<!DOCTYPE html>
<html lang=zh>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="PolarDB-IMCI: A Cloud-Native HTAP Database System at Alibaba å‘è¡¨åœ¨ SIGMODâ€™23 ä¸Šçš„æ–‡ç« ï¼Œç®€å•ä»‹ç»äº† IMCI çš„åˆ—å­˜å®ç°ã€‚PolarDB æ˜¯ä¸€ä¸ªåŸºäºå…±äº«å­˜å‚¨ PolarFS + RDMA çš„äº‘å­˜å‚¨æ•°æ®åº“ã€‚Redo&#x2F;Page å…±äº«åœ¨ PolarFS è¿™ä¸€å…±äº«å±‚ä¸Šã€‚PolarDB ä¹‹å‰èƒ½å¤Ÿåœ¨è¿™ä¸ªæ¶æ„ä¸Šå®ç° Serve ç±»ä¼¼æ•°æ®çš„">
<meta property="og:type" content="article">
<meta property="og:title" content="PolarDB IMCI: Row&#x2F;Column in RO node">
<meta property="og:url" content="http://blog.mwish.me/2024/01/20/PolarDB-IMCI-Row-Column-in-RO-node/index.html">
<meta property="og:site_name" content="é£ç©ºä¹‹å²›">
<meta property="og:description" content="PolarDB-IMCI: A Cloud-Native HTAP Database System at Alibaba å‘è¡¨åœ¨ SIGMODâ€™23 ä¸Šçš„æ–‡ç« ï¼Œç®€å•ä»‹ç»äº† IMCI çš„åˆ—å­˜å®ç°ã€‚PolarDB æ˜¯ä¸€ä¸ªåŸºäºå…±äº«å­˜å‚¨ PolarFS + RDMA çš„äº‘å­˜å‚¨æ•°æ®åº“ã€‚Redo&#x2F;Page å…±äº«åœ¨ PolarFS è¿™ä¸€å…±äº«å±‚ä¸Šã€‚PolarDB ä¹‹å‰èƒ½å¤Ÿåœ¨è¿™ä¸ªæ¶æ„ä¸Šå®ç° Serve ç±»ä¼¼æ•°æ®çš„">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://image.mwish.me/blog-image/E0F08A18-1F38-481E-AC44-6262DB555837.png">
<meta property="og:image" content="https://image.mwish.me/blog-image/E1F22974-F501-4A94-A79E-3D3720F2CBCC.png">
<meta property="og:image" content="https://image.mwish.me/blog-image/62418A3E-3019-4D4D-874B-099C3EF3E1BE.png">
<meta property="og:image" content="https://image.mwish.me/blog-image/07AEECAC-C9D7-40AE-9268-FAD83114FBE1.png">
<meta property="og:image" content="https://image.mwish.me/blog-image/43AAD368-908E-486F-9AEB-3A487A26A6C4.png">
<meta property="og:image" content="https://image.mwish.me/blog-image/C818EC67-9CE8-46B2-A85F-263468184963.png">
<meta property="article:published_time" content="2024-01-20T12:00:00.000Z">
<meta property="article:modified_time" content="2024-01-20T12:03:17.346Z">
<meta property="article:author" content="mwish">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://image.mwish.me/blog-image/E0F08A18-1F38-481E-AC44-6262DB555837.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/logo.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/logo.ico" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/logo.ico">
        
      
    
    <!-- title -->
    <title>PolarDB IMCI: Row/Column in RO node</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 6.2.0"></head>

<body class="max-width mx-auto px3 ltr">    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="ç›®å½•"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="ç›®å½•"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="é¡¶éƒ¨" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">é¦–é¡µ</a></li><!--
     --><!--
       --><li><a href="/about/">å…³äº</a></li><!--
     --><!--
       --><li><a href="/archives/">å½’æ¡£</a></li><!--
     --><!--
       --><li><a href="/search/">æœç´¢</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        
        <li><a class="icon" aria-label="ä¸‹ä¸€ç¯‡" href="/2023/12/30/Strict-Alias-and-Type-Punning/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="è¿”å›é¡¶éƒ¨" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="åˆ†äº«æ–‡ç« " href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">ä¸Šä¸€ç¯‡</span>
      <span id="i-next" class="info" style="display:none;">ä¸‹ä¸€ç¯‡</span>
      <span id="i-top" class="info" style="display:none;">è¿”å›é¡¶éƒ¨</span>
      <span id="i-share" class="info" style="display:none;">åˆ†äº«æ–‡ç« </span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://blog.mwish.me/2024/01/20/PolarDB-IMCI-Row-Column-in-RO-node/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://blog.mwish.me/2024/01/20/PolarDB-IMCI-Row-Column-in-RO-node/&text=PolarDB IMCI: Row/Column in RO node"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://blog.mwish.me/2024/01/20/PolarDB-IMCI-Row-Column-in-RO-node/&title=PolarDB IMCI: Row/Column in RO node"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://blog.mwish.me/2024/01/20/PolarDB-IMCI-Row-Column-in-RO-node/&is_video=false&description=PolarDB IMCI: Row/Column in RO node"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=PolarDB IMCI: Row/Column in RO node&body=Check out this article: http://blog.mwish.me/2024/01/20/PolarDB-IMCI-Row-Column-in-RO-node/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://blog.mwish.me/2024/01/20/PolarDB-IMCI-Row-Column-in-RO-node/&title=PolarDB IMCI: Row/Column in RO node"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://blog.mwish.me/2024/01/20/PolarDB-IMCI-Row-Column-in-RO-node/&title=PolarDB IMCI: Row/Column in RO node"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://blog.mwish.me/2024/01/20/PolarDB-IMCI-Row-Column-in-RO-node/&title=PolarDB IMCI: Row/Column in RO node"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://blog.mwish.me/2024/01/20/PolarDB-IMCI-Row-Column-in-RO-node/&title=PolarDB IMCI: Row/Column in RO node"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://blog.mwish.me/2024/01/20/PolarDB-IMCI-Row-Column-in-RO-node/&name=PolarDB IMCI: Row/Column in RO node&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://blog.mwish.me/2024/01/20/PolarDB-IMCI-Row-Column-in-RO-node/&t=PolarDB IMCI: Row/Column in RO node"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#COLUMN-INDEX-STORAGE"><span class="toc-number">1.</span> <span class="toc-text">COLUMN INDEX STORAGE</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E5%A4%84%E7%90%86"><span class="toc-number">2.</span> <span class="toc-text">æŸ¥è¯¢å¤„ç†</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Column-%E6%95%B0%E6%8D%AE%E7%9A%84%E6%8C%81%E4%B9%85%E5%8C%96%E5%8D%8F%E8%AE%AE"><span class="toc-number">3.</span> <span class="toc-text">Column æ•°æ®çš„æŒä¹…åŒ–åè®®</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Reference"><span class="toc-number">4.</span> <span class="toc-text">Reference</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        PolarDB IMCI: Row/Column in RO node
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">mwish</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2024-01-20T12:00:00.000Z" itemprop="datePublished">2024-01-20</time>
        
      
    </div>


      

      

    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <p>PolarDB-IMCI: A Cloud-Native HTAP Database System at Alibaba å‘è¡¨åœ¨ SIGMODâ€™23 ä¸Šçš„æ–‡ç« ï¼Œç®€å•ä»‹ç»äº† IMCI çš„åˆ—å­˜å®ç°ã€‚PolarDB æ˜¯ä¸€ä¸ªåŸºäºå…±äº«å­˜å‚¨ PolarFS + RDMA çš„äº‘å­˜å‚¨æ•°æ®åº“ã€‚Redo/Page å…±äº«åœ¨ PolarFS è¿™ä¸€å…±äº«å±‚ä¸Šã€‚PolarDB ä¹‹å‰èƒ½å¤Ÿåœ¨è¿™ä¸ªæ¶æ„ä¸Šå®ç° Serve ç±»ä¼¼æ•°æ®çš„ RO èŠ‚ç‚¹ï¼ˆå®é™…ä¸Šæˆ‘æ„Ÿè§‰ RO èŠ‚ç‚¹åœ¨å·¥ç¨‹ä¸Šè¿˜æ˜¯æœ‰ä¸å°‘éš¾åº¦çš„ï¼‰ã€‚åœ¨ IMCI ä¸Šï¼Œè¿™å¥— RO æ‰©å±•ä¸ºè¡Œ/åˆ—çš†æœ‰çš„å­˜å‚¨ï¼Œé  InnoDB Redo Log æ¥åŒæ­¥ã€‚åœ¨ RO ä»èŠ‚ç‚¹ä¸Šï¼Œé€šè¿‡è¡Œå­˜çš„ Page å’Œä¸€å¥—é¢å¤–çš„å®šä½ç´¢å¼•å®Œæˆ Physical Page - Logical in Page çš„æ—¥å¿—åˆ°åˆ—å­˜åœ°å€çš„å®šä½ï¼Œå¹¶ç”¨ä¸€å¥—ç®€å•çš„åˆ—å­˜ Serve MVCC è¯»æŸ¥è¯¢ã€‚è¿™å¥—æ¶æ„ä¼šå¢åŠ ä¸€å®šçš„å­˜å‚¨æˆæœ¬ï¼Œå¹¶ä¸”å¯¹æœºå™¨çš„å†…å­˜å’Œ io å¯èƒ½æœ‰ä¸€å®šçš„è¦æ±‚ï¼Œå› ä¸ºç›¸å¯¹äºåŸæ¥çš„èŠ‚ç‚¹ï¼Œæ„Ÿè§‰éœ€è¦å¤š Serve ä¸€éƒ¨åˆ†æ•°æ®ï¼Œå¯èƒ½éœ€è¦ä¸€äº›ç›¸å¯¹é«˜è§„æ ¼çš„æœºå‹ã€‚ä½†æ˜¯æœ¬èº«è¿™ç§æ¶æ„å¯èƒ½æœåŠ¡çš„å¯¹è±¡ä¹Ÿæ¯”è¾ƒå…·ä½“ï¼Œå› ä¸º PolarDB è™½ç„¶æ˜¯å…±äº«å­˜å‚¨ï¼Œä½†æ˜¯è¿˜æ˜¯é‚£ç§ TP æ•°æ®åº“ï¼Œæ‰€ä»¥æ•°æ®è§„æ¨¡åº”è¯¥ç›¸å¯¹å¯æ§ï¼Œé¢å¯¹çš„ç”¨æˆ·éœ€æ±‚å¯èƒ½ä¹Ÿç›¸å¯¹å…·ä½“ä¸€äº›ã€‚è¿™æ ·æœ¬èº«å¯èƒ½ workload ä¹Ÿå’Œæ•°æ®åˆ†æå„ç§è·‘æ‰¹ç„¶å INSERT OVERWRITE åˆ°ä¸€ä¸ªæ–°çš„è¡¨ï¼Œå„ç§ç®— T+1 çš„éœ€æ±‚ä¹‹ç±»çš„ä¸ä¸€æ ·ï¼Œåªæ˜¯ OLAP æŸ¥è¯¢ã€‚åœ¨è¿™ç§åœºæ™¯ä¸‹ï¼Œè¿™å¥—æ¶æ„å¯èƒ½æ˜¯å¾ˆè½»è€Œä¸”å¾ˆé è°±çš„ã€‚</p>
<p><img src="https://image.mwish.me/blog-image/E0F08A18-1F38-481E-AC44-6262DB555837.png" alt="E0F08A18-1F38-481E-AC44-6262DB555837"></p>
<p>è®ºæ–‡è®¾è®¡çš„æ—¶å€™æå‡ºäº†äº”ä¸ªç›®æ ‡ï¼š</p>
<ol>
<li>Transparent Query Execution: é å¯¹ä¸Šå±‚æä¾›åŒæ · SQL æ¥å£ï¼Œåªè¦ç”¨æˆ·è®¾è®¡ Indexï¼Œç„¶åå†…éƒ¨å¼€å‡ºèŠ‚ç‚¹ï¼ˆå…¶å®æˆ‘ä¹Ÿæœ‰ç‚¹æ„Ÿå…´è¶£ä»–ä»¬è¿™æ–¹é¢æ€ä¹ˆåšæ”¶è´¹æ¨¡å‹çš„ï¼‰</li>
<li>Advanced OLAP Performance: (typically through the introduction of columnar data storage).</li>
<li>Minimal Perturbation on OLTP Workloads: OLTP queries are usually more mission-critical and are more sensitive to performance degradation.<ol>
<li>è¿™é‡Œé  RO èŠ‚ç‚¹æ¥å®ç°ï¼Œé€šè¿‡ Redo log æ¥åšåŒæ­¥ï¼Œå¹¶ä¸”ä¸è€ƒèµ° binlog æ¥é¿å…å¼•å…¥å†™ä¾§çš„é¢å¤–å¼€é”€ [1]</li>
</ol>
</li>
<li>High Data Freshness: using the visibility delay as a freshness score for a query. By definition, the visibility delay is the time interval during which updates to the database can be visible to OLAP queries. (è¿™é‡Œåœ¨è®ºæ–‡ç¬¬å…­èŠ‚æåˆ°æœ‰ä¸€äº› Proxy çš„è®¾è®¡èƒ½ä¿è¯æ›´å¼ºçš„è¯­ä¹‰)<ol>
<li>è¿™é‡Œèµ°äº† commit ahead log shipping å’Œ conflict-free log replay (2P-COFFER)ï¼ˆå°±æ˜¯ç›´æ¥ redo è€Œä¸æ˜¯ binlog åŒæ­¥ğŸ˜…çœŸèƒ½å–åï¼‰</li>
<li>ä½¿ç”¨ Append-Only Storage åšä¸€ä¸ª LSM-T åˆ—å­˜ç´¢å¼•åŠ é€ŸæŸ¥è¯¢ï¼Œæ ¹æ® insert-order æ¥ç»„ç»‡åˆ—å­˜ï¼ˆä½†æ˜¯è¿™æ ·æ˜¾ç„¶å°±è¦åå°è°ƒåº¦ compaction äº†ï¼Œæ— è®ºæ˜¯åˆ—å­˜çš„è¿˜æ˜¯ç´¢å¼•çš„ï¼Œä¸è¿‡è®ºæ–‡ä¹Ÿæ²¡è®²ï¼Ÿå¯èƒ½æ˜¯å°½é‡åœ¨å‰å°åšä¸€äº›æ“ä½œï¼‰</li>
</ol>
</li>
<li>Excellent Resource Elasticity: should ensure high resource elasticity (e.g., scale-out in minutes or even seconds) to adaptively serve the changing data volume and analytical workloads with stable performance and high resource utilization.<ol>
<li>å…è®¸ç”¨ ddl ç±»ä¼¼çš„æ–¹å¼å¿«é€Ÿåœ¨åˆ«çš„æœºå™¨ä¸Šæ‹‰èµ·æ„å»ºç´¢å¼•</li>
</ol>
</li>
</ol>
<p>IMCI æ¶æ„å¦‚ä¸‹ï¼š</p>
<p><img src="https://image.mwish.me/blog-image/E1F22974-F501-4A94-A79E-3D3720F2CBCC.png" alt="E1F22974-F501-4A94-A79E-3D3720F2CBCC"></p>
<p>ä½¿ç”¨çš„æ—¶å€™éœ€è¦å»ºè¡¨ï¼š</p>
<p><img src="https://image.mwish.me/blog-image/62418A3E-3019-4D4D-874B-099C3EF3E1BE.png" alt="62418A3E-3019-4D4D-874B-099C3EF3E1BE"></p>
<p>ç„¶å Planner ä¼šç”Ÿæˆä¸€ä¸ªæ··åˆè¡Œåˆ—çš„ Planã€‚å› ä¸ºåœ¨è¿™ä¸ªèŠ‚ç‚¹ä¸Šæ˜¯è¡Œåˆ—éƒ½æœ‰çš„ã€‚ä¸è¿‡æ„Ÿè§‰è¿™é‡Œçš„éš”ç¦»çº§åˆ«å’ŒåŒæ­¥æ—¶é—´ä¹‹ç±»çš„æ²¡æœ‰ç‰¹åˆ«å¥½çš„å®šä¹‰ï¼Œè®ºæ–‡æåˆ°äº†ä¸€ä¸ªåŒæ­¥å»¶è¿Ÿï¼Œä½†æ˜¯æ²¡æœ‰æåˆ°å…·ä½“çš„å®æ—¶å’Œä¸€äº›è¯­ä¹‰ï¼Œæ„Ÿè§‰è¿™ä¸ªå¾—çœ‹çœ‹äº§å“æ–‡æ¡£äº†ï¼Œæˆ‘ä¸ªäººæ„Ÿè§‰ä¸Šåº”è¯¥æ˜¯åªæœ‰ RR çš„ã€‚æˆ‘ä»¬åœ¨ä¹‹åä¹Ÿä¼šä»‹ç»è¿™ä¸ªè¡Œåˆ—æ··åˆçš„æ‰§è¡Œæ¨¡å¼ã€‚</p>
<p>å…·ä½“æ‹‰èµ·ä¸€ä¸ªèŠ‚ç‚¹çš„æ—¶å€™ç±»ä¼¼åœ¨ RO ä¸Š DDL ï¼Œç„¶åè¿™é‡Œä¼š Online æ„å»ºä¸€ä¸ªç´¢å¼•ã€‚</p>
<h2 id="COLUMN-INDEX-STORAGE"><a href="#COLUMN-INDEX-STORAGE" class="headerlink" title="COLUMN INDEX STORAGE"></a>COLUMN INDEX STORAGE</h2><p><img src="https://image.mwish.me/blog-image/07AEECAC-C9D7-40AE-9268-FAD83114FBE1.png" alt="07AEECAC-C9D7-40AE-9268-FAD83114FBE1"></p>
<p>è¿™å—å…·ä½“å¦‚ä¸Šå›¾ã€‚è§‚å¯Ÿåˆ°å‡ ä¸ªæˆåˆ†ï¼š</p>
<ol>
<li>å¤–éƒ¨æ•°æ®æ¥è‡ª Redo Logï¼Œè¿™é‡Œå¯èƒ½ä½œç”¨äº Page, Change Buffer (ä½†ä¸å®Œå…¨è€ƒè™‘ Undo)? è¿™é‡Œæœ‰ä¸ªç»†èŠ‚æ˜¯å¯èƒ½è¦æ”¹ MTRï¼Œæ¯”å¦‚ Update çš„ MTR éœ€è¦å˜æˆæ‹¥æœ‰æ‰€æœ‰åˆ—çš„ UPSERTã€‚æˆ‘è¿˜ä¸€ä¸‹æ²¡æƒ³åˆ° Undo æ˜¯ä¸æ˜¯æœ‰å½±å“ï¼Œå¯èƒ½ DDL æ„å»ºå®Œ Index åå¯ä»¥å¿½ç•¥ Undoï¼Ÿ</li>
<li>å†…éƒ¨æœ‰ä¸ª 2-Level LSM-Tree, ä½œä¸ºä¸€ä¸ª <strong>å•ç‰ˆæœ¬</strong> æœ€æ–°æ•°æ®å®šä½å™¨ã€‚æ˜ å°„ <code>&lt;P.K. -&gt; RID in Physical Location&gt;</code>.</li>
<li>æ–‡ä»¶åˆ’åˆ†ä¸º RowGroups, 64K è¡Œä¸€ä¸ª RGã€‚RG çš„ Column ç§°ä¸º Packï¼Œæœ‰ä¸€ä¸ªæ­£åœ¨å†™å…¥çš„æ˜¯ Unsealed pack. è¿™ä¸ª Pack çš„æ¦‚å¿µç±»ä¼¼ Parquet çš„ Pageã€‚æ­£åœ¨æ›´æ–°çš„ unpack - rowgroup ä¸ä¼šè¢«å‹ç¼©ã€‚è¿™é‡Œè¿˜é¢å¤–åœ¨ Metadata ç»´æŠ¤äº†ä¸¤åˆ— MVCC åˆ—ï¼šDeleted VID Map å’Œ Inserted VID Map. è¿™ä¸ªç±»ä¼¼äº‹åŠ¡ç³»ç»Ÿçš„ insert_ts å’Œ delete_ts (ä½†æ˜¯å¯èƒ½ä¸ä¸€å®šæœ‰ç›´æ¥çš„é¡ºåºæ€§ï¼Œåº”è¯¥ç±»ä¼¼ Innodb çš„äº‹åŠ¡ idï¼Œæ˜¯ä¸€ä¸ªè™½ç„¶é€’å¢ï¼Œä½†æ˜¯ç³»ç»Ÿçš„ id ä¸ä¸€å®šä»£è¡¨æäº¤çš„ ordering)<ol>
<li>æ€è€ƒ: ç³»ç»Ÿæœ¬èº«å¦‚ä½•æ¢å¤ï¼Ÿå®é™…ä¸Šå¯ä¾é  RO çš„ WAL æ¢å¤ï¼Œæ‰€ä»¥å¯ä»¥ä¸ç”¨åŠæ—¶ç›´æ¥æŠŠ Unsealed å» Seal äº†ï¼Œè¿™æ˜¯æœ‰è¡Œå­˜å’Œ RW ç³»ç»Ÿçš„ä¸€å¥—å¥½å¤„</li>
</ol>
</li>
</ol>
<p>åœ¨è¿™ä¸ªç³»ç»Ÿä¸­ï¼ŒUpdate è¢«æŠ½è±¡æˆ Delete + Insert ã€‚Delete å…¶å®ç›¸å½“äºåªåœ¨ RID Locator å’Œ Metadata åšåˆ é™¤ã€‚ç„¶å INSERT å…¨è¡Œæ’å…¥æœ€æ–°çš„ã€‚è€ƒè™‘åˆ°è¿™ä¸ªè¡¨å¯èƒ½ä¸ä¼šå¾ˆå¤§ï¼Œæš‚æ—¶å¯èƒ½æ²¡æœ‰åˆ†åŒºä¹‹ç±»çš„åŠŸèƒ½ï¼Ÿè¿™æ ·åº”è¯¥è¿˜è›®ç®€å•çš„ã€‚å‹ç¼©æ–‡ä»¶åˆ é™¤åªåˆ é™¤ Delete VID çš„ Metadata çš„è¯ï¼Œè¿™å—å¼€é”€ä¹Ÿä¸æ˜¯å¾ˆå¤§ã€‚</p>
<p>è¿™é‡Œè€ƒè™‘åˆ° MVCC çš„ç»†èŠ‚ï¼Œå®é™…ä¸Šåœ¨ Snapshot æ¨è¿›ä¹‹åï¼ŒInsert VID Map æ˜¯å¯ä»¥ä¸è¯»çš„ï¼ˆå½“ç³»ç»Ÿçš„ lowest trx id å¤§äºæœ€å¤§çš„ insert vid çš„æ—¶å€™ï¼‰ã€‚è¿™é‡Œçš„å¤„ç†æŒ‰ç…§ä¸‹é¢çš„é¡ºåºï¼š</p>
<p><img src="https://image.mwish.me/blog-image/43AAD368-908E-486F-9AEB-3A487A26A6C4.png" alt="43AAD368-908E-486F-9AEB-3A487A26A6C4"></p>
<p>åœ¨æäº¤ä¹‹å‰ï¼Œäº‹åŠ¡æ”’åœ¨ Transaction Buffer ä¸­ï¼Œç­‰å¾…æœ€ç»ˆçš„æäº¤æˆ–è€… abortã€‚æ€è€ƒï¼šå¦‚æœèµ° binlog çš„è¯ï¼Œè¿™å¥—ä¸œè¥¿å°±ç›¸å½“äºç›´æ¥èµ° CDC äº†ï¼ŒRID Locator ä»ç„¶éœ€è¦ï¼Œä½†åˆ«çš„åº”è¯¥ä¸ä¼šäº†ã€‚è¿™é‡Œä¹Ÿä¸éœ€è¦åˆ¤æ–­äº‹åŠ¡å†²çªï¼Œå› ä¸ºäº‹åŠ¡å†²çªåº”è¯¥åœ¨è¡Œå­˜ç³»ç»Ÿå¤„ç†äº†ã€‚æˆ‘ç†è§£å…¶å®åªèµ° binlog çš„è¯è¿™å¥—ä¼šå¹²å‡€ä¸€ç‚¹ï¼Œç„¶åè€ƒè™‘ binlog in redo çš„æ¶æ„ï¼Œè¿™å¥—åº”è¯¥æ˜¯å¯ä»¥åšçš„ã€‚</p>
<p>ä½†æ˜¯åœ¨å¤„ç†å¤§äº‹åŠ¡çš„æ—¶å€™ï¼Œè¿™å¥—æ–¹å¼æ¨æˆäº†ä¸å¤„ç†å†™å†²çªçš„ MVCCï¼Œå³è¿™é‡Œå¤§äº‹åŠ¡ä¼šåš pre-commit: å½“äº‹åŠ¡ txn record å¤§å°è¶…ä¸€å®šé™åˆ¶çš„æ—¶å€™å°±ä¼šåš PreCommitï¼Œå†™åˆ° unpack çš„åˆ—å­˜ä¸­ï¼ŒMVCC åˆ—æ ‡æ³¨ä¸ºä¸€ä¸ªä¸åˆæ³•çš„åˆ—ã€‚é‚£ä¹ˆæ€ä¹ˆå®šä½è¿™äº›æ•°æ®å‘¢ï¼Ÿè¿™é‡Œå¯èƒ½éœ€è¦ä¸€äº›ä¸´æ—¶çš„ RID Locator:</p>
<blockquote>
<p>First, request a continuous RID for all rows in the current transaction buffer, and save this RID range. It is important to note that the global RID locator cannot yet be changed during the pre-commit phase to avoid the exposure of uncommitted transactions. Thus, PolarDB-IMCI creates a temporary RID locator instead of updating the RID global locator to cache new PK-toRID mappings. Then, PolarDB-IMCI writes the updates to Partial Packs while setting the insert and delete VIDs as invalid to make them invisible. Finally, PolarDB-IMCI frees the memory used by the transaction buffer unit.</p>
</blockquote>
<h2 id="æŸ¥è¯¢å¤„ç†"><a href="#æŸ¥è¯¢å¤„ç†" class="headerlink" title="æŸ¥è¯¢å¤„ç†"></a>æŸ¥è¯¢å¤„ç†</h2><p>è¿™é‡Œå‰å°æœ‰ä¸ª Proxy æ¥è´Ÿè´£ dispatch ro/rw:</p>
<p><img src="https://image.mwish.me/blog-image/C818EC67-9CE8-46B2-A85F-263468184963.png" alt="C818EC67-9CE8-46B2-A85F-263468184963"></p>
<p>è¿™é‡Œå…¶å®æœ‰ç‚¹æ²¡æ‡‚ï¼Œè¿™ä¸ªæ˜¯åœ¨å‰å°æœ‰ä¸ª SQL Parser ç„¶ååšä»£ä»·ä¼°è®¡ï¼Ÿè¿™ä¸€è·³ä¼šå¾ˆè€—æ—¶å—ğŸ¤”ï¼Ÿä¸çŸ¥é“æ˜¯åƒ Preso Coordinator é‚£æ ·æ‹†åˆ†äº†ï¼Œè¿˜æ˜¯æ€ä¹ˆæ ·ï¼Œå…¶å®æœ‰ç‚¹ä¸æ˜¯å¾ˆç†è§£ã€‚</p>
<p>å…³äº Consistencyï¼Œè¿™é‡Œè¿˜æ˜¯ Proxy é  track LSN æ¥è§£å†³ï¼Œæœ‰é‚£ä¹ˆä¸€ç‚¹ç‚¹ç±»ä¼¼ Raft ReadIndex ä¹‹ç±»çš„ã€‚æˆ‘å€’æ˜¯æœ‰ç‚¹å¥½å¥‡ï¼Œå¦‚æœæ˜¯é  binlog ï¼Œè¿™å—åŒæ­¥æœ‰æ²¡æœ‰ä»€ä¹ˆæ–¹æ¡ˆï¼Œå¯èƒ½è¿˜æ˜¯ç»™ committed txn ä¸€ä¸ª id? å…¶å®ä¸‹ä¸€èŠ‚æåˆ°äº†ä¸ª CSEï¼Œè®©æˆ‘è«åè§‰å¾—è¿™å¥—æœºåˆ¶ä¹Ÿå¯è¡Œã€‚</p>
<blockquote>
<p>The proxy keeps track of the RW nodeâ€™s written LSN and all RO nodesâ€™ applied LSN. The written LSN and applied LSN indicate the transaction commit point for RW and RO, respectively. Transactions before the written LSN were committed on the RW node. Likewise, any log entries before the applied LSN are guaranteed to have been replayed by the RO node. The proxy may only route queries to the RO nodes whose applied LSN is not less than the written LSN to meet the requirements of strong consistency.</p>
</blockquote>
<h2 id="Column-æ•°æ®çš„æŒä¹…åŒ–åè®®"><a href="#Column-æ•°æ®çš„æŒä¹…åŒ–åè®®" class="headerlink" title="Column æ•°æ®çš„æŒä¹…åŒ–åè®®"></a>Column æ•°æ®çš„æŒä¹…åŒ–åè®®</h2><p>Column RO çš„ Node è¢«åˆ‡æˆ Leader å’Œ Followerï¼Œç±»ä¼¼ä¸€ç§ã€ŒColumnar RO æ•°æ®çš„ä¸€å†™å¤šè¯»ã€ã€‚Leader æŒä¹…åŒ–è¿™éƒ¨åˆ†æ•°æ®ï¼ŒFollower ç±»ä¼¼åªè¯»èŠ‚ç‚¹ã€‚è¿™é‡Œå›å¤´çœ‹çœ‹æ„Ÿè§‰å®é™…ä¸Šè¿™ä¸ªæ•°æ®åº“ç”šè‡³æœ‰ä¸€äº› MPP èƒ½åŠ›ã€‚ã€‚ã€‚</p>
<p>è¿™é‡Œçš„å…³é”®è®¾è®¡æ˜¯ CSN (Checkpoint Sequence Number) å’Œ Checkpointã€‚ç›¸å½“äºå¯¹æäº¤çš„äº‹åŠ¡å®šåºï¼š</p>
<ol>
<li>VID Map ä¼š fence æ‰å¤§äº CSN çš„æ•°æ®</li>
<li>Packs ç›´æ¥ä¸‹åˆ·å³å¯ï¼ŒLeader æŠŠ unsealed pack æ„å»ºæˆ Sealed ä¹‹åå°±å¯ä»¥ä¸‹åˆ·</li>
<li>RID Allocator å¯ä»¥ç›´æ¥ç›¸å½“äºå– Snapshot ç„¶åä¸‹åˆ·ï¼Œä¹Ÿä¼š fence åŠæ›´å¤§çš„</li>
</ol>
<p>å…³äº VID Map å’Œ RID Allocator å¯èƒ½éœ€è¦ä¸€äº›ç²¾ç»†ä¸€äº›çš„è®¾è®¡ï¼Œä¸è¿‡æ„Ÿè§‰å…¶å®éš¾åº¦ä¹Ÿå¯æ§</p>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ol>
<li>å…³äº binlog çš„é¢å¤–å¼€é”€å’Œ binlog in redo æ–¹æ¡ˆï¼Œæˆ‘æ„Ÿè§‰å¦‚æœç›´æ¥ binlog in redo å°±èƒ½ç§»é™¤è¡Œé‚£å¥—çš„ç›´æ¥ä¾èµ–äº†ï¼Œé™¤éå†å»åšæŸ¥è¯¢çš„ fusion: <a target="_blank" rel="noopener" href="http://mysql.taobao.org/monthly/2020/06/01/">http://mysql.taobao.org/monthly/2020/06/01/</a></li>
<li>AWS re:Invent2022 Aurora å‘å¸ƒäº†å•¥ - é™ˆå®—å¿—çš„æ–‡ç«  - çŸ¥ä¹<br><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/590576660">https://zhuanlan.zhihu.com/p/590576660</a> ã€‚è¿™å—æˆ‘è§‰å¾—æœ¬èº«ä¹Ÿå¯ä»¥ä¸Š binlogã€‚</li>
</ol>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">é¦–é¡µ</a></li>
         
          <li><a href="/about/">å…³äº</a></li>
         
          <li><a href="/archives/">å½’æ¡£</a></li>
         
          <li><a href="/search/">æœç´¢</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#COLUMN-INDEX-STORAGE"><span class="toc-number">1.</span> <span class="toc-text">COLUMN INDEX STORAGE</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E5%A4%84%E7%90%86"><span class="toc-number">2.</span> <span class="toc-text">æŸ¥è¯¢å¤„ç†</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Column-%E6%95%B0%E6%8D%AE%E7%9A%84%E6%8C%81%E4%B9%85%E5%8C%96%E5%8D%8F%E8%AE%AE"><span class="toc-number">3.</span> <span class="toc-text">Column æ•°æ®çš„æŒä¹…åŒ–åè®®</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Reference"><span class="toc-number">4.</span> <span class="toc-text">Reference</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://blog.mwish.me/2024/01/20/PolarDB-IMCI-Row-Column-in-RO-node/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://blog.mwish.me/2024/01/20/PolarDB-IMCI-Row-Column-in-RO-node/&text=PolarDB IMCI: Row/Column in RO node"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://blog.mwish.me/2024/01/20/PolarDB-IMCI-Row-Column-in-RO-node/&title=PolarDB IMCI: Row/Column in RO node"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://blog.mwish.me/2024/01/20/PolarDB-IMCI-Row-Column-in-RO-node/&is_video=false&description=PolarDB IMCI: Row/Column in RO node"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=PolarDB IMCI: Row/Column in RO node&body=Check out this article: http://blog.mwish.me/2024/01/20/PolarDB-IMCI-Row-Column-in-RO-node/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://blog.mwish.me/2024/01/20/PolarDB-IMCI-Row-Column-in-RO-node/&title=PolarDB IMCI: Row/Column in RO node"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://blog.mwish.me/2024/01/20/PolarDB-IMCI-Row-Column-in-RO-node/&title=PolarDB IMCI: Row/Column in RO node"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://blog.mwish.me/2024/01/20/PolarDB-IMCI-Row-Column-in-RO-node/&title=PolarDB IMCI: Row/Column in RO node"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://blog.mwish.me/2024/01/20/PolarDB-IMCI-Row-Column-in-RO-node/&title=PolarDB IMCI: Row/Column in RO node"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://blog.mwish.me/2024/01/20/PolarDB-IMCI-Row-Column-in-RO-node/&name=PolarDB IMCI: Row/Column in RO node&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://blog.mwish.me/2024/01/20/PolarDB-IMCI-Row-Column-in-RO-node/&t=PolarDB IMCI: Row/Column in RO node"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> èœå•</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> ç›®å½•</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> åˆ†äº«</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> è¿”å›é¡¶éƒ¨</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2022-2024
    mwish
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">é¦–é¡µ</a></li><!--
     --><!--
       --><li><a href="/about/">å…³äº</a></li><!--
     --><!--
       --><li><a href="/archives/">å½’æ¡£</a></li><!--
     --><!--
       --><li><a href="/search/">æœç´¢</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->
 
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script> 




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script> 
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"å¤åˆ¶åˆ°ç²˜è´´æ¿ï¼\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "å¤åˆ¶æˆåŠŸï¼");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

    <script async src="https://www.googletagmanager.com/gtag/js?id=G-FL51GBW6JT"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-FL51GBW6JT');
    </script>

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Umami Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });
</script>
<script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</body>
</html>
