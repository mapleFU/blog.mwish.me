<!DOCTYPE html>
<html lang=zh>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="在上一篇，我们了解了静态链接和对应的环境 https:&#x2F;&#x2F;blog.mwish.me&#x2F;2024&#x2F;11&#x2F;20&#x2F;Compile-Loader-Libraries-Part-1-Static-linking&#x2F;  这部分我们需要介绍加载、动态链接和库 可执行文件的 Load 和进程作者（有一些咬文嚼字的）认为：  程序是静态的概念，指编译好的指令&#x2F;数据的文件（那个 ELF 可执行文件？），因为这个原因，所">
<meta property="og:type" content="article">
<meta property="og:title" content="Compile&#x2F;Loader&#x2F;Libraries: Part 2 Dynamic linking">
<meta property="og:url" content="http://blog.mwish.me/2024/12/06/Compile-Loader-Libraries-Part-2-Dynamic-linking/index.html">
<meta property="og:site_name" content="风空之岛">
<meta property="og:description" content="在上一篇，我们了解了静态链接和对应的环境 https:&#x2F;&#x2F;blog.mwish.me&#x2F;2024&#x2F;11&#x2F;20&#x2F;Compile-Loader-Libraries-Part-1-Static-linking&#x2F;  这部分我们需要介绍加载、动态链接和库 可执行文件的 Load 和进程作者（有一些咬文嚼字的）认为：  程序是静态的概念，指编译好的指令&#x2F;数据的文件（那个 ELF 可执行文件？），因为这个原因，所">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://image.mwish.me/blog-image/8629188967446540905.png">
<meta property="og:image" content="https://image.mwish.me/blog-image/3540751129526476111.png">
<meta property="og:image" content="https://image.mwish.me/blog-image/2797812280891855987.png">
<meta property="og:image" content="https://image.mwish.me/blog-image/8541393186470268469.png">
<meta property="og:image" content="https://image.mwish.me/blog-image/8340745219183224494.png">
<meta property="og:image" content="https://image.mwish.me/blog-image/1380078064477421890.png">
<meta property="og:image" content="https://image.mwish.me/blog-image/3989383184023196757.png">
<meta property="og:image" content="https://image.mwish.me/blog-image/2358980861257600997.png">
<meta property="og:image" content="https://image.mwish.me/blog-image/8719342898469064858.png">
<meta property="og:image" content="https://image.mwish.me/blog-image/4719154147066187773.png">
<meta property="og:image" content="https://image.mwish.me/blog-image/8773140081539434308.png">
<meta property="article:published_time" content="2024-12-05T17:00:54.000Z">
<meta property="article:modified_time" content="2024-12-05T17:02:45.244Z">
<meta property="article:author" content="mwish">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://image.mwish.me/blog-image/8629188967446540905.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/logo.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/logo.ico" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/logo.ico">
        
      
    
    <!-- title -->
    <title>Compile/Loader/Libraries: Part 2 Dynamic linking</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 6.2.0"></head>

<body class="max-width mx-auto px3 ltr">    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="目录"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="目录"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="顶部" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">首页</a></li><!--
     --><!--
       --><li><a href="/about/">关于</a></li><!--
     --><!--
       --><li><a href="/archives/">归档</a></li><!--
     --><!--
       --><li><a href="/search/">搜索</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="上一篇" href="/2024/12/11/Adaptive-and-Robust-Query-Execution-for-Lakehouses-at-Scale/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="下一篇" href="/2024/12/05/Column-or-row-in-database-execution/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="返回顶部" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="分享文章" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">上一篇</span>
      <span id="i-next" class="info" style="display:none;">下一篇</span>
      <span id="i-top" class="info" style="display:none;">返回顶部</span>
      <span id="i-share" class="info" style="display:none;">分享文章</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://blog.mwish.me/2024/12/06/Compile-Loader-Libraries-Part-2-Dynamic-linking/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://blog.mwish.me/2024/12/06/Compile-Loader-Libraries-Part-2-Dynamic-linking/&text=Compile/Loader/Libraries: Part 2 Dynamic linking"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://blog.mwish.me/2024/12/06/Compile-Loader-Libraries-Part-2-Dynamic-linking/&title=Compile/Loader/Libraries: Part 2 Dynamic linking"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://blog.mwish.me/2024/12/06/Compile-Loader-Libraries-Part-2-Dynamic-linking/&is_video=false&description=Compile/Loader/Libraries: Part 2 Dynamic linking"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Compile/Loader/Libraries: Part 2 Dynamic linking&body=Check out this article: http://blog.mwish.me/2024/12/06/Compile-Loader-Libraries-Part-2-Dynamic-linking/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://blog.mwish.me/2024/12/06/Compile-Loader-Libraries-Part-2-Dynamic-linking/&title=Compile/Loader/Libraries: Part 2 Dynamic linking"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://blog.mwish.me/2024/12/06/Compile-Loader-Libraries-Part-2-Dynamic-linking/&title=Compile/Loader/Libraries: Part 2 Dynamic linking"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://blog.mwish.me/2024/12/06/Compile-Loader-Libraries-Part-2-Dynamic-linking/&title=Compile/Loader/Libraries: Part 2 Dynamic linking"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://blog.mwish.me/2024/12/06/Compile-Loader-Libraries-Part-2-Dynamic-linking/&title=Compile/Loader/Libraries: Part 2 Dynamic linking"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://blog.mwish.me/2024/12/06/Compile-Loader-Libraries-Part-2-Dynamic-linking/&name=Compile/Loader/Libraries: Part 2 Dynamic linking&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://blog.mwish.me/2024/12/06/Compile-Loader-Libraries-Part-2-Dynamic-linking/&t=Compile/Loader/Libraries: Part 2 Dynamic linking"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%AF%E6%89%A7%E8%A1%8C%E6%96%87%E4%BB%B6%E7%9A%84-Load-%E5%92%8C%E8%BF%9B%E7%A8%8B"><span class="toc-number">1.</span> <span class="toc-text">可执行文件的 Load 和进程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5"><span class="toc-number">2.</span> <span class="toc-text">动态链接</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%B0%E5%9D%80%E6%97%A0%E5%85%B3%E4%BB%A3%E7%A0%81%E5%92%8C-GOT"><span class="toc-number">2.1.</span> <span class="toc-text">地址无关代码和 GOT</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#MaskRay-%E5%8D%9A%E5%AE%A2%E4%B8%8A%E7%9A%84%E8%AE%A8%E8%AE%BA"><span class="toc-number">2.1.1.</span> <span class="toc-text">MaskRay 博客上的讨论</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BB%B6%E8%BF%9F%E7%BB%91%E5%AE%9A%E5%92%8C-PLT"><span class="toc-number">2.2.</span> <span class="toc-text">延迟绑定和 PLT</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5%E7%9A%84%E8%BF%87%E7%A8%8B"><span class="toc-number">2.3.</span> <span class="toc-text">动态链接的过程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%98%BE%E5%BC%8F%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5"><span class="toc-number">2.4.</span> <span class="toc-text">显式动态链接</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#References"><span class="toc-number">3.</span> <span class="toc-text">References</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        Compile/Loader/Libraries: Part 2 Dynamic linking
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">mwish</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2024-12-05T17:00:54.000Z" itemprop="datePublished">2024-12-06</time>
        
      
    </div>


      

      

    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <p>在上一篇，我们了解了静态链接和对应的环境 <a href="https://blog.mwish.me/2024/11/20/Compile-Loader-Libraries-Part-1-Static-linking/">https://blog.mwish.me/2024/11/20/Compile-Loader-Libraries-Part-1-Static-linking/</a>  这部分我们需要介绍加载、动态链接和库</p>
<h2 id="可执行文件的-Load-和进程"><a href="#可执行文件的-Load-和进程" class="headerlink" title="可执行文件的 Load 和进程"></a>可执行文件的 Load 和进程</h2><p>作者（有一些咬文嚼字的）认为：</p>
<ul>
<li>程序是静态的概念，指编译好的指令/数据的文件（那个 ELF 可执行文件？），因为这个原因，所以有的时候可执行文件还会被称为映像文件(image)</li>
<li>进程是动态的概念，指被加载、运行的程序进程，有自己的虚拟地址空间</li>
</ul>
<p>又翻到一张 rCore 的地址空间图。书上还有很多32位地址空间的讨论，但这块没看的必要了。</p>
<p><img src="https://image.mwish.me/blog-image/8629188967446540905.png" alt="img"></p>
<p>在书上提到了程序 Binary 的内存管理的方式，Overlay 和 Paging。Paging 是我们今天很熟悉的方式，以内存映射的方式来读取，Overlay 是以树形结构或者别的结构，自己 aware 程序的结构，并手动管理子结构的换入换出</p>
<p><img src="https://image.mwish.me/blog-image/3540751129526476111.png" alt="img"></p>
<p>Paging 映射的方式本质上也是现在操作系统 mmap / 内存管理的方式。在进程建立后（一些流程可能会在之后详细描述），这里执行 <code>fork + exec</code> 的逻辑大概是：</p>
<ol>
<li>创建一个独立的虚拟地址空间<ol>
<li>设置 PageTable 映射之类的</li>
</ol>
</li>
<li>读取可执行文件头，进行映射<ol>
<li>VMA 上构建磁盘上 section 到内存的映射</li>
<li>ELF 上有几种 section: 可执行的 <code>text</code>，可读可写的（比如 <code>.bss</code>）和只读的 （<code>.strtab</code> 等多种）。对于类似权限的 section，链接的时候可以某种程度上合并到一起，而 Load 的时候，也可以把它们一起 Load 。这种对象可以被称之为 segment，如图 6-7。Segment 包含一个或者多个属性类似的 Section。<code>readelf -S</code> 能显示对应的 Segment，<code>readelf -l</code> 也能看到被 load 的方式</li>
</ol>
</li>
<li>指令寄存器设置到对应地址，启动！</li>
</ol>
<p><img src="https://image.mwish.me/blog-image/2797812280891855987.png" alt="img"></p>
<p>这里可以尝试下面的程序，进入 llvm 例子阶段！</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">    sleep(<span class="number">1000</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后 <code>readelf</code> 查看 section 和 segments</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// llvm-readelf -S a.out </span></span><br><span class="line">There are <span class="number">33</span> section headers, starting at offset <span class="number">0xd4d60</span>:</span><br><span class="line"></span><br><span class="line">Section Headers:</span><br><span class="line">  [Nr] Name              Type            Address          Off    Size   ES Flg Lk Inf Al</span><br><span class="line">  [ <span class="number">0</span>]                   <span class="literal">NULL</span>            <span class="number">0000000000000000</span> <span class="number">000000</span> <span class="number">000000</span> <span class="number">00</span>      <span class="number">0</span>   <span class="number">0</span>  <span class="number">0</span></span><br><span class="line">  [ <span class="number">1</span>] .note.ABI-tag     NOTE            <span class="number">0000000000400238</span> <span class="number">000238</span> <span class="number">000020</span> <span class="number">00</span>   A  <span class="number">0</span>   <span class="number">0</span>  <span class="number">4</span></span><br><span class="line">  [ <span class="number">2</span>] .rela.plt         RELA            <span class="number">0000000000400258</span> <span class="number">000258</span> <span class="number">000108</span> <span class="number">18</span>  AI  <span class="number">0</span>  <span class="number">24</span>  <span class="number">8</span></span><br><span class="line">  [ <span class="number">3</span>] .init             PROGBITS        <span class="number">0000000000401000</span> <span class="number">001000</span> <span class="number">00001</span>a <span class="number">00</span>  AX  <span class="number">0</span>   <span class="number">0</span>  <span class="number">4</span></span><br><span class="line">  [ <span class="number">4</span>] .plt              PROGBITS        <span class="number">0000000000401020</span> <span class="number">001020</span> <span class="number">000058</span> <span class="number">00</span>  AX  <span class="number">0</span>   <span class="number">0</span>  <span class="number">8</span></span><br><span class="line">  [ <span class="number">5</span>] .text             PROGBITS        <span class="number">0000000000401080</span> <span class="number">001080</span> <span class="number">092</span>c26 <span class="number">00</span>  AX  <span class="number">0</span>   <span class="number">0</span> <span class="number">16</span></span><br><span class="line">  [ <span class="number">6</span>] __libc_thread_freeres_fn PROGBITS <span class="number">0000000000493</span>cb0 <span class="number">093</span>cb0 <span class="number">0000b</span>2 <span class="number">00</span>  AX  <span class="number">0</span>   <span class="number">0</span> <span class="number">16</span></span><br><span class="line">  [ <span class="number">7</span>] __libc_freeres_fn PROGBITS        <span class="number">0000000000493</span>d70 <span class="number">093</span>d70 <span class="number">001</span>aef <span class="number">00</span>  AX  <span class="number">0</span>   <span class="number">0</span> <span class="number">16</span></span><br><span class="line">  [ <span class="number">8</span>] .fini             PROGBITS        <span class="number">0000000000495860</span> <span class="number">095860</span> <span class="number">000009</span> <span class="number">00</span>  AX  <span class="number">0</span>   <span class="number">0</span>  <span class="number">4</span></span><br><span class="line">  [ <span class="number">9</span>] .rodata           PROGBITS        <span class="number">0000000000496000</span> <span class="number">096000</span> <span class="number">01949</span>c <span class="number">00</span>   A  <span class="number">0</span>   <span class="number">0</span> <span class="number">32</span></span><br><span class="line">  [<span class="number">10</span>] .stapsdt.base     PROGBITS        <span class="number">00000000004</span>af49c <span class="number">0</span>af49c <span class="number">000001</span> <span class="number">00</span>   A  <span class="number">0</span>   <span class="number">0</span>  <span class="number">1</span></span><br><span class="line">  [<span class="number">11</span>] __libc_thread_subfreeres PROGBITS <span class="number">00000000004</span>af4a0 <span class="number">0</span>af4a0 <span class="number">000008</span> <span class="number">00</span>   A  <span class="number">0</span>   <span class="number">0</span>  <span class="number">8</span></span><br><span class="line">  [<span class="number">12</span>] __libc_subfreeres PROGBITS        <span class="number">00000000004</span>af4a8 <span class="number">0</span>af4a8 <span class="number">000050</span> <span class="number">00</span>   A  <span class="number">0</span>   <span class="number">0</span>  <span class="number">8</span></span><br><span class="line">  [<span class="number">13</span>] __libc_IO_vtables PROGBITS        <span class="number">00000000004</span>af500 <span class="number">0</span>af500 <span class="number">0006</span>a8 <span class="number">00</span>   A  <span class="number">0</span>   <span class="number">0</span> <span class="number">32</span></span><br><span class="line">  [<span class="number">14</span>] __libc_atexit     PROGBITS        <span class="number">00000000004</span>afba8 <span class="number">0</span>afba8 <span class="number">000008</span> <span class="number">00</span>   A  <span class="number">0</span>   <span class="number">0</span>  <span class="number">8</span></span><br><span class="line">  [<span class="number">15</span>] .eh_frame_hdr     PROGBITS        <span class="number">00000000004</span>afbb0 <span class="number">0</span>afbb0 <span class="number">0022b</span>4 <span class="number">00</span>   A  <span class="number">0</span>   <span class="number">0</span>  <span class="number">4</span></span><br><span class="line">  [<span class="number">16</span>] .eh_frame         PROGBITS        <span class="number">00000000004b</span>1e68 <span class="number">0b1</span>e68 <span class="number">00</span>dd58 <span class="number">00</span>   A  <span class="number">0</span>   <span class="number">0</span>  <span class="number">8</span></span><br><span class="line">  [<span class="number">17</span>] .gcc_except_table PROGBITS        <span class="number">00000000004b</span>fbc0 <span class="number">0b</span>fbc0 <span class="number">000105</span> <span class="number">00</span>   A  <span class="number">0</span>   <span class="number">0</span>  <span class="number">1</span></span><br><span class="line">  [<span class="number">18</span>] .tdata            PROGBITS        <span class="number">00000000004</span>c0ec0 <span class="number">0b</span>fec0 <span class="number">000020</span> <span class="number">00</span> WAT  <span class="number">0</span>   <span class="number">0</span> <span class="number">16</span></span><br><span class="line">  [<span class="number">19</span>] .tbss             NOBITS          <span class="number">00000000004</span>c0ee0 <span class="number">0b</span>fee0 <span class="number">000038</span> <span class="number">00</span> WAT  <span class="number">0</span>   <span class="number">0</span> <span class="number">16</span></span><br><span class="line">  [<span class="number">20</span>] .init_array       INIT_ARRAY      <span class="number">00000000004</span>c0ee0 <span class="number">0b</span>fee0 <span class="number">000010</span> <span class="number">08</span>  WA  <span class="number">0</span>   <span class="number">0</span>  <span class="number">8</span></span><br><span class="line">  [<span class="number">21</span>] .fini_array       FINI_ARRAY      <span class="number">00000000004</span>c0ef0 <span class="number">0b</span>fef0 <span class="number">000010</span> <span class="number">08</span>  WA  <span class="number">0</span>   <span class="number">0</span>  <span class="number">8</span></span><br><span class="line">  [<span class="number">22</span>] .data.rel.ro      PROGBITS        <span class="number">00000000004</span>c0f00 <span class="number">0b</span>ff00 <span class="number">0000e4</span> <span class="number">00</span>  WA  <span class="number">0</span>   <span class="number">0</span> <span class="number">32</span></span><br><span class="line">  [<span class="number">23</span>] .got              PROGBITS        <span class="number">00000000004</span>c0fe8 <span class="number">0b</span>ffe8 <span class="number">000008</span> <span class="number">00</span>  WA  <span class="number">0</span>   <span class="number">0</span>  <span class="number">8</span></span><br><span class="line">  [<span class="number">24</span>] .got.plt          PROGBITS        <span class="number">00000000004</span>c1000 <span class="number">0</span>c0000 <span class="number">000070</span> <span class="number">08</span>  WA  <span class="number">0</span>   <span class="number">0</span>  <span class="number">8</span></span><br><span class="line">  [<span class="number">25</span>] .data             PROGBITS        <span class="number">00000000004</span>c1080 <span class="number">0</span>c0080 <span class="number">001690</span> <span class="number">00</span>  WA  <span class="number">0</span>   <span class="number">0</span> <span class="number">32</span></span><br><span class="line">  [<span class="number">26</span>] .bss              NOBITS          <span class="number">00000000004</span>c2720 <span class="number">0</span>c1710 <span class="number">002158</span> <span class="number">00</span>  WA  <span class="number">0</span>   <span class="number">0</span> <span class="number">32</span></span><br><span class="line">  [<span class="number">27</span>] __libc_freeres_ptrs NOBITS        <span class="number">00000000004</span>c4878 <span class="number">0</span>c1710 <span class="number">000030</span> <span class="number">00</span>  WA  <span class="number">0</span>   <span class="number">0</span>  <span class="number">8</span></span><br><span class="line">  [<span class="number">28</span>] .comment          PROGBITS        <span class="number">0000000000000000</span> <span class="number">0</span>c1710 <span class="number">000070</span> <span class="number">01</span>  MS  <span class="number">0</span>   <span class="number">0</span>  <span class="number">1</span></span><br><span class="line">  [<span class="number">29</span>] .note.stapsdt     NOTE            <span class="number">0000000000000000</span> <span class="number">0</span>c1780 <span class="number">000f</span>40 <span class="number">00</span>      <span class="number">0</span>   <span class="number">0</span>  <span class="number">4</span></span><br><span class="line">  [<span class="number">30</span>] .symtab           SYMTAB          <span class="number">0000000000000000</span> <span class="number">0</span>c26c0 <span class="number">00b</span>9e8 <span class="number">18</span>     <span class="number">31</span> <span class="number">810</span>  <span class="number">8</span></span><br><span class="line">  [<span class="number">31</span>] .strtab           STRTAB          <span class="number">0000000000000000</span> <span class="number">0</span>ce0a8 <span class="number">006b</span>47 <span class="number">00</span>      <span class="number">0</span>   <span class="number">0</span>  <span class="number">1</span></span><br><span class="line">  [<span class="number">32</span>] .shstrtab         STRTAB          <span class="number">0000000000000000</span> <span class="number">0</span>d4bef <span class="number">000171</span> <span class="number">00</span>      <span class="number">0</span>   <span class="number">0</span>  <span class="number">1</span></span><br><span class="line">Key to Flags:</span><br><span class="line">  W (write), A (alloc), X (execute), M (merge), S (strings), I (info),</span><br><span class="line">  L (link order), O (extra OS processing required), G (group), T (TLS),</span><br><span class="line">  C (compressed), x (unknown), o (OS specific), E (exclude),</span><br><span class="line">  R (retain), l (large), p (processor specific)</span><br><span class="line">  </span><br><span class="line"><span class="comment">// llvm-readelf -l a.out </span></span><br><span class="line"></span><br><span class="line">Elf file type is <span class="title function_">EXEC</span> <span class="params">(Executable file)</span></span><br><span class="line">Entry point 0x401c3d</span><br><span class="line">There are 9 program headers, starting at offset 64</span><br><span class="line"></span><br><span class="line">Program Headers:</span><br><span class="line">  Type           Offset   VirtAddr           PhysAddr           FileSiz  MemSiz   Flg Align</span><br><span class="line">  LOAD           0x000000 0x0000000000400000 0x0000000000400000 0x000360 0x000360 R   0x1000</span><br><span class="line">  LOAD           0x001000 0x0000000000401000 0x0000000000401000 0x094869 0x094869 R E 0x1000</span><br><span class="line">  LOAD           0x096000 0x0000000000496000 0x0000000000496000 0x029cc5 0x029cc5 R   0x1000</span><br><span class="line">  LOAD           0x0bfec0 0x00000000004c0ec0 0x00000000004c0ec0 0x001850 0x0039e8 RW  0x1000</span><br><span class="line">  NOTE           0x000238 0x0000000000400238 0x0000000000400238 0x000020 0x000020 R   0x4</span><br><span class="line">  TLS            0x0bfec0 0x00000000004c0ec0 0x00000000004c0ec0 0x000020 0x000058 R   0x10</span><br><span class="line">  GNU_EH_FRAME   0x0afbb0 0x00000000004afbb0 0x00000000004afbb0 0x0022b4 0x0022b4 R   0x4</span><br><span class="line">  GNU_STACK      0x000000 0x0000000000000000 0x0000000000000000 0x000000 0x000000 RW  0x10</span><br><span class="line">  GNU_RELRO      0x0bfec0 0x00000000004c0ec0 0x00000000004c0ec0 0x000140 0x000140 R   0x1</span><br><span class="line"></span><br><span class="line"> Section to Segment mapping:</span><br><span class="line">  Segment Sections...</span><br><span class="line">   00     .note.ABI-tag .rela.plt </span><br><span class="line">   01     .init .plt .text __libc_thread_freeres_fn __libc_freeres_fn .fini </span><br><span class="line">   02     .rodata .stapsdt.base __libc_thread_subfreeres __libc_subfreeres __libc_IO_vtables __libc_atexit .eh_frame_hdr .eh_frame .gcc_except_table </span><br><span class="line">   03     .tdata .init_array .fini_array .data.rel.ro .got .got.plt .data .bss __libc_freeres_ptrs </span><br><span class="line">   04     .note.ABI-tag </span><br><span class="line">   05     .tdata .tbss </span><br><span class="line">   06     .eh_frame_hdr </span><br><span class="line">   07     </span><br><span class="line">   08     .tdata .init_array .fini_array .data.rel.ro .got </span><br><span class="line">   None   .comment .note.stapsdt .symtab .strtab .shstrtab </span><br></pre></td></tr></table></figure>
<p>这里对应映射如图（书有点老，意思一下就行）：</p>
<ul>
<li>Type 有 LOAD 等类型的 Segments，fileSiz 是文件上的大小，MemSiz 是映射的内存上的大小。如果 MemSiz 更大，后面需要初始化成 0</li>
<li>BSS 段之类的内容要被 zero-initialize，初始化成 0，对于 <code>0x001850 0x0039e8</code> 这种，可能后面可以给 bss 开辟空间，令其被 zero-initialized</li>
</ul>
<p><img src="https://image.mwish.me/blog-image/8541393186470268469.png" alt="img"></p>
<p><img src="https://image.mwish.me/blog-image/8340745219183224494.png" alt="img"></p>
<p>这里运行上面的程序，来查看 <code>/proc</code> 看虚拟空间（这里毕竟是一个 sleep 程序）:</p>
<ol>
<li>VMA 前四个是执行文件的 Segment</li>
<li>后面是 Anonymous Virtual Memory Area，没有影射到文件中</li>
<li>Vdso 是一个内核模块，它和 vsyscall 可以参考下面的博客，大概意思是 vdso / vsyscall 都是一些 syscall 绕过陷入内核的机制。<ol>
<li>Linux vDSO概述 - 乾越的文章 -<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/436454953">https://zhuanlan.zhihu.com/p/436454953</a> </li>
<li><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/19938324/what-are-vdso-and-vsyscall">https://stackoverflow.com/questions/19938324/what-are-vdso-and-vsyscall</a></li>
</ol>
</li>
<li>相比书中写作的时候，如果你 -fPIE，这里还有合适的 ASLR 机制，能够让访问的地址并不固定。不过现在咱们静态编译也没这个问题，这段我们后面还能遇到</li>
<li>借助 OS 的机制，可执行文件可能会有物理上的段合并，如上图 6-11</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">cat /proc/&#123;pid&#125;/maps             </span><br><span class="line"><span class="number">00400000</span><span class="number">-00401000</span> r--p <span class="number">00000000</span> fd:<span class="number">11</span> <span class="number">9043977</span>                            learn-compile/a.out</span><br><span class="line"><span class="number">00401000</span><span class="number">-00496000</span> r-xp <span class="number">00001000</span> fd:<span class="number">11</span> <span class="number">9043977</span>                            learn-compile/a.out</span><br><span class="line"><span class="number">00496000</span><span class="number">-004</span>c0000 r--p <span class="number">00096000</span> fd:<span class="number">11</span> <span class="number">9043977</span>                            learn-compile/a.out</span><br><span class="line"><span class="number">004</span>c0000<span class="number">-004</span>c3000 rw-p <span class="number">000b</span>f000 fd:<span class="number">11</span> <span class="number">9043977</span>                            learn-compile/a.out</span><br><span class="line"><span class="number">004</span>c3000<span class="number">-004</span>c5000 rw-p <span class="number">00000000</span> <span class="number">00</span>:<span class="number">00</span> <span class="number">0</span> </span><br><span class="line"><span class="number">02418000</span><span class="number">-0243b</span>000 rw-p <span class="number">00000000</span> <span class="number">00</span>:<span class="number">00</span> <span class="number">0</span>                                  [heap]</span><br><span class="line"><span class="number">7f</span>fffe973000<span class="number">-7f</span>fffe995000 rw-p <span class="number">00000000</span> <span class="number">00</span>:<span class="number">00</span> <span class="number">0</span>                          [<span class="built_in">stack</span>]</span><br><span class="line"><span class="number">7f</span>fffe9f8000<span class="number">-7f</span>fffe9fa000 r-xp <span class="number">00000000</span> <span class="number">00</span>:<span class="number">00</span> <span class="number">0</span>                          [vdso]</span><br><span class="line">ffffffffff600000-ffffffffff601000 r-xp <span class="number">00000000</span> <span class="number">00</span>:<span class="number">00</span> <span class="number">0</span>                  [vsyscall]</span><br></pre></td></tr></table></figure>
<p>我们现在知道 Huge Page 也有被用到程序中，用于优化一些程序加载，如下面的几个例子：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.hudsonrivertrading.com/hrtbeat/low-latency-optimization-part-2/">https://www.hudsonrivertrading.com/hrtbeat/low-latency-optimization-part-2/</a></li>
<li>透明代码大页：让数据库也能用上 2MB 大页！ - 阿里云云栖号的文章 - 知乎<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/621400462">https://zhuanlan.zhihu.com/p/621400462</a></li>
<li><a target="_blank" rel="noopener" href="https://jira.mariadb.org/browse/MDEV-24051">https://jira.mariadb.org/browse/MDEV-24051</a></li>
<li><a target="_blank" rel="noopener" href="https://archive.fosdem.org/2019/schedule/event/hugepages_databases/attachments/slides/3038/export/events/attachments/hugepages_databases/slides/3038/Huge_pages_and_databases___FOSDEM19.pdf">https://archive.fosdem.org/2019/schedule/event/hugepages_databases/attachments/slides/3038/export/events/attachments/hugepages_databases/slides/3038/Huge_pages_and_databases___FOSDEM19.pdf</a></li>
</ul>
<h2 id="动态链接"><a href="#动态链接" class="headerlink" title="动态链接"></a>动态链接</h2><p>静态链接的 Binary 都要链到一起，all in one binary 是个好主意（甚至现在很多地方都推荐源码整个编译）。解决方案是某种程度上分离程序，然后「动态」的</p>
<p><img src="https://image.mwish.me/blog-image/1380078064477421890.png" alt="img"></p>
<p>DLL/.so/.dylib 在这里也有版本问题，即 DLL Hell，早期的 so/dll 缺乏版本管理机制，导致这块很折磨人。</p>
<p>动态链接是把程序拆分开来，在运行的时候才链接成一个完整的程序。显然，这里执行的时候涉及多个文件，也需要操作系统的支持（如上图，你显然要合适的给进程分配出合适的位置）。ELF 动态链接文件被称为动态共享对象（DSO, Dynamic Shared Objects），一般以 <code>.so</code> 为扩展名，Windows 则常是 <code>.dll</code>，Mac 下则是 <code>.dylib</code>。Linux 下常用的 C 语言的运行库称之为 glibc，常放在 <code>/lib</code> 下的 <code>libc.so</code>。系统的动态连接器会负责加载它，然后绑定没有决议的符号，进行 Relocate。</p>
<p>下面给出测试和实验的 code:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// cat lib.c  </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">foobar</span><span class="params">(<span class="type">int</span> i)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;printing from lib.so %d\n&quot;</span>, i);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// cat lib.h</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">foobar</span><span class="params">(<span class="type">int</span> i)</span></span>;</span><br><span class="line"><span class="comment">// cat program1.c </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;lib.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="built_in">foobar</span>(<span class="number">1</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// cat program2.c</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;lib.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="built_in">foobar</span>(<span class="number">2</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里编译一把 <code>clang -fPIC -shared -o lib.so lib.c</code> 后，可以再去编译：<code>clang -o program1 program1.c lib.so</code>，然后就能跑了（记得 <code>LD_LIBRARY_PATH</code> 和 <code>LD_PRELOAD</code> )</p>
<p><img src="https://image.mwish.me/blog-image/3989383184023196757.png" alt="img"></p>
<p>这里我们看到，链接的时候，我们还是指定了 <code>lib.dylib</code> 作为参数. 在这里，我们首先知道：</p>
<ol>
<li>如果编译 <code>program1.c</code> 到 <code>program1.o</code>，这个 ELF 文件是不知道 <code>foobar</code> 调用是动态还是静态的，相关信息都躺在 <code>rela</code> 里头</li>
<li>链接的时候，需要接受 <code>lib</code> 作为输入文件，它里面也保存了完整的符号信息，链接器知道最终是一个对动态符号的引用</li>
</ol>
<p>在虚地址空间中，<code>cat /proc/&#123;pid&#125;/maps</code> 之后，能发现对 <code>lib.so</code> 和别的地方的映射 ，另外还有别的共享对象 <code>ld-2.18.so</code>，就是动态链接器</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">cat /proc/<span class="number">26247</span>/maps </span><br><span class="line"><span class="number">555f</span>a03bc000<span class="number">-555f</span>a03bd000 r--p <span class="number">00000000</span> fd:<span class="number">11</span> <span class="number">9044026</span>                    ../learn-compile/program1</span><br><span class="line"><span class="number">555f</span>a03bd000<span class="number">-555f</span>a03be000 r-xp <span class="number">00001000</span> fd:<span class="number">11</span> <span class="number">9044026</span>                    ../learn-compile/program1</span><br><span class="line"><span class="number">555f</span>a03be000<span class="number">-555f</span>a03bf000 r--p <span class="number">00002000</span> fd:<span class="number">11</span> <span class="number">9044026</span>                    ../learn-compile/program1</span><br><span class="line"><span class="number">555f</span>a03bf000<span class="number">-555f</span>a03c0000 r--p <span class="number">00002000</span> fd:<span class="number">11</span> <span class="number">9044026</span>                    ../learn-compile/program1</span><br><span class="line"><span class="number">555f</span>a03c0000<span class="number">-555f</span>a03c1000 rw-p <span class="number">00003000</span> fd:<span class="number">11</span> <span class="number">9044026</span>                    ../learn-compile/program1</span><br><span class="line"><span class="number">7f</span>3174554000<span class="number">-7f</span>31746fe000 r-xp <span class="number">00000000</span> fd:<span class="number">01</span> <span class="number">675913</span>                     /usr/lib64/libc<span class="number">-2.18</span>.so.bak</span><br><span class="line"><span class="number">7f</span>31746fe000<span class="number">-7f</span>31748fe000 ---p <span class="number">001</span>aa000 fd:<span class="number">01</span> <span class="number">675913</span>                     /usr/lib64/libc<span class="number">-2.18</span>.so.bak</span><br><span class="line"><span class="number">7f</span>31748fe000<span class="number">-7f</span>3174902000 r--p <span class="number">001</span>aa000 fd:<span class="number">01</span> <span class="number">675913</span>                     /usr/lib64/libc<span class="number">-2.18</span>.so.bak</span><br><span class="line"><span class="number">7f</span>3174902000<span class="number">-7f</span>3174904000 rw-p <span class="number">001</span>ae000 fd:<span class="number">01</span> <span class="number">675913</span>                     /usr/lib64/libc<span class="number">-2.18</span>.so.bak</span><br><span class="line"><span class="number">7f</span>3174904000<span class="number">-7f</span>3174908000 rw-p <span class="number">00000000</span> <span class="number">00</span>:<span class="number">00</span> <span class="number">0</span> </span><br><span class="line"><span class="number">7f</span>3174908000<span class="number">-7f</span>3174929000 r-xp <span class="number">00000000</span> fd:<span class="number">01</span> <span class="number">674975</span>                     /usr/lib64/ld<span class="number">-2.18</span>.so</span><br><span class="line"><span class="number">7f</span>3174b10000<span class="number">-7f</span>3174b13000 rw-p <span class="number">00000000</span> <span class="number">00</span>:<span class="number">00</span> <span class="number">0</span> </span><br><span class="line"><span class="number">7f</span>3174b21000<span class="number">-7f</span>3174b22000 rw-p <span class="number">00000000</span> <span class="number">00</span>:<span class="number">00</span> <span class="number">0</span> </span><br><span class="line"><span class="number">7f</span>3174b22000<span class="number">-7f</span>3174b23000 r--p <span class="number">00000000</span> fd:<span class="number">11</span> <span class="number">9044017</span>                    ../learn-compile/lib.so</span><br><span class="line"><span class="number">7f</span>3174b23000<span class="number">-7f</span>3174b24000 r-xp <span class="number">00001000</span> fd:<span class="number">11</span> <span class="number">9044017</span>                    ../learn-compile/lib.so</span><br><span class="line"><span class="number">7f</span>3174b24000<span class="number">-7f</span>3174b25000 r--p <span class="number">00002000</span> fd:<span class="number">11</span> <span class="number">9044017</span>                    ../learn-compile/lib.so</span><br><span class="line"><span class="number">7f</span>3174b25000<span class="number">-7f</span>3174b26000 r--p <span class="number">00002000</span> fd:<span class="number">11</span> <span class="number">9044017</span>                    ../learn-compile/lib.so</span><br><span class="line"><span class="number">7f</span>3174b26000<span class="number">-7f</span>3174b27000 rw-p <span class="number">00003000</span> fd:<span class="number">11</span> <span class="number">9044017</span>                    ../learn-compile/lib.so</span><br><span class="line"><span class="number">7f</span>3174b27000<span class="number">-7f</span>3174b28000 rw-p <span class="number">00000000</span> <span class="number">00</span>:<span class="number">00</span> <span class="number">0</span> </span><br><span class="line"><span class="number">7f</span>3174b28000<span class="number">-7f</span>3174b29000 r--p <span class="number">00020000</span> fd:<span class="number">01</span> <span class="number">674975</span>                     /usr/lib64/ld<span class="number">-2.18</span>.so</span><br><span class="line"><span class="number">7f</span>3174b29000<span class="number">-7f</span>3174b2a000 rw-p <span class="number">00021000</span> fd:<span class="number">01</span> <span class="number">674975</span>                     /usr/lib64/ld<span class="number">-2.18</span>.so</span><br><span class="line"><span class="number">7f</span>3174b2a000<span class="number">-7f</span>3174b2b000 rw-p <span class="number">00000000</span> <span class="number">00</span>:<span class="number">00</span> <span class="number">0</span> </span><br><span class="line"><span class="number">7f</span>ff460a6000<span class="number">-7f</span>ff460c8000 rw-p <span class="number">00000000</span> <span class="number">00</span>:<span class="number">00</span> <span class="number">0</span>                          [<span class="built_in">stack</span>]</span><br><span class="line"><span class="number">7f</span>ff460ea000<span class="number">-7f</span>ff460ec000 r-xp <span class="number">00000000</span> <span class="number">00</span>:<span class="number">00</span> <span class="number">0</span>                          [vdso]</span><br><span class="line">ffffffffff600000-ffffffffff601000 r-xp <span class="number">00000000</span> <span class="number">00</span>:<span class="number">00</span> <span class="number">0</span>                  [vsyscall]</span><br></pre></td></tr></table></figure>
<p>还记得之前的装载属性吗？我们 <code>llvm-readelf -l</code> 看看呢：我们会发现这里的文件类型和普通类型不一样，同时，<code>DYNAMIC</code> 的属性出现了</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">llvm-readelf -l program1</span><br><span class="line"></span><br><span class="line">Elf file type is <span class="title function_">DYN</span> <span class="params">(Shared object file)</span></span><br><span class="line">Entry point 0x1070</span><br><span class="line">There are 11 program headers, starting at offset 64</span><br><span class="line"></span><br><span class="line">Program Headers:</span><br><span class="line">  Type           Offset   VirtAddr           PhysAddr           FileSiz  MemSiz   Flg Align</span><br><span class="line">  PHDR           0x000040 0x0000000000000040 0x0000000000000040 0x000268 0x000268 R   0x8</span><br><span class="line">  INTERP         0x0002a8 0x00000000000002a8 0x00000000000002a8 0x00001c 0x00001c R   0x1</span><br><span class="line">      [Requesting program interpreter: /lib64/ld-linux-x86-64.so.2]</span><br><span class="line">  LOAD           0x000000 0x0000000000000000 0x0000000000000000 0x0005c0 0x0005c0 R   0x1000</span><br><span class="line">  LOAD           0x001000 0x0000000000001000 0x0000000000001000 0x00020d 0x00020d R E 0x1000</span><br><span class="line">  LOAD           0x002000 0x0000000000002000 0x0000000000002000 0x000128 0x000128 R   0x1000</span><br><span class="line">  LOAD           0x002dd8 0x0000000000003dd8 0x0000000000003dd8 0x000264 0x000268 RW  0x1000</span><br><span class="line">  DYNAMIC        0x002df0 0x0000000000003df0 0x0000000000003df0 0x0001f0 0x0001f0 RW  0x8</span><br><span class="line">  NOTE           0x0002c4 0x00000000000002c4 0x00000000000002c4 0x000020 0x000020 R   0x4</span><br><span class="line">  GNU_EH_FRAME   0x002004 0x0000000000002004 0x0000000000002004 0x000034 0x000034 R   0x4</span><br><span class="line">  GNU_STACK      0x000000 0x0000000000000000 0x0000000000000000 0x000000 0x000000 RW  0x10</span><br><span class="line">  GNU_RELRO      0x002dd8 0x0000000000003dd8 0x0000000000003dd8 0x000228 0x000228 R   0x1</span><br><span class="line"></span><br><span class="line"> Section to Segment mapping:</span><br><span class="line">  Segment Sections...</span><br><span class="line">   00     </span><br><span class="line">   01     .interp </span><br><span class="line">   02     .interp .note.ABI-tag .gnu.hash .dynsym .dynstr .gnu.version .gnu.version_r .rela.dyn .rela.plt </span><br><span class="line">   03     .init .plt .text .fini </span><br><span class="line">   04     .rodata .eh_frame_hdr .eh_frame </span><br><span class="line">   05     .init_array .fini_array .data.rel.ro .dynamic .got .got.plt .data .bss </span><br><span class="line">   06     .dynamic </span><br><span class="line">   07     .note.ABI-tag </span><br><span class="line">   08     .eh_frame_hdr </span><br><span class="line">   09     </span><br><span class="line">   10     .init_array .fini_array .data.rel.ro .dynamic .got </span><br><span class="line">   None   .comment .symtab .strtab .shstrtab </span><br></pre></td></tr></table></figure>
<h3 id="地址无关代码和-GOT"><a href="#地址无关代码和-GOT" class="headerlink" title="地址无关代码和 GOT"></a>地址无关代码和 GOT</h3><p>最早期 PE/COFF 之类的地方引入了 “shared static library”，大概是需要一个固定分配的地址，见：<a target="_blank" rel="noopener" href="https://maskray.me/blog/2023-12-03-linker-notes-on-pe-coff">https://maskray.me/blog/2023-12-03-linker-notes-on-pe-coff</a> 。不管怎么样，感觉这种 “shared static library” 还是比较不方便的。</p>
<p>这里希望共享对象装载的时候能在任意地址装载，这里希望：链接的时候，绝对地址的引用不做重定位，推迟到 Load 的时候完成。之前静态链接则是「链接时重定位」，现在则变成了希望动态决定这些。</p>
<p>这个说法是比较简单的，但是程序编译的时候本身也有一个目标地址，如果 load 的时候再重定位不就行了吗！主意很好，但实际上这里麻烦可能在细一点的地方：之前静态链接的时候，大家都编译到一起，这没啥问题，但是反过来，动态链接那个被链接的共享对象，要在多个地方（进程）共享，可能不能比较方便的定下一个固定的地址</p>
<p><img src="https://image.mwish.me/blog-image/2358980861257600997.png" alt="img"></p>
<p>这里我们回到之前编译的参数：</p>
<ul>
<li>如果只使用 <code>-shared</code>，这里会在 Load 的时候重定位，直接在加载期间填写上一些对应的映射关系</li>
<li>如果使用 <code>-shared</code> + <code>-fPIC</code>，就会生成位置无关代码（Position-independent Code），便于指令的共享。对于现代机器来说，这也不麻烦</li>
</ul>
<p>这里可以写大概几种引用情况（希望生成书中的情况可以 <code>-m32</code>）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> a;</span><br><span class="line"><span class="keyword">extern</span> <span class="type">int</span> b;</span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="type">void</span> <span class="title function_">ext</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">bar</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="comment">// inner module data access</span></span><br><span class="line">  a = <span class="number">1</span>;</span><br><span class="line">  <span class="comment">// inter module data access</span></span><br><span class="line">  b = <span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">foo</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="comment">// inner module call</span></span><br><span class="line">  bar();</span><br><span class="line">  <span class="comment">// inter module call</span></span><br><span class="line">  ext();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们编译后 <code>llvm-objdump -d</code> 一下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// llvm-objdump -d x.o </span></span><br><span class="line"></span><br><span class="line">x.o:    file format elf64-x86<span class="number">-64</span></span><br><span class="line"></span><br><span class="line">Disassembly of section .text:</span><br><span class="line"></span><br><span class="line"><span class="number">0000000000000000</span> &lt;bar&gt;:</span><br><span class="line">       <span class="number">0</span>: <span class="number">55</span>                            pushq   %rbp</span><br><span class="line">       <span class="number">1</span>: <span class="number">48</span> <span class="number">89</span> e5                      movq    %rsp, %rbp</span><br><span class="line">       <span class="number">4</span>: c7 <span class="number">05</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> movl    $<span class="number">0x1</span>, (%rip)            # <span class="number">0xe</span> &lt;bar+<span class="number">0xe</span>&gt;</span><br><span class="line">       e: <span class="number">48</span> <span class="number">8b</span> <span class="number">05</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>          movq    (%rip), %rax            # <span class="number">0x15</span> &lt;bar+<span class="number">0x15</span>&gt;</span><br><span class="line">      <span class="number">15</span>: c7 <span class="number">00</span> <span class="number">02</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>             movl    $<span class="number">0x2</span>, (%rax)</span><br><span class="line">      <span class="number">1b</span>: <span class="number">5</span>d                            popq    %rbp</span><br><span class="line">      <span class="number">1</span>c: c3                            retq</span><br><span class="line">      <span class="number">1</span>d: <span class="number">0f</span> <span class="number">1f</span> <span class="number">00</span>                      nopl    (%rax)</span><br><span class="line"></span><br><span class="line"><span class="number">0000000000000020</span> &lt;foo&gt;:</span><br><span class="line">      <span class="number">20</span>: <span class="number">55</span>                            pushq   %rbp</span><br><span class="line">      <span class="number">21</span>: <span class="number">48</span> <span class="number">89</span> e5                      movq    %rsp, %rbp</span><br><span class="line">      <span class="number">24</span>: e8 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>                callq   <span class="number">0x29</span> &lt;foo+<span class="number">0x9</span>&gt;</span><br><span class="line">      <span class="number">29</span>: b0 <span class="number">00</span>                         movb    $<span class="number">0x0</span>, %al</span><br><span class="line">      <span class="number">2b</span>: e8 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>                callq   <span class="number">0x30</span> &lt;foo+<span class="number">0x10</span>&gt;</span><br><span class="line">      <span class="number">30</span>: <span class="number">5</span>d                            popq    %rbp</span><br><span class="line">      <span class="number">31</span>: c3                            retq</span><br><span class="line"></span><br><span class="line"><span class="comment">// llvm-objdump -r x.o </span></span><br><span class="line"></span><br><span class="line">x.o:    file format elf64-x86<span class="number">-64</span></span><br><span class="line"></span><br><span class="line">RELOCATION RECORDS FOR [.text]:</span><br><span class="line">OFFSET           TYPE                     VALUE</span><br><span class="line"><span class="number">0000000000000006</span> R_X86_64_PC32            .bss<span class="number">-0x8</span></span><br><span class="line"><span class="number">0000000000000011</span> R_X86_64_REX_GOTPCRELX   b<span class="number">-0x4</span></span><br><span class="line"><span class="number">0000000000000025</span> R_X86_64_PLT32           bar<span class="number">-0x4</span></span><br><span class="line"><span class="number">000000000000002</span>c R_X86_64_PLT32           ext<span class="number">-0x4</span></span><br><span class="line"></span><br><span class="line">RELOCATION RECORDS FOR [.eh_frame]:</span><br><span class="line">OFFSET           TYPE                     VALUE</span><br><span class="line"><span class="number">0000000000000020</span> R_X86_64_PC32            .text</span><br><span class="line"><span class="number">0000000000000040</span> R_X86_64_PC32            .text+<span class="number">0x20</span></span><br></pre></td></tr></table></figure>
<ol>
<li>Foo 对 bar 调用是一条相对地址调用指令，忽略共享对象的全局符号表介入（Global Symbol Interposition）问题，这里可以当成相对地址的跳转；bar 对 <code>a</code> 的访问也通过相对地址</li>
<li>模块间的<strong>数据访问</strong>可能需要指向变量的数组，这里可以参考之前我们的 <code>.got</code>, 用 <code>llvm-objdump -h &#123;&#125; --show-lma</code> 可以找到。这里 GOT 也可以保留目标函数的地址。(我个人觉得，某种意义上，这里逻辑是，代码段不可改，所以抽象出了一个可以改的数据段 <code>.got</code>，同时处理这票逻辑）</li>
</ol>
<p>我们看到上面，有 <code>R_X86_64_PC32</code> ( 对 <code>a</code> 这个模块内 static 的访问，使用 PC 相对地址 ）, <code>R_X86_64_PLT32</code> （对 bar 和 ext 的访问） 和 <code>R_X86_64_REX_GOTPCRELX</code> ( 对 <code>b</code> 的访问） 。这里我们有个非常好的参考对象（相对原文），maskray 的博客是这里比较好的介绍（虽然这是他在介绍 relocation overflow 的时候的博客： <a target="_blank" rel="noopener" href="https://maskray.me/blog/2023-05-14-relocation-overflow-and-code-models">https://maskray.me/blog/2023-05-14-relocation-overflow-and-code-models</a> ）。这里特殊的是 <code>R_X86_64_REX_GOTPCRELX</code>，逻辑类似 <code>rdx = .got[n] = &amp;var1</code> ，ELF 在<strong>数据段</strong>建立了一个 GOT 表</p>
<p><img src="https://image.mwish.me/blog-image/8719342898469064858.png" alt="img"></p>
<p>这里看上去很清晰了，但是<strong>特殊的情况是</strong>，一个模块引用了一个<strong>定义在共享对象的全局变量</strong>的时候，比如 <code>static in global</code>，然后这里可能会( 参考 <a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/19373061/what-happens-to-global-and-static-variables-in-a-shared-library-when-it-is-dynam">https://stackoverflow.com/questions/19373061/what-happens-to-global-and-static-variables-in-a-shared-library-when-it-is-dynam</a> ）</p>
<ul>
<li>编译链接的时候，这里面创建 <code>global</code> 对象的一个副本</li>
<li>Got 如果发现这个数据，指向这个副本</li>
</ul>
<p>这里还有个间接以来的行为，我们刚才说了 Unix 下动态链接定义导出符号的结果，那万一是下面这种有依赖的符号呢？实际上这里也需要被特别判定来处理。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> a;</span><br><span class="line"><span class="type">static</span> <span class="type">int</span>* p = &amp;a;</span><br></pre></td></tr></table></figure>
<p>这里 maskray 的 threadlocal 文章还提到了这块和 thread local 的行为：<a target="_blank" rel="noopener" href="https://maskray.me/blog/2021-02-14-all-about-thread-local-storage">https://maskray.me/blog/2021-02-14-all-about-thread-local-storage</a></p>
<h4 id="MaskRay-博客上的讨论"><a href="#MaskRay-博客上的讨论" class="headerlink" title="MaskRay 博客上的讨论"></a>MaskRay 博客上的讨论</h4><p><a target="_blank" rel="noopener" href="https://maskray.me/blog/2021-08-29-all-about-global-offset-table">https://maskray.me/blog/2021-08-29-all-about-global-offset-table</a> : 见 <strong>Compiler behavior</strong> 一节，这里定义三种符号</p>
<p>The address may be:</p>
<ul>
<li>a link-time constant</li>
<li>the load base plus a link-time constant</li>
<li>dependent on runtime computation by ld.so -&gt; 这是比较常见的会存储在 GOT 的场景</li>
</ul>
<p>这里编译出来的 binary 会带上 Global offset Table（通常由 <code>.got</code> 和 <code>.got.plt</code> 组成，<code>.got.plt</code> 持有 <code>.got</code> 需要的符号，而其余内容在 <code>.got</code> 中），他们持有 “link-time constant” 和动态链接产生的对象.</p>
<blockquote>
<p>GOT 生成的重定位引用的第一个一个符号。当链接器第一次看到这样的引用符号时，它会在 GOT 中保留一个条目。对于引用相同符号的后续 GOT 生成重定位，链接器仅重用此条目。</p>
</blockquote>
<p>这里还提到有的优化能把  <code>.got</code> 和 <code>.got.plt</code> 组合到一起。</p>
<h3 id="延迟绑定和-PLT"><a href="#延迟绑定和-PLT" class="headerlink" title="延迟绑定和 PLT"></a>延迟绑定和 PLT</h3><p>这里比较好的内容是博客：<a target="_blank" rel="noopener" href="https://maskray.me/blog/2021-09-19-all-about-procedure-linkage-table">https://maskray.me/blog/2021-09-19-all-about-procedure-linkage-table</a></p>
<p>也可以参考：<a target="_blank" rel="noopener" href="https://ctf-wiki.org/executable/elf/structure/dynamic-sections/">https://ctf-wiki.org/executable/elf/structure/dynamic-sections/</a></p>
<p>在我之前举的例子中，有一个 <code>memcpy@plt</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">call    <span class="built_in">memcpy</span>@PLT</span><br><span class="line"></span><br><span class="line"><span class="comment">// -fno-plt</span></span><br><span class="line">call    qword ptr [rip + <span class="built_in">memcpy</span>@GOTPCREL]</span><br></pre></td></tr></table></figure>
<p>为了直观的展示这部分的印象，可以贴出对应的图，这个图源来自 <a target="_blank" rel="noopener" href="https://ctf-wiki.org/executable/elf/structure/dynamic-sections/">https://ctf-wiki.org/executable/elf/structure/dynamic-sections/</a></p>
<ol>
<li>上面的图为第一次调用的情况</li>
<li>下面的图为随后调用的情况</li>
</ol>
<p><img src="https://image.mwish.me/blog-image/4719154147066187773.png" alt="img"></p>
<p>这里可以看到一个 <code>call memcpy@PLT</code> 的记号。plt 是 ELF 中提供间接映射的东西。我们这里还有：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Disassembly of section .plt:</span><br><span class="line"></span><br><span class="line"><span class="number">0000000000001020</span> &lt;.plt&gt;:</span><br><span class="line">    <span class="number">1020</span>: ff <span class="number">35</span> e2 <span class="number">2f</span> <span class="number">00</span> <span class="number">00</span>             pushq   <span class="number">0x2fe2</span>(%rip)            # <span class="number">0x4008</span> &lt;_GLOBAL_OFFSET_TABLE_+<span class="number">0x8</span>&gt;</span><br><span class="line">    <span class="number">1026</span>: ff <span class="number">25</span> e4 <span class="number">2f</span> <span class="number">00</span> <span class="number">00</span>             jmpq    *<span class="number">0x2fe4</span>(%rip)           # <span class="number">0x4010</span> &lt;_GLOBAL_OFFSET_TABLE_+<span class="number">0x10</span>&gt;</span><br><span class="line">    <span class="number">102</span>c: <span class="number">0f</span> <span class="number">1f</span> <span class="number">40</span> <span class="number">00</span>                   nopl    (%rax)</span><br><span class="line"></span><br><span class="line"><span class="number">0000000000001030</span> &lt;foobar@plt&gt;:</span><br><span class="line">    <span class="number">1030</span>: ff <span class="number">25</span> e2 <span class="number">2f</span> <span class="number">00</span> <span class="number">00</span>             jmpq    *<span class="number">0x2fe2</span>(%rip)           # <span class="number">0x4018</span> &lt;_GLOBAL_OFFSET_TABLE_+<span class="number">0x18</span>&gt;</span><br><span class="line">    <span class="number">1036</span>: <span class="number">68</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>                pushq   $<span class="number">0x0</span></span><br><span class="line">    <span class="number">103b</span>: e9 e0 ff ff ff                jmp     <span class="number">0x1020</span> &lt;.plt&gt;</span><br></pre></td></tr></table></figure>
<p><code>.plt</code> 中 <code>foobar@plt</code> 是一个对应的 stub，值得一提的事这里没有实际代码。前面的 <code>_GLOBAL_OFFSET_TABLE_</code> 是一些预留的位置，可以看 maskray 的博客</p>
<blockquote>
<p>In the assembly dump, <code>foo@plt</code> is such a stub. Note that <code>foo@plt</code> is not a symbol table entry. It is just that objdump displays the PLT entry as <code>foo@plt</code>. We use the notation to describe a stub. The stub consists of 3 instructions. The first jmpq instruction loads an entry from <code>.got.plt</code> and performs an indirect jump. The remaining two instructions will be described when introducing lazy binding.</p>
<p><code>.got.plt</code> holds an array of word size entries. On some architectures (x86-32, x86-64) <code>.got.plt[0]</code> is the link time address of <code>_DYNAMIC</code>. <code>.got.plt[1]</code> and <code>.got.plt[2]</code> are reserved by ld.so. <code>.got.plt[1]</code> is a descriptor of the current component while <code>.got.plt[2]</code> is the address of the PLT resolver.</p>
<p>The subsequent entries are for resolved function addresses. Each entry is relocated by an <code>R_*_JUMP_SLOT</code> dynamic relocation describing the target function symbol. Resolving a function address is also called a binding. There are two binding schemes.</p>
</blockquote>
<p>这里 <code>_GLOBAL_OFFSET_TABLE_</code> 对应 <code>_DYNAMIC</code> 段 ( <code>.dynamic</code> ），在 got 的博客也有介绍。这里 <code>.got.plt</code> 走 <code>elf_machine_fixup_plt</code> 来调用 plt resolver。</p>
<p><img src="https://image.mwish.me/blog-image/8773140081539434308.png" alt="img"></p>
<h3 id="动态链接的过程"><a href="#动态链接的过程" class="headerlink" title="动态链接的过程"></a>动态链接的过程</h3><p>首先，在链接的输出程序中，会有一个 <code>.interp</code> 段。这里可以看到对应有一个 request program interpreter，这里配置链接器也可以参考：<a target="_blank" rel="noopener" href="https://clang.llvm.org/docs/Toolchain.html#linker">https://clang.llvm.org/docs/Toolchain.html#linker</a> ，配置 <code>-fuse-ld</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">llvm-readelf --all program1 | grep inter</span><br><span class="line">  [ <span class="number">1</span>] .interp           PROGBITS        <span class="number">00000000000002</span>a8 <span class="number">0002</span>a8 <span class="number">00001</span>c <span class="number">00</span>   A  <span class="number">0</span>   <span class="number">0</span>  <span class="number">1</span></span><br><span class="line">      [Requesting program interpreter: /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>]</span><br><span class="line">   <span class="number">01</span>     .interp </span><br><span class="line">   <span class="number">02</span>     .interp .note.ABI-tag .gnu.hash .dynsym .dynstr .gnu.version .gnu.version_r .rela.dyn .rela.plt </span><br></pre></td></tr></table></figure>
<p>ELF 中最重要的应该是 <code>.dynamic</code> 段，它有点像动态链接对应的 ELF Header。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">learn-compile llvm-readelf -d lib.so</span><br><span class="line">Dynamic section at offset <span class="number">0x2e20</span> contains <span class="number">24</span> entries:</span><br><span class="line">  Tag                Type           Name/Value</span><br><span class="line">  <span class="number">0x0000000000000001</span> (NEEDED)       Shared library: [libc.so<span class="number">.6</span>]</span><br><span class="line">  <span class="number">0x000000000000000c</span> (INIT)         <span class="number">0x1000</span></span><br><span class="line">  <span class="number">0x000000000000000d</span> (FINI)         <span class="number">0x115c</span></span><br><span class="line">  <span class="number">0x0000000000000019</span> (INIT_ARRAY)   <span class="number">0x3e08</span></span><br><span class="line">  <span class="number">0x000000000000001b</span> (INIT_ARRAYSZ) <span class="number">8</span> (bytes)</span><br><span class="line">  <span class="number">0x000000000000001a</span> (FINI_ARRAY)   <span class="number">0x3e10</span></span><br><span class="line">  <span class="number">0x000000000000001c</span> (FINI_ARRAYSZ) <span class="number">8</span> (bytes)</span><br><span class="line">  <span class="number">0x000000006ffffef5</span> (GNU_HASH)     <span class="number">0x200</span></span><br><span class="line">  <span class="number">0x0000000000000005</span> (STRTAB)       <span class="number">0x320</span></span><br><span class="line">  <span class="number">0x0000000000000006</span> (SYMTAB)       <span class="number">0x230</span></span><br><span class="line">  <span class="number">0x000000000000000a</span> (STRSZ)        <span class="number">139</span> (bytes)</span><br><span class="line">  <span class="number">0x000000000000000b</span> (SYMENT)       <span class="number">24</span> (bytes)</span><br><span class="line">  <span class="number">0x0000000000000003</span> (PLTGOT)       <span class="number">0x4000</span></span><br><span class="line">  <span class="number">0x0000000000000002</span> (PLTRELSZ)     <span class="number">96</span> (bytes)</span><br><span class="line">  <span class="number">0x0000000000000014</span> (PLTREL)       RELA</span><br><span class="line">  <span class="number">0x0000000000000017</span> (JMPREL)       <span class="number">0x488</span></span><br><span class="line">  <span class="number">0x0000000000000007</span> (RELA)         <span class="number">0x3e0</span></span><br><span class="line">  <span class="number">0x0000000000000008</span> (RELASZ)       <span class="number">168</span> (bytes)</span><br><span class="line">  <span class="number">0x0000000000000009</span> (RELAENT)      <span class="number">24</span> (bytes)</span><br><span class="line">  <span class="number">0x000000006ffffffe</span> (VERNEED)      <span class="number">0x3c0</span></span><br><span class="line">  <span class="number">0x000000006fffffff</span> (VERNEEDNUM)   <span class="number">1</span></span><br><span class="line">  <span class="number">0x000000006ffffff0</span> (VERSYM)       <span class="number">0x3ac</span></span><br><span class="line">  <span class="number">0x000000006ffffff9</span> (RELACOUNT)    <span class="number">3</span></span><br><span class="line">  <span class="number">0x0000000000000000</span> (<span class="literal">NULL</span>)         <span class="number">0x0</span></span><br><span class="line">➜  learn-compile llvm-readelf -d program1</span><br><span class="line">Dynamic section at offset <span class="number">0x2df0</span> contains <span class="number">27</span> entries:</span><br><span class="line">  Tag                Type           Name/Value</span><br><span class="line">  <span class="number">0x0000000000000001</span> (NEEDED)       Shared library: [lib.so]</span><br><span class="line">  <span class="number">0x0000000000000001</span> (NEEDED)       Shared library: [libc.so<span class="number">.6</span>]</span><br><span class="line">  <span class="number">0x000000000000000c</span> (INIT)         <span class="number">0x1000</span></span><br><span class="line">  <span class="number">0x000000000000000d</span> (FINI)         <span class="number">0x1204</span></span><br><span class="line">  <span class="number">0x0000000000000019</span> (INIT_ARRAY)   <span class="number">0x3dd8</span></span><br><span class="line">  <span class="number">0x000000000000001b</span> (INIT_ARRAYSZ) <span class="number">8</span> (bytes)</span><br><span class="line">  <span class="number">0x000000000000001a</span> (FINI_ARRAY)   <span class="number">0x3de0</span></span><br><span class="line">  <span class="number">0x000000000000001c</span> (FINI_ARRAYSZ) <span class="number">8</span> (bytes)</span><br><span class="line">  <span class="number">0x000000006ffffef5</span> (GNU_HASH)     <span class="number">0x2e8</span></span><br><span class="line">  <span class="number">0x0000000000000005</span> (STRTAB)       <span class="number">0x3e8</span></span><br><span class="line">  <span class="number">0x0000000000000006</span> (SYMTAB)       <span class="number">0x310</span></span><br><span class="line">  <span class="number">0x000000000000000a</span> (STRSZ)        <span class="number">151</span> (bytes)</span><br><span class="line">  <span class="number">0x000000000000000b</span> (SYMENT)       <span class="number">24</span> (bytes)</span><br><span class="line">  <span class="number">0x0000000000000015</span> (DEBUG)        <span class="number">0x0</span></span><br><span class="line">  <span class="number">0x0000000000000003</span> (PLTGOT)       <span class="number">0x4000</span></span><br><span class="line">  <span class="number">0x0000000000000002</span> (PLTRELSZ)     <span class="number">96</span> (bytes)</span><br><span class="line">  <span class="number">0x0000000000000014</span> (PLTREL)       RELA</span><br><span class="line">  <span class="number">0x0000000000000017</span> (JMPREL)       <span class="number">0x560</span></span><br><span class="line">  <span class="number">0x0000000000000007</span> (RELA)         <span class="number">0x4b8</span></span><br><span class="line">  <span class="number">0x0000000000000008</span> (RELASZ)       <span class="number">168</span> (bytes)</span><br><span class="line">  <span class="number">0x0000000000000009</span> (RELAENT)      <span class="number">24</span> (bytes)</span><br><span class="line">  <span class="number">0x000000006ffffffb</span> (FLAGS_1)      PIE </span><br><span class="line">  <span class="number">0x000000006ffffffe</span> (VERNEED)      <span class="number">0x498</span></span><br><span class="line">  <span class="number">0x000000006fffffff</span> (VERNEEDNUM)   <span class="number">1</span></span><br><span class="line">  <span class="number">0x000000006ffffff0</span> (VERSYM)       <span class="number">0x480</span></span><br><span class="line">  <span class="number">0x000000006ffffff9</span> (RELACOUNT)    <span class="number">3</span></span><br><span class="line">  <span class="number">0x0000000000000000</span> (<span class="literal">NULL</span>)         <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<p>这里也可以看到依赖的库</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ldd program1</span></span><br><span class="line">        linux-vdso.so<span class="number">.1</span> (<span class="number">0x00007fffb2953000</span>)</span><br><span class="line">        lib.so =&gt; &#123;&#125;/learn-compile/lib.so (<span class="number">0x00007f356767f000</span>)</span><br><span class="line">        libc.so<span class="number">.6</span> =&gt; /lib64/libc.so<span class="number">.6</span> (<span class="number">0x00007f35670b6000</span>)</span><br><span class="line">        /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span> (<span class="number">0x00007f356746a000</span>)</span><br></pre></td></tr></table></figure>
<p>这里我们在看 <code>lib.so</code>, <code>-s</code> 打印符号表还会看到 <code>.dynsym</code>，这是动态链接用的符号表</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">llvm-readelf -s lib.so  </span><br><span class="line"></span><br><span class="line">Symbol table <span class="string">&#x27;.dynsym&#x27;</span> contains <span class="number">10</span> entries:</span><br><span class="line">   Num:    Value          Size Type    Bind   Vis       Ndx Name</span><br><span class="line">     <span class="number">0</span>: <span class="number">0000000000000000</span>     <span class="number">0</span> NOTYPE  LOCAL  DEFAULT   UND </span><br><span class="line">     <span class="number">1</span>: <span class="number">0000000000000000</span>     <span class="number">0</span> NOTYPE  WEAK   DEFAULT   UND _ITM_deregisterTMCloneTable</span><br><span class="line">     <span class="number">2</span>: <span class="number">0000000000000000</span>     <span class="number">0</span> FUNC    GLOBAL DEFAULT   UND <span class="built_in">printf</span>@GLIBC_2<span class="number">.2</span><span class="number">.5</span></span><br><span class="line">     <span class="number">3</span>: <span class="number">0000000000000000</span>     <span class="number">0</span> NOTYPE  WEAK   DEFAULT   UND __gmon_start__</span><br><span class="line">     <span class="number">4</span>: <span class="number">0000000000000000</span>     <span class="number">0</span> NOTYPE  WEAK   DEFAULT   UND _ITM_registerTMCloneTable</span><br><span class="line">     <span class="number">5</span>: <span class="number">0000000000000000</span>     <span class="number">0</span> FUNC    GLOBAL DEFAULT   UND sleep@GLIBC_2<span class="number">.2</span><span class="number">.5</span></span><br><span class="line">     <span class="number">6</span>: <span class="number">0000000000000000</span>     <span class="number">0</span> FUNC    WEAK   DEFAULT   UND __cxa_finalize@GLIBC_2<span class="number">.2</span><span class="number">.5</span></span><br><span class="line">     <span class="number">7</span>: <span class="number">0000000000001000</span>     <span class="number">0</span> FUNC    GLOBAL DEFAULT     <span class="number">8</span> _init</span><br><span class="line">     <span class="number">8</span>: <span class="number">000000000000115</span>c     <span class="number">0</span> FUNC    GLOBAL DEFAULT    <span class="number">11</span> _fini</span><br><span class="line">     <span class="number">9</span>: <span class="number">0000000000001130</span>    <span class="number">44</span> FUNC    GLOBAL DEFAULT    <span class="number">10</span> foobar</span><br><span class="line"></span><br><span class="line">Symbol table <span class="string">&#x27;.symtab&#x27;</span> contains <span class="number">27</span> entries:</span><br><span class="line">   Num:    Value          Size Type    Bind   Vis       Ndx Name</span><br><span class="line">     <span class="comment">// ...</span></span><br></pre></td></tr></table></figure>
<p>我们之前也介绍过 <code>rela.text</code> 之类的，实际上动态链接也有 <code>.rela.dyn</code> <code>.rela.plt</code>, 用来做类似的事情。</p>
<h3 id="显式动态链接"><a href="#显式动态链接" class="headerlink" title="显式动态链接"></a>显式动态链接</h3><blockquote>
<p>在Linux 中，从文件本身的格式上来看，动态库实际上跟一般的共享对象没有区别，正如我们前面讨论过的。主要的区别是共享对象是由动态链接器在程序启动之前负责装载和链接的，这一系列步骤都由动态连接器自动完成，对于程序本身是透明的；而动态库的装载则是通过一系列由动态链接器提供的 API，具体地讲共有 4 个：打开动态库 (dlopen)、查找符号（dlsym）、错误处理(dlerror）以及关闭动态库 (diclose ），程序可以通过这几个API对动态库进行操作。</p>
</blockquote>
<p>TUM Codegen Paper 也提到了这个。最简单的 codegen 方式也就是 xjb 编译然后 dlopen 之类的去链接。</p>
<h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><ul>
<li><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/1401359/understanding-linux-proc-pid-maps-or-proc-self-maps">Understanding Linux /proc/pid/maps or /proc/self/maps</a> ( <a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/1401359/understanding-linux-proc-pid-maps-or-proc-self-maps">https://stackoverflow.com/questions/1401359/understanding-linux-proc-pid-maps-or-proc-self-maps</a> )</li>
<li><a target="_blank" rel="noopener" href="https://maskray.me/blog/2021-08-29-all-about-global-offset-table">https://maskray.me/blog/2021-08-29-all-about-global-offset-table</a></li>
<li><a target="_blank" rel="noopener" href="https://maskray.me/blog/2021-09-19-all-about-procedure-linkage-table">https://maskray.me/blog/2021-09-19-all-about-procedure-linkage-table</a></li>
<li><a target="_blank" rel="noopener" href="https://www.eyrie.org/~eagle/notes/rpath.html">https://www.eyrie.org/~eagle/notes/rpath.html</a></li>
</ul>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">首页</a></li>
         
          <li><a href="/about/">关于</a></li>
         
          <li><a href="/archives/">归档</a></li>
         
          <li><a href="/search/">搜索</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%AF%E6%89%A7%E8%A1%8C%E6%96%87%E4%BB%B6%E7%9A%84-Load-%E5%92%8C%E8%BF%9B%E7%A8%8B"><span class="toc-number">1.</span> <span class="toc-text">可执行文件的 Load 和进程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5"><span class="toc-number">2.</span> <span class="toc-text">动态链接</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%B0%E5%9D%80%E6%97%A0%E5%85%B3%E4%BB%A3%E7%A0%81%E5%92%8C-GOT"><span class="toc-number">2.1.</span> <span class="toc-text">地址无关代码和 GOT</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#MaskRay-%E5%8D%9A%E5%AE%A2%E4%B8%8A%E7%9A%84%E8%AE%A8%E8%AE%BA"><span class="toc-number">2.1.1.</span> <span class="toc-text">MaskRay 博客上的讨论</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BB%B6%E8%BF%9F%E7%BB%91%E5%AE%9A%E5%92%8C-PLT"><span class="toc-number">2.2.</span> <span class="toc-text">延迟绑定和 PLT</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5%E7%9A%84%E8%BF%87%E7%A8%8B"><span class="toc-number">2.3.</span> <span class="toc-text">动态链接的过程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%98%BE%E5%BC%8F%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5"><span class="toc-number">2.4.</span> <span class="toc-text">显式动态链接</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#References"><span class="toc-number">3.</span> <span class="toc-text">References</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://blog.mwish.me/2024/12/06/Compile-Loader-Libraries-Part-2-Dynamic-linking/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://blog.mwish.me/2024/12/06/Compile-Loader-Libraries-Part-2-Dynamic-linking/&text=Compile/Loader/Libraries: Part 2 Dynamic linking"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://blog.mwish.me/2024/12/06/Compile-Loader-Libraries-Part-2-Dynamic-linking/&title=Compile/Loader/Libraries: Part 2 Dynamic linking"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://blog.mwish.me/2024/12/06/Compile-Loader-Libraries-Part-2-Dynamic-linking/&is_video=false&description=Compile/Loader/Libraries: Part 2 Dynamic linking"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Compile/Loader/Libraries: Part 2 Dynamic linking&body=Check out this article: http://blog.mwish.me/2024/12/06/Compile-Loader-Libraries-Part-2-Dynamic-linking/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://blog.mwish.me/2024/12/06/Compile-Loader-Libraries-Part-2-Dynamic-linking/&title=Compile/Loader/Libraries: Part 2 Dynamic linking"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://blog.mwish.me/2024/12/06/Compile-Loader-Libraries-Part-2-Dynamic-linking/&title=Compile/Loader/Libraries: Part 2 Dynamic linking"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://blog.mwish.me/2024/12/06/Compile-Loader-Libraries-Part-2-Dynamic-linking/&title=Compile/Loader/Libraries: Part 2 Dynamic linking"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://blog.mwish.me/2024/12/06/Compile-Loader-Libraries-Part-2-Dynamic-linking/&title=Compile/Loader/Libraries: Part 2 Dynamic linking"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://blog.mwish.me/2024/12/06/Compile-Loader-Libraries-Part-2-Dynamic-linking/&name=Compile/Loader/Libraries: Part 2 Dynamic linking&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://blog.mwish.me/2024/12/06/Compile-Loader-Libraries-Part-2-Dynamic-linking/&t=Compile/Loader/Libraries: Part 2 Dynamic linking"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> 菜单</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> 目录</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> 分享</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> 返回顶部</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2022-2025
    mwish
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">首页</a></li><!--
     --><!--
       --><li><a href="/about/">关于</a></li><!--
     --><!--
       --><li><a href="/archives/">归档</a></li><!--
     --><!--
       --><li><a href="/search/">搜索</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->
 
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script> 




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script> 
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"复制到粘贴板！\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "复制成功！");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

    <script async src="https://www.googletagmanager.com/gtag/js?id=G-FL51GBW6JT"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-FL51GBW6JT');
    </script>

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Umami Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });
</script>
<script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</body>
</html>
