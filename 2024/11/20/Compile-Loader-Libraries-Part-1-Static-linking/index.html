<!DOCTYPE html>
<html lang=zh>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="本文是《程序员的自我修养：链接、装载与库》的读书笔记 Part 1 Basics早期计算机的抽象：  CPU 频率不高，和内存的频率一样 每个设备都会有一个相应的 IO 控制器   随着 CPU 频率提高，慢慢抽象出了一个北桥芯片，用来处理快速的 CPU    All CPUs (two in the previous example, but there can be more) are con">
<meta property="og:type" content="article">
<meta property="og:title" content="Compile&#x2F;Loader&#x2F;Libraries: Part 1 Static linking">
<meta property="og:url" content="http://blog.mwish.me/2024/11/20/Compile-Loader-Libraries-Part-1-Static-linking/index.html">
<meta property="og:site_name" content="风空之岛">
<meta property="og:description" content="本文是《程序员的自我修养：链接、装载与库》的读书笔记 Part 1 Basics早期计算机的抽象：  CPU 频率不高，和内存的频率一样 每个设备都会有一个相应的 IO 控制器   随着 CPU 频率提高，慢慢抽象出了一个北桥芯片，用来处理快速的 CPU    All CPUs (two in the previous example, but there can be more) are con">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://image.mwish.me/blog-image/4932899964052476740.png">
<meta property="og:image" content="https://image.mwish.me/blog-image/4339522356176946419.png">
<meta property="og:image" content="https://image.mwish.me/blog-image/2291417229521937750.png">
<meta property="og:image" content="https://image.mwish.me/blog-image/261400368790472692.png">
<meta property="og:image" content="https://image.mwish.me/blog-image/5835146491911473415.png">
<meta property="og:image" content="https://image.mwish.me/blog-image/7997325648404591894.png">
<meta property="og:image" content="https://image.mwish.me/blog-image/4553063082286656964.png">
<meta property="og:image" content="https://image.mwish.me/blog-image/4432749571058982552.png">
<meta property="og:image" content="https://image.mwish.me/blog-image/3200920742870858169.png">
<meta property="og:image" content="https://image.mwish.me/blog-image/8819930589112446864.png">
<meta property="article:published_time" content="2024-11-20T15:35:24.000Z">
<meta property="article:modified_time" content="2024-11-20T15:37:10.447Z">
<meta property="article:author" content="mwish">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://image.mwish.me/blog-image/4932899964052476740.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/logo.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/logo.ico" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/logo.ico">
        
      
    
    <!-- title -->
    <title>Compile/Loader/Libraries: Part 1 Static linking</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 6.2.0"></head>

<body class="max-width mx-auto px3 ltr">    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="目录"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="目录"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="顶部" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">首页</a></li><!--
     --><!--
       --><li><a href="/about/">关于</a></li><!--
     --><!--
       --><li><a href="/archives/">归档</a></li><!--
     --><!--
       --><li><a href="/search/">搜索</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="上一篇" href="/2024/12/05/Column-or-row-in-database-execution/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="下一篇" href="/2024/11/10/Arrow-simplifies-expression-with-guarantee/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="返回顶部" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="分享文章" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">上一篇</span>
      <span id="i-next" class="info" style="display:none;">下一篇</span>
      <span id="i-top" class="info" style="display:none;">返回顶部</span>
      <span id="i-share" class="info" style="display:none;">分享文章</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://blog.mwish.me/2024/11/20/Compile-Loader-Libraries-Part-1-Static-linking/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://blog.mwish.me/2024/11/20/Compile-Loader-Libraries-Part-1-Static-linking/&text=Compile/Loader/Libraries: Part 1 Static linking"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://blog.mwish.me/2024/11/20/Compile-Loader-Libraries-Part-1-Static-linking/&title=Compile/Loader/Libraries: Part 1 Static linking"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://blog.mwish.me/2024/11/20/Compile-Loader-Libraries-Part-1-Static-linking/&is_video=false&description=Compile/Loader/Libraries: Part 1 Static linking"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Compile/Loader/Libraries: Part 1 Static linking&body=Check out this article: http://blog.mwish.me/2024/11/20/Compile-Loader-Libraries-Part-1-Static-linking/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://blog.mwish.me/2024/11/20/Compile-Loader-Libraries-Part-1-Static-linking/&title=Compile/Loader/Libraries: Part 1 Static linking"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://blog.mwish.me/2024/11/20/Compile-Loader-Libraries-Part-1-Static-linking/&title=Compile/Loader/Libraries: Part 1 Static linking"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://blog.mwish.me/2024/11/20/Compile-Loader-Libraries-Part-1-Static-linking/&title=Compile/Loader/Libraries: Part 1 Static linking"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://blog.mwish.me/2024/11/20/Compile-Loader-Libraries-Part-1-Static-linking/&title=Compile/Loader/Libraries: Part 1 Static linking"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://blog.mwish.me/2024/11/20/Compile-Loader-Libraries-Part-1-Static-linking/&name=Compile/Loader/Libraries: Part 1 Static linking&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://blog.mwish.me/2024/11/20/Compile-Loader-Libraries-Part-1-Static-linking/&t=Compile/Loader/Libraries: Part 1 Static linking"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Basics"><span class="toc-number">1.</span> <span class="toc-text">Basics</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9D%99%E6%80%81%E9%93%BE%E6%8E%A5"><span class="toc-number">2.</span> <span class="toc-text">静态链接</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Elf-Executable-and-Linking-Format"><span class="toc-number">3.</span> <span class="toc-text">Elf: Executable and Linking Format</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Elf-%E7%9A%84%E5%A4%A7%E8%87%B4%E7%BB%93%E6%9E%84"><span class="toc-number">3.1.</span> <span class="toc-text">Elf 的大致结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%A8-LLVM-%E5%B7%A5%E5%85%B7%E9%AA%8C%E8%AF%81%E4%B8%8A%E9%9D%A2%E7%9A%84%E5%86%85%E5%AE%B9%E5%90%A7"><span class="toc-number">3.2.</span> <span class="toc-text">用 LLVM 工具验证上面的内容吧</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9D%99%E6%80%81%E9%93%BE%E6%8E%A5-1"><span class="toc-number">4.</span> <span class="toc-text">静态链接</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#LTO"><span class="toc-number">4.1.</span> <span class="toc-text">LTO</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%A8%E5%B1%80%E8%B5%84%E6%BA%90"><span class="toc-number">4.2.</span> <span class="toc-text">全局资源</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ABI"><span class="toc-number">4.3.</span> <span class="toc-text">ABI</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9D%99%E6%80%81%E5%BA%93"><span class="toc-number">4.4.</span> <span class="toc-text">静态库</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Linker-Script"><span class="toc-number">4.5.</span> <span class="toc-text">Linker Script</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#References"><span class="toc-number">5.</span> <span class="toc-text">References</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        Compile/Loader/Libraries: Part 1 Static linking
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">mwish</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2024-11-20T15:35:24.000Z" itemprop="datePublished">2024-11-20</time>
        
      
    </div>


      

      

    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <p>本文是《程序员的自我修养：链接、装载与库》的读书笔记 Part 1</p>
<h2 id="Basics"><a href="#Basics" class="headerlink" title="Basics"></a>Basics</h2><p>早期计算机的抽象：</p>
<ul>
<li>CPU 频率不高，和内存的频率一样</li>
<li>每个设备都会有一个相应的 IO 控制器</li>
</ul>
<p><img src="https://image.mwish.me/blog-image/4932899964052476740.png" alt="img"></p>
<p>随着 CPU 频率提高，慢慢抽象出了一个北桥芯片，用来处理快速的 CPU </p>
<p><img src="https://image.mwish.me/blog-image/4339522356176946419.png" alt="img"></p>
<blockquote>
<p>All CPUs (two in the previous example, but there can be more) are connected via a common bus (the Front Side Bus, FSB) to the Northbridge. The Northbridge contains, among other things, the memory controller, and its implementation determines the type of RAM chips used for the computer. Different types of RAM, such as DRAM, Rambus, and SDRAM, require different memory controllers.</p>
<p>To reach all other system devices, the Northbridge must communicate with the Southbridge. The Southbridge, often referred to as the I/O bridge, handles communication with devices through a variety of different buses. Today the PCI, PCI Express, SATA, and USB buses are of most importance, but PATA, IEEE 1394, serial, and parallel ports are also supported by the Southbridge. Older systems had AGP slots which were attached to the Northbridge. This was done for performance reasons related to insufﬁciently fast connections between the Northbridge and Southbridge. However, today the PCI-E slots are all connected to the Southbridge.</p>
</blockquote>
<p>上面这些也一定程度上成为历史了，但是理论仍然是相似的，北桥之所以叫北桥，是因为它在主板上真的在 CPU 下面。现在 CPU 已经将北桥功能做进去了。这并不代表我们知识是过期的，因为这部分原理仍然类似。下图是成书年间的图，仅供参考，可图一乐。</p>
<p><img src="https://image.mwish.me/blog-image/2291417229521937750.png" alt="img"></p>
<p>SMP 架构和多处理器也出现在了当年的 arch 中，并越来越火，直到今天</p>
<p>当年的系统架构如图：</p>
<p><img src="https://image.mwish.me/blog-image/261400368790472692.png" alt="img"></p>
<p>这不禁让我想到一个刚看到的问题，随着 os 虚拟化的加入，我们可能更需要这样调试的能力了：问题排查：C++ exception with description “getrandom“ thrown in the test body - 大家好大家吃了吗的文章 - 知乎 <a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/5392960438">https://zhuanlan.zhihu.com/p/5392960438</a></p>
<p>这里我再次想到了 OSTEP 的「虚拟化」这一概念，我们对 CPU 其实很熟悉了，就不介绍进程线程这些了。设备在这里也被「虚拟化」了，比如图形被虚拟化成 DirectX 这样的 API，网络被虚拟化成网卡，盘也被虚拟化成对应的接口。这样的东西也被称为 Device Driver。</p>
<blockquote>
<p>驱动程序可以看作是操作系统的一部分，它往往跟操作系统内核一起运行在特权级，但它又与操作系统内核之间有一定的独性，使得驱动程序有比较好的灵活性。因为PC 的硬件多如牛毛，操作系统开发者不可能为每个硬件开发一个驱动程序，这些驱动程序的开发工作通常由硬件生产厂商完成。操作系统开发者为硬件生产厂商提供了一系列接口和框架，凡是按照这个接口和框架开发的驱动程序都可以在该操作系统上使用。</p>
</blockquote>
<p>这节介绍了很多线程和内存的部分，都被我忽略了，感兴趣可以自己读。</p>
<h2 id="静态链接"><a href="#静态链接" class="headerlink" title="静态链接"></a>静态链接</h2><p>我以前博客写过一些流程（时间过的真快）：</p>
<ul>
<li>RISC-V 编译、链接、加载 <a href="https://blog.mwish.me/2020/10/05/RISC-V-%E7%BC%96%E8%AF%91%E3%80%81%E9%93%BE%E6%8E%A5%E3%80%81%E5%8A%A0%E8%BD%BD/">https://blog.mwish.me/2020/10/05/RISC-V-%E7%BC%96%E8%AF%91%E3%80%81%E9%93%BE%E6%8E%A5%E3%80%81%E5%8A%A0%E8%BD%BD/</a></li>
<li>CALL: libc 和 C++ 标准库 <a href="https://blog.mwish.me/2020/04/04/CALL-libc-%E5%92%8C-C-%E6%A0%87%E5%87%86%E5%BA%93/">https://blog.mwish.me/2020/04/04/CALL-libc-%E5%92%8C-C-%E6%A0%87%E5%87%86%E5%BA%93/</a></li>
</ul>
<p>上面都有图有例子，至少介绍了一些最基本的东西。我们得利用之前的东西再接着看书，以免之前白写了</p>
<p>书里提到「链接」的行为在打孔纸袋写代码的时候就已经存在了，最早 <code>jmp</code> <code>call</code> 这些东西都没有，地址之类的很多调整都得手算，这个计算过程叫 <strong>重定位（ Relocation ）</strong>。汇编语言的出现让 <code>jmp</code> 之类的东西能登上舞台，<code>Symbol</code> 这个词也随之火热了起来，它用来表示一个地址，可以是变量地址，也可以是函数的地址。而随着程序增大，模块化的需求也来了，很多地方也会需要分开来写，而拼接这些符号的过程就是 Linking</p>
<p>静态链接包括了：</p>
<ul>
<li>地址和空间分配（Address and Storage Allocation）</li>
<li>符号决议（Symbol Resolution） -&gt; 这个名字更符合静态链接，绑定之类的其实更符合动态链接</li>
<li>重定位（Relocation）</li>
</ul>
<p>在这里，需要被修正的函数/全局变量是重定位入口（Relocation Entry），然后重定位就是让他们指向程序正确的位置。</p>
<h2 id="Elf-Executable-and-Linking-Format"><a href="#Elf-Executable-and-Linking-Format" class="headerlink" title="Elf: Executable and Linking Format"></a>Elf: Executable and Linking Format</h2><h3 id="Elf-的大致结构"><a href="#Elf-的大致结构" class="headerlink" title="Elf 的大致结构"></a>Elf 的大致结构</h3><p>Unix/Linux 社区有着 Elf 格式，windows 等社区有着 PE-COFF 格式, Mach-O</p>
<p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/36293052/what-is-the-difference-between-executable-formats">https://stackoverflow.com/questions/36293052/what-is-the-difference-between-executable-formats</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">printf</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* format, ...)</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> global_init_var = <span class="number">84</span>;</span><br><span class="line"><span class="type">int</span> global_uninit_var;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">func1</span><span class="params">(<span class="type">int</span> i)</span> &#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, i);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="type">static</span> <span class="type">int</span> static_var = <span class="number">85</span>;</span><br><span class="line">  <span class="type">static</span> <span class="type">int</span> static_var2;</span><br><span class="line">  <span class="type">int</span> a = <span class="number">1</span>;</span><br><span class="line">  <span class="type">int</span> b;</span><br><span class="line">  func1(static_var + static_var2 + a + b);</span><br><span class="line">  <span class="keyword">return</span> a;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 MacOS 上 LLVM Clang 13 编译，可以看到这里是 mach-o 格式；在 Linux 下编译则是 elf 格式</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">clang -c <span class="number">3</span><span class="number">-1.</span>c</span><br><span class="line"></span><br><span class="line"><span class="comment">// MacOS 下</span></span><br><span class="line">➜  llvm-objdump -h <span class="number">3</span><span class="number">-1.</span>o  </span><br><span class="line"></span><br><span class="line"><span class="number">3</span><span class="number">-1.</span>o:        file format mach-o arm64</span><br><span class="line"></span><br><span class="line">Sections:</span><br><span class="line">Idx Name             Size     VMA              Type</span><br><span class="line">  <span class="number">0</span> __text           <span class="number">00000088</span> <span class="number">0000000000000000</span> TEXT</span><br><span class="line">  <span class="number">1</span> __data           <span class="number">00000008</span> <span class="number">0000000000000088</span> DATA</span><br><span class="line">  <span class="number">2</span> __cstring        <span class="number">00000004</span> <span class="number">0000000000000090</span> DATA</span><br><span class="line">  <span class="number">3</span> __bss            <span class="number">00000004</span> <span class="number">00000000000000</span>d8 BSS</span><br><span class="line">  <span class="number">4</span> __common         <span class="number">00000004</span> <span class="number">00000000000000</span>dc BSS</span><br><span class="line">  <span class="number">5</span> __compact_unwind <span class="number">00000040</span> <span class="number">0000000000000098</span> DATA</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// Linux 下</span></span><br><span class="line">ch3<span class="number">-1.</span>o:        file format elf64-x86<span class="number">-64</span></span><br><span class="line"></span><br><span class="line">Sections:</span><br><span class="line">Idx Name            Size     VMA              Type</span><br><span class="line">  <span class="number">0</span>                 <span class="number">00000000</span> <span class="number">0000000000000000</span> </span><br><span class="line">  <span class="number">1</span> .strtab         <span class="number">000000</span>d0 <span class="number">0000000000000000</span> </span><br><span class="line">  <span class="number">2</span> .text           <span class="number">00000066</span> <span class="number">0000000000000000</span> TEXT</span><br><span class="line">  <span class="number">3</span> .rela.text      <span class="number">00000078</span> <span class="number">0000000000000000</span> </span><br><span class="line">  <span class="number">4</span> .data           <span class="number">00000008</span> <span class="number">0000000000000000</span> DATA</span><br><span class="line">  <span class="number">5</span> .rodata.str1<span class="number">.1</span>  <span class="number">00000004</span> <span class="number">0000000000000000</span> DATA</span><br><span class="line">  <span class="number">6</span> .bss            <span class="number">00000008</span> <span class="number">0000000000000000</span> BSS</span><br><span class="line">  <span class="number">7</span> .comment        <span class="number">00000016</span> <span class="number">0000000000000000</span> </span><br><span class="line">  <span class="number">8</span> .note.GNU-<span class="built_in">stack</span> <span class="number">00000000</span> <span class="number">0000000000000000</span> </span><br><span class="line">  <span class="number">9</span> .eh_frame       <span class="number">00000058</span> <span class="number">0000000000000000</span> </span><br><span class="line"> <span class="number">10</span> .rela.eh_frame  <span class="number">00000030</span> <span class="number">0000000000000000</span> </span><br><span class="line"> <span class="number">11</span> .llvm_addrsig   <span class="number">00000004</span> <span class="number">0000000000000000</span> </span><br><span class="line"> <span class="number">12</span> .symtab         <span class="number">00000138</span> <span class="number">0000000000000000</span> </span><br></pre></td></tr></table></figure>
<p>看 llvm-size 可以看到各个 “type” 的段的 size </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">llvm-size <span class="number">3</span><span class="number">-1.</span>o                          </span><br><span class="line">__TEXT        __DATA        __OBJC        others        dec        hex</span><br><span class="line"><span class="number">140</span>           <span class="number">16</span>            <span class="number">0</span>             <span class="number">64</span>            <span class="number">220</span>        dc</span><br><span class="line"></span><br><span class="line">llvm-size ch3<span class="number">-1.</span>o </span><br><span class="line">   text    data     bss     dec     hex filename</span><br><span class="line">    <span class="number">194</span>       <span class="number">8</span>       <span class="number">8</span>     <span class="number">210</span>      d2 ch3<span class="number">-1.</span>o</span><br></pre></td></tr></table></figure>
<p>书上所示，程序中:</p>
<p><img src="https://image.mwish.me/blog-image/5835146491911473415.png" alt="img"></p>
<ul>
<li>ELF / Mach-O 开头是 Header，描述整个文件的 ``, 这块可以参考后文</li>
<li>编译后的机器指令常常放在 Code Section 中，常叫 “.code” / “.text”；全局变量和静态局部变量放在数据段，一般叫 “.data”</li>
<li>Section 有一个 <code>CONTENTS</code> 属性（我们会在后面介绍）</li>
<li><code>.rodata</code> 存放只读数据，某种平台下这部分也可以放到只读存储器中。有的时候字符串常量会放到别的地方</li>
<li><code>.bss</code> section 描述未初始化的全局变量和局部静态变量。我们后文可以看到，<code>global_uninit_var</code> 其实没有出现在这个地方，我理解因为这个地方提供的是编译单元内的变量. <code>.bss</code> 端似乎能够存放一些 <code>= 0</code> 这样初始化为 <code>0</code> 的字段来减少对磁盘空间的占用。 </li>
<li>这些段通常应 <code>.</code> 作为前缀，表示他们的名字是系统保留的，elf 因为历史原因也留下一些保留段名，同时 elf 允许同名段和「自定义段」。比如用 <code>__attribute__((section(&quot;段名&quot;)))</code> 来声明</li>
</ul>
<p>Elf 大概结构如下，</p>
<p><img src="https://image.mwish.me/blog-image/7997325648404591894.png" alt="img"></p>
<p><img src="https://image.mwish.me/blog-image/4553063082286656964.png" alt="img"></p>
<h3 id="用-LLVM-工具验证上面的内容吧"><a href="#用-LLVM-工具验证上面的内容吧" class="headerlink" title="用 LLVM 工具验证上面的内容吧"></a>用 LLVM 工具验证上面的内容吧</h3><p>Objdump 查汇编甚至反汇编：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">ch3<span class="number">-1.</span>o:        file format elf64-x86<span class="number">-64</span></span><br><span class="line">Contents of section .strtab:</span><br><span class="line"> <span class="number">0000</span> <span class="number">002e7265</span> <span class="number">6</span>c612e74 <span class="number">65787400</span> <span class="number">2e636</span>f6d  ..rela.text..com</span><br><span class="line"> <span class="number">0010</span> <span class="number">6</span>d656e74 <span class="number">002e6273</span> <span class="number">73002e4</span>c <span class="number">2e737472</span>  ment..bss..L.str</span><br><span class="line"> <span class="number">0020</span> <span class="number">00676</span>c6f <span class="number">62616</span>c5f <span class="number">756e696</span>e <span class="number">69745f</span>76  .global_uninit_v</span><br><span class="line"> <span class="number">0030</span> <span class="number">61720067</span> <span class="number">6</span>c6f6261 <span class="number">6</span>c5f696e <span class="number">69745f</span>76  ar.global_init_v</span><br><span class="line"> <span class="number">0040</span> <span class="number">6172006</span>d <span class="number">61696e2</span>e <span class="number">73746174</span> <span class="number">69635f</span>76  ar.main.static_v</span><br><span class="line"> <span class="number">0050</span> <span class="number">6172006</span>d <span class="number">61696e00</span> <span class="number">2e6</span>e6f74 <span class="number">652e474</span>e  ar.main..note.GN</span><br><span class="line"> <span class="number">0060</span> <span class="number">552</span>d7374 <span class="number">61636b</span>00 <span class="number">2e6</span>c6c76 <span class="number">6</span>d5f6164  U-<span class="built_in">stack</span>..llvm_ad</span><br><span class="line"> <span class="number">0070</span> <span class="number">64727369</span> <span class="number">67007072</span> <span class="number">696e7466</span> <span class="number">002e7265</span>  drsig.<span class="built_in">printf</span>..re</span><br><span class="line"> <span class="number">0080</span> <span class="number">6</span>c612e65 <span class="number">685f</span>6672 <span class="number">616</span>d6500 <span class="number">6368332</span>d  la.eh_frame.ch3-</span><br><span class="line"> <span class="number">0090</span> <span class="number">312e6300</span> <span class="number">2e737472</span> <span class="number">74616200</span> <span class="number">2e73796</span>d  <span class="number">1.</span>c..strtab..sym</span><br><span class="line"> <span class="number">00</span>a0 <span class="number">74616200</span> <span class="number">2e646174</span> <span class="number">61006</span>d61 <span class="number">696e2</span>e73  tab..data.main.s</span><br><span class="line"> <span class="number">00b</span>0 <span class="number">74617469</span> <span class="number">635f</span>7661 <span class="number">72320066</span> <span class="number">756e6331</span>  tatic_var2.func1</span><br><span class="line"> <span class="number">00</span>c0 <span class="number">002e726</span>f <span class="number">64617461</span> <span class="number">2e737472</span> <span class="number">312e3100</span>  ..rodata.str1<span class="number">.1</span>.</span><br><span class="line">Contents of section .text:</span><br><span class="line">Contents of section .rela.text:</span><br><span class="line">Contents of section .data:</span><br><span class="line"> <span class="number">0000</span> <span class="number">54000000</span> <span class="number">55000000</span>                    T...U...</span><br><span class="line">Contents of section .rodata.str1<span class="number">.1</span>:</span><br><span class="line"> <span class="number">0000</span> <span class="number">25640</span>a00                             %d..</span><br><span class="line">Contents of section .bss:</span><br><span class="line">&lt;skipping contents of bss section at [<span class="number">0000</span>, <span class="number">0008</span>)&gt;</span><br><span class="line">Contents of section .comment:</span><br><span class="line"> <span class="number">0000</span> <span class="number">00636</span>c61 <span class="number">6e672076</span> <span class="number">65727369</span> <span class="number">6f</span>6e2031  .clang version <span class="number">1</span></span><br><span class="line"> <span class="number">0010</span> <span class="number">372e302</span>e <span class="number">3300</span>                        <span class="number">7.0</span><span class="number">.3</span>.</span><br><span class="line">Contents of section .eh_frame:</span><br><span class="line">Contents of section .llvm_addrsig:</span><br><span class="line"> <span class="number">0000</span> <span class="number">08090405</span>                             ....</span><br><span class="line">Contents of section .symtab:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Disassembly of section .text:</span><br><span class="line"></span><br><span class="line"><span class="number">0000000000000000</span> &lt;func1&gt;:</span><br><span class="line">       <span class="number">0</span>: <span class="number">55</span>                            pushq   %rbp</span><br><span class="line">       <span class="number">1</span>: <span class="number">48</span> <span class="number">89</span> e5                      movq    %rsp, %rbp</span><br><span class="line">       <span class="number">4</span>: <span class="number">48</span> <span class="number">83</span> ec <span class="number">10</span>                   subq    $<span class="number">0x10</span>, %rsp</span><br><span class="line">       <span class="number">8</span>: <span class="number">89</span> <span class="number">7</span>d fc                      movl    %edi, <span class="number">-0x4</span>(%rbp)</span><br><span class="line">       b: <span class="number">8b</span> <span class="number">75</span> fc                      movl    <span class="number">-0x4</span>(%rbp), %esi</span><br><span class="line">       e: <span class="number">48</span> <span class="number">8</span>d <span class="number">3</span>d <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>          leaq    (%rip), %rdi            # <span class="number">0x15</span> &lt;func1+<span class="number">0x15</span>&gt;</span><br><span class="line">      <span class="number">15</span>: b0 <span class="number">00</span>                         movb    $<span class="number">0x0</span>, %al</span><br><span class="line">      <span class="number">17</span>: e8 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>                callq   <span class="number">0x1c</span> &lt;func1+<span class="number">0x1c</span>&gt;</span><br><span class="line">      <span class="number">1</span>c: <span class="number">48</span> <span class="number">83</span> c4 <span class="number">10</span>                   addq    $<span class="number">0x10</span>, %rsp</span><br><span class="line">      <span class="number">20</span>: <span class="number">5</span>d                            popq    %rbp</span><br><span class="line">      <span class="number">21</span>: c3                            retq</span><br><span class="line">      <span class="number">22</span>: <span class="number">66</span> <span class="number">66</span> <span class="number">66</span> <span class="number">66</span> <span class="number">66</span> <span class="number">2</span>e <span class="number">0f</span> <span class="number">1f</span> <span class="number">84</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>     nopw    %cs:(%rax,%rax)</span><br><span class="line"></span><br><span class="line"><span class="number">0000000000000030</span> &lt;main&gt;:</span><br><span class="line">      <span class="number">30</span>: <span class="number">55</span>                            pushq   %rbp</span><br><span class="line">      <span class="number">31</span>: <span class="number">48</span> <span class="number">89</span> e5                      movq    %rsp, %rbp</span><br><span class="line">      <span class="number">34</span>: <span class="number">48</span> <span class="number">83</span> ec <span class="number">10</span>                   subq    $<span class="number">0x10</span>, %rsp</span><br><span class="line">      <span class="number">38</span>: c7 <span class="number">45</span> fc <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>          movl    $<span class="number">0x0</span>, <span class="number">-0x4</span>(%rbp)</span><br><span class="line">      <span class="number">3f</span>: c7 <span class="number">45</span> f8 <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>          movl    $<span class="number">0x1</span>, <span class="number">-0x8</span>(%rbp)</span><br><span class="line">      <span class="number">46</span>: <span class="number">8b</span> <span class="number">3</span>d <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>             movl    (%rip), %edi            # <span class="number">0x4c</span> &lt;main+<span class="number">0x1c</span>&gt;</span><br><span class="line">      <span class="number">4</span>c: <span class="number">03</span> <span class="number">3</span>d <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>             addl    (%rip), %edi            # <span class="number">0x52</span> &lt;main+<span class="number">0x22</span>&gt;</span><br><span class="line">      <span class="number">52</span>: <span class="number">03</span> <span class="number">7</span>d f8                      addl    <span class="number">-0x8</span>(%rbp), %edi</span><br><span class="line">      <span class="number">55</span>: <span class="number">03</span> <span class="number">7</span>d f4                      addl    <span class="number">-0xc</span>(%rbp), %edi</span><br><span class="line">      <span class="number">58</span>: e8 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>                callq   <span class="number">0x5d</span> &lt;main+<span class="number">0x2d</span>&gt;</span><br><span class="line">      <span class="number">5</span>d: <span class="number">8b</span> <span class="number">45</span> f8                      movl    <span class="number">-0x8</span>(%rbp), %eax</span><br><span class="line">      <span class="number">60</span>: <span class="number">48</span> <span class="number">83</span> c4 <span class="number">10</span>                   addq    $<span class="number">0x10</span>, %rsp</span><br><span class="line">      <span class="number">64</span>: <span class="number">5</span>d                            popq    %rbp</span><br><span class="line">      <span class="number">65</span>: c3                            retq</span><br></pre></td></tr></table></figure>
<p>这里内容还是比较清晰的代码段展示</p>
<p><code>-t</code> 可以打印 <code>objdump</code> 的符号表，可以看到变量被怎么放置了</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">➜ llvm-objdump -s -d -t <span class="number">3</span><span class="number">-1.</span>o</span><br><span class="line"></span><br><span class="line"><span class="number">3</span><span class="number">-1.</span>o:        file format mach-o arm64</span><br><span class="line"></span><br><span class="line">SYMBOL TABLE:</span><br><span class="line"><span class="number">0000000000000000</span> l     F __TEXT,__text ltmp0</span><br><span class="line"><span class="number">0000000000000090</span> l     O __TEXT,__cstring l_.str</span><br><span class="line"><span class="number">000000000000008</span>c l     O __DATA,__data _main.static_var</span><br><span class="line"><span class="number">00000000000000</span>d8 l     O __DATA,__bss _main.static_var2</span><br><span class="line"><span class="number">0000000000000088</span> l     O __DATA,__data ltmp1</span><br><span class="line"><span class="number">0000000000000090</span> l     O __TEXT,__cstring ltmp2</span><br><span class="line"><span class="number">00000000000000</span>d8 l     O __DATA,__bss ltmp3</span><br><span class="line"><span class="number">00000000000000</span>dc l     O __DATA,__common ltmp4</span><br><span class="line"><span class="number">0000000000000098</span> l     O __LD,__compact_unwind ltmp5</span><br><span class="line"><span class="number">0000000000000000</span> g     F __TEXT,__text _func1</span><br><span class="line"><span class="number">0000000000000088</span> g     O __DATA,__data _global_init_var</span><br><span class="line"><span class="number">00000000000000</span>dc g     O __DATA,__common _global_uninit_var</span><br><span class="line"><span class="number">0000000000000038</span> g     F __TEXT,__text _main</span><br><span class="line"><span class="number">0000000000000000</span>         *UND* _printf</span><br></pre></td></tr></table></figure>
<p>可以看到：</p>
<ul>
<li><code>global_init_var</code> 被分配到了 <code>__data</code></li>
<li><code>global_uninit_var</code> 被分配到了 <code>__common</code></li>
</ul>
<p>相对于 <code>objdump</code> 打印文件信息，<code>readelf</code> 工具主要是能更好的解析 ELF 文件的格式：</p>
<p><img src="https://image.mwish.me/blog-image/4432749571058982552.png" alt="img"></p>
<p>接下来，用 <code>readelf</code> 工具可以读对应的 elf 文件头：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">llvm-readelf -h <span class="number">3</span><span class="number">-1.</span>o </span><br><span class="line">MachHeader &#123;</span><br><span class="line">  Magic: Magic64 (<span class="number">0xFEEDFACF</span>)</span><br><span class="line">  CpuType: Arm64 (<span class="number">0x100000C</span>)</span><br><span class="line">  CpuSubType: CPU_SUBTYPE_ARM64_ALL (<span class="number">0x0</span>)</span><br><span class="line">  FileType: Relocatable (<span class="number">0x1</span>)</span><br><span class="line">  NumOfLoadCommands: <span class="number">4</span></span><br><span class="line">  SizeOfLoadCommands: <span class="number">680</span></span><br><span class="line">  Flags [ (<span class="number">0x2000</span>)</span><br><span class="line">    MH_SUBSECTIONS_VIA_SYMBOLS (<span class="number">0x2000</span>)</span><br><span class="line">  ]</span><br><span class="line">  Reserved: <span class="number">0x0</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">llvm-readelf -h ch3<span class="number">-1.</span>o </span><br><span class="line">ELF Header:</span><br><span class="line">  Magic:   <span class="number">7f</span> <span class="number">45</span> <span class="number">4</span>c <span class="number">46</span> <span class="number">02</span> <span class="number">01</span> <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span></span><br><span class="line">  Class:                             ELF64</span><br><span class="line">  Data:                              <span class="number">2&#x27;</span>s complement, little endian</span><br><span class="line">  Version:                           <span class="number">1</span> (current)</span><br><span class="line">  OS/ABI:                            UNIX - System V</span><br><span class="line">  ABI Version:                       <span class="number">0</span></span><br><span class="line">  Type:                              REL (Relocatable file)</span><br><span class="line">  Machine:                           Advanced Micro Devices X86<span class="number">-64</span></span><br><span class="line">  Version:                           <span class="number">0x1</span></span><br><span class="line">  Entry point address:               <span class="number">0x0</span></span><br><span class="line">  Start of program headers:          <span class="number">0</span> (bytes into file)</span><br><span class="line">  Start of section headers:          <span class="number">992</span> (bytes into file)</span><br><span class="line">  Flags:                             <span class="number">0x0</span></span><br><span class="line">  Size of this header:               <span class="number">64</span> (bytes)</span><br><span class="line">  Size of program headers:           <span class="number">0</span> (bytes)</span><br><span class="line">  Number of program headers:         <span class="number">0</span></span><br><span class="line">  Size of section headers:           <span class="number">64</span> (bytes)</span><br><span class="line">  Number of section headers:         <span class="number">13</span></span><br><span class="line">  Section header <span class="built_in">string</span> table index: <span class="number">1</span></span><br></pre></td></tr></table></figure>
<p>而 ELF Header 之后，可以跳转到 Section header table ( 即前面图中，文件尾部的 Section Table），去读取对应内容，这里也能看到文件中有多少个有效的段：</p>
<p>这里可以看到:</p>
<ul>
<li><code>Type</code> 里面的段类型，段的名字只在编译-链接过程有意义，真正决定段属性的还是 <code>Type</code></li>
<li><code>Flg</code> 代表段的执行属性</li>
<li><code>.rela.text</code> 是 <code>.text</code> 段的重定位表，重定位表类型是 <code>RELA</code></li>
<li><code>.strtab</code> 是字符串表</li>
<li><code>.syntab</code> 是符号表</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">llvm-readelf -S ch3<span class="number">-1.</span>o</span><br><span class="line">There are <span class="number">13</span> section headers, starting at offset <span class="number">0x3e0</span>:</span><br><span class="line"></span><br><span class="line">Section Headers:</span><br><span class="line">  [Nr] Name              Type            Address          Off    Size   ES Flg Lk Inf Al</span><br><span class="line">  [ <span class="number">0</span>]                   <span class="literal">NULL</span>            <span class="number">0000000000000000</span> <span class="number">000000</span> <span class="number">000000</span> <span class="number">00</span>      <span class="number">0</span>   <span class="number">0</span>  <span class="number">0</span></span><br><span class="line">  [ <span class="number">1</span>] .strtab           STRTAB          <span class="number">0000000000000000</span> <span class="number">00030</span>c <span class="number">0000</span>d0 <span class="number">00</span>      <span class="number">0</span>   <span class="number">0</span>  <span class="number">1</span></span><br><span class="line">  [ <span class="number">2</span>] .text             PROGBITS        <span class="number">0000000000000000</span> <span class="number">000040</span> <span class="number">000066</span> <span class="number">00</span>  AX  <span class="number">0</span>   <span class="number">0</span> <span class="number">16</span></span><br><span class="line">  [ <span class="number">3</span>] .rela.text        RELA            <span class="number">0000000000000000</span> <span class="number">000260</span> <span class="number">000078</span> <span class="number">18</span>   I <span class="number">12</span>   <span class="number">2</span>  <span class="number">8</span></span><br><span class="line">  [ <span class="number">4</span>] .data             PROGBITS        <span class="number">0000000000000000</span> <span class="number">0000</span>a8 <span class="number">000008</span> <span class="number">00</span>  WA  <span class="number">0</span>   <span class="number">0</span>  <span class="number">4</span></span><br><span class="line">  [ <span class="number">5</span>] .rodata.str1<span class="number">.1</span>    PROGBITS        <span class="number">0000000000000000</span> <span class="number">0000b</span>0 <span class="number">000004</span> <span class="number">01</span> AMS  <span class="number">0</span>   <span class="number">0</span>  <span class="number">1</span></span><br><span class="line">  [ <span class="number">6</span>] .bss              NOBITS          <span class="number">0000000000000000</span> <span class="number">0000b</span>4 <span class="number">000008</span> <span class="number">00</span>  WA  <span class="number">0</span>   <span class="number">0</span>  <span class="number">4</span></span><br><span class="line">  [ <span class="number">7</span>] .comment          PROGBITS        <span class="number">0000000000000000</span> <span class="number">0000b</span>4 <span class="number">000016</span> <span class="number">01</span>  MS  <span class="number">0</span>   <span class="number">0</span>  <span class="number">1</span></span><br><span class="line">  [ <span class="number">8</span>] .note.GNU-<span class="built_in">stack</span>   PROGBITS        <span class="number">0000000000000000</span> <span class="number">0000</span>ca <span class="number">000000</span> <span class="number">00</span>      <span class="number">0</span>   <span class="number">0</span>  <span class="number">1</span></span><br><span class="line">  [ <span class="number">9</span>] .eh_frame         X86_64_UNWIND   <span class="number">0000000000000000</span> <span class="number">0000</span>d0 <span class="number">000058</span> <span class="number">00</span>   A  <span class="number">0</span>   <span class="number">0</span>  <span class="number">8</span></span><br><span class="line">  [<span class="number">10</span>] .rela.eh_frame    RELA            <span class="number">0000000000000000</span> <span class="number">0002</span>d8 <span class="number">000030</span> <span class="number">18</span>   I <span class="number">12</span>   <span class="number">9</span>  <span class="number">8</span></span><br><span class="line">  [<span class="number">11</span>] .llvm_addrsig     LLVM_ADDRSIG    <span class="number">0000000000000000</span> <span class="number">000308</span> <span class="number">000004</span> <span class="number">00</span>   E <span class="number">12</span>   <span class="number">0</span>  <span class="number">1</span></span><br><span class="line">  [<span class="number">12</span>] .symtab           SYMTAB          <span class="number">0000000000000000</span> <span class="number">000128</span> <span class="number">000138</span> <span class="number">18</span>      <span class="number">1</span>   <span class="number">8</span>  <span class="number">8</span></span><br><span class="line">Key to Flags:</span><br><span class="line">  W (write), A (alloc), X (execute), M (merge), S (strings), I (info),</span><br><span class="line">  L (link order), O (extra OS processing required), G (group), T (TLS),</span><br><span class="line">  C (compressed), x (unknown), o (OS specific), E (exclude),</span><br><span class="line">  R (retain), l (large), p (processor specific)</span><br></pre></td></tr></table></figure>
<p>在教材中，<code>printf</code> 之类的内容被丢到 <code>.rel.data</code>，准备进行重定位，这里可以打印对应的 rel:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">llvm-readelf -r <span class="number">3</span><span class="number">-1.</span>o  </span><br><span class="line">Relocations [</span><br><span class="line">  Section __text &#123;</span><br><span class="line">    <span class="number">0x7C</span> <span class="number">1</span> <span class="number">2</span> <span class="number">1</span> ARM64_RELOC_BRANCH26 <span class="number">0</span> _func1</span><br><span class="line">    <span class="number">0x64</span> <span class="number">0</span> <span class="number">2</span> <span class="number">1</span> ARM64_RELOC_PAGEOFF12 <span class="number">0</span> _main.static_var2</span><br><span class="line">    <span class="number">0x60</span> <span class="number">1</span> <span class="number">2</span> <span class="number">1</span> ARM64_RELOC_PAGE21 <span class="number">0</span> _main.static_var2</span><br><span class="line">    <span class="number">0x5C</span> <span class="number">0</span> <span class="number">2</span> <span class="number">1</span> ARM64_RELOC_PAGEOFF12 <span class="number">0</span> _main.static_var</span><br><span class="line">    <span class="number">0x58</span> <span class="number">1</span> <span class="number">2</span> <span class="number">1</span> ARM64_RELOC_PAGE21 <span class="number">0</span> _main.static_var</span><br><span class="line">    <span class="number">0x30</span> <span class="number">1</span> <span class="number">2</span> <span class="number">1</span> ARM64_RELOC_BRANCH26 <span class="number">0</span> _printf</span><br><span class="line">    <span class="number">0x20</span> <span class="number">0</span> <span class="number">2</span> <span class="number">1</span> ARM64_RELOC_PAGEOFF12 <span class="number">0</span> l_.str</span><br><span class="line">    <span class="number">0x1C</span> <span class="number">1</span> <span class="number">2</span> <span class="number">1</span> ARM64_RELOC_PAGE21 <span class="number">0</span> l_.str</span><br><span class="line">    <span class="number">0x14</span> <span class="number">1</span> <span class="number">2</span> <span class="number">1</span> ARM64_RELOC_BRANCH26 <span class="number">0</span> _wrap</span><br><span class="line">  &#125;</span><br><span class="line">  Section __compact_unwind &#123;</span><br><span class="line">    <span class="number">0x20</span> <span class="number">0</span> <span class="number">3</span> <span class="number">0</span> ARM64_RELOC_UNSIGNED <span class="number">0</span> __text</span><br><span class="line">    <span class="number">0x0</span> <span class="number">0</span> <span class="number">3</span> <span class="number">0</span> ARM64_RELOC_UNSIGNED <span class="number">0</span> __text</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">llvm-readelf -r ch3<span class="number">-1.</span>o </span><br><span class="line"></span><br><span class="line">Relocation section <span class="string">&#x27;.rela.text&#x27;</span> at offset <span class="number">0x260</span> contains <span class="number">5</span> entries:</span><br><span class="line">    Offset             Info             Type               Symbol<span class="number">&#x27;</span>s Value  Symbol<span class="number">&#x27;</span>s Name + Addend</span><br><span class="line"><span class="number">0000000000000011</span>  <span class="number">0000000300000002</span> R_X86_64_PC32          <span class="number">0000000000000000</span> .L.str - <span class="number">4</span></span><br><span class="line"><span class="number">0000000000000018</span>  <span class="number">0000000900000004</span> R_X86_64_PLT32         <span class="number">0000000000000000</span> <span class="built_in">printf</span> - <span class="number">4</span></span><br><span class="line"><span class="number">0000000000000048</span>  <span class="number">0000000600000002</span> R_X86_64_PC32          <span class="number">0000000000000000</span> .data + <span class="number">0</span></span><br><span class="line"><span class="number">000000000000004</span>e  <span class="number">0000000700000002</span> R_X86_64_PC32          <span class="number">0000000000000000</span> .bss - <span class="number">4</span></span><br><span class="line"><span class="number">0000000000000059</span>  <span class="number">0000000800000004</span> R_X86_64_PLT32         <span class="number">0000000000000000</span> func1 - <span class="number">4</span></span><br><span class="line"></span><br><span class="line">Relocation section <span class="string">&#x27;.rela.eh_frame&#x27;</span> at offset <span class="number">0x2d8</span> contains <span class="number">2</span> entries:</span><br><span class="line">    Offset             Info             Type               Symbol<span class="number">&#x27;</span>s Value  Symbol<span class="number">&#x27;</span>s Name + Addend</span><br><span class="line"><span class="number">0000000000000020</span>  <span class="number">0000000200000002</span> R_X86_64_PC32          <span class="number">0000000000000000</span> .text + <span class="number">0</span></span><br><span class="line"><span class="number">0000000000000040</span>  <span class="number">0000000200000002</span> R_X86_64_PC32          <span class="number">0000000000000000</span> .text + <span class="number">30</span></span><br></pre></td></tr></table></figure>
<p>这里面上面一个就是著名的 <code>.rel.text</code>.</p>
<p>在链接的时候，这里可能有下列的符号：</p>
<ol>
<li>本目标文件定义的全局符号</li>
<li>本目标文件引用的全局符号</li>
<li>段名</li>
<li>局部符号：编译单元内不可见，比如 <code>static_var</code></li>
<li>行号等 debug 信息</li>
</ol>
<p>这里符号还有强弱符号，有相关的定义：</p>
<ul>
<li>不允许强符号被多次定义</li>
<li>如果一个符号在某个目标文件是强符号，剩下都是弱符号，链接器选择强符号</li>
<li>如果全部都是弱符号，选择最大的弱符号（最好不要这么做）</li>
</ul>
<p>对于符号表（ <code>.syntab</code> ) 来说，符号表自身也有对应的结构：</p>
<ul>
<li>符号的类型是 「局部符号」「全局符号」还是「弱引用」</li>
<li>符号的类型是「段」「类型」「文件名」还是什么</li>
<li>定义在本目标中的文件的符号所在段</li>
</ul>
<p>不过我这里看了一下符号表，发现 <code>printf</code> 在 <em><code>UND</code></em> 中，即 UNDEFINED</p>
<p>这里还涉及一下 mangle demangle 的问题，对于 C++ 的 demangle，有个工具是：<a target="_blank" rel="noopener" href="https://llvm.org/docs/CommandGuide/llvm-cxxfilt.html">https://llvm.org/docs/CommandGuide/llvm-cxxfilt.html</a> . 这里这个可以帮助 demangle 相关的 C++ 符号。</p>
<p>对于 C++ 中调用 C 函数，为了保证 C Style 的符号，需要 Extern “C”, 有一个很好的例子是：<a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/58665349/what-are-g-begin-decls-and-g-end-decls-for">https://stackoverflow.com/questions/58665349/what-are-g-begin-decls-and-g-end-decls-for</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">G_BEGIN_DECLS</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">G_END_DECLS</span><br></pre></td></tr></table></figure>
<p>在 <code>ld</code> 做链接，生产可执行文件的时候，这里会定义很多 Linker 段，我翻了一下之前做 rCore 的时候的笔记：<a target="_blank" rel="noopener" href="https://github.com/mapleFU/mwishCore/issues/5">https://github.com/mapleFU/mwishCore/issues/5</a> ，我怎么能写的这么清晰？实际上这里也和 Linker Script 有关，系统上 <code>ld --verbose</code> 或者 </p>
<p>书上列了一些：</p>
<ul>
<li><code>__executable_start</code>: 表示程序起始地址</li>
<li><code>__etext</code> 代码段结束地址</li>
<li><code>_edata</code> 数据段结束地址</li>
<li><code>_end</code> 程序结束地址</li>
<li>上面都是被 LOAD 时候的虚拟地址，可以直接 <code>extern char</code> 使用这些地址</li>
</ul>
<p>这里还允许带上 debug 信息，如果带上 <code>-g</code> 编译，可以多出下面的 debug 段：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">llvm-readelf -S ch3-1-dbg.o</span><br><span class="line">There are 24 section headers, starting at offset 0xae8:</span><br><span class="line"></span><br><span class="line">Section Headers:</span><br><span class="line">  [Nr] Name              Type            Address          Off    Size   ES Flg Lk Inf Al</span><br><span class="line">  [ 7] .debug_abbrev     PROGBITS        0000000000000000 0000b4 0000b3 00      0   0  1</span><br><span class="line">  [ 8] .debug_info       PROGBITS        0000000000000000 000167 0000af 00      0   0  1</span><br><span class="line">  [ 9] .rela.debug_info  RELA            0000000000000000 0006b8 000060 18   I 23   8  8</span><br><span class="line">  [10] .debug_str_offsets PROGBITS       0000000000000000 000216 000044 00      0   0  1</span><br><span class="line">  [11] .rela.debug_str_offsets RELA      0000000000000000 000718 000168 18   I 23  10  8</span><br><span class="line">  [12] .debug_str        PROGBITS        0000000000000000 00025a 0000a6 01  MS  0   0  1</span><br><span class="line">  [13] .debug_addr       PROGBITS        0000000000000000 000300 000040 00      0   0  1</span><br><span class="line">  [14] .rela.debug_addr  RELA            0000000000000000 000880 0000a8 18   I 23  13  8</span><br><span class="line">  [21] .debug_line_str   PROGBITS        0000000000000000 000434 00002a 01  MS  0   0  1</span><br><span class="line">Key to Flags:</span><br><span class="line">  W (write), A (alloc), X (execute), M (merge), S (strings), I (info),</span><br><span class="line">  L (<span class="built_in">link</span> order), O (extra OS processing required), G (group), T (TLS),</span><br><span class="line">  C (compressed), x (unknown), o (OS specific), E (exclude),</span><br><span class="line">  R (retain), l (large), p (processor specific)</span><br></pre></td></tr></table></figure>
<p>ELF 采用 DWARF 作为默认的 debug 格式，stacktrace 之类的方式都需要拿到一些对应的信息。摘录如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line">llvm-dwarfdump --all ch3-1-dbg.o</span><br><span class="line">ch3-1-dbg.o:    file format elf64-x86-64</span><br><span class="line"></span><br><span class="line">.debug_abbrev contents:</span><br><span class="line">Abbrev table <span class="keyword">for</span> offset: 0x00000000</span><br><span class="line">[1] DW_TAG_compile_unit DW_CHILDREN_yes</span><br><span class="line">        DW_AT_producer  DW_FORM_strx1</span><br><span class="line">        DW_AT_language  DW_FORM_data2</span><br><span class="line">        DW_AT_name      DW_FORM_strx1</span><br><span class="line">        DW_AT_str_offsets_base  DW_FORM_sec_offset</span><br><span class="line">        DW_AT_stmt_list DW_FORM_sec_offset</span><br><span class="line">        DW_AT_comp_dir  DW_FORM_strx1</span><br><span class="line">        DW_AT_low_pc    DW_FORM_addrx</span><br><span class="line">        DW_AT_high_pc   DW_FORM_data4</span><br><span class="line">        DW_AT_addr_base DW_FORM_sec_offset</span><br><span class="line">        </span><br><span class="line">.debug_info contents:</span><br><span class="line">0x00000000: Compile Unit: length = 0x000000ab, format = DWARF32, version = 0x0005, unit_type = DW_UT_compile, abbr_offset = 0x0000, addr_size = 0x08 (next unit at 0x000000af)</span><br><span class="line"></span><br><span class="line">0x0000000c: DW_TAG_compile_unit</span><br><span class="line">              DW_AT_producer    (<span class="string">&quot;clang version 17.0.3&quot;</span>)</span><br><span class="line">              DW_AT_language    (DW_LANG_C11)</span><br><span class="line">              DW_AT_name        (<span class="string">&quot;ch3-1.c&quot;</span>)</span><br><span class="line">              DW_AT_str_offsets_base    (0x00000008)</span><br><span class="line">              DW_AT_stmt_list   (0x00000000)</span><br><span class="line">              DW_AT_comp_dir    (<span class="string">&quot;&#123;&#125;/learn-compile&quot;</span>)</span><br><span class="line">              DW_AT_low_pc      (0x0000000000000000)</span><br><span class="line">              DW_AT_high_pc     (0x0000000000000066)</span><br><span class="line">              DW_AT_addr_base   (0x00000008)</span><br><span class="line"></span><br><span class="line">0x0000008c:   DW_TAG_variable</span><br><span class="line">                DW_AT_name      (<span class="string">&quot;global_uninit_var&quot;</span>)</span><br><span class="line">                DW_AT_type      (0x0000002e <span class="string">&quot;int&quot;</span>)</span><br><span class="line">                DW_AT_external  (<span class="literal">true</span>)</span><br><span class="line">                DW_AT_decl_file (<span class="string">&quot;&#123;&#125;/learn-compile/ch3-1.c&quot;</span>)</span><br><span class="line">                DW_AT_decl_line (4)</span><br><span class="line">                DW_AT_location  (DW_OP_addrx 0x4)</span><br><span class="line"></span><br><span class="line">.debug_line contents:</span><br><span class="line">debug_line[0x00000000]</span><br><span class="line">Line table prologue:</span><br><span class="line">    total_length: 0x00000080</span><br><span class="line">          format: DWARF32</span><br><span class="line">         version: 5</span><br><span class="line">    address_size: 8</span><br><span class="line"> seg_select_size: 0</span><br><span class="line"> prologue_length: 0x00000037</span><br><span class="line"> min_inst_length: 1</span><br><span class="line">max_ops_per_inst: 1</span><br><span class="line"> default_is_stmt: 1</span><br><span class="line">       line_base: -5</span><br><span class="line">      line_range: 14</span><br><span class="line">     opcode_base: 13</span><br><span class="line">standard_opcode_lengths[DW_LNS_copy] = 0</span><br><span class="line">standard_opcode_lengths[DW_LNS_advance_pc] = 1</span><br><span class="line">standard_opcode_lengths[DW_LNS_advance_line] = 1</span><br><span class="line">standard_opcode_lengths[DW_LNS_set_file] = 1</span><br><span class="line">standard_opcode_lengths[DW_LNS_set_column] = 1</span><br><span class="line">standard_opcode_lengths[DW_LNS_negate_stmt] = 0</span><br><span class="line">standard_opcode_lengths[DW_LNS_set_basic_block] = 0</span><br><span class="line">standard_opcode_lengths[DW_LNS_const_add_pc] = 0</span><br><span class="line">standard_opcode_lengths[DW_LNS_fixed_advance_pc] = 1</span><br><span class="line">standard_opcode_lengths[DW_LNS_set_prologue_end] = 0</span><br><span class="line">standard_opcode_lengths[DW_LNS_set_epilogue_begin] = 0</span><br><span class="line">standard_opcode_lengths[DW_LNS_set_isa] = 1</span><br><span class="line">include_directories[  0] = <span class="string">&quot;&#123;&#125;/learn-compile&quot;</span></span><br><span class="line">file_names[  0]:</span><br><span class="line">           name: <span class="string">&quot;ch3-1.c&quot;</span></span><br><span class="line">      dir_index: 0</span><br><span class="line">   md5_checksum: 4bffa4da73a8e4e5e008eff1bb4d494e</span><br><span class="line"></span><br><span class="line">.debug_line_str contents:</span><br><span class="line">0x00000000: <span class="string">&quot;&#123;&#125;/learn-compile&quot;</span></span><br><span class="line">0x00000022: <span class="string">&quot;ch3-1.c&quot;</span></span><br><span class="line"></span><br><span class="line">.debug_addr contents:</span><br><span class="line">Address table header: length = 0x0000003c, format = DWARF32, version = 0x0005, addr_size = 0x08, seg_size = 0x00</span><br><span class="line">Addrs: [</span><br><span class="line">0x0000000000000000</span><br><span class="line">0x0000000000000000</span><br><span class="line">0x0000000000000004</span><br><span class="line">0x0000000000000000</span><br><span class="line">0x0000000000000004</span><br><span class="line">0x0000000000000000</span><br><span class="line">0x0000000000000030</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">.debug_str_offsets contents:</span><br><span class="line">0x00000000: Contribution size = 64, Format = DWARF32, Version = 5</span><br><span class="line">0x00000008: 00000000 <span class="string">&quot;clang version 17.0.3&quot;</span></span><br><span class="line">0x0000000c: 00000015 <span class="string">&quot;ch3-1.c&quot;</span></span><br><span class="line">0x00000010: 0000001d <span class="string">&quot;&#123;&#125;/learn-compile&quot;</span></span><br><span class="line">0x00000014: 0000003f <span class="string">&quot;global_init_var&quot;</span></span><br><span class="line">0x00000018: 0000004f <span class="string">&quot;int&quot;</span></span><br><span class="line">0x0000001c: 00000053 <span class="string">&quot;char&quot;</span></span><br><span class="line">0x00000020: 00000058 <span class="string">&quot;__ARRAY_SIZE_TYPE__&quot;</span></span><br><span class="line">0x00000024: 0000006c <span class="string">&quot;static_var&quot;</span></span><br><span class="line">0x00000028: 00000077 <span class="string">&quot;static_var2&quot;</span></span><br><span class="line">0x0000002c: 00000083 <span class="string">&quot;global_uninit_var&quot;</span></span><br><span class="line">0x00000030: 00000095 <span class="string">&quot;func1&quot;</span></span><br><span class="line">0x00000034: 0000009b <span class="string">&quot;main&quot;</span></span><br><span class="line">0x00000038: 000000a0 <span class="string">&quot;i&quot;</span></span><br><span class="line">0x0000003c: 000000a2 <span class="string">&quot;a&quot;</span></span><br><span class="line">0x00000040: 000000a4 <span class="string">&quot;b&quot;</span></span><br></pre></td></tr></table></figure>
<p><code>.debug</code> 相关的信息和 <code>.eh_frame</code> 是给 dwarf 和异常处理使用的，参考：</p>
<ul>
<li>Unwind 栈回溯详解 <a target="_blank" rel="noopener" href="https://www.cnblogs.com/pwl999/p/15534946.html">https://www.cnblogs.com/pwl999/p/15534946.html</a> </li>
<li><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Executable_and_Linkable_Format">https://en.wikipedia.org/wiki/Executable_and_Linkable_Format</a></li>
</ul>
<p>同时，可以用 <code>strip</code> 来去掉这些调试信息，例如可以用 llvm-strip.</p>
<h2 id="静态链接-1"><a href="#静态链接-1" class="headerlink" title="静态链接"></a>静态链接</h2><p>这里执行逻辑差不多是链接多个 ELF 文件成为一个可执行 ELF 文件。sample 代码如下:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// a.c</span></span><br><span class="line"><span class="keyword">extern</span> <span class="type">int</span> shared;</span><br><span class="line"><span class="type">void</span> <span class="title function_">swap</span><span class="params">(<span class="type">int</span>*, <span class="type">int</span>*)</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="type">int</span> a = <span class="number">100</span>;</span><br><span class="line">  swap(&amp;a, &amp;shared);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// b.c</span></span><br><span class="line"><span class="type">int</span> shared = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">swap</span><span class="params">(<span class="type">int</span>* a, <span class="type">int</span>* b)</span> &#123;</span><br><span class="line">  <span class="type">int</span> tmp = *a;</span><br><span class="line">  *a = *b;</span><br><span class="line">  *b = tmp;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://image.mwish.me/blog-image/3200920742870858169.png" alt="img"></p>
<p>我们上一节提到过 Linker Script 和 rCore 的代码，这里链接器位目标文件分配地址和空间：</p>
<ul>
<li>分配输出的可执行文件的空间</li>
<li>也确定 Loader 加载后虚拟地址的”虚拟”空间</li>
</ul>
<p>成书的时候，链接器采用 Two-pass Linking:</p>
<ul>
<li>收集各个段的长度、属性、位置；然后收集所有符号表，统一起来合并到全局符号表，这个地方能建立起合并的段长度等</li>
<li>符号解析和重定位。在符号表地址确定后，可以给原来的偏移地址，再给地址一个相对的偏移量</li>
</ul>
<p>这里查看对应文件和链接后的文件, 这里 VMA (Virtual Memory Address) 表示虚拟地址，LMA (Loaded Memory Address) 表示加载后的地址</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">llvm-objdump -h a.o --show-lma        </span><br><span class="line"></span><br><span class="line">a.o:    file format elf64-x86<span class="number">-64</span></span><br><span class="line"></span><br><span class="line">Sections:</span><br><span class="line">Idx Name            Size     VMA              LMA              Type</span><br><span class="line">  <span class="number">0</span>                 <span class="number">00000000</span> <span class="number">0000000000000000</span> <span class="number">0000000000000000</span> </span><br><span class="line">  <span class="number">1</span> .strtab         <span class="number">00000067</span> <span class="number">0000000000000000</span> <span class="number">0000000000000000</span> </span><br><span class="line">  <span class="number">2</span> .text           <span class="number">0000002</span>e <span class="number">0000000000000000</span> <span class="number">0000000000000000</span> TEXT</span><br><span class="line">  <span class="number">3</span> .rela.text      <span class="number">00000030</span> <span class="number">0000000000000000</span> <span class="number">0000000000000000</span> </span><br><span class="line">  <span class="number">4</span> .comment        <span class="number">00000016</span> <span class="number">0000000000000000</span> <span class="number">0000000000000000</span> </span><br><span class="line">  <span class="number">5</span> .note.GNU-<span class="built_in">stack</span> <span class="number">00000000</span> <span class="number">0000000000000000</span> <span class="number">0000000000000000</span> </span><br><span class="line">  <span class="number">6</span> .eh_frame       <span class="number">00000038</span> <span class="number">0000000000000000</span> <span class="number">0000000000000000</span> </span><br><span class="line">  <span class="number">7</span> .rela.eh_frame  <span class="number">00000018</span> <span class="number">0000000000000000</span> <span class="number">0000000000000000</span> </span><br><span class="line">  <span class="number">8</span> .llvm_addrsig   <span class="number">00000002</span> <span class="number">0000000000000000</span> <span class="number">0000000000000000</span> </span><br><span class="line">  <span class="number">9</span> .symtab         <span class="number">00000090</span> <span class="number">0000000000000000</span> <span class="number">0000000000000000</span></span><br><span class="line"></span><br><span class="line">llvm-objdump -h b.o --show-lma </span><br><span class="line"></span><br><span class="line">b.o:    file format elf64-x86<span class="number">-64</span></span><br><span class="line"></span><br><span class="line">Sections:</span><br><span class="line">Idx Name            Size     VMA              LMA              Type</span><br><span class="line">  <span class="number">0</span>                 <span class="number">00000000</span> <span class="number">0000000000000000</span> <span class="number">0000000000000000</span> </span><br><span class="line">  <span class="number">1</span> .strtab         <span class="number">00000063</span> <span class="number">0000000000000000</span> <span class="number">0000000000000000</span> </span><br><span class="line">  <span class="number">2</span> .text           <span class="number">0000002</span>c <span class="number">0000000000000000</span> <span class="number">0000000000000000</span> TEXT</span><br><span class="line">  <span class="number">3</span> .data           <span class="number">00000004</span> <span class="number">0000000000000000</span> <span class="number">0000000000000000</span> DATA</span><br><span class="line">  <span class="number">4</span> .comment        <span class="number">00000016</span> <span class="number">0000000000000000</span> <span class="number">0000000000000000</span> </span><br><span class="line">  <span class="number">5</span> .note.GNU-<span class="built_in">stack</span> <span class="number">00000000</span> <span class="number">0000000000000000</span> <span class="number">0000000000000000</span> </span><br><span class="line">  <span class="number">6</span> .eh_frame       <span class="number">00000038</span> <span class="number">0000000000000000</span> <span class="number">0000000000000000</span> </span><br><span class="line">  <span class="number">7</span> .rela.eh_frame  <span class="number">00000018</span> <span class="number">0000000000000000</span> <span class="number">0000000000000000</span> </span><br><span class="line">  <span class="number">8</span> .llvm_addrsig   <span class="number">00000000</span> <span class="number">0000000000000000</span> <span class="number">0000000000000000</span> </span><br><span class="line">  <span class="number">9</span> .symtab         <span class="number">00000078</span> <span class="number">0000000000000000</span> <span class="number">0000000000000000</span> </span><br><span class="line"></span><br><span class="line">llvm-objdump -h a.out --show-lma</span><br><span class="line"></span><br><span class="line">a.out:  file format elf64-x86<span class="number">-64</span></span><br><span class="line"></span><br><span class="line">Sections:</span><br><span class="line">Idx Name           Size     VMA              LMA              Type</span><br><span class="line">  <span class="number">0</span>                <span class="number">00000000</span> <span class="number">0000000000000000</span> <span class="number">0000000000000000</span> </span><br><span class="line">  <span class="number">1</span> .interp        <span class="number">0000001</span>c <span class="number">00000000000002</span>a8 <span class="number">00000000000002</span>a8 DATA</span><br><span class="line">  <span class="number">2</span> .note.ABI-tag  <span class="number">00000020</span> <span class="number">00000000000002</span>c4 <span class="number">00000000000002</span>c4 </span><br><span class="line">  <span class="number">3</span> .gnu.hash      <span class="number">0000001</span>c <span class="number">00000000000002e8</span> <span class="number">00000000000002e8</span> </span><br><span class="line">  <span class="number">4</span> .dynsym        <span class="number">00000090</span> <span class="number">0000000000000308</span> <span class="number">0000000000000308</span> </span><br><span class="line">  <span class="number">5</span> .dynstr        <span class="number">0000007</span>d <span class="number">0000000000000398</span> <span class="number">0000000000000398</span> </span><br><span class="line">  <span class="number">6</span> .gnu.version   <span class="number">0000000</span>c <span class="number">0000000000000416</span> <span class="number">0000000000000416</span> </span><br><span class="line">  <span class="number">7</span> .gnu.version_r <span class="number">00000020</span> <span class="number">0000000000000428</span> <span class="number">0000000000000428</span> </span><br><span class="line">  <span class="number">8</span> .rela.dyn      <span class="number">000000</span>a8 <span class="number">0000000000000448</span> <span class="number">0000000000000448</span> </span><br><span class="line">  <span class="number">9</span> .rela.plt      <span class="number">00000048</span> <span class="number">00000000000004f</span>0 <span class="number">00000000000004f</span>0 </span><br><span class="line"> <span class="number">10</span> .init          <span class="number">0000001</span>a <span class="number">0000000000001000</span> <span class="number">0000000000001000</span> TEXT</span><br><span class="line"> <span class="number">11</span> .plt           <span class="number">00000040</span> <span class="number">0000000000001020</span> <span class="number">0000000000001020</span> TEXT</span><br><span class="line"> <span class="number">12</span> .text          <span class="number">000001</span>c2 <span class="number">0000000000001060</span> <span class="number">0000000000001060</span> TEXT</span><br><span class="line"> <span class="number">13</span> .fini          <span class="number">00000009</span> <span class="number">0000000000001224</span> <span class="number">0000000000001224</span> TEXT</span><br><span class="line"> <span class="number">14</span> .rodata        <span class="number">00000004</span> <span class="number">0000000000002000</span> <span class="number">0000000000002000</span> DATA</span><br><span class="line"> <span class="number">15</span> .eh_frame_hdr  <span class="number">0000003</span>c <span class="number">0000000000002004</span> <span class="number">0000000000002004</span> DATA</span><br><span class="line"> <span class="number">16</span> .eh_frame      <span class="number">00000110</span> <span class="number">0000000000002040</span> <span class="number">0000000000002040</span> DATA</span><br><span class="line"> <span class="number">17</span> .init_array    <span class="number">00000008</span> <span class="number">0000000000003</span>de8 <span class="number">0000000000003</span>de8 </span><br><span class="line"> <span class="number">18</span> .fini_array    <span class="number">00000008</span> <span class="number">0000000000003</span>df0 <span class="number">0000000000003</span>df0 </span><br><span class="line"> <span class="number">19</span> .data.rel.ro   <span class="number">00000008</span> <span class="number">0000000000003</span>df8 <span class="number">0000000000003</span>df8 DATA</span><br><span class="line"> <span class="number">20</span> .dynamic       <span class="number">000001e0</span> <span class="number">0000000000003e00</span> <span class="number">0000000000003e00</span> </span><br><span class="line"> <span class="number">21</span> .got           <span class="number">00000020</span> <span class="number">0000000000003f</span>e0 <span class="number">0000000000003f</span>e0 DATA</span><br><span class="line"> <span class="number">22</span> .got.plt       <span class="number">00000030</span> <span class="number">0000000000004000</span> <span class="number">0000000000004000</span> DATA</span><br><span class="line"> <span class="number">23</span> .data          <span class="number">00000008</span> <span class="number">0000000000004030</span> <span class="number">0000000000004030</span> DATA</span><br><span class="line"> <span class="number">24</span> .bss           <span class="number">00000008</span> <span class="number">0000000000004038</span> <span class="number">0000000000004038</span> BSS</span><br><span class="line"> <span class="number">25</span> .comment       <span class="number">00000070</span> <span class="number">0000000000000000</span> <span class="number">0000000000000000</span> </span><br><span class="line"> <span class="number">26</span> .symtab        <span class="number">000003</span>c0 <span class="number">0000000000000000</span> <span class="number">0000000000000000</span> </span><br><span class="line"> <span class="number">27</span> .strtab        <span class="number">000001f</span>8 <span class="number">0000000000000000</span> <span class="number">0000000000000000</span> </span><br><span class="line"> <span class="number">28</span> .shstrtab      <span class="number">000000f</span>d <span class="number">0000000000000000</span> <span class="number">0000000000000000</span> </span><br></pre></td></tr></table></figure>
<p>我们对代码 <code>llvm-objdump -d</code> 一下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// llvm-objdump -d a.o</span></span><br><span class="line"></span><br><span class="line">a.o:    file format elf64-x86<span class="number">-64</span></span><br><span class="line"></span><br><span class="line">Disassembly of section .text:</span><br><span class="line"></span><br><span class="line"><span class="number">0000000000000000</span> &lt;main&gt;:</span><br><span class="line">       <span class="number">0</span>: <span class="number">55</span>                            pushq   %rbp</span><br><span class="line">       <span class="number">1</span>: <span class="number">48</span> <span class="number">89</span> e5                      movq    %rsp, %rbp</span><br><span class="line">       <span class="number">4</span>: <span class="number">48</span> <span class="number">83</span> ec <span class="number">10</span>                   subq    $<span class="number">0x10</span>, %rsp</span><br><span class="line">       <span class="number">8</span>: c7 <span class="number">45</span> fc <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>          movl    $<span class="number">0x0</span>, <span class="number">-0x4</span>(%rbp)</span><br><span class="line">       f: c7 <span class="number">45</span> f8 <span class="number">64</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>          movl    $<span class="number">0x64</span>, <span class="number">-0x8</span>(%rbp)</span><br><span class="line">      <span class="number">16</span>: <span class="number">48</span> <span class="number">8</span>d <span class="number">7</span>d f8                   leaq    <span class="number">-0x8</span>(%rbp), %rdi</span><br><span class="line">      <span class="number">1</span>a: <span class="number">48</span> <span class="number">8b</span> <span class="number">35</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>          movq    (%rip), %rsi            # <span class="number">0x21</span> &lt;main+<span class="number">0x21</span>&gt;</span><br><span class="line">      <span class="number">21</span>: e8 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>                callq   <span class="number">0x26</span> &lt;main+<span class="number">0x26</span>&gt;</span><br><span class="line">      <span class="number">26</span>: <span class="number">31</span> c0                         xorl    %eax, %eax</span><br><span class="line">      <span class="number">28</span>: <span class="number">48</span> <span class="number">83</span> c4 <span class="number">10</span>                   addq    $<span class="number">0x10</span>, %rsp</span><br><span class="line">      <span class="number">2</span>c: <span class="number">5</span>d                            popq    %rbp</span><br><span class="line">      <span class="number">2</span>d: c3                            retq</span><br><span class="line">      </span><br><span class="line"><span class="comment">// llvm-objdump -drw -Mintel a.o </span></span><br><span class="line"></span><br><span class="line">a.o:    file format elf64-x86<span class="number">-64</span></span><br><span class="line"></span><br><span class="line">Disassembly of section .text:</span><br><span class="line"></span><br><span class="line"><span class="number">0000000000000000</span> &lt;main&gt;:</span><br><span class="line">       <span class="number">0</span>: <span class="number">55</span>                            push    rbp</span><br><span class="line">       <span class="number">1</span>: <span class="number">48</span> <span class="number">89</span> e5                      mov     rbp, rsp</span><br><span class="line">       <span class="number">4</span>: <span class="number">48</span> <span class="number">83</span> ec <span class="number">10</span>                   sub     rsp, <span class="number">0x10</span></span><br><span class="line">       <span class="number">8</span>: c7 <span class="number">45</span> fc <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>          mov     dword ptr [rbp - <span class="number">0x4</span>], <span class="number">0x0</span></span><br><span class="line">       f: c7 <span class="number">45</span> f8 <span class="number">64</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>          mov     dword ptr [rbp - <span class="number">0x8</span>], <span class="number">0x64</span></span><br><span class="line">      <span class="number">16</span>: <span class="number">48</span> <span class="number">8</span>d <span class="number">7</span>d f8                   lea     rdi, [rbp - <span class="number">0x8</span>]</span><br><span class="line">      <span class="number">1</span>a: <span class="number">48</span> <span class="number">8b</span> <span class="number">35</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>          mov     rsi, qword ptr [rip]    # <span class="number">0x21</span> &lt;main+<span class="number">0x21</span>&gt;</span><br><span class="line">                <span class="number">000000000000001</span>d:  R_X86_64_REX_GOTPCRELX       shared<span class="number">-0x4</span></span><br><span class="line">      <span class="number">21</span>: e8 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>                call    <span class="number">0x26</span> &lt;main+<span class="number">0x26</span>&gt;</span><br><span class="line">                <span class="number">0000000000000022</span>:  R_X86_64_PLT32       swap<span class="number">-0x4</span></span><br><span class="line">      <span class="number">26</span>: <span class="number">31</span> c0                         xor     eax, eax</span><br><span class="line">      <span class="number">28</span>: <span class="number">48</span> <span class="number">83</span> c4 <span class="number">10</span>                   add     rsp, <span class="number">0x10</span></span><br><span class="line">      <span class="number">2</span>c: <span class="number">5</span>d                            pop     rbp</span><br><span class="line">      <span class="number">2</span>d: c3                            ret</span><br><span class="line"></span><br><span class="line"><span class="comment">// llvm-objdump -d a.out </span></span><br><span class="line"></span><br><span class="line">Disassembly of section .text:</span><br><span class="line"><span class="number">0000000000001150</span> &lt;main&gt;:</span><br><span class="line">    <span class="number">1150</span>: <span class="number">55</span>                            pushq   %rbp</span><br><span class="line">    <span class="number">1151</span>: <span class="number">48</span> <span class="number">89</span> e5                      movq    %rsp, %rbp</span><br><span class="line">    <span class="number">1154</span>: <span class="number">48</span> <span class="number">83</span> ec <span class="number">10</span>                   subq    $<span class="number">0x10</span>, %rsp</span><br><span class="line">    <span class="number">1158</span>: c7 <span class="number">45</span> fc <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>          movl    $<span class="number">0x0</span>, <span class="number">-0x4</span>(%rbp)</span><br><span class="line">    <span class="number">115f</span>: c7 <span class="number">45</span> f8 <span class="number">64</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>          movl    $<span class="number">0x64</span>, <span class="number">-0x8</span>(%rbp)</span><br><span class="line">    <span class="number">1166</span>: <span class="number">48</span> <span class="number">8</span>d <span class="number">7</span>d f8                   leaq    <span class="number">-0x8</span>(%rbp), %rdi</span><br><span class="line">    <span class="number">116</span>a: <span class="number">48</span> <span class="number">8</span>d <span class="number">35</span> c3 <span class="number">2</span>e <span class="number">00</span> <span class="number">00</span>          leaq    <span class="number">0x2ec3</span>(%rip), %rsi      # <span class="number">0x4034</span> &lt;shared&gt;</span><br><span class="line">    <span class="number">1171</span>: e8 <span class="number">0</span>a <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>                callq   <span class="number">0x1180</span> &lt;swap&gt;</span><br><span class="line">    <span class="number">1176</span>: <span class="number">31</span> c0                         xorl    %eax, %eax</span><br><span class="line">    <span class="number">1178</span>: <span class="number">48</span> <span class="number">83</span> c4 <span class="number">10</span>                   addq    $<span class="number">0x10</span>, %rsp</span><br><span class="line">    <span class="number">117</span>c: <span class="number">5</span>d                            popq    %rbp</span><br><span class="line">    <span class="number">117</span>d: c3                            retq</span><br><span class="line">    <span class="number">117</span>e: <span class="number">66</span> <span class="number">90</span>                         nop</span><br></pre></td></tr></table></figure>
<p>从上面可以看到：</p>
<ol>
<li><code>a.o</code> 中并不知道 <code>shared</code> 的地址，用 <code>movq    (%rip), %rsi            # 0x21</code> 来处理</li>
<li>不知道 <code>swap</code> 的地址，用 <code>callq   0x26</code> 代替 swap</li>
<li>链接器用<strong>重定位表</strong>把他们链接起来</li>
</ol>
<p>这里也可以参考：<a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/31818870/assembly-x86-call-instruction-and-memory-address">https://stackoverflow.com/questions/31818870/assembly-x86-call-instruction-and-memory-address</a></p>
<p>重定位表：还记得我们之前看到的 <code>.rela.text</code> 吗？Here it is！这里具体也可以看 maskray 的博客 <a target="_blank" rel="noopener" href="https://maskray.me/blog/2021-08-29-all-about-global-offset-table">https://maskray.me/blog/2021-08-29-all-about-global-offset-table</a> . 下面的地方是对应的 Relocation Entry，这里的 Offset 表示入口在需要被 relocate 的 section 中的位置，也是 <code>a.o</code> 中对应的逻辑位置。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// llvm-objdump -r a.o</span></span><br><span class="line"></span><br><span class="line">a.o:    file format elf64-x86<span class="number">-64</span></span><br><span class="line"></span><br><span class="line">RELOCATION RECORDS FOR [.text]:</span><br><span class="line">OFFSET           TYPE                     VALUE</span><br><span class="line"><span class="number">000000000000001</span>d R_X86_64_REX_GOTPCRELX   shared<span class="number">-0x4</span></span><br><span class="line"><span class="number">0000000000000022</span> R_X86_64_PLT32           swap<span class="number">-0x4</span></span><br><span class="line"></span><br><span class="line">RELOCATION RECORDS FOR [.eh_frame]:</span><br><span class="line">OFFSET           TYPE                     VALUE</span><br><span class="line"><span class="number">0000000000000020</span> R_X86_64_PC32            .text</span><br></pre></td></tr></table></figure>
<p>下面也展示了符号表( <code>llvm-readelf -s</code> )，<code>Ndx</code> 里面有对应的 <code>UND</code>，即连接器应该在全局中找到这里的信息。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// llvm-readelf -s a.o</span></span><br><span class="line"></span><br><span class="line">Symbol table <span class="string">&#x27;.symtab&#x27;</span> contains <span class="number">6</span> entries:</span><br><span class="line">   Num:    Value          Size Type    Bind   Vis       Ndx Name</span><br><span class="line">     <span class="number">0</span>: <span class="number">0000000000000000</span>     <span class="number">0</span> NOTYPE  LOCAL  DEFAULT   UND </span><br><span class="line">     <span class="number">1</span>: <span class="number">0000000000000000</span>     <span class="number">0</span> FILE    LOCAL  DEFAULT   ABS a.c</span><br><span class="line">     <span class="number">2</span>: <span class="number">0000000000000000</span>     <span class="number">0</span> SECTION LOCAL  DEFAULT     <span class="number">2</span> .text</span><br><span class="line">     <span class="number">3</span>: <span class="number">0000000000000000</span>    <span class="number">46</span> FUNC    GLOBAL DEFAULT     <span class="number">2</span> main</span><br><span class="line">     <span class="number">4</span>: <span class="number">0000000000000000</span>     <span class="number">0</span> NOTYPE  GLOBAL DEFAULT   UND shared</span><br><span class="line">     <span class="number">5</span>: <span class="number">0000000000000000</span>     <span class="number">0</span> NOTYPE  GLOBAL DEFAULT   UND swap</span><br></pre></td></tr></table></figure>
<h3 id="LTO"><a href="#LTO" class="headerlink" title="LTO"></a>LTO</h3><p>链接的时候本身会：</p>
<ul>
<li>没用到的函数之类的可以丢了</li>
<li>重复的可以尝试被合并掉</li>
<li>可以尝试内联掉函数</li>
</ul>
<p>具体看 LTO，这也是最近越来越广泛使用的的东西：</p>
<p>代码优化利器 LTO 介绍 - 左沙的文章 - 知乎 <a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/384160632">https://zhuanlan.zhihu.com/p/384160632</a></p>
<h3 id="全局资源"><a href="#全局资源" class="headerlink" title="全局资源"></a>全局资源</h3><p>现在在 <code>a.out</code> 中还存在 <code>.init</code> 和 <code>.fini</code> 这两个段，<code>main</code> 之前就会执行 <code>.init</code> 段，<code>main</code> 之后执行 <code>.fini</code> 段。</p>
<h3 id="ABI"><a href="#ABI" class="headerlink" title="ABI"></a>ABI</h3><p>感觉 abi 在这书和这部分都讨论了一些，原本是很重要的部分，但是笔者比较熟悉这个概念，就不介绍了。</p>
<h3 id="静态库"><a href="#静态库" class="headerlink" title="静态库"></a>静态库</h3><p>一图解千言。<code>clang -static --verbose -fno-builtin</code> 看真相。</p>
<p><img src="https://image.mwish.me/blog-image/8819930589112446864.png" alt="img"></p>
<h3 id="Linker-Script"><a href="#Linker-Script" class="headerlink" title="Linker Script"></a>Linker Script</h3><p>参考之前 rCore 的部分，我就不再写了。</p>
<h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><ol>
<li><a target="_blank" rel="noopener" href="https://jonathan2251.github.io/lbd/elf.html">https://jonathan2251.github.io/lbd/elf.html</a> 介绍过 LLVM 上的 ELF</li>
<li>程序员的自我修养—链接、装载与库</li>
<li>CS61C 2023 Summer</li>
<li>SNU Course: <a target="_blank" rel="noopener" href="https://ocw.snu.ac.kr/sites/default/files/NOTE/08-GNU%20Linker.pdf">https://ocw.snu.ac.kr/sites/default/files/NOTE/08-GNU%20Linker.pdf</a></li>
<li>深入浅出ELF <a target="_blank" rel="noopener" href="https://evilpan.com/2020/08/09/elf-inside-out/">https://evilpan.com/2020/08/09/elf-inside-out/</a></li>
<li>二进制分析工具 bloaty <a target="_blank" rel="noopener" href="https://github.com/google/bloaty">https://github.com/google/bloaty</a></li>
<li>Elf 有关的代码: <a target="_blank" rel="noopener" href="https://github.com/bminor/glibc/blob/glibc-2.27/elf/elf.h">https://github.com/bminor/glibc/blob/glibc-2.27/elf/elf.h</a></li>
<li><a target="_blank" rel="noopener" href="https://coyorkdow.github.io/linking/2024/11/17/C++_linking_linux.html">https://coyorkdow.github.io/linking/2024/11/17/C++_linking_linux.html</a></li>
<li><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/31818870/assembly-x86-call-instruction-and-memory-address">https://stackoverflow.com/questions/31818870/assembly-x86-call-instruction-and-memory-address</a></li>
<li><a target="_blank" rel="noopener" href="https://maskray.me/blog/2021-08-29-all-about-global-offset-table">https://maskray.me/blog/2021-08-29-all-about-global-offset-table</a></li>
<li>代码优化利器 LTO 介绍 - 左沙的文章 - 知乎 <a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/384160632">https://zhuanlan.zhihu.com/p/384160632</a></li>
</ol>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">首页</a></li>
         
          <li><a href="/about/">关于</a></li>
         
          <li><a href="/archives/">归档</a></li>
         
          <li><a href="/search/">搜索</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Basics"><span class="toc-number">1.</span> <span class="toc-text">Basics</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9D%99%E6%80%81%E9%93%BE%E6%8E%A5"><span class="toc-number">2.</span> <span class="toc-text">静态链接</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Elf-Executable-and-Linking-Format"><span class="toc-number">3.</span> <span class="toc-text">Elf: Executable and Linking Format</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Elf-%E7%9A%84%E5%A4%A7%E8%87%B4%E7%BB%93%E6%9E%84"><span class="toc-number">3.1.</span> <span class="toc-text">Elf 的大致结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%A8-LLVM-%E5%B7%A5%E5%85%B7%E9%AA%8C%E8%AF%81%E4%B8%8A%E9%9D%A2%E7%9A%84%E5%86%85%E5%AE%B9%E5%90%A7"><span class="toc-number">3.2.</span> <span class="toc-text">用 LLVM 工具验证上面的内容吧</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9D%99%E6%80%81%E9%93%BE%E6%8E%A5-1"><span class="toc-number">4.</span> <span class="toc-text">静态链接</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#LTO"><span class="toc-number">4.1.</span> <span class="toc-text">LTO</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%A8%E5%B1%80%E8%B5%84%E6%BA%90"><span class="toc-number">4.2.</span> <span class="toc-text">全局资源</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ABI"><span class="toc-number">4.3.</span> <span class="toc-text">ABI</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9D%99%E6%80%81%E5%BA%93"><span class="toc-number">4.4.</span> <span class="toc-text">静态库</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Linker-Script"><span class="toc-number">4.5.</span> <span class="toc-text">Linker Script</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#References"><span class="toc-number">5.</span> <span class="toc-text">References</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://blog.mwish.me/2024/11/20/Compile-Loader-Libraries-Part-1-Static-linking/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://blog.mwish.me/2024/11/20/Compile-Loader-Libraries-Part-1-Static-linking/&text=Compile/Loader/Libraries: Part 1 Static linking"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://blog.mwish.me/2024/11/20/Compile-Loader-Libraries-Part-1-Static-linking/&title=Compile/Loader/Libraries: Part 1 Static linking"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://blog.mwish.me/2024/11/20/Compile-Loader-Libraries-Part-1-Static-linking/&is_video=false&description=Compile/Loader/Libraries: Part 1 Static linking"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Compile/Loader/Libraries: Part 1 Static linking&body=Check out this article: http://blog.mwish.me/2024/11/20/Compile-Loader-Libraries-Part-1-Static-linking/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://blog.mwish.me/2024/11/20/Compile-Loader-Libraries-Part-1-Static-linking/&title=Compile/Loader/Libraries: Part 1 Static linking"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://blog.mwish.me/2024/11/20/Compile-Loader-Libraries-Part-1-Static-linking/&title=Compile/Loader/Libraries: Part 1 Static linking"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://blog.mwish.me/2024/11/20/Compile-Loader-Libraries-Part-1-Static-linking/&title=Compile/Loader/Libraries: Part 1 Static linking"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://blog.mwish.me/2024/11/20/Compile-Loader-Libraries-Part-1-Static-linking/&title=Compile/Loader/Libraries: Part 1 Static linking"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://blog.mwish.me/2024/11/20/Compile-Loader-Libraries-Part-1-Static-linking/&name=Compile/Loader/Libraries: Part 1 Static linking&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://blog.mwish.me/2024/11/20/Compile-Loader-Libraries-Part-1-Static-linking/&t=Compile/Loader/Libraries: Part 1 Static linking"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> 菜单</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> 目录</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> 分享</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> 返回顶部</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2022-2025
    mwish
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">首页</a></li><!--
     --><!--
       --><li><a href="/about/">关于</a></li><!--
     --><!--
       --><li><a href="/archives/">归档</a></li><!--
     --><!--
       --><li><a href="/search/">搜索</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->
 
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script> 




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script> 
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"复制到粘贴板！\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "复制成功！");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

    <script async src="https://www.googletagmanager.com/gtag/js?id=G-FL51GBW6JT"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-FL51GBW6JT');
    </script>

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Umami Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });
</script>
<script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</body>
</html>
