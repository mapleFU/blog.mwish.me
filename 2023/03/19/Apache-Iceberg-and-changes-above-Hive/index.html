<!DOCTYPE html>
<html lang=zh>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="当我们说一个东西是屎山的时候，它最好真的不是…「大数据」这个词在很长一段时间事实标准就是 Apache Hadoop 下那堆东西，因为历史原因，很多东西实际上在 Hive &#x2F; Spark 之类的东西上有一套实现和名词，这套名词本身可能比较草台班子：比如 Bucket &#x2F; Partition 这些东西，在各个系统有不同的叫法，有的东西可能直接和别的系统对应… 你一定想问这些东西和 iceberg 有">
<meta property="og:type" content="article">
<meta property="og:title" content="Apache Iceberg and changes above Hive">
<meta property="og:url" content="http://blog.mwish.me/2023/03/19/Apache-Iceberg-and-changes-above-Hive/index.html">
<meta property="og:site_name" content="风空之岛">
<meta property="og:description" content="当我们说一个东西是屎山的时候，它最好真的不是…「大数据」这个词在很长一段时间事实标准就是 Apache Hadoop 下那堆东西，因为历史原因，很多东西实际上在 Hive &#x2F; Spark 之类的东西上有一套实现和名词，这套名词本身可能比较草台班子：比如 Bucket &#x2F; Partition 这些东西，在各个系统有不同的叫法，有的东西可能直接和别的系统对应… 你一定想问这些东西和 iceberg 有">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://image.mwish.me/blog-image/iceberg-01.png">
<meta property="og:image" content="https://image.mwish.me/blog-image/iceberg-02.png">
<meta property="og:image" content="https://image.mwish.me/blog-image/iceberg-03.png">
<meta property="og:image" content="https://image.mwish.me/blog-image/iceberg-04.png">
<meta property="og:image" content="https://image.mwish.me/blog-image/iceberg-05.png">
<meta property="og:image" content="https://image.mwish.me/blog-image/iceberg-06.png">
<meta property="og:image" content="https://image.mwish.me/blog-image/iceberg-07.png">
<meta property="og:image" content="https://image.mwish.me/blog-image/iceberg-08.png">
<meta property="article:published_time" content="2023-03-19T06:35:00.000Z">
<meta property="article:modified_time" content="2023-03-19T06:33:15.999Z">
<meta property="article:author" content="mwish">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://image.mwish.me/blog-image/iceberg-01.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/logo.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/logo.ico" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/logo.ico">
        
      
    
    <!-- title -->
    <title>Apache Iceberg and changes above Hive</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 6.2.0"></head>

<body class="max-width mx-auto px3 ltr">    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="目录"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="目录"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="顶部" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">首页</a></li><!--
     --><!--
       --><li><a href="/about/">关于</a></li><!--
     --><!--
       --><li><a href="/archives/">归档</a></li><!--
     --><!--
       --><li><a href="/search/">搜索</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="上一篇" href="/2023/03/25/InnoDB-Data-Locking/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="下一篇" href="/2023/03/17/Apache-Hive-A-History-on-Hadoop/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="返回顶部" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="分享文章" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">上一篇</span>
      <span id="i-next" class="info" style="display:none;">下一篇</span>
      <span id="i-top" class="info" style="display:none;">返回顶部</span>
      <span id="i-share" class="info" style="display:none;">分享文章</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://blog.mwish.me/2023/03/19/Apache-Iceberg-and-changes-above-Hive/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://blog.mwish.me/2023/03/19/Apache-Iceberg-and-changes-above-Hive/&text=Apache Iceberg and changes above Hive"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://blog.mwish.me/2023/03/19/Apache-Iceberg-and-changes-above-Hive/&title=Apache Iceberg and changes above Hive"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://blog.mwish.me/2023/03/19/Apache-Iceberg-and-changes-above-Hive/&is_video=false&description=Apache Iceberg and changes above Hive"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Apache Iceberg and changes above Hive&body=Check out this article: http://blog.mwish.me/2023/03/19/Apache-Iceberg-and-changes-above-Hive/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://blog.mwish.me/2023/03/19/Apache-Iceberg-and-changes-above-Hive/&title=Apache Iceberg and changes above Hive"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://blog.mwish.me/2023/03/19/Apache-Iceberg-and-changes-above-Hive/&title=Apache Iceberg and changes above Hive"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://blog.mwish.me/2023/03/19/Apache-Iceberg-and-changes-above-Hive/&title=Apache Iceberg and changes above Hive"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://blog.mwish.me/2023/03/19/Apache-Iceberg-and-changes-above-Hive/&title=Apache Iceberg and changes above Hive"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://blog.mwish.me/2023/03/19/Apache-Iceberg-and-changes-above-Hive/&name=Apache Iceberg and changes above Hive&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://blog.mwish.me/2023/03/19/Apache-Iceberg-and-changes-above-Hive/&t=Apache Iceberg and changes above Hive"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%89%80%E8%B0%93%E6%95%B0%E6%8D%AE%E6%B9%96"><span class="toc-number">1.</span> <span class="toc-text">所谓数据湖</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Hive-%E7%9A%84%E7%BC%BA%E9%99%B7"><span class="toc-number">2.</span> <span class="toc-text">Hive 的缺陷</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Iceberg"><span class="toc-number">3.</span> <span class="toc-text">Iceberg</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Iceberg-Metadata-Layer"><span class="toc-number">4.</span> <span class="toc-text">Iceberg Metadata Layer</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Table-Metadata-and-Snapshot"><span class="toc-number">4.1.</span> <span class="toc-text">Table Metadata and Snapshot</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Metadata-File-Manifest-List"><span class="toc-number">4.2.</span> <span class="toc-text">Metadata File (Manifest List)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Manifests"><span class="toc-number">4.3.</span> <span class="toc-text">Manifests</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#File-Format"><span class="toc-number">4.4.</span> <span class="toc-text">File Format</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Row-Level-Delete-Formats"><span class="toc-number">4.5.</span> <span class="toc-text">Row-Level Delete Formats</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Concurrency-Control-and-Sequence-Number"><span class="toc-number">4.6.</span> <span class="toc-text">Concurrency Control and Sequence Number</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Partition-Bucket-Sorting"><span class="toc-number">5.</span> <span class="toc-text">Partition &#x2F; Bucket &#x2F; Sorting</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Partition-Evolution-amp-Sort-Order-Evolution"><span class="toc-number">5.1.</span> <span class="toc-text">Partition Evolution &amp; Sort Order Evolution</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Wrapup-How-does-Iceberg-run-query"><span class="toc-number">6.</span> <span class="toc-text">Wrapup: How does Iceberg run query</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Iceberg-%E5%85%BC%E5%AE%B9"><span class="toc-number">7.</span> <span class="toc-text">Iceberg 兼容</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#References"><span class="toc-number">8.</span> <span class="toc-text">References</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        Apache Iceberg and changes above Hive
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">mwish</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2023-03-19T06:35:00.000Z" itemprop="datePublished">2023-03-19</time>
        
      
    </div>


      

      

    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <p>当我们说一个东西是屎山的时候，它最好真的不是…「大数据」这个词在很长一段时间事实标准就是 Apache Hadoop 下那堆东西，因为历史原因，很多东西实际上在 Hive / Spark 之类的东西上有一套实现和名词，这套名词本身可能比较草台班子：比如 Bucket / Partition 这些东西，在各个系统有不同的叫法，有的东西可能直接和别的系统对应…</p>
<p>你一定想问这些东西和 iceberg 有什么关系了，答案是息息相关。Iceberg 本身就是一帮人受不了 Hive 折磨搞出来的，在文档里三步一提 Hive，关系比亲爹还亲，然后 Iceberg 又只是一个 table format。这导致了几个后果：</p>
<ol>
<li>在介绍 Iceberg 的时候，会不断介绍 Hive 之前的设计为什么导致了 Iceberg 会这么做…这导致其实你得对 Hive 有个基本的认知。妈的，我为啥要对这种老草台系统有认知…</li>
<li>Iceberg 只是一个 Table format，它有的时候甚至会跑在 HMS 上。同时，Iceberg 很多时候只说明了「需要这么做」，实现行为还是要自己决定的，所以很多时候实现行为是各家一坨屎，e.g:<ol>
<li>Spark Partition: <a target="_blank" rel="noopener" href="https://iceberg.apache.org/docs/latest/spark-writes/">https://iceberg.apache.org/docs/latest/spark-writes/</a></li>
<li>Hive Partition: <a target="_blank" rel="noopener" href="https://iceberg.apache.org/docs/latest/hive/">https://iceberg.apache.org/docs/latest/hive/</a></li>
</ol>
</li>
</ol>
<p>我们这里会介绍一下 Hive 和 iceberg format，这个文档会持续更新，因为笔者可能认知也是会更新的。然后也会简单介绍一下 Snowflake、StarRocks 的行为是怎么兼容 iceberg 的。</p>
<h2 id="所谓数据湖"><a href="#所谓数据湖" class="headerlink" title="所谓数据湖"></a>所谓数据湖</h2><p>众所周知，Hive 本身的设计中，存储 Partition 以目录的形式，而存储 Bucket 以目录下文件的形式存放。这样 Partition 裁剪，Bucket Join 之类的操作本身是很正常的，但是在 Hive 查询的时候，对超大表会有一些很奇怪的问题。比如 Meta 信息拿到分区之后 List 过慢、对 Underlying NameNode 的依赖等。很自然的，这套东西还可以移动到 S3 之类的存储上，但是 S3 之类的存储也有问题。</p>
<p>Apache Iceberg 名义上定位其实很低，它定位为对 OSS 之类的存储比较友好的 Table Format，它表层面的 RFC 变动相当克制，带来了一些格式兼容性。继承了一些 Hive 比较好的地方，比如哪个傻大个都可以往里写，同时在 Partition / Bucket / Schema 等方向上做出了演进或者限制，带来了比较细致的演进方式。</p>
<p>Iceberg 经常和「数据湖」这个词一起被提起，而不是我们之前说的 Table Format。这个词更多是个宣传用词，按我之前的理解（ <a href="https://blog.mwish.me/2022/05/01/Delta-Lake-Lakehouse/">https://blog.mwish.me/2022/05/01/Delta-Lake-Lakehouse/</a> ），Data Lake 意味着：</p>
<ol>
<li>ACID 的能力，防止 Job 跑到一半挂了又没法处理</li>
<li>柔性的 Schema</li>
<li>Streaming 等接口</li>
<li>SQL 相关的 Pruning，Min-Max</li>
<li>对应的 Format Compaction / Auto-Clustering，包括 z-ordering</li>
</ol>
<p>过了一年多，回顾这个结论，确实是我当时结论问题没那么大，但是这些是核心语义吗？其实回头来想，Apache Iceberg 不是一个很 Fancy 的东西，但却是一个很可怕的东西，新的数据湖产品，像 Snowflake，StarRocks， Doris 这些产品，都开始兼容了 Apache Iceberg 协议。然后 DeltaLake 感觉在路子上是更加靠前的产品，但是在 Apache Iceberg 的「攻势」下也开始部分开源了（笑）。</p>
<p>所以回过头来，也结合网易那几篇文章的理解：</p>
<ul>
<li>从 Hive 这条路线的演进，看 Apache Iceberg 是一个 Table Format，它把表结构（表，Bucket，分区）抽离了物理的 Layout，从目录的部分依赖走到了自己拆分出一层逻辑的 Manifest 层。同时，也做了一些对原子 ACID 之类的支持（和部分反对者说的不完全一样，Hive 也支持 ACID，不过折腾的很别扭，而这在 Apache Iceberg 中师一等公民）</li>
<li>Delta 也类似，拆分出一套日志层（甚至依赖 DynamoDB）来做提交</li>
</ul>
<p>但是，从外部用户的视角来理解：</p>
<ul>
<li>引擎平权，Apache Iceberg 是一套标准，用户可以尽量不 Lock-In 在某个系统中（而引擎当然巴不得你 Lock-In），包括猫猫狗狗都可以来根据这个 Format 去读 / 写对应的结构，写入的数据也可以是具体实现无关（Parquet，Avro，…）相当于自身的结构是开放的。</li>
<li>写入数据和 Schema 很方便，包括很多情况下，导入数据 - 加列 之后，数据符合某种标准。同时，数据只要符合某种 Schema 即可（Apache Iceberg 允许 Avro，Parquet，Orc 等多种数据）</li>
<li>ACID，这里并不同于 TP 数据库的快速小事务，这里更多是要求 abortable / 隔离性 这样的需求。我在之前其实是列了 Streaming 需求的，但是其实这个就类似 AP 测向 TP 测靠拢，属于大家却是不清楚这个做了是不是真的有收益的环节了。</li>
<li>CDC？其实我并不知道是不是用户真的需要 CDC 之类的需求，但是某种意义上（去掉 Compaction）很多场景做 CDC 确实是非常自然的场景了。</li>
</ul>
<p>（Optimize 和 Compaction 感觉很必要，但是暂时不在列）</p>
<p>这个时候你就会发现，有的东西确实是 Hive 有的，但是它指向了一个更混沌开放的领域。和我之前理解不完全一样的是，这里确实要有一些 Schema 限制，但并不是整体 Enforce 某个 Schema，而是一些读时模式 + 列变换的限制。</p>
<p>今天就简单介绍一下 Apache Iceberg 的 Spec</p>
<h2 id="Hive-的缺陷"><a href="#Hive-的缺陷" class="headerlink" title="Hive 的缺陷"></a>Hive 的缺陷</h2><p>Hive 可能现在不怎么用了，但是 Hive 的表结构还是数据的事实标准。在这个世界还青春的时候，Spark 的 Core 本身作为一套计算的逻辑维护 RDD。之后感觉很多引擎推进的都是计算上的方式，而存储的方式很多还是在 Hive 上或者自己去搞 Share nothing。Hive 在很长一段时间至少在表结构上还是 de-facto 的主导者。Hive Table Format 如下：</p>
<p><img src="https://image.mwish.me/blog-image/iceberg-01.png" alt="iceberg-01"></p>
<p>然而，这里列出来一些缺点：</p>
<ul>
<li>Hive ACID 通过 fs rename 来实现。在 POSIX 上，rename 可以是原子的。然而 S3: ?</li>
<li>没有 WAL 之类的方式，无法原子性写多个 Partition</li>
<li>无法对多个写同一个 Partition 的 Txn 作出什么限制</li>
<li>需要依赖 <code>List</code>，可能会开销很长的时间 （分区多或者分区的文件多都会加重这个问题，而且 S3 的 List 本身就很昂贵，见 <a target="_blank" rel="noopener" href="https://www.youtube.com/watch?t=138&amp;v=nWwQMlrjhy0&amp;feature=youtu.be">https://www.youtube.com/watch?t=138&amp;v=nWwQMlrjhy0&amp;feature=youtu.be</a> ）</li>
<li>用户需要手动写分区，因为在 Hive 中，<strong>分区列并不是表数据的一部分</strong>，要手动写对应的分区信息</li>
<li>Hive 的 Table Statistics 常常并不准确（显然数据库都不那么准确？）</li>
<li>在 OSS 中，Hive 的路径 <code>/path/to/table/partition_column=partition_value</code> 限制了物理路径的打散能力，导致可能落在几个固定的节点上，造成一定的性能问题。（本质上还是对物理路径的依赖？）</li>
</ul>
<p><img src="https://image.mwish.me/blog-image/iceberg-02.png" alt="iceberg-02"></p>
<h2 id="Iceberg"><a href="#Iceberg" class="headerlink" title="Iceberg"></a>Iceberg</h2><p>Netflix 搞了一套新的 Table Format: Iceberg，主导者 Ryan Blue 随后也创建了公司。</p>
<p>Netflix 的思路是，发现 Table format 和 fs 目录的物理结构是完全绑定的，它们的简单设计是：</p>
<ul>
<li>抽离这个<strong>物理</strong> Directory 的层次，造了一个逻辑的 Directory</li>
<li>Track 文件和文件的变更</li>
<li>用这套 Track 机制做了一套文件层面的 MVCC</li>
<li>把 Partition 机制融合进数据中</li>
</ul>
<p><img src="https://image.mwish.me/blog-image/iceberg-03.png" alt="iceberg-03"></p>
<p>Iceberg 抽象了一套多层的架构：</p>
<p><img src="https://image.mwish.me/blog-image/iceberg-04.png" alt="iceberg-04"></p>
<p>显然，中间层是 iceberg 的核心，但我们最后介绍：</p>
<ol>
<li>Data layer: 用户写 data 就写 data，没有挂在 list 上 commit，就不是表的一部分</li>
<li>Iceberg Catalog: iceberg 整个结构的 root 指针，它可以是 HDFS / HMS 等，需要支持原子的变更</li>
</ol>
<p>那下面比较重要的就是中间的结构了。</p>
<h2 id="Iceberg-Metadata-Layer"><a href="#Iceberg-Metadata-Layer" class="headerlink" title="Iceberg Metadata Layer"></a>Iceberg Metadata Layer</h2><p>首先还是需要注意，在数据库领域，我们经常提到 record, wal, page 之类的概念，而在大数据领域，某种意义上，<strong>数据的一等公民是文件</strong>。</p>
<h3 id="Table-Metadata-and-Snapshot"><a href="#Table-Metadata-and-Snapshot" class="headerlink" title="Table Metadata and Snapshot"></a>Table Metadata and Snapshot</h3><p>Table Metadata / Metadata File: 是一个 JSON，表达表的信息，包含表的 schema，Partition specs，格式的版本. ( The table metadata file tracks the table schema, partitioning config, custom properties, and <strong>snapshot</strong>s of the table contents. A snapshot represents the state of a table at some time and is used to access the complete set of data files in the table. )</p>
<ul>
<li>Snapshot 可以视作一次写产生的 snapshot，snapshot 被内包含在 Metadata File 中。系统一定有一个当前的 Snapshot (对于刚创建的表，这个 snapshot 里面一个文件都没有）。Snapshot 也可以包含创建者的 Summary</li>
</ul>
<p>举个博客中的例子：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="comment">// 在 iceberg 中的版本是 v1</span></span><br><span class="line">    <span class="attr">&quot;format-version&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="comment">// 对应的 table 生成的 uuid</span></span><br><span class="line">    <span class="attr">&quot;table-uuid&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;4b96b6e8-9838-48df-a111-ec1ff6422816&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="comment">// Table 的位置. 你可能要问了, 这个鬼玩意和 Hive 那样目录有啥区别,</span></span><br><span class="line">    <span class="comment">// 答案是数据不在目录下</span></span><br><span class="line">    <span class="attr">&quot;location&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;/home/hadoop/warehouse/db2/part_table2&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="comment">// table 最后更新的 unix epoch</span></span><br><span class="line">    <span class="comment">// (其实这里还应该有一个最新的 sequence-id)</span></span><br><span class="line">    <span class="attr">&quot;last-updated-ms&quot;</span> <span class="punctuation">:</span> <span class="number">1611694436618</span><span class="punctuation">,</span></span><br><span class="line">    <span class="comment">// 已经分配的最高的 column-id</span></span><br><span class="line">    <span class="attr">&quot;last-column-id&quot;</span> <span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">    <span class="comment">// table 的 schema, 注意这里 id 的分配</span></span><br><span class="line">    <span class="comment">// 这个东西已经 deprecated 了, 新一点的是 schemas,</span></span><br><span class="line">    <span class="comment">// 就是包括历史有的 schema.</span></span><br><span class="line">    <span class="attr">&quot;schema&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;struct&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;fields&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;id&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;id&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;required&quot;</span> <span class="punctuation">:</span> <span class="keyword">true</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;int&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;id&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;ts&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;required&quot;</span> <span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;timestamptz&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;id&quot;</span> <span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;message&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;required&quot;</span> <span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;string&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span> <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="comment">// Partition 相关的信息.</span></span><br><span class="line">    <span class="comment">// 你可能注意到了 spec 和 specs</span></span><br><span class="line">    <span class="comment">// spec 也已经 deprecated 了, 令人唏嘘</span></span><br><span class="line">    <span class="attr">&quot;partition-spec&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;ts_hour&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;transform&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;hour&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;source-id&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;field-id&quot;</span> <span class="punctuation">:</span> <span class="number">1000</span></span><br><span class="line">    <span class="punctuation">&#125;</span> <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;default-spec-id&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;partition-specs&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;spec-id&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;fields&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;ts_hour&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;transform&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;hour&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;source-id&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;field-id&quot;</span> <span class="punctuation">:</span> <span class="number">1000</span></span><br><span class="line">        <span class="punctuation">&#125;</span> <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span> <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="comment">// 排序的 key</span></span><br><span class="line">    <span class="comment">// 其实 Sort 也比这个定义复杂, 还包括对应的</span></span><br><span class="line">    <span class="comment">// SortOrder, null first 之类的.</span></span><br><span class="line">    <span class="attr">&quot;default-sort-order-id&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;sort-orders&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;order-id&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;fields&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span> <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span> <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="comment">// table 的属性, 可以用来控制 table 的读写</span></span><br><span class="line">    <span class="attr">&quot;properties&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;owner&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;hadoop&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="comment">// 指向 latest 的 snapshot id.</span></span><br><span class="line">    <span class="attr">&quot;current-snapshot-id&quot;</span> <span class="punctuation">:</span> <span class="number">1257424822184505371</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;snapshots&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="comment">// snapshot</span></span><br><span class="line">        <span class="attr">&quot;snapshot-id&quot;</span> <span class="punctuation">:</span> <span class="number">8271497753230544300</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;timestamp-ms&quot;</span> <span class="punctuation">:</span> <span class="number">1611694406483</span><span class="punctuation">,</span></span><br><span class="line">        <span class="comment">// 关于写入的一些信息</span></span><br><span class="line">        <span class="attr">&quot;summary&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;operation&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;append&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;spark.app.id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;application_1611687743277_0002&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;added-data-files&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;added-records&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;added-files-size&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;960&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;changed-partition-count&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;total-records&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;total-data-files&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;total-delete-files&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;0&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;total-position-deletes&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;0&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;total-equality-deletes&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;0&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="comment">// 一个 snapshot 会有一个对应的 manifest list</span></span><br><span class="line">        <span class="attr">&quot;manifest-list&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;/home/hadoop/warehouse/db2/part_table2/metadata/snap-8271497753230544300-1-d8a778f9-ad19-4e9c-88ff-28f49ec939fa.avro&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span> </span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;snapshot-id&quot;</span> <span class="punctuation">:</span> <span class="number">1257424822184505371</span><span class="punctuation">,</span></span><br><span class="line">        <span class="comment">// 有的 snapshot 会有对应的 parent snapshot.</span></span><br><span class="line">        <span class="attr">&quot;parent-snapshot-id&quot;</span> <span class="punctuation">:</span> <span class="number">8271497753230544300</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;timestamp-ms&quot;</span> <span class="punctuation">:</span> <span class="number">1611694436618</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;summary&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;operation&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;append&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;spark.app.id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;application_1611687743277_0002&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;added-data-files&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;added-records&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;added-files-size&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;973&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;changed-partition-count&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;total-records&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;2&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;total-data-files&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;2&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;total-delete-files&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;0&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;total-position-deletes&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;0&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;total-equality-deletes&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;0&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;manifest-list&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;/home/hadoop/warehouse/db2/part_table2/metadata/snap-1257424822184505371-1-eab8490b-8d16-4eb1-ba9e-0dede788ff08.avro&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span> <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="comment">// snapshot 时间对应上物理时间</span></span><br><span class="line">    <span class="attr">&quot;snapshot-log&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;timestamp-ms&quot;</span> <span class="punctuation">:</span> <span class="number">1611694406483</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;snapshot-id&quot;</span> <span class="punctuation">:</span> <span class="number">8271497753230544300</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span> </span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;timestamp-ms&quot;</span> <span class="punctuation">:</span> <span class="number">1611694436618</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;snapshot-id&quot;</span> <span class="punctuation">:</span> <span class="number">1257424822184505371</span></span><br><span class="line">    <span class="punctuation">&#125;</span> <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="comment">// 可选的 metadata 列表</span></span><br><span class="line">    <span class="attr">&quot;metadata-log&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;timestamp-ms&quot;</span> <span class="punctuation">:</span> <span class="number">1611694097253</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;metadata-file&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;/home/hadoop/warehouse/db2/part_table2/metadata/v1.metadata.json&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span> </span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;timestamp-ms&quot;</span> <span class="punctuation">:</span> <span class="number">1611694406483</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;metadata-file&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;/home/hadoop/warehouse/db2/part_table2/metadata/v2.metadata.json&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span> <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>(说是版本 1，其实版本2 包含了一些 delete 之类的信息）</p>
<p>(其实我很好奇这个时间，如果遇到了分布式时钟回退怎么办)</p>
<p>这里表级别包含了文件的 Partition，Schema，Snapshots，和 snapshot 的 History。这里还有一些物理时间变更的信息。没有写清楚的是，这里还可以存储 table statistics 和 snapshot refs。table statistics 定义见：<a target="_blank" rel="noopener" href="https://iceberg.apache.org/spec/#table-statistics">https://iceberg.apache.org/spec/#table-statistics</a></p>
<p>这部分内容可以被存储在 Metastore 或者 HDFS 之类的东西上，靠 Atomic Swap 来解决。</p>
<p>这个 Summary 也比较有意思，能代表 snapshot 的来源，举个好玩的例子，Compaction 可以用 <code>replace</code> 来表示。</p>
<h3 id="Metadata-File-Manifest-List"><a href="#Metadata-File-Manifest-List" class="headerlink" title="Metadata File (Manifest List)"></a>Metadata File (Manifest List)</h3><p>Manifest List 对应一个 Snapshot，以一个 Avro 文件的形式存在。Snapshot 本身 inline 在了 Metadata 里面，但是 Manifest List 却被抽出来了。这种抽象也算是避免进一步膨胀。同时，Manifest List 是一个完成的 snapshot，它包含了一些 Manifest。而这些 Manifest 比较值得玩味：</p>
<ol>
<li>Manifest 本身按照 Table 或者 Partition 有一些切分，查询可以跳过一定的 Manifest</li>
<li>如果 Manifest 本身和 Partition 一一绑定的话，写入需要重写整个 Partition 甚至 Table 的 Manifest，但是实际上，这里 Manifest 也可以被当成 Log，快速写插入一个文件，然后加入 Manifest List，这项技术被称为 fast append</li>
<li>大表也可以拆分 Manifest，来某种意义上加速 Planning</li>
</ol>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="comment">// 需要注意的是, 在 v2 上, 这里还有个 sequence number</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// manifest 对应的路径.</span></span><br><span class="line">    <span class="attr">&quot;manifest_path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/home/hadoop/warehouse/db2/part_table2/metadata/eab8490b-8d16-4eb1-ba9e-0dede788ff08-m0.avro&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;manifest_length&quot;</span><span class="punctuation">:</span> <span class="number">4884</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;partition_spec_id&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;added_snapshot_id&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;long&quot;</span><span class="punctuation">:</span> <span class="number">1257424822184505300</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="comment">// 这些字段算是 table summaries, 表达对应的增 / 删</span></span><br><span class="line">    <span class="attr">&quot;added_data_files_count&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;int&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;existing_data_files_count&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;int&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;deleted_data_files_count&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;int&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="comment">// 包含的 Partition 相关的信息</span></span><br><span class="line">    <span class="comment">// 这里还可以记录 Partition 相关的和 field-summary,</span></span><br><span class="line">    <span class="comment">// 做进一步的分区裁剪.</span></span><br><span class="line">    <span class="attr">&quot;partitions&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;array&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;contains_null&quot;</span><span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;lower_bound&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;bytes&quot;</span><span class="punctuation">:</span> <span class="string">&quot;¹Ô\\u0006\\u0000&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;upper_bound&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;bytes&quot;</span><span class="punctuation">:</span> <span class="string">&quot;¹Ô\\u0006\\u0000&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span> <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;added_rows_count&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;long&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;existing_rows_count&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;long&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;deleted_rows_count&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;long&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;manifest_path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/home/hadoop/warehouse/db2/part_table2/metadata/d8a778f9-ad19-4e9c-88ff-28f49ec939fa-m0.avro&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;manifest_length&quot;</span><span class="punctuation">:</span> <span class="number">4884</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;partition_spec_id&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;added_snapshot_id&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;long&quot;</span><span class="punctuation">:</span> <span class="number">8271497753230544000</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;added_data_files_count&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;int&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;existing_data_files_count&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;int&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;deleted_data_files_count&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;int&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;partitions&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;array&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;contains_null&quot;</span><span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;lower_bound&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;bytes&quot;</span><span class="punctuation">:</span> <span class="string">&quot;¸Ô\\u0006\\u0000&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;upper_bound&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;bytes&quot;</span><span class="punctuation">:</span> <span class="string">&quot;¸Ô\\u0006\\u0000&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span> <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;added_rows_count&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;long&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;existing_rows_count&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;long&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;deleted_rows_count&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;long&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<h3 id="Manifests"><a href="#Manifests" class="headerlink" title="Manifests"></a>Manifests</h3><p>在 v2 中，format 还允许标注 Manifest 为 Delete Manifest. 这个 Manifest 就是单纯一个 「文件列表」了，我们真的走了好一会儿才看到这里呢…</p>
<p>Manifest 本身有点像 G+ 写的那篇 when metadata is bigdata. 整个文件会被记录 Schema 和统计信息，来进行分析，我们接着看一个 v1 的文件：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="comment">// (existing / add / deleted )</span></span><br><span class="line">    <span class="attr">&quot;status&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="comment">// 插入的 snapshot id</span></span><br><span class="line">    <span class="attr">&quot;snapshot_id&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;long&quot;</span><span class="punctuation">:</span> <span class="number">1257424822184505300</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="comment">// (这里还隐含了 seq-number 和 file-seqnumber, 因为这个文件</span></span><br><span class="line">    <span class="comment">// 本身是一个 v1 文件, 所以不包含, 当读取的时候, 这里有一套继承机制)</span></span><br><span class="line">    <span class="attr">&quot;data_file&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;file_path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/home/hadoop/warehouse/db2/part_table2/data/ts_hour=2021-01-26-01/00000-6-7c6cf3c0-8090-4f15-a4cc-3a3a562eed7b-00001.parquet&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;file_format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;PARQUET&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;partition&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;ts_hour&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;int&quot;</span><span class="punctuation">:</span> <span class="number">447673</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;record_count&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;file_size_in_bytes&quot;</span><span class="punctuation">:</span> <span class="number">973</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;block_size_in_bytes&quot;</span><span class="punctuation">:</span> <span class="number">67108864</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;column_sizes&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;array&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;key&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="number">47</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;key&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="number">57</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;key&quot;</span><span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="number">60</span></span><br><span class="line">            <span class="punctuation">&#125;</span> <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;value_counts&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;array&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;key&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;key&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;key&quot;</span><span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">            <span class="punctuation">&#125;</span> <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;null_value_counts&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;array&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;key&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;key&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;key&quot;</span><span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">            <span class="punctuation">&#125;</span> <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;lower_bounds&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;array&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;key&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;\\u0002\\u0000\\u0000\\u0000&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;key&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;\\u0000„ ,Ã¹\\u0005\\u0000&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;key&quot;</span><span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;test message 2&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span> <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;upper_bounds&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;array&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;key&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;\\u0002\\u0000\\u0000\\u0000&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;key&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;\\u0000„ ,Ã¹\\u0005\\u0000&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;key&quot;</span><span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;test message 2&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span> <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;key_metadata&quot;</span><span class="punctuation">:</span> <span class="keyword">null</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;split_offsets&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;array&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="number">4</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>这里就可以咔咔杀文件了. 回顾一下，这里每一个层次都有统计，Manifest <del>即是神又是魔（这是我中二犯了）</del> 既能删除又能添加，同时提供了 Prune 文件的能力。</p>
<h3 id="File-Format"><a href="#File-Format" class="headerlink" title="File Format"></a>File Format</h3><p>其实 File Format 层面，Iceberg 类似 Arrow Parquet 那套。什么意思呢？它不能适应任何格式，但是会需要你这个格式预留一些符合它 spec 的东西，比如：</p>
<ol>
<li>FieldId：<a target="_blank" rel="noopener" href="https://github.com/apache/iceberg/blob/master/format/spec.md#column-projection">https://github.com/apache/iceberg/blob/master/format/spec.md#column-projection</a></li>
<li>Default Value (and spec)：<a target="_blank" rel="noopener" href="https://github.com/apache/iceberg/blob/master/format/spec.md#default-values">iceberg/spec.md at master · apache/iceberg</a><ol>
<li>这里提供了 <code>initial-default</code>（添加字段的时候的默认值）和 <code>write-default</code>（写入的默认值）</li>
</ol>
</li>
<li>类型：<a target="_blank" rel="noopener" href="https://github.com/apache/iceberg/blob/master/format/spec.md#schemas-and-data-types">https://github.com/apache/iceberg/blob/master/format/spec.md#schemas-and-data-types</a> 这里限制的还是相对比较死的</li>
</ol>
<h3 id="Row-Level-Delete-Formats"><a href="#Row-Level-Delete-Formats" class="headerlink" title="Row-Level Delete Formats"></a>Row-Level Delete Formats</h3><p>Iceberg format v2.0 提供了 Delete format. 这里有 Positional-Delete File 和 Equality Delete-File</p>
<ol>
<li>Positional Delete File: 对文件提供删除，以行的形式标记删除</li>
<li>Equality Delete-File: 对文件提供删除，以某个 Column 的 Value 形式<strong>全部</strong>删除</li>
</ol>
<p>这里文件也要提供对应的 Stats，比如删除文件也要提供自己删除的 Stats。</p>
<p>Iceberg 的 Stats 比较有意思，语义是：「<strong>你可以不提供，但是只要你提供了，就必须是全都准确的</strong>」。</p>
<p>这里还要注意，一个 Delete File 可以对应多个 Base 文件，Equality Delete-File 甚至可以对应多个分区。</p>
<h3 id="Concurrency-Control-and-Sequence-Number"><a href="#Concurrency-Control-and-Sequence-Number" class="headerlink" title="Concurrency Control and Sequence Number"></a>Concurrency Control and Sequence Number</h3><p>Apache Iceberg 没有 row-level transaction 和 row-level mvcc，取而代之，它模型关键是 Snapshot / 文件级别的 MVCC：</p>
<ol>
<li>每个 snapshot 有一个 sequence number</li>
<li>尝试提交的时候，Apache Iceberg 以 OCC 的协议提交，在前面申请一个 Sequence number，然后在 validation 阶段做 checking</li>
<li>创建的新 Delete / Insert 继承新的 Snapshot 的 Sequence Number，而之前创建的（Existing）享有之前的 Sequence number<ol>
<li>因为这套机制，Compaction 前后文件其实是不太一致的，令人唏嘘。</li>
</ol>
</li>
</ol>
<h2 id="Partition-Bucket-Sorting"><a href="#Partition-Bucket-Sorting" class="headerlink" title="Partition / Bucket / Sorting"></a>Partition / Bucket / Sorting</h2><h3 id="Partition-Evolution-amp-Sort-Order-Evolution"><a href="#Partition-Evolution-amp-Sort-Order-Evolution" class="headerlink" title="Partition Evolution &amp; Sort Order Evolution"></a>Partition Evolution &amp; Sort Order Evolution</h3><p>Iceberg 通过 PartitionSpecs 和 Sort Order 的 Specs 的方式来提供相关的内容。Hive Partition 不是数据表的一列，但是 Iceberg Partition 可以选择 <code>expr-transform(表的一列)</code>，比如它 spec 要求是</p>
<blockquote>
<ul>
<li>A source column id from the table’s schema</li>
<li>A partition field id that is used to identify a partition field and is unique within a partition spec. In v2 table metadata, it is unique across all partition specs.</li>
<li>A transform that is applied to the source column to produce a partition value</li>
<li>A partition name</li>
</ul>
</blockquote>
<p>这里举个之前的例子：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;default-spec-id&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;partition-specs&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;spec-id&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;fields&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;ts_hour&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;transform&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;hour&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;source-id&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;field-id&quot;</span> <span class="punctuation">:</span> <span class="number">1000</span></span><br><span class="line">    <span class="punctuation">&#125;</span> <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span> <span class="punctuation">]</span><span class="punctuation">,</span></span><br></pre></td></tr></table></figure>
<p>这个地方就很直观介绍了 Partition 的模样。在 Manifest 上也有 partition-spec:</p>
<p><img src="https://image.mwish.me/blog-image/iceberg-05.png" alt="iceberg-05"></p>
<p>类似 Partition，Bucket 也做成 Partition 的内容，可以套: </p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">[</span> <span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;source-id&quot;</span><span class="punctuation">:</span> <span class="number">4</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;field-id&quot;</span><span class="punctuation">:</span> <span class="number">1000</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ts_day&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;transform&quot;</span><span class="punctuation">:</span> <span class="string">&quot;day&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">,</span> <span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;source-id&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;field-id&quot;</span><span class="punctuation">:</span> <span class="number">1001</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;id_bucket&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;transform&quot;</span><span class="punctuation">:</span> <span class="string">&quot;bucket[16]&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span> <span class="punctuation">]</span></span><br></pre></td></tr></table></figure>
<p>其实 Sort Order 也差不多就是这套 Rule，下面来介绍</p>
<p><img src="https://image.mwish.me/blog-image/iceberg-06.png" alt="iceberg-06"></p>
<h2 id="Wrapup-How-does-Iceberg-run-query"><a href="#Wrapup-How-does-Iceberg-run-query" class="headerlink" title="Wrapup: How does Iceberg run query"></a>Wrapup: How does Iceberg run query</h2><p>比较细节的部分在 Spec 的 Scan Planning 部分：<a target="_blank" rel="noopener" href="https://iceberg.apache.org/spec/#scan-planning">https://iceberg.apache.org/spec/#scan-planning</a></p>
<ol>
<li>找到 Iceberg Catalog，拿到 Metadata file</li>
<li>DELETED 的文件不会参与 Planning，专注处理 EXISTING  和 ADDED</li>
<li>裁剪分区</li>
</ol>
<p>下面有一些 DELETED File Apply 的规则：</p>
<ol>
<li>对于 Position，这里会根据 ts-rule 来 apply，<strong>如果是分区表，必须在同一个分区做删除</strong></li>
<li>对于 Equality，这里会根据 ts-rule 来删除，<strong>它可以是 unpartition 的，作用于全局</strong></li>
</ol>
<p><img src="https://image.mwish.me/blog-image/iceberg-07.png" alt="iceberg-07"></p>
<p>这样就可以 Plan 出对应的表，然后进行查询了。</p>
<h2 id="Iceberg-兼容"><a href="#Iceberg-兼容" class="headerlink" title="Iceberg 兼容"></a>Iceberg 兼容</h2><p>Snowflake, StarRocks 这些系统都兼容了 Iceberg，我们以 Snowflake 为例，讲讲这块是怎么兼容的：</p>
<p><a target="_blank" rel="noopener" href="https://www.snowflake.com/blog/expanding-the-data-cloud-with-apache-iceberg/">https://www.snowflake.com/blog/expanding-the-data-cloud-with-apache-iceberg/</a></p>
<ol>
<li>从内部格式为生成 Parquet，可能会双写</li>
<li>Manifest 层面去双写</li>
</ol>
<p><img src="https://image.mwish.me/blog-image/iceberg-08.png" alt="iceberg-08"></p>
<h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><ul>
<li>[强烈推荐] <a target="_blank" rel="noopener" href="https://www.dremio.com/resources/guide/apache-iceberg-an-architectural-look-under-the-covers/">https://www.dremio.com/resources/guide/apache-iceberg-an-architectural-look-under-the-covers/</a></li>
<li><a target="_blank" rel="noopener" href="https://tabular.io/blog/iceberg-fileio/">https://tabular.io/blog/iceberg-fileio/</a></li>
<li>Iceberg V2 Spec: <a target="_blank" rel="noopener" href="https://docs.google.com/document/d/1ZqVaSI_vBXekqXxNEg8NYvuiKgV2fKpMARhU54FhQaM/edit#">https://docs.google.com/document/d/1ZqVaSI_vBXekqXxNEg8NYvuiKgV2fKpMARhU54FhQaM/edit#</a></li>
<li>Snowflake and iceberg</li>
<li>Apache Iceberg 的设计哲学 - lfyzjck的文章 - 知乎 <a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/601654830">https://zhuanlan.zhihu.com/p/601654830</a></li>
<li>从 Delta 2.0 开始聊聊我们需要怎样的数据湖 - 网易数帆的文章 - 知乎 <a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/552390193">https://zhuanlan.zhihu.com/p/552390193</a></li>
<li>深度对比delta、iceberg和hudi三大开源数据湖方案 - openinx的文章 - 知乎 <a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/110748218">https://zhuanlan.zhihu.com/p/110748218</a></li>
<li>数据湖（Data Lake） 总结 - 我吃印度飞饼的文章 - 知乎 <a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/91165577">https://zhuanlan.zhihu.com/p/91165577</a></li>
</ul>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">首页</a></li>
         
          <li><a href="/about/">关于</a></li>
         
          <li><a href="/archives/">归档</a></li>
         
          <li><a href="/search/">搜索</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%89%80%E8%B0%93%E6%95%B0%E6%8D%AE%E6%B9%96"><span class="toc-number">1.</span> <span class="toc-text">所谓数据湖</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Hive-%E7%9A%84%E7%BC%BA%E9%99%B7"><span class="toc-number">2.</span> <span class="toc-text">Hive 的缺陷</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Iceberg"><span class="toc-number">3.</span> <span class="toc-text">Iceberg</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Iceberg-Metadata-Layer"><span class="toc-number">4.</span> <span class="toc-text">Iceberg Metadata Layer</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Table-Metadata-and-Snapshot"><span class="toc-number">4.1.</span> <span class="toc-text">Table Metadata and Snapshot</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Metadata-File-Manifest-List"><span class="toc-number">4.2.</span> <span class="toc-text">Metadata File (Manifest List)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Manifests"><span class="toc-number">4.3.</span> <span class="toc-text">Manifests</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#File-Format"><span class="toc-number">4.4.</span> <span class="toc-text">File Format</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Row-Level-Delete-Formats"><span class="toc-number">4.5.</span> <span class="toc-text">Row-Level Delete Formats</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Concurrency-Control-and-Sequence-Number"><span class="toc-number">4.6.</span> <span class="toc-text">Concurrency Control and Sequence Number</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Partition-Bucket-Sorting"><span class="toc-number">5.</span> <span class="toc-text">Partition &#x2F; Bucket &#x2F; Sorting</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Partition-Evolution-amp-Sort-Order-Evolution"><span class="toc-number">5.1.</span> <span class="toc-text">Partition Evolution &amp; Sort Order Evolution</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Wrapup-How-does-Iceberg-run-query"><span class="toc-number">6.</span> <span class="toc-text">Wrapup: How does Iceberg run query</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Iceberg-%E5%85%BC%E5%AE%B9"><span class="toc-number">7.</span> <span class="toc-text">Iceberg 兼容</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#References"><span class="toc-number">8.</span> <span class="toc-text">References</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://blog.mwish.me/2023/03/19/Apache-Iceberg-and-changes-above-Hive/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://blog.mwish.me/2023/03/19/Apache-Iceberg-and-changes-above-Hive/&text=Apache Iceberg and changes above Hive"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://blog.mwish.me/2023/03/19/Apache-Iceberg-and-changes-above-Hive/&title=Apache Iceberg and changes above Hive"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://blog.mwish.me/2023/03/19/Apache-Iceberg-and-changes-above-Hive/&is_video=false&description=Apache Iceberg and changes above Hive"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Apache Iceberg and changes above Hive&body=Check out this article: http://blog.mwish.me/2023/03/19/Apache-Iceberg-and-changes-above-Hive/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://blog.mwish.me/2023/03/19/Apache-Iceberg-and-changes-above-Hive/&title=Apache Iceberg and changes above Hive"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://blog.mwish.me/2023/03/19/Apache-Iceberg-and-changes-above-Hive/&title=Apache Iceberg and changes above Hive"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://blog.mwish.me/2023/03/19/Apache-Iceberg-and-changes-above-Hive/&title=Apache Iceberg and changes above Hive"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://blog.mwish.me/2023/03/19/Apache-Iceberg-and-changes-above-Hive/&title=Apache Iceberg and changes above Hive"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://blog.mwish.me/2023/03/19/Apache-Iceberg-and-changes-above-Hive/&name=Apache Iceberg and changes above Hive&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://blog.mwish.me/2023/03/19/Apache-Iceberg-and-changes-above-Hive/&t=Apache Iceberg and changes above Hive"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> 菜单</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> 目录</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> 分享</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> 返回顶部</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2022-2025
    mwish
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">首页</a></li><!--
     --><!--
       --><li><a href="/about/">关于</a></li><!--
     --><!--
       --><li><a href="/archives/">归档</a></li><!--
     --><!--
       --><li><a href="/search/">搜索</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->
 
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script> 




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script> 
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"复制到粘贴板！\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "复制成功！");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

    <script async src="https://www.googletagmanager.com/gtag/js?id=G-FL51GBW6JT"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-FL51GBW6JT');
    </script>

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Umami Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });
</script>
<script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</body>
</html>
