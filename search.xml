<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>PolarDB IMCI: Row/Column in RO node</title>
      <link href="/2024/01/20/PolarDB-IMCI-Row-Column-in-RO-node/"/>
      <url>/2024/01/20/PolarDB-IMCI-Row-Column-in-RO-node/</url>
      
        <content type="html"><![CDATA[<p>PolarDB-IMCI: A Cloud-Native HTAP Database System at Alibaba å‘è¡¨åœ¨ SIGMODâ€™23 ä¸Šçš„æ–‡ç« ï¼Œç®€å•ä»‹ç»äº† IMCI çš„åˆ—å­˜å®ç°ã€‚PolarDB æ˜¯ä¸€ä¸ªåŸºäºå…±äº«å­˜å‚¨ PolarFS + RDMA çš„äº‘å­˜å‚¨æ•°æ®åº“ã€‚Redo/Page å…±äº«åœ¨ PolarFS è¿™ä¸€å…±äº«å±‚ä¸Šã€‚PolarDB ä¹‹å‰èƒ½å¤Ÿåœ¨è¿™ä¸ªæ¶æ„ä¸Šå®ç° Serve ç±»ä¼¼æ•°æ®çš„ RO èŠ‚ç‚¹ï¼ˆå®é™…ä¸Šæˆ‘æ„Ÿè§‰ RO èŠ‚ç‚¹åœ¨å·¥ç¨‹ä¸Šè¿˜æ˜¯æœ‰ä¸å°‘éš¾åº¦çš„ï¼‰ã€‚åœ¨ IMCI ä¸Šï¼Œè¿™å¥— RO æ‰©å±•ä¸ºè¡Œ/åˆ—çš†æœ‰çš„å­˜å‚¨ï¼Œé  InnoDB Redo Log æ¥åŒæ­¥ã€‚åœ¨ RO ä»èŠ‚ç‚¹ä¸Šï¼Œé€šè¿‡è¡Œå­˜çš„ Page å’Œä¸€å¥—é¢å¤–çš„å®šä½ç´¢å¼•å®Œæˆ Physical Page - Logical in Page çš„æ—¥å¿—åˆ°åˆ—å­˜åœ°å€çš„å®šä½ï¼Œå¹¶ç”¨ä¸€å¥—ç®€å•çš„åˆ—å­˜ Serve MVCC è¯»æŸ¥è¯¢ã€‚è¿™å¥—æ¶æ„ä¼šå¢åŠ ä¸€å®šçš„å­˜å‚¨æˆæœ¬ï¼Œå¹¶ä¸”å¯¹æœºå™¨çš„å†…å­˜å’Œ io å¯èƒ½æœ‰ä¸€å®šçš„è¦æ±‚ï¼Œå› ä¸ºç›¸å¯¹äºåŸæ¥çš„èŠ‚ç‚¹ï¼Œæ„Ÿè§‰éœ€è¦å¤š Serve ä¸€éƒ¨åˆ†æ•°æ®ï¼Œå¯èƒ½éœ€è¦ä¸€äº›ç›¸å¯¹é«˜è§„æ ¼çš„æœºå‹ã€‚ä½†æ˜¯æœ¬èº«è¿™ç§æ¶æ„å¯èƒ½æœåŠ¡çš„å¯¹è±¡ä¹Ÿæ¯”è¾ƒå…·ä½“ï¼Œå› ä¸º PolarDB è™½ç„¶æ˜¯å…±äº«å­˜å‚¨ï¼Œä½†æ˜¯è¿˜æ˜¯é‚£ç§ TP æ•°æ®åº“ï¼Œæ‰€ä»¥æ•°æ®è§„æ¨¡åº”è¯¥ç›¸å¯¹å¯æ§ï¼Œé¢å¯¹çš„ç”¨æˆ·éœ€æ±‚å¯èƒ½ä¹Ÿç›¸å¯¹å…·ä½“ä¸€äº›ã€‚è¿™æ ·æœ¬èº«å¯èƒ½ workload ä¹Ÿå’Œæ•°æ®åˆ†æå„ç§è·‘æ‰¹ç„¶å INSERT OVERWRITE åˆ°ä¸€ä¸ªæ–°çš„è¡¨ï¼Œå„ç§ç®— T+1 çš„éœ€æ±‚ä¹‹ç±»çš„ä¸ä¸€æ ·ï¼Œåªæ˜¯ OLAP æŸ¥è¯¢ã€‚åœ¨è¿™ç§åœºæ™¯ä¸‹ï¼Œè¿™å¥—æ¶æ„å¯èƒ½æ˜¯å¾ˆè½»è€Œä¸”å¾ˆé è°±çš„ã€‚</p><p><img src="https://image.mwish.me/blog-image/E0F08A18-1F38-481E-AC44-6262DB555837.png" alt="E0F08A18-1F38-481E-AC44-6262DB555837"></p><p>è®ºæ–‡è®¾è®¡çš„æ—¶å€™æå‡ºäº†äº”ä¸ªç›®æ ‡ï¼š</p><ol><li>Transparent Query Execution: é å¯¹ä¸Šå±‚æä¾›åŒæ · SQL æ¥å£ï¼Œåªè¦ç”¨æˆ·è®¾è®¡ Indexï¼Œç„¶åå†…éƒ¨å¼€å‡ºèŠ‚ç‚¹ï¼ˆå…¶å®æˆ‘ä¹Ÿæœ‰ç‚¹æ„Ÿå…´è¶£ä»–ä»¬è¿™æ–¹é¢æ€ä¹ˆåšæ”¶è´¹æ¨¡å‹çš„ï¼‰</li><li>Advanced OLAP Performance: (typically through the introduction of columnar data storage).</li><li>Minimal Perturbation on OLTP Workloads: OLTP queries are usually more mission-critical and are more sensitive to performance degradation.<ol><li>è¿™é‡Œé  RO èŠ‚ç‚¹æ¥å®ç°ï¼Œé€šè¿‡ Redo log æ¥åšåŒæ­¥ï¼Œå¹¶ä¸”ä¸è€ƒèµ° binlog æ¥é¿å…å¼•å…¥å†™ä¾§çš„é¢å¤–å¼€é”€ [1]</li></ol></li><li>High Data Freshness: using the visibility delay as a freshness score for a query. By definition, the visibility delay is the time interval during which updates to the database can be visible to OLAP queries. (è¿™é‡Œåœ¨è®ºæ–‡ç¬¬å…­èŠ‚æåˆ°æœ‰ä¸€äº› Proxy çš„è®¾è®¡èƒ½ä¿è¯æ›´å¼ºçš„è¯­ä¹‰)<ol><li>è¿™é‡Œèµ°äº† commit ahead log shipping å’Œ conflict-free log replay (2P-COFFER)ï¼ˆå°±æ˜¯ç›´æ¥ redo è€Œä¸æ˜¯ binlog åŒæ­¥ğŸ˜…çœŸèƒ½å–åï¼‰</li><li>ä½¿ç”¨ Append-Only Storage åšä¸€ä¸ª LSM-T åˆ—å­˜ç´¢å¼•åŠ é€ŸæŸ¥è¯¢ï¼Œæ ¹æ® insert-order æ¥ç»„ç»‡åˆ—å­˜ï¼ˆä½†æ˜¯è¿™æ ·æ˜¾ç„¶å°±è¦åå°è°ƒåº¦ compaction äº†ï¼Œæ— è®ºæ˜¯åˆ—å­˜çš„è¿˜æ˜¯ç´¢å¼•çš„ï¼Œä¸è¿‡è®ºæ–‡ä¹Ÿæ²¡è®²ï¼Ÿå¯èƒ½æ˜¯å°½é‡åœ¨å‰å°åšä¸€äº›æ“ä½œï¼‰</li></ol></li><li>Excellent Resource Elasticity: should ensure high resource elasticity (e.g., scale-out in minutes or even seconds) to adaptively serve the changing data volume and analytical workloads with stable performance and high resource utilization.<ol><li>å…è®¸ç”¨ ddl ç±»ä¼¼çš„æ–¹å¼å¿«é€Ÿåœ¨åˆ«çš„æœºå™¨ä¸Šæ‹‰èµ·æ„å»ºç´¢å¼•</li></ol></li></ol><p>IMCI æ¶æ„å¦‚ä¸‹ï¼š</p><p><img src="https://image.mwish.me/blog-image/E1F22974-F501-4A94-A79E-3D3720F2CBCC.png" alt="E1F22974-F501-4A94-A79E-3D3720F2CBCC"></p><p>ä½¿ç”¨çš„æ—¶å€™éœ€è¦å»ºè¡¨ï¼š</p><p><img src="https://image.mwish.me/blog-image/62418A3E-3019-4D4D-874B-099C3EF3E1BE.png" alt="62418A3E-3019-4D4D-874B-099C3EF3E1BE"></p><p>ç„¶å Planner ä¼šç”Ÿæˆä¸€ä¸ªæ··åˆè¡Œåˆ—çš„ Planã€‚å› ä¸ºåœ¨è¿™ä¸ªèŠ‚ç‚¹ä¸Šæ˜¯è¡Œåˆ—éƒ½æœ‰çš„ã€‚ä¸è¿‡æ„Ÿè§‰è¿™é‡Œçš„éš”ç¦»çº§åˆ«å’ŒåŒæ­¥æ—¶é—´ä¹‹ç±»çš„æ²¡æœ‰ç‰¹åˆ«å¥½çš„å®šä¹‰ï¼Œè®ºæ–‡æåˆ°äº†ä¸€ä¸ªåŒæ­¥å»¶è¿Ÿï¼Œä½†æ˜¯æ²¡æœ‰æåˆ°å…·ä½“çš„å®æ—¶å’Œä¸€äº›è¯­ä¹‰ï¼Œæ„Ÿè§‰è¿™ä¸ªå¾—çœ‹çœ‹äº§å“æ–‡æ¡£äº†ï¼Œæˆ‘ä¸ªäººæ„Ÿè§‰ä¸Šåº”è¯¥æ˜¯åªæœ‰ RR çš„ã€‚æˆ‘ä»¬åœ¨ä¹‹åä¹Ÿä¼šä»‹ç»è¿™ä¸ªè¡Œåˆ—æ··åˆçš„æ‰§è¡Œæ¨¡å¼ã€‚</p><p>å…·ä½“æ‹‰èµ·ä¸€ä¸ªèŠ‚ç‚¹çš„æ—¶å€™ç±»ä¼¼åœ¨ RO ä¸Š DDL ï¼Œç„¶åè¿™é‡Œä¼š Online æ„å»ºä¸€ä¸ªç´¢å¼•ã€‚</p><h2 id="COLUMN-INDEX-STORAGE"><a href="#COLUMN-INDEX-STORAGE" class="headerlink" title="COLUMN INDEX STORAGE"></a>COLUMN INDEX STORAGE</h2><p><img src="https://image.mwish.me/blog-image/07AEECAC-C9D7-40AE-9268-FAD83114FBE1.png" alt="07AEECAC-C9D7-40AE-9268-FAD83114FBE1"></p><p>è¿™å—å…·ä½“å¦‚ä¸Šå›¾ã€‚è§‚å¯Ÿåˆ°å‡ ä¸ªæˆåˆ†ï¼š</p><ol><li>å¤–éƒ¨æ•°æ®æ¥è‡ª Redo Logï¼Œè¿™é‡Œå¯èƒ½ä½œç”¨äº Page, Change Buffer (ä½†ä¸å®Œå…¨è€ƒè™‘ Undo)? è¿™é‡Œæœ‰ä¸ªç»†èŠ‚æ˜¯å¯èƒ½è¦æ”¹ MTRï¼Œæ¯”å¦‚ Update çš„ MTR éœ€è¦å˜æˆæ‹¥æœ‰æ‰€æœ‰åˆ—çš„ UPSERTã€‚æˆ‘è¿˜ä¸€ä¸‹æ²¡æƒ³åˆ° Undo æ˜¯ä¸æ˜¯æœ‰å½±å“ï¼Œå¯èƒ½ DDL æ„å»ºå®Œ Index åå¯ä»¥å¿½ç•¥ Undoï¼Ÿ</li><li>å†…éƒ¨æœ‰ä¸ª 2-Level LSM-Tree, ä½œä¸ºä¸€ä¸ª <strong>å•ç‰ˆæœ¬</strong> æœ€æ–°æ•°æ®å®šä½å™¨ã€‚æ˜ å°„ <code>&lt;P.K. -&gt; RID in Physical Location&gt;</code>.</li><li>æ–‡ä»¶åˆ’åˆ†ä¸º RowGroups, 64K è¡Œä¸€ä¸ª RGã€‚RG çš„ Column ç§°ä¸º Packï¼Œæœ‰ä¸€ä¸ªæ­£åœ¨å†™å…¥çš„æ˜¯ Unsealed pack. è¿™ä¸ª Pack çš„æ¦‚å¿µç±»ä¼¼ Parquet çš„ Pageã€‚æ­£åœ¨æ›´æ–°çš„ unpack - rowgroup ä¸ä¼šè¢«å‹ç¼©ã€‚è¿™é‡Œè¿˜é¢å¤–åœ¨ Metadata ç»´æŠ¤äº†ä¸¤åˆ— MVCC åˆ—ï¼šDeleted VID Map å’Œ Inserted VID Map. è¿™ä¸ªç±»ä¼¼äº‹åŠ¡ç³»ç»Ÿçš„ insert_ts å’Œ delete_ts (ä½†æ˜¯å¯èƒ½ä¸ä¸€å®šæœ‰ç›´æ¥çš„é¡ºåºæ€§ï¼Œåº”è¯¥ç±»ä¼¼ Innodb çš„äº‹åŠ¡ idï¼Œæ˜¯ä¸€ä¸ªè™½ç„¶é€’å¢ï¼Œä½†æ˜¯ç³»ç»Ÿçš„ id ä¸ä¸€å®šä»£è¡¨æäº¤çš„ ordering)<ol><li>æ€è€ƒ: ç³»ç»Ÿæœ¬èº«å¦‚ä½•æ¢å¤ï¼Ÿå®é™…ä¸Šå¯ä¾é  RO çš„ WAL æ¢å¤ï¼Œæ‰€ä»¥å¯ä»¥ä¸ç”¨åŠæ—¶ç›´æ¥æŠŠ Unsealed å» Seal äº†ï¼Œè¿™æ˜¯æœ‰è¡Œå­˜å’Œ RW ç³»ç»Ÿçš„ä¸€å¥—å¥½å¤„</li></ol></li></ol><p>åœ¨è¿™ä¸ªç³»ç»Ÿä¸­ï¼ŒUpdate è¢«æŠ½è±¡æˆ Delete + Insert ã€‚Delete å…¶å®ç›¸å½“äºåªåœ¨ RID Locator å’Œ Metadata åšåˆ é™¤ã€‚ç„¶å INSERT å…¨è¡Œæ’å…¥æœ€æ–°çš„ã€‚è€ƒè™‘åˆ°è¿™ä¸ªè¡¨å¯èƒ½ä¸ä¼šå¾ˆå¤§ï¼Œæš‚æ—¶å¯èƒ½æ²¡æœ‰åˆ†åŒºä¹‹ç±»çš„åŠŸèƒ½ï¼Ÿè¿™æ ·åº”è¯¥è¿˜è›®ç®€å•çš„ã€‚å‹ç¼©æ–‡ä»¶åˆ é™¤åªåˆ é™¤ Delete VID çš„ Metadata çš„è¯ï¼Œè¿™å—å¼€é”€ä¹Ÿä¸æ˜¯å¾ˆå¤§ã€‚</p><p>è¿™é‡Œè€ƒè™‘åˆ° MVCC çš„ç»†èŠ‚ï¼Œå®é™…ä¸Šåœ¨ Snapshot æ¨è¿›ä¹‹åï¼ŒInsert VID Map æ˜¯å¯ä»¥ä¸è¯»çš„ï¼ˆå½“ç³»ç»Ÿçš„ lowest trx id å¤§äºæœ€å¤§çš„ insert vid çš„æ—¶å€™ï¼‰ã€‚è¿™é‡Œçš„å¤„ç†æŒ‰ç…§ä¸‹é¢çš„é¡ºåºï¼š</p><p><img src="https://image.mwish.me/blog-image/43AAD368-908E-486F-9AEB-3A487A26A6C4.png" alt="43AAD368-908E-486F-9AEB-3A487A26A6C4"></p><p>åœ¨æäº¤ä¹‹å‰ï¼Œäº‹åŠ¡æ”’åœ¨ Transaction Buffer ä¸­ï¼Œç­‰å¾…æœ€ç»ˆçš„æäº¤æˆ–è€… abortã€‚æ€è€ƒï¼šå¦‚æœèµ° binlog çš„è¯ï¼Œè¿™å¥—ä¸œè¥¿å°±ç›¸å½“äºç›´æ¥èµ° CDC äº†ï¼ŒRID Locator ä»ç„¶éœ€è¦ï¼Œä½†åˆ«çš„åº”è¯¥ä¸ä¼šäº†ã€‚è¿™é‡Œä¹Ÿä¸éœ€è¦åˆ¤æ–­äº‹åŠ¡å†²çªï¼Œå› ä¸ºäº‹åŠ¡å†²çªåº”è¯¥åœ¨è¡Œå­˜ç³»ç»Ÿå¤„ç†äº†ã€‚æˆ‘ç†è§£å…¶å®åªèµ° binlog çš„è¯è¿™å¥—ä¼šå¹²å‡€ä¸€ç‚¹ï¼Œç„¶åè€ƒè™‘ binlog in redo çš„æ¶æ„ï¼Œè¿™å¥—åº”è¯¥æ˜¯å¯ä»¥åšçš„ã€‚</p><p>ä½†æ˜¯åœ¨å¤„ç†å¤§äº‹åŠ¡çš„æ—¶å€™ï¼Œè¿™å¥—æ–¹å¼æ¨æˆäº†ä¸å¤„ç†å†™å†²çªçš„ MVCCï¼Œå³è¿™é‡Œå¤§äº‹åŠ¡ä¼šåš pre-commit: å½“äº‹åŠ¡ txn record å¤§å°è¶…ä¸€å®šé™åˆ¶çš„æ—¶å€™å°±ä¼šåš PreCommitï¼Œå†™åˆ° unpack çš„åˆ—å­˜ä¸­ï¼ŒMVCC åˆ—æ ‡æ³¨ä¸ºä¸€ä¸ªä¸åˆæ³•çš„åˆ—ã€‚é‚£ä¹ˆæ€ä¹ˆå®šä½è¿™äº›æ•°æ®å‘¢ï¼Ÿè¿™é‡Œå¯èƒ½éœ€è¦ä¸€äº›ä¸´æ—¶çš„ RID Locator:</p><blockquote><p>First, request a continuous RID for all rows in the current transaction buffer, and save this RID range. It is important to note that the global RID locator cannot yet be changed during the pre-commit phase to avoid the exposure of uncommitted transactions. Thus, PolarDB-IMCI creates a temporary RID locator instead of updating the RID global locator to cache new PK-toRID mappings. Then, PolarDB-IMCI writes the updates to Partial Packs while setting the insert and delete VIDs as invalid to make them invisible. Finally, PolarDB-IMCI frees the memory used by the transaction buffer unit.</p></blockquote><h2 id="æŸ¥è¯¢å¤„ç†"><a href="#æŸ¥è¯¢å¤„ç†" class="headerlink" title="æŸ¥è¯¢å¤„ç†"></a>æŸ¥è¯¢å¤„ç†</h2><p>è¿™é‡Œå‰å°æœ‰ä¸ª Proxy æ¥è´Ÿè´£ dispatch ro/rw:</p><p><img src="https://image.mwish.me/blog-image/C818EC67-9CE8-46B2-A85F-263468184963.png" alt="C818EC67-9CE8-46B2-A85F-263468184963"></p><p>è¿™é‡Œå…¶å®æœ‰ç‚¹æ²¡æ‡‚ï¼Œè¿™ä¸ªæ˜¯åœ¨å‰å°æœ‰ä¸ª SQL Parser ç„¶ååšä»£ä»·ä¼°è®¡ï¼Ÿè¿™ä¸€è·³ä¼šå¾ˆè€—æ—¶å—ğŸ¤”ï¼Ÿä¸çŸ¥é“æ˜¯åƒ Preso Coordinator é‚£æ ·æ‹†åˆ†äº†ï¼Œè¿˜æ˜¯æ€ä¹ˆæ ·ï¼Œå…¶å®æœ‰ç‚¹ä¸æ˜¯å¾ˆç†è§£ã€‚</p><p>å…³äº Consistencyï¼Œè¿™é‡Œè¿˜æ˜¯ Proxy é  track LSN æ¥è§£å†³ï¼Œæœ‰é‚£ä¹ˆä¸€ç‚¹ç‚¹ç±»ä¼¼ Raft ReadIndex ä¹‹ç±»çš„ã€‚æˆ‘å€’æ˜¯æœ‰ç‚¹å¥½å¥‡ï¼Œå¦‚æœæ˜¯é  binlog ï¼Œè¿™å—åŒæ­¥æœ‰æ²¡æœ‰ä»€ä¹ˆæ–¹æ¡ˆï¼Œå¯èƒ½è¿˜æ˜¯ç»™ committed txn ä¸€ä¸ª id? å…¶å®ä¸‹ä¸€èŠ‚æåˆ°äº†ä¸ª CSEï¼Œè®©æˆ‘è«åè§‰å¾—è¿™å¥—æœºåˆ¶ä¹Ÿå¯è¡Œã€‚</p><blockquote><p>The proxy keeps track of the RW nodeâ€™s written LSN and all RO nodesâ€™ applied LSN. The written LSN and applied LSN indicate the transaction commit point for RW and RO, respectively. Transactions before the written LSN were committed on the RW node. Likewise, any log entries before the applied LSN are guaranteed to have been replayed by the RO node. The proxy may only route queries to the RO nodes whose applied LSN is not less than the written LSN to meet the requirements of strong consistency.</p></blockquote><h2 id="Column-æ•°æ®çš„æŒä¹…åŒ–åè®®"><a href="#Column-æ•°æ®çš„æŒä¹…åŒ–åè®®" class="headerlink" title="Column æ•°æ®çš„æŒä¹…åŒ–åè®®"></a>Column æ•°æ®çš„æŒä¹…åŒ–åè®®</h2><p>Column RO çš„ Node è¢«åˆ‡æˆ Leader å’Œ Followerï¼Œç±»ä¼¼ä¸€ç§ã€ŒColumnar RO æ•°æ®çš„ä¸€å†™å¤šè¯»ã€ã€‚Leader æŒä¹…åŒ–è¿™éƒ¨åˆ†æ•°æ®ï¼ŒFollower ç±»ä¼¼åªè¯»èŠ‚ç‚¹ã€‚è¿™é‡Œå›å¤´çœ‹çœ‹æ„Ÿè§‰å®é™…ä¸Šè¿™ä¸ªæ•°æ®åº“ç”šè‡³æœ‰ä¸€äº› MPP èƒ½åŠ›ã€‚ã€‚ã€‚</p><p>è¿™é‡Œçš„å…³é”®è®¾è®¡æ˜¯ CSN (Checkpoint Sequence Number) å’Œ Checkpointã€‚ç›¸å½“äºå¯¹æäº¤çš„äº‹åŠ¡å®šåºï¼š</p><ol><li>VID Map ä¼š fence æ‰å¤§äº CSN çš„æ•°æ®</li><li>Packs ç›´æ¥ä¸‹åˆ·å³å¯ï¼ŒLeader æŠŠ unsealed pack æ„å»ºæˆ Sealed ä¹‹åå°±å¯ä»¥ä¸‹åˆ·</li><li>RID Allocator å¯ä»¥ç›´æ¥ç›¸å½“äºå– Snapshot ç„¶åä¸‹åˆ·ï¼Œä¹Ÿä¼š fence åŠæ›´å¤§çš„</li></ol><p>å…³äº VID Map å’Œ RID Allocator å¯èƒ½éœ€è¦ä¸€äº›ç²¾ç»†ä¸€äº›çš„è®¾è®¡ï¼Œä¸è¿‡æ„Ÿè§‰å…¶å®éš¾åº¦ä¹Ÿå¯æ§</p><h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ol><li>å…³äº binlog çš„é¢å¤–å¼€é”€å’Œ binlog in redo æ–¹æ¡ˆï¼Œæˆ‘æ„Ÿè§‰å¦‚æœç›´æ¥ binlog in redo å°±èƒ½ç§»é™¤è¡Œé‚£å¥—çš„ç›´æ¥ä¾èµ–äº†ï¼Œé™¤éå†å»åšæŸ¥è¯¢çš„ fusion: <a href="http://mysql.taobao.org/monthly/2020/06/01/">http://mysql.taobao.org/monthly/2020/06/01/</a></li><li>AWS re:Invent2022 Aurora å‘å¸ƒäº†å•¥ - é™ˆå®—å¿—çš„æ–‡ç«  - çŸ¥ä¹<br><a href="https://zhuanlan.zhihu.com/p/590576660">https://zhuanlan.zhihu.com/p/590576660</a> ã€‚è¿™å—æˆ‘è§‰å¾—æœ¬èº«ä¹Ÿå¯ä»¥ä¸Š binlogã€‚</li></ol>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Strict Alias and Type Punning</title>
      <link href="/2023/12/30/Strict-Alias-and-Type-Punning/"/>
      <url>/2023/12/30/Strict-Alias-and-Type-Punning/</url>
      
        <content type="html"><![CDATA[<p>æœ€è¿‘åœ¨çœ‹ä»£ç çš„æ—¶å€™è€æ„Ÿè§‰è‡ªå·±çš„åŸºç¡€ä¸å¤Ÿæ‰å®ï¼ŒåŠ ä¸Šæœ€è¿‘æ¯”è¾ƒæ‘¸é±¼ï¼Œäºæ˜¯æƒ³çŒçŒæ°´ã€‚äº‹æƒ…çš„èµ·å› æ˜¯æ—©ä¸Šçœ‹åˆ°ç¤¾åŒºçš„ä¸€ä¸ªä¼˜åŒ–ï¼š<a href="https://github.com/apache/arrow/pull/39397">https://github.com/apache/arrow/pull/39397</a></p><p>è¿™ä¸ªä¼˜åŒ–çš„ä¿®æ”¹å¤§æ¦‚æ˜¯è¿™æ ·çš„ï¼š</p><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">  // Read definition and repetition levels. Also return the number of definition levels</span><br><span class="line">  // and number of values to read. This function is called before reading values.</span><br><span class="line">  void ReadLevels(int64_t batch_size, int16_t* def_levels, int16_t* rep_levels,</span><br><span class="line">                  int64_t* num_def_levels, int64_t* values_to_read) &#123;</span><br><span class="line">    batch_size =</span><br><span class="line">        std::min(batch_size, this-&gt;num_buffered_values_ - this-&gt;num_decoded_values_);</span><br><span class="line">    // If the field is required and non-repeated, there are no definition levels</span><br><span class="line">    if (this-&gt;max_def_level_ &gt; 0 &amp;&amp; def_levels != nullptr) &#123;</span><br><span class="line">      *num_def_levels = this-&gt;ReadDefinitionLevels(batch_size, def_levels);</span><br><span class="line">      // TODO(wesm): this tallying of values-to-decode can be performed with better</span><br><span class="line">      // cache-efficiency if fused with the level decoding.</span><br><span class="line"><span class="deletion">-      for (int64_t i = 0; i &lt; *num_def_levels; ++i) &#123;</span></span><br><span class="line"><span class="deletion">-        if (def_levels[i] == this-&gt;max_def_level_) &#123;</span></span><br><span class="line"><span class="deletion">-          ++(*values_to_read);</span></span><br><span class="line"><span class="deletion">-        &#125;</span></span><br><span class="line"><span class="deletion">-      &#125;</span></span><br><span class="line"><span class="addition">+ *values_to_read +=</span></span><br><span class="line"><span class="addition">+          std::count(def_levels, def_levels + *num_def_levels, this-&gt;max_def_level_);</span></span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      // Required field, read all values</span><br><span class="line">      *values_to_read = batch_size;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>å®é™…ä¸Šï¼Œè¿™ä¸ªåœ°æ–¹ <code>std::count</code> æ¯”å¾ªç¯æ•ˆç‡é«˜å—ï¼Ÿå¦ï¼Œè™½ç„¶æˆ‘ä»¬å¯ä»¥è®¤ä¸º <code>std::count</code> å’Œå¾ªç¯å¤§æ¦‚å¯ä»¥äº§ç”Ÿç­‰ä»·çš„ä»£ç ï¼Œé‚£ä¹ˆæ˜¯ä»€ä¹ˆä¸œè¥¿è®©è¿™æ ·æ•ˆæœå¥½ä¸€ç‚¹å‘¢ï¼Ÿç­”æ¡ˆæ˜¯ç¼–è¯‘å™¨æ— æ³•ç¡®å®š <code>num_def_levels</code>, <code>values_to_read</code> æ˜¯ä¸æ˜¯ä¸€ä¸ªä¸œè¥¿ï¼Œåœ¨å¾ªç¯ä¸­ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (def_levels[i] == <span class="keyword">this</span>-&gt;max_def_level_) &#123;</span><br><span class="line">  (*values_to_read);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¼šç”Ÿæˆä¸‹é¢çš„ä»£ç ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">0xc0c2f0 &lt;ReadLevels()+96&gt; inc %rdx</span><br><span class="line">0xc0c2f3 &lt;ReadLevels()+99&gt; cmp %rax,%rdx</span><br><span class="line">0xc0c2f6 &lt;ReadLevels()+102&gt; jge 0xc0c30c &lt;ReadLevels()+124&gt;</span><br><span class="line">0xc0c2f8 &lt;ReadLevels()+104&gt; cmp %cx,(%r14,%rdx,2)</span><br><span class="line">0xc0c2fd &lt;ReadLevels()+109&gt; jne 0xc0c2f0 &lt;ReadLevels()+96&gt;</span><br><span class="line">0xc0c2ff &lt;ReadLevels()+111&gt; incq 0x0(%rbp)</span><br><span class="line">0xc0c303 &lt;ReadLevels()+115&gt; mov (%rbx),%rax</span><br><span class="line">0xc0c306 &lt;ReadLevels()+118&gt; jmp 0xc0c2f0 &lt;ReadLevels()+96&gt;</span><br></pre></td></tr></table></figure><p>è¿™æ®µå¾ˆç®€å•çš„ä»£ç åœ¨å¾ªç¯ä¸­åè€Œæ˜¾å¾—åˆ¤æ–­å¾ˆå¤šä½™ã€‚æ ¹æ®æˆ‘ä»¬ä¹‹å‰ä»‹ç»çš„å†…å®¹ï¼Œç¼–è¯‘å™¨å¯ä»¥å¾ˆå¥½çš„ä¼˜åŒ–è¿™ç§åœºæ™¯ï¼Œç”šè‡³åšä¸€äº›å‘é‡åŒ–çš„ä¼˜åŒ–ã€‚</p><p>è¿™é‡Œæˆ‘ä»¬ä¼šäº†è§£åˆ°çš„éƒ¨åˆ†å°±æ˜¯ strict aliasingï¼Œè¿™éƒ¨åˆ†çš„ cppreference å¯ä»¥è§ï¼š<a href="https://en.cppreference.com/w/cpp/language/object#Strict_aliasing">https://en.cppreference.com/w/cpp/language/object#Strict_aliasing</a> ã€‚Strict Aliasing å¤§æ¦‚å°±æ˜¯ï¼Œä»€ä¹ˆä¹‹åèƒ½å¤Ÿåˆ¤æ–­å˜é‡ï¼ˆæƒ³è±¡å¾ªç¯é‡Œçš„ <code>def_levels</code>, <code>max_def_level_</code> , <code>values_to_read</code> ï¼‰æŒ‡å‘ä¸åŒçš„åŒºåŸŸã€‚</p><p>é‚£ä¹ˆï¼Œæ ¹æ®æˆ‘ä»¬ä¸Šé¢çš„ cppreference ï¼ˆä¹Ÿå¯ä»¥å‚è€ƒåšæ–‡ <a href="https://zhuanlan.zhihu.com/p/595286568">https://zhuanlan.zhihu.com/p/595286568</a> ï¼‰ã€‚ç±»å‹ä¸Šå¤§å®¶éƒ½æ˜¯ <code>int64_t</code>ï¼Œå¹¶ä¸å¥½åˆ¤æ–­ä¸¤è¾¹ä¸æ˜¯åŒä¸€ä¸ª aliasï¼</p><h2 id="æ‚ä½™"><a href="#æ‚ä½™" class="headerlink" title="æ‚ä½™"></a>æ‚ä½™</h2><h3 id="å‘Šè¯‰ç¼–è¯‘å™¨å¥½å¥½å·¥ä½œ"><a href="#å‘Šè¯‰ç¼–è¯‘å™¨å¥½å¥½å·¥ä½œ" class="headerlink" title="å‘Šè¯‰ç¼–è¯‘å™¨å¥½å¥½å·¥ä½œ"></a>å‘Šè¯‰ç¼–è¯‘å™¨å¥½å¥½å·¥ä½œ</h3><p>æœ¬ patch çš„ solving ç”¨äº†ä¸ªå¾ˆç®€å•çš„æ–¹æ³•ï¼šç›´æ¥æŠŠå˜é‡æ‹·å‡ºæ¥ï¼ä½ ä¸¤ä¸ªæœ¬åœ°å†…å­˜ä½ èƒ½é£åˆ°å“ªå»å‘¢ï¼Ÿ</p><p>é™¤æ­¤ä¹‹å¤–ï¼Œè¿™é‡Œè¿˜æåˆ°äº†å¾ˆå¤šæ–¹æ³•</p><ol><li>RESTRICT</li><li><a href="https://en.cppreference.com/w/cpp/language/attributes/assume">https://en.cppreference.com/w/cpp/language/attributes/assume</a> </li><li><code>gnu::pure</code></li><li>â€¦</li></ol><p>è¿™äº›æ–¹æ³•ä¸»è¦æ˜¯å‘Šè¯‰ç¼–è¯‘å™¨å¥½å¥½å¹²æ´»ä¸è¦èƒ¡æ€ä¹±æƒ³ï¼å…·ä½“å¯ä»¥å‚è€ƒè¿™ä¸ªç³»åˆ—ï¼š<a href="https://developers.redhat.com/blog/2020/06/02/the-joys-and-perils-of-c-and-c-aliasing-part-1#">https://developers.redhat.com/blog/2020/06/02/the-joys-and-perils-of-c-and-c-aliasing-part-1#</a></p><h3 id="Strict-Aliasing-å’Œ-UB"><a href="#Strict-Aliasing-å’Œ-UB" class="headerlink" title="Strict Aliasing å’Œ UB"></a>Strict Aliasing å’Œ UB</h3><p>åœ¨ Strict Aliasing çš„æƒ…å†µä¸‹ï¼Œè¿™é‡Œå…¶å®å¾ˆå®¹æ˜“å†™å‡ºä¸€äº›ç›¸å…³çš„ ub: </p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">foo</span><span class="params">( <span class="type">float</span> *f, <span class="type">int</span> *i )</span> </span>&#123; </span><br><span class="line">    *i = <span class="number">1</span>;               </span><br><span class="line">    *f = <span class="number">0.f</span>;            </span><br><span class="line">   </span><br><span class="line">   <span class="keyword">return</span> *i;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="type">int</span> x = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    std::cout &lt;&lt; x &lt;&lt; <span class="string">&quot;\n&quot;</span>;   <span class="comment">// Expect 0ï¼ŒOutput 0</span></span><br><span class="line">    x = <span class="built_in">foo</span>((<span class="type">float</span>*)(&amp;x), &amp;x);</span><br><span class="line">    std::cout &lt;&lt; x &lt;&lt; <span class="string">&quot;\n&quot;</span>;   <span class="comment">// Expect 0, But Output 1</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>å‡½æ•° <code>foo( float *f, int *i )</code>ï¼Œç¼–è¯‘å™¨æ ¹æ® strict aliasing rule ä¼šè®¤ä¸º <code>*f</code> å’Œ <code>*i</code> æŒ‡å‘ä¸åŒçš„å†…å­˜åŒºåŸŸï¼Œå¹¶ä»¥æ­¤è¿›è¡Œä¼˜åŒ–ï¼Œä½†å®é™…ä¸ŠæŒ‡å‘äº†ç›¸åŒçš„å†…å­˜åŒºåŸŸï¼Œå› æ­¤äº§ç”Ÿäº†é”™è¯¯çš„ç»“æœã€‚</p></blockquote><p>å˜›è¿™ä¸ªè™½ç„¶ <code>-fno-strict-aliasing</code> å¯ä»¥é˜»æ­¢ä¸€äº›é”™è¯¯ï¼Œä½†æ˜¯å®é™…ä¹Ÿå¯ä»¥å‚è€ƒ Type Punning</p><h2 id="Type-Punning"><a href="#Type-Punning" class="headerlink" title="Type Punning"></a>Type Punning</h2><p>æœ€æ—©çœ‹ LevelDB ä»£ç çš„æ—¶å€™ï¼Œå‘ç°å®ƒä» buffer ä¸­è¯»å–æ•´æ•°èµ°äº†ä¸€ä¸ª memcpyã€‚è¿™ä¸ªæˆ‘å½“æ—¶è¿˜æ²¡ç†è§£ï¼Œåæ¥æ‰çŸ¥é“æ˜¯ Type Punning çš„ç„æœºã€‚æˆ‘ä»¬å¯ä»¥ä»‹ç»ä¸€ä¸‹ Strict Aliasing ä¹‹ç±»çš„å…è®¸çš„ç±»å‹è½¬åŒ–å’Œä¸€äº›å¥‡æ€ªçš„é—®é¢˜ã€‚</p><blockquote><p>Whenever an attempt is made to read or modify the stored value of an object of type <code>DynamicType</code> through a glvalue of type <code>AliasedType</code>, the behavior is undefined unless one of the following is true:</p><ul><li><code>AliasedType</code> and <code>DynamicType</code> are <a href="https://en.cppreference.com/w/cpp/language/implicit_conversion#Similar_types">similar</a>.</li><li><code>AliasedType</code> is the (possibly <a href="https://en.cppreference.com/w/cpp/language/cv">cv</a>-qualified) signed or unsigned variant of <code>DynamicType</code>.</li><li><code>AliasedType</code> is <a href="https://en.cppreference.com/w/cpp/types/byte"><code>std::byte</code></a>,(since C++17) char, or unsigned char: this permits examination of the <a href="https://en.cppreference.com/w/cpp/language/object#Object_representation_and_value_representation">object representation</a> of any object as an array of bytes.</li></ul></blockquote><p>æ­¤å¤–ï¼Œè¿˜æœ‰ä¸‹é¢çš„å›¾ï¼šæ¯”å¦‚è¯´ int32_t çš„ object representation å¯èƒ½å¾ˆå¤šï¼Œä½†è½¬æˆåŒæ ·ä½æ•°çš„ floatï¼Œå´å¯èƒ½æ˜¯ cbï¼Œå› ä¸ºå®ƒå¯èƒ½æœ‰äº› value representation æ˜¯æ²¡æœ‰çš„ï¼</p><p><img src="https://image.mwish.me/blog-image/9C554F6D-AEC1-4758-A462-3B3D75F0ABCC.png" alt="9C554F6D-AEC1-4758-A462-3B3D75F0ABCC"></p><p>è¿™é‡Œå…·ä½“ä¹Ÿå¯ä»¥å‚è€ƒ <a href="https://www.youtube.com/watch?v=_qzMpk-22cc&amp;ab_channel=CppCon">https://www.youtube.com/watch?v=_qzMpk-22cc&amp;ab_channel=CppCon</a></p><h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ol><li>Type punning in modern C++ - Timur Doumler - CppCon 2019 <a href="https://www.youtube.com/watch?v=_qzMpk-22cc&amp;ab_channel=CppCon">https://www.youtube.com/watch?v=_qzMpk-22cc&amp;ab_channel=CppCon</a></li><li>ä¸¥æ ¼åˆ«åï¼ˆStrict Aliasingï¼‰è§„åˆ™æ˜¯ä»€ä¹ˆï¼Œç¼–è¯‘å™¨ä¸ºä»€ä¹ˆä¸åšæˆ‘æƒ³åšçš„äº‹ï¼Ÿ - Atledçš„æ–‡ç«  - çŸ¥ä¹<br><a href="https://zhuanlan.zhihu.com/p/595286568">https://zhuanlan.zhihu.com/p/595286568</a></li><li><a href="https://developers.redhat.com/blog/2020/06/02/the-joys-and-perils-of-c-and-c-aliasing-part-1#">https://developers.redhat.com/blog/2020/06/02/the-joys-and-perils-of-c-and-c-aliasing-part-1#</a></li><li><a href="https://gist.github.com/shafik/848ae25ee209f698763cffee272a58f8">https://gist.github.com/shafik/848ae25ee209f698763cffee272a58f8</a></li></ol>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Compiler Optimizations: Power, Limits, Auto-vetorize</title>
      <link href="/2023/12/10/Compiler-Optimizations-Power-Limits-Auto-vetorize/"/>
      <url>/2023/12/10/Compiler-Optimizations-Power-Limits-Auto-vetorize/</url>
      
        <content type="html"><![CDATA[<p>æœ¬æ–‡æ˜¯ç³»åˆ—æ–‡ç« çš„ç¬¬ä¸‰ç¯‡ï¼Œå‰ä¸¤ç¯‡æ–‡ç« ï¼š</p><ul><li><strong>x86 and SIMD programming Part0: Background</strong> <a href="https://blog.mwish.me/2022/11/05/x86-and-SIMD-programming/">https://blog.mwish.me/2022/11/05/x86-and-SIMD-programming/</a></li><li>Part0.5: <a href="https://blog.mwish.me/2023/11/15/Fast-Scalar-Code-and-Compiler/">https://blog.mwish.me/2023/11/15/Fast-Scalar-Code-and-Compiler/</a></li></ul><p>æœ¬ç¯‡å…¶å®è¿˜æ²¡åˆ° Part 1ï¼Œä¼°è®¡ç®—æ˜¯ 0.8 äº†ã€‚æœ¬ç¯‡æ–‡ç« ä¼šä»‹ç»ç¼–è¯‘å™¨èƒ½å¤Ÿåšçš„ä¸€äº›ä¼˜åŒ–å’Œä¼˜åŒ–çš„é™åˆ¶ï¼Œç„¶åä»‹ç» LLVM çš„ Auto-vectorizeã€‚ä¸‹ä¸€æœŸä¼šå¼€å§‹ä»‹ç» AVX2ã€‚</p><p>åœ¨ part-0.5 ä¸­ï¼Œæˆ‘ä»¬ä»‹ç»äº†ä½¿ç”¨æ‰‹å†™ Fast-Scalar ä»£ç çš„ä¾‹å­å’Œä»£ç ã€‚å®é™…ä¸Šï¼Œåœ¨ llvm éœ€è¦å¤ç°ç±»ä¼¼çš„æµ‹è¯•ç»“æœï¼Œéœ€è¦å…³æ‰ LLVM Auto-vectorizeï¼Œå› ä¸ºåè€…å¯èƒ½ä¼šå¸®åŠ©ç”Ÿæˆä¸€äº›ç›¸ä¼¼çš„ä»£ç ã€‚è¿™å°±æ˜¯ç¼–è¯‘å™¨çš„é­…åŠ›ã€‚ä½†æ˜¯ä½ ä¼šå‘ç°ï¼Œå¼€ä¸å¼€å¯¹äºæµ®ç‚¹æ•°éƒ½æ˜¯æ²¡æœ‰åŒºåˆ«çš„ï¼Œæˆ‘ä»¬ä¹‹åä¼šä»‹ç»ï¼Œæµ®ç‚¹æ•°çš„è®¡ç®—å› ä¸ºå—åˆ°ç²¾åº¦ä¹‹ç±»çš„ä¸œè¥¿çš„å½±å“ï¼Œåœ¨æ²¡æœ‰ <code>-ffast-math</code> çš„æƒ…å†µä¸‹ï¼Œå¾ˆå¤šä¼˜åŒ–æµ®ç‚¹æ•°æ˜¯ä¸è®©åšçš„ã€‚ï¼ˆè¯´ä¸ªå’Œæœ¬é¢˜æ— å…³çš„ï¼Œæ˜¨å¤©çœ‹ patch çš„æ—¶å€™ç«Ÿç„¶å‘ç° C++20 ä¹‹å‰ unsigned æ•´æ•°è½¬ signed æ˜¯<strong>å®ç°å®šä¹‰</strong>çš„â€¦è€Œä¸”å®ç°å®šä¹‰å’Œ ub è¿˜ä¸æ˜¯ä¸€å›äº‹ï¼Œè¿™ä¸ªéœ‡æ’¼æˆ‘å¿ƒäº†ï¼‰</p><p>è¿™ç¯‡çš„ä¸»è¦ææ–™æ¥æºäº Matt Godbolt çš„åšå®¢å’Œ Ethz / CMU çš„è¯¾ä»¶. æœ¬æ–‡æœ¬æ¥11æœˆå°±è¯¥å†™å®Œäº†ï¼Œå› ä¸ºæˆ‘åŠ ç­åŠ çš„æœ‰ç‚¹çƒ¦ï¼Œä¸­é—´æ‘†çƒ‚äº†å¾ˆé•¿ä¸€é˜µå­ï¼Œè¿™ä¸¤å¤©å›å®¶ç¼“äº†ç¼“æ‰è§‰å¾—åº”è¯¥å¹²æ´»äº†ã€‚æ‹–äº†å¾ˆä¹…å®åœ¨ä¸å¥½æ„æ€â€¦</p><h2 id="ç¼–è¯‘å™¨çš„ä¼˜åŒ–å’Œé™åˆ¶"><a href="#ç¼–è¯‘å™¨çš„ä¼˜åŒ–å’Œé™åˆ¶" class="headerlink" title="ç¼–è¯‘å™¨çš„ä¼˜åŒ–å’Œé™åˆ¶"></a>ç¼–è¯‘å™¨çš„ä¼˜åŒ–å’Œé™åˆ¶</h2><p>ç¼–è¯‘å™¨èƒ½å¤Ÿè¿›è¡Œå¾ˆå¤šæœ‰æ•ˆçš„ä¼˜åŒ–ï¼Œä½†æ˜¯å…¶ä¸­ä¹Ÿæœ‰å¾ˆå¤šé™åˆ¶ã€‚ã€Œæ„è¯†ã€åˆ°ç¼–è¯‘å™¨èƒ½å¤Ÿè¿›è¡Œçš„ä¼˜åŒ–æœ‰åŠ©äºæˆ‘ä»¬å†™å‡ºå¿«é€Ÿçš„ä»£ç ï¼ŒåŒæ—¶ï¼Œä¹Ÿè®©æˆ‘ä»¬ä¸è‡³äºå› ä¸ºæ€§èƒ½æå¾—ä»£ç çœ‹ä¸Šå»ç‰¹åˆ«æ“ã€‚</p><p>ç®€å•çš„è¯´ï¼Œæˆ‘ä¸ªäººæ€»ç»“å°±æ˜¯ï¼š</p><ul><li>ç¼–è¯‘å™¨ä¼šå°è¯•æ›¿æ¢æ˜‚è´µçš„æ“ä½œ</li><li>ç¼–è¯‘å™¨çŸ¥é“çš„æ¯”è¾ƒå¤šå°±èƒ½æ›´å¥½ä½œå‡ºä¼˜åŒ–ï¼ˆå‚è€ƒ LTOã€PGOï¼‰</li></ul><p>å…·ä½“å¯è§ï¼š <a href="https://dl.acm.org/doi/10.1145/3371595.3372264">https://dl.acm.org/doi/10.1145/3371595.3372264</a></p><p>æœ‰ä¸ªæ¯”è¾ƒå¥½ç©çš„ï¼Œä½œè€…å†™çš„å…³äº LTO çš„è¯ï¼š</p><blockquote><p>Despite being a relatively established technology (I used LTCG in the early 2000s on the original Xbox), Iâ€™ve been surprised how few projects use LTO. In part this may be because programmers unintentionally rely on undefined behavior that becomes apparent only when the compiler gets more visibility: I know Iâ€™ve been guilty of this.</p></blockquote><p>åªèƒ½è¯´ Godbolt ä¸­è‚¯ã€‚function call é€šå¸¸æ˜¯é˜»ç¢ä¼˜åŒ–çš„éƒ¨åˆ†ï¼Œè¿™ä¸ªå¯èƒ½åŒ…æ‹¬çš„éƒ¨åˆ†æœ‰å¾ˆå¤šï¼Œä½ å¾—çŸ¥é“å‡½æ•°æ˜¯ä¸æ˜¯ <code>pure</code> çš„ï¼Œå‚æ•°æ˜¯å¦æ˜¯ <code>const</code> çš„ï¼Œä¼šä¸ä¼šä¿®æ”¹ä½ çš„å‚æ•°ã€‚é‡Œé¢æ˜¯å¦æœ‰åŸå­æ“ä½œä¹‹ç±»çš„ä¸œè¥¿ï¼Œä¼šæœ‰é‚£ç§ç¦æ­¢ä½  ordering çš„ä¸œè¥¿ã€‚inline ä¹‹ç±»çš„ã€‚è¿™æ–¹é¢æœ‰ LTO çš„è¯ä¼šæ–¹ä¾¿å¾ˆå¤šï¼ˆæ¯•ç«Ÿä½ è‡ªå·±ä¼˜åŒ–èƒ½ä¼˜åŒ–åˆ°å“ªå»å‘¢ï¼Ÿï¼‰</p><p>è¿™é‡Œè¿˜æ˜¯å»ºè®®ç›´æ¥çœ‹åŸå¸–ï¼ŒåŸå¸–é‡è¦éƒ¨åˆ†æ˜¯ç»™äº†å‡ ä¸ªä¼˜åŒ–çš„å®é™…ä¾‹å­ï¼Œæˆ‘è¿˜æ˜¯æ¯”è¾ƒå»ºè®®é€šè¯»å®Œçš„ï¼Œè¿™é‡Œè¿˜æœ‰ä¸ªé‡ç‚¹æ˜¯æµ®ç‚¹æ•°ï¼š</p><blockquote><p>This does rely on the fact that separating the totals into individual subtotals and then summing at the end is equivalent to adding them in the order the program specified. For integers, this is trivially true; but for floating-point data types this is not the case. Floating point operations are not associative: (a+b)+c is not the same as a+(b+c), asâ€”among other thingsâ€”the precision of the result of an addition depends on the relative magnitude of the two inputs.</p></blockquote><p>æµ®ç‚¹æ•°çš„æ“ä½œéƒ½å’Œå¾ˆå¤šä¸œè¥¿ç›¸å…³ï¼Œä¸å¼€ <code>-ffast-math</code> ä¹‹ç±»çš„å…¶å®ä¸å¥½ä¼˜åŒ–çš„ã€‚å› ä¸ºç¼–è¯‘å™¨è¿˜æ˜¯<strong>åœ¨ä¸ä¿®æ”¹ç¨‹åºçš„è¯­ä¹‰ä¸‹è¿›è¡Œä¼˜åŒ–</strong>çš„ã€‚</p><p>æ–‡ç« ä¸­è¿˜æœ‰å‡ ä¸ªæ¯”è¾ƒé‡è¦çš„éƒ¨åˆ†ï¼š</p><ul><li>ä¹˜æ³•ã€é™¤æ³•çš„ä¼˜åŒ–</li><li>de-virtualization (ç”¨å¥½ <code>final</code> ) ï¼Œè¿™ä¸ªä¹Ÿå¯è§åšå®¢ [4] ( <a href="https://quuxplusone.github.io/blog/2021/02/15/devirtualization/">https://quuxplusone.github.io/blog/2021/02/15/devirtualization/</a>  )</li></ul><p>å½“ç„¶ï¼Œä¹±ä¼˜åŒ–æµ®ç‚¹æ•°å¯èƒ½ä¼šäº§ç”Ÿéé¢„æœŸçš„ç»“æœï¼Œæ¯”å¦‚ NaN çš„å¤„ç†å¯èƒ½ä¼šäº§ç”Ÿä¸€äº›éé¢„æœŸçš„è¡Œä¸ºã€‚</p><p>æ­¤å¤–ï¼Œå½±å“ä¼˜åŒ–çš„ä¸€ç‚¹åŒ…æ‹¬ memory alias:</p><p><img src="https://image.mwish.me/blog-image/5232900845989570722.png" alt="img"></p><p>è¿™ç§ä¸ç¡®å®š alias çš„æƒ…å†µä¸‹ï¼Œå¯èƒ½ä¸æ˜¯ç‰¹åˆ«å¥½ä¼˜åŒ–ï¼Œå¯èƒ½ç¼–è¯‘å™¨ä¼šåŠ ä¸Šä¸€äº› flag æˆ–è€… Runtime Flagï¼Œä½†æˆ‘ç†è§£æœ‰æ¥è‡ªç”¨æˆ·çš„å…ˆéªŒçŸ¥è¯†ï¼Œèƒ½å¤Ÿå¸®åŠ©ç¼–è¯‘å™¨æ²¡æœ‰è´Ÿæ‹…çš„äº§ç”Ÿæ›´å¿«çš„ä»£ç ã€‚</p><p><img src="https://image.mwish.me/blog-image/1919209245906864678.png" alt="img"></p><p>å½“ç„¶ï¼Œä½ æœ‰ä¸€äº›å®å¯ä»¥ç”¨ä¸Šï¼Œè¿™é‡Œå¯èƒ½ä¹Ÿå¯ä»¥å¸®åŠ©ä½ æ¥å±•å¼€å¾ªç¯ï¼Œæ¯”å¦‚ <code>#pragma ivdep</code></p><p><img src="https://image.mwish.me/blog-image/147086212116536191.png" alt="img"></p><h2 id="LLVM-Auto-Vectorization"><a href="#LLVM-Auto-Vectorization" class="headerlink" title="LLVM Auto-Vectorization"></a>LLVM Auto-Vectorization</h2><p>15-721 çš„è¯¾ä»¶æœ‰ä¸€å¼ æ¯”è¾ƒæœ‰æ„æ€çš„å›¾ï¼Œä½†è¿™å¼ å›¾å®é™…ä¸Šæ˜¯é”™è¯¯çš„ï¼Œç¼–è¯‘å™¨åœ¨è¿™æ–¹é¢å…¶å®è¿˜æ˜¯è›®èªæ˜çš„ï¼š</p><p><img src="https://image.mwish.me/blog-image/3046202342352512391.png" alt="img"></p><p>LLVM æœ‰ä¸€ç§ Runtime checks of pointers çš„èƒ½åŠ›ï¼Œå®ƒä¼šç¼–ç ä¸€ä¸ª Runtime çš„ checkingï¼Œå¦‚ä¸‹ã€‚</p><p><a href="https://llvm.org/docs/Vectorizers.html#runtime-checks-of-pointers">https://llvm.org/docs/Vectorizers.html#runtime-checks-of-pointers</a></p><p>æˆ‘å¸Œæœ›æˆ‘ä»¬èƒ½å›å¿†èµ·æ¥ä¸Šä¸€èŠ‚çš„ä¼˜åŒ–å†…å®¹ï¼Œä¸Šä¸€èŠ‚é‡Œé¢æˆ‘ä»¬å±•ç¤ºäº†ä¸€ä¸ªæ‰‹åŠ¨çš„å¯¹éå‘é‡åŒ–ä»£ç çš„ä¼˜åŒ–ï¼š<a href="https://blog.mwish.me/2023/11/15/Fast-Scalar-Code-and-Compiler/#Parquet-BYTE-STREAM-SPLIT-%E5%8A%A0%E9%80%9F">https://blog.mwish.me/2023/11/15/Fast-Scalar-Code-and-Compiler/#Parquet-BYTE-STREAM-SPLIT-%E5%8A%A0%E9%80%9F</a></p><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä¸Šè¿°ä¼˜åŒ–çš„ä»£ç çš„ä¸€äº›æ€è·¯ï¼š</p><ol><li>æ‹†åˆ†è®¡ç®—ï¼ŒæŠŠ vectorize çš„è®¡ç®—æ‹†åˆ†æˆä¸ºä¸€ç»„è®¡ç®— Load ä¸€å¤§ç»„ â€”&gt; å¯¹è¿™ç»„æ•°æ®è¿›è¡Œè®¡ç®— â€”&gt; Store å†…å­˜</li><li>å¦‚æœæ˜¯ SIMD æˆ–è€…åˆ©ç”¨æŒ‡ä»¤çº§å¹¶è¡Œï¼Œé‚£ä¹ˆè®¡ç®—å‡ºæŸä¸ªæ ¸å¿ƒçš„è®¡ç®—é€»è¾‘å¯¹åº”çš„ port æ•°ï¼Œç„¶åå»å¹¶è¡Œæ‰§è¡Œå®ƒä»¬</li><li>ä¸Šè¿°æ“ä½œå¦‚æœæ˜¯åœ¨ TP ç‚¹æŸ¥æ“ä½œä¸­å…¶å®ä¸ä¸€å®šåˆ’å¾—æ¥ï¼Œå› ä¸ºæ²¡å‡ ä¸ªæ“ä½œè·Ÿä½ å¹¶è¡Œï¼Œå³ä½¿æ˜¯ TableScan -&gt; Filter è¿™ç§ä¹Ÿæ˜¯ã€‚ä½†æ˜¯å¯èƒ½ AP è¿™ç§ workload æœ¬èº«å°±æœ‰ä¸€å¤§æ‰¹æ•°æ®éœ€è¦è®¡ç®—çš„ï¼Œæ‰€ä»¥å¯ä»¥æ‹†åˆ†æˆè¿™æ ·æ¯ä¸ª batch æ‰¹é‡æ‰§è¡Œçš„è®¡ç®—ã€‚è¿™ä¸ªæ‰¹é‡å¤§å°å’Œ CPUã€Portã€è®¿å­˜æ“ä½œæœ‰å…³ã€‚å¦‚æœè¾“å…¥æ•° % batchSize è¿˜æœ‰å‰©ä½™çš„è¯ï¼Œå¯èƒ½ä¼šéœ€è¦æ¥ä¸€ä¸ª non-vectorize çš„ epilogue</li></ol><p>æ¯”è¾ƒæœ‰è¶£çš„äº‹ï¼ŒLLVM è‡ªåŠ¨å‘é‡åŒ–ä¼šå°è¯•äº§ç”Ÿä¸€ä¸ªç±»ä¼¼ä¸‹åˆ—çš„ç»“æ„ï¼š</p><ul><li>Vectorize Body</li><li>Vector Epilogue</li><li>Scalar Epilogue</li></ul><p><img src="https://image.mwish.me/blog-image/1492060510279710289.png" alt="img"></p><p>LLVM ä¼šæŒ‰ç…§ä¸Šè¿°å†…å®¹æ¥ä¼˜åŒ–ã€‚çŸ¥é“è¿™ä¸ªä¹‹åï¼Œæˆ‘ä»¬å»çœ‹çœ‹ LLVM å®˜æ–¹çš„ Vectorize æ–‡æ¡£ï¼š<a href="https://llvm.org/docs/Vectorizers.html#features">https://llvm.org/docs/Vectorizers.html#features</a></p><p>ä¸‹åˆ—çš„ä»£ç æ˜¯å¯ä»¥ vectorize çš„</p><ul><li>Loops with unknown trip count</li></ul><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">bar</span><span class="params">(<span class="type">float</span> *A, <span class="type">float</span>* B, <span class="type">float</span> K, <span class="type">int</span> start, <span class="type">int</span> end)</span> </span>&#123;  </span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = start; i &lt; end; ++i)    </span><br><span class="line">        A[i] *= B[i] + K;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>Reductions</li></ul><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">foo</span><span class="params">(<span class="type">int</span> *A, <span class="type">int</span> n)</span> </span>&#123;</span><br><span class="line">  <span class="type">unsigned</span> sum = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; n; ++i)</span><br><span class="line">    sum += A[i] + <span class="number">5</span>;</span><br><span class="line">  <span class="keyword">return</span> sum;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå¦‚æœæ˜¯ Reductions ï¼Œé‚£ä¹ˆ add, xor ä¹‹ç±»çš„æ“ä½œï¼Œå®ƒä¼šæŠ½å‡ºä¸€ä¸ª vectorize ç»„ï¼ˆç±»ä¼¼ <code>unsigned[dop] sum</code> )ï¼Œç„¶ååœ¨ä¸Šé¢æ“ä½œçš„æ—¶å€™ï¼Œé¿å…æ“ä½œåŒä¸€ä¸ªå€¼ã€‚æ³¨æ„è¿™é‡Œå¯¹æµ®ç‚¹æ•°æ˜¯ä¸èƒ½è¿™æ ·æ“ä½œçš„ï¼ˆé™¤éå¼€äº† <code>-ffast-math</code>ï¼‰</p><ul><li>Inductions</li></ul><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">bar</span><span class="params">(<span class="type">float</span> *A, <span class="type">int</span> n)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; n; ++i)</span><br><span class="line">    A[i] = i;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ç§èƒ½å‘é‡åŒ–ï¼ˆå¥½åƒå¾ˆåˆç†ï¼‰</p><ul><li>If Conversion</li></ul><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">foo</span><span class="params">(<span class="type">int</span> *A, <span class="type">int</span> *B, <span class="type">int</span> n)</span> </span>&#123;</span><br><span class="line">  <span class="type">unsigned</span> sum = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; n; ++i)</span><br><span class="line">    <span class="keyword">if</span> (A[i] &gt; B[i])</span><br><span class="line">      sum += A[i] + <span class="number">5</span>;</span><br><span class="line">  <span class="keyword">return</span> sum;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>control flow in the innermost loop è¿™é‡Œå¯ä»¥ vectorizeï¼Œè¿™é‡Œå¯ä»¥å‚è€ƒåšå®¢ï¼š<a href="https://sbaziotis.com/performance/a-beginners-guide-to-vectorization-by-hand-part-3.html">https://sbaziotis.com/performance/a-beginners-guide-to-vectorization-by-hand-part-3.html</a></p><ul><li>Pointer Induction Variables</li></ul><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">baz</span><span class="params">(<span class="type">int</span> *A, <span class="type">int</span> n)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> std::<span class="built_in">accumulate</span>(A, A + n, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯¹æŒ‡é’ˆå’Œæ ‡å‡†åº“èƒ½å¾ˆå¥½å¤„ç†</p><ul><li>Reverse Iterators</li></ul><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">foo</span><span class="params">(<span class="type">int</span> *A, <span class="type">int</span> n)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = n; i &gt; <span class="number">0</span>; --i)</span><br><span class="line">    A[i] +=<span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯¹åå‘æ“ä½œå¾ˆå¥½å¤„ç†(è·Ÿ rsy èŠçš„æ—¶å€™ä»–è¿˜å‘Šè¯‰æˆ‘ reverse æ–¹å‘çš„ prefetch å¯èƒ½ä¸å¦‚æ­£å‘çš„ prefetchï¼Œå­¦åˆ°å¾ˆå¤šï¼‰</p><ul><li>Scatter / Gatter</li></ul><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">foo</span><span class="params">(<span class="type">int</span> * A, <span class="type">int</span> * B, <span class="type">int</span> n)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">intptr_t</span> i = <span class="number">0</span>; i &lt; n; ++i)</span><br><span class="line">    A[i] += B[i * <span class="number">4</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>-mllvm -force-vector-width=#</code> çš„æƒ…å†µä¸‹è¿™é‡Œæ‰ä¼šå¼€å¯ï¼Œå› ä¸ºå®ƒå¯èƒ½å‘ç° cost åˆ’ä¸æ¥</p><ul><li><a href="https://llvm.org/docs/Vectorizers.html#vectorization-of-mixed-types">https://llvm.org/docs/Vectorizers.html#vectorization-of-mixed-types</a></li></ul><p>å¤šç§ç±»å‹çš„æ··åˆä¼šæ ¹æ®ä»£ä»·æ¥ä¼°è®¡</p><ul><li>Partial unrolling during vectorization</li></ul><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">foo</span><span class="params">(<span class="type">int</span> *A, <span class="type">int</span> n)</span> </span>&#123;</span><br><span class="line">  <span class="type">unsigned</span> sum = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; n; ++i)</span><br><span class="line">    sum += A[i];</span><br><span class="line">  <span class="keyword">return</span> sum;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªé•¿å¾—å’Œå‰é¢ Reduction å¾ˆåƒï¼Œä½†è¿™é‡Œæ˜¯è¯´ï¼Œä¼šæŒ‰ç…§ port çš„æ•°é‡ï¼Œæ¥æ‹†åˆ†å¹¶è¡Œåº¦ã€‚</p><p>è¿™äº›åªæ˜¯æˆ‘é€‰äº†æƒ³è®°ä½çš„ä¸€éƒ¨åˆ†ï¼Œéœ€è¦çŸ¥é“å…·ä½“ç»†èŠ‚å¯ä»¥æµè§ˆåŸæ¥çš„æ–‡æ¡£ã€‚</p><h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><ul><li>Matt Godbolt çš„ C++ Optimizations <a href="https://dl.acm.org/doi/10.1145/3371595.3372264">https://dl.acm.org/doi/10.1145/3371595.3372264</a> å’Œå¤§ä½¬çš„ç¿»è¯‘ <a href="https://fuzhe1989.github.io/2020/01/22/optimizations-in-cpp-compilers/">https://fuzhe1989.github.io/2020/01/22/optimizations-in-cpp-compilers/</a> . è¿™ä¸€ç¯‡çš„ä»‹ç»éå¸¸å¥½</li><li>Ethz Fastcode 05: <a href="https://acl.inf.ethz.ch/teaching/fastcode/2023/slides/05-compiler-limitations.pdf">https://acl.inf.ethz.ch/teaching/fastcode/2023/slides/05-compiler-limitations.pdf</a></li><li>CMU 15-721 2023 <a href="https://15721.courses.cs.cmu.edu/spring2023/slides/08-vectorization.pdf">https://15721.courses.cs.cmu.edu/spring2023/slides/08-vectorization.pdf</a></li><li><a href="https://quuxplusone.github.io/blog/2021/02/15/devirtualization/">https://quuxplusone.github.io/blog/2021/02/15/devirtualization/</a> Author çš„å»è™šæ‹ŸåŒ–åšå®¢</li><li><a href="https://llvm.org/docs/Vectorizers.html#features">https://llvm.org/docs/Vectorizers.html#features</a> LLVM Vectorize</li><li><a href="https://sbaziotis.com/">https://sbaziotis.com/</a></li></ul>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Fast Scalar Code and Compiler</title>
      <link href="/2023/11/15/Fast-Scalar-Code-and-Compiler/"/>
      <url>/2023/11/15/Fast-Scalar-Code-and-Compiler/</url>
      
        <content type="html"><![CDATA[<p>ä¸Šä¸€æœŸ( <a href="https://blog.mwish.me/2022/11/05/x86-and-SIMD-programming/">https://blog.mwish.me/2022/11/05/x86-and-SIMD-programming/</a> ) ä»‹ç»äº† x86 å’Œ SIMD çš„èƒŒæ™¯ï¼ŒåŒæ—¶ä»‹ç»äº† x86 Skylake çš„æ¶æ„ã€‚è¿™æ–‡ç« å†™äº†éƒ½æ•´æ•´ä¸€å¹´äº†ï¼ˆæˆ‘ä¹Ÿå¤ªæ‘†çƒ‚äº†ï¼‰ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿˜æ˜¯éœ€è¦å›é¡¾ä¸€ä¸‹ã€‚x86 CPU ä¸Šé¢é€šè¿‡ decode ä»£ç ï¼ŒæŠŠ x86 CISC æŒ‡ä»¤è½¬åŒ–ä¸º RISC çš„ micro-arch çš„æŒ‡ä»¤ã€‚SuperScalar çš„æŒ‡ä»¤è¢«è§£æåï¼Œé‡Œé¢æœ‰ä¸€ç»„ Port æ¥æ‰§è¡Œå¯¹åº”çš„ä»£ç ã€‚è¿™æ ·æˆ‘ä»¬çš„ CPU å¯ä»¥ OoO çš„æ‰§è¡Œã€‚ç†è®ºä¸Šç»™å®šä¸€ç»„ä»£ç å’Œ Port ç”šè‡³å¯ä»¥ç®—å‡ºä¸€ä¸ªä»£ç æ‰§è¡Œçš„ä¸Šé™ã€‚</p><p><img src="https://image.mwish.me/blog-image/2216018380123463140.png" alt="img"></p><p>å½“ç„¶ä¸Šé¢è¿™é‡Œè¯´çš„è¿˜æ˜¯ä¸€ä¸ªç†è®ºçš„ä¸Šé™å€¼ï¼Œå®é™…ä¸Šåœ¨ä¸Šç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬è¿˜äº†è§£äº†å¦‚ä½•è¡¡é‡ä¸€ä¸ªåº”ç”¨æ˜¯ bounded by CPU è¿˜æ˜¯è®¿å­˜ã€‚</p><p>åœ¨è®¿é—®å†…å­˜ä¸Šï¼Œæœ‰ L1 â€” L2 â€” L3 çš„ Cacheã€‚è¿™é‡Œ L1 åœ¨æ¯ä¸ª CPU ä¸Šï¼ŒL3 åˆ™å¯èƒ½æ¶‰åŠä¸€äº›å…±äº«ã€‚ç¬”è€…è¿™é‡Œå¹¶ä¸åšç‰¹åˆ«ç»†çš„ä»‹ç»æ˜¯å› ä¸ºè¿™å—å¹¶ä¸å±äº ISAï¼Œè€Œæ˜¯ microarch ä¹‹ç±»æˆ–è€…å®ç°ä¸Šåº”è¯¥ç®¡çš„ä¸€éƒ¨åˆ†ã€‚Prefetch æœ¬èº«ä¹Ÿå’Œé«˜æ€§èƒ½çš„ä»£ç ç›¸å…³ï¼Œä½†æ˜¯è¿™ä¸ªæ›´å¤šåªèƒ½ç”¨æ¥è§£é‡Šã€‚</p><p>è¿™ä¸€èŠ‚æˆ‘ä»¬ä»‹ç»çš„æ˜¯å¦‚ä½•å†™å‡ºé«˜æ€§èƒ½çš„ â€œscalarâ€ ä»£ç ï¼Œè¯´æ˜¯ scalar ä¸»è¦æ˜¯å› ä¸ºåœ¨è¿™é‡Œæˆ‘ä»¬ä¸ä¼šç”¨åˆ° SIMD çš„æŒ‡ä»¤ã€‚å–è€Œä»£ä¹‹çš„æ˜¯å¦‚ä½•åˆ©ç”¨ superscalar ä¹‹ç±»çš„æ€§è´¨ï¼Œå†™å‡ºé«˜æ€§èƒ½çš„ Scalar Codeã€‚æˆ‘ä»¬é¦–å…ˆä¼šä»‹ç»ä» fastcode çš„ä»£ç å’Œç”Ÿäº§çš„ä»£ç æ¥åˆ†æè¿™å—çš„æ€§èƒ½ã€‚ä¸‹ä¸€èŠ‚ä¹Ÿä¼šä»‹ç» LLVM çš„ Auto-vectorize å’Œ ç¼–è¯‘å™¨çš„ä¼˜åŒ–ã€‚</p><h2 id="Fast-Scalar-Code"><a href="#Fast-Scalar-Code" class="headerlink" title="Fast Scalar Code"></a>Fast Scalar Code</h2><p>ä»£ç æœ¬èº«å¯èƒ½å’Œ code æ‰§è¡Œçš„æ±‡ç¼–æ•°é‡ã€è®¿é—®çš„è´Ÿè½½ä¹‹ç±»çš„ä¸œè¥¿æœ‰å…³ã€‚æ ¹æ®æˆ‘ä»¬ä¸Šç¯‡æ–‡ç« çš„çŸ¥è¯†ï¼ŒæŒ‡ä»¤çš„å»¶è¿Ÿã€ååéƒ½æ˜¯ä¸ä¸€æ ·çš„ã€‚æ­¤å¤–ï¼Œæˆ‘ä»¬è¿˜çŸ¥é“äº†æ‰€è°“ Super Scalar çš„å¤§è‡´è¯­ä¹‰ã€‚é‚£ä¹ˆï¼Œå°½ç®¡ä¸åŒæ¶æ„ä»£ç å¯èƒ½ Port ä¹‹ç±»çš„æ•°é‡ä¼šæœ‰ä¸åŒï¼Œä½†æ˜¯è¿™å¯¹æˆ‘ä»¬å†™å‡ºå¿«çš„ scalar ä»£ç æ˜¯æœ‰æŒ‡å¯¼æ„ä¹‰çš„ã€‚</p><p>å…³äºä¹±åºå¦‚ä¸‹é¢æ‰€è¿°</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">t2 = t0 + t1</span><br><span class="line">t5 = t4 * t3</span><br><span class="line">t6 = t2 + t5</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆ è¿™é‡Œ (1) (2) è¡Œçš„å…¶å®å¯ä»¥ä¸²è¡Œæ‰§è¡Œã€‚è€ƒè™‘åˆ° Memory Modelï¼ŒStore Load å¯èƒ½ä¼šæœ‰ä¸€äº›å½±å“ï¼Œä½†æ˜¯å¾ˆå¤šä¸œè¥¿ä¹Ÿèµ°ä¸åˆ° Memory ( æ¯”å¦‚çœ‹è¿™ä¸ªé“¾æ¥ <a href="https://stackoverflow.com/questions/29722676/atomic-operations-on-superscalar-processor">https://stackoverflow.com/questions/29722676/atomic-operations-on-superscalar-processor</a> ï¼Œå®é™…ä¸Šä¸€äº› Atomic æ“ä½œçš„æ—¶å€™ï¼ŒCPU ä¹Ÿä»¿ä½›ä¸æ˜¯ Super Scalar çš„äº†ï¼‰</p><p><img src="https://image.mwish.me/blog-image/8601113935312402029.png" alt="img"></p><p>è¯¾ç¨‹ä¸¾äº†ä¸ª Sample æ¥ä»‹ç»å¦‚ä½•å†™ fast scalar çš„ä»£ç ï¼Œsample å¦‚ä¸‹ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">template <span class="operator">&lt;</span>typename ArrowType, typename Op<span class="operator">&gt;</span></span><br><span class="line">void BenchmarkOp(benchmark::State<span class="operator">&amp;</span> state) &#123;</span><br><span class="line">  <span class="keyword">using</span> CType <span class="operator">=</span> typename ArrowType::c_type;</span><br><span class="line">  auto rand <span class="operator">=</span> random::RandomArrayGenerator(kSeed);</span><br><span class="line">  auto valueArray <span class="operator">=</span> std::static_pointer_cast<span class="operator">&lt;</span>NumericArray<span class="operator">&lt;</span>ArrowType<span class="operator">&gt;&gt;</span>(rand.Numeric<span class="operator">&lt;</span>ArrowType<span class="operator">&gt;</span>(<span class="number">4096</span> <span class="operator">*</span> <span class="number">16</span>, <span class="number">0</span>, <span class="number">114514</span>));</span><br><span class="line">  int64_t length <span class="operator">=</span> valueArray<span class="operator">-</span><span class="operator">&gt;</span>length();</span><br><span class="line">  auto <span class="keyword">values</span> <span class="operator">=</span> valueArray<span class="operator">-</span><span class="operator">&gt;</span>raw_values();</span><br><span class="line">  <span class="keyword">for</span> (auto s : state) &#123;</span><br><span class="line">    CType sum <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (int64_t i <span class="operator">=</span> <span class="number">0</span>; i <span class="operator">&lt;</span> length; i<span class="operator">+</span><span class="operator">+</span>) &#123;</span><br><span class="line">      sum <span class="operator">=</span> Op::<span class="keyword">call</span>(sum, <span class="keyword">values</span>[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    benchmark::DoNotOptimize(sum);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªä»£ç æ‰§è¡Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå¯ä»¥è¯´æ˜¯ Scalar Code:</p><p><img src="https://image.mwish.me/blog-image/4813239862219650588.png" alt="img"></p><p><img src="https://image.mwish.me/blog-image/7962189767674737933.png" alt="img"></p><p>è¿™é‡Œçš„ sequential op å¯¼è‡´æµæ°´çº¿å¹¶è¡Œæ²¡æœ‰è¢«å¾ˆå¥½çš„åˆ©ç”¨ä¸Šï¼Œéƒ½æ˜¯çº¿æ€§æ‰§è¡Œè¿™äº›ä»£ç ã€‚ä¸‹é¢è¿™é‡Œæä¾›äº† <code>unroll2</code> çš„å®ç°ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> ArrowType, <span class="keyword">typename</span> Op&gt;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">BenchmarkOp2</span><span class="params">(benchmark::State&amp; state)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">using</span> CType = <span class="keyword">typename</span> ArrowType::c_type;</span><br><span class="line">  <span class="keyword">auto</span> rand = random::<span class="built_in">RandomArrayGenerator</span>(kSeed);</span><br><span class="line">  <span class="keyword">auto</span> valueArray = std::static_pointer_cast&lt;NumericArray&lt;ArrowType&gt;&gt;(rand.<span class="built_in">Numeric</span>&lt;ArrowType&gt;(<span class="number">4096</span> * <span class="number">16</span>, <span class="number">0</span>, <span class="number">114514</span>));</span><br><span class="line">  <span class="type">int64_t</span> length = valueArray-&gt;<span class="built_in">length</span>();</span><br><span class="line">  <span class="keyword">auto</span> values = valueArray-&gt;<span class="built_in">raw_values</span>();</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">auto</span> s : state) &#123;</span><br><span class="line">    CType sum = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int64_t</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (; i &lt; length; i += <span class="number">2</span>) &#123;</span><br><span class="line">      sum = Op::<span class="built_in">call</span>(Op::<span class="built_in">call</span>(sum, values[i]), values[i + <span class="number">1</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (i &lt; length) &#123;</span><br><span class="line">      sum = Op::<span class="built_in">call</span>(sum, values[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    benchmark::<span class="built_in">DoNotOptimize</span>(sum);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„æ“ä½œç›¸å½“äºæŠŠåŸå…ˆå¾ªç¯ä¸­ä¸€æ¬¡æ”¹æˆäº†ä¸¤ä¸ª OPï¼Œé‚£ä¹ˆè¿™ä¸ªä¼šæ€ä¹ˆæ ·å‘¢ï¼Ÿç­”æ¡ˆæ˜¯æ²¡æ€ä¹ˆå˜åŒ–ã€‚</p><p><img src="https://image.mwish.me/blog-image/4911952986514956094.png" alt="img"></p><p>æ¥ä¸‹æ¥å±•ç¤º Separate Accumulators çš„ç‰ˆæœ¬ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> ArrowType, <span class="keyword">typename</span> Op&gt;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">BenchmarkOp2SA</span><span class="params">(benchmark::State&amp; state)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">using</span> CType = <span class="keyword">typename</span> ArrowType::c_type;</span><br><span class="line">  <span class="keyword">auto</span> rand = random::<span class="built_in">RandomArrayGenerator</span>(kSeed);</span><br><span class="line">  <span class="keyword">auto</span> valueArray = std::static_pointer_cast&lt;NumericArray&lt;ArrowType&gt;&gt;(rand.<span class="built_in">Numeric</span>&lt;ArrowType&gt;(<span class="number">4096</span> * <span class="number">16</span>, <span class="number">0</span>, <span class="number">114514</span>));</span><br><span class="line">  <span class="type">int64_t</span> length = valueArray-&gt;<span class="built_in">length</span>();</span><br><span class="line">  <span class="keyword">auto</span> values = valueArray-&gt;<span class="built_in">raw_values</span>();</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">auto</span> s : state) &#123;</span><br><span class="line">    CType sum0 = <span class="number">0</span>;</span><br><span class="line">    CType sum1 = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int64_t</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (; i &lt; length; i += <span class="number">2</span>) &#123;</span><br><span class="line">        sum0 = Op::<span class="built_in">call</span>(sum0, values[i]);</span><br><span class="line">        sum1 += Op::<span class="built_in">call</span>(sum1, values[i + <span class="number">1</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (i &lt; length) &#123;</span><br><span class="line">      sum0 = Op::<span class="built_in">call</span>(sum0, values[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    benchmark::<span class="built_in">DoNotOptimize</span>(Op::<span class="built_in">call</span>(sum0, sum1));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://image.mwish.me/blog-image/2057821884675391120.png" alt="img"></p><p>è¿™é‡Œå¯ä»¥å¾—åˆ°ä¸€å®šçš„æå‡ï¼Œä½†æ˜¯è‚¯å®šä¸ä¼šè¶…è¿‡æ€§èƒ½ä¸Šé™ã€‚æ­¤å¤–ï¼Œå¯¹äºæµ®ç‚¹æ•°æ¥è¯´ï¼Œè¿™æ ·çš„æ“ä½œå¯èƒ½ä¼š<strong>ç•¥å¾®å˜æ›´å¯¹åº”çš„ç»“æœ</strong>ã€‚</p><p>æœ¬è´¨ä¸Šï¼Œè¿™é‡Œå¯ä»¥ç®—å‡ºæ¥ä¸€ä¸ªå¹¶è¡Œåº¦ï¼Œç„¶åæ¥ä¼˜åŒ–å¯¹åº”çš„æ“ä½œï¼š</p><p><img src="https://image.mwish.me/blog-image/7144858499665429034.png" alt="img"></p><p>å½“ç„¶ï¼Œè¿™æ®µå…¶å®æ˜¯ä¸ªç†è®ºåˆ†æï¼ŒæŸç§ç¨‹åº¦ä¸Šæ„Ÿè§‰è‡³å°‘æˆ‘åœ¨ LLVM17 å¼€ O3 ç¼–è¯‘å™¨ä¼šå¸®å¿™åšå¾ˆå¤šäº‹æƒ…ï¼Œé™¤äº†æµ®ç‚¹æ•°éƒ½ä¼šä¼˜åŒ–åˆ°å·®ä¸å¤šçš„æ€§èƒ½ï¼Œæ„Ÿå…´è¶£çš„ä¹Ÿå¯ä»¥æ‹¿æˆ‘ä»¬ä¸Šé¢çš„ä»£ç å»è·‘ä¸€ä¸‹ï¼Œæ„Ÿå—ä¸€ä¸‹è¿™å—çš„å…·ä½“å†…å®¹ã€‚</p><h2 id="Parquet-BYTE-STREAM-SPLIT-åŠ é€Ÿ"><a href="#Parquet-BYTE-STREAM-SPLIT-åŠ é€Ÿ" class="headerlink" title="Parquet BYTE_STREAM_SPLIT åŠ é€Ÿ"></a>Parquet BYTE_STREAM_SPLIT åŠ é€Ÿ</h2><p>ä¸‹é¢è¿™é‡Œæˆ‘ä»¬å†ä»¥ BYTE_STREAM_SPLIT ä¸ºç±»å‹ï¼Œåˆ†æä¸€ä¸‹ Scalar ä»£ç æ€ä¹ˆæé€Ÿã€‚è¿™æ˜¯ Parquet æ ‡å‡†ä¸­ä¸€ç§æµ®ç‚¹ç±»å‹çš„æ— æŸæµ®ç‚¹ Encodingã€‚å®ƒè¦ç»“åˆå‹ç¼©æ¥ä½¿ç”¨ã€‚å®ƒçš„ç®—æ³•å¤§æ¦‚æ˜¯ï¼š</p><ul><li>å¯¹äº k Bytes çš„ n ä¸ªæµ®ç‚¹æ•°æ‹†æˆ k ä¸ª n bytes çš„ Stream</li><li>ç¬¬ä¸€ä¸ª k Bytes çš„æµ®ç‚¹æ•°ï¼Œå†…å®¹ç¬¬ä¸€ä½å†™åœ¨ç¬¬ä¸€ Byteï¼›ç¬¬äºŒä½å†™åœ¨ç¬¬äºŒä¸ª Stream çš„ç¬¬ä¸€ byte ï¼Œä»¥æ­¤ç±»æ¨</li></ul><p>å¦‚æœä½ è§‰å¾—ä¸Šé¢ä¸æ¸…æ™°ï¼Œå¯ä»¥ç›´æ¥çœ‹åŸæ–‡ï¼š<a href="https://github.com/apache/parquet-format/blob/master/Encodings.md#byte-stream-split-byte_stream_split--9">https://github.com/apache/parquet-format/blob/master/Encodings.md#byte-stream-split-byte_stream_split--9</a></p><p>è¿™å—åŸå…ˆçš„ä»£ç éå¸¸å¥½æ‡‚ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// Encoding: å¯¹äºæ¯ä¸ªæ•°å€¼ï¼Œç›´æ¥å†™ k ä¸ª Stream çš„ Byte</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ByteStreamSplitEncodeScalar</span><span class="params">(<span class="type">const</span> <span class="type">uint8_t</span>* raw_values, <span class="type">const</span> <span class="type">int64_t</span> num_values,</span></span></span><br><span class="line"><span class="params"><span class="function">                                 <span class="type">uint8_t</span>* output_buffer_raw)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constexpr</span> <span class="type">size_t</span> kNumStreams = <span class="built_in">sizeof</span>(T);</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0U</span>; i &lt; num_values; ++i) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> j = <span class="number">0U</span>; j &lt; kNumStreams; ++j) &#123;</span><br><span class="line">      <span class="type">const</span> <span class="type">uint8_t</span> byte_in_value = raw_values[i * kNumStreams + j];</span><br><span class="line">      output_buffer_raw[j * num_values + i] = byte_in_value;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// Encoding: å¯¹äºæ¯ä¸ªæ•°å€¼ï¼Œç›´æ¥ä» k ä¸ª Stream çš„ Byte ä¸­è¯»å–</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ByteStreamSplitDecodeScalar</span><span class="params">(<span class="type">const</span> <span class="type">uint8_t</span>* data, <span class="type">int64_t</span> num_values, <span class="type">int64_t</span> stride,</span></span></span><br><span class="line"><span class="params"><span class="function">                                 T* out)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constexpr</span> <span class="type">size_t</span> kNumStreams = <span class="built_in">sizeof</span>(T);</span><br><span class="line">  <span class="keyword">auto</span> output_buffer_raw = <span class="built_in">reinterpret_cast</span>&lt;<span class="type">uint8_t</span>*&gt;(out);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int64_t</span> i = <span class="number">0</span>; i &lt; num_values; ++i) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> b = <span class="number">0</span>; b &lt; kNumStreams; ++b) &#123;</span><br><span class="line">      <span class="type">const</span> <span class="type">size_t</span> byte_index = b * stride + i;</span><br><span class="line">      output_buffer_raw[i * kNumStreams + b] = data[byte_index];</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ®µä»£ç åœ¨ CPU ä¸Šå’Œå†…å­˜ä¸Šå…¶å®éƒ½å¹¶ä¸é«˜æ•ˆã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Epilog</span></span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> stream = <span class="number">0</span>; stream &lt; width; ++stream) &#123;</span><br><span class="line">  <span class="type">uint8_t</span>* dest = dest_streams[stream];</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int64_t</span> i = <span class="number">0</span>; i &lt; nvalues; ++i) &#123;</span><br><span class="line">    dest[i] = src[stream + i * width];</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Epilog</span></span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> stream = <span class="number">0</span>; stream &lt; width; ++stream) &#123;</span><br><span class="line">  <span class="type">const</span> <span class="type">uint8_t</span>* src = src_streams[stream];</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int64_t</span> i = <span class="number">0</span>; i &lt; nvalues; ++i) &#123;</span><br><span class="line">    dest[stream + i * width] = src[i];</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ–°çš„ç®—æ³•åœ¨æœ«ç«¯ä¼šè‡³å°‘ä»¥å•ä¸ª â€œSTREAMâ€ ä¸ºå•ä½å»è¯»å†™ï¼Œé¿å…ä¸€äº›é€ä¸ª Value è®¿é—® Stream çš„æ—¶å€™æŠŠ Cache æè¿›æ¥åˆæå‡ºå»</p><p>å½“ç„¶è¿™é‡Œä¸æ­¢æ˜¯è¿™å¥—é€»è¾‘ï¼Œè¿™é‡ŒæŠŠ Encoding çš„é€»è¾‘æ‹†æˆäº†ä¸‹é¢çš„é€»è¾‘ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Scalar implementations</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">DoSplitStreams</span><span class="params">(<span class="type">const</span> <span class="type">uint8_t</span>* src, <span class="type">int</span> width, <span class="type">int64_t</span> nvalues,</span></span></span><br><span class="line"><span class="params"><span class="function">                           <span class="type">uint8_t</span>** dest_streams)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// Value empirically chosen to provide the best performance on the author&#x27;s machine</span></span><br><span class="line">  <span class="keyword">constexpr</span> <span class="type">int</span> kBlockSize = <span class="number">32</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (nvalues &gt;= kBlockSize) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> stream = <span class="number">0</span>; stream &lt; width; ++stream) &#123;</span><br><span class="line">      <span class="type">uint8_t</span>* dest = dest_streams[stream];</span><br><span class="line">      <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; kBlockSize; i += <span class="number">8</span>) &#123;</span><br><span class="line">        <span class="type">uint64_t</span> a = src[stream + i * width];</span><br><span class="line">        <span class="type">uint64_t</span> b = src[stream + (i + <span class="number">1</span>) * width];</span><br><span class="line">        <span class="type">uint64_t</span> c = src[stream + (i + <span class="number">2</span>) * width];</span><br><span class="line">        <span class="type">uint64_t</span> d = src[stream + (i + <span class="number">3</span>) * width];</span><br><span class="line">        <span class="type">uint64_t</span> e = src[stream + (i + <span class="number">4</span>) * width];</span><br><span class="line">        <span class="type">uint64_t</span> f = src[stream + (i + <span class="number">5</span>) * width];</span><br><span class="line">        <span class="type">uint64_t</span> g = src[stream + (i + <span class="number">6</span>) * width];</span><br><span class="line">        <span class="type">uint64_t</span> h = src[stream + (i + <span class="number">7</span>) * width];</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> ARROW_LITTLE_ENDIAN</span></span><br><span class="line">        <span class="type">uint64_t</span> r = a | (b &lt;&lt; <span class="number">8</span>) | (c &lt;&lt; <span class="number">16</span>) | (d &lt;&lt; <span class="number">24</span>) | (e &lt;&lt; <span class="number">32</span>) | (f &lt;&lt; <span class="number">40</span>) |</span><br><span class="line">                     (g &lt;&lt; <span class="number">48</span>) | (h &lt;&lt; <span class="number">56</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">        <span class="type">uint64_t</span> r = (a &lt;&lt; <span class="number">56</span>) | (b &lt;&lt; <span class="number">48</span>) | (c &lt;&lt; <span class="number">40</span>) | (d &lt;&lt; <span class="number">32</span>) | (e &lt;&lt; <span class="number">24</span>) |</span><br><span class="line">                     (f &lt;&lt; <span class="number">16</span>) | (g &lt;&lt; <span class="number">8</span>) | h;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        arrow::util::<span class="built_in">SafeStore</span>(&amp;dest[i], r);</span><br><span class="line">      &#125;</span><br><span class="line">      dest_streams[stream] += kBlockSize;</span><br><span class="line">    &#125;</span><br><span class="line">    src += width * kBlockSize;</span><br><span class="line">    nvalues -= kBlockSize;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Epilog</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> stream = <span class="number">0</span>; stream &lt; width; ++stream) &#123;</span><br><span class="line">    <span class="type">uint8_t</span>* dest = dest_streams[stream];</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int64_t</span> i = <span class="number">0</span>; i &lt; nvalues; ++i) &#123;</span><br><span class="line">      dest[i] = src[stream + i * width];</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>å¯¹äºæ¯ä¸ª Blockï¼ŒBlock Size ä¼šæ˜¯ 8 çš„å€æ•°</li><li>Block å†…ï¼Œè¿™é‡Œä¼š 8 ä¸ªä¸€ç»„ï¼ŒæŠŠ 8 ä¸ªæµ®ç‚¹æ•°çš„ Byte å†™åˆ°ä¸€ä¸ª Stream é‡Œé¢</li></ul><p>è¿™é‡Œå°±æ˜¯æœ¬èŠ‚ä»‹ç»çš„æ“ä½œæ–¹å¼ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œæœ‰å‡ ä¸ª Trick:</p><ol><li>åˆ†ç¦»è®¿å­˜æ“ä½œå’Œ CPU æ“ä½œ</li><li>å¯¹äºåŒè´¨å¤§é‡è®¡ç®—ï¼Œé«˜æ•ˆçš„å¤„ç†æ‰€æœ‰å€¼</li></ol><h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><ol><li><a href="https://github.com/apache/arrow/pull/38529">https://github.com/apache/arrow/pull/38529</a></li><li>LLVM Auto-Vectorize <a href="https://llvm.org/docs/Vectorizers.html">https://llvm.org/docs/Vectorizers.html</a></li></ol>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>CIDR&#39;23: Analyzing and Comparing Lakehouse Storage Systems</title>
      <link href="/2023/11/05/CIDR-23-Analyzing-and-Comparing-Lakehouse-Storage-Systems/"/>
      <url>/2023/11/05/CIDR-23-Analyzing-and-Comparing-Lakehouse-Storage-Systems/</url>
      
        <content type="html"><![CDATA[<p>Analyzing and Comparing Lakehouse Storage Systems å‘å¸ƒäº CIDRâ€™23ã€‚ä½œè€…åŒ…æ‹¬äº† UCB, Stanfordï¼Œè¿˜æœ‰è‘—åçš„ Mesos / Spark çš„ä½œè€… Matei å’Œä»–çš„å¯¼å¸ˆ Ion Stoicaã€‚æœ¬æ–‡åˆ†æäº† DataBricksã€Hudiã€Iceberg å‡ å¤§ç³»ç»Ÿçš„å­˜å‚¨ï¼Œå¹¶ä¸”åˆ’åˆ†äº†ä¸‹é¢çš„å‡ ä¸ªé—®é¢˜ï¼š</p><ol><li>Coordinator transaction</li><li>Store metadata</li><li>Query Metadata</li><li>Handle Update (CoW, MoR. etcâ€¦)</li></ol><p>æ¯ä¸ªé—®é¢˜çš„é€‰æ‹©éƒ½ä¼šå¸¦æ¥ä¸€å®šçš„ trade-offï¼Œæœ¬æ–‡ä¹Ÿç”¨ LHBench ( <a href="https://github.com/lhbench/lhbench">https://github.com/lhbench/lhbench</a> ) æ¥å¯¹æ¯”äº†è¿™äº› Lakehouseã€‚</p><p>æˆ‘ä»¬ä¹‹å‰çš„åšå®¢å¯ä»¥è§ï¼š</p><ol><li><a href="https://blog.mwish.me/2023/03/19/Apache-Iceberg-and-changes-above-Hive/">https://blog.mwish.me/2023/03/19/Apache-Iceberg-and-changes-above-Hive/</a></li><li><a href="https://blog.mwish.me/2022/05/01/Delta-Lake-Lakehouse/">https://blog.mwish.me/2022/05/01/Delta-Lake-Lakehouse/</a></li></ol><p>æ ¹æ®æˆ‘ä»¬è‡ªå·±çš„ç†è§£å’Œè®ºæ–‡çš„ç†è§£ï¼ŒLakehouse è™½ç„¶äº§å“å®šä¹‰æ˜¯ä¸€ä¸ªå•†ä¸šæ¦‚å¿µï¼Œä½†æ˜¯æŠ€æœ¯ä¸Šï¼Œå®ƒæ€»çš„æ¥è¯´æ˜¯ä¸€ä¸ª Meta å±‚ â€” Storage å±‚çš„æ¦‚å¿µï¼ŒRaynold Xin æœ‰ä¸€ä¸ª Talk çš„ PPT åšçš„å¾ˆå¥½ï¼Œæˆ‘å°±ç›´æ¥æŠ å‡ºæ¥äº†ï¼š</p><p><img src="https://image.mwish.me/blog-image/9015916313194020933.png" alt="img"></p><p>è¿™é‡Œå¯ä»¥çœ‹åˆ°ï¼Œè™½ç„¶ Lakehouse æ˜¯ä¸ªå•†ä¸šæ¦‚å¿µï¼Œä½†æ˜¯è¿™äº›ç‚¹è¿˜æ˜¯æ¯”è¾ƒæ¸…æ™°çš„ï¼š</p><ol><li>ï¼ˆå¯¹å¤–ï¼‰ä¾èµ– Open Format å’Œæ¯”è¾ƒå®šä¹‰å¥½çš„å­˜å‚¨ï¼ˆæ¯”å¦‚ Object Storeï¼‰<ol><li>Object Store and Lakehouse: High latency</li><li>å¯¹å¤–: (weak) Consistency gurantee</li></ol></li><li>ä¸€å®šç¨‹åº¦ä¸Šçš„æ•°æ® / å…ƒæ•°æ®å¤„ç†. æ”¯æŒä¸€äº›ç®€å•çš„ ACID è¯­ä¹‰ï¼ˆè¿™å—çš„ ACID è¯­ä¹‰å…¶å®æ²¡æœ‰ä¼ ç»Ÿçš„å…³ç³»å‹æ•°æ®åº“å®šä¹‰çš„é‚£ä¹ˆæ¸…æ™°ï¼‰</li></ol><p>çŸ¥é“è¿™ä¸ªæ¦‚å¿µä¹‹åæˆ‘ä»¬å†æ¥çœ‹è¿™ç¯‡è®ºæ–‡æå‡ºçš„å‡ ä¸ªç‚¹ï¼š</p><ol><li>å¦‚ä½•åè°ƒäº‹åŠ¡ã€‚è¿™é‡Œæ¶‰åŠè¯»å†™ â€” å†™å†™çš„å…³ç³»ã€‚<ol><li>ä¸Šå±‚äº‹åŠ¡æ°¸è¿œä¸‹å±‚çš„ï¼ˆå¯¹è±¡ï¼‰å­˜å‚¨ï¼šæœ‰çš„åœ°æ–¹å¦‚æœè€ƒè™‘å†™ S3 æˆ–è€…å¯¹è±¡å­˜å‚¨å½“ä½œäº‹åŠ¡ï¼Œå¯èƒ½ä¼šè€ƒè™‘ä½¿ç”¨å¯¹è±¡å­˜å‚¨çš„ Put-if-absent è¯­ä¹‰ ï¼ˆæœ‰çš„ä¸æ”¯æŒçš„å¯èƒ½é¢å¤–ä¾èµ–ä¸€ä¸ªå¤–éƒ¨ç³»ç»Ÿï¼‰</li><li>ç”¨é¢å¤–çš„å­˜å‚¨ç³»ç»Ÿï¼Œæ¯”å¦‚åƒ Hive MetaStoreï¼ˆæˆ–è®¸è¿˜åŒ…æ‹¬ FDBï¼Ÿï¼‰. ç›¸å¯¹æ¥è¯´ï¼Œè¿™é‡Œæäº¤å»¶è¿Ÿï¼ˆä¸è€ƒè™‘ LISTï¼Œé‚£åˆæ˜¯å¦ä¸€ä¸ªé—®é¢˜äº†ï¼‰ä¼šä½ä¸€äº›ï¼Œä½†æœ¬èº«ä¹Ÿä¼šè¿™ä¸ªç³»ç»Ÿæœ‰ä¸€å®šçš„å½±å“</li></ol></li><li>å¦‚ä½•å­˜å‚¨ metadata. (For Pruning, etc.)<ol><li>æŠŠæ•°æ®å­˜åˆ°é¢å¤–çš„è¡¨ä¸Šï¼ˆGoogle Bigmeta?)</li><li>æ”¾åˆ° Transaction Log ä¸Š</li><li>æ”¾åˆ°é¢å¤–çš„æœåŠ¡å»ï¼ˆFDBï¼Ÿï¼‰</li></ol></li><li>å¦‚ä½•æŸ¥è¯¢ Metadata<ol><li>Delta Lake å’Œ Hudi å¯ä»¥ç”¨ç³»ç»Ÿçš„ Parallel Job æ¥æŸ¥è¯¢ Metadataï¼Œåœ¨å¤§è¡¨çš„æ—¶å€™å¹¶è¡Œ Planingï¼ŒåŠ é€Ÿï¼Œä½†è¿™ä¸ªå¯¹å°è¡¨æ¥è¯´å¯èƒ½ä¼šå¢å¤§ latency</li><li>Iceberg ç°åœ¨æ˜¯å•çº¿ç¨‹æŸ¥è¯¢</li><li>ï¼ˆä½†æˆ‘ç†è§£è¿™å‡ ä¸ªç‰¹ä¹ˆçš„éƒ½å¯ä»¥å¹¶è¡Œå§ï¼Œæ ‡å‡†åœ¨é‚£äººæ˜¯æ´»äººï¼‰</li></ol></li><li>å¦‚ä½•é«˜æ•ˆå¤„ç† Record çº§åˆ«çš„æ›´æ–°ã€‚è¿™é‡Œå› ä¸º Lakehouse æœ¬èº«å¤„ç†å¤§æ‰¹æ•°æ®ï¼Œæœ¬èº«æœ‰å¾ˆå¤šæ‰¹é‡åŠ è½½æ•°æ®çš„é€»è¾‘ï¼Œæ¯”å¦‚ SQL Merge è¿™ç§ã€‚ä¸åŒç³»ç»Ÿå¯èƒ½æœ‰ Copy-on-write æˆ–è€… Merge-on-read ç­‰æ–¹å¼</li></ol><p>è®ºæ–‡é‡Œé¢è¿˜æåˆ°ä¸€äº›æ¯”è¾ƒå¥½ç©çš„ä¸œè¥¿ï¼Œå¾ˆç¬¦åˆæˆ‘çš„ç›´è§‰</p><blockquote><p>On the one hand, organizations use lakehouse systems to ingest and organize very large datasetsâ€”for example, the largest Delta Lake tables span well into the hundreds of petabytes, consist of billions of files, and are updated with hundreds of terabytes of ingested data per day [21]. On the other hand, the data warehouse capabilities of lakehouse systems are encouraging organizations to load and manage smaller datasets in them too, in order to combine these with the latest data from their ingest pipelines and build a single management system for all data. For example, most of the CPU-hours on Databricks are used to process tables smaller than 1 TB, and query durations across all tables range from sub-second to hours.</p></blockquote><p>è®ºæ–‡ä¸­å¯¹ Lakehouse æ‹†åˆ†å‰–æå¦‚ä¸‹ï¼š</p><p><img src="https://image.mwish.me/blog-image/8009400306733372816.png" alt="img"></p><p>æ–‡ç« åé¢æœ‰ä¸€äº› benchmarkï¼Œä½†æˆ‘è§‰å¾—æ²¡å•¥æ„æ€ï¼Œå°±ä¸çœ‹äº†ï¼Œä½ å¦ˆçš„è¿™äº› benchmark æ¯”è¾ƒåœ¨åšè¿‡çš„äººçœ¼é‡Œå®Œå…¨æ²¡ä»»ä½•ä»·å€¼ã€‚</p><h2 id="Transaction-Coordination"><a href="#Transaction-Coordination" class="headerlink" title="Transaction Coordination"></a>Transaction Coordination</h2><ul><li>æ”¯æŒå•è¡¨äº‹åŠ¡ï¼Œä½†æ˜¯å¯¹å¤šæ ‡äº‹åŠ¡æ”¯æŒå¯èƒ½ä¸æ˜¯ç‰¹åˆ«å¥½ï¼ŒåŒäº‹äº‹åŠ¡æ”¯æŒçš„è¯­ä¹‰ä¸å®Œå…¨ç›¸åŒï¼ˆè§ Table1 çš„ Isolation Levelsï¼‰</li><li>Delta Lake ä½¿ç”¨å¯¹è±¡å­˜å‚¨çš„äº‹åŠ¡ã€‚å¯¹äº S3 è¿™ç§ä¸æ”¯æŒ conditional-write çš„ï¼ŒDelta Lake ä½¿ç”¨ Dynamo æ¥åšåè°ƒï¼ˆLance å’Œ arrow-rs çš„ object-store ä¹Ÿæ”¯æŒåŒæ ·çš„è¯­ä¹‰ï¼‰ã€‚æˆ‘ä¸ªäººè§‰å¾—ï¼Œè¿™å¥—æ–¹æ¡ˆçš„æœ¬è´¨æ˜¯ä¾èµ–äº‹åŠ¡æ€§ CAS Logging å’Œ Lakehouse æœ¬èº«çš„ä½æäº¤é¢‘ç‡ï¼ˆæˆ–è€…å³ä½¿æäº¤æ•°æ®å¤šï¼Œåœ¨ä»–ä»¬çš„åœºæ™¯ä¹Ÿå€¾å‘äºæ˜¯å¤§ SQLä½œä¸šæäº¤å¤§æ‰¹é‡æ•°æ®ï¼Œè€Œä¸æ˜¯TPçš„é«˜tpså°äº‹åŠ¡ï¼‰</li><li>Hudi/Iceberg HMS/Zk/Dynamo å®ç°çš„è¡¨é”ã€‚è®ºæ–‡å› ä¸ºæœ‰ Delta çš„äººï¼Œè¿˜å°å°çš„æŠ¹é»‘äº†ä¸€ä¸‹æåˆ°ä»–ä»¬æœ‰å› ä¸ºè¿™ä¸ªé€ æˆè„å†™çš„é—®é¢˜ï¼ˆHive: Fix concurrent transactions overwriting commits by adding hive lock heartbeats. <a href="https://github.com/apache/iceberg/pull/5036">https://github.com/apache/iceberg/pull/5036</a> )ã€‚ä½†æˆ‘è§‰å¾—å±äºåŠå°¬é»‘äº†ï¼Œæœ¬è´¨åŸå› è¿˜æ˜¯ä¾èµ–å¤–éƒ¨ç³»ç»Ÿåšä¸€ä¸ªå­˜å‚¨å±‚çš„ fencing æ˜¯æ¯”è¾ƒéš¾çš„ï¼Œé€€ä¸€ä¸‡æ­¥è¯´ï¼Œæˆ‘è§‰å¾—ä½  Delta ä¾èµ– Dynamo åœ¨ S3 ä¸Šæ“ä½œè¿˜æ¯”äººå®¶æœ‰ä¼˜è¶Šæ„Ÿäº†ä¹ˆã€‚å½“ç„¶ä¾èµ–å°‘ç¡®å®æ˜¯æœ‰ä¼˜åŠ¿çš„å°±æ˜¯äº†ï¼Œæœ¬è´¨ä¹Ÿæ˜¯ trade-offã€‚</li></ul><p>è¿™å‡ ä¸ªäº§å“æœ¬èº«éƒ½æ˜¯ç”¨ OCC çš„åè®®ï¼ˆinsite: å†²çªå¯èƒ½ä¼šæ¯”è¾ƒå°ï¼Ÿï¼‰ï¼Œä½†æ˜¯æä¾›äº†ä¸åŒçš„è¯­ä¹‰ï¼ˆåˆè¦å¼€å§‹å¹è‡ªå·±äº†ï¼‰ï¼š</p><ul><li>Iceberg å’Œ Hudi éƒ½ä¼šä¿è¯è¯»çš„æ—¶å€™æ¥è‡ª start snapshotï¼Œæäº¤çš„æ—¶å€™å’Œå·²ç»æäº¤çš„äº‹åŠ¡æ²¡æœ‰å†™å†™å†²çªï¼Œæ‰€ä»¥è¿™å—çš„éš”ç¦»çº§åˆ«æ˜¯ SI</li><li>Delta é»˜è®¤ä¼šä¿è¯ï¼ˆå½“ç„¶ Iceberg ä¹Ÿæœ‰è¿™ä¸ªèƒ½åŠ›ï¼‰æ›´æ–°çš„æ—¶å€™æ²¡æœ‰ SIä¼šé‡åˆ°çš„ anti-dependency ( <a href="https://blog.mwish.me/2020/11/14/%E4%BA%8B%E5%8A%A1-%E5%8D%8F%E8%AE%AE%E5%92%8C%E9%9A%94%E7%A6%BB/">https://blog.mwish.me/2020/11/14/%E4%BA%8B%E5%8A%A1-%E5%8D%8F%E8%AE%AE%E5%92%8C%E9%9A%94%E7%A6%BB/</a> æ¯”å¦‚åªå‰©ä¸€ä¸ªç”¨æˆ·ï¼Œç„¶åä¸¤ä¸ªäº‹åŠ¡éƒ½æ˜¯ `IF(exist) then -1 and â€¦`` è¿™ç§ï¼Œç”¨è¿™ç§æ–¹å¼æ¥æ”¯æŒ Serializableï¼ˆå½“ç„¶è¿™å—è¯»å¯èƒ½ä¸å®Œå…¨æŒ‰ç…§å®šä¹‰ï¼Œä¸€ä¸ªè¯»ä»ç„¶å¯èƒ½è¯»åˆ°ä¸æ»¡è¶³æ—¶åºçš„æ•°æ®ï¼‰ã€‚Delta ç”šè‡³å¯ä»¥å¼€å¯è¯»çš„æ—¶å€™ä¹Ÿåšæ£€æŸ¥çš„é™åˆ¶ï¼Œæ¥è¾¾åˆ° Strict Serializable</li></ul><h2 id="Metadata-Management"><a href="#Metadata-Management" class="headerlink" title="Metadata Management"></a>Metadata Management</h2><p>S3 ä¹‹ç±»çš„ LIST æœ¬èº«é™åˆ¶ 1000 ä¸ªæ–‡ä»¶ï¼ŒLIST ä¸€ä¸ªå¤§ç›®å½•å»¶è¿Ÿé«˜ï¼Œå¯èƒ½è¿˜è¦æ‰‹å†™å¾ªç¯æˆ–è€…é€’å½’ï¼Œè¿˜æ˜¯æ¯”è¾ƒèœçš„ã€‚ä¸ºäº†çªç ´è¿™ç§é™åˆ¶ï¼Œå‡ ä¸ª Lakehouse éƒ½æ”¯æŒæŠŠ Metadata å¤–å­˜ï¼Œè®ºæ–‡è¿™é‡ŒæŠŠå¤–å­˜åˆ†æˆäº† Tabular å’Œ Hierachical ä¸¤ç§æ–¹å¼ï¼š</p><ul><li>Delta Lake å’Œ Hudi æŠŠå…ƒæ•°æ®å­˜å‚¨åœ¨ metadata tableï¼ˆHudiï¼‰ ï¼Œ Transaction Log Checkpointï¼ˆDelta å­˜å‚¨ JSON / Parquet ï¼‰ã€‚è¿™ä¸¤ç§ç³»ç»Ÿå…ƒæ•°æ®æäº¤æ˜¯ç›´æ¥å†™æ—¥å¿—ç„¶åå‘¨æœŸæ€§ Merge-On-Read åˆå¹¶åˆ°è¡¨ä¸­ï¼ˆæœ¬è´¨ä¸Šæœ‰ç‚¹åƒ Lakehouse æä» CDC ä¸­å¯¼å…¥æ•°æ®çš„ Patternï¼Ÿï¼‰</li><li>Iceberg ç›´æ¥å­˜æˆå±‚æ¬¡çš„æ–‡ä»¶</li></ul><h2 id="Data-Update-Strategies"><a href="#Data-Update-Strategies" class="headerlink" title="Data Update Strategies"></a>Data Update Strategies</h2><p>åˆ†ä¸º COW å’Œ MORã€‚ä½†æ˜¯æ ¹æ®æˆ‘ä¸ªäººçš„è§‚å¯Ÿï¼Œæ¯”è¾ƒå›°éš¾çš„å…¶å®è¿˜æ˜¯æ›´æ–° / å®½è¡¨æ›´æ–°å•åˆ— è¿™ç±»çš„å¤„ç†ï¼Œæœ‰çš„åœ°æ–¹å¯èƒ½ä¼šå†™ opLogï¼Œæœ‰çš„åœ°æ–¹ä¼šäº§ç”Ÿä¸€ä¸ª Primary Key ç„¶åè¦†ç›– PKï¼Œæœ‰çš„åœ°æ–¹ä¼šæ›´æ–°å®½è¡¨çš„æ—¶å€™ CoW å•åˆ—ã€‚ </p><h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ol><li><a href="https://www.montecarlodata.com/impact-2021-the-data-lakehouse/">https://www.montecarlodata.com/impact-2021-the-data-lakehouse/</a> Reynold Xin åœ¨ 21 å¹´çš„ Talkã€‚æˆ‘è§‰å¾—å…ˆçœ‹è¿™ä¸ªå†çœ‹ VLDBçš„ LakeHouse Paper æ¯”è¾ƒå¥½ï¼Œæ¯•ç«Ÿä¸»åˆ›è‡ªå·±çš„æ„æ€è‚¯å®šæ›´æ¸…æ™°ä¸€äº›</li></ol>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>SIGMOD&#39;14: Morsel-Driven Parallelism</title>
      <link href="/2023/11/03/SIGMOD-14-Morsel-Driven-Parallelism/"/>
      <url>/2023/11/03/SIGMOD-14-Morsel-Driven-Parallelism/</url>
      
        <content type="html"><![CDATA[<p>æœ¬æ–‡ç”± TUM å‘è¡¨äº SIGMODâ€™14. åœ¨å‰ä¸€ç¯‡æ–‡ç« ä¸­æåˆ°ï¼ŒVLDBâ€™11 çš„æ—¶å€™ï¼ŒTUM å¼•å…¥äº† LLVM Codegen å’Œ Data Centric çš„ Push-based Executionã€‚åœ¨é‚£ç¯‡æ–‡ç« ä¸­ï¼Œä»‹ç»çš„æ˜¯ä»ä¸€ä¸ª Volcano Model è½¬åŒ–æˆä¸€ä¸ª Push-based exec çš„ Planï¼Œå¹¶æ²¡æœ‰ä»‹ç»æ€ä¹ˆåœ¨é‡Œé¢å¤„ç†å¹¶å‘ï¼Œç”Ÿæˆçš„ä¸œè¥¿å¯ä»¥ç†è§£æˆæ˜¯ä¸²è¡Œæ‰§è¡Œçš„</p><p>æœ¬è®ºæ–‡å¯ä»¥è§†ä½œä¸Šä¸€ç¯‡è®ºæ–‡çš„åç»­ï¼Œå³åœ¨ â€œdata centricâ€ çš„æ‰§è¡Œä¸‹ï¼Œæ€ä¹ˆå»æ ¹æ®æ•°æ®æ¥åšæŸ¥è¯¢åˆ‡åˆ†/å¹¶å‘ã€‚åœ¨è¿™å¥—æ¶æ„ä¸‹ï¼Œæ•°æ®è¢«åˆ‡åˆ†æˆ Morsel ç„¶åè¢« CPU çº¿ç¨‹è°ƒåº¦æ‰§è¡Œï¼ˆè®ºæ–‡å…¶å®æ²¡é‚£ä¹ˆç»†ä»‹ç» TableScan?ï¼‰ã€‚æ­¤å¤–ï¼Œæ–‡ç« ä¹Ÿè€ƒè™‘äº†ä¸€äº›ç°ä»£ CPU çš„ç‰¹æ€§ï¼Œæ¯”å¦‚ NUMAã€‚Morsel å› ä¸ºæ˜¯data-centric çš„ï¼Œæ‰€ä»¥æ‰§è¡Œè¿™ç‚¹è¿˜æ¯”è¾ƒè‡ªç„¶ï¼ˆå®é™…ä¸ŠæŸç§æ„ä¹‰ä¸Šè¯´ï¼Œtp æ•°æ®åº“å¾ˆå¤šåœ°æ–¹æ²¡ TPC ä¹‹ç±»çš„ä¸œè¥¿è¿˜ä¸å¤ªå¥½åšï¼‰ã€‚è¿™é‡Œå…è®¸æŠŠè¾“å…¥æ•°æ®åˆ‡åˆ†æˆ Morselsï¼Œæ ¹æ®æœºå™¨çš„æ‰§è¡ŒçŠ¶å†µæ¥å®šä¹‰ DOP (degree of parallelismï¼‰è€Œä¸ç”¨åœ¨ Plan ä¹‹ç±»çš„åœ°æ–¹å†™æ­»ï¼Œç”± Runtime æ¥åšåŠ¨æ€çš„è°ƒåº¦ç”šè‡³å˜æ›´æ‰§è¡ŒæœŸçš„ DOPï¼ˆå½“ç„¶ï¼Œå¯èƒ½æœ‰ä¸€äº› colocate-join ä¹‹ç±»çš„ä¸çŸ¥é“è¦ä¸è¦ç‰¹æ®Šå¤„ç†ï¼‰ã€‚</p><p>åœ¨æ–°ç¡¬ä»¶ä¸Šï¼Œæœ¬æ–‡è€ƒè™‘äº†æ–°çš„ NUMA ç¡¬ä»¶ã€‚NUMA å¯èƒ½ä¼šæœ‰å¤šä¸ªä¸å¯¹ç­‰çš„ Memory Controllerï¼Œæ–‡ç« çš„ Point å¾ˆæœ‰æ„æ€ï¼š(è¿™é‡Œè€ƒè™‘çš„ä¸»è¦æ˜¯ locality éƒ¨åˆ†ï¼‰</p><blockquote><p>In essence, the computer has become a network in itself as the access costs of data items varies depending on which chip the data and the accessing thread are located. Therefore, many-core parallelization needs to take RAM and cache hierarchies into account. In particular, the NUMA division of the RAM has to be considered carefully to ensure that threads work (mostly) on NUMA-local data.</p></blockquote><p>åœ¨ä¸€èˆ¬æ•°æ®åº“ä¸­ï¼Œç®—å­å†…éƒ¨çš„å¹¶è¡Œå¯èƒ½éœ€è¦ä¸€ä¸ª Exchange Operator æ¥åˆ‡åˆ†è®¡ç®—ï¼Œå¹¶éœ€è¦ä¸€ä¸ª Optimizer æˆ–è€…ä»€ä¹ˆé˜¶æ®µå®šæ­»çš„ã€‚è¿™ç¯‡è®ºæ–‡ç§°å…¶ä¸º plan-driven çš„å¹¶å‘è°ƒåº¦ã€‚è€Œç›¸å¯¹çš„ï¼Œæœ¬æ–‡æå‡ºäº†ä¸€ç§ Morsel Driven çš„è°ƒåº¦ï¼Œä¸‹å›¾æ˜¯ä¸‰ä¸ª Join æ‰§è¡Œçš„æƒ…å†µï¼š</p><p><img src="https://image.mwish.me/blog-image/8319243476576150900.png" alt="img"></p><p>åœ¨è¿™ä¸ªç³»ç»Ÿä¸Šï¼Œçº¿ç¨‹<strong>å›ºå®šæ•°é‡å¹¶ç»‘æ ¸</strong>ã€‚</p><p>Morsel Driven çš„è°ƒåº¦ç›¸å¯¹æ¥è¯´éœ€è¦ä¸€ä¸ªåŠå…¨å±€çš„çŠ¶æ€ï¼Œæ•°æ®ä»è¾“å…¥æ‹¿åˆ°ä¸€ä»½å†…å­˜ï¼Œç„¶åä¸¢ç»™è¾“å‡ºçš„ Bufferã€‚è™½ç„¶è¿™é‡Œæ˜¯å…¨å±€çš„çŠ¶æ€(ä¹Ÿå…è®¸ work-stealing)ï¼Œä½†æ˜¯æœ¬èº«æ¥è¯´å› ä¸ºè°ƒåº¦ä¼šè€ƒè™‘ localityï¼Œæ‰€ä»¥è®¤ä¸ºè¿™å—çš„ locality ç›¸å½“å¥½ã€‚å½“ç„¶è¿™é‡Œ Operator çš„å®ç°ä¹Ÿè¦è¿›è¡Œä¸€äº›æ”¹é€ æ¥é€‚é… Morselã€‚</p><p>æœ¬è®ºæ–‡çš„å†…å®¹å¤§æ¦‚åŒ…æ‹¬ï¼š</p><ol><li>Morsel-driven çš„æŸ¥è¯¢æ‰§è¡Œæ¡†æ¶</li><li>é€‚é… Morsel æ‰§è¡Œæ¡†æ¶çš„å¹¶è¡Œç®—å­å®ç°</li><li>NUMA ç‰¹æ€§çš„åˆ©ç”¨æ¢è®¨</li></ol><h2 id="Morsel-Driven-Execution"><a href="#Morsel-Driven-Execution" class="headerlink" title="Morsel-Driven Execution"></a>Morsel-Driven Execution</h2><p>Figure2 å±•ç¤ºäº†ä¸€ä¸ªå¤šè¡¨è¯»å– -&gt; Join çš„æ‰§è¡Œæµç¨‹ï¼š</p><p><img src="https://image.mwish.me/blog-image/4704972240403201565.png" alt="img"></p><p>æ‰§è¡Œæ–¹å¼åœ¨å‰ä¸€ç¯‡è®ºæ–‡é‡Œæåˆ°ï¼Œè¿™é‡Œä¸å†èµ˜è¿°ï¼ˆå€¼å¾—ä¸€æçš„æ˜¯ï¼ŒHyPer è¿™é‡Œä¹Ÿä½¿ç”¨äº† vectorize çš„ç­–ç•¥ï¼‰</p><p>è®ºæ–‡å¼•å…¥äº†ç»„ä»¶ QEProject (Query Engine Project?)ï¼ŒæŠŠ Pipeline è½¬åŒ–ä¸º dispatcher (ç”¨ Velox ç±»ä¼¼çš„è¯è¯´ï¼Œæ˜¯åˆ†ç»™ä¸åŒçš„ Driver æ¥æ‰§è¡Œï¼Ÿï¼‰åœ¨è®ºæ–‡çš„æ‰§è¡Œä¸­ï¼š</p><ol><li>Probe åªæœ‰åœ¨ build å®Œæˆä¹‹åæ‰èƒ½å¼€å§‹æ‰§è¡Œã€‚</li><li>æ¯ä¸ª Pipeline é‡Œé¢ QEProject ä¼šåˆ‡åˆ†ç­‰å¤§çš„è¾“å…¥ï¼Œå½“ç„¶è¿™ä¸ªå¯èƒ½é€ æˆè¾“å‡ºå¤§å°ä¸ç­‰å¤§ã€‚</li><li>Dop çš„ä¸Šé™å—ç³»ç»Ÿçº¿ç¨‹çš„é™åˆ¶æ¥é˜²æ­¢å¯¹åº”çš„æŠ¢å ã€‚</li></ol><p><img src="https://image.mwish.me/blog-image/2837544159723451720.png" alt="img"></p><p>è¿™é‡Œåœ¨ Scan çš„æ—¶å€™ä¼šç›¸å½“äºæœ‰ä¸€ä¸ªæŠ¢å ï¼Œæ­¤å¤–æˆ‘ä»¬å†çœ‹ Figure 3ï¼Œè€ƒè™‘åˆ°æœ¬æ–‡è¿™é‡Œå› ä¸ºå¹¶å‘ï¼Œé‚£ä¹ˆ hash build çš„æ—¶å€™ï¼Œå¦‚æœç”± Scan çº¿ç¨‹ç›´æ¥æ’å…¥çš„è¯ï¼Œè¿™é‡Œä¼šæœ‰ä¸€éƒ¨åˆ†çš„å†…å­˜çš„é—®é¢˜ï¼šè¯»å†™å…±äº«åŒºåŸŸï¼Œç”šè‡³æ˜¯ Hash Table çš„æ‰©å®¹ã€‚äºæ˜¯è¿™éƒ¨åˆ†ä¼šæŠŠ Scan-&gt;Build åˆ†æˆä¸¤ä¸ªé˜¶æ®µï¼š</p><ol><li>åœ¨ Scan é˜¶æ®µï¼Œæ•°æ®ä»æ•°æ®æº fetch å‡ºæ¥ç„¶åæŠŠ Filter ä¹‹åçš„æ•°æ®<strong>æ¨åˆ° NUMA-Aware çš„å­˜å‚¨åŒºåŸŸï¼ˆåœ¨æŸä¸ª NUMA ä¸­æ¥é¿å…è¿‡å¤šçš„åŒæ­¥ã€æŠ¢å å¼€é”€ï¼‰</strong>ã€‚å¦‚ä¸Šå›¾çš„ Storage Area æ‰€ç¤ºã€‚è¿™ç§æƒ…å†µä¸‹å¦‚æœæœ‰ skew çš„è¯ï¼Œéœ€è¦ç»§ç»­è°ƒåº¦ï¼ˆåœ¨ DOP å°äºåˆ‡åˆ†çš„æƒ…å†µä¸‹ï¼‰ï¼Œå¦‚çº¢è‰²æ‰§è¡Œæµæ‰€ç¤ºã€‚</li><li>ç­‰ Scan -&gt; Filter å®Œæˆåï¼Œè¿™é‡Œä¼šåˆ‡æ¢åˆ° Hash Build Phaseã€‚å› ä¸º Scan å·²ç»å®Œæˆï¼ˆå¹¶ Stagingï¼‰ï¼Œè¿™é‡Œä¼šé¢„å…ˆç”³è¯·å¥½ Hash Tableã€‚è¿™é‡Œä¼šå®Œæˆå¹¶å‘æ’å…¥çš„æµç¨‹ã€‚æ­¤å¤–å› ä¸ºä¼šæœ‰å¹¶å‘æ’å…¥ï¼Œæ‰€ä»¥ TUM ä½œè€…æŠŠè¿™ä¸ª Hash Table å¼„æˆ Lock-free çš„äº†ã€‚åæ–‡æœ‰ä»‹ç» HashTable çš„å®ç°</li></ol><p>åœ¨ä¸¤ä¸ª Scan éƒ½å¤Ÿæ—©æ™š Hash Table ä¹‹åï¼Œè¿™é‡Œå°±ä¼šæ„å»º Probe Pipelineã€‚</p><p><img src="https://image.mwish.me/blog-image/1842822139066825291.png" alt="img"></p><p>ç›¸å¯¹ volcano, è¿™äº›æ‰§è¡Œçº¿ç¨‹å¯èƒ½ä¸ç”¨é¢„å…ˆåˆ†é… dopï¼Œä½†æ˜¯éœ€è¦åŒæ­¥è¯»å†™ä¸€äº›å…¨å±€çš„ï¼ˆæˆ–è€… numa æœ‰å…³çš„ï¼‰çŠ¶æ€ä¿¡æ¯ï¼Œå› ä¸ºè¿™ç‚¹ï¼Œæ‰€ä»¥çŠ¶æ€å¤„ç†å˜å¾—å¾ˆé‡è¦ã€‚</p><h2 id="Dispatcher-Scheduling-Parallel-Pipeline-Tasks"><a href="#Dispatcher-Scheduling-Parallel-Pipeline-Tasks" class="headerlink" title="Dispatcher: Scheduling Parallel Pipeline Tasks"></a>Dispatcher: Scheduling Parallel Pipeline Tasks</h2><p>å¦‚å‰æ–‡æ‰€è¯´ï¼ŒHyPer Pipeline è°ƒåº¦çš„æ—¶å€™é‡‡ç”¨äº† TPC æ¨¡å‹ã€‚é‚£ä¹ˆåœ¨è°ƒåº¦çš„æ—¶å€™ï¼Œè‡ªå·±è¿™ä¸ªä»»åŠ¡ Morsel æ‰§è¡Œå®Œäº†ï¼ˆMorsel Boundaryï¼‰å¯èƒ½å°±è¦å¤„ç†åˆ«çš„ä»£ç äº†ã€‚è¿™é‡Œçš„ Dispatcher å¹¶ä¸æ˜¯ä¸€ä¸ªçº¿ç¨‹ï¼Œè€Œæ˜¯ä¸€ä¸ªé€»è¾‘çš„æ¦‚å¿µã€‚</p><p>è¿™é‡Œå®ƒé¢„æœŸçš„ç›®æ ‡æ˜¯ï¼š</p><ol><li>æœ‰ä¸€å®šçš„ Localityï¼ŒæŠŠä»»åŠ¡<strong>å°½é‡åˆ†é…</strong>ç»™æœ¬æ ¸å¿ƒ</li><li>èƒ½æŠŠçº¿ç¨‹èµ„æºå°½é‡è·‘æ»¡ï¼ˆè¿™é‡Œåº”è¯¥æ²¡æœ‰ Latency ç›¸å…³çš„ï¼Œå› æ­¤åº”è¯¥è€ƒè™‘ Bandwidth æˆ–è€…æœ¬æ–‡è¯´çš„å¹¶å‘åº¦å°±è¡Œï¼Ÿä¸è¿‡åæ–‡ä¹Ÿæœ‰ä»‹ç»ä¸€äº›ä¼˜å…ˆçº§è°ƒåº¦æœ‰å…³çš„ä¸œè¥¿ã€‚ï¼‰</li><li>åœ¨ Locality çš„æƒ…å†µä¸‹ï¼Œé¿å…è¿‡åº¦ Skewã€‚</li></ol><p>ä¸‹å›¾æ˜¯ Dispatcher çš„é€»è¾‘æ¦‚å¿µå›¾ã€‚å¯ä»¥çœ‹åˆ°ï¼š</p><ol><li>Dispatcher ç»´æŠ¤äº†é€»è¾‘çš„ (Pending) Pipeline Job å’Œå¯¹åº” Pipeline Job ä¸Šçš„ <Core, Morsel>ã€‚åŒæ—¶è¿™é‡ŒæŒ‚çš„æ˜¯èƒ½å¤Ÿæ‰§è¡Œçš„ï¼ˆ.i.e Build å®Œä¹‹å‰ Probe çš„ä»»åŠ¡ä¸èƒ½æŒ‚ä¸Šå»ï¼‰</li><li>è¿™ä¸ªæ¡†æ¶ä¹Ÿèƒ½åŒ…å« Intra-query å¹¶è¡Œï¼Œæ¯”å¦‚ä¾‹å­ä¸­ä¸¤ä¸ª Hash Build çš„ Scan éƒ½èƒ½å¤Ÿè¢«åŠ å…¥è¿™ä¸ªé˜Ÿåˆ—ã€‚<ol><li>ä½œè€…è®¤ä¸ºè¿™å—å…¶å®ç”¨å¤„ä¸æ˜¯å¾ˆå¤§ã€‚å› ä¸ºè¿™æ ·ä¼°æ‘¸ç€ä½ æœ¬èº«å¼‚æ„çš„ä»»åŠ¡ä¹Ÿä¸æ˜¯å¾ˆå¤šï¼Œå¤§å®¶ä¸åŒçš„è¯ï¼Œæ‰§è¡Œèµ·æ¥ä¹Ÿæ¯”è¾ƒå®¹æ˜“ skewï¼ŒåŒæ—¶è¿™é‡Œè¿˜ä¼šå½±å“ cache (æˆ‘è§‰å¾—å³å½±å“ icache ä¹Ÿå½±å“ dcache)ã€‚æ‰€ä»¥æ„Ÿè§‰è¿™ä¸ªä½œç”¨ä¸æ˜¯ç‰¹åˆ«å¤§ã€‚</li></ol></li></ol><p><img src="https://image.mwish.me/blog-image/1251129381962944340.png" alt="img"></p><p>åœ¨è®ºæ–‡å†™ä½œæ—¶ï¼ŒHyPer å¹¶æ²¡æœ‰ä»€ä¹ˆå†…éƒ¨ä¼˜å…ˆçº§çš„æ¦‚å¿µï¼Œæ¯ä¸ªæŸ¥è¯¢ä¼˜å…ˆçº§ç›¸åŒã€‚ï¼ˆä»–ä»¬è¯´ Priority å½“æ—¶å·²ç»åœ¨å¼€å‘äº†ï¼Œæ„Ÿè§‰è¿™å¥—ä¹Ÿå·²ç»æ˜¯æ¯”è¾ƒæˆç†Ÿçš„ä¸œè¥¿äº†ï¼‰ã€‚æ¯ä¸ª NUMA è¿™é‡Œä¹Ÿä¼šæœ‰ç›¸å…³çš„ List ï¼Œæ¥ååŠ©è°ƒåº¦ã€‚å½“æœ¬ core æ²¡å•¥ Morsel çš„æ—¶å€™ï¼Œè¿™ä¹Ÿä¼šåšæˆ work-stealing çš„ï¼ˆä½œè€…è®¤ä¸ºè¿™å—éå¸¸ä¸é¢‘ç¹ï¼‰ï¼Œwork-stealing ä¹‹åï¼Œæ•°æ®ä¸¢åœ¨æ‰§è¡Œçº¿ç¨‹çš„ Core ä¸Šã€‚</p><p>Dispatcher è¿™ä¸œè¥¿å®ç°æˆé¢å¤–çº¿ç¨‹ä¹Ÿä¸å¥½ï¼Œæ‰€ä»¥ Dispatcher å®é™…ä¸Šæ˜¯ä¸€å¥—é™æ€çš„ codeï¼Œç”± worker thread åœ¨ Morsel Boundary æ‰§è¡Œã€‚è¿™é‡Œè¿˜å…è®¸ query cancelingï¼Œå› ä¸º dispatcher æ˜¯ä¸ªå…¨å±€çŠ¶æ€ï¼Œåœ¨å…¨å±€çŠ¶æ€è®¾ç½®å°±ç‰¹ä¹ˆè¡Œäº†ã€‚</p><h3 id="Morsel-Size"><a href="#Morsel-Size" class="headerlink" title="Morsel Size"></a>Morsel Size</h3><p>è®ºæ–‡æåˆ°äº†ä¸ªå¾ˆå¥½ç©çš„ä¸œè¥¿ï¼š</p><blockquote><p>there is no performance penalty if a morsel does not fit into cache.</p></blockquote><p>Morsel åªæ˜¯è®ºæ–‡æ‹†åˆ†ä»»åŠ¡çš„å•å…ƒï¼Œå’Œ Vectorize Batch Size æœ‰å…³ä½†å¹¶ä¸ç»å¯¹ç›¸å…³ï¼Œä¸€ä¸ª Morsel ç”šè‡³å¯ä»¥åˆ†æˆå¤šä¸ª Batch æ¥æ‰§è¡Œå¹¶å¤§äº Cache-Sizeã€‚æ‰€ä»¥ Morsel å¤§å°å°±å˜æˆäº†è°ƒåº¦çš„å•å…ƒï¼ˆå½“ç„¶æ½œå°è¯æ˜¯ Morsel è‚¯å®šè¦ä¸æ¯” Vectorize Batch å°ï¼Œå“ˆå“ˆâ€¦ï¼‰ï¼š</p><ol><li>Morsel å°ä¼šå¯¼è‡´å¤šæ¬¡è°ƒåº¦ï¼Œå½±å“å…¨å±€è°ƒåº¦å™¨ï¼Œå¢åŠ åŒæ­¥æ¬¡æ•°</li><li>Morsel å¤§ä¼šå¯¼è‡´ skew</li></ol><p><img src="https://image.mwish.me/blog-image/1572924691635908096.png" alt="img"></p><h2 id="Parallel-Operator-Details"><a href="#Parallel-Operator-Details" class="headerlink" title="Parallel Operator Details"></a>Parallel Operator Details</h2><p>å¦‚æœéœ€è¦åœ¨ Morsel ä¸Šé«˜æ•ˆæ‰§è¡Œï¼Œé‚£ä¹ˆ Operator æœ¬èº«ä¹Ÿéœ€è¦æ˜¯ä¸€ä¸ªé«˜æ•ˆçš„å¹¶å‘æ‰§è¡Œç®—å­ï¼Œå®ƒä¹Ÿè¦èƒ½æ¥æ”¶ Batch çš„æ•°æ®ã€‚è®ºæ–‡ä»‹ç»äº† Hash Join / Partition (Scan) / Grouping / Agg / Sorting çš„å¯¹åº”çš„å®ç°ã€‚è¿™äº›å®ç°å¯èƒ½æ˜¯äº’ç›¸ç›¸å…³çš„ï¼Œæ¯”å¦‚ Hash Join æœ¬èº«å¯èƒ½å’Œ Partition ä¼šæœ‰å…³ç³»ï¼ˆä¸€äº›è¡Œä¸ºä¾èµ– Scan æä¾› Join çš„ä¸¤è¡¨çš„æ€§è´¨ï¼‰ï¼Œä¼šæ ¹æ®åˆ‡åˆ†æ¥é«˜æ•ˆçš„æ¨è¿› Scanã€‚</p><h3 id="Hash-Join"><a href="#Hash-Join" class="headerlink" title="Hash Join"></a>Hash Join</h3><p><img src="https://image.mwish.me/blog-image/1663940936737561721.png" alt="img"></p><p>è¿™é‡Œ Hash Join æœ‰å‡ ä¸ª Point:</p><ol><li>å¯¹äºå“ˆå¸Œè¡¨ï¼Œç”¨äº†åˆ†ç¦»é“¾æ¥çš„æ–¹å¼æ¥åš lock-free hashingã€‚å› ä¸ºé¢„å…ˆçŸ¥é“å¤§å°ï¼Œæ‰€ä»¥èƒ½åšæ¯”è¾ƒå¥½çš„ hashã€‚<ol><li>åˆ©ç”¨äº†æŒ‡é’ˆ 48bits çš„ trickã€‚æŒ‡é’ˆå­˜ç€ä¸€ä¸ª<strong>ç±»ä¼¼ 1bit çš„ Bloom Filter</strong> çš„ä¸œè¥¿ï¼Œæ¥åšä¸€ä¸ªå¿«é€Ÿ filteringã€‚</li><li>ä½œè€…è®¤ä¸ºè¿™ç§æ–¹å¼ç›¸å¯¹ radix Join æ¥è¯´æœ‰ç€ä¸é”™çš„ cache locality</li></ol></li><li>è¿™é‡Œä½¿ç”¨ 2M çš„ Page æ¥åšå“ˆå¸Œè¡¨ã€‚è¿™é‡Œä½œè€…è®¤ä¸ºï¼Œç”³è¯·å¤§é¡µä¹‹åï¼Œè¿™é‡Œä¼šç”±ç¬¬ä¸€ä¸ªæ’å…¥çš„çº¿ç¨‹è§¦å‘çœŸå®çš„å†…å­˜åˆ†é…ï¼Œè¿™ä¸ªæ—¶å€™ï¼ŒNUMA é¡µé¢ä¼šæœ‰ä¸€å®šçš„äº²å’Œåº¦ã€‚ä¹‹åæ’å…¥å¯èƒ½ä¹Ÿæ˜¯è¿™ä¸ªçº¿ç¨‹<ol><li>ç¬”è€…è®¤ä¸ºï¼Œå…‰çœ‹è¿™ä¸€æ®µæ¯”è¾ƒç‰µå¼ºï¼Œä½†æ˜¯å¦‚æœæ•°æ®æœ‰å¾ˆå¥½çš„ Hash Partition ç‰¹æ€§ï¼Œè€Œä¸”å’Œå“ˆå¸Œè¡¨å“ˆå¸Œæ–¹å¼å¯¹é½çš„è¯ï¼Œå¯èƒ½ä¼šæœ‰ä¸€å®šçš„ localityï¼Œåé¢æ–‡ç« ä¹Ÿæåˆ°äº†æ•°æ®çš„ Partitionã€‚è€Œåœ¨è¯»é˜¶æ®µï¼Œå› ä¸ºæ˜¯åªè¯»çš„ï¼Œæ‰€ä»¥å“ˆå¸Œè¡¨åœ¨ l2 cache é‡Œå°±å¯ä»¥ä¿è¯ä¸€å®šçš„é«˜æ€§èƒ½ã€‚</li></ol></li></ol><blockquote><p>Modern operating systems do not eagerly allocate the memory immediately, but only when a particular page is ï¬rst written to. This has two positive effects. First, there is no need to manually initialize the hash table to zero in an additional phase. Second, the table is adaptively distributed over the NUMA nodes, because the pages will be located on the same NUMA node as the thread that has ï¬rst written to that page. If many threads build the hash table, it will be pseudorandomly interleaved over all nodes. In case only threads from a single NUMA node construct the hash table, it will be located on that node â€“ which is exactly as desired.</p></blockquote><h3 id="Partition-the-input"><a href="#Partition-the-input" class="headerlink" title="Partition the input"></a>Partition the input</h3><p>è¿™é‡Œå¸Œæœ›æ ¹æ® <code>Hash(attrs)</code>ï¼Œå¹¶é€‰æ‹©å°½é‡é‡è¦çš„ï¼ˆæ¯”å¦‚å’Œ Join æœ‰å…³çš„æ–¹å¼ï¼‰æ¥è°ƒåº¦ã€‚è¿™æ ·èƒ½åˆ©ç”¨ä¸Šä¸€äº› co-locate Join ç­‰æ–¹å¼ï¼Œå¹¶ä¸”èƒ½å¤Ÿè®©æ•°æ®åˆ†å¸ƒå¾ˆå‡åŒ€ã€‚</p><p>å½“ç„¶ï¼Œä½œè€…è®¤ä¸ºè¿™é‡Œ<strong>åªæ˜¯ä¸€ä¸ª Hint</strong>ï¼Œå› ä¸º Morsel æœ¬èº«ä¹Ÿæœ‰ work-stealing çš„èƒ½åŠ›ã€‚</p><blockquote><p>It should be stressed that this co-location scheme is beneï¬cial but not decisive for the high performance of morsel-driven execution, as NUMA-locality is, in either case, guaranteed for table scans, and after the ï¬rst pipeline that materializes results NUMA locally.</p></blockquote><h3 id="Grouping-Aggregation"><a href="#Grouping-Aggregation" class="headerlink" title="Grouping/Aggregation"></a>Grouping/Aggregation</h3><p><img src="https://image.mwish.me/blog-image/6961668421561371144.png" alt="img"></p><p>è¿™é‡Œç±»ä¼¼ Map-Reduce çš„ Shuffle çš„æ¨¡å¼ï¼Œå…ˆæœ¬åœ°åš Hash Partitionï¼ˆç»´æŠ¤ thread local hash tableï¼Œè€Œä¸æ˜¯ Join çš„é‚£ç§ï¼‰ã€‚åœ¨ Hash Parititon ï¼ˆhtï¼‰é‡ï¼Œå¦‚æœæ»¡äº†ï¼Œå°± Spill åˆ°é¢å¤–çš„åŒºåŸŸå†…ï¼ˆå½“ç„¶æˆ‘çŒœè¿™é‡Œä¹Ÿå¯ä»¥ Agg ç›´æ¥åšï¼‰ã€‚</p><p>ç„¶ååœ¨é˜¶æ®µäºŒç”±ä¸åŒçº¿ç¨‹ fetchã€‚æ¯ä¸ªçº¿ç¨‹è´Ÿè´£æ”¶é›†æŸä¸ª Partition çš„æ•°æ®ï¼Œå½“ä»–æ”¶é›†å®Œæ‰€æœ‰è¾“å…¥ Partition çš„æ—¶å€™ï¼Œä¼šç›´æ¥ Push å¯¹åº”çš„è¾“å‡ºç»™ä¸‹æ¸¸çš„ Operator ï¼ˆè¿™ä¸ª Phase ä¸æ˜¯ä¸ª Blocking çš„ï¼‰ã€‚</p><p>è¿™é‡ŒåŸç†ç‰¹åˆ«åƒ Shuffleã€‚</p><h3 id="Sorting"><a href="#Sorting" class="headerlink" title="Sorting"></a>Sorting</h3><p><img src="https://image.mwish.me/blog-image/2400864754718694597.png" alt="img"></p><p>Local Sorting -&gt; Merge</p><h2 id="Other-cases-and-Blogs"><a href="#Other-cases-and-Blogs" class="headerlink" title="Other cases and Blogs"></a>Other cases and Blogs</h2><h3 id="Datafusion"><a href="#Datafusion" class="headerlink" title="Datafusion"></a>Datafusion</h3><p>Datafusion è‡ªèº«æ˜¯ä¸€ä¸ª pull-based Morsel Driven Execution çš„æ‰§è¡Œæ¨¡å‹ï¼Œå®ƒçš„å‚è€ƒæ–‡æ¡£å¦‚ä¸‹ï¼š</p><ol><li>Tustvold å†™çš„ RFC <a href="https://docs.google.com/document/d/1txX60thXn1tQO1ENNT8rwfU3cXLofa7ZccnvP4jD6AA/edit?pli=1#heading=h.3iwlbn2gzs29">https://docs.google.com/document/d/1txX60thXn1tQO1ENNT8rwfU3cXLofa7ZccnvP4jD6AA/edit?pli=1#heading=h.3iwlbn2gzs29</a></li><li>ä¸€äº›ç›¸å…³çš„è®¨è®ºï¼š<ol><li><a href="https://github.com/apache/arrow-datafusion/issues/7000">https://github.com/apache/arrow-datafusion/issues/7000</a></li><li><a href="https://github.com/apache/arrow-datafusion/issues/7001">https://github.com/apache/arrow-datafusion/issues/7001</a></li></ol></li></ol><p>Alamb æåˆ°ä¸€äº›æ¯”è¾ƒæœ‰æ„æ€çš„æ€è€ƒï¼š( <a href="https://github.com/apache/arrow-datafusion/issues/7001#issuecomment-1666569951">https://github.com/apache/arrow-datafusion/issues/7001#issuecomment-1666569951</a> )</p><blockquote><p>The <strong>claimed</strong> benefits of morsel driven parallelism of the classic approach are:</p><ol><li>Better NUMA / cache locality</li><li>Near linear scaling (so if you double core count to 32 to 64 expect to see a linear 2x speed up)</li><li>Better runtime optimization by scaling up/down cores, but I think this is less important in the real world (as you most often run out of memory long before you run out of CPU)</li></ol><p>Basically, I think it is totally reasonable for DataFusion to scale linearly to high core counts â€” like 128 / 256. I just need to prove that is the case and I suspect it will take some finagling with the current Repartitioning code</p></blockquote><p>(3) æ˜¯ä¸ªæ¯”è¾ƒé¢å¤–çš„ç‚¹ã€‚å°±ç®—å¼•å…¥ Spill ä¹‹ç±»çš„ä¸œè¥¿æ„Ÿè§‰è¿˜æ˜¯ä¼šå¯¹å†…å­˜é€ æˆä¸€å®šçš„å½±å“æ€§ã€‚</p><h3 id="DuckDB"><a href="#DuckDB" class="headerlink" title="DuckDB"></a>DuckDB</h3><p><a href="https://github.com/duckdb/duckdb/pull/991">https://github.com/duckdb/duckdb/pull/991</a></p><p>è¿™é‡Œæåˆ°ä¼šæŠŠ Morsel åˆ‡åˆ†æˆ 100 vectorï¼Œä¸çŸ¥é“æ–°çš„ç‰ˆæœ¬æ˜¯å•¥æ ·å­çš„</p><h3 id="TiFlash"><a href="#TiFlash" class="headerlink" title="TiFlash"></a>TiFlash</h3><p>ä¾é  Exchange ç®—å­æ¥åšå¹¶è¡Œã€‚è§ <a href="http://fuzhe1989.github.io/2022/04/17/tiflash-executor-thread-model/">http://fuzhe1989.github.io/2022/04/17/tiflash-executor-thread-model/</a></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>VLDB&#39;11: Efficiently Compiling Efficient Query Plans for Modern Hardware</title>
      <link href="/2023/10/29/VLDB-11-Efficiently-Compiling-Efficient-Query-Plans-for-Modern-Hardware/"/>
      <url>/2023/10/29/VLDB-11-Efficiently-Compiling-Efficient-Query-Plans-for-Modern-Hardware/</url>
      
        <content type="html"><![CDATA[<p>åœ¨æ—¥æ–°æœˆå¼‚çš„dbé¢†åŸŸçœ‹ä¸€ç¯‡å¹´ä»£è¾ƒæ—©çš„è®ºæ–‡æœ‰ä¸€äº›æ€è·¯ï¼Œè¦ä¹ˆæ˜¯å…¶å®é¢†åŸŸå‘å±•çš„æ²¡æœ‰é‚£ä¹ˆå¿«ï¼Œæ¯”å¦‚å¤§å®¶æäº†å¾ˆå¤š btree æ–°ç»“æ„çš„æ–‡ç« ï¼Œä½†æ˜¯æ„Ÿè§‰åš BTR è¿˜æ˜¯å®Œå…¨æ— æ³•ç»•å¼€ IBMçš„ARIESå‡ ä»¶å¥—ï¼Œï¼§.Gotez çš„æ–‡ç« ã€‚è¦ä¹ˆå°±æ˜¯ç»™æ—¥æ¸å¤æ‚çš„æ¨¡å‹æ‰¾ä¸€ä¸ªåŸºæœ¬çš„å‡ºå¤„ã€‚æˆ‘åˆšç¿»15-721 çš„æ—¶å€™çœ‹ä»–èŠåˆ° Vectorize ç›´æ¥ç»™æˆ‘ä¸Š SIMD äº†ï¼Œå¿ƒæƒ³è¿™å’Œ Monet/X100 çš„è®ºæ–‡æ€è·¯è¿˜æ˜¯æœ‰åŒºåˆ«çš„ã€‚ä¸è¿‡ä»”ç»†æƒ³æƒ³ï¼Œå¯èƒ½ Vectorize é™¤å¼€æŒ‡ä»¤å’Œæ•°æ®æœ‰æ›´å¥½çš„å±€éƒ¨æ€§ã€é¿å…å“¦äº†æ›´å¤šçš„ Volcano è¿™ç±»çš„æ¡†æ¶å¼€é”€ä¹‹å¤–èƒ½å¤Ÿåˆ©ç”¨ä¸Šçš„ä¼˜åŒ–ã€‚</p><p>è¿™ç¯‡è®ºæ–‡ç”± TUM åœ¨ 11 å¹´å‘è¡¨åœ¨ VLDB ä¸Šã€‚æœ¬æ–‡ä¸»è¦è´¡çŒ®æ˜¯ Codegen + æ”¯æŒ codegen çš„ Pipelineã€‚ç°å¦‚ä»Šä½œä¸º ap å¤§å†…å·æ—¶ä»£ï¼Œè¿™ä¸¤é¡¹æŠ€æœ¯éƒ½åœ¨ DuckDBã€ClickHouseã€Velox å’Œæ— æ•°åˆ†ææ•°æ®åº“ä¸Šè·‘ç€äº†ã€‚ä¸æ˜¯æ‰€æœ‰æ•°æ®åº“éƒ½åšäº† Codegenï¼Œä½†æ˜¯å¤§å®¶é€šå¸¸ä¼šå®ç°ä¸€å¥— Pipeline æ¥åšé«˜æ•ˆçš„è°ƒåº¦å’Œæ‰§è¡Œã€‚ä½†æ¯”è¾ƒæœ‰æ„æ€çš„æ˜¯ï¼Œæœ¬æ–‡å´æ˜¯åè¿‡æ¥çš„ï¼Œä¸ºäº† Codegen è€Œå®ç°äº† Pipelineã€‚</p><p>ä»è¿™ä¸ªè§’åº¦æ¥çœ‹ï¼Œåœ¨ codegen çš„åŸç‚¹ï¼Œä½œè€…çš„éœ€æ±‚æ˜¯ï¼š</p><ol><li>å¸Œæœ›ç›´æ¥ç”Ÿæˆ Monet/X100 çš„è®ºæ–‡ä¸­é‚£ç§ optimal çš„ä»£ç ã€‚å› ä¸ºæ˜¯ç›´æ¥ç”Ÿæˆçš„ Typed ä»£ç ï¼Œæ‰€ä»¥ä¹Ÿé¿å…äº†æ¡†æ¶çš„å¼€é”€</li><li>æœ¬èº« codegen å¦‚æœä»ä¸Šå±‚å» pull çš„æ‰§è¡Œçš„è¯ï¼Œä½œè€…è®¤ä¸ºå…¶ä¸­è¿˜æ˜¯ä¼šæœ‰å¾ˆå¤š branching çš„å¼€é”€çš„ã€‚ä½œè€…è®¤ä¸ºï¼Œé¿å…è¿™ç§å¼€é”€çš„æ–¹å¼å°±æ˜¯ä»¥æ•°æ®ä¸ºä¸­å¿ƒå®ç° executionã€‚æŠŠå¤šä¸ª operator æŒ‰ç…§æ€§è´¨ç»„ç»‡æˆ Pipelineï¼Œæ¥è¿›è¡Œä»¥æ•°æ®ä¸ºä¸­å¿ƒçš„æ‰§è¡Œã€‚</li></ol><p>å½“ç„¶ï¼Œä½œè€…è¿˜ä¸¾äº†ä¸ªæ¯”è¾ƒå¥½ç©çš„ä¾‹å­ï¼Œåœ¨å®ç° Scan çš„æ—¶å€™ï¼Œå¦‚æœæœ‰ä¸€äº›å‹ç¼©ä¹‹ç±»çš„ä¸Šä¸‹æ–‡ï¼Œæˆ–è€…è¿™æ ·çš„å¤„ç†æ–¹å¼ï¼Œper-tuple çš„æ‰§è¡Œå¯èƒ½ book-keeping çš„å¼€é”€ä¼šå¾ˆå¤§ï¼ˆæ„Ÿè§‰æŒ‰ä»–è¯´æ³•ç”šè‡³ç±»ä¼¼äºæ streaming è§£å‹äº†ï¼Œä¸è¿‡çœ‹å¤§éƒ¨åˆ†å®ç°å¯èƒ½ä¸ä¼šè¿™æ ·åšï¼Œéƒ½æ˜¯ Page è§£å‹ç„¶åå† Page ä¸Šè¯»æ•°æ®ã€‚ä½†æ˜¯ä¼ ç»Ÿ btr åœ¨ Page ä¸Šå¤„ç† iterator ä¸Šä¸‹æ–‡ä¹Ÿæ˜¯æœ‰ä¸€å®šå¼€é”€çš„ï¼‰ã€‚</p><p><img src="https://image.mwish.me/blog-image/7123140944280875689.png" alt="img"></p><p>ä½œè€…å¯¹ vectorize å½“æ—¶çš„çœ‹æ³•æ˜¯ï¼š</p><blockquote><p>This materialization has other advantages like allowing for vectorized operations [2], but in general the lack of pipelining is very unfortunate as it consumes more memory bandwidth.</p><p>As shown in Figure 1, still does not reach the speed of hand-written code.</p></blockquote><p>(å³æœ¬èº«å¯¹ memory bandwidth ä¾èµ–æ¯”è¾ƒé‡ã€‚è¿™ä¸ªå¯ä»¥æœ‰ä¸€äº›å·¥ç¨‹ä¼˜åŒ–ï¼Œæˆ‘ä¿ç•™æ€åº¦)</p><p>å…³äºä¸ºä»€ä¹ˆè¦åš Push-based è¿™å¥—ï¼Œä½œè€…çš„è§‚ç‚¹æ˜¯ï¼š</p><ol><li>Data centric &gt; Operator centricï¼Œæ¥ä¿è¯æ•°æ® keep åœ¨ register ä¸­ã€‚</li><li>ä½œè€…è®¤ä¸º pull-based execution ä¾èµ– function callï¼ŒåŒæ—¶ï¼Œå®ƒéœ€è¦æä¾›ä¸€ä¸ª <code>next()</code> çš„è°ƒç”¨ï¼Œè¿™ç§è°ƒç”¨å¾ˆä¿æŒæ•°æ®åœ¨å¯„å­˜å™¨ä¸­ã€‚</li><li>æ•°æ®è¢« LLVM è½¬æˆ Native Code</li></ol><p>æ­¤å¤–ï¼Œè™½ç„¶æ–‡ç« çš„ 1-4 èŠ‚ï¼Œä½œè€…ä»‹ç»çš„éƒ½æ˜¯ per-tuple çš„æ‰§è¡Œï¼Œä½†æ˜¯åœ¨æ–‡ç« çš„ç¬¬äº”èŠ‚ï¼Œä½œä¸ºä¼˜åŒ–é¡¹ç›®ï¼Œè¿™é‡Œä¹Ÿå…è®¸æ¡†æ¶ä½¿ç”¨ Batch çš„æ‰§è¡Œæ¥åˆ©ç”¨ SIMD ç­‰æ–¹å¼æ¥ä¼˜åŒ–ã€‚</p><h2 id="æ‰§è¡Œæ¨¡å‹"><a href="#æ‰§è¡Œæ¨¡å‹" class="headerlink" title="æ‰§è¡Œæ¨¡å‹"></a>æ‰§è¡Œæ¨¡å‹</h2><p>ä½œè€…é¦–å…ˆå®šä¹‰äº†:</p><ul><li>Pipeline-breaker: å¯¹äºç»™å®šçš„è¾“å…¥ï¼Œå¦‚æœä¼šä»å¯„å­˜å™¨ä¸¢åˆ°å†…å­˜é‡Œï¼Œè¿™å°±æ˜¯ pipeline breaker. è¿™é‡Œè§†æŠŠæ•°æ® spill åˆ°å†…å­˜ä¸­ä¸ºä¸€ä¸ª pipeline-breaking op</li><li>Full Pipeline breaker: éœ€è¦è¾“å…¥ç«¯ Materialize æ‰€æœ‰çš„ input</li></ul><p>å…³äºè¿™é‡Œçš„å¯„å­˜å™¨æ¦‚å¿µå®šä¹‰ï¼Œå¯ä»¥æŸ¥çœ‹ï¼š</p><blockquote><p>LLVM hides the problem of register allocation by offering an unbounded number of registers (albeit in Single Static Assignment form).</p></blockquote><p>åœ¨è¿™é‡Œï¼Œæ•°æ®æµæˆä¸ºäº†ï¼š</p><blockquote><p>data is always pushed from one pipeline-breaker into another pipeline-breaker</p></blockquote><p>åœ¨è¿™é‡Œåšä¸€ä¸ªè®¨è®ºï¼Œä½œè€…è®¤ä¸º pull-based execution ä¸å¤ªé€‚åˆä¿æŒ Tuple åœ¨å¯„å­˜å™¨ä¸­ï¼Œè¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿè¿™é‡Œå’ŒåŸ¹ç¥äº¤æµäº†ä¸‹ï¼Œå¯¹äº pull å¯èƒ½æŠŠå‡½æ•°å†™æˆä¸‹é¢çš„æ ·å­ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Optional<span class="operator">&lt;</span>Nullable<span class="operator">&lt;</span>T<span class="operator">&gt;&gt;</span> next();</span><br><span class="line">bool next(Nullable<span class="operator">&lt;</span>T<span class="operator">&gt;</span><span class="operator">*</span>);</span><br></pre></td></tr></table></figure><p>å¯¹äº 1/2 æ¥è¯´ï¼Œå…¶å®éƒ½å¾ˆéš¾ä¿è¯æ•°æ®åœ¨å¯„å­˜å™¨ä¸­ï¼š</p><ol><li><a href="https://wiki.osdev.org/System_V_ABI">https://wiki.osdev.org/System_V_ABI</a> å¯èƒ½æœ€å¤šä¿è¯ 64B çš„è¿”å›å¯ä»¥åœ¨å¯„å­˜å™¨ä¸­ã€‚è¿™æ ·å¯¹äº Schema ç¨å¾®å¤æ‚ä¸€ç‚¹çš„ Tuple</li><li><a href="https://www.reddit.com/r/cpp/comments/ilujab/it_turns_out_stdtuple_is_not_a_zerocost/?rdt=58548">https://www.reddit.com/r/cpp/comments/ilujab/it_turns_out_stdtuple_is_not_a_zerocost/?rdt=58548</a></li></ol><p>ï¼ˆå½“ç„¶ï¼ŒæŸç§æ„ä¹‰ä¸Šï¼Œæˆ‘è§‰å¾—å¯¹äº Batch Exec è¿™é‡Œä¹Ÿä¸æ˜¯é‚£ä¹ˆé‡è¦ã€‚å¯èƒ½ Batch Exec å¸Œæœ›çš„æ˜¯ä¸ªç±»ä¼¼çš„ä¸œè¥¿ï¼Œå°±æ˜¯æ•°æ®å…¨éƒ¨åœ¨ L1 Cache é‡Œå¤´ã€‚ClickHouse å’Œ DuckDB ç›¸å¯¹æ¥è¯´éƒ½è§‰å¾—è¿™å—çš„æµæ§ä¹‹ç±»çš„æ›´åŠ å¥½åšï¼Œè€Œä¸æ˜¯ç®€å•çš„ keep æ•°æ®åœ¨å¯„å­˜å™¨ä¸­ã€‚ï¼‰</p><p>ä¸‹é¢å±•ç¤ºäº†ä¸€ä¸ªå¸¦å­æŸ¥è¯¢çš„ SQL å’ŒåŸºæœ¬çš„æ‰§è¡Œè®¡åˆ’ï¼š</p><p><img src="https://image.mwish.me/blog-image/4066494792601214913.png" alt="img"></p><p>è¿™é‡Œ Figure2 -&gt; Figure3 å·¦ä¾§å…¶å®æ˜¯æ¯”è¾ƒå¥½æ‡‚çš„ã€‚è¿™é‡Œéœ€è¦ä¸¤æ¬¡ Joinï¼Œç„¶åæœ‰ä¸€ä¸ªçš„è¾“å…¥æ¥è‡ªäºå­æŸ¥è¯¢æœ«ç«¯çš„ Group By å’Œ R3ï¼Œå¦ä¸€ä»½çš„è¾“å…¥æ¥è‡ªäº R1 Selection å’Œ Join çš„ç»“æœã€‚å·¦å³å…³ç³»å¯èƒ½æ¥è‡ªä¼˜åŒ–å™¨çš„ä¼°è®¡ï¼ˆHash Join ä¸­ï¼ŒBuild ä¾§å¯èƒ½å¸Œæœ›å°ä¸€äº›ï¼Œæ¥è®©å†…å­˜çš„å¼€é”€å°ä¸€ç‚¹ï¼‰</p><p>ä¸Šè¿°çš„ä»£ç ä¼šè¢«ï¼ˆé€»è¾‘ä¸Šï¼‰å¤„ç†æˆ Figure4 çš„æ ·å­ã€‚æ³¨æ„è¿™é‡Œè¿˜æ˜¯è€ƒè™‘çš„æ˜¯ä¸²è¡Œå¤„ç†çš„ä»£ç ï¼Œå¯¹åº”ä» Root èŠ‚ç‚¹ pull çš„ä»£ç ç»“æ„ã€‚è¿™æ ·çš„ä»£ç åœ¨æ‰§è¡Œçš„æ—¶å€™ä¼šåˆ’åˆ†æˆä¸‹é¢å››ä¸ª pipeline çš„éƒ¨åˆ†ï¼š</p><ol><li>ä» R1 ä¸­è¯»æ•°æ®ï¼Œç„¶å materialize (å» build)</li><li>R2 ä¸­è¯»å– -&gt; Filter -&gt; Materialize ( Hash Agg )</li><li>ä» Hash Aggregate ä¸­å†æ„å»º Build é˜¶æ®µçš„ Table</li><li>ä» R3 æ¨ä¸Šæ¥ï¼Œå…ˆ Join (3) å† Join (1) çš„ç»“æœã€‚è¿™éƒ¨åˆ† Join çš„å¤„ç†è¿˜æ˜¯å¾ˆæœ‰æ„æ€çš„ã€‚</li></ol><p><img src="https://image.mwish.me/blog-image/7800869277960209727.png" alt="img"></p><p>ç¼–è¯‘å‡ºè¿™æ ·çš„ä»£ç æ˜¯æœ‰éš¾åº¦çš„ï¼Œå°¤å…¶æ˜¯è€ƒè™‘å¯èƒ½æ’å…¥ä¸€äº›å¹¶å‘æ“ä½œçš„æ—¶å€™ã€‚åŒæ—¶éœ€è¦å¤„ç† Join è¿™æ ·çš„ç»“æ„ã€‚æ‰€æœ‰ç®—å­å¯ä»¥å‡†å¤‡ä¸‹é¢çš„é€»è¾‘ç»“æ„ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">produce(); <span class="operator">/</span><span class="operator">/</span> å£°æ˜æ“ä½œï¼Œè¦æ±‚ä½ å¯ä»¥äº§ç”Ÿæ•°æ®äº†</span><br><span class="line">consume(attr, data); <span class="operator">/</span><span class="operator">/</span> è¡¨ç¤ºæ”¶åˆ°äº†(æŸäº› attr çš„) æ•°æ®</span><br></pre></td></tr></table></figure><p>æ˜¾ç„¶ï¼Œæˆ‘ä»¬ä¹‹å‰çœ‹è¿‡ Acero çš„ä»£ç ï¼Œå®ƒä¹Ÿæœ‰ç±»ä¼¼çš„ç»“æ„ã€‚</p><p><img src="https://image.mwish.me/blog-image/3440688350487090750.png" alt="img"></p><p>è¿™é‡Œæ³¨æ„ Join çš„ Consume çš„ç»“æ„ã€‚</p><h2 id="Code-Generation"><a href="#Code-Generation" class="headerlink" title="Code Generation"></a>Code Generation</h2><p><img src="https://image.mwish.me/blog-image/6313517831374343862.png" alt="img"></p><p>ä½œè€…ä½¿ç”¨ LLVM è¿æ¥ C++ ä»£ç ï¼Œå¹¶ä¸é€‚ç”¨ç›´æ¥ç”Ÿæˆæ±‡ç¼–çš„æ–¹å¼ï¼Œå¦‚å›¾6ï¼ŒC++çš„â€œé½¿è½®â€æ˜¯é¢„ç¼–è¯‘çš„ï¼›åªæœ‰ç”¨äºç»„åˆå®ƒä»¬çš„LLVMâ€œé“¾æ¡â€æ˜¯åŠ¨æ€ç”Ÿæˆçš„ã€‚è¿™æ ·å¯ä»¥å®ç°éå¸¸ä½çš„æŸ¥è¯¢ç¼–è¯‘æ—¶é—´ã€‚ç›´æ¥ç¼–è¯‘ C++ ä»£ç åˆ™è¦è€—è´¹æ•°ç§’çš„æ—¶é—´ã€‚</p><p>æœ‰äº›ä»£ç æ¯”å¦‚ Sort ä¹‹ç±»çš„ç›¸å¯¹å¤æ‚ï¼ŒLLVM è¿™é‡Œæ˜¯ç”¨èƒ¶æ°´æŠŠå®ƒä»¬è¿æ¥èµ·æ¥ã€‚ç„¶åä¸»è¦ç¼–å†™ C++ ä»£ç ã€‚</p><blockquote><p>While staying in LLVM, we can keep the tuples in CPU registers all the time, which is about as fast as we can expect to be. When calling an external function all registers have to be spilled to memory, which is somewhat expensive. In absolute terms it is very cheap, of course, as the registers will be spilled on the stack, which is usually in cache, but if this is done millions of times it becomes noticeable.</p></blockquote>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>ATC&#39;19: EROFS</title>
      <link href="/2023/10/22/ATC-19-EROFS/"/>
      <url>/2023/10/22/ATC-19-EROFS/</url>
      
        <content type="html"><![CDATA[<p>ä¹‹å‰çœ‹åˆ°åŸ¹ç¥åœ¨ç¾¤é‡Œè½¬åä¸ºè´¡çŒ®çš„ EROFS å¯èƒ½è¿›å®‰å“ä¸»çº¿å¹¶ä½œä¸ºé»˜è®¤åªè¯»æ–‡ä»¶ç³»ç»Ÿï¼Œä¸ä»…å¯¹è¿™ä¸€è´¡çŒ®æ¯”è¾ƒæ„Ÿå…´è¶£ï¼Œé‚æŠŠè®ºæ–‡æ‹‰å‡ºæ¥è¯»äº†ä¸€éã€‚æ–‡ç« ä½œè€…æ¥è‡ªåä¸ºå’Œ SJTU iPadsï¼Œå†…å®¹è¿˜æ˜¯æ¯”è¾ƒæ¸…æ™°çš„ï¼Œæè¿°äº†å®ƒä»¬æ€ä¹ˆä¼˜åŒ–åªè¯»æ–‡ä»¶ç³»ç»Ÿçš„ï¼Œå®ƒä»¬çš„è´¡çŒ®å¤§æ¦‚æœ‰ï¼š</p><ol><li>åˆ©ç”¨ LZ4 æ¥æŠŠè¾“å…¥å—å‹ç¼©æˆ<strong>å›ºå®šå¤§å°çš„å—è¾“å‡º</strong> BLOCK å­˜å‚¨åœ¨å—å­˜å‚¨è®¾å¤‡ä¸Š</li><li>åˆ©ç”¨å·§å¦™çš„æŠ€å·§ï¼Œæ¥ä¼˜åŒ–è§£å‹ç¼©çš„å¼€é”€ã€‚ä½œè€…è®¤ä¸ºè¿™å—çš„å¼€é”€æœ‰ä¸¤ä¸ªæ–¹é¢ï¼šæ–‡ä»¶å¤§å°çš„æ”¾å¤§ã€è§£å‹ç¼©éœ€è¦çš„çš„å†…å­˜å¼€é”€ï¼ˆè§åæ–‡å›¾ï¼‰<ol><li>æ–‡ç« æŠŠ compressed block åˆ†æˆäº†ä¸¤ç§æ¨¡å¼ï¼šcached io å’Œ in-place ioã€‚</li><li>ç”¨å¤šç§æ–¹æ³•æ¥ä¼˜åŒ–è§£å‹ç¼©ï¼ŒåŒ…æ‹¬ç›´æ¥æŠŠç”¨æˆ·å†…å­˜æ˜ å°„åˆ°è§£å‹ç¼©å¯¹åº”çš„ Pageã€è·³è¿‡ä¸éœ€è¦è§£å‹ç¼©çš„å¤šä½™æ•°æ®</li></ol></li></ol><p>æœ¬æ–‡åªä»£è¡¨ 19 ATC å‘è¡¨çš„çŠ¶å†µï¼Œå¬è¯´ 2023 å¹´ Linux ä¸»çº¿ä»£ç å’Œè¿™ä¸ªæœ‰ç‚¹å˜åŒ–ï¼Œè€Œä¸”ä½œè€…ç›®å‰è¿˜åœ¨ç»´æŠ¤è¿™å¥—ç³»ç»Ÿã€‚æ„Ÿå…´è¶£çš„å¯ä»¥ç¿»ç¿» maillist æ¥å¾—çŸ¥æœ€æ–°çš„æƒ…å†µã€‚</p><h2 id="èƒŒæ™¯å’Œç›¸å…³ç³»ç»Ÿä»‹ç»"><a href="#èƒŒæ™¯å’Œç›¸å…³ç³»ç»Ÿä»‹ç»" class="headerlink" title="èƒŒæ™¯å’Œç›¸å…³ç³»ç»Ÿä»‹ç»"></a>èƒŒæ™¯å’Œç›¸å…³ç³»ç»Ÿä»‹ç»</h2><p>EROFS æ˜¯ä¸€ä¸ª<strong>åªè¯»çš„å‹ç¼©æ–‡ä»¶ç³»ç»Ÿ</strong>ã€‚è€Œå®‰å“æœ¬èº«ä»£ç ä¹Ÿä½¿ç”¨äº† Linux Kernel éƒ¨åˆ†çš„ä¸€äº›ä»£ç [3]. æœ¬èº« Linux ä¸Šå¾ˆå¤šåœ°æ–¹å°±æ˜¯æ”¾åªè¯»æ–‡ä»¶çš„ï¼Œæ¯”å¦‚ç³»ç»Ÿçš„ <code>/system</code> ä¹‹ç±»çš„ read-only space. é‚£ä¹ˆæ ¹æ®è®ºæ–‡çš„ä½œè€…æ‰€è¯´ï¼Œå®é™…ä¸Šå®‰å“çš„ç³»ç»Ÿæ–‡ä»¶å¤§å°æœ¬èº«æ˜¯æŒºå¤§çš„ï¼Œåœ¨ android 9 ä¸Šé¢å¢é•¿åˆ°äº† 1.9 GBã€‚å¦‚ä¸‹å›¾</p><p>ï¼ˆSparse Image å’Œ Raw Image æ˜¯é•œåƒçš„ä¸åŒæ ¼å¼ï¼Œè§ [4] ï¼‰</p><p><img src="https://image.mwish.me/blog-image/5632958259247473078.png" alt="img"></p><ol><li>Btrfs è¿™ç§ fs å¯¹å‹ç¼©å¹¶æ²¡æœ‰é‚£ä¹ˆå‹å¥½ï¼Œå®ƒä¼šæŠŠæ•°æ®åˆ‡åˆ†æˆå¤šä¸ª 128KB çš„ Chunkï¼Œç„¶åç‹¬ç«‹å‹ç¼©ï¼ŒæŠŠè¿™äº›æ•°æ®å­˜æ”¾åœ¨ä¸åŒçš„ Extent ä¸­ï¼Œè¿™äº› Extent çš„ä½ç½®ä¼šå­˜æ”¾åœ¨ä¸€ä¸ª Btree ç´¢å¼•ä¸Šã€‚éœ€è¦è¯»å–çš„æ—¶å€™è¿™é‡Œéœ€è¦ decompress æ•´ä¸ª column chunk. ç„¶åå»å¤„ç†. Btrfs æ˜¯å¯ä»¥æ›´æ–°çš„ï¼Œä½†æ˜¯æ›´æ–°å’Œé‡å†™æ•´ä¸ª chunk å·®ä¸å¤šäº†ï¼Œè¿˜è¦é¢å¤–æ›´æ–°ä¸€ä¸‹ indexã€‚</li><li>è€Œ SquashFs æ˜¯ä¸€ä¸ªå·²å­˜åœ¨çš„å‹ç¼©åªè¯»æ–‡ä»¶ç³»ç»Ÿï¼Œä½†æ˜¯è¿™ä¸ªç³»ç»Ÿä¼šå¸¦æ¥ä¸å°‘ overheadï¼Œæœ‰çš„æ˜¯è®¾è®¡å±‚é¢çš„ï¼Œæœ‰çš„æ˜¯å®ç°å±‚é¢çš„ï¼Œè§ä¸‹å›¾ï¼š</li></ol><p><img src="https://image.mwish.me/blog-image/1637353494132474512.png" alt="img"></p><p>Squashfs æ”¯æŒé…ç½®<strong>è¾“å…¥ block-size</strong>ï¼Œç„¶åæŠŠè¿™äº›å‹ç¼©åˆ°è¾“å‡ºç„¶ååˆ†é…åˆ°ç£ç›˜çš„ Block ä¸Šã€‚ä¹Ÿæ”¯æŒé…ç½®ä¸€äº›ç®—æ³•ã€‚åœ¨ Squashfs ä¸Šï¼Œä¹Ÿéœ€è¦ä¸€äº›å…ƒæ•°æ®ï¼ˆæ¯”å¦‚å‹ç¼©å‰åçš„æ˜ å°„ï¼‰ã€‚å‹ç¼©åçš„å¤§å°å­˜å‚¨åœ¨ inode ä¸­çš„åˆ—è¡¨ä¸Šã€‚</p><p>ä»æ–‡ç« çš„å®éªŒè§’åº¦çœ‹ï¼Œè¿™äº›è®¾å¤‡çš„å‹ç¼©ç‡å…¶å®æ˜¯å¾ˆé«˜çš„ã€‚è¿™å¯¼è‡´ï¼š</p><ol><li>æ¯æ¬¡ä¼šå¤šè¯»ä¸€äº›ç£ç›˜ IO çš„æ•°æ®ï¼ˆè¿™ä¸ªæ˜¯è®¾è®¡è§’åº¦å¯¼è‡´çš„ï¼Œæ¯”å¦‚å‹ç¼©åçš„å—å’Œç£ç›˜ size ä¸å¯¹é½ï¼‰</li><li>è§£å‹ç¼©éœ€è¦ç”³è¯· uncompressed çš„å—å¤§å°çš„ä¸´æ—¶å†…å­˜ã€‚æœ¬æ¥ç›˜å¤§å°å°±å°äºå†…å­˜äº†ï¼Œä½ è¿™èµ„æºå¼€é”€æ›´å¤§äº†â€¦è¿™äº›å†…å­˜åœ¨ç°åœ¨è¿˜æ²¡å¤šå¤§å†…å­˜çš„æœºå™¨ä¸Šæ“ä½œè¿˜ä¼šåŠ å‰§ swappingã€‚</li></ol><p>ä½œè€…è®¤ä¸ºï¼ŒSquashfs è®¾è®¡æœ‰ä¸‹åˆ—æ ¸å¿ƒé—®é¢˜ï¼š</p><ol><li>Fixed-sized input compression: è¿™ç§æ–¹å¼å¯¹å° io å¸¦æ¥äº†æ¯”è¾ƒå¤§çš„è¯»æ”¾å¤§å’Œå†…å­˜æ”¾å¤§ï¼Œå¦‚æœå…¨è¦è¯»å€’è¿˜å¥½ï¼Œä½†æ˜¯å¯¹äºå° ioï¼Œæ¯”æ–¹è¯´è¦è¯»å–ç¬¬ä¸€ä¸ª blockï¼Œç„¶åç£ç›˜ä¸Šå¯èƒ½æ²¡å¯¹é½çš„ BLOCK éƒ½ç»™è¯»äº†ï¼Œç„¶ååˆè¦å‡†å¤‡è§£å‹ç¼©ç©ºé—´ï¼Œå› ä¸ºä½ ä¹Ÿä¸çŸ¥é“è¿™äº›ä¸œè¥¿æ¯ä¸ªç”¨æˆ·å±‚é¢çš„è¯»è¦çš„æ•°æ®åœ¨å“ªå—. å½“é…ç½®æˆ 4KB çš„è¾“å…¥å—çš„æ—¶å€™ï¼Œä¸Šè¿°é—®é¢˜ä¼šè¢«æ”¹å–„ï¼Œä½†æ˜¯å‹ç¼©çš„ batch-size åˆå¤ªå°äº†ï¼Œå¯¼è‡´ç™½å‹ç¼©äº†ã€‚</li><li>æ•°æ®æ‹·è´çš„å¼€é”€ã€‚è¿™éƒ¨åˆ†ä¸Šé¢çš„å›¾å†™çš„éå¸¸æ¸…æ™°ï¼Œè¿™é‡Œè¯»çš„ buffer-&gt;è§£å‹å— -&gt; ç”¨æˆ·å†…å­˜ã€‚æ¯éƒ¨åˆ†éƒ½å¼•å…¥äº†ä¸€å®šçš„å¼€é”€ã€‚è¿™éƒ¨åˆ†æˆ‘æ„Ÿè§‰ä¸€å®šç¨‹åº¦ä¸Šä¹Ÿæ˜¯å®ç°é—®é¢˜äº†ã€‚ä¸çŸ¥é“ block-size å’Œè®¾è®¡æ„Ÿè§‰å’Œè¿™ä¸ªçš„å½±å“æ²¡æœ‰é‚£ä¹ˆç›´æ¥ã€‚ä¸»è¦æ˜¯å·¥ç¨‹åŒ–çš„æ—¶å€™æ€ä¹ˆåœ¨å†…æ ¸ä¸Šæ”¯æŒè¿™äº›éœ€æ±‚ã€‚åœ¨å®ç°ä¸Šçš„æ—¶å€™ï¼Œsquashfs å®ç°å¦‚ä¸‹<ol><li>æ‹¿åˆ° compressed block çš„æ•°é‡</li><li>ç»™æ¯ä¸ª compressed block ç”³è¯·å†…å­˜ã€‚ç„¶å issue io æŠŠå®ƒä»¬è¯»èµ·æ¥ã€‚è¿™é‡Œå¯èƒ½ä¼šæœ‰ä¸ª io page æ± ï¼Œè¿™ä¸ªæ± æ˜¯é¢„å…ˆç”³è¯·çš„ï¼Œç»™ io å¯¹åº”çš„éœ€æ±‚ä½¿ç”¨</li><li>æ‹·è´åˆ° temp input bufferï¼Œè¿™é‡Œéœ€è¦ä¸€ä¸ªè¿ç»­çš„ç©ºé—´ï¼Œç„¶åè§£å‹åˆ° temp output buffer. ä½œè€…è®¤ä¸ºï¼Œè¿™é‡Œçš„ä¸»è¦ç“¶é¢ˆè¿˜æ˜¯ memory access è€Œä¸æ˜¯ CPU</li><li>ç»™ç”¨æˆ·çš„ page cache æ‹·è´</li></ol></li></ol><p>ä½œè€…è®¤ä¸ºï¼Œä¼˜åŒ–ç©ºé—´åœ¨äºï¼š</p><ol><li>å‡å°‘ io</li><li>å‡å°‘å†…å­˜ç”³è¯·</li></ol><h2 id="EROFS"><a href="#EROFS" class="headerlink" title="EROFS"></a>EROFS</h2><h3 id="Fixed-size-output-compression"><a href="#Fixed-size-output-compression" class="headerlink" title="Fixed-size output compression"></a>Fixed-size output compression</h3><p>ä½œè€…è®¤ä¸ºï¼Œä¸€éƒ¨åˆ†é—®é¢˜æ¥æºäº Fixed-size input çš„ä¸å¤Ÿ flexibleï¼Œæ‰€ä»¥ä»–ä»¬ä½¿ç”¨çš„ç­–ç•¥æ˜¯ fixed-sized output (è¿™å—å…¶å®æˆ‘ä¹Ÿæ²¡æœ‰ç™¾åˆ†ç™¾è¢«è¯´æœï¼Œå› ä¸ºæ„Ÿè§‰æ˜¯æœ‰ trade-off çš„ï¼Œåœ¨åŒæ ·å‹ç¼©ç‡çš„æƒ…å†µä¸‹ï¼Œè¿™é‡Œä¿è¯äº†å¯¹ä¸‹å±‚ block çš„ io æ˜¯å¯¹é½çš„ï¼Œä½†æ˜¯æœ¬èº« decompress ä¸­çš„å„ç§æ”¾å¤§è¿˜æ˜¯å­˜åœ¨çš„ã€‚ï¼‰</p><p><img src="https://image.mwish.me/blog-image/2120385008114742494.png" alt="img"></p><p>å…·ä½“æ–¹æ³•ä¸Šï¼ŒEROFS é‡‡ç”¨äº† LZ4 çš„æ–¹å¼ï¼Œåœ¨ <code>&#123;è¾“å…¥å¤§å°åˆ°è¾¾ 1MB, è¾“å‡ºå¤§å°åˆ°è¾¾4k&#125;</code> ä¸¤ä¸ªæ¡ä»¶ä»»æ„æ»¡è¶³ä¸€ä¸ªå°±ä¼šåˆ‡ä¸‹é¢çš„ BLOCKã€‚å¦‚æœæ˜¯è¾“å…¥å¤§å°ä¸º1MBå¯èƒ½ä¹Ÿä¼šå‡†å¤‡ä¸€ä¸ª 4K çš„å—ã€‚è¿™ä¸ªå¢åŠ äº†å‹ç¼©ç‡çš„ä¸Šé™ï¼ˆæ¯•ç«ŸåŸæ¥128KBä¸€å‹ï¼‰ã€‚2(c) å°±æ˜¯å‹ç¼©çš„ä¸€ä¸ªå›¾ä¾‹ã€‚ä½œè€…è®¤ä¸ºè¿™æ ·æœ‰å¦‚ä¸‹æœ‰ç‚¹ï¼š</p><ol><li>æœ€å¤§å‹ç¼©ç‡æ›´å¥½ï¼ˆæˆ‘è®¤ä¸ºè¿™ä¸ªå–å†³äºè¾“å…¥å§ orzï¼‰</li><li>åœ¨è§£å‹ç¼©çš„æ—¶å€™ï¼Œio æ§åˆ¶çš„æ¯”è¾ƒå¥½ã€‚ä½œè€…ä¹Ÿé€šè¿‡ä¸€äº› hack çš„æ–¹å¼è®©è§£å‹ç¼©å°½é‡è§£å‹å°‘çš„ç©ºé—´<ol><li>ä½œè€…è®¤ä¸ºåªæœ‰å¯¹åº”çš„å‹ç¼©æ•°æ®ä¼šè¢«è§£å‹ï¼Œæˆ‘è§‰å¾—æ²¡å·®æŠŠã€‚æˆ‘æ„Ÿè§‰ä¸€ä¸ªéšå«æ¡ä»¶å°±æ˜¯è¿™å †ä¸œè¥¿å‹ç¼©ç‡å¾ˆé«˜ï¼Œå‹ç¼©ç‡ä½çš„æ¡ä»¶ä¸‹æ–‡ç« æåˆ°çš„å¾ˆå¤šä¸œè¥¿éƒ½æ¯”è¾ƒæ‰¯ã€‚ã€‚ã€‚è¿™æ ·å¯¹äºå°ç¢è¯»æœ‰ä¸€å®šä¼˜åŒ–ï¼Œæ¯”å¦‚å°ç¢è¯»æœ€å¤šå¼•å…¥ä¸¤ä¸ª Physical Page IO. (<strong>ä¸è¿‡çœ‹æ–‡ç« é¢†æ‚Ÿäº†ä¸€ä¸‹ï¼Œåº”è¯¥è¿™é‡Œ fs å±‚ä¹Ÿæ˜¯ Page-Level IO</strong>ï¼ŒåŸåˆ™ä¸Š fs ä¸Šå±‚è¯»ä¸€ä¸ª Page ä¸‹å¤´ç¡®å®æœ€å¤šè¯»ä¸¤ä¸ªç‰©ç† Pageï¼‰ã€‚</li></ol></li><li>ä½¿å¾—åæ–‡æåˆ°çš„ in-place compression æˆä¸ºå¯èƒ½ã€‚</li></ol><h3 id="Input-Buffer-Handling-Cached-I-O-and-io-place-I-O"><a href="#Input-Buffer-Handling-Cached-I-O-and-io-place-I-O" class="headerlink" title="Input Buffer Handling: Cached I/O and io-place I/O"></a>Input Buffer Handling: Cached I/O and io-place I/O</h3><p><img src="https://image.mwish.me/blog-image/8349381289810421741.png" alt="img"></p><ol><li>Cached I/O: å¦‚æœè¦ partial read æŸä¸ª block<ol><li>ä½¿ç”¨ä¸€å— inode åŒºåŸŸæ¥å­˜å‚¨çŠ¶æ€ï¼Œæ•°æ®è¢« fetch åˆ°ä¸€ä¸ªé¢å¤–çš„ page cache ä¸­ã€‚</li><li>ä½œè€…è®¤ä¸ºè¿™ç§å°å—è¯»å¯èƒ½æ˜¯è¿ç»­çš„ï¼Œæ‰€ä»¥å¯èƒ½ä¼š cache ä¸€ä¼šå„¿ï¼Œåé¢è¯»åˆ°äº†åé¢çš„åŒºæ®µå¯ä»¥é¿å…åå¤è§£å‹ï¼ˆè¿™æ®µæœ‰ç‚¹æŠ½è±¡ï¼Œå¯ä»¥çœ‹åé¢çš„ decompression ä¸€èŠ‚ï¼‰ã€‚</li></ol></li><li>In-place I/O: æ¯”è¾ƒ hackï¼ŒåŒ…å«ä¸€äº›æ ¸å¿ƒä¼˜åŒ–ï¼Œç»™ä¸€äº›éœ€è¦ decompressed çš„ Page å‡†å¤‡çš„ã€‚è¿™é‡Œè®¤ä¸ºå¤§å—è¯»ä¸ä¼šè¢«åå¤è¯·æ±‚ï¼Œæ‰€ä»¥æŠŠ page æ”¾åˆ°<strong>è¿ç»­çš„è§£å‹ç¼© Buffer çš„å°¾éƒ¨</strong></li></ol><p>ï¼ˆè¿™æ®µæœ‰ç‚¹æŠ½è±¡ï¼Œå¯ä»¥çœ‹åé¢çš„ decompression ä¸€èŠ‚ï¼Œé…åˆç†è§£ï¼‰</p><h3 id="Decompression"><a href="#Decompression" class="headerlink" title="Decompression"></a>Decompression</h3><p><img src="https://image.mwish.me/blog-image/8833660903331583403.png" alt="img"></p><p>å¦‚ä¸Šå›¾ï¼Œå‡è®¾ç°åœ¨ç”¨æˆ·éœ€è¦ D4/D6 ï¼Œè¿™é‡Œéœ€è¦çœ‹çœ‹ Cache-IO æ€ä¹ˆå¤„ç†</p><p><img src="https://image.mwish.me/blog-image/5182527977773199469.png" alt="img"></p><p>å¦‚ä¸Š (b)ï¼Œè¿™é‡Œ EROFS åªéœ€è¦ D3 D4ï¼Œæ‰€ä»¥å®ƒï¼š</p><ol><li>å‘èµ·ä¸¤ä¸ª Page çš„ç‰©ç† io</li><li>å‡†å¤‡ä¸€äº› temporary page ç»™ D0-D2ï¼Œå› ä¸º å’Œ éœ€è¦ mapping çš„ Page ä¸ä¸€æ ·ï¼Œè¿™äº›æš‚æ—¶ä¸éœ€è¦ï¼Œç„¶åç›´æ¥è§£å‹ï¼Œç„¶å D3 D4 è§£å‹çš„ç”¨ <code>vmap</code> æ˜ å°„å¥½ä¸¢ç»™ç”¨æˆ·å±‚</li></ol><p>å¦‚æœæ˜¯ in-place I/Oï¼Œ<strong>é‚£ä¹ˆå¦‚åŒ (d)</strong>ï¼Œè¿™é‡Œ C0 ä¼šè¢«æ”¾åˆ°å°¾éƒ¨ï¼Œç„¶åç›´æ¥è§£å‹å®Œã€‚</p><p>è¿™é‡Œè¿˜æœ‰å‡ ä¸ªå·¥ç¨‹ä¼˜åŒ–ï¼š</p><ol><li>å°é¡µé¢ç”¨ Per-CPU buffer decompressionã€‚å› ä¸ºå¾ˆå¤šå°é¡µé¢è§£å‹ï¼ŒEROFS ç¦æ­¢äº†åˆ‡æ¢ï¼ˆåœ¨ç¬¬äº”èŠ‚ä»‹ç»çš„ï¼‰ç„¶ååˆ‡æˆ per-cpu çš„å°é¡µé¢è§£å‹ï¼Œè¿™é‡Œå†è§£å‹ç¼©é¡µé¢å°äº 4ä¸ª page çš„æ—¶å€™æ‰ä¼šä½¿ç”¨ï¼Œä¾‹å¦‚ 3(c). å½“ç„¶è¿™é‡Œä¹Ÿéœ€è¦æ‹·è´å‡ºå»äº†</li><li>Rolling decompression: ä¸ºäº†é¿å…ä¸éœ€è¦çš„å†…å­˜ç”³è¯·å¤ªå¤šï¼Œè¿™é‡Œä¼šæ¯ä¸ª CPU å‡†å¤‡ 16 ä¸ª Physical Pagesï¼Œç„¶åæ»šåŠ¨ decompress</li></ol><p><img src="https://image.mwish.me/blog-image/4188107683917911099.png" alt="img"></p><p>æ­¤å¤–ï¼Œå¦‚æœå½“ figure5 è¿™ç§åœºæ™¯å‡ºç°çš„æ—¶å€™ï¼Œä¹Ÿä¼šä½¿ç”¨ä¸´æ—¶çš„ Per-cpué¡µé¢ã€‚</p><h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ol><li><a href="https://www.usenix.org/system/files/atc19-gao.pdf">https://www.usenix.org/system/files/atc19-gao.pdf</a></li><li><a href="https://www.usenix.org/conference/atc19/presentation/gao">https://www.usenix.org/conference/atc19/presentation/gao</a> (Presentation)</li><li><a href="https://www.androidauthority.com/android-linux-784964/">https://www.androidauthority.com/android-linux-784964/</a></li><li><a href="https://wiki.archlinux.org/title/sparse_file">https://wiki.archlinux.org/title/sparse_file</a></li></ol>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>VLDB&#39;23: Query Partition in Napa</title>
      <link href="/2023/09/08/VLDB-23-Query-Partition-in-Napa/"/>
      <url>/2023/09/08/VLDB-23-Query-Partition-in-Napa/</url>
      
        <content type="html"><![CDATA[<p>Google åœ¨ VLDBâ€™21 å¹´å‘è¡¨äº† Napa çš„è®ºæ–‡ï¼š Napa: Powering Scalable Data Warehousing with Robust Query Performance at Googleã€‚Napa æœ¬èº«å®šä½æ˜¯ä¸€ä¸ªå¯¹ MV æ”¯æŒå¾ˆå¥½çš„æ•°ä»“ï¼Œå®ƒç”¨ LSM æ¥å­˜å‚¨å¯¹åº”çš„å†…å®¹ï¼Œè¯»æŸ¥è¯¢é€šå¸¸æ˜¯ Scan å’Œ Multi-key Lookupï¼ˆä¸‹é¢æ˜¯ Multi-key Lookup çš„ä¸€ä¸ªä¾‹å­ï¼Œæ„Ÿè§‰æ˜¯å¾ˆ ads çš„éœ€æ±‚ï¼‰ã€‚</p><p>åœ¨æŸ¥è¯¢å»¶æ—¶ä¸Šï¼ŒNapa çš„éœ€æ±‚æ¯”è¾ƒé«˜ï¼Œé€šå¸¸å®ƒéœ€è¦åœ¨å‹ç§’çº§çš„æ—¶é—´å†…å®Œæˆä¸€äº›æŸ¥è¯¢ã€‚åœ¨æ•°æ®ä¸Šï¼ŒNapa æœ‰æ•°ç™¾ä¸ª databasesï¼Œå…¶ä¸­æœ‰æ•°åƒä¸ª Table å’Œ MV.æœ‰äº›è¡¨å¤§å°ç”šè‡³åˆ°è¾¾äº†å‡  PBã€‚è¿™äº›è¡¨ä¹Ÿä¼šè¢«ä¸Šæ¸¸æµç³»ç»Ÿå¾ˆé¢‘ç¹çš„æ›´æ–°ã€‚ç”¨æˆ·å¸Œæœ›æ•°æ®æœ‰ä¸€å®šçš„å®æ—¶æ€§ã€‚ä¸ºäº†æ»¡è¶³è¿™ä¸ªéœ€æ±‚ï¼ŒNapa å®ç°äº† LSM-Tree å’ŒåŸºäº LSM çš„ MV ç»´æŠ¤å¼•æ“ã€‚</p><p><img src="https://image.mwish.me/blog-image/5678331180122730692.png" alt="img"></p><p>ä¸Šè¿° Figure1 ä¾‹å­ä¸­ï¼ŒNapa ä»¥ <code>K1, K2, K3</code> ä¸ºä¸»é”®ï¼Œå¹¶æŒ‰ç…§ <code>K..</code> æ’åºã€‚è¿™é‡Œä¸»è¦éœ€æ±‚æ˜¯å¯¹è¿™ä¸€ç»„æŸ¥è¯¢ï¼ˆ<code>K1, K2</code> çš„å‰ç¼€ keyï¼‰é‡‡å–å¹¶è¡ŒæŸ¥è¯¢ï¼Œé€šè¿‡æ‰“å¤§å¹¶å‘é™ä½å¯¹åº”çš„å»¶è¿Ÿã€‚</p><p>è¿™é‡Œæœ‰ä¸€äº›æ¯”è¾ƒé‡è¦çš„éƒ¨åˆ†ï¼š</p><ol><li>Query-specific partition: æ ¹æ®æŸ¥è¯¢ç”Ÿæˆå¯¹åº”çš„å¹¶å‘åº¦å’Œ Partitionï¼Œæ¥ match å¯¹åº”çš„ SLO</li><li>Evenness: Partition éœ€è¦èƒ½å¤Ÿå¤„ç† skew çš„æƒ…å†µï¼Œe.g. Figure1 ä¸­ <code>&lt;K1 = 1, K2 = 20&gt;</code> æ•°æ®å¯èƒ½æœ‰å‡ ç™¾ GB</li><li>Progressiveness: è¿™ä¸ªæœ‰ç‚¹ç±»ä¼¼ Planner(ä½†æˆ‘å…¶å®ä¸å¤ªæ‡‚ï¼Œæˆ‘ç†è§£æ˜¯æœ‰ç‚¹åƒï¼Œä½†ä¹Ÿå¯èƒ½æ ¹æœ¬ä¸ä¸€æ ·)ã€‚ç®—å‡ºä¸€ä¸ª Perfect çš„ Partition æ˜¯å¾ˆè´¹æ—¶é—´çš„ï¼Œåªè¦ç®—å‡ºæ¥é¢„ä¼°å·®ä¸å¤šæ»¡è¶³ SLO éœ€æ±‚å°±å¯ä»¥åœæ‰‹å»æ‰§è¡Œäº†ã€‚æ‰€ä»¥è¿™ä¸ªç®—æ³•æ˜¯æ¸è¿›å¼çš„ã€‚</li></ol><p>åœ¨æœ¬è®ºæ–‡ä¹‹å‰ä¹Ÿæœ‰å¾ˆå¤š database partition çš„éœ€æ±‚ï¼ŒåŒ…æ‹¬ write-time partition(ä¸»åŠ¨ partition, compaction, snowflake é£æ ¼çš„ micro-partition) å’ŒæŸ¥è¯¢å¹¶è¡Œ. ä½œè€…è®¤ä¸ºè¿™é‡Œè§£å†³çš„é—®é¢˜ä¸å®Œå…¨ä¸€æ ·ï¼ˆä½†æˆ‘è§‰å¾—è‚¯å®šå¯ä»¥æ•´åˆåˆ°ä¸€èµ·ï¼‰ï¼Œå‡å¦‚ç”¨ Partition çš„æ–¹å¼è§£å†³å¹¶è¡Œé—®é¢˜çš„è¯ï¼š</p><ol><li>Partition Unit å°çš„è¯ï¼Œ Metadata ç»´æŠ¤å¼€é”€å¾ˆå¤§ï¼Œè®¿é—® metadata çš„ latency ä¼šå¢åŠ </li><li>Partition Unit å¤§çš„è¯ï¼Œå¦‚æœæŒ‰ç…§ Partition æ¥å¹¶è¡Œçš„è¯ï¼Œå¯èƒ½è¯»æ•°æ®çš„ latency ä¸‹ä¸å»</li></ol><p>è®ºæ–‡ä¸­å®éªŒä¹Ÿè¡¨æ˜ï¼Œç”¨å¤ªç»†çš„ä¸œè¥¿åš plan çš„è¯ï¼Œè¿™éƒ¨åˆ† planning å¼€é”€ä¹Ÿä¼šå‡é«˜ã€‚è¿™éƒ¨åˆ† Napa å’Œ Btree ç»“åˆèµ·æ¥äº†ï¼Œå®ƒçš„ LSM Sorted Run æœ¬èº«æ˜¯ä¸ª DataBlocks + Btree (çœ‹ç€åƒæ˜¯ç”¨ Btree ç»„ç»‡äº†ä¸€ç»„ SSTï¼Œç±»ä¼¼ Kudu çš„ Block å­˜å‚¨ï¼Œä¼šæ ¹æ® Btree æ¥ç»„ç»‡ï¼Œè§ <a href="https://github.com/apache/kudu/blob/master/docs/design-docs/tablet.md#handling-mutations-against-on-disk-files">https://github.com/apache/kudu/blob/master/docs/design-docs/tablet.md#handling-mutations-against-on-disk-files</a> ã€‚RocksDB çš„ Index ä¹Ÿå¤§æ¦‚æ˜¯è¿™ç§æ–¹å¼ç»„ç»‡çš„)ï¼Œæ¯å±‚æœ‰ä¸€äº›ç»Ÿè®¡ä¿¡æ¯ï¼Œè¶Šä¸Šé¢è¶Šç²—ç•¥ã€‚Napa é€šè¿‡è¿™ç§æ–¹å¼æ¥åšåˆ‡åˆ†ã€‚å¦‚æœ Btree ä¸Šå±‚èŠ‚ç‚¹è¶³å¤Ÿäº†å°±ç”¨ä¸Šå±‚çš„ï¼Œä¸Šå±‚åˆ‡ä¸å‡ºæ¥æˆ–è€…ä¸å¤Ÿè¯¦ç»†å°±è¦è®¿é—® Btree ä¸‹å±‚ã€‚(ä¹‹å‰åœ¨ bg å¥½åƒæè¿‡ç±»ä¼¼çš„ï¼Œä¸è¿‡å®ƒè¿™é‡Œå¥½å¤„è¿˜æ˜¯ immutable + å’Œç»Ÿè®¡ç»“åˆ)</p><h2 id="ç›¸å…³å·¥ä½œ"><a href="#ç›¸å…³å·¥ä½œ" class="headerlink" title="ç›¸å…³å·¥ä½œ"></a><strong>ç›¸å…³å·¥ä½œ</strong></h2><p>å¹¶è¡Œå¤„ç†çš„ä¸»è¦å·¥ä½œåŸºæœ¬ä¸Šæ˜¯å¹¶è¡ŒåŒ– SQL + SIMD æ¨¡å‹æ¥æŸ¥è¯¢ã€‚æ—©æœŸçš„æ‰¹å¤„ç†å·¥ä½œç±»ä¼¼ Map Reduce ä¸€ä¸ª idea å°±æ˜¯åˆ‡åˆ†è¾“å…¥å¹¶å¹¶è¡Œã€‚</p><p>åœ¨æ•°æ®åº“è¿ç§»åˆ°äº‘ä¸Šæˆ–è€…åšå¤§è§„æ¨¡å¤„ç†çš„æ—¶å€™ï¼Œæµè¡Œçš„æ–¹å¼æ˜¯å¯¹ Key åš {Hash/Range} Partitionã€‚è¿™ç§æ–¹å¼ä¹Ÿå…è®¸ç”¨æˆ·åš Collocate Joinï¼Œå¹¶ä¸”èƒ½å¤Ÿå°½é‡é¿å… distributed transaction ï¼ˆ For OLTP workloads, graph-based [6, 20] and skew-aware [19] partitioning approaches have been developed to minimize the number of distributed transactions. ï¼‰ã€‚è¿™ç§æ–¹å¼å€¾å‘äºå†™æ—¶ç»´æŠ¤ Partitionï¼ˆåºŸè¯ï¼ŒTP åˆ†å¸ƒå¼äº‹åŠ¡æˆ–è€…å¤šèµ°äº†ä¸€è½®å¼€é”€å¤§æ˜¯è¿™æ ·çš„ï¼‰</p><p>åœ¨æŸ¥è¯¢çš„æ—¶å€™åš Partition æ²¡æœ‰é‚£ä¹ˆç›´æ¥çš„å·¥ä½œï¼Œæ¯”è¾ƒæ¥è¿‘çš„å·¥ä½œæ˜¯ database crackingã€‚æœ¬ä½œå‡†å¤‡ç”¨ RL ç³Šå±æ¥è§£å†³ä¸åŒç”¨æˆ·çš„è¾“å…¥ã€‚</p><h2 id="Napa"><a href="#Napa" class="headerlink" title="Napa"></a><strong>Napa</strong></h2><p>Napa å¹äº†ä¸€ä¸‹è‡ªå·±ç³»ç»Ÿå‡ ä¸ªéœ€æ±‚ï¼š</p><ol><li>Robust Query Performance: äºšç§’çº§å“åº”ï¼Œadhoc æŸ¥è¯¢</li><li>System Flexibility: Napa çš„æ€§èƒ½ä¸‰è§’ï¼Œå…è®¸æ‹¿é’±ä¹‹ç±»çš„æ¢ freshness</li><li>High-throughput Data Ingestion: Napa ä¼šæœ‰å¾ˆå¤§çš„å†™å…¥é‡</li></ol><p>Napa çš„æ¯ä¸ª Delta Set ç›¸å½“äº LSM çš„ Sorted Runï¼Œå®ƒä»¬ä¼šè¢«ç»„ç»‡æˆ btreeã€‚æ¯ä¸ª Delta çš„ Btree å†…éƒ¨æ˜¯æ²¡æœ‰ MVCC çš„ï¼ˆä¸åƒ RocksDB å¯èƒ½ä¼šæŠŠåŒä¸€ä»½æ•°æ® Duplicate ä¸åŒæ—¶é—´æˆ³çš„å¤šæ¬¡æ“ä½œï¼‰ã€‚ä¸ºäº†æ”¯æŒ Statistics çš„éœ€æ±‚ï¼Œè¿™é‡Œä¼šè®¾è®¡æ¯å±‚çš„ Statisticsï¼Œçˆ¶äº²çº§åˆ« Agg å­å±‚çº§çš„ç»Ÿè®¡ä¿¡æ¯ã€‚</p><h2 id="å»ºæ¨¡"><a href="#å»ºæ¨¡" class="headerlink" title="å»ºæ¨¡"></a><strong>å»ºæ¨¡</strong></h2><h3 id="LSM"><a href="#LSM" class="headerlink" title="LSM"></a><strong>LSM</strong></h3><p>åœ¨ napa ä¸­ï¼Œæ¯ä¸ªæ–‡ä»¶æ˜¯ immutable çš„ï¼Œåœ¨ napa çš„è®¾è®¡ä¸­å«åš Deltaã€‚å¯¹åº”æ ¼å¼æ˜¯ä¸€ä¸ª btreeï¼Œå¯¹åº” napa ä¸­çš„ä¸€ä¸ªæ—¶é—´èŒƒå›´ï¼Œ<strong>å’Œæ–‡ä»¶çš„ indexes</strong>ã€‚Napa é‡‡ç”¨äº† Tiered Compaction çš„å½¢å¼ï¼ˆè¯è¯´ä¹‹å‰çœ‹ G.Goetz çš„ç®€å†ä¸Šè¯´ä»–ç°åœ¨è¿˜åœ¨ç»´æŠ¤ napa çš„ compactionï¼‰ï¼Œå®ƒæ—¶é—´æˆ³å’Œ Compaction é€»è¾‘ç»´æŠ¤å½¢å¼<strong>æœ‰ç‚¹ç±»ä¼¼äº ClickHouse</strong>ï¼Œæ–‡ä»¶è½åˆ° Napa çš„æ—¶å€™æ‹¿åˆ°ä¸€ä¸ªç»Ÿä¸€çš„æ—¶é—´æˆ³ï¼ˆ<code>[T1, T1]</code>)ï¼ŒCompaction çš„æ—¶å€™äº§ç”Ÿæ–°çš„æ—¶é—´æˆ³ Range(<code>[T1, T3]</code>)ã€‚</p><p>å½“ Table å­˜åœ¨ unique key æˆ–è€… primary key çš„æ—¶å€™ï¼Œè¿™é‡Œéœ€è¦åšè¯»çš„æ—¶å€™ dedup (ç±»ä¼¼ Hudi MORï¼‰ã€‚Napa ä¼¼ä¹ä¸ä¼šå¯¹ç³»ç»Ÿåšå‡å®š(ç±»ä¼¼ Hudi ä¸å‡å®šå‰é¢æ˜¯ MOR è¿˜æ˜¯ COWï¼Ÿï¼‰ã€‚</p><p>ä½œè€…è®¤ä¸º LSM å¢åŠ äº† Query Partition çš„å¤æ‚åº¦ã€‚ä¸»è¦è¿˜æ˜¯å› ä¸ºå®ƒä¸æ˜¯ btr é‚£æ ·å•å±‚çš„æ¨¡å‹ï¼Œä¸€ä¸ª key å¯èƒ½å­˜åœ¨å¤šå¤„ã€‚è¿™ä¹Ÿç»™æŸ¥è¯¢ evenness çš„ä¼°è®¡å¸¦æ¥äº†ä¸€å®šçš„å¤æ‚åº¦ã€‚æœ€åä¸€ç‚¹æ˜¯ï¼Œä¸åŒå±‚çš„ Sorted Run å¯èƒ½å› ä¸ºæ•°æ®åˆ†å¸ƒä¸åŒï¼Œåœ¨å®ƒä»¬ä¸Šé¢ Plan Partition çš„éš¾åº¦ä¹Ÿä¸åŒã€‚</p><h3 id="æŸ¥è¯¢"><a href="#æŸ¥è¯¢" class="headerlink" title="æŸ¥è¯¢"></a>æŸ¥è¯¢</h3><p><img src="https://image.mwish.me/blog-image/4965052238396183469.png" alt="img"></p><p>Napa æœ‰ä¸€äº›å•æœºçš„ scan worker ï¼š</p><ul><li>èƒ½å¤Ÿæ‰§è¡Œï¼šSelection, projection, partial (local) agg</li><li>è¾“å‡ºå¯ä»¥æ˜¯åˆ«çš„ downstreamï¼Œå¯èƒ½ä¼šè¢« full agg, sort, join ä¹‹ç±»çš„æ¶ˆè´¹å¯¹åº”çš„è®¡ç®—</li></ul><p>Napa çš„æŸ¥è¯¢ä¼˜åŒ–å™¨ä¼šå°½é‡æŒ‰ç…§ PK æŠŠç”¨æˆ·çš„ Predicates åšæˆå‰ç¼€ï¼ˆæ„Ÿè§‰æœ‰ pk çš„è¡¨å¤§å®¶éƒ½è¿™ä¹ˆæçš„ï¼Œä½†æ˜¯è¿™é‡Œæœ‰ç‚¹ç±»ä¼¼ PGï¼Œ<code>&lt;pk1, pk2...&gt;</code> é‡Œé¢ï¼Œå³ä½¿åªæœ‰ <code>pk2 == ...</code>, å®ƒä¹Ÿä¼šå°è¯•æ„å»º Prefixï¼‰ï¼Œåœ¨ä¸Šè¿°æŸ¥è¯¢ä¸­æœ‰ä¸‹åˆ—çš„ transformã€‚</p><p><img src="https://image.mwish.me/blog-image/2987111351221671228.png" alt="img"></p><p>åœ¨åš Partition çš„æ—¶å€™ï¼Œå› ä¸º filter selectivity çš„ä¸åŒï¼Œscan worker é…ç½®çš„èµ„æºä¸ä¸€æ ·ï¼Œæ‰€ä»¥æŸ¥è¯¢çš„æ—¶å€™ partition çš„æƒ…å†µä¹Ÿä¸åŒï¼ˆè¿™é‡Œå¤§æ¦‚å¯ä»¥ç†è§£æˆï¼Œè®ºæ–‡é‡Œçš„ size æ˜¯åŸå§‹æ•°æ®çš„å¤§å°ï¼Œåº”è¯¥ä¸æ˜¯ filter ä¹‹åçš„å¤§å°ï¼‰ã€‚æ‰€ä»¥æœ€ä½³çš„ partition unit size å¯èƒ½ä» 10MB - 1GBã€‚æ­¤å¤–è¿˜æœ‰ä¸ªé—®é¢˜æ˜¯æŸ¥è¯¢çš„ skewã€‚Napa å¯¹äº <code>&lt;c, d&gt;</code> è¿™ç§è¡¨ï¼Œå½“ <code>d = d3</code> çš„æ—¶å€™ï¼Œæ„å»ºçš„å‰ç¼€å¯èƒ½è¦†ç›–äº†æ•´å¼ è¡¨çš„å¤§éƒ¨åˆ†ç©ºé—´ï¼ˆé‚£ä½ å°±åˆ«è¿™ä¹ˆæå•Šâ€¦ï¼‰è¿™ä¹Ÿè¡¨æ˜ï¼ŒPartition è§„åˆ’éœ€è¦æ˜¯æ¸è¿›å¼çš„ï¼Œèƒ½å¤Ÿé˜²æ­¢æ„å»ºçš„ç²’åº¦è¿‡ç»†ã€‚</p><p>Napa è®¤ä¸º write-time partition å¹¶ä¸å¥½å¤„ç†è¿™ç§ caseï¼Œä¸»è¦åŸå› è¿˜æ˜¯å®ƒï¼š</p><ol><li>å†™çš„æ—¶å€™åˆ‡çš„å¤ªç»†çš„è¯æˆ–è€…å¤ªç²—çš„è¯ï¼Œè¯»è€…éœ€æ±‚éƒ½ä¸ä¸€å®šå®Œå…¨æ»¡è¶³ã€‚æ¯•ç«Ÿéƒ½æ˜¯ adhoc query å’Œä¸åŒçš„èµ„æºåœ¨åˆ°å¤„é£˜</li><li>Hash Cluster ä¹‹ç±»çš„æƒ…å†µä¸å¤ªèƒ½å¤„ç† skew æˆ–è€… <code>d = d3</code> è¿™ç§æŸ¥è¯¢ã€‚å¯èƒ½å¯¼è‡´ Partition è§„åˆ’çš„å¼€é”€é«˜ï¼Œç®—èµ·æ¥è¿˜å› ä¸º Partition skew æ€§èƒ½ä¸å¤ªå¥½ã€‚</li></ol><p>ç„¶å G+ çš„äººä¸è£…äº†ï¼Œæ‰¯äº†è¿™ä¹ˆä¹…æ‰ä»‹ç»è‡ªå·±çš„éœ€æ±‚:</p><blockquote><p>Note by this example, we have established that partitioning is highly specific to query under consideration and existing writetime partitioning is inadequate for workloads with a wide spectrum of query workloads</p></blockquote><p>æ€»ä¹‹ G+ çš„äººæ˜¯æƒ³è¦åœ¨ PROGRESSIVE PARTITIONING ä¸­å‘æ˜ Partition çš„éœ€æ±‚ï¼Œæ¸æ¸å‘ç°ã€ŒPlan Partition å¿«ã€æŸ¥è¯¢ä¹Ÿæ»¡è¶³ SLOã€çš„çœŸç›¸</p><h2 id="Progressive-Parititoning"><a href="#Progressive-Parititoning" class="headerlink" title="Progressive Parititoning"></a>Progressive Parititoning</h2><p>é‚£ä¹ˆï¼ŒNapa å·²ç»æœ‰ï¼š</p><ol><li>æ¯ä¸ª Delta æœ‰ä¸€ä¸ª B-tree, ç»´æŠ¤æŒ‡å‘æ¯ä¸ª PAX layout Block çš„ size ç­‰ Statistics</li><li>ä¸€å®šæ•°é‡çš„ scan workers, å’Œä» workers + QoS å¯ä»¥æ¨æ–­çš„ç›®æ ‡ Partition æ•°é‡ P</li><li>margin ratio: theta, ç”¨äºæ§åˆ¶è¡¡é‡ Partition çš„ç»“æœï¼Œè¡¨æ˜é¢„ä¼°çš„å¤§å°å’Œå®é™…åˆ†ç‰‡å¤§å°å¯èƒ½çš„åå·®ã€‚ç®—æ³•çš„é¢„æœŸæ˜¯éšç€è¿è¡Œè®©è¿™ä¸ªè¯¯å·®å°½é‡å°ã€‚æ»¡è¶³é¢„æœŸçš„æ—¶å€™ï¼Œç®—æ³•æ¨å‡º</li></ol><p>ç®—æ³•çš„é¢„æœŸæ˜¯ï¼š</p><ul><li>ç»™å®šæŸ¥è¯¢ Qï¼Œç®—æ³•èƒ½å¤Ÿåˆ‡åˆ† D ç»„ Deltas æˆä¸º P ä¸ª key-range Partition, error margin å¯¹åº”æ˜¯ theta</li><li>é¢„æœŸå¤§å° == æ ¹æ® Btree Indices çš„å¤§å°å’Œ combine-key æ¥æ¨æ–­</li></ul><p>Figure 4-5 æ¼”ç¤ºäº†ç®—æ³•å·¥ä½œçš„æµç¨‹ã€‚Figure 4 å±•ç¤ºäº†æœ‰å››ä¸ª Delta çš„è¡¨ä¸­ï¼Œå½“ P = 2 çš„æ—¶å€™ï¼ŒæŸ¥è¯¢ K1-K8 æ—¶å€™çš„åˆ‡åˆ†ã€‚åœ¨ Figure4 å¯ä»¥çœ‹åˆ°ï¼ŒDelta#1 æŸ¥è¯¢ btree æ·±åº¦æ›´å¤§ï¼Œè€Œ Delta#2 æ›´æ—©åœä¸‹äº†ã€‚å› ä¸ºç®—æ³•è®¤ä¸ºè¾¾åˆ°äº† error margin ratioã€‚å½“ç„¶è¿™ä¸ªç®—æ³•ä¹Ÿå¯ä»¥å¾€ä¸‹åˆ‡ï¼Œ<strong>ä½ å¯ä»¥ç†è§£æˆè¿™é‡Œçš„è®¿é—®æ˜¯ä¸€ä¸ª stack æˆ–è€… waveï¼Œè®¤ä¸ºæŸä¸ªåœ°æ–¹å¯ä»¥åˆ‡ç»†ï¼Œå°±å¯ä»¥è®¿é—®å­èŠ‚ç‚¹</strong>ã€‚</p><p>Figure 5 å±•ç¤ºäº†å…·ä½“åˆ‡åˆ†çš„æ•ˆæœï¼Œè¿™é‡Œå¦‚æœæŒ‰ç…§ä¼°è®¡ï¼Œæ€»å¤§å°ä¸Šé™æ˜¯ 70ï¼Œå‡å¦‚æŒ‰ç…§ Figure 5ï¼Œç®—æ³•åœ¨ K4-K5 ä¹‹é—´åˆ‡åˆ†ï¼Œé‚£ä¹ˆæ ¹æ®ç®—æ³•å¯ä»¥ç®—å‡ºæ¯ä¸ª Partition çš„ min-max å¤§å°ã€‚å¦‚ Figure5.</p><p><img src="https://image.mwish.me/blog-image/9198748789641734866.png" alt="img"></p><p><img src="https://image.mwish.me/blog-image/648885662659901694.png" alt="img"></p><p>Margin Ratio å¯ä»¥æŒ‰ç…§ <code>(Max - Min ) * 2 /  (Max + Min)</code> æ¥è®¡ç®—ã€‚å¦‚æœä¸¤ä¸ª Partition æ¯”ç‡åˆç†ï¼Œé‚£ä¹ˆ theta è¢«è§†ä¸ºè¶³å¤Ÿå¥½äº†ï¼Œå¦åˆ™ç®—æ³•ä¼šè®¿é—® btree çš„æ·±å±‚æ¥æç»Ÿè®¡ä¿¡æ¯ã€‚æ¯”å¦‚æŠŠ <code>[K4, K8]</code> ç´¢å¼•å†æ¢æ·±ä¸€å±‚ï¼ˆNapa ç§°è¿™ç§æ“ä½œä¸º Drill Downï¼‰</p><p>Drill Down åªæ˜¯éƒ¨åˆ†çš„</p><blockquote><p>Note that we only need to drill down entries contributing to the error margin. The other entries are kept in the working set (called the set) without matching entry drill down.</p></blockquote><p>ä½†æˆ‘ä¸çŸ¥é“è¿™ä¸ª Contribute æ˜¯æ€ä¹ˆåˆ¤å®šçš„ã€‚ã€‚ã€‚Margin Ratio å¤§å°åˆé€‚åº¦åˆæ˜¯æ€ä¹ˆåˆ¤å®šçš„ã€‚ã€‚ã€‚è¿™äº›éƒ½ä¼šåœ¨ç®—æ³•ç»†èŠ‚éƒ¨åˆ†ä»‹ç»ï¼æœªå®Œå¾…ç»­ï¼</p><h3 id="ç®—æ³•ç»†èŠ‚"><a href="#ç®—æ³•ç»†èŠ‚" class="headerlink" title="ç®—æ³•ç»†èŠ‚"></a>ç®—æ³•ç»†èŠ‚</h3><p>å‡å®š Delta ä¸º <script type="math/tex">\{1, ..., D\}</script>ï¼Œç¬¬ i ä¸ªæŸ¥è¯¢ä¸º <script type="math/tex">d_{i}</script>ã€‚ç»™å®šæŸ¥è¯¢ Qï¼Œ <script type="math/tex">d_{i}</script>ä¸­æ»¡è¶³è¦æ±‚çš„æ¡ç›®ç§°ä¸º mathing entry set <script type="math/tex">E_{i}</script>. é‚£ä¹ˆåœ¨æŸ¥è¯¢ä¸­ä¹Ÿå¯ä»¥æ‰¾åˆ°ä¸€ç»„æ»¡è¶³è¦æ±‚çš„ <script type="math/tex">\{E_{1}, E_{2}, ..., E_{D}\}</script>ã€‚å¯¹äºæ¯ä¸ª B-tree èŠ‚ç‚¹ï¼Œè¿™é‡Œå¯ä»¥æ‰¾åˆ°å­æ¡ç›® <script type="math/tex">e_{i}</script>å’Œ <script type="math/tex">e_{i+1}</script>ï¼Œæ¯ä¸ªæ¡ç›®çš„ size ç­‰çº§äºè‡ªå·±å­éƒ¨åˆ†å†…å®¹çš„ size å’Œã€‚å®ƒçš„ç»Ÿè®¡ä¿¡æ¯å¯ä»¥ç®€åŒ–ä¸º <code>e = &lt;start, end, size, level, block&gt;</code>ï¼Œ<code>[start, end)</code> ä»£è¡¨ key-range. <code>level</code> ä»£è¡¨å¯ä»¥ dive çš„å±‚æ•°ï¼ˆæˆ‘ç†è§£å±‚æ•°åº”è¯¥æ˜¯ hidden çš„ï¼Œä¸ç”¨å­˜ï¼Œåªæ˜¯ä¸ªæŠ½è±¡?ï¼‰ï¼Œ<code>e.block</code> æ˜¯ child index block çš„æ•°é‡ã€‚</p><p>ç®—æ³•ä¼šé€æ¸æ¨è¿›ï¼Œä»ä¸€ä¸ª (virtual) root entry æ‰©å±•å¼€æ¥ï¼Œæ¯æ¬¡åˆ°ä¸€å±‚å¯ä»¥æ›´æ–°ä¸€æ‰¹ matching entry setï¼Œç›¸å½“äºé€šè¿‡ IO ï¼ˆå’Œéƒ¨åˆ† CPU ä¸ç»´æŠ¤æˆæœ¬ï¼‰æ¥æä¾›æ›´ç²¾ç»†çš„ç»Ÿè®¡ã€‚è¿™é‡Œæä¾›çš„å†…å®¹åŸºæœ¬ä¸Šæ˜¯ <strong>maximum size estimate</strong>ã€‚è¿™ä¸ªç²¾ç»†åŒ–çš„è¿‡ç¨‹å°±æ˜¯ DrillDownï¼š</p><p><img src="https://image.mwish.me/blog-image/3125270644515696735.png" alt="img"></p><p>DrillDown æœ¬èº«å¯èƒ½å¼•å…¥ IOï¼ˆè€å®è¯´æˆ‘æ„Ÿè§‰ btr è¿™ä¸ªä¸œè¥¿æœ¬èº«å°±å¾ˆå®¹æ˜“ç¼“å­˜ï¼Œä½†æ˜¯è¿™ç§å¤§è§„æ¨¡æŸ¥è¯¢å¯èƒ½ç¼“å­˜å‘½ä¸­ç‡ä¹Ÿåšä¸åˆ°å¾ˆé«˜ï¼Œå…·ä½“å¾—æµ‹æµ‹æˆ–è€…ç»“åˆ RocksDB Index çš„ç»éªŒçœ‹çœ‹ï¼‰ã€‚æ‰€ä»¥è¿™é‡Œå¯èƒ½ä¼š Batch è®¿é—®ä¸‹å±‚æ¥ä¼˜åŒ–ï¼ˆè¯´å®è¯æˆ‘çœŸä¸æ‡‚è¿™äº†ã€‚ã€‚ã€‚è™½ç„¶æˆ‘çœ‹ç€æ‡‚ä»–çš„æ„æ€ï¼Œä½†æ˜¯è„‘éƒ¨ä¸å‡ºä¸ºå•¥è¦è¿™ä¹ˆå†™ï¼‰</p><h4 id="Split-point-candidates"><a href="#Split-point-candidates" class="headerlink" title="Split point candidates"></a>Split point candidates</h4><p>ä¸‹é¢æ˜¯åˆ°ä¸€ç»„ Entry Sets  <script type="math/tex">\{E_{1}, E_{2}, ..., E_{D}\}</script>é‡Œé¢å¯»æ‰¾<strong>æ‰€æœ‰çš„ bonadry-key</strong> <script type="math/tex">\{k_{1}, k_{2}, ..., k_{m}\}</script>å’Œå¯¹åº”çš„ cumulative å¤§å°å’Œ<script type="math/tex">\{c_{1}, c_{2}, ..., c_{m}\}</script>. è¿™é‡Œå¸Œæœ›è¿™é‡Œé¢çš„åˆ‡åˆ†èƒ½å¤Ÿå°½é‡å‡åŒ€. åœ¨è¿™é‡Œ <script type="math/tex">k_{i}</script>å’Œä¸‹ä¸€ä¸ª key ä¸­é—´çš„æŸä¸ª key è¢«ç§°ä¸º i split point candidate ã€‚é€‰ä½œä¸­é—´æŸä¸ª key æ˜¯ä¸€ä¸ª <strong>short-key ä¼˜åŒ–</strong>ï¼ˆç±»ä¼¼å¤„ç† min-max è¿‡é•¿æ—¶å€™çš„ä¼˜åŒ–<strong>ï¼‰ã€‚</strong></p><p><script type="math/tex">c_{i}</script>å®ç°ä¸Šæœ‰ç‚¹ç±»ä¼¼ DPï¼Œä¼šé€‰å–&lt;ä»é›¶åˆ°è¿™ä¸ªè¿™ä¸ªkey çš„ sizeå¯èƒ½çš„æœ€å°&gt;å’Œ&lt;ä»é›¶åˆ°è¿™ä¸ªè¿™ä¸ªkey çš„ sizeå¯èƒ½çš„æœ€å¤§&gt;ã€‚è¿™ä¸ªè¯´æ³•æœ‰ç‚¹æŠ½è±¡ï¼Œæˆªå›¾è®ºæ–‡äº†</p><p><img src="https://image.mwish.me/blog-image/6275015760304340221.png" alt="img"></p><p>ä¸‹é¢æ˜¯å…·ä½“çš„å‚æ•°ï¼š</p><p><img src="https://image.mwish.me/blog-image/2872769688922876604.png" alt="img"></p><p>é€šè¿‡è¿™ä¸ªç²—ç³™çš„è®¡ç®— size å’Œé”™è¯¯ç‡ã€‚è¿™ä¸ªé—®é¢˜ç­‰ä»·äºåœ¨æ‰€æœ‰ m ä¸ª key ä¸­åˆ‡å‡º P ä¸ª Parititionï¼ˆP-1 ä¸ª split pointï¼‰ã€‚</p><p>ä¸‹é¢æ˜¯æ‰¾åˆ°å…·ä½“çš„ split pointã€‚æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ª uniform partition ç®—æ³•ã€‚ç®—æ³•çš„ç›®æ ‡æ˜¯ï¼Œç»™å®š<script type="math/tex">\{c_{1}, c_{2}, ..., c_{m}\}</script>è®¡ç®—<script type="math/tex">\{s_{1}, s_{2}, ..., s_{p-1}\}</script>.å› ä¸ºè¿™é‡Œæœ‰ä¸€ä¸ªæ€»å¤§å°ï¼ˆç›¸å½“äºæœ€åä¸€ä¸ª <script type="math/tex">c_{m}</script>çš„ maxï¼‰ï¼Œæ‰€ä»¥æ ¹æ®æ€»å¤§å°èƒ½æ¨æ–­å‡ºæ¯ä¸ª Partition çš„æ¨èå¤§å°ã€‚ç„¶åæ‰«å‡ºä¸€ç»„ Partitionï¼Œä»–è¿™é‡Œç®—æ³•æˆ‘æ²¡çœ‹æ‡‚ï¼Œå¤æ‚åº¦å¦‚ä¸‹</p><p><img src="https://image.mwish.me/blog-image/1296285521936491971.png" alt="img"></p><p>ç„¶åè¿™é‡Œå†æ¬¡è®¡ç®— <script type="math/tex">\{s_{1}, s_{2}, ..., s_{p-1}\}</script> æ˜¯å¦è¶³å¤Ÿå¥½äº†ï¼Œä¸‹é¢æŒ‘é€‰å‡ºå¯¹åº”çš„ä¸åˆæ³•é›†åˆï¼š</p><p><img src="https://image.mwish.me/blog-image/1850538063534972728.png" alt="img"></p><p>è¿™é‡Œæ ¹æ®ä¸åˆæ³•çš„é›†åˆå°è¯•æ‰¾åˆ°éœ€è¦ dive çš„ entry</p><p><img src="https://image.mwish.me/blog-image/6739283094117746993.png" alt="img"></p><p>å¯ä»¥çœ‹åˆ°ï¼Œentry æ˜¯é’ˆå¯¹ key è€Œè¨€çš„ï¼Œè¿™é‡Œå¯ä»¥é’ˆå¯¹ key æ‰¾åˆ°ä¸€ç»„å¯¹åº”çš„éœ€è¦åˆ‡çš„ entryï¼Œç„¶åå°è¯•åˆ‡ä¸€ä¸‹ã€‚ï¼ˆè®ºæ–‡æè¿°äº†ä¸¤ç§åˆ‡åˆ†æ–¹æ³•ï¼‰</p><p><img src="https://image.mwish.me/blog-image/210579796710822954.png" alt="img"></p><p>ç»„åˆèµ·æ¥ç®—æ³•å¦‚ä¸‹ï¼š</p><p><img src="https://image.mwish.me/blog-image/140444377129215087.png" alt="img"></p><p>å·¥ç¨‹ä¸Šè¿™é‡Œæœ‰ä¸€äº›ä¼˜åŒ–ï¼š</p><ol><li>å…è®¸ç”¨æˆ·è®¾ç½® dopï¼Œä½†æ˜¯æ¯ä¸ª dop æœ‰æœ€å°å¤§å°é™åˆ¶ï¼Œç”¨æˆ·å¯èƒ½çå‡ æŠŠè®¾ï¼Œä¸èƒ½æå¤ªç»†</li><li>å…è®¸æ ¹æ® Scan çš„ size æ¥ä¼°è®¡ï¼Œè€Œä¸æ˜¯æ ¹æ® dop æ¥ä¼°è®¡ã€‚å› ä¸ºå¯èƒ½ scan size å¯¹äºæŸ¥è¯¢ä¼°è®¡æ¥è¯´æ˜¯ä¸ªæ›´å¥½çš„ä¸œè¥¿</li></ol>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>ç¿»è¯‘: Itâ€™s not always obvious when tail-call optimization is allowed</title>
      <link href="/2023/09/05/It%E2%80%99s-not-always-obvious-when-tail-call-optimization-is-allowed/"/>
      <url>/2023/09/05/It%E2%80%99s-not-always-obvious-when-tail-call-optimization-is-allowed/</url>
      
        <content type="html"><![CDATA[<p>åŸæ–‡é“¾æ¥ï¼š<a href="https://quuxplusone.github.io/blog/2021/01/09/tail-call-optimization/">https://quuxplusone.github.io/blog/2021/01/09/tail-call-optimization/</a></p><p>ç¿»è¯‘è®¸å¯ï¼š</p><p><img src="https://image.mwish.me/blog-image/311401252216574504.png" alt="img"></p><p>æˆ‘æœ€åˆæœ¬æ–‡ä½œä¸º <a href="https://quuxplusone.github.io/blog/2019/08/02/the-tough-guide-to-cpp-acronyms/">â€œA C++ acronym glossaryâ€</a> (2019-08-02) ä¸­çš„ä¸€éƒ¨åˆ†ç¼–å†™ï¼Œä½†å†³å®šæœ€å¥½å°†å…¶å•ç‹¬åˆ—å‡ºæ¥æ”¾åˆ°ä¸€ä¸ªåšå®¢ä¸­ã€‚</p><p>â€œTCOâ€ä»£è¡¨â€œtail call optimizationâ€ã€‚ è¿™æ˜¯ä¸€ç§ç¼–è¯‘å™¨ä¼˜åŒ–ï¼Œå®ƒå°†ä»£ç ä¸­çš„å‡½æ•°è°ƒç”¨ï¼ˆé€šå¸¸ä¼šå‘æ ˆä¸Š push frameï¼‰å¹¶å°†å…¶è½¬æ¢ä¸º jump æŒ‡ä»¤ï¼ˆä¸ä¼šå°†æ–°çš„ frame push åˆ°æ ˆä¸Šï¼‰ã€‚ åªæœ‰ <code>return bar()</code> è¿™æ ·åœ¨å‡½æ•°ä¸ºå°¾éƒ¨å‘ç”Ÿè°ƒç”¨çš„æ—¶å€™ï¼Œç¼–è¯‘å™¨å¯èƒ½ä¼šé‡‡ç”¨è¿™ç§ä¼˜åŒ–ï¼š ç¼–è¯‘å™¨è¯´ï¼šâ€œçœ‹ï¼Œæˆ‘çŸ¥é“ <code>bar</code> æ‰§è¡Œå®Œå°±è¿”å›ç»™è°ƒç”¨è€…ï¼Œå°±æ˜¯ <code>return bar()</code> çš„è¿™ä¸ªå‡½æ•°äº†ï¼Œè®©æˆ‘ä»¬ç›´æ¥åœ¨æœ¬å‡½æ•°çš„ <code>caller</code> å¤„è°ƒç”¨ <code>bar()</code>â€ï¼</p><p>Tail call optimization é€šå¸¸å¯ä»¥ç”¨äº <code>return bar()</code> è¿™ç§å½¢å¼ï¼Œä½†ä¸èƒ½ç”¨äº <code>return bar()+1</code>ã€‚</p><p>åœ¨ C++ ä¸­ï¼Œç¼–ç¨‹è€…å¾ˆéš¾å‡†ç¡®åœ°å¼„æ¸…æ¥šå“ªé‡Œå…è®¸å‘ç”Ÿ TCOã€‚ ä¸»è¦åŸå› æ˜¯ non-trivial destructors:</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">foo1</span><span class="params">()</span> </span>&#123; <span class="built_in">bar</span>(); &#125;  <span class="comment">// tail call</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">foo2</span><span class="params">()</span> </span>&#123; <span class="function">std::lock_guard <span class="title">lk</span><span class="params">(m)</span></span>; <span class="built_in">bar</span>(); &#125;  <span class="comment">// not a tail call</span></span><br></pre></td></tr></table></figure><p>è¿™ä¹ŸåŒ…å« temporary objects çš„ææ„ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">bar</span><span class="params">(std::string_view)</span></span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">foo1</span><span class="params">()</span> </span>&#123; <span class="built_in">bar</span>(<span class="string">&quot;hello&quot;</span>); &#125;  <span class="comment">// tail call</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">foo2</span><span class="params">()</span> </span>&#123; <span class="built_in">bar</span>(<span class="string">&quot;hello&quot;</span>s); &#125;  <span class="comment">// not a tail call</span></span><br></pre></td></tr></table></figure><p>ä½†å³ä½¿è¿™é‡Œæ‰€æœ‰ä¸œè¥¿éƒ½æ˜¯ trivially destructible çš„ï¼Œæ‚¨ä¹Ÿå¯èƒ½å› ä¸ºéœ€è¦ stack pointer æˆ–å…¶ä»–ä¸œè¥¿ï¼Œå¯¼è‡´é˜»æ­¢å‘ç”Ÿ TCO ã€‚<a href="https://godbolt.org/z/vcY3v9">https://godbolt.org/z/vcY3v9</a> ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">bar</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">escape</span><span class="params">(<span class="type">const</span> <span class="type">int</span>&amp;)</span></span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">foo1</span><span class="params">()</span> </span>&#123; <span class="built_in">escape</span>(<span class="number">42</span>); <span class="built_in">bar</span>(); &#125;  <span class="comment">// tail-call on GCC and MSVC</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">foo2</span><span class="params">()</span> </span>&#123; <span class="type">const</span> <span class="type">int</span> i = <span class="number">42</span>; <span class="built_in">escape</span>(i); <span class="built_in">bar</span>(); &#125;  <span class="comment">// not a tail-call</span></span><br></pre></td></tr></table></figure><p>æœ‰è¶£çš„æ˜¯ï¼Œåœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼ŒGCC å’Œ MSVC ä¸º <code>foo1</code> ç”Ÿæˆ <code>jmp bar</code>ï¼Œä½† Clang å’Œ ICC æ²¡æœ‰è¯¥ä¼˜åŒ–ã€‚</p><p><img src="https://image.mwish.me/blog-image/9002952926214148686.png" alt="img"></p><p>æ‚¨å¯èƒ½ä¼šåˆç†åœ°é—®ä¸ºä»€ä¹ˆæˆ‘ä»¬ä¸èƒ½å¯¹ <code>foo2</code> è¿›è¡Œç›¸åŒçš„ä¼˜åŒ–ã€‚ æˆ‘è®¤ä¸ºåŸå› æ˜¯ C++ ä¿è¯æ¯ä¸ªå˜é‡ï¼ˆåœ¨å…¶ç”Ÿå‘½å‘¨æœŸå†…ï¼‰éƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„åœ°å€ã€‚ å¦‚æœæˆ‘ä»¬è¦åƒè¿™æ ·å®ç° <code>bar</code>ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">const</span> <span class="type">int</span> *addr_of_i;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">escape</span><span class="params">(<span class="type">const</span> <span class="type">int</span>&amp; i)</span> </span>&#123;</span><br><span class="line">    addr_of_i = &amp;i;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">bar</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="type">int</span> j;</span><br><span class="line">    <span class="built_in">assert</span>(&amp;j != addr_of_i);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆç¨‹åºå¯ä»¥åˆ¤æ–­è¯¥å®ç°æ˜¯å¦ï¼ˆä¸ç¬¦åˆè§„å®šï¼‰å°† <code>j</code> æ”¾å…¥ä¸ <code>i</code> ç›¸åŒçš„å†…å­˜ä½ç½®ã€‚ ç„¶è€Œï¼Œæ²¡æœ‰è§„åˆ™è§„å®š <code>j</code>ä¸èƒ½ä¸ <code>42</code> ç”Ÿæˆçš„ä¸´æ—¶å¯¹è±¡å…±äº«å†…å­˜ä½ç½®ï¼Œå› ä¸ºè¯¥ä¸´æ—¶å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸä¸ <code>j</code> çš„ç”Ÿå‘½å‘¨æœŸä¸é‡å ã€‚</p><p>ä¸€ä¸ªå®ç°æ˜¯å¦æ‰§è¡Œ TCO æ˜¯å¯ä»¥è§‚å¯Ÿåˆ°çš„ï¼Œå› ä¸ºä»æŸç§æ„ä¹‰ä¸Šè¯´ï¼Œtail-recursive å‡½æ•°åœ¨ä½¿ç”¨ TCO æ—¶å¯èƒ½ä½¿ç”¨ <code>O(1)</code> çš„æ ˆç©ºé—´ï¼Œä½†åœ¨ä¸ä½¿ç”¨ TCO æ—¶ä½¿ç”¨ O(n) çš„æ ˆç©ºé—´â€”â€”å› æ­¤ï¼Œå½“é€’å½’è¶³å¤Ÿæ·±æ—¶ï¼Œä¼šâ€œçˆ†ç ´å †æ ˆâ€ ï¼ˆstack overflowï¼‰ã€‚ ç„¶è€Œï¼ŒC++ çš„æŠ½è±¡æœºå®é™…ä¸Šå¹¶æ²¡æœ‰ä»»ä½•ã€Œçˆ†ç ´å †æ ˆã€çš„æ¦‚å¿µã€‚ C++ ç¨‹åºæ²¡æœ‰ä¸€è‡´çš„æ–¹æ³•æ¥æ£€æµ‹æˆ–å¤„ç†è¯¥æƒ…å†µã€‚</p><blockquote><p>åŸæ–‡ï¼šHowever, C++â€™s abstract machine doesnâ€™t really have any notion of blowing the stack. Thereâ€™s no conforming way for a C++ program to detect that condition or deal with it.  ä¸ç¡®å®šç¿»è¯‘å¯¹äº†â€¦</p></blockquote><p>å› æ­¤ï¼Œè¶³å¤Ÿåæ‰§çš„ C++ ä»£ç åˆä½œè€…å°†é¿å…éå¸¸æ·±çš„é€’å½’ã€‚ æ‰§è¡Œæ­¤æ“ä½œçš„ä¸€ç§æŠ€æœ¯æ˜¯æ‰‹åŠ¨è¿›è¡Œ tail-recursion optimizationï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">gcd</span><span class="params">(<span class="type">int</span> x, <span class="type">int</span> y)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (x == <span class="number">0</span>) <span class="keyword">return</span> y;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">gcd</span>(y % x, x);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ”¹å†™ä¸º:</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">gcd</span><span class="params">(<span class="type">int</span> x, <span class="type">int</span> y)</span> </span>&#123;</span><br><span class="line">top:</span><br><span class="line">    <span class="keyword">if</span> (x == <span class="number">0</span>) <span class="keyword">return</span> y;</span><br><span class="line">    std::<span class="built_in">tie</span>(x, y) = std::<span class="built_in">tuple</span>(y % x, x);</span><br><span class="line">    <span class="keyword">goto</span> top;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¹¶æ”¹å†™æˆ</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">gcd</span><span class="params">(<span class="type">int</span> x, <span class="type">int</span> y)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (x != <span class="number">0</span>) &#123;</span><br><span class="line">        std::<span class="built_in">tie</span>(x, y) = std::<span class="built_in">tuple</span>(y % x, x);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> y;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œæœ€åä¸€æ­¥é€šå¸¸éå¸¸é‡è¦ï¼Œè¿™ä¸ä»…å› ä¸ºè¿™ç§æ–¹å¼ï¼ˆ <a href="https://en.wikipedia.org/wiki/Structured_programming">https://en.wikipedia.org/wiki/Structured_programming</a> ï¼‰ä½¿ä»£ç æ›´æ˜“è¯»ï¼Œè¿˜å› ä¸º goto æ˜¯æå°‘æ•°é˜»æ­¢å°†å‡½æ•°æ ‡è®°ä¸º constexpr çš„ C++ ç»“æ„ä¹‹ä¸€ ï¼ˆè§ <a href="https://stackoverflow.com/questions/45266577/why-disallow-goto-in-constexpr-functions">https://stackoverflow.com/questions/45266577/why-disallow-goto-in-constexpr-functions</a> ï¼‰ã€‚ å¦‚æœæ‚¨å¸Œæœ›å‡½æ•°ä¸º constexprï¼ˆæ— è®ºå‡ºäºä½•ç§åŸå› ï¼‰ï¼Œåˆ™å¿…é¡»é¿å… gotoã€‚ è¿™æ˜¯ C++ åœ¨é£æ ¼ä¸Šå›ºæ‰§å·±è§çš„ç½•è§æƒ…å†µã€‚</p><p>(å¦‚æœä½ æ²¡æœ‰è§è¿‡ <code>tie = tuple</code> trick , ä½ å¯èƒ½ä¼šå–œæ¬¢æˆ‘åœ¨ CppCon 2020 ä¸Šçš„æ¼”è®² <a href="https://www.youtube.com/watch?v=OJzmWqCCZaM">â€œBack to Basics: Algebraic Data Types.â€</a>.)</p><p><em>Posted 2021-01-09</em></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Arrow util: File &amp; FileSystem</title>
      <link href="/2023/08/21/Arrow-util-File-FileSystem/"/>
      <url>/2023/08/21/Arrow-util-File-FileSystem/</url>
      
        <content type="html"><![CDATA[<p>FileSystem å¯ä»¥çœ‹ä½œ Arrow çš„æ•°æ®è®¿é—®å±‚ï¼ˆä¸å¤ªåƒ fsï¼Œè€Œæ˜¯ä¸€ä¸ªè™šæ‹Ÿçš„æ–‡ä»¶ç³»ç»Ÿï¼‰ã€‚åªä¸è¿‡å®ƒå…¼å®¹çš„ä¸æ˜¯ POSIX è¯­ä¹‰ï¼Œè€Œæ˜¯è‡ªå·±åœ¨ä¸Šé¢å°äº†ä¸€å¥—å„ç§æ¥å£ã€‚å…·ä½“å¯ä»¥çœ‹ï¼š</p><ul><li><a href="https://arrow.apache.org/docs/cpp/api/filesystem.html">https://arrow.apache.org/docs/cpp/api/filesystem.html</a></li><li><a href="https://arrow.apache.org/docs/cpp/api/io.html">https://arrow.apache.org/docs/cpp/api/io.html</a></li></ul><p>ç›¸å…³ç›®å½•åœ¨ï¼š</p><ul><li><code>cpp/src/io/interface.h</code>: åŒ…å« file æœ¬èº«éƒ¨åˆ†æ¥å£ã€IO çš„æ¥å£å’Œæ‰€æœ‰çš„æ¥å£</li><li><code>cpp/src/io/file.h</code>: åŒ…å« file æœ¬èº«éƒ¨åˆ†æ¥å£ã€IO çš„æ¥å£å’Œæ‰€æœ‰çš„æ¥å£</li><li><code>cpp/src/arrow/filesystem</code>: åŒ…å« fs éƒ¨åˆ†å®ç°å’Œæ‰€æœ‰çš„æ¥å£<ul><li><code>hdfs.h</code> ä¸‹æœ‰ä¸ª <code>arrow::io::FileSystem</code>ï¼Œè¿™ä¸æ˜¯ä¸€å¥—ä¸œè¥¿.</li></ul></li></ul><h2 id="FileSystem"><a href="#FileSystem" class="headerlink" title="FileSystem"></a>FileSystem</h2><p>FileSystem è¿™å±‚æŠ½è±¡èƒ½å¤Ÿè¾¨åˆ«å‡ºä¸€ä¸ªç±»ä¼¼æ–‡ä»¶çš„è¯­ä¹‰ï¼Œå®ƒçš„æ¦‚å¿µæ²¡æœ‰ä¸‹å±‚åˆ° FS/VFS/Node è¿™æ ·çš„å±‚é¢ã€‚æˆ‘ä¸ªäººç†è§£ï¼Œå®ƒå¯¹åº”çš„è¯­ä¹‰æ˜¯ï¼šæ–‡ä»¶/ç›®å½• çš„ å¸¦è§„åˆ™çš„ List / Open / Delete / Create / GetInfoï¼Œå…¶ä¸­è¿˜åŒ…å« Copy / Move(Rename) è¿™æ ·çš„è¯­ä¹‰ã€‚åŒæ—¶æä¾›äº†ä¸€äº› async æˆ–è€…ç±»ä¼¼ Batch çš„æ¥å£ã€‚</p><p>FileSystem è¿™é‡Œæœ‰ä¸€äº›ä¸‹é¢çš„å­ç±»ï¼š</p><blockquote><p>Subclassed by <a href="https://arrow.apache.org/docs/cpp/api/filesystem.html#classarrow_1_1fs_1_1_gcs_file_system">arrow::fs::GcsFileSystem</a>, <a href="https://arrow.apache.org/docs/cpp/api/filesystem.html#classarrow_1_1fs_1_1_hadoop_file_system">arrow::fs::HadoopFileSystem</a>, arrow::fs::internal::MockFileSystem, <a href="https://arrow.apache.org/docs/cpp/api/filesystem.html#classarrow_1_1fs_1_1_local_file_system">arrow::fs::LocalFileSystem</a>, <a href="https://arrow.apache.org/docs/cpp/api/filesystem.html#classarrow_1_1fs_1_1_s3_file_system">arrow::fs::S3FileSystem</a>, arrow::fs::SlowFileSystem, <a href="https://arrow.apache.org/docs/cpp/api/filesystem.html#classarrow_1_1fs_1_1_sub_tree_file_system">arrow::fs::SubTreeFileSystem</a></p></blockquote><p>Local, S3, GCS, Hadoop è¿™å‡ ä¸ªè™½ç„¶å„æœ‰å„çš„ä¼˜åŒ–ï¼Œä½†æ˜¯ä¸€çœ‹åå­—ä½ å°±æ‡‚ä»–ä»¬æ˜¯äº›å•¥ã€‚æˆ‘ä»¬é¢å¤–è§£é‡Šä¸€ä¸‹å‡ ä¸ªåˆ«çš„ FS:</p><ul><li><code>SlowFileSystem</code> æ³¨å…¥å»¶æ—¶ï¼Œæ˜¯ç»™æµ‹è¯•ç”¨çš„ï¼Œè§ä¸‹æ–‡ï¼š</li></ul><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// \brief A FileSystem implementation that delegates to another</span></span><br><span class="line"><span class="comment">/// implementation but inserts latencies at various points.</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ARROW_EXPORT</span> SlowFileSystem : <span class="keyword">public</span> FileSystem &#123;</span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="built_in">SlowFileSystem</span>(std::shared_ptr&lt;FileSystem&gt; base_fs,</span><br><span class="line">                 std::shared_ptr&lt;io::LatencyGenerator&gt; latencies);</span><br><span class="line">  <span class="built_in">SlowFileSystem</span>(std::shared_ptr&lt;FileSystem&gt; base_fs, <span class="type">double</span> average_latency);</span><br><span class="line">  <span class="built_in">SlowFileSystem</span>(std::shared_ptr&lt;FileSystem&gt; base_fs, <span class="type">double</span> average_latency,</span><br><span class="line">                 <span class="type">int32_t</span> seed);</span><br></pre></td></tr></table></figure><ul><li><code>MockFIleSystem</code>: æŠŠæ‰€æœ‰å†…å®¹æŒæœ‰åœ¨å†…å­˜ä¸­çš„ FileSystemï¼Œåº”è¯¥æ˜¯ç»™æµ‹è¯•ç”¨çš„</li><li><code>SubTreeFileSystem</code>: æ„Ÿè§‰åƒæ˜¯æŸä¸ª base filesystemï¼Œç»™ä¸€ä¸ªå­è·¯å¾„çš„ â€œSubTreeâ€ æ–‡ä»¶ç³»ç»Ÿ</li></ul><p>è¿™é‡Œ arrow å†…éƒ¨è¿˜æ”¯æŒäº†ä¸€å¥—ç»Ÿä¸€çš„ URL ç³»ç»Ÿï¼Œç„¶åä» URL ç³»ç»Ÿä¸­ load å‡ºæ¥å¯¹åº”çš„ pathã€‚æ¯”å¦‚ <code>gcs://</code>, å†…å®¹æ˜¯ <code>FileSystemFromUri</code>. éœ€è¦æ³¨æ„çš„æ˜¯æœ¬åœ°æ–‡ä»¶æ˜¯ <code>file://</code> è¿™ç±»çš„å‰ç¼€ã€‚</p><p>è¯è¯´åˆ°è¿™é‡Œï¼Œæ¯ä¸ªæ–‡ä»¶ç³»ç»Ÿè¿˜æœ‰ä¸€äº›æ–‡ä»¶å’Œè·¯å¾„çš„æ¦‚å¿µï¼ŒArrow æ˜¯æ€ä¹ˆæ˜ å°„è¿™äº›æ–‡ä»¶å’Œè·¯å¾„çš„å‘¢ï¼ŸArrow FileSystem å®šä¹‰äº† <code>NormalizeFilePath</code>ï¼Œä¸“é—¨å¤„ç†ä¸€äº› Windows Path / SubTreeSystem ä¹‹ç±»çš„è·¯å¾„ä¹‹ç±»çš„å†…å®¹ï¼Œæ¥ç»™è·¯å¾„çš„é€»è¾‘åšäº†ç»Ÿä¸€çš„å¤„ç†</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Result&lt;std::string&gt; <span class="title">SubTreeFileSystem::NormalizePath</span><span class="params">(std::string path)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">ARROW_ASSIGN_OR_RAISE</span>(<span class="keyword">auto</span> real_path, <span class="built_in">PrependBase</span>(path));</span><br><span class="line">  <span class="built_in">ARROW_ASSIGN_OR_RAISE</span>(<span class="keyword">auto</span> normalized, base_fs_-&gt;<span class="built_in">NormalizePath</span>(real_path));</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">StripBase</span>(std::<span class="built_in">move</span>(normalized));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯åœ¨ä»‹ç» FileSystem ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆä»‹ç»ä¸€ä¸‹ç³»ç»Ÿè¿è¡Œçš„ä¸Šä¸‹æ–‡ã€‚</p><h3 id="IOContext-and-Executor"><a href="#IOContext-and-Executor" class="headerlink" title="IOContext and Executor"></a>IOContext and Executor</h3><p>IOContext æ˜¯ Parquet æ–‡ä»¶è¯»å–çš„ã€Œä¸Šä¸‹æ–‡ã€ã€‚å› ä¸º arrow ç”¨çš„ C++17 æ²¡æœ‰æ ‡å‡†çš„ async æ¨¡å‹ï¼Œæ‰€ä»¥è¿™é‡ŒåŸºæœ¬ä¸Šè¿˜æ˜¯ç”¨ IO çº¿ç¨‹æ± åŒ…è£…äº†åŒæ­¥çš„æ¥å£ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// EXPERIMENTAL: options provider for IO tasks</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// Includes an Executor (which will be used to execute asynchronous reads),</span></span><br><span class="line"><span class="comment">/// a MemoryPool (which will be used to allocate buffers when zero copy reads</span></span><br><span class="line"><span class="comment">/// are not possible), and an external id (in case the executor receives tasks from</span></span><br><span class="line"><span class="comment">/// multiple sources and must distinguish tasks associated with this IOContext).</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">ARROW_EXPORT</span> IOContext &#123;</span><br><span class="line"> <span class="keyword">private</span>:</span><br><span class="line">  MemoryPool* pool_;</span><br><span class="line">  ::arrow::internal::Executor* executor_;</span><br><span class="line">  <span class="type">int64_t</span> external_id_;</span><br><span class="line">  StopToken stop_token_;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>åˆ«çš„éƒ½å¾ˆå¥½ç†è§£ï¼Œ<code>external_id_</code> æ˜¯ä¸€ä¸ªç±»ä¼¼ IOTag çš„ä¸œè¥¿ã€‚æˆ‘çœ‹å®ƒè¿™é‡Œæ²¡æœ‰åšå¾ˆç»†çš„ tagï¼Œå°±åŸºäº id åˆ¤æ–­ä¸€ä¸‹ã€‚è¿™é‡Œå®ƒæŠŠ <code>SubmitIO</code> åŒ…è£…æˆå¼‚æ­¥çš„äº†</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span>... SubmitArgs&gt;</span><br><span class="line"><span class="function"><span class="keyword">auto</span> <span class="title">SubmitIO</span><span class="params">(IOContext io_context, SubmitArgs&amp;&amp;... submit_args)</span></span></span><br><span class="line"><span class="function">    -&gt; <span class="title">decltype</span><span class="params">(std::declval&lt;::arrow::internal::Executor*&gt;()-&gt;Submit(submit_args...))</span> </span>&#123;</span><br><span class="line">  ::arrow::internal::TaskHints hints;</span><br><span class="line">  hints.external_id = io_context.<span class="built_in">external_id</span>();</span><br><span class="line">  <span class="keyword">return</span> io_context.<span class="built_in">executor</span>()-&gt;<span class="built_in">Submit</span>(hints, io_context.<span class="built_in">stop_token</span>(),</span><br><span class="line">                                       std::forward&lt;SubmitArgs&gt;(submit_args)...);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå…·ä½“æäº¤ IO çš„æ—¶å€™è¿˜æœ‰ä¸€äº› TaskHintï¼Œä½†æ˜¯å¥½åƒæ²¡æœ‰ä»€ä¹ˆäººçœŸçš„ç”¨äº†è¿™ä¸€å¥—ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Hints about a task that may be used by an Executor.</span></span><br><span class="line"><span class="comment">// They are ignored by the provided ThreadPool implementation.</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">TaskHints</span> &#123;</span><br><span class="line">  <span class="comment">// The lower, the more urgent</span></span><br><span class="line">  <span class="type">int32_t</span> priority = <span class="number">0</span>;</span><br><span class="line">  <span class="comment">// The IO transfer size in bytes</span></span><br><span class="line">  <span class="type">int64_t</span> io_size = <span class="number">-1</span>;</span><br><span class="line">  <span class="comment">// The approximate CPU cost in number of instructions</span></span><br><span class="line">  <span class="type">int64_t</span> cpu_cost = <span class="number">-1</span>;</span><br><span class="line">  <span class="comment">// An application-specific ID</span></span><br><span class="line">  <span class="type">int64_t</span> external_id = <span class="number">-1</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å…³äº Executorï¼Œè¿™é‡Œå¯ä»¥å½“æˆ IO çº¿ç¨‹çš„åŒ…è£…å™¨æ¥å£ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ARROW_EXPORT</span> Executor &#123;</span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="keyword">using</span> StopCallback = internal::FnOnce&lt;<span class="built_in">void</span>(<span class="type">const</span> Status&amp;)&gt;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">virtual</span> ~<span class="built_in">Executor</span>();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Spawn a fire-and-forget task.</span></span><br><span class="line">  <span class="keyword">template</span> &lt;<span class="keyword">typename</span> Function&gt;</span><br><span class="line">  <span class="function">Status <span class="title">Spawn</span><span class="params">(...)</span></span>;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// Transfers a future to this executor.  Any continuations added to the</span></span><br><span class="line">  <span class="comment">// returned future will run in this executor.  Otherwise they would run</span></span><br><span class="line">  <span class="comment">// on the same thread that called MarkFinished.</span></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  <span class="comment">// This is necessary when (for example) an I/O task is completing a future.</span></span><br><span class="line">  <span class="comment">// The continuations of that future should run on the CPU thread pool keeping</span></span><br><span class="line">  <span class="comment">// CPU heavy work off the I/O thread pool.  So the I/O task should transfer</span></span><br><span class="line">  <span class="comment">// the future to the CPU executor before returning.</span></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  <span class="comment">// By default this method will only transfer if the future is not already completed.  If</span></span><br><span class="line">  <span class="comment">// the future is already completed then any callback would be run synchronously and so</span></span><br><span class="line">  <span class="comment">// no transfer is typically necessary.  However, in cases where you want to force a</span></span><br><span class="line">  <span class="comment">// transfer (e.g. to help the scheduler break up units of work across multiple cores)</span></span><br><span class="line">  <span class="comment">// then you can override this behavior with `always_transfer`.</span></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  <span class="comment">// Transfer å®Œæˆçš„æ˜¯ä¸€ä¸ªè¿™æ ·çš„é€»è¾‘ï¼Œæ¯”æ–¹è¯´ç”¨æˆ·çš„çº¿ç¨‹æ˜¯ä¸€ä¸ª IO çº¿ç¨‹ï¼Œé‚£ä¹ˆå¯èƒ½è¿™é‡Œä¼šè®¿é—®çš„æ—¶å€™ä¸å¤ªå¸Œæœ›æ˜¯åœ¨</span></span><br><span class="line">  <span class="comment">// CPU Thread å»æ¥å—. å½“ç„¶ Transfer å¯¹äºå·²ç»å®Œæˆçš„ Future å¯èƒ½ä¼šæœ‰ç‚¹å¥‡æ€ª, å› ä¸ºå®ƒå®ç°æ˜¯ç›´æ¥æŒ‚ callback</span></span><br><span class="line">  <span class="comment">// çš„.</span></span><br><span class="line">  <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">  <span class="function">Future&lt;T&gt; <span class="title">Transfer</span><span class="params">(Future&lt;T&gt; future)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Overload of Transfer which will always schedule callbacks on new threads even if the</span></span><br><span class="line">  <span class="comment">// future is finished when the callback is added.</span></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  <span class="comment">// This can be useful in cases where you want to ensure parallelism</span></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  <span class="comment">// å¼ºåˆ¶ Transfer æ“ä½œ.</span></span><br><span class="line">  <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">  <span class="function">Future&lt;T&gt; <span class="title">TransferAlways</span><span class="params">(Future&lt;T&gt; future)</span></span>;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// Return the level of parallelism (the number of tasks that may be executed</span></span><br><span class="line">  <span class="comment">// concurrently).  This may be an approximate number.</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="type">int</span> <span class="title">GetCapacity</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Return true if the thread from which this function is called is owned by this</span></span><br><span class="line">  <span class="comment">// Executor. Returns false if this Executor does not support this property.</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="type">bool</span> <span class="title">OwnsThisThread</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="literal">false</span>; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Return true if this is the current executor being called</span></span><br><span class="line">  <span class="comment">// n.b. this defaults to just calling OwnsThisThread</span></span><br><span class="line">  <span class="comment">// unless the threadpool is disabled</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="type">bool</span> <span class="title">IsCurrentExecutor</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="built_in">OwnsThisThread</span>(); &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// \brief An interface to represent something with a custom destructor</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// \see KeepAlive</span></span><br><span class="line">  <span class="keyword">class</span> <span class="title class_">ARROW_EXPORT</span> Resource &#123;</span><br><span class="line">   <span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">virtual</span> ~<span class="built_in">Resource</span>() = <span class="keyword">default</span>;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// \brief Keep a resource alive until all executor threads have terminated</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// Executors may have static storage duration.  In particular, the CPU and I/O</span></span><br><span class="line">  <span class="comment">/// executors are currently implemented this way.  These threads may access other</span></span><br><span class="line">  <span class="comment">/// objects with static storage duration such as the OpenTelemetry runtime context</span></span><br><span class="line">  <span class="comment">/// the default memory pool, or other static executors.</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// The order in which these objects are destroyed is difficult to control.  In order</span></span><br><span class="line">  <span class="comment">/// to ensure those objects remain alive until all threads have finished those objects</span></span><br><span class="line">  <span class="comment">/// should be wrapped in a Resource object and passed into this method.  The given</span></span><br><span class="line">  <span class="comment">/// shared_ptr will be kept alive until all threads have finished their worker loops.</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">KeepAlive</span><span class="params">(std::shared_ptr&lt;Resource&gt; resource)</span></span>;</span><br><span class="line">  </span><br><span class="line"> <span class="keyword">protected</span>:</span><br><span class="line">  <span class="comment">// Subclassing API</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> Status <span class="title">SpawnReal</span><span class="params">(TaskHints hints, FnOnce&lt;<span class="type">void</span>()&gt; task, StopToken,</span></span></span><br><span class="line"><span class="params"><span class="function">                           StopCallback&amp;&amp;)</span> </span>= <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>è¿™éƒ¨åˆ†æ¥å£å…¶å®éƒ½ç›¸å¯¹æ¯”è¾ƒå¥½ç†è§£.</p><p>å…ˆä»‹ç»å‡ ä¸ªæ¯”è¾ƒå¥½ç†è§£çš„æ¥å£ï¼š</p><ol><li><code>KeepAlive</code>: ç”Ÿå‘½å‘¨æœŸ Ordering ç»´æŠ¤å™¨</li><li><code>OwnsThisThread()</code> è¿™éƒ¨åˆ†å®ç°å¾ˆæœ‰æ„æ€ï¼Œ<code>ThreadPool</code> å®ç°è¿™ä¸ªçš„æ—¶å€™å¥—äº†ä¸€å±‚ <code>threadlocal</code>ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹çœ‹</li></ol><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">thread_local</span> ThreadPool* current_thread_pool_ = <span class="literal">nullptr</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">ThreadPool::OwnsThisThread</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> current_thread_pool_ == <span class="keyword">this</span>; &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ThreadPool::LaunchWorkersUnlocked</span><span class="params">(<span class="type">int</span> threads)</span> </span>&#123;</span><br><span class="line">  std::shared_ptr&lt;State&gt; state = sp_state_;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; threads; i++) &#123;</span><br><span class="line">    state_-&gt;workers_.<span class="built_in">emplace_back</span>();</span><br><span class="line">    <span class="keyword">auto</span> it = --(state_-&gt;workers_.<span class="built_in">end</span>());</span><br><span class="line">    *it = std::<span class="built_in">thread</span>([<span class="keyword">this</span>, state, it] &#123;</span><br><span class="line">      current_thread_pool_ = <span class="keyword">this</span>;</span><br><span class="line">      <span class="built_in">WorkerLoop</span>(state, it);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯ä»¥ç›´æ¥çœ‹çœ‹ <code>Transfer</code> çš„å®ç°ï¼Œè¿™æ®µå¤„ç†çš„æ¯”è¾ƒæœ‰æ„æ€</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T, <span class="keyword">typename</span> FT = Future&lt;T&gt;, <span class="keyword">typename</span> FTSync = <span class="keyword">typename</span> FT::SyncType&gt;</span><br><span class="line">Future&lt;T&gt; <span class="built_in">DoTransfer</span>(Future&lt;T&gt; future, <span class="type">bool</span> always_transfer = <span class="literal">false</span>) &#123;</span><br><span class="line">  <span class="keyword">auto</span> transferred = Future&lt;T&gt;::<span class="built_in">Make</span>();</span><br><span class="line">  <span class="keyword">if</span> (always_transfer) &#123;</span><br><span class="line">    CallbackOptions callback_options = CallbackOptions::<span class="built_in">Defaults</span>();</span><br><span class="line">    callback_options.should_schedule = ShouldSchedule::Always;</span><br><span class="line">    callback_options.executor = <span class="keyword">this</span>;</span><br><span class="line">    <span class="keyword">auto</span> sync_callback = [transferred](<span class="type">const</span> FTSync&amp; result) <span class="keyword">mutable</span> &#123;</span><br><span class="line">      transferred.<span class="built_in">MarkFinished</span>(result);</span><br><span class="line">    &#125;;</span><br><span class="line">    future.<span class="built_in">AddCallback</span>(sync_callback, callback_options);</span><br><span class="line">    <span class="keyword">return</span> transferred;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// We could use AddCallback&#x27;s ShouldSchedule::IfUnfinished but we can save a bit of</span></span><br><span class="line">  <span class="comment">// work by doing the test here.</span></span><br><span class="line">  <span class="keyword">auto</span> callback = [<span class="keyword">this</span>, transferred](<span class="type">const</span> FTSync&amp; result) <span class="keyword">mutable</span> &#123;</span><br><span class="line">    <span class="keyword">auto</span> spawn_status =</span><br><span class="line">        <span class="built_in">Spawn</span>([transferred, result]() <span class="keyword">mutable</span> &#123; transferred.<span class="built_in">MarkFinished</span>(result); &#125;);</span><br><span class="line">    <span class="keyword">if</span> (!spawn_status.<span class="built_in">ok</span>()) &#123;</span><br><span class="line">      transferred.<span class="built_in">MarkFinished</span>(spawn_status);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">auto</span> callback_factory = [&amp;callback]() &#123; <span class="keyword">return</span> callback; &#125;;</span><br><span class="line">  <span class="keyword">if</span> (future.<span class="built_in">TryAddCallback</span>(callback_factory)) &#123;</span><br><span class="line">    <span class="keyword">return</span> transferred;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// If the future is already finished and we aren&#x27;t going to force spawn a thread</span></span><br><span class="line">  <span class="comment">// then we don&#x27;t need to add another layer of callback and can return the original</span></span><br><span class="line">  <span class="comment">// future</span></span><br><span class="line">  <span class="keyword">return</span> future;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ®µä»£ç å¾ˆæ¸…æ™°ï¼š</p><ol><li>å¦‚æœæ˜¯ <code>always_transfer</code>ï¼Œé‚£ä¹ˆå°±å¯ä»¥åˆ›å»ºä¸€ä¸ª callbackï¼Œç›´æ¥æŒ‚è¿‡å»</li><li>å¦åˆ™ï¼Œå°è¯•å¼€ä¸€ä¸ª transfer &amp; callback çš„ thread, å°è¯• async å» MarkFinish. å¦‚æœ Future å·²ç» finish äº†ï¼Œè¿™éƒ¨åˆ†é€»è¾‘å€’æ˜¯å¾ˆå¥½è§£å†³äº†ã€‚</li></ol><h3 id="æ–‡ä»¶ç³»ç»Ÿçš„æ¥å£"><a href="#æ–‡ä»¶ç³»ç»Ÿçš„æ¥å£" class="headerlink" title="æ–‡ä»¶ç³»ç»Ÿçš„æ¥å£"></a>æ–‡ä»¶ç³»ç»Ÿçš„æ¥å£</h3><p>è¿™é‡Œæœ‰äº›æ¯”è¾ƒå¥½ç©çš„ï¼Œé¦–å…ˆçœ‹ <code>FileSystem</code> è¿™ä¸ªåŸºç±»</p><h4 id="List-æ–‡ä»¶"><a href="#List-æ–‡ä»¶" class="headerlink" title="List æ–‡ä»¶"></a>List æ–‡ä»¶</h4><p>è¿™é‡Œä¼šæœ‰ä¸€äº›å¯¹ Stream Open çš„æ”¯æŒï¼Œå¯ä»¥æ‰“å¼€ File ä¹‹ç±»çš„æ“ä½œï¼Œå’Œæ ¹æ® FileSelector å» List çš„æ“ä½œï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// Get info for the given target.</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// Any symlink is automatically dereferenced, recursively.</span></span><br><span class="line"><span class="comment">/// A nonexistent or unreachable file returns an Ok status and</span></span><br><span class="line"><span class="comment">/// has a FileType of value NotFound.  An error status indicates</span></span><br><span class="line"><span class="comment">/// a truly exceptional condition (low-level I/O error, etc.).</span></span><br><span class="line"><span class="function"><span class="keyword">virtual</span> Result&lt;FileInfo&gt; <span class="title">GetFileInfo</span><span class="params">(<span class="type">const</span> std::string&amp; path)</span> </span>= <span class="number">0</span>;</span><br><span class="line"><span class="comment">/// Same, for many targets at once.</span></span><br><span class="line"><span class="function"><span class="keyword">virtual</span> Result&lt;FileInfoVector&gt; <span class="title">GetFileInfo</span><span class="params">(<span class="type">const</span> std::vector&lt;std::string&gt;&amp; paths)</span></span>;</span><br><span class="line"><span class="comment">/// Same, according to a selector.</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// The selector&#x27;s base directory will not be part of the results, even if</span></span><br><span class="line"><span class="comment">/// it exists.</span></span><br><span class="line"><span class="comment">/// If it doesn&#x27;t exist, see `FileSelector::allow_not_found`.</span></span><br><span class="line"><span class="function"><span class="keyword">virtual</span> Result&lt;FileInfoVector&gt; <span class="title">GetFileInfo</span><span class="params">(<span class="type">const</span> FileSelector&amp; select)</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// Async version of GetFileInfo</span></span><br><span class="line"><span class="function"><span class="keyword">virtual</span> Future&lt;FileInfoVector&gt; <span class="title">GetFileInfoAsync</span><span class="params">(<span class="type">const</span> std::vector&lt;std::string&gt;&amp; paths)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// Streaming async version of GetFileInfo</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// The returned generator is not async-reentrant, i.e. you need to wait for</span></span><br><span class="line"><span class="comment">/// the returned future to complete before calling the generator again.</span></span><br><span class="line"><span class="function"><span class="keyword">virtual</span> FileInfoGenerator <span class="title">GetFileInfoGenerator</span><span class="params">(<span class="type">const</span> FileSelector&amp; select)</span></span>;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œè§‚å¯Ÿåˆ°æœ‰ä¸€ä¸ª <code>FileSelector</code> æ¥å£ï¼Œå®é™…ä¸Šè¿™é‡Œä¹Ÿä¼šæ”¯æŒä¸€äº›è¿‡æ»¤è§„åˆ™ï¼Œç„¶åå°½é‡ä¸‹æ¨</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// \brief File selector for filesystem APIs</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">ARROW_EXPORT</span> FileSelector &#123;</span><br><span class="line">  <span class="comment">/// The directory in which to select files.</span></span><br><span class="line">  <span class="comment">/// If the path exists but doesn&#x27;t point to a directory, this should be an error.</span></span><br><span class="line">  std::string base_dir;</span><br><span class="line">  <span class="comment">/// The behavior if `base_dir` isn&#x27;t found in the filesystem.  If false,</span></span><br><span class="line">  <span class="comment">/// an error is returned.  If true, an empty selection is returned.</span></span><br><span class="line">  <span class="type">bool</span> allow_not_found;</span><br><span class="line">  <span class="comment">/// Whether to recurse into subdirectories.</span></span><br><span class="line">  <span class="type">bool</span> recursive;</span><br><span class="line">  <span class="comment">/// The maximum number of subdirectories to recurse into.</span></span><br><span class="line">  <span class="type">int32_t</span> max_recursion;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">FileSelector</span>() : <span class="built_in">allow_not_found</span>(<span class="literal">false</span>), <span class="built_in">recursive</span>(<span class="literal">false</span>), <span class="built_in">max_recursion</span>(INT32_MAX) &#123;&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="Dir-Operations"><a href="#Dir-Operations" class="headerlink" title="Dir Operations"></a>Dir Operations</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// Create a directory and subdirectories.</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// This function succeeds if the directory already exists.</span></span><br><span class="line"><span class="function"><span class="keyword">virtual</span> Status <span class="title">CreateDir</span><span class="params">(<span class="type">const</span> std::string&amp; path, <span class="type">bool</span> recursive = <span class="literal">true</span>)</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// Delete a directory and its contents, recursively.</span></span><br><span class="line"><span class="function"><span class="keyword">virtual</span> Status <span class="title">DeleteDir</span><span class="params">(<span class="type">const</span> std::string&amp; path)</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// Delete a directory&#x27;s contents, recursively.</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// Like DeleteDir, but doesn&#x27;t delete the directory itself.</span></span><br><span class="line"><span class="comment">/// Passing an empty path (&quot;&quot; or &quot;/&quot;) is disallowed, see DeleteRootDirContents.</span></span><br><span class="line"><span class="function"><span class="keyword">virtual</span> Status <span class="title">DeleteDirContents</span><span class="params">(<span class="type">const</span> std::string&amp; path,</span></span></span><br><span class="line"><span class="params"><span class="function">                                 <span class="type">bool</span> missing_dir_ok = <span class="literal">false</span>)</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// Async version of DeleteDirContents.</span></span><br><span class="line"><span class="keyword">virtual</span> Future&lt;&gt; <span class="built_in">DeleteDirContentsAsync</span>(<span class="type">const</span> std::string&amp; path,</span><br><span class="line">                                        <span class="type">bool</span> missing_dir_ok = <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/// EXPERIMENTAL: Delete the root directory&#x27;s contents, recursively.</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// Implementations may decide to raise an error if this operation is</span></span><br><span class="line"><span class="comment">/// too dangerous.</span></span><br><span class="line"><span class="comment">// <span class="doctag">NOTE:</span> may decide to remove this if it&#x27;s deemed not useful</span></span><br><span class="line"><span class="function"><span class="keyword">virtual</span> Status <span class="title">DeleteRootDirContents</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br></pre></td></tr></table></figure><h3 id="File-and-Stream-Operations"><a href="#File-and-Stream-Operations" class="headerlink" title="File and Stream Operations"></a>File and Stream Operations</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// Delete a file.</span></span><br><span class="line"><span class="function"><span class="keyword">virtual</span> Status <span class="title">DeleteFile</span><span class="params">(<span class="type">const</span> std::string&amp; path)</span> </span>= <span class="number">0</span>;</span><br><span class="line"><span class="comment">/// Delete many files.</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// The default implementation issues individual delete operations in sequence.</span></span><br><span class="line"><span class="function"><span class="keyword">virtual</span> Status <span class="title">DeleteFiles</span><span class="params">(<span class="type">const</span> std::vector&lt;std::string&gt;&amp; paths)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// Move / rename a file or directory.</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// If the destination exists:</span></span><br><span class="line"><span class="comment">/// - if it is a non-empty directory, an error is returned</span></span><br><span class="line"><span class="comment">/// - otherwise, if it has the same type as the source, it is replaced</span></span><br><span class="line"><span class="comment">/// - otherwise, behavior is unspecified (implementation-dependent).</span></span><br><span class="line"><span class="function"><span class="keyword">virtual</span> Status <span class="title">Move</span><span class="params">(<span class="type">const</span> std::string&amp; src, <span class="type">const</span> std::string&amp; dest)</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// Copy a file.</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// If the destination exists and is a directory, an error is returned.</span></span><br><span class="line"><span class="comment">/// Otherwise, it is replaced.</span></span><br><span class="line"><span class="function"><span class="keyword">virtual</span> Status <span class="title">CopyFile</span><span class="params">(<span class="type">const</span> std::string&amp; src, <span class="type">const</span> std::string&amp; dest)</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// Open an input stream for sequential reading.</span></span><br><span class="line"><span class="keyword">virtual</span> Result&lt;std::shared_ptr&lt;io::InputStream&gt;&gt; <span class="built_in">OpenInputStream</span>(</span><br><span class="line">    <span class="type">const</span> std::string&amp; path) = <span class="number">0</span>;</span><br><span class="line"><span class="comment">/// Open an input stream for sequential reading.</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// This override assumes the given FileInfo validly represents the file&#x27;s</span></span><br><span class="line"><span class="comment">/// characteristics, and may optimize access depending on them (for example</span></span><br><span class="line"><span class="comment">/// avoid querying the file size or its existence).</span></span><br><span class="line"><span class="keyword">virtual</span> Result&lt;std::shared_ptr&lt;io::InputStream&gt;&gt; <span class="built_in">OpenInputStream</span>(<span class="type">const</span> FileInfo&amp; info);</span><br><span class="line"></span><br><span class="line"><span class="comment">/// Open an input file for random access reading.</span></span><br><span class="line"><span class="keyword">virtual</span> Result&lt;std::shared_ptr&lt;io::RandomAccessFile&gt;&gt; <span class="built_in">OpenInputFile</span>(</span><br><span class="line">    <span class="type">const</span> std::string&amp; path) = <span class="number">0</span>;</span><br><span class="line"><span class="comment">/// Open an input file for random access reading.</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// This override assumes the given FileInfo validly represents the file&#x27;s</span></span><br><span class="line"><span class="comment">/// characteristics, and may optimize access depending on them (for example</span></span><br><span class="line"><span class="comment">/// avoid querying the file size or its existence).</span></span><br><span class="line"><span class="keyword">virtual</span> Result&lt;std::shared_ptr&lt;io::RandomAccessFile&gt;&gt; <span class="built_in">OpenInputFile</span>(</span><br><span class="line">    <span class="type">const</span> FileInfo&amp; info);</span><br><span class="line"></span><br><span class="line"><span class="comment">/// Async version of OpenInputStream</span></span><br><span class="line"><span class="keyword">virtual</span> Future&lt;std::shared_ptr&lt;io::InputStream&gt;&gt; <span class="built_in">OpenInputStreamAsync</span>(</span><br><span class="line">    <span class="type">const</span> std::string&amp; path);</span><br><span class="line"><span class="comment">/// Async version of OpenInputStream</span></span><br><span class="line"><span class="keyword">virtual</span> Future&lt;std::shared_ptr&lt;io::InputStream&gt;&gt; <span class="built_in">OpenInputStreamAsync</span>(</span><br><span class="line">    <span class="type">const</span> FileInfo&amp; info);</span><br><span class="line"></span><br><span class="line"><span class="comment">/// Async version of OpenInputFile</span></span><br><span class="line"><span class="keyword">virtual</span> Future&lt;std::shared_ptr&lt;io::RandomAccessFile&gt;&gt; <span class="built_in">OpenInputFileAsync</span>(</span><br><span class="line">    <span class="type">const</span> std::string&amp; path);</span><br><span class="line"><span class="comment">/// Async version of OpenInputFile</span></span><br><span class="line"><span class="keyword">virtual</span> Future&lt;std::shared_ptr&lt;io::RandomAccessFile&gt;&gt; <span class="built_in">OpenInputFileAsync</span>(</span><br><span class="line">    <span class="type">const</span> FileInfo&amp; info);</span><br><span class="line"></span><br><span class="line"><span class="comment">/// Open an output stream for sequential writing.</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// If the target already exists, existing data is truncated.</span></span><br><span class="line"><span class="keyword">virtual</span> Result&lt;std::shared_ptr&lt;io::OutputStream&gt;&gt; <span class="built_in">OpenOutputStream</span>(</span><br><span class="line">    <span class="type">const</span> std::string&amp; path,</span><br><span class="line">    <span class="type">const</span> std::shared_ptr&lt;<span class="type">const</span> KeyValueMetadata&gt;&amp; metadata) = <span class="number">0</span>;</span><br><span class="line">Result&lt;std::shared_ptr&lt;io::OutputStream&gt;&gt; <span class="built_in">OpenOutputStream</span>(<span class="type">const</span> std::string&amp; path);</span><br><span class="line"></span><br><span class="line"><span class="comment">/// Open an output stream for appending.</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// If the target doesn&#x27;t exist, a new empty file is created.</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// Note: some filesystem implementations do not support efficient appending</span></span><br><span class="line"><span class="comment">/// to an existing file, in which case this method will return NotImplemented.</span></span><br><span class="line"><span class="comment">/// Consider writing to multiple files (using e.g. the dataset layer) instead.</span></span><br><span class="line"><span class="keyword">virtual</span> Result&lt;std::shared_ptr&lt;io::OutputStream&gt;&gt; <span class="built_in">OpenAppendStream</span>(</span><br><span class="line">    <span class="type">const</span> std::string&amp; path,</span><br><span class="line">    <span class="type">const</span> std::shared_ptr&lt;<span class="type">const</span> KeyValueMetadata&gt;&amp; metadata) = <span class="number">0</span>;</span><br><span class="line">Result&lt;std::shared_ptr&lt;io::OutputStream&gt;&gt; <span class="built_in">OpenAppendStream</span>(<span class="type">const</span> std::string&amp; path);</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå®ƒæ‰“å¼€æ–‡ä»¶ï¼Œæœ¬èº«éƒ½æ˜¯ Sync æˆ–è€… Async çš„ï¼Œè€Œæ‰“å¼€åçš„æ¥å£ï¼Œå¯èƒ½æœ‰ä¸åŒçš„ Sync Async æ¨¡å‹ã€‚æ ¹æ®æˆ‘ä¸ªäººçš„ç†è§£ï¼Œè¿™ä¸ªå¯èƒ½æ˜¯ä¸ªå¼€å‘è€…è´£ä»»åˆ¶ã€‚æ¯”å¦‚æŸä¸ªæ¥å£åœ¨éå…³é”®è·¯å¾„ä¸Šä¸æ˜¯ asyncï¼Œå°±æ²¡æœ‰å¼€å‘è€…æ„¿æ„æ”¹å®ƒï¼Œç„¶åè¿™ç©æ„å°±éƒ½æ˜¯ Sync çš„äº†ã€‚åæ­£ Sync æ˜¯ç¬¬ä¸€éœ€è¦æ”¯æŒçš„ä¸œè¥¿ã€‚ç„¶åéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä¼¼ä¹ <code>FileSystem</code> è¿™å¥—æ¥å£ä½¿ç”¨çš„æ—¶å€™ä¼šå°½é‡ä¿è¯æ˜¯ hold by <code>shared_ptr</code> çš„ã€‚</p><p>Async çš„å®ç°ç›®å‰ä¹Ÿæ¯”è¾ƒç›´æ¥ï¼Œåº”è¯¥æ˜¯é»˜è®¤å®ç°æ˜¯åŒ…ä¸€å¥— <code>SubmitIO</code>ï¼Œç„¶åå†…éƒ¨å®ç°å¯ä»¥åœ¨ç»§æ‰¿çš„æ—¶å€™å…è®¸è‡ªå·±å»åšä¸€äº› hack. è¿™é‡Œä¸¾ä¾‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> DeferredFunc&gt;</span><br><span class="line"><span class="function"><span class="keyword">auto</span> <span class="title">FileSystemDefer</span><span class="params">(FileSystem* fs, <span class="type">bool</span> synchronous, DeferredFunc&amp;&amp; func)</span></span></span><br><span class="line"><span class="function">    -&gt; <span class="title">decltype</span><span class="params">(DeferNotOk(</span></span></span><br><span class="line"><span class="params"><span class="function">        fs-&gt;io_context().executor()-&gt;Submit(func, std::shared_ptr&lt;FileSystem&gt;&#123;&#125;)))</span> </span>&#123;</span><br><span class="line">  <span class="keyword">auto</span> self = fs-&gt;<span class="built_in">shared_from_this</span>();</span><br><span class="line">  <span class="keyword">if</span> (synchronous) &#123;</span><br><span class="line">    <span class="keyword">return</span> std::forward&lt;DeferredFunc&gt;(func)(std::<span class="built_in">move</span>(self));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">DeferNotOk</span>(io::internal::<span class="built_in">SubmitIO</span>(</span><br><span class="line">      fs-&gt;<span class="built_in">io_context</span>(), std::forward&lt;DeferredFunc&gt;(func), std::<span class="built_in">move</span>(self)));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;  <span class="comment">// namespace</span></span><br><span class="line"></span><br><span class="line">Future&lt;std::shared_ptr&lt;io::InputStream&gt;&gt; FileSystem::<span class="built_in">OpenInputStreamAsync</span>(</span><br><span class="line">    <span class="type">const</span> std::string&amp; path) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">FileSystemDefer</span>(</span><br><span class="line">      <span class="keyword">this</span>, default_async_is_sync_,</span><br><span class="line">      [path](std::shared_ptr&lt;FileSystem&gt; self) &#123; <span class="keyword">return</span> self-&gt;<span class="built_in">OpenInputStream</span>(path); &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸ºä»€ä¹ˆ OpenFile éœ€è¦æ˜¯ async çš„å‘¢ï¼Ÿä¸¾ä¾‹å­å°±æ˜¯ S3 çš„ Open:</p><p>è¿™é‡Œ <code>Init</code> æœ¬èº«ä¼šå‘å‡ºä¸€ä¸ª HeadObjectï¼Œæ‰€ä»¥å¯èƒ½éœ€è¦å°½é‡åœ¨å¯¹åº”çš„å¼‚æ­¥çº¿ç¨‹é‡Œæ‰“å¼€</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// A RandomAccessFile that reads from a S3 object</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ObjectInputFile</span> <span class="keyword">final</span> : <span class="keyword">public</span> io::RandomAccessFile &#123;</span><br><span class="line">  <span class="function">Status <span class="title">Init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Issue a HEAD Object to get the content-length and ensure any</span></span><br><span class="line">    <span class="comment">// errors (e.g. file not found) don&#x27;t wait until the first Read() call.</span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;;  </span><br></pre></td></tr></table></figure><h2 id="File"><a href="#File" class="headerlink" title="File"></a>File</h2><p>File æœ‰å¥½å‡ ä¸ªæ¥å£ï¼Œè¿™äº›ä»£ç æœ¬èº«æ˜¯éå¸¸æ¸…æ™°çš„ã€‚è¿™é‡Œæ¥å£ç±»ä¼¼ conceptï¼Œæ¯ä¸ªåœ°æ–¹æ˜¯ä¸€ä¸ª</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">FileIterface(Close, CloseAsync, Abort, Tell. è¿™é‡Œç‰¹æ®Šè¯´ä¸€ä¸‹ CloseAsync, å› ä¸ºå¯èƒ½æ–‡ä»¶è¯»å–ä¹Ÿè¦é‡Šæ”¾ä¸€äº›èµ„æºçš„)</span><br><span class="line">Seekable(Seek)</span><br><span class="line">Writable(Write, Flush. Write å¯ä»¥ä¼ å…¥ non-owned buffer, ä¹Ÿå¯ä»¥ä¸¢ä¸ª shared_ptr&lt;Buffer&gt; è¿›æ¥æ¥é¿å…æ‹·è´)</span><br><span class="line">Readable(Read. Read å¯ä»¥æ‹·è´åˆ°ç”¨æˆ·çš„ Buffer, ä¹Ÿå¯ä»¥è¿”å›ä¸€ä¸ª shared_ptr&lt;Buffer&gt;)</span><br><span class="line">OutputStream: FileIterface</span><br><span class="line">InputStream: FileIterface, Readable (Advance, Peak, supports_zero_copy, ReadMetadata, ReadMetadataAsync)</span><br><span class="line">RandomAccessFile: InputStream, Seekable (GetStream, GetSize, ReadAt, ReadAsync, ReadManyAsync, WillNeed)</span><br><span class="line">WritableFile: OutputStream (WriteAt)</span><br><span class="line">ReadWriteFileInterface: RandomAccessFile, WritableFile</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªéƒ¨åˆ†æ³¨æ„ä¸€ä¸‹ async çš„å®ç°å³å¯ã€‚æˆ‘ä»¬é¦–å…ˆå…³æ³¨ä¸€ä¸‹ S3 çš„ <code>CloseAsync</code>:</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">Future&lt;&gt; <span class="built_in">CloseAsync</span>() <span class="keyword">override</span> &#123;</span><br><span class="line">   <span class="keyword">if</span> (closed_) <span class="keyword">return</span> Status::<span class="built_in">OK</span>();</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (current_part_) &#123;</span><br><span class="line">     <span class="comment">// Upload last part</span></span><br><span class="line">     <span class="built_in">RETURN_NOT_OK</span>(<span class="built_in">CommitCurrentPart</span>());</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// S3 mandates at least one part, upload an empty one if necessary</span></span><br><span class="line">   <span class="keyword">if</span> (part_number_ == <span class="number">1</span>) &#123;</span><br><span class="line">     <span class="built_in">RETURN_NOT_OK</span>(<span class="built_in">UploadPart</span>(<span class="string">&quot;&quot;</span>, <span class="number">0</span>));</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Wait for in-progress uploads to finish (if async writes are enabled)</span></span><br><span class="line">   <span class="keyword">return</span> <span class="built_in">FlushAsync</span>().<span class="built_in">Then</span>([<span class="keyword">this</span>]() &#123;</span><br><span class="line">     <span class="built_in">ARROW_ASSIGN_OR_RAISE</span>(<span class="keyword">auto</span> client_lock, holder_-&gt;<span class="built_in">Lock</span>());</span><br><span class="line"></span><br><span class="line">     <span class="comment">// At this point, all part uploads have finished successfully</span></span><br><span class="line">     <span class="built_in">DCHECK_GT</span>(part_number_, <span class="number">1</span>);</span><br><span class="line">     <span class="built_in">DCHECK_EQ</span>(upload_state_-&gt;completed_parts.<span class="built_in">size</span>(),</span><br><span class="line">               <span class="built_in">static_cast</span>&lt;<span class="type">size_t</span>&gt;(part_number_ - <span class="number">1</span>));</span><br><span class="line"></span><br><span class="line">     S3Model::CompletedMultipartUpload completed_upload;</span><br><span class="line">     completed_upload.<span class="built_in">SetParts</span>(upload_state_-&gt;completed_parts);</span><br><span class="line">     S3Model::CompleteMultipartUploadRequest req;</span><br><span class="line">     req.<span class="built_in">SetBucket</span>(<span class="built_in">ToAwsString</span>(path_.bucket));</span><br><span class="line">     req.<span class="built_in">SetKey</span>(<span class="built_in">ToAwsString</span>(path_.key));</span><br><span class="line">     req.<span class="built_in">SetUploadId</span>(upload_id_);</span><br><span class="line">     req.<span class="built_in">SetMultipartUpload</span>(std::<span class="built_in">move</span>(completed_upload));</span><br><span class="line"></span><br><span class="line">     <span class="keyword">auto</span> outcome =</span><br><span class="line">         client_lock.<span class="built_in">Move</span>()-&gt;<span class="built_in">CompleteMultipartUploadWithErrorFixup</span>(std::<span class="built_in">move</span>(req));</span><br><span class="line">     <span class="keyword">if</span> (!outcome.<span class="built_in">IsSuccess</span>()) &#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="built_in">ErrorToStatus</span>(</span><br><span class="line">           std::forward_as_tuple(<span class="string">&quot;When completing multiple part upload for key &#x27;&quot;</span>,</span><br><span class="line">                                 path_.key, <span class="string">&quot;&#x27; in bucket &#x27;&quot;</span>, path_.bucket, <span class="string">&quot;&#x27;: &quot;</span>),</span><br><span class="line">           <span class="string">&quot;CompleteMultipartUpload&quot;</span>, outcome.<span class="built_in">GetError</span>());</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     holder_ = <span class="literal">nullptr</span>;</span><br><span class="line">     closed_ = <span class="literal">true</span>;</span><br><span class="line">     <span class="keyword">return</span> Status::<span class="built_in">OK</span>();</span><br><span class="line">   &#125;);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå› ä¸ºå®Œæˆçš„æ—¶å€™è¿˜å¾— <code>Flush</code> ç„¶åå‘ä¸ª <code>Complete</code> è¯·æ±‚ï¼Œæ‰€ä»¥å¾ˆé€‚åˆä½œä¸ºä¸€ä¸ª Asyncã€‚</p><p>å¯¹äº <code>RandomAccessFile::ReadAt</code> æ¥è¯´ï¼Œé»˜è®¤å®ç°æ˜¯ä¸ªå¾ˆæŒ«çš„å®ç°â€¦ï¼Œæ¯”å¦‚ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Result&lt;<span class="type">int64_t</span>&gt; <span class="title">RandomAccessFile::ReadAt</span><span class="params">(<span class="type">int64_t</span> position, <span class="type">int64_t</span> nbytes, <span class="type">void</span>* out)</span> </span>&#123;</span><br><span class="line">  <span class="function">std::lock_guard&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(interface_impl_-&gt;lock_)</span></span>;</span><br><span class="line">  <span class="built_in">RETURN_NOT_OK</span>(<span class="built_in">Seek</span>(position));</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">Read</span>(nbytes, out);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Result&lt;std::shared_ptr&lt;Buffer&gt;&gt; RandomAccessFile::<span class="built_in">ReadAt</span>(<span class="type">int64_t</span> position,</span><br><span class="line">                                                         <span class="type">int64_t</span> nbytes) &#123;</span><br><span class="line">  <span class="function">std::lock_guard&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(interface_impl_-&gt;lock_)</span></span>;</span><br><span class="line">  <span class="built_in">RETURN_NOT_OK</span>(<span class="built_in">Seek</span>(position));</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">Read</span>(nbytes);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>File</code> ç³»è¿˜æœ‰å‡ ä¸ª Concurrency Wrapperï¼Œä½†åœ¨ Release ç¼–è¯‘çš„æ—¶å€™å…¶å®æ˜¯ä¸ä¸Šé”çš„( Concurrency Wrapper å®ç°äº†ã€‚å½“ç„¶ï¼Œç³»ç»Ÿå¦‚æœæ”¯æŒè¿™æ ·ï¼Œå¯ä»¥åšä¸€äº›ç›¸å¯¹å¥½çš„æ“ä½œã€‚HDFS è¿™æ ·æœ‰çš„ client ä¸æ”¯æŒ pread çš„å¯ä»¥èµ°è¿™å¥—ï¼Œä½†æ˜¯å¦‚æœèµ° pread è‚¯å®šå¯ä»¥æœ‰æ›´å¥½çš„æ€§èƒ½.</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// A RandomAccessFile that reads from a S3 object</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ObjectInputFile</span> <span class="keyword">final</span> : <span class="keyword">public</span> io::RandomAccessFile;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå°±å®ç°äº†ä¸å¸¦é”çš„ preadï¼Œæ¥åŠ é€Ÿå¯¹åº”çš„æ“ä½œã€‚</p><h4 id="Buffered-and-Memory-Layer"><a href="#Buffered-and-Memory-Layer" class="headerlink" title="Buffered and Memory Layer"></a>Buffered and Memory Layer</h4><p>Buffered æ˜¯ arrow åŒ…è£…çš„ä¸€å¥— Buffer IO ç³»ç»Ÿï¼Œæˆ‘è§‰å¾—æœ‰ç‚¹ç±»ä¼¼ Rust æ ‡å‡†åº“çš„é‚£å¥— Buffer IOï¼Œç„¶åä¹ŸåŒ…è£…äº†ä¸€äº› Arrow ç‰¹æœ‰çš„é€»è¾‘ã€‚è¯»å–çš„</p><p><code>BufferedOutputStream</code> å’Œ <code>BufferedInputStream</code> æ˜¯ Buffered IO çš„å®ç°ï¼Œåˆ†åˆ«æŠŠè¾“å…¥è¾“å‡º Buffer åŒ–ã€‚</p><p><code>src/arrow/io/memory.h</code> æœ‰ä¸€äº›ç”¨ Memory ä¸­çš„ <code>Buffer</code> æˆ–è€…åˆ«çš„ä¸œè¥¿å½“æˆè¾“å…¥æˆ–è€…è¾“å‡ºçš„å·¥å…·ï¼Œå¯ä»¥åœ¨æµ‹è¯•ä¹‹ç±»çš„ä»£ç å¾ˆæ–¹ä¾¿çš„ä½¿ç”¨ã€‚</p><h3 id="Transform"><a href="#Transform" class="headerlink" title="Transform"></a>Transform</h3><p><code>TransformInputStream</code> å…è®¸ç”¨æˆ·ç»™ inputStream è¯» bytes çš„æ—¶å€™å®šåˆ¶ä¸€ä¸ª <code>transform</code> å‡½æ•°</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ARROW_EXPORT</span> TransformInputStream : <span class="keyword">public</span> InputStream &#123;</span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="keyword">using</span> TransformFunc =</span><br><span class="line">      std::function&lt;Result&lt;std::shared_ptr&lt;Buffer&gt;&gt;(<span class="type">const</span> std::shared_ptr&lt;Buffer&gt;&amp;)&gt;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>æ„Ÿè§‰è¿™ä¸ªå¾—å®šä¹‰ä¸€ä¸ªæœ‰çŠ¶æ€çš„å‡½æ•°ï¼Œæ¯”å¦‚è¯´é‚£ç§ utf8 parsing çš„æ—¶å€™è¿”å›çš„ buf è‚¯å®šä¸ä¸€å®šæ˜¯å®Œæ•´çš„ buf äº†â€¦</p><h3 id="Memory-Caching-Layer"><a href="#Memory-Caching-Layer" class="headerlink" title="Memory Caching Layer"></a>Memory Caching Layer</h3><p><code>src/arrow/io/caching.h</code> å¤„ç†äº†é¢„è¯»ã€ç¼“å­˜ã€IOåˆå¹¶çš„é€»è¾‘ã€‚<code>ReadRangeCache</code> ä¼šé¢„è¯»å¹¶ä¸”ç¼“å­˜æ•°æ®ï¼Œå®ƒæœ‰ä¸¤ç§å½¢å¼ï¼š</p><ol><li>Lazy: ç­‰å¾…ç”¨æˆ·çš„è¯»ï¼Œæ¥è§¦å‘ IO</li><li>Default: æŠŠæ‰€æœ‰ IO å‘å‡ºå»</li></ol><p>ä¸Šé¢ä¸¤ç§æ¥å£éƒ½ä¼šå‘é€ IO åˆå¹¶ï¼Œç„¶åè¯»ä¸€ä¸ªå¤§å—çš„æ—¶å€™ IO å‘å‡ºå»ä¹‹åä¼šç¼“å­˜</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">ARROW_EXPORT</span> CacheOptions &#123;</span><br><span class="line">  <span class="type">static</span> <span class="keyword">constexpr</span> <span class="type">double</span> kDefaultIdealBandwidthUtilizationFrac = <span class="number">0.9</span>;</span><br><span class="line">  <span class="type">static</span> <span class="keyword">constexpr</span> <span class="type">int64_t</span> kDefaultMaxIdealRequestSizeMib = <span class="number">64</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// \brief The maximum distance in bytes between two consecutive</span></span><br><span class="line">  <span class="comment">///   ranges; beyond this value, ranges are not combined</span></span><br><span class="line">  <span class="type">int64_t</span> hole_size_limit;</span><br><span class="line">  <span class="comment">/// \brief The maximum size in bytes of a combined range; if</span></span><br><span class="line">  <span class="comment">///   combining two consecutive ranges would produce a range of a</span></span><br><span class="line">  <span class="comment">///   size greater than this, they are not combined</span></span><br><span class="line">  <span class="type">int64_t</span> range_size_limit;</span><br><span class="line">  <span class="comment">/// \brief A lazy cache does not perform any I/O until requested.</span></span><br><span class="line">  <span class="type">bool</span> lazy;</span><br><span class="line">  <span class="comment">/// \brief The maximum number of ranges to be prefetched. This is only used</span></span><br><span class="line">  <span class="comment">///   for lazy cache to asynchronously read some ranges after reading the target range.</span></span><br><span class="line">  <span class="type">int64_t</span> prefetch_limit = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="type">bool</span> <span class="keyword">operator</span>==(<span class="type">const</span> CacheOptions&amp; other) <span class="type">const</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> hole_size_limit == other.hole_size_limit &amp;&amp;</span><br><span class="line">           range_size_limit == other.range_size_limit &amp;&amp; lazy == other.lazy &amp;&amp;</span><br><span class="line">           prefetch_limit == other.prefetch_limit;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// \brief Construct CacheOptions from network storage metrics (e.g. S3).</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// \param[in] time_to_first_byte_millis Seek-time or Time-To-First-Byte (TTFB) in</span></span><br><span class="line">  <span class="comment">///   milliseconds, also called call setup latency of a new S3 request.</span></span><br><span class="line">  <span class="comment">///   The value is a positive integer.</span></span><br><span class="line">  <span class="comment">/// \param[in] transfer_bandwidth_mib_per_sec Data transfer Bandwidth (BW) in MiB/sec.</span></span><br><span class="line">  <span class="comment">///   The value is a positive integer.</span></span><br><span class="line">  <span class="comment">/// \param[in] ideal_bandwidth_utilization_frac Transfer bandwidth utilization fraction</span></span><br><span class="line">  <span class="comment">///   (per connection) to maximize the net data load.</span></span><br><span class="line">  <span class="comment">///   The value is a positive double precision number less than 1.</span></span><br><span class="line">  <span class="comment">/// \param[in] max_ideal_request_size_mib The maximum single data request size (in MiB)</span></span><br><span class="line">  <span class="comment">///   to maximize the net data load.</span></span><br><span class="line">  <span class="comment">///   The value is a positive integer.</span></span><br><span class="line">  <span class="comment">/// \return A new instance of CacheOptions.</span></span><br><span class="line">  <span class="function"><span class="type">static</span> CacheOptions <span class="title">MakeFromNetworkMetrics</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">      <span class="type">int64_t</span> time_to_first_byte_millis, <span class="type">int64_t</span> transfer_bandwidth_mib_per_sec,</span></span></span><br><span class="line"><span class="params"><span class="function">      <span class="type">double</span> ideal_bandwidth_utilization_frac = kDefaultIdealBandwidthUtilizationFrac,</span></span></span><br><span class="line"><span class="params"><span class="function">      <span class="type">int64_t</span> max_ideal_request_size_mib = kDefaultMaxIdealRequestSizeMib)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="type">static</span> CacheOptions <span class="title">Defaults</span><span class="params">()</span></span>;</span><br><span class="line">  <span class="function"><span class="type">static</span> CacheOptions <span class="title">LazyDefaults</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæ¯”è¾ƒæ–°é¢–çš„ä¸€ä¸ªåœ°æ–¹æ˜¯ <code>MakeFromNetworkMetrics</code>, æ ¹æ®ç½‘ç»œçŠ¶å†µç”Ÿæˆå¯¹åº”çš„ IO çŠ¶å†µ.</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Arrow Acero Framework</title>
      <link href="/2023/08/03/Arrow-Acero-Framework/"/>
      <url>/2023/08/03/Arrow-Acero-Framework/</url>
      
        <content type="html"><![CDATA[<p>Acero æ˜¯ä¸€ä¸ª ã€ŒStreamingã€ çš„å¤„ç†å¼•æ“ã€‚è¿™ä¸ª Streaming æœ‰ç‚¹ç±»ä¼¼ Monet/X100 æ„ä¹‰ä¸Šçš„ï¼š</p><ol><li>æœ€æ—© Monet ä»–ä»¬å¼„çš„æ˜¯æ•´ä¸ªå…¨éƒ¨ç‰©åŒ–ï¼Œæ¯ä¸ªæŒ‰ç…§è‡ªå·±çš„å¤§ Batch åšæ‰§è¡Œ</li><li>åæ¥å‘ç°è¿™æ ·ç‰©åŒ–çš„å¼€é”€è¿‡é«˜ï¼Œæ‰€ä»¥å¼„æˆäº† Batch Exec</li></ol><p>Acero åœ¨ Arrow ä¸­ä¹Ÿæ˜¯è¿™æ ·çš„å­˜åœ¨ï¼Œå®ƒæ˜¯ä¸€ä¸ª Push-Based Executorï¼Œç›®å‰è¿˜ä¸æ”¯æŒ Pipeline Executor ä¹‹ç±»çš„å½¢å¼ã€‚ ä¹Ÿä¸æ”¯æŒ Sort Merge Join å’Œ Sort Aggã€‚åŸºæœ¬ä¸Šæ”¯æŒçš„ç®—å­éƒ½åœ¨ä¸‹é¢äº†ã€‚è¿™ä¹Ÿå¯¼è‡´äº†ä¸€ä¸ªç°è±¡ï¼š</p><ul><li>SortBy, TopK ç®—å­åœ¨ Acero é‡Œé¢æ˜¯ç»“åˆ Sink ç®—å­æ¥å®ç°çš„</li></ul><p><img src="https://image.mwish.me/blog-image/415664007430259013.png" alt="img"></p><p>Acero ç›¸å½“äºä¸€ä¸ªä¸²è” Dataset (è¯»/å†™)ï¼ŒFunction çš„å·¥å…·ï¼Œäº§ç”Ÿéœ€è¦çš„æ•°æ®æˆ–è€… Tableã€‚å®ƒå¹¶æ²¡æœ‰ä»€ä¹ˆä¼˜åŒ–å™¨ï¼Œç±»ä¼¼ Veloxï¼Œå¯¹æ¥çš„æ˜¯å¤–å±‚çš„ Substrait[1] , dplyr [2] æ¥å£ã€‚</p><p>æˆ‘ä»¬ä¼šä» Declarationï¼ŒPlan ï¼ŒNode å±‚å¼€å§‹ä»‹ç» Acero çš„ç»“æ„ã€‚</p><h2 id="Overview"><a href="#Overview" class="headerlink" title="Overview"></a>Overview</h2><p>æ–‡æ¡£çš„è¿™ä¸€èŠ‚ä»‹ç»äº† Acero çš„ç»“æ„ï¼ˆ <a href="https://arrow.apache.org/docs/cpp/streaming_execution.html#architecture-overview">https://arrow.apache.org/docs/cpp/streaming_execution.html#architecture-overview</a> ï¼‰</p><p>æš‚æ—¶æ— æ³•åœ¨é£ä¹¦æ–‡æ¡£å¤–å±•ç¤ºæ­¤å†…å®¹</p><ol><li><code>ExecPlan</code> å¯ä»¥ä» <code>Declaration</code> ä¸­åˆ›å»ºï¼Œä½œä¸ºä¸€äº›è¯­æ³•ç³–. <code>ExecPlan</code> ä¸ä»…æ˜¯ä¸€ä¸ª</li><li><code>ExecNode</code> æ˜¯ä¸€ä¸ª Acero ä¸­çš„åŸºæœ¬æ§åˆ¶å•å…ƒï¼Œå¹¶ä¸”å¯ä»¥åŠ å…¥ <code>ExecNodeOptions</code>ã€‚å„ç§ç±»å‹çš„ ExecNode æ„é€ å‡½æ•°ä¸å¯¹å¤–å…¬å¼€ï¼Œä½†æ˜¯å¯ä»¥èµ° <code>ExecFactoryRegistry</code> åˆ›å»ºã€‚</li><li>æ•°æ®é€šè¿‡ ExecBatch æ¥æ¨é€ï¼Œè¿™ä¸ªä¸œè¥¿ä¹Ÿæ˜¯ä¸ªæ³›ç”¨ç±»å‹çš„ç©æ„</li></ol><p>Acero å¤§éƒ¨åˆ†å®ç°æ˜¯åšåœ¨ Compute ä¸Šçš„ï¼ŒAcero ä¸»è¦åšçš„æ˜¯ä¸²èµ· Dataset å’Œ Computeï¼Œè¿™é‡Œè¿˜æœ‰å¼ ä¸é”™çš„å›¾ï¼š</p><p><img src="https://image.mwish.me/blog-image/7708173130236331652.png" alt="img"></p><p>è¿™é‡Œåˆ›å»º ExecNode çš„æ—¶å€™ï¼Œç±»ä¼¼ <code>CallFunction</code>, ä¹Ÿå¯ä»¥é€šè¿‡åç§°æ¥åˆ›å»ºï¼Œe.g. <a href="https://arrow.apache.org/docs/cpp/streaming_execution.html#constructing-execnode-using-options">https://arrow.apache.org/docs/cpp/streaming_execution.html#constructing-execnode-using-options</a></p><p>Plan æ˜¯ä¸€ä¸ª ExecNode çš„ç»„åˆã€‚å®ƒç›¸å½“äºæ•´ä¸ªæ‰§è¡Œçš„ Planï¼Œè€Œä¸æ˜¯ç±»ä¼¼ <code>PhysicalPlanNode</code> è¿™ç§ <code>ExecNode</code> å¯¹åº”çš„å•ä¸ªèŠ‚ç‚¹çš„ç»“æ„ã€‚å®ƒä¹Ÿæœ‰ä¸€äº›æ‰§è¡Œçš„ä¸Šä¸‹æ–‡ ï¼ˆ<code>ExecContext</code> å’Œ <code>QueryOptions</code>ï¼‰. </p><p>ExecBatch æ˜¯å¯¹åº”çš„ä¼ é€’çš„å•å…ƒï¼Œå®ƒä»£ç æ¯”è¾ƒç®€å•ã€‚è¿™é‡Œå®ƒä»£ç å¼•å…¥äº† <code>SelectionVector</code>ï¼Œä½†æ˜¯å®ç°å¹¶æ²¡æœ‰ç”¨ä¸Š selection vectorã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// The values representing positional arguments to be passed to a kernel&#x27;s</span></span><br><span class="line"><span class="comment">/// exec function for processing.</span></span><br><span class="line">std::vector&lt;Datum&gt; values;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// SV, å®é™…ä¸Šæ˜¯æ²¡æœ‰ç”¨ä¸Šçš„</span></span><br><span class="line">std::shared_ptr&lt;SelectionVector&gt; selection_vector;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// DataBatch å†…çš„ Guarantee. è¿™é‡Œçš„æŠ½è±¡æ¯”è¾ƒæœ‰æ„æ€, å› ä¸ºå®ƒå¯èƒ½å€¾å‘äº</span></span><br><span class="line"><span class="comment">/// é‡Œé¢æ¥è‡ªåŒä¸€ä¸ª RowGroup æˆ–è€…å•¥çš„. æ‰€ä»¥å¯¹ä¸Šæ–¹åå‡ºçš„æ•°æ®ä¼šæœ‰ä¸€ä¸ª gurantee.</span></span><br><span class="line">Expression guarantee = <span class="built_in">literal</span>(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/// values é‡Œé¢æ¯ä¸ªçš„é•¿åº¦(å¯èƒ½ä¼šæœ‰ constants, è¿™é‡Œå®ƒæŠ½è±¡å’Œ Velox çš„)</span></span><br><span class="line"><span class="type">int64_t</span> length = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// è¿™é‡Œå…è®¸å¹¶è¡Œè¯»å–å¤šä¸ªæ–‡ä»¶ç„¶å unordered åå‡ºå»ï¼Œè¿™ä¸ª index è¡¨ç¤º Order ç›¸å…³çš„éƒ¨åˆ†ã€‚</span></span><br><span class="line"><span class="type">int64_t</span> index = kUnsequencedIndex;</span><br></pre></td></tr></table></figure><p><img src="https://image.mwish.me/blog-image/3457402530082094772.png" alt="img"></p><p>ä¸Šé¢æ˜¯ ExecBatch çš„å®˜å›¾ã€‚Acero é‡Œçš„ <code>Node</code> å·¥å‚å¦‚ä»£ç æ‰€ç¤ºï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// \brief An extensible registry for factories of ExecNodes</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ARROW_ACERO_EXPORT</span> ExecFactoryRegistry &#123;</span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="keyword">using</span> Factory = std::function&lt;<span class="built_in">Result</span>&lt;ExecNode*&gt;(ExecPlan*, std::vector&lt;ExecNode*&gt;,</span><br><span class="line">                                                  <span class="type">const</span> ExecNodeOptions&amp;)&gt;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">virtual</span> ~<span class="built_in">ExecFactoryRegistry</span>() = <span class="keyword">default</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// \brief Get the named factory from this registry</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// will raise if factory_name is not found</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> Result&lt;Factory&gt; <span class="title">GetFactory</span><span class="params">(<span class="type">const</span> std::string&amp; factory_name)</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// \brief Add a factory to this registry with the provided name</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// will raise if factory_name is already in the registry</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> Status <span class="title">AddFactory</span><span class="params">(std::string factory_name, Factory factory)</span> </span>= <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// The default registry, which includes built-in factories.</span></span><br><span class="line"><span class="function">ARROW_ACERO_EXPORT</span></span><br><span class="line"><span class="function">ExecFactoryRegistry* <span class="title">default_exec_factory_registry</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// \brief Construct an ExecNode using the named factory</span></span><br><span class="line"><span class="function"><span class="keyword">inline</span> Result&lt;ExecNode*&gt; <span class="title">MakeExecNode</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> std::string&amp; factory_name, ExecPlan* plan, std::vector&lt;ExecNode*&gt; inputs,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> ExecNodeOptions&amp; options,</span></span></span><br><span class="line"><span class="params"><span class="function">    ExecFactoryRegistry* registry = default_exec_factory_registry())</span> </span>&#123;</span><br><span class="line">  <span class="built_in">ARROW_ASSIGN_OR_RAISE</span>(<span class="keyword">auto</span> factory, registry-&gt;<span class="built_in">GetFactory</span>(factory_name));</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">factory</span>(plan, std::<span class="built_in">move</span>(inputs), options);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œéœ€è¦æ³¨æ„ï¼Œ<code>Node</code> çš„å…³ç³»åŸºæœ¬ä¸Šæ˜¯ <code>ExecNode</code> è‡ªå·±ç»´æŠ¤çš„ï¼Œ<code>Plan</code> ä¼šå»é©±åŠ¨æ•´ä¸ªæ‰§è¡Œã€‚<code>MakeExecNode</code> çš„æ—¶å€™ï¼Œè¿™é‡Œä¼š <code>emplace_back</code> å¯¹åº”çš„èŠ‚ç‚¹ã€‚ç„¶ååœ¨ Build çš„é˜¶æ®µæ‹“æ‰‘æ’åºã€‚</p><p>èŠ‚ç‚¹æœ‰ä¸åŒçš„ç±»å‹ï¼Œè¿™é‡Œæˆ‘ä»¬ç®€å•çš„æŠ½è±¡ï¼š</p><ul><li>TableSource / Scan: ç±»ä¼¼ â€œscanâ€ ä¹‹ç±»çš„æ¥å£ï¼Œæä¾›æ•°æ®æºã€‚è¿™é‡Œä¸€éƒ¨åˆ†ä»£ç å®ç°åœ¨ Dataset é‚£å¥—æ¥å£ä¸‹é¢</li><li>Project: å¾ˆæ­£å¸¸çš„ Projectï¼Œåœ¨æœ‰çš„åœ°æ–¹ Project å¹¶ä¸ä¼šæ˜¯ä¸€ä¸ª Nodeï¼Œè€Œæ˜¯ä½œä¸ºå±æ€§ä¸¢ç»™å„ä¸ªç®—å­è‡ªå·±ï¼Œè€Œä¸æ˜¯æå‡ºä¸€ä¸ª Projectã€‚ä¸è¿‡æˆ‘æ„Ÿè§‰è¿™å—å¼€é”€ä¹Ÿä¸æ˜¯å¾ˆå¤§</li><li>Filter: ç»™å‡ºå¯¹åº”çš„è¿‡æ»¤é€»è¾‘ï¼Œèµ° Compute::Filter</li><li>Sink: è®¡ç®—çš„ç»“æœï¼ŒOrderBy TopK ä¹‹ç±»çš„ç®—å­ç›®å‰æ˜¯åœ¨ Sink ä¸Šé¢å®ç°çš„ï¼Œè¿™æœ‰ç‚¹å¥‡æ€ªã€‚</li></ul><p>åœ¨ Node èŠ‚ç‚¹ä¸²èµ·æ¥ä¹‹åï¼Œæˆ‘ä»¬éœ€è¦ Care ä¸€ä¸‹ Pipeline çš„æ§åˆ¶æµ. åœ¨ Acero å†…éƒ¨æœ‰ä¸¤ä¸ª Scheduler:</p><ol><li>AsyncScheduler</li><li>TaskScheduler</li></ol><p>AsyncScheduler æœ‰ç‚¹ç±»ä¼¼ Pipeline çš„æ ¹ç»“ç‚¹ï¼Œå®ƒä¼šæŠŠ â€œscanâ€ ä¹‹ç±»æœ€åº•ç«¯çš„ Node æ¨è¿›å»ï¼Œç„¶å ScanNode å¯èƒ½ä¼šè°ƒç”¨é€šçŸ¥ä¸‹ä¸€å±‚èŠ‚ç‚¹ï¼Œæ¥é€šä¿¡ä¸‹ä¸€å±‚ä¿¡æ¯ã€‚TaskScheduler æ˜¯ä¸“é—¨ç»™ Join è¿™ç§å‡†å¤‡çš„ï¼Œå®ƒä¼šç±»ä¼¼ ForkJoinï¼Œåœ¨çº¿ç¨‹ç»„ä¸Šæ‰§è¡Œå¤šä¸ªä»»åŠ¡ã€‚ï¼ˆä¸è¿‡ TaskScheduler ä»£ç æˆ‘æ²¡å®Œå…¨çœ‹æ‡‚ï¼‰</p><h2 id="Framework"><a href="#Framework" class="headerlink" title="Framework"></a>Framework</h2><p>æˆ‘ä»¬åœ¨è¿™é‡Œä»‹ç» <code>ExecPlan</code> å’Œ <code>ExecNode</code> ä¸¤å±‚ï¼Œå°½å¯èƒ½ä»‹ç»ä¸€ä¸‹</p><h3 id="Future"><a href="#Future" class="headerlink" title="Future"></a>Future</h3><p>é¦–å…ˆæˆ‘ä»¬éœ€è¦ä»‹ç»ä¸€ä¸‹ arrow çš„ <code>Future</code>ï¼Œå®ƒå®ç°äº†ä¸€å¥—ç®€å•çš„ Futureï¼Œå®é™…ä¸Šè¿™æ˜¯ä¸€ä¸ªæ”¯æŒæ·»åŠ  Callback çš„ <code>shared_future</code>ï¼ŒArrow ç”¨è¿™ä¸ªå…±äº«çš„ Future æ¥æ”¯æŒäº† push-based çš„è¯­æ ¸ã€‚è¿™é‡Œå¯ä»¥çœ‹ <code>Future</code> ä½œ <code>Future&lt;Result&lt;T&gt;&gt;</code>, å®ƒå¯¹ <code>Status</code> ç­‰ç±»å‹åšäº†å¾ˆå¥½çš„æ”¯æŒã€‚</p><p>è¿™å¥—ä¸œè¥¿å®ç°åœ¨ï¼š<a href="https://arrow.apache.org/docs/cpp/api/async.html">https://arrow.apache.org/docs/cpp/api/async.html</a> ã€‚è¿™å¥—ä»£ç æ˜¯æ¯”è¾ƒæ­£å¸¸çš„ Future ä»£ç ï¼Œå…³æ³¨æ¥å£å°±è¡Œäº†ã€‚å®ç°ç­‰æˆ‘çœ‹ä¸€åœˆ C++ Templates å†æ¥å•ƒå§ XD</p><p>åœ¨è¿™é‡Œï¼ŒFuture æœ¬èº«ä½œä¸º shared_future, æ‰€ä»¥å¯ä»¥è¿™æ ·</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Result&lt;Table&gt; <span class="title">blockingOp</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   <span class="keyword">auto</span> future = plan-&gt;<span class="built_in">GetFuture</span>()</span><br><span class="line">   future.<span class="built_in">Wait</span>();  <span class="comment">// &lt;-- è½¬æ¢æˆé˜»å¡æ“ä½œï¼Œä¸å½±å“å†…éƒ¨çš„æ‰§è¡Œ</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Future å¯ä»¥æ·»åŠ  <code>Callback</code> å’Œ <code>Then</code>.</p><ol><li><code>AddCallback</code> åŠ å…¥ Callback, Callback æ˜¯å¤„ç†å®Œæœ¬ <code>Future</code> ä¹‹åæ‰§è¡Œçš„ä¸€ä¸ªæˆ–è€…å¤šä¸ªå›è°ƒå‡½æ•°ã€‚è¿™é‡Œå¦‚æœå¯¹ä¸€ä¸ª Finished Future è°ƒç”¨ Callbackï¼Œé‚£ä¹ˆå¯èƒ½ä¼šç›´æ¥è°ƒç”¨è¿™ä¸ªå‡½æ•°ï¼ˆå‚»äº†å§ï¼Œå°±åœ° Callbackï¼‰ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œè¿™é‡Œæä¾›äº† <code>TryAddCallback</code> æ¥å£ï¼Œå¦‚æœæ‰§è¡Œå®Œäº†ï¼Œè¿™é‡Œä¼šä¸æ‰§è¡Œè¿™ä¸ª<ol><li>Callback å¯ä»¥ç»‘å®šå¯¹åº”çš„ <code>options</code> ï¼Œå…¶ä¸­å¯ä»¥å¸¦ä¸Šå¯¹åº”çš„ Executorã€‚è¿™é‡Œå®ç°çš„æ—¶å€™ï¼Œå°±å…è®¸ä½ è¿™ä¸ªåœ°æ–¹æ‰§è¡Œå¯¹åº”çš„é€»è¾‘ã€‚ä¹Ÿæœ‰ä¸€äº›é€»è¾‘å†³å®šæ˜¯å¦è°ƒåº¦å¯¹åº”çš„ Futureï¼Œç±»ä¼¼ Folly ä¸­çš„ <code>via</code></li></ol></li><li><code>Then</code> ç±»ä¼¼ <code>Callback</code>, ä½†æ˜¯æœ¬èº«äº§ç”Ÿä¸€ä¸ª <code>future</code>ã€‚å®ƒç°åœ¨ä¼šå½“æˆ Callback å®ç°ï¼Œä¸ä¼šåœ¨ <code>Callback</code> æ‰§è¡Œå®Œä¹‹åè¢«è°ƒåº¦ï¼Œè€Œæ˜¯å½“æˆä¸€ä¸ªæ™®é€šçš„ Callbackã€‚</li></ol><p>æˆ‘ä»¬å¯ä»¥ç®€å•çœ‹å‡ ä¸ª Future çš„ä½¿ç”¨ä¾‹å­ï¼ˆè€Œä¸æ˜¯çœ‹ä»£ç ï¼‰ï¼š</p><p>Case 1: All</p><p>è¿™é‡Œå…³é”®ç‚¹æ˜¯ç”¨ Callback å®ç°ï¼Œç„¶åå¤„ç†é”™è¯¯ï¼Œè¿”å›ä¸€ä¸ªæ–°çš„ Futureã€‚ç„¶åæ‰€æœ‰ Future ç»“æŸåœ¨æ–°çš„ Future é‡Œé¢ <code>MarkFinished</code></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">Future&lt;std::vector&lt;Result&lt;T&gt;&gt;&gt; <span class="built_in">All</span>(std::vector&lt;Future&lt;T&gt;&gt; futures) &#123;</span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">State</span> &#123;</span><br><span class="line">    <span class="function"><span class="keyword">explicit</span> <span class="title">State</span><span class="params">(std::vector&lt;Future&lt;T&gt;&gt; f)</span></span></span><br><span class="line"><span class="function">        : futures(std::move(f)), n_remaining(futures.size()) &#123;</span>&#125;</span><br><span class="line"></span><br><span class="line">    std::vector&lt;Future&lt;T&gt;&gt; futures;</span><br><span class="line">    std::atomic&lt;<span class="type">size_t</span>&gt; n_remaining;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (futures.<span class="built_in">size</span>() == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;std::vector&lt;Result&lt;T&gt;&gt;&#123;&#125;&#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">auto</span> state = std::<span class="built_in">make_shared</span>&lt;State&gt;(std::<span class="built_in">move</span>(futures));</span><br><span class="line"></span><br><span class="line">  <span class="keyword">auto</span> out = Future&lt;std::vector&lt;Result&lt;T&gt;&gt;&gt;::<span class="built_in">Make</span>();</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">const</span> Future&lt;T&gt;&amp; future : state-&gt;futures) &#123;</span><br><span class="line">    future.<span class="built_in">AddCallback</span>([state, out](<span class="type">const</span> Result&lt;T&gt;&amp;) <span class="keyword">mutable</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (state-&gt;n_remaining.<span class="built_in">fetch_sub</span>(<span class="number">1</span>) != <span class="number">1</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">      std::vector&lt;Result&lt;T&gt;&gt; <span class="built_in">results</span>(state-&gt;futures.<span class="built_in">size</span>());</span><br><span class="line">      <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; results.<span class="built_in">size</span>(); ++i) &#123;</span><br><span class="line">        results[i] = state-&gt;futures[i].<span class="built_in">result</span>();</span><br><span class="line">      &#125;</span><br><span class="line">      out.<span class="built_in">MarkFinished</span>(std::<span class="built_in">move</span>(results));</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> out;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Case2: CountRows:</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> FragmentGenerator = AsyncGenerator&lt;std::shared_ptr&lt;Fragment&gt;&gt;;</span><br><span class="line"></span><br><span class="line"><span class="function">Result&lt;FragmentGenerator&gt; <span class="title">AsyncScanner::GetFragments</span><span class="params">()</span> <span class="type">const</span> </span>&#123;</span><br><span class="line">  <span class="comment">// TODO(ARROW-8163): Async fragment scanning will return AsyncGenerator&lt;Fragment&gt;</span></span><br><span class="line">  <span class="comment">// here. Current iterator based versions are all fast &amp; sync so we will just ToVector</span></span><br><span class="line">  <span class="comment">// it</span></span><br><span class="line">  <span class="built_in">ARROW_ASSIGN_OR_RAISE</span>(<span class="keyword">auto</span> fragments_it, dataset_-&gt;<span class="built_in">GetFragments</span>(scan_options_-&gt;filter));</span><br><span class="line">  <span class="built_in">ARROW_ASSIGN_OR_RAISE</span>(<span class="keyword">auto</span> fragments_vec, fragments_it.<span class="built_in">ToVector</span>());</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">MakeVectorGenerator</span>(std::<span class="built_in">move</span>(fragments_vec));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">Future&lt;<span class="type">int64_t</span>&gt; <span class="title">AsyncScanner::CountRowsAsync</span><span class="params">(Executor* executor)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">ARROW_ASSIGN_OR_RAISE</span>(<span class="keyword">auto</span> fragment_gen, <span class="built_in">GetFragments</span>());</span><br><span class="line"></span><br><span class="line">  <span class="function">compute::ExecContext <span class="title">exec_context</span><span class="params">(scan_options_-&gt;pool, executor)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">ARROW_ASSIGN_OR_RAISE</span>(<span class="keyword">auto</span> plan, acero::ExecPlan::<span class="built_in">Make</span>(exec_context));</span><br><span class="line">  <span class="comment">// Drop projection since we only need to count rows</span></span><br><span class="line">  <span class="type">const</span> <span class="keyword">auto</span> options = std::<span class="built_in">make_shared</span>&lt;ScanOptions&gt;(*scan_options_);</span><br><span class="line">  <span class="built_in">ARROW_ASSIGN_OR_RAISE</span>(<span class="keyword">auto</span> empty_projection,</span><br><span class="line">                        ProjectionDescr::<span class="built_in">FromNames</span>(std::<span class="built_in">vector</span>&lt;std::string&gt;(),</span><br><span class="line">                                                   *scan_options_-&gt;dataset_schema));</span><br><span class="line">  <span class="built_in">SetProjection</span>(options.<span class="built_in">get</span>(), empty_projection);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">auto</span> total = std::make_shared&lt;std::atomic&lt;<span class="type">int64_t</span>&gt;&gt;(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">  fragment_gen = <span class="built_in">MakeMappedGenerator</span>(</span><br><span class="line">      std::<span class="built_in">move</span>(fragment_gen),</span><br><span class="line">      [options, total](<span class="type">const</span> std::shared_ptr&lt;Fragment&gt;&amp; fragment) &#123;</span><br><span class="line">        <span class="keyword">return</span> fragment-&gt;<span class="built_in">CountRows</span>(options-&gt;filter, options)</span><br><span class="line">            .<span class="built_in">Then</span>([options, total, fragment](std::optional&lt;<span class="type">int64_t</span>&gt; fast_count) <span class="keyword">mutable</span></span><br><span class="line">                  -&gt; std::shared_ptr&lt;Fragment&gt; &#123;</span><br><span class="line">              <span class="keyword">if</span> (fast_count) &#123;</span><br><span class="line">                <span class="comment">// fast path: got row count directly; skip scanning this fragment</span></span><br><span class="line">                (*total) += *fast_count;</span><br><span class="line">                <span class="keyword">return</span> std::<span class="built_in">make_shared</span>&lt;InMemoryFragment&gt;(options-&gt;dataset_schema,</span><br><span class="line">                                                          RecordBatchVector&#123;&#125;);</span><br><span class="line">              &#125;</span><br><span class="line"></span><br><span class="line">              <span class="comment">// slow path: actually filter this fragment&#x27;s batches</span></span><br><span class="line">              <span class="keyword">return</span> std::<span class="built_in">move</span>(fragment);</span><br><span class="line">            &#125;);</span><br><span class="line">      &#125;);</span><br><span class="line"></span><br><span class="line">  acero::Declaration count_plan = acero::Declaration::<span class="built_in">Sequence</span>(</span><br><span class="line">      &#123;&#123;<span class="string">&quot;scan&quot;</span>,</span><br><span class="line">        ScanNodeOptions&#123;std::<span class="built_in">make_shared</span>&lt;FragmentDataset&gt;(scan_options_-&gt;dataset_schema,</span><br><span class="line">                                                          std::<span class="built_in">move</span>(fragment_gen)),</span><br><span class="line">                        options&#125;&#125;,</span><br><span class="line">       &#123;<span class="string">&quot;project&quot;</span>, acero::ProjectNodeOptions&#123;&#123;options-&gt;filter&#125;, &#123;<span class="string">&quot;mask&quot;</span>&#125;&#125;&#125;,</span><br><span class="line">       &#123;<span class="string">&quot;aggregate&quot;</span>, acero::AggregateNodeOptions&#123;&#123;compute::Aggregate&#123;</span><br><span class="line">                         <span class="string">&quot;sum&quot;</span>, <span class="literal">nullptr</span>, <span class="string">&quot;mask&quot;</span>, <span class="string">&quot;selected_count&quot;</span>&#125;&#125;&#125;&#125;&#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> acero::<span class="built_in">DeclarationToBatchesAsync</span>(std::<span class="built_in">move</span>(count_plan), exec_context)</span><br><span class="line">      .<span class="built_in">Then</span>([total](<span class="type">const</span> RecordBatchVector&amp; batches) -&gt; Result&lt;<span class="type">int64_t</span>&gt; &#123;</span><br><span class="line">        <span class="built_in">DCHECK_EQ</span>(<span class="number">1</span>, batches.<span class="built_in">size</span>());</span><br><span class="line">        <span class="built_in">ARROW_ASSIGN_OR_RAISE</span>(std::shared_ptr&lt;Scalar&gt; count_scalar,</span><br><span class="line">                              batches[<span class="number">0</span>]-&gt;<span class="built_in">column</span>(<span class="number">0</span>)-&gt;<span class="built_in">GetScalar</span>(<span class="number">0</span>));</span><br><span class="line">        <span class="keyword">return</span> total-&gt;<span class="built_in">load</span>() +</span><br><span class="line">               <span class="built_in">static_cast</span>&lt;<span class="type">int64_t</span>&gt;(</span><br><span class="line">                   ::arrow::internal::<span class="built_in">checked_pointer_cast</span>&lt;UInt64Scalar&gt;(count_scalar)</span><br><span class="line">                       -&gt;value);</span><br><span class="line">      &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ª <code>Then</code> ç”¨çš„è¿˜æŒºæœ‰è¶£</p><h3 id="Plan"><a href="#Plan" class="headerlink" title="Plan"></a>Plan</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ARROW_ACERO_EXPORT</span> ExecPlan : <span class="keyword">public</span> std::enable_shared_from_this&lt;ExecPlan&gt; &#123;</span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="comment">// This allows operators to rely on signed 16-bit indices</span></span><br><span class="line">  <span class="type">static</span> <span class="type">const</span> <span class="type">uint32_t</span> kMaxBatchSize = <span class="number">1</span> &lt;&lt; <span class="number">15</span>;</span><br><span class="line">  <span class="keyword">using</span> NodeVector = std::vector&lt;ExecNode*&gt;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">virtual</span> ~<span class="built_in">ExecPlan</span>() = <span class="keyword">default</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function">QueryContext* <span class="title">query_context</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// \brief retrieve the nodes in the plan</span></span><br><span class="line">  <span class="function"><span class="type">const</span> NodeVector&amp; <span class="title">nodes</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="function">ExecNode* <span class="title">AddNode</span><span class="params">(std::unique_ptr&lt;ExecNode&gt; node)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">template</span> &lt;<span class="keyword">typename</span> Node, <span class="keyword">typename</span>... Args&gt;</span><br><span class="line">  <span class="function">Node* <span class="title">EmplaceNode</span><span class="params">(Args&amp;&amp;... args)</span> </span>&#123;</span><br><span class="line">    std::unique_ptr&lt;Node&gt; node&#123;<span class="keyword">new</span> Node&#123;std::forward&lt;Args&gt;(args)...&#125;&#125;;</span><br><span class="line">    <span class="keyword">auto</span> out = node.<span class="built_in">get</span>();</span><br><span class="line">    <span class="built_in">AddNode</span>(std::<span class="built_in">move</span>(node));</span><br><span class="line">    <span class="keyword">return</span> out;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function">Status <span class="title">Validate</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// \brief Start producing on all nodes</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// Nodes are started in reverse topological order, such that any node</span></span><br><span class="line">  <span class="comment">/// is started before all of its inputs.</span></span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">StartProducing</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// \brief Stop producing on all nodes</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// Triggers all sources to stop producing new data.  In order to cleanly stop the plan</span></span><br><span class="line">  <span class="comment">/// will continue to run any tasks that are already in progress.  The caller should</span></span><br><span class="line">  <span class="comment">/// still wait for `finished` to complete before destroying the plan.</span></span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">StopProducing</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// \brief A future which will be marked finished when all tasks have finished.</span></span><br><span class="line">  Future&lt;&gt; <span class="built_in">finished</span>();</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// \brief Return whether the plan has non-empty metadata</span></span><br><span class="line">  <span class="function"><span class="type">bool</span> <span class="title">HasMetadata</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// \brief Return the plan&#x27;s attached metadata</span></span><br><span class="line">  <span class="function">std::shared_ptr&lt;<span class="type">const</span> KeyValueMetadata&gt; <span class="title">metadata</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="function">std::string <span class="title">ToString</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢è¿™æ®µä»£ç ç”Ÿå‘½å‘¨æœŸç®¡ç†è¿˜æ˜¯éå¸¸å¥½ç†è§£çš„ï¼š</p><ol><li><code>StartProducing</code>: å¼€å§‹äº§ç”Ÿæ•°æ®</li><li><code>StopProducing</code>: åœæ­¢äº§ç”Ÿ <strong>source æ•°æ®</strong>ã€‚</li></ol><h3 id="Node"><a href="#Node" class="headerlink" title="Node"></a>Node</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ARROW_ACERO_EXPORT</span> ExecNode &#123;</span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="keyword">using</span> NodeVector = std::vector&lt;ExecNode*&gt;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">virtual</span> ~<span class="built_in">ExecNode</span>() = <span class="keyword">default</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="type">const</span> <span class="type">char</span>* <span class="title">kind_name</span><span class="params">()</span> <span class="type">const</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// The number of inputs expected by this node</span></span><br><span class="line">  <span class="function"><span class="type">int</span> <span class="title">num_inputs</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> <span class="built_in">static_cast</span>&lt;<span class="type">int</span>&gt;(inputs_.<span class="built_in">size</span>()); &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// This node&#x27;s predecessors in the exec plan</span></span><br><span class="line">  <span class="function"><span class="type">const</span> NodeVector&amp; <span class="title">inputs</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> inputs_; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// True if the plan has no output schema (is a sink)</span></span><br><span class="line">  <span class="function"><span class="type">bool</span> <span class="title">is_sink</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> !output_schema_; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// \brief Labels identifying the function of each input.</span></span><br><span class="line">  <span class="function"><span class="type">const</span> std::vector&lt;std::string&gt;&amp; <span class="title">input_labels</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> input_labels_; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// This node&#x27;s successor in the exec plan</span></span><br><span class="line">  <span class="function"><span class="type">const</span> ExecNode* <span class="title">output</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> output_; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// The datatypes for batches produced by this node</span></span><br><span class="line">  <span class="function"><span class="type">const</span> std::shared_ptr&lt;Schema&gt;&amp; <span class="title">output_schema</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> output_schema_; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// This node&#x27;s exec plan</span></span><br><span class="line">  <span class="function">ExecPlan* <span class="title">plan</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> plan_; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// \brief An optional label, for display and debugging</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// There is no guarantee that this value is non-empty or unique.</span></span><br><span class="line">  <span class="function"><span class="type">const</span> std::string&amp; <span class="title">label</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> label_; &#125;</span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">SetLabel</span><span class="params">(std::string label)</span> </span>&#123; label_ = std::<span class="built_in">move</span>(label); &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> Status <span class="title">Validate</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// \brief the ordering of the output batches</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="type">const</span> Ordering&amp; <span class="title">ordering</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// Transfer input batch to ExecNode</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// A node will typically perform some kind of operation on the batch</span></span><br><span class="line">  <span class="comment">/// and then call InputReceived on its outputs with the result.</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// Other nodes may need to accumulate some number of inputs before any</span></span><br><span class="line">  <span class="comment">/// output can be produced.  These nodes will add the batch to some kind</span></span><br><span class="line">  <span class="comment">/// of in-memory accumulation queue and return.</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> Status <span class="title">InputReceived</span><span class="params">(ExecNode* input, ExecBatch batch)</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// Mark the inputs finished after the given number of batches.</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// This may be called before all inputs are received.  This simply fixes</span></span><br><span class="line">  <span class="comment">/// the total number of incoming batches for an input, so that the ExecNode</span></span><br><span class="line">  <span class="comment">/// knows when it has received all input, regardless of order.</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> Status <span class="title">InputFinished</span><span class="params">(ExecNode* input, <span class="type">int</span> total_batches)</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// \brief Perform any needed initialization</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// This hook performs any actions in between creation of ExecPlan and the call to</span></span><br><span class="line">  <span class="comment">/// StartProducing. An example could be Bloom filter pushdown. The order of ExecNodes</span></span><br><span class="line">  <span class="comment">/// that executes this method is undefined, but the calls are made synchronously.</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// At this point a node can rely on all inputs &amp; outputs (and the input schemas)</span></span><br><span class="line">  <span class="comment">/// being well defined.</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> Status <span class="title">Init</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// \brief Start producing</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// This must only be called once.</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// This is typically called automatically by ExecPlan::StartProducing().</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> Status <span class="title">StartProducing</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// \brief Pause producing temporarily</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// \param output Pointer to the output that is full</span></span><br><span class="line">  <span class="comment">/// \param counter Counter used to sequence calls to pause/resume</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// This call is a hint that an output node is currently not willing</span></span><br><span class="line">  <span class="comment">/// to receive data.</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// This may be called any number of times.</span></span><br><span class="line">  <span class="comment">/// However, the node is still free to produce data (which may be difficult</span></span><br><span class="line">  <span class="comment">/// to prevent anyway if data is produced using multiple threads).</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">PauseProducing</span><span class="params">(ExecNode* output, <span class="type">int32_t</span> counter)</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// \brief Resume producing after a temporary pause</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// \param output Pointer to the output that is now free</span></span><br><span class="line">  <span class="comment">/// \param counter Counter used to sequence calls to pause/resume</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// This call is a hint that an output node is willing to receive data again.</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// This may be called any number of times.</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">ResumeProducing</span><span class="params">(ExecNode* output, <span class="type">int32_t</span> counter)</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// \brief Stop producing new data</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// If this node is a source then the source should stop generating data</span></span><br><span class="line">  <span class="comment">/// as quickly as possible.  If this node is not a source then there is typically</span></span><br><span class="line">  <span class="comment">/// nothing that needs to be done although a node may choose to start ignoring incoming</span></span><br><span class="line">  <span class="comment">/// data.</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// This method will be called when an error occurs in the plan</span></span><br><span class="line">  <span class="comment">/// This method may also be called by the user if they wish to end a plan early</span></span><br><span class="line">  <span class="comment">/// Finally, this method may be called if a node determines it no longer needs any more</span></span><br><span class="line">  <span class="comment">/// input (for example, a limit node).</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// This method may be called multiple times.</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// This is not a pause.  There will be no way to start the source again after this has</span></span><br><span class="line">  <span class="comment">/// been called.</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> Status <span class="title">StopProducing</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="function">std::string <span class="title">ToString</span><span class="params">(<span class="type">int</span> indent = <span class="number">0</span>)</span> <span class="type">const</span></span>;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">protected</span>:</span><br><span class="line">  <span class="built_in">ExecNode</span>(ExecPlan* plan, NodeVector inputs, std::vector&lt;std::string&gt; input_labels,</span><br><span class="line">           std::shared_ptr&lt;Schema&gt; output_schema);</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> Status <span class="title">StopProducingImpl</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// Provide extra info to include in the string representation.</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> std::string <span class="title">ToStringExtra</span><span class="params">(<span class="type">int</span> indent = <span class="number">0</span>)</span> <span class="type">const</span></span>;</span><br><span class="line"></span><br><span class="line">  std::atomic&lt;<span class="type">bool</span>&gt; stopped_;</span><br><span class="line">  ExecPlan* plan_;</span><br><span class="line">  std::string label_;</span><br><span class="line"></span><br><span class="line">  NodeVector inputs_;</span><br><span class="line">  std::vector&lt;std::string&gt; input_labels_;</span><br><span class="line"></span><br><span class="line">  std::shared_ptr&lt;Schema&gt; output_schema_;</span><br><span class="line">  ExecNode* output_ = NULLPTR;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>è¿™å—ä»£ç è¿˜æ˜¯æ¯”è¾ƒæ¸…æ™°çš„ï¼Œè€Œä¸”è€ƒè™‘äº† <code>Pause</code> <code>Resume</code> ç­‰æ“ä½œçš„å¹¶è¡Œæ€§ï¼ˆè¿™é‡Œç»™æ“ä½œå¸¦ä¸Šäº†ä¸€ä¸ªå¤–éƒ¨çš„ Counterï¼Œç”±å¤–éƒ¨ç»´æŠ¤æ“ä½œçš„åºå·ï¼Œæ¥åšå®šåºï¼Œæ²¡æœ‰å¹‚ç­‰çš„éœ€æ±‚ï¼‰ã€‚å“æˆ‘çœŸè§‰å¾—è¿™ä¸ªä»£ç éå¸¸æ¸…æ™°äº†ã€‚</p><p>æš‚æ—¶æ— æ³•åœ¨é£ä¹¦æ–‡æ¡£å¤–å±•ç¤ºæ­¤å†…å®¹</p><h3 id="Scheduler"><a href="#Scheduler" class="headerlink" title="Scheduler"></a>Scheduler</h3><p><code>TaskScheduler</code> çš„ä»£ç æˆ‘æ²¡çœ‹æ‡‚ï¼Œå› æ­¤åªçœ‹ AsyncScheduler å°±è¡Œã€‚</p><p>è¿™å—çš„ä»£ç è¿˜æ˜¯æ¯”è¾ƒå¥‡è‘©çš„ï¼Œ<code>AsyncTaskScheduler</code> ä¼šæœ‰å‡ ä¸ªç›¸å…³çš„ç±»å‹ï¼š</p><ol><li><code>AsyncTaskScheduler</code></li><li><code>AsyncTaskSchedulerImpl</code>: å…·ä½“å®ç°</li><li><code>ThrottledAsyncTaskScheduler</code>: é™æµçš„ Task Scheduler</li><li><code>AsyncTaskGroup</code>: è¿™ä¸ªæ˜¯ä¸ªæ¯”è¾ƒå¥‡æ€ªçš„ä¸œè¥¿ï¼Œæ¯”æ–¹è¯´ Scan çš„æ—¶å€™ï¼Œè¿™é‡Œä¼šè¦åŸæœ¬çš„æ–‡ä»¶æ´»ç€ï¼Œæ‰€ä»¥æˆä¸ºä¸€ä¸ªå°çš„è°ƒåº¦ç»„ã€‚<code>AsyncTaskGroupImpl</code> æ˜¯å®ƒçš„ä¸€ä¸ªå®ç°ã€‚</li></ol><p>è¿™é‡Œç®€å•çœ‹ä¸€ä¸‹è¿™é‡Œçš„åˆ›å»ºæ–¹å¼å°±è¡Œï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// Construct a scheduler</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// \param initial_task The initial task which is responsible for adding</span></span><br><span class="line"><span class="comment">///        the first subtasks to the scheduler.</span></span><br><span class="line"><span class="comment">/// \param abort_callback A callback that will be triggered immediately after a task</span></span><br><span class="line"><span class="comment">///        fails while other tasks may still be running.  Nothing needs to be done here,</span></span><br><span class="line"><span class="comment">///        when a task fails the scheduler will stop accepting new tasks and eventually</span></span><br><span class="line"><span class="comment">///        return the error.  However, this callback can be used to more quickly end</span></span><br><span class="line"><span class="comment">///        long running tasks that have already been submitted.  Defaults to doing</span></span><br><span class="line"><span class="comment">///        nothing.</span></span><br><span class="line"><span class="comment">/// \param stop_token An optional stop token that will allow cancellation of the</span></span><br><span class="line"><span class="comment">///        scheduler.  This will be checked before each task is submitted and, in the</span></span><br><span class="line"><span class="comment">///        event of a cancellation, the scheduler will enter an aborted state. This is</span></span><br><span class="line"><span class="comment">///        a graceful cancellation and submitted tasks will still complete.</span></span><br><span class="line"><span class="comment">/// \return A future that will be completed when the initial task and all subtasks have</span></span><br><span class="line"><span class="comment">///         finished.</span></span><br><span class="line"><span class="type">static</span> Future&lt;&gt; <span class="built_in">Make</span>(</span><br><span class="line">    FnOnce&lt;<span class="built_in">Status</span>(AsyncTaskScheduler*)&gt; initial_task,</span><br><span class="line">    FnOnce&lt;<span class="built_in">void</span>(<span class="type">const</span> Status&amp;)&gt; abort_callback = [](<span class="type">const</span> Status&amp;) &#123;&#125;,</span><br><span class="line">    StopToken stop_token = StopToken::<span class="built_in">Unstoppable</span>());</span><br></pre></td></tr></table></figure><p>æ³¨æ„ Scan çš„æ—¶å€™æ€ä¹ˆä½¿ç”¨çš„ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">Future&lt;&gt; <span class="built_in">AddScanTasks</span>(<span class="type">const</span> std::shared_ptr&lt;FragmentScanner&gt;&amp; fragment_scanner) &#123;</span><br><span class="line">  scan_state-&gt;fragment_scanner = fragment_scanner;</span><br><span class="line">  ScanState* state_view = scan_state.<span class="built_in">get</span>();</span><br><span class="line">  Future&lt;&gt; list_and_scan_done = Future&lt;&gt;::<span class="built_in">Make</span>();</span><br><span class="line">  <span class="comment">// Finish callback keeps the scan state alive until all scan tasks done</span></span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">StateHolder</span> &#123;</span><br><span class="line">    <span class="function">Status <span class="title">operator</span><span class="params">()</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      list_and_scan_done.<span class="built_in">MarkFinished</span>();</span><br><span class="line">      <span class="keyword">return</span> Status::<span class="built_in">OK</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    Future&lt;&gt; list_and_scan_done;</span><br><span class="line">    std::unique_ptr&lt;ScanState&gt; scan_state;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  std::unique_ptr&lt;util::AsyncTaskGroup&gt; scan_tasks = util::AsyncTaskGroup::<span class="built_in">Make</span>(</span><br><span class="line">      node-&gt;batches_throttle_.<span class="built_in">get</span>(),</span><br><span class="line">      StateHolder&#123;list_and_scan_done, std::<span class="built_in">move</span>(scan_state)&#125;);</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; fragment_scanner-&gt;<span class="built_in">NumBatches</span>(); i++) &#123;</span><br><span class="line">    node-&gt;num_batches_.<span class="built_in">fetch_add</span>(<span class="number">1</span>);</span><br><span class="line">    scan_tasks-&gt;<span class="built_in">AddTask</span>(std::<span class="built_in">make_unique</span>&lt;ScanBatchTask&gt;(node, state_view, i));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// The &quot;list fragments&quot; task doesn&#x27;t actually end until the fragments are</span></span><br><span class="line">  <span class="comment">// all scanned.  This allows us to enforce fragment readahead.</span></span><br><span class="line">  <span class="keyword">return</span> list_and_scan_done;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œ <code>scan_state</code> åœ¨ <code>StateHolder</code> ä¸­ç»´æŠ¤ã€‚å¹¶ä¸”åšäº† dtor callbackã€‚</p><h2 id="Node-Implementions"><a href="#Node-Implementions" class="headerlink" title="Node Implementions"></a>Node Implementions</h2><h3 id="Scan"><a href="#Scan" class="headerlink" title="Scan"></a>Scan</h3><p>ScanNode é‡‡å– Push çš„ç­–ç•¥ã€‚å¹¶ä¸”å¯èƒ½æœ‰ä¸€äº› Backpressure. è¿™éƒ¨åˆ†ä»£ç å¯ä»¥è§äº <code>arrow/dataset/scanner.cc</code></p><p>è¿™é‡Œå¤§æ¦‚é€»è¾‘æ˜¯æŠŠ Parquet FileFragment å¼„æˆ Scannerï¼Œç„¶åå¼„æˆ AsyncRecordBatchGeneratorï¼Œåå‡º RecordBatch</p><h4 id="Unordered-Generator"><a href="#Unordered-Generator" class="headerlink" title="Unordered Generator"></a>Unordered Generator</h4><p>è¿™é‡Œä¼šåœ¨æ–‡ä»¶äº§ç”Ÿçš„ RecordBatch ä¸Šæ ‡æ³¨ä¸€ä¸ªåºï¼Œä½†æ˜¯ä¸æ‰‹åŠ¨å®šåºã€‚</p><h4 id="Ordered-Generator"><a href="#Ordered-Generator" class="headerlink" title="Ordered Generator"></a>Ordered Generator</h4><p>æ„å»ºåœ¨ Unordered Generator ä¸Šï¼Œæ’åºçš„ BatchGen</p><h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><ol><li><a href="https://substrait.io/">https://substrait.io/</a></li><li><a href="https://dplyr.tidyverse.org/">https://dplyr.tidyverse.org/</a></li><li><a href="https://arrow.apache.org/docs/cpp/streaming_execution.html">https://arrow.apache.org/docs/cpp/streaming_execution.html</a></li><li><a href="https://arrow.apache.org/docs/dev/cpp/streaming_execution.html">https://arrow.apache.org/docs/dev/cpp/streaming_execution.html</a></li></ol>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>arrow dataset</title>
      <link href="/2023/07/23/Arrow-Dataset/"/>
      <url>/2023/07/23/Arrow-Dataset/</url>
      
        <content type="html"><![CDATA[<p>Dataset æ˜¯ Arrow ä¸­æ³›åŒ–å¤„ç† <code>&#123;æŸç§ fs ä¸Š, æŸç§ format&#125;</code> çš„å¤šä¸ªæ–‡ä»¶çš„æŠ½è±¡ã€‚åœ¨è¯»å–æ–‡ä»¶çš„æ—¶å€™ï¼Œé€šå¸¸ä¼šæœ‰å¤šä¸ªæ•°æ®é›†åˆï¼Œåå‡ºåŒä¸€ç§ Schemaã€‚</p><p>æœ‰æ•°æ®é›†åˆï¼Œé‚£ä¹ˆè‡ªç„¶å°±æœ‰å•ä¸ªæ–‡ä»¶ï¼ŒDataset æŠ½è±¡å‡ºäº† Fragment çš„æ¦‚å¿µã€‚æ¯ä¸ª Fragment å¯¹åº”çš„èŒƒå›´å¯ä»¥æ˜¯æ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥æ˜¯ â€œæ–‡ä»¶çš„ä¸€éƒ¨åˆ†â€ ( e.g.: Csv æ–‡ä»¶çš„ä¸€å®šè¡Œæ•°ï¼ŒParquet æ–‡ä»¶ä¸­çš„1ä¸ª RowGroupï¼‰ã€‚å¯¹äº Fragment æ¥è¯´ï¼ŒFragment çš„ Schema å¯èƒ½å’Œæ•°æ®çš„ Schema ä¼šæœ‰ä¸€ç‚¹åŒºåˆ«ï¼ŒDataset ä¼šåœ¨è¿™ä¸€å±‚åš Schema Evolution (ä½†æ˜¯ Arrow ç›®å‰ï¼Œè‡³å°‘ 13.0 è¿˜ä¸æ”¯æŒ Parquet upcastï¼Œåªæ”¯æŒå°‘è¯»å‡ åˆ—æˆ–è€…å¤šè¯»å‡ åˆ—ä¸å­˜åœ¨çš„è¿™ç§<strong>ç±»ä¼¼ Project å’ŒåŒ…æ‹¬ Projection</strong> çš„ææ³•ï¼‰ï¼Œå°†å¤šéƒ¨åˆ† Fragment çš„ Schema è½¬åŒ–ä¸º Dataset çš„ Schema çš„é€»è¾‘ç”± <code>FragmentEvolutionStrategy</code> å¤„ç†ã€‚</p><p>Dataset æœ‰ Discovery çš„èƒ½åŠ›ï¼ˆ<code>DatasetFactory</code>ï¼‰ã€‚è¿™éƒ¨åˆ†æˆ‘è§‰å¾—æœ‰ç‚¹æ€ªï¼Œæ¯”å¦‚è¯´ï¼Œå®ƒèƒ½ç»™å®šä¸€ä¸ªç›®å½•ï¼Œç„¶åæŠŠè¿™ä¸ªç›®å½•å½“æˆ Hive åˆ†åŒºé‚£ç§æ–¹å¼å¤„ç†( <code>key=value</code>)ã€‚ä¸çŸ¥é“è¿™ä¸ªç®—ä¸ç®—ä¸€ä¸ªå®ç”¨åŠŸèƒ½ï¼Œå› ä¸ºåœ¨æˆ‘çœ‹æ¥ï¼Œè¿™å—æ€»è§‰å¾—æ˜¯åº”è¯¥ä¸¢ç»™ Meta ç³»ç»Ÿæ¥å¤„ç†çš„ã€‚</p><p>Dataset å¯ä»¥ç”¨æ¥çœ‹ Schema ç„¶å Scanï¼Œäº§ç”Ÿä¸€ä¸ªå¯¹åº”çš„ Scanner å¯¹è±¡ï¼ˆæœ‰ Scannerï¼Œé‡Œé¢æŒæœ‰ FragmentScannerï¼‰ã€‚äº§ç”Ÿå¯¹åº”çš„ RecordBatchã€‚ä¸è¿‡æˆ‘çœ‹å¥½åƒè¿˜æ²¡æœ‰é’ˆå¯¹ Iceberg ä¹‹ç±»çš„å¤„ç†çš„é€»è¾‘ã€‚åœ¨ Scan çš„æ—¶å€™ï¼Œè¿™é‡Œä¼šæœ‰ä¸€å®šçš„é¢„è¯»ç­–ç•¥ï¼Œä¸è¿‡è¿™å‡ å—çš„é€»è¾‘åŸºæœ¬æ˜¯ç»™ Acero å‡†å¤‡çš„ï¼Œæœ‰çš„åœ°æ–¹ç­–ç•¥çœ‹èµ·æ¥è¿˜æ˜¯æŒºå¥‡æ€ªçš„ï¼Œæ¯”å¦‚åŸºæœ¬æ˜¯ä¸€ä¸ª push-based çš„æ¨¡å‹ï¼Œä¸æ–­ push å…·ä½“çš„å†…å®¹ã€‚</p><p>æ­¤å¤–ï¼Œå¯¹äº Scan æ¥è¯´å¯ä»¥æŒ‡å®šå¯¹åº”ç­–ç•¥ï¼Œæ¯”å¦‚ Prefetch çš„å±æ€§ã€æ˜¯å¦è¦æ±‚ Scan å‡ºæ¥çš„æ•°æ®æ»¡è¶³ Orderingï¼Œe.g.:</p><p><img src="https://image.mwish.me/blog-image/whiteboard_exported_image.png" alt="whiteboard_exported_image"></p><p>ç›®å‰åœ¨ä¸€ç§ DataSet é‡Œé¢ï¼Œæœ‰çš„ Dataset åªèƒ½å¤„ç†ä¸€ç§ Format ï¼ˆParquetã€CSVâ€¦ï¼‰çš„æ•°æ®ï¼Œå®ƒä»¬å¯ä»¥é  <code>UnionDataset</code> è¿æ¥èµ·æ¥å¤„ç†ã€‚è€Œ FileSystem ä¸Šçš„å†…å®¹åˆ™é  <code>FileSystemDataset</code>ã€‚ä¹‹åæˆ‘ä»¬ä¼šäº†è§£è¿™äº›ä¸œè¥¿æ˜¯æ€ä¹ˆç»„åˆèµ·æ¥çš„ã€‚</p><p>ä¸Šé¢çš„ Dataset éƒ¨åˆ†å’Œ Acero æ˜¯äº¤èçš„ï¼ŒDataset å¯ä»¥åˆ©ç”¨ Acero çš„éƒ¨åˆ†æ¥ Scanï¼Œè€Œ Acero åˆå€ŸåŠ©äº† Fragments:</p><p><img src="https://image.mwish.me/blog-image/whiteboard_exported_image-2.png" alt="whiteboard_exported_image-2"></p><p>Arrow è¿˜å…è®¸å†™ Datasetï¼Œå®ƒæä¾›äº†ï¼š</p><ol><li>DatasetWriter</li><li>SinkNode</li></ol><p>è¿™é‡Œç»„ç»‡å’Œä¹‹å‰å·®ä¸å¤šï¼Œä¸è¿‡è€å®è¯´æˆ‘æ„Ÿè§‰ Arrow å¯¹å†™è¿™å—æ²¡é‚£ä¹ˆç†Ÿæ‚‰ï¼Œæ‰€ä»¥å†™é“¾è·¯ä¸Šæ„Ÿè§‰æ‰“ç£¨çš„ä¸æ˜¯å¾ˆå¤šã€‚</p><h2 id="Fragment"><a href="#Fragment" class="headerlink" title="Fragment"></a>Fragment</h2><p>Fragment æ˜¯ Dataset çš„ã€Œä¸€éƒ¨åˆ†ã€æŠ½è±¡ä¸ºä¸€ä¸ªå­å•å…ƒï¼Œå¯èƒ½ä¼šæœ‰ä¸€äº› Partition çº¦æŸ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ARROW_DS_EXPORT</span> <span class="title">Fragment</span> :</span> public <span class="built_in">std</span>::enable_shared_from_this&lt;Fragment&gt; &#123;</span><br><span class="line"> public:</span><br><span class="line">  <span class="comment">/// \brief An expression that represents no known partition information</span></span><br><span class="line">  <span class="type">static</span> <span class="type">const</span> compute::Expression kNoPartitionInformation;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// \brief Return the physical schema of the Fragment.</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// The physical schema is also called the writer schema.</span></span><br><span class="line">  <span class="comment">/// This method is blocking and may suffer from high latency filesystem.</span></span><br><span class="line">  <span class="comment">/// The schema is cached after being read once, or may be specified at construction.</span></span><br><span class="line">  Result&lt;<span class="built_in">std</span>::<span class="built_in">shared_ptr</span>&lt;Schema&gt;&gt; ReadPhysicalSchema();</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// An asynchronous version of Scan</span></span><br><span class="line">  virtual Result&lt;RecordBatchGenerator&gt; <span class="title function_">ScanBatchesAsync</span><span class="params">(</span></span><br><span class="line"><span class="params">      <span class="type">const</span> <span class="built_in">std</span>::<span class="built_in">shared_ptr</span>&lt;ScanOptions&gt;&amp; options)</span> = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// \brief Inspect a fragment to learn basic information</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// This will be called before a scan and a fragment should attach whatever</span></span><br><span class="line">  <span class="comment">/// information will be needed to figure out an evolution strategy.  This information</span></span><br><span class="line">  <span class="comment">/// will then be passed to the call to BeginScan</span></span><br><span class="line">  virtual Future&lt;<span class="built_in">std</span>::<span class="built_in">shared_ptr</span>&lt;InspectedFragment&gt;&gt; InspectFragment(</span><br><span class="line">      <span class="type">const</span> FragmentScanOptions* format_options, compute::ExecContext* exec_context);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// \brief Start a scan operation</span></span><br><span class="line">  virtual Future&lt;<span class="built_in">std</span>::<span class="built_in">shared_ptr</span>&lt;FragmentScanner&gt;&gt; BeginScan(</span><br><span class="line">      <span class="type">const</span> FragmentScanRequest&amp; request, <span class="type">const</span> InspectedFragment&amp; inspected_fragment,</span><br><span class="line">      <span class="type">const</span> FragmentScanOptions* format_options, compute::ExecContext* exec_context);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// \brief Count the number of rows in this fragment matching the filter using metadata</span></span><br><span class="line">  <span class="comment">/// only. That is, this method may perform I/O, but will not load data.</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// If this is not possible, resolve with an empty optional. The fragment can perform</span></span><br><span class="line">  <span class="comment">/// I/O (e.g. to read metadata) before it deciding whether it can satisfy the request.</span></span><br><span class="line">  virtual Future&lt;<span class="built_in">std</span>::optional&lt;<span class="type">int64_t</span>&gt;&gt; CountRows(</span><br><span class="line">      compute::Expression predicate, <span class="type">const</span> <span class="built_in">std</span>::<span class="built_in">shared_ptr</span>&lt;ScanOptions&gt;&amp; options);</span><br><span class="line"></span><br><span class="line">  virtual <span class="built_in">std</span>::<span class="built_in">string</span> <span class="title function_">type_name</span><span class="params">()</span> <span class="type">const</span> = <span class="number">0</span>;</span><br><span class="line">  virtual <span class="built_in">std</span>::<span class="built_in">string</span> <span class="title function_">ToString</span><span class="params">()</span> <span class="type">const</span> &#123; <span class="keyword">return</span> type_name(); &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// \brief An expression which evaluates to true for all data viewed by this</span></span><br><span class="line">  <span class="comment">/// Fragment.</span></span><br><span class="line">  <span class="type">const</span> compute::Expression&amp; <span class="title function_">partition_expression</span><span class="params">()</span> <span class="type">const</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>è¿™éƒ¨åˆ†é€»è¾‘æ¯”è¾ƒç®€å•ã€‚</p><ol><li><code>FragmentScanOptions</code> æ˜¯ä¸€å¥—å¤šæ€æ¥å£ï¼Œå…è®¸ä½ è‡ªå·±å®šä¹‰</li><li><code>InspectFragments</code> ä¼šå…è®¸ä½ å» Inspect å¯¹åº”çš„å†…å®¹</li><li><code>CountRow</code> ä¼šå°è¯•ï¼ˆæ³¨æ„ï¼Œè¿™ä¸ªä¸ä¸€å®šçœŸçš„è¿”å›ï¼‰å‘Šè¯‰ä½ æœ‰å¤šå°‘è¡Œï¼Œå®ƒä¼šåšæˆ Best Effort + å‡†ç¡®çš„ã€‚æ¯”å¦‚å®ƒè¯» Parquetï¼Œå¦‚æœå‘ç°è‡ªå·±æŸä¸ª Expression æ²¡æ³•åˆ¤æ–­æ˜¯å¦æ»¡è¶³ï¼Œå°±ä¼šå¿«é€Ÿç†”æ–­ï¼Œè¿”å› <code>std::nullopt</code>.</li></ol><h3 id="FileFragment"><a href="#FileFragment" class="headerlink" title="FileFragment"></a>FileFragment</h3><p>ä¸»è¦çš„ Fragment æ˜¯ FileFragmentï¼Œæ˜¯åœ¨æŸç§ fs ä¸Šï¼Œç»™å®šæŸä¸ª Schema è¯»å–ï¼Œæœ‰ç€ Format çš„å›ºå®šå•å…ƒã€‚FileFragment å¯¹åº”æŸç§æ–‡ä»¶æ ¼å¼ï¼Œä½†æ˜¯ä¸ä¸€å®šå¯¹åº”ä¸€ä¸ªæ–‡ä»¶ã€‚æ¯”å¦‚ Parquet çš„ FileFragment å°±å¯èƒ½å¯¹åº” File ä¸‹çš„ä¸€åˆ°æ•°ä¸ª RowGroupã€‚</p><p>è¿™é‡Œé¢åŒ…è£…äº†å¦‚ä¸‹çš„ç±»å‹ï¼š</p><ul><li>FileSource :  <code>((fileName, fs) or (input buffer), compression..)</code>, å…è®¸ç”¨æˆ·åœ¨ä¸Šé¢æ‰“å¼€ä¸€ä¸ª <code>RandomAccessFile</code> æˆ–è€… <code>InputStream</code> (è€å®è¯´æˆ‘è§‰å¾— InputStream æ¯”è¾ƒè‡ªç„¶â€¦ä¸è¿‡ OSS è¿™ç§åš RandomAccess çš„è¯è¦åŒ…ä¸€å † pread ä¹‹ç±»çš„è¯­ä¹‰ï¼Œä¹Ÿä¸æ˜¯ä¸è¡Œï¼‰</li><li>FileFormat : ç›¸å½“äº <code>FileFragment</code> çš„å·¥å‚ï¼ŒåŒ…è£…äº†ä¸€äº› Fragment çš„æ¥å£ï¼Œç„¶åæ ¹æ® <code>FileSource</code> ä¹‹ç±»çš„åˆ›å»º FileFragmentï¼Œå’Œ<strong>æ‰€æœ‰</strong> Fragment ä¸Šçš„æ¥å£. è¿™é‡Œæ„Ÿè§‰ä¸ä¼šåˆ›å»º RowGroup ä¸Šçš„ Fragmentã€‚FileFormat å¯¹æ¯ä¸ªæ–‡ä»¶ç±»å‹éœ€è¦å®ç°ä¸€éå­ç±»ã€‚æ­¤å¤–ï¼Œæ¯ä¸€ç§ Format å·¥å‚ä¸Šè¿˜æœ‰ä¸€ä¸ª <code>FragmentScanOptions</code>ï¼Œ<strong>ä½œä¸ºé»˜è®¤çš„ Scan é…ç½®</strong>ã€‚è¿™ç§ Format ä½œä¸ºå·¥å‚çš„é…ç½®ä»£ç æ²¡å•¥å¥‡ç‰¹çš„ï¼Œä¸è¿‡ä½œä¸ºæ¡†æ¶ä»£ç è¿˜æ˜¯å¯ä»¥æ‹¿æ¥æŠ„çš„</li></ul><ol><li><p>åœ¨ FileFormat ä¸‹æœ‰å¤šç§ Formatï¼Œæ¯”å¦‚ Csv, Ipc, Json, Parquetã€‚ä½œä¸º Dataset çš„æŠ½è±¡ã€‚</p></li><li><p><code>FileFragment</code> == <code>FileSource + FileFormat</code>. åŒ…è£…äº†ä¸€ä¸ª <code>FileFormat</code> å’Œ <code>FileSource</code>ï¼Œå®Œæˆå¯¹åº”çš„éœ€æ±‚ã€‚</p></li></ol><p>æˆ‘ä»¬ä»¥ ParquetFileFragment å’Œ ParquetFileFormat ä¸ºä¾‹</p><ol><li><code>ParquetFileFragment</code>: åŒ…æ‹¬ <code>SchemaManifest</code>ã€æ–‡ä»¶çš„ <code>metadata_</code>ï¼Œæ­¤å¤–è¿˜æœ‰ä¸€äº› Partition Guarantee Expressionã€RowGroup è£å‰ªè¡¨è¾¾å¼çš„å†…å®¹</li><li><code>ParquetFileFormat</code>: åŒ…è£…äº†ä¸Šå±‚çš„ä¸€ä¸ªå¥‡æ€ªçš„ ReaderOptionsï¼Œå’Œ default config</li></ol><p>åœ¨ Format å±‚å®ç°çš„ï¼š</p><ul><li>IsSupport: çœ‹ä¸€ä¸‹ Footerï¼ŒæŸ¥çœ‹ä¸€ä¸‹æ–‡ä»¶ä½¿ç”¨çš„ç‰ˆæœ¬å‘€ç¼–ç å‘€è‡ªå·±æ˜¯å¦æ”¯æŒ</li><li><code>GetReader</code> / <code>GetReaderAsync</code>: æ‰“å¼€ Reader</li><li>è¯»å– Schema</li><li>è¯»å–çš„æ—¶å€™åš Schema Projection (è¿™é‡ŒåŒ…å«æŠŠå¤–éƒ¨è¯»å–çš„ Schema æ˜ å°„åˆ°å†…éƒ¨ï¼Œå¯ä»¥çœ‹ <code>InferColumnProjection</code>, æˆ‘è§‰å¾—è¿™å—å†™çš„æ€ªæ€ªçš„ï¼Œç”šè‡³è¿˜æœ‰æ£€æŸ¥ duplicate fields name çš„ï¼‰</li></ul><p>åœ¨ <code>ParquetFileFragment</code> å±‚ï¼Œé»˜è®¤ä¼šã€Œæ‰“å¼€ Footerï¼Œç„¶ååŒ…å«æ‰€æœ‰çš„ RowGroupã€ï¼Œç„¶åå¤–å±‚ç”¨æˆ·å¯ä»¥ï¼š</p><ol><li>ä¸‹æ¨ Filterï¼Œè¿™é‡Œä¼šæŠŠæ¯ä¸ª RowGroup çš„ä¿¡æ¯æŠ½å‡ºæ¥ï¼ŒæŠ½æˆä¸€ä¸ª Expressionï¼Œç„¶åçœ‹è¿™ä¸ª Expression &amp;&amp; ç”¨æˆ·ä¼ å…¥çš„ Filter å¦‚æœä¸€å®šæ˜¯ False çš„è¯ï¼Œé‚£ä¹ˆå¯ä»¥å°è¯•è£å‰ªæ‰</li><li>å…è®¸ Subsetï¼Œå–è¿™é‡Œçš„ä¸€å°éƒ¨åˆ†</li><li>åœ¨æ‰“å¼€ Scanner çš„æ—¶å€™ (<code>ParquetFileFormat::GetReaderAsync</code>)ï¼Œæ‰ä¼šæ‰“å¼€ InputStream ( <code>FileSource::open</code>)</li></ol><p>æˆ‘ä»¬å¯ä»¥ç®€å•çœ‹ä¸€ä¸‹ Filter çš„ä»£ç ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">Result&lt;<span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="type">int</span>&gt;&gt; ParquetFileFragment::FilterRowGroups(</span><br><span class="line">    compute::Expression predicate) &#123;</span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="type">int</span>&gt; row_groups;</span><br><span class="line">  ARROW_ASSIGN_OR_RAISE(<span class="keyword">auto</span> expressions, TestRowGroups(<span class="built_in">std</span>::move(predicate)));</span><br><span class="line"></span><br><span class="line">  <span class="keyword">auto</span> lock = physical_schema_mutex_.Lock();</span><br><span class="line">  DCHECK(expressions.empty() || (expressions.size() == row_groups_-&gt;size()));</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; expressions.size(); i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (expressions[i].IsSatisfiable()) &#123;</span><br><span class="line">      row_groups.push_back(row_groups_-&gt;at(i));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> row_groups;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Result&lt;<span class="built_in">std</span>::<span class="built_in">vector</span>&lt;compute::Expression&gt;&gt; ParquetFileFragment::TestRowGroups(</span><br><span class="line">    compute::Expression predicate) &#123;</span><br><span class="line">  <span class="keyword">auto</span> lock = physical_schema_mutex_.Lock();</span><br><span class="line"></span><br><span class="line">  DCHECK_NE(metadata_, nullptr);</span><br><span class="line">  ARROW_ASSIGN_OR_RAISE(</span><br><span class="line">      predicate, SimplifyWithGuarantee(<span class="built_in">std</span>::move(predicate), partition_expression_));</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!predicate.IsSatisfiable()) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;compute::Expression&gt;&#123;&#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">const</span> FieldRef&amp; ref : FieldsInExpression(predicate)) &#123;</span><br><span class="line">    ARROW_ASSIGN_OR_RAISE(<span class="keyword">auto</span> match, ref.FindOneOrNone(*physical_schema_));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (match.empty()) <span class="keyword">continue</span>;</span><br><span class="line">    <span class="keyword">if</span> (statistics_expressions_complete_[match[<span class="number">0</span>]]) <span class="keyword">continue</span>;</span><br><span class="line">    statistics_expressions_complete_[match[<span class="number">0</span>]] = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">const</span> SchemaField&amp; schema_field = manifest_-&gt;schema_fields[match[<span class="number">0</span>]];</span><br><span class="line">    <span class="type">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> row_group : *row_groups_) &#123;</span><br><span class="line">      <span class="keyword">auto</span> row_group_metadata = metadata_-&gt;RowGroup(row_group);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">auto</span> minmax =</span><br><span class="line">              ColumnChunkStatisticsAsExpression(schema_field, *row_group_metadata)) &#123;</span><br><span class="line">        FoldingAnd(&amp;statistics_expressions_[i], <span class="built_in">std</span>::move(*minmax));</span><br><span class="line">        ARROW_ASSIGN_OR_RAISE(statistics_expressions_[i],</span><br><span class="line">                              statistics_expressions_[i].Bind(*physical_schema_));</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      ++i;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;compute::Expression&gt; <span class="title function_">row_groups</span><span class="params">(row_groups_-&gt;size())</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; row_groups_-&gt;size(); ++i) &#123;</span><br><span class="line">    ARROW_ASSIGN_OR_RAISE(<span class="keyword">auto</span> row_group_predicate,</span><br><span class="line">                          SimplifyWithGuarantee(predicate, statistics_expressions_[i]));</span><br><span class="line">    row_groups[i] = <span class="built_in">std</span>::move(row_group_predicate);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> row_groups;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>(æˆ‘æ„Ÿè§‰è¿™å—è™½ç„¶æ²¡é—®é¢˜ï¼Œä½†æ˜¯ Column As Expr çœ‹ç€æœ‰ç‚¹åˆ«æ‰­ï¼Œè€Œä¸”è¿™ç§æ¨¡å¼åœ¨æ BloomFilter çš„æ—¶å€™ï¼Œå°±ä¸æ˜¯å¾ˆæ–¹ä¾¿äº†ã€‚ä¹‹åçœ‹çœ‹ Velox å’Œ Impala ä¹‹ç±»çš„æ˜¯æ€ä¹ˆæ Column Filter çš„ï¼Œæ¯”æ–¹è¯´ä½ å…¶å®æœ‰ç‚¹ä¸é‚£ä¹ˆå¥½æŠŠ BF æŠ½å‡ºæ¥ä½œä¸ºä¸€ä¸ªè¡¨è¾¾å¼ç„¶åæ”¾è¿™é‡Œï¼ˆå…¶å®ä¹Ÿä¸æ˜¯ä¸è¡Œï¼‰ï¼‰</p><p>è¿™é‡Œå– Subset çš„æ—¶å€™ï¼Œç›¸å½“äº <code>FileMetadata</code> å’Œ <code>SchemaManifest</code> è¿™å‡ ä¸ªä¸œè¥¿ä¼šä¼ è¿‡å»ï¼Œä¸ä¼šé‡å¤ Reopen footer.</p><h3 id="FileWriter"><a href="#FileWriter" class="headerlink" title="FileWriter"></a>FileWriter</h3><p><code>FileWriter</code> åŒ…è£…äº†ä¸åŒ Format æ–‡ä»¶çš„å†™æ¥å£ï¼Œå¯ä»¥ç»™ SinkNode æ¥å†™å…¥æ•°æ®ï¼Œä¸è¿‡æˆ‘è§‰å¾—å†™çš„å¾ˆç®€å•ä¹Ÿå¾ˆæŒ«ï¼Œéšä¾¿çœ‹çœ‹å°±è¡Œäº†ã€‚</p><h3 id="ä¸Šå±‚æ“ä½œ"><a href="#ä¸Šå±‚æ“ä½œ" class="headerlink" title="ä¸Šå±‚æ“ä½œ"></a>ä¸Šå±‚æ“ä½œ</h3><p><code>FragmentEvolutionStrategy</code> åœ¨ä¸Šå±‚å¤„ç†äº†ä¸€äº› Evolution</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// \brief Rules for converting the dataset schema to and from fragment schemas</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ARROW_DS_EXPORT</span> <span class="title">FragmentEvolutionStrategy</span> &#123;</span></span><br><span class="line"> public:</span><br><span class="line">  <span class="comment">/// This instance will only be destroyed when all scan operations for the</span></span><br><span class="line">  <span class="comment">/// fragment have completed.</span></span><br><span class="line">  virtual ~FragmentEvolutionStrategy() = <span class="keyword">default</span>;</span><br><span class="line">  <span class="comment">/// \brief A guarantee that applies to all batches of this fragment</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// For example, if a fragment is missing one of the fields in the dataset</span></span><br><span class="line">  <span class="comment">/// schema then a typical evolution strategy is to set that field to null.</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// So if the column at index 3 is missing then the guarantee is</span></span><br><span class="line">  <span class="comment">/// FieldRef(3) == null</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// Individual field guarantees should be AND&#x27;d together and returned</span></span><br><span class="line">  <span class="comment">/// as a single expression.</span></span><br><span class="line">  virtual Result&lt;compute::Expression&gt; <span class="title function_">GetGuarantee</span><span class="params">(</span></span><br><span class="line"><span class="params">      <span class="type">const</span> <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;FieldPath&gt;&amp; dataset_schema_selection)</span> <span class="type">const</span> = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// \brief Return a fragment schema selection given a dataset schema selection</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// For example, if the user wants fields 2 &amp; 4 of the dataset schema and</span></span><br><span class="line">  <span class="comment">/// in this fragment the field 2 is missing and the field 4 is at index 1 then</span></span><br><span class="line">  <span class="comment">/// this should return &#123;1&#125;</span></span><br><span class="line">  virtual Result&lt;<span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;FragmentSelection&gt;&gt; DevolveSelection(</span><br><span class="line">      <span class="type">const</span> <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;FieldPath&gt;&amp; dataset_schema_selection) <span class="type">const</span> = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// \brief Return a filter expression bound to the fragment schema given</span></span><br><span class="line">  <span class="comment">///        a filter expression bound to the dataset schema</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// The dataset scan filter will first be simplified by the guarantee returned</span></span><br><span class="line">  <span class="comment">/// by GetGuarantee.  This means an evolution that only handles dropping or casting</span></span><br><span class="line">  <span class="comment">/// fields doesn&#x27;t need to do anything here except return the given filter.</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// On the other hand, an evolution that is doing some kind of aliasing will likely</span></span><br><span class="line">  <span class="comment">/// need to convert field references in the filter to the aliased field references</span></span><br><span class="line">  <span class="comment">/// where appropriate.</span></span><br><span class="line">  virtual Result&lt;compute::Expression&gt; <span class="title function_">DevolveFilter</span><span class="params">(</span></span><br><span class="line"><span class="params">      <span class="type">const</span> compute::Expression&amp; filter)</span> <span class="type">const</span> = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// \brief Convert a batch from the fragment schema to the dataset schema</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// Typically this involves casting columns from the data type stored on disk</span></span><br><span class="line">  <span class="comment">/// to the data type of the dataset schema.  For example, this fragment might</span></span><br><span class="line">  <span class="comment">/// have columns stored as int32 and the dataset schema might have int64 for</span></span><br><span class="line">  <span class="comment">/// the column.  In this case we should cast the column from int32 to int64.</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// Note: A fragment may perform this cast as the data is read from disk.  In</span></span><br><span class="line">  <span class="comment">/// that case a cast might not be needed.</span></span><br><span class="line">  virtual Result&lt;compute::ExecBatch&gt; <span class="title function_">EvolveBatch</span><span class="params">(</span></span><br><span class="line"><span class="params">      <span class="type">const</span> <span class="built_in">std</span>::<span class="built_in">shared_ptr</span>&lt;RecordBatch&gt;&amp; batch,</span></span><br><span class="line"><span class="params">      <span class="type">const</span> <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;FieldPath&gt;&amp; dataset_selection,</span></span><br><span class="line"><span class="params">      <span class="type">const</span> FragmentSelection&amp; selection)</span> <span class="type">const</span> = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// \brief Return a string description of this strategy</span></span><br><span class="line">  virtual <span class="built_in">std</span>::<span class="built_in">string</span> <span class="title function_">ToString</span><span class="params">()</span> <span class="type">const</span> = <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>æ¯ä¸ª Fragment åœ¨æ–‡ä»¶çº§åˆ«ä¼šæœ‰ä¸€äº› Guaranteeï¼Œè¡¨è¾¾ï¼š</p><p>æ¯”å¦‚è¿™ä¸ª Fragment å¦‚æœ Field å°‘äº†ä¸€ä¸ªï¼Œé‚£ä¹ˆæ•´ä½“è¿˜æ˜¯å¯è¯»çš„ï¼Œä½†æ˜¯è¿™ä¸ª Batch å¯èƒ½ä¼šæœ‰ä¸€äº› Guranteeã€‚æ¯”å¦‚è¯»å– <code>&lt;a: int, b:int, c:int&gt;</code> ä¸‰åˆ—ï¼Œæ–‡ä»¶åªæœ‰ <code>&lt;a: int, b:int&gt;</code>ï¼Œé‚£ä¹ˆ c å¯ä»¥è¡¥é½ï¼Œè¿™ä¸ªæ—¶å€™ä¼šæœ‰ä¸€äº› <code>EvolveBatch</code>(æŠŠ Batch è¡¥é½)ï¼Œæˆ–è€… <code>Gurantee</code>(ä¿è¯ <code>c == null</code> ) çš„æ“ä½œï¼Œç»™ä¸Šé¢æä¾›ä¸€äº›å¤„ç†çš„å¸®åŠ©ã€‚è¿™ä¸ª <code>DevolveFilter</code> èƒ½å¤ŸæŠŠå¯¹åº”çš„ Filter è¡¥æˆå¯¹åº”çš„ï¼Œæˆ–è€…è¡¥å……ä¸€äº›åˆ«çš„é‡æ–°æ˜ å°„ä¹‹ç±»çš„æ“ä½œï¼ˆæ¯”å¦‚  <code>&lt;a: int, c:int, b:int&gt;</code> ). è¿™éƒ¨åˆ†æ–¹ä¾¿åš Resolve.</p><h2 id="Dataset"><a href="#Dataset" class="headerlink" title="Dataset"></a>Dataset</h2><p>Dataset æ˜¯ Fragment çš„é›†åˆï¼Œè¡¨ç°ä¸ºä¸€ç»„å¯ä»¥è¢« arrow æå‡ºæ¥å¤„ç†çš„æ•´ä½“ï¼Œè¿™äº› Fragment å¯èƒ½æŒ‰ç…§ä¸€äº›åˆ†åŒºè§„åˆ™ä¹‹ç±»çš„æ–¹å¼è¢«æ’åºã€‚Dataset å¯ä»¥å¤„ç†çš„é€»è¾‘æœ‰ï¼š</p><ol><li>ProjectSchema: å…è®¸ Dataset ä¸Šå¥—ä¸€å±‚ Projectï¼ŒProject ç”šè‡³å¯ä»¥æ˜¯ä¸€äº›è¡¨è¾¾å¼</li><li>äº§ç”Ÿ Scan å¯¹è±¡</li></ol><p>è¿™ä¹ˆè¯´æ¥è¿™å¥—ä¸œè¥¿è¿˜æ˜¯æŒºç®€å•çš„æ˜¯ä¸â€¦å¹¶ä¸æ˜¯ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹çœ‹è¿™å¥—ç±»å‹æ˜¯æ€ä¹ˆç»„åˆçš„:</p><p><img src="https://image.mwish.me/blog-image/whiteboard_exported_image-3.png" alt="whiteboard_exported_image-3"></p><p><code>DatasetFactory</code> å¯ä»¥å¸®åŠ©æ„é€ ä¸åŒç±»å‹çš„ <code>Dataset</code>ï¼Œå®é™…ä¸Šè¿™é‡Œä¸»è¦ç›®çš„æ˜¯ List å‡ºå¯¹åº”çš„ç›®å½•ç„¶åæ„å»ºåˆ°ä¸€èµ·ã€‚</p><p>å®é™…ä¸Šï¼Œè¿™é‡Œé¢å¤§æ¦‚é€»è¾‘æ˜¯ï¼š</p><ol><li>ç”¨æˆ·å¯ä»¥ç”¨ <code>FileSystemDatasetFactory</code> ä¹‹ç±»çš„ï¼ŒæŒ‡å®šå¯¹åº”çš„ S3 æˆ–è€… Local ç­‰ç›®å½•ï¼ŒList Plan åˆ°å¯¹åº”çš„æ–‡ä»¶</li><li>æ„å»ºå‡ºä¸€ç»„ FileSystemDatasetï¼Œç„¶åç”¨ Union è¿æ¥åˆ°ä¸€èµ·</li><li>æ‹¿åˆ°å¯¹åº”çš„ Fragmentï¼Œç„¶åå…è®¸å¯¹ Fragment æ‰“å¼€ + é¢„è¯»ã€‚å¯ä»¥åˆ›å»º <code>FragmentDataset</code> ç„¶åä¸¢ç»™ Acero</li><li>ç”¨ Acero ä¹‹ç±»çš„ Scanner å»åšå¯¹åº”çš„ Scan</li></ol>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Distributed Transaction in DynamoDB</title>
      <link href="/2023/07/15/Distributed-Transaction-in-DynamoDB/"/>
      <url>/2023/07/15/Distributed-Transaction-in-DynamoDB/</url>
      
        <content type="html"><![CDATA[<p>DynamoDB æ˜¯ä¸€ä¸ª Dynamo ä¹‹åäºšé©¬é€Šä¸»è¦æ¨è¿›çš„ä¸€ä¸ª K-V å‹äº§å“ï¼Œå®šä½ä¸Šæ˜¯ä¸€ä¸ªå¼ºä¸€è‡´ã€å¤šç§Ÿæˆ·çš„ key-value å­˜å‚¨ã€‚DynamoDB äº§å“åšçš„æ¯”è¾ƒæ—©ï¼Œä½†æ˜¯è®ºæ–‡å‘å¸ƒåœ¨ ATCâ€™22 ä¸Š [1] ã€‚</p><p>ATCâ€™23 çš„è®ºæ–‡ Distributed Transactions at Scale in Amazon DynamoDB ä»‹ç»äº† DynamoDB æ˜¯æ€ä¹ˆæ”¯æŒé«˜æ€§èƒ½çš„åˆ†å¸ƒå¼äº‹åŠ¡çš„ï¼Œæœ¬æ¥æˆ‘æ˜¯æ¯”è¾ƒæœŸå¾…ä»–ä»¬æ•´ä»€ä¹ˆç‰¹åˆ«å¥½çš„æ´»ï¼Œä½†å®é™…ä¸Šçœ‹å‰ä¸‰èŠ‚çš„æ—¶å€™æœ‰ä¸€ç§ã€Œæ„Ÿè§‰ä¸å¦‚ ByteGraphâ€¦äº‹åŠ¡â€¦ã€çš„æ„Ÿè§‰ã€‚æœ¬æ–‡å‰å‡ èŠ‚è®²è¿°äº† DynamoDB äº‹åŠ¡çš„è´Ÿè½½å’Œå®ç°ï¼Œå®ƒçš„è´Ÿè½½ä¸»è¦æ˜¯ä¸€ä¸ª Point Get æˆ–è€…å¤šè¡Œäº‹åŠ¡è¯»ï¼Œå•row/å¤šrow Update ä¹‹ç±»ç±»ä¼¼ RocksDB ä½†æ²¡æœ‰ Iterator çš„åœºæ™¯ï¼ˆè¿˜æœ‰ä¸€ä¸ªæ“ä½œæ˜¯ <code>condition ? op1 : op2</code> è¿™ç§ç±»ä¼¼ RocksDB Merge çš„åœºæ™¯ï¼‰ï¼Œå’Œåœ¨è¿™ç§åœºæ™¯ä¸‹ï¼Œå¦‚ä½•ä¸ä¾èµ– MVCC å’Œé”æœåŠ¡ã€ä¾é æœ¬åœ°æ—¶é—´æˆ³å®ç° OCC äº‹åŠ¡ã€‚æœ¬æ–‡çš„é‡ç‚¹åœ¨ç¬¬å››èŠ‚ï¼Œæè¿°äº†åœ¨è¿™ç§ç‰¹å®šè´Ÿè½½ä¸‹ï¼Œå¦‚ä½•é€šè¿‡ Thomas Rule ä¹‹ç±»çš„æ–¹å¼æ¥åš OCC Reorderã€‚</p><p>ç¬”è€…çœ‹å®Œè§‰å¾—äº®ç‚¹åœ¨ç¬¬å››èŠ‚ï¼Œè™½ç„¶çœ‹ç€æœ‰ä¸€ç‚¹å¤±æœ›ï¼Œä½†æ˜¯æ— ç–‘æœ¬æ–‡èƒ½å¸®æˆ‘ä¸€å®šç¨‹åº¦ä¸Š recap ä¹‹å‰åšçš„åˆ†å¸ƒå¼äº‹åŠ¡ï¼Œä¹Ÿæ–¹ä¾¿çœ‹çœ‹ï¼Œå®ƒä¸ºä»€ä¹ˆè¿™ä¹ˆåšï¼Œç‰¹å®šé¢†åŸŸçš„ä¼˜åŒ–æœ‰æ²¡æœ‰å‰é€”ã€‚å’Œè¯­ä¹‰åŒ–å¤„ç†äº‹åŠ¡çš„ä¸€äº›å®ç°é€»è¾‘ã€‚</p><p>åœ¨è®ºæ–‡é‡Œï¼Œä»–ä»¬çš„æè¿°å¦‚ä¸‹ï¼ˆé¦–å…ˆéœ€è¦äº†è§£ä»–ä»¬æ˜¯ä¸€ä¸ª primary key-value çš„æ¨¡å‹ï¼‰ï¼š</p><ul><li>äº‹åŠ¡ç›¸å¯¹äºç»´æŠ¤æˆ sessionï¼Œåªæ˜¯åœ¨å•ä¸ªå•ä¸ªè¯·æ±‚é‡Œé¢æäº¤ï¼ˆå¤©å•Šè¿™ä¸æ˜¯æˆ‘ä»¬ bg çš„æ¢—å—ï¼‰</li><li>é‡‡ç”¨ä¹è§‚äº‹åŠ¡æ¥å®ç°ï¼ˆç”¨æˆ·çœŸçš„ä¸ä¼šæœ‰æ„è§å—ï¼‰</li><li>å¯¹éäº‹åŠ¡æ“ä½œï¼ˆGet / Putï¼‰ã€1PC ç­‰åœºæ™¯æœ‰ç‰¹å®šä¼˜åŒ–ï¼Œè®©äº‹åŠ¡é€»è¾‘å°½é‡ä¸å½±å“å®ƒä»¬ã€‚åŒæ—¶è¿™äº›æ“ä½œä¹Ÿä¸ä¼š break äº‹åŠ¡æ“ä½œçš„é€»è¾‘</li><li>ä¸ç”¨ MVCCï¼Œäº‹åŠ¡æœ¬åœ°ç›´æ¥æ›´æ–°ã€‚ä½œè€…è§‰å¾—å¤šç‰ˆæœ¬å¼€æ”¾åœ¨å­˜å‚¨ä¸Šå¤ªå¤æ‚äº†ï¼ˆæ„Ÿè§‰ç”šè‡³åŒ…æ‹¬ç”¨ write intent è¿™ç§å½¢å¼ï¼‰ï¼Œæ‰€ä»¥åšäº†ä¸€ä¸ªå•ç‰ˆæœ¬çš„äº‹åŠ¡ï¼ˆæˆ‘æœ¬äººå¯¹è¿™ä¸ªä¸ç½®å¯å¦ï¼Œå› ä¸ºæ„Ÿè§‰å®ƒä»¬æ²¡æœ‰ scan è´Ÿè½½ï¼Œæ‰€ä»¥å¯ä»¥å°½é‡åšç®€å•ï¼‰</li><li>ç”¨äº‹åŠ¡çš„ start-ts æ¥åšæ—¶é—´æˆ³ï¼Œæ—¶é—´æˆ³ä»äºšé©¬é€Šçš„å•ç‹¬çš„æœåŠ¡ä¸Šå¤„ç†ï¼ˆç±»ä¼¼ TrueTimeï¼Œä½†æ˜¯çœ‹è®ºæ–‡æè¿°è¯´æ˜¯ä¼šæœ‰ç‚¹åå·®çš„ï¼Œä¼°è®¡å°±æ˜¯ NTP çŸ«æ­£æœ‰æ—¶é—´åå·®æœ‰ä¸ª lower-bound çš„æ—¶é’Ÿï¼Ÿï¼‰</li></ul><p>(é¢˜å¤–è¯ï¼Œåœ¨ ByteGraph è®ºæ–‡é‡Œé¢é‡ç‚¹æè¿°äº†è¿™ç§åœºæ™¯ä¸‹ Retry å¯èƒ½å¸¦æ¥çš„é—®é¢˜ï¼Œä½†æ˜¯ DynamoDB å¥½åƒæ²¡å¼ºè°ƒè¿™ä¸ªï¼Œä»–ä»¬åªå¼ºè°ƒäº†å†™è¯·æ±‚ä¼šå¸¦ä¸Šä¸€ä¸ª client idï¼Œæ„Ÿè§‰æ²¡æœ‰æ·±ç©¶ï¼Œä¸çŸ¥é“æ˜¯ä»–ä»¬æ²¡åšè¿˜æ˜¯ä»€ä¹ˆæƒ…å†µï¼Œå¦‚ä¸‹å›¾ï¼‰</p><p><img src="https://image.mwish.me/blog-image/998926934240291277.png" alt="img"></p><h2 id="DynamoDB-Interfaces"><a href="#DynamoDB-Interfaces" class="headerlink" title="DynamoDB Interfaces"></a>DynamoDB Interfaces</h2><p>DynamoDB æä¾›äº†æ“ä½œ Table æˆ–è€… Index çš„æŠ½è±¡ . ä¸‹é¢æ˜¯å®ƒå¼€æ”¾çš„éäº‹åŠ¡ API: </p><p><img src="https://image.mwish.me/blog-image/6696684328966579519.png" alt="img"></p><p>å¯¹äºäº‹åŠ¡ APIï¼Œæˆ‘ä»¬å¯ä»¥åˆ—å‡ºæ¥ç„¶åçœ‹çœ‹å…·ä½“ä»£ç çš„å†™æ³•ï¼ˆç¡®å®æœ‰ç‚¹åƒ RocksDBï¼‰</p><p><img src="https://image.mwish.me/blog-image/7121389673865386713.png" alt="img"></p><ul><li>å®ƒçš„ <code>TransactGetItems</code> ç»´æŠ¤çš„æ˜¯ä¸€ä¸ªç±»ä¼¼ SI çš„è¯­ä¹‰ï¼ˆ RC åº”è¯¥ç›´æ¥èµ°è¯»æ¥å£å°±è¡Œï¼‰</li><li>å†™æ“ä½œä¼š<strong>ä¿è¯è‡ªå·±æ˜¯å¹‚ç­‰</strong>çš„ï¼Œå…·ä½“è€Œè¨€å®ƒå…è®¸ç”¨æˆ·å¸¦ä¸Šä¸€ä¸ª client-idï¼Œç„¶åä¿è¯10minçš„çª—å£å†…è¿™é‡Œæ˜¯ä¼šæ£€æŸ¥æ˜¯å¦é‡å¤çš„ï¼ˆä½†æ˜¯è®ºæ–‡æ²¡æœ‰å¼ºè°ƒè¿™å—å…·ä½“çš„å®ç°ï¼Œæœ‰ç‚¹åƒæ˜¯åœ¨å†…å­˜æˆ–è€…å­˜å‚¨ä¸Šç»´æŠ¤äº†ä¸€ä¸ª Purge Windowï¼Œå› ä¸ºè¿™é‡Œæ¯”è¾ƒæ¶å¿ƒçš„æƒ…å†µæ˜¯ client-id å’Œ txn-id é€»è¾‘ä¸ä¸€å®šåœ¨ä¸€èµ·ï¼Œé™¤éå®ƒåšäº†ä»€ä¹ˆç‰¹æ®Šçš„ä¿è¯æ“ä½œæˆ–è€…åœ¨èŠ‚ç‚¹å†…å­˜ä¸Šè·Ÿç€äº‹åŠ¡ä¸€èµ·ç»´æŠ¤äº†è¿™ä¸ªçª—å£ï¼Œæˆ‘æ„Ÿè§‰éƒ½èƒ½åšä½†æ˜¯å°±æœ‰ç‚¹éº»çƒ¦ã€‚éš¾é“æ˜¯ç”¨è¿™ä¸ªç”Ÿæˆ transaction-idâ€¦?ï¼‰</li></ul><p><img src="https://image.mwish.me/blog-image/6182433940045300901.png" alt="img"></p><p>ä¸Šé¢çš„é€»è¾‘æè¿°äº† DynamoDB å…ˆ Checkï¼Œæ»¡è¶³çš„è¯å°±å»æ›´æ–°å¹¶ä¸”åˆ›å»ºè®¢å•ï¼ˆæ€»è§‰å¾—è¿™ä¸ªç»„ç»‡è¿˜æ˜¯æ¯”è¾ƒå¹³å¦çš„ï¼Œä¸çŸ¥é“å…è®¸ä¸å…è®¸å¤æ‚ä¸€ç‚¹çš„é€»è¾‘ç»“æ„ï¼Œçœ‹äº†ä¸‹æ–‡æ¡£æ„Ÿè§‰ä¸å¤ªå»ºè®®ç”¨æˆ·è¿™ä¹ˆæï¼Œä¼°è®¡å°±æ˜¯ä¸ªç®€å•çš„ check + mergeï¼‰</p><h2 id="Transaction-Execution-Basics"><a href="#Transaction-Execution-Basics" class="headerlink" title="Transaction Execution: Basics"></a>Transaction Execution: Basics</h2><p>è¿™èŠ‚ä»‹ç»äº† DynamoDB çš„äº‹åŠ¡æ‰§è¡Œï¼Œä¹‹æ‰€ä»¥å« Basic æ˜¯å› ä¸ºè¿™èŠ‚ä»‹ç»çš„æ˜¯å¤§æ¦‚çš„æ¡†æ¶ï¼Œè€Œæ²¡æœ‰ä»‹ç» OCC ç›¸å…³çš„æ ¸å¿ƒä¼˜åŒ–ã€‚</p><p><img src="https://image.mwish.me/blog-image/6547853856850566784.png" alt="img"></p><p>åœ¨é‰´æƒç­‰æ“ä½œä¹‹åï¼Œäº‹åŠ¡è¯·æ±‚ï¼ˆä¸åŒ…æ‹¬éäº‹åŠ¡è¯·æ±‚ï¼‰éƒ½ä¼šè¢«å‘ç»™ Transaction Coordinatorã€‚Transaction Coordinator æ˜¯ä¸€ä¸ªæ— çŠ¶æ€çš„èŠ‚ç‚¹ï¼Œä»»ä½•ä¸€ä¸ª Transaction Coordinator éƒ½å¯ä»¥å……å½“ä¸€ä¸ªäº‹åŠ¡çš„ coordinatorã€‚</p><p>åœ¨ coordinator ä¸Šï¼Œäº‹åŠ¡ä¼šè¢« assign ä¸€ä¸ª start-ts ï¼ˆä½¿ç”¨ AWS time-sync service [3]ï¼Œä¸€ä¸ª NTP æ± ï¼‰ä½œä¸ºäº‹åŠ¡æ“ä½œçš„ tsï¼Œç„¶åè¦æ±‚æŒ‰ç…§ ts åš orderingã€‚è¿™é‡Œæ¯”è¾ƒ trickï¼Œå› ä¸ºå®ƒè¿™é‡Œä¸ä¾èµ– TrueTimeã€Lock è€Œä¸”åšçš„è¿˜æ˜¯ OCCï¼Œæˆ‘è§‰å¾—è¿™æ®µè¿˜æ˜¯å¾—æ¯”è¾ƒè°¨æ…çš„åˆ¤æ–­ corner case çš„â€¦</p><h3 id="Write-Transaction-Protocols"><a href="#Write-Transaction-Protocols" class="headerlink" title="Write Transaction Protocols"></a>Write Transaction Protocols</h3><p>è¿™é‡Œçš„åè®®æ˜¯ä¸ª 2PC:</p><p><img src="https://image.mwish.me/blog-image/4742757250468458028.png" alt="img"></p><ol><li>Prepare</li><li>Commit / Cancel</li><li>(post) å» Ledger è®°å½•äº‹åŠ¡çš„ FIN ä¿¡æ¯<ol><li>è¿™é‡Œé¢ï¼Œå¯¹äº DynamoDBï¼Œæ¯ä¸ª row (æˆ–è€…è¯´ item) æœ‰ä¸€ä¸ª <code>&#123;timestamp(commitæ—¶æ›´æ–°), update-txn-id(prepareæ—¶æ›´æ–°,commitæ¸…ç†)&#125;</code> çš„æ ‡è®°, ä½œä¸ºäº‹åŠ¡æ›´æ–°çš„æ ‡è®°ï¼Œè¿™é‡Œæœ‰ä¸€ç‚¹éœ€è¦æ³¨æ„ï¼š</li></ol></li></ol><ul><li>å¯¹äºä¸€èˆ¬çš„æ•°æ®åº“ï¼Œè¿™ç§ä¸€èˆ¬æ˜¯æ’å…¥ä¸€æ¡è¾¹ï¼Œå¸¦ä¸Šè‡ªå·±çš„ ts/txn-id ä½œä¸ºé”ï¼Œç„¶åç­‰ commit é˜¶æ®µè¿™æ¡è®°å½•å˜å¾—å¯¹å¤–éƒ¨äº‹åŠ¡å¯è§ã€‚å¯èƒ½æ—§çš„ row ä¼šå¸¦ä¸Š end-tsã€‚å½“ç„¶ä¹Ÿæœ‰ä¸€äº›ç³»ç»Ÿæ˜¯ implicit å®Œæˆè¿™ä¸ªçº¦æŸçš„ï¼Œæ¯”å¦‚æ„å»ºåœ¨ kv ç³»ç»Ÿä¸Šçš„ Percolator</li><li>å¯¹äº DynamoDBï¼Œè¿™ä¸€ç»„æ ‡è®°ä»…ä»…æ˜¯ä¸€ä¸ª update-lockingï¼Œåœ¨ Prepare é˜¶æ®µåœ¨æ—§çš„æ•°æ®ä¸Šæ ‡è®°è¿™ä¸ª row çš„é”è¢«å ç”¨äº†ï¼Œå¹¶ä¸”åœ¨ commit é˜¶æ®µå¯ä»¥åšæ£€æŸ¥ï¼ˆcommit é˜¶æ®µçš„æ£€æŸ¥åº”è¯¥å’Œé‡è¯•ä¹‹ç±»çš„ä¹Ÿæœ‰å…³ç³»ï¼Œä¸€èˆ¬åˆ†å¸ƒå¼äº‹åŠ¡å¯èƒ½éœ€è¦æœ‰ä¸€ä¸ª background resolve ä¹‹ç±»çš„åå°æ¸…ç†ä¹‹ç±»çš„æµç¨‹ï¼‰ï¼Œ<strong>è¿™ç»„ã€Œé”ã€åœ¨äº‹åŠ¡æäº¤ä¹‹åï¼Œå®ƒè®¤ä¸º txn-id å°±å¯ä»¥ discard äº†ã€‚</strong></li></ul><p><img src="https://image.mwish.me/blog-image/5160409351946106530.png" alt="img"></p><p>Coordinator ä¸Šæ­£å¸¸é“¾è·¯çš„æ“ä½œè¿˜æ˜¯å¾ˆç®€å•çš„ã€‚Prepare æ­£å¸¸é“¾è·¯çš„åè®®å¦‚ä¸‹ï¼š</p><p><img src="https://image.mwish.me/blog-image/3483436806349992495.png" alt="img"></p><p>è¿™é‡Œæ³¨æ„åˆ°å‡ ä¸ªåœ°æ–¹ï¼š</p><ul><li>åªæœ‰é€šè¿‡äº† check æ‰èƒ½æ¨è¿›</li><li>å¦‚æœç°åœ¨æ“ä½œè¢«å¦ä¸€ä¸ªäº‹åŠ¡(<code>tx</code>)å æœ‰äº†ï¼Œæ—¶é—´æˆ³æ¯” tx å°ç›´æ¥å°±è¿”å›äº†ï¼Œä½†æ˜¯æ¯”æ›´æ–°å¤§è¿˜æ˜¯ä¼šå¤±è´¥ï¼Œå› ä¸ºè¿™ä¸Šé¢æœ‰ <code>ongoing</code></li><li>å› ä¸ºåˆ é™¤ä¸€æ¡è®°å½•è¿™ä¸ªç‰©ç†è®°å½•å°±ä¼šä¸å­˜åœ¨äº†ï¼Œè¿™ä¸ªä¼šç»´æŠ¤ <code>partition</code> ä¸Šçš„ <code>maxDeleteTimeStamp</code>ã€‚ç„¶åå¦‚æœæ’å…¥çš„æ—¶é—´æˆ³å°äº <code>maxDeleteTimestamp</code>ï¼Œè¡¨ç¤ºå¯èƒ½å’Œå¯¹è¿™æ¡è¾¹çš„åˆ é™¤å†²çªï¼Œæ‰€ä»¥ä¸å¾—æ¨è¿›ã€‚ï¼ˆè¿™é‡Œ bytegraph ä¸»è¦æ˜¯é  lock æ¥ç»´æŠ¤çš„ï¼Œç„¶å binlog éœ€è¦ç»´æŠ¤ä¸€ä¸ª delete setï¼‰</li><li>å¦‚æœé‡åˆ°å†²çªæˆ–è€…å¤±è´¥ï¼Œè¿™é‡Œå°±ä¼š cancel è‡ªå·±ï¼ˆæ„Ÿè§‰åœ¨é«˜å†²çªåœºæ™¯ä¸‹ï¼Œè¿™ä¸ªè¦ä¹ˆå¾—ä¼˜åŒ–è¦ä¹ˆå¾—ç”©é”…ç»™ç”¨æˆ·ï¼‰</li><li>éœ€è¦åœ¨èŠ‚ç‚¹ä¸Šæäº¤æˆåŠŸå†è¿”å›ï¼Œæ„Ÿè§‰æ²¡æœ‰åš async commit</li><li>æ„Ÿè§‰å®ƒä»¬æ²¡æœ‰æè¿°ä¸€ä¸ªäº‹åŠ¡è¡¨ï¼Œåœ¨ coordinator ä¸Šå¥½åƒä¹Ÿæ²¡æœ‰å­˜å‚¨ï¼Œè¿™ä¸ªæ„Ÿè§‰æ˜¯å¯¹ä»–ä»¬æ¥è¯´ç®—å¾—ä¸Šç‹¬ç‰¹çš„åœ°æ–¹ï¼Œå› ä¸ºè¿™æ ·æ„Ÿè§‰å°±ä¸å¥½ç¡®å®šäº‹åŠ¡æœ€ç»ˆçš„çŠ¶æ€æˆ–è€…æ‰€æœ‰ participants äº†ã€‚è¿™ä¸ªåé¢æœ‰è®² Ledgerã€‚</li></ul><p><img src="https://image.mwish.me/blog-image/6510681213383560754.png" alt="img"></p><p>Commit é˜¶æ®µï¼Œæ¯”è¾ƒæœ‰è¶£çš„æ˜¯å®ƒä¼šåšä¸€ä¸ª <code>item.ongoing == commit-txn</code> çš„æ£€æŸ¥ï¼Œè¿™ä¸ªå’Œåé¢å‡ èŠ‚ä»‹ç»çš„ recover æœ‰å…³ã€‚</p><p>é¢˜å¤–è¯ï¼Œæˆ‘è§‰å¾—è¿™é‡Œå¾ˆé‡è¦ä¸€éƒ¨åˆ†æ˜¯ Merge æ“ä½œçš„åŸå­æ€§å’Œè¯»å†™é›†ã€‚è¿™é‡Œçœ‹äº†ä¸‹å®˜æ–¹æ–‡æ¡£ï¼š</p><blockquote><p>You canâ€™t target the same item with multiple operations within the same transaction. For example, you canâ€™t perform a <code>ConditionCheck</code> and also an <code>Update</code> action on the same item in the same transaction.</p></blockquote><p>æˆ‘æ€»è§‰å¾— <code>condition</code> çš„ item ä¹Ÿå¾—ä¸Šä¸ªå†™æ ‡è®°ã€‚</p><h3 id="Naive-Read-Transaction-Protocol"><a href="#Naive-Read-Transaction-Protocol" class="headerlink" title="(Naive) Read Transaction Protocol"></a>(Naive) Read Transaction Protocol</h3><p>DynamoDB ä¸æƒ³å’Œ TS Protocol ä¸€æ ·ç»´æŠ¤ä¸€ä¸ª read-ts æ ‡è®°ã€‚æ‰€ä»¥æ‰ç”¨äº†ä¸¤é˜¶æ®µè¯»ï¼ˆç±»ä¼¼ Hekaton OCC é‚£å¥—ï¼‰ï¼š</p><ol><li>Phase1: æŸ¥çœ‹è¯»çš„ item æ˜¯å¦éƒ½æ²¡æœ‰ on-going äº‹åŠ¡ï¼Œå¦‚æœæœ‰çš„è¯ï¼Œè¿”å›å¤±è´¥ï¼Œå¦åˆ™è®°å½• item LSN</li><li>Phase2: è¯»å®Œä¹‹åå†æ¬¡æ£€æŸ¥ LSN æœ‰æ²¡æœ‰å˜æ›´</li></ol><p>è¿™ä¸ªå®é™…ä¸Šè¿‡äº Naive äº†ï¼Œæ‰€ä»¥ç¬¬å››èŠ‚ä¼šè®²è¿™éƒ¨åˆ†æ€ä¹ˆè¿›è¡Œä¼˜åŒ–ã€‚ï¼ˆå¦ˆçš„åˆå¼•å…¥äº†ä¸€ä¸ª LSN çš„æ¦‚å¿µï¼Œä½ ç”¨ ts ä¼šæ­»ï¼Ÿï¼‰</p><h3 id="Recovery"><a href="#Recovery" class="headerlink" title="Recovery"></a>Recovery</h3><p>å› ä¸º Paxos åè®®ï¼Œæ‰€ä»¥ Participant Failed æ˜¯å¾ˆå¥½å¤„ç†çš„ï¼Œä½†æ˜¯ Coordinator Failed å¯èƒ½ä¼šä¸¢å¤±äº‹åŠ¡æ‰§è¡Œçš„ä¸Šä¸‹æ–‡ï¼ˆPercolator ç±»çš„åè®®ä¼šæœ‰ Primary å­˜å‚¨å¯¹åº”äº‹åŠ¡çš„ä¸Šä¸‹æ–‡ï¼ŒDynamoDB æ²¡æœ‰è¯´ï¼Œè¿™ä¸ªå¯ä»¥èŠ‚çœä¸€è½®æäº¤æ—¶å€™çš„ rpcï¼Œä½†æ˜¯æ„Ÿè§‰å¯¹ resolve æ¥è¯´ä¼šæœ‰ä¸€å®šè´Ÿæ‹…ï¼‰ã€‚è¿™é‡Œæœ‰ä¸ªåå° scanner å»æ‰«æ²¡å®Œæˆçš„äº‹åŠ¡ï¼Œç„¶åå°è¯•äº¤ç»™ä¸€ä¸ªæ–°çš„ Coordinator æ¥ Resolveã€‚</p><p>è®ºæ–‡æåˆ° transaction å¯ä»¥å¹¶è¡Œ resolveï¼Œæ²¡å•¥é—®é¢˜ï¼Œä½†æ˜¯æ¯”è¾ƒæ¶å¿ƒçš„æ˜¯ï¼Œå¦‚æœä½ å» resolve:</p><ul><li>ä½ æ€ä¹ˆå®šä¹‰è¿™ä¸ª txn æ˜¯ abort è¿˜æ˜¯ commit å‘¢ï¼Ÿ</li><li>ä½ æ€ä¹ˆæ‰¾åˆ°æ‰€æœ‰çš„ participants å‘¢ï¼Ÿ</li></ul><p>è¿™é‡Œå®ƒä»¬æ²¡æœ‰ async commitï¼Œä½†æ˜¯ä¹Ÿä¸èƒ½çœ‹åˆ°ä¸€ä¸ª abort ä¸€ä¸ªï¼Œè¦ä¸ç„¶æœ€ç»ˆçŠ¶æ€åˆé—®é¢˜ï¼Œä½†è®ºæ–‡æåˆ°äº† <strong>Ledger æ¥å­˜å‚¨äº‹åŠ¡çš„çŠ¶æ€</strong>ã€‚ï¼ˆè®ºæ–‡é‡Œæ²¡æœ‰æåˆ°å®ƒæ˜¯ä¸æ˜¯åŒæ­¥å†™ Ledgerï¼Œä¸è¿‡æˆ‘è§‰å¾—åº”è¯¥æ˜¯ï¼Œè¿™æ · resolve çš„æ—¶å€™å¯ä»¥æ‰¾åˆ°æ‰€æœ‰çš„ Participantsï¼Œç„¶åå†å» resolveï¼‰</p><p>Ledger æœ¬èº«æ˜¯ DynamoDB ä¸Šä¸€ä¸ªç‰¹æ®Šçš„è¡¨ï¼Œç”¨è¿™ä¸ªæ¥å¤„ç†ç›¸å…³çš„äº‹åŠ¡é€»è¾‘ï¼ŒStorage èŠ‚ç‚¹ä¹Ÿä¼šä¸»åŠ¨æŠŠæ²¡å®Œæˆçš„äº‹åŠ¡ä¸ŠæŠ¥ï¼Œç„¶åæé†’ä¸Šé¢ä¸»åŠ¨æ¸…ç†ï¼ˆBG ä¹Ÿæœ‰è¿™å¥—é€»è¾‘ï¼Œå®³ï¼Œæ„Ÿè§‰ä»–ä»¬åšçš„æ²¡å•¥å•Š XDï¼‰</p><h2 id="Adapting-timestamp-ordering-for-key-value-operations"><a href="#Adapting-timestamp-ordering-for-key-value-operations" class="headerlink" title="Adapting timestamp ordering for key-value operations"></a>Adapting timestamp ordering for key-value operations</h2><p>DynamoDB åŒºåˆ†å‡ºäº† Delete / Partial Update / Insert / Upsert(Put) ä¹‹ç±»çš„è¯­ä¹‰ï¼ˆé‡Œé¢æœ‰äº›æ²¡ç›´æ¥è¯´ï¼Œä½†æ˜¯å¤§è‡´æ˜¯è¿™ä¸ªæ„æ€ï¼‰ã€‚ç„¶ååº”ç”¨äº†ä¸€äº› OCC ä¸Šçš„ç»å…¸ Rulesï¼ŒåŒæ—¶æŠŠéäº‹åŠ¡çš„æ“ä½œä¹Ÿå›Šæ‹¬è¿›æ¥äº†ï¼ˆå¾ˆéš¾é¿å…äº‹åŠ¡å’Œéäº‹åŠ¡æ“ä½œåœ¨æŸäº›æ–¹é¢ä¸Šçš„å†²çªï¼‰</p><h3 id="PointGet-å§‹ç»ˆä¼šæˆåŠŸ"><a href="#PointGet-å§‹ç»ˆä¼šæˆåŠŸ" class="headerlink" title="PointGet å§‹ç»ˆä¼šæˆåŠŸ"></a>PointGet å§‹ç»ˆä¼šæˆåŠŸ</h3><p>è¯»ä¿è¯ RC è¯­ä¹‰å³å¯ï¼Œå¯ä»¥çœ‹åšå®ƒçš„æ—¶é—´æˆ³ï¼š</p><ul><li>å¤§äºç­‰äºå·²ç»æäº¤çš„äº‹åŠ¡</li><li>å°äº Prepare çš„äº‹åŠ¡</li></ul><p>åæ­£ Point Getï¼Œåœ¨è¿™ä¸ª Partial Order çš„ç³»ç»Ÿæ²¡æœ‰ä»€ä¹ˆè¦å’Œåˆ«äººåŒæ­¥çš„ã€‚è¿™ä¸ªä¸ä¼šèµ° txn coordinatorï¼Œç›´æ¥è·¯ç”±åˆ° Storage Node å°±è¡Œäº†ã€‚</p><h3 id="Single-Put-å¯ä»¥ç›´æ¥å†™æ²¡æœ‰-Prepare-çš„-row"><a href="#Single-Put-å¯ä»¥ç›´æ¥å†™æ²¡æœ‰-Prepare-çš„-row" class="headerlink" title="Single Put å¯ä»¥ç›´æ¥å†™æ²¡æœ‰ Prepare çš„ row"></a>Single Put å¯ä»¥ç›´æ¥å†™æ²¡æœ‰ Prepare çš„ row</h3><p>é¦–å…ˆæ³¨æ„è¿™é‡Œä¸ä¼šèµ° coordinator èŠ‚ç‚¹ï¼Œç›´æ¥è·¯ç”±ç»™ Storageã€‚</p><p>è¿™é‡Œå•ç‚¹çš„ç›´æ¥å†™æ˜¯å¯ä»¥çš„ï¼Œå‘ç°æ²¡æœ‰ Prepare çš„ row çš„æ—¶å€™ï¼Œå¯ä»¥ç›´æ¥å†™å…¥ï¼ˆDelete/Update/Putâ€¦ï¼‰ã€‚å¦‚æœæ˜¯ checked-write çš„è¯å°±ä¸å¤ªè¡Œï¼Œè¿™é‡Œè®ºæ–‡ä¹Ÿæ²¡å¤ªä»”ç»†è®ºè¯ï¼Œæˆ‘æ„Ÿè§‰è¿™ä¸ªæ—¶é—´æˆ³è¿˜æ˜¯æ¯”è¾ƒå¤æ‚çš„ï¼Œç±»ä¼¼ PolarDB-X è®¾è®¡ä¸Šçš„ 1PC çš„æµç¨‹äº†</p><h3 id="Single-Put-å¯ä»¥ç›´æ¥-Buffer-å†™æ²¡æœ‰-Prepare-çš„-row"><a href="#Single-Put-å¯ä»¥ç›´æ¥-Buffer-å†™æ²¡æœ‰-Prepare-çš„-row" class="headerlink" title="Single Put å¯ä»¥ç›´æ¥ Buffer å†™æ²¡æœ‰ Prepare çš„ row"></a>Single Put å¯ä»¥ç›´æ¥ Buffer å†™æ²¡æœ‰ Prepare çš„ row</h3><p>å¯¹äºæœ‰ Prepare çš„ rowï¼Œè¿™é‡Œå¯èƒ½ä¼š Buffer å†™è¯·æ±‚ç„¶ååˆ†é…ä¸€ä¸ª Later Timestampã€‚</p><p>è¿™é‡Œå®ƒä»¬è¿˜æäº†ä¸€ä¸ª further optimization:</p><ul><li>å¦‚æœæ˜¯ unconditional Put/Deleteï¼Œè¿™é‡Œå¯ä»¥ç›´æ¥è¦†ç›–ç„¶åè¿”å›æˆåŠŸï¼Œä¹‹å‰çš„äº‹åŠ¡æˆåŠŸä¸å¦éƒ½ä¸å¯è§ï¼ˆç±»ä¼¼ Thomas Rule äº†ï¼Œä¸åŒçš„åŒºåˆ«æ˜¯ï¼ŒThomas Rule å¯èƒ½è¦å¤„ç† Cascade Abortï¼Œä½†å¯¹äº DynamoDBï¼Œè¿™ç±» 1PC æ“ä½œæ—¢ç„¶åšäº†å°±æ˜¯ä¸€å®šæˆåŠŸçš„ï¼Œä¸è¿‡æˆ‘è§‰å¾—è¿™å¥—ä¸œè¥¿å®ç°çš„æ—¶å€™è¿˜æ˜¯æŒºæ¶å¿ƒçš„ï¼Œä¼°è®¡ä¸å¥½æŸ¥é—®é¢˜ï¼‰ã€‚</li></ul><h3 id="å¯¹äºæœ€æ–°å†™å…¥æ˜¯è¦†ç›–å†™çš„æ“ä½œï¼Œæ—§æ—¶é—´æˆ³çš„äº‹åŠ¡å†™å¯ä»¥è®¤ä¸ºä¸å®ƒæ— å†²çª"><a href="#å¯¹äºæœ€æ–°å†™å…¥æ˜¯è¦†ç›–å†™çš„æ“ä½œï¼Œæ—§æ—¶é—´æˆ³çš„äº‹åŠ¡å†™å¯ä»¥è®¤ä¸ºä¸å®ƒæ— å†²çª" class="headerlink" title="å¯¹äºæœ€æ–°å†™å…¥æ˜¯è¦†ç›–å†™çš„æ“ä½œï¼Œæ—§æ—¶é—´æˆ³çš„äº‹åŠ¡å†™å¯ä»¥è®¤ä¸ºä¸å®ƒæ— å†²çª"></a>å¯¹äºæœ€æ–°å†™å…¥æ˜¯è¦†ç›–å†™çš„æ“ä½œï¼Œæ—§æ—¶é—´æˆ³çš„äº‹åŠ¡å†™å¯ä»¥è®¤ä¸ºä¸å®ƒæ— å†²çª</h3><p>è¿™ä¸ªæ¯”è¾ƒå¥½ç†è§£ï¼Œå’Œä¸Šé¢ä¸€æ¡åŸåˆ™å·®ä¸å¤šã€‚ä½†æˆ‘è§‰å¾—æå¾—å¤ªå¤æ‚äº†ï¼Œå¯¹äº checked-write è¿™ç±» Merge æ“ä½œé‚£ä½ ä¹Ÿè¦ç®—ä¸Šï¼Œè¿™ä¸ªæœ¬èº«æ—¶é—´é¡ºåºå°±ä»ä¸€ä¸ª ts å…¨åºå˜æˆä¸€å¨ start-ts å’Œ arrive-ts å¾ˆæ··ä¹±çš„ä¸œè¥¿äº†ã€‚</p><h3 id="å¤šæ¡å†™åŒä¸€-row-çš„-Put-Delete-äº‹åŠ¡å¯ä»¥-batch-prepare"><a href="#å¤šæ¡å†™åŒä¸€-row-çš„-Put-Delete-äº‹åŠ¡å¯ä»¥-batch-prepare" class="headerlink" title="å¤šæ¡å†™åŒä¸€ row çš„ Put/Delete äº‹åŠ¡å¯ä»¥ batch prepare"></a>å¤šæ¡å†™åŒä¸€ row çš„ Put/Delete äº‹åŠ¡å¯ä»¥ batch prepare</h3><p>è¿™æ¡æˆ‘æ²¡è¯»å¤ªæ‡‚ï¼Œè¿™æ€ä¹ˆæ•¢çš„â€¦æŠŠ Prepared å˜æˆä¸€ç»„ <code>vector</code>?ç„¶åæäº¤çš„æ—¶å€™æ›´æ–°è®°å½•ï¼Œä» vector ç§»é™¤è‡ªå·±ï¼Ÿ</p><p>å¦‚æœæ˜¯ partial updateï¼Œé‚£ä¹ˆéœ€è¦å…¨åºï¼Œå¦åˆ™å¯ä»¥å¹¶è¡Œ prepareã€‚</p><p>æˆ‘è¿˜æ˜¯é‚£ä¸ªé—®é¢˜ï¼Œä½  checked-update è¦æ’åºæ€ä¹ˆåŠã€‚ã€‚ã€‚æ„Ÿè§‰æˆ‘å°±æ²¡ç†è§£è¿™ä¸ª check çš„è¯­ä¹‰â€¦å¦‚æœ check çš„è¯­ä¹‰å°±æ˜¯æ£€æŸ¥å…ƒæ•°æ®çš„è¯å€’æ˜¯æ²¡é—®é¢˜ï¼Œä½†æ˜¯è¿™ä¸ªåŒ…æ‹¬æ£€æŸ¥æ•°æ®ï¼Œä¼°è®¡è¦ä¹ˆèµ°å†™åè®®ï¼Œè¦ä¹ˆèµ°è¯»åè®®ï¼Œä¸ç„¶çœ‹ç€éå¸¸åˆ«æ‰­ã€‚</p><h3 id="Read-å¯ä»¥ä¸ç”¨èµ°-OCC-çš„ä¸¤è½®æµç¨‹"><a href="#Read-å¯ä»¥ä¸ç”¨èµ°-OCC-çš„ä¸¤è½®æµç¨‹" class="headerlink" title="Read å¯ä»¥ä¸ç”¨èµ° OCC çš„ä¸¤è½®æµç¨‹"></a>Read å¯ä»¥ä¸ç”¨èµ° OCC çš„ä¸¤è½®æµç¨‹</h3><blockquote><p>This GetItemWithTimestamp operation returns the latest value of the item if its last write timestamp is earlier than the given read timestamp and if any prepared transactions have later timestamps, and otherwise rejects the request.</p></blockquote><p>è¿™éƒ¨åˆ†æ¦‚å¿µç®€å•ï¼Œä½†æ˜¯æœ‰ä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿæ—¶é—´æˆ³å›é€€çš„é—®é¢˜ï¼Œè¿™éƒ¨åˆ†æœ‰ç‚¹åƒ TiDB çš„ async-commit æåˆ°çš„è¯»æ°´ä½ç»´æŠ¤ã€‚è¦æ±‚åç»­æ›´æ–° row ä¸èƒ½ä½äºè¿™ä¸ª Max-Row-Read-Tsã€‚</p><p>é¢˜å¤–è¯ï¼Œè¿™å‚»é€¼æ–‡ç« ä¹‹å‰è¿˜è¯´ä¸æƒ³ç»´æŠ¤ read-tsï¼Œè¿™ä¸‹å…¨å›æ¥äº†ã€‚</p><h3 id="å†™åŒä¸€ä¸ª-Partition-çš„äº‹åŠ¡å¯ä»¥èµ°-1PC"><a href="#å†™åŒä¸€ä¸ª-Partition-çš„äº‹åŠ¡å¯ä»¥èµ°-1PC" class="headerlink" title="å†™åŒä¸€ä¸ª Partition çš„äº‹åŠ¡å¯ä»¥èµ° 1PC"></a>å†™åŒä¸€ä¸ª Partition çš„äº‹åŠ¡å¯ä»¥èµ° 1PC</h3><p>åºŸè¯ã€‚</p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>æœ¬æ–‡æè¿°äº† DynamoDB çš„åˆ†å¸ƒå¼äº‹åŠ¡å¤„ç†ï¼Œäº®ç‚¹æ˜¯ç›¸å…³çš„è¯­ä¹‰ï¼Œä½†ç¬”è€…è§‰å¾—ï¼š</p><ol><li>å®ƒç¼ºå°‘ scan çš„åœºæ™¯ï¼Œåœ¨ scan åœºæ™¯ä¸‹ï¼ŒDynamoDB çš„è¯»å¤„ç†å°†å˜æˆä¸€å †åºŸç‰©ã€‚ä¸è¿‡åè¿‡æ¥æƒ³ï¼Œå¦‚æœæ²¡æœ‰ Scan æ”¯æŒï¼Œé‚£æˆ‘ä»¬ä¹Ÿä¸ä¸€å®šéœ€è¦åšä¸€ä¸ª MVCC çš„ç³»ç»Ÿ</li><li>ç‰¹å®šè¯­ä¹‰çš„åŒºåˆ†ã€‚æ ¹æ® Update åŒºåˆ†ä¸ºä¸åŒè¯­ä¹‰å’ŒåŒºåˆ†ä¸ºæ˜¯å¦æ˜¯äº‹åŠ¡å†™ï¼Œæ¥åšä¸€äº›ç‰¹å®šçš„äº‹åŠ¡ä¼˜åŒ–ã€‚è¿™äº›ä¼˜åŒ–ä¸æ˜¯é€šç”¨çš„ï¼Œè€Œä¸”å¯èƒ½ break ç³»ç»Ÿ invariantï¼Œä½†æ˜¯å¯èƒ½ç¡®å®èƒ½ä¼˜åŒ–ä¸€äº›ç‰¹å®šåœºæ™¯ã€‚</li></ol><h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ol><li>Amazon DynamoDB: A Scalable, Predictably Performant, and Fully Managed NoSQL Database Service <a href="https://www.usenix.org/conference/atc22/presentation/elhemali">https://www.usenix.org/conference/atc22/presentation/elhemali</a></li><li>DynamoDB äº‹åŠ¡ç›¸å…³çš„æ–‡æ¡£ <a href="https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/transaction-apis.html#transaction-conflict-handling">https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/transaction-apis.html#transaction-conflict-handling</a></li><li>AWS Time Sync <a href="https://aws.amazon.com/cn/about-aws/whats-new/2022/11/amazon-time-sync-internet-public-ntp-service/">https://aws.amazon.com/cn/about-aws/whats-new/2022/11/amazon-time-sync-internet-public-ntp-service/</a></li></ol>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>arrow expression</title>
      <link href="/2023/07/06/arrow-expression/"/>
      <url>/2023/07/06/arrow-expression/</url>
      
        <content type="html"><![CDATA[<p>Expressionï¼Œé¡¾åæ€ä¹‰ï¼Œæ˜¯ arrow ä¸­è®¡ç®—çš„è¡¨è¾¾å¼ã€‚è¿™é‡Œå¯ä»¥é€šè¿‡ Substrait æ¥æ„å»º Plan æˆ–è€…å•æœºçš„è¡¨è¾¾å¼ã€‚</p><h2 id="Glance"><a href="#Glance" class="headerlink" title="Glance"></a>Glance</h2><p>åœ¨ Arrow ä¸­ï¼ŒExpression å¯ä»¥åˆ†ä¸ºä¸‹é¢å‡ ç§å¯èƒ½çš„å½¢å¼ï¼š</p><ul><li>Call<ul><li>Function + Args çš„åŒ…è£…ï¼Œåˆ†ä¸º Bounded / Unbounded çš„ç±»å‹</li></ul></li><li>Parameter ( <code>A reference to a single (potentially nested) field of the input Datum.</code>)<ul><li>Arrow æˆ–è€… Input ä¸­ Field çš„åŒ…è£…ï¼Œåˆ†ä¸º Bounded / Unbounded</li><li>å¯ä»¥é€šè¿‡ <code>FieldRef</code> ä¹‹ç±»çš„æ¥æ„å»ºã€‚ç”¨æˆ·å¤§éƒ¨åˆ†æ—¶å€™åªèµ° <code>field_ref</code>ï¼Œä½†åº•ä¸‹å®ç°è¿˜æ˜¯ä¸ª <code>Parameter</code></li></ul></li><li>Literal: æ­£å¸¸çš„ Literal, åŒ…å« Nullã€‚å®é™…ä¸Šç”± <code>Datum</code> (æˆ‘ä»¬åœ¨ä»‹ç» Compute çš„æ—¶å€™è®²è¿‡) å®ç°</li></ul><p>ä¸Šé¢è¿™å‡ å¥—æ¥å£åœ¨ Expression ä¸­è¡¨ç°ä¸ºæ¯”è¾ƒæœ‰è¶£çš„å½¢å¼ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// An unbound expression which maps a single Datum to another Datum.</span></span><br><span class="line"><span class="comment">/// An expression is one of</span></span><br><span class="line"><span class="comment">/// - A literal Datum.</span></span><br><span class="line"><span class="comment">/// - A reference to a single (potentially nested) field of the input Datum.</span></span><br><span class="line"><span class="comment">/// - A call to a compute function, with arguments specified by other Expressions.</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ARROW_EXPORT</span> Expression &#123;</span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="function"><span class="type">bool</span> <span class="title">is_valid</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> impl_ != NULLPTR; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// Access a Call or return nullptr if this expression is not a call</span></span><br><span class="line">  <span class="function"><span class="type">const</span> Call* <span class="title">call</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">  <span class="comment">/// Access a Datum or return nullptr if this expression is not a literal</span></span><br><span class="line">  <span class="function"><span class="type">const</span> Datum* <span class="title">literal</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">  <span class="comment">/// Access a FieldRef or return nullptr if this expression is not a field_ref</span></span><br><span class="line">  <span class="function"><span class="type">const</span> FieldRef* <span class="title">field_ref</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">Parameter</span> &#123;</span><br><span class="line">    FieldRef ref;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// post-bind properties</span></span><br><span class="line">    TypeHolder type;</span><br><span class="line">    ::arrow::internal::SmallVector&lt;<span class="type">int</span>, <span class="number">2</span>&gt; indices;</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="function"><span class="type">const</span> Parameter* <span class="title">parameter</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">  </span><br><span class="line"> <span class="keyword">private</span>:</span><br><span class="line">  <span class="keyword">using</span> Impl = std::variant&lt;Datum, Parameter, Call&gt;;</span><br><span class="line">  std::shared_ptr&lt;Impl&gt; impl_;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„ä½¿ç”¨æ–¹å¼å¾ˆæœ‰æ„æ€ï¼Œç±»ä¼¼ enum:</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">auto</span> call = expr-&gt;<span class="built_in">call</span>();</span><br><span class="line"><span class="keyword">if</span> (call == <span class="literal">nullptr</span>) <span class="keyword">return</span>;</span><br></pre></td></tr></table></figure><p><code>Datum</code> ä½œä¸º <code>literal</code> æˆ‘ä»¬ä¹‹å‰å°±å·²ç»ä»‹ç»è¿‡äº†ï¼ˆå›§ï¼‰</p><p>å®ƒè‡ªå·±è¿˜æœ‰æ•´ä¸ª Expression çš„ç±»å‹ (<code>Type</code>)ï¼Œç„¶åæ­¤å¤–ï¼Œæ•´ä¸ª <code>Expression</code> è¿˜æœ‰å¯¹åº”çš„ Hash å’Œ Equal çš„æ–¹æ³•ï¼Œç”¨æ¥ç»„ä¸€äº›æ¯”è¾ƒã€‚æˆ‘ä»¬ä¹‹åä¼šçœ‹åˆ°è¿™äº›æ–¹æ³•</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">std::string <span class="title">ToString</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">Equals</span><span class="params">(<span class="type">const</span> Expression&amp; other)</span> <span class="type">const</span></span>;</span><br><span class="line"><span class="function"><span class="type">size_t</span> <span class="title">hash</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Hash</span> &#123;</span><br><span class="line">  <span class="function"><span class="type">size_t</span> <span class="title">operator</span><span class="params">()</span><span class="params">(<span class="type">const</span> Expression&amp; expr)</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> expr.<span class="built_in">hash</span>(); &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>æ­¤å¤–ï¼Œè¿™é‡Œè¿˜æœ‰ä¸€äº›ç‰¹æ®Šçš„å±æ€§ï¼Œéœ€è¦é¢å¤–æä¾›ä¸€ä¸‹ï¼š</p><ol><li><code>IsBound</code>:<ol><li><strong>è¿™ä¸ªåé¢è®²ï¼Œæœ‰ç‚¹å¤æ‚</strong></li></ol></li><li><code>IsScalar</code> ï¼ˆéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨è¿™é‡Œï¼Œcomplex type ä¹‹ç±»çš„ä¹Ÿç®—æ˜¯ scalarï¼‰<ol><li>å¯¹äº <code>Datum</code> æ¥è¯´ï¼ŒDatum åŒ…å«çš„æ˜¯å¦æ˜¯ Scalar (å®ƒè¿˜èƒ½åŒ…å« Array Table RecordBatch ChunkedArray ä¹‹ç±»çš„)</li><li>å¯¹äº FieldRefï¼Œè¿™é‡Œâ€¦å•¥éƒ½è¡Œï¼</li><li><code>Call</code>: all argument <code>IsScalar</code>, and function type is <code>SCALAR</code>.</li></ol></li></ol><h2 id="FieldRef-and-Parameter"><a href="#FieldRef-and-Parameter" class="headerlink" title="FieldRef and Parameter"></a>FieldRef and Parameter</h2><p><code>FieldRef</code> æ˜¯ä¸ªå¾ˆå¥‡æ€ªçš„ä¸œè¥¿ï¼Œè¡¨ç¤ºå¯¹æŸä¸ª Field çš„å¼•ç”¨ï¼Œå®ƒæœ¬èº«ä¹Ÿå¯ä»¥æ˜¯ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// Unlike FieldPath (which exclusively uses indices of child fields), FieldRef may</span></span><br><span class="line"><span class="comment">/// reference a field by name. It is intended to replace parameters like `int field_index`</span></span><br><span class="line"><span class="comment">/// and `const std::string&amp; field_name`; it can be implicitly constructed from either a</span></span><br><span class="line"><span class="comment">/// field index or a name.</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// Nested fields can be referenced as well. Given</span></span><br><span class="line"><span class="comment">///     schema(&#123;field(&quot;a&quot;, struct_(&#123;field(&quot;n&quot;, null())&#125;)), field(&quot;b&quot;, int32())&#125;)</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// the following all indicate the nested field named &quot;n&quot;:</span></span><br><span class="line"><span class="comment">///     FieldRef ref1(0, 0);</span></span><br><span class="line"><span class="comment">///     FieldRef ref2(&quot;a&quot;, 0);</span></span><br><span class="line"><span class="comment">///     FieldRef ref3(&quot;a&quot;, &quot;n&quot;);</span></span><br><span class="line"><span class="comment">///     FieldRef ref4(0, &quot;n&quot;);</span></span><br><span class="line"><span class="comment">///     ARROW_ASSIGN_OR_RAISE(FieldRef ref5,</span></span><br><span class="line"><span class="comment">///                           FieldRef::FromDotPath(&quot;.a[0]&quot;));</span></span><br></pre></td></tr></table></figure><p>ä»–å¯ä»¥è¡¨ç¤ºçš„è·¯å¾„å¦‚ä¸Šæ‰€è¿°, è¿™é‡Œå¯ä»¥ç”¨åå­—è¡¨ç¤ºã€‚é‚£ä¹ˆå®é™…ä¸Šå†…éƒ¨ç”¨ <code>FieldPath</code> æ˜¯æœ€å¥½çš„ï¼Œä½†æ˜¯è¿™é‡Œ xjb ç³Šäº†ä¸€å¥—ï¼Œç”¨æˆ· Bind çš„æ—¶å€™è¦ä¼ ä¸ª Schema è¿›æ¥ï¼Œç„¶åç”¨è¿™ä¸ª Schema æ¥ Bindï¼ŒBind å®Œé‡Œé¢è¿˜æ˜¯åŸæ¥é‚£ä¸ª <code>&quot;a.b.c&quot;</code>ï¼Œåªæ˜¯ç»‘å®šäº†ä¸€äº›ç±»å‹ã€‚</p><p>åœ¨ Bind çš„æ—¶å€™ï¼Œæ³¨æ„åˆ°è¿™äº› Post Bindï¼Œç±»å‹æ˜¯åœ¨ Bind ä¹‹åç»‘å®šçš„ï¼ˆè¿˜æ˜¯ä¸ª <code>TypeHolder</code> å‘¢ï¼Œå‘µå‘µï¼‰</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">Parameter</span> &#123;</span><br><span class="line">  FieldRef ref;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// post-bind properties</span></span><br><span class="line">  TypeHolder type;</span><br><span class="line">  ::arrow::internal::SmallVector&lt;<span class="type">int</span>, <span class="number">2</span>&gt; indices;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h2 id="Call"><a href="#Call" class="headerlink" title="Call"></a>Call</h2><p>Call è¡¨ç¤ºä¸€ä¸ª fn call.</p><p>å¦‚æœæ˜¯ <code>Call</code>, è¿™é‡Œä¼šæœ‰å¯¹åº”çš„å‚æ•°ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">Call</span> &#123;</span><br><span class="line">  std::string function_name;</span><br><span class="line">  std::vector&lt;Expression&gt; arguments;</span><br><span class="line">  std::shared_ptr&lt;FunctionOptions&gt; options;</span><br><span class="line">  <span class="comment">// Cached hash value</span></span><br><span class="line">  <span class="type">size_t</span> hash;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// post-Bind properties:</span></span><br><span class="line">  std::shared_ptr&lt;Function&gt; function;</span><br><span class="line">  <span class="type">const</span> Kernel* kernel = NULLPTR;</span><br><span class="line">  std::shared_ptr&lt;KernelState&gt; kernel_state;</span><br><span class="line">  TypeHolder type;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">ComputeHash</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå¯ä»¥é€šè¿‡ <code>function</code> æ¥åˆ¤æ–­æ˜¯å¦åš bindingã€‚è¿™é‡Œçš„å«ä¹‰è¿˜æ˜¯æ¯”è¾ƒæ¸…æ™°çš„ï¼ŒExpression çš„ä¸»è¦å†…å®¹è¿˜æ˜¯åœ¨è¿™ä¸ªåœ°æ–¹åº”è¯¥æ˜¯æœ€é‡è¦çš„ä¸€ä¸ªç±»å‹ã€‚<code>+</code> <code>-</code> ä¹‹ç±»çš„ï¼Œæœ¬èº«æœ‰ <code>add</code> ä¹‹ç±»çš„ Function ( åœ¨ä¹‹å‰çš„ compute æ¨¡å—ä»‹ç»è¿‡ )ã€‚è€Œ <code>Expression</code> å±‚ä¼šç»„ç»‡æˆ:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Call(function_name=&quot;Add&quot;, arguments=&#123;field_ref(&quot;a.b&quot;), literal(1000)&#125;)</span><br></pre></td></tr></table></figure><p>è¿™æ ·çš„å½¢å¼ï¼Œåœ¨ <code>Bind</code> ä»¥åï¼Œè¿™é‡Œä¼šç»‘å®šåˆ° <code>Function</code> å’Œå¯¹åº”çš„ <code>kernel</code> æ‰§è¡Œå™¨ä¸Šã€‚</p><p>è¿™é‡Œè¿˜æä¾›äº† <code>and</code>, <code>or</code> ä¹‹ç±»çš„ä¸œè¥¿ç»™ç”¨æˆ·ï¼Œéå¸¸æœ‰æ„æ€:</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">ARROW_EXPORT Expression <span class="title">project</span><span class="params">(std::vector&lt;Expression&gt; values,</span></span></span><br><span class="line"><span class="params"><span class="function">                                std::vector&lt;std::string&gt; names)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function">ARROW_EXPORT Expression <span class="title">equal</span><span class="params">(Expression lhs, Expression rhs)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function">ARROW_EXPORT Expression <span class="title">not_equal</span><span class="params">(Expression lhs, Expression rhs)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function">ARROW_EXPORT Expression <span class="title">less</span><span class="params">(Expression lhs, Expression rhs)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function">ARROW_EXPORT Expression <span class="title">less_equal</span><span class="params">(Expression lhs, Expression rhs)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function">ARROW_EXPORT Expression <span class="title">greater</span><span class="params">(Expression lhs, Expression rhs)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function">ARROW_EXPORT Expression <span class="title">greater_equal</span><span class="params">(Expression lhs, Expression rhs)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function">ARROW_EXPORT Expression <span class="title">is_null</span><span class="params">(Expression lhs, <span class="type">bool</span> nan_is_null = <span class="literal">false</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function">ARROW_EXPORT Expression <span class="title">is_valid</span><span class="params">(Expression lhs)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function">ARROW_EXPORT Expression <span class="title">and_</span><span class="params">(Expression lhs, Expression rhs)</span></span>;</span><br><span class="line"><span class="function">ARROW_EXPORT Expression <span class="title">and_</span><span class="params">(<span class="type">const</span> std::vector&lt;Expression&gt;&amp;)</span></span>;</span><br><span class="line"><span class="function">ARROW_EXPORT Expression <span class="title">or_</span><span class="params">(Expression lhs, Expression rhs)</span></span>;</span><br><span class="line"><span class="function">ARROW_EXPORT Expression <span class="title">or_</span><span class="params">(<span class="type">const</span> std::vector&lt;Expression&gt;&amp;)</span></span>;</span><br><span class="line"><span class="function">ARROW_EXPORT Expression <span class="title">not_</span><span class="params">(Expression operand)</span></span>;</span><br></pre></td></tr></table></figure><p>æ¯”è¾ƒæœ‰æ„æ€çš„æ˜¯ <code>project</code>ï¼Œä¼šäº§ç”Ÿä¸€ä¸ªæ–°çš„ <code>struct</code> ç±»å‹ã€‚</p><h3 id="Bind"><a href="#Bind" class="headerlink" title="Bind"></a>Bind</h3><p>å¯¹ Expression çš„ Bind ä¼šæ¯”è¾ƒå¤æ‚. è¿™é‡Œå¯èƒ½åšçš„äº‹æƒ…æœ‰ï¼š</p><ol><li>Bind æ‰€æœ‰çš„å­æˆå‘˜ï¼Œç„¶åè¿›å…¥ <code>BindNonRecursive</code></li><li>æ‹¿åˆ°æ‰€æœ‰ arguments çš„ç±»å‹</li><li>æ ¹æ® Name å’Œå‚æ•°å»æ‰¾åˆ°å¯¹åº”çš„ <code>Function</code> , <code>Kernel</code>ï¼Œè¿™é‡Œå…ˆæ‰¾å®Œå…¨åŒ¹é…çš„ ï¼ˆ <code>`DispatchExact</code>ï¼‰<ol><li>å¦‚æœæ‰¾åˆ°æ­£å¥½åŒ¹é…çš„ï¼Œå°±ç”¨è¿™ä¸ª</li><li>å¦‚æœæœ‰ <code>insert_implicit_casts</code>ï¼Œå°±ä¼šå°è¯•ä¿®æ”¹ç±»å‹<ol><li>å¯¹äº Literalï¼Œæ‰¾åˆ° Literal çš„æœ€å°ç±»å‹ï¼ˆeg: å¦‚æœæ˜¯ <code>Datum(int32(8))</code>, å¯ä»¥æ”¹æˆ <code>Datum(int8(8))</code></li><li>å°è¯•å» <code>DispatchBest</code>ï¼Œç„¶åå¦‚æœæœ‰ä¸ä¸€æ ·çš„ï¼Œ<ol><li>å¦‚æœæ˜¯ <code>field_ref</code>ï¼Œç›´æ¥ç”¨ç›®æ ‡ç±»å‹</li><li>å¦‚æœæ˜¯ <code>field_ref</code> æˆ–è€… <code>call</code>ï¼Œæ’å…¥ä¸€ä¸ª Cast</li></ol></li></ol></li></ol></li><li>åˆå§‹åŒ– <code>KernelContext</code> å’Œ <code>KernelState</code></li></ol><h3 id="ä¼˜åŒ–"><a href="#ä¼˜åŒ–" class="headerlink" title="ä¼˜åŒ–"></a>ä¼˜åŒ–</h3><p>è¡¨è¾¾å¼çš„å¾ˆå¤§ä¸€éƒ¨åˆ†é€»è¾‘åœ¨äºå¯¹è¡¨è¾¾å¼è¿›è¡Œå¤„ç†ã€‚ä¸‹é¢åˆ—ä¸¾äº†ä¸€ç»„ç›¸å…³çš„ APIã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// Weak canonicalization which establishes guarantees for subsequent passes. Even</span></span><br><span class="line"><span class="comment">/// equivalent Expressions may result in different canonicalized expressions.</span></span><br><span class="line"><span class="comment">/// TODO this could be a strong canonicalization</span></span><br><span class="line"><span class="function">ARROW_EXPORT</span></span><br><span class="line"><span class="function">Result&lt;Expression&gt; <span class="title">Canonicalize</span><span class="params">(Expression, ExecContext* = NULLPTR)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// Simplify Expressions based on literal arguments (for example, add(null, x) will always</span></span><br><span class="line"><span class="comment">/// be null so replace the call with a null literal). Includes early evaluation of all</span></span><br><span class="line"><span class="comment">/// calls whose arguments are entirely literal.</span></span><br><span class="line"><span class="function">ARROW_EXPORT</span></span><br><span class="line"><span class="function">Result&lt;Expression&gt; <span class="title">FoldConstants</span><span class="params">(Expression)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// Simplify Expressions by replacing with known values of the fields which it references.</span></span><br><span class="line"><span class="function">ARROW_EXPORT</span></span><br><span class="line"><span class="function">Result&lt;Expression&gt; <span class="title">ReplaceFieldsWithKnownValues</span><span class="params">(<span class="type">const</span> KnownFieldValues&amp; known_values,</span></span></span><br><span class="line"><span class="params"><span class="function">                                                Expression)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// Simplify an expression by replacing subexpressions based on a guarantee:</span></span><br><span class="line"><span class="comment">/// a boolean expression which is guaranteed to evaluate to `true`. For example, this is</span></span><br><span class="line"><span class="comment">/// used to remove redundant function calls from a filter expression or to replace a</span></span><br><span class="line"><span class="comment">/// reference to a constant-value field with a literal.</span></span><br><span class="line"><span class="function">ARROW_EXPORT</span></span><br><span class="line"><span class="function">Result&lt;Expression&gt; <span class="title">SimplifyWithGuarantee</span><span class="params">(Expression,</span></span></span><br><span class="line"><span class="params"><span class="function">                                         <span class="type">const</span> Expression&amp; guaranteed_true_predicate)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// Replace all named field refs (e.g. &quot;x&quot; or &quot;x.y&quot;) with field paths (e.g. [0] or [1,3])</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// This isn&#x27;t usually needed and does not offer any simplification by itself.  However,</span></span><br><span class="line"><span class="comment">/// it can be useful to normalize an expression to paths to make it simpler to work with.</span></span><br><span class="line"><span class="function">ARROW_EXPORT Result&lt;Expression&gt; <span class="title">RemoveNamedRefs</span><span class="params">(Expression expression)</span></span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="tools"><a href="#tools" class="headerlink" title="tools"></a>tools</h4><p><code>arrow/compute/util.h</code> ç­‰åœ°æ–¹æä¾›äº†ä¸€ç»„é è°±çš„å·¥å…·ï¼Œæœ€å…¸å‹çš„æ˜¯ä¸€ä¸ª tree visitor:</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// Modify an Expression with pre-order and post-order visitation.</span></span><br><span class="line"><span class="comment">/// `pre` will be invoked on each Expression. `pre` will visit Calls before their</span></span><br><span class="line"><span class="comment">/// arguments, `post_call` will visit Calls (and no other Expressions) after their</span></span><br><span class="line"><span class="comment">/// arguments. Visitors should return the Identical expression to indicate no change; this</span></span><br><span class="line"><span class="comment">/// will prevent unnecessary construction in the common case where a modification is not</span></span><br><span class="line"><span class="comment">/// possible/necessary/...</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// If an argument was modified, `post_call` visits a reconstructed Call with the modified</span></span><br><span class="line"><span class="comment">/// arguments but also receives a pointer to the unmodified Expression as a second</span></span><br><span class="line"><span class="comment">/// argument. If no arguments were modified the unmodified Expression* will be nullptr.</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> PreVisit, <span class="keyword">typename</span> PostVisitCall&gt;</span><br><span class="line"><span class="function">Result&lt;Expression&gt; <span class="title">ModifyExpression</span><span class="params">(Expression expr, <span class="type">const</span> PreVisit&amp; pre,</span></span></span><br><span class="line"><span class="params"><span class="function">                                    <span class="type">const</span> PostVisitCall&amp; post_call)</span></span>;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªèƒ½å¤Ÿè¢«ç”¨æ¥æ‰« + æ›´æ–°æ•´ä¸ª tree.</p><h4 id="Canonicalize"><a href="#Canonicalize" class="headerlink" title="Canonicalize"></a>Canonicalize</h4><p>å°è¯•æŠŠè¡¨è¾¾å¼å¤„ç†æˆé•¿å¾—å·®ä¸å¤šçš„æƒ…å†µã€‚</p><p>e.g: å¯¹<strong>åŒæ ·çš„</strong>å¯äº¤æ¢æ“ä½œçš„å¤„ç†</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">((a + b) + 2) + 3</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå‘ç°æ˜¯åŒæ ·çš„æ“ä½œï¼Œå°±ä¼šå°è¯•æ•´ç†ï¼Œç„¶ååšæˆä¾¿äº constant folding çš„å½¢å¼ã€‚è¿™é‡Œä¹Ÿä¼šæœ‰ <code>field_ref</code>, <code>literal</code> , <code>null literal</code> ä½ç½®çš„å…³ç³»ã€‚</p><p>e.g.: å¯¹æ¯”è¾ƒçš„å¤„ç†</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">a &gt; 3</span><br><span class="line">3 &lt; a</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä¼šè¢«å¤„ç†æˆä¸€æ ·çš„å½¢å¼ã€‚</p><h3 id="Others"><a href="#Others" class="headerlink" title="Others"></a>Others</h3><p>è¿™é‡Œè¿˜æœ‰ Constant Foldingï¼ŒæŠ½å‡º Key-Values ç­‰å½¢å¼ã€‚å…¶å®è¿™ä¸ªè¡¨è¾¾å¼ç›¸å¯¹æ¥è¯´è¿˜æ˜¯å¤ª trivial äº†ï¼Œåšä¸ªå…¥é—¨è¿˜è¡Œï¼Œéš¾ä¸€ç‚¹è¿˜æ˜¯åˆ«çœ‹è¿™ä¸ªäº†ã€‚</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>schedule: Mesos</title>
      <link href="/2023/07/01/schedule-Mesos-and-Yarn/"/>
      <url>/2023/07/01/schedule-Mesos-and-Yarn/</url>
      
        <content type="html"><![CDATA[<p>åœ¨ä¹‹å‰åšå®¢ä¸­ï¼Œæˆ‘ä»¬ä»‹ç»äº† MapReduce å’Œ Spark çš„æ¡†æ¶ï¼Œè¿™ä¸¤ä¸ªçš„ç¨‹åºç±»å‹éƒ½æ˜¯ Batch Jobï¼Œbatch job è¿™é‡Œä¼šè¢«åˆ†é…åˆ°å¯¹åº”çš„æœºå™¨ä¸Šï¼Œç”±ä¸€ä¸ªç±»ä¼¼ master çš„èŠ‚ç‚¹æ¥è°ƒåº¦æˆ–è€…ç›‘æ§å®ƒçš„æ‰§è¡Œã€‚</p><p>å¯¹äºå°çš„ä»»åŠ¡æ¥è¯´ï¼Œç»†ç²’åº¦çš„è°ƒåº¦æ˜¯æ¯”è¾ƒéš¾æ§åˆ¶çš„ï¼Œä»ä¸€äº› Morsel Driven çš„è°ƒåº¦åˆ° Scylladb å’Œ RocksDB çš„ä¸€äº›ä¾‹å­ï¼Œçœ‹ç€éƒ½å¾ˆéš¾ï¼Œè€Œä¸”æ™ºèƒ½æ˜¯åœ¨è´Ÿè½½ä¸Šã€æ ¸å¿ƒæˆ–è€…çº¿ç¨‹æ± ä¸Šåˆ‡åˆ†ï¼Œåšä¸€äº›ç»†ç²’åº¦çš„è°ƒåº¦ï¼ŒOS ä¸‹é¢ä¹Ÿæœ‰ä¸€äº›è°ƒåº¦ç›¸å…³çš„ï¼Œæ¯”å¦‚éå¸¸ç»å…¸çš„ CFS è°ƒåº¦ã€‚å¯¹äº Batch Job æ¥è¯´ï¼Œé—®é¢˜å…¶å®æœ‰é‚£ä¹ˆç‚¹ç±»ä¼¼ OS ï¼ˆåŒ…æ‹¬åæ¥ Google å’Œ Meta çš„åœºæ™¯ï¼Œå¯èƒ½éƒ½ç±»ä¼¼ä¸€ä¸ªåˆ†å¸ƒå¼çš„ OSï¼Œå¯¹æ•°æ®ä¸­å¿ƒå¤§é‡æœºå™¨è¿›è¡Œé«˜æ•ˆçš„è°ƒåº¦å’Œåˆ†é…ï¼‰ã€‚è¿™é‡Œæœ‰ä¸€äº›åŒºåˆ«æ˜¯ï¼Œä»»åŠ¡å¯èƒ½ä¼šæœ‰ä¸€äº›å…ˆéªŒçš„é¢„æœŸä¹‹ç±»çš„ã€‚</p><p>æˆ‘ä»¬è®¨è®ºçš„ Mesos æ˜¯ä¸€äº›å¹³å°çš„å‰èº«ï¼Œä½†åŒæ—¶ï¼ŒMesos ä¹Ÿè¢«æçŒ®åˆ° Apache ä¸­ï¼Œå’Œ Yarn ç±»ä¼¼çš„ï¼Œå¹¿æ³›çš„è¿›è¡Œä¸€äº› Hadoop ç³» Batch Job ç”šè‡³å°ä¸€äº›çš„ä»»åŠ¡çš„è°ƒåº¦ï¼Œå¹¶ç®¡ç† MPIã€Hadoop ç­‰è®¡ç®—æ¡†æ¶ã€‚Mesos çš„è®ºæ–‡å‘è¡¨äº NSDIâ€™11ï¼Œå¯ä»¥çœ‹åˆ°è®ºæ–‡æ¯”è¾ƒæ—©ï¼Œè®ºæ–‡ä¸»è¦çš„ç‚¹åœ¨äºï¼š</p><ol><li>å‡ºç°çš„æ—¶å€™ï¼Œä¸»è¦å–ä»£çš„æ˜¯é™æ€åˆ†ç‰‡çš„é›†ç¾¤</li><li>2çº§è°ƒåº¦ï¼Œæ¥å…è®¸ç”¨æˆ·è‡ªå·±ç¼–å†™è°ƒåº¦æ¡†æ¶ï¼ŒMesos ç®¡ç†èµ„æºå’Œè°ƒåº¦æ¡†æ¶äº¤äº’ã€‚è¿™æ ·ä¸èƒ½ä¿è¯å…¨å±€æœ€ä¼˜çš„è°ƒåº¦ï¼Œä½†æ˜¯æä¾›äº† scability</li><li>åŸºäºä¸¤çº§è°ƒåº¦è®¾è®¡çš„ api<ol><li>æœ‰ä¸€äº›äº²å’Œåº¦ç”šè‡³æ˜¯å¿…è¦æ¡ä»¶æœ‰å…³çš„è€ƒé‡</li><li>èµ„æºé‡å¯¹äºåº”ç”¨/æ¡†æ¶ä¸å¤Ÿçš„æ—¶å€™ï¼Œæ€ä¹ˆå¤„ç†</li><li>ä»»åŠ¡æ˜¯å¦èƒ½å¤Ÿè¢« kill</li><li>å¯¹äºèµ„æºå æœ‰äº†ï¼Œä½†æ˜¯æ²¡è·‘èµ·æ¥è¿™ç§ä¼šæ­»é”çš„æƒ…å†µï¼Œæ€ä¹ˆå¤„ç†</li></ol></li><li>å®šä¹‰ä»»åŠ¡çš„å¹³å‡æ‰§è¡Œæ—¶é—´å’Œæ‰§è¡Œæ—¶é—´çš„åˆ†å¸ƒï¼ŒMesos çš„å¯¹åº”å¤„ç†</li></ol><p>è¿™é‡Œæˆ‘ä»¬ä¹Ÿ<strong>åªä»‹ç»ã€Œæ¡†æ¶ã€ç›¸å…³çš„ï¼Œå…¶å®å°½é‡é¿å…ä»‹ç»å…·ä½“çš„ç­–ç•¥</strong>ï¼Œæ„Ÿè§‰ç­–ç•¥è¦åˆ° queuing theory æˆ–è€… DRF çš„è®ºæ–‡å¯ä»¥ä»‹ç»ä¸€ä¸‹ã€‚</p><h2 id="ä¸¤çº§è°ƒåº¦"><a href="#ä¸¤çº§è°ƒåº¦" class="headerlink" title="ä¸¤çº§è°ƒåº¦"></a><strong>ä¸¤çº§è°ƒåº¦</strong></h2><p>éœ€æ±‚ï¼šHadoop, MPI ç­‰å¤šä¸ªé›†ç¾¤å…±äº«èµ„æºï¼Œè€Œæ¯éƒ¨åˆ†å¯èƒ½ä¼šæœ‰è‡ªå·±çš„è°ƒåº¦å™¨ã€‚æŠŠæ‰€æœ‰çš„è°ƒåº¦å™¨æ•´åˆåˆ°å…¨å±€åœ¨å·¥ç¨‹ä¸Šæ¯”è¾ƒé‡ï¼ˆå½“ç„¶ä¹Ÿå¯ä»¥ï¼Œä½†æ˜¯é‚£è¦æ±‚ä¸­å¿ƒåŒ–çš„è°ƒåº¦ + å¯èƒ½ä¼šæ¯”è¾ƒç²—ç³™çš„è°ƒåº¦ç®—æ³• + ä¸å¥½å¤ç”¨æ¡†æ¶è‡ªå·±çš„ä»£ç ï¼Œå› ä¸ºæ¯ä¸ªæ¡†æ¶å¯èƒ½å¯¹è°ƒåº¦çš„éœ€æ±‚ä¸ä¸€æ ·ï¼Œç„¶åäººå®¶å†™å•¥ä½ å†™å•¥ï¼Œå¦‚æœå¡é¡¿ä¸€ä¸‹æå¾— master å¡ä½äº†å°±æ›´æ˜¯ç¾éš¾äº†ï¼‰ã€‚æ­¤å¤–ï¼Œè¿™é‡Œéœ€æ±‚è¿˜æœ‰ HAã€‚</p><p>æ­¤å¤–ï¼Œå¯¹äºé‚£ç§åŒä¸€ç»„èµ„æºçš„å¤šä¸ªé›†ç¾¤ï¼ŒMesos ç”šè‡³èƒ½ç»™ä½ æ‹†ä¸¤ç»„ scheduler ç„¶åè‡ªå·±è·‘åœ¨ä¸Šå¤´ç®¡ï¼Œæä¾›äº†å¾ˆå¤šæ–¹ä¾¿æäº‹çš„æ–¹æ³•ã€‚</p><p>ç»¼ä¸Šï¼ŒMesos æ²¡æœ‰é€‰æ‹©ä¸­å¿ƒåŒ–çš„è°ƒåº¦ï¼Œè€Œæ˜¯é€‰æ‹©äº†ä¸¤çº§è°ƒåº¦ï¼š</p><p><img src="https://image.mwish.me/blog-image/7264590773996925814.png" alt="img"></p><p>è¿™é‡Œ Mesos å¯ä»¥ç»™è°ƒåº¦å™¨æä¾›èµ„æºï¼Œç„¶åè°ƒåº¦å™¨å†³å®šå…·ä½“ task çš„è¿è¡Œï¼Œè¿™ä¸­é—´æœ‰å¾ˆå¤šç»†èŠ‚ï¼šï¼Œä½†æ˜¯å¤§è‡´æ¡†æ¶å¦‚ä¸‹ï¼š</p><ol><li>Mesos å†³å®šæŠŠå¤šå°‘èµ„æºç»™ç”¨æˆ·(resource offer)</li><li>è°ƒåº¦å™¨å¯ä»¥æ‹’ç»è¿™äº›èµ„æºæˆ–è€…å¼€è·‘ï¼Œå…³åˆ‡è¿™é‡Œçš„å…·ä½“è°ƒåº¦</li></ol><h3 id="æ¶æ„å’Œä¾‹å­"><a href="#æ¶æ„å’Œä¾‹å­" class="headerlink" title="æ¶æ„å’Œä¾‹å­"></a><strong>æ¶æ„å’Œä¾‹å­</strong></h3><p>Mesos çš„æ¶æ„å¦‚ Figure 2ï¼Œä¸‹é¢æ˜¯ä¸ªè®ºæ–‡çš„çš„ Mesos ä¾‹å­ï¼š</p><p><img src="https://image.mwish.me/blog-image/3859067561288897201.png" alt="img"></p><p>Mesos ä¼šè¿è¡Œï¼š</p><ul><li>Executor: æ‰¿è½½å…·ä½“çš„ Task çš„è¿è¡Œ</li><li>Scheduler: æ ¸å¿ƒçš„è°ƒåº¦å™¨ã€‚æœ¬èº«æ˜¯ä¸€ä¸ªè½»çŠ¶æ€ï¼Œä¼šæœ‰ backup å’Œ failover</li></ul><p>Figure3 å±•ç¤ºäº†å¯¹åº”çš„æµç¨‹ï¼š</p><ol><li>Slave 1: æ±‡æŠ¥è‡ªèº«çš„èµ„æº</li><li>Master 1: å†³å®šæä¾›ç»™ Framework 1ï¼Œç„¶åå‘Šè¯‰å®ƒå¯¹åº”çš„èµ„æºæè¿°</li><li>Framework 1: è°ƒåº¦åå‘ä¸¤ä¸ª Tasksï¼Œæ¯ä¸ª Task ä¹Ÿæœ‰å¯¹åº”çš„èµ„æºæè¿°</li><li>ä»»åŠ¡è¢«æ´¾å‘ç»™å¯¹åº”çš„ executor</li></ol><p>ï¼ˆè¿™é‡Œè€ƒè™‘åˆ°æœºåˆ¶ä¸Šè¿˜æœ‰ä»»åŠ¡çš„ ritï¼Œfailover ä¹‹ç±»çš„é—®é¢˜ï¼Œä¸è¿‡æˆ‘æ„Ÿè§‰ï¼Œå› ä¸ºå¤§éƒ¨åˆ†è®¡ç®—é‡å¤è®¡ç®—äº†ä¹Ÿæ²¡ä»€ä¹ˆé—®é¢˜ï¼Œç„¶åæœ¬èº« master æ˜¯ä¸ªå¼±çŠ¶æ€çš„èŠ‚ç‚¹ï¼Œæ‰€ä»¥è¿™å—ç›¸å¯¹å¯ä»¥æ¯” tp çš„ masterï¼Œæ¯”å¦‚ hbaseï¼Œ å¤„ç†çš„ç²—ç³™ä¸€äº›ï¼‰</p><p>é‚£ä¹ˆä¸Šé¢è¿™å¼ å›¾æ˜¯ä¸ªæœ€ç®€å•çš„æƒ…å†µï¼Œå®é™…ä¸Šæ˜¯æœ‰å¾ˆå¤šç»†èŠ‚çš„ï¼ŒåŒ…æ‹¬ corner case å’Œä¸‹é¢ä¸€äº›ä¿¡æ¯ï¼š</p><ul><li>ä¸ºäº†åœ¨æ¥å£ä¸Šæ¯”è¾ƒ cleanï¼Œæ¡†æ¶å¯ä»¥ Reject èµ„æºï¼Œæ¯”å¦‚è¯´ Mesos ç»™çš„èµ„æºä¸å¤Ÿçš„æ—¶å€™ Rejectã€ä¸æ»¡è¶³éœ€æ±‚ä¹Ÿå¯ä»¥ Rejectã€‚æœ¬èº«æä¾›äº†ä¸€ä¸ª Reject çš„å¯èƒ½ï¼Œç„¶åè¿™ä¸ªè¯·æ±‚æœ¬èº«è¦èµ°ä¸€è½® RPCï¼Œä¸ºäº†æå‰ä¼˜åŒ–æ‰ RPCï¼Œæ¡†æ¶å¯ä»¥ç¼–å†™ Filterï¼Œè®© Mesos Scheduler æµ‹æå‰è¿‡æ»¤ï¼ŒåŒ…æ‹¬è®¾ç½® ip ç™½åå•è¿™ç§æ“ä½œ<ul><li>Mesos è®¤ä¸º Filter ä¸æ˜¯å¿…é¡»çš„ï¼Œåªæ˜¯èŠ‚çœ rpcï¼Œå½“å¾ˆå¤šå°çš„ task çš„æ—¶å€™ï¼Œç›´æ¥ delay scheduling (æ”’ç€ä¸€äº› slave ä¿¡æ¯å†å‘ï¼‰çš„æ•ˆæœè´¼å¥½ï¼Œè¿™ç§æƒ…å†µä¸‹æ²¡ Filter æ€§èƒ½ä¹Ÿä¸é”™</li><li>Mesos åœ¨è®ºæ–‡å†™ä½œçš„æ—¶å€™æ”¯æŒä¸¤ç§ filter:<ul><li>åªæ”¯æŒ Set ä¸­çš„ Executor èŠ‚ç‚¹</li><li>æä¾›æ”¯æ´çš„æ—¶å€™ï¼Œè‡³å°‘éœ€è¦ R çš„èµ„æº</li><li>åŸåˆ™ä¸Šï¼Œå…¶ä»– Filter ä¹Ÿèƒ½æ”¯æŒï¼ˆrnmï¼Œé‚£ä½ è¿˜å†™è¿™ä¹ˆå¤šï¼Ÿï¼‰</li></ul></li></ul></li><li>åœ¨å†™è¿™ç¯‡è®ºæ–‡çš„æ—¶å€™ï¼ŒScheduler çš„è°ƒåº¦ç®—æ³•æ˜¯ min-max fair sharing çš„è°ƒåº¦ï¼Œå½“ç„¶ä¸€æ®µæ—¶é—´ä¹‹åï¼Œä»–ä»¬å°±æäº† DRF. å¦‚æœéƒ½æ˜¯çŸ­ä½œä¸šï¼Œç„¶åä¸€ä¸ª 10% share çš„æ¡†æ¶å¯èƒ½éœ€è¦ç­‰å¾… 10% çš„æ‰§è¡Œæ—¶é—´ï¼Œä½†æ˜¯å¦‚æœæœ‰ä¸€äº›å¤§ taskï¼Œè¿™é‡Œè°ƒåº¦ä¼šå—åˆ°ä¸€äº›å½±å“ã€‚Mesos å…è®¸ revoke(kill) å¯¹åº”çš„ taskï¼Œç„¶åç»™åº”ç”¨ä¸€ä¸ª grace period æ¥æ¸…æ¥šå¯¹åº”çš„ taskã€‚å½“ç„¶æœ‰ä¸€äº› Jobï¼Œæ¯”å¦‚ MPI è¿™ç§ dependency æ¯”è¾ƒå¤æ‚çš„ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ guaranteed allocation æ¥<strong>ç”³è¯·ä¸€å®šçš„èµ„æº</strong>ï¼Œè¿™ç§æƒ…å†µä¸‹ï¼Œåœ¨è¿™ä¸ªæ¡†æ¶ç”³è¯·çš„èµ„æºåœ¨ guaranteed allocation ä¹‹ä¸‹çš„æ—¶å€™ï¼ŒMesos å¯èƒ½å°±ä¸å¤ªä¼šå» kill å®ƒäº†ï¼ˆå¯ä»¥çœ‹ä½œæ˜¯ä¸€ä¸ªä½æ°´ä½ï¼‰</li><li>è®ºæ–‡å†™ä½œçš„æ—¶å€™ï¼Œisolation è¿˜æ²¡å•¥å¥½çš„æœºåˆ¶ï¼Œæ è¿‡ä¸è®²ã€‚</li><li>åœ¨ç”³è¯·èµ„æºçš„æ—¶å€™ï¼Œå›åˆ°ä¸Šè¿°æ­¥éª¤ï¼Œè¿™é‡Œåœ¨ (3) Scheduler æ”¶åˆ°æ¡†æ¶ä¿¡æ¯çš„æ—¶å€™ï¼ŒMesos æ‰ä¼šæŠŠèµ„æºå ç”¨è®¡ç®—ç»™å®ƒï¼ˆæ„Ÿè§‰è¿™ä¸ªåœ¨å¤„ç†æŒ‚æ‰çš„ Framework çš„æ—¶å€™æœ‰ä¸€ç‚¹ä¹è§‚ï¼Œå¯èƒ½æç«¯æƒ…å†µèµ„æºä¼šå‘å‡ºå»å‡ ä»½ï¼Ÿè™½ç„¶æˆ‘è§‰å¾—è®¡ç®—å±‚é¢æŒ‚æ‰é—®é¢˜ä¸ä¸¥é‡ï¼Œä¸è¿‡è·¨å‡ ä¸ªç³»ç»Ÿå¤„ç†é—®é¢˜ç»ˆå½’æœ‰äº›éº»çƒ¦ï¼‰ã€‚å®é™…ä¸Šå¦‚æœæ¡†æ¶å¾ˆä¹…ä¸è¿”å›ï¼ŒMesos ä¼š rescind å›æ”¶ç›¸å…³çš„èµ„æºï¼Œç„¶åå…è®¸æŠŠè¿™äº›èµ„æºè°ƒåº¦ç»™åˆ«çš„æ¡†æ¶ï¼‰</li><li>å…³äº Failover:<ul><li>å¦‚æœ Mesos Master fail äº†ï¼Œé‚£ä¹ˆå…è®¸æ‹‰èµ·ã€‚è¿™é‡Œè¿˜è¿è¡Œäº†ä¸€ä¸ª zk</li><li>å¦‚æœ Mesos Executor æŒ‚äº†æˆ–è€…ä»»åŠ¡ crash äº†ï¼Œå¯ä»¥äº¤ç»™ Framework å¤„ç†</li><li>å¦‚æœ Framework æŒ‚äº†ï¼ŒMesos å…è®¸ç”¨æˆ·åœ¨ Framework æµ‹æ³¨å†Œä¸€ç»„ï¼Œå…è®¸ä»é¡¶ä¸Šå»</li></ul></li></ul><p><img src="https://image.mwish.me/blog-image/2418121716793468253.png" alt="img"></p><p>è¿™é‡Œ Scheduler Callback æ˜¯ç”¨æˆ·è°ƒåº¦å™¨ï¼ŒExecutor æ˜¯å¯¹åº”çš„æ‰§è¡Œå™¨ã€‚Callback æ˜¯è¢« Mesos æ‰§è¡Œçš„æ“ä½œï¼ŒAction æ˜¯ä¸»åŠ¨å¯¹ Mesos æ‰§è¡Œçš„æ“ä½œã€‚</p><h2 id="Mesos-çš„è¡Œä¸ºå’Œä¼˜åŒ–"><a href="#Mesos-çš„è¡Œä¸ºå’Œä¼˜åŒ–" class="headerlink" title="Mesos çš„è¡Œä¸ºå’Œä¼˜åŒ–"></a>Mesos çš„è¡Œä¸ºå’Œä¼˜åŒ–</h2><p>è¿™é‡Œå¯¹ Mesos çš„è¡Œä¸ºè¿›è¡Œäº†å»ºæ¨¡ï¼š</p><ul><li>Framework ramp-up time: ä¸€ä¸ª framework è°ƒåº¦åˆ° task çš„æ—¶é—´</li><li>Job completion time: one-job per framework çš„æƒ…å†µä¸‹çš„è°ƒåº¦æ—¶é—´</li><li>System utilization: é›†ç¾¤åˆ©ç”¨ç‡</li></ul><p>è¿™é‡Œè€ƒè™‘åˆ°çš„è°ƒåº¦å’Œè®¡ç®—ä»»åŠ¡ç›¸å…³çš„ä¸€äº›æ€§è´¨ï¼š</p><ul><li>Elastic: æ˜¯å¦å’Œ MapReduce / Dryad è¿™æ ·èƒ½è°ƒæ•´å¯¹åº”çš„å¹¶å‘ã€‚è¿™å¹¶ä¸æ˜¯è¯´è°ƒæ•´ä»»åŠ¡ dop è¿™ç§ï¼Œè€Œæ˜¯è¯´å¯èƒ½å¯ä»¥åˆ†å¼€æ¥ task å®Œäº†å°±åœæ­¢äº†ï¼Œæ¯”å¦‚å¯¹åº”çš„ MPI å°±ä¸èƒ½ç›´æ¥å…·å¤‡è¿™ä¸ªèƒ½åŠ›(rigid)</li><li>å¯¹èµ„æºè¦æ±‚çš„ mandatory æˆ–è€… preferred<ul><li>Mandatory: å¼ºåˆ¶çš„è¦æ±‚ï¼Œæ¯”å¦‚è¦åœ¨æœ‰ GPU çš„æœºå™¨ä¸Šæ‰§è¡Œ</li><li>Preferred: è¦æ±‚ï¼Œåªæ˜¯è°ƒåº¦äº²å’Œæ€§è¿™ç§é€»è¾‘ã€‚</li></ul></li><li>æš‚æ—¶å‡è®¾ mandatory resources ä¸ä¼šè¶…è¿‡ guaranteed shareï¼Œé˜²æ­¢å‡ºç°æ­»é”çš„æƒ…å†µï¼ˆTBD: è¯è¯´ä¸€èˆ¬çš„è°ƒåº¦æ¡†æ¶æ˜¯æ€ä¹ˆå¤„ç†æ­»é”çš„å‘¢ï¼Ÿï¼‰</li><li>æš‚æ—¶åˆ†æˆ slot-based çš„ min-max share</li></ul><h3 id="Homogeneous-Tasks"><a href="#Homogeneous-Tasks" class="headerlink" title="Homogeneous Tasks"></a>Homogeneous Tasks</h3><blockquote><p>We consider a cluster with <strong>n</strong> slots and a framework, f, that is entitled to <strong>k</strong> slots. For the purpose of this analysis, we consider two distributions of the task durations: constant (i.e., all tasks have the same length) and exponential. Let the mean task duration be <strong>T,</strong> and assume that framework f runs a job which requires Î²kT total computation time. That is, when the framework has k slots, it takes its job Î²T time to ï¬nish.</p></blockquote><p><img src="https://image.mwish.me/blog-image/8249790567283055499.png" alt="img"></p><ul><li>å¯¹äº Ramp-up time, å¦‚æœåˆ†å¸ƒæ˜¯ constantï¼Œé‚£ä¹ˆ T çš„æ—¶é—´åŸºæœ¬ä¸Šéƒ½ä¼šè°ƒåº¦åˆ°ã€‚å¦‚æœæ˜¯æŒ‡æ•°åˆ†å¸ƒçš„ï¼Œé‚£ä¹ˆå¯èƒ½ä¼šæœ‰ Tlnk çš„æœŸæœ›æ—¶é—´.</li><li>å¯¹äº Job completion time, Elastic è¿™é‡Œæ¯”è¾ƒç®€å•ï¼ŒRigid é‡Œé¢è¦æ‹¿åˆ°æ‰€æœ‰èµ„æºæ‰èƒ½å¼€å§‹</li><li>åˆ©ç”¨ç‡åŒä¸Š</li></ul><h3 id="Preference"><a href="#Preference" class="headerlink" title="Preference"></a>Preference</h3><p>åœ¨å¼•å…¥ Perference çš„æ—¶å€™ï¼Œå†…å®¹ä¼šå‘ç”Ÿä¸€äº›æ”¹å˜ã€‚å½“æ¯é›†ç¾¤ prefer éƒ½å¤Ÿç”¨çš„æ—¶å€™è‚¯å®šæ²¡é—®é¢˜ï¼Œå‡ºç°æŠ¢å çš„æ—¶å€™ï¼Œè¿™é‡Œå¯èƒ½ä¼šç”¨ç±»ä¼¼å½©ç¥¨è°ƒåº¦çš„æ–¹å¼æ¥åˆ†é…ã€‚</p><h3 id="Heterogeneous-Tasks"><a href="#Heterogeneous-Tasks" class="headerlink" title="Heterogeneous Tasks"></a>Heterogeneous Tasks</h3><p>è¿™é‡Œä¸»è¦æŒ‡çš„æ˜¯å¤§ task å’Œ å° task éƒ½æœ‰çš„åœºæ™¯ã€‚</p><blockquote><p>Such heterogeneous workloads can hurt frameworks with short tasks. In the worst case, all nodes required by a short job might be ï¬lled with long tasks, so the job may need to wait a long time (relative to its execution time) to acquire resources.</p><p>In particular, we can associate a maximum task duration with some of the resources on each node, after which tasks running on those resources are killed. These time limits can be exposed to the frameworks in resource offers, allowing them to choose whether to use these resources. This scheme is similar to the common policy of having a separate queue for short jobs in HPC clusters.</p></blockquote><h2 id="References"><a href="#References" class="headerlink" title="References"></a><strong>References</strong></h2><ol><li>é›†ç¾¤è°ƒåº¦ç³»ç»Ÿçš„æ¼”è¿› - é‚µæ˜å²çš„æ–‡ç«  - çŸ¥ä¹ <a href="https://zhuanlan.zhihu.com/p/51790388">https://zhuanlan.zhihu.com/p/51790388</a></li><li>å·ç§°äº†è§£mesosåŒå±‚è°ƒåº¦çš„ä½ ï¼Œå…ˆæ¥å›ç­”ä¸‹é¢è¿™äº”ä¸ªé—®é¢˜ï¼ - ç½‘æ˜“æ•°å¸†çš„æ–‡ç«  - çŸ¥ä¹ <a href="https://zhuanlan.zhihu.com/p/49429953">https://zhuanlan.zhihu.com/p/49429953</a></li><li>è®©ä½ å½»åº•ææ˜ç™½YARNèµ„æºåˆ†é… - æ–œæ ä»£ç æ—¥è®°çš„æ–‡ç«  - çŸ¥ä¹ <a href="https://zhuanlan.zhihu.com/p/335881182">https://zhuanlan.zhihu.com/p/335881182</a></li><li>ä¹…ç»æ²™åœºçš„é›†ç¾¤ç®¡ç†ç³»ç»Ÿè°ƒç ”ï¼šBorg, Twine, Protean, Mesos, YARN and K8S - Peterçš„æ–‡ç«  - çŸ¥ä¹ <a href="https://zhuanlan.zhihu.com/p/388355341">https://zhuanlan.zhihu.com/p/388355341</a></li><li>Hadoop YARNï¼šè°ƒåº¦æ€§èƒ½ä¼˜åŒ–å®è·µ - ç¾å›¢æŠ€æœ¯å›¢é˜Ÿçš„æ–‡ç«  - çŸ¥ä¹ <a href="https://zhuanlan.zhihu.com/p/76697106">https://zhuanlan.zhihu.com/p/76697106</a></li><li><a href="https://draveness.me/papers-mesos/">https://draveness.me/papers-mesos/</a></li><li><a href="https://draveness.me/system-design-scheduler/">https://draveness.me/system-design-scheduler/</a></li><li><a href="https://blog.mwish.me/2022/05/29/Scheduling-Blog-Overview/">https://blog.mwish.me/2022/05/29/Scheduling-Blog-Overview/</a></li></ol>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Snowflake: Streaming and Change in Table</title>
      <link href="/2023/06/22/Snowflake-Streaming-and-Change-in-Table/"/>
      <url>/2023/06/22/Snowflake-Streaming-and-Change-in-Table/</url>
      
        <content type="html"><![CDATA[<p>Whatâ€™s the Difference? Incremental Processing with Change Queries in Snowflake æ˜¯å‘è¡¨åœ¨ SIGMODâ€™23 ä¸Šçš„è®ºæ–‡ã€‚æè¿°äº† Snowflake å†…éƒ¨çš„å¢é‡è®¡ç®—åœºæ™¯ã€‚è¿™ä¸ªéƒ¨åˆ†æœ‰ç‚¹ç±»ä¼¼ Streaming æˆ–è€…è¯´ä»€ä¹ˆï¼ŒSnowflake å¯ä»¥åœ¨è¡¨æˆ–è€… MV çš„å¯¹è±¡ä¸Šå¼€å¯ <code>STREAM</code>ï¼Œ Stream å†…ä¼šåŒ…å« Snowflake äº§ç”Ÿçš„ç±»ä¼¼ CDC çš„æ•°æ® <code>CHANGES</code>ï¼Œç„¶åï¼ŒSnowflake æœ¬èº«èƒ½å¤Ÿæ ¹æ® Time Travel çš„åŠŸèƒ½æ¥è·‘å‡º <code>STREAM</code> ä¸Šçš„ <code>CHANGES</code>ï¼Œä¸‹æ¸¸ä¼šæ¶ˆè´¹è¿™ä¸ª <code>CHANGES</code>ï¼Œæ¥ç”¨å¢é‡æ„å»º diffã€‚Snowflake å£°ç§°è¿™å¥—ä»£ç å·²ç»è·‘ä¸‰å¹´äº†ï¼Œå¦å¤–ï¼Œè¿™å¥—è®ºæ–‡çš„ç¬¬ä¸€ä½œè€…æ˜¯ MillWheel çš„ä½œè€…ã€‚ä»€ä¹ˆåˆ˜å¼å®¶æ—ã€‚</p><p>Streaming System å’Œ Batch çš„å¤§ä¹±æ–—æœ‰æ‚ ä¹…çš„å†å²äº†ï¼Œä½œè€…è®¤ä¸ºè¿™å…¶ä¸­çš„åŒºåˆ«åœ¨äºï¼š</p><ul><li>Batch éœ€è¦å¤„ç†æ•´å¥—è¾“å…¥æ¥äº§ç”Ÿè¾“å‡º</li><li><p>Streaming å¤„ç†çš„æ˜¯ã€Œå¢é‡ã€</p><p>* å¯èƒ½ä¼šåšä¸€ä¸ª Partitionï¼Œå•ä¸ª key çš„å¤„ç†åœ¨ Partition å†…æ˜¯æŒ‰è¡Œæ“ä½œã€åºåˆ—åŒ–çš„</p></li></ul><p>Snowflake åšäº†ä¸‹é¢çš„æ¦‚å¿µåŒºåˆ†ï¼š</p><ul><li>Tables: æ¯ä¸ªæ—¶é—´ç‚¹å†…ï¼Œè¡¨çš„å®Œæ•´çŠ¶æ€</li><li>Stream: changes to a dataset over time, è¡¨ç¤º Tables ä¸Šå‘ç”Ÿçš„ã€Œå˜æ›´ã€ï¼ˆç±»ä¼¼ Redo Log æµï¼Ÿä½†æ˜¯æ˜¯æ›´ä¸Šå±‚çš„æ¦‚å¿µï¼‰</li></ul><p>Snowflake å€¾å‘äºã€Œç”¨æˆ·å¯ä»¥ç›´æ¥æŸ¥è¯¢ CHANGESã€çš„æ–¹å¼ï¼Œå¹¶ä¸”è®¤ä¸ºæœ‰è¿™æ ·çš„ Usecases:</p><ul><li>Event Queuing: ç»™ SQL ä¸€ä¸ª message queue çš„è¯­ä¹‰</li><li>Notifications: è®ºæ–‡è®¤ä¸ºæ¶ˆè´¹ <code>CHANGES</code> è¡¨ï¼Œç›¸å¯¹æ¥è¯´èµ„æºå¼€é”€ä¼šå°å¾ˆå¤š</li><li><strong>Incremental View Maintenance(IVM)</strong>: ç»™ä¸Šå±‚å®ç°å¢é‡ MV ç»´æŠ¤æä¾›æ¯”è¾ƒå¥½çš„å·¥å…·</li><li>Flexible Change transformation: æ¶ˆè´¹ CHANGES çš„æ—¶å€™ï¼Œæœ‰çš„ç”¨æˆ·åªå…³æ³¨ä¸€éƒ¨åˆ†ï¼Œå¹¶ä¸”è¿™ç§ CHANGES èµ° SQL çš„è¯ä¹Ÿç®—æœ‰ä¼˜åŠ¿</li></ul><p>Snowflake æä¾›äº†ä¸‹é¢çš„è¯­ä¹‰ï¼š</p><ul><li>CHANGESï¼šå¯¹è¡¨æˆ–è€…å¢é‡ mv çš„å˜æ›´</li><li>STREAM: å¯¹è¡¨æˆ–è€…å¢é‡ mv çš„å˜æ›´æµï¼ŒåŒ…å«å¾ˆå¤š CHANGES å’Œæ—¶é—´æˆ³ï¼Œéœ€è¦æ¶ˆè´¹æ¥æ¨è¿›ã€‚</li></ul><h2 id="Semantics"><a href="#Semantics" class="headerlink" title="Semantics"></a>Semantics</h2><p>Snowflake æŠŠè¡¨æ„å»ºä¸ºä¸€ä¸ª TVR æ¨¡å‹(time-varying relations), å¹¶æ„å»ºäº†ä¸€ä¸ª Table + Redo Log çš„æ¨¡å‹ï¼Œ<strong>æ¥æ•è· SQL ä¸­å‘ç”Ÿçš„ INSERT, UPDATE, DELETE æ“ä½œ</strong>ã€‚åœ¨è¿™é‡Œï¼ŒSnowflake å…ˆæŠ½è±¡æˆäº† Delete + Insert çš„æ¨¡å‹ã€‚ä¸‹é¢æ˜¯è®ºæ–‡ä¸­ç”¨åˆ°çš„ SQL å’Œæ—¶åºï¼Œåé¢ä¼šä¸æ–­å›æ¥çœ‹è¿™ä¸ªçš„ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">12</span>:<span class="number">00</span>&gt; SELECT * FROM people;</span><br><span class="line">+----+-------+</span><br><span class="line">| id | name  |</span><br><span class="line">+----+-------+</span><br><span class="line">| <span class="number">1</span>  | Jeff  | </span><br><span class="line">| <span class="number">2</span>  | Donny |</span><br><span class="line">+----+-------+</span><br><span class="line"></span><br><span class="line">(Listing <span class="number">1</span>. Example table with two rows)</span><br></pre></td></tr></table></figure><p>ä¸‹é¢æ˜¯è®ºæ–‡ä¸­çš„æ“ä½œåºåˆ—ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">12</span>:<span class="number">01</span>&gt; INSERT INTO people <span class="title function_ invoke__">VALUES</span> (<span class="number">3</span>, <span class="symbol">&#x27;Walter</span>&#x27;), (<span class="number">4</span>, <span class="symbol">&#x27;Maud</span>&#x27;), (<span class="number">5</span>, <span class="symbol">&#x27;Uli</span>&#x27;);</span><br><span class="line"></span><br><span class="line"><span class="number">12</span>:<span class="number">02</span> &gt; UPDATE people SET name = <span class="symbol">&#x27;Jeffrey</span> &#x27; WHERE id = <span class="number">1</span>; </span><br><span class="line"><span class="number">12</span>:<span class="number">03</span> &gt; UPDATE people SET name = <span class="symbol">&#x27;Maude</span> &#x27; WHERE id = <span class="number">4</span>;</span><br><span class="line"><span class="number">12</span>:<span class="number">04</span> &gt; DELETE FROM people WHERE id <span class="title function_ invoke__">in</span> (<span class="number">2</span>, <span class="number">5</span>); </span><br><span class="line"></span><br><span class="line">(Listing <span class="number">2</span>. Mutations to the table from Listing <span class="number">1</span>)</span><br></pre></td></tr></table></figure><p>æŸ¥è¯¢ç»“æœæ˜¯ï¼š</p><p><img src="https://image.mwish.me/blog-image/2034055683243599966.png" alt="img"></p><p>é‚£ä¹ˆï¼Œè¿™é‡Œé€»è¾‘ä¸Šçš„ Redo Log å¦‚ä¸‹æ‰€ç¤ºï¼ˆè¿™å¹¶ä¸ä»£è¡¨æœ€ç»ˆäº§ç”Ÿçš„ CHANGESï¼‰ï¼š</p><p><img src="https://image.mwish.me/blog-image/2295336572436247647.png" alt="img"></p><p>è¿™ç§æŠ½è±¡å¯¹ Table æˆ–è€… MV éƒ½æœ‰ç”¨ï¼Œè¿˜æ˜¯æ¯”è¾ƒé€šç”¨çš„ï¼Œå½“ç„¶è¿™é‡Œå¯èƒ½æ˜¯è¯´ï¼Œ<strong>éœ€è¦åœ¨åˆ é™¤å’Œæ’å…¥çš„æ—¶å€™éƒ½å¸¦ä¸Šå®Œæ•´çš„è¡Œè®°å½•</strong>ï¼Œå¯¹äºå®½è¡¨æ¥è¯´è¿˜æ˜¯æœ‰ç‚¹å¤§çš„ã€‚ä¸è¿‡è¿™å¹´å¤´æˆ‘è¿˜æ˜¯è§‰å¾—ç®€å•å°±æ˜¯å¥½ï¼Œå¤§åŠ›å‡ºå¥‡è¿¹å°±è¡Œï¼Œä¼˜åŒ–ä»€ä¹ˆçš„ç­‰å®¢æˆ·æœ‰éœ€æ±‚å†è¯´å§ã€‚</p><h3 id="CHANGES-quries"><a href="#CHANGES-quries" class="headerlink" title="CHANGES quries"></a>CHANGES quries</h3><p>CHANGES query æ˜¯ snowflake çš„ä¸€ç§æŸ¥è¯¢ CHANGES çš„æŸ¥è¯¢ï¼Œæ”¯æŒ SQLã€‚Snowflake æ—©å°±æ”¯æŒäº† Time Travelï¼Œç”¨æˆ·å¯ä»¥æŒ‡å®š START å’Œ END çš„æ—¶é—´æˆ³ï¼Œå¦‚æœä¸æŒ‡å®š END å°±æ˜¯æŸ¥è¯¢ START åˆ°ç°åœ¨çš„æ•°æ®ï¼Œå½“ç„¶ï¼Œé™¤äº†æ—¶é—´æˆ³ï¼Œç”¨æˆ·è¿˜å¯ä»¥ä½¿ç”¨ <code>STREAM</code> å¯¹è±¡æ¥æŸ¥è¯¢ã€‚</p><p>å¦‚ä¹‹å‰ Listing 3 æ‰€æè¿°çš„ï¼Œåœ¨ CHANGES æŸ¥è¯¢çš„ç»“æœä¸­ï¼Œæœ‰ä¸€äº› metadata columnsï¼š</p><ul><li><code>$ACTION</code>: CHANGES æ˜¯ INSERT è¿˜æ˜¯ DELETE</li><li><code>$ISUPDATE</code>: å¯¹äº UPDATEï¼Œå®ƒåœ¨ CHANGES ä¸­ä¼šå˜æˆ INSERT + DELETE. åœ¨è¿™ç§åœºæ™¯ä¸‹ <code>$ISUPDATE = true</code></li><li><code>$ROW_ID</code>: è¿™ä¸ªå°±éå¸¸æœ‰æ„æ€äº†ã€‚è¡¨ç¤º Row çš„ Unique Idï¼Œåé¢ä¼šä»‹ç»è¿™ä¸ªå­—æ®µæ˜¯æ€ä¹ˆæ„æˆçš„</li></ul><p>å…¶å® (1) (3) è¿˜æ¯”è¾ƒå¥½ç†è§£ï¼ˆä½†æ˜¯éœ€è¦ç»†åˆ†ä¸€ä¸‹ ROW_ID æ˜¯æ€ä¹ˆæ„æˆçš„ï¼‰ï¼Œæ­¤å¤– Snowflake è¿˜æ”¯æŒæŸ¥è¯¢ <code>INFORMATION</code>ï¼Œè¡¨ç¤º <code>CHANGES</code> çš„å…ƒä¿¡æ¯ã€‚ä¸‹é¢ä»‹ç» Snowflake çš„åŒºåˆ†å¤„ç†æ–¹å¼ï¼ŒSnowflake ç›®å‰æ”¯æŒä¸¤ç§ CHANGES æ ¼å¼ï¼Œè¿™é‡Œéƒ½å¯ä»¥è¡¨ç¤ºä¸ºç±»ä¼¼ Redo Log çš„å½¢å¼ï¼š</p><ul><li>Append Only: è¡¨ç¤º<strong>æ•°æ®ç¬¬ä¸€æ¬¡æ’å…¥è¡¨</strong>çš„æ—¥å¿—ï¼Œå¯èƒ½æ¥è‡ª INSERT, Merge, COPY æˆ–è€… Snowpipe(file-based) / Snowpipe Streaming(row-based)ã€‚UPDATE/Truncate/Delete å…¶å®åœ¨è¿™é‡Œéƒ½ä¸ä¼šè¢«è®°å½•ã€‚ä¸‹é¢å±•ç¤ºäº†åœ¨ Snowflake æŸ¥è¯¢ Listing 2 çš„ APPEND_ONLY æ•°æ®</li></ul><p><img src="https://image.mwish.me/blog-image/2778464309866266745.png" alt="img"></p><ul><li>Minimum-delta: <strong>åœ¨æŒ‡å®šçš„æ—¶é—´æ®µæˆ–è€… STREAM å˜æ›´å†…</strong>çš„ INSERT/UPDATE/DELETEç­‰å†™ æ“ä½œ<strong>æœ€å°DELETE/INSERTé›†åˆ</strong>ï¼ˆå³åˆå¹¶é‡å¤æ“ä½œï¼‰ã€‚è¿™ç§æ“ä½œç›¸å¯¹äºç‰©ç†å˜åŒ–å…¶å®å¥½å¤„æ¯”è¾ƒå¤šï¼Œæ¯”æ–¹è¯´ç”¨æˆ·è·‘äº†ä¸ª Merge è¯·æ±‚æˆ–è€…å†…éƒ¨è·‘äº†ä¸ª Compactionï¼Œä½  dedup ä¸€ä¸‹ç”¨æˆ·/ä¸‹æ¸¸å¹¸ç¦å¤šäº†ã€‚</li></ul><p><img src="https://image.mwish.me/blog-image/1456419358256344730.png" alt="img"></p><p>è¿™é‡Œå¯ä»¥å¯¹æ¯” Listing 3ï¼Œå¯ä»¥çœ‹åˆ°å¯¹ id 4 çš„é‡å¤æ“ä½œéƒ½è¢«æŠ˜å æ‰äº†ï¼Œå¯¹åŒä¸€ä¸ªå¯¹è±¡( id 5 )çš„ INSERT - DELETE ä¹Ÿæ²¡äº†ï¼ˆå¯ä»¥æ‹‰ä¸Šå»å¯¹æ¯”ä¸€ä¸‹ï¼‰ã€‚</p><p>åœ¨è¿™é‡Œï¼ŒSnowflake åšäº†ä¸ªæ¯”è¾ƒæœ‰æ„æ€çš„è¯„è®ºï¼šåœ¨å®¡è®¡åœºæ™¯ä¸­ï¼Œæ‰€æœ‰è®°å½•éƒ½è¦æ˜¯å¯è§è€Œä¸èƒ½è¢«æŠ˜å ï¼Œä¸è¿‡ç›®å‰å¤§éƒ¨åˆ†ç”¨æˆ·è§‰å¾—å‡‘åˆç€ç”¨å°±è¡Œï¼Œä¹‹åå¯èƒ½ä¼šæŠŠæ‰€æœ‰ CHANGES éƒ½æš´éœ²å‡ºå»ã€‚</p><p>è¿™é‡Œæœ‰ä¸ªé—®é¢˜æ˜¯ï¼Œdelta ä¿¡æ¯å¯èƒ½æ¯” Insert å…¨ä¸€äº›ï¼Œä¸ºå•¥è¿˜éœ€è¦ minimum-delta </p><h3 id="CHANGES-queries-on-Views"><a href="#CHANGES-queries-on-Views" class="headerlink" title="CHANGES queries on Views"></a>CHANGES queries on Views</h3><p>ä¹‹å‰ä¾‹å­ä¸­çš„ CHANGES éƒ½æ˜¯å¯¹è¡¨çš„ï¼Œä¸‹é¢æœ‰ä¸€ä¸ªæ¯”è¾ƒæ¶å¿ƒçš„ï¼šå¯¹ View çš„ CHANGES.</p><ul><li>Append-only CHANGES<ul><li>Monotonicity: è¿™é‡Œå®šä¹‰äº† Monotonicity, å³æ’å…¥ä¸€æ¡æ•°æ®æ˜¯å¦ä¿è¯æœ€ç»ˆçš„æ’å…¥ï¼Œä¾‹å­æ˜¯ Anti-Joinï¼Œå¯èƒ½è¡¨ A æ’å…¥ä¸€æ¡æ•°æ®ï¼ŒAnti-Join çš„ MV ä¼šå‡å°‘ä¸€æ¡æ•°æ®ã€‚è¿™é‡Œè®¤ä¸ºä¸æ˜¯å¾ˆæ–¹ä¾¿çš„ç›´æ¥è®¡ç®—åˆ° append-only changesï¼Œæ‰€ä»¥è¿™é‡Œåªå…è®¸ append-only changes æä¾›ç»™ monotonic query(mv)</li><li>Repeated inserts: æœ‰ä¸€ä¸ªä¾‹å­æ˜¯åŒä¸€æ¡è¾¹è¢«æ’å…¥ - åˆ é™¤ - æ’å…¥ ï¼Œç¬¬äºŒæ¬¡æ’å…¥æ˜¯å¦è¦è¢«åŒ…å«ã€‚è¿™é‡Œè®¤ä¸ºä¸éœ€è¦åŒ…å«ï¼Œå®ƒè®¤ä¸ºè¿™æ ·ä¼šè®©å®ç°æ›´ç®€å•ä¸€äº›ï¼ˆå“ªé‡Œæ›´ç®€å•äº†å‘¢ï¼‰</li></ul></li><li>Minimum-delta CHANGES<ul><li>Excluded Columns: å¯¹äº Filter æ¡ä»¶æ¥è¯´ï¼ŒBase è¢« Filter æ‰çš„æˆ–è€…æ˜¯æ ¹æœ¬å’Œ mv æ²¡å…³ç³»çš„åˆ—ï¼ŒMV ä¸ä¼šå†å‡ºç°è¿™æ ·çš„ CHANGES</li><li>Update coercion: å¯¹äº Excluded -&gt; INLUDED çš„è¯·æ±‚ï¼ˆæ¯”å¦‚ UPDATEï¼‰ï¼Œè¿™é‡Œä¼šå°†ä¸Šæ¸¸çš„ Update å˜æˆ CHANGES ä¸­çš„ INSERT</li></ul></li></ul><p>æ¥ç€ä¸¾ä¾‹å­ï¼š</p><p><img src="https://image.mwish.me/blog-image/6727086490095305434.png" alt="img"></p><p>Oid æ˜¯ id çš„ foreign key, ä¸‹é¢åˆ›å»ºä¸€ä¸ª inner join çš„ mv:</p><p><img src="https://image.mwish.me/blog-image/3745451790993126611.png" alt="img"></p><p>ä¸‹é¢æè¿°äº†ä¸€äº›å˜æ›´æ“ä½œï¼š</p><p><img src="https://image.mwish.me/blog-image/1947515212853200859.png" alt="img"></p><ul><li>è¿™é‡Œæ¯”è¾ƒå¥½ç©ï¼Œç¬¬ä¸€ä¸ª SQL ç›¸å½“äºæœ€ç»ˆ mv çš„ä¸€ä¸ª UPDATEï¼Œäº§ç”Ÿäº† DELETE + INSERT</li><li>ç¬¬äºŒä¸ª UPDATE åœ¨ Base è¡¨æ˜¯ä¸€ä¸ª UPDATEï¼Œä½†æ˜¯å®ƒå¯¼è‡´ mv Join å˜æ›´äº†ï¼Œç›¸å½“äº Delete + Insert</li><li>ç¬¬ä¸‰ä¸ªæ›´æ–° <code>desc</code> åˆ—å½’å±äº excluded columnï¼Œæ‰€ä»¥æ²¡ä¸€ç‚¹å½±å“</li><li>ç¬¬å››ä¸ª DELETE ä¼šå¯¼è‡´ mv ä¸¤æ¡ Delete (æ„Ÿè§‰å®ƒçš„ fk ä¸æ˜¯å¼ºçº¦æŸï¼Œæ€»è§‰å¾—åœ¨ db è¿™ç§æ•°æ®å¾ˆéš¾åˆ ï¼‰</li></ul><h3 id="STREAM-Objects"><a href="#STREAM-Objects" class="headerlink" title="STREAM Objects"></a>STREAM Objects</h3><p>CHANGES æ˜¯ä¸€ä¸ªæ¯”è¾ƒå¥½ç”¨çš„å·¥å…·ï¼Œè€Œ STREAM åˆ™æ˜¯ CHANGES å’Œè¡¨çš„çŠ¶æ€ç»´æŠ¤ã€‚èƒ½å¤Ÿå®Œæˆå­˜å‚¨çŠ¶æ€å’Œå®¹é”™ç­‰åŠŸèƒ½ã€‚æˆ‘ä»¬åˆ—ä¸¾ STREAM çš„é€»è¾‘ï¼š</p><ul><li>è¡¨(persistent or view) çº§åˆ«ï¼Œå¯¹åº”ä¸€ä¸ª schema-level catalog object ï¼Œç»‘å®šäº source view (è¡¨æˆ–è€… mv)</li><li>STREAM çš„çŠ¶æ€å« frontierï¼Œä»£è¡¨ CHANGES è¢«æ¶ˆè´¹å®Œçš„ä¸€ä¸ªæ—¶é—´ç‚¹ï¼ˆç±»ä¼¼ ckpt?ï¼‰</li><li>Stream å¯ä»¥è¢« consume:<ul><li>è¢«æŸ¥è¯¢çš„æ—¶å€™ï¼ŒSTREAM ç”Ÿæˆ frontier åˆ°ç°åœ¨çš„åº”ç”¨</li><li>DML æ“ä½œ STREAM çš„æ—¶å€™ï¼ŒSTREAM ä¼šåœ¨ DML çš„äº‹åŠ¡ä¸­è¢«å¤„ç†ï¼ˆåŸå­æ€§ï¼‰ï¼Œå½“äº‹åŠ¡ COMMIT çš„æ—¶å€™ï¼Œæ¨è¿› STREAMã€‚</li></ul></li><li>ä¸€ä¸ªè¡¨å¯ä»¥åˆ›å»ºå¤šä¸ª STREAM</li><li>STREAM æ”¯æŒ show initial rowsï¼Œåœ¨ STREAM è¢«ç¬¬ä¸€æ¬¡æ¶ˆè´¹çš„æ—¶å€™ï¼Œå®ƒçš„æ•°æ®åŒ…å«è¡¨çš„æ•°æ®ï¼ˆæˆ‘çŒœæ˜¯å…¨éƒ¨éƒ½æ˜¯ INSERT çš„å½¢å¼ï¼‰ã€‚è¿™ä¸ªè®©æ•´ä¸ª STREAM æ„æˆä¸€ä¸ªèƒ½æ¢å¤æ•´ä¸ªè¡¨çš„ redo log æµ</li></ul><p>ä¸‹é¢å±•ç¤ºäº† Listing 1/2 çš„ STREAM</p><p><img src="https://image.mwish.me/blog-image/644682537778375200.png" alt="img"></p><p><img src="https://image.mwish.me/blog-image/2376649931720618126.png" alt="img"></p><p>ï¼ˆè¿™é‡Œ idea è¿˜æ˜¯æŒºæ˜æ˜¾çš„ï¼‰</p><p>ä½œè€…è®¤ä¸ºï¼ŒSTREAM å¼•å…¥çš„å­˜å‚¨å¼€é”€æ¯”è¾ƒå°ï¼Œç›¸å¯¹çš„åªéœ€è¦å­˜å‚¨ frontierï¼Œæ‰€ä»¥ä½œè€…è§‰å¾— STREAM å¯ä»¥éšä¾¿å¼€ï¼Œå½“ç„¶è®ºæ–‡ä¹Ÿæåˆ°äº†ï¼ŒSTREAM æœ¬èº«å’Œè¡¨çš„ retention policy æœ‰å…³ï¼Œè¿™é‡Œè®¤ä¸º STREAM æœ¬èº«ä¹Ÿä¾èµ–è¡¨çš„ Retention ç­–ç•¥ï¼Œå¦‚æœä¸‹æ¸¸æŸä¸ªæ—¶é—´æˆ³çš„è¡¨ GC äº†ï¼Œé‚£ä¹ˆè¿™é‡Œä¼šè¡¨ç¤ºæ–‡ä»¶å†ä¹Ÿæä¸åˆ°äº†ï¼Œæ‰€ä»¥ STREAM Stale äº†ã€‚å½“ç„¶ Snowflake æœ¬èº«æœ‰ä¸€å®šçš„ Time Travel æœºåˆ¶å’Œ Retention ç›¸å…³çš„ï¼Œå®ƒå…è®¸ç»´æŠ¤ã€å»¶é•¿ä¸€æ®µæ—¶é—´çš„ Retentionï¼Œç›´åˆ°è¿™ä¸ªæ•°æ®çœŸçš„ Retire äº†ã€‚</p><h2 id="Implementation"><a href="#Implementation" class="headerlink" title="Implementation"></a>Implementation</h2><p>Snowflake å¸Œæœ›èƒ½å¤Ÿå°½é‡å¤ç”¨ä»¥å‰çš„ç»„å»ºå’Œæœºåˆ¶ã€ä¹Ÿå‡å°‘å®¢æˆ·çš„è´Ÿæ‹…ï¼ˆåºŸè¯ï¼‰ã€‚è¿™é‡Œè¦æ±‚ï¼š</p><ul><li>ç»™ Storage Layer å¢åŠ  Row-Level Metadata</li><li>Query differentiation framework to Rewrite query</li><li>Integrate STREAM with Transaction system</li></ul><p>è¿™é‡Œï¼Œè®ºæ–‡æ€»ç»“äº†ä¸€ä¸‹ Snowflake çš„æ¶æ„ï¼Œç„¶åä»‹ç»äº†ä¸€ä¸‹å®ƒä»¬æ˜¯æ€ä¹ˆå®ç° STREAM çš„ã€‚</p><h3 id="Table-Metadata"><a href="#Table-Metadata" class="headerlink" title="Table Metadata"></a>Table Metadata</h3><p>Snowflake çš„è¡¨åœ¨æ•°æ®ä¸Šç”±å¤šä¸ª micro-partition ç»„æˆï¼Œä»–ä»¬æ˜¯å¤§å°ä¸ä¸€çš„æ•°æ®æ–‡ä»¶ï¼Œä»¥ z-ordering ä¹‹ç±»çš„å½¢å¼æ¥ç»„ç»‡ï¼Œå­˜å‚¨åœ¨ Blob Storage ä¸Šï¼Œå…ƒæ•°æ®å­˜å‚¨åœ¨ä¸€ä¸ª FoundationDB é›†ç¾¤ä¸Šï¼ˆå¦ˆçš„ç°åœ¨ fdb çš„è´¡çŒ®è€…å…¨æ˜¯ sfc-gh å®¶æ—äº†ï¼Œè¿«çœŸå é¢†ç¤¾åŒºï¼‰ã€‚Snowflake æœ‰ä¸€ä¸ª table versionï¼Œæ¥è¡¨ç¤º Table çš„çŠ¶æ€ï¼š</p><ul><li>System Timestamp</li><li>Set of micro-parititons</li><li>Partition-level statistics</li></ul><p>è€Œè¡¨çš„çŠ¶æ€ä¹Ÿç±»ä¼¼è¿ç»­çš„ Redo Logs:</p><ul><li>INSERT ç­‰æ“ä½œæ’å…¥æ–°çš„ micro-partitions</li><li>DML çš„æ“ä½œçš„ Micro-partition çº§åˆ«ï¼Œæ¯”å¦‚ CoW é‚£ç§å°±æ˜¯ Delete / Insertï¼›æˆ–è€…å¹²è„†ç›´æ¥åˆ äº†<ul><li>ä¸Šè¿°éƒ½èµ° Transaction æäº¤æ“ä½œ</li></ul></li><li>å¦‚æœè¶…è¿‡ Retentionï¼Œå»å›æ”¶æ•°æ®</li></ul><p>è¡¨çš„ç‰ˆæœ¬å’ŒæŸ¥è¯¢çš„ç‰ˆæœ¬ç›´æ¥å…³è”ï¼Œmetadata system é¦–å…ˆä¼šæ‹¿åˆ°æ—¶é—´é”™å¯¹åº”çš„ table version, æ‹¿åˆ°å¯¹åº”çš„ micro partitions</p><h3 id="Query-Differentiation"><a href="#Query-Differentiation" class="headerlink" title="Query Differentiation"></a>Query Differentiation</h3><h4 id="æŸ¥è¯¢çš„æ¨¡å‹"><a href="#æŸ¥è¯¢çš„æ¨¡å‹" class="headerlink" title="æŸ¥è¯¢çš„æ¨¡å‹"></a>æŸ¥è¯¢çš„æ¨¡å‹</h4><p>è¿™é‡Œçš„æŠ€å·§åœ¨äºï¼ŒæŠŠæŸ¥è¯¢æ”¹å†™ä¸ºå¢é‡ mv çš„æŸ¥è¯¢æˆ‘åŸå°ä¸åŠ¨è´´ä¸€ä¸‹è®ºæ–‡çš„æ¨¡å‹ï¼š</p><blockquote><p>given that we want the CHANGES of a query ğ‘„ over an interval ğ¼, we say we differentiate ğ‘„ to obtain the derivative of ğ‘„ , Î” ğ¼ğ‘„ , which varies over ğ¼.</p></blockquote><p>è¿™é‡Œä¼šæ ¹æ®ä¸Šé¢å‡ éƒ¨åˆ†æ¥æ”¹å†™æŸ¥è¯¢ï¼Œä¸‹é¢æ˜¯æ•°å­¦éƒ¨åˆ†ï¼Œæˆ‘åªèƒ½çœ‹æ‡‚å¤§æ¦‚ï¼ˆæ‚²ï¼‰ï¼Œå¤§æ¦‚æ˜¯ Join / Filter / Project / Agg æ‹†åˆ†æˆå¢é‡çš„å½¢å¼ã€‚</p><p><img src="https://image.mwish.me/blog-image/3032945505873821696.png" alt="img"></p><p>å½“ç„¶ï¼Œç­‰é‡ä»£æ¢å®Œæˆä¹‹åï¼Œå°±æ¶‰åŠåˆ°ä»£ä»·çš„é—®é¢˜äº†ï¼š</p><ul><li>Inner Join ä¹‹ç±»çš„ä»£æ¢å¯èƒ½æ€§èƒ½åŠæˆ·éƒ½ä¼šæœ‰ä¼˜åŒ–</li><li>Agg ä¹‹ç±»çš„ï¼Œå¦‚æœå¤§éƒ¨åˆ† key è¢«ä¿®æ”¹äº†ï¼Œæ€§èƒ½å¯èƒ½ä¼šä¸€å¨</li></ul><p>æ‰€ä»¥è¿™é‡Œä¸¢ç»™ Cost-based Optimizer å»è‡ªå·±è¯„ä¼°äº†ã€‚</p><h4 id="Change-Tracking"><a href="#Change-Tracking" class="headerlink" title="Change Tracking"></a>Change Tracking</h4><p>Snowflake ä¼šåœ¨ TableScan Operator å¤„ç†å¢é‡ï¼Œå®ƒéœ€è¦åœ¨ TableScan æå‡º changesã€‚è¿™é‡Œä¼šåˆ©ç”¨è¡Œä¸Šçš„ metadata æ¥å¤„ç†ï¼ŒSnowflake ç»™è¡Œä¸Šå¯ç”¨äº† properties:</p><ul><li>A unique id. Stable across updates (è¿˜è®°å¾— min-delta ä¸Šçš„å˜›ï¼‰</li><li>Whether the row was inserted into the current micro-partition or was copied in from another.This information makes it trivial to produce append-only changes. ï¼ˆè¡Œçš„æ¥æºï¼Œä½†æˆ‘è§‰å¾—è¿™ä¸ªåœ¨ Compaction ä¹‹åè®¡ç®—å¾ˆè›‹ç–¼å•Šï¼ŒåŒ…æ‹¬ insert + compactionï¼Œä½ æ€»ä¸èƒ½æ¯ä¸€è¡Œå» traverse version chain å§ï¼Œè¿«çœŸ MVCCï¼Œä¸è¿‡å®ƒä¹Ÿå¤„ç†äº†è¿™ä¸ªé—®é¢˜ï¼‰</li></ul><p>è¿™ä¸¤å—æˆ‘è§‰å¾—å­˜å‚¨å¼€é”€è‚¯å®šè¿˜å°ï¼Œå› ä¸ºåˆ—å­˜ä¸€å‹å¾ˆå¤šä¸œè¥¿å°±æ²¡äº†ï¼Œä½†æ˜¯æˆ‘è§‰å¾—è¿™å¥—æ¡†æ¶å’Œåˆ«çš„åˆèµ·æ¥è¿˜æ˜¯æœ‰é—®é¢˜çš„ã€‚å½“ç„¶ï¼Œè¿™é‡Œè‚¯å®šä¼šæœ‰é‡å¤ï¼ˆredundent deltaï¼‰ï¼Œäºæ˜¯ query rewriter ä¼šåœ¨ä¸Šé¢åŒºåˆ†è¿™ä¸ªæŸ¥è¯¢æ˜¯å¦ä¼šäº§ç”Ÿ deltaï¼Œå¦‚æœå¯èƒ½æœ‰ delta å°±å±äº redundant-delta propertiesï¼Œç»™ä½ å—¯åŠ ä¸€ä¸ª consolidation å»å»é‡ã€‚Snowflake å‘ç°å¤§éƒ¨åˆ† CHANGE QUERY åªæœ‰ ä¸€å †INSERT æˆ–è€… ä¸€å † DELETEï¼Œæ‰€ä»¥å®ƒæä¾›äº†ä¸å°‘ Plan Shapes:</p><ul><li>MINIMIZE</li><li>ADDED_ONLY</li><li>REMOVED_ONLY</li></ul><p>è€ƒè™‘åˆ°è¿™ä¸ªï¼Œåœ¨ planning çš„æ—¶å€™ï¼Œè¿™é‡Œä¼šæ‰¾åˆ° INSERTED micro-partitions å’Œ DELETED micro-partitions(è¿™ä¸ªå¯¹ Compaction ä¹Ÿç”Ÿæ•ˆï¼‰ï¼Œç„¶åè¿›è¡Œä¸‹é¢çš„ Planï¼Œé‚£ä¸ª UNION å°±å¾ˆç²¾é«“ï¼ŒMinimization çœ‹ä¸‹é¢è®¡ç®—çš„æ€§è´¨ã€‚è¿™é‡Œè¿˜æœ‰ä¸ª <code>ISUPDATE</code> è®¡ç®—ï¼Œæˆ‘ä»¬ä¸€ä¼šå„¿è®²ã€‚</p><p><img src="https://image.mwish.me/blog-image/8580455075483302732.png" alt="img"></p><p>å¯¹äº Added æ¥è¯´ï¼Œè¿™é‡Œä¼šæ‰¾åˆ°ï¼š</p><ol><li>æ‰€æœ‰ Added Partitionï¼ŒåŒ…æ‹¬ Compaction äº§ç”Ÿçš„</li><li>æ‰«ææ‰€æœ‰è®°å½•ï¼Œåªæœ‰è¡Œæ¥æºä¸æ¥è‡ªäºåˆ«çš„æ–‡ä»¶çš„æ‰ä¼šè¢«è®°å…¥</li></ol><p>è¿™ä¸ªç®—æ³•ä¹Ÿæ˜¯æ¯”è¾ƒç®€æ´çš„</p><p><img src="https://image.mwish.me/blog-image/2504297451855509654.png" alt="img"></p><p>åœ¨å…ƒä¿¡æ¯ä¸Šï¼Œå…³äº ACTION çš„è®¡ç®—æ˜¯å¾ˆç®€å•çš„ï¼ŒISUPDATE çš„è®¡ç®—ä¼šæ˜¯æœ€ç»ˆåˆå¹¶çš„ï¼ˆè€Œä¸æ˜¯ä¸­é—´çš„æ“ä½œï¼‰ï¼Œæ€»çš„è¯´å®ƒåªçœ‹èµ·æ­¢ã€‚</p><p>æ¯”è¾ƒé‡è¦çš„æ˜¯ <code>$ROW_ID</code>ï¼Œè¿™ä¸ªä¸œè¥¿è®¾ç½®äº†å¯èƒ½å°±æ²¡é‚£ä¹ˆå¥½æ”¹äº†ï¼š</p><ol><li>å¯ä»¥æ˜¯æœ‰å«ä¹‰çš„è¯­ä¹‰ï¼Œä½†æ˜¯å¯èƒ½ä¼šå¯¹ç³»ç»Ÿæœªæ¥çš„ evaluation é€ æˆå…¼å®¹æ€§è´Ÿæ‹…ï¼ˆä¹Ÿä¸é‚£ä¹ˆä¼šæŠŠï¼Ÿï¼‰</li><li>å¯ä»¥æ˜¯æ²¡æœ‰å«ä¹‰çš„è¯­ä¹‰ï¼Œæ¯”å¦‚ Hashing Columnsã€‚å› ä¸ºè¿™é‡Œä¹Ÿå¸Œæœ› TableScan ä¹‹ç±»çš„æ—¶å€™ï¼Œä¸ä¼šå¯¹ Shuffle ä¹‹ç±»çš„å†…å®¹é€ æˆå¤ªå¤§çš„è´Ÿæ‹…</li><li>Our row IDs are a cryptographic hash of the change tracking columns, which ensures uniqueness to a very high probability.ï¼ˆæ¯”å¦‚ geohash æˆ–è€…ç±»ä¼¼çš„ï¼ŸçŒœæµ‹å’Œ row è¿˜æœ‰ partition æœ‰å…³ï¼‰</li></ol><p>è¿™é‡Œè¿˜æœ‰ä¸ªé—®é¢˜æ˜¯ï¼Œä¸Šé¢ä½œä¸º base è¡¨çš„ï¼Œé‚£ä¹ˆä½œä¸ºä¼ ä¸‹å»æˆ–è€… mv çš„å‘¢ï¼Ÿè¿™é‡Œçš„å¤„ç†æ–¹å¼æ˜¯ï¼š</p><ol><li>Filter / Project ä¸æ”¹å˜ row-id</li><li>Group By æ ¹æ® Group-by Agg Keys æ¥åš row-id</li><li>UNION ALL åœ¨åŒä¸€å¼ è¡¨çš„ Filter çš„æ—¶å€™ï¼Œå¯èƒ½ç›¸å¯¹å¤æ‚ä¸€äº›</li></ol><p>Snowflake è¯´ä»–ä»¬æ²¡é‡åˆ°ä»€ä¹ˆ corner caseï¼Œä»€ä¹ˆç»¿çš®æš´åŠ›ææ³•å¤§åŠ›å‡ºå¥‡è¿¹ã€‚</p><h3 id="Stream-Transactions"><a href="#Stream-Transactions" class="headerlink" title="Stream Transactions"></a>Stream Transactions</h3><p><img src="https://image.mwish.me/blog-image/7468682257460978131.png" alt="img"></p><p>åœ¨ STREAM è¢«æŸ¥è¯¢çš„æ—¶å€™ï¼Œè¿™é‡Œä¼šå°è¯•æ¶ˆè´¹ï¼Œæ¶ˆè´¹çš„æ—¶å€™ä¼šæ»¡è¶³åŸå­æ€§ã€‚</p><ol><li>å¦‚æœè®¾è®¡å•ä¸ª Tableï¼Œé‚£ä¼šå¾ˆç®€å•ï¼Œä½†æ˜¯å¤šä¸ª tableï¼Œä¼šæ¯”è¾ƒè›‹ç–¼ï¼Œå› ä¸º snowflake å¥½åƒæ²¡æœ‰å…¨å±€æ—¶é—´æˆ³ã€‚è¿™é‡Œ frontier ä¼šæ£€æµ‹å¤šä¸ª base table çš„ç‰ˆæœ¬ï¼Œæ¥ä¿è¯ STREAM å†…éƒ¨ä¸ä¼šæœ‰å†²çª</li><li>STREAM æœ¬èº«ä»£è¡¨è¿‡å»çš„æ—¶é—´æˆ³ï¼Œæ‰€ä»¥å®ƒè‡ªå·±è¦å­˜æ—¶é—´æˆ³ï¼Œè¿™é‡Œä¹Ÿä¼šæœ‰ä¸ª last updated çš„ç‰©ç†æ—¶é—´æˆ³</li><li>åœ¨æ¶ˆè´¹ STREAM å¯èƒ½ä¼šæœ‰äº‹åŠ¡ï¼Œæ‰€ä»¥ä¸€ä¸ª STREAM å¯èƒ½ä¸èƒ½è¢«å¤šä¸ªå®¢æˆ·ç«¯æ¶ˆè´¹</li><li>Staleness ä¼šæ ¹æ® Retention æ¥ç»´æŠ¤</li></ol><h2 id="USAGE-AND-PERFORMANCE-ANALYSIS"><a href="#USAGE-AND-PERFORMANCE-ANALYSIS" class="headerlink" title="USAGE AND PERFORMANCE ANALYSIS"></a>USAGE AND PERFORMANCE ANALYSIS</h2><p><img src="https://image.mwish.me/blog-image/1423177542917606780.png" alt="img"></p><p><img src="https://image.mwish.me/blog-image/4745081897764211093.png" alt="img"></p><p><img src="https://image.mwish.me/blog-image/3412166040666676318.png" alt="img"></p><h2 id="æ‰¹è¯ç¯èŠ‚"><a href="#æ‰¹è¯ç¯èŠ‚" class="headerlink" title="æ‰¹è¯ç¯èŠ‚"></a>æ‰¹è¯ç¯èŠ‚</h2><p>è¿™ç¯‡æ–‡ç« æè¿°çš„å†…å®¹è¿˜æ˜¯å¾ˆæœ´ç´ çš„ï¼Œæˆ‘å½“æ—¶ä»¥ä¸ºæœ‰å•¥å¤§æ‹›ï¼Œä½†æ˜¯è¿˜æ˜¯ç¡¬æ‰«ã€‚è¿™å—éš¾åº¦åº”è¯¥ä¸åœ¨å­˜å‚¨ä¸Šï¼Œå¯¹æŸ¥è¯¢æ”¹å†™ã€ä¼˜åŒ–å™¨ç”šè‡³ä¸Šæ¸¸è°ƒåº¦å¼€é”€ä¼šæ¯”è¾ƒé«˜ã€‚è€Œä¸”å¾ˆå¤šä¸œè¥¿è¿˜æ˜¯ Open Problemã€‚æœŸå¾…å‚å•†è¿˜æ˜¯èƒ½æŠŠè¿™å¥—æœºåˆ¶å’Œ Live Table ä¹‹ç±»çš„ç»“åˆèµ·æ¥ï¼Œæˆ–è€…æä¾›ä¸€äº› Streaming çš„ç®—å­ï¼ŒæŠ½è±¡å‡ºä¸€ä¸ªæ›´é«˜æ•ˆçš„æ¡†æ¶ã€‚</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Spark: RDD design</title>
      <link href="/2023/06/21/Spark-RDD-design/"/>
      <url>/2023/06/21/Spark-RDD-design/</url>
      
        <content type="html"><![CDATA[<p>ä»¥ 2023 å¹´çš„è§†è§’æ¥çœ‹ï¼ŒMapReduce æ˜¯ä¸ªè¿‡åº¦åŠ›å¤§ç –é£çš„è½¯ä»¶ï¼Œå®ƒå¼ºè°ƒå¼ºåˆ¶çš„ 2ä¸ª Stage ï¼ˆä¸€äº›å…¶ä»–ç¬¬ä¸‰æ–¹ä¹‹ç±»çš„æ–¹æ¡ˆä¼šæœ‰åˆ«çš„ Stageï¼‰ï¼Œç„¶å Stage ä¸­é—´ Sort + è½ HDFS æ–‡ä»¶æ¥åš Shuffleï¼Œé  Reducer Pull æ¥ä¼ è¾“æ•°æ®ã€‚è¿™æ ·çš„è®¡ç®—æµå¾ˆå›ºå®šã€æ€§èƒ½æ¯”è¾ƒä½æ•ˆï¼Œä½†æ˜¯ç›¸å¯¹æ¥è¯´ç¡®å®æ˜¯ä¸ªåŠ›å¤§ç –é£çš„æ–¹æ¡ˆã€‚</p><p>Spark ä¹‹å‰ï¼Œé¦–å…ˆæ˜¯å¾®è½¯åœ¨ SCOPE ç³»ç»Ÿå’Œ DryadLinq ä¹‹ç±»çš„åœ°æ–¹åšå‡ºäº†è´¡çŒ®ï¼ŒåŒ…æ‹¬ DAG ä¸€æ ·çš„è®¡ç®—æµã€ï¼ˆç±»ï¼‰SQL çš„æ”¯æŒï¼Œä½†æ˜¯ Spark ç¡®å®æ˜¯å¼€æºç¤¾åŒºå¾ˆæ—©æå‡ºæ¥çš„ï¼Œå¹¶ä¸”åœ¨ä»Šå¤©å·²ç»èŒå£®æˆé•¿ä¸ºäº† DataBricks è¿™æ ·çš„å·¨å¤§å…¬å¸å’Œæ‹¥æœ‰äº†åºå¤§çš„å‘¨è¾¹ç”Ÿæ€ï¼Œå¯è§è¿™å¥—ä¸œè¥¿æ‰“æ³•è¿˜æ˜¯å¾ˆé‡è¦ã€‚Spark æ”¯æŒçš„å¯¹è±¡æœ‰ DataSet/DataFrame å’Œ SQL ç”šè‡³ Streaming / ML ç­‰å¤šä¸ªç›®æ ‡çš„åºå¤§ç³»ç»Ÿã€‚ä¸è¿‡æˆ‘ä»¬ä¼šåœ¨ä¹‹åçš„å†…å®¹ä¸­æåˆ° Spark SQL ç”šè‡³ DataFrameï¼Œæˆ‘ä»¬ä»Šå¤©åªæ¶‰åŠ Spark è®ºæ–‡ä¸­æå‡ºçš„ RDDã€‚</p><h2 id="RDD"><a href="#RDD" class="headerlink" title="RDD"></a>RDD</h2><p>Spark æœ€åˆç‰ˆæœ¬æ•´ä¸ªåœ¨ Scala ä¸Šç¼–å†™ï¼Œå®ƒæä¾›çš„æŠ½è±¡æ˜¯ RDDã€‚åœ¨è®ºæ–‡å†™ä½œçš„æ—¶å€™ï¼Œå®ƒåªåšä¸€äº› Batch Exec çš„è®¡ç®—ï¼Œå¹¶ä¸”è®ºæ–‡ä¸­æåˆ°çš„ä¼˜åŠ¿åœºæ™¯åŒ…æ‹¬ iterative algorithms (eg: å›¾è®¡ç®—ï¼ŒML çš„è®­ç»ƒ) å’Œ interactive data mining tools(ç»™åŒä¸€ä»½æ•°æ®å‘å¤šæ¬¡ adhoc query). åŒæ—¶ï¼ŒRDD çš„ç›®æ ‡æ˜¯<strong>å°½é‡ç”¨ä¸Šå†…å­˜</strong>(åˆ©ç”¨ä¸Šå†…å­˜å¹¶ä¸éš¾ï¼Œä½†æ˜¯ MPI å¯èƒ½éœ€è¦çŸ¥é“å¯¹åº”æœºå™¨çš„ä½ç½®ï¼Œæ­¤å¤–è¿˜éœ€è¦èƒ½å¤Ÿä»æ•…éšœæˆ–è€… worker failover ä¸­æ¢å¤å‡ºæ¥)ã€åˆ©ç”¨ Intermediate resultã€‚</p><p>ç›¸å¯¹äº MPI, Pregel ç­‰ç³»ç»Ÿï¼ŒSpark RDD æ„å»ºçš„æ˜¯ä¸€ç§<strong>ç²—ç²’åº¦çš„æŠ½è±¡</strong>ï¼Œå®ƒï¼š</p><ul><li>ç±»ä¼¼ Fpï¼Œæœ¬èº«æ˜¯ immutable çš„</li><li>æè¿°è®¡ç®—è¿‡ç¨‹ï¼ŒåŒæ—¶ä¹Ÿæœ‰ä¸€äº›ç›¸å¯¹ internal çš„ä¸œè¥¿ï¼Œ æ¯”å¦‚ Partitionã€‚ä¹Ÿå…è®¸æœ‰ <code>persist</code> (æŒä¹…åŒ–) å’Œ <code>cache</code> (ç¼“å­˜/ç‰©åŒ–ç»“æœå¹¶å°½é‡åœ¨å†…å­˜)</li><li>Parallelï¼šå› ä¸º RDD åªæè¿°è®¡ç®—è¿‡ç¨‹ï¼ŒåŒæ—¶ä¸€äº› Map ç´¯çš„è®¡ç®—æµç¨‹é€šå¸¸æ˜¯ç›¸åŒçš„ï¼Œæ‰€ä»¥å…è®¸ Parallel çš„å»æ‰§è¡Œã€‚å½“ç„¶ä¹Ÿå¯ä»¥æ ¹æ® partition ä¹‹ç±»çš„ä¸œè¥¿æ¥å†³å®šè¿™éƒ¨åˆ†çš„æè¿°</li><li>Fault Tolerant: è¿™ä¸ª FT åå­—æœ‰ç‚¹æŠ½è±¡ï¼Œå¹¶ä¸æ˜¯å’Œ TP Workload ä¸€æ ·çš„ FTï¼Œè€Œæ˜¯å’Œ MapReduce é‚£ç§æ²¡ç®—å®Œæˆ–è€…æŒ‚äº†ï¼Œå°±å»é‡æ–° Exec å¯¹åº”çš„ä»»åŠ¡</li></ul><p>ä¸Šé¢çš„éƒ¨åˆ†å…¶å®æœ‰ç‚¹æŠ½è±¡ã€‚ä¸è¿‡åé¢éƒ½ä¼šè®²ã€‚è®ºæ–‡å…ˆä¸¾äº†ä¸¤ä¸ª RDD çš„ä¾‹å­ï¼š</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">lines = spark.textFile(<span class="string">&quot;hdfs://...&quot;</span>) </span><br><span class="line">errors = lines.filter(_.startsWith(<span class="string">&quot;ERROR&quot;</span>))</span><br><span class="line">errors.persist()</span><br><span class="line">errors.count()</span><br><span class="line"></span><br><span class="line">errors.filter(_.contains(<span class="string">&quot;MySQL&quot;</span>)).count()</span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„è®¡ç®—æµç¨‹å¯ä»¥å¦‚ä¸‹æ‰€ç¤ºï¼šå¯ä»¥çœ‹åˆ° RDD è¦ä¹ˆæ¥è‡ªæ–‡ä»¶è¾“å…¥ï¼ˆ<code>lines</code>ï¼‰ è¦ä¹ˆæ¥è‡ªå¯¹ä¹‹å‰ RDD çš„ transformationã€‚</p><p><img src="https://image.mwish.me/blog-image/image-20230619195027384.png" alt="image-20230619195027384"></p><p>æ–‡ç« ä¹Ÿå¯¹æ¯”äº† Spark å’Œ Distributed Memory çš„ä¼˜åŠ¿ï¼ˆä¸è¿‡æˆ‘ä¸ªäººè®¤ä¸º RDD å’Œ Distributed Memory å®Œå…¨ä¸æ˜¯ä¸€å¥—ä¸œè¥¿ï¼Œä¹Ÿç”¨åœ¨ä¸åŒçš„åœºæ™¯ï¼Œæˆ‘ç°åœ¨è§‰å¾— Distributed Memory æ˜¯ â€œInternalâ€ï¼‰ä¸‹é¢çš„è¡¨æ ¼å¹äº†å¾ˆå¤šæœ‰ç‚¹ï¼Œä½†æˆ‘è§‰å¾—ä¸»è¦åŒºåˆ«è¿˜æ˜¯ï¼š</p><ul><li>Spark è‡ªå·±ç»´æŠ¤äº† lineageï¼Œè¡¨è¿°æ•°æ®çš„æ„é€ å’Œè¡€ç¼˜å…³ç³»</li><li>å£°æ˜å¼éœ€è¦æŸç§è®¡ç®— vs å…·ä½“å®ç°å¯¹åº”çš„è®¡ç®—</li><li>RDD åœ¨å†…å­˜ä¸å¤Ÿçš„æ—¶å€™ä¹Ÿå¯ä»¥ downgrade æˆç±»ä¼¼ MapReduce é‚£ç§æ¨¡å¼ï¼ˆåˆ©ç”¨ Spill å’Œ Shuffleï¼‰</li></ul><p>åˆ«çš„éƒ½æ˜¯è™šå¤´å·´è„‘çš„ï¼Œæ„Ÿè§‰æ‰¯æ¥æ‰¯å»æµªè´¹æ—¶é—´ã€‚</p><p><img src="https://image.mwish.me/blog-image/0CAF7F90-40E2-474C-A42C-19B76FF70AB1.png" alt="0CAF7F90-40E2-474C-A42C-19B76FF70AB1"></p><p>è¿™é‡Œè®ºæ–‡è¿˜æè¿°äº†ä¸€ä¸‹ä¸é€‚åˆ RDD ä¸é€‚åˆ Streaming æˆ–è€…å°äº®å¤šæ¬¡æ›´æ–°çš„åº”ç”¨ï¼Œçœ‹è§ DataBricks çš„ Live Tableï¼Œæˆ‘é™·å…¥äº†æ²‰æ€ã€‚å˜›ï¼ŒæŠ€æœ¯æ˜¯å‘å±•çš„ï¼ŒDelta-IO æä¾›çš„æ•°æ®æ¹–æœ¬èº«ä¹Ÿæ˜¯ä¸€ç§ç»•å¼¯å¼¯çš„æ–¹æ¡ˆå§ã€‚</p><h3 id="Spark-Programming-Interface"><a href="#Spark-Programming-Interface" class="headerlink" title="Spark Programming Interface"></a>Spark Programming Interface</h3><p>Spark çš„ Cluster æ¨¡å¼å¦‚é“¾æ¥æ‰€è¿°ï¼š<a href="https://spark.apache.org/docs/latest/cluster-overview.html">https://spark.apache.org/docs/latest/cluster-overview.html</a> ã€‚æœ¬èº«æŠŠ worker éƒ¨ç½²çš„æ—¶å€™éƒ¨ç½²åœ¨æœºå™¨æˆ–è€…å®¹å™¨ä¸Šï¼Œæœ‰ standalone, Yarn/Mesos è°ƒåº¦, Kubernetes æ¨¡å¼ã€‚è¿™é‡Œæœ‰å‡ ä¸ªï¼ˆå…¨å®‡å®™éƒ½ä¸€æ ·çš„ï¼‰æ¨¡å‹ï¼š</p><p><img src="https://image.mwish.me/blog-image/cluster-overview.png" alt="cluster-overview"></p><p><img src="https://image.mwish.me/blog-image/image-20230620221329414.png" alt="image-20230620221329414"></p><p>ç”¨æˆ·å¯ä»¥ç”¨ Scala ç¼–å†™ RDDï¼ŒRDD æ˜¯å¸¦ç±»å‹çš„å¯¹è±¡ <code>RDD[T]</code>, å¯¹ RDD æ“ä½œåˆ†ä¸º <code>transformation</code> å’Œ <code>action</code>ï¼Œé‡Œé¢å†…å®¹å…¶å®éå¸¸å¥½ç†è§£ï¼ˆæˆ‘æ„Ÿè§‰ä¸€äº›å¸¦å‰¯ä½œç”¨çš„åœ¨è¿™é‡Œåè€Œæ˜¾å¾—æœ‰ç‚¹æ€ªï¼‰ï¼š</p><p><img src="https://image.mwish.me/blog-image/EBF3B6DA-0602-4995-B618-93751F38FD6C.png" alt="EBF3B6DA-0602-4995-B618-93751F38FD6C"></p><p> è¿™é‡Œä¼šæ˜¾å¾—æœ‰ç‚¹æ··ä¹±ï¼Œä½†æ˜¯å…¶å®å¾ˆç®€å•ï¼Œé¦–å…ˆè¿™äº›åŠŸèƒ½å·®ä¸å¤šéƒ½æ˜¯å‡½æ•°å¼æˆ–è€… db ç±»ä¼¼çš„åŸè¯­. è¿™é‡Œæœ‰å‡ ä¸ªå€¼å¾—æ³¨æ„çš„ï¼š</p><ul><li><code>join</code> <code>union</code> <code>cogroup</code> <code>crossProduct</code>: ä»¤äººç†Ÿæ‚‰çš„æ•°æ®åº“è€æœ‹å‹</li><li><code>sort</code>: æ‡‚å¾—éƒ½æ‡‚ï¼ˆå…¶å®ç±»å‹ä¸Š sort è¿˜æ²¡æœ‰ï¼Œæˆ‘æ„Ÿè§‰ç±»ä¼¼ä¼šæœ‰ä¸ª properties çš„ä¸œè¥¿åœ¨é‡Œé¢ï¼Ÿï¼‰</li><li><code>partitionBy</code>: éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡ŒæŒ‡å®šçš„æ˜¯ç±»ä¼¼ã€Œç‰©ç†æ‰§è¡Œã€çš„å±æ€§ï¼Œè¿™ç‚¹æ„Ÿè§‰å…¶å®å¯¹æ€§èƒ½ä¹‹ç±»çš„ç›¸å¯¹æ¥è¯´æ¯”è¾ƒé‡è¦ï¼Œä¸¾ä¸ªä¾‹å­ï¼Œæ¯”å¦‚æœ¬èº«å¯èƒ½èµ° shuffle çš„è®¡ç®—ï¼Œåœ¨ Partition ä¹‹åå°±ä¸ä¸€å®šè¦èµ° Shuffle äº†ã€‚</li></ul><p>è®ºæ–‡è¿™é‡Œæä¾›äº†ä¸€ä¸ª <code>PageRank</code> çš„ä¾‹å­ï¼Œå…¶å® MR ä¹‹ç±»çš„éƒ½ä¼šåœ¨è¿™ä»‹ç» PageRankï¼Œä»€ä¹ˆå…¬å…±é¶åœº. è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå®ƒæŠŠ <code>links</code> ç»™ <code>cache</code> ä¸‹æ¥äº†ï¼Œç„¶ååœ¨æ¯ä¸€æ­¥éƒ½å¯ä»¥ç”¨è¿™ä¸ªåŸºæœ¬çš„ RDDï¼Œè€Œä¸éœ€è¦é‡æ–°è®¡ç®—ã€‚è¿™é‡Œæœ‰ä¸ª Python çš„ä¾‹å­ï¼š<a href="https://github.com/apache/spark/blob/master/examples/src/main/python/pagerank.py">https://github.com/apache/spark/blob/master/examples/src/main/python/pagerank.py</a> ï¼ˆæ³¨æ„ <code>cache</code> å’Œè¿­ä»£ï¼‰</p><p><img src="https://image.mwish.me/blog-image/image-20230620225708643.png" alt="image-20230620225708643"></p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä½œè€…è®¤ä¸ºè¿™é‡Œ links å¾ˆå¤§ï¼Œæ‰€ä»¥æ²¡æœ‰å» <code>broadcast</code> å®ƒï¼Œè¿™é‡Œä¹Ÿæåˆ°ï¼Œå¦‚æœè´Ÿè½½æ¯”è¾ƒæ˜ç¡®ï¼Œå¯ä»¥å» <code>partition</code> ä¸€æŠŠï¼š</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">links = spark.textFile(...).map(...).partitionBy(myPartFunc).persist()</span><br></pre></td></tr></table></figure><p>å¯¹çš„ï¼Œå…¶å® Spark RDD è¿˜å¸¦äº†ä¸€ç»„æ¯”è¾ƒç‰©ç†æ€§è´¨çš„æ“ä½œï¼š</p><p><img src="https://image.mwish.me/blog-image/0D7ADA36-5AD3-482E-B1BC-21766A1C686B.png" alt="0D7ADA36-5AD3-482E-B1BC-21766A1C686B"></p><p>Spark çš„æ“ä½œå¯ä»¥æŒ‡å®š <code>numPartition</code> å’Œå¯¹åº”çš„ <code>partitioner</code>, ç”šè‡³å» <code>repartition</code>ï¼Œä¸è¿‡è¿™é‡Œéœ€è¦æ³¨æ„ <code>partition</code> æœ¬èº«ä¸ç”Ÿæˆ RDD ï¼ˆ <code>repartition</code> è‚¯å®šä¼šï¼‰ã€‚å®ƒæœ‰ï¼š</p><ul><li>List Partition</li><li>Hash Partition</li><li>Range Partition</li></ul><p>ä¸Šé¢å‡ ç§ï¼Œå…·ä½“è¿˜æ˜¯çœ‹ä¸šåŠ¡äº†ã€‚<code>cache</code> / <code>presist</code> æœ¬èº«æ˜¯ä¸ª lazy çš„æ“ä½œï¼Œä¼šåœ¨æ‰§è¡Œçš„æ—¶å€™æ‰å¤„ç†ï¼Œ<strong>Cache / Persist çš„å¯¹è±¡æ˜¯ RDD çš„ç»“æœ</strong></p><h2 id="RDD-çš„ç»„æˆ"><a href="#RDD-çš„ç»„æˆ" class="headerlink" title="RDD çš„ç»„æˆ"></a>RDD çš„ç»„æˆ</h2><p>ä½œè€…åœ¨è¿™é‡Œè®¤ä¸ºï¼ŒRDD åŒ…å«ï¼š</p><ul><li>Partitions</li><li>Dependencies (å¯¹åº”çš„æ•°æ®æº)</li><li>Compute Function</li><li>Metadata About Schema</li></ul><p>æˆ‘ä¸ªäººè§‰å¾—å…¶å®æœ‰ç‚¹åƒæ•°æ®åº“çš„ Physical Plan ä¸€ç±»çš„ä¸œè¥¿ï¼ˆæˆ–è®¸ Spark SQL çš„è®ºæ–‡ä¼šå‘Šè¯‰æˆ‘æœ‰ä»€ä¹ˆåŒºåˆ«ï¼‰ã€‚</p><p>å…³äº RDDï¼Œå‡ ä¸ªè¦å…³æ³¨çš„æ“ä½œæ˜¯ï¼š</p><ul><li>dependency and shuffle</li><li>plan æ„å»º</li><li>cache / persist</li></ul><p>æˆ‘ä»¬å…ˆè®² dependency &amp; shuffle. ä¹Ÿæ˜¯ Spark çš„æ ¸å¿ƒä¹‹ä¸€ã€‚</p><h3 id="Dependency-and-Shuffle"><a href="#Dependency-and-Shuffle" class="headerlink" title="Dependency and Shuffle"></a>Dependency and Shuffle</h3><p><img src="https://image.mwish.me/blog-image/14AC10E6-1CB9-40C2-AAAC-2CA613DAF85B.png" alt="14AC10E6-1CB9-40C2-AAAC-2CA613DAF85B"></p><p>Spark ä¼šæ ¹æ®æ“ä½œç±»å‹æ¥åˆ¤æ–­æ˜¯å¦è¦ Shuffleï¼Œè¿™é‡Œçš„åˆ¤æ–­æ–¹å¼å…¶å®çœ‹ä¸Šé¢ï¼Œæ„å¤–å¾ˆç®€å•ï¼Œå®ƒæŠŠ Spark åŒºåˆ†ä¸º Narrow Dependencies å’Œ Wide Dependencies:</p><ul><li>Narrow Dependencies: where each <strong>partition</strong> of the parent RDD is used by at most one <strong>partition</strong> of the child RDD</li><li>Wide Dependencies: wide dependencies, where multiple child partitions may depend on it.</li></ul><p>è¿™é‡Œæˆ‘ç‰¹åœ°è´´åŸæ–‡ï¼Œå› ä¸ºå®ƒå«ä¹‰è¿˜æ˜¯æ¯”è¾ƒæ¸…æ™°çš„ï¼Œå› ä¸ºè¿™é‡Œä¸€å¯¹ä¸€ å’Œå¤šå¯¹ä¸€çš„å•ä½æ˜¯ <strong>RDDä¸­çš„ Partition</strong> ï¼</p><ul><li>OneToOneã€ManyToOne ä¹‹ç±»çš„å…³ç³»æ˜¾ç„¶è‚¯å®šæ˜¯ Narrow Dependencies</li><li>å¤šå¯¹ä¸€å‚ç…§ Partitionï¼Œco-locate Join è¿™ç§å¯èƒ½ä¼šæ˜¯ Narrow Dependencies!</li></ul><p>æˆ‘ä»¬ä¸‹é¢åŒºåˆ†åˆ° Shuffle çš„å®ç°ï¼ŒShuffle åœ¨ MapReduce ä¸­ä¹Ÿèƒ½è§åˆ°ï¼Œå®ƒæ˜¯ä¸€ä¸ªéƒ¨åˆ†æ•´ä¸ªå†™è¿‡å»ï¼Œå¦ä¸€éƒ¨åˆ†æ•´ä¸ªè¯»çš„æ“ä½œã€‚è¿™ä¸ªæ“ä½œè¿˜æ˜¯ç›¸å½“é‡çš„ï¼Œè€Œä¸”å¯èƒ½æ¶‰åŠæ’åºã€‚è¿™é‡Œè€ƒè™‘åˆ†æˆ Shuffle Write å’Œ Shuffle Read çš„é˜¶æ®µï¼Œå†™çš„æ—¶å€™å¯èƒ½èµ°æ’åºæˆ–è€… Hash + Aggï¼Œè¯»çš„æ—¶å€™å¯èƒ½è¿˜éœ€è¦å†èµ°ä¸€ä¸ªç±»ä¼¼å¤šè·¯å½’å¹¶çš„æ“ä½œã€‚</p><p><img src="https://image.mwish.me/blog-image/BC2A9E92-563A-4D1D-8647-7336690F0C24.png" alt="BC2A9E92-563A-4D1D-8647-7336690F0C24"></p><p>åœ¨ VLDBâ€˜20 ä¸Šï¼ŒLinkedIn çš„å·¥ç¨‹å¸ˆæä¾›äº†ä¸€ä¸ª Spark Shuffle çš„æ–¹æ¡ˆï¼ŒSpark 3.2 çš„æ—¶å€™è¢« Merge è¿›å»äº†ã€‚ä¹‹åå†™ç¯‡å•ç‹¬æ–‡ç« ä»‹ç»è¿™ä¸ª Shuffle çš„æµç¨‹å¥½äº†ã€‚</p><h3 id="Stage"><a href="#Stage" class="headerlink" title="Stage"></a>Stage</h3><p><img src="https://image.mwish.me/blog-image/C0F5047D-EBFA-4C60-9265-16E8822B489B.png" alt="C0F5047D-EBFA-4C60-9265-16E8822B489B"></p><p>Spark ä¼šæŒ‰ç…§ Wide Dependencies æ‹†åˆ†æˆå¤šä¸ª Stageï¼ŒStage å†…å¹¶è¡Œæ‰§è¡Œï¼ˆæœ‰ç‚¹ç±»ä¼¼ Push-based Execution Engineï¼Ÿï¼‰</p><p><img src="https://image.mwish.me/blog-image/63816205-6672-4A0D-8A47-E3AD07D1A28D.png" alt="63816205-6672-4A0D-8A47-E3AD07D1A28D"></p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>æœ¬æ–‡å…³æ³¨ Spark è®¡ç®—å’Œ Shuffleï¼Œçœç•¥äº†å†…å­˜ç®¡ç†ã€ä»£ç ç”Ÿæˆç­‰éƒ¨åˆ†ï¼Œå› ä¸ºæˆ‘æ„Ÿè§‰è¿™äº›ä¸œè¥¿è¦ä¹ˆæˆ‘ä»¬ä¹‹å‰è®²è¿‡æ›´ç°ä»£çš„æ–¹æ¡ˆï¼Œè¦ä¹ˆ Photon è‡ªå·±åšäº†ï¼Œæ²¡å¿…è¦åœ¨æ„è¿™ä¹ˆè€è®ºæ–‡æ˜¯æ€ä¹ˆ codegen ã€å†…å­˜ç®¡ç†çš„ã€‚</p><p>Spark æ„Ÿè§‰è®ºæ–‡é‡Œä¹Ÿæå‡ºäº†åŠ›å¤§ç –é£çš„æ–¹å¼ã€‚æ­¤å¤–ï¼Œå¯¹äº Shuffle ç­‰åœ°æ–¹çš„ä¼˜åŒ–ï¼Œæœ¬æ–‡ä¹Ÿåªæ˜¯æåˆ°ï¼Œæ²¡æœ‰æ·±å…¥ï¼ˆå…¥é—¨é˜¶æ®µå…ˆ move-fast å…ˆæ‰«ä¸€éï¼Œä¹‹åæ‡‚å¾—å¤šäº†å†è¡¥å›æ¥å§ï¼‰ã€‚å…³äºå„ä¸ª transformï¼Œå…¶å®æœ¬æ¥åº”è¯¥å¤§æœ‰å¯ä»¥è®²çš„åœ°æ–¹ï¼Œä¸è¿‡ç›®å‰ç‚¹åˆ°ä¸ºæ­¢ç®—äº†ã€‚</p><p>Spark è¿˜æœ‰ä¸€å¥—æ¯”è¾ƒå¤§çš„æ€æ‰‹é”æ˜¯ Adaptive Query Executionï¼Œå®ƒèƒ½æ ¹æ®å¤§å°æ¥åŠ¨æ€è°ƒæ•´æ‰§è¡Œçš„èµ„æºï¼Œæ¥å¤„ç†å¤§æ•°æ®åœºæ™¯çš„ skewï¼Œè¿™æ˜¯ä¸ªæ¯”è¾ƒé‡è¦çš„ä¼˜åŒ–ï¼Œä½†æœ¬æ–‡ä¹Ÿç•¥è¿‡äº†ï¼Œå®åœ¨æ·±æ„Ÿæƒ­æ„§ã€‚</p><h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><ul><li><p>Resilient Distributed Datasets: A Fault-Tolerant Abstraction for In-Memory Cluster Computing</p></li><li><p>VLDBâ€™20  Magnet: é¢†è‹±Spark Shuffleè§£å†³æ–¹æ¡ˆ - Sovnloçš„æ–‡ç«  - çŸ¥ä¹ <a href="https://zhuanlan.zhihu.com/p/397391514">https://zhuanlan.zhihu.com/p/397391514</a></p></li><li><p>å…³äºSpark 3.2.0 push-based shuffle - æ–œæ ä»£ç æ—¥è®°çš„æ–‡ç«  - çŸ¥ä¹ <a href="https://zhuanlan.zhihu.com/p/443752106">https://zhuanlan.zhihu.com/p/443752106</a></p></li><li><p>å¤§æ•°æ®å¤„ç†æ¡†æ¶Apache Sparkè®¾è®¡ä¸å®ç°(<a href="https://book.douban.com/subject/35140409/">https://book.douban.com/subject/35140409/</a>)  è®¸åˆ©æ°ã€æ–¹äºšèŠ¬ / ç”µå­å·¥ä¸šå‡ºç‰ˆç¤¾</p></li></ul>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Parallel Data Processing with MapReduce: A Survey</title>
      <link href="/2023/06/14/Parallel-Data-Processing-with-MapReduce-A-Survey/"/>
      <url>/2023/06/14/Parallel-Data-Processing-with-MapReduce-A-Survey/</url>
      
        <content type="html"><![CDATA[<p>ä¸Šæ¬¡å†™ MapReduce çš„æ–‡ç« è¿˜æ˜¯åœ¨å¾ˆä¹…ä¹‹å‰ï¼Œè®°å¾—å¤§å››ä¸‹å­¦æœŸæ¯•ä¸šå†™ 6.824 çš„æ—¶å€™å†™çš„ï¼š<a href="https://blog.mwish.me/2020/01/28/MapReduce-%E7%AE%80%E8%AF%BB/">https://blog.mwish.me/2020/01/28/MapReduce-%E7%AE%80%E8%AF%BB/</a> ã€‚è°çŸ¥é“è¿™é—¨è¯¾éƒ½æ”¹åå« 6.8540 äº†ã€‚</p><p>Parallel Data Processing with MapReduce: A Survey è¿™ç¯‡ SIGMODâ€˜11 çš„è®ºæ–‡åœ¨ MapReduce å‘è¡¨å‡ å¹´åæ€»ç»“äº†ä¸€ä¸‹ MapReduce çš„ä¼˜åŠ£ã€‚æˆ‘ä»¬ä¼šå¸¦ç€è¿™ç¯‡è®ºæ–‡çš„ Point å»çœ‹çœ‹ä¸€äº›åç»­çš„åˆ†å¸ƒå¼è®¡ç®—ã€‚</p><p>MR åœ¨ 04 å¹´æ¨å‡ºçš„æ—¶å€™ç®—æ˜¯ç»„äº†ä¸€å †åƒåœ¾æœºå™¨ï¼Œç„¶åæ‹¼å‡‘çš„ä¸€ä¸ªæ»¡è¶³ Google æœç´¢ç­‰è®¡ç®—éœ€æ±‚çš„ç³»ç»Ÿï¼ŒScalable ä¸Šå…¶å®é—®é¢˜æ²¡é‚£ä¹ˆå¤§ï¼ˆä¸è®¨è®ºå…·ä½“ç®—å­çš„è¯ï¼‰ï¼Œä½†æ˜¯ performance å’Œ efficiency ä¸Šå¯èƒ½æ²¡é‚£ä¹ˆå°½äººæ„ï¼Œæ¯•ç«Ÿä¸‰å‰¯æœ¬å†™ã€è½ç›˜ç­‰æ–¹å¼åœ¨ 2023 å¹´å¥½æ—¶ä»£çš„è½¯ä»¶å·¥ç¨‹å¸ˆçœ‹æ¥å…¶å®æ˜¯ä¼˜ç‚¹è®©äººå›°æƒ‘çš„ã€‚ä¸è¿‡äº‹å®è¯æ˜ï¼Œè¿™å¥—ä¸œè¥¿å—åˆ°äº†å¾ˆå¤šäººçš„æ¬¢è¿ã€‚è™½ç„¶å¤§éƒ¨åˆ†äººè§‰å¾—è¿™å¥—ä¸œè¥¿å…¶å®æ˜¯ä¸€ä¸ªå†å²çš„é€€æ­¥ï¼ŒMapReduce -&gt; Hadoop è¿™å¥—ä¸œè¥¿ä¹Ÿæ…¢æ…¢è¢«åæ¥çš„ä¸œè¥¿å–ä»£äº†ï¼Œä½†æ˜¯è¿™ä¸­é—´å‡ºç°çš„å¾ˆå¤šåè¯å’Œæ¦‚å¿µè¿˜æ˜¯æœ‰å»¶ç»­æ€§çš„ï¼Œæ¯•ç«Ÿå¦‚æœè®¨è®ºåˆ°åˆ†å¸ƒå¼è®¡ç®—çš„å„ç§ç®—å­ï¼Œ Shuffle / Sort è¿™äº›ä¸œè¥¿çš„ä¼˜åŒ–å…¶å®ä¹Ÿå¯èƒ½æ˜¯æ ¹æ®è¿™äº›æœ€æ—©çš„æ¦‚å¿µä¸€æ­¥æ­¥æ¥çš„ã€‚åŒ…æ‹¬ä¸€äº› Push/Pull ä¹‹ç±»çš„è®¨è®ºï¼Œå’Œè®ºæ–‡æå‡ºçš„ä¸€äº›è¿œè§ï¼Œæ„Ÿè§‰æ¦‚å¿µè¿˜æ˜¯æœ‰å»¶ç»­æ€§çš„ã€‚åœ¨çœ‹ Spark RDD ä¹‹å‰æˆ‘ä»¬è¿˜æ˜¯å…ˆæ¥å›é¡¾ä¸€ä¸‹å¤è€çš„ MapReduce å§ã€‚</p><h2 id="Architecture"><a href="#Architecture" class="headerlink" title="Architecture"></a>Architecture</h2><p><img src="https://image.mwish.me/blog-image/5038885A-E1C0-404D-8CF7-7332A7477439.png" alt="5038885A-E1C0-404D-8CF7-7332A7477439"></p><p>MapReduce çš„æ¶æ„å¾ˆç®€å•ï¼š</p><ol><li>æŠŠç¨‹åºï¼ˆå¯èƒ½ä»¥ Binary ç­‰æ–¹å¼ï¼‰åˆ†å¸ƒåˆ° Mapper / Reducer ä¸Šï¼Œç¼–å†™ Map å’Œ Reduce å‡½æ•°</li><li>ç¨‹åºåˆ†ä¸º Map å’Œ Reduce ä¸¤ä¸ª Stageï¼Œæ•°æ® Stage éƒ½è¯»å–å¹¶è½åˆ° GFS ä¸Šï¼Œä¸ºäº†å®¹é”™å†™ä¸‰å‰¯æœ¬ï¼Œè¯»ä¹Ÿèµ° GFS (HDFS) æ¥è¯»å–</li><li>Map Stage çš„åˆ†å¸ƒå’Œ Input Block è¿˜æœ‰ Map çš„æœºå™¨æœ‰å…³ã€‚Block è¢«åˆ†é…ç»™ Mapperï¼Œæ‰§è¡Œå°½é‡æ— çŠ¶æ€çš„ Map å‡½æ•°ï¼Œç„¶åå¯èƒ½ä¼šèµ°ä¸€ä¸ªæœ¬åœ°æ’åºæ¥åšä¸€ä¸‹ Map-Key çš„ Group Byã€‚æœ€åèµ°ä¸€ä¸ª optional çš„ <code>Combiner</code> ï¼ˆç±»ä¼¼ Map ç«¯é¢„ Reduce æˆ–è€…åˆ«çš„é€»è¾‘ï¼‰æ¥æå‰å‡å°‘æ•°æ®é‡ I/O å¸¦å®½<ol><li>Map Stage çš„ç»“æœå­˜æ”¾åœ¨ <strong>æœ¬åœ°æˆ–è€…å¤šå‰¯æœ¬çš„å­˜å‚¨ä¸Š</strong>ï¼Œç„¶åæŒ‰ç…§ Reduce Task çš„æ•°é‡åšä¸€ä¸ª Partitionï¼Œè¿™é‡Œ Partition æˆ R ä»½ï¼Œé€šå¸¸æ˜¯ <code>hash(key) mod R</code> çš„å½¢å¼ã€‚è¿™é‡Œå¯èƒ½ä¼šæœ‰ä¸€ä¸ª Buffer å’Œ Spill-sizeï¼Œå¤„ç†çš„æ—¶å€™å†…å­˜è£…ä¸ä¸‹å¯ä»¥ Spill æ–‡ä»¶æˆ–è€…åˆå¹¶</li><li>å¯èƒ½ä¼šæœ‰ä¸€ä¸ª shuffle çš„æµç¨‹ï¼Œåœ¨ Map å†™ä¸‹å»ä¹‹å‰ï¼Œä¼šèµ° Hash Shuffle æˆ–è€… Sort Shuffleï¼ŒæŠŠæ•°æ®æ’åºä¸€éå†™å…¥ï¼Œé¿å… Reduce é˜¶æ®µæ‰“å¼€è¿‡å¤šçš„ Readerï¼Œå’ŒåŠ é€Ÿä¸‹æ¸¸ Reducer è¯»å–æ•°æ®ã€‚</li></ol></li><li>åœ¨Map Stage ä»»åŠ¡æ‰§è¡Œå®Œä¹‹å‰ï¼ŒReduce Stage ä¸èƒ½å·¥ä½œ. è¿™é‡Œå…¶å®å¯ä»¥æœ‰ä¸€äº›æ›´ flexible çš„æ¨¡å‹ï¼Œæ¯”å¦‚ Mapper ç›´æ¥æŠŠæ•°æ® push åˆ° Reducerï¼Œä½†æ˜¯è¿™æ · Reducer æŒ‚äº†äº‹æƒ…å¯èƒ½å°±ä¼šå˜éº»çƒ¦äº†ï¼Œæ‰€ä»¥å¯ä»¥è½ä¸€æ¬¡ç›˜</li><li>åœ¨ Reduce é˜¶æ®µï¼Œ<strong>ä¸€èˆ¬ä¸€æ¡ Record åªä¼šå‘ç»™ä¸€ä¸ª Reducer</strong> (Recall: JOIN). Reducer ä»¥ <strong>Pull</strong> æ¨¡å¼å»èµ° IPC æ‹‰æ•°æ®ã€‚è¿™é‡Œæœ‰ä¸ªç±»ä¼¼ External Merge Sort çš„æ–¹å¼æ¥è¯»å– â€” Merge æ•°æ®ï¼Œå› ä¸ºéœ€è¦è¯»å–å¤šä»½å¥‡æ€ªçš„æ•°æ®ã€‚æœ€åæŠŠ Reduce ç»“æœè¾“å‡ºåˆ° HDFSã€‚åœ¨åŸè®ºæ–‡ä¸­ï¼ŒReducer æ‹‰åˆ°æ•°æ®éœ€è¦æ’åºä¸€éã€‚</li><li>Stage å†… Task å’Œæœºå™¨æ•°é‡å¯ä»¥ä¸ç›¸ç­‰ï¼ŒMapReduce æ¡†æ¶ä¼šç›‘æ§çœ‹ä½ æ‰§è¡Œçš„å¿«ä¸å¿«ã€‚æ‰§è¡Œå¿«çš„èŠ‚ç‚¹å¯ä»¥å¤šæ‰§è¡Œå‡ ä¸ªä»»åŠ¡ï¼Œæ‰§è¡Œæ…¢çš„å¯ä»¥è®¾ç½®è¶…æ—¶ç„¶åæ¢äººè·‘ã€‚è¿™ä¹Ÿå®ç°äº†å¯¹åº”çš„ Fault Tolerant å’Œè‡ªåŠ¨çš„ load balanceã€‚</li><li>Hadoop ç³»å¯èƒ½æœ‰ Yarn ä¹‹ç±»çš„æ¡†æ¶ï¼Œæ¥ç»™å®šå¯¹åº”å†…å­˜çš„ç”³è¯·ï¼Œç„¶åæŠŠä»»åŠ¡ã€è°ƒåº¦å’Œå¯¹åº”çš„ä»»åŠ¡ç»‘å®šã€‚</li></ol><p><img src="https://image.mwish.me/blog-image/09C1DE3C-5A3E-4246-97C4-A52B148A6D93.png" alt="09C1DE3C-5A3E-4246-97C4-A52B148A6D93"></p><p>MapReduce å¯ä¸å¯ä»¥åªæœ‰ä¸€ä¸ªé˜¶æ®µå‘¢ï¼Ÿæ¯”å¦‚ Filter æˆ–è€… Project å¯èƒ½ä¼šåªæœ‰ Map é˜¶æ®µï¼Œ</p><h2 id="Pros-and-cons"><a href="#Pros-and-cons" class="headerlink" title="Pros and cons"></a>Pros and cons</h2><p>é¦–å…ˆ Stonebraker è¿™äº›åšæ•°æ®åº“çš„äººè§‰å¾—è´¼å‡ æŠŠä¸çˆ½ï¼Œè‡ªå·±ä¼˜åŒ–çš„å¥½å¥½çš„çªç„¶æ¥ä¸€æ³¢äººå†™äº†ä¸ªå¾ˆæŒ«çš„æ¶æ„ç„¶åè¿˜å¾ˆå—æ¬¢è¿ã€‚æ¥ä¸‹æ¥åˆä¸€äº›åšå®¢çš„å¯¹çº¿ã€‚å†å²å…¶å®æ˜¯å¾ˆæ¸…æ™°çš„ï¼Œæƒ³å¿…åœ¨åº§çš„å„ä½éƒ½çŸ¥é“è¿™äºŒåå¹´éƒ½ç»å†äº†ä»€ä¹ˆç ´äº‹ã€‚</p><blockquote><p>Anderson et al also criticize that the current Hadoop system is scalable, but achieves very low eï¬ƒciency per node, less than 5MB/s processing rates, repeating a mistake that previous studies on high-performance systems often made by â€œfocusing on scalability but missing eï¬ƒciencyâ€ [32]. This poor eï¬ƒciency involves many issues such as performance, total cost of ownership(TCO) and energy. Although Hadoop won the 1st position in GraySort benchmark test for 100 TB sorting(1 trillion 100-byte records) in 2009, its winning was achieved with over 3,800 nodes [76]. MapReduce or Hadoop would not be a cheap solution if the cost for constructing and maintaining a cluster of that size was considered.</p></blockquote><p>ï¼ˆé¢˜å¤–è¯ï¼Œéšç€ç¡¬ä»¶å‘å±• MotherDuck ç”šè‡³åœ¨ç½‘ä¸Šå‘åšå®¢è¯´å¤§æ•°æ®ä¸å­˜åœ¨äº†ï¼Œæ„æ€æ˜¯é™¤äº†å¤§å…¬å¸çš„æ•°æ®å…¶ä»–å°å…¬å¸çš„è·‘ä¸ªå•æœºåµŒå…¥å¼å·®ä¸å¤šå¾—äº†ã€‚æˆ‘ä¸ç½®å¯å¦ä¸è¿‡ä¹Ÿå¾ˆå¥½å¥‡ä»–ä»¬å‡†å¤‡æ€ä¹ˆèµšé’±ï¼‰</p><p>æ¯”è¾ƒæœ‰æ„æ€çš„æ˜¯ï¼Œè¿™é‡ŒæŠ½è±¡å‡ºäº†ä¸€ä¸ªæ¨¡å‹ï¼Œæ¨¡å‹æœ‰ä¸‹é¢å‡ ç‚¹ï¼š</p><ol><li>Efficiency</li><li>Fault Tolerant</li></ol><p>è¿™é‡Œçš„è§‚ç‚¹æ˜¯ï¼ŒMR æœ‰ç€å¾ˆå¼ºçš„ Fault Tolerantï¼Œå–è€Œä»£ä¹‹çš„æ˜¯ç¢æˆæ¸£çš„ Efficiencyï¼Œå› ä¸ºå®ƒè¦å¾ˆé¢‘ç¹çš„å»åš Local File IO ï¼ˆä¸è€ƒè™‘è¾“å…¥ç«¯å’Œè¾“å‡ºç«¯ï¼‰æˆ–è€…ä½œä¸º checkpointã€‚ä½œä¸ºå¯¹æ¯”ï¼ŒEfficient çš„ä»£è¡¨æ˜¯ä½†æ˜¯çš„æ•°æ®åº“ï¼Œå–è€Œä»£ä¹‹çš„å¯èƒ½æ˜¯å¯¹ Batch Jobï¼Œå¯¹é‡ä»»åŠ¡çš„é‡è¯•ä¸å‹å¥½ã€‚éšåï¼Œä½œè€…æŠ¥èœåçš„ä»‹ç»äº†ä¸€ä¸‹ MapReduce çš„ä¼˜ç‚¹å’Œç¼ºç‚¹ï¼š</p><h3 id="ä¼˜ç‚¹"><a href="#ä¼˜ç‚¹" class="headerlink" title="ä¼˜ç‚¹"></a>ä¼˜ç‚¹</h3><p>(è¿™ä¸€æ®µæˆ‘çœ‹çš„æ¯”è¾ƒå›°æƒ‘ï¼Œå¯èƒ½æ²¡åšè¿‡è®¡ç®—æ˜¯è¿™æ ·çš„)</p><ol><li>Flexible: ??? è‡³å°‘ä½ å¯ä»¥æ— è§†æ•°æ®æ ¼å¼é€ å¤§ä¾¿</li><li>Independent of storage: å‘ƒå‘ƒå‘ƒâ€¦.è¿™ä¸ªå¯èƒ½æ˜¯è·Ÿç»‘å®šå­˜å‚¨çš„ MPP æ¯”è¾ƒçš„å§</li><li>Fault tolerance: è¿™ä¸ªæˆ‘è¿˜æ˜¯è®¤å¯çš„</li><li>High Scalabity: å…¶å®æˆ‘ä¸æ˜¯å¾ˆæ‡‚ scalableï¼Œæ„Ÿè§‰ DOP æ— è„‘å¾€å¤§åˆ‡ä¹Ÿä¸å¤ªå¥½å§ï¼Œä½†è‡³å°‘å¯¹ä¸€äº›éœ€è¦å¹¶å‘çš„ Batch Job å¯èƒ½ç¡®å®æ˜¯ä¼˜åŠ¿ï¼Ÿï¼ˆ2023 å¹´çš„æœºå™¨å’Œ 2004 å¹´å·²ç»ä¸ä¸€æ ·äº†ã€‚ã€‚ã€‚ï¼‰</li></ol><h3 id="ç¼ºç‚¹"><a href="#ç¼ºç‚¹" class="headerlink" title="ç¼ºç‚¹"></a>ç¼ºç‚¹</h3><ol><li>No high-level language</li><li>No schema and no index</li><li><strong>A single fixed dataflow</strong></li><li>Low efficiency<ol><li>External Sort-Merge</li><li>Materialization of intermediate results</li><li>write to distributed file system (?)</li><li>block-level restrarts</li><li>one-to-one shuffle strategy (?)</li><li>simple runtime scheduling</li></ol></li></ol><h2 id="å¯¹-MapReduce-çš„æ”¹è¿›"><a href="#å¯¹-MapReduce-çš„æ”¹è¿›" class="headerlink" title="å¯¹ MapReduce çš„æ”¹è¿›"></a>å¯¹ MapReduce çš„æ”¹è¿›</h2><p>è¿™èŠ‚ä¸»è¦ä»‹ç»äº†ï¼ˆä½œè€…è®¤ä¸ºçš„ï¼‰MapReduce çš„é—®é¢˜ï¼Œæˆ‘æœ¬æ¥è›®æœŸå¾…è¿™èŠ‚çš„ï¼Œä½†æ˜¯è¯»ç€è¯»ç€å‘ç°å†™çš„è¿˜æ˜¯å¤ªæ—©äº†ï¼Œå¾ˆå¤šæ”¹è¿›çš„ç³»ç»Ÿéƒ½å·²ç»æ­»äº†ã€‚è¯»è¿™èŠ‚çš„æ—¶å€™ï¼Œä¸»è¦è¿˜æ˜¯å…³æ³¨ï¼Œåœ¨ 2023 å¹´è¿™ä¸ªèŠ‚ç‚¹ï¼Œå¤§æ•°æ®ç³»ç»Ÿæ˜¯æ€ä¹ˆå…‹æœè¿™äº›é—®é¢˜çš„ã€‚</p><h3 id="High-Level-Languages"><a href="#High-Level-Languages" class="headerlink" title="High-Level Languages"></a>High-Level Languages</h3><p>å¾®è½¯çš„ SCOPE, Apache Pig, Apache Hive éƒ½åŒ…å«ä¸Šå±‚è¯­è¨€ç›¸å…³çš„æ”¹è¿›ï¼ŒåŒ…æ‹¬ Spark çš„æ¨¡å‹ä¹Ÿæ”¯æŒ DataFrame å’Œ SQL ä¸¤ç§å½¢å¼ã€‚è¿™é‡Œæ¯”è¾ƒè‘—åçš„æ˜¯å¾®è½¯çš„ SCOPE ä¸Šçš„ DryadLinq å’Œ Spark SQLã€‚éƒ½èƒ½å¤ŸæŠŠ SQL è½¬æˆ<strong>è‡ªå·±çš„æ‰§è¡Œæµ</strong>ã€‚</p><p>æˆ‘ä»¬ä¹‹å‰ä»‹ç»è¿‡ Hiveï¼ŒHive æ”¯æŒ Hive QLï¼Œæ”¯æŒ adhoc queryã€‚Hive å¦‚æœåå°æ˜¯ MRï¼Œå®ƒæ”¶åˆ° SQL ä¼šç¼–è¯‘äº§ç”Ÿä¸€ç»„ Stageï¼Œç„¶å Stage ä»£è¡¨å¯¹åº”çš„ MR Jobã€‚</p><h3 id="Schema-Support"><a href="#Schema-Support" class="headerlink" title="Schema Support"></a>Schema Support</h3><p>Schema æœ‰å¥½å‡ å±‚å«ä¹‰ï¼Œè¿™é‡Œä¸»è¦æŒ‡çš„æ˜¯ MapReduce è®ºæ–‡ä¸­æœ¬èº«å¤„ç†çš„æ˜¯çº¯æ–‡æœ¬æˆ–è€…äºŒè¿›åˆ¶ï¼Œæ‰€ä»¥è¿‡äº flexible çš„é—®é¢˜ï¼Œå®é™…ä¸Šè¿™é‡Œçš„è§£å†³æ–¹å¼æœ‰ä¸Šå±‚æä¾› Schema å’Œæä¾›ä¸€å®šçš„æ ¼å¼ã€‚å®é™…ä¸Šå¾ˆå¤šæ ¼å¼æœ¬èº«å°±æ˜¯ã€Œå¤§æ•°æ® / Hadoop ç³»ã€æå‡ºæ¥çš„ï¼Œæ¯”å¦‚ Avroã€Parquetã€ORC è¿™å‡ ä¸ªæ ¼å¼éƒ½å¤šå°‘æ˜¯ä»ã€Œå¤§æ•°æ®ç¤¾åŒºã€å­µåŒ–å‡ºæ¥çš„ã€‚</p><p>å…³äºè¿™ä¸ªï¼Œæ„Ÿè§‰ Schema Support æœ¬èº«ä¹Ÿæ˜¯è®¨è®ºçƒ‚äº†çš„å†…å®¹äº†ã€‚</p><h3 id="Flexible-Data-Flow"><a href="#Flexible-Data-Flow" class="headerlink" title="Flexible Data Flow"></a>Flexible Data Flow</h3><p>Flexible Data Flow ä¸»è¦åœ¨äº Map / Reduce æ¨¡å‹æœ¬èº«çš„ä¼˜åŒ–å’Œæ”¹è¿›ï¼Œæ¯”å¦‚ä¸€äº›ç®—æ³•æœ¬èº«è¦ç»´æŠ¤ä¸€äº›å¤„ç†æ•°æ®çš„çŠ¶æ€ã€‚</p><p>ä¸€äº›æ”¹è¿›ï¼Œæ¯”å¦‚ Map-Reduce è¦è¯»å¤šä¸ªè¾“å…¥çš„æ—¶å€™ï¼ˆæ¯”å¦‚ Joinï¼‰ï¼Œå¯èƒ½ä¼šæœ‰ä¸€ä¸ª Map-Reduce-Merge çš„æ¨¡å‹.</p><p>ä¸è¿‡ï¼Œç°åœ¨çš„ç‰ˆæœ¬å® å„¿æ˜¯ Spark / Dryad è¿™æ ·çš„ç±»ä¼¼ DAG çš„æµã€‚é€šè¿‡ ç‚¹ï¼ˆè®¡ç®—ï¼‰å’Œè¾¹ï¼ˆTCP / å†…å­˜ / è½æ–‡ä»¶è¿™æ ·çš„é€šä¿¡ï¼‰æ¥æ„æˆå¯¹åº”çš„è®¡ç®—ã€‚è¿™äº›ä¸œè¥¿ä¸€èµ·å—åˆ° Runtime çš„è°ƒåº¦ã€‚</p><h3 id="Blocking-Operations"><a href="#Blocking-Operations" class="headerlink" title="Blocking Operations"></a>Blocking Operations</h3><p>MapReduce çš„è®¡ç®—æµç±»ä¼¼ BSP æ¨¡å‹ï¼Œä¸æ‰§è¡Œå®Œä¸Šä¸€éƒ¨å°±ä¸èƒ½æ‰§è¡Œä¸‹ä¸€æ­¥ï¼Œè¿™æ ·ä¹Ÿä¸æ˜¯å¾ˆå¥½å¤„ç†<strong>å¢é‡çš„è¯·æ±‚å’Œ Online Processing</strong>ï¼ˆ Google å½“æ—¶ç”¨ MapReduce è·‘æ‰¹ï¼Œç„¶åèµ° Percolator çš„å° TP è¯·æ±‚æ¥æ’å…¥æ–°çš„æ•°æ®ï¼‰ï¼Œä¹Ÿä¸æ”¯æŒ Streaming è¿™æ ·çš„ä¸œè¥¿ï¼Œè¿™é‡Œä¹Ÿæœ‰ä¸€äº›å¯¹åº”çš„æ›´æ–°çš„æ¨¡å‹ã€‚æˆ‘ä¸ªäººæ„Ÿè§‰è¿™é‡Œæ¨¡å‹æœ¬è´¨ä¸Šè¿˜æ˜¯è¯´ï¼ŒMR è¿™ç±»ä¸œè¥¿åªé€‚åˆè·‘æ‰¹ï¼Œéœ€è¦åœ¨åŒæ ·çš„æ¨¡å‹ä¸Šæ”¯æŒä¸€äº›è½»é‡çš„æ“ä½œã€‚</p><p>æˆ‘ä¸ªäººæ„Ÿè§‰ Lakehouse / Delta-Lake è¿™ç§ï¼ˆåŒ…æ‹¬ Paimon è¿™ç§ Flink Table Formatï¼‰ï¼š</p><ol><li>ä¸€ä¸ªé€šç”¨çš„ Table Formatï¼Œæœ‰æ¯”è¾ƒé€‚åˆæ’å…¥çš„ç»“æ„</li><li>ä¸€ä¸ªå¼ºåŠ²çš„ meta</li></ol><h3 id="I-O-Optimization"><a href="#I-O-Optimization" class="headerlink" title="I/O Optimization"></a>I/O Optimization</h3><p>Parquet / ORC è¿™ç§ç»“æ„åœ¨ I/O ç­‰ Optimize ä¸Šæ•ˆæœæ˜¾è‘—ã€‚</p><h3 id="Scheduling-TBD"><a href="#Scheduling-TBD" class="headerlink" title="Scheduling(TBD)"></a>Scheduling(TBD)</h3><p>è°ƒåº¦æœ‰é—®é¢˜ä¸»è¦æ˜¯ MR è®ºæ–‡çš„è°ƒåº¦å¤ª sb äº†ï¼Œè¿™é‡Œæåˆ°äº†ä¼°è®¡ä¼°ç®—ç­‰ï¼Œæˆ‘æ„Ÿè§‰è¿™é‡Œä¸»è¦å…³æ³¨ Yarn çš„è°ƒåº¦ç­‰ã€‚è¿™ä¸ªä¹‹åä¸“é—¨å†™ä¸€ç¯‡åšå®¢å§ã€‚</p><ul><li>å¯¹ä»»åŠ¡æœ¬èº«çš„èµ·æ­¢é‡è¯•ç­‰è¿›è¡Œä¼°è®¡</li><li>è¿˜æœ‰ä¸€ä¸ªé—®é¢˜æ˜¯ï¼Œå¦‚æœ MR çš„é›†ç¾¤æ˜¯å…±äº«çš„ï¼Œé‚£ä¹ˆå¤šç§Ÿæˆ·è¿™ä¸€ä¸ªå±‚æ¬¡çš„è°ƒåº¦ã€‚</li><li>å¦‚æœæœ‰ç›¸ä¼¼çš„è®¡ç®—ï¼Œé¿å…é‡å¤è®¡ç®—ï¼ˆå…±äº«è¯·æ±‚ï¼‰</li></ul><h3 id="Joins"><a href="#Joins" class="headerlink" title="Joins"></a>Joins</h3><p>Map Reduce æœ¬èº«åªæ”¯æŒä¸€ä¸ª inputï¼Œæ‰€ä»¥ Join æ˜¯ä¸€ä¸ªåœ¨ä¸Šé¢éœ€è¦ç»•å¼¯å¼¯è§£å†³çš„é—®é¢˜ã€‚è¿™é‡Œæœ‰å‡ ç§å¯¹åº”çš„æ–¹æ¡ˆï¼š</p><ol><li>Map-side Join: å®ç°æ–¹å¼ç±»ä¼¼ RDBMS çš„ SMJ, æ ¹æ® key æ¥åš partitionï¼Œç„¶åè¢« Join åˆ°ä¸€èµ·ã€‚å¦ä¸€ç§æ˜¯å¯¹åº”çš„ broadcast Join. Map-side join ä¸€å®šç¨‹åº¦ä¸Šèƒ½å‡å°å¯¹åº”çš„ç½‘ç»œå’Œä¼ è¾“å¼€é”€ã€‚broadcast join ä¹Ÿå¯ä»¥åœ¨ Map é˜¶æ®µæå®š</li><li>Reduce-side Join: æœ€é€šç”¨çš„ Join. Map æ¥åšå¯¹åº”çš„æ ‡è®°ï¼Œç„¶åæ¥åš key-equality join.</li><li>Map-Reduce-Merge: åœ¨ Reduce ååŠ ä¸€ä¸ª Merge é˜¶æ®µï¼Œç±»ä¼¼ Filtering-Join-Agg çš„æ¨¡å¼</li></ol><p>æˆ‘ä»¬ä»¥ Hive ä¸ºä¾‹å­ï¼ŒHive ä¼šæœ‰ï¼š</p><ol><li>å‘ç”Ÿåœ¨ Shuffle / Reduce é˜¶æ®µçš„<ol><li>Map: è¯»å– A, B çš„æ•°æ®ï¼Œç„¶åæ ¹æ® Join æ¡ä»¶å‘å¾€ Reduceï¼ˆå¯èƒ½èµ° Shuffleï¼‰ï¼Œæ£€æµ‹ Key ç›¸åŒçš„ï¼Œåš Join</li></ol></li><li>å‘ç”Ÿåœ¨ Map é˜¶æ®µçš„ï¼šMap ä¾§å®Œæˆæ“ä½œ<ol><li>æœ‰ä¸€ä¸ª Stage è¯»å–å°è¡¨ï¼Œç„¶åå­˜ HashTable åˆ°æ–‡ä»¶ç³»ç»Ÿã€‚ç„¶åä»»åŠ¡ä¸­ Map é˜¶æ®µè¯»å®ƒï¼Œåš Join</li></ol></li><li>å¯ä»¥åš Bucket Map Join, Table 1 å’Œ Table 2 çš„ bucket æˆå€æ•°å…³ç³»å¯ä»¥å¿«é€Ÿ Bucket è£å‰ª</li><li>å¯èƒ½éœ€è¦å¤„ç† Skew Dataï¼Œç‰¹æ®Šåˆ†é…ä¸€ä¸ªä½œä¸šå¤„ç† Skew çš„æ•°æ®</li></ol><h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><ul><li>Hive æ€§èƒ½è°ƒä¼˜å®æˆ˜ æ—å¿—ç…Œ ç…®</li><li>Parallel Data Processing with MapReduce: A Survey</li></ul>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>ToyDB Query Parsing</title>
      <link href="/2023/06/07/ToyDB-Query-Parsing/"/>
      <url>/2023/06/07/ToyDB-Query-Parsing/</url>
      
        <content type="html"><![CDATA[<p>ToyDB æä¾›äº†æ‰‹åŠ¨è§£æçš„ Parser å’Œè‡ªå·±å†™çš„ Catalog å’Œ Plannerï¼ŒCatalog. å®ƒæœ‰ä¸€ä¸ªå¾ˆå¥‡æ€ªçš„ç‰¹ç‚¹å°±æ˜¯ï¼Œå¤§å®¶éƒ½å«ä¸€ä¸ªåå­—ï¼Œç„¶åä» modules æ¥åŒºåˆ†ã€‚æˆ‘ä¸çŸ¥é“è¿™ç®—ä¸ç®—å¥½çš„å®è·µï¼Œåæ­£ç»™æˆ‘æ•´çš„æœ‰ç‚¹éº»ã€‚</p><p>è¿™é‡Œæˆ‘æŠ˜è…¾äº†ä¸€ä¸ªç®€å•çš„å¯ä»¥ç© query çš„åœºæ™¯ï¼š<a href="https://github.com/mapleFU/toydb">https://github.com/mapleFU/toydb</a> ï¼Œè§è¿™ä¸ªé¡¹ç›®é‡Œçš„ <code>test_basic_sql</code>ã€‚</p><h2 id="Catalog"><a href="#Catalog" class="headerlink" title="Catalog"></a>Catalog</h2><p>ToyDB çš„ Catalog å’Œ Transaction æ˜¯åŠç»‘å®šçš„ï¼ŒCatalog å’Œ Transaction éƒ½ä»¥ä¸€ä¸ª Trait çš„å½¢å¼æä¾›ã€‚ToyDB çš„ Catalog åªæ”¯æŒå•ä¸ª databaseï¼Œä¸æ”¯æŒ DDLã€‚ç³»ç»Ÿä¼šå­˜å‚¨åœ¨ä¸€ä¸ª Raft Key-Value çš„äº‹åŠ¡å¼•æ“ä¸Šï¼Œå­˜å‚¨å†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// Encodes SQL keys, using an order-preserving encoding - see kv::encoding for details. Options can</span></span><br><span class="line"><span class="comment">/// be None to get a keyspace prefix. We use table and column names directly as identifiers, to</span></span><br><span class="line"><span class="comment">/// avoid additional indirection and associated overhead. It is not possible to change names, so</span></span><br><span class="line"><span class="comment">/// this is ok. Uses Cows since we want to borrow when encoding but return owned when decoding.</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// æœ€åä¸€é¡¹å¯èƒ½ç”± Option æ„æˆ, Option ä¸ºç©ºçš„æ—¶å€™, å¯ä»¥æ‹¿åˆ°è¿™ä¸ª key</span></span><br><span class="line"><span class="comment">/// ç¼–ç : è¿™é‡Œä¼šæŠŠå¯¹åº”çš„å¯¹è±¡æ•´ç†æˆä¸€ä¸ª Key, Table / Index / Row å­˜æ”¾åœ¨ä¸åŒçš„ keyspace (ç±»ä¼¼ ns).</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// è¿™ä¸ªåŸºæœ¬ä¸Šå¥—äº†ä¸€å±‚ foundation db çš„ç¼–ç ç³»ç»Ÿã€‚</span></span><br><span class="line"><span class="keyword">enum</span> <span class="title class_">Key</span>&lt;<span class="symbol">&#x27;a</span>&gt; &#123;</span><br><span class="line">    <span class="comment">/// A table schema key for the given table name</span></span><br><span class="line">    <span class="comment">/// tableName.</span></span><br><span class="line">    <span class="comment">/// è¿™ä¸ªçš„ prefix ä¸º 0x01</span></span><br><span class="line">    <span class="title function_ invoke__">Table</span>(<span class="type">Option</span>&lt;Cow&lt;<span class="symbol">&#x27;a</span>, <span class="type">str</span>&gt;&gt;),</span><br><span class="line">    <span class="comment">/// A key for an index entry</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// (tableName, columnName, value).</span></span><br><span class="line">    <span class="title function_ invoke__">Index</span>(Cow&lt;<span class="symbol">&#x27;a</span>, <span class="type">str</span>&gt;, Cow&lt;<span class="symbol">&#x27;a</span>, <span class="type">str</span>&gt;, <span class="type">Option</span>&lt;Cow&lt;<span class="symbol">&#x27;a</span>, Value&gt;&gt;),</span><br><span class="line">    <span class="comment">/// A key for a row identified by table name and row primary key</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// (tableName, value)</span></span><br><span class="line">    <span class="title function_ invoke__">Row</span>(Cow&lt;<span class="symbol">&#x27;a</span>, <span class="type">str</span>&gt;, <span class="type">Option</span>&lt;Cow&lt;<span class="symbol">&#x27;a</span>, Value&gt;&gt;),</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯¹åº” Trait å¦‚ä¸‹ï¼š</p><ul><li>Catalog, Schema, Column, Table: <a href="https://github.com/erikgrinaker/toydb/blob/master/src/sql/schema.rs">https://github.com/erikgrinaker/toydb/blob/master/src/sql/schema.rs</a><ul><li>Column æœ‰åŸºæœ¬çš„ <code>(name, type)</code> æ”¯æŒ default, pk, nullable, unique, foreign key ç”šè‡³ indexï¼Œæ”¯æŒä¸Šå±‚å» validate å¯¹åº”çš„ valueï¼Œè¿™ä¸ªæ£€æŸ¥ã€‚ï¼ˆè™½ç„¶æœ‰çš„åœ°æ–¹æˆ‘æ„Ÿè§‰ä¸åº”è¯¥åœ¨ Column é‡Œé¢æ”¯æŒï¼‰</li><li>Table å³ <code>&lt;name: String, columns: [Column]&gt;</code>ï¼Œåœ¨å•ä¸ª Table å†…ï¼Œåªæœ‰å•ä¸ª key æ˜¯ä¸»é”®ï¼Œä¸æ”¯æŒè”åˆä¸»é”®ã€‚Index ä¹Ÿåªæ”¯æŒå•å€¼çš„ Indexï¼Œä¸æ”¯æŒè”åˆç´¢å¼•</li><li>Schema è¿™é‡Œä¼šè®¿é—®ç‰©ç†å±‚ï¼Œæ¥æ‹¿åˆ°å¯¹åº”çš„å†…å®¹ã€‚</li><li>å®ƒçš„ Catalog è¿™ä¸ªåœ°æ–¹æ”¯æŒçš„æ˜¯è®¿é—® Table çš„æ¥å£</li><li>è®¨è®ºï¼šåœ¨ Column æ”¯æŒ pk, default, unique, fk åº”è¯¥ä¸æ˜¯ä¸€ä¸ªåˆç†çš„æ–¹æ¡ˆã€‚</li></ul></li></ul><h2 id="Parsing"><a href="#Parsing" class="headerlink" title="Parsing"></a>Parsing</h2><p>è¿™é‡Œçš„ Lexer ä¸å¤ªæ•™ç§‘ä¹¦ï¼Œè€Œæ˜¯æ‰‹å·¥ç¼–å†™çš„ä¸€ä¸ªè¯†åˆ«å™¨ï¼Œæˆ‘æ„Ÿè§‰ç”¨ flex å†™ä¸€ä¸ªæ²¡å‡†è¿˜èˆ’æœäº›ã€‚</p><p>è¯­æ³•åˆ†æåˆ™æ˜¯ä¸€ä¸ªé€’å½’ä¸‹é™çš„ Parsingï¼Œè¯­æ³•ç»“æ„å¦‚ä¸‹ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// Parses an SQL statement</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">parse_statement</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;ast::Statement&gt; &#123;</span><br><span class="line">    <span class="keyword">match</span> <span class="keyword">self</span>.<span class="title function_ invoke__">peek</span>()? &#123;</span><br><span class="line">        <span class="title function_ invoke__">Some</span>(Token::<span class="title function_ invoke__">Keyword</span>(Keyword::Begin)) =&gt; <span class="keyword">self</span>.<span class="title function_ invoke__">parse_transaction</span>(),</span><br><span class="line">        <span class="title function_ invoke__">Some</span>(Token::<span class="title function_ invoke__">Keyword</span>(Keyword::Commit)) =&gt; <span class="keyword">self</span>.<span class="title function_ invoke__">parse_transaction</span>(),</span><br><span class="line">        <span class="title function_ invoke__">Some</span>(Token::<span class="title function_ invoke__">Keyword</span>(Keyword::Rollback)) =&gt; <span class="keyword">self</span>.<span class="title function_ invoke__">parse_transaction</span>(),</span><br><span class="line"></span><br><span class="line">        <span class="title function_ invoke__">Some</span>(Token::<span class="title function_ invoke__">Keyword</span>(Keyword::Create)) =&gt; <span class="keyword">self</span>.<span class="title function_ invoke__">parse_ddl</span>(),</span><br><span class="line">        <span class="title function_ invoke__">Some</span>(Token::<span class="title function_ invoke__">Keyword</span>(Keyword::<span class="built_in">Drop</span>)) =&gt; <span class="keyword">self</span>.<span class="title function_ invoke__">parse_ddl</span>(),</span><br><span class="line"></span><br><span class="line">        <span class="title function_ invoke__">Some</span>(Token::<span class="title function_ invoke__">Keyword</span>(Keyword::Delete)) =&gt; <span class="keyword">self</span>.<span class="title function_ invoke__">parse_statement_delete</span>(),</span><br><span class="line">        <span class="title function_ invoke__">Some</span>(Token::<span class="title function_ invoke__">Keyword</span>(Keyword::Insert)) =&gt; <span class="keyword">self</span>.<span class="title function_ invoke__">parse_statement_insert</span>(),</span><br><span class="line">        <span class="title function_ invoke__">Some</span>(Token::<span class="title function_ invoke__">Keyword</span>(Keyword::Select)) =&gt; <span class="keyword">self</span>.<span class="title function_ invoke__">parse_statement_select</span>(),</span><br><span class="line">        <span class="title function_ invoke__">Some</span>(Token::<span class="title function_ invoke__">Keyword</span>(Keyword::Update)) =&gt; <span class="keyword">self</span>.<span class="title function_ invoke__">parse_statement_update</span>(),</span><br><span class="line"></span><br><span class="line">        <span class="title function_ invoke__">Some</span>(Token::<span class="title function_ invoke__">Keyword</span>(Keyword::Explain)) =&gt; <span class="keyword">self</span>.<span class="title function_ invoke__">parse_statement_explain</span>(),</span><br><span class="line"></span><br><span class="line">        <span class="title function_ invoke__">Some</span>(token) =&gt; <span class="title function_ invoke__">Err</span>(Error::<span class="title function_ invoke__">Parse</span>(<span class="built_in">format!</span>(<span class="string">&quot;Unexpected token &#123;&#125;&quot;</span>, token))),</span><br><span class="line">        <span class="literal">None</span> =&gt; <span class="title function_ invoke__">Err</span>(Error::<span class="title function_ invoke__">Parse</span>(<span class="string">&quot;Unexpected end of input&quot;</span>.<span class="title function_ invoke__">into</span>())),</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥ä»è¿™ä¸ªæ¥æ¨æ–­å‡ºå®ƒçš„ç»“æ„ï¼Œè¿™æ®µåº”è¯¥æ˜¯æŒ‰ç…§ standard å†™çš„ï¼Œè¿˜ç®—æœ‰å‚è€ƒä»·å€¼ã€‚å¯¹å¤–äº§ç”Ÿæœ€ç»ˆçš„ç»“æ„åœ¨ç›®å½• <code>ast</code> ä¸‹å¤´ï¼Œå…·ä½“æ˜¯ä¸€ä¸ª <code>ast::Statement</code>.</p><p>ç‰¹æ®Šçš„ï¼Œå¦‚æœæ˜¯ <code>SELECT *</code></p><h2 id="Planner"><a href="#Planner" class="headerlink" title="Planner"></a>Planner</h2><p>Planner è´Ÿè´£å°† <code>ast::Statement</code> è½¬ä¸º <code>Plan</code>. è¿™éƒ¨åˆ† Plan / PlanNode æœ¬èº«å°±æ˜¯å¯ä»¥è¿è¡Œçš„äº†ï¼Œé€šè¿‡èµ°ä¸€ä¸ªå¯é€‰çš„ Optimizer æ¥è¿›è¡Œä¼˜åŒ–ã€‚</p><p>è¿™ä¸ªåœ°æ–¹æ²¡æœ‰ä¸€ä¸ª ï¼ˆå•ç‹¬çš„ï¼‰Binder é˜¶æ®µæ¥ resolve nameï¼Œ</p><h3 id="Plan-Select"><a href="#Plan-Select" class="headerlink" title="Plan Select"></a>Plan Select</h3><h4 id="Scope"><a href="#Scope" class="headerlink" title="Scope"></a>Scope</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// Manages names available to expressions and executors, and maps them onto columns/fields.</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// Scope åŒ…å«ä¸€ç»„æœ‰åºçš„ columns. åŒæ—¶åŒ…å«é™å®šç¬¦, è¡¨ç¤ºè¿™äº›ä¸œè¥¿çš„å½’å±.</span></span><br><span class="line"><span class="meta">#[derive(Clone, Debug)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">Scope</span> &#123;</span><br><span class="line">    <span class="comment">// If true, the scope is constant and cannot contain any variables.</span></span><br><span class="line">    constant: <span class="type">bool</span>,</span><br><span class="line">    <span class="comment">// Currently visible tables, by query name (i.e. alias or actual name).</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// Table çš„åç§°é›†åˆ, æ„å»ºäº† alias / table_name -&gt; Table çš„æ˜ å°„</span></span><br><span class="line">    <span class="comment">// TODO(maple): è¿™ä¸ª Table æ˜¯æ€ä¹ˆæ„å»ºå‡ºæ¥çš„? å…·ä½“ binding å—?</span></span><br><span class="line">    tables: HashMap&lt;<span class="type">String</span>, Table&gt;,</span><br><span class="line">    <span class="comment">// Column labels, if any (qualified by table name when available)</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// columns æ˜¯è¡¨çš„ source-of-truth, ä¸‹é¢ä¸‰ä¸ª hash éƒ½æ˜¯æ ¹æ®è¿™ç©æ„é€ å‡ºæ¥çš„.</span></span><br><span class="line">    columns: <span class="type">Vec</span>&lt;(<span class="type">Option</span>&lt;<span class="type">String</span>&gt;, <span class="type">Option</span>&lt;<span class="type">String</span>&gt;)&gt;,</span><br><span class="line">    <span class="comment">// Qualified names to column indexes.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// qualified: æœ‰ table-name å’Œ field-name çš„, è¿™ä¸ªåœ°æ–¹ field-name å¯èƒ½æ˜¯ä¸€ä¸ª label.</span></span><br><span class="line">    qualified: HashMap&lt;(<span class="type">String</span>, <span class="type">String</span>), <span class="type">usize</span>&gt;,</span><br><span class="line">    <span class="comment">// Unqualified names to column indexes, if unique.</span></span><br><span class="line">    unqualified: HashMap&lt;<span class="type">String</span>, <span class="type">usize</span>&gt;,</span><br><span class="line">    <span class="comment">// Unqualified ambiguous names.</span></span><br><span class="line">    <span class="comment">// TODO(maple): ambiguous çš„ name æ˜¯æ€ä¹ˆ solving çš„?</span></span><br><span class="line">    ambiguous: HashSet&lt;<span class="type">String</span>&gt;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Expression"><a href="#Expression" class="headerlink" title="Expression"></a>Expression</h3><p>Expression çš„ solving é€šå¸¸ä¸éœ€è¦å˜æ›´ç±»å‹ï¼Œå­—é¢é‡æ˜¯ä»€ä¹ˆç±»å‹ä½¿ç”¨çš„å°±æ˜¯ä»€ä¹ˆç±»å‹ï¼Œè¿™é‡Œæ”¯æŒçš„ç±»å‹æœ‰ï¼š</p><ul><li>INTEGER: 1, 2, 3</li><li>FLOAT: 1.2</li><li>NULL</li><li>Boolean: true, false</li><li>String: <code>&#39;&#39;</code></li></ul><p>å¸¸é‡è§£æçš„æ—¶å€™ï¼Œä¸€èˆ¬å°±ç”¨ä¸Šé¢è¿™äº›ç±»å‹ï¼Œç„¶ååœ¨è¡¨è¾¾å¼ eval é˜¶æ®µåˆ¤æ–­ç±»å‹ã€‚</p><p>è¡¨è¾¾å¼ä¼šä» <code>Scope</code> ä¸­æåˆ°åå­—ï¼Œä» <code>ast::Expression</code> æ„å»ºä¸€ä¸ª <code>Expression</code> å®ƒä¼šæ„å»ºï¼š</p><ul><li>Literal: è¿”å› <em><code>Constant</code></em></li><li>Field: å¸¦æœ‰æ¥æºçš„ fieldId å’Œ table.name çš„åå­—ï¼Œè¿”å› <code>Field</code></li><li>Functionï¼š<em>å¾ˆé—æ†¾ï¼Œå®ƒæ²¡æœ‰å®ç°ä»»ä½• function</em><ul><li>æœäº†ä¸‹ï¼Œfunction å¤„ç†ä¸­ï¼Œå¯ä»¥å‚è€ƒè¿™ä¸¤ä¸ªã€‚toydb ç±»å‹å¤„ç†æ„Ÿè§‰æ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œfunction å’Œ ast::function ä¸€ä¸€å¯¹åº”<ul><li><a href="https://www.postgresql.org/docs/current/sql-expressions.html">https://www.postgresql.org/docs/current/sql-expressions.html</a></li><li><a href="https://duckdb.org/docs/sql/functions/date">https://duckdb.org/docs/sql/functions/date</a></li></ul></li></ul></li><li><strong>Column: è¿™ä¸ªæ¯”è¾ƒé‡è¦ï¼Œæ”¾åé¢è¯´ï¼Œè¿™ä¸ªåœ¨å®ƒçš„ SQL è¯­æ³•ä¸å­˜åœ¨ï¼Œå±äºå†…éƒ¨ç”Ÿæˆçš„</strong></li><li>Operation: ä» AND OR åˆ°åŠ å‡æ³•ç­‰ç­‰</li></ul><p>æ€»ä¹‹ï¼Œè¿™é‡Œä¼šæ„å»ºä¸€ä»½ Expression</p><h3 id="FromTable-TableRef-æ„å»º"><a href="#FromTable-TableRef-æ„å»º" class="headerlink" title="FromTable ( TableRef ) æ„å»º"></a>FromTable ( TableRef ) æ„å»º</h3><ul><li>é‡‡ç”¨</li></ul><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">build_from_clause:</span><br><span class="line">- copy ä¸€ä»½ root Scope</span><br><span class="line">- (å¯¹æ¯ä¸ªå­æˆå‘˜) (ä½¿ç”¨ root Scope) build_from_item</span><br><span class="line">  - (é€’å½’åŸº) å» catalog æŸ¥è¯¢æœ‰æ²¡æœ‰è¿™ä¸ªåå­—çš„è¡¨, ç„¶åèµ° `scope::add_table`, è¿”å›ä¸€ä¸ª Node::Scan</span><br><span class="line">  - (Join) å» build_from_item å·¦è¡¨, ç„¶åç”¨åŒä¸€ä¸ª scope å» build_from_item å³è¡¨</span><br><span class="line">    å†ç”¨è¿™ä¸ª scope å» `build_expression`, æ„å»ºå‡º `ON ..` çš„æ¡ä»¶</span><br><span class="line">    æ„æˆä¸€ä¸ª Node::NextLoopJoin èŠ‚ç‚¹. (è¿™é‡Œæœ‰ä¸€äº›å…³äº right join çš„ hack æ“ä½œï¼Œæš‚ä¸è®¨è®º)</span><br><span class="line">- å¯¹ä¸Šè¿°çš„æˆå‘˜ï¼Œæ„æˆä¸€ä¸ª Node::NestLoopJoin çš„å·¦æ·±æ ‘, å¹¶é€’å½’çš„å» merge è¿™äº› scope</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªåœ°æ–¹ç”¨åˆ°äº† <code>build_expression</code> æ¥å¤„ç† <code>ON</code> çš„æƒ…å†µï¼Œå¯¹å¤–è¿”å›äº†ä¸€ä¸ªæ–°çš„ Scope.</p><h3 id="Where-æ„å»º"><a href="#Where-æ„å»º" class="headerlink" title="Where æ„å»º"></a>Where æ„å»º</h3><p>ç”¨åˆ°äº† <code>build_expression</code> æ¥å¤„ç† <code>WHERE</code> å­è¡¨è¾¾å¼ã€‚åŒ Expression ä¸€èŠ‚</p><p>æ³¨æ„è¿™é‡Œæ²¡æœ‰ subqueryï¼Œæ‰€ä»¥å†…å®¹åº”è¯¥å¾ˆç®€å•</p><h3 id="Selection-List-å¤„ç†"><a href="#Selection-List-å¤„ç†" class="headerlink" title="Selection-List å¤„ç†"></a>Selection-List å¤„ç†</h3><p><code>select-list</code> å¦‚æœæ˜¯ emptyï¼Œä½œè€…è®¤ä¸ºæ˜¯å…¨éƒ¨è¾“å‡ºï¼ˆå³ <code>SELECT *</code>ï¼‰ï¼Œä¸æ‡‚ SQL è¯­æ³•ï¼Œè¿™æ˜¯çœŸçš„å—ï¼Ÿ</p><h4 id="inject-hidden"><a href="#inject-hidden" class="headerlink" title="inject_hidden"></a>inject_hidden</h4><p>è¿™é‡Œä¼šå…ˆå°è¯•ç»™ select å» <code>inject_hidden</code>ï¼Œæ’å…¥ä¸€äº›éœ€è¦ç»“æœçš„ ast::Expr æˆ–è€… ast::Fieldï¼Œæœ€åå†é€šè¿‡ Projection æŠŠè¿™äº›å­—æ®µç»™ Prune æ‰ã€‚è¿™ä¸ªæ—¶å€™ä¼šåˆ©ç”¨ä¹‹å‰è¯´çš„ <code>Column</code> å­—æ®µã€‚</p><p>è¿™é‡Œä¼šå°è¯•ï¼š</p><ul><li>æ’å…¥ HAVING çš„å†…å®¹</li><li>æ’å…¥ ORDER BY çš„å†…å®¹</li></ul><p><code>inject_hidden</code> æ’å…¥çš„æ—¶å€™ï¼Œä¼šæœ‰ä¸¤ä¸ª <code>ast::Expr</code>:</p><ul><li>Selection çš„ expr ç»„</li><li>éœ€è¦æ’å…¥çš„ expr</li></ul><p>è¿™ä¸ªæ—¶å€™ï¼Œå¤§è‡´é€»è¾‘å¦‚ä¸‹ï¼š</p><ul><li>æ‰«æ selection ï¼Œå’Œéœ€è¦æ’å…¥çš„ expr å¯¹æ¯”<ul><li>å¦‚æœæŸé¡¹æˆå‘˜æ­£å¥½ç›¸ç­‰ (<code>SELECT x .. ORDER BY x</code>)ï¼Œé‚£ä¹ˆå°±æ ‡è®°ä¸º <code>ast::expr::Column</code></li><li>å¦åˆ™ï¼Œè®¿é—® expr æ ‘ï¼Œæ‰¾åˆ°å¯¹åº”çš„ Column Refï¼Œç„¶åæ›¿æ¢æˆå¯¹åº”çš„ä¸Šä¸‹æ–‡ï¼Œæ¯”å¦‚ <code>SELECT a .. HAVING a = 10</code> , <code>a</code> æ›¿æ¢ä¸º <code>Column(0)</code></li></ul></li><li>å¯¹äºæ²¡æœ‰æ‰¾åˆ°ç›¸ä¼¼çš„ï¼Œå…¨éƒ¨åŠ å…¥ <code>selection</code>, ç„¶åè¡¨è¾¾å¼æ›¿æ¢ä¸º <code>Column( åœ¨ selection ä¸­çš„ä½ç½®)</code></li></ul><h4 id="Plan-Agg"><a href="#Plan-Agg" class="headerlink" title="Plan Agg"></a>Plan Agg</h4><p>Plan Agg æ˜¯ä»£ç é‡Œé¢æˆ‘çœ‹çš„æœ€è›‹ç–¼çš„ä¸€éƒ¨åˆ†ï¼Œè¿™ä¸ªéƒ¨åˆ†ç»“æœå¤§æ¦‚æ˜¯ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Aggregation aggregates</span><br><span class="line">- Projection aggregators, group-bys</span><br></pre></td></tr></table></figure><p>Eg:</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">â””â”€Aggregation: sum</span><br><span class="line">   â””â”€ Projection: a, b + <span class="number">2</span></span><br><span class="line">       â””â”€ Filter: a &gt; <span class="number">0</span></span><br></pre></td></tr></table></figure><p>Aggregation å‰ aggregates é¡¹æ˜¯å¯¹åº”çš„ï¼Œåé¢æ¥è‡ª GROUP-BY å­å¥</p><p>Group-BY è¡¨è¾¾å¼çš„å¤„ç†åˆ†æˆå¥½å‡ ä¸ªé˜¶æ®µï¼š</p><ul><li>ä» Selection-List ä¸­æŠ½å– Aggregation<ul><li>æŠŠ Selection ä¸­çš„è¡¨è¾¾å¼æ›¿æ¢ä¸ºå¯¹ Aggregation çš„ Column-Ref, è¿™é‡Œç›¸å½“äºä» Select é‡Œé¢æŠ½å‡º expr. <code>exprs</code> éƒ½æ˜¯è£¸çš„ ast::expr. <code>SELECT max(a) ...</code> æŠ½æˆ ColumnRef(0) + MAX</li><li>èƒ½æŠ½æˆ Field-Ref çš„å°½é‡æŠ½å–æˆ Field-Refï¼Œè¡¨è¾¾å½¢å¼ä¸º <code>Column(idx)</code></li></ul></li><li>æŠ½å– GROUP BY<ul><li>æŠŠ Selection ä¸­çš„è¡¨è¾¾å¼æ›¿æ¢ä¸ºå¯¹ Group By çš„ Column-Ref</li></ul></li><li>æ„å»º Aggregator<ul><li>æ’å…¥ä¸Šé¢çš„è¡¨è¾¾å¼ã€‚è¿™é‡Œä¼šå¯¹ <code>Scope</code> åšä¸€ä¸ª Projectionï¼Œæœ‰ç‚¹ hackï¼Œæˆ‘è¿˜å¾—æ¶ˆåŒ–ä¸€ä¸‹</li></ul></li><li>å†æ„å»ºä¸€ä¸ª Projectionï¼Œæ‹¿åˆ° Selection-List</li></ul><h3 id="å‰©ä½™"><a href="#å‰©ä½™" class="headerlink" title="å‰©ä½™"></a>å‰©ä½™</h3><ul><li>Build Having</li><li>Build Order</li><li>Build Offset</li><li>Build Limit</li><li>æŠŠ <code>inject_hidden</code> æ’å…¥çš„éšè—åˆ— Projection æ‰</li></ul>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Why do InnoDB need ReadView</title>
      <link href="/2023/06/07/Why-do-we-need-ReadView/"/>
      <url>/2023/06/07/Why-do-we-need-ReadView/</url>
      
        <content type="html"><![CDATA[<p>ä¹‹å‰å…¶å®ä¸€ç›´ä¸å¥½ç†è§£ä¸ºä»€ä¹ˆ InnoDB å¤šè¦äº†ä¸€ä¸ª ReadViewï¼Œçœ‹å®Œäº†æŸä¸ªå›ç­”ï¼ˆ  <a href="https://www.zhihu.com/question/40514055/answer/86935747ï¼‰ä¹‹åï¼Œçªç„¶ç†è§£äº†ã€‚">https://www.zhihu.com/question/40514055/answer/86935747ï¼‰ä¹‹åï¼Œçªç„¶ç†è§£äº†ã€‚</a></p><h2 id="InnoDB-MVCC"><a href="#InnoDB-MVCC" class="headerlink" title="InnoDB MVCC"></a>InnoDB MVCC</h2><p>åœ¨ç³»ç»Ÿä¸­ï¼Œæœ‰å‡ ä¸ª txn:</p><ol><li>äº‹åŠ¡çš„ DB_TRX_IDï¼Œå¦‚æœæ˜¯è¯»å†™äº‹åŠ¡çš„è¯ï¼Œä¼šåœ¨ <code>trx_sys_get_new_trx_id()</code> åˆ†é…ä¸€ä¸ªé€’å¢çš„ <code>trx_id</code>, æˆ‘ä»¬å¯ä»¥ç®€å•å°†å…¶è§†ä½œ <code>start_trx_id</code></li><li>åœ¨äº‹åŠ¡ Commit çš„æ—¶å€™ï¼Œæäº¤ undo çš„æ—¶å€™ï¼Œä¼šåˆ†é… <code>txn_no</code> ç»™ Undo ( <code>trx_serialisation_number_get</code> -&gt; <code>trx_sys_get_new_trx_id()</code> )ï¼Œè¿™ä¸ªå¯ä»¥çœ‹ä½œ <code>end_ts</code></li><li>è€Œæ¯ä¸ªè¯»äº‹åŠ¡ä¼šåœ¨è‡ªå·±çš„ ReadView ä¸­è®°å½•è‡ªå·±å¼€å§‹çš„æ—¶å€™çœ‹åˆ°çš„æœ€å¤§çš„ trx_no ä¸º <code>m_low_limit_no</code>ã€‚ReadView åˆ—è¡¨æŒ‰ç…§ <code>m_low_limit_no</code></li></ol><p>InnoDB MVCC ç›¸å…³çš„ç»“æ„å¦‚ä¸‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** The MVCC read view manager */</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MVCC</span> &#123;</span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">  Allocate and create a view.</span></span><br><span class="line"><span class="comment">  @param view   view owned by this class created for the</span></span><br><span class="line"><span class="comment">                          caller. Must be freed by calling close()</span></span><br><span class="line"><span class="comment">  @param trx    transaction creating the view */</span></span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">view_open</span><span class="params">(ReadView *&amp;view, <span class="type">trx_t</span> *trx)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">  Close a view created by the above function.</span></span><br><span class="line"><span class="comment">  @param view   view allocated by trx_open.</span></span><br><span class="line"><span class="comment">  @param own_mutex  true if caller owns trx_sys_t::mutex */</span></span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">view_close</span><span class="params">(ReadView *&amp;view, <span class="type">bool</span> own_mutex)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">  Release a view that is inactive but not closed. Caller must own</span></span><br><span class="line"><span class="comment">  the trx_sys_t::mutex.</span></span><br><span class="line"><span class="comment">  @param view   View to release */</span></span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">view_release</span><span class="params">(ReadView *&amp;view)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** Clones the oldest view and stores it in view. No need to</span></span><br><span class="line"><span class="comment">  call view_close(). The caller owns the view that is passed in.</span></span><br><span class="line"><span class="comment">  It will also move the closed views from the m_views list to the</span></span><br><span class="line"><span class="comment">  m_free list. This function is called by Purge to create it view.</span></span><br><span class="line"><span class="comment">  @param view   Preallocated view, owned by the caller */</span></span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">clone_oldest_view</span><span class="params">(ReadView *view)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">  @return the number of active views */</span></span><br><span class="line">  <span class="function">ulint <span class="title">size</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">  @return true if the view is active and valid */</span></span><br><span class="line">  <span class="function"><span class="type">static</span> <span class="type">bool</span> <span class="title">is_view_active</span><span class="params">(ReadView *view)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">ut_a</span>(view != <span class="built_in">reinterpret_cast</span>&lt;ReadView *&gt;(<span class="number">0x1</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (view != <span class="literal">NULL</span> &amp;&amp; !(<span class="built_in">intptr_t</span>(view) &amp; <span class="number">0x1</span>));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">  Set the view creator transaction id. Note: This shouldbe set only</span></span><br><span class="line"><span class="comment">  for views created by RW transactions. */</span></span><br><span class="line">  <span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">set_view_creator_trx_id</span><span class="params">(ReadView *view, <span class="type">trx_id_t</span> id)</span></span>;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span>:</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">  Validates a read view list. */</span></span><br><span class="line">  <span class="function"><span class="type">bool</span> <span class="title">validate</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">  Find a free view from the active list, if none found then allocate</span></span><br><span class="line"><span class="comment">  a new view. This function will also attempt to move delete marked</span></span><br><span class="line"><span class="comment">  views from the active list to the freed list.</span></span><br><span class="line"><span class="comment">  @return a view to use */</span></span><br><span class="line">  <span class="function"><span class="keyword">inline</span> ReadView *<span class="title">get_view</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">  Get the oldest view in the system. It will also move the delete</span></span><br><span class="line"><span class="comment">  marked read views from the views list to the freed list.</span></span><br><span class="line"><span class="comment">  @return oldest view if found or NULL */</span></span><br><span class="line">  <span class="function"><span class="keyword">inline</span> ReadView *<span class="title">get_oldest_view</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">  <span class="function">ReadView *<span class="title">get_view_created_by_trx_id</span><span class="params">(<span class="type">trx_id_t</span> trx_id)</span> <span class="type">const</span></span>;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span>:</span><br><span class="line">  <span class="comment">/** Free views ready for reuse. */</span></span><br><span class="line">  <span class="type">view_list_t</span> m_free;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** Active and closed views, the closed views will have the</span></span><br><span class="line"><span class="comment">  creator trx id set to TRX_ID_MAX */</span></span><br><span class="line">  <span class="type">view_list_t</span> m_views;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><code>MVCC</code> ä¼šæŒ‰ç…§ <code>m_low_limit_no</code> æ’åºï¼Œä¸€äº›è¯¦ç»†çš„æ³¨é‡Šåœ¨ <code>read/read0read.cc</code> é‡Œé¢ï¼Œå®ƒè¿˜æœ‰ä¸ª free-list é¿å…é‡å¤çš„çš„åˆ†é…ï¼ˆRC ä¹‹ç±»çš„æ—¶å€™ï¼‰ã€‚</p><p>è€Œ ReadView æœ‰ç€å¦‚ä¸‹çš„ç»“æ„ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ReadView</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="keyword">friend</span> <span class="keyword">class</span> <span class="title class_">MVCC</span>;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span>:</span><br><span class="line">  <span class="comment">// Disable copying</span></span><br><span class="line">  <span class="built_in">ReadView</span>(<span class="type">const</span> ReadView &amp;);</span><br><span class="line">  ReadView &amp;<span class="keyword">operator</span>=(<span class="type">const</span> ReadView &amp;);</span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span>:</span><br><span class="line">  <span class="comment">/** The read should not see any transaction with trx id &gt;= this</span></span><br><span class="line"><span class="comment">  value. In other words, this is the &quot;high water mark&quot;. */</span></span><br><span class="line">  <span class="type">trx_id_t</span> m_low_limit_id;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** The read should see all trx ids which are strictly</span></span><br><span class="line"><span class="comment">  smaller (&lt;) than this value.  In other words, this is the</span></span><br><span class="line"><span class="comment">  low water mark&quot;. */</span></span><br><span class="line">  <span class="type">trx_id_t</span> m_up_limit_id;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** trx id of creating transaction, set to TRX_ID_MAX for free</span></span><br><span class="line"><span class="comment">  views. */</span></span><br><span class="line">  <span class="type">trx_id_t</span> m_creator_trx_id;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** Set of RW transactions that was active when this snapshot</span></span><br><span class="line"><span class="comment">  was taken */</span></span><br><span class="line">  <span class="type">ids_t</span> m_ids;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** The view does not need to see the undo logs for transactions</span></span><br><span class="line"><span class="comment">  whose transaction number is strictly smaller (&lt;) than this value:</span></span><br><span class="line"><span class="comment">  they can be removed in purge if not needed by other views */</span></span><br><span class="line">  <span class="type">trx_id_t</span> m_low_limit_no;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** AC-NL-RO transaction view that has been &quot;closed&quot;. */</span></span><br><span class="line">  <span class="type">bool</span> m_closed;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">typedef</span> <span class="title">UT_LIST_NODE_T</span><span class="params">(ReadView)</span> <span class="type">node_t</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** List of read views in trx_sys */</span></span><br><span class="line">  byte pad1[<span class="number">64</span> - <span class="built_in">sizeof</span>(<span class="type">node_t</span>)];</span><br><span class="line">  <span class="type">node_t</span> m_view_list;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆï¼Œæˆ‘ä»¬æ³¨æ„åˆ°ï¼š</p><ol><li>å¯¹ä¸€ä¸ª readview, æœ‰ç€ <code>m_low_limit_id</code> å’Œ <code>m_up_limit_id</code> ä¸¤ä¸ªæ°´ä½ï¼Œè¿™ä¸¤ä¸ªæ°´ä½å¯ä»¥è¿‡æ»¤æ‰æ’å…¥çš„</li><li><code>m_creator_trx_id</code> ä»£è¡¨è‡ªèº«ï¼Œåˆ›å»ºçš„å†…å®¹å¯¹è‡ªå·±æ˜¯å¯è§çš„</li><li><code>m_low_limit_no</code> ä»£è¡¨åˆ›å»ºæ—¶å€™çš„æœ€å¤§ idã€‚</li></ol><p>è¿™ä¸ªåœ¨ ReadView åˆ›å»ºçš„æ—¶å€™ï¼Œå¯ä»¥çœ‹åˆ°å…·ä½“çš„è®¾ç½®é€»è¾‘ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">Copy the transaction ids from the source vector */</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ReadView::copy_trx_ids</span><span class="params">(<span class="type">const</span> <span class="type">trx_ids_t</span> &amp;trx_ids)</span> </span>&#123;</span><br><span class="line">  ulint size = trx_ids.<span class="built_in">size</span>();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (m_creator_trx_id &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">ut_ad</span>(size &gt; <span class="number">0</span>);</span><br><span class="line">    --size;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (size == <span class="number">0</span>) &#123;</span><br><span class="line">    m_ids.<span class="built_in">clear</span>();</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  m_ids.<span class="built_in">reserve</span>(size);</span><br><span class="line">  m_ids.<span class="built_in">resize</span>(size);</span><br><span class="line"></span><br><span class="line">  <span class="type">ids_t</span>::value_type *p = m_ids.<span class="built_in">data</span>();</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Copy all the trx_ids except the creator trx id */</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (m_creator_trx_id &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">// æ‹·è´ è‡ªå·±ä¹‹å¤–çš„å…ƒç´ </span></span><br><span class="line">    <span class="comment">/* Note: We go through all this trouble because it is</span></span><br><span class="line"><span class="comment">    unclear whether std::vector::resize() will cause an</span></span><br><span class="line"><span class="comment">    overhead or not. We should test this extensively and</span></span><br><span class="line"><span class="comment">    if the vector to vector copy is fast enough then get</span></span><br><span class="line"><span class="comment">    rid of this code and replace it with more readable</span></span><br><span class="line"><span class="comment">    and obvious code. The code below does exactly one copy,</span></span><br><span class="line"><span class="comment">    and filters out the creator&#x27;s trx id. */</span></span><br><span class="line"></span><br><span class="line">    <span class="type">trx_ids_t</span>::const_iterator it =</span><br><span class="line">        std::<span class="built_in">lower_bound</span>(trx_ids.<span class="built_in">begin</span>(), trx_ids.<span class="built_in">end</span>(), m_creator_trx_id);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">ut_ad</span>(it != trx_ids.<span class="built_in">end</span>() &amp;&amp; *it == m_creator_trx_id);</span><br><span class="line"></span><br><span class="line">    ulint i = std::<span class="built_in">distance</span>(trx_ids.<span class="built_in">begin</span>(), it);</span><br><span class="line">    ulint n = i * <span class="built_in">sizeof</span>(<span class="type">trx_ids_t</span>::value_type);</span><br><span class="line"></span><br><span class="line">    ::<span class="built_in">memmove</span>(p, &amp;trx_ids[<span class="number">0</span>], n);</span><br><span class="line"></span><br><span class="line">    n = (trx_ids.<span class="built_in">size</span>() - i - <span class="number">1</span>) * <span class="built_in">sizeof</span>(<span class="type">trx_ids_t</span>::value_type);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">ut_ad</span>(i + (n / <span class="built_in">sizeof</span>(<span class="type">trx_ids_t</span>::value_type)) == m_ids.<span class="built_in">size</span>());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (n &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      ::<span class="built_in">memmove</span>(p + i, &amp;trx_ids[i + <span class="number">1</span>], n);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// æ‹·è´æ‰€æœ‰çš„å…ƒç´ </span></span><br><span class="line">    ulint n = size * <span class="built_in">sizeof</span>(<span class="type">trx_ids_t</span>::value_type);</span><br><span class="line"></span><br><span class="line">    ::<span class="built_in">memmove</span>(p, &amp;trx_ids[<span class="number">0</span>], n);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  m_up_limit_id = m_ids.<span class="built_in">front</span>();</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> UNIV_DEBUG</span></span><br><span class="line">  <span class="comment">/* Assert that all transaction ids in list are active. */</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">trx_ids_t</span>::const_iterator it = trx_ids.<span class="built_in">begin</span>(); it != trx_ids.<span class="built_in">end</span>();</span><br><span class="line">       ++it) &#123;</span><br><span class="line">    <span class="type">trx_t</span> *trx = <span class="built_in">trx_get_rw_trx_by_id</span>(*it);</span><br><span class="line">    <span class="built_in">ut_ad</span>(trx != <span class="literal">NULL</span>);</span><br><span class="line">    <span class="built_in">ut_ad</span>(trx-&gt;state == TRX_STATE_ACTIVE || trx-&gt;state == TRX_STATE_PREPARED);</span><br><span class="line">  &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/* UNIV_DEBUG */</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">Opens a read view where exactly the transactions serialized before this</span></span><br><span class="line"><span class="comment">point in time are seen in the view.</span></span><br><span class="line"><span class="comment">@param id   Creator transaction id */</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ReadView::prepare</span><span class="params">(<span class="type">trx_id_t</span> id)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">ut_ad</span>(<span class="built_in">mutex_own</span>(&amp;trx_sys-&gt;mutex));</span><br><span class="line"></span><br><span class="line">  m_creator_trx_id = id;</span><br><span class="line"></span><br><span class="line">  m_low_limit_no = m_low_limit_id = m_up_limit_id = trx_sys-&gt;max_trx_id;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!trx_sys-&gt;rw_trx_ids.<span class="built_in">empty</span>()) &#123;</span><br><span class="line">    <span class="built_in">copy_trx_ids</span>(trx_sys-&gt;rw_trx_ids);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    m_ids.<span class="built_in">clear</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">ut_ad</span>(m_up_limit_id &lt;= m_low_limit_id);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">UT_LIST_GET_LEN</span>(trx_sys-&gt;serialisation_list) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="type">const</span> <span class="type">trx_t</span> *trx;</span><br><span class="line"></span><br><span class="line">    trx = <span class="built_in">UT_LIST_GET_FIRST</span>(trx_sys-&gt;serialisation_list);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (trx-&gt;no &lt; m_low_limit_no) &#123;</span><br><span class="line">      m_low_limit_no = trx-&gt;no;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  m_closed = <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°è¿™é‡Œçš„è®¾ç½®éå¸¸å·§å¦™ã€‚</p><p>æ¥ä¸‹æ¥è§‚å¯Ÿåˆ°ä¸€ä¸ªäº‹å®ï¼Œè¿™é‡Œæ˜¯æ ¹æ® <code>trx_sys-&gt;rw_trx_ids</code> å’Œ <code>trx_sys-&gt;max_trx_id</code> è¿˜æœ‰ <code>m_creator_trx_id</code> è®¾ç½®çš„ï¼š</p><ol><li><code>m_low_limit_id</code> è®¾ç½®ä¸º <code>trx_sys-&gt;max_trx_id</code> ( å³ <code>max(start-ts, end-ts)</code>)</li><li><code>m_low_limit_no</code> è®¾ç½®ä¸º <code>min(min committing-txn-id, trx_sys-&gt;max_trx_id)</code>ï¼Œè¡¨ç¤ºå·²ç»æäº¤çš„æœ€å¤§äº‹åŠ¡ id æˆ– pending çš„æœ€å°äº‹åŠ¡ idï¼Œ<strong>ä¿è¯ä¸ä¼šè¯»åˆ°æäº¤ä¸­çš„æ•°æ®</strong></li><li><code>m_low_limit_id</code> å’Œ <code>m_up_limit_id</code> éƒ½æ˜¯å¯¹åº”çš„ Running Txn Idã€‚<code>m_up_limit_id</code> æ›´æ–°ä¸º <code>min(active-txn)</code></li></ol><p>æ‰€ä»¥åœ¨æ£€æŸ¥çš„æ—¶å€™ï¼Œè¿™é‡Œæœ‰ï¼š</p><ol><li>ä¸€æ¡æ’å…¥çš„è¾¹ä¼šæœ‰ <code>DB_TRX_ID</code>, è¿™ä¸ªæ˜¯ <code>start_ts</code>ï¼Œ<strong>æœ€å¤§çš„é—®é¢˜æ˜¯ï¼Œè¿™ç©æ„å¹¶ä¸æ˜¯ä¸€ä¸ª</strong> <code>commit_ts</code>!</li><li>æ‰€ä»¥è¦æ ¹æ® min-max å’Œ runing-txn åˆ—è¡¨æ¥åˆ¤æ–­å®ƒ</li></ol><p>æˆ‘ä»¬åè¿‡æ¥æ¨æ–­ä¸€ä¸‹ï¼š</p><ol><li>å¦‚æœ <code>start_ts == commit_ts</code> -&gt; å¹¶ä¸éœ€è¦ä¸€ä¸ª ReadView</li><li>å¦‚æœä¸éœ€è¦è¿™ä¹ˆç²¾ç»†çš„åˆ¤æ–­ï¼Œæ¯”å¦‚åˆ†å¸ƒå¼å¹¶ä¸çŸ¥é“æ‰€æœ‰ runing txn æ˜¯ä»€ä¹ˆï¼Œå°±ä¸éœ€è¦è¿™ä¸ª</li></ol><h2 id="TiDB-CRDB"><a href="#TiDB-CRDB" class="headerlink" title="TiDB / CRDB"></a>TiDB / CRDB</h2><p>æˆ‘ä»¬å›è¿‡å¤´æ¥çœ‹ TiDBï¼ŒTiDB æ˜¯ä¸€ä¸ª Percolator çš„æ¨¡å‹ï¼Œæ˜¾ç„¶ï¼Œåœ¨è¿™é‡Œè·å¾—æ‰€æœ‰çš„ txn-id æ˜¯ä¸ç°å®çš„ï¼ˆæˆ‘æ€€ç–‘ä¼šå¯¼è‡´æäº¤æˆä¸ºç“¶é¢ˆï¼Œæˆ–è€…æ‰“çˆ† PDï¼‰ï¼Œè¿™ä¸ªæ—¶å€™å°±éœ€è¦å¯¹çŠ¶æ€æœªå†³çš„äº‹åŠ¡æçŠ¶æ€ç”šè‡³ç­‰å¾…äº†ã€‚CRDB å…¶å®ä¹Ÿå·®ä¸å¤šã€‚</p><h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul><li>åˆ†å¸ƒå¼äº‹åŠ¡ä¸­çš„æ—¶é—´æˆ³ - Eric Fuçš„æ–‡ç«  - çŸ¥ä¹ <a href="https://zhuanlan.zhihu.com/p/333471336">https://zhuanlan.zhihu.com/p/333471336</a></li><li><a href="http://mysql.taobao.org/monthly/2018/11/04/">http://mysql.taobao.org/monthly/2018/11/04/</a></li><li><a href="http://mysql.taobao.org/monthly/2015/04/01/">http://mysql.taobao.org/monthly/2015/04/01/</a></li><li><a href="https://leviathan.vip/2019/03/20/InnoDB%E7%9A%84%E4%BA%8B%E5%8A%A1%E5%88%86%E6%9E%90-MVCC/">https://leviathan.vip/2019/03/20/InnoDB%E7%9A%84%E4%BA%8B%E5%8A%A1%E5%88%86%E6%9E%90-MVCC/</a></li><li>innodbäº‹åŠ¡å¼€å¯åï¼Œä¿®æ”¹ä¸€è¡Œè®°å½•ï¼Œæ˜¯updateæ‰§è¡Œåè¡Œç‰ˆæœ¬å·å¢åŠ ï¼Œè¿˜æ˜¯åœ¨äº‹ç‰©æäº¤åè¡Œç‰ˆæœ¬å·å¢åŠ ï¼Ÿ - éƒç™½çš„å›ç­” - çŸ¥ä¹ <a href="https://www.zhihu.com/question/40514055/answer/86935747">https://www.zhihu.com/question/40514055/answer/86935747</a></li></ul>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Arrow Data System</title>
      <link href="/2023/06/01/Arrow-Data-System/"/>
      <url>/2023/06/01/Arrow-Data-System/</url>
      
        <content type="html"><![CDATA[<ol><li><p>Apache Arrow æ˜¯ç”± Pandas ä½œè€… Wes McKenny ä¸»å¯¼çš„ä¸€æ¬¾ä»¥å†…å­˜ä¸ºä¸»ä½“ï¼Œè¾å°„åˆ°æ•°æ®äº¤æ¢ã€å†…å­˜è®¡ç®—ã€å¤šæ ¼å¼å¤šå¹³å°è½¬æ¢çš„åº“ã€‚å®ƒçš„å¤§æ¦‚ Idea å¯ä»¥è§ä¸‹å›¾ï¼Œå†™çš„éå¸¸ç›´è§‚ã€‚</p><p><img src="https://image.mwish.me/blog-image/image.png" alt="image"></p><p>æˆ‘ä»¬ç®€å•ä»‹ç»ä¸€ä¸‹ Arrow çš„å†…å®¹ï¼š</p><ol><li>ä¸€åˆ‡çš„æ ¸å¿ƒï¼ŒArrow çš„å†…å­˜ Columnar ç»“æ„(è§å®˜æ–¹ä»‹ç» [1] å’Œæˆ‘ä¹‹å‰çš„åšå®¢ [2])<ol><li>åœ¨è¿™ä¸Šé¢çš„ ExtensionTypeï¼Œæ”¯æŒç”¨æˆ·å®šä¹‰è‡ªå·±çš„ç±»å‹ï¼ŒåŒ…æ‹¬ Tensor è¿™æ ·çš„ç±»å‹</li><li>IPC File</li></ol></li><li>æ•°æ®äº¤æ¢ä¸ŠæˆåŠŸçš„å·¥å…·<ol><li>Arrow JDBC Converter [3]</li><li>ADBC [4]</li><li>Arrow Flight [5] å’ŒåŸºäº Arrow Flight SQL [6]</li></ol></li><li>ä¸€äº›è®¡ç®—ç›¸å…³çš„ API<ol><li>å‘é‡åŒ–è®¡ç®—å‡½æ•°çš„ Compute [7]</li><li>Push-based Execution çš„ Acero [8]</li><li>LLVM Codegen çš„æ‰§è¡Œ Gandiva [9] (å·²ç»å¿«æ­»äº†)</li><li>SQL Planning çš„ Datafusion [10]</li><li>åˆ†å¸ƒå¼æ‰§è¡Œçš„ Ballista</li></ol></li><li>ä¸€äº›æ•°æ®æºå’Œå†™å…¥ç›¸å…³çš„ API<ol><li>FileSystem: å¯¹æ–‡ä»¶æ¥æºçš„å±‚æ¬¡çš„ Unify [11]</li><li>Dataset API: å¯¹æŸä¸ª FileSystem ä¸‹çš„å¤šä¸ªæ–‡ä»¶ / åˆ†åŒº / æ•°æ®æ ¼å¼çš„æŠ½è±¡ï¼Œä¹Ÿå¯ä»¥åŠ ä¸Š Project, Filter ç­‰æ“ä½œ [12]</li></ol></li></ol><p>å°±æˆ‘ä¸ªäººè¯„ä»·è€Œè¨€ï¼ŒArrow åœ¨æ¯ä¸ªé¢†åŸŸä¸­å¾ˆéš¾è¯´å¾—ä¸Šæ˜¯æ€§èƒ½æœ€å¥½çš„ï¼Œä½†æ˜¯èƒœåœ¨æä¾›äº†æ¯”è¾ƒå®Œå–„çš„è§£å†³æ–¹æ¡ˆï¼Œapi ç›¸å¯¹ä¾µå…¥æ€§ä¹Ÿä¸ä¼šå¾ˆå¤§ã€‚å¾ˆå¤šåœ°æ–¹æ‰©å±•æ€§æ¯”è¾ƒå¼ºï¼Œä¾‹å¦‚æä¾›äº† <code>ExtensionType</code>ï¼ˆå¯ä»¥ç”¨ <code>ExtensionType</code> å»æ”¯æŒæœºå™¨å­¦ä¹ éœ€è¦çš„ Tensor è¿™æ ·çš„ç±»å‹ [16] ï¼‰ï¼Œä¹Ÿå…è®¸ç”¨æˆ·æŒ‰ç…§ API å» Inject è‡ªå·±æƒ³è¦çš„ä¸œè¥¿ã€‚Arrow Flight æ€»ä½“ä¸Šä¹Ÿæ˜¯æ¯”è¾ƒå¼€æ”¾çš„ã€‚è¿™äº›åˆèµ·æ¥çš„åŸå› å’Œæ–¹ä¾¿çš„ç”Ÿæ€å¯¼è‡´ Arrow å…¶å®è¢«è¾ƒä¸ºå¹¿æ³›çš„ä½¿ç”¨äº†ï¼ŒåŒ…æ‹¬ Snowflake [13] å’Œ Bigquery [14] è¿™å‡ å®¶éƒ½åœ¨ç”¨ï¼Œå¼€æºçš„æ•°æ®é¡¹ç›®ï¼Œåƒ Ray è¿™æ ·çš„ä¹Ÿä¼šç§¯ææ‹¥æŠ± Arrowã€‚DuckDB ç”šè‡³ç»™æ”¯æŒ Arrow çš„è½¬æ¢å†™äº†ä¸€ç¯‡åšå®¢ [15]ã€‚</p><p>æ€»çš„æ¥è¯´ï¼ŒArrow ä¸»è¦ä¸ºç”Ÿæ€å¼€æ”¾çš„åšäº†ä¸å°‘å·¥ä½œï¼Œè™½ç„¶æ ¸å¿ƒçš„æ€§èƒ½ä¸æ˜¯æœ€å¥½çš„ï¼ˆå‚è§ Velox å’Œè¯¸å¤šçš„å¤§å‚å¼€æ”¾çš„å¼•æ“ï¼Œä¸€ä¸ªæ¯”è¾ƒç»å…¸çš„ä¾‹å­æ˜¯ Fireboltï¼ŒåŸºäºå¼€æºçš„å¼•æ“è‡ªå·±æ‹¼äº†ä¸€ä¸ªæ•°æ®ä»“åº“å‡ºæ¥ï¼‰ï¼Œä½†æ˜¯å› ä¸ºå¾ˆå¼ºçš„é€šç”¨æ€§å’Œæ¯”è¾ƒå®Œå–„çš„ç”Ÿæ€ï¼Œç°åœ¨å·²ç»ä¾µå…¥äº†å¾ˆå¤šäººçš„ç³»ç»Ÿã€‚</p><h2 id="Core-In-Memory-Format"><a href="#Core-In-Memory-Format" class="headerlink" title="Core: In Memory Format"></a><strong>Core: In Memory Format</strong></h2><p>å…³äº Arrow çš„ In Memory Formatï¼Œä¹‹å‰å°è¯•ä»‹ç»è¿‡äº†ï¼š</p><ol><li><a href="https://blog.mwish.me/2023/05/04/Type-and-Array-in-Columnar-System/">https://blog.mwish.me/2023/05/04/Type-and-Array-in-Columnar-System/</a></li><li><a href="https://blog.mwish.me/2022/10/04/Parquet-Part2-arrow-Parquet-code-path/">https://blog.mwish.me/2022/10/04/Parquet-Part2-arrow-Parquet-code-path/</a></li></ol><p>è¿™ä¸ªåœ°æ–¹æœ¬èº«æ²¡å•¥å¥½è¯´çš„ï¼Œå€¼å¾—è¯´çš„éƒ½åœ¨ä¸Šé¢çš„å†…å®¹äº†</p><h3 id="IPC-Format"><a href="#IPC-Format" class="headerlink" title="IPC Format"></a><strong>IPC Format</strong></h3><p>IPC File æ ¼å¼ <strong>åŸºæœ¬ç­‰ä»·äº</strong> å†…å­˜ä¸­ Format çš„ RecordBatchï¼Œè¿™é‡Œå®ƒä¼šå°½é‡åœ¨ package é‡Œé¢åš alignas ï¼ˆæ¯”è¾ƒæœ‰æ„æ€å’Œå…³è”çš„ patch çœ‹è¿™ä¸ªï¼š<a href="https://github.com/apache/arrow/pull/35565/files">https://github.com/apache/arrow/pull/35565/files</a> ï¼Œåœ¨è®¡ç®—å±‚è¦æ±‚è¾“å‡ºæ˜¯æ»¡è¶³ align çš„ï¼‰ï¼Œç„¶åè®©æ•°æ®èƒ½å¤Ÿè¢« Zero-Copy çš„è§£æåˆ° Arrow æ ¼å¼ä¸Šã€‚è¿™é‡Œåº”è¯¥å…³å¿ƒå¯èƒ½çš„æ•°æ®å’Œå…ƒæ•°æ®</p><p>IPC Format æœ‰ä¸¤ç§æ ¼å¼ï¼š</p><ol><li>Streaming Format: Appendableï¼Œå¿…é¡»æ•´ä¸ªè§£æ</li><li>Random Access: ä¸€æ•´ä¸ª RecordBatch å†™çš„æ–‡ä»¶</li></ol><p>åœ¨åè®®ä¸Šï¼Œè¿™é‡Œå…è®¸ï¼ˆä¸å®šå¤§å°çš„ï¼‰ä¸‹åˆ—å…ƒç´ ï¼š</p><ol><li>Schema: <strong>æ–‡ä»¶æˆ–è€… Stream</strong> çš„ Schemaï¼ˆè¿™é‡Œéœ€è¦æ³¨æ„ï¼Œipc æ—¢å¯ä»¥å†™åœ¨æ–‡ä»¶é‡Œï¼Œåˆå¯ä»¥ä¸ºäº†æ•´ä¸ªæµæ¥è®¾ç½®ï¼‰</li><li>DictionaryBatch</li><li>RecordBatch</li></ol><p>åœ¨å®šä¹‰çš„æ ¼å¼ä¸­ï¼ŒåŸºæœ¬çš„å…ƒç´ æ˜¯ Messageï¼Œä¸‹é¢æ˜¯å¯¹åº”çš„ Message Format:</p><p><img src="https://image.mwish.me/blog-image/ipc-file-format.png" alt="ipc-file-format"></p><p>è¿™é‡Œå…ƒæ•°æ®ç”± <code>FlatBuffer</code> ç»„æˆï¼ˆ <a href="https://blog.mwish.me/2022/01/14/format-thinking/">https://blog.mwish.me/2022/01/14/format-thinking/</a> ï¼‰å®ƒçš„æ ¼å¼å®šä¹‰åœ¨ <a href="https://github.com/apache/arrow/blob/main/format/Message.fbs">https://github.com/apache/arrow/blob/main/format/Message.fbs</a> ä¸­ã€‚è¿™é‡ŒåŒ…æ‹¬ï¼š</p><figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">table Message &#123;</span><br><span class="line">  version: org.apache.arrow.flatbuf.MetadataVersion;</span><br><span class="line">  header: MessageHeader;</span><br><span class="line">  bodyLength: long;</span><br><span class="line">  custom_metadata: [ KeyValue ];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="Stream"><a href="#Stream" class="headerlink" title="Stream"></a>Stream</h4><p><img src="https://image.mwish.me/blog-image/C9ACE6F5-A3F6-45B3-A4E6-169BFAAF96A0.png" alt="C9ACE6F5-A3F6-45B3-A4E6-169BFAAF96A0"></p><p><img src="https://image.mwish.me/blog-image/a7d9c337-14e0-44f8-8c1c-e8badd189e0d.png" alt="a7d9c337-14e0-44f8-8c1c-e8badd189e0d"></p><p>ä¸ºä»€ä¹ˆä¹‹å‰å¼ºè°ƒäº†æ˜¯æ–‡ä»¶/Streamçš„ Schema å‘¢ï¼Œå› ä¸ºå®ƒæœ¬èº«æ˜¯æ²¡æœ‰æ–‡ä»¶ï¼ˆå†…ï¼‰çº§åˆ«çš„ Schema Evolution çš„</p><p>æ¯”è¾ƒé‡è¦çš„æ˜¯ Record Batch Messageï¼Œè¿™é‡Œä¼šåœ¨å†™æ–‡ä»¶å’Œè¯»å–çš„æ—¶å€™éƒ½ä¿è¯ alignment (8Bï¼Œä¹Ÿå¯ä»¥æ‰‹åŠ¨æŒ‡å®šï¼‰ï¼Œè¿™é‡Œæœ‰ï¼š<a href="https://arrow.apache.org/docs/format/Columnar.html#recordbatch-message">https://arrow.apache.org/docs/format/Columnar.html#recordbatch-message</a></p><p>è¿™éƒ¨åˆ†å®ç°çš„å†…å®¹å¾ˆåƒ ORC é‚£å¥—æ ¼å¼ã€‚</p><p>åŒæ—¶ï¼Œè¿™éƒ¨åˆ†å­—å…¸æ ¼å¼æ˜¯ INCREMENT çš„ï¼ˆçœ‹ä¸Šé¢çš„ DICTIONARY DELTAï¼‰ï¼Œå¢é‡çš„å­—å…¸å¸¦æ¥äº†ä¸€éƒ¨åˆ†çš„æ‰©å±•æ€§ï¼š<a href="https://arrow.apache.org/docs/format/Columnar.html#dictionary-messages">https://arrow.apache.org/docs/format/Columnar.html#dictionary-messages</a></p><h4 id="File"><a href="#File" class="headerlink" title="File"></a>File</h4><p><img src="https://image.mwish.me/blog-image/9E626D1C-90D9-4261-80DD-761870A41306.png" alt="9E626D1C-90D9-4261-80DD-761870A41306"></p><h3 id="Extension-Type"><a href="#Extension-Type" class="headerlink" title="Extension Type"></a>Extension Type</h3><p>ç”¨æˆ·å¯ä»¥ä»¥ Key-Value Metadata çš„å½¢å¼å»åš Schema ä¸Šçš„æ‰©å±•ï¼ŒGeoArrowï¼ŒTensor è¿™äº›ï¼Œéƒ½å¯ä»¥æ”¶ç›ŠäºArrow åŒ…å«çš„æ‰©å±•ï¼š<a href="https://arrow.apache.org/docs/format/Columnar.html#extension-types">https://arrow.apache.org/docs/format/Columnar.html#extension-types</a></p><h2 id="æ•°æ®äº¤æ¢çš„å·¥å…·"><a href="#æ•°æ®äº¤æ¢çš„å·¥å…·" class="headerlink" title="æ•°æ®äº¤æ¢çš„å·¥å…·"></a>æ•°æ®äº¤æ¢çš„å·¥å…·</h2><p>å¦‚æœè¯´ä¹‹å‰çš„éƒ¨åˆ†æ˜¯å†…å­˜å’Œ Stream å±‚é¢çš„ kernelï¼Œé‚£ä¹ˆä¸‹é¢æ¥ä»‹ç»æ•°æ®äº¤æ¢ã€‚æåˆ°è¿™éƒ¨åˆ†ï¼Œå¯èƒ½é¦–å…ˆæƒ³èµ·çš„æ˜¯ IPC å±‚ CWI çš„ç›¸å…³çš„è®ºæ–‡ ã€ŒDonâ€™t Hold My Data Hostage â€“ A Case For Client Protocol Redesignã€ã€‚å…¶å®å’Œæ–‡ç« ç»“è®ºæ¯”è¾ƒæ¥è¿‘ï¼Œä½†æ˜¯è¿™éƒ¨åˆ†å…¶å®æ¯”è¾ƒæœ‰æ„æ€ï¼Œä¹Ÿç»™ç”¨æˆ·å¯ä»¥ç§‘æ™®ä¸€ä¸‹ client-side çš„ dirty work å’Œå¤æ‚åº¦ã€‚</p><h3 id="Arrow-Flight"><a href="#Arrow-Flight" class="headerlink" title="Arrow Flight"></a>Arrow Flight</h3><p>Arrow Flight å…¶å®æ˜¯åœ¨ grpc å’Œ protobuf ä¸Šå¼€äº†ä¸€å¥—æ´çš„ Arrow ä¼ è¾“åè®®ã€‚</p><p>Q: Arrow Flight å’Œ Arrow Streaming Format æœ‰ä»€ä¹ˆå…³ç³»ï¼Ÿ</p><p>A: Arrow Flight ä¸»è¦å·¥ä½œåœ¨ä¼ è¾“åè®®å’Œåˆ†å¸ƒå¼ä¸Š</p><p>å¦‚å›¾ï¼Œä¸‹é¢æ˜¯ Arrow Flight çš„å·¥ä½œæ¨¡å¼</p><p><img src="https://image.mwish.me/blog-image/flight-request-pattern.png" alt="flight-request-pattern"></p><p>å¦‚å›¾ï¼ŒArrow Flight å…è®¸ä»¥å¦‚ä¸‹æ–¹å¼å»æä¸€ä¸ª <strong>Dataset</strong>ï¼Œå’Œè¿™ç¯‡ï¼ˆ <a href="https://zhuanlan.zhihu.com/p/340520316">https://zhuanlan.zhihu.com/p/340520316</a> ï¼‰æœ‰å¼‚æ›²åŒå·¥ä¹‹å¦™ï¼ˆåºŸè¯ï¼ŒAP åšæ³•éƒ½å·®ä¸å¤šï¼‰</p><p><img src="https://image.mwish.me/blog-image/flight-batch.png" alt="flight-batch"></p><p>åœ¨ä»£ç å®ç°ä¸Šï¼ŒFlight åœ¨ Protobuf ä»£ç ä¸Šå¼€äº†ä¸ªæ´ï¼Œå°½é‡è®©ä»–è§£æ Arrow æ•°æ®çš„æ—¶å€™ï¼Œè¢« Arrow æ‹¦æˆªï¼Œåšåˆ°å®ç°ä¸Šçš„ Zero-copy (ä¼—æ‰€å‘¨çŸ¥ï¼Œpb æœ¬èº«ä¸æ˜¯ä¸ºäº†ä¼ è¾“å¤§å¯¹è±¡è®¾è®¡çš„ï¼‰ã€‚</p><p>Flight è¿˜æ”¯æŒä¸€äº›é gRPC çš„è®¿é—®ï¼Œæ¯”å¦‚åè®®ä¸Šå‡†å¤‡å…¼å®¹</p><h3 id="From-JDBC-Converter-to-Others"><a href="#From-JDBC-Converter-to-Others" class="headerlink" title="From JDBC Converter to Others"></a>From JDBC Converter to Others</h3><p>JDBC / ODBC å®é™…ä¸Šæ˜¯ 90 å¹´ä»£èµ·æ•°æ®äº¤æ¢çš„äº‹å®æ ‡å‡†ï¼Œå¦‚æœè€ƒè™‘åˆ°ä½¿ç”¨çš„è¯ï¼Œæµç¨‹å¦‚å·¦å›¾ï¼š</p><p><img src="https://image.mwish.me/blog-image/casting.png" alt="casting"></p><p>å³å›¾é¦–å…ˆæä¾›äº†ä¸€ç§ JDBC Client çš„äº¤äº’æ–¹å¼ã€‚å³é¦–å…ˆéœ€è¦è½¬ä¸€å±‚ã€‚å½“ç„¶è¿™å¹¶ä¸èƒ½è®©äººæ»¡æ„ï¼Œæ‰€ä»¥æ¥ä¸‹æ¥å‡ºç°äº†ä¸‹é¢çš„æ•°æ®æµ</p><p><img src="https://image.mwish.me/blog-image/data.png" alt="data"></p><ol><li>ADBC: å¯å‘è‡ª DuckDB ä½œè€…çš„è®ºæ–‡ ã€ŒDonâ€™t Hold My Data Hostage â€“ A Case For Client Protocol Redesignã€ã€‚ç›¸å½“äºåˆ—å¼çš„ JDBCã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™ä¸ªæ ¼å¼è™½ç„¶æ¯”è¾ƒæœ‰æ½œåŠ›ï¼Œä½†æ˜¯æ‰ 0.4ï¼Œå¯èƒ½éœ€è¦ç­‰ä»–è‡ªå·±å‘å±•ä¸€ä¸‹</li><li>Driver: ç±»ä¼¼æ•°æ®åº“çš„ Driverï¼Œèƒ½å¤ŸæŠŠ Arrow è½¬æˆ JDBC / ADBC</li><li>Flight SQL Protocol: Flight ä¹‹ä¸Šçš„ Catalog / SQL æ¡†æ¶ã€‚ä¸å®ç°å¤§æ¦‚æ— å…³ï¼Œæ„¿æ™¯æ˜¯ä¸€ä¸ªé€šç”¨åè®®å±‚</li></ol><p>è¯´å®è¯è¿™å¥—ä¸œè¥¿ç«äº‰åŠ›è¿˜æŒºå¼ºçš„ï¼ŒBigQuery, Snowflake, DataBricks éƒ½æˆ–å¤šæˆ–å°‘ç”¨äº†è¿™å¥—ä¸œè¥¿. ä¸»è¦é—®é¢˜è¿˜æ˜¯ç”¨æ•°æ®åº“çš„ JDBC Driver æˆ–è€…ç”šè‡³è¡Œçš„æ¥å£æ¥å¤„ç†è¿˜æ˜¯æ¯”è¾ƒèœçš„ã€‚éœ€è¦ä¸“é—¨çš„æ¥å£æ¥ handle è¿™å¥—å†…å®¹ã€‚</p><h2 id="è®¡ç®—ç›¸å…³çš„å·¥å…·"><a href="#è®¡ç®—ç›¸å…³çš„å·¥å…·" class="headerlink" title="è®¡ç®—ç›¸å…³çš„å·¥å…·"></a>è®¡ç®—ç›¸å…³çš„å·¥å…·</h2><h3 id="Compute-amp-Acero"><a href="#Compute-amp-Acero" class="headerlink" title="Compute &amp; Acero"></a>Compute &amp; Acero</h3><p>åœ¨ Arrow çš„æ ¸å¿ƒä¸­æä¾›äº† Arrow Compute è¿™æ ·çš„å·¥å…·ï¼Œå®ƒçš„åŸºæœ¬é€»è¾‘å’Œå®šä½è§ä¹‹å‰çš„åšå®¢ï¼š<a href="https://blog.mwish.me/2023/05/27/Arrow-Compute/">https://blog.mwish.me/2023/05/27/Arrow-Compute/</a></p><p>Compute å®šä½çš„æ˜¯å‘é‡åŒ–çš„ç®—å­( Function )ã€‚</p><p>è™½ç„¶ Compute æœ¬èº«å¯èƒ½æ²¡æœ‰ Expression çš„æ¦‚å¿µï¼Œä½†æ˜¯ Arrow ä¸ºäº†åˆ«çš„åœ°æ–¹ä½¿ç”¨ï¼Œåœ¨ Compute é‡Œé¢å®ç°äº† Expressionã€‚å‡ ä¹æ‰€æœ‰æ•°æ®åº“éƒ½æœ‰ Expression ç›¸å…³çš„æ¦‚å¿µï¼Œå®ƒå¯ä»¥æ˜¯ï¼š</p><ol><li>LiteralValue Or Datum</li><li>FieldRef of input Datum</li><li>Compute Functionï¼ŒFunction Member éƒ½æ˜¯åˆ«çš„ Expression</li></ol><p><img src="https://image.mwish.me/blog-image/expressions.png" alt="expressions"></p><p>Acero æ˜¯æ„å»ºåœ¨è¿™å¥—ç³»ç»Ÿä¸Šçš„ Operator å±‚ã€‚å®šä½ä¸Šï¼ŒAcero æ˜¯ä¸€ä¸ª Push-Based çš„ç®—å­å±‚ï¼Œè™½ç„¶ä»£ç å†™çš„ä¸æ˜¯å¾ˆç»†ï¼Œä½†æ˜¯æ¯”è¾ƒæ˜“æ‡‚ï¼š</p><p><img src="https://image.mwish.me/blog-image/acero-nodes.png" alt="acero-nodes"></p><p>è¿™é‡Œå¯ä»¥æ ¹æ® Declaration ç”Ÿæˆä¸€ç»„å¯¹åº”çš„ ExecPlan / ExecNodeï¼Œç„¶åä¸‹å±‚æ¥é©±åŠ¨æ•°æ®æµçš„æ‰§è¡Œã€‚</p><h4 id="Substrait"><a href="#Substrait" class="headerlink" title="Substrait"></a>Substrait</h4><p>Substrait çš„å®šä½æ˜¯ä¸€ä¸ªå¼€æ”¾çš„ (å¯èƒ½è¢«ä¼˜åŒ–è¿‡çš„) Planï¼Œåé¢å¯ä»¥æ˜¯å¯¹åº”çš„æ‰§è¡Œå™¨ï¼Œå‰é¢äº§ç”Ÿå¯¹åº”çš„ Planã€‚Arrow C++ Acero æœ¬èº«å¹¶ä¸è´Ÿè´£ Planningï¼Œåªæ˜¯ä¸€ä¸ªæ‰§è¡Œçš„å¯¹åº”çš„æµã€‚</p><p><img src="https://image.mwish.me/blog-image/B1AA6B5E-808A-43C6-97CC-D165C82B13A8.png" alt="B1AA6B5E-808A-43C6-97CC-D165C82B13A8"></p><h3 id="Datafusion-Ballista"><a href="#Datafusion-Ballista" class="headerlink" title="Datafusion / Ballista"></a>Datafusion / Ballista</h3><p><img src="https://image.mwish.me/blog-image/D457D790-709D-4B27-846D-DFBDC4183DB2.png" alt="D457D790-709D-4B27-846D-DFBDC4183DB2"></p><p>SQL å’Œæ‰§è¡Œå¯¹åº”çš„é€»è¾‘ã€‚</p><h3 id="Gandiva"><a href="#Gandiva" class="headerlink" title="Gandiva"></a>Gandiva</h3><p>Gandiva ç±»ä¼¼ Computeï¼Œæ˜¯ Dremio æèµ ç»™é¡¹ç›®çš„ï¼Œå¯¹åº”çš„é€»è¾‘æ˜¯ Codegen. è¿™ä¸ªé¡¹ç›®æ„Ÿè§‰å·®ä¸å¤šå·²ç»ä¼¼äº†</p><p><img src="https://image.mwish.me/blog-image/gandiva.png" alt="gandiva"></p><h2 id="æ•°æ®æºå’Œå†™å…¥ç›¸å…³çš„-API"><a href="#æ•°æ®æºå’Œå†™å…¥ç›¸å…³çš„-API" class="headerlink" title="æ•°æ®æºå’Œå†™å…¥ç›¸å…³çš„ API"></a>æ•°æ®æºå’Œå†™å…¥ç›¸å…³çš„ API</h2><p><img src="https://image.mwish.me/blog-image/0EC24B5E-7C33-4F1D-B813-B9C4BBA65D25.png" alt="0EC24B5E-7C33-4F1D-B813-B9C4BBA65D25"></p><p>Arrow åœ¨å¯¹åº”çš„å†…å®¹ä¸Šæœ‰ä¸¤å±‚</p><ol><li>FileSystem: å¤„ç† Local, S3, HDFS ç­‰ã€Œå­˜å‚¨åå°ã€çš„æ–‡ä»¶</li><li>DataSet: ORC/JSON/CSV ç­‰æ–‡ä»¶æ˜¯åœ¨ DataSet å±‚å¤„ç†çš„ï¼Œè¿™å±‚ä¹Ÿä½¿ç”¨äº† FileSystemã€‚æœ‰ç‚¹åƒ Presto çš„ Connectorï¼Œå¯ä»¥ Filter Pushdown å’Œè¯»/å†™</li></ol><h2 id="References"><a href="#References" class="headerlink" title="References"></a><strong>References</strong></h2><ol><li>DuckDB quacks Arrow: A zero-copy data integration between Apache Arrow and DuckDB <a href="https://duckdb.org/2021/12/03/duck-arrow.html">https://duckdb.org/2021/12/03/duck-arrow.html</a></li><li><a href="https://arrow.apache.org/docs/cpp/api/tensor.html">https://arrow.apache.org/docs/cpp/api/tensor.html</a> å’Œ maillist çš„è®¨è®º <a href="https://lists.apache.org/thread/95ncmr4two34mxodlds7bzxvrrzmk1s6">https://lists.apache.org/thread/95ncmr4two34mxodlds7bzxvrrzmk1s6</a></li></ol></li></ol>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Arrow Compute: CallFunction and Add</title>
      <link href="/2023/05/27/Arrow-Compute/"/>
      <url>/2023/05/27/Arrow-Compute/</url>
      
        <content type="html"><![CDATA[<h2 id="æ¦‚å¿µä»‹ç»"><a href="#æ¦‚å¿µä»‹ç»" class="headerlink" title="æ¦‚å¿µä»‹ç»"></a>æ¦‚å¿µä»‹ç»</h2><p>Arrow åŒ…å«ç€ä¸€äº›å¯¹åº”çš„ Runtime ç±»å‹çš„è¯­ä¹‰ï¼Œå¯ä»¥æ‰§è¡Œä¸€äº›è®¡ç®—ç›¸å…³çš„åŠŸèƒ½ï¼Œå®ƒçš„ä¸Šå±‚å¯ä»¥æ˜¯ Python è„šæœ¬ç›´æ¥è°ƒç”¨ Arrow Computeï¼Œä¹Ÿå¯ä»¥æ˜¯ Substrait Plan è°ƒç”¨ Aceroã€‚</p><p>ç®€å•æ¥è¯´ï¼ŒArrow è¿™äº›è®¡ç®—å¯ä»¥åŒ…æ‹¬ Compute å±‚å’Œ Acero å±‚ï¼š</p><ol><li>Compute: (æ‰§è¡Œå•å…ƒ) Datum, Expression, Function å’Œ Function å±‚é¢çš„æ‰§è¡Œ( Kernel, FunctionExecutor, KernelExecutor)</li><li>Acero: Push-Based Execution Model, ExecBatch, è°ƒåº¦ï¼ˆå¯èƒ½ä¼šç”¨åˆ° dataset å±‚çš„ api æ¥è®¿é—®æ•°æ®ï¼‰</li></ol><p><strong>Datum</strong>: ä¸€ä¸ªæ³›ç”¨ç±»å‹ï¼Œå¯ä»¥åŒ…è£… {scalar, array, chunked array, record batch, table}.  æ“ä½œçš„è¾“å…¥å’Œè¾“å‡ºé€šå¸¸éƒ½æ˜¯æŸç§ <code>vector&lt;Datum&gt; -&gt; Datum</code></p><p>Function: ç”±<strong>ä¸€ä¸ªæˆ–è€…æ•°ä¸ª Kernel</strong> ç»„æˆï¼Œæ¯ä¸ª Kernel æœ‰æ“ä½œå’Œå¯¹åº”çš„<strong>è¾“å…¥/è¾“å‡ºç±»å‹</strong>ï¼ŒFunction æŒ‰ç…§ Function name æ³¨å†Œåœ¨ <strong>FunctionRegistry</strong> ä¸­. åœ¨ç±»å‹åŒ¹é…çš„æ—¶å€™ï¼ŒFunction æ”¯æŒã€ŒæŒ‘é€‰æœ€ä½³çš„åŒ¹é…ã€ï¼Œå¹¶ä¸”ï¼ŒFunction æ”¯æŒ implicit castï¼Œå°†ä¸€äº›ç±»å‹å®Œæˆå¯¹åº”çš„è½¬å‹.</p><p>å¥½ï¼Œä¸Šé¢çš„çŸ¥è¯†ä½ å·²ç»çŸ¥é“äº†ï¼Œä¸‹é¢ä¸¾ä¸€ä¸ªå¼±æ™ºçš„ä¾‹å­ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">auto</span> i64_3 = std::<span class="built_in">make_shared</span>&lt;arrow::Int64Scalar&gt;(<span class="number">3</span>);</span><br><span class="line">arrow::Datum incremented_datum;</span><br><span class="line"></span><br><span class="line"><span class="built_in">ARROW_ASSIGN_OR_RAISE</span>(incremented_datum,</span><br><span class="line">                      arrow::compute::<span class="built_in">CallFunction</span>(<span class="string">&quot;add&quot;</span>, &#123;int64_array_a, i64_3&#125;));</span><br><span class="line">std::shared_ptr&lt;::arrow::Array&gt; incremented_array = std::<span class="built_in">move</span>(incremented_datum).<span class="built_in">make_array</span>();</span><br><span class="line">std::cout &lt;&lt; incremented_array-&gt;<span class="built_in">ToString</span>() &lt;&lt; std::endl;</span><br></pre></td></tr></table></figure><ol><li>è¿™é‡Œè¾“å…¥æ˜¯ä¸€ä¸ª <code>Array</code> å’Œ <code>Scalar</code>ï¼Œç±»å‹éƒ½æ˜¯ <code>Int64</code>ï¼Œè¾“å‡ºæ˜¯ä¸€ä¸ª <code>Int64Array</code></li><li>è°ƒç”¨äº† <code>arrow::compute::CallFunction</code>, é€šè¿‡åç§° <code>&quot;add&quot;</code> æ¥è°ƒç”¨å¯¹åº”çš„å‡½æ•°</li><li>è¿”å›ç±»å‹æ˜¯ä¸€ä¸ª <code>Datum</code>ï¼Œå¯ä»¥ get å‡ºæ¥æ˜¯ä¸€ä¸ª Arrayã€‚</li></ol><p>å®é™…ä¸Šï¼ŒæŠŠ <code>Int64Scalar</code> æ¢æˆ <code>Int32Scalar</code> ä¹Ÿæ˜¯å¯ä»¥é€šè¿‡çš„ï¼Œå› ä¸ºè¿™é‡Œçš„ç³»ç»Ÿæ”¯æŒå†…éƒ¨çš„è½¬å‹ã€‚ç”šè‡³ä» Dict è½¬æˆæ™®é€šç±»å‹ä¹Ÿæ˜¯å¯ä»¥çš„. Arrow Compute æŒ‡å®šäº†ä¸€ä¸ªç±»å‹å…¼å®¹æ€§çš„è¡¨æ ¼ï¼Œæ¥å¤„ç†è¿™é¡¹ä»»åŠ¡ï¼š<a href="https://arrow.apache.org/docs/cpp/compute.html#common-numeric-type">https://arrow.apache.org/docs/cpp/compute.html#common-numeric-type</a></p><p>è¿™é‡Œç®€å•çš„æ¨æ–­ä¸€ä¸‹è¿™å¥—è§„åˆ™ï¼Œæ„Ÿè§‰ Arrow ç”¨çš„æ˜¯ç®€å•çš„ç±»å‹æ˜ å°„å†™è¿›å»çš„ï¼Œæ²¡æœ‰å¼•å…¥ä¸€äº›ç›¸å¯¹å¤æ‚ä¸€äº›çš„è®¡ç®—ï¼š</p><ul><li>Numeric<ul><li>Numeric å…è®¸ Implicit Cast<ul><li>Signed integer / Unsigned integer / Floating Point çš„ Common Type æ˜¯ <code>max(T1, T2)</code></li><li>(Unsigned, Signed) çš„ Common Type æ˜¯ <code>larger-int(max(T1, T2))</code>. ç‰¹æ®Šçš„ï¼Œå½“å…¶ä¸­ä¸€ä¸ªç±»å‹æ˜¯ 64-bit çš„æ—¶å€™ï¼Œè¿™é‡Œé€‰æ‹©çš„è¾“å‡ºç±»å‹æ˜¯ int64 (è€Œå¯èƒ½ä¸æ˜¯ decimal)ã€‚è¿™ä»£è¡¨ï¼Œ<code>(int64, uint64)</code> ä¸­ï¼Œu64 çš„å¤§äº <code>i64::max</code> çš„å€¼ä¼šè¢« truncate</li></ul></li><li>Arrow æœ‰ Decimal128 å’Œ Decimal256</li></ul></li><li>Temporal: Date types (Date32, Date64), Time types (Time32, Time64), Timestamp, Duration, Interval.</li><li>â€œBinary-likeâ€: Binary, LargeBinary, sometimes also FixedSizeBinary.</li><li>â€œString-likeâ€: String, LargeString.<ul><li>è¿™é‡Œä¸æ”¯æŒç‰¹æ®Šçš„é™å®šé•¿åº¦æˆ–è€… char varchar ç±»å‹ã€‚è€Œä¸” String / LargeString å®é™…ä¸Šå’Œç‰©ç† Layout æœ‰å…³</li></ul></li><li>â€œList-likeâ€: List, LargeList, sometimes also FixedSizeList.</li><li>â€œNestedâ€: List-likes (including FixedSizeList), Struct, Union, and related types like Map.</li></ul><p>ï¼ˆä»¤æˆ‘æ„Ÿè§‰å¾ˆæç¬‘çš„æ˜¯ï¼Œè¿™é‡Œç«Ÿç„¶æ²¡æœ‰åŒ…æ‹¬å­—å…¸å’Œ REE. <code>&#123;å­—å…¸, REE&#125;</code> å…è®¸ Implicit Cast åˆ°ï¼‰</p><blockquote><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒGroup Aggregation å¹¶ä¸èƒ½ç”¨ <code>CallFunction</code> æ¥è°ƒç”¨</p></blockquote><p>Function æœ‰å‡ ç§ç±»å‹ï¼Œç²—ç•¥çš„è¯´ï¼Œç±»å‹åŒ…å«ï¼š</p><ol><li>Aggregators: æ¥æ”¶ (chunked) array / scalarï¼Œç”Ÿæˆä¸€ä¸ª Scalar Output Value</li><li>Grouped Aggregations: ç±»ä¼¼ GROUP BY (col1, col2â€¦)ã€‚æ¥æ”¶ Hash Agg (æˆ‘ç®€å•æ‰«äº†ä¸€ä¸‹ï¼Œä¼¼ä¹ä¸æ”¯æŒ SortMerge + Agg?)ã€‚å®ç°ä¸Šç®—å­ä¼šç±»ä¼¼ä¸‹é¢æ‰€ç¤ºã€‚åœ¨è¿™ä¸ª</li></ol><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">HashAggregate</span></span><br><span class="line"><span class="function">  <span class="title">grouper</span><span class="params">(hash)</span></span></span><br><span class="line"><span class="function">  <span class="title">hash_agg</span><span class="params">(agg)</span></span></span><br></pre></td></tr></table></figure><ol><li>Scalar Functions: Scalar å¹¶ä¸æ˜¯è¡¨ç¤ºè¿™ä¸ªå‡½æ•°æ˜¯ <code>F(Scalar) -&gt; Scalar</code>ï¼Œè€Œæ˜¯è¡¨ç¤ºä¸€ç§å•å°„å…³ç³»ï¼Œä»ä¸€ç»„æ˜¯å‚æ•°ç”Ÿæˆå¦ä¸€ç»„å‚æ•°ã€‚ä¸¾ä¾‹ä¸º â€œaddâ€, â€œmulâ€ ç”šè‡³ â€œabsâ€ è¿™ç§ã€‚å®é™…ä¸Šè¿™é‡Œç§ç±»æ˜¯éå¸¸å¤šçš„ï¼Œä¸è¿‡æˆ‘ä»¬è¿™ç¯‡åšå®¢ä¸ä»‹ç»æ¡†æ¶ä¹‹å¤–çš„ä¸œè¥¿ã€‚<ol><li>æ¯”è¾ƒæœ‰æ„æ€çš„æ˜¯ï¼Œrandom number generator è¿™ç§ 0 ä¸ªå‚æ•°çš„ä¸œè¥¿ä¹Ÿè¢«å½’ç±»äº†è¿™é‡Œã€‚</li></ol></li><li>Vector Functions: è¾“å‡ºæ˜¯ç±»ä¼¼å¸¦çŠ¶æ€çš„ï¼Œæ¯”å¦‚ Sort / ç´¯ç§¯å’Œ / Filter è¿™ç§</li></ol><p>ä¸Šé¢çš„ç³»ç»Ÿè¢«ç»„ç»‡æˆä¸‹é¢çš„å±‚æ¬¡ï¼š</p><ul><li>ExecNode (in Acero)</li><li>Function( ä¸åŒç±»å‹çš„ Function )</li><li>Kernel (åŒä¸€ä¸ª Function çš„ä¸åŒå®ç°)</li></ul><p>ä¸‹é¢æˆ‘ä»¬æ¥é˜…è¯»åé¢ä¸¤é¡¹çš„ä»£ç ç»„ç»‡ã€‚</p><h2 id="ä»-CallFunction-å’Œ-â€œaddâ€-çœ‹èµ·"><a href="#ä»-CallFunction-å’Œ-â€œaddâ€-çœ‹èµ·" class="headerlink" title="ä» CallFunction å’Œ â€œaddâ€ çœ‹èµ·"></a>ä» CallFunction å’Œ â€œaddâ€ çœ‹èµ·</h2><p>ä¸€äº›å‡½æ•°èƒ½å¤Ÿè¢« <code>CallFunction</code> è°ƒç”¨ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">ARROW_EXPORT</span></span><br><span class="line"><span class="function">Result&lt;Datum&gt; <span class="title">CallFunction</span><span class="params">(<span class="type">const</span> std::string&amp; func_name, <span class="type">const</span> std::vector&lt;Datum&gt;&amp; args,</span></span></span><br><span class="line"><span class="params"><span class="function">                           <span class="type">const</span> FunctionOptions* options, ExecContext* ctx = NULLPTR)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function">ARROW_EXPORT</span></span><br><span class="line"><span class="function">Result&lt;Datum&gt; <span class="title">CallFunction</span><span class="params">(<span class="type">const</span> std::string&amp; func_name, <span class="type">const</span> std::vector&lt;Datum&gt;&amp; args,</span></span></span><br><span class="line"><span class="params"><span class="function">                           ExecContext* ctx = NULLPTR)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function">ARROW_EXPORT</span></span><br><span class="line"><span class="function">Result&lt;Datum&gt; <span class="title">CallFunction</span><span class="params">(<span class="type">const</span> std::string&amp; func_name, <span class="type">const</span> ExecBatch&amp; batch,</span></span></span><br><span class="line"><span class="params"><span class="function">                           <span class="type">const</span> FunctionOptions* options, ExecContext* ctx = NULLPTR)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function">ARROW_EXPORT</span></span><br><span class="line"><span class="function">Result&lt;Datum&gt; <span class="title">CallFunction</span><span class="params">(<span class="type">const</span> std::string&amp; func_name, <span class="type">const</span> ExecBatch&amp; batch,</span></span></span><br><span class="line"><span class="params"><span class="function">                           ExecContext* ctx = NULLPTR)</span></span>;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œé™¤äº†æˆ‘ä»¬ä¹‹å‰ä»‹ç»çš„ï¼Œè¿˜æœ‰å‡ ä¸ªæ¯”è¾ƒå¥½ç©çš„å‚æ•°:</p><ol><li><code>FunctionOptions</code>: æ˜¯ä¸€ä¸ªæ¯”è¾ƒå¥‡æ€ªçš„ä¸œè¥¿</li><li><code>ExecBatch</code>: åŸºæœ¬ä¸Šæ˜¯ Acero ä¹‹ç±»çš„ä¼ ä¸‹æ¥çš„ï¼Œå®ƒä»¬å€¾å‘ä»¥ Batch æ¨¡å¼æ¥ Exec</li><li><code>ExecContext</code>: æ‰§è¡Œçš„æ—¶å€™çš„ä¸Šä¸‹æ–‡ï¼ŒåŒ…å«äº†ï¼š<ol><li>MemoryPool</li><li>CPU Info ( SIMD instr ä¹‹ç±»çš„ï¼‰</li><li>CPU Executor</li><li>ChunkSize ( Batch Size )</li><li>Function Registry</li></ol></li></ol><p>é‚£ä¹ˆï¼Œæœ€ä¸ºæœ€å¼€å§‹ä½¿ç”¨çš„ç”¨æˆ·ï¼Œæˆ‘ä»¬å¯ä»¥è‡ªé¡¶å‘ä¸‹çš„æ¥çœ‹çœ‹è¿™ä¸ª CallFunction:</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Result&lt;Datum&gt; <span class="title">CallFunction</span><span class="params">(<span class="type">const</span> std::string&amp; func_name, <span class="type">const</span> std::vector&lt;Datum&gt;&amp; args,</span></span></span><br><span class="line"><span class="params"><span class="function">                           <span class="type">const</span> FunctionOptions* options, ExecContext* ctx)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (ctx == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">    ctx = <span class="built_in">default_exec_context</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">ARROW_ASSIGN_OR_RAISE</span>(std::shared_ptr&lt;<span class="type">const</span> Function&gt; func,</span><br><span class="line">                        ctx-&gt;<span class="built_in">func_registry</span>()-&gt;<span class="built_in">GetFunction</span>(func_name));</span><br><span class="line">  <span class="keyword">return</span> func-&gt;<span class="built_in">Execute</span>(args, options, ctx);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="FunctionRegistry"><a href="#FunctionRegistry" class="headerlink" title="FunctionRegistry"></a>FunctionRegistry</h4><p>FunctionRegistry çš„å®ç°å…³ç³»ç±»ä¼¼ Naming çš„ Scope:</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">FunctionRegistry</span>::FunctionRegistryImpl &#123;</span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span>:</span><br><span class="line">  FunctionRegistryImpl* parent_;</span><br><span class="line">  std::mutex lock_;</span><br><span class="line">  std::unordered_map&lt;std::string, std::shared_ptr&lt;Function&gt;&gt; name_to_function_;</span><br><span class="line">  std::unordered_map&lt;std::string, <span class="type">const</span> FunctionOptionsType*&gt; name_to_options_type_;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><ol><li>å†…éƒ¨æˆå‘˜å®é™…ä¸Šä¼šæœ‰ <code>lock_</code> çš„ä¿æŠ¤</li><li>æœ‰çˆ¶çº§å…³ç³»( æˆ‘çœ‹äº†ä¸‹ï¼Œarrow å†…éƒ¨å¥½åƒæ²¡ç”¨åˆ°ï¼Œæ„Ÿè§‰æ˜¯ç»™ç”¨æˆ·å¤„ç† UDF ä¹‹ç±»çš„ï¼Ÿï¼‰</li><li>å…è®¸åŠ å…¥æˆå‘˜å’Œ alias</li></ol><p>é‚£ä¹ˆï¼Œè¿™é‡Œå±‚æ¬¡æ˜¯æ€ä¹ˆç©çš„å‘¢ï¼Œç­”æ¡ˆæ˜¯å®ƒä¼šæŒ‰ç…§åˆ†ç±»æ¥åˆ›å»ºï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> std::unique_ptr&lt;FunctionRegistry&gt; <span class="title">CreateBuiltInRegistry</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">auto</span> registry = FunctionRegistry::<span class="built_in">Make</span>();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Register core kernels</span></span><br><span class="line">  <span class="built_in">RegisterScalarCast</span>(registry.<span class="built_in">get</span>());</span><br><span class="line">  <span class="built_in">RegisterVectorHash</span>(registry.<span class="built_in">get</span>());</span><br><span class="line">  <span class="built_in">RegisterVectorSelection</span>(registry.<span class="built_in">get</span>());</span><br><span class="line"></span><br><span class="line">  <span class="built_in">RegisterScalarOptions</span>(registry.<span class="built_in">get</span>());</span><br><span class="line">  <span class="built_in">RegisterVectorOptions</span>(registry.<span class="built_in">get</span>());</span><br><span class="line">  <span class="built_in">RegisterAggregateOptions</span>(registry.<span class="built_in">get</span>());</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> ARROW_COMPUTE</span></span><br><span class="line">  <span class="comment">// Register additional kernels</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Scalar functions</span></span><br><span class="line">  <span class="built_in">RegisterScalarArithmetic</span>(registry.<span class="built_in">get</span>());</span><br><span class="line">  <span class="built_in">RegisterScalarBoolean</span>(registry.<span class="built_in">get</span>());</span><br><span class="line">  <span class="built_in">RegisterScalarComparison</span>(registry.<span class="built_in">get</span>());</span><br><span class="line">  <span class="built_in">RegisterScalarIfElse</span>(registry.<span class="built_in">get</span>());</span><br><span class="line">  <span class="built_in">RegisterScalarNested</span>(registry.<span class="built_in">get</span>());</span><br><span class="line">  <span class="built_in">RegisterScalarRandom</span>(registry.<span class="built_in">get</span>());  <span class="comment">// Nullary</span></span><br><span class="line">  <span class="built_in">RegisterScalarRoundArithmetic</span>(registry.<span class="built_in">get</span>());</span><br><span class="line">  <span class="built_in">RegisterScalarSetLookup</span>(registry.<span class="built_in">get</span>());</span><br><span class="line">  <span class="built_in">RegisterScalarStringAscii</span>(registry.<span class="built_in">get</span>());</span><br><span class="line">  <span class="built_in">RegisterScalarStringUtf8</span>(registry.<span class="built_in">get</span>());</span><br><span class="line">  <span class="built_in">RegisterScalarTemporalBinary</span>(registry.<span class="built_in">get</span>());</span><br><span class="line">  <span class="built_in">RegisterScalarTemporalUnary</span>(registry.<span class="built_in">get</span>());</span><br><span class="line">  <span class="built_in">RegisterScalarValidity</span>(registry.<span class="built_in">get</span>());</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Vector functions</span></span><br><span class="line">  <span class="built_in">RegisterVectorArraySort</span>(registry.<span class="built_in">get</span>());</span><br><span class="line">  <span class="built_in">RegisterVectorCumulativeSum</span>(registry.<span class="built_in">get</span>());</span><br><span class="line">  <span class="built_in">RegisterVectorNested</span>(registry.<span class="built_in">get</span>());</span><br><span class="line">  <span class="built_in">RegisterVectorRank</span>(registry.<span class="built_in">get</span>());</span><br><span class="line">  <span class="built_in">RegisterVectorReplace</span>(registry.<span class="built_in">get</span>());</span><br><span class="line">  <span class="built_in">RegisterVectorSelectK</span>(registry.<span class="built_in">get</span>());</span><br><span class="line">  <span class="built_in">RegisterVectorSort</span>(registry.<span class="built_in">get</span>());</span><br><span class="line">  <span class="built_in">RegisterVectorRunEndEncode</span>(registry.<span class="built_in">get</span>());</span><br><span class="line">  <span class="built_in">RegisterVectorRunEndDecode</span>(registry.<span class="built_in">get</span>());</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Aggregate functions</span></span><br><span class="line">  <span class="built_in">RegisterHashAggregateBasic</span>(registry.<span class="built_in">get</span>());</span><br><span class="line">  <span class="built_in">RegisterScalarAggregateBasic</span>(registry.<span class="built_in">get</span>());</span><br><span class="line">  <span class="built_in">RegisterScalarAggregateMode</span>(registry.<span class="built_in">get</span>());</span><br><span class="line">  <span class="built_in">RegisterScalarAggregateQuantile</span>(registry.<span class="built_in">get</span>());</span><br><span class="line">  <span class="built_in">RegisterScalarAggregateTDigest</span>(registry.<span class="built_in">get</span>());</span><br><span class="line">  <span class="built_in">RegisterScalarAggregateVariance</span>(registry.<span class="built_in">get</span>());</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> registry;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;  <span class="comment">// namespace internal</span></span><br><span class="line"></span><br><span class="line"><span class="function">FunctionRegistry* <span class="title">GetFunctionRegistry</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="type">static</span> <span class="keyword">auto</span> g_registry = internal::<span class="built_in">CreateBuiltInRegistry</span>();</span><br><span class="line">  <span class="keyword">return</span> g_registry.<span class="built_in">get</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬ä¸¾å‡ ä¸ªä¾‹å­ï¼Œæ¯”å¦‚æ’å…¥ Cast ç›¸å…³çš„:</p><ol><li>MetaFunction æœ¬è´¨ä¸Šæ˜¯ä¸ªè½¬å‘å™¨(è¯¯)</li><li>æ³¨å†Œäº†ä¸€ä¸ª FunctionOptionï¼Œè¿™é‡Œç»‘å®šçš„æ˜¯ç±»å‹å’Œå¯¹åº”çš„æˆå‘˜ã€‚</li></ol><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">auto</span> kCastOptionsType = <span class="built_in">GetFunctionOptionsType</span>&lt;CastOptions&gt;(</span><br><span class="line">    arrow::internal::<span class="built_in">DataMember</span>(<span class="string">&quot;to_type&quot;</span>, &amp;CastOptions::to_type),</span><br><span class="line">    arrow::internal::<span class="built_in">DataMember</span>(<span class="string">&quot;allow_int_overflow&quot;</span>, &amp;CastOptions::allow_int_overflow),</span><br><span class="line">    arrow::internal::<span class="built_in">DataMember</span>(<span class="string">&quot;allow_time_truncate&quot;</span>, &amp;CastOptions::allow_time_truncate),</span><br><span class="line">    arrow::internal::<span class="built_in">DataMember</span>(<span class="string">&quot;allow_time_overflow&quot;</span>, &amp;CastOptions::allow_time_overflow),</span><br><span class="line">    arrow::internal::<span class="built_in">DataMember</span>(<span class="string">&quot;allow_decimal_truncate&quot;</span>,</span><br><span class="line">                                &amp;CastOptions::allow_decimal_truncate),</span><br><span class="line">    arrow::internal::<span class="built_in">DataMember</span>(<span class="string">&quot;allow_float_truncate&quot;</span>,</span><br><span class="line">                                &amp;CastOptions::allow_float_truncate),</span><br><span class="line">    arrow::internal::<span class="built_in">DataMember</span>(<span class="string">&quot;allow_invalid_utf8&quot;</span>, &amp;CastOptions::allow_invalid_utf8));</span><br><span class="line">&#125;  <span class="comment">// namespace</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">RegisterScalarCast</span><span class="params">(FunctionRegistry* registry)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">DCHECK_OK</span>(registry-&gt;<span class="built_in">AddFunction</span>(std::<span class="built_in">make_shared</span>&lt;CastMetaFunction&gt;()));</span><br><span class="line">  <span class="built_in">DCHECK_OK</span>(registry-&gt;<span class="built_in">AddFunctionOptionsType</span>(kCastOptionsType));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶å®ä½ ä¼šå¯¹è¿™ä¸ª FunctionType å¾ˆå›°æƒ‘ï¼Œæˆ‘ä¹Ÿå¾ˆå›°æƒ‘ï¼Œçœ‹ä¸Šå»ä»–ä»¬æŒ«äº†ä¸€å¥—åå°„åº“ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> Options, <span class="keyword">typename</span>... Properties&gt;</span><br><span class="line"><span class="function"><span class="type">const</span> FunctionOptionsType* <span class="title">GetFunctionOptionsType</span><span class="params">(<span class="type">const</span> Properties&amp;... properties)</span> </span>&#123;</span><br><span class="line">  <span class="type">static</span> <span class="type">const</span> <span class="keyword">class</span> <span class="title class_">OptionsType</span> : <span class="keyword">public</span> GenericOptionsType &#123;</span><br><span class="line">   <span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">explicit</span> <span class="title">OptionsType</span><span class="params">(<span class="type">const</span> arrow::internal::PropertyTuple&lt;Properties...&gt; properties)</span></span></span><br><span class="line"><span class="function">        : properties_(properties) &#123;</span>&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">const</span> <span class="type">char</span>* <span class="title">type_name</span><span class="params">()</span> <span class="type">const</span> <span class="keyword">override</span> </span>&#123; <span class="keyword">return</span> Options::kTypeName; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">std::string <span class="title">Stringify</span><span class="params">(<span class="type">const</span> FunctionOptions&amp; options)</span> <span class="type">const</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">      <span class="type">const</span> <span class="keyword">auto</span>&amp; self = <span class="built_in">checked_cast</span>&lt;<span class="type">const</span> Options&amp;&gt;(options);</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">StringifyImpl</span>&lt;Options&gt;(self, properties_).<span class="built_in">Finish</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">Compare</span><span class="params">(<span class="type">const</span> FunctionOptions&amp; options,</span></span></span><br><span class="line"><span class="params"><span class="function">                 <span class="type">const</span> FunctionOptions&amp; other)</span> <span class="type">const</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">      <span class="type">const</span> <span class="keyword">auto</span>&amp; lhs = <span class="built_in">checked_cast</span>&lt;<span class="type">const</span> Options&amp;&gt;(options);</span><br><span class="line">      <span class="type">const</span> <span class="keyword">auto</span>&amp; rhs = <span class="built_in">checked_cast</span>&lt;<span class="type">const</span> Options&amp;&gt;(other);</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">CompareImpl</span>&lt;Options&gt;(lhs, rhs, properties_).equal_;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">Status <span class="title">ToStructScalar</span><span class="params">(<span class="type">const</span> FunctionOptions&amp; options,</span></span></span><br><span class="line"><span class="params"><span class="function">                          std::vector&lt;std::string&gt;* field_names,</span></span></span><br><span class="line"><span class="params"><span class="function">                          std::vector&lt;std::shared_ptr&lt;Scalar&gt;&gt;* values)</span> <span class="type">const</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">      <span class="type">const</span> <span class="keyword">auto</span>&amp; self = <span class="built_in">checked_cast</span>&lt;<span class="type">const</span> Options&amp;&gt;(options);</span><br><span class="line">      <span class="built_in">RETURN_NOT_OK</span>(</span><br><span class="line">          <span class="built_in">ToStructScalarImpl</span>&lt;Options&gt;(self, properties_, field_names, values).status_);</span><br><span class="line">      <span class="keyword">return</span> Status::<span class="built_in">OK</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    Result&lt;std::unique_ptr&lt;FunctionOptions&gt;&gt; <span class="built_in">FromStructScalar</span>(</span><br><span class="line">        <span class="type">const</span> StructScalar&amp; scalar) <span class="type">const</span> <span class="keyword">override</span> &#123;</span><br><span class="line">      <span class="keyword">auto</span> options = std::<span class="built_in">make_unique</span>&lt;Options&gt;();</span><br><span class="line">      <span class="built_in">RETURN_NOT_OK</span>(</span><br><span class="line">          <span class="built_in">FromStructScalarImpl</span>&lt;Options&gt;(options.<span class="built_in">get</span>(), scalar, properties_).status_);</span><br><span class="line">      <span class="keyword">return</span> std::<span class="built_in">move</span>(options);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">std::unique_ptr&lt;FunctionOptions&gt; <span class="title">Copy</span><span class="params">(<span class="type">const</span> FunctionOptions&amp; options)</span> <span class="type">const</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">      <span class="keyword">auto</span> out = std::<span class="built_in">make_unique</span>&lt;Options&gt;();</span><br><span class="line">      <span class="built_in">CopyImpl</span>&lt;Options&gt;(out.<span class="built_in">get</span>(), <span class="built_in">checked_cast</span>&lt;<span class="type">const</span> Options&amp;&gt;(options), properties_);</span><br><span class="line">      <span class="keyword">return</span> std::<span class="built_in">move</span>(out);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">private</span>:</span><br><span class="line">    <span class="type">const</span> arrow::internal::PropertyTuple&lt;Properties...&gt; properties_;</span><br><span class="line">  &#125; <span class="built_in">instance</span>(arrow::internal::<span class="built_in">MakeProperties</span>(properties...));</span><br><span class="line">  <span class="keyword">return</span> &amp;instance;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="Function"><a href="#Function" class="headerlink" title="Function"></a>Function</h4><p>ç„¶åæˆ‘ä»¬æ¥çœ‹çœ‹ <code>Function</code> éƒ¨åˆ†ï¼Œä»¥ â€œAddâ€ ä¸ºä¾‹:</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="function">Result&lt;Datum&gt; <span class="title">ExecuteInternal</span><span class="params">(<span class="type">const</span> Function&amp; func, std::vector&lt;Datum&gt; args,</span></span></span><br><span class="line"><span class="params"><span class="function">                              <span class="type">int64_t</span> passed_length, <span class="type">const</span> FunctionOptions* options,</span></span></span><br><span class="line"><span class="params"><span class="function">                              ExecContext* ctx)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">ARROW_ASSIGN_OR_RAISE</span>(<span class="keyword">auto</span> inputs, internal::<span class="built_in">GetFunctionArgumentTypes</span>(args));</span><br><span class="line">  <span class="built_in">ARROW_ASSIGN_OR_RAISE</span>(<span class="keyword">auto</span> func_exec, func.<span class="built_in">GetBestExecutor</span>(inputs));</span><br><span class="line">  <span class="built_in">ARROW_RETURN_NOT_OK</span>(func_exec-&gt;<span class="built_in">Init</span>(options, ctx));</span><br><span class="line">  <span class="keyword">return</span> func_exec-&gt;<span class="built_in">Execute</span>(args, passed_length);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;  <span class="comment">// namespace</span></span><br><span class="line"></span><br><span class="line"><span class="function">Result&lt;Datum&gt; <span class="title">Function::Execute</span><span class="params">(<span class="type">const</span> std::vector&lt;Datum&gt;&amp; args,</span></span></span><br><span class="line"><span class="params"><span class="function">                                <span class="type">const</span> FunctionOptions* options, ExecContext* ctx)</span> <span class="type">const</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">ExecuteInternal</span>(*<span class="keyword">this</span>, args, <span class="comment">/*passed_length=*/</span><span class="number">-1</span>, options, ctx);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">Result&lt;Datum&gt; <span class="title">Function::Execute</span><span class="params">(<span class="type">const</span> ExecBatch&amp; batch, <span class="type">const</span> FunctionOptions* options,</span></span></span><br><span class="line"><span class="params"><span class="function">                                ExecContext* ctx)</span> <span class="type">const</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">ExecuteInternal</span>(*<span class="keyword">this</span>, batch.values, batch.length, options, ctx);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Function å†…éƒ¨æœ‰ä¸€å±‚ <code>Dispatch</code> çš„æµç¨‹:</p><ol><li>åˆ›å»ºå¯¹åº”çš„ Executorï¼Œè¿™é‡Œçš„ Executor æ˜¯ä¸ª <code>KernelExecutor</code> ç±»å‹</li><li>ç„¶åæ‰¾åˆ° Best çš„ Kernel( <code>GetBestExecutor</code> )</li><li>åŒ…è£…æˆä¸€ä¸ª FunctionExecutor è¿”å›</li></ol><p>æˆ‘ä»¬å…ˆæ¥è®² <code>Kernel</code>ï¼Œç„¶åæ¥è®²å¯¹åº”çš„ Executors</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">Result&lt;std::shared_ptr&lt;FunctionExecutor&gt;&gt; Function::<span class="built_in">GetBestExecutor</span>(</span><br><span class="line">    std::vector&lt;TypeHolder&gt; inputs) <span class="type">const</span> &#123;</span><br><span class="line">  std::unique_ptr&lt;detail::KernelExecutor&gt; executor;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">kind</span>() == Function::SCALAR) &#123;</span><br><span class="line">    executor = detail::KernelExecutor::<span class="built_in">MakeScalar</span>();</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">kind</span>() == Function::VECTOR) &#123;</span><br><span class="line">    executor = detail::KernelExecutor::<span class="built_in">MakeVector</span>();</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">kind</span>() == Function::SCALAR_AGGREGATE) &#123;</span><br><span class="line">    executor = detail::KernelExecutor::<span class="built_in">MakeScalarAggregate</span>();</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> Status::<span class="built_in">NotImplemented</span>(<span class="string">&quot;Direct execution of HASH_AGGREGATE functions&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">ARROW_ASSIGN_OR_RAISE</span>(<span class="type">const</span> Kernel* kernel, <span class="built_in">DispatchBest</span>(&amp;inputs));</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> std::<span class="built_in">make_shared</span>&lt;detail::FunctionExecutorImpl&gt;(std::<span class="built_in">move</span>(inputs), kernel,</span><br><span class="line">                                                        std::<span class="built_in">move</span>(executor), *<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="Kernel-æ‰§è¡Œå™¨å’Œé€»è¾‘çš„ç”Ÿæˆ"><a href="#Kernel-æ‰§è¡Œå™¨å’Œé€»è¾‘çš„ç”Ÿæˆ" class="headerlink" title="Kernel æ‰§è¡Œå™¨å’Œé€»è¾‘çš„ç”Ÿæˆ"></a>Kernel æ‰§è¡Œå™¨å’Œé€»è¾‘çš„ç”Ÿæˆ</h4><p>é¦–å…ˆï¼Œæˆ‘ä»¬æ¥ä»‹ç» Kernel å¯¹è±¡ï¼ŒKernel çš„ç±»å‹ç¨ç¨æœ‰ç‚¹å¤æ‚ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// \brief Common initializer function for all kernel types.</span></span><br><span class="line"><span class="keyword">using</span> KernelInit = std::function&lt;Result&lt;std::unique_ptr&lt;KernelState&gt;&gt;(</span><br><span class="line">    KernelContext*, <span class="type">const</span> KernelInitArgs&amp;)&gt;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// \brief Base type for kernels. Contains the function signature and</span></span><br><span class="line"><span class="comment">/// optionally the state initialization function, along with some common</span></span><br><span class="line"><span class="comment">/// attributes</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">ARROW_EXPORT</span> Kernel &#123;</span><br><span class="line">  <span class="built_in">Kernel</span>() = <span class="keyword">default</span>;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">Kernel</span>(std::shared_ptr&lt;KernelSignature&gt; sig, KernelInit init)</span><br><span class="line">      : <span class="built_in">signature</span>(std::<span class="built_in">move</span>(sig)), <span class="built_in">init</span>(std::<span class="built_in">move</span>(init)) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">Kernel</span>(std::vector&lt;InputType&gt; in_types, OutputType out_type, KernelInit init)</span><br><span class="line">      : <span class="built_in">Kernel</span>(KernelSignature::<span class="built_in">Make</span>(std::<span class="built_in">move</span>(in_types), std::<span class="built_in">move</span>(out_type)),</span><br><span class="line">               std::<span class="built_in">move</span>(init)) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// \brief The &quot;signature&quot; of the kernel containing the InputType input</span></span><br><span class="line">  <span class="comment">/// argument validators and OutputType output type resolver.</span></span><br><span class="line">  std::shared_ptr&lt;KernelSignature&gt; signature;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// \brief Create a new KernelState for invocations of this kernel, e.g. to</span></span><br><span class="line">  <span class="comment">/// set up any options or state relevant for execution.</span></span><br><span class="line">  KernelInit init;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// \brief Create a vector of new KernelState for invocations of this kernel.</span></span><br><span class="line">  <span class="function"><span class="type">static</span> Status <span class="title">InitAll</span><span class="params">(KernelContext*, <span class="type">const</span> KernelInitArgs&amp;,</span></span></span><br><span class="line"><span class="params"><span class="function">                        std::vector&lt;std::unique_ptr&lt;KernelState&gt;&gt;*)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// \brief Indicates whether execution can benefit from parallelization</span></span><br><span class="line">  <span class="comment">/// (splitting large chunks into smaller chunks and using multiple</span></span><br><span class="line">  <span class="comment">/// threads). Some kernels may not support parallel execution at</span></span><br><span class="line">  <span class="comment">/// all. Synchronization and concurrency-related issues are currently the</span></span><br><span class="line">  <span class="comment">/// responsibility of the Kernel&#x27;s implementation.</span></span><br><span class="line">  <span class="type">bool</span> parallelizable = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// \brief Indicates the level of SIMD instruction support in the host CPU is</span></span><br><span class="line">  <span class="comment">/// required to use the function. The intention is for functions to be able to</span></span><br><span class="line">  <span class="comment">/// contain multiple kernels with the same signature but different levels of SIMD,</span></span><br><span class="line">  <span class="comment">/// so that the most optimized kernel supported on a host&#x27;s processor can be chosen.</span></span><br><span class="line">  SimdLevel::type simd_level = SimdLevel::NONE;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Additional kernel-specific data</span></span><br><span class="line">  std::shared_ptr&lt;KernelState&gt; data;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ä¸¾ä¾‹å­æ˜¯ <code>Add</code> è¿™ä¸ª Binary çš„ Scalar Function:</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">auto</span> add = <span class="built_in">MakeArithmeticFunction</span>&lt;Add&gt;(<span class="string">&quot;add&quot;</span>, add_doc);</span><br><span class="line"><span class="built_in">AddDecimalBinaryKernels</span>&lt;Add&gt;(<span class="string">&quot;add&quot;</span>, add.<span class="built_in">get</span>());</span><br></pre></td></tr></table></figure><p>è¿™é‡Œè°ƒäº†å¯¹åº”çš„ KernelGeneratorï¼Œè¿™é‡Œå†™äº†ä¸€å¥—æ¨¡ç‰ˆä»£ç ï¼Œæˆ‘è§‰å¾—è°ƒç”¨èµ·æ¥æŒºæ–¹ä¾¿ï¼Œè¯»èµ·æ¥æ„Ÿè§‰çœŸçš„æœ‰ç‚¹ç‚¹éš¾ï¼Œé¦–å…ˆè¿™é‡Œæœ‰ <code>Add</code> å’Œ Checked ç‰ˆæœ¬çš„ Addï¼Œä»–ä»¬æä¾›æ˜¯å¦æ£€æŸ¥çš„ä»£ç ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">Add</span> &#123;</span><br><span class="line">  <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T, <span class="keyword">typename</span> Arg0, <span class="keyword">typename</span> Arg1&gt;</span><br><span class="line">  <span class="function"><span class="type">static</span> <span class="keyword">constexpr</span> enable_if_floating_value&lt;T&gt; <span class="title">Call</span><span class="params">(KernelContext*, Arg0 left, Arg1 right,</span></span></span><br><span class="line"><span class="params"><span class="function">                                                    Status*)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> left + right;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T, <span class="keyword">typename</span> Arg0, <span class="keyword">typename</span> Arg1&gt;</span><br><span class="line">  <span class="function"><span class="type">static</span> <span class="keyword">constexpr</span> enable_if_unsigned_integer_value&lt;T&gt; <span class="title">Call</span><span class="params">(KernelContext*, Arg0 left,</span></span></span><br><span class="line"><span class="params"><span class="function">                                                            Arg1 right, Status*)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> left + right;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T, <span class="keyword">typename</span> Arg0, <span class="keyword">typename</span> Arg1&gt;</span><br><span class="line">  <span class="function"><span class="type">static</span> <span class="keyword">constexpr</span> enable_if_signed_integer_value&lt;T&gt; <span class="title">Call</span><span class="params">(KernelContext*, Arg0 left,</span></span></span><br><span class="line"><span class="params"><span class="function">                                                          Arg1 right, Status*)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> arrow::internal::<span class="built_in">SafeSignedAdd</span>(left, right);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T, <span class="keyword">typename</span> Arg0, <span class="keyword">typename</span> Arg1&gt;</span><br><span class="line">  <span class="function"><span class="type">static</span> enable_if_decimal_value&lt;T&gt; <span class="title">Call</span><span class="params">(KernelContext*, Arg0 left, Arg1 right, Status*)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> left + right;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">AddChecked</span> &#123;</span><br><span class="line">  <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T, <span class="keyword">typename</span> Arg0, <span class="keyword">typename</span> Arg1&gt;</span><br><span class="line">  <span class="function"><span class="type">static</span> enable_if_integer_value&lt;T&gt; <span class="title">Call</span><span class="params">(KernelContext*, Arg0 left, Arg1 right,</span></span></span><br><span class="line"><span class="params"><span class="function">                                         Status* st)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">static_assert</span>(std::is_same&lt;T, Arg0&gt;::value &amp;&amp; std::is_same&lt;T, Arg1&gt;::value, <span class="string">&quot;&quot;</span>);</span><br><span class="line">    T result = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">ARROW_PREDICT_FALSE</span>(<span class="built_in">AddWithOverflow</span>(left, right, &amp;result))) &#123;</span><br><span class="line">      *st = Status::<span class="built_in">Invalid</span>(<span class="string">&quot;overflow&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T, <span class="keyword">typename</span> Arg0, <span class="keyword">typename</span> Arg1&gt;</span><br><span class="line">  <span class="function"><span class="type">static</span> enable_if_floating_value&lt;T&gt; <span class="title">Call</span><span class="params">(KernelContext*, Arg0 left, Arg1 right,</span></span></span><br><span class="line"><span class="params"><span class="function">                                          Status*)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">static_assert</span>(std::is_same&lt;T, Arg0&gt;::value &amp;&amp; std::is_same&lt;T, Arg1&gt;::value, <span class="string">&quot;&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> left + right;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T, <span class="keyword">typename</span> Arg0, <span class="keyword">typename</span> Arg1&gt;</span><br><span class="line">  <span class="function"><span class="type">static</span> enable_if_decimal_value&lt;T&gt; <span class="title">Call</span><span class="params">(KernelContext*, Arg0 left, Arg1 right, Status*)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> left + right;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>æœ‰ä¸€ä¸ªåœ°æ–¹éœ€è¦æ³¨æ„ä¸€ä¸‹ï¼Œè™½ç„¶ Arrow å¯èƒ½ä¼šåœ¨è°ƒç”¨çš„æ—¶å€™åˆ¤æ–­ï¼Œå¦‚æœè¾“å…¥ï¼ˆæœ‰ä¸€ä¸ªï¼‰æ˜¯ NULLï¼Œé‚£ä¹ˆè¾“å‡º NULLã€‚ä½†æ˜¯ Add çš„æ—¶å€™ï¼Œé’ˆå¯¹ Null ä¸Š Undefined çš„åœ°æ–¹åšåŠ æ³•å¼€é”€ä¹Ÿä¸å¤§ã€‚æˆ‘ä»¬è¿™é‡Œçœ‹ <code>MakeArithmeticFunction&lt;Add&gt;(&quot;add&quot;, add_doc)</code>:</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è¿™é‡Œè¿˜å¡äº†ä¸€ä¸ª FunctionDoc è¿›å»</span></span><br><span class="line"><span class="type">const</span> FunctionDoc add_doc&#123;<span class="string">&quot;Add the arguments element-wise&quot;</span>,</span><br><span class="line">                          (<span class="string">&quot;Results will wrap around on integer overflow.\n&quot;</span></span><br><span class="line">                           <span class="string">&quot;Use function \&quot;add_checked\&quot; if you want overflow\n&quot;</span></span><br><span class="line">                           <span class="string">&quot;to return an error.&quot;</span>),</span><br><span class="line">                          &#123;<span class="string">&quot;x&quot;</span>, <span class="string">&quot;y&quot;</span>&#125;&#125;;</span><br></pre></td></tr></table></figure><p>ç„¶åå’Œï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> Op, <span class="keyword">typename</span> FunctionImpl = ArithmeticFunction&gt;</span><br><span class="line">std::shared_ptr&lt;ScalarFunction&gt; <span class="built_in">MakeArithmeticFunction</span>(std::string name,</span><br><span class="line">                                                       FunctionDoc doc) &#123;</span><br><span class="line">  <span class="keyword">auto</span> func = std::<span class="built_in">make_shared</span>&lt;FunctionImpl&gt;(name, Arity::<span class="built_in">Binary</span>(), std::<span class="built_in">move</span>(doc));</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">const</span> <span class="keyword">auto</span>&amp; ty : <span class="built_in">NumericTypes</span>()) &#123;</span><br><span class="line">    <span class="keyword">auto</span> exec = <span class="built_in">ArithmeticExecFromOp</span>&lt;ScalarBinaryEqualTypes, Op&gt;(ty);</span><br><span class="line">    <span class="built_in">DCHECK_OK</span>(func-&gt;<span class="built_in">AddKernel</span>(&#123;ty, ty&#125;, ty, exec));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">AddNullExec</span>(func.<span class="built_in">get</span>());</span><br><span class="line">  <span class="keyword">return</span> func;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œ <code>NumericTypes</code> åŒ…å«ä»€ä¹ˆå‘¢ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Numeric types</span></span><br><span class="line"><span class="built_in">Extend</span>(g_int_types, &amp;g_numeric_types);</span><br><span class="line"><span class="built_in">Extend</span>(g_floating_types, &amp;g_numeric_types);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Non-parametric, non-nested types. This also DOES NOT include</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// * Decimal</span></span><br><span class="line"><span class="comment">// * Fixed Size Binary</span></span><br><span class="line"><span class="comment">// * Time32</span></span><br><span class="line"><span class="comment">// * Time64</span></span><br><span class="line"><span class="comment">// * Timestamp</span></span><br><span class="line">g_primitive_types = &#123;<span class="built_in">null</span>(), <span class="built_in">boolean</span>(), <span class="built_in">date32</span>(), <span class="built_in">date64</span>()&#125;;</span><br><span class="line"><span class="built_in">Extend</span>(g_numeric_types, &amp;g_primitive_types);</span><br></pre></td></tr></table></figure><p>ç„¶åè°ƒç”¨ <code>ArithmeticExecFromOp&lt;ScalarBinaryEqualTypes, Op&gt;(ty)</code> äº§ç”Ÿ <code>ArrayKernelExec</code>, <code>ArithmeticExecFromOp</code> ä¼šä½¿ç”¨ <code>ScalarBinaryEqualTypes</code> è¿™ä¸ª Generator æ¥æŠŠåŠ¨æ€çš„è°ƒç”¨åˆ†å‘åˆ°é™æ€æ¨¡ç‰ˆä¸Š:</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> ArrayKernelExec = <span class="built_in">Status</span> (*)(KernelContext*, <span class="type">const</span> ExecSpan&amp;, ExecResult*);</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">template</span> &lt;<span class="keyword">typename</span>...&gt; <span class="keyword">class</span> <span class="title class_">KernelGenerator</span>, <span class="keyword">typename</span> Op,</span><br><span class="line">          <span class="keyword">typename</span> KernelType = ArrayKernelExec, <span class="keyword">typename</span>... Args&gt;</span><br><span class="line">KernelType <span class="built_in">ArithmeticExecFromOp</span>(detail::GetTypeId get_id) &#123;</span><br><span class="line">  <span class="keyword">switch</span> (get_id.id) &#123;</span><br><span class="line">    <span class="keyword">case</span> Type::INT8:</span><br><span class="line">      <span class="keyword">return</span> KernelGenerator&lt;Int8Type, Int8Type, Op, Args...&gt;::Exec;</span><br><span class="line">    <span class="keyword">case</span> Type::UINT8:</span><br><span class="line">      <span class="keyword">return</span> KernelGenerator&lt;UInt8Type, UInt8Type, Op, Args...&gt;::Exec;</span><br><span class="line">    <span class="keyword">case</span> Type::INT16:</span><br><span class="line">      <span class="keyword">return</span> KernelGenerator&lt;Int16Type, Int16Type, Op, Args...&gt;::Exec;</span><br><span class="line">    <span class="keyword">case</span> Type::UINT16:</span><br><span class="line">      <span class="keyword">return</span> KernelGenerator&lt;UInt16Type, UInt16Type, Op, Args...&gt;::Exec;</span><br><span class="line">    <span class="keyword">case</span> Type::INT32:</span><br><span class="line">      <span class="keyword">return</span> KernelGenerator&lt;Int32Type, Int32Type, Op, Args...&gt;::Exec;</span><br><span class="line">    <span class="keyword">case</span> Type::UINT32:</span><br><span class="line">      <span class="keyword">return</span> KernelGenerator&lt;UInt32Type, UInt32Type, Op, Args...&gt;::Exec;</span><br><span class="line">    <span class="keyword">case</span> Type::DURATION:</span><br><span class="line">    <span class="keyword">case</span> Type::INT64:</span><br><span class="line">    <span class="keyword">case</span> Type::TIMESTAMP:</span><br><span class="line">      <span class="keyword">return</span> KernelGenerator&lt;Int64Type, Int64Type, Op, Args...&gt;::Exec;</span><br><span class="line">    <span class="keyword">case</span> Type::UINT64:</span><br><span class="line">      <span class="keyword">return</span> KernelGenerator&lt;UInt64Type, UInt64Type, Op, Args...&gt;::Exec;</span><br><span class="line">    <span class="keyword">case</span> Type::FLOAT:</span><br><span class="line">      <span class="keyword">return</span> KernelGenerator&lt;FloatType, FloatType, Op, Args...&gt;::Exec;</span><br><span class="line">    <span class="keyword">case</span> Type::DOUBLE:</span><br><span class="line">      <span class="keyword">return</span> KernelGenerator&lt;DoubleType, DoubleType, Op, Args...&gt;::Exec;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="built_in">DCHECK</span>(<span class="literal">false</span>);</span><br><span class="line">      <span class="keyword">return</span> FailFunctor&lt;KernelType&gt;::Exec;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ Generator:</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// A kernel exec generator for binary kernels where both input types are the</span></span><br><span class="line"><span class="comment">// same</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> OutType, <span class="keyword">typename</span> ArgType, <span class="keyword">typename</span> Op&gt;</span><br><span class="line"><span class="keyword">using</span> ScalarBinaryEqualTypes = ScalarBinary&lt;OutType, ArgType, ArgType, Op&gt;;</span><br></pre></td></tr></table></figure><p>é‡Œé¢æ˜¯ï¼š</p><ol><li>æŠŠè¾“å…¥è¾“å‡ºçš„ Array ç”¨æ³›å‹æŠ½äº†è¿­ä»£å™¨å‡ºæ¥</li><li>æ ¹æ® <code>Op::Call</code> æ¥è°ƒç”¨</li><li>æ ¹æ®ä¸€ä¸ªæ³›å‹ Writer æ¥æŠ½å‡ºè¾“å‡ºï¼Œå†™è¾“å‡ºçš„æ•°æ®</li></ol><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// A kernel exec generator for binary functions that addresses both array and</span></span><br><span class="line"><span class="comment">// scalar inputs and dispatches input iteration and output writing to other</span></span><br><span class="line"><span class="comment">// templates</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// This template executes the operator even on the data behind null values,</span></span><br><span class="line"><span class="comment">// therefore it is generally only suitable for operators that are safe to apply</span></span><br><span class="line"><span class="comment">// even on the null slot values.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// The &quot;Op&quot; functor should have the form</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// struct Op &#123;</span></span><br><span class="line"><span class="comment">//   template &lt;typename OutValue, typename Arg0Value, typename Arg1Value&gt;</span></span><br><span class="line"><span class="comment">//   static OutValue Call(KernelContext* ctx, Arg0Value arg0, Arg1Value arg1, Status* st)</span></span><br><span class="line"><span class="comment">//   &#123;</span></span><br><span class="line"><span class="comment">//     // implementation</span></span><br><span class="line"><span class="comment">//     // <span class="doctag">NOTE:</span> &quot;status&quot; should only populated with errors,</span></span><br><span class="line"><span class="comment">//     //       leave it unmodified to indicate Status::OK()</span></span><br><span class="line"><span class="comment">//   &#125;</span></span><br><span class="line"><span class="comment">// &#125;;</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> OutType, <span class="keyword">typename</span> Arg0Type, <span class="keyword">typename</span> Arg1Type, <span class="keyword">typename</span> Op&gt;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">ScalarBinary</span> &#123;</span><br><span class="line">  <span class="keyword">using</span> OutValue = <span class="keyword">typename</span> GetOutputType&lt;OutType&gt;::T;</span><br><span class="line">  <span class="keyword">using</span> Arg0Value = <span class="keyword">typename</span> GetViewType&lt;Arg0Type&gt;::T;</span><br><span class="line">  <span class="keyword">using</span> Arg1Value = <span class="keyword">typename</span> GetViewType&lt;Arg1Type&gt;::T;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="type">static</span> Status <span class="title">ArrayArray</span><span class="params">(KernelContext* ctx, <span class="type">const</span> ArraySpan&amp; arg0,</span></span></span><br><span class="line"><span class="params"><span class="function">                           <span class="type">const</span> ArraySpan&amp; arg1, ExecResult* out)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="type">static</span> Status <span class="title">ArrayScalar</span><span class="params">(KernelContext* ctx, <span class="type">const</span> ArraySpan&amp; arg0, <span class="type">const</span> Scalar&amp; arg1,</span></span></span><br><span class="line"><span class="params"><span class="function">                            ExecResult* out)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="type">static</span> Status <span class="title">ScalarArray</span><span class="params">(KernelContext* ctx, <span class="type">const</span> Scalar&amp; arg0, <span class="type">const</span> ArraySpan&amp; arg1,</span></span></span><br><span class="line"><span class="params"><span class="function">                            ExecResult* out)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="type">static</span> Status <span class="title">Exec</span><span class="params">(KernelContext* ctx, <span class="type">const</span> ExecSpan&amp; batch, ExecResult* out)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (batch[<span class="number">0</span>].<span class="built_in">is_array</span>()) &#123;</span><br><span class="line">      <span class="keyword">if</span> (batch[<span class="number">1</span>].<span class="built_in">is_array</span>()) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">ArrayArray</span>(ctx, batch[<span class="number">0</span>].array, batch[<span class="number">1</span>].array, out);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">ArrayScalar</span>(ctx, batch[<span class="number">0</span>].array, *batch[<span class="number">1</span>].scalar, out);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (batch[<span class="number">1</span>].<span class="built_in">is_array</span>()) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">ScalarArray</span>(ctx, *batch[<span class="number">0</span>].scalar, batch[<span class="number">1</span>].array, out);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">DCHECK</span>(<span class="literal">false</span>);</span><br><span class="line">        <span class="keyword">return</span> Status::<span class="built_in">Invalid</span>(<span class="string">&quot;Should be unreachable&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>æœ€åè°ƒç”¨ <code>func-&gt;AddKernel(/*è¾“å…¥ç±»å‹*/&#123;ty, ty&#125;, /*è¾“å‡ºç±»å‹*/ty, ``/*æ‰§è¡Œcallback*/``exec)</code> æ¥æ·»åŠ æ‰§è¡Œçš„ Kernelã€‚</p><p>è¿™é‡Œæˆ‘ä»¬å†å›è¿‡å¤´çœ‹çœ‹é‚£ä¸ªé—®é¢˜ï¼ŒKernel æ˜¯ä»€ä¹ˆï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">Kernel</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// \brief Arguments to pass to an KernelInit function. A struct is used to help</span></span><br><span class="line"><span class="comment">/// avoid API breakage should the arguments passed need to be expanded.</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">KernelInitArgs</span> &#123;</span><br><span class="line">  <span class="comment">/// \brief A pointer to the kernel being initialized. The init function may</span></span><br><span class="line">  <span class="comment">/// depend on the kernel&#x27;s KernelSignature or other data contained there.</span></span><br><span class="line">  <span class="type">const</span> Kernel* kernel;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// \brief The types of the input arguments that the kernel is</span></span><br><span class="line">  <span class="comment">/// about to be executed against.</span></span><br><span class="line">  <span class="type">const</span> std::vector&lt;TypeHolder&gt;&amp; inputs;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// \brief Opaque options specific to this kernel. May be nullptr for functions</span></span><br><span class="line">  <span class="comment">/// that do not require options.</span></span><br><span class="line">  <span class="type">const</span> FunctionOptions* options;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// \brief Common initializer function for all kernel types.</span></span><br><span class="line"><span class="keyword">using</span> KernelInit = std::function&lt;Result&lt;std::unique_ptr&lt;KernelState&gt;&gt;(</span><br><span class="line">    KernelContext*, <span class="type">const</span> KernelInitArgs&amp;)&gt;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// \brief Base type for kernels. Contains the function signature and</span></span><br><span class="line"><span class="comment">/// optionally the state initialization function, along with some common</span></span><br><span class="line"><span class="comment">/// attributes</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">ARROW_EXPORT</span> Kernel &#123;</span><br><span class="line">  <span class="built_in">Kernel</span>() = <span class="keyword">default</span>;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">Kernel</span>(std::shared_ptr&lt;KernelSignature&gt; sig, KernelInit init)</span><br><span class="line">      : <span class="built_in">signature</span>(std::<span class="built_in">move</span>(sig)), <span class="built_in">init</span>(std::<span class="built_in">move</span>(init)) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">Kernel</span>(std::vector&lt;InputType&gt; in_types, OutputType out_type, KernelInit init)</span><br><span class="line">      : <span class="built_in">Kernel</span>(KernelSignature::<span class="built_in">Make</span>(std::<span class="built_in">move</span>(in_types), std::<span class="built_in">move</span>(out_type)),</span><br><span class="line">               std::<span class="built_in">move</span>(init)) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// \brief The &quot;signature&quot; of the kernel containing the InputType input</span></span><br><span class="line">  <span class="comment">/// argument validators and OutputType output type resolver.</span></span><br><span class="line">  std::shared_ptr&lt;KernelSignature&gt; signature;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// \brief Create a new KernelState for invocations of this kernel, e.g. to</span></span><br><span class="line">  <span class="comment">/// set up any options or state relevant for execution.</span></span><br><span class="line">  KernelInit init;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// \brief Create a vector of new KernelState for invocations of this kernel.</span></span><br><span class="line">  <span class="function"><span class="type">static</span> Status <span class="title">InitAll</span><span class="params">(KernelContext*, <span class="type">const</span> KernelInitArgs&amp;,</span></span></span><br><span class="line"><span class="params"><span class="function">                        std::vector&lt;std::unique_ptr&lt;KernelState&gt;&gt;*)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="type">bool</span> parallelizable = <span class="literal">true</span>;</span><br><span class="line">  SimdLevel::type simd_level = SimdLevel::NONE;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Additional kernel-specific data</span></span><br><span class="line">  std::shared_ptr&lt;KernelState&gt; data;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>Kernel æœ¬èº«æ˜¯ä¸€ç»„å¥‡æ€ªçš„ apiï¼ŒåŒ…å« <code>KernelState</code>, å¤–éƒ¨æ ¹æ®<code>KernelSignature</code> å’Œ <code>KernelInit</code>æ¥è°ƒç”¨å®ƒï¼Œæˆ‘ä»¬æ¥çœ‹ <code>ScalarKernel</code>:</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> ArrayKernelExec = <span class="built_in">Status</span> (*)(KernelContext*, <span class="type">const</span> ExecSpan&amp;, ExecResult*);</span><br><span class="line"></span><br><span class="line"><span class="comment">/// \brief Kernel data structure for implementations of ScalarFunction. In</span></span><br><span class="line"><span class="comment">/// addition to the members found in Kernel, contains the null handling</span></span><br><span class="line"><span class="comment">/// and memory pre-allocation preferences.</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">ARROW_EXPORT</span> ScalarKernel : <span class="keyword">public</span> Kernel &#123;</span><br><span class="line">  <span class="built_in">ScalarKernel</span>() = <span class="keyword">default</span>;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">ScalarKernel</span>(std::shared_ptr&lt;KernelSignature&gt; sig, ArrayKernelExec exec,</span><br><span class="line">               KernelInit init = NULLPTR)</span><br><span class="line">      : <span class="built_in">Kernel</span>(std::<span class="built_in">move</span>(sig), init), <span class="built_in">exec</span>(exec) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">ScalarKernel</span>(std::vector&lt;InputType&gt; in_types, OutputType out_type, ArrayKernelExec exec,</span><br><span class="line">               KernelInit init = NULLPTR)</span><br><span class="line">      : <span class="built_in">Kernel</span>(std::<span class="built_in">move</span>(in_types), std::<span class="built_in">move</span>(out_type), std::<span class="built_in">move</span>(init)), <span class="built_in">exec</span>(exec) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// \brief Perform a single invocation of this kernel. Depending on the</span></span><br><span class="line">  <span class="comment">/// implementation, it may only write into preallocated memory, while in some</span></span><br><span class="line">  <span class="comment">/// cases it will allocate its own memory. Any required state is managed</span></span><br><span class="line">  <span class="comment">/// through the KernelContext.</span></span><br><span class="line">  ArrayKernelExec exec;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// \brief Writing execution results into larger contiguous allocations</span></span><br><span class="line">  <span class="comment">/// requires that the kernel be able to write into sliced output ArrayData*,</span></span><br><span class="line">  <span class="comment">/// including sliced output validity bitmaps. Some kernel implementations may</span></span><br><span class="line">  <span class="comment">/// not be able to do this, so setting this to false disables this</span></span><br><span class="line">  <span class="comment">/// functionality.</span></span><br><span class="line">  <span class="type">bool</span> can_write_into_slices = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// For scalar functions preallocated data and intersecting arg validity</span></span><br><span class="line">  <span class="comment">// bitmaps is a reasonable default</span></span><br><span class="line">  NullHandling::type null_handling = NullHandling::INTERSECTION;</span><br><span class="line">  MemAllocation::type mem_allocation = MemAllocation::PREALLOCATE;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæ¯”è¾ƒå…³é”®çš„æ˜¯è¿™ä¸ª Execï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹æ‰§è¡Œä¾§ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ARROW_EXPORT</span> KernelExecutor &#123;</span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="keyword">virtual</span> ~<span class="built_in">KernelExecutor</span>() = <span class="keyword">default</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// The Kernel&#x27;s `init` method must be called and any KernelState set in the</span></span><br><span class="line">  <span class="comment">/// KernelContext *before* KernelExecutor::Init is called. This is to facilitate</span></span><br><span class="line">  <span class="comment">/// the case where init may be expensive and does not need to be called again for</span></span><br><span class="line">  <span class="comment">/// each execution of the kernel, for example the same lookup table can be re-used</span></span><br><span class="line">  <span class="comment">/// for all scanned batches in a dataset filter.</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> Status <span class="title">Init</span><span class="params">(KernelContext*, KernelInitArgs)</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// TODO(wesm): per ARROW-16819, adding ExecBatch variant so that a batch</span></span><br><span class="line">  <span class="comment">// length can be passed in for scalar functions; will have to return and</span></span><br><span class="line">  <span class="comment">// clean a bunch of things up</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> Status <span class="title">Execute</span><span class="params">(<span class="type">const</span> ExecBatch&amp; batch, ExecListener* listener)</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> Datum <span class="title">WrapResults</span><span class="params">(<span class="type">const</span> std::vector&lt;Datum&gt;&amp; args,</span></span></span><br><span class="line"><span class="params"><span class="function">                            <span class="type">const</span> std::vector&lt;Datum&gt;&amp; outputs)</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// \brief Check the actual result type against the resolved output type</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> Status <span class="title">CheckResultType</span><span class="params">(<span class="type">const</span> Datum&amp; out, <span class="type">const</span> <span class="type">char</span>* function_name)</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="type">static</span> std::unique_ptr&lt;KernelExecutor&gt; <span class="title">MakeScalar</span><span class="params">()</span></span>;</span><br><span class="line">  <span class="function"><span class="type">static</span> std::unique_ptr&lt;KernelExecutor&gt; <span class="title">MakeVector</span><span class="params">()</span></span>;</span><br><span class="line">  <span class="function"><span class="type">static</span> std::unique_ptr&lt;KernelExecutor&gt; <span class="title">MakeScalarAggregate</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>æœ€ç»ˆï¼Œ<code>ScalarExecutor::Execute</code> ä¼šæ‰§è¡Œé‚£ä¸ª <code>exec</code>ï¼Œæ¥å¤„ç†å¯¹åº”çš„é€»è¾‘:</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Status <span class="title">ExecuteNonSpans</span><span class="params">(ExecListener* listener)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// ARROW-16756: Kernel is going to allocate some memory and so</span></span><br><span class="line">  <span class="comment">// for the time being we pass in an empty or partially-filled</span></span><br><span class="line">  <span class="comment">// shared_ptr&lt;ArrayData&gt; or shared_ptr&lt;Scalar&gt; to be populated</span></span><br><span class="line">  <span class="comment">// by the kernel.</span></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  <span class="comment">// We will eventually delete the Scalar output path per</span></span><br><span class="line">  <span class="comment">// ARROW-16757.</span></span><br><span class="line">  ExecSpan input;</span><br><span class="line">  ExecResult output;</span><br><span class="line">  <span class="keyword">while</span> (span_iterator_.<span class="built_in">Next</span>(&amp;input)) &#123;</span><br><span class="line">    <span class="built_in">ARROW_ASSIGN_OR_RAISE</span>(output.value, <span class="built_in">PrepareOutput</span>(input.length));</span><br><span class="line">    <span class="built_in">DCHECK</span>(output.<span class="built_in">is_array_data</span>());</span><br><span class="line"></span><br><span class="line">    ArrayData* out_arr = output.<span class="built_in">array_data</span>().<span class="built_in">get</span>();</span><br><span class="line">    <span class="keyword">if</span> (output_type_.type-&gt;<span class="built_in">id</span>() == Type::NA) &#123;</span><br><span class="line">      out_arr-&gt;null_count = out_arr-&gt;length;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (kernel_-&gt;null_handling == NullHandling::INTERSECTION) &#123;</span><br><span class="line">      <span class="built_in">RETURN_NOT_OK</span>(<span class="built_in">PropagateNulls</span>(kernel_ctx_, input, out_arr));</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (kernel_-&gt;null_handling == NullHandling::OUTPUT_NOT_NULL) &#123;</span><br><span class="line">      out_arr-&gt;null_count = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">RETURN_NOT_OK</span>(kernel_-&gt;<span class="built_in">exec</span>(kernel_ctx_, input, &amp;output));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Output type didn&#x27;t change</span></span><br><span class="line">    <span class="built_in">DCHECK</span>(output.<span class="built_in">is_array_data</span>());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Emit a result for each chunk</span></span><br><span class="line">    <span class="built_in">RETURN_NOT_OK</span>(<span class="built_in">EmitResult</span>(std::<span class="built_in">move</span>(output.<span class="built_in">array_data</span>()), listener));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> Status::<span class="built_in">OK</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="Kernel-çš„ç±»å‹åŒ¹é…"><a href="#Kernel-çš„ç±»å‹åŒ¹é…" class="headerlink" title="Kernel çš„ç±»å‹åŒ¹é…"></a>Kernel çš„ç±»å‹åŒ¹é…</h4><p>è¿˜æœ‰ä¸€ä¸ªæ¯”è¾ƒé‡è¦çš„æ˜¯ Kernel å‡½æ•°çš„ç±»å‹åŒ¹é…ï¼Œè¿™é‡Œä¼šæ ¹æ® <code>Matches</code> æ¥æŒ‘é€‰å¯¹åº”çš„ç±»å‹æ¥è¿›è¡ŒåŒ¹é…ã€‚æˆ‘ä»¬å›åˆ° <code>ExecuteInternal</code>:</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Result&lt;Datum&gt; <span class="title">ExecuteInternal</span><span class="params">(<span class="type">const</span> Function&amp; func, std::vector&lt;Datum&gt; args,</span></span></span><br><span class="line"><span class="params"><span class="function">                              <span class="type">int64_t</span> passed_length, <span class="type">const</span> FunctionOptions* options,</span></span></span><br><span class="line"><span class="params"><span class="function">                              ExecContext* ctx)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">ARROW_ASSIGN_OR_RAISE</span>(<span class="keyword">auto</span> inputs, internal::<span class="built_in">GetFunctionArgumentTypes</span>(args));</span><br><span class="line">  <span class="built_in">ARROW_ASSIGN_OR_RAISE</span>(<span class="keyword">auto</span> func_exec, func.<span class="built_in">GetBestExecutor</span>(inputs));</span><br><span class="line">  <span class="built_in">ARROW_RETURN_NOT_OK</span>(func_exec-&gt;<span class="built_in">Init</span>(options, ctx));</span><br><span class="line">  <span class="keyword">return</span> func_exec-&gt;<span class="built_in">Execute</span>(args, passed_length);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä¼š:</p><ol><li><code>GetBestExecutor</code>ï¼Œæ ¹æ® <code>Function::DispatchBest</code> æ¥æ‰¾åˆ°å¯¹åº”çš„ <code>Kernel</code>ï¼Œç„¶ååˆ›å»º <code>FunctionExecutor</code>. <code>Dispatch</code> é»˜è®¤èµ°çš„æ˜¯ <code>DispatchExact</code>ï¼Œå°±æ˜¯æ‰¾åˆ°å®Œå…¨å¯¹åº”çš„è¾“å…¥ã€‚æœ‰çš„æ—¶å€™æ ¹æ®éœ€æ±‚ä¸åŒï¼Œå¯èƒ½ä¼šæ’å…¥ä¸€äº› <code>Cast</code></li><li>åœ¨ <code>func_exec-&gt;Init</code> é˜¶æ®µï¼Œå» Init éœ€è¦çš„å†…å®¹</li><li>è°ƒç”¨ <code>func_exec-&gt;Execute</code></li></ol><p>Dispatch çš„ç­¾åå¦‚ä¸‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// \brief Return a best-match kernel that can execute the function given the argument</span></span><br><span class="line"><span class="comment">/// types, after implicit casts are applied.</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// \param[in,out] values Argument types. An element may be modified to</span></span><br><span class="line"><span class="comment">/// indicate that the returned kernel only approximately matches the input</span></span><br><span class="line"><span class="comment">/// value descriptors; callers are responsible for casting inputs to the type</span></span><br><span class="line"><span class="comment">/// required by the kernel.</span></span><br><span class="line"><span class="function"><span class="keyword">virtual</span> Result&lt;<span class="type">const</span> Kernel*&gt; <span class="title">DispatchBest</span><span class="params">(std::vector&lt;TypeHolder&gt;* values)</span> <span class="type">const</span></span>;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å†ä»¥ Add ä¸ºä¾‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">ArithmeticFunction</span> : ScalarFunction &#123;</span><br><span class="line">  <span class="keyword">using</span> ScalarFunction::ScalarFunction;</span><br><span class="line"></span><br><span class="line">  <span class="function">Result&lt;<span class="type">const</span> Kernel*&gt; <span class="title">DispatchBest</span><span class="params">(std::vector&lt;TypeHolder&gt;* types)</span> <span class="type">const</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">    <span class="built_in">RETURN_NOT_OK</span>(<span class="built_in">CheckArity</span>(types-&gt;<span class="built_in">size</span>()));</span><br><span class="line"></span><br><span class="line">    <span class="built_in">RETURN_NOT_OK</span>(<span class="built_in">CheckDecimals</span>(types));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">using</span> arrow::compute::detail::DispatchExactImpl;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">auto</span> kernel = <span class="built_in">DispatchExactImpl</span>(<span class="keyword">this</span>, *types)) <span class="keyword">return</span> kernel;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">EnsureDictionaryDecoded</span>(types);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Only promote types for binary functions</span></span><br><span class="line">    <span class="keyword">if</span> (types-&gt;<span class="built_in">size</span>() == <span class="number">2</span>) &#123;</span><br><span class="line">      <span class="built_in">ReplaceNullWithOtherType</span>(types);</span><br><span class="line">      TimeUnit::type finest_unit;</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">CommonTemporalResolution</span>(types-&gt;<span class="built_in">data</span>(), types-&gt;<span class="built_in">size</span>(), &amp;finest_unit)) &#123;</span><br><span class="line">        <span class="built_in">ReplaceTemporalTypes</span>(finest_unit, types);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (TypeHolder type = <span class="built_in">CommonNumeric</span>(*types)) &#123;</span><br><span class="line">          <span class="built_in">ReplaceTypes</span>(type, types);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">auto</span> kernel = <span class="built_in">DispatchExactImpl</span>(<span class="keyword">this</span>, *types)) <span class="keyword">return</span> kernel;</span><br><span class="line">    <span class="keyword">return</span> arrow::compute::detail::<span class="built_in">NoMatchingKernel</span>(<span class="keyword">this</span>, *types);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªåœ°æ–¹å°±æ˜¯åˆ›å»ºæ‰€æœ‰éœ€è¦çš„ä¸Šä¸‹æ–‡ï¼Œ<code>Kernel</code> çš„æŒ‘é€‰æ¥è‡ªäº</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// \brief An type-checking interface to permit customizable validation rules</span></span><br><span class="line"><span class="comment">/// for use with InputType and KernelSignature. This is for scenarios where the</span></span><br><span class="line"><span class="comment">/// acceptance is not an exact type instance, such as a TIMESTAMP type for a</span></span><br><span class="line"><span class="comment">/// specific TimeUnit, but permitting any time zone.</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">ARROW_EXPORT</span> TypeMatcher &#123;</span><br><span class="line">  <span class="keyword">virtual</span> ~<span class="built_in">TypeMatcher</span>() = <span class="keyword">default</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// \brief Return true if this matcher accepts the data type.</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="type">bool</span> <span class="title">Matches</span><span class="params">(<span class="type">const</span> DataType&amp; type)</span> <span class="type">const</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// \brief A human-interpretable string representation of what the type</span></span><br><span class="line">  <span class="comment">/// matcher checks for, usable when printing KernelSignature or formatting</span></span><br><span class="line">  <span class="comment">/// error messages.</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> std::string <span class="title">ToString</span><span class="params">()</span> <span class="type">const</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// \brief Return true if this TypeMatcher contains the same matching rule as</span></span><br><span class="line">  <span class="comment">/// the other. Currently depends on RTTI.</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="type">bool</span> <span class="title">Equals</span><span class="params">(<span class="type">const</span> TypeMatcher&amp; other)</span> <span class="type">const</span> </span>= <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä¹Ÿå…è®¸ <code>Output</code> è®¡ç®—å‡ºå¯¹åº”çš„è¾“å‡ºç±»å‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// \brief Container to capture both exact and input-dependent output types.</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ARROW_EXPORT</span> OutputType &#123;</span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="comment">/// \brief An enum indicating whether the value type is an invariant fixed</span></span><br><span class="line">  <span class="comment">/// value or one that&#x27;s computed by a kernel-defined resolver function.</span></span><br><span class="line">  <span class="keyword">enum</span> <span class="title class_">ResolveKind</span> &#123; FIXED, COMPUTED &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// Type resolution function. Given input types, return output type.  This</span></span><br><span class="line">  <span class="comment">/// function MAY may use the kernel state to decide the output type based on</span></span><br><span class="line">  <span class="comment">/// the FunctionOptions.</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// This function SHOULD _not_ be used to check for arity, that is to be</span></span><br><span class="line">  <span class="comment">/// performed one or more layers above.</span></span><br><span class="line">  <span class="keyword">using</span> Resolver = <span class="built_in">Result</span>&lt;TypeHolder&gt; (*)(KernelContext*, <span class="type">const</span> std::vector&lt;TypeHolder&gt;&amp;);</span><br></pre></td></tr></table></figure><p>åœ¨ Init çš„æ—¶å€™é€»è¾‘å¦‚ä¸‹. è¿™é‡Œ <code>Add</code> å¯¹åº”çš„ä¸Šä¸‹æ–‡ä¸å¤ªå¤šã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Status <span class="title">KernelInit</span><span class="params">(<span class="type">const</span> FunctionOptions* options)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">RETURN_NOT_OK</span>(<span class="built_in">CheckOptions</span>(func, options));</span><br><span class="line">  <span class="keyword">if</span> (options == NULLPTR) &#123;</span><br><span class="line">    options = func.<span class="built_in">default_options</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (kernel-&gt;init) &#123;</span><br><span class="line">    <span class="built_in">ARROW_ASSIGN_OR_RAISE</span>(state,</span><br><span class="line">                          kernel-&gt;<span class="built_in">init</span>(&amp;kernel_ctx, &#123;kernel, in_types, options&#125;));</span><br><span class="line">    kernel_ctx.<span class="built_in">SetState</span>(state.<span class="built_in">get</span>());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">RETURN_NOT_OK</span>(executor-&gt;<span class="built_in">Init</span>(&amp;kernel_ctx, &#123;kernel, in_types, options&#125;));</span><br><span class="line">  <span class="keyword">this</span>-&gt;options = options;</span><br><span class="line">  inited = <span class="literal">true</span>;</span><br><span class="line">  <span class="keyword">return</span> Status::<span class="built_in">OK</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">Status <span class="title">Init</span><span class="params">(<span class="type">const</span> FunctionOptions* options, ExecContext* exec_ctx)</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (exec_ctx == NULLPTR) &#123;</span><br><span class="line">    exec_ctx = <span class="built_in">default_exec_context</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  kernel_ctx = KernelContext&#123;exec_ctx, kernel&#125;;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">KernelInit</span>(options);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>è¿™ç¯‡æ–‡ç« ç®€å•ä¸²äº†ä¸€ä¸‹æœ€ç®€å•çš„ Add æ‰§è¡Œçš„æµç¨‹ï¼Œé™äºæœ¬äººç›®å‰æ°´å¹³å’Œç¯‡å¹…ï¼Œè¿™éƒ¨åˆ†ä¸ä¼šå¾ˆè¯¦ç»†ã€‚ç­‰å¾…æœ¬äººæ›´ç†Ÿæ‚‰ Runtime ä»£ç å†æ‰©å……æœ¬æ–‡çš„å†…å®¹ã€‚</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Type and Array in Columnar System</title>
      <link href="/2023/05/04/Type-and-Array-in-Columnar-System/"/>
      <url>/2023/05/04/Type-and-Array-in-Columnar-System/</url>
      
        <content type="html"><![CDATA[<p>Type å’Œ Array æ˜¯ Columnar System æœ€åº•å±‚çš„ä¸œè¥¿ä¹‹ä¸€äº†ã€‚å› ä¸ºæœ¬èº«ä»»ä½•åˆ—å­˜ç³»ç»Ÿæ— æ—¶æ— åˆ»éƒ½è¦å’Œå®ƒä»¬æ‰“äº¤é“ã€‚ä½œä¸ºç³»ç»Ÿçš„ Building Blockï¼Œå­˜å‚¨åˆ° Runtime éƒ½æœ‰ Type Systemï¼ŒåŒæ—¶å¤„ç†çš„æ•°æ®å¤§éƒ¨åˆ†æ—¶å€™éƒ½æ˜¯ Columnar çš„ã€‚</p><p>Type &amp; Array System æœ¬èº«ä¸æ˜¯å¾ˆæœ‰èŠ±å¤´çš„ä¸œè¥¿ï¼Œä¸»è¦è€ƒé‡çš„æ˜¯æŸä¸ªç¼–ç¨‹è¯­è¨€ä¸‹çš„ï¼š</p><ol><li>ç›´æ¥çš„å¹³å¦éå˜é•¿æ•°æ®çš„å®ç°ï¼ˆè¿™æ˜¯æœ€ç®€å•çš„ä¸€å±‚ï¼Œå¯èƒ½éœ€è¦å…³æ³¨ alignasã€å†…å­˜ç®¡ç†ç­‰ï¼‰ã€Null çš„å¤„ç†ã€è¯»/å†™çš„æ¥å£</li><li>Stringï¼ˆç­‰å˜é•¿ï¼‰ ç±»å‹çš„å¤„ç†</li><li>Struct / Map / Array ç­‰å˜é•¿/åµŒå¥—ç±»å‹çš„å¤„ç†<ol><li>nullable / nonnull çš„é€»è¾‘çš„å¤„ç†ï¼ˆè¿™ä¸ªé€»è¾‘å¹¶ä¸ç®€å•ï¼Œæƒ³è±¡ä¸€ä¸‹ <code>nullable struct&lt;list&lt;nonnull int&gt;&gt;</code>ï¼Œé‚£ä¹ˆæ€ä¹ˆè¡¨ç¤ºè¿™æ ·çš„ç»“æ„</li></ol></li><li>Union ç­‰æ•°æ®çš„å¤„ç†ï¼ˆæœ¬è´¨ä¸Šå…¶å®æœ‰ç‚¹ç±»ä¼¼å˜é•¿ / åµŒå¥—ç»“æ„ï¼‰</li><li>å„ç§ç¼–ç çš„æ ¼å¼ï¼Œæ¯”å¦‚ Dictionary / RLE ç­‰ formatã€‚è¿™é‡Œè¦è€ƒè™‘çš„æ˜¯ç¼–ç æ ¼å¼æœ¬èº«çš„æŠ½è±¡ä¹‹ç±»çš„ã€‚</li></ol><h2 id="Arrow"><a href="#Arrow" class="headerlink" title="Arrow"></a>Arrow</h2><p>Apache Arrow å°†ç³»ç»Ÿåˆ†ä¸ºäº†å¥½å‡ å±‚ï¼ˆ <a href="https://arrow.apache.org/docs/cpp/overview.html">https://arrow.apache.org/docs/cpp/overview.html</a> ï¼‰ï¼š</p><h3 id="Physical-Layer"><a href="#Physical-Layer" class="headerlink" title="Physical Layer"></a>Physical Layer</h3><p>Memory Management ç‰©ç†çš„å†…å­˜ç®¡ç†ï¼Œæ¶‰åŠ <code>MemoryPool</code> , <code>Buffer</code> ç³»ç»Ÿ</p><ol><li>Memory Pool æ”¯æŒ JeMalloc MiMalloc ç­‰ backendï¼Œä¹Ÿå…è®¸ç”¨æˆ·è‡ªå·±åœ¨ä¸Šé¢åŒ…ä¸€å±‚ï¼Œæ¯”å¦‚ç”¨ <code>std::alloctor</code> æ¥å½“ä½œç³»ç»Ÿçš„å†…å­˜ç”³è¯·è€…ï¼Œç”³è¯·çš„å†…å­˜<strong>é»˜è®¤ 64B alignas</strong><ol><li>Jemalloc, MiMalloc æœ‰å¯¹åº”çš„ Poolï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ Jemalloc ç­‰ Pool ç®¡ç†</li><li>Memory Pool æ¥å£ç±»ä¼¼ <code>std::allocator</code>ï¼Œç”šè‡³æœ‰ç›´æ¥é€‚é…çš„ï¼Œè¿™ä¸¤ä¸ªè¿˜èƒ½äº’ç›¸é€‚é…ï¼Œç¬‘å˜»äº†ã€‚åæ­£ calloc ä¹‹ç±»çš„æ˜¯æ²¡æœ‰çš„ï¼ŒFree å’Œ <code>free</code> ä¹Ÿä¸å®Œå…¨å¯¹åº”ï¼ŒçŸ¥é“å°±è¡Œ</li><li>é»˜è®¤ç”šè‡³æ˜¯ System Allocatorï¼Œå°±ä¸¢ç»™ OS äº†</li></ol></li><li><code>MemoryManager</code> / <code>Device</code>:<ol><li><code>Device</code> æ˜¯å¯¹ä¸“æœ‰å†…å­˜å’Œè®¾å¤‡çš„æŠ½è±¡ï¼Œç›®å‰åªæ”¯æŒäº† CPU Memory</li><li><code>MemoryManager</code> æ„Ÿè§‰ä¹Ÿæ˜¯åœ¨æŸä¸ªè®¾å¤‡ä¸Šçš„æŠ½è±¡ï¼Œå…è®¸æŠŠå†…å­˜ dump åˆ°å¦å¤–çš„ mm ä¸­ (ç„¶è€Œ <code>CPUMemoryManager</code> åŒ…äº†ä¸€å±‚ poolï¼ŒçœŸæ˜¯æƒŠäººçš„å¤§é»‘æš—)</li><li>ä¸Šè¿°çš„å†…å®¹åœ¨è¿™ä¸ª patch ä¸­è¢«å¼•å…¥ï¼š<a href="https://github.com/apache/arrow/commit/9f0c70c8337b1a8c75df5cc9410b54e97351bfc0">https://github.com/apache/arrow/commit/9f0c70c8337b1a8c75df5cc9410b54e97351bfc0</a></li><li>è¿™ä¸ª Patch æåˆ°äº†ä¸€äº› GPU å†…å­˜çš„ç®¡ç† <a href="https://github.com/apache/arrow/pull/34972">https://github.com/apache/arrow/pull/34972</a></li></ol></li><li><code>Buffer</code>: Arrow çš„å†…å­˜ç³»ç»Ÿï¼Œæœ‰ç€ä¸€å¥—ç±»å‹æ ‘ã€‚<ol><li><code>Buffer</code> æœ¬èº«: åŒ…å« <code>is_cpu</code> , <code>MemoryManager</code>, <code>is_mutable</code>, <code>data</code>, <code>capacity</code>, <code>parent</code>. æœ¬èº«ä¸ç®¡ç†å†…å­˜ï¼Œä½œä¸ºåŸºç±»å­˜åœ¨ã€‚Buffer æœ¬èº«ä¸å…³å¿ƒ 64B å¯¹é½ï¼Œä½†æ˜¯ <code>MemoryPool</code> é€ å‡ºæ¥çš„å¯ä»¥å½“æˆæ˜¯ 64B å¯¹é½çš„<ol><li>è®¤ä¸º <code>size</code> å’Œ <code>capacity</code> ä¸­é—´çš„å†…å®¹æ˜¯ padding éƒ¨åˆ†ï¼Œå…è®¸ zero padding</li><li><code>is_cpu</code> å¹¶ä¸å®Œå…¨ä»£è¡¨è¿™æ˜¯ CPU. æ˜¯ CPU çš„å¯ä»¥ç”¨ <code>data()</code> æ‹¿åˆ° <code>u8 pointer</code> ï¼Œå¦åˆ™åªèƒ½ç”¨ <code>address</code> æ‹¿åˆ° <code>uintptr</code></li><li>å…è®¸æœ‰ä¸€ä¸ª <code>shared_ptr&lt;Buffer&gt;</code> ä½œä¸ºçˆ¶çº§å…³ç³»</li></ol></li><li><code>MutableBuffer</code>: Buffer çš„å­ç±»ï¼Œæ ‡æ³¨äº†ä¸€ä¸‹ <code>is_mutable = true</code>ï¼Œå…¶ä»–å•¥éƒ½æ²¡åš</li><li><code>ResizableBuffer</code>: <code>MutableBuffer</code> çš„å­ç±»ï¼Œæ¥å£ä¸Šå…è®¸ Resize</li><li>ä¸Šé¢å‡ ä¸ªéƒ½æ˜¯å¤–éƒ¨çš„æ¥å£ï¼Œå®é™…ä¸Šã€Œæœ¬èº«å¹¶ä¸ç®¡ç†å†…å­˜ã€ï¼Œä¸‹é¢è¿˜æœ‰å‡ ä¸ªå†…éƒ¨çš„å®ç°ï¼š<ol><li><code>PoolBuffer</code>: å’Œ <code>MemoryPool</code> ç»‘å®šçš„ Buffer<ol><li>å…¶å®äº§ç”Ÿå‡ºæ¥çš„ï¼Œå› ä¸ºç»‘å®šäº† <code>PoolBuffer</code>ï¼Œæ‰€ä»¥äº‹å®ä¸Šå…¨æ˜¯ Resizable çš„</li></ol></li><li><code>StlStringBuffer</code>: åŒ…äº†ä¸€å±‚ string</li></ol></li><li>String æœ¬èº«å…è®¸åŒ…ä¸€å±‚ <code>shared_ptr</code> ç„¶åä¸¢ç»™å„¿å­ï¼Œè¿™æ ·å•å±‚çš„ç»§æ‰¿å…³ç³»ï¼Œä½†æ˜¯ä¸å…è®¸å¤šå±‚çš„å…³ç³»</li></ol></li></ol><h3 id="The-one-dimensional-layer"><a href="#The-one-dimensional-layer" class="headerlink" title="The one-dimensional layer"></a>The one-dimensional layer</h3><p>åœ¨æˆ‘çš„è¿™ç¯‡åšå®¢ï¼ˆ <a href="https://blog.mwish.me/2022/10/04/Parquet-Part2-arrow-Parquet-code-path/#Arrow-cheatsheet">https://blog.mwish.me/2022/10/04/Parquet-Part2-arrow-Parquet-code-path/#Arrow-cheatsheet</a> ï¼‰ è´´äº†å¾ˆå¤š arrow çš„å›¾ï¼Œå½“æ—¶ä¸€ç›´åœ¨è§£é‡Šè¿™å¥—ä¸œè¥¿ï¼Œç°åœ¨æ¥çœ‹ï¼Œæˆ‘å½“æ—¶è´´çš„å›¾è¿˜æ˜¯æŒºæœ‰è´¨é‡çš„ã€‚åæ¥ arrow çš„ä¸€äº›è¿›å±•æˆ‘ä¹Ÿå¯ä»¥è¡¥å……åˆ°è¿™ç¯‡åšå®¢é‡Œæ¥ã€‚</p><p><img src="https://image.mwish.me/blog-image/D113AFDFF7CD13071A3A407B9CED5CC3.png" alt="arrowType"></p><p>é™¤äº†ä¸Šå›¾ï¼Œåœ¨ä¸€äº›æ–°çš„ææ¡ˆä¸­ï¼Œarrow ä¹Ÿå¢åŠ äº†æ–°çš„ç±»å‹ï¼Œeg:</p><ol><li>REE: <a href="https://arrow.apache.org/docs/format/Columnar.html#run-end-encoded-layout">https://arrow.apache.org/docs/format/Columnar.html#run-end-encoded-layout</a></li><li>(ææ¡ˆä¸­) ListView  <a href="https://github.com/apache/arrow/pull/35345">https://github.com/apache/arrow/pull/35345</a></li></ol><p>æˆ‘ä»¬å…ˆç®€çŸ­ä»‹ç»ä¸€ä¸‹è¿™é‡Œçš„ç±»å‹ç³»ç»Ÿå’Œå¯¹åº”çš„é™åˆ¶ï¼š</p><ol><li><code>DataType</code>: ç±»å‹ç³»ç»Ÿï¼ŒåŒ…å«åµŒå¥—ç­‰æ–¹å¼</li><li><code>Array</code>: ç›®å‰å¯ä»¥å½“ä½œ POD ä¹‹ç±»çš„ä¸œè¥¿çš„åŒ…è£…å™¨ï¼Œå¤§éƒ¨åˆ†æ˜¯æ²¡æœ‰å¯¹è±¡è¯­ä¹‰çš„</li><li>(Extension) æ‰©å±•çš„ç±»å‹ç³»ç»Ÿå’Œ Array</li><li><strong>Chunked arrays</strong>: ç‰©ç†ä¸è¿ç»­ï¼Œé€»è¾‘ä¸Šè¿ç»­çš„ Array åºåˆ—ã€‚</li><li>Scalar: (Typed) å•ä¸ªç±»å‹çš„å€¼</li></ol><p>æˆ‘ä»¬ç®€çŸ­ä»‹ç»ä¸€ä¸‹è¿™äº›ç³»ç»Ÿï¼š</p><p>DataType åŒ…å« <code>DataType</code> ( ä¸€ä¸ªç±»å‹ç³»ç»Ÿæ ‘ ) å’Œ <code>Schema</code> ï¼ˆå…·åï¼Œå…è®¸é¢å¤–ä¿¡æ¯çš„ Schemaï¼‰</p><ol><li><code>DataTypeLayout</code>: é€’å½’çš„åŒ…å« Layout (å®šé•¿ã€å˜é•¿ã€å…¨ NULLã€Bitmap)</li><li><code>DataType</code>: å¯ä»¥æ˜¯æ ‘å½¢çš„ã€å¸¦æœ‰ PhysicalType (æ¯”å¦‚ Timestamp å®é™…ä½¿ç”¨ Int64) çš„ arrayï¼Œå­èŠ‚ç‚¹æ˜¯ <code>Field</code><ol><li>Arrow çš„ Type ä¸åŒ…å« Nullableï¼Œå¹¶ä¸” <strong>å…³è”å®é™…ç‰©ç†çš„ Layout</strong>ï¼Œæ¯”å¦‚ <code>Dictionary</code> ç”šè‡³è¢«æŠ½äº†ä¸€ä¸ªç±»å‹å‡ºæ¥ã€‚ç„¶åå¯ä»¥ç”¨ Visitor æ¨¡å¼æ¥è®¿é—®ç±»å‹æ ‘</li><li><code>FixedWidthType is DataType</code> , <code>PrimitiveCType is FixedWidthType</code>ï¼Œè¿™é‡Œæœ‰ä¸€å¥—å¯¹åº”çš„é“¾è·¯ï¼Œç„¶å FP, Integer ä»€ä¹ˆçš„éƒ½æ˜¯å®ƒ</li><li><code>NullType</code> ç”¨æ¥è¡¨ç¤ºå…¨ null çš„</li><li><code>BaseBinaryType is DataType</code>, å…¶ä½™ç±»å‹ç»§æ‰¿äº†å®ƒã€‚æ³¨æ„æˆ‘ä»¬ä¹‹å‰è¯´çš„ï¼Œ<code>LargeBinary</code> å’Œ <code>Binary</code> ä¹‹ç±»çš„ offset é•¿åº¦ä¸åŒçš„ï¼Œå±äºä¸¤ä¸ªç±»å‹ï¼Œ<code>FixedSized</code> ä¹Ÿæœ‰è‡ªå·±çš„ç±»å‹</li><li>ä»¤äººå”å˜˜çš„æ˜¯ï¼Œ<code>DecimalType</code> æ˜¯ <code>FixedSizeBinaryType</code> çš„å­ç±»â€¦ç„¶åå®ƒè¿˜æœ‰ <code>Decimal128</code> å’Œ <code>Decimal256</code> ä¸¤ä¸ªå­ç±»</li><li><code>ParametricType</code> æ˜¯ä¸€ä¸ªå¥‡æ€ªçš„ç±»å‹æ ‡è®°ï¼Œæˆ‘ç°åœ¨è¿˜ä¸çŸ¥é“è¿™ç©æ„æœ‰ä»€ä¹ˆç”¨</li><li><code>NestedType</code> æ˜¯ <code>DataType</code> å’Œ <code>ParametricType</code> çš„å­ç±»ã€‚å„¿å­åŒ…å« <code>List</code> <code>Map</code> <code>Struct</code> ä¹‹ç±»çš„</li><li><code>Union</code> ä¹Ÿæ˜¯ <code>NestedType</code></li><li><code>DictionaryType</code> æ˜¯ä¸€ç§ <code>FixedWidthType</code>, è€Œ <code>RunEndEncodedType</code> æ˜¯ä¸€ç§ <code>NestedType</code></li></ol></li><li><code>Field</code>: <code>(name, type, nullable, key-value metadata)</code>. å…è®¸å¸¦å­ç±»å‹å’Œ Flattenã€‚åµŒå¥—çš„ <code>DataType</code> å„¿å­éƒ½æ˜¯ <code>Field</code>.<ol><li><code>FieldPath</code>: ä¸€ç»„ <code>schema-&gt;field(5)-&gt;type()-&gt;field(9)-&gt;type()-&gt;field(3)</code> è¿™æ ·æ„æˆçš„ <code>&#123;5, 9, 3&#125;</code> çš„ schema ä¸Šçš„è·¯å¾„</li><li><code>FieldRef</code>: ç›¸å¯¹äº <code>FieldPath</code>ï¼Œè¿˜å¤šä¸€ä¸ª <code>FieldName</code> ç”¨åç§°æ¥å¯»å€çš„è¯­ä¹‰</li></ol></li><li><code>Schema</code>: å¯ä»¥çœ‹ä½œ <code>Endianness, &#123;Fields&#125;</code>, endianness æ˜¯ä¸ºäº†è¯»å¦ä¸€ç§ endian çš„ Schemaã€‚ä¸€èˆ¬ç»“æ„çš„ Root å°±æ˜¯ä¸€ä¸ª Schemaã€‚<ol><li>å¯ä»¥é€šè¿‡ Schema Builder æ¥æ„å»º Schema</li></ol></li></ol><p>é¡ºå¸¦ä¸€æè¿™ä¸ª Layout æ¥å£çœŸçš„å¾ˆç›´è§‚ï¼Œæ¯”å¦‚ä¸‹é¢æ˜¯ Binary çš„ Layout</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">DataTypeLayout <span class="title">layout</span><span class="params">()</span> <span class="type">const</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">DataTypeLayout</span>(&#123;DataTypeLayout::<span class="built_in">Bitmap</span>(),</span><br><span class="line">                         DataTypeLayout::<span class="built_in">FixedWidth</span>(<span class="built_in">sizeof</span>(offset_type)),</span><br><span class="line">                         DataTypeLayout::<span class="built_in">VariableWidth</span>()&#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Array çš„ç³»ç»Ÿç±»ä¼¼ Typeï¼Œä¸è¿‡æˆ‘è€å®è¯´ Array çš„ Mutable è¿˜æ˜¯æŒºè›‹ç–¼çš„ï¼Œæ€è€ƒä¸€ä¸ªé—®é¢˜å°±æ˜¯ï¼ŒPrimitive Type å¯ä»¥æ¯”è¾ƒç®€å•ï¼Œå¹³å¦çš„æå‡ºæ¥ï¼Œä½†æ˜¯ Binary / List ä¹‹ç±»çš„å…¶å®ä¸å¤ªå¥½æã€‚</p><p>Array æœ¬èº«çš„æ ¸å¿ƒæ˜¯ <code>ArrayData</code>, å®ƒä¹Ÿæ˜¯ä¸€ä¸ªå¯ä»¥é€’å½’çš„ç±»å‹ï¼Œä»¥ç»„åˆçš„å½¢å¼å†…åµŒåœ¨ <code>Array</code> ä¸­ï¼ŒBuffer æŒ‰ç…§ Type å¯¹åº”çš„ Layout æ¥æ’å¸ƒã€‚ä¸€èˆ¬ <code>[0]</code> æ˜¯ validity bitmapï¼Œå…¶ä»–çš„éšä¾¿ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">  std::shared_ptr&lt;DataType&gt; type;</span><br><span class="line">  <span class="type">int64_t</span> length = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">mutable</span> std::atomic&lt;<span class="type">int64_t</span>&gt; null_count&#123;<span class="number">0</span>&#125;;</span><br><span class="line">  <span class="comment">// The logical start point into the physical buffers (in values, not bytes).</span></span><br><span class="line">  <span class="comment">// Note that, for child data, this must be *added* to the child data&#x27;s own offset.</span></span><br><span class="line">  <span class="type">int64_t</span> offset = <span class="number">0</span>;</span><br><span class="line">  std::vector&lt;std::shared_ptr&lt;Buffer&gt;&gt; buffers;</span><br><span class="line">  std::vector&lt;std::shared_ptr&lt;ArrayData&gt;&gt; child_data;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// The dictionary for this Array, if any. Only used for dictionary type</span></span><br><span class="line">  std::shared_ptr&lt;ArrayData&gt; dictionary;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><code>Array</code> åŸºç±»æ˜¯ä¸€ä¸ª <code>ArrayData</code> çš„åŒ…è£…å™¨ï¼Œå…¶ä»–ç±»å‹ä¹Ÿä¸å¤–å¦‚æ˜¯ï¼Œåªæ˜¯æä¾›äº†å¾ˆå¤šç›¸å…³çš„æ–¹æ³•ã€‚æˆ–è®¸æˆ‘ä»¬éœ€è¦é¢å¤–å…³æ³¨ Flatten çš„è¯­ä¹‰ï¼Œè¿™é‡Œå­çº§åˆ«çš„ Validity éœ€è¦æ‰‹åŠ¨å¤„ç†çˆ¶çº§åˆ«çš„ Validityï¼Œè¿™é€»è¾‘è¿˜æ˜¯æ¯”è¾ƒå¤æ‚çš„ã€‚</p><p><code>Scalar</code> å’Œ <code>Array</code> ç›¸åï¼Œè¯­ä¹‰ä¸Šæ˜¯ä¸€ä¸ªå•å€¼ï¼Œé€»è¾‘ä¸Šå·®ä¸å¤šç›¸å½“äºç”¨ç»§æ‰¿å®ç°äº†ä¸€å¥— tagged enumï¼Œæˆ‘æ„Ÿè§‰å…¶å®æˆ‘ä¸æ˜¯å¾ˆåœ¨æ„è¿™ä¸€å±‚çš„å¼€é”€ã€‚</p><p><code>Datum</code> ç›¸å½“äºä¸€ä¸ªæ³›ç”¨çš„ç±»å‹ï¼Œæˆ–è®¸æ²¡æœ‰ä»€ä¹ˆèƒ½æ¯”è´´å‡ è¡Œä»£ç è¯´çš„æ›´æ¸…æ¥šäº†ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// \class Datum</span></span><br><span class="line"><span class="comment">/// \brief Variant type for various Arrow C++ data structures</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">ARROW_EXPORT</span> Datum &#123;</span><br><span class="line">  <span class="keyword">enum</span> <span class="title class_">Kind</span> &#123; NONE, SCALAR, ARRAY, CHUNKED_ARRAY, RECORD_BATCH, TABLE &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å°±è¿™æ ·.</p><h2 id="Velox"><a href="#Velox" class="headerlink" title="Velox"></a>Velox</h2><p>ç›¸å¯¹ Arrow é‚£å¥—è¢«å¾ˆå¤šåœ°æ–¹ç”¨åˆ°çš„ Typeï¼ŒVelox çš„ Type ä¸€æ–¹é¢ä»£ç è´¨é‡å¯èƒ½æ²¡é‚£ä¹ˆè¯»èµ·æ¥èˆ’æœï¼Œå¦ä¸€æ–¹é¢å…¶å®åŠŸèƒ½è¦†ç›–æ˜¯å¹¿ä¸€äº›çš„ã€‚Velox çš„å†…å­˜ç®¡ç† Hack äº†ä¸€å¥— MemoryTrackerï¼Œç±»å‹ç³»ç»Ÿä¹Ÿæ›´ â€œSQLâ€:</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// Velox type system supports a small set of SQL-compatible composeable types:</span></span><br><span class="line"><span class="comment">/// BOOLEAN, TINYINT, SMALLINT, INTEGER, BIGINT, REAL, DOUBLE, VARCHAR,</span></span><br><span class="line"><span class="comment">/// VARBINARY, TIMESTAMP, DATE, INTERVAL_DAY_TIME, ARRAY, MAP, ROW</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// This file has multiple C++ type definitions for each of these logical types.</span></span><br><span class="line"><span class="comment">/// These logical definitions each serve slightly different purposes.</span></span><br><span class="line"><span class="comment">/// These type sets are:</span></span><br><span class="line"><span class="comment">/// - TypeKind</span></span><br><span class="line"><span class="comment">/// - Type (RowType, BigIntType, ect.)</span></span><br><span class="line"><span class="comment">/// - Templated Types (Row&lt;T...&gt;, Map&lt;K, V&gt;, ...)</span></span><br><span class="line"><span class="comment">///     C++ templated classes. Never instantiated, used to pass limited type</span></span><br><span class="line"><span class="comment">///     information into template parameters.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/// Simple enum with type category.</span></span><br><span class="line"><span class="keyword">enum class</span> <span class="title class_">TypeKind</span> : <span class="type">int8_t</span> &#123;</span><br><span class="line">  BOOLEAN = <span class="number">0</span>,</span><br><span class="line">  TINYINT = <span class="number">1</span>,</span><br><span class="line">  SMALLINT = <span class="number">2</span>,</span><br><span class="line">  INTEGER = <span class="number">3</span>,</span><br><span class="line">  BIGINT = <span class="number">4</span>,</span><br><span class="line">  REAL = <span class="number">5</span>,</span><br><span class="line">  DOUBLE = <span class="number">6</span>,</span><br><span class="line">  VARCHAR = <span class="number">7</span>,</span><br><span class="line">  VARBINARY = <span class="number">8</span>,</span><br><span class="line">  TIMESTAMP = <span class="number">9</span>,</span><br><span class="line">  DATE = <span class="number">10</span>,</span><br><span class="line">  INTERVAL_DAY_TIME = <span class="number">11</span>,</span><br><span class="line">  SHORT_DECIMAL = <span class="number">12</span>,</span><br><span class="line">  LONG_DECIMAL = <span class="number">13</span>,</span><br><span class="line">  <span class="comment">// Enum values for ComplexTypes start after 30 to leave</span></span><br><span class="line">  <span class="comment">// some values space to accommodate adding new scalar/native</span></span><br><span class="line">  <span class="comment">// types above.</span></span><br><span class="line">  ARRAY = <span class="number">30</span>,</span><br><span class="line">  MAP = <span class="number">31</span>,</span><br><span class="line">  ROW = <span class="number">32</span>,</span><br><span class="line">  UNKNOWN = <span class="number">33</span>,</span><br><span class="line">  FUNCTION = <span class="number">34</span>,</span><br><span class="line">  OPAQUE = <span class="number">35</span>,</span><br><span class="line">  INVALID = <span class="number">36</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å®ƒçš„ Type ç³»ç»Ÿæ˜¯ä¸€æ£µæ ‘ï¼Œåˆ†åˆ«ä¸º ScalarType å’Œåˆ«çš„å¤æ‚çš„å¤åˆç±»å‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// Abstract class hierarchy. Instances of these classes carry full</span></span><br><span class="line"><span class="comment">/// information about types, including for example field names.</span></span><br><span class="line"><span class="comment">/// Can be instantiated by factory methods, like INTEGER()</span></span><br><span class="line"><span class="comment">/// or MAP(INTEGER(), BIGINT()).</span></span><br><span class="line"><span class="comment">/// Instances of these classes form a tree, and are immutable.</span></span><br><span class="line"><span class="comment">/// For example, MAP&lt;INTEGER, ARRAY&lt;BIGINT&gt;&gt; will form a tree like:</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">///             MapType</span></span><br><span class="line"><span class="comment">///           /         \</span></span><br><span class="line"><span class="comment">///   IntegerType    ArrayType</span></span><br><span class="line"><span class="comment">///                     |</span></span><br><span class="line"><span class="comment">///                   BigintType</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Type</span> : <span class="keyword">public</span> Tree&lt;<span class="type">const</span> std::shared_ptr&lt;<span class="type">const</span> Type&gt;&gt;,</span><br><span class="line">             <span class="keyword">public</span> velox::ISerializable &#123;</span><br></pre></td></tr></table></figure><p>Velox çš„ Buffer è‡ªå·±åšäº†ä¸€å¥—ä¾µå…¥å¼çš„ RCï¼Œå¹¶ç”± MemoryTracker è®°å½•å†…å­˜ï¼Œè¿™å¥—ä»£ç å®ç°åœ¨ <code>velox/buffer/Buffer.h</code></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> BufferPtr = boost::intrusive_ptr&lt;Buffer&gt;;</span><br></pre></td></tr></table></figure><p>(ä¸€ä¸ªæœ‰æ„æ€çš„ <code>intrusive_ptr</code> ä½¿ç”¨ï¼Œè¿™é‡Œæ„Ÿè§‰ä¸Šæ˜¯èŠ‚çœäº† <code>weak_ptr</code> çš„å†…å­˜å¼€é”€)</p><ol><li>ï¼ˆåœ¨ <code>velox/buffer/Buffer.h</code>ï¼‰Buffer: å¯èƒ½ç”± MemoryTracker æ¥è¿½æº¯å†…å­˜çš„ã€å…è®¸ asMutable / <code>as&lt;T&gt;</code> çš„ å†…å­˜æ± ï¼Œå…è®¸å­˜æ”¾ non-pod type</li><li>ï¼ˆå†…å­˜ç®¡ç†çš„é€»è¾‘åœ¨ <code>velox/common/memory</code> ä¸‹é¢ï¼‰MemoryPool: å¯ä»¥æœ‰çˆ¶çº§çš„æ ‘å½¢ç»“æ„ï¼ŒMemoryPool åˆ†ä¸º Leaf ï¼ˆå…·ä½“çš„å¶å­ç»“ç‚¹ï¼‰å’Œ Aggregateï¼ˆæ±‡æ€»èŠ‚ç‚¹ï¼‰ã€‚è¿™é‡Œå¹¶å‘ä¸Š children ç”± <code>folly::SharedMutex</code> ç»´æŠ¤ï¼Œ<code>parent_</code> æ˜¯ä¸ä¼šå˜çš„ï¼Œå†…å­˜æ°¸è¿œæŒ‰ç…§ alignas ç”³è¯·ã€‚<strong>è¿™æ®µé€»è¾‘æœ€è¿‘åœ¨é‡æ„ï¼Œå˜åŠ¨æ¯”è¾ƒå¤§ï¼Œæˆ‘è¿™ç‰ˆæœ¬ç†è§£åŸºäº <a href="https://github.com/facebookincubator/velox/commit/c82d9f9bd335c6411fcc1f1f99c5d82796535733">https://github.com/facebookincubator/velox/commit/c82d9f9bd335c6411fcc1f1f99c5d82796535733</a></strong> <ol><li><code>MemoryPoolImpl</code> æ˜¯ <code>MemoryPool</code> å®é™…ä½¿ç”¨çš„é€»è¾‘ï¼Œå®ƒçš„å†…å­˜æ·»åŠ ä¼šèµ°ä¸€æŠŠé”ï¼ˆè¿˜æ˜¯ <code>std::mutex</code>ï¼Œæˆ‘æ—¥ï¼‰ã€‚å®ƒè‡ªå·±æœ‰ä¸€ç»„ç»Ÿè®¡ä¿¡æ¯ï¼ŒåŒæ—¶ç»‘å®šäº†ä¸€ä¸ª <code>MemoryManager</code></li><li><code>MemoryManager</code> å‡ ä¹æ˜¯ç±»ä¼¼å•ä¾‹çš„å…¨å±€å†…å­˜åˆ†é…å™¨ï¼Œå®ƒæœ‰ä¸€ä¸ªå•ä¾‹ï¼Œç„¶åå¯ä»¥æ ¹æ®ä»–äº§ç”Ÿ <code>MemoryPool</code> å’Œç»‘å®š <code>MemoryPool</code></li><li><code>MemoryArbitrator</code> æ˜¯ä¸€ä¸ª <code>MemoryManager</code> ä¸­çš„æ€ªä¸œè¥¿ï¼Œæ„Ÿè§‰ä¸Šç±»ä¼¼ä¸€ä¸ª burst å†…å­˜å¤„ç†å™¨ã€‚å½“å†…å­˜ä¸å¤Ÿçš„æ—¶å€™ï¼Œå¯ä»¥æ ¹æ® <code>MemoryArbitrator</code> å»å‘åˆ«çš„åœ°æ–¹ç§Ÿå€Ÿå†…å­˜</li><li><code>MemoryReclaimer</code> æ˜¯ <code>MemoryArbitrator</code> çš„ RAII åŒ…è£…å™¨ï¼Œè´Ÿè´£å€Ÿ/è¿˜å†…å­˜çš„ç®¡ç†</li></ol></li></ol><p>è¿™é‡Œæœ‰ä¸ª Hacking çš„åœ°æ–¹æ˜¯ï¼ŒMemoryPool è‡ªå·±å’Œçˆ¶çº§åˆ« allocate ä¸€éè¿˜è¦å» MemoryManager æä¸€éï¼Œæ„Ÿè§‰æ˜¯å› ä¸ºå„ç§åœ°æ–¹çš„ä¸Šé™ä¸æ˜¯ç®€å•ç¡¬ä»çˆ¶äº²é‚£é‡Œåˆ†é…å¤šå°‘ï¼Œè€Œæ˜¯æ¯ä¸ªçº§åˆ«æœ‰ä¸€äº›å†…å­˜ï¼Œç„¶åå…è®¸å» stealã€‚</p><p>å’Œ Arrow ä¸ä¸€æ ·ï¼ŒVelox çš„ Vector å’Œç±»å‹å’Œç‰©ç†çš„ Layout æ²¡æœ‰ç›´æ¥å¯¹åº”ã€‚</p><p>è¿™é‡Œç»™ Vector æä¾›äº†ä¸åŒçš„ Encoding æ–¹å¼ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Provides an enumeration of vector encoding types.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">enum class</span> <span class="title class_">Simple</span> &#123;</span><br><span class="line">  BIASED,</span><br><span class="line">  CONSTANT,</span><br><span class="line">  DICTIONARY,</span><br><span class="line">  FLAT,</span><br><span class="line">  SEQUENCE,</span><br><span class="line">  ROW,</span><br><span class="line">  MAP,</span><br><span class="line">  ARRAY,</span><br><span class="line">  LAZY,</span><br><span class="line">  FUNCTION</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>Velox çš„ null ä¹Ÿæ˜¯ä¸ª bitmapã€‚å€¼å¾—ä¸€æçš„æ˜¯ï¼ŒVelox ä»£ç ä¸­ <code>BaseVector</code> éƒ½å¿«æœ‰ 1000 è¡Œäº†ï¼Œæˆ‘ä»¬å…ˆçœ‹ç‚¹ç®€å•çš„å†…å®¹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">const</span> TypePtr type_;</span><br><span class="line"><span class="type">const</span> TypeKind typeKind_;</span><br><span class="line"><span class="type">const</span> VectorEncoding::Simple encoding_;</span><br><span class="line">BufferPtr nulls_;</span><br><span class="line"><span class="comment">// Caches raw pointer to &#x27;nulls-&gt;as&lt;uint64_t&gt;().</span></span><br><span class="line"><span class="type">const</span> <span class="type">uint64_t</span>* rawNulls_ = <span class="literal">nullptr</span>;</span><br><span class="line">velox::memory::MemoryPool* pool_;</span><br><span class="line"><span class="type">vector_size_t</span> length_ = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Holds the number of nulls in the vector. If the number of nulls</span></span><br><span class="line"><span class="comment"> * is not available, it is set to std::nullopt. Setting the value to</span></span><br><span class="line"><span class="comment"> * zero does have implications (SIMD operations need null count to be</span></span><br><span class="line"><span class="comment"> * zero) and is not the same as std::nullopt.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">std::optional&lt;<span class="type">vector_size_t</span>&gt; nullCount_;</span><br><span class="line">std::optional&lt;<span class="type">vector_size_t</span>&gt; distinctValueCount_;</span><br><span class="line">std::optional&lt;ByteCount&gt; representedByteCount_;</span><br><span class="line">std::optional&lt;ByteCount&gt; storageByteCount_;</span><br><span class="line">ByteCount inMemoryBytes_ = <span class="number">0</span>;</span><br></pre></td></tr></table></figure><p>è¿™äº›æ˜¯å®ƒçš„æˆå‘˜ï¼Œè¿™é‡Œæ²¡æœ‰å¤„ç†æ•°æ®ï¼Œä½†æ˜¯åŒ…è£…äº†å¾ˆå¤š <code>wrap</code> ä¹‹ç±»çš„åè§£æ–¹æ³•ã€‚è¿™é‡Œä¸Šé¢å†å¥—äº†ä¸€å±‚ <code>SimpleVector</code>:</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// This class abstracts over various Columnar Storage Formats such that Velox</span></span><br><span class="line"><span class="comment">// can select the most appropriate one on a per field / per block basis.</span></span><br><span class="line"><span class="comment">// The goal is to use the most appropriate type to optimize for:</span></span><br><span class="line"><span class="comment">//   - Lazy deserialization if desired.</span></span><br><span class="line"><span class="comment">//   - serialization / rehydration cost, ideally we use a smart view into the</span></span><br><span class="line"><span class="comment">//     data without fully rehydrating.</span></span><br><span class="line"><span class="comment">//   - serialized bytes</span></span><br><span class="line"><span class="comment">//   - cpu cost of filtering</span></span><br><span class="line"><span class="comment">//   - optimize aggregation of sequential values</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SimpleVector</span> : <span class="keyword">public</span> BaseVector &#123;</span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="built_in">SimpleVector</span>(</span><br><span class="line">      velox::memory::MemoryPool* pool,</span><br><span class="line">      TypePtr type,</span><br><span class="line">      VectorEncoding::Simple encoding,</span><br><span class="line">      BufferPtr nulls,</span><br><span class="line">      <span class="type">size_t</span> length,</span><br><span class="line">      <span class="type">const</span> SimpleVectorStats&lt;T&gt;&amp; stats,</span><br><span class="line">      std::optional&lt;<span class="type">vector_size_t</span>&gt; distinctValueCount,</span><br><span class="line">      std::optional&lt;<span class="type">vector_size_t</span>&gt; nullCount,</span><br><span class="line">      std::optional&lt;<span class="type">bool</span>&gt; isSorted,</span><br><span class="line">      std::optional&lt;ByteCount&gt; representedByteCount,</span><br><span class="line">      std::optional&lt;ByteCount&gt; storageByteCount = std::<span class="literal">nullopt</span>)</span><br><span class="line">      : <span class="built_in">BaseVector</span>(</span><br><span class="line">            pool,</span><br><span class="line">            std::<span class="built_in">move</span>(type),</span><br><span class="line">            encoding,</span><br><span class="line">            std::<span class="built_in">move</span>(nulls),</span><br><span class="line">            length,</span><br><span class="line">            distinctValueCount,</span><br><span class="line">            nullCount,</span><br><span class="line">            representedByteCount,</span><br><span class="line">            storageByteCount),</span><br><span class="line">        <span class="built_in">isSorted_</span>(isSorted),</span><br><span class="line">        <span class="built_in">elementSize_</span>(<span class="built_in">sizeof</span>(T)),</span><br><span class="line">        <span class="built_in">stats_</span>(stats) &#123;&#125;</span><br></pre></td></tr></table></figure><p>SimpleVector æœ‰å‡ ä¸ªä¸åŒçš„å­ç±»ï¼Œå¯¹åº”æ–‡æ¡£é‡Œçš„ç¼–ç ï¼š</p><ol><li>Constant</li><li>Bias (Delta + Base)</li><li>Dictionary</li><li>Flat (å•¥éƒ½æ²¡æœ‰)</li><li>Sequence (RLE)</li></ol><p>å¤æ‚ç±»å‹çš„å¤„ç†é€»è¾‘å’Œ Arrow å·®åˆ«å¾ˆå¤§ï¼Œè§ï¼š<a href="https://facebookincubator.github.io/velox/develop/vectors.html#flat-vectors-complex-types">https://facebookincubator.github.io/velox/develop/vectors.html#flat-vectors-complex-types</a></p><p>å¯¹ Null å¤„ç†è€Œè¨€ï¼ŒåŒºåˆ«æœ‰ï¼š</p><p>Struct</p><blockquote><p>Child vectors may include nulls buffers of their own, therefore, it is possible to have a non-null top-level struct value with some or all child fields being null. A null struct is not the same as a struct with all its fields being null. Values of child fields for rows where the top-level struct is null are undefined.</p></blockquote><p>Map:</p><blockquote><p>Null map and empty map are not the same.</p><p>Keys and values vectors may have nulls buffer independent of each other and of the nulls buffer of the map vector itself. This allows us to specify non-null maps with some or all values being null. Technically speaking a map may have a null key as well, although this may not be very useful in practice. Null map and a map with all values being null are not the same.</p><p>Map vector layout does not guarantee or require that keys of individual maps are unique. However, in practice, places which create maps, e.g. ORC and Parquet readers, <a href="https://facebookincubator.github.io/velox/functions/presto/map.html#id0"><code>map()</code></a> function, etc., ensure that map keys are unique.</p></blockquote><p>Array:</p><blockquote><p>Null array and empty array are not the same.</p><p>Elements vector may have a nulls buffer independent of the nulls buffer of the array vector itself. This allows us to specify non-null arrays with some or all null elements. Null array and array of all null elements are not the same.</p></blockquote><p>æ€»ä¹‹ï¼Œè¿™å—è¯­ä¹‰æœ¬èº«ä¹Ÿéœ€è¦ä¸€å®š checkingã€‚</p><h2 id="ClickHouse"><a href="#ClickHouse" class="headerlink" title="ClickHouse"></a>ClickHouse</h2><p>å†…å­˜è§  <a href="https://www.jianshu.com/p/4b15fae5d400">https://www.jianshu.com/p/4b15fae5d400</a> ï¼Œæ¯”è¾ƒå€¼å¾—å€Ÿé‰´çš„åœ°æ–¹æ˜¯å„ç§ Hook</p><p>ç›¸å…³çš„ Doris ä¹Ÿå¯ä»¥è§ <a href="https://cwiki.apache.org/confluence/display/DORIS/DSIP-002%3A+Refactor+memory+tracker+on+BE">https://cwiki.apache.org/confluence/display/DORIS/DSIP-002%3A+Refactor+memory+tracker+on+BE</a></p><h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ol><li>Arrow çš„ä»‹ç»ï¼š<a href="https://arrow.apache.org/docs/cpp/arrays.html">https://arrow.apache.org/docs/cpp/arrays.html</a></li><li>å‘é‡åŒ–çš„æŸ¥è¯¢å¼•æ“é‡Œä½¿ç”¨Bitmapè¿˜æ˜¯Select Vectorsè¡¨ç¤ºè¿‡æ»¤åçš„ç»“æœæ›´ä¼˜ï¼Ÿ - ç ä¸ŠDX3906çš„å›ç­” - çŸ¥ä¹ <a href="https://www.zhihu.com/question/546231083/answer/2601582280">https://www.zhihu.com/question/546231083/answer/2601582280</a></li><li>ClickHouse çš„å†…å­˜ç®¡ç†: <a href="https://www.jianshu.com/p/4b15fae5d400">https://www.jianshu.com/p/4b15fae5d400</a></li><li>Jemalloc: <a href="https://jemalloc.net/jemalloc.3.html">https://jemalloc.net/jemalloc.3.html</a> (<code>sallocx</code> ç­‰)</li><li>Doris å†…å­˜ç®¡ç†ï¼š<a href="https://cwiki.apache.org/confluence/display/DORIS/DSIP-002%3A+Refactor+memory+tracker+on+BE">https://cwiki.apache.org/confluence/display/DORIS/DSIP-002%3A+Refactor+memory+tracker+on+BE</a></li></ol>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>[SIGMOD&#39;18] Column Sketches: a index for OLAP workload</title>
      <link href="/2023/04/16/Column-Sketches-a-index-for-OLAP-workload/"/>
      <url>/2023/04/16/Column-Sketches-a-index-for-OLAP-workload/</url>
      
        <content type="html"><![CDATA[<ul><li><p><code>&lt;Column Sketches: A Scan Accelerator for Rapid and Robust Predicate Evaluation&gt;</code> æ˜¯ SIGMODâ€™18 ä¸Šçš„ä¸€ç¯‡ Research Paper. å®ƒæè¿°äº†æ€ä¹ˆç”¨ Column Sketches æ¥æ„å»ºä¸€ä¸ªåˆé€‚çš„ã€ä»¥ Table ä¸ºé¡ºåºçš„ Sketchï¼Œæ¥ä¼˜åŒ–æŸ¥è¯¢ã€‚è¿™ç¯‡æ–‡ç« çš„ idea æ¯”è¾ƒç®€å•ï¼Œä½†æ˜¯æ•°å­¦éƒ¨åˆ†ç›¸å¯¹å¤æ‚ä¸€äº›ï¼Œæ¯”è¾ƒå€¼å¾—å€Ÿé‰´ã€‚ä¸è¿‡è¿™é‡Œä¹Ÿå¾—å°å°æ³¨æ„ä¸€ä¸‹ï¼ŒColumn Sketches å’Œç»å¸¸ç”¨çš„ç¼©ç•¥è¯ CM Sketch (Count-Min) æ˜¯ä¸ä¸€æ ·çš„ï¼Œåè€…ç»å¸¸ç”¨æ¥åš ndv çš„ç»Ÿè®¡ï¼Œè€Œå‰è€…å¯ä»¥çœ‹ä½œæ˜¯ bitmap index çš„ç±»ä¼¼ç‰©ã€‚</p><h2 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a><strong>èƒŒæ™¯</strong></h2><p>æŠ±æ­‰æˆ‘ä»¬éœ€è¦åœ¨èƒŒæ™¯éƒ¨åˆ†ä»‹ç»æ¯”è¾ƒé•¿çš„æ—¶é—´. æœ¬è´¨ä¸Šï¼ŒAP ç³»ç»Ÿçš„ Index å’Œ tp ç³»ç»Ÿçš„ index å¯èƒ½ç¨å¾®æœ‰ä¸€äº›ä¸ä¸€æ ·ï¼š</p><ol><li>æ•°æ®çš„è§„æ¨¡å¤§ï¼Œå¯èƒ½è¿‡æ»¤æ‰çš„æ•°æ®è§„æ¨¡å¤§ï¼Œç²’åº¦å¯èƒ½ä¹Ÿæ¯”è¾ƒå¤§</li><li>ï¼ˆå¯èƒ½ä¼šï¼‰å…è®¸ä¸€äº› false positive</li><li>ï¼ˆå¹¶ä¸ä¸€å®šä¼šï¼‰å¯èƒ½ä¸å¤ªä¼šè€ƒè™‘ update / insert çš„æƒ…å†µ</li></ol><p>TP çš„ BTree / LSM / ART ç­‰ç´¢å¼•éƒ½ä¸æ˜¯å¾ˆé€‚åˆè¿™ä¸ªæƒ…å†µã€‚åœ¨ AP ç³»ç»Ÿä¸­ï¼Œå¯èƒ½è¿˜ä¼šæœ‰å‡ ä¸ª considerationï¼ˆTPå¯èƒ½ä¹Ÿæœ‰ï¼‰ï¼š</p><ol><li>Predicate Seletivity<ol><li>å…¶å®æˆ‘è§‰å¾—è¿˜æœ‰ä¸€ä¸ªå¾ˆé‡è¦çš„ï¼Œä½†æ˜¯è®ºæ–‡å’Œ 15-721 éƒ½æ²¡å’‹æï¼Œå°±æ˜¯æ•°æ®çš„åˆ†å¸ƒçš„æƒ…å†µã€‚æ¯”å¦‚ 0 1 0 1 0 1 è¿™ç§ï¼Œä½ åœ¨ loading å±‚é¢å¦‚æœ</li></ol></li><li>Skewness<ol><li>å¯èƒ½ä¼šæœ‰é«˜åˆ†å¸ƒçš„ unique value æ•°æ®</li></ol></li><li>cluster / sorting<ol><li>æ•°æ®æ˜¯å¦é¢„å…ˆ clustering äº†</li></ol></li></ol><p>åœ¨ 15-721 é‡Œé¢ï¼Œæ•´ç†äº†ä¸€äº›ç´¢å¼•ï¼Œéƒ¨åˆ†ä¹Ÿæ¥è‡ª Column Sketches çš„ä¸¾ä¾‹ï¼Œä¸çŸ¥é“æœ‰æ²¡æœ‰ä»€ä¹ˆä¸“è®ºã€‚</p><h3 id="Zone-Maps"><a href="#Zone-Maps" class="headerlink" title="Zone Maps"></a><strong>Zone Maps</strong></h3><p>Apache Iceberg, Apache Parquet, Apache ORC ä¹‹ç±»çš„éƒ½æœ‰è¿™ä¸ªä¸œè¥¿ï¼Œæˆ‘å€’æ˜¯å¾ˆéš¾æƒ³è±¡æœ‰è°æ²¡æœ‰çš„ã€‚æœ¬è´¨ä¸Šæ˜¯ä¸€ç§è¶…çº§ç²—ç²’åº¦ pruningã€‚ä¸€èˆ¬æ¥è¯´è¿˜æ˜¯æœ‰ä¸€äº›å„ç§ corner case çš„ï¼Œæ¯”å¦‚å“ªäº›ä¸œè¥¿åº”è¯¥æ”¾ min-maxï¼Œä¸€äº›ç‰¹æ®Šå€¼çš„å¤„ç†ï¼Œä»€ä¹ˆæ—¶å€™åº”è¯¥é€€åŒ–ã€‚ä¸è¿‡è¿™äº›æˆ‘ç†è§£æ˜¯ä»€ä¹ˆç´¢å¼•éƒ½æœ‰ã€‚</p><h3 id="Bitmap-Index"><a href="#Bitmap-Index" class="headerlink" title="Bitmap Index"></a><strong>Bitmap Index</strong></h3><p>StarRocks / Doris éƒ½å¼•å…¥äº† Bitmap Index. Bitmap Index æœ‰ä¸€äº›æ€è·¯å‘è¡¨åœ¨è®ºæ–‡ <Bitmap Index Design and Evaluation> ä¸­ï¼Œè®ºæ–‡æœ¬èº«æ¯”è¾ƒç®€å•ã€‚bitmap index çš„æœ€åŸå§‹æ€è·¯æ˜¯ã€Œä¸€ä¸ªå€¼ä¸€ä¸ª bitmap indexã€ã€‚ç„¶å Filter çš„æ—¶å€™æ‰«é‚£å‡ ä¸ª bitmap å°±è¡Œäº†ã€‚è¿™ä¸ª idea æˆ‘ä¸ªäººè®¤ä¸ºæœ¬è´¨ä¸Šæ˜¯æŠŠ domain æ‹†åˆ†æˆå¤šç»„ï¼Œç„¶å filter çš„æ—¶å€™åªæ‰«æéœ€è¦çš„ domainã€‚</p><p>è¿™ç§æ–¹å¼ç›´è§‚çœ‹æ˜¯æ²¡æœ‰é—®é¢˜çš„ï¼Œä½†æ˜¯é—®é¢˜æ˜¯å¤šæ–¹é¢çš„ï¼Œæ¯”å¦‚ domain éœ€è¦å¾ˆå°ï¼Œä½†æ˜¯åˆä¸å¤ªå¥½è¿‡å°ï¼ˆæƒ³è±¡ä¸€ä¸‹ï¼Œå¦‚æœ domain = 2ï¼Œé‚£ä¹ˆæ˜¯ä¸æ˜¯å°±æ²¡æœ‰åŒºåˆ«äº†â€¦ï¼‰ï¼ŒåŒæ—¶è¿˜æœ‰å„ç§é—®é¢˜ï¼Œæ‰€ä»¥è¿™é‡Œå¯èƒ½è¦å¼•å…¥ä¸€äº› pattern å’Œå‹ç¼©æ–¹å¼ã€‚</p><p>è®ºæ–‡ Bitmap Index Design and Evaluation æå‡ºäº†å¯¹åº”çš„æ¯”è¾ƒæ¡†æ¶ï¼Œæ¥ç»™è¿™ä¸ªä¸€ä¸ªé‡åŒ–çš„æ¸ é“ã€‚è¿™ç¯‡è®ºæ–‡å‘è¡¨çš„æ¯”è¾ƒæ—©ï¼Œä¸è¿‡å…¶å®è¯„ä¼°è¿˜æ˜¯å¾ˆå¥½çš„ã€‚</p><p>è¿™ç¯‡è®ºæ–‡æ‹†åˆ†å‡ºäº†ä¸¤ä¸ªç»´åº¦ï¼Œä½œä¸ºè¯„ä»·çš„æ ‡å‡†ï¼š</p><ol><li>Space-Time Tradeoff</li><li>Encoding Scheme</li></ol><p>åŒæ—¶åšäº†ä¸€äº› bitmap eval ç›¸å…³çš„å·¥ä½œã€‚åŒæ—¶å®šä¹‰äº†ä¸€äº› bitmap ç›¸å…³çš„å¯å‘å¼å·¥ä½œ</p><p>è¿™é‡Œï¼š</p><ol><li>C = attribute cardnality</li><li>å®šä¹‰ä¸‹åˆ— Decomposition:</li></ol><p><img src="https://image.mwish.me/blog-image/bitmap.png" alt="bitmap"></p><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œè¿™é‡Œå¯ä»¥æŠŠå€¼æ‹†æˆ n ç»„ bitmap çš„é›†åˆ {B0, B1, Bâ€¦, B_{n-1}}ï¼Œå…±åŒæ„æˆå¯¹åº”çš„æ•°å­—ã€‚è¿™é‡Œå±•ç¤ºåŒä¸€ç»„æ•°æ®çš„ä¸¤ç§è¡¨ç¤ºæ–¹å¼ï¼Œå¯ä»¥çœ‹åˆ° Filter æ€§èƒ½å’Œå ç”¨ç©ºé—´ä¸Šçš„åŒºåˆ«ï¼š</p><p><img src="https://image.mwish.me/blog-image/bitmap-2-component.png" alt="bitmap-2-component"></p><p><img src="https://image.mwish.me/blog-image/bitmap-value-list.png" alt="bitmap-value-list"></p><p>è¿™é‡Œè¿˜æœ‰ä¸€ä¸ª Encoding Schema çš„é—®é¢˜ï¼Œè¿™é‡Œåˆ†ä¸ºä¸¤ç§ï¼š</p><ol><li>Equality Encoding: å•ç»„æ•°æ®å†…ï¼Œç­‰äºè¦æ±‚çš„mark ä¸º 1 </li><li>Range Encoding: å•ç»„æ•°æ®å†…ï¼Œå¤§äºç­‰äºè¦æ±‚çš„å…¨éƒ¨mark ä¸º 1ã€‚<strong>å®ƒçš„å®½åº¦ä¼šå°‘ä¸€ï¼Œå› ä¸ºå®ƒç›¸å½“äºç”¨ range çš„æ–¹å¼ç¼©å‡äº†éœ€è¦çš„ä¿¡æ¯</strong>ã€‚</li></ol><p>Figure1 å’Œ Figure3 å†…å®¹å‡ä¸º Equality Encodingï¼Œä¸‹é¢å±•ç¤º Range Encoding:</p><p><img src="https://image.mwish.me/blog-image/bitmap-abc.png" alt="bitmap-abc"></p><h4 id="æ¼”ç®—"><a href="#æ¼”ç®—" class="headerlink" title="æ¼”ç®—"></a>æ¼”ç®—</h4><p><img src="https://image.mwish.me/blog-image/bitmap-eval.png" alt="bitmap-eval"></p><p>è¿™é‡Œæœ‰ä¸¤ç§ç®—æ³•ï¼š</p><ol><li>RangeEval: å¯¹äº <code>&gt;=</code> å’Œ <code>&lt;=</code>ï¼Œç»´æŠ¤æ¯ä¸ª bitmap çš„ Eq, GT æˆ–è€… Eq, LTã€‚ç„¶åæ¨ç®—ã€‚<ol><li>åˆå§‹åŒ–çš„ GT, LT ä¸ºå…¨ 0 çš„å‘é‡ï¼ŒEq ä¸º non-nulls</li><li>æ¯ä¸€è½®ä¸­ï¼Œæ±‚è§£éœ€è¦çš„ Eq, LT, GT</li></ol></li><li>RangeEval-Opt:<ol><li>æŠŠ <code>&gt;=</code> å’Œ <code>&lt;=</code> æ¨æˆ <code>&gt; v - 1</code> å’Œ  <code>&lt; v + 1</code>ï¼Œç„¶åæ‰§è¡Œæ“ä½œã€‚</li></ol></li></ol><p>ï¼ˆæˆ‘å…¶å®æ²¡å®Œå…¨çœ‹æ‡‚è¿™é‡Œï¼Œå¯èƒ½ä¹‹åå¾—ç¿»ç¿»ä»£ç ï¼‰</p><h4 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h4><p><img src="https://image.mwish.me/blog-image/bitmap-design-space.png" alt="bitmap-design-space"></p><p>è®ºæ–‡ä¸­æå‡ºäº†å¯¹åº”çš„ space-time æŠ½è±¡ï¼Œæ¥è¯„ä¼°å¯¹åº”çš„å®ç°ã€‚</p><p>ä½ å¯èƒ½ä¼šæ³¨æ„åˆ°å³ä¸‹è§’æœ‰ä¸ª Bit-Sliced Indexï¼Œè¿™ä¸ªä¸œè¥¿â€¦å’Œ Bit-Weaving ä¸€æ ·ï¼Œç®—æ˜¯æç«¯ç‰¹åŒ–çš„ bitmap indexï¼Œç®—æ³•å¤§è‡´ç±»ä¼¼ä¹‹å‰è´´å‡ºæ¥çš„éƒ¨åˆ†ï¼ˆä½†æ˜¯å¯èƒ½æœ‰ SIMDï¼‰ï¼Œç±»ä¼¼ä¸€å¥—æå‰çš„è£å‰ª</p><p><img src="https://image.mwish.me/blog-image/bit-slice.png" alt="bit-slice"></p><p>åœ¨å®è·µä¸­ï¼Œæœ‰çš„æ•°æ®åº“å®ç°äº† Bitmap Index:</p><ol><li>Oracle</li><li>Greenplum, è¿™å¥—åšçš„æ¯”è¾ƒç»†ï¼Œç›´æ¥åšåˆ° Page ä¸Šå¤´äº†</li><li>StarRocks/Doris, è¿™ä¸ªåšçš„ç›¸å½“äºæ˜¯å¤šåˆ—æ— åºå­—å…¸</li></ol><p>(å…¶å®æˆ‘è®¤ä¸ºæŸç§ç¨‹åº¦ä¸Š bitmap ç›¸å½“äºä¸€ç§å¥‡æ€ªçš„ encoding äº†ï¼Œè€Œä¸æ˜¯ä¼ ç»Ÿ Index é‚£ç§å«ä¹‰ï¼Œæˆ‘ç›®å‰æ²¡æ‰¾åˆ°å¾ˆå¥½çš„ææ–™ï¼Œæ‰€ä»¥è¯­è¨€ä¸Šè¯´ä¸å¤ªæ¸…æ¥šï¼Œæ‡‚æˆ‘æ„æ€å°±è¡Œ)</p><h3 id="Bit-Weaving"><a href="#Bit-Weaving" class="headerlink" title="Bit Weaving"></a>Bit Weaving</h3><p>Bit Weaving æœ‰ wisc çš„ä½œè€…ä»¬å‘è¡¨äº SIGMODâ€™13 çš„è®ºæ–‡ BitWeaving: Fast Scans for Main Memory Data Processing ä¸Šã€‚æŸç§ç¨‹åº¦ä¸Šï¼ŒBit Weaving æœ‰ç‚¹åƒ Bit-Slices è¿™ä¸€å¥—ï¼Œå®ƒå¾€å‰èµ°äº†ä¸€æ­¥ï¼šå¯¹æ•´æ•°ï¼ˆå°½é‡ï¼‰å‹ç¼©ï¼Œå¯¹ä½é‡‡ç”¨ç‰¹æ®Šçš„æ¨¡å¼ï¼Œä½¿å…¶é€‚åˆäº SIMD çš„æ‰§è¡Œã€‚</p><p><img src="https://image.mwish.me/blog-image/bit-weaving.png" alt="bit-weaving"></p><p><img src="https://image.mwish.me/blog-image/bit-weaving-hbp.png" alt="img"></p><p>è¿™é‡Œç»™å„ç§ç®—å­éƒ½åšäº†åŸºæœ¬çš„å®ç°ã€‚æ€§èƒ½è¯„ä¼°å¦‚ä¸‹ï¼š</p><p><img src="https://image.mwish.me/blog-image/bitweaving-eval.png" alt="bitweaving-eval"></p><p>è¿™é‡Œæˆ‘å»ºè®®è¿˜æ˜¯å›åˆ°è®ºæ–‡çš„æ ‡é¢˜ï¼Œã€Œä¸€ä¸ª fast-scanã€ æ¥ç†è§£ã€‚</p><h2 id="Column-Sketches-and-Column-Inprints"><a href="#Column-Sketches-and-Column-Inprints" class="headerlink" title="Column Sketches ( and Column Inprints )"></a><strong>Column Sketches ( and Column Inprints )</strong></h2><p>ï¼ˆä¸‹é¢æ˜¯ Column Inprintsï¼Œæ€è·¯å¾ˆç®€å•ï¼‰</p><p><img src="https://image.mwish.me/blog-image/column-imprint.png" alt="column-imprint"></p><p>è¿™éƒ¨åˆ†ç›¸å½“äºè¿›è¡Œä¸€ç³»åˆ—æœ‰æŸå‹ç¼©ï¼Œæ¥æ‹¿åˆ°ä¸€ä¸ªå¸®åŠ©è£å‰ªçš„ sketchesï¼Œæ„Ÿè§‰è¿™ä¸ªæ–¹å¼æ˜æ˜¾åˆç†å¾ˆå¤šã€‚æˆ‘è§‰å¾—åœ¨ç°ä»£ AP ç³»ç»Ÿä¸­ï¼Œå±äºå€¼å¾—ä¸€è¯•çš„æ–¹æ¡ˆã€‚</p><p>è®ºæ–‡æ¥è‡ªå“ˆä½›å¤§å­¦çš„å®éªŒå®¤: <a href="https://stratos.seas.harvard.edu/publications/adaptive-data-skipping-main-memory-systems">https://stratos.seas.harvard.edu/publications/adaptive-data-skipping-main-memory-systems</a></p><p>LSM è‘—åçš„ Dostoyevsky ä¹Ÿæ˜¯æ¥è‡ªè¿™ä¸ªå®éªŒå®¤ï¼Œæ„Ÿè§‰ä»–ä»¬æ˜¯å·¥ç¨‹èƒ½åŠ›æ²¡æœ‰é‚£ä¹ˆå¼ºï¼Œä½†æ˜¯å¯¹å„ç§ metrics</p><p>è®ºæ–‡é‡Œé¢è¯„ä¼°äº† Zone Map, BitWeaving, Btr ä¹‹ç±»çš„ç­–ç•¥ï¼Œä¸‹åˆ—å†…å®¹è¯„ä¼°èŒƒå›´æ˜¯ï¼š</p><ol><li>Selectivity 3%</li><li>æ•°æ®åˆ†å¸ƒæœ‰ skew (å¯è§ Figure 1 æ˜¯æœ‰åˆ©äº sketch çš„ï¼Œå› ä¸ºæ•°æ®åˆ†å¸ƒæœ‰ skew çš„åœºæ™¯æ˜¯å®ƒçš„ä¼˜åŠ¿åŒºï¼Œè¿™å°±æ˜¯è®ºæ–‡åšå®éªŒçš„æ–¹å¼ï¼Œå˜¿å˜¿) </li></ol><p><img src="https://image.mwish.me/blog-image/sketches-1.png" alt="sketches-1"></p><blockquote><p>Compared to standard scans, Column Sketches provide an improvement of 3Ã—-6Ã— for numerical attributes and 2.7Ã— for categorical attributes.</p></blockquote><p>ä¸‹é¢æ˜¯ä¸€ä¸ªè®ºæ–‡ç®€å•çš„å¯¹æ¯”ï¼ˆåŠæ‰“ï¼‰æ¡†æ¶ï¼š</p><p><img src="https://image.mwish.me/blog-image/rap.png" alt="rap"></p><p>è®ºæ–‡è¯„ä¼°çš„èŒƒå›´æœ‰ï¼š</p><ul><li>B-Treeï¼š<ul><li>å¯¹ low-selectivity æ•ˆæœå¥½ï¼Œä½†æ˜¯å½“ Seletivity ä¸Šå»çš„æ—¶å€™ï¼Œæ€§èƒ½å°±ä¼šæš´è·Œï¼ˆä¼ ç»Ÿ rdbms ä¹Ÿè¦è€ƒè™‘å›è¡¨çš„ io/cpu å¼€é”€ï¼‰</li><li>è®ºæ–‡ä¸­æåˆ° Btree ä¸é€‚åˆåœ¨ append-only ç³»ç»Ÿæ›´æ–°ã€cache-locality åœ¨ modern scan ä¸Šè¡¨ç°ä¸å¥½ã€‚æˆ‘ç†è§£å‰è€…æ˜¯å®ç°é—®é¢˜ï¼Œåè€…æ„Ÿè§‰ç¡®å®æ˜¯ä¸ªå°é—®é¢˜ã€‚ä½†æˆ‘ç†è§£æŸç§ç¨‹åº¦ä¸Š btr å’Œ sketch ç¡®å®æ˜¯ä¸¤å›äº‹ã€‚æ­¤å¤–è¿˜æœ‰ä¸ªé—®é¢˜æ˜¯ï¼Œè¿™é‡Œ btr æ˜¯æŒ‰ç…§ domain åˆ‡åˆ†çš„ï¼Œåˆ‡åˆ†å®Œå¯èƒ½è¿˜è¦è½¬åŒ–æˆ scan å›è¡¨ï¼ˆæˆ–è€…ç›´æ¥ icpï¼‰ã€‚ä½œè€…å®éªŒä¸­ï¼Œåœ¨é€‰æ‹©ç‡å¤§äº 1% çš„æƒ…å†µä¸‹ï¼Œå°±ä¸å»ºè®®ç”¨ btr äº†ï¼ˆå…¶å®æˆ‘ä¹ŸæŒºå¥½å¥‡ä»–å®éªŒçš„ç¯å¢ƒçš„ï¼Œä¸è¿‡ä¸æ·±ç©¶äº†ï¼‰</li></ul></li><li>Lightweight Indices (Zone Map, Column Inprints)<ul><li>ç”¨æ•°æ®çš„ Summary æ¥åš Skipping</li><li>å¯¹äº data çš„ clustering properties ä¸å¥½çš„æ—¶å€™ï¼Œæ•ˆæœå¹¶ä¸å¥½ï¼ˆåƒ Figure 1ï¼‰. è¿™ä¸ªå…¶å®å¯ä»¥çœ‹ä¸€ç¯‡åˆ«çš„è®ºæ–‡ Adaptive Data Skipping in Main Memory System çš„å›¾ï¼Œæ€»çš„æ¥è¯´å’Œ zone map ç²’åº¦ã€selectivity å’Œæ•°æ®æ··ä¹±ç¨‹åº¦éƒ½æœ‰å…³ã€‚å½“æŸå‡ åˆ—æ•°æ®ä¸å¤ª clustering çš„æ—¶å€™æ•ˆæœæ˜¾ç„¶æ˜¯ä¸å¥½çš„</li></ul></li><li>Early Pruning Methods<ul><li>æå‰ï¼ˆç»†ç²’åº¦çš„ï¼‰pruning æ•°æ®ï¼Œæ¯”å¦‚ bit-slicing, byte-slicingã€‚é€šå¸¸ç­–ç•¥æ˜¯æŒ‰ bit / byte æ¥åˆ‡åˆ†ï¼ˆpartitionï¼‰å€¼ï¼Œç„¶åè¯»çš„æ—¶å€™å»æŠŠç”¨æˆ·çš„ Operator ä¹Ÿæ¨ç»™éœ€è¦çš„ partition å†åˆå¹¶ï¼Œè¿™é‡Œä¸‹æ¨çš„é¡ºåºä»é«˜åˆ°ä½ï¼Œç„¶åå°½é‡ skip å·²ç» prune æ‰çš„æ•°æ®ã€‚</li><li>å½“æ•°æ®æˆ– filter é›†ä¸­åœ¨ä½ä½ã€æˆ–è€…å‡ºç° skew çš„æ—¶å€™ï¼Œé«˜ä½ filter ä¼šåšå¾ˆå¤šæ— ç”¨åŠŸï¼ŒåŒæ—¶ä¹Ÿä¸èƒ½ prune æ‰ä»€ä¹ˆæ•°æ®ã€‚ï¼ˆthe high order bits are biased towards zero, enabling very little pruning. As a result early pruning brings no significant advantage over a traditional scan.ï¼‰</li></ul></li></ul><p>è®ºæ–‡æå‡ºäº† Column Sketchesï¼Œç‰¹ç‚¹æ˜¯ï¼š</p><ol><li>Robust to Selectivity, data value distribution, data clustering</li><li>Lossy Compression<ol><li>å¯ä»¥æ¯”è¾ƒç²—ç³™åˆä¸å½±å“æ­£ç¡®æ€§çš„æ‘¸å‡ºä¸€ä¸ª encoder</li><li>Space efficient</li><li>æ›´å¿«çš„ ingestion speed (å°±æ˜¯å†™çš„å¿«,å› ä¸ºæŸ¥è¡¨å°‘æˆ‘ç†è§£)ï¼ŒåŒæ—¶ï¼ŒUpdate ä¹‹ç±»çš„ä¸ç”¨åƒå­—å…¸ä¸€æ ·é‡å†™å­—å…¸ã€‚</li><li>æŠŠæŸ¥è¯¢æ‹†åˆ†ä¸ºï¼š<ol><li>èµ° sketched data ç²—è¿‡æ»¤ä¸€éï¼ˆä¼šæœ‰ false positiveï¼‰</li><li>å¦‚æœæœ‰éœ€è¦ï¼Œèµ° Base data ç»†è¿‡æ»¤ä¸€é</li></ol></li></ol></li><li>è®ºæ–‡æ¡†æ¶ä¸­ï¼Œå°½é‡é€‚é… SIMDã€å¤šæ ¸ä¼˜åŒ–ã€‚è®ºæ–‡å£°ç§°ä¹Ÿå¯ä»¥é€‚é… TPæ•°æ®åº“ã€‚</li></ol><p>é‚£ä¹ˆï¼Œç®€å•æ¥ä¸€å¼ å›¾è¡¨ç¤º Column Sketches çš„æ¡†æ¶ï¼š</p><p><img src="https://image.mwish.me/blog-image/BB82ECF4-14BB-4F3A-957E-36E821C7F220.png" alt="BB82ECF4-14BB-4F3A-957E-36E821C7F220"></p><p>è¿™éƒ¨åˆ†å†…å®¹åœ¨è®ºæ–‡ç¬¬äºŒç« ï¼Œä¸Šå›¾ä¸€å›¾æ„Ÿè§‰å°±è¡Œäº†ã€‚</p><ol><li>Column Sketches æ”¯æŒ Ordered å’Œ Unordered ä¸¤ç§æ¨¡å¼ã€‚æ•°æ®ç»“æ„åˆ†ä¸º Compression Map ( function S(x) ) å’Œ Sketched Column ï¼ˆå›ºå®š bitsï¼‰ã€‚Build é˜¶æ®µï¼ŒBase Data æ ¹æ® Compression Map çš„ä¿¡æ¯è¢«æ˜ å°„åˆ° Sketched Column ä¸Šï¼›Probe é˜¶æ®µ</li><li>å¯¹äº Ordered ç»“æ„ï¼ŒCompression Map ç±»ä¼¼ä¸€ä¸ªæœ‰åºçš„ eq-depth histogram. Figure 2 å·¦ä¾§å†™çš„å¾ˆæ¸…æ¥šã€‚æ ¹æ®è¿™ä¸ªå¯ä»¥æ„å»ºï¼Œç„¶åå³å›¾ä¸­ï¼Œæ ¹æ® Map å¯ä»¥ç²—ç­›ä¸€éï¼Œå†æ ¹æ® filter çš„ç»“æœç»†ç­›ï¼ˆè¿™ä¸ªåœ°æ–¹æœ‰ä¸€ä¸ªé—®é¢˜æ˜¯ï¼Œ<strong>ç©ºé—´å ç”¨å’Œ fpp</strong> éƒ½æ˜¯å¤šå°‘ï¼Œåˆ«æ€¥ï¼Œè®ºæ–‡åé¢ä¼šè®²ï¼‰</li><li>å¯¹äº Unordered ç»“æ„ï¼ŒCompression Map æ˜¯ä¸€ä¸ªå«æœ‰ unique code çš„ HashTable + HashFunction </li></ol><p>æ–‡ç« è´´äº†ä¸€ä¸ªç®—æ³•ï¼Œç„¶åè¡¨ç¤ºè¿™ä¸ªç©æ„æœ€å¥½æ˜¯ byte-alignment çš„ï¼Œåæ­£è¿™ç§ä¸œè¥¿éƒ½æ˜¯å®ç°å±‚é¢çš„å› ç´ ï¼š</p><blockquote><p>Byte Alignment. Column Sketches work for any code size. However, we find that on modern hardware there exists around a 30% performance penalty for using non-byte aligned codes. Thus, we give special attention to 8 bit Column Sketches and to 16 bit Column Sketches.</p></blockquote><p>S(x) å·²çŸ¥çš„æƒ…å†µä¸‹ï¼Œæ„å»ºå’ŒæŸ¥è¯¢è¿‡ç¨‹éƒ½å¾ˆç®€å•ã€‚æ˜¾ç„¶è¿™ä¸ªç»“æ„çš„é—®é¢˜å°±å˜æˆäº†å¦‚ä½•æ„å»º S(x)ã€‚</p><h3 id="CONSTRUCTING-COMPRESSION-MAPS"><a href="#CONSTRUCTING-COMPRESSION-MAPS" class="headerlink" title="CONSTRUCTING COMPRESSION MAPS"></a>CONSTRUCTING COMPRESSION MAPS</h3><p>éœ€è¦æ»¡è¶³è®ºæ–‡ç”»çš„ Robust to Selectivity, data value distribution, data clustering è¿™å‡ ä¸ªé¥¼ï¼Œæ„å»ºä¸€ä¸ªåˆé€‚çš„ Mapping å°±å˜å¾—å¾ˆé‡è¦äº†ï¼Œè®ºæ–‡å…ˆæå‡ºäº†ä¸€äº›åŸåˆ™ï¼Œç„¶åå†å…·ä½“åˆ†æï¼š</p><ol><li>ç»™ frequency valueï¼ˆè¶…è¿‡ä¸€å®šæ¯”ä¾‹ï¼‰å»åˆ†é…ç‹¬ç«‹çš„ code.<ol><li>åˆ†é…ç‹¬ç«‹çš„ code æœ‰ä¸€ä¸ªç‰¹æ®Šçš„å¥½å¤„å°±æ˜¯ä¸ç”¨å›è¡¨å†å¥—ä¸€å±‚è¿™ä¸ª Column çš„ Filterã€‚åŒæ—¶è®ºæ–‡æåˆ°ï¼Œåœ¨å‡ºç°ä¸€ä¸ª value å¯¹åº”å¾ˆå¤š key çš„ï¼ˆå‡è®¾æ˜¯ 10%ï¼‰è¿™ç§æ•°æ®åˆ†å¸ƒæƒ…å†µä¸‹ï¼Œè®¿é—® cacheline ä¸­çš„ä»»æ„æ•°æ®ï¼Œå°±ä¼šéœ€è¦è®¿é—®cacheline å…¨éƒ¨çš„æ•°æ®ï¼ŒåŒæ—¶ä¹Ÿä¼šå½±å“è¿™ä¸ª value é‡Œé¢åˆ†å¸ƒçš„å…¶ä»–æ•°æ®ã€‚ä¸å¥½åšåˆ° robustã€‚ï¼ˆè®ºæ–‡é‡Œè®ºè¯æ„Ÿè§‰ä¸æ˜¯å¾ˆæ¸…æ¥šï¼Œæˆ‘ç†è§£å¤§æ¦‚æ˜¯è¿™ä¸ªæ„æ€ï¼‰</li></ol></li><li>ç»™é frequency value åˆ†é…éç‹¬ç«‹çš„ code å¾ˆåˆç†ï¼Œå‹ç¼©ç©ºé—´ï¼Œè®¿é—® base data çš„æ¯”ä¾‹ä¹Ÿå¾ˆå°</li><li>å…è®¸ order preserving (åºŸè¯)</li><li>å¦‚æœæœ‰ï¼ˆsampling ä¸­ï¼‰æ²¡è§åˆ°è¿‡çš„ valueï¼Œä¹Ÿå¯ä»¥å½“æˆ non-unique code æ­£ç¡®å¤„ç†ï¼ˆæƒ³è±¡ä¸€ä¸‹ï¼Œä½œä¸ºåä¾‹çš„ dict encodingï¼‰</li><li>Optional: Exploit Frequently Queried Values </li></ol><p>ä¸‹é¢æœ‰ä¸€æ®µæ•°å­¦è¯æ˜ï¼š</p><p><img src="https://image.mwish.me/blog-image/image.png" alt="image"></p><blockquote><p>256 é‚£ä¸ªåœ°æ–¹æˆ‘æ€€ç–‘æ˜¯ä¸ªç¬”è¯¯ï¼Œå½“æˆ n å¤„ç†å°±è¡Œã€‚</p></blockquote><p>è¿™é‡Œç‰¹åˆ«åšäº†ä¸€ä¸ªä¸éš¾è¯æ˜çš„ä¸Šé™ (2/n). è¿™ä¸ªä¸Šçº¿åœ¨å®ç°ä¸Šæ˜¯æœ‰æ“ä½œç©ºé—´çš„ã€‚å¤§äº 2/n çš„èƒ½ä¿è¯åˆ†é…åˆ° unique value.</p><h3 id="æœ‰åºæ•°åˆ—çš„æ„å»º"><a href="#æœ‰åºæ•°åˆ—çš„æ„å»º" class="headerlink" title="æœ‰åºæ•°åˆ—çš„æ„å»º"></a>æœ‰åºæ•°åˆ—çš„æ„å»º</h3><p>å¯¹äºæœ‰åº Mapï¼Œæ„å»ºæ–¹å¼å¤§æ¦‚æ˜¯ CDF é‡‡æ ·ï¼Œç„¶åæ„å»º eq-depth histogramã€‚è¿™é‡Œçš„æ–¹å¼æ˜¯ é‡‡æ · + Sortï¼Œç„¶åæ„å»º histogramï¼Œæ ¹æ®è¿™ä¸ª histogram æ¥å¤„ç†ã€‚è®ºæ–‡åˆ—å‡ºäº† sample 200k ä¸ªå€¼ï¼Œç„¶åæ„å»º 256 ä¸ª bucket å’Œ assign unique value çš„æƒ…å†µã€‚</p><p>Unique value assign åœ¨è¿™é‡Œè¢«åšäº†ä¸€ç§å¾ˆç®€å•çš„æŠ½æ ·æ³•ï¼š</p><ol><li>å‡è®¾æœ‰ n ä¸ªæ•°å€¼ï¼Œå…¶ä¸­ï¼Œå‡ºç°æ•°å¤šäº 1/z çš„è¦è¢« assign unique value, c æ˜¯ column sketches ä¸­å‡†å¤‡åˆ†é…çš„ codepoint æ•°é‡</li><li>æ„é€ æ–¹å¼ï¼šæŠ½æ · n/z, 2n/zâ€¦ è¿™äº›è½´ç‚¹ä¸Šçš„æ•°æ®ï¼Œç„¶å check æ¯ä¸ªè½´ç‚¹ä¸Šæ•°æ®çš„ begin, endï¼Œæ˜¯å¦è¶…è¿‡äº† 1/z (è¿™ä¸ªæ„é€ æ–¹å¼è¿˜æ˜¯ O(N) çš„ï¼Œä¸è¿‡å¯ä»¥è·³è¿‡å¾ˆå¤šé unique çš„æ•°æ®ï¼Œé‡‡æ ·ç­–ç•¥ä¹Ÿæ¯”è¾ƒç®€å•ï¼‰</li><li>Assign c * midpoint / n çš„ codepoint ç»™ä¸­é—´çš„å€¼ã€‚è®ºæ–‡ä¸­ï¼Œä»¤ z = cã€‚</li><li>åˆ†é…å‰©ä¸‹çš„ code</li></ol><h3 id="Category-æ•°åˆ—çš„æ„å»º"><a href="#Category-æ•°åˆ—çš„æ„å»º" class="headerlink" title="Category æ•°åˆ—çš„æ„å»º"></a>Category æ•°åˆ—çš„æ„å»º</h3><p>æœ‰åºçš„ S(x) ç±»ä¼¼ä¸€ä¸ª eq-depth ç›´æ–¹å›¾ï¼Œæ— åºçš„æ•°åˆ—åˆ™æ˜¯ Hash Function + Bucket Size + Unique Valuesã€‚</p><p>è¿™é‡Œé‡‡æ ·å°±æ¯”è¾ƒå¼±æ™ºäº†ï¼Œç»™é«˜é¢‘å€¼åšåˆ†é…ï¼Œç„¶åä½é¢‘å€¼ hash</p><h3 id="Eval"><a href="#Eval" class="headerlink" title="Eval"></a>Eval</h3><p><img src="https://image.mwish.me/blog-image/sketches-eval.png" alt="sketches-eval"></p><p>Eval åˆ†æˆä¸¤éƒ¨åˆ†ï¼š</p><ol><li>Definite</li><li>Possible</li></ol><p>ç„¶åç”¨æ¥æ±‚èŒï¼Œç›¸å½“äº unique value æ¯”è¾ƒç‹¬ç«‹çš„æŠ½å‡ºæ¥äº†ã€‚</p><h2 id="æ€»ç»“-1"><a href="#æ€»ç»“-1" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>å¯¹äº APï¼Œç›¸å¯¹äº TP çš„ Domain-Based Indexï¼ŒAP æ›´å€¾å‘äºç”¨ Table-Based Indexï¼Œæ¥è¯»å–æ•°æ®ï¼ˆç±»ä¼¼ ICPï¼‰æˆ–è€…å¯¹ Table è¯»å–çš„æ•°æ®è¿›è¡Œè£å‰ªï¼ˆæ‹¿åˆ°ä¸€ä¸ª maskï¼Œç„¶åå» filterï¼‰ã€‚åŒæ—¶ï¼Œä¹Ÿæœ‰ä¸€äº›æ”¹å˜ Table æ•°æ®å­˜æ”¾æ¨¡å¼ï¼Œæ–¹ä¾¿ fast filtering çš„æ–¹æ¡ˆã€‚è¿™é‡Œä¹Ÿè¦è€ƒè™‘ä¸Šç©ºé—´æ”¾å¤§ä¹‹ç±»çš„ã€‚</p><p>ç›®å‰æ„Ÿè§‰å¸‚é¢ä¸Šçš„ AP äº§å“éƒ½æ²¡æœ‰ä»€ä¹ˆåšçš„ç‰¹åˆ«æˆç†Ÿçš„ã€‚æˆ‘è¦å‘åŠ›äº†ï¼ˆè¯¯ï¼‰ã€‚</p><h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a><strong>Reference</strong></h2><ul><li><strong>Bitmap Index Design and Evaluation</strong> <a href="http://www.cs.tau.ac.il/~matias/courses/sem_fall98/bitmaps/bitmapIndexes.html">http://www.cs.tau.ac.il/~matias/courses/sem_fall98/bitmaps/bitmapIndexes.html</a></li><li><a href="https://www.youtube.com/watch?v=2sRyOTZ5Kh0&amp;ab_channel=Sigmod2018">https://www.youtube.com/watch?v=2sRyOTZ5Kh0&amp;ab_channel=Sigmod2018</a></li></ul></li></ul>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>InnoDB Data Locking: Part 1</title>
      <link href="/2023/03/25/InnoDB-Data-Locking/"/>
      <url>/2023/03/25/InnoDB-Data-Locking/</url>
      
        <content type="html"><![CDATA[<p>æ¯ä¸€ä¸ªéœ€è¦å®ç°é”çš„äººï¼Œéƒ½éœ€è¦è€ƒè™‘ Data Lockingï¼Œåœ¨ Btree ä¸Šå¦‚ä½•è¿›è¡Œæ•°æ®çš„é”å®šï¼Œç‰¹åˆ«æ˜¯ InnoDB / PostgreSQLã€‚è¿™ç¯‡æ–‡ç« ç®€å•ä»‹ç»ä¸€ä¸‹ InnoDB æ˜¯æ€ä¹ˆé”å®šæ•°æ®çš„ã€‚æœ¬èº«è¿™ç¯‡æ–‡ç« å‚è€ƒçš„æ˜¯ InnoDB å®˜æ–¹åšå®¢ä¸­ï¼ŒKuba ÅopuszaÅ„ski å†™çš„å‡ éƒ¨åˆ† InnoDB Data Locking çš„æ–‡ç« ï¼Œå†åŠ ä¸Š é˜¿é‡Œå·´å·´æ•°æ®åº“æœˆæŠ¥ä¸€äº›ç›¸å…³çš„è¯¦ç»†ä¸€äº›çš„ä»‹ç»ã€‚</p><p>Locking ä¸€ç›´æ˜¯æ•°æ®åº“é‡Œé¢éå¸¸éš¾çš„å†…å®¹ï¼Œåœ¨ InnoDB é‡Œé¢ï¼Œéš¾ç‚¹ä¹Ÿåœ¨äºå¾ˆå¤šåœ°æ–¹ï¼š</p><ol><li>ä¸åŒå±‚æ¬¡çš„ï¼ˆdatabase, table, rowï¼‰çš„é”å®š</li><li>ä¸åŒçš„éš”ç¦»çº§åˆ«</li><li>è¯»/å†™ç­‰ä¸åŒçš„é”çš„æƒé™<ol><li>äº‹åŠ¡å†²çª</li><li>éœ€è¦çš„æ—¶å€™ï¼Œç»´æŠ¤ consistent read view</li></ol></li><li>é”çš„è¶…æ—¶ / é¥¿æ­»(priority) / æ’é˜Ÿ</li><li>æ­»é”å¤„ç†<ol><li>è¯†åˆ«å†²çª</li><li>æŒ‘é€‰ victim</li><li>é«˜æ•ˆï¼Œä¸å½±å“å…¨å±€</li><li>è¯†åˆ«ä¸åŒæ¨¡å¼çš„ï¼Œç”šè‡³æ˜¯é”å‡çº§å¼•èµ·çš„å†²çª</li></ol></li></ol><p>æœ¬èº«ï¼Œäº‹åŠ¡è¿™ä¸ªæŠ½è±¡æš—ç¤ºç€ DB å¯¹å¤–å±‚æä¾›çš„æ˜¯ä¸€ç§ total-ordering çš„è¯­ä¹‰ã€‚ä½†æ˜¯ä¸ºäº†æ€§èƒ½ï¼Œdb ä¼šåšåˆ°è¡Œæˆ–è€…ä¸€äº›çº§åˆ«çš„é”å®šï¼Œæ¥å…è®¸å¹¶å‘å­˜åœ¨ã€‚åŒæ—¶ï¼Œä¸ºäº†ç»™æ€§èƒ½æˆ–è€…ä½¿ç”¨å¼€ä¸€äº›å£å­ï¼ŒDB ç”šè‡³ï¼ˆä¹Ÿä¸èƒ½è¯´ç”šè‡³ï¼‰å…è®¸å¾ˆå¤šä½çº§åˆ«çš„ Isolation Levelã€‚å…¶å®å•çº¯ä»å– snapshot æˆ–è€…ä¸€äº›å°åœ°æ–¹æ¥çœ‹ï¼Œæ€§èƒ½ç”šè‡³ä¸ä¸€å®šæ›´å¥½ï¼ˆæ¯”å¦‚ RC å¯èƒ½æ¯æ¬¡è¯»è¦æ‹¿ä¸€ä¸ª read-viewï¼Œè™½ç„¶ä¹Ÿæœ‰ä¸€äº›æ€§èƒ½ä¼˜åŒ–ï¼‰ï¼Œä½†æ˜¯é™ä½äº†æ€»ä½“å†²çªçš„æ¦‚ç‡ã€‚</p><p>è¿™é‡Œçš„é—®é¢˜æ˜¯æ€ä¹ˆï¼ˆé«˜æ•ˆçš„ï¼‰æä¾›é”å®šå’Œè¯†åˆ«å†²çªå¹¶ abortã€‚</p><h2 id="è¡¨å’Œæ•°æ®é”å®š"><a href="#è¡¨å’Œæ•°æ®é”å®š" class="headerlink" title="è¡¨å’Œæ•°æ®é”å®š"></a>è¡¨å’Œæ•°æ®é”å®š</h2><p>InnoDB çš„æ•°æ®é”å®šæ˜¯ MySQL é¢è¯•ä¸€å¤§å‘ï¼Œæ¯”å¦‚ç»å…¸çš„ GAP_LOCK å’Œ next-key lockingï¼Œæ¯”è¾ƒä¹å­çš„æ˜¯ï¼Œå…¶å®æ•°æ®åº“ä¸šåŠ¡éƒ¨é—¨æ¯”å¤§éƒ¨åˆ†å¦‚ä»Šçš„ DB R&amp;D æ›´æ‡‚è¿™å—çš„å†…å®¹ï¼Œå› ä¸ºä»–ä»¬åœ¨ç”Ÿäº§ä¸­ä¼šå®é™…å’Œè¿™äº›ä¸œè¥¿æ‰“äº¤é“ã€‚</p><p>æ¯”è¾ƒå¸¸è§çš„å†…å®¹æ˜¯è¡¨é”å’Œæ•°æ®é”ã€‚è¡¨é”æ˜¯ä¸€ä¸ª MySQL çº§åˆ«çš„æ¦‚å¿µï¼Œä½†æ˜¯å®ƒå¯ä»¥è¢«è½¬åŒ–ä¸º InnoDB çš„æ•°æ®é”ç„¶åé£˜åœ¨ InnoDB ä¸Šã€‚ä¸¾åšå®¢ä¸­çš„ä¾‹å­ï¼š</p><p>æ•°æ®é”å®šçš„ sample:</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator">&gt;</span> <span class="keyword">SELECT</span> </span><br><span class="line">    ENGINE_TRANSACTION_ID <span class="keyword">as</span> trx_id,</span><br><span class="line">    LOCK_DATA <span class="keyword">as</span> <span class="type">row</span>,</span><br><span class="line">    OBJECT_NAME <span class="keyword">as</span> `<span class="keyword">table</span>`,</span><br><span class="line">    LOCK_MODE,</span><br><span class="line">    LOCK_STATUS </span><br><span class="line">  <span class="keyword">FROM</span> performance_schema.data_locks <span class="keyword">WHERE</span> LOCK_TYPE<span class="operator">=</span><span class="string">&#x27;RECORD&#x27;</span>; </span><br><span class="line"><span class="operator">+</span><span class="comment">--------+-----+--------+-----------+-------------+ </span></span><br><span class="line"><span class="operator">|</span> trx_id <span class="operator">|</span> <span class="type">row</span> <span class="operator">|</span>  <span class="keyword">table</span> <span class="operator">|</span> LOCK_MODE <span class="operator">|</span> LOCK_STATUS <span class="operator">|</span> </span><br><span class="line"><span class="operator">+</span><span class="comment">--------+-----+--------+-----------+-------------+ </span></span><br><span class="line"><span class="operator">|</span>   <span class="number">3305</span> <span class="operator">|</span>   <span class="number">2</span> <span class="operator">|</span> report <span class="operator">|</span>         S <span class="operator">|</span>     GRANTED <span class="operator">|</span> </span><br><span class="line"><span class="operator">|</span>   <span class="number">3305</span> <span class="operator">|</span>   <span class="number">2</span> <span class="operator">|</span> report <span class="operator">|</span>         X <span class="operator">|</span>     GRANTED <span class="operator">|</span> </span><br><span class="line"><span class="operator">|</span>   <span class="number">3306</span> <span class="operator">|</span>   <span class="number">2</span> <span class="operator">|</span> report <span class="operator">|</span>         X <span class="operator">|</span>     WAITING <span class="operator">|</span> </span><br><span class="line"><span class="operator">+</span><span class="comment">--------+-----+--------+-----------+-------------+</span></span><br></pre></td></tr></table></figure><p>ä¸Šé¢æ˜¯å¾ˆæ˜æ˜¾çš„æ•°æ®é”å®šï¼Œæˆ‘ä»¬è¿˜å¯ä»¥çœ‹åˆ°è¡¨é”ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">con2<span class="operator">&gt;</span> <span class="keyword">SELECT</span> LOCK_TYPE,LOCK_STATUS,OWNER_THREAD_ID </span><br><span class="line">      <span class="keyword">FROM</span> performance_schema.metadata_locks </span><br><span class="line">      <span class="keyword">WHERE</span> OBJECT_NAME<span class="operator">=</span><span class="string">&#x27;t&#x27;</span> <span class="keyword">AND</span> OBJECT_TYPE<span class="operator">=</span>&quot;TABLE&quot;;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-------------+-----------------+</span></span><br><span class="line"><span class="operator">|</span> LOCK_TYPE        <span class="operator">|</span> LOCK_STATUS <span class="operator">|</span> OWNER_THREAD_ID <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-------------+-----------------+</span></span><br><span class="line"><span class="operator">|</span> SHARED_READ_ONLY <span class="operator">|</span> GRANTED     <span class="operator">|</span>              <span class="number">53</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> SHARED_WRITE     <span class="operator">|</span> PENDING     <span class="operator">|</span>              <span class="number">54</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-------------+-----------------+</span></span><br></pre></td></tr></table></figure><p>è¿™é‡Œå¯ä»¥çœ‹åˆ°ï¼Œ<code>performance_schema.metadata_locks</code> æœ‰ <code>SHARED_READ_ONLY</code> é”çš„è¡¨ï¼Œè¿™é‡Œé”æœ‰ä¸‹é¢çš„å‡ ç§å½¢å¼ï¼š<a href="https://dev.mysql.com/doc/refman/5.7/en/performance-schema-metadata-locks-table.html">https://dev.mysql.com/doc/refman/5.7/en/performance-schema-metadata-locks-table.html</a></p><blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LOCK_TYPE</span><br></pre></td></tr></table></figure><ul><li>The lock type from the metadata lock subsystem. The value is one of <code>INTENTION_EXCLUSIVE</code>, <code>SHARED</code>, <code>SHARED_HIGH_PRIO</code>, <code>SHARED_READ</code>, <code>SHARED_WRITE</code>, <code>SHARED_UPGRADABLE</code>, <code>SHARED_NO_WRITE</code>, <code>SHARED_NO_READ_WRITE</code>, or <code>EXCLUSIVE</code>.</li></ul></blockquote><p>è¿™é‡Œæƒ³å¿…åœ¨ MDL é˜¶æ®µä¹Ÿä¼šä¸Š X é”ã€‚</p><p>è¡¨é”åœ¨ InnoDB ä¸­ï¼Œå¯èƒ½ä¼šä»¥æ„å‘é”çš„å½¢å¼å­˜åœ¨ï¼ˆIX ISï¼‰ï¼Œå…¶å®åè¿‡æ¥è¯´ï¼ŒInnoDB çš„æ„å‘é”ä¹Ÿåªä¼šåœ¨ä¸Šé¢è¡¨é”çš„æƒ…å†µä¸‹å¼€ã€‚æˆ‘ä»¬ç»§ç»­ä¸¾å®˜æ–¹åšå®¢ä¸­çš„ä¾‹å­ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SET</span> autocommit <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"> </span><br><span class="line">mysql<span class="operator">&gt;</span> LOCK <span class="keyword">TABLE</span> t READ, t1 WRITE;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.04</span> sec)</span><br><span class="line"> </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SELECT</span> OBJECT_NAME,LOCK_TYPE,LOCK_STATUS,OWNER_THREAD_ID </span><br><span class="line">       <span class="keyword">FROM</span> performance_schema.metadata_locks </span><br><span class="line">       <span class="keyword">WHERE</span> OBJECT_SCHEMA<span class="operator">=</span><span class="string">&#x27;test&#x27;</span> <span class="keyword">AND</span> OBJECT_TYPE<span class="operator">=</span>&quot;TABLE&quot;;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+----------------------+-------------+-----------------+</span></span><br><span class="line"><span class="operator">|</span> OBJECT_NAME <span class="operator">|</span> LOCK_TYPE            <span class="operator">|</span> LOCK_STATUS <span class="operator">|</span> OWNER_THREAD_ID <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+----------------------+-------------+-----------------+</span></span><br><span class="line"><span class="operator">|</span> t           <span class="operator">|</span> SHARED_READ_ONLY     <span class="operator">|</span> GRANTED     <span class="operator">|</span>              <span class="number">49</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> t1          <span class="operator">|</span> SHARED_NO_READ_WRITE <span class="operator">|</span> GRANTED     <span class="operator">|</span>              <span class="number">49</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+----------------------+-------------+-----------------+</span></span><br><span class="line"><span class="number">2</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"> </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SELECT</span> thread_id,processlist_id </span><br><span class="line">       <span class="keyword">FROM</span> performance_schema.threads </span><br><span class="line">       <span class="keyword">WHERE</span> thread_id<span class="operator">=</span><span class="number">49</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+----------------+</span></span><br><span class="line"><span class="operator">|</span> thread_id <span class="operator">|</span> processlist_id <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+----------------+</span></span><br><span class="line"><span class="operator">|</span>        <span class="number">49</span> <span class="operator">|</span>              <span class="number">8</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+----------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"> </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SELECT</span> trx_id <span class="keyword">FROM</span> information_schema.innodb_trx </span><br><span class="line">       <span class="keyword">WHERE</span> trx_mysql_thread_id<span class="operator">=</span><span class="number">8</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">--------+</span></span><br><span class="line"><span class="operator">|</span> trx_id <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------+</span></span><br><span class="line"><span class="operator">|</span>   <span class="number">3851</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------+</span></span><br><span class="line"> </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SELECT</span> </span><br><span class="line">         ENGINE_TRANSACTION_ID <span class="keyword">as</span> trx_id,</span><br><span class="line">         OBJECT_NAME <span class="keyword">as</span> `<span class="keyword">table</span>`,</span><br><span class="line">         INDEX_NAME,</span><br><span class="line">         LOCK_DATA,</span><br><span class="line">         LOCK_MODE,</span><br><span class="line">         LOCK_STATUS </span><br><span class="line">       <span class="keyword">FROM</span> performance_schema.data_locks;</span><br><span class="line"><span class="operator">+</span><span class="comment">--------+-------+------------+-----------+-----------+-------------+</span></span><br><span class="line"><span class="operator">|</span> trx_id <span class="operator">|</span> <span class="keyword">table</span> <span class="operator">|</span> INDEX_NAME <span class="operator">|</span> LOCK_DATA <span class="operator">|</span> LOCK_MODE <span class="operator">|</span> LOCK_STATUS <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------+-------+------------+-----------+-----------+-------------+</span></span><br><span class="line"><span class="operator">|</span>   <span class="number">3851</span> <span class="operator">|</span> t     <span class="operator">|</span> <span class="keyword">NULL</span>       <span class="operator">|</span> <span class="keyword">NULL</span>      <span class="operator">|</span> S         <span class="operator">|</span> GRANTED     <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>   <span class="number">3851</span> <span class="operator">|</span> t1    <span class="operator">|</span> <span class="keyword">NULL</span>       <span class="operator">|</span> <span class="keyword">NULL</span>      <span class="operator">|</span> X         <span class="operator">|</span> GRANTED     <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------+-------+------------+-----------+-----------+-------------+</span></span><br><span class="line"><span class="number">2</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><p>è¿™é‡Œè§‚å¯Ÿåˆ°äº† <code>metadata_lock</code> çš„é”å’Œ <code>data_locks</code> çš„æ˜ å°„å…³ç³»ã€‚</p><p>å›å¿†ä¸€ä¸‹åœ¨æ•°æ®åº“ä¸­ Intention Lock éƒ½æ˜¯ä¸ºäº†æ»¡è¶³ä¸åŒå±‚æ¬¡çš„é”å®šã€‚å¯ä»¥æƒ³è±¡ï¼Œå†™äº‹åŠ¡ä¼šæ‹¿åˆ° <code>IX</code> é”ï¼Œç„¶åå†™ï¼›è¯»äº‹åŠ¡ä¼šæ‹¿åˆ° IS é”ï¼Œç„¶åè¯»ã€‚è¿™ä¸ªæ—¶å€™å¦‚æœæœ‰å…¨å±€çš„è¡¨é”ï¼Œä¼šèµ° InnoDB Lock çš„æµç¨‹ï¼Œç­‰å¾…æ‹¿åˆ°é”ç„¶åè¿›è¡Œæ“ä½œã€‚ï¼ˆä¸çŸ¥é“æœ‰æ²¡æœ‰ä»€ä¹ˆç‰¹å®šçš„ä¼˜åŒ–ï¼Œåº”è¯¥æœ‰å§ï¼‰</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">BEGIN</span>;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"> </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">INSERT</span> <span class="keyword">INTO</span> t <span class="keyword">VALUES</span> (<span class="number">200</span>);</span><br><span class="line">Query OK, <span class="number">1</span> <span class="type">row</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SELECT</span> </span><br><span class="line">         ENGINE_TRANSACTION_ID <span class="keyword">as</span> trx_id,</span><br><span class="line">         OBJECT_NAME <span class="keyword">as</span> `<span class="keyword">table</span>`,</span><br><span class="line">         INDEX_NAME,</span><br><span class="line">         LOCK_DATA,</span><br><span class="line">         LOCK_MODE,</span><br><span class="line">         LOCK_STATUS </span><br><span class="line">       <span class="keyword">FROM</span> performance_schema.data_locks;</span><br><span class="line"><span class="operator">+</span><span class="comment">--------+-------+------------+-----------+-----------+-------------+</span></span><br><span class="line"><span class="operator">|</span> trx_id <span class="operator">|</span> <span class="keyword">table</span> <span class="operator">|</span> INDEX_NAME <span class="operator">|</span> LOCK_DATA <span class="operator">|</span> LOCK_MODE <span class="operator">|</span> LOCK_STATUS <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------+-------+------------+-----------+-----------+-------------+</span></span><br><span class="line"><span class="operator">|</span>   <span class="number">3852</span> <span class="operator">|</span> t     <span class="operator">|</span> <span class="keyword">NULL</span>       <span class="operator">|</span> <span class="keyword">NULL</span>      <span class="operator">|</span> IX        <span class="operator">|</span> GRANTED     <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------+-------+------------+-----------+-----------+-------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> t1 <span class="keyword">FOR</span> SHARE;</span><br><span class="line"><span class="operator">+</span><span class="comment">-----+</span></span><br><span class="line"><span class="operator">|</span> id  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">123</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"> </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SELECT</span> </span><br><span class="line">         ENGINE_TRANSACTION_ID <span class="keyword">as</span> trx_id,</span><br><span class="line">         OBJECT_NAME <span class="keyword">as</span> `<span class="keyword">table</span>`,</span><br><span class="line">         INDEX_NAME,</span><br><span class="line">         LOCK_DATA,</span><br><span class="line">         LOCK_MODE,</span><br><span class="line">         LOCK_STATUS </span><br><span class="line">       <span class="keyword">FROM</span> performance_schema.data_locks <span class="keyword">AND</span> LOCK_TYPE<span class="operator">=</span>&quot;TABLE&quot;;</span><br><span class="line"><span class="operator">+</span><span class="comment">--------+-------+------------+------------------------+-----------+-------------+</span></span><br><span class="line"><span class="operator">|</span> trx_id <span class="operator">|</span> <span class="keyword">table</span> <span class="operator">|</span> INDEX_NAME <span class="operator">|</span> LOCK_DATA              <span class="operator">|</span> LOCK_MODE <span class="operator">|</span> LOCK_STATUS <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------+-------+------------+------------------------+-----------+-------------+</span></span><br><span class="line"><span class="operator">|</span>   <span class="number">3852</span> <span class="operator">|</span> t     <span class="operator">|</span> <span class="keyword">NULL</span>       <span class="operator">|</span> <span class="keyword">NULL</span>                   <span class="operator">|</span> IX        <span class="operator">|</span> GRANTED     <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>   <span class="number">3852</span> <span class="operator">|</span> t1    <span class="operator">|</span> <span class="keyword">NULL</span>       <span class="operator">|</span> <span class="keyword">NULL</span>                   <span class="operator">|</span> <span class="keyword">IS</span>        <span class="operator">|</span> GRANTED     <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------+-------+------------+------------------------+-----------+-------------+</span></span><br><span class="line"><span class="number">4</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><p>å…³äºé”å®šï¼Œè¿™é‡Œå¸Œæœ›ä¸‹è¡¨æ²¡æœ‰è¶…è¿‡ä½ çš„å¸¸è¯†ï¼ˆè¯¯ï¼‰ï¼š</p><p><img src="https://image.mwish.me/blog-image/innodb-lock-01.png" alt="innodb-lock-01"></p><p>ï¼ˆAUTO_INC ä¹Ÿæ˜¯ä¸€ç§è¡¨é”ï¼Œä¸¤ä¸ª AUTO_INC ä¹‹é—´çš„è®¿é—®æ˜¯äº’æ–¥çš„ï¼‰</p><h3 id="Record-Lock-amp-Gap"><a href="#Record-Lock-amp-Gap" class="headerlink" title="Record Lock &amp; Gap"></a>Record Lock &amp; Gap</h3><p>è¿™ä¸ªéƒ¨åˆ†åº”è¯¥æ˜¯éå¸¸æ¶å¿ƒçš„ä¸€éƒ¨åˆ†äº†ï¼Œå› ä¸º InnoDB åˆ‡çš„éå¸¸ç»†ï¼Œç›´æ¥å¯¼è‡´è¿™å—ç»†èŠ‚å¤„ç†éå¸¸æ¶å¿ƒè€Œä¸” bug-pruneã€‚</p><p>å®˜æ–¹åšå®¢ä¸¾äº†ä¸ªéå¸¸å¥½çš„ä¾‹å­ï¼Œå†æ¬¡å…è®¸æˆ‘åŸå°ä¸åŠ¨çš„è´´ä¸Šæ¥ï¼š</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT * FROM t;</span><br><span class="line">+----+</span><br><span class="line">| id |</span><br><span class="line">+----+</span><br><span class="line">|  <span class="number">5</span> |</span><br><span class="line">| <span class="number">10</span> |</span><br><span class="line">| <span class="number">42</span> |</span><br><span class="line">+----+</span><br><span class="line"><span class="number">3</span> rows in set (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"># Could be conceptualized as<span class="punctuation">:</span></span><br><span class="line">--(<span class="number">5</span>)---(<span class="number">10</span>)-----(<span class="number">42</span>)---&gt; id</span><br><span class="line"></span><br><span class="line"># Our mental image should consist of points and gaps between them<span class="punctuation">:</span></span><br><span class="line"></span><br><span class="line">--(                        the gap before the row #<span class="number">5</span></span><br><span class="line"> </span><br><span class="line">   <span class="number">5</span>                       the row #<span class="number">5</span> itself</span><br><span class="line"> </span><br><span class="line">    )---(                  the gap before the row #<span class="number">10</span></span><br><span class="line"> </span><br><span class="line">         <span class="number">10</span>                the row #<span class="number">10</span> itself</span><br><span class="line"> </span><br><span class="line">           )-----(         the gap before the row #<span class="number">42</span></span><br><span class="line"> </span><br><span class="line">                  <span class="number">42</span>       the row #<span class="number">42</span> itself</span><br><span class="line"> </span><br><span class="line">                    )---&gt;  the gap before infinity</span><br></pre></td></tr></table></figure><p>GAP_LOCKï¼Œæ®ä¼Ÿå¤§çš„ Graefe Goetz æ‰€è¯´ï¼Œæ˜¯ä¸€ç§æŠŠ Predicate Lock è½¬åŒ–ä¸ºè®°å½•é”çš„å¥½æ–¹æ¡ˆï¼ŒInnoDB çš„é”æœ‰å¦‚ä¸‹ç±»å‹ï¼š</p><blockquote><ul><li><strong>S,REC_NOT_GAP</strong> â†’ shared access to the record itself</li><li><strong>X,REC_NOT_GAP</strong> â†’ exclusive access to the record itself</li><li><strong>S,GAP</strong> â†’ right to prevent anyone from inserting anything into the gap before the row</li><li><strong>X,GAP</strong> â†’ same as above. Yes, â€œSâ€ and â€œXâ€ are short for â€œsharedâ€ and â€œexclusiveâ€, but given that the semantic of this access right is to â€œprevent insert from happeningâ€ several threads can all agree to prevent the same thing without any conflict, thus currently InnoDB treats <strong>S,GAP</strong> and <strong>X,GAP</strong> (or <strong>*,GAP</strong> locks, for short) the same way: as conflicting just with <strong>*,INSERT_INTENTION</strong></li><li><strong>S</strong> â†’ is like a combination of <strong>S,REC_NOT_GAP</strong> and <strong>S,GAP</strong> at the same time. So it is a shared access right to the row, and prevents insert before it.</li><li><strong>X</strong> â†’ is like a combination of <strong>X,REC_NOT_GAP</strong> and <strong>X,GAP</strong> at the same time. So it is an exclusive access right to the row, and prevents insert before it.</li><li><strong>X,GAP,INSERT_INTENTION</strong> â†’ right to insert a new row into the gap before this row. Despite â€œXâ€ in its name it is actually compatible with others threads trying to insert at the same time.</li><li><strong>X,INSERT_INTENTION</strong> â†’ conceptually same as above, but only happens for the â€œsupremum pseudo-recordâ€ which is imaginary record â€œlarger than any other record on the pageâ€ so that the gap â€œbeforeâ€ â€œitâ€ is actually â€œgap after the last recordâ€.</li></ul></blockquote><p><code>INSERT_INTENTION</code> æ˜¯ä¸ªå¾ˆå‘çˆ¹çš„ä¸œè¥¿ï¼Œæˆ‘ä»¬å…ˆç†è§£ GAP:</p><ol><li>é”çš„ç±»å‹æ˜¯ä¸ª flagï¼ŒS å’Œ REC_NOT_GAP ç›´æ¥æŒ‰ä½ <code>|</code> å°±è¡Œ</li><li>InnoDB çš„é”å’Œå¶å­ç»“æ„æ˜¯ï¼ˆåŠï¼‰ç»‘å®šçš„ï¼Œä¹‹åæˆ‘ä»¬çœ‹ Lock åˆ†è£‚/ç»§æ‰¿çš„æ—¶å€™ä¹Ÿä¼šçœ‹åˆ°ã€‚åœ¨ InnoDB çš„ Page ä¸Šï¼Œä¼šæœ‰ Infimum recordï¼ˆä¸‹ç¡®ç•Œï¼‰/ supremum recordï¼ˆä¸Šç¡®ç•Œï¼‰</li><li>GAP é”å®šçš„æ˜¯è®°å½•ä¹‹å‰çš„ GAP</li><li>InnoDB çš„å®ç°ä¸­ï¼Œèµ„æºåªæœ‰ä¸€ä¸ªç‚¹ï¼ˆç‰©ç†çš„ recordï¼‰ï¼Œä½†æ˜¯æœ‰ä¸åŒç§ç±»çš„æƒé™ï¼Œ<code>GAP</code>, <code>REC_NOT_GAP</code>, å’Œéƒ½æœ‰</li></ol><p>è¿™é‡Œçš„äº’æ–¥å…³ç³»å¦‚ä¸‹å›¾ï¼š</p><p><img src="https://image.mwish.me/blog-image/innodb-02.png" alt="innodb-02"></p><p>INTENTION_LOCK æ˜¯ä¸€ä¸ªå¾ˆæ¶å¿ƒçš„äº‹æƒ…ï¼Œè€ƒè™‘ä¸€ä¸ªäº‹å®ï¼Œåœ¨ InnoDB ç”³è¯·é”å¯èƒ½ä¼šåœ¨ Page ç›¸å…³çš„ç»“æ„ä¸Šåšä¸€äº›æ ‡è®°ï¼Œç„¶åç‰©ç†ä¸Šæ’å…¥è¿™è¡Œè®°å½•ã€‚åœ¨æ’å…¥çš„æ—¶å€™ï¼Œå®é™…ä¸Šçš„æµç¨‹å¦‚ä¸‹ï¼š</p><ol><li>Latching the page</li><li>æ‰¾åˆ°æ•°æ®å¯¹åº”çš„ä½ç½®ï¼ˆinnodb page å¯¹åº”çš„ç¨€ç–é“¾è¡¨ï¼‰</li><li>æ£€æŸ¥é”ï¼ˆä½†ä¸ä¸Šé”ï¼‰ï¼šthen latching the Lock System queue for the point to the right of insertion point and checking if there is any <strong>*,GAP</strong>, <strong>S</strong> or <strong>X</strong> lock.<ol><li>å¦‚æœæ²¡æœ‰å†²çªçš„é”ï¼Œç›´æ¥æ’å…¥è¿™æ¡è®°å½•ï¼Œç„¶åä¸ä¸Šé”ã€‚ä¾é è®°å½•çš„ txn æ ‡è®°æ¥è¯†åˆ«</li><li>æœ‰å†²çªçš„é”ï¼Œå°±å‘èµ·ä¸€æ¡ <code>INSERT_INTENTION</code> æäº¤åˆ°é”é˜Ÿåˆ—ä¸­</li></ol></li><li>å¦‚æœæ˜¯æœ‰é”çš„æƒ…å†µï¼ˆåŒ…æ‹¬è‡ªå·±çš„é”ï¼‰è¿™é‡Œä¼šéœ€è¦åšä¸€äº›é”ç»§æ‰¿ç›¸å…³çš„æ“ä½œã€‚å…·ä½“çš„ç»§æ‰¿ç»†èŠ‚åœ¨åé¢è®²ï¼Œè¿™é‡Œç®€å•è¯´å°±æ˜¯æ¯”å¦‚åŸå…ˆæ˜¯è‡ªå·±çš„ S é”ï¼Œç„¶åæ’å…¥ä¹‹åï¼ŒåŒºé—´ä»ä¸€ä¸ª gap è¢«æ‹†æˆæ–°çš„ä¸€æ¡è®°å½• + ä¸€ä¸ªæ–°çš„ gapã€‚è¿™ä¸ªåœ°æ–¹è¦æ³¨æ„é”ä¿ç•™æƒé™</li></ol><p>ä¸¾å®˜æ–¹åšå®¢çš„ä¾‹å­ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">BEGIN</span>;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"> </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> t <span class="keyword">FOR</span> SHARE;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">5</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">10</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">42</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+</span></span><br><span class="line"><span class="number">3</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"> </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">DELETE</span> <span class="keyword">FROM</span> t <span class="keyword">WHERE</span> id<span class="operator">=</span><span class="number">10</span>;</span><br><span class="line">Query OK, <span class="number">1</span> <span class="type">row</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"> </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">INSERT</span> <span class="keyword">INTO</span> t <span class="keyword">VALUES</span> (<span class="number">4</span>);</span><br><span class="line">Query OK, <span class="number">1</span> <span class="type">row</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"> </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SELECT</span> INDEX_NAME,LOCK_TYPE,LOCK_DATA,LOCK_MODE</span><br><span class="line">       <span class="keyword">FROM</span> performance_schema.data_locks <span class="keyword">WHERE</span> OBJECT_NAME<span class="operator">=</span><span class="string">&#x27;t&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------+-----------+------------------------+---------------+</span></span><br><span class="line"><span class="operator">|</span> INDEX_NAME <span class="operator">|</span> LOCK_TYPE <span class="operator">|</span> LOCK_DATA              <span class="operator">|</span> LOCK_MODE     <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------+-----------+------------------------+---------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">NULL</span>       <span class="operator">|</span> <span class="keyword">TABLE</span>     <span class="operator">|</span> <span class="keyword">NULL</span>                   <span class="operator">|</span> <span class="keyword">IS</span>            <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">PRIMARY</span>    <span class="operator">|</span> RECORD    <span class="operator">|</span> supremum pseudo<span class="operator">-</span>record <span class="operator">|</span> S             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">PRIMARY</span>    <span class="operator">|</span> RECORD    <span class="operator">|</span> <span class="number">5</span>                      <span class="operator">|</span> S             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">PRIMARY</span>    <span class="operator">|</span> RECORD    <span class="operator">|</span> <span class="number">10</span>                     <span class="operator">|</span> S             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">PRIMARY</span>    <span class="operator">|</span> RECORD    <span class="operator">|</span> <span class="number">42</span>                     <span class="operator">|</span> S             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">NULL</span>       <span class="operator">|</span> <span class="keyword">TABLE</span>     <span class="operator">|</span> <span class="keyword">NULL</span>                   <span class="operator">|</span> IX            <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">PRIMARY</span>    <span class="operator">|</span> RECORD    <span class="operator">|</span> <span class="number">10</span>                     <span class="operator">|</span> X,REC_NOT_GAP <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">PRIMARY</span>    <span class="operator">|</span> RECORD    <span class="operator">|</span> <span class="number">4</span>                      <span class="operator">|</span> S,GAP         <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------+-----------+------------------------+---------------+</span></span><br><span class="line"><span class="number">8</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><ol><li>SELECT çš„æ—¶å€™ï¼Œå…¨éƒ¨å¸¦ä¸Š S é”. è¿™ä¸ªåœ°æ–¹æ³¨æ„ supremum çš„é”ã€‚è¿™é‡Œä¹Ÿç”³è¯·äº†ä¸€ä¸ª IS çš„è¡¨é”</li><li>DELETE çš„æ—¶å€™ï¼Œç”Ÿæˆä¸€æ¡ X çš„åˆ é™¤é”</li><li>INSERT çš„æ—¶å€™ï¼Œæ²¡æœ‰ç”Ÿæˆé”ï¼Œå› ä¸ºæ²¡æœ‰å†²çª</li></ol><h3 id="Lock-Compression"><a href="#Lock-Compression" class="headerlink" title="Lock Compression"></a>Lock Compression</h3><p><code>performance_schema.data_locks</code> å¹¶ä¸æ˜¯ä¸€å¼ å…·ä½“çš„è¡¨ï¼Œè€Œæ˜¯ä» <code>&lt;space id, page no, heap no&gt;</code> æ¢å¤å‡ºæ¥çš„ã€‚é”åªæ˜¯ä¸€ä¸ªå†…å­˜ç»“æ„ã€‚</p><p>InnoDB åœ¨å†…å­˜ä¸­ä¼šæœ‰ä¸€ä¸ªå‹ç¼©ä½å›¾ï¼ŒHedengcheng Slide æœ‰ä¸€å¼ å¾ˆå¥½çš„å›¾ï¼š</p><p><img src="https://image.mwish.me/blog-image/1cfad4ec-a6fa-47e8-aab8-f5e8581f8ad3.png" alt="1cfad4ec-a6fa-47e8-aab8-f5e8581f8ad3"></p><p>è¿™é‡Œæˆ‘ä»¬æ³¨æ„åˆ°å‡ ä¸ªäº‹å®ï¼š</p><ol><li>ä¾èµ– <code>heap_no</code> æ¥ç»´æŠ¤ bitmap çš„å¤§å°å’Œå¯¹åº”çš„é¡ºåº</li><li>å¯èƒ½ç¬¬ä¸€æ¬¡ä¸Šé”çš„æ—¶å€™ä¼šç”³è¯·ä¸€ä¸ªæ¯”è¾ƒå¤§çš„ bitmapï¼Œåé¢ä¸Šé”å¼€å¼€é”€å°±ä¼šå‡å°ã€‚</li></ol><h3 id="Implicit-Lock"><a href="#Implicit-Lock" class="headerlink" title="Implicit Lock"></a>Implicit Lock</h3><p>è¿™å¨ä¸œè¥¿å’Œ implicit lock æœ‰ä»€ä¹ˆå…³ç³»å‘¢ï¼Ÿæœ‰ï¼Œimplicit lock å°±æ˜¯åœ¨è¿™ç§ç‹å…«è›‹æ—¶é—´çªç„¶å†’å‡ºæ¥çš„ã€‚è¿˜è®°å¾—æˆ‘ä»¬çš„æ’å…¥çš„æ—¶å€™ï¼Œå…¶å®ä¸€å¼€å§‹æ²¡æœ‰ INSERT_INTENTION é”å—ï¼Œæˆ‘ä¸¾ä¸ªè®©è¿™ä¸ªé”é£˜å‡ºæ¥çš„ä¾‹å­ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(client1) mysql<span class="operator">&gt;</span> <span class="keyword">INSERT</span> <span class="keyword">INTO</span> t <span class="keyword">VALUES</span> (<span class="number">4</span>);</span><br><span class="line">Query OK, <span class="number">1</span> <span class="type">row</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">(client2) mysql<span class="operator">&gt;</span> <span class="keyword">INSERT</span> <span class="keyword">INTO</span> t <span class="keyword">VALUES</span> (<span class="number">4</span>);</span><br><span class="line">Query OK, <span class="number">1</span> <span class="type">row</span> affected (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªåœ°æ–¹å¯èƒ½æœ¬æ¥çš„ä¼˜åŒ–ä¸­ï¼Œ client1 æ’å…¥åæ˜¯æ²¡æœ‰ä¸€æŠŠé”ï¼Œåœ¨ Delete ä¹‹åé”å°±å‡ºç°äº†. è¿™ç§<strong>å› ä¸ºä¼˜åŒ–å¯¼è‡´æš‚æ—¶ä¸å‡ºç°ï¼Œä½†æ˜¯ä½ å‘ç°é—®é¢˜çš„æ—¶å€™è¦æŸ¥å®ƒæ‰¾å†²çªçš„é”</strong>å«åš implicit lockã€‚åé¢åœ¨ Secondary Index ä¸€èŠ‚ï¼Œä¼šæœ‰æ¯”è¾ƒå¤šå†…å®¹ä»‹ç»è¿™ä¸ªã€‚</p><h3 id="Lock-Spliting"><a href="#Lock-Spliting" class="headerlink" title="Lock Spliting"></a>Lock Spliting</h3><p>åœ¨ç”³è¯·é”çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¸¸è§çš„æœ‰é”çš„å‡çº§ï¼ˆUpgradeï¼‰ï¼ŒåŒæ—¶ï¼Œåœ¨ InnoDB çš„ç»“æ„ä¸‹ï¼Œä¹Ÿä¼šæœ‰ä» A ç±»å‹çš„é”åˆ‡åˆ° B ç±»å‹é”çš„ Patternã€‚</p><p>è€ƒè™‘åˆ°å‡ ç§ Pattern:</p><ol><li>è¯»é”å‡çº§åˆ°å†™é”</li><li>ä» S|REC_NOT_GAP å‡çº§åˆ° S</li></ol><p>å¯¹äº (2) InnoDB åœ¨ç”³è¯·èµ„æºçš„æ—¶å€™ï¼Œä¼šæŒ‰ç…§é›†åˆåšå‡æ³•ï¼Œå°è¯•åª acquire <code>S - S|REC_NOT_GAP = S|GAP</code> çš„é”</p><h3 id="Btree-åˆ†è£‚å’Œé”ç»§æ‰¿"><a href="#Btree-åˆ†è£‚å’Œé”ç»§æ‰¿" class="headerlink" title="Btree åˆ†è£‚å’Œé”ç»§æ‰¿"></a>Btree åˆ†è£‚å’Œé”ç»§æ‰¿</h3><p>è¿™éƒ¨åˆ†çŸ¥è¯†åœ¨è¿™ç¯‡æ–‡ç« ä¸­å¾ˆè¯¦ç»†ï¼š<a href="http://mysql.taobao.org/monthly/2016/06/01/">http://mysql.taobao.org/monthly/2016/06/01/</a></p><p>ä¸ºä»€ä¹ˆåˆå¹¶ä¸éœ€è¦å‘¢ï¼Ÿç­”æ¡ˆæ˜¯ next-key locking æ˜¯çœŸçš„ä¼šæ‰¾åˆ°ä¸‹ä¸€ä¸ª key, ä½†æ˜¯è¿™ä¸ª Page å†…éƒ¨ä¹Ÿéœ€è¦è¡¨ç¤º ã€ŒPage å†…æœ€å¤§å·²ç»è¢«é”å®šã€ã€‚</p><p>è¿™é‡Œåœ¨ Page åˆ†è£‚çš„æ—¶å€™ï¼Œä¹Ÿè¦å¤„ç†å¯¹åº”çš„ GAP å’Œ Lockingã€‚</p><h3 id="Secondary-Index-amp-Implicit-Lock"><a href="#Secondary-Index-amp-Implicit-Lock" class="headerlink" title="Secondary Index &amp; Implicit Lock"></a>Secondary Index &amp; Implicit Lock</h3><p>Secondary Index å’Œ Lock ç»“åˆèµ·æ¥â€¦éå¸¸å¤æ‚ã€‚é¦–å…ˆè¦çŸ¥é“ï¼š</p><ol><li>Secondary Index Page ä¸Šä¹Ÿæ˜¯æœ‰é”å®šçš„</li><li>MVCC ä¸­ï¼ŒSecondary Index ä¼šä¿æœ‰æœ€æ–°çš„æ•°æ®ï¼Œè¿™é‡Œå¯èƒ½ä¼šå½±å“ ICP</li></ol><p>è¿™é‡Œå®˜æ–¹åšå®¢ä¸¾äº†ä¸ªéå¸¸å¥½çš„ä¾‹å­ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> point2D(</span><br><span class="line">  x <span class="type">INT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">PRIMARY</span> KEY,</span><br><span class="line">  y <span class="type">INT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">UNIQUE</span> </span><br><span class="line">);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> point2D (x,y) <span class="keyword">VALUES</span></span><br><span class="line">  (<span class="number">0</span>,<span class="number">3</span>),      </span><br><span class="line">        (<span class="number">1</span>,<span class="number">2</span>), </span><br><span class="line">                    (<span class="number">3</span>,<span class="number">1</span>),</span><br><span class="line">             (<span class="number">2</span>,<span class="number">0</span>);</span><br></pre></td></tr></table></figure><p>ç„¶åæŸ¥è¯¢ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">con1<span class="operator">&gt;</span> <span class="keyword">BEGIN</span>;</span><br><span class="line">con1<span class="operator">&gt;</span> <span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">FROM</span> point2D <span class="keyword">WHERE</span> y<span class="operator">=</span><span class="number">2</span> <span class="keyword">FOR</span> SHARE;</span><br><span class="line">con1<span class="operator">&gt;</span> <span class="keyword">SELECT</span> INDEX_NAME,LOCK_TYPE,LOCK_DATA,LOCK_MODE </span><br><span class="line">      <span class="keyword">FROM</span> performance_schema.data_locks <span class="keyword">WHERE</span> OBJECT_NAME<span class="operator">=</span><span class="string">&#x27;point2D&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------+-----------+-----------+---------------+</span></span><br><span class="line"><span class="operator">|</span> INDEX_NAME <span class="operator">|</span> LOCK_TYPE <span class="operator">|</span> LOCK_DATA <span class="operator">|</span> LOCK_MODE     <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------+-----------+-----------+---------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">NULL</span>       <span class="operator">|</span> <span class="keyword">TABLE</span>     <span class="operator">|</span> <span class="keyword">NULL</span>      <span class="operator">|</span> <span class="keyword">IS</span>            <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> y          <span class="operator">|</span> RECORD    <span class="operator">|</span> <span class="number">2</span>, <span class="number">1</span>      <span class="operator">|</span> S,REC_NOT_GAP <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------+-----------+-----------+---------------+</span></span><br></pre></td></tr></table></figure><p>è¿™ä¸ªé” <strong>éå¸¸ç¬¦åˆé¢„æœŸã€‚</strong>å›æ»šè¿™ä¸ªäº‹åŠ¡ï¼Œåˆ é™¤ x :</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">con1<span class="operator">&gt;</span> <span class="keyword">COMMIT</span>;</span><br><span class="line">con1<span class="operator">&gt;</span> <span class="keyword">BEGIN</span>;</span><br><span class="line">con1<span class="operator">&gt;</span> <span class="keyword">DELETE</span> <span class="keyword">FROM</span> point2D <span class="keyword">WHERE</span> x<span class="operator">=</span><span class="number">1</span>;</span><br><span class="line">con1<span class="operator">&gt;</span> <span class="keyword">SELECT</span> INDEX_NAME,LOCK_TYPE,LOCK_DATA,LOCK_MODE <span class="keyword">FROM</span> performance_schema.data_locks <span class="keyword">WHERE</span> OBJECT_NAME<span class="operator">=</span><span class="string">&#x27;point2D&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------+-----------+-----------+---------------+</span></span><br><span class="line"><span class="operator">|</span> INDEX_NAME <span class="operator">|</span> LOCK_TYPE <span class="operator">|</span> LOCK_DATA <span class="operator">|</span> LOCK_MODE     <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------+-----------+-----------+---------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">NULL</span>       <span class="operator">|</span> <span class="keyword">TABLE</span>     <span class="operator">|</span> <span class="keyword">NULL</span>      <span class="operator">|</span> IX            <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">PRIMARY</span>    <span class="operator">|</span> RECORD    <span class="operator">|</span> <span class="number">1</span>         <span class="operator">|</span> X,REC_NOT_GAP <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------+-----------+-----------+---------------+</span></span><br></pre></td></tr></table></figure><p>è¿™ä¸ªåœ°æ–¹è¡¨é¢ä¸Šä¹Ÿç¬¦åˆé¢„æœŸï¼Œä½†æ˜¯å›é¡¾ä¸€ä¸‹ï¼Œå¯¹åº”çš„ x/y å‘¢ï¼Ÿ</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">con2<span class="operator">&gt;</span> <span class="keyword">BEGIN</span>;</span><br><span class="line">con2<span class="operator">&gt;</span> <span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">FROM</span> point2D <span class="keyword">WHERE</span> y<span class="operator">=</span><span class="number">2</span> <span class="keyword">FOR</span> SHARE;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œ con2 å°± hang ä½äº†ï¼Œå†å» con1:</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">con1<span class="operator">&gt;</span> <span class="keyword">SELECT</span> ENGINE_TRANSACTION_ID trx_id,INDEX_NAME,LOCK_TYPE,LOCK_DATA,LOCK_MODE,LOCK_STATUS </span><br><span class="line">      <span class="keyword">FROM</span> performance_schema.data_locks <span class="keyword">WHERE</span> OBJECT_NAME<span class="operator">=</span><span class="string">&#x27;point2D&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+------------+-----------+-----------+---------------+-------------+</span></span><br><span class="line"><span class="operator">|</span>          trx_id <span class="operator">|</span> INDEX_NAME <span class="operator">|</span> LOCK_TYPE <span class="operator">|</span> LOCK_DATA <span class="operator">|</span> LOCK_MODE     <span class="operator">|</span> LOCK_STATUS <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+------------+-----------+-----------+---------------+-------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">283410363307272</span> <span class="operator">|</span> <span class="keyword">NULL</span>       <span class="operator">|</span> <span class="keyword">TABLE</span>     <span class="operator">|</span> <span class="keyword">NULL</span>      <span class="operator">|</span> <span class="keyword">IS</span>            <span class="operator">|</span> GRANTED     <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">283410363307272</span> <span class="operator">|</span> y          <span class="operator">|</span> RECORD    <span class="operator">|</span> <span class="number">2</span>, <span class="number">1</span>      <span class="operator">|</span> S             <span class="operator">|</span> WAITING     <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>            <span class="number">1560</span> <span class="operator">|</span> <span class="keyword">NULL</span>       <span class="operator">|</span> <span class="keyword">TABLE</span>     <span class="operator">|</span> <span class="keyword">NULL</span>      <span class="operator">|</span> IX            <span class="operator">|</span> GRANTED     <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>            <span class="number">1560</span> <span class="operator">|</span> <span class="keyword">PRIMARY</span>    <span class="operator">|</span> RECORD    <span class="operator">|</span> <span class="number">1</span>         <span class="operator">|</span> X,REC_NOT_GAP <span class="operator">|</span> GRANTED     <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>            <span class="number">1560</span> <span class="operator">|</span> y          <span class="operator">|</span> RECORD    <span class="operator">|</span> <span class="number">2</span>, <span class="number">1</span>      <span class="operator">|</span> X,REC_NOT_GAP <span class="operator">|</span> GRANTED     <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+------------+-----------+-----------+---------------+-------------+</span></span><br></pre></td></tr></table></figure><p>å¤šå‡ºæ¥äº† implicit lockï¼Œé‚ªæ¶å§ï¼è¿™é‡Œé€»è¾‘æµç¨‹å¦‚ä¸‹ï¼š</p><ol><li>InnoDB åˆ é™¤ä¼šæ¨é«˜ Page çš„æœ€å¤§ trx id</li><li>Secondary Index æŸ¥æ‰¾çš„æ—¶å€™æœ‰ä¸€ä¸ª read_viewï¼Œå‘ç° Page ä¸Šä¿®æ”¹çš„ trx å¤§ï¼ˆ <code>page_get_max_trx_id(page)</code>ï¼‰ï¼Œå°±è¦èµ°é€»è¾‘å»æŸ¥è¿™ä¸ª trx æ˜¯ä¸æ˜¯è¿˜æŒæœ‰é”ï¼š<a href="https://github.com/mysql/mysql-server/blob/a2f0879/storage/innobase/row/row0vers.cc#L536">row_vers_impl_x_locked</a></li><li>æŸ¥çœ‹æ˜¯å¦å†²çªï¼Œä¸Š implicit lock</li></ol><p>è¿™æ®µé€»è¾‘æ˜¯å¾ˆæ¸…æ™°çš„ï¼Œç°åœ¨è®©æˆ‘ä»¬è°ƒä¸ªä¸ªï¼Œçœ‹çœ‹å¦‚æœ å…ˆè¯» Secondary Indexï¼Œå†åˆ ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">con2<span class="operator">&gt;</span> <span class="keyword">BEGIN</span>;</span><br><span class="line">con2<span class="operator">&gt;</span> <span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">FROM</span> point2D <span class="keyword">WHERE</span> y<span class="operator">=</span><span class="number">2</span> <span class="keyword">FOR</span> SHARE;</span><br><span class="line"><span class="operator">+</span><span class="comment">----------+</span></span><br><span class="line"><span class="operator">|</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+</span></span><br><span class="line"><span class="operator">|</span>        <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+</span></span><br><span class="line"></span><br><span class="line">con1<span class="operator">&gt;</span> <span class="keyword">BEGIN</span>;</span><br><span class="line">con1<span class="operator">&gt;</span> <span class="keyword">DELETE</span> <span class="keyword">FROM</span> point2D <span class="keyword">WHERE</span> x<span class="operator">=</span><span class="number">1</span>;</span><br><span class="line">âŒ›</span><br></pre></td></tr></table></figure><p>con1 hang æ­»äº†ï¼Œè¿™ä¸ªæ—¶å€™ con2 æŸ¥é”ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator">&gt;</span> <span class="keyword">SELECT</span> ENGINE_TRANSACTION_ID trx_id,INDEX_NAME,LOCK_TYPE,LOCK_DATA,LOCK_MODE,LOCK_STATUS </span><br><span class="line">  <span class="keyword">FROM</span> performance_schema.data_locks <span class="keyword">WHERE</span> OBJECT_NAME<span class="operator">=</span><span class="string">&#x27;point2D&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+------------+-----------+-----------+---------------+-------------+</span></span><br><span class="line"><span class="operator">|</span> trx_id          <span class="operator">|</span> INDEX_NAME <span class="operator">|</span> LOCK_TYPE <span class="operator">|</span> LOCK_DATA <span class="operator">|</span> LOCK_MODE     <span class="operator">|</span> LOCK_STATUS <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+------------+-----------+-----------+---------------+-------------+</span></span><br><span class="line"><span class="operator">|</span>            <span class="number">2077</span> <span class="operator">|</span> <span class="keyword">NULL</span>       <span class="operator">|</span> <span class="keyword">TABLE</span>     <span class="operator">|</span> <span class="keyword">NULL</span>      <span class="operator">|</span> IX            <span class="operator">|</span> GRANTED     <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>            <span class="number">2077</span> <span class="operator">|</span> <span class="keyword">PRIMARY</span>    <span class="operator">|</span> RECORD    <span class="operator">|</span> <span class="number">1</span>         <span class="operator">|</span> X,REC_NOT_GAP <span class="operator">|</span> GRANTED     <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>            <span class="number">2077</span> <span class="operator">|</span> y          <span class="operator">|</span> RECORD    <span class="operator">|</span> <span class="number">2</span>, <span class="number">1</span>      <span class="operator">|</span> X,REC_NOT_GAP <span class="operator">|</span> WAITING     <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">283410363307272</span> <span class="operator">|</span> <span class="keyword">NULL</span>       <span class="operator">|</span> <span class="keyword">TABLE</span>     <span class="operator">|</span> <span class="keyword">NULL</span>      <span class="operator">|</span> <span class="keyword">IS</span>            <span class="operator">|</span> GRANTED     <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">283410363307272</span> <span class="operator">|</span> y          <span class="operator">|</span> RECORD    <span class="operator">|</span> <span class="number">2</span>, <span class="number">1</span>      <span class="operator">|</span> S,REC_NOT_GAP <span class="operator">|</span> GRANTED     <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+------------+-----------+-----------+---------------+-------------+</span></span><br></pre></td></tr></table></figure><p>è¿™ä¸ªåœ°æ–¹ï¼Œæˆ‘ä»¬ä¹‹å‰ Delete x æ²¡æœ‰åœ¨ y åŠ é”ï¼Œæ€ä¹ˆä¼šæ˜¯å‘¢ï¼Ÿç­”æ¡ˆæ˜¯è¿™é‡Œä¼šå°è¯•åœ¨ y ä¸ŠåŠ é”ï¼Œæ²¡æœ‰çš„è¯å°± implicit lock é‚£ç§æ¨¡å¼äº† ï¼ˆ <code>lock_sec_rec_modify_check_and_lock</code> ï¼‰</p><h3 id="å…³äº-MVCC-read-view-å’Œé”"><a href="#å…³äº-MVCC-read-view-å’Œé”" class="headerlink" title="å…³äº MVCC, read_view å’Œé”"></a>å…³äº MVCC, read_view å’Œé”</h3><p>å®é™…ä¸Šï¼Œä¹‹å‰æ¼”ç¤ºçš„éƒ¨åˆ†éƒ½ä¸Šé”äº†ã€‚read_view è¯»å–å…¶å®çœ‹éš”ç¦»çº§åˆ«ä¸ä¸€å®šä¼šä¸€ç›´æŒæœ‰é”ã€‚</p><p>æ¯”å¦‚ InnoDB çš„ semi-consistent read ï¼ˆ <a href="http://mysql.taobao.org/monthly/2018/11/04/">http://mysql.taobao.org/monthly/2018/11/04/</a> ) ã€‚ä¼šå°è¯•ç¬¬ä¸€æ¬¡ä¸ä¸Šé”ï¼Œç›´æ¥è¯» Undo Chainã€‚</p><h3 id="æ’å…¥å’Œå·²ç»å­˜åœ¨çš„è®°å½•"><a href="#æ’å…¥å’Œå·²ç»å­˜åœ¨çš„è®°å½•" class="headerlink" title="æ’å…¥å’Œå·²ç»å­˜åœ¨çš„è®°å½•"></a>æ’å…¥å’Œå·²ç»å­˜åœ¨çš„è®°å½•</h3><p>å¦‚æœå‘ç°å·²ç»å­˜åœ¨çš„è®°å½•ï¼š</p><blockquote><p>é€šå¸¸INSERTæ“ä½œæ˜¯ä¸åŠ é”çš„ï¼Œä½†å¦‚æœåœ¨æ’å…¥æˆ–æ›´æ–°è®°å½•æ—¶ï¼Œæ£€æŸ¥åˆ° duplicate keyï¼ˆæˆ–è€…æœ‰ä¸€ä¸ªè¢«æ ‡è®°åˆ é™¤çš„duplicate keyï¼‰ï¼Œå¯¹äºæ™®é€šçš„INSERT/UPDATEï¼Œä¼šåŠ LOCK_Sé”ï¼Œè€Œå¯¹äºç±»ä¼¼REPLACE INTOæˆ–è€…INSERT â€¦ ON DUPLICATEè¿™æ ·çš„SQLåŠ çš„æ˜¯Xé”ã€‚è€Œé’ˆå¯¹ä¸åŒçš„ç´¢å¼•ç±»å‹ä¹Ÿæœ‰æ‰€ä¸åŒï¼š</p><ul><li>å¯¹äºèšé›†ç´¢å¼•ï¼ˆå‚é˜…å‡½æ•°<code>row_ins_duplicate_error_in_clust</code>ï¼‰ï¼Œéš”ç¦»çº§åˆ«å°äºç­‰äºRCæ—¶ï¼ŒåŠ çš„æ˜¯<code>LOCK_REC_NOT_GAP</code>ç±»ä¼¼çš„Sæˆ–è€…Xè®°å½•é”ã€‚å¦åˆ™åŠ <code>LOCK_ORDINARY</code>ç±»å‹çš„è®°å½•é”ï¼ˆNEXT-KEY LOCKï¼‰ï¼›</li><li>å¯¹äºäºŒçº§å”¯ä¸€ç´¢å¼•ï¼Œè‹¥æ£€æŸ¥åˆ°é‡å¤é”®ï¼Œå½“å‰ç‰ˆæœ¬æ€»æ˜¯åŠ  LOCK_ORDINARY ç±»å‹çš„è®°å½•é”(å‡½æ•° <code>row_ins_scan_sec_index_for_duplicate</code>)ã€‚å®é™…ä¸ŠæŒ‰ç…§RCçš„è®¾è®¡ç†å¿µï¼Œä¸åº”è¯¥åŠ GAPé”ï¼ˆ<a href="http://bugs.mysql.com/bug.php?id=68021">bug#68021</a>ï¼‰ï¼Œå®˜æ–¹ä¹Ÿäº‹å®ä¸Šå°è¯•ä¿®å¤è¿‡ä¸€æ¬¡ï¼Œå³å¯¹äºRCéš”ç¦»çº§åˆ«åŠ ä¸Š<code>LOCK_REC_NOT_GAP</code>ï¼Œä½†å´å¼•å…¥äº†å¦å¤–ä¸€ä¸ªé—®é¢˜ï¼Œå¯¼è‡´äºŒçº§ç´¢å¼•çš„å”¯ä¸€çº¦æŸå¤±æ•ˆ(<a href="http://bugs.mysql.com/bug.php?id=73170">bug#73170</a>)ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥å‚é˜…æˆ‘å†™çš„<a href="http://mysqllover.com/?p=1041">è¿™ç¯‡åšå®¢</a>ï¼Œç”±äºè¿™ä¸ªä¸¥é‡bugï¼Œå®˜æ–¹å¾ˆå¿«åˆæŠŠè¿™ä¸ªfixç»™revertæ‰äº†ã€‚</li></ul></blockquote><p>æ‘˜è‡ªï¼š<a href="http://mysql.taobao.org/monthly/2016/01/01/">http://mysql.taobao.org/monthly/2016/01/01/</a> . ä½ æˆ–è®¸ä¼šå‘ç°ï¼Œè¿™é‡Œä¸Šçš„æ˜¯<strong>æ•°æ®é”</strong>ï¼Œè€Œä¸æ˜¯æ„å‘é”ã€‚è¿™é‡ŒåŸå› ä»£ç è¯´çš„æ¯”è¾ƒæ¸…æ™°ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">lock_type = ((trx-&gt;isolation_level &lt;= TRX_ISO_READ_COMMITTED) ||</span><br><span class="line">             (cursor-&gt;index-&gt;table-&gt;<span class="built_in">skip_gap_locks</span>()))</span><br><span class="line">                ? LOCK_REC_NOT_GAP</span><br><span class="line">                : LOCK_ORDINARY;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* We set a lock on the possible duplicate: this</span></span><br><span class="line"><span class="comment">is needed in logical logging of MySQL to make</span></span><br><span class="line"><span class="comment">sure that in roll-forward we get the same duplicate</span></span><br><span class="line"><span class="comment">errors as in original execution */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (flags &amp; BTR_NO_LOCKING_FLAG) &#123;</span><br><span class="line">  <span class="comment">/* Do nothing if no-locking is set */</span></span><br><span class="line">  err = DB_SUCCESS;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (trx-&gt;duplicates) &#123;</span><br><span class="line">  <span class="comment">/* If the SQL-query will update or replace</span></span><br><span class="line"><span class="comment">  duplicate key we will take X-lock for</span></span><br><span class="line"><span class="comment">  duplicates ( REPLACE, LOAD DATAFILE REPLACE,</span></span><br><span class="line"><span class="comment">  INSERT ON DUPLICATE KEY UPDATE). */</span></span><br><span class="line"></span><br><span class="line">  err =</span><br><span class="line">      <span class="built_in">row_ins_set_exclusive_rec_lock</span>(lock_type, <span class="built_in">btr_cur_get_block</span>(cursor),</span><br><span class="line">                                     rec, cursor-&gt;index, offsets, thr);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  err = <span class="built_in">row_ins_set_shared_rec_lock</span>(lock_type, <span class="built_in">btr_cur_get_block</span>(cursor),</span><br><span class="line">                                    rec, cursor-&gt;index, offsets, thr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>æ„Ÿè§‰å’Œè°“è¯é”æœ‰å…³ï¼Œå±äºè¯»å†™è”åˆæœºåˆ¶ã€‚</p><h2 id="Not-in-this-article"><a href="#Not-in-this-article" class="headerlink" title="Not in this article"></a>Not in this article</h2><p>ä¸‹ç¯‡æ–‡ç« è¿™é‡Œéœ€è¦ä»‹ç» InnoDB çš„ 8.0.18 æ–°çš„æ­»é”æ£€æµ‹ç®—æ³•ã€è°ƒåº¦ï¼Œè¿˜æœ‰ 8.0.21 çš„å¹¶å‘é˜Ÿåˆ—å’Œé”æ‹†åˆ†.</p><h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><ul><li><a href="https://dev.mysql.com/doc/refman/8.0/en/internal-locking.html">https://dev.mysql.com/doc/refman/8.0/en/internal-locking.html</a></li><li><a href="https://dev.mysql.com/blog-archive/innodb-data-locking-part-2-locks/">https://dev.mysql.com/blog-archive/innodb-data-locking-part-2-locks/</a> è¿™ä¸€ç³»åˆ—çš„æ–‡ç« </li><li>InnoDB äº‹åŠ¡é”æºç åˆ†æ - å®‹æ˜­çš„æ–‡ç«  - çŸ¥ä¹ <a href="https://zhuanlan.zhihu.com/p/412358771">https://zhuanlan.zhihu.com/p/412358771</a></li><li>MySQL å¼•æ“ç‰¹æ€§-æ­»é”æ£€æµ‹ <a href="http://mysql.taobao.org/monthly/2021/05/02/">http://mysql.taobao.org/monthly/2021/05/02/</a></li><li>MySQL Â· å¼•æ“ç‰¹æ€§ Â· InnoDB äº‹åŠ¡é”ç³»ç»Ÿç®€ä»‹ <a href="http://mysql.taobao.org/monthly/2016/01/01/">http://mysql.taobao.org/monthly/2016/01/01/</a></li></ul>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Apache Iceberg and changes above Hive</title>
      <link href="/2023/03/19/Apache-Iceberg-and-changes-above-Hive/"/>
      <url>/2023/03/19/Apache-Iceberg-and-changes-above-Hive/</url>
      
        <content type="html"><![CDATA[<p>å½“æˆ‘ä»¬è¯´ä¸€ä¸ªä¸œè¥¿æ˜¯å±å±±çš„æ—¶å€™ï¼Œå®ƒæœ€å¥½çœŸçš„ä¸æ˜¯â€¦ã€Œå¤§æ•°æ®ã€è¿™ä¸ªè¯åœ¨å¾ˆé•¿ä¸€æ®µæ—¶é—´äº‹å®æ ‡å‡†å°±æ˜¯ Apache Hadoop ä¸‹é‚£å †ä¸œè¥¿ï¼Œå› ä¸ºå†å²åŸå› ï¼Œå¾ˆå¤šä¸œè¥¿å®é™…ä¸Šåœ¨ Hive / Spark ä¹‹ç±»çš„ä¸œè¥¿ä¸Šæœ‰ä¸€å¥—å®ç°å’Œåè¯ï¼Œè¿™å¥—åè¯æœ¬èº«å¯èƒ½æ¯”è¾ƒè‰å°ç­å­ï¼šæ¯”å¦‚ Bucket / Partition è¿™äº›ä¸œè¥¿ï¼Œåœ¨å„ä¸ªç³»ç»Ÿæœ‰ä¸åŒçš„å«æ³•ï¼Œæœ‰çš„ä¸œè¥¿å¯èƒ½ç›´æ¥å’Œåˆ«çš„ç³»ç»Ÿå¯¹åº”â€¦</p><p>ä½ ä¸€å®šæƒ³é—®è¿™äº›ä¸œè¥¿å’Œ iceberg æœ‰ä»€ä¹ˆå…³ç³»äº†ï¼Œç­”æ¡ˆæ˜¯æ¯æ¯ç›¸å…³ã€‚Iceberg æœ¬èº«å°±æ˜¯ä¸€å¸®äººå—ä¸äº† Hive æŠ˜ç£¨æå‡ºæ¥çš„ï¼Œåœ¨æ–‡æ¡£é‡Œä¸‰æ­¥ä¸€æ Hiveï¼Œå…³ç³»æ¯”äº²çˆ¹è¿˜äº²ï¼Œç„¶å Iceberg åˆåªæ˜¯ä¸€ä¸ª table formatã€‚è¿™å¯¼è‡´äº†å‡ ä¸ªåæœï¼š</p><ol><li>åœ¨ä»‹ç» Iceberg çš„æ—¶å€™ï¼Œä¼šä¸æ–­ä»‹ç» Hive ä¹‹å‰çš„è®¾è®¡ä¸ºä»€ä¹ˆå¯¼è‡´äº† Iceberg ä¼šè¿™ä¹ˆåšâ€¦è¿™å¯¼è‡´å…¶å®ä½ å¾—å¯¹ Hive æœ‰ä¸ªåŸºæœ¬çš„è®¤çŸ¥ã€‚å¦ˆçš„ï¼Œæˆ‘ä¸ºå•¥è¦å¯¹è¿™ç§è€è‰å°ç³»ç»Ÿæœ‰è®¤çŸ¥â€¦</li><li>Iceberg åªæ˜¯ä¸€ä¸ª Table formatï¼Œå®ƒæœ‰çš„æ—¶å€™ç”šè‡³ä¼šè·‘åœ¨ HMS ä¸Šã€‚åŒæ—¶ï¼ŒIceberg å¾ˆå¤šæ—¶å€™åªè¯´æ˜äº†ã€Œéœ€è¦è¿™ä¹ˆåšã€ï¼Œå®ç°è¡Œä¸ºè¿˜æ˜¯è¦è‡ªå·±å†³å®šçš„ï¼Œæ‰€ä»¥å¾ˆå¤šæ—¶å€™å®ç°è¡Œä¸ºæ˜¯å„å®¶ä¸€å¨å±ï¼Œe.g:<ol><li>Spark Partition: <a href="https://iceberg.apache.org/docs/latest/spark-writes/">https://iceberg.apache.org/docs/latest/spark-writes/</a></li><li>Hive Partition: <a href="https://iceberg.apache.org/docs/latest/hive/">https://iceberg.apache.org/docs/latest/hive/</a></li></ol></li></ol><p>æˆ‘ä»¬è¿™é‡Œä¼šä»‹ç»ä¸€ä¸‹ Hive å’Œ iceberg formatï¼Œè¿™ä¸ªæ–‡æ¡£ä¼šæŒç»­æ›´æ–°ï¼Œå› ä¸ºç¬”è€…å¯èƒ½è®¤çŸ¥ä¹Ÿæ˜¯ä¼šæ›´æ–°çš„ã€‚ç„¶åä¹Ÿä¼šç®€å•ä»‹ç»ä¸€ä¸‹ Snowflakeã€StarRocks çš„è¡Œä¸ºæ˜¯æ€ä¹ˆå…¼å®¹ iceberg çš„ã€‚</p><h2 id="æ‰€è°“æ•°æ®æ¹–"><a href="#æ‰€è°“æ•°æ®æ¹–" class="headerlink" title="æ‰€è°“æ•°æ®æ¹–"></a>æ‰€è°“æ•°æ®æ¹–</h2><p>ä¼—æ‰€å‘¨çŸ¥ï¼ŒHive æœ¬èº«çš„è®¾è®¡ä¸­ï¼Œå­˜å‚¨ Partition ä»¥ç›®å½•çš„å½¢å¼ï¼Œè€Œå­˜å‚¨ Bucket ä»¥ç›®å½•ä¸‹æ–‡ä»¶çš„å½¢å¼å­˜æ”¾ã€‚è¿™æ · Partition è£å‰ªï¼ŒBucket Join ä¹‹ç±»çš„æ“ä½œæœ¬èº«æ˜¯å¾ˆæ­£å¸¸çš„ï¼Œä½†æ˜¯åœ¨ Hive æŸ¥è¯¢çš„æ—¶å€™ï¼Œå¯¹è¶…å¤§è¡¨ä¼šæœ‰ä¸€äº›å¾ˆå¥‡æ€ªçš„é—®é¢˜ã€‚æ¯”å¦‚ Meta ä¿¡æ¯æ‹¿åˆ°åˆ†åŒºä¹‹å List è¿‡æ…¢ã€å¯¹ Underlying NameNode çš„ä¾èµ–ç­‰ã€‚å¾ˆè‡ªç„¶çš„ï¼Œè¿™å¥—ä¸œè¥¿è¿˜å¯ä»¥ç§»åŠ¨åˆ° S3 ä¹‹ç±»çš„å­˜å‚¨ä¸Šï¼Œä½†æ˜¯ S3 ä¹‹ç±»çš„å­˜å‚¨ä¹Ÿæœ‰é—®é¢˜ã€‚</p><p>Apache Iceberg åä¹‰ä¸Šå®šä½å…¶å®å¾ˆä½ï¼Œå®ƒå®šä½ä¸ºå¯¹ OSS ä¹‹ç±»çš„å­˜å‚¨æ¯”è¾ƒå‹å¥½çš„ Table Formatï¼Œå®ƒè¡¨å±‚é¢çš„ RFC å˜åŠ¨ç›¸å½“å…‹åˆ¶ï¼Œå¸¦æ¥äº†ä¸€äº›æ ¼å¼å…¼å®¹æ€§ã€‚ç»§æ‰¿äº†ä¸€äº› Hive æ¯”è¾ƒå¥½çš„åœ°æ–¹ï¼Œæ¯”å¦‚å“ªä¸ªå‚»å¤§ä¸ªéƒ½å¯ä»¥å¾€é‡Œå†™ï¼ŒåŒæ—¶åœ¨ Partition / Bucket / Schema ç­‰æ–¹å‘ä¸Šåšå‡ºäº†æ¼”è¿›æˆ–è€…é™åˆ¶ï¼Œå¸¦æ¥äº†æ¯”è¾ƒç»†è‡´çš„æ¼”è¿›æ–¹å¼ã€‚</p><p>Iceberg ç»å¸¸å’Œã€Œæ•°æ®æ¹–ã€è¿™ä¸ªè¯ä¸€èµ·è¢«æèµ·ï¼Œè€Œä¸æ˜¯æˆ‘ä»¬ä¹‹å‰è¯´çš„ Table Formatã€‚è¿™ä¸ªè¯æ›´å¤šæ˜¯ä¸ªå®£ä¼ ç”¨è¯ï¼ŒæŒ‰æˆ‘ä¹‹å‰çš„ç†è§£ï¼ˆ <a href="https://blog.mwish.me/2022/05/01/Delta-Lake-Lakehouse/">https://blog.mwish.me/2022/05/01/Delta-Lake-Lakehouse/</a> ï¼‰ï¼ŒData Lake æ„å‘³ç€ï¼š</p><ol><li>ACID çš„èƒ½åŠ›ï¼Œé˜²æ­¢ Job è·‘åˆ°ä¸€åŠæŒ‚äº†åˆæ²¡æ³•å¤„ç†</li><li>æŸ”æ€§çš„ Schema</li><li>Streaming ç­‰æ¥å£</li><li>SQL ç›¸å…³çš„ Pruningï¼ŒMin-Max</li><li>å¯¹åº”çš„ Format Compaction / Auto-Clusteringï¼ŒåŒ…æ‹¬ z-ordering</li></ol><p>è¿‡äº†ä¸€å¹´å¤šï¼Œå›é¡¾è¿™ä¸ªç»“è®ºï¼Œç¡®å®æ˜¯æˆ‘å½“æ—¶ç»“è®ºé—®é¢˜æ²¡é‚£ä¹ˆå¤§ï¼Œä½†æ˜¯è¿™äº›æ˜¯æ ¸å¿ƒè¯­ä¹‰å—ï¼Ÿå…¶å®å›å¤´æ¥æƒ³ï¼ŒApache Iceberg ä¸æ˜¯ä¸€ä¸ªå¾ˆ Fancy çš„ä¸œè¥¿ï¼Œä½†å´æ˜¯ä¸€ä¸ªå¾ˆå¯æ€•çš„ä¸œè¥¿ï¼Œæ–°çš„æ•°æ®æ¹–äº§å“ï¼Œåƒ Snowflakeï¼ŒStarRocksï¼Œ Doris è¿™äº›äº§å“ï¼Œéƒ½å¼€å§‹å…¼å®¹äº† Apache Iceberg åè®®ã€‚ç„¶å DeltaLake æ„Ÿè§‰åœ¨è·¯å­ä¸Šæ˜¯æ›´åŠ é å‰çš„äº§å“ï¼Œä½†æ˜¯åœ¨ Apache Iceberg çš„ã€Œæ”»åŠ¿ã€ä¸‹ä¹Ÿå¼€å§‹éƒ¨åˆ†å¼€æºäº†ï¼ˆç¬‘ï¼‰ã€‚</p><p>æ‰€ä»¥å›è¿‡å¤´æ¥ï¼Œä¹Ÿç»“åˆç½‘æ˜“é‚£å‡ ç¯‡æ–‡ç« çš„ç†è§£ï¼š</p><ul><li>ä» Hive è¿™æ¡è·¯çº¿çš„æ¼”è¿›ï¼Œçœ‹ Apache Iceberg æ˜¯ä¸€ä¸ª Table Formatï¼Œå®ƒæŠŠè¡¨ç»“æ„ï¼ˆè¡¨ï¼ŒBucketï¼Œåˆ†åŒºï¼‰æŠ½ç¦»äº†ç‰©ç†çš„ Layoutï¼Œä»ç›®å½•çš„éƒ¨åˆ†ä¾èµ–èµ°åˆ°äº†è‡ªå·±æ‹†åˆ†å‡ºä¸€å±‚é€»è¾‘çš„ Manifest å±‚ã€‚åŒæ—¶ï¼Œä¹Ÿåšäº†ä¸€äº›å¯¹åŸå­ ACID ä¹‹ç±»çš„æ”¯æŒï¼ˆå’Œéƒ¨åˆ†åå¯¹è€…è¯´çš„ä¸å®Œå…¨ä¸€æ ·ï¼ŒHive ä¹Ÿæ”¯æŒ ACIDï¼Œä¸è¿‡æŠ˜è…¾çš„å¾ˆåˆ«æ‰­ï¼Œè€Œè¿™åœ¨ Apache Iceberg ä¸­å¸ˆä¸€ç­‰å…¬æ°‘ï¼‰</li><li>Delta ä¹Ÿç±»ä¼¼ï¼Œæ‹†åˆ†å‡ºä¸€å¥—æ—¥å¿—å±‚ï¼ˆç”šè‡³ä¾èµ– DynamoDBï¼‰æ¥åšæäº¤</li></ul><p>ä½†æ˜¯ï¼Œä»å¤–éƒ¨ç”¨æˆ·çš„è§†è§’æ¥ç†è§£ï¼š</p><ul><li>å¼•æ“å¹³æƒï¼ŒApache Iceberg æ˜¯ä¸€å¥—æ ‡å‡†ï¼Œç”¨æˆ·å¯ä»¥å°½é‡ä¸ Lock-In åœ¨æŸä¸ªç³»ç»Ÿä¸­ï¼ˆè€Œå¼•æ“å½“ç„¶å·´ä¸å¾—ä½  Lock-Inï¼‰ï¼ŒåŒ…æ‹¬çŒ«çŒ«ç‹—ç‹—éƒ½å¯ä»¥æ¥æ ¹æ®è¿™ä¸ª Format å»è¯» / å†™å¯¹åº”çš„ç»“æ„ï¼Œå†™å…¥çš„æ•°æ®ä¹Ÿå¯ä»¥æ˜¯å…·ä½“å®ç°æ— å…³ï¼ˆParquetï¼ŒAvroï¼Œâ€¦ï¼‰ç›¸å½“äºè‡ªèº«çš„ç»“æ„æ˜¯å¼€æ”¾çš„ã€‚</li><li>å†™å…¥æ•°æ®å’Œ Schema å¾ˆæ–¹ä¾¿ï¼ŒåŒ…æ‹¬å¾ˆå¤šæƒ…å†µä¸‹ï¼Œå¯¼å…¥æ•°æ® - åŠ åˆ— ä¹‹åï¼Œæ•°æ®ç¬¦åˆæŸç§æ ‡å‡†ã€‚åŒæ—¶ï¼Œæ•°æ®åªè¦ç¬¦åˆæŸç§ Schema å³å¯ï¼ˆApache Iceberg å…è®¸ Avroï¼ŒParquetï¼ŒOrc ç­‰å¤šç§æ•°æ®ï¼‰</li><li>ACIDï¼Œè¿™é‡Œå¹¶ä¸åŒäº TP æ•°æ®åº“çš„å¿«é€Ÿå°äº‹åŠ¡ï¼Œè¿™é‡Œæ›´å¤šæ˜¯è¦æ±‚ abortable / éš”ç¦»æ€§ è¿™æ ·çš„éœ€æ±‚ã€‚æˆ‘åœ¨ä¹‹å‰å…¶å®æ˜¯åˆ—äº† Streaming éœ€æ±‚çš„ï¼Œä½†æ˜¯å…¶å®è¿™ä¸ªå°±ç±»ä¼¼ AP æµ‹å‘ TP æµ‹é æ‹¢ï¼Œå±äºå¤§å®¶å´æ˜¯ä¸æ¸…æ¥šè¿™ä¸ªåšäº†æ˜¯ä¸æ˜¯çœŸçš„æœ‰æ”¶ç›Šçš„ç¯èŠ‚äº†ã€‚</li><li>CDCï¼Ÿå…¶å®æˆ‘å¹¶ä¸çŸ¥é“æ˜¯ä¸æ˜¯ç”¨æˆ·çœŸçš„éœ€è¦ CDC ä¹‹ç±»çš„éœ€æ±‚ï¼Œä½†æ˜¯æŸç§æ„ä¹‰ä¸Šï¼ˆå»æ‰ Compactionï¼‰å¾ˆå¤šåœºæ™¯åš CDC ç¡®å®æ˜¯éå¸¸è‡ªç„¶çš„åœºæ™¯äº†ã€‚</li></ul><p>ï¼ˆOptimize å’Œ Compaction æ„Ÿè§‰å¾ˆå¿…è¦ï¼Œä½†æ˜¯æš‚æ—¶ä¸åœ¨åˆ—ï¼‰</p><p>è¿™ä¸ªæ—¶å€™ä½ å°±ä¼šå‘ç°ï¼Œæœ‰çš„ä¸œè¥¿ç¡®å®æ˜¯ Hive æœ‰çš„ï¼Œä½†æ˜¯å®ƒæŒ‡å‘äº†ä¸€ä¸ªæ›´æ··æ²Œå¼€æ”¾çš„é¢†åŸŸã€‚å’Œæˆ‘ä¹‹å‰ç†è§£ä¸å®Œå…¨ä¸€æ ·çš„æ˜¯ï¼Œè¿™é‡Œç¡®å®è¦æœ‰ä¸€äº› Schema é™åˆ¶ï¼Œä½†å¹¶ä¸æ˜¯æ•´ä½“ Enforce æŸä¸ª Schemaï¼Œè€Œæ˜¯ä¸€äº›è¯»æ—¶æ¨¡å¼ + åˆ—å˜æ¢çš„é™åˆ¶ã€‚</p><p>ä»Šå¤©å°±ç®€å•ä»‹ç»ä¸€ä¸‹ Apache Iceberg çš„ Spec</p><h2 id="Hive-çš„ç¼ºé™·"><a href="#Hive-çš„ç¼ºé™·" class="headerlink" title="Hive çš„ç¼ºé™·"></a>Hive çš„ç¼ºé™·</h2><p>Hive å¯èƒ½ç°åœ¨ä¸æ€ä¹ˆç”¨äº†ï¼Œä½†æ˜¯ Hive çš„è¡¨ç»“æ„è¿˜æ˜¯æ•°æ®çš„äº‹å®æ ‡å‡†ã€‚åœ¨è¿™ä¸ªä¸–ç•Œè¿˜é’æ˜¥çš„æ—¶å€™ï¼ŒSpark çš„ Core æœ¬èº«ä½œä¸ºä¸€å¥—è®¡ç®—çš„é€»è¾‘ç»´æŠ¤ RDDã€‚ä¹‹åæ„Ÿè§‰å¾ˆå¤šå¼•æ“æ¨è¿›çš„éƒ½æ˜¯è®¡ç®—ä¸Šçš„æ–¹å¼ï¼Œè€Œå­˜å‚¨çš„æ–¹å¼å¾ˆå¤šè¿˜æ˜¯åœ¨ Hive ä¸Šæˆ–è€…è‡ªå·±å»æ Share nothingã€‚Hive åœ¨å¾ˆé•¿ä¸€æ®µæ—¶é—´è‡³å°‘åœ¨è¡¨ç»“æ„ä¸Šè¿˜æ˜¯ de-facto çš„ä¸»å¯¼è€…ã€‚Hive Table Format å¦‚ä¸‹ï¼š</p><p><img src="https://image.mwish.me/blog-image/iceberg-01.png" alt="iceberg-01"></p><p>ç„¶è€Œï¼Œè¿™é‡Œåˆ—å‡ºæ¥ä¸€äº›ç¼ºç‚¹ï¼š</p><ul><li>Hive ACID é€šè¿‡ fs rename æ¥å®ç°ã€‚åœ¨ POSIX ä¸Šï¼Œrename å¯ä»¥æ˜¯åŸå­çš„ã€‚ç„¶è€Œ S3: ?</li><li>æ²¡æœ‰ WAL ä¹‹ç±»çš„æ–¹å¼ï¼Œæ— æ³•åŸå­æ€§å†™å¤šä¸ª Partition</li><li>æ— æ³•å¯¹å¤šä¸ªå†™åŒä¸€ä¸ª Partition çš„ Txn ä½œå‡ºä»€ä¹ˆé™åˆ¶</li><li>éœ€è¦ä¾èµ– <code>List</code>ï¼Œå¯èƒ½ä¼šå¼€é”€å¾ˆé•¿çš„æ—¶é—´ ï¼ˆåˆ†åŒºå¤šæˆ–è€…åˆ†åŒºçš„æ–‡ä»¶å¤šéƒ½ä¼šåŠ é‡è¿™ä¸ªé—®é¢˜ï¼Œè€Œä¸” S3 çš„ List æœ¬èº«å°±å¾ˆæ˜‚è´µï¼Œè§ <a href="https://www.youtube.com/watch?t=138&amp;v=nWwQMlrjhy0&amp;feature=youtu.be">https://www.youtube.com/watch?t=138&amp;v=nWwQMlrjhy0&amp;feature=youtu.be</a> ï¼‰</li><li>ç”¨æˆ·éœ€è¦æ‰‹åŠ¨å†™åˆ†åŒºï¼Œå› ä¸ºåœ¨ Hive ä¸­ï¼Œ<strong>åˆ†åŒºåˆ—å¹¶ä¸æ˜¯è¡¨æ•°æ®çš„ä¸€éƒ¨åˆ†</strong>ï¼Œè¦æ‰‹åŠ¨å†™å¯¹åº”çš„åˆ†åŒºä¿¡æ¯</li><li>Hive çš„ Table Statistics å¸¸å¸¸å¹¶ä¸å‡†ç¡®ï¼ˆæ˜¾ç„¶æ•°æ®åº“éƒ½ä¸é‚£ä¹ˆå‡†ç¡®ï¼Ÿï¼‰</li><li>åœ¨ OSS ä¸­ï¼ŒHive çš„è·¯å¾„ <code>/path/to/table/partition_column=partition_value</code> é™åˆ¶äº†ç‰©ç†è·¯å¾„çš„æ‰“æ•£èƒ½åŠ›ï¼Œå¯¼è‡´å¯èƒ½è½åœ¨å‡ ä¸ªå›ºå®šçš„èŠ‚ç‚¹ä¸Šï¼Œé€ æˆä¸€å®šçš„æ€§èƒ½é—®é¢˜ã€‚ï¼ˆæœ¬è´¨ä¸Šè¿˜æ˜¯å¯¹ç‰©ç†è·¯å¾„çš„ä¾èµ–ï¼Ÿï¼‰</li></ul><p><img src="https://image.mwish.me/blog-image/iceberg-02.png" alt="iceberg-02"></p><h2 id="Iceberg"><a href="#Iceberg" class="headerlink" title="Iceberg"></a>Iceberg</h2><p>Netflix æäº†ä¸€å¥—æ–°çš„ Table Format: Icebergï¼Œä¸»å¯¼è€… Ryan Blue éšåä¹Ÿåˆ›å»ºäº†å…¬å¸ã€‚</p><p>Netflix çš„æ€è·¯æ˜¯ï¼Œå‘ç° Table format å’Œ fs ç›®å½•çš„ç‰©ç†ç»“æ„æ˜¯å®Œå…¨ç»‘å®šçš„ï¼Œå®ƒä»¬çš„ç®€å•è®¾è®¡æ˜¯ï¼š</p><ul><li>æŠ½ç¦»è¿™ä¸ª<strong>ç‰©ç†</strong> Directory çš„å±‚æ¬¡ï¼Œé€ äº†ä¸€ä¸ªé€»è¾‘çš„ Directory</li><li>Track æ–‡ä»¶å’Œæ–‡ä»¶çš„å˜æ›´</li><li>ç”¨è¿™å¥— Track æœºåˆ¶åšäº†ä¸€å¥—æ–‡ä»¶å±‚é¢çš„ MVCC</li><li>æŠŠ Partition æœºåˆ¶èåˆè¿›æ•°æ®ä¸­</li></ul><p><img src="https://image.mwish.me/blog-image/iceberg-03.png" alt="iceberg-03"></p><p>Iceberg æŠ½è±¡äº†ä¸€å¥—å¤šå±‚çš„æ¶æ„ï¼š</p><p><img src="https://image.mwish.me/blog-image/iceberg-04.png" alt="iceberg-04"></p><p>æ˜¾ç„¶ï¼Œä¸­é—´å±‚æ˜¯ iceberg çš„æ ¸å¿ƒï¼Œä½†æˆ‘ä»¬æœ€åä»‹ç»ï¼š</p><ol><li>Data layer: ç”¨æˆ·å†™ data å°±å†™ dataï¼Œæ²¡æœ‰æŒ‚åœ¨ list ä¸Š commitï¼Œå°±ä¸æ˜¯è¡¨çš„ä¸€éƒ¨åˆ†</li><li>Iceberg Catalog: iceberg æ•´ä¸ªç»“æ„çš„ root æŒ‡é’ˆï¼Œå®ƒå¯ä»¥æ˜¯ HDFS / HMS ç­‰ï¼Œéœ€è¦æ”¯æŒåŸå­çš„å˜æ›´</li></ol><p>é‚£ä¸‹é¢æ¯”è¾ƒé‡è¦çš„å°±æ˜¯ä¸­é—´çš„ç»“æ„äº†ã€‚</p><h2 id="Iceberg-Metadata-Layer"><a href="#Iceberg-Metadata-Layer" class="headerlink" title="Iceberg Metadata Layer"></a>Iceberg Metadata Layer</h2><p>é¦–å…ˆè¿˜æ˜¯éœ€è¦æ³¨æ„ï¼Œåœ¨æ•°æ®åº“é¢†åŸŸï¼Œæˆ‘ä»¬ç»å¸¸æåˆ° record, wal, page ä¹‹ç±»çš„æ¦‚å¿µï¼Œè€Œåœ¨å¤§æ•°æ®é¢†åŸŸï¼ŒæŸç§æ„ä¹‰ä¸Šï¼Œ<strong>æ•°æ®çš„ä¸€ç­‰å…¬æ°‘æ˜¯æ–‡ä»¶</strong>ã€‚</p><h3 id="Table-Metadata-and-Snapshot"><a href="#Table-Metadata-and-Snapshot" class="headerlink" title="Table Metadata and Snapshot"></a>Table Metadata and Snapshot</h3><p>Table Metadata / Metadata File: æ˜¯ä¸€ä¸ª JSONï¼Œè¡¨è¾¾è¡¨çš„ä¿¡æ¯ï¼ŒåŒ…å«è¡¨çš„ schemaï¼ŒPartition specsï¼Œæ ¼å¼çš„ç‰ˆæœ¬. ( The table metadata file tracks the table schema, partitioning config, custom properties, and <strong>snapshot</strong>s of the table contents. A snapshot represents the state of a table at some time and is used to access the complete set of data files in the table. )</p><ul><li>Snapshot å¯ä»¥è§†ä½œä¸€æ¬¡å†™äº§ç”Ÿçš„ snapshotï¼Œsnapshot è¢«å†…åŒ…å«åœ¨ Metadata File ä¸­ã€‚ç³»ç»Ÿä¸€å®šæœ‰ä¸€ä¸ªå½“å‰çš„ Snapshot (å¯¹äºåˆšåˆ›å»ºçš„è¡¨ï¼Œè¿™ä¸ª snapshot é‡Œé¢ä¸€ä¸ªæ–‡ä»¶éƒ½æ²¡æœ‰ï¼‰ã€‚Snapshot ä¹Ÿå¯ä»¥åŒ…å«åˆ›å»ºè€…çš„ Summary</li></ul><p>ä¸¾ä¸ªåšå®¢ä¸­çš„ä¾‹å­ï¼š</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="comment">// åœ¨ iceberg ä¸­çš„ç‰ˆæœ¬æ˜¯ v1</span></span><br><span class="line">    <span class="attr">&quot;format-version&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="comment">// å¯¹åº”çš„ table ç”Ÿæˆçš„ uuid</span></span><br><span class="line">    <span class="attr">&quot;table-uuid&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;4b96b6e8-9838-48df-a111-ec1ff6422816&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="comment">// Table çš„ä½ç½®. ä½ å¯èƒ½è¦é—®äº†, è¿™ä¸ªé¬¼ç©æ„å’Œ Hive é‚£æ ·ç›®å½•æœ‰å•¥åŒºåˆ«,</span></span><br><span class="line">    <span class="comment">// ç­”æ¡ˆæ˜¯æ•°æ®ä¸åœ¨ç›®å½•ä¸‹</span></span><br><span class="line">    <span class="attr">&quot;location&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;/home/hadoop/warehouse/db2/part_table2&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="comment">// table æœ€åæ›´æ–°çš„ unix epoch</span></span><br><span class="line">    <span class="comment">// (å…¶å®è¿™é‡Œè¿˜åº”è¯¥æœ‰ä¸€ä¸ªæœ€æ–°çš„ sequence-id)</span></span><br><span class="line">    <span class="attr">&quot;last-updated-ms&quot;</span> <span class="punctuation">:</span> <span class="number">1611694436618</span><span class="punctuation">,</span></span><br><span class="line">    <span class="comment">// å·²ç»åˆ†é…çš„æœ€é«˜çš„ column-id</span></span><br><span class="line">    <span class="attr">&quot;last-column-id&quot;</span> <span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">    <span class="comment">// table çš„ schema, æ³¨æ„è¿™é‡Œ id çš„åˆ†é…</span></span><br><span class="line">    <span class="comment">// è¿™ä¸ªä¸œè¥¿å·²ç» deprecated äº†, æ–°ä¸€ç‚¹çš„æ˜¯ schemas,</span></span><br><span class="line">    <span class="comment">// å°±æ˜¯åŒ…æ‹¬å†å²æœ‰çš„ schema.</span></span><br><span class="line">    <span class="attr">&quot;schema&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;struct&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;fields&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;id&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;id&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;required&quot;</span> <span class="punctuation">:</span> <span class="keyword">true</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;int&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;id&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;ts&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;required&quot;</span> <span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;timestamptz&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;id&quot;</span> <span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;message&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;required&quot;</span> <span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;string&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span> <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="comment">// Partition ç›¸å…³çš„ä¿¡æ¯.</span></span><br><span class="line">    <span class="comment">// ä½ å¯èƒ½æ³¨æ„åˆ°äº† spec å’Œ specs</span></span><br><span class="line">    <span class="comment">// spec ä¹Ÿå·²ç» deprecated äº†, ä»¤äººå”å˜˜</span></span><br><span class="line">    <span class="attr">&quot;partition-spec&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;ts_hour&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;transform&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;hour&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;source-id&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;field-id&quot;</span> <span class="punctuation">:</span> <span class="number">1000</span></span><br><span class="line">    <span class="punctuation">&#125;</span> <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;default-spec-id&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;partition-specs&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;spec-id&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;fields&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;ts_hour&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;transform&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;hour&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;source-id&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;field-id&quot;</span> <span class="punctuation">:</span> <span class="number">1000</span></span><br><span class="line">        <span class="punctuation">&#125;</span> <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span> <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="comment">// æ’åºçš„ key</span></span><br><span class="line">    <span class="comment">// å…¶å® Sort ä¹Ÿæ¯”è¿™ä¸ªå®šä¹‰å¤æ‚, è¿˜åŒ…æ‹¬å¯¹åº”çš„</span></span><br><span class="line">    <span class="comment">// SortOrder, null first ä¹‹ç±»çš„.</span></span><br><span class="line">    <span class="attr">&quot;default-sort-order-id&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;sort-orders&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;order-id&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;fields&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span> <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span> <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="comment">// table çš„å±æ€§, å¯ä»¥ç”¨æ¥æ§åˆ¶ table çš„è¯»å†™</span></span><br><span class="line">    <span class="attr">&quot;properties&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;owner&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;hadoop&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="comment">// æŒ‡å‘ latest çš„ snapshot id.</span></span><br><span class="line">    <span class="attr">&quot;current-snapshot-id&quot;</span> <span class="punctuation">:</span> <span class="number">1257424822184505371</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;snapshots&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="comment">// snapshot</span></span><br><span class="line">        <span class="attr">&quot;snapshot-id&quot;</span> <span class="punctuation">:</span> <span class="number">8271497753230544300</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;timestamp-ms&quot;</span> <span class="punctuation">:</span> <span class="number">1611694406483</span><span class="punctuation">,</span></span><br><span class="line">        <span class="comment">// å…³äºå†™å…¥çš„ä¸€äº›ä¿¡æ¯</span></span><br><span class="line">        <span class="attr">&quot;summary&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;operation&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;append&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;spark.app.id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;application_1611687743277_0002&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;added-data-files&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;added-records&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;added-files-size&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;960&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;changed-partition-count&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;total-records&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;total-data-files&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;total-delete-files&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;0&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;total-position-deletes&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;0&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;total-equality-deletes&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;0&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="comment">// ä¸€ä¸ª snapshot ä¼šæœ‰ä¸€ä¸ªå¯¹åº”çš„ manifest list</span></span><br><span class="line">        <span class="attr">&quot;manifest-list&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;/home/hadoop/warehouse/db2/part_table2/metadata/snap-8271497753230544300-1-d8a778f9-ad19-4e9c-88ff-28f49ec939fa.avro&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span> </span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;snapshot-id&quot;</span> <span class="punctuation">:</span> <span class="number">1257424822184505371</span><span class="punctuation">,</span></span><br><span class="line">        <span class="comment">// æœ‰çš„ snapshot ä¼šæœ‰å¯¹åº”çš„ parent snapshot.</span></span><br><span class="line">        <span class="attr">&quot;parent-snapshot-id&quot;</span> <span class="punctuation">:</span> <span class="number">8271497753230544300</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;timestamp-ms&quot;</span> <span class="punctuation">:</span> <span class="number">1611694436618</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;summary&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;operation&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;append&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;spark.app.id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;application_1611687743277_0002&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;added-data-files&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;added-records&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;added-files-size&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;973&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;changed-partition-count&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;total-records&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;2&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;total-data-files&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;2&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;total-delete-files&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;0&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;total-position-deletes&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;0&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;total-equality-deletes&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;0&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;manifest-list&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;/home/hadoop/warehouse/db2/part_table2/metadata/snap-1257424822184505371-1-eab8490b-8d16-4eb1-ba9e-0dede788ff08.avro&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span> <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="comment">// snapshot æ—¶é—´å¯¹åº”ä¸Šç‰©ç†æ—¶é—´</span></span><br><span class="line">    <span class="attr">&quot;snapshot-log&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;timestamp-ms&quot;</span> <span class="punctuation">:</span> <span class="number">1611694406483</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;snapshot-id&quot;</span> <span class="punctuation">:</span> <span class="number">8271497753230544300</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span> </span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;timestamp-ms&quot;</span> <span class="punctuation">:</span> <span class="number">1611694436618</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;snapshot-id&quot;</span> <span class="punctuation">:</span> <span class="number">1257424822184505371</span></span><br><span class="line">    <span class="punctuation">&#125;</span> <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="comment">// å¯é€‰çš„ metadata åˆ—è¡¨</span></span><br><span class="line">    <span class="attr">&quot;metadata-log&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;timestamp-ms&quot;</span> <span class="punctuation">:</span> <span class="number">1611694097253</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;metadata-file&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;/home/hadoop/warehouse/db2/part_table2/metadata/v1.metadata.json&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span> </span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;timestamp-ms&quot;</span> <span class="punctuation">:</span> <span class="number">1611694406483</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;metadata-file&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;/home/hadoop/warehouse/db2/part_table2/metadata/v2.metadata.json&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span> <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>(è¯´æ˜¯ç‰ˆæœ¬ 1ï¼Œå…¶å®ç‰ˆæœ¬2 åŒ…å«äº†ä¸€äº› delete ä¹‹ç±»çš„ä¿¡æ¯ï¼‰</p><p>(å…¶å®æˆ‘å¾ˆå¥½å¥‡è¿™ä¸ªæ—¶é—´ï¼Œå¦‚æœé‡åˆ°äº†åˆ†å¸ƒå¼æ—¶é’Ÿå›é€€æ€ä¹ˆåŠ)</p><p>è¿™é‡Œè¡¨çº§åˆ«åŒ…å«äº†æ–‡ä»¶çš„ Partitionï¼ŒSchemaï¼ŒSnapshotsï¼Œå’Œ snapshot çš„ Historyã€‚è¿™é‡Œè¿˜æœ‰ä¸€äº›ç‰©ç†æ—¶é—´å˜æ›´çš„ä¿¡æ¯ã€‚æ²¡æœ‰å†™æ¸…æ¥šçš„æ˜¯ï¼Œè¿™é‡Œè¿˜å¯ä»¥å­˜å‚¨ table statistics å’Œ snapshot refsã€‚table statistics å®šä¹‰è§ï¼š<a href="https://iceberg.apache.org/spec/#table-statistics">https://iceberg.apache.org/spec/#table-statistics</a></p><p>è¿™éƒ¨åˆ†å†…å®¹å¯ä»¥è¢«å­˜å‚¨åœ¨ Metastore æˆ–è€… HDFS ä¹‹ç±»çš„ä¸œè¥¿ä¸Šï¼Œé  Atomic Swap æ¥è§£å†³ã€‚</p><p>è¿™ä¸ª Summary ä¹Ÿæ¯”è¾ƒæœ‰æ„æ€ï¼Œèƒ½ä»£è¡¨ snapshot çš„æ¥æºï¼Œä¸¾ä¸ªå¥½ç©çš„ä¾‹å­ï¼ŒCompaction å¯ä»¥ç”¨ <code>replace</code> æ¥è¡¨ç¤ºã€‚</p><h3 id="Metadata-File-Manifest-List"><a href="#Metadata-File-Manifest-List" class="headerlink" title="Metadata File (Manifest List)"></a>Metadata File (Manifest List)</h3><p>Manifest List å¯¹åº”ä¸€ä¸ª Snapshotï¼Œä»¥ä¸€ä¸ª Avro æ–‡ä»¶çš„å½¢å¼å­˜åœ¨ã€‚Snapshot æœ¬èº« inline åœ¨äº† Metadata é‡Œé¢ï¼Œä½†æ˜¯ Manifest List å´è¢«æŠ½å‡ºæ¥äº†ã€‚è¿™ç§æŠ½è±¡ä¹Ÿç®—æ˜¯é¿å…è¿›ä¸€æ­¥è†¨èƒ€ã€‚åŒæ—¶ï¼ŒManifest List æ˜¯ä¸€ä¸ªå®Œæˆçš„ snapshotï¼Œå®ƒåŒ…å«äº†ä¸€äº› Manifestã€‚è€Œè¿™äº› Manifest æ¯”è¾ƒå€¼å¾—ç©å‘³ï¼š</p><ol><li>Manifest æœ¬èº«æŒ‰ç…§ Table æˆ–è€… Partition æœ‰ä¸€äº›åˆ‡åˆ†ï¼ŒæŸ¥è¯¢å¯ä»¥è·³è¿‡ä¸€å®šçš„ Manifest</li><li>å¦‚æœ Manifest æœ¬èº«å’Œ Partition ä¸€ä¸€ç»‘å®šçš„è¯ï¼Œå†™å…¥éœ€è¦é‡å†™æ•´ä¸ª Partition ç”šè‡³ Table çš„ Manifestï¼Œä½†æ˜¯å®é™…ä¸Šï¼Œè¿™é‡Œ Manifest ä¹Ÿå¯ä»¥è¢«å½“æˆ Logï¼Œå¿«é€Ÿå†™æ’å…¥ä¸€ä¸ªæ–‡ä»¶ï¼Œç„¶ååŠ å…¥ Manifest Listï¼Œè¿™é¡¹æŠ€æœ¯è¢«ç§°ä¸º fast append</li><li>å¤§è¡¨ä¹Ÿå¯ä»¥æ‹†åˆ† Manifestï¼Œæ¥æŸç§æ„ä¹‰ä¸ŠåŠ é€Ÿ Planning</li></ol><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="comment">// éœ€è¦æ³¨æ„çš„æ˜¯, åœ¨ v2 ä¸Š, è¿™é‡Œè¿˜æœ‰ä¸ª sequence number</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// manifest å¯¹åº”çš„è·¯å¾„.</span></span><br><span class="line">    <span class="attr">&quot;manifest_path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/home/hadoop/warehouse/db2/part_table2/metadata/eab8490b-8d16-4eb1-ba9e-0dede788ff08-m0.avro&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;manifest_length&quot;</span><span class="punctuation">:</span> <span class="number">4884</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;partition_spec_id&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;added_snapshot_id&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;long&quot;</span><span class="punctuation">:</span> <span class="number">1257424822184505300</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="comment">// è¿™äº›å­—æ®µç®—æ˜¯ table summaries, è¡¨è¾¾å¯¹åº”çš„å¢ / åˆ </span></span><br><span class="line">    <span class="attr">&quot;added_data_files_count&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;int&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;existing_data_files_count&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;int&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;deleted_data_files_count&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;int&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="comment">// åŒ…å«çš„ Partition ç›¸å…³çš„ä¿¡æ¯</span></span><br><span class="line">    <span class="comment">// è¿™é‡Œè¿˜å¯ä»¥è®°å½• Partition ç›¸å…³çš„å’Œ field-summary,</span></span><br><span class="line">    <span class="comment">// åšè¿›ä¸€æ­¥çš„åˆ†åŒºè£å‰ª.</span></span><br><span class="line">    <span class="attr">&quot;partitions&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;array&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;contains_null&quot;</span><span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;lower_bound&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;bytes&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Â¹Ã”\\u0006\\u0000&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;upper_bound&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;bytes&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Â¹Ã”\\u0006\\u0000&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span> <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;added_rows_count&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;long&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;existing_rows_count&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;long&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;deleted_rows_count&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;long&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;manifest_path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/home/hadoop/warehouse/db2/part_table2/metadata/d8a778f9-ad19-4e9c-88ff-28f49ec939fa-m0.avro&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;manifest_length&quot;</span><span class="punctuation">:</span> <span class="number">4884</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;partition_spec_id&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;added_snapshot_id&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;long&quot;</span><span class="punctuation">:</span> <span class="number">8271497753230544000</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;added_data_files_count&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;int&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;existing_data_files_count&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;int&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;deleted_data_files_count&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;int&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;partitions&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;array&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;contains_null&quot;</span><span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;lower_bound&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;bytes&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Â¸Ã”\\u0006\\u0000&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;upper_bound&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;bytes&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Â¸Ã”\\u0006\\u0000&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span> <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;added_rows_count&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;long&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;existing_rows_count&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;long&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;deleted_rows_count&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;long&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h3 id="Manifests"><a href="#Manifests" class="headerlink" title="Manifests"></a>Manifests</h3><p>åœ¨ v2 ä¸­ï¼Œformat è¿˜å…è®¸æ ‡æ³¨ Manifest ä¸º Delete Manifest. è¿™ä¸ª Manifest å°±æ˜¯å•çº¯ä¸€ä¸ª ã€Œæ–‡ä»¶åˆ—è¡¨ã€äº†ï¼Œæˆ‘ä»¬çœŸçš„èµ°äº†å¥½ä¸€ä¼šå„¿æ‰çœ‹åˆ°è¿™é‡Œå‘¢â€¦</p><p>Manifest æœ¬èº«æœ‰ç‚¹åƒ G+ å†™çš„é‚£ç¯‡ when metadata is bigdata. æ•´ä¸ªæ–‡ä»¶ä¼šè¢«è®°å½• Schema å’Œç»Ÿè®¡ä¿¡æ¯ï¼Œæ¥è¿›è¡Œåˆ†æï¼Œæˆ‘ä»¬æ¥ç€çœ‹ä¸€ä¸ª v1 çš„æ–‡ä»¶ï¼š</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="comment">// (existing / add / deleted )</span></span><br><span class="line">    <span class="attr">&quot;status&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="comment">// æ’å…¥çš„ snapshot id</span></span><br><span class="line">    <span class="attr">&quot;snapshot_id&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;long&quot;</span><span class="punctuation">:</span> <span class="number">1257424822184505300</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="comment">// (è¿™é‡Œè¿˜éšå«äº† seq-number å’Œ file-seqnumber, å› ä¸ºè¿™ä¸ªæ–‡ä»¶</span></span><br><span class="line">    <span class="comment">// æœ¬èº«æ˜¯ä¸€ä¸ª v1 æ–‡ä»¶, æ‰€ä»¥ä¸åŒ…å«, å½“è¯»å–çš„æ—¶å€™, è¿™é‡Œæœ‰ä¸€å¥—ç»§æ‰¿æœºåˆ¶)</span></span><br><span class="line">    <span class="attr">&quot;data_file&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;file_path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/home/hadoop/warehouse/db2/part_table2/data/ts_hour=2021-01-26-01/00000-6-7c6cf3c0-8090-4f15-a4cc-3a3a562eed7b-00001.parquet&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;file_format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;PARQUET&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;partition&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;ts_hour&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;int&quot;</span><span class="punctuation">:</span> <span class="number">447673</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;record_count&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;file_size_in_bytes&quot;</span><span class="punctuation">:</span> <span class="number">973</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;block_size_in_bytes&quot;</span><span class="punctuation">:</span> <span class="number">67108864</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;column_sizes&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;array&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;key&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="number">47</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;key&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="number">57</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;key&quot;</span><span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="number">60</span></span><br><span class="line">            <span class="punctuation">&#125;</span> <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;value_counts&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;array&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;key&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;key&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;key&quot;</span><span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">            <span class="punctuation">&#125;</span> <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;null_value_counts&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;array&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;key&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;key&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;key&quot;</span><span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">            <span class="punctuation">&#125;</span> <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;lower_bounds&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;array&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;key&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;\\u0002\\u0000\\u0000\\u0000&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;key&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;\\u0000â€ ,ÃƒÂ¹\\u0005\\u0000&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;key&quot;</span><span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;test message 2&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span> <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;upper_bounds&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;array&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;key&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;\\u0002\\u0000\\u0000\\u0000&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;key&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;\\u0000â€ ,ÃƒÂ¹\\u0005\\u0000&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;key&quot;</span><span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;test message 2&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span> <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;key_metadata&quot;</span><span class="punctuation">:</span> <span class="keyword">null</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;split_offsets&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;array&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="number">4</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>è¿™é‡Œå°±å¯ä»¥å’”å’”æ€æ–‡ä»¶äº†. å›é¡¾ä¸€ä¸‹ï¼Œè¿™é‡Œæ¯ä¸€ä¸ªå±‚æ¬¡éƒ½æœ‰ç»Ÿè®¡ï¼ŒManifest <del>å³æ˜¯ç¥åˆæ˜¯é­”ï¼ˆè¿™æ˜¯æˆ‘ä¸­äºŒçŠ¯äº†ï¼‰</del> æ—¢èƒ½åˆ é™¤åˆèƒ½æ·»åŠ ï¼ŒåŒæ—¶æä¾›äº† Prune æ–‡ä»¶çš„èƒ½åŠ›ã€‚</p><h3 id="File-Format"><a href="#File-Format" class="headerlink" title="File Format"></a>File Format</h3><p>å…¶å® File Format å±‚é¢ï¼ŒIceberg ç±»ä¼¼ Arrow Parquet é‚£å¥—ã€‚ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿå®ƒä¸èƒ½é€‚åº”ä»»ä½•æ ¼å¼ï¼Œä½†æ˜¯ä¼šéœ€è¦ä½ è¿™ä¸ªæ ¼å¼é¢„ç•™ä¸€äº›ç¬¦åˆå®ƒ spec çš„ä¸œè¥¿ï¼Œæ¯”å¦‚ï¼š</p><ol><li>FieldIdï¼š<a href="https://github.com/apache/iceberg/blob/master/format/spec.md#column-projection">https://github.com/apache/iceberg/blob/master/format/spec.md#column-projection</a></li><li>Default Value (and spec)ï¼š<a href="https://github.com/apache/iceberg/blob/master/format/spec.md#default-values">iceberg/spec.md at master Â· apache/iceberg</a><ol><li>è¿™é‡Œæä¾›äº† <code>initial-default</code>ï¼ˆæ·»åŠ å­—æ®µçš„æ—¶å€™çš„é»˜è®¤å€¼ï¼‰å’Œ <code>write-default</code>ï¼ˆå†™å…¥çš„é»˜è®¤å€¼ï¼‰</li></ol></li><li>ç±»å‹ï¼š<a href="https://github.com/apache/iceberg/blob/master/format/spec.md#schemas-and-data-types">https://github.com/apache/iceberg/blob/master/format/spec.md#schemas-and-data-types</a> è¿™é‡Œé™åˆ¶çš„è¿˜æ˜¯ç›¸å¯¹æ¯”è¾ƒæ­»çš„</li></ol><h3 id="Row-Level-Delete-Formats"><a href="#Row-Level-Delete-Formats" class="headerlink" title="Row-Level Delete Formats"></a>Row-Level Delete Formats</h3><p>Iceberg format v2.0 æä¾›äº† Delete format. è¿™é‡Œæœ‰ Positional-Delete File å’Œ Equality Delete-File</p><ol><li>Positional Delete File: å¯¹æ–‡ä»¶æä¾›åˆ é™¤ï¼Œä»¥è¡Œçš„å½¢å¼æ ‡è®°åˆ é™¤</li><li>Equality Delete-File: å¯¹æ–‡ä»¶æä¾›åˆ é™¤ï¼Œä»¥æŸä¸ª Column çš„ Value å½¢å¼<strong>å…¨éƒ¨</strong>åˆ é™¤</li></ol><p>è¿™é‡Œæ–‡ä»¶ä¹Ÿè¦æä¾›å¯¹åº”çš„ Statsï¼Œæ¯”å¦‚åˆ é™¤æ–‡ä»¶ä¹Ÿè¦æä¾›è‡ªå·±åˆ é™¤çš„ Statsã€‚</p><p>Iceberg çš„ Stats æ¯”è¾ƒæœ‰æ„æ€ï¼Œè¯­ä¹‰æ˜¯ï¼šã€Œ<strong>ä½ å¯ä»¥ä¸æä¾›ï¼Œä½†æ˜¯åªè¦ä½ æä¾›äº†ï¼Œå°±å¿…é¡»æ˜¯å…¨éƒ½å‡†ç¡®çš„</strong>ã€ã€‚</p><p>è¿™é‡Œè¿˜è¦æ³¨æ„ï¼Œä¸€ä¸ª Delete File å¯ä»¥å¯¹åº”å¤šä¸ª Base æ–‡ä»¶ï¼ŒEquality Delete-File ç”šè‡³å¯ä»¥å¯¹åº”å¤šä¸ªåˆ†åŒºã€‚</p><h3 id="Concurrency-Control-and-Sequence-Number"><a href="#Concurrency-Control-and-Sequence-Number" class="headerlink" title="Concurrency Control and Sequence Number"></a>Concurrency Control and Sequence Number</h3><p>Apache Iceberg æ²¡æœ‰ row-level transaction å’Œ row-level mvccï¼Œå–è€Œä»£ä¹‹ï¼Œå®ƒæ¨¡å‹å…³é”®æ˜¯ Snapshot / æ–‡ä»¶çº§åˆ«çš„ MVCCï¼š</p><ol><li>æ¯ä¸ª snapshot æœ‰ä¸€ä¸ª sequence number</li><li>å°è¯•æäº¤çš„æ—¶å€™ï¼ŒApache Iceberg ä»¥ OCC çš„åè®®æäº¤ï¼Œåœ¨å‰é¢ç”³è¯·ä¸€ä¸ª Sequence numberï¼Œç„¶ååœ¨ validation é˜¶æ®µåš checking</li><li>åˆ›å»ºçš„æ–° Delete / Insert ç»§æ‰¿æ–°çš„ Snapshot çš„ Sequence Numberï¼Œè€Œä¹‹å‰åˆ›å»ºçš„ï¼ˆExistingï¼‰äº«æœ‰ä¹‹å‰çš„ Sequence number<ol><li>å› ä¸ºè¿™å¥—æœºåˆ¶ï¼ŒCompaction å‰åæ–‡ä»¶å…¶å®æ˜¯ä¸å¤ªä¸€è‡´çš„ï¼Œä»¤äººå”å˜˜ã€‚</li></ol></li></ol><h2 id="Partition-Bucket-Sorting"><a href="#Partition-Bucket-Sorting" class="headerlink" title="Partition / Bucket / Sorting"></a>Partition / Bucket / Sorting</h2><h3 id="Partition-Evolution-amp-Sort-Order-Evolution"><a href="#Partition-Evolution-amp-Sort-Order-Evolution" class="headerlink" title="Partition Evolution &amp; Sort Order Evolution"></a>Partition Evolution &amp; Sort Order Evolution</h3><p>Iceberg é€šè¿‡ PartitionSpecs å’Œ Sort Order çš„ Specs çš„æ–¹å¼æ¥æä¾›ç›¸å…³çš„å†…å®¹ã€‚Hive Partition ä¸æ˜¯æ•°æ®è¡¨çš„ä¸€åˆ—ï¼Œä½†æ˜¯ Iceberg Partition å¯ä»¥é€‰æ‹© <code>expr-transform(è¡¨çš„ä¸€åˆ—)</code>ï¼Œæ¯”å¦‚å®ƒ spec è¦æ±‚æ˜¯</p><blockquote><ul><li>A source column id from the tableâ€™s schema</li><li>A partition field id that is used to identify a partition field and is unique within a partition spec. In v2 table metadata, it is unique across all partition specs.</li><li>A transform that is applied to the source column to produce a partition value</li><li>A partition name</li></ul></blockquote><p>è¿™é‡Œä¸¾ä¸ªä¹‹å‰çš„ä¾‹å­ï¼š</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;default-spec-id&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;partition-specs&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;spec-id&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;fields&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;ts_hour&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;transform&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;hour&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;source-id&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;field-id&quot;</span> <span class="punctuation">:</span> <span class="number">1000</span></span><br><span class="line">    <span class="punctuation">&#125;</span> <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span> <span class="punctuation">]</span><span class="punctuation">,</span></span><br></pre></td></tr></table></figure><p>è¿™ä¸ªåœ°æ–¹å°±å¾ˆç›´è§‚ä»‹ç»äº† Partition çš„æ¨¡æ ·ã€‚åœ¨ Manifest ä¸Šä¹Ÿæœ‰ partition-spec:</p><p><img src="https://image.mwish.me/blog-image/iceberg-05.png" alt="iceberg-05"></p><p>ç±»ä¼¼ Partitionï¼ŒBucket ä¹Ÿåšæˆ Partition çš„å†…å®¹ï¼Œå¯ä»¥å¥—: </p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">[</span> <span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;source-id&quot;</span><span class="punctuation">:</span> <span class="number">4</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;field-id&quot;</span><span class="punctuation">:</span> <span class="number">1000</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ts_day&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;transform&quot;</span><span class="punctuation">:</span> <span class="string">&quot;day&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">,</span> <span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;source-id&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;field-id&quot;</span><span class="punctuation">:</span> <span class="number">1001</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;id_bucket&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;transform&quot;</span><span class="punctuation">:</span> <span class="string">&quot;bucket[16]&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span> <span class="punctuation">]</span></span><br></pre></td></tr></table></figure><p>å…¶å® Sort Order ä¹Ÿå·®ä¸å¤šå°±æ˜¯è¿™å¥— Ruleï¼Œä¸‹é¢æ¥ä»‹ç»</p><p><img src="https://image.mwish.me/blog-image/iceberg-06.png" alt="iceberg-06"></p><h2 id="Wrapup-How-does-Iceberg-run-query"><a href="#Wrapup-How-does-Iceberg-run-query" class="headerlink" title="Wrapup: How does Iceberg run query"></a>Wrapup: How does Iceberg run query</h2><p>æ¯”è¾ƒç»†èŠ‚çš„éƒ¨åˆ†åœ¨ Spec çš„ Scan Planning éƒ¨åˆ†ï¼š<a href="https://iceberg.apache.org/spec/#scan-planning">https://iceberg.apache.org/spec/#scan-planning</a></p><ol><li>æ‰¾åˆ° Iceberg Catalogï¼Œæ‹¿åˆ° Metadata file</li><li>DELETED çš„æ–‡ä»¶ä¸ä¼šå‚ä¸ Planningï¼Œä¸“æ³¨å¤„ç† EXISTING  å’Œ ADDED</li><li>è£å‰ªåˆ†åŒº</li></ol><p>ä¸‹é¢æœ‰ä¸€äº› DELETED File Apply çš„è§„åˆ™ï¼š</p><ol><li>å¯¹äº Positionï¼Œè¿™é‡Œä¼šæ ¹æ® ts-rule æ¥ applyï¼Œ<strong>å¦‚æœæ˜¯åˆ†åŒºè¡¨ï¼Œå¿…é¡»åœ¨åŒä¸€ä¸ªåˆ†åŒºåšåˆ é™¤</strong></li><li>å¯¹äº Equalityï¼Œè¿™é‡Œä¼šæ ¹æ® ts-rule æ¥åˆ é™¤ï¼Œ<strong>å®ƒå¯ä»¥æ˜¯ unpartition çš„ï¼Œä½œç”¨äºå…¨å±€</strong></li></ol><p><img src="https://image.mwish.me/blog-image/iceberg-07.png" alt="iceberg-07"></p><p>è¿™æ ·å°±å¯ä»¥ Plan å‡ºå¯¹åº”çš„è¡¨ï¼Œç„¶åè¿›è¡ŒæŸ¥è¯¢äº†ã€‚</p><h2 id="Iceberg-å…¼å®¹"><a href="#Iceberg-å…¼å®¹" class="headerlink" title="Iceberg å…¼å®¹"></a>Iceberg å…¼å®¹</h2><p>Snowflake, StarRocks è¿™äº›ç³»ç»Ÿéƒ½å…¼å®¹äº† Icebergï¼Œæˆ‘ä»¬ä»¥ Snowflake ä¸ºä¾‹ï¼Œè®²è®²è¿™å—æ˜¯æ€ä¹ˆå…¼å®¹çš„ï¼š</p><p><a href="https://www.snowflake.com/blog/expanding-the-data-cloud-with-apache-iceberg/">https://www.snowflake.com/blog/expanding-the-data-cloud-with-apache-iceberg/</a></p><ol><li>ä»å†…éƒ¨æ ¼å¼ä¸ºç”Ÿæˆ Parquetï¼Œå¯èƒ½ä¼šåŒå†™</li><li>Manifest å±‚é¢å»åŒå†™</li></ol><p><img src="https://image.mwish.me/blog-image/iceberg-08.png" alt="iceberg-08"></p><h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><ul><li>[å¼ºçƒˆæ¨è] <a href="https://www.dremio.com/resources/guide/apache-iceberg-an-architectural-look-under-the-covers/">https://www.dremio.com/resources/guide/apache-iceberg-an-architectural-look-under-the-covers/</a></li><li><a href="https://tabular.io/blog/iceberg-fileio/">https://tabular.io/blog/iceberg-fileio/</a></li><li>Iceberg V2 Spec: <a href="https://docs.google.com/document/d/1ZqVaSI_vBXekqXxNEg8NYvuiKgV2fKpMARhU54FhQaM/edit#">https://docs.google.com/document/d/1ZqVaSI_vBXekqXxNEg8NYvuiKgV2fKpMARhU54FhQaM/edit#</a></li><li>Snowflake and iceberg</li><li>Apache Iceberg çš„è®¾è®¡å“²å­¦ - lfyzjckçš„æ–‡ç«  - çŸ¥ä¹ <a href="https://zhuanlan.zhihu.com/p/601654830">https://zhuanlan.zhihu.com/p/601654830</a></li><li>ä» Delta 2.0 å¼€å§‹èŠèŠæˆ‘ä»¬éœ€è¦æ€æ ·çš„æ•°æ®æ¹– - ç½‘æ˜“æ•°å¸†çš„æ–‡ç«  - çŸ¥ä¹ <a href="https://zhuanlan.zhihu.com/p/552390193">https://zhuanlan.zhihu.com/p/552390193</a></li><li>æ·±åº¦å¯¹æ¯”deltaã€icebergå’Œhudiä¸‰å¤§å¼€æºæ•°æ®æ¹–æ–¹æ¡ˆ - openinxçš„æ–‡ç«  - çŸ¥ä¹ <a href="https://zhuanlan.zhihu.com/p/110748218">https://zhuanlan.zhihu.com/p/110748218</a></li><li>æ•°æ®æ¹–ï¼ˆData Lakeï¼‰ æ€»ç»“ - æˆ‘åƒå°åº¦é£é¥¼çš„æ–‡ç«  - çŸ¥ä¹ <a href="https://zhuanlan.zhihu.com/p/91165577">https://zhuanlan.zhihu.com/p/91165577</a></li></ul>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Apache Hive: A History on Hadoop</title>
      <link href="/2023/03/17/Apache-Hive-A-History-on-Hadoop/"/>
      <url>/2023/03/17/Apache-Hive-A-History-on-Hadoop/</url>
      
        <content type="html"><![CDATA[<p>ï¼ˆè¿™æ˜¯æœ€è¿‘å†™çš„æœ€çƒ‚çš„ä¸€ç¯‡æ–‡ç« äº†ï¼‰</p><p>å¯¹äº OTAP å’Œä¼ ç»Ÿçš„æ•°æ®åº“æ¥è¯´ï¼Œæ‰§è¡Œå¼•æ“ / å‰å° / å­˜å‚¨å³ä½¿æœ‰ä¸€äº›æ‹†åˆ†ï¼Œæ€»ä½“ä¸Šè¿˜æ˜¯å•ä¸ªç¨‹åºæ‰§è¡Œã€‚åœ¨å‰å°ç”± SQL è§£æï¼Œç„¶å Planner ä¸‹å‘åˆ°æ‰§è¡Œå±‚ï¼Œæ‰§è¡Œå±‚å¯èƒ½ä¼šå¸¦ä¸€ä¸ª Context æ¥éƒ¨åˆ†é™åˆ¶èµ„æºçš„æ‰§è¡Œã€‚ç„¶å Queuing çš„è¯ï¼Œæœ‰ä¸€äº›å…¨é“¾è·¯çš„ Queueï¼Œç„¶ååœ¨ overquota æˆ–è€…å†…å­˜è¿‡å¤§çš„æ—¶å€™ï¼Œè§¦å‘ä¸€äº›å†…å­˜ä¸Šçš„é™åˆ¶ã€‚</p><p>Hive ç”± Facebook å¼€å‘ï¼Œå‘è¡¨äº ICDEâ€™10ï¼Œåæ¥ Cloudera ä¹Ÿè¿›è¡Œäº†ä¸å°‘å¼€å‘ï¼Œæ„Ÿè§‰åŸºæœ¬ä¸Šæ˜¯ä»–ä»¬åœ¨ç®¡ï¼ŒHive ç»å†äº† 0.xã€1.0ã€2.0ã€3.0 ç‰ˆæœ¬ï¼Œåœ¨è¿‡å» SQL on BigData ä¸ç”šå®Œå–„çš„æ—¶ä»£ï¼Œæ˜¯å¤§æ•°æ®çš„äº‹å®æ ‡å‡†ã€‚å³ä½¿ç°åœ¨æ–°æŠ€æœ¯ä¸€ä»£ä»£å‡ºç°ï¼Œä»–ä»¬ä¹Ÿè¦å…¼å®¹ä¸€äº› Hive ç›¸å…³çš„è¯­ä¹‰ï¼ŒåŒæ—¶ï¼Œå³ä½¿ Hive å“ªå¤©çœŸçš„æ­»äº†ï¼Œå®ƒåœ¨ HDFS / S3 çš„è¡¨ç»“æ„ç›¸å…³çš„ä¿¡æ¯ä¹Ÿä¼šå­˜æ´»ã€‚å¤§ä½“æ¥è¯´ï¼ŒHive æ˜¯ä¸€ä¸ªæ•°æ®ä»“åº“ï¼Œä½ å¯ä»¥è¯´ã€ŒHive æµç¨‹å¤§è‡´å’Œå®ƒä»¬å·®ä¸å¤šã€ï¼Œä½†å…·ä½“è¿˜æ˜¯æœ‰è›®å¤šè®¾è®¡ä¸Šçš„æ¯”è¾ƒå¤§çš„åŒºåˆ«çš„ï¼Œæˆ‘ä»¬å¯ä»¥ç®€å•ä»ä¸€å¼ æ¶æ„å›¾æ¥å»¶å±•ï¼š</p><p><img src="https://image.mwish.me/blog-image/arch-hive.png" alt="arch-hive"></p><ol><li>MetaData å­˜å‚¨åœ¨å•ç‹¬çš„æœåŠ¡ï¼ˆMetaStoreï¼‰ä¸Š</li><li>Hive è‡ªå·±ä¸å®Œå…¨è´Ÿè´£æŸ¥è¯¢çš„æ‰§è¡Œï¼Œè€Œæ˜¯ä¸‹å‘ç»™ MapReduce/Tez ä¹‹ç±»çš„ Runtime</li><li>Hive è‡ªå·±ä¸å®Œå…¨è´Ÿè´£ä»»åŠ¡çš„è°ƒåº¦ï¼Œè€Œæ˜¯ä¸‹å‘ç»™ Yarn ä¹‹ç±»çš„ï¼Œåœ¨ Yarn çš„æ¡†æ¶ä¸‹è¿›è¡Œè°ƒåº¦</li><li>æ•°æ®å­˜æ”¾åœ¨ HDFS ä¸Šã€‚å¯¹å¤–éƒ¨æ•°æ®æºçš„å°Šé‡ï¼Œä¸åˆ†æƒ…å†µæ”¯æŒå¯¹æ‰˜ç®¡è¡¨çš„å¤„ç†</li><li>Planner å¹¶ä¸æ˜¯é‚£ä¹ˆã€Œç‰©ç†ã€çš„ SQL Operatorï¼Œå¾ˆå¤§ç¨‹åº¦ä¸Šæ˜¯ä¸‹æ¨ç»™æ‰§è¡Œå¼•æ“çš„ Plan</li></ol><p>åœ¨ Hive ä¸­ï¼Œä»»åŠ¡è°ƒåº¦å¦‚ä¸Šå›¾æ‰€ç¤ºã€‚</p><p>åŒæ—¶ï¼ŒHive SQL å’Œ OLTP çš„ SQL ä½¿ç”¨åŒºåˆ«è¿˜æ˜¯æ¯”è¾ƒå¤§çš„ï¼Œå®ƒæä¾›äº† Partition / Bucket çš„æ¦‚å¿µï¼Œåœ¨æ“ä½œçš„æ—¶å€™ï¼Œç»å¸¸å¯¹ Partition å’Œ Bucket åš Insert Overwrite ç­‰ç›¸å¯¹æ¯”è¾ƒé‡çš„å¤„ç†æ“ä½œ. è¿™é‡Œå¯èƒ½å¯ä»¥è®©å®ƒçš„ SQL è¢«å¼„è¿› SQL æ ‡å‡†ï¼Œä½†æ€»çš„æ¥è¯´ï¼Œè¿™ä¸ªå’Œ TP ç³»å¸¸ç”¨çš„é‚£äº› SQL å·®åˆ«è¿˜æ˜¯ä¸å°çš„ã€‚æ­¤å¤–ï¼Œå¯¹äº Hive è€Œè¨€ï¼Œæœ‰ä¸€ç‚¹æ¯”è¾ƒä¹å­çš„åœ°æ–¹æ˜¯ï¼Œå®ƒè™½ç„¶èƒ½åšä¸€äº›ä¼˜åŒ–ï¼Œä½†æ˜¯ä½ å¯èƒ½æ˜¯ç”¨ Calcite æ¥ä¼˜åŒ–ï¼Œæœ€åè·‘åœ¨ä¸€ä¸ª MapReduce ä¸Šï¼Œå¤šå°‘æœ‰ç‚¹éš”é´å­æŒ ç—’ï¼Œç„¶å Plan ä¹Ÿæ˜¯å¯¹åº” Stage çš„ Planï¼Œå› æ­¤ Hive SQL ä¹Ÿå¾—ä¸“é—¨æŠ½æ—¶é—´å­¦ä¹ æ‰èƒ½å†™å¥½ï¼Œè€Œä¸å¦‚ DB é‚£æ · EXPLAIN / PROFILE é‚£æ ·ç›´è§‚ã€‚ï¼ˆè¿˜æœ‰ä¸€äº›æ¯”è¾ƒå¥½ç©çš„ case æ˜¯ï¼Œå› ä¸º MR å‡ ä¹æ€»æ˜¯ Shuffleï¼Œæ‰€ä»¥æˆ‘ä»¬æŸç§ç¨‹åº¦ä¸Šå¯ä»¥å‘ç°ï¼Œä¸€äº›å…¬å¸ Data Stack ä¼šåœ¨æŸ¥è¯¢å¼•æ“é€æ­¥é™çº§ï¼Œä» Presto -&gt; Spark -&gt; Hive è¿™æ ·é€æ­¥çš„é™çº§ï¼Œç›´åˆ°è·‘å‡ºä»»åŠ¡ï¼‰ã€‚</p><p>Hive åœ¨å†å²ä¸Šä¹Ÿè¿›è¡Œè¿‡ä¸å°‘ä¼˜åŒ–ï¼ŒåŒ…æ‹¬ä» MapReduce æ¢ Tez ç­‰æ¨¡å¼ã€å‘é‡åŒ–ã€LLAPã€‚å¾ˆå¤šç”¨æˆ·çš„è§‚å¿µè¿˜åœç•™åœ¨ 0.14 ä¹‹ç±»çš„ç‰ˆæœ¬ã€‚</p><h2 id="Hive-ä¸€äº›å¸¸ç”¨çš„-SQL"><a href="#Hive-ä¸€äº›å¸¸ç”¨çš„-SQL" class="headerlink" title="Hive ä¸€äº›å¸¸ç”¨çš„ SQL"></a>Hive ä¸€äº›å¸¸ç”¨çš„ SQL</h2><h3 id="è¡¨çš„åˆ›å»ºå’ŒåŠ è½½"><a href="#è¡¨çš„åˆ›å»ºå’ŒåŠ è½½" class="headerlink" title="è¡¨çš„åˆ›å»ºå’ŒåŠ è½½"></a>è¡¨çš„åˆ›å»ºå’ŒåŠ è½½</h3><p>Hive çš„ config ç”¨ set ä¹‹ç±»çš„å®šä¹‰ï¼Œæ•°æ®æºä¹Ÿå¯ä»¥å®šä¹‰ Serde ä¹‹ç±»çš„ config:</p><p>åœ¨åˆ›å»ºè¡¨çš„æ—¶å€™ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> pageviews (userid <span class="type">VARCHAR</span>(<span class="number">64</span>), link STRING, came_from STRING)</span><br><span class="line">  PARTITIONED <span class="keyword">BY</span> (datestamp STRING) CLUSTERED <span class="keyword">BY</span> (userid) <span class="keyword">INTO</span> <span class="number">256</span> BUCKETS STORED <span class="keyword">AS</span> ORC;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œ:</p><ol><li>æ³¨æ„ Partition BY çš„å†…å®¹ä¸å®Œå…¨å‡ºç°åœ¨è¡¨ Schema ä¸­</li><li>CLUSTER BY æŒ‡å®šåˆ† bucket ä¹‹ç±»çš„ä¿¡æ¯</li><li>è¿˜å¯ä»¥æŒ‡å®šè¡¨çš„ä¸€äº› Schema</li></ol><p>ç„¶åç”¨æˆ·å¯ä»¥é€šè¿‡ load ç­‰æ–¹å¼æ¥åŠ è½½æ•°æ®ï¼Œè¿™é‡ŒåŠ è½½ç”šè‡³å¯ä»¥é€‰æ‹© OVERWRITE æŸä¸ª Partition çš„æ–¹å¼è¿›è¡Œ</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">LOAD DATA [<span class="keyword">LOCAL</span>] INPATH <span class="string">&#x27;filepath&#x27;</span> [OVERWRITE] <span class="keyword">INTO</span> <span class="keyword">TABLE</span> tablename [<span class="keyword">PARTITION</span> (partcol1<span class="operator">=</span>val1, partcol2<span class="operator">=</span>val2 ...)]</span><br><span class="line"> </span><br><span class="line">LOAD DATA [<span class="keyword">LOCAL</span>] INPATH <span class="string">&#x27;filepath&#x27;</span> [OVERWRITE] <span class="keyword">INTO</span> <span class="keyword">TABLE</span> tablename [<span class="keyword">PARTITION</span> (partcol1<span class="operator">=</span>val1, partcol2<span class="operator">=</span>val2 ...)] [INPUTFORMAT <span class="string">&#x27;inputformat&#x27;</span> SERDE <span class="string">&#x27;serde&#x27;</span>] (<span class="number">3.0</span> <span class="keyword">or</span> later)</span><br></pre></td></tr></table></figure><p>ç„¶åï¼ŒINSERT å¯ä»¥é€‰ä¸­æ•°æ®ï¼Œåˆ†åˆ«æœ‰ INSERT INTO å’Œ INSERT OVERWRITE. å¤§è‡´ä¸Šï¼ŒINTO æ˜¯æ’å…¥çš„æ—¶å€™ç›´æ¥æ’å…¥ï¼ŒOVERWRITE æ˜¯è¦†å†™ï¼Œæ’å…¥çš„å¯¹è±¡æ˜¯ Table æˆ–è€… Partitionã€‚</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">LOAD DATA [<span class="keyword">LOCAL</span>] INPATH <span class="string">&#x27;filepath&#x27;</span> [OVERWRITE] <span class="keyword">INTO</span> <span class="keyword">TABLE</span> tablename [<span class="keyword">PARTITION</span> (partcol1<span class="operator">=</span>val1, partcol2<span class="operator">=</span>val2 ...)]</span><br><span class="line"> </span><br><span class="line">LOAD DATA [<span class="keyword">LOCAL</span>] INPATH <span class="string">&#x27;filepath&#x27;</span> [OVERWRITE] <span class="keyword">INTO</span> <span class="keyword">TABLE</span> tablename [<span class="keyword">PARTITION</span> (partcol1<span class="operator">=</span>val1, partcol2<span class="operator">=</span>val2 ...)] [INPUTFORMAT <span class="string">&#x27;inputformat&#x27;</span> SERDE <span class="string">&#x27;serde&#x27;</span>] (<span class="number">3.0</span> <span class="keyword">or</span> later)</span><br></pre></td></tr></table></figure><p>Hive çš„ Insert è¿˜æ”¯æŒ Multi-Table-Insertï¼Œè¿™æ˜¯ä»€ä¹ˆç©æ„å‘¢ï¼Ÿç­”æ¡ˆæ˜¯å®ƒå¸Œæœ›åªè¯»ä¸€éæ•°æ®ç„¶åæ’å…¥å¤šä¸ª Partition / è¡¨ï¼Œå€Ÿç”¨ä¸€ä¸ª SQLï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> my_table</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> temp_table_20201115 <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">WHERE</span> dt <span class="operator">=</span><span class="string">&#x27;2020-11-15&#x27;</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> temp_table_20201116 <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">WHERE</span> dt <span class="operator">=</span><span class="string">&#x27;2020-11-16&#x27;</span></span><br></pre></td></tr></table></figure><p>æ¶å¿ƒå§ï¼</p><p>å“¦å¯¹äº†ï¼Œè™½ç„¶ä¸æ˜¯å¾ˆæƒ³åœ¨è¿™ä¸ªé˜¶æ®µä»‹ç» Partitionï¼Œä½†æ˜¯ INSERT çš„æ—¶å€™ï¼Œå¦‚æœæ‰“å¼€äº†åŠ¨æ€åˆ†åŒºï¼ŒHive ä¼šæ ¹æ®æœ€åå‡ åˆ—çš„å†…å®¹ï¼Œåˆ›å»ºæ–°çš„åˆ†åŒºï¼Œå…·ä½“è§ï¼š<a href="https://cwiki.apache.org/confluence/display/Hive/Tutorial#Tutorial-Dynamic-PartitionInsert">https://cwiki.apache.org/confluence/display/Hive/Tutorial#Tutorial-Dynamic-PartitionInsert</a></p><p>CRUD å°±ä¸ä»‹ç»äº†ï¼Œå¦ä¸€äº›æœ‰æ„æ€çš„åŒ…æ‹¬ MERGE INTO, Merge åœ¨ Hive 2.2 æ”¯æŒ:</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Standard Syntax:</span><br><span class="line"><span class="keyword">MERGE</span> <span class="keyword">INTO</span> <span class="operator">&lt;</span>target <span class="keyword">table</span><span class="operator">&gt;</span> <span class="keyword">AS</span> T <span class="keyword">USING</span> <span class="operator">&lt;</span>source expression<span class="operator">/</span><span class="keyword">table</span><span class="operator">&gt;</span> <span class="keyword">AS</span> S</span><br><span class="line"><span class="keyword">ON</span> <span class="operator">&lt;</span><span class="type">boolean</span> expression1<span class="operator">&gt;</span></span><br><span class="line"><span class="keyword">WHEN</span> MATCHED [<span class="keyword">AND</span> <span class="operator">&lt;</span><span class="type">boolean</span> expression2<span class="operator">&gt;</span>] <span class="keyword">THEN</span> <span class="keyword">UPDATE</span> <span class="keyword">SET</span> <span class="operator">&lt;</span><span class="keyword">set</span> clause list<span class="operator">&gt;</span></span><br><span class="line"><span class="keyword">WHEN</span> MATCHED [<span class="keyword">AND</span> <span class="operator">&lt;</span><span class="type">boolean</span> expression3<span class="operator">&gt;</span>] <span class="keyword">THEN</span> <span class="keyword">DELETE</span></span><br><span class="line"><span class="keyword">WHEN</span> <span class="keyword">NOT</span> MATCHED [<span class="keyword">AND</span> <span class="operator">&lt;</span><span class="type">boolean</span> expression4<span class="operator">&gt;</span>] <span class="keyword">THEN</span> <span class="keyword">INSERT</span> <span class="keyword">VALUES</span><span class="operator">&lt;</span><span class="keyword">value</span> list<span class="operator">&gt;</span></span><br></pre></td></tr></table></figure><p>Merge æ˜¯ä¸€å¥—ç›¸å¯¹æ¶å¿ƒçš„ä¸œè¥¿â€¦å°±æ˜¯å¯¹åŒ¹é…åˆ°çš„æ•°æ®è¿›è¡Œæ“ä½œï¼Œä¸¾ä¸ªä¾‹å­ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">MERGE</span> <span class="keyword">INTO</span> customer <span class="keyword">USING</span> (<span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> new_customer_stage) sub <span class="keyword">ON</span> sub.id <span class="operator">=</span> customer.id </span><br><span class="line"><span class="keyword">WHEN</span> MATCHED <span class="keyword">THEN</span> <span class="keyword">UPDATE</span> <span class="keyword">SET</span> name <span class="operator">=</span> sub.name, state <span class="operator">=</span> sub.new_state </span><br><span class="line"><span class="keyword">WHEN</span> <span class="keyword">NOT</span> MATCHED <span class="keyword">THEN</span> <span class="keyword">INSERT</span> <span class="keyword">VALUES</span> (sub.id, sub.name, sub.state);</span><br></pre></td></tr></table></figure><p>å¥½ç”¨æ˜¯è›®å¥½ç”¨çš„ï¼Œå°±æ˜¯ SCOPE å¤ªå¤§äº†ç‚¹ï¼Œæœ‰ç‚¹éœ‡æ’¼ï¼Œç›¸å½“äºåšå‡ºä¸€å®šçš„ç­›é€‰ï¼Œå†å¯¹ç­›é€‰å‡ºæ¥çš„æ•°æ®å¤„ç†ã€‚å¥½åƒ Oracle ä¹Ÿæ”¯æŒè¿™æ ·çš„è¯­æ³•ã€‚</p><h3 id="æŸ¥è¯¢"><a href="#æŸ¥è¯¢" class="headerlink" title="æŸ¥è¯¢"></a>æŸ¥è¯¢</h3><p>INSERT OVERWRITE ä»ä¸€å¼ è¡¨æ’å…¥å¦å¤–ä¸€å¼ è¡¨è¿™ç§ SQL æˆ‘å°±ä¸è¯´äº†ï¼Œè¿™é‡Œç€é‡è´´ä¸€ä¸‹åˆ†åŒºç›¸å…³çš„ SQL å’Œ JOIN</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> OVERWRITE <span class="keyword">TABLE</span> xyz_com_page_views</span><br><span class="line"><span class="keyword">SELECT</span> page_views.<span class="operator">*</span></span><br><span class="line"><span class="keyword">FROM</span> page_views</span><br><span class="line"><span class="keyword">WHERE</span> page_views.date <span class="operator">&gt;=</span> <span class="string">&#x27;2008-03-01&#x27;</span> <span class="keyword">AND</span> page_views.date <span class="operator">&lt;=</span> <span class="string">&#x27;2008-03-31&#x27;</span> <span class="keyword">AND</span></span><br><span class="line">      page_views.referrer_url <span class="keyword">like</span> <span class="string">&#x27;%xyz.com&#x27;</span>;</span><br></pre></td></tr></table></figure><p>æ³¨æ„åˆ° date ä¸ä¸€å®šæ˜¯ table ä¸­çš„å­—æ®µï¼Œè¿™é‡Œå¯èƒ½ä½œä¸ºå¯¹åº”çš„åˆ†åŒºå­—æ®µã€‚</p><p>è¿™é‡Œè¿˜æ”¯æŒäº† SAMPLINGï¼ŒArray/Map/Struct ç±»å‹ï¼ŒSchema Evolution ç­‰ï¼š<a href="https://cwiki.apache.org/confluence/display/Hive/Tutorial#Tutorial-QueryingandInsertingData">Tutorial - Apache Hive - Apache Software Foundation</a></p><p>æ€»ä¹‹ï¼ŒHive æä¾›çš„è¿™å¥—è¯­ä¹‰åœ¨å¤§æ•°æ®åœºæ™¯ä¸‹ï¼Œè¿˜æ˜¯æœ‰ç”¨æ­¦ä¹‹åœ°çš„ã€‚è¿™é‡Œä¸“é—¨æä¸€ä¸‹ Co-Groups:</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> (</span><br><span class="line">     <span class="keyword">FROM</span> (</span><br><span class="line">             <span class="keyword">FROM</span> action_video av</span><br><span class="line">             <span class="keyword">SELECT</span> av.uid <span class="keyword">AS</span> uid, av.id <span class="keyword">AS</span> id, av.date <span class="keyword">AS</span> <span class="type">date</span></span><br><span class="line"> </span><br><span class="line">            <span class="keyword">UNION</span> <span class="keyword">ALL</span></span><br><span class="line"> </span><br><span class="line">             <span class="keyword">FROM</span> action_comment ac</span><br><span class="line">             <span class="keyword">SELECT</span> ac.uid <span class="keyword">AS</span> uid, ac.id <span class="keyword">AS</span> id, ac.date <span class="keyword">AS</span> <span class="type">date</span></span><br><span class="line">     ) union_actions</span><br><span class="line">     <span class="keyword">SELECT</span> union_actions.uid, union_actions.id, union_actions.date</span><br><span class="line">     CLUSTER <span class="keyword">BY</span> union_actions.uid) map</span><br><span class="line"> </span><br><span class="line"> <span class="keyword">INSERT</span> OVERWRITE <span class="keyword">TABLE</span> actions_reduced</span><br><span class="line">     <span class="keyword">SELECT</span> TRANSFORM(map.uid, map.id, map.date) <span class="keyword">USING</span> <span class="string">&#x27;reduce_script&#x27;</span> <span class="keyword">AS</span> (uid, id, reduced_val);</span><br></pre></td></tr></table></figure><p>è¿™é‡Œåå°éœ€è¦æ˜¯ä¸€ä¸ª MapReduce ç¨‹åºï¼Œç„¶åå®šä¹‰ reduce_scriptã€‚è¿™å¥—ä¸œè¥¿å°±èƒ½æ³¡åœ¨å®ƒä¸Šé¢äº†ã€‚</p><p>æ­¤å¤–ï¼Œå¤§æ•°æ®è¿˜éœ€è¦ä¸€äº›ä½œä¸º CUBEï¼ŒROLLUP ä¹‹ç±»çš„è¯­ä¹‰ï¼Œæ¯”å¦‚ï¼š</p><ul><li><a href="https://cwiki.apache.org/confluence/display/Hive/LanguageManual+GroupBy">https://cwiki.apache.org/confluence/display/Hive/LanguageManual+GroupBy</a> ï¼ˆGROUP BYï¼ŒGROUPINGSETSï¼ŒROLLUPï¼ŒCUBEï¼‰</li><li>ä½¿ç”¨çª—å£å‡½æ•°æ¥è·å¾—ä¸€å®šçš„ WINDOW ä¿¡æ¯ï¼ˆTODO(mwish): ä¸°å¯Œè¿™é‡Œï¼‰</li><li>Coalesce, CASE WHEN ä¹‹ç±»çš„ï¼Œå¤„ç†ç±»ä¼¼ if çš„è¯­ä¹‰</li></ul><p>åœ¨ JOIN çš„æ—¶å€™ï¼ŒHive SQL è¿˜æ”¯æŒç±»ä¼¼ HINT çš„è¯­æ³•ï¼ˆæˆ‘çœ‹äº†ä¸‹ï¼ŒSpark ä¹Ÿæ”¯æŒï¼‰ï¼Œæ¥æ‰‹åŠ¨å¹²é¢„ JOIN çš„ Plan: <a href="https://cwiki.apache.org/confluence/display/hive/languagemanual+joinoptimization">https://cwiki.apache.org/confluence/display/hive/languagemanual+joinoptimization</a></p><h4 id="æ¶è¡¥ä¸€äº›æŸ¥è¯¢çš„æ—¶å€™éœ€è¦çš„-SQL"><a href="#æ¶è¡¥ä¸€äº›æŸ¥è¯¢çš„æ—¶å€™éœ€è¦çš„-SQL" class="headerlink" title="æ¶è¡¥ä¸€äº›æŸ¥è¯¢çš„æ—¶å€™éœ€è¦çš„ SQL"></a>æ¶è¡¥ä¸€äº›æŸ¥è¯¢çš„æ—¶å€™éœ€è¦çš„ SQL</h4><p>æœ¬æ¥ Hive å’Œ SQL æ ‡å‡†åº”è¯¥å°½é‡åˆ†å¼€è®²çš„ï¼Œé™¤éä¸€äº›æ ‡å‡†çš„ SQLï¼Œä¸åº”è¯¥åœ¨æ–‡ç« æ­£æ–‡éƒ¨åˆ†ä»‹ç»ï¼Œä½†æ˜¯æˆ‘åˆä¸æƒ³ä¸“é—¨èŠ±ä¸€ç¯‡å†…å®¹ä»‹ç»é«˜çº§ SQL, æ‰€ä»¥å¹²è„†åœ¨è¿™é‡Œè¯´äº†</p><p>RANK ä¹‹ç±»çš„ï¼Œå¯ä»¥åœ¨åºåˆ—ä¸­ï¼Œé¢å¤–æä¾›ä¸€ä¸ª RANK çš„æ•°å­—ï¼Œç›¸å½“äºåœ¨ SQL ä¸­æä¾›äº†ä¸€ä¸ª idx çš„æŠ½è±¡ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> ID, <span class="built_in">rank</span>() <span class="keyword">over</span> (<span class="keyword">order</span> <span class="keyword">by</span> (GPA) <span class="keyword">desc</span>) <span class="keyword">as</span> s_rank</span><br><span class="line"><span class="keyword">from</span> student_grades;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæ²¡æœ‰æŒ‡å®šè¾“å‡ºæ’åºé¡ºåºã€‚è¿˜æœ‰ä¸€äº›èƒ½æ›¿ä»£ <code>rank</code> çš„å‡½æ•°ï¼Œæ¯”å¦‚ï¼š</p><ul><li><code>percent_rank</code>: æ’åºä¸­çš„æ¯”ä¾‹</li><li><code>cume_dist</code>:ç´¯ç§¯åˆ†å¸ƒ</li><li><code>row_number</code>: ç±»ä¼¼ rank, ä½œä¸ºæ’åºçš„æ—¶å€™å”¯ä¸€çš„è¡Œå·ã€‚</li><li><code>ntile</code> æŠŠç»“æœåˆ†æˆå¯¹åº”çš„æ¡¶ï¼Œæ¥å¤„ç†ç›¸å…³çš„é€»è¾‘</li></ul><p>SQL è¿˜æä¾›äº†çª—å£å‡½æ•°å’Œå¯¹åº”çš„åŠŸèƒ½ã€‚è¿™ä¸ªæ˜¯å¯ä»¥å‘å‰æ»‘åŠ¨çš„ï¼Œå°±æ˜¯ä¸€ä¸ªrowå¯èƒ½è¢«ç®—è¿›å¤šä¸ªçª—å£ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">year</span>, <span class="built_in">avg</span>(num_credits) <span class="keyword">over</span> (<span class="keyword">order</span> <span class="keyword">by</span> <span class="keyword">year</span> <span class="keyword">rows</span> <span class="number">3</span> preceding) <span class="keyword">as</span> avg_total_credits</span><br><span class="line"><span class="keyword">from</span> tot_credits;</span><br></pre></td></tr></table></figure><p><code>range</code> <code>over</code> å¯ä»¥æä¾›çª—å£æœ‰å…³çš„é è°±åŠŸèƒ½</p><p><code>pivot</code>åšçš„æ—¶æœŸç›¸å½“äºæŠŠSQLä¸­çš„ enum å±•å¼€ï¼Œä» <code>table(a, b, c)</code> å±•å¼€æˆ <code>table(a, b, c_value1, c_value2 ...)</code>:</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">from</span> <span class="keyword">table</span></span><br><span class="line">pivot (</span><br><span class="line">  <span class="built_in">sum</span>(d)</span><br><span class="line">  <span class="keyword">for</span> c <span class="keyword">in</span> (c_value1, c_value2, ...)</span><br><span class="line">);</span><br></pre></td></tr></table></figure><p>è¿™é‡Œè¿˜æœ‰ä¸€äº› rollup, cube å’Œ grouping sets æ¥è¡¨è¾¾ä¸€äº›æ··æ‚çš„ GROUP BY. ç®€å•æ¥è¯´ï¼Œè¿™äº›ä¸åŒäºå¤šåˆ— GROUP BY (<code>GROUP BY c1, c2</code>), ä»–ä»¬ç›¸å½“äºå¤šåˆ— GROUP BY çš„ UNIONã€‚</p><ol><li><code>rollup</code> ç›¸å½“äº<strong>å‰ç¼€</strong>çš„ group by å’Œï¼Œ<code>rollup(a, b, c...)</code> ç›¸å½“äº <code>UNION&#123;(a, b, c..), ... (a, b), (a), ()&#125;</code></li><li><code>cube</code> ç›¸å½“äºæ‰€æœ‰æŒ‰ç…§é¡ºåºæ’åˆ—çš„å­é›† (<code>CUBE(a,b,c) == GROUPING SETS((a,b,c), (a,b),(a,c),(b,c),(a),...())</code> )</li><li><code>grouping sets</code> ç›¸å½“äºæ‰‹åŠ¨åˆ—å‡ºè¿™äº›é›†åˆ </li></ol><p>è¿™äº›è¿˜å¯ä»¥å’Œ <code>COALESCE</code> è¿ç”¨</p><h2 id="Hive-ç®€å•ä½¿ç”¨"><a href="#Hive-ç®€å•ä½¿ç”¨" class="headerlink" title="Hive ç®€å•ä½¿ç”¨"></a>Hive ç®€å•ä½¿ç”¨</h2><p>çŸ¥é“äº†ä¸Šé¢çš„å†…å®¹ä¹‹åï¼Œå°±å¯ä»¥å†™åŸºæœ¬çš„ Hive SQL äº†ï¼ŒHive çš„ EXPLAIN æœ‰ç‚¹éš¾æ‡‚ï¼Œä¼šè¾“å‡ºä¸€å¤§å †å’Œ Stage æœ‰å…³çš„ä¸œè¥¿ï¼š</p><ul><li><a href="https://cwiki.apache.org/confluence/display/Hive/LanguageManual+Explain">https://cwiki.apache.org/confluence/display/Hive/LanguageManual+Explain</a></li><li><a href="https://cwiki.apache.org/confluence/display/Hive/Cost-based+optimization+in+Hive">https://cwiki.apache.org/confluence/display/Hive/Cost-based+optimization+in+Hive</a></li><li><a href="https://zhuanlan.zhihu.com/p/352076174">https://zhuanlan.zhihu.com/p/352076174</a></li></ul><p>EXPLAIN è¿™é‡Œå¯èƒ½è¾“å‡ºå¯¹åº”çš„ Stageï¼ŒHive é«˜ç‰ˆæœ¬è¿˜å¼•å…¥äº† CBOã€‚</p><p><img src="https://image.mwish.me/blog-image/arch-hive-1-x.png" alt="arch-hive-1-x"></p><p>Hive åœ¨æ‰§è¡Œçš„æ—¶å€™ï¼Œåœ¨è¿›è¡Œæ•°æ®å¤„ç†æ—¶å…ˆå°†è®¡ç®—å‘å¾€æ•°æ®æ‰€åœ¨çš„èŠ‚ç‚¹ï¼Œå°†æ•°æ®ä»¥é”®-å€¼å¯¹ä½œä¸ºè¾“å…¥ï¼Œåœ¨æœ¬åœ°å¤„ç†åå†ä»¥é”®-å€¼å¯¹çš„å½¢å¼å‘å¾€è¿œç«¯çš„èŠ‚ç‚¹ï¼Œè¿™ä¸ªè¿‡ç¨‹é€šç”¨å«æ³•ä¸ºShuffleï¼Œè¿œç«¯çš„èŠ‚ç‚¹å°†æ¥æ”¶çš„æ•°æ®ç»„ç»‡æˆé”®-å€¼å¯¹çš„å½¢å¼ä½œä¸ºè¾“å…¥ï¼Œå¤„ç†åçš„æ•°æ®ï¼Œæœ€ç»ˆä¹Ÿä»¥é”®-å€¼å¯¹çš„å½¢å¼è¾“å‡ºã€‚</p><p>è¿™é‡Œé LLAP çš„æ¨¡å¼å¯èƒ½è¿˜è¦é€šè¿‡ Yarn æ‹‰èµ·ä¸€ä¸ªè¿›ç¨‹ï¼Œç„¶åé€‰å‡ºä¸€ä¸ªç®¡ç†å™¨ï¼Œæ¥åè°ƒä»»åŠ¡çš„æ‰§è¡Œ</p><p><img src="https://image.mwish.me/blog-image/hive-on-yarn.png" alt="hive-on-yarn"></p><p><img src="https://image.mwish.me/blog-image/yarn-internal.png" alt="yarn-internal"></p><p>è¿™é‡Œè¦å…³æ³¨ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯ï¼Œåœ¨ Hive 1.x æ‰§è¡Œé—®é¢˜æŒ‰æˆ‘ä»¬æœ€æ—©è´´çš„é‚£å¼ å›¾æ‰€è¿°ï¼Œè¿™é‡Œ YARN ä¼šæœ‰è°ƒåº¦å™¨å’Œé˜Ÿåˆ—ï¼Œç„¶åè¿›ç¨‹éƒ½æ˜¯æ‹‰èµ·ä¸€å¤§å †çš„ï¼Œæ•´ä¸ªæµç¨‹ç›¸å¯¹äº OLTP Database éƒ½å¾ˆé‡é‡çº§ã€‚YARN æŒ‰ç…§ DRF ä¹‹ç±»çš„æ–¹å¼è¿›è¡Œè°ƒåº¦ã€‚</p><p>æ•°æ®åœ¨è¿™é‡Œå­˜å‚¨åœ¨ HDFS ä¸Šã€‚</p><p>è¿™é‡Œè®¡ç®—å¼•æ“è¿˜æœ‰å¯¹åº”çš„ï¼š</p><ul><li>MapReduce</li><li>Tez</li></ul><p>MapReduce å¦‚ä¸‹å›¾æ‰€ç¤º</p><p><img src="https://image.mwish.me/blog-image/hive-and-mr.png" alt="hive-and-mr"></p><p><img src="https://image.mwish.me/blog-image/tez-and-hive.png" alt="tez-and-hive"></p><p>Hive è¿˜æœ‰ LLAP æ¨¡å¼ï¼Œè¿™é‡Œç›¸å½“äºæŒä¹…é©»ç•™è¿›ç¨‹ï¼Œæœ‰ç‚¹ç±»ä¼¼ç°ä»£äººå¿ƒç›®ä¸­çš„ database (ä½†è¯åˆè¯´å›æ¥ï¼ŒæŸç§æ„ä¹‰ä¸Šï¼Œé LLAP é‚£å¥—è¿˜æŒº<strong>äº‘</strong>ï¼‰</p><p><img src="https://image.mwish.me/blog-image/tez-llap.png" alt="tez-llap"></p><p>LLAP æ¨¡å¼ä¸­ï¼Œå¯ä»¥ï¼š</p><ol><li>push å¯¹åº”çš„æ•°æ®ï¼Œè€Œä¸ç”¨å¿…é¡» shuffle åˆ° HDFS ä¸Š</li><li>ç¼“å­˜æ•°æ®</li><li>â€¦</li></ol><p>æ­¤å¤–ï¼Œè¿™é‡Œè¿˜æ”¯æŒè®¡ç®—è°ƒåº¦åˆ° Hive ä¸Š.</p><h2 id="Partition-amp-Bucket"><a href="#Partition-amp-Bucket" class="headerlink" title="Partition &amp; Bucket"></a>Partition &amp; Bucket</h2><p><a href="https://cwiki.apache.org/confluence/display/Hive/Design">Design - Apache Hive - Apache Software Foundation</a></p><ul><li>Table æ˜¯ HDFS ä¸Šçš„ä¸€ä¸ªç›®å½•</li><li>Partition è¢«è®¾ç½®æˆ HDFS ä¸Šçš„ä¸€ä¸ªç›®å½•</li><li>Bucket ä½œä¸ºä¸€ä¸ªæ–‡ä»¶æ¥è¢«å­˜å‚¨</li></ul><p>è¿™å°±æ˜¯ Hive çš„è¡¨ç»“æ„ï¼ŒIceberg ä¼˜åŒ–äº†è¿™ä¸ªè¡¨ç»“æ„ã€‚</p><p><img src="https://image.mwish.me/blog-image/hive-partition-and-buckets.png" alt="hive-partition-and-buckets"></p><h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><ul><li>é¢è¯•|ä¸å¯ä¸çŸ¥çš„åå¤§Hiveè°ƒä¼˜æŠ€å·§æœ€ä½³å®è·µ - å¤§æ•°æ®æŠ€æœ¯ä¸æ•°ä»“çš„æ–‡ç«  - çŸ¥ä¹ <a href="https://zhuanlan.zhihu.com/p/296254978">https://zhuanlan.zhihu.com/p/296254978</a></li><li>SQL to Hive CheatSheet: <a href="https://hortonworks.com/wp-content/uploads/2016/05/Hortonworks.CheatSheet.SQLtoHive.pdf">https://hortonworks.com/wp-content/uploads/2016/05/Hortonworks.CheatSheet.SQLtoHive.pdf</a></li><li><strong>Hiveæ€§èƒ½è°ƒä¼˜å®æˆ˜</strong> </li><li>Hive Wiki: <a href="https://cwiki.apache.org/confluence/display/Hive/">https://cwiki.apache.org/confluence/display/Hive/</a></li><li>HCatalog Wiki: <a href="https://cwiki.apache.org/confluence/display/Hive/HCatalog">https://cwiki.apache.org/confluence/display/Hive/HCatalog</a></li></ul>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Beyond Parquet: ORC and new file format</title>
      <link href="/2023/03/11/Beyond-Parquet-ORC-and-new-file-format/"/>
      <url>/2023/03/11/Beyond-Parquet-ORC-and-new-file-format/</url>
      
        <content type="html"><![CDATA[<p>Apache Parquet æ˜¯ä¸€ä¸ªåŠŸèƒ½å¼ºå¤§çš„åˆ—å­˜ç³»ç»Ÿï¼Œä¸è¿‡ä¹Ÿæœ‰ä¸€äº›åŒç±»çš„é¡¶çº§é¡¹ç›®ï¼Œæ¯”å¦‚ Apache ORCã€‚Google è‡ªå·±å‘è¿‡ä¸€äº› Capacitor æ ¼å¼ï¼Œä½œä¸º Dremel (BigQuery) çš„æ–‡ä»¶æ ¼å¼ã€‚æ­¤å¤–ï¼ŒBiswapesh Chattopadhyay åœ¨ä¸€äº›æ–°çš„è®ºæ–‡ä¸­è°ˆè¿‡ Youtube (2019) å’Œ Shared Foundations (CIDRâ€™23) ä¸€äº›è®¾è®¡çš„æ–°çš„æ ¼å¼ã€‚</p><p>æ­¤å¤–ï¼Œè¿˜æœ‰äººä¸º AI workload åšäº†ä¸€äº›ç‰¹æ®Šçš„æ ¼å¼ï¼Œæ¯”å¦‚ IndexR. åŒ…æ‹¬è¿˜æœ‰å†å²æ‚ ä¹…çš„ HDF5 å’Œæ–°é²œçš„ lanceã€‚</p><p>è¿™äº›æ ¼å¼çš„éœ€æ±‚å„æœ‰ä¸åŒï¼Œå’Œæˆ‘ç†Ÿæ‚‰çš„ Parquet ç›¸æ¯”æœ‰åŒæœ‰å¼‚ã€‚ä¸‹é¢å¯ä»¥å¼€å§‹ç®€å•ä»‹ç»</p><h2 id="Apache-ORC"><a href="#Apache-ORC" class="headerlink" title="Apache ORC"></a>Apache ORC</h2><p>Apache ORC ç”± Hive ç¤¾åŒºå¼€å‘ï¼Œå¦‚æœä½ å¬è¿‡ RC æˆ–è€… RCFile çš„è¯ï¼Œä¼šå‘ç° ORC è¿™ä¸ªåå­—æœ‰ç‚¹ç†Ÿæ‚‰ï¼Œå…¶å® ORC å‰é¢é‚£ä¸ª O æ˜¯ Optimized çš„æ¦‚å¿µã€‚Apache ORC è‡ªè®¤ä¸ºå¯ä»¥ï¼š</p><ul><li>typed, self-describe</li><li>æŒ‘é€‰åˆé€‚çš„ encoding æ–¹å¼</li><li>æä¾› Index</li><li>åˆ‡åˆ† 10000 rowsï¼Œç„¶å Predicate Pushdown</li><li>æ”¯æŒ ComplexType: Map, Union, Struct, List</li></ul><p>Apache ORC æœ‰ä¸‰ä¸ªç‰ˆæœ¬ï¼š</p><ol><li>v0: Hive æ—§ç‰ˆæœ¬ä½¿ç”¨</li><li>V1: Hive1.0 å’Œ 0.12 ä¹‹åä½¿ç”¨</li><li>V2: ä¸çŸ¥é“å•¥çŠ¶æ€ï¼Œå¥½åƒæ¯æ¬¡çœ‹éƒ½æ˜¯ TODOï¼Œè™½ç„¶å†…å®¹æŒºå¤šçš„</li></ol><p>Apache ORC æ ¼å¼å¦‚ä¸‹å›¾ï¼Œæœ‰ä¸€äº›ç›¸ä¼¼çš„æ¦‚å¿µï¼š</p><ul><li>File Tail: ç±»ä¼¼ Parquet çš„ Footer å’Œ FileMetaDataï¼Œåœ¨æ–‡ä»¶çš„å°¾éƒ¨<ul><li>File Tail åŒ…å« encrypted statistics, stripe metadata, Footer , file footer, postscript</li><li>PostScript: æ–‡ä»¶æœ¬èº«å…ƒä¿¡æ¯ï¼ŒåŒ…æ‹¬ç‰ˆæœ¬ï¼ŒFooter é•¿åº¦ï¼Œå†™è€…ï¼ˆå¾ˆå¥‡æ€ªçš„æ˜¯ç«Ÿç„¶æœ‰æ–‡ä»¶å‹ç¼©æ–¹å¼ï¼‰</li><li>File Footer ç±»ä¼¼ Parquet Footerï¼Œæ˜¯ä¸€ä¸ª protobufï¼Œå†…å®¹å¦‚ä¸‹ï¼š<a href="https://github.com/apache/orc/blob/main/proto/orc_proto.proto#L354">https://github.com/apache/orc/blob/main/proto/orc_proto.proto#L354</a><ul><li>åŒ…å«æ–‡ä»¶ç±»å‹ï¼Œæ•´ä¸ªæ–‡ä»¶çš„ statisticsï¼Œæ–‡ä»¶ headerï¼Œæ‰€æœ‰ Stripe çš„ä¿¡æ¯</li><li>Stripe ä¿¡æ¯åŒ…å« Stripe çš„èµ·å§‹åœ°ï¼Œindex é•¿åº¦ï¼ŒRow Data é•¿åº¦ï¼ŒStripe Footer é•¿åº¦ï¼Œè¡Œæ•°</li><li>Type åŒ…å«æ–‡ä»¶ç±»å‹ï¼Œæ•´ä¸ªæ–‡ä»¶æœ‰ç›¸åŒçš„ç±»å‹ã€‚</li><li>ColumnStatistics åŒ…å«å„åˆ—çš„ min/max/hasNull</li><li>user metadata: å¡å…¥ key-value</li><li>Encryption ç›¸å…³çš„ä¿¡æ¯ï¼Œä¸å¤ªæ‡‚åŠ å¯†ï¼Œä¸å†™äº†</li></ul></li></ul></li><li>Index: Parquet æœ‰ BloomFilter å’Œæ²¡æœ‰å®ç°ä»»ä½• Index çš„ Index Page (ç¬‘)ï¼ŒORC æœ‰ Index Data</li><li>Stripe: å¯¹åº” Parquet çš„ RowGroupï¼Œç”± Index Data + Row Data + Stripe Footer æ„æˆã€‚Row ä¸ä¼šè·¨ Stripeã€‚<ul><li>Stripe é€šå¸¸æ¯”è¾ƒå¤§ (~200MB)ï¼Œå¯ä»¥å½“ä½œå¹¶å‘çš„å•ä½</li><li>Stripe æ•°æ®è¢«å­˜å‚¨åœ¨ç›¸é‚»çš„å¤šä¸ª Stream ä¸­ã€‚åˆ—çš„æ•°æ®æ°›å›´ Present Stream å’Œ Data Streamï¼ŒPresent å­˜æ”¾ç±»ä¼¼ null çš„ä¿¡æ¯ï¼ŒStream æœ‰è‡ªå·±çš„ Kind, lengthã€‚æˆ‘ä»¬ä¹‹åå†æ¥ä»‹ç»å®ƒæ˜¯å¦‚ä½•è¡¨ç¤º Complex Type çš„ã€‚Present Stream æ˜¯é å‹ç¼©å’Œ Encoding æ¥å‡å°‘ç©ºé—´å¼€é”€çš„</li><li>æ­¤å¤–ï¼Œç´¢å¼•ã€Statsä¹‹ç±»çš„å†…å®¹ä¹Ÿè¢«ç»Ÿä¸€åˆ°äº† Stream ä¸­ï¼Œç”± Stream è¡¨ç¤º</li></ul></li></ul><p><img src="https://image.mwish.me/blog-image/gpdhpp5sx7.jpeg" alt="gpdhpp5sx7"></p><p>Orc çš„ Compression åˆ°å¤„éƒ½æ˜¯ï¼Œå®ƒé™¤äº† Postscriptï¼Œå„æ®µéƒ½ä¼šç”¨ Postscript æŒ‡å®šçš„ compression æ¥ç¼–ç ï¼Œæ­¤å¤–ï¼Œè¿™é‡Œä¼šæœ‰ä¸€äº› <code>is_compression</code> flagï¼Œ Parquet çš„ Page V1 æ˜¯æ²¡æœ‰è¿™ä¸ªä¸œè¥¿çš„ï¼ŒPage V2 æ‰æœ‰ã€‚å‹ç¼©æ•ˆæœä¸å¥½çš„æ—¶å€™ï¼Œå¯ä»¥é€šè¿‡è¿™ä¸ª flag æ¥å–æ¶ˆå‹ç¼©ã€‚</p><p>åœ¨æ•°æ®å±‚ï¼ŒOrc é’ˆå¯¹ä¸åŒçš„ç±»å‹æ”¯æŒäº†ä¸åŒçš„ Encoding æ–¹å¼ï¼Œå…¶å®æˆ‘æ„Ÿè§‰ç±»ä¼¼ Parquet äº†ã€‚Present å¼ºè°ƒç”¨ Boolean RLE ç¼–ç ã€‚ORC æ”¯æŒäº†ï¼š</p><ol><li>RLE</li><li>Dictionary</li></ol><p>è¿™æ ·çš„ç¼–ç æ–¹å¼ï¼Œå…·ä½“è€Œè¨€ï¼ŒRLE ç±»ä¼¼ Parquet çš„ RLEï¼Œå¯èƒ½ä¹Ÿä¼šæœ‰ delta ä¹‹ç±»çš„é€»è¾‘ã€‚Dict ç¼–ç ä¼šåˆ†æˆå¤šæ¡ Stream æ¥å†™ã€‚æ­¤å¤–ï¼ŒORC è¿˜æœ‰ SECONDARY Streamï¼Œç”¨æ¥è¡¨ç¤ºä¸€äº›å¼‚æ„çš„å€¼ã€‚ç®€å•æ¥è¯´ï¼š</p><ul><li>Orc æŠŠåˆ—æ‹†æˆäº†å¤šæ¡ Stream</li><li>ä¼˜åŒ–å¥½äº† Stream çš„å¯¹å„ç§ç±»å‹çš„ç®€å•ç¼–ç æ–¹å¼</li><li>ç”¨è¿™ç§ç®€å•ç¼–ç  + å¤šæ¡æµè¡¨ç¤ºç±»å‹</li></ul><p>ç¼–ç æ–¹å¼æˆ‘å°±ä¸ä»‹ç»äº†ï¼Œä¹‹åä¸“é—¨å¼€ä¸ªä¸“é¢˜å•ƒç®—äº†ï¼Œæ„Ÿè§‰æ”¾è¿™ä¸å¤ªå¥½ã€‚</p><p>å¯¹äº Complex ç±»å‹çš„è¡¨ç¤ºï¼Œç®€å•æ¥è¯´å¦‚ä¸‹ï¼š</p><ol><li>Struct åªè®°å½• Struct æœ¬èº«çš„ PRESENT</li><li>List = Present Stream + Length Stream</li><li>Map = Map ç­‰ä»·äºä¸€ç§å¾ˆå¥‡æ€ªçš„ List å’Œ List è¡¨ç°ä¸€æ ·ï¼Œä½†åé¢æœ‰ä¸€ç»„ Key ä¸€ç»„ Value</li><li>Union åˆ†æˆ PRESENT + Tagï¼Œåé¢æ¥ä¸åŒç§ç±»çš„ Stream</li></ol><h3 id="Statistics-amp-Index"><a href="#Statistics-amp-Index" class="headerlink" title="Statistics &amp; Index"></a>Statistics &amp; Index</h3><p>ä¹¦æ¥ä¸Šå›ï¼ŒOrc çš„ format æ”¯æŒäº†ä¸€å¤§æŠŠä¸åŒçš„ Statistics. Parquet çš„ Statistics é  bytes æ¥æ€¼é€šç”¨æ€§ï¼ŒOrc åˆ™æ˜¯å®šä¹‰äº†ä¸€å † adhoc çš„ä¸œè¥¿ï¼Œä½†æ˜¯è¿™å¹¶ä¸è¦ç´§â€¦</p><figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">message </span><span class="title class_">ColumnStatistics</span> &#123;</span><br><span class="line">  <span class="keyword">optional</span> <span class="type">uint64</span> numberOfValues = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">optional</span> IntegerStatistics intStatistics = <span class="number">2</span>;</span><br><span class="line">  <span class="keyword">optional</span> DoubleStatistics doubleStatistics = <span class="number">3</span>;</span><br><span class="line">  <span class="keyword">optional</span> StringStatistics stringStatistics = <span class="number">4</span>;</span><br><span class="line">  <span class="keyword">optional</span> BucketStatistics bucketStatistics = <span class="number">5</span>;</span><br><span class="line">  <span class="keyword">optional</span> DecimalStatistics decimalStatistics = <span class="number">6</span>;</span><br><span class="line">  <span class="keyword">optional</span> DateStatistics dateStatistics = <span class="number">7</span>;</span><br><span class="line">  <span class="keyword">optional</span> BinaryStatistics binaryStatistics = <span class="number">8</span>;</span><br><span class="line">  <span class="keyword">optional</span> TimestampStatistics timestampStatistics = <span class="number">9</span>;</span><br><span class="line">  <span class="keyword">optional</span> <span class="type">bool</span> hasNull = <span class="number">10</span>;</span><br><span class="line">  <span class="keyword">optional</span> <span class="type">uint64</span> bytesOnDisk = <span class="number">11</span>;</span><br><span class="line">  <span class="keyword">optional</span> CollectionStatistics collectionStatistics = <span class="number">12</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬çš„å…³é”®æ˜¯ï¼ŒStatistics å¯èƒ½å‡ºç°åœ¨ä»€ä¹ˆåœ°æ–¹ï¼Ÿ</p><figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// StripeStatistics (1 per a stripe), which each contain the</span></span><br><span class="line"><span class="comment">// ColumnStatistics for each column.</span></span><br><span class="line"><span class="comment">// This message type is only used in ORC v0 and v1.</span></span><br><span class="line"><span class="keyword">message </span><span class="title class_">StripeStatistics</span> &#123;</span><br><span class="line">  <span class="keyword">repeated</span> ColumnStatistics colStats = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// This message type is only used in ORC v0 and v1.</span></span><br><span class="line"><span class="keyword">message </span><span class="title class_">Metadata</span> &#123;</span><br><span class="line">  <span class="keyword">repeated</span> StripeStatistics stripeStats = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½ ä¼šå‘ç°ï¼Œè¿™é‡Œ Statistics éƒ½æ˜¯ Stripe çº§åˆ«çš„ã€‚é‚£ä¹ˆæœ‰æ²¡æœ‰æ›´ç»†ç²’åº¦çš„ Statistics å‘¢ï¼Ÿæœ‰ï¼ŒRow Group Indexã€‚</p><p>è¿™é‡Œçš„ RowGroup å’Œ Parquet çš„ Row Group æ˜¯ä¸åŒçš„æ¦‚å¿µï¼Œç±»ä¼¼ Parquet ä¸­çš„ Page Statisticsï¼Œä¸è¿‡æœ‰ä¸€äº› trickey çš„ RLE ç»†èŠ‚ï¼š</p><figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">message </span><span class="title class_">RowIndexEntry</span> &#123;</span><br><span class="line"> <span class="keyword">repeated</span> <span class="type">uint64</span> positions = <span class="number">1</span> [packed=<span class="literal">true</span>];</span><br><span class="line"> <span class="keyword">optional</span> ColumnStatistics statistics = <span class="number">2</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>To record positions, each stream needs a sequence of numbers. For uncompressed streams, the position is the byte offset of the RLE runâ€™s start location followed by the number of values that need to be consumed from the run. In compressed streams, the first number is the start of the compression chunk in the stream, followed by the number of decompressed bytes that need to be consumed, and finally the number of values consumed in the RLE.</p></blockquote><p>è¿™ä¸ªåœ°æ–¹å°±æ˜¯ hack åˆ° RLE format å†…éƒ¨äº†ã€‚</p><h3 id="ACID"><a href="#ACID" class="headerlink" title="ACID?"></a>ACID?</h3><p>ORC æ˜¯ Hive çš„äº²å„¿å­ï¼Œåœ¨ format æ ‡æ³¨ä¸Šï¼Œå®ƒå†™äº†ä¸€äº› Deltaã€‚è¿™ä¸ªæ„Ÿè§‰ç¿»ç¿» iceberg å°±è¡Œäº†.</p><h2 id="Capacitor-in-Dremel"><a href="#Capacitor-in-Dremel" class="headerlink" title="Capacitor in Dremel"></a>Capacitor in Dremel</h2><p>Capacitor æ˜¯ Parquet çš„é‡çˆ¹ï¼Œä¹‹æ‰€ä»¥è¯´ä¸æ˜¯äº²çˆ¹â€¦Google å•¥æ—¶å€™æˆè¿‡äº²çˆ¹ï¼ŸParquet æ˜¯ Twitter å’Œ LinkedIn ä¸€èµ·å®é™…å¼€å‘çš„ï¼Œç„¶å 15 å¹´æˆäº†é¡¶çº§é¡¹ç›®ï¼ŒG+ å°±å–œæ¬¢æ†‹å¤§æ‹›çš„ã€‚</p><p>Google è¿™å®¶ä¼™è´¼å–œæ¬¢è—å¤§æ‹›ï¼Œä½†æ˜¯è¿™é‡Œé€éœ²çš„ææ–™è¿˜æ˜¯ä¸é”™çš„ï¼š</p><ul><li>å‚è€ƒ Storing and Querying Tree-Structured Records in Dremel: <a href="https://research.google/pubs/pub43119/">https://research.google/pubs/pub43119/</a> åšè°“è¯ä¸‹æ¨å’Œ encoding + query execã€‚</li><li>é‡‡æ ·æ•°æ®ï¼Œå­˜å‚¨åˆ° Meta ä¸­ï¼Œå¸®åŠ©æä¾›äº†ä¸€å¥— Reordering Record çš„æ–¹å¼ã€‚è¿™é‡Œå¯ä»¥å‚è§ Arxiv: <a href="https://arxiv.org/abs/1207.2189">https://arxiv.org/abs/1207.2189</a></li></ul><p>åœ¨è¿™é‡Œï¼Œæˆ‘æ„Ÿè§‰è¿™é‡Œä¸æ˜¯å•çº¯çš„æ ¼å¼äº†ï¼Œè€Œæ˜¯ä¸€å¥—è‡ªä¸Šè€Œä¸‹çš„ Stats/Reorder + Format + Query Exec èåˆçš„ç³»ç»Ÿäº†ã€‚Query Exec çš„åœ°æ–¹æˆ‘æ„Ÿè§‰æˆ‘å¯ä»¥å€Ÿé‰´ä¸€ä¸‹ï¼Œä½†æ˜¯ Stats + Reorder æˆ‘æ„Ÿè§‰æˆ‘å°±ä¸ä¼šæäº† Orzã€‚</p><h2 id="HTAP-HSAP-Design"><a href="#HTAP-HSAP-Design" class="headerlink" title="HTAP/HSAP Design"></a>HTAP/HSAP Design</h2><p>åœ¨ AP ä¸­ï¼Œæ•°æ®ç»å¸¸æ˜¯ä¸‹æ¨ Filterï¼Œç„¶åæ‰«å¤§é‡æ•°æ®ã€‚HTAP / HSAP è¿™ç§åœºæ™¯ï¼Œä¼šæ··æ‚ Point Lookup å’Œ Range Filterã€‚å¯¹äº Point Lookup æ¥è¯´ï¼Œåœ¨å‹ç¼©çš„ Group ä¸­æ„Ÿè§‰æ•ˆæœæ˜¯ä¸å¤ªå¥½çš„ï¼Œå› ä¸ºè¿™é‡Œæœ‰ä¸ªé—®é¢˜æ˜¯ï¼Œå¯èƒ½éœ€è¦èµ°ä¸€é è§£å‹ + Decodingã€‚</p><p>HTAP / HSAP çš„åœºæ™¯ï¼Œåœ¨è¿™æ–¹é¢èƒ½å¤Ÿé€‰å‡ºæ¯”è¾ƒå¥½çš„æ ¼å¼ï¼Œéœ€è¦æœ‰ Skipable çš„ formatï¼Œå¿«é€Ÿæ‰¾åˆ°å¯¹åº”çš„åˆ—ã€‚</p><p>SingleStore çš„åšæ³•åœ¨åšå®¢ä¸­æœ‰æåˆ°ï¼š<a href="https://www.singlestore.com/blog/winter-2022-universal-storage-part-5/">https://www.singlestore.com/blog/winter-2022-universal-storage-part-5/</a> . ç®€å•è¯´æ˜¯é ç´¢å¼• + Encoding Skip æ¥å®ç°ï¼ŒRLE / LZ4 éƒ½æ˜¯æœ‰ç±»ä¼¼ RLE çš„æ€§è´¨çš„ï¼Œå› ä¸ºæœ‰ RLE çš„æ€§è´¨ï¼Œæ‰€ä»¥å¯ä»¥åœ¨æœ‰ Secondary Index to RowId çš„æƒ…å†µä¸‹ï¼Œåšä¸€äº›å¿«é€Ÿçš„ Skippingã€‚</p><p>åœ¨ Procella: Unifying serving and analytical data at YouTube è¿™ç¯‡è®ºæ–‡ä¸­ï¼Œä½œè€…æè¿°äº† HSAP ä¸­çš„æ ¼å¼ Artusï¼Œç³»ç»Ÿç”¨è¿™ä¸ªæ ¼å¼æ¥ä»£æ›¿ Capacitorã€‚è¿™ä¸ªæ ¼å¼ä¹Ÿæ˜¯ç»™ç›¸ä¼¼çš„é€»è¾‘è®¾å®šçš„ï¼Œä½†æ˜¯ç›¸å¯¹äº S2DB è¿™ç§é  Secondary Index çš„ï¼Œå®ƒè¿™é‡Œè¿˜æ˜¯ä¼šåšä¸€äº›ï¼ˆä¸»åŠ¨çš„ï¼‰æœç´¢çš„ï¼š</p><ol><li>ï¼ˆç±»ä¼¼ S2DBï¼‰ï¼Œé¿å…ç”¨é€šç”¨çš„ compressionï¼Œå€¾å‘äº Seekable format</li><li>Multi-pass adaptive encoding: å…ˆé‡‡é›† ndv/min-max/sorting ä¹‹ç±»çš„ä¿¡æ¯ï¼Œå† adaptive é€‰æ‹©ç¼–ç æ–¹å¼ã€‚Artus æä¾›äº†ä¸€å¥— encoding data çš„ evaluation: Dict, Index, RLE, Delta è¿™äº›æ–¹å¼ï¼ŒåŒæ—¶ï¼Œæ ¼å¼æä¾›äº†ä¸€ä¸ª Scoreï¼Œèƒ½æ ¹æ® (size, speed) æ¯”è¾ƒå¥½è¯„ä¼°è¿™äº›æ ¼å¼çš„ä»£ä»·ï¼Œæ¥åš eval</li><li>é‡‡ç”¨ Binary Search able çš„ç¼–ç æ–¹å¼ï¼Œå…è®¸ç”¨æˆ·ä»¥ $O(logN)$ çš„ Complexity å»æœç´¢<ol><li>$O(1)$ çš„ Seek to RowIdã€‚è¿™ä¸ªåœ¨ç­‰å®½ bitpacking ä¸Šæ²¡å•¥é—®é¢˜ï¼Œä½†æ˜¯åˆ«çš„ RLE ä¹‹ç±»çš„ï¼Œéœ€è¦å‡†å¤‡ä¸€äº›ç¨€ç–ç´¢å¼•ï¼ˆSkip Blockï¼‰ï¼Œè¿™é‡Œ Block Size é€šå¸¸æ˜¯ 32/128ï¼Œæ¥ä¿è¯è¿™ä¸ªå¾ˆå°ï¼ˆParquet C++ ç°åœ¨ æ˜¯å¾ˆå‚»é€¼çš„ 32 * 4ï¼‰</li><li>$O(logN + K)$ çš„ Primary Key Searching</li></ol></li><li>ç”¨ ORC é‚£ç§æ–¹å¼æ¥å­˜ã€‚æˆ‘æ„Ÿè§‰è¿™ç§æ ¼å¼åœ¨ HTAP Nested Search ä¸Šæœ‰ä¸€äº›ä¼˜åŠ¿ï¼Ÿæ¯•ç«Ÿ Parquet é‚£ç§ format row-id å¯¹ä¸€äº›ä¸œè¥¿å…¶å®è¿˜æ˜¯è¦åè§£ rep/def çš„ã€‚</li><li>æš´éœ² Dictionary Index å’Œ RLE ç»™å¼•æ“ï¼Œæ–¹ä¾¿ Pushdown</li><li>å°è¯•æš´éœ²å¾ˆå¤šå…ƒä¿¡æ¯ï¼Œç„¶åæŒ‰ç…§ pk åˆ‡åˆ†æ–‡ä»¶ï¼Œä¿è¯ï¼ˆç²—ç²’åº¦çš„ï¼‰è¿‡æ»¤æ€§</li><li>æ”¯æŒ inverted index (S2DB ä¹Ÿèµ°äº†è¿™æ¡è·¯)</li></ol><p>æ„Ÿè§‰ HTAP çš„åœºæ™¯ä¸Šè¿°è¿˜æ˜¯è¦æ”¯æŒçš„ã€‚</p><h2 id="AI-The-Old-one-and-The-new-one"><a href="#AI-The-Old-one-and-The-new-one" class="headerlink" title="AI, The Old one and The new one"></a>AI, The Old one and The new one</h2><p>åœ¨ AI é¢†åŸŸï¼Œæœ‰ HDF5 æ ¼å¼ä¹‹ç±»çš„è€ä¸œè¥¿ï¼Œè¿˜æœ‰æ–°çš„å¾ˆå¤šå­˜å‚¨ç³»ç»Ÿç±»ä¼¼ Feature Storeï¼Œä¼šå­˜ä¸€äº›ç¨€ç–çš„å¤§å®½è¡¨ï¼Œæ¯”å¦‚ä¸‹é¢è®ºæ–‡çš„æè¿°ï¼š</p><blockquote><p>For example, it is increasingly common for ML tables to outgrow analytical tables by up to an order of magnitude. ML tables are also typically much wider, and tend to have tens of thousands of features usually stored as large maps.</p></blockquote><p>è¿™ä¸ªé¢†åŸŸå¯ä»¥ç®€å•å½“æˆå¯èƒ½æœ‰ç¨€ç–çš„å¤§å®½è¡¨ï¼Œæœ‰ä¸€äº›éšæœºè®¿é—®ï¼Œä½†æ˜¯åˆæ˜¯åˆ—å­˜ï¼Ÿåœ¨ è¿™é‡Œï¼š</p><ol><li>Shared Foundations æå‡ºäº†ä¸€äº›å…ƒæ•°æ®ä¼˜åŒ–ï¼Œå› ä¸º Orc / Parquet åˆ—å…ƒæ•°æ®éƒ½å¾ˆå¤§äº†ï¼Œä½†æ˜¯æ²¡æè‡ªå·±æ˜¯æ€ä¹ˆåšçš„</li><li>HDF5 ç®€å•çš„å°†æ•°æ®é›†æ‰“åŒ…</li><li>lance æ˜¯ä¸€ä¸ªæ–°çš„æ ¼å¼ï¼Œç±»ä¼¼ ORCï¼Œå¦ç™½çš„è¯´ï¼Œå®ƒåœ¨ PPT é‡Œé¢å†™çš„ä¸œè¥¿éƒ½æ˜¯åƒåœ¾ï¼Œä½†æ˜¯çœ‹åˆ°å®ƒæ”¯æŒäº†ä¸€äº› ad-hoc çš„ kmeans ä¹‹ç±»çš„ä¸œè¥¿ï¼Œè¿˜æ˜¯æŒºæœ‰æ„æ€çš„ã€‚</li></ol><h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><ul><li><p>Parquet / Capacitor</p><ul><li>InfluxDB-IOx çš„ Parquet ä½¿ç”¨ <a href="https://www.influxdata.com/blog/querying-parquet-millisecond-latency/">https://www.influxdata.com/blog/querying-parquet-millisecond-latency/</a></li><li>Dremel: Interactive Analysis of Web-Scale Datasets: <a href="https://research.google/pubs/pub36632/">https://research.google/pubs/pub36632/</a></li><li>Storing and Querying Tree-Structured Records in Dremel: <a href="https://research.google/pubs/pub43119/">https://research.google/pubs/pub43119/</a></li><li><a href="https://cloud.google.com/blog/products/bigquery/inside-capacitor-bigquerys-next-generation-columnar-storage-format">https://cloud.google.com/blog/products/bigquery/inside-capacitor-bigquerys-next-generation-columnar-storage-format</a><ul><li>å€¼å¾—ä¸€æçš„æ˜¯ï¼Œè¿™ä¸ªæ–‡ç« çš„è€æ¿å·²ç»å» firebolt å½“è€æ¿äº†</li></ul></li></ul></li><li><p>lance: <a href="https://github.com/eto-ai/lance">https://github.com/eto-ai/lance</a></p></li><li><p>ç‰¹å¾å¹³å°ï¼ˆFeature Storeï¼‰ï¼šåºè®º - æ›¾ä¸­é“­çš„æ–‡ç«  - çŸ¥ä¹ <a href="https://zhuanlan.zhihu.com/p/406897374">https://zhuanlan.zhihu.com/p/406897374</a></p></li><li><p>Guide to File Formats for Machine Learning: Columnar, Training, Inferencing, and the Feature Store <a href="https://towardsdatascience.com/guide-to-file-formats-for-machine-learning-columnar-training-inferencing-and-the-feature-store-2e0c3d18d4f9">https://towardsdatascience.com/guide-to-file-formats-for-machine-learning-columnar-training-inferencing-and-the-feature-store-2e0c3d18d4f9</a></p></li></ul>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>[WIP] Storage in AP Systems</title>
      <link href="/2023/03/05/Storage-in-AP-Systems/"/>
      <url>/2023/03/05/Storage-in-AP-Systems/</url>
      
        <content type="html"><![CDATA[<h2 id="ä¸Šå±‚æ¶æ„-å¯¹å­˜å‚¨çš„éœ€æ±‚"><a href="#ä¸Šå±‚æ¶æ„-å¯¹å­˜å‚¨çš„éœ€æ±‚" class="headerlink" title="ä¸Šå±‚æ¶æ„ / å¯¹å­˜å‚¨çš„éœ€æ±‚"></a>ä¸Šå±‚æ¶æ„ / å¯¹å­˜å‚¨çš„éœ€æ±‚</h2><p>ç›¸å…³çš„è®ºæ–‡ï¼š</p><ol><li>SIGMODâ€˜16ï¼ŒçŸ¥åçš„ï¼š <a href="https://www.snowflake.com/resource/sigmod-2016-paper-snowflake-elastic-data-warehouse/">The Snowflake Elastic Data Warehouse</a></li><li>SIGMODâ€™22: Amazon Redshift Reinvent</li><li>NSDIâ€™20: snowflake çš„å¼¹æ€§å­˜å‚¨ï¼šBuilding An Elastic Query Engine on Disaggregated Storage</li><li>(BigQuery) Dremel: A Decade of Interactive SQL Analysis at Web Scale</li><li>PushdownDB / FlexPushdownDB</li></ol><p>æˆ‘ä»¬åˆ†æˆå‡ ä¸ªå­è¯é¢˜</p><p>æ•°æ®åˆ†å¸ƒï¼š</p><ol><li>[PVLDBâ€™20] Fast and effective distribution-key recommendation for amazon redshift / [SIGMODâ€™20] Learning a partitioning advisor for cloud databases.</li><li><a href="https://cloud.google.com/blog/topics/developers-practitioners/bigquery-admin-reference-guide-storage">https://cloud.google.com/blog/topics/developers-practitioners/bigquery-admin-reference-guide-storage</a> / snowflake paper</li></ol><h3 id="è°ƒåº¦-å¼¹æ€§"><a href="#è°ƒåº¦-å¼¹æ€§" class="headerlink" title="è°ƒåº¦ / å¼¹æ€§"></a>è°ƒåº¦ / å¼¹æ€§</h3><p>è¿™å—å…¶å®ä¸å¤ªå®Œå…¨æ˜¯ AP ç³»ç»Ÿçš„çŸ¥è¯†</p><ul><li>Yarn / Mesos (æœºåˆ¶)</li><li>DRF (ç­–ç•¥)</li></ul><h3 id="è®¡ç®—-colocate"><a href="#è®¡ç®—-colocate" class="headerlink" title="è®¡ç®— ( colocate )"></a>è®¡ç®— ( colocate )</h3><h3 id="Cache"><a href="#Cache" class="headerlink" title="Cache"></a>Cache</h3><p>ç›¸å…³æ–‡ç« ï¼š</p><ol><li><p>facebook å…³äº CacheLib çš„ä¸¤ç¯‡è®ºæ–‡</p></li><li><p>snowflake å¼¹æ€§å­˜å‚¨</p></li><li><p>Crystal: A Unified Cache Storage System for Analytical Databases</p></li><li><p>Alluxio</p></li></ol><h3 id="shuffle-service"><a href="#shuffle-service" class="headerlink" title="shuffle service"></a>shuffle service</h3><ul><li>Cosco: An Efficient Facebook-Scale Shuffle Service</li><li>Dremel: A Decade of Interactive SQL Analysis at Web Scale</li></ul><h3 id="Multi-tanent"><a href="#Multi-tanent" class="headerlink" title="Multi-tanent"></a>Multi-tanent</h3><p>è¿™é‡Œæ„Ÿè§‰å¾—åˆ†å¼€æ¥è®¨è®ºï¼Œ Dynamo è¿™äº›ç”¨çš„éƒ½æ˜¯ quota ä¹‹ç±»çš„ï¼ŒYarn ä¹‹ç±»çš„æ˜¯ä¸Šå±‚è°ƒåº¦ï¼Œæˆ‘ä¸ç¡®å®šè¿™é‡Œåˆä¸åˆé€‚</p><ul><li>StarRocksæŠ€æœ¯å†…å¹• | èµ„æºéš”ç¦»åŸç†è§£æ - <em>StarRocks</em>çš„æ–‡ç«  - çŸ¥ä¹ <a href="https://zhuanlan.zhihu.com/p/605900476">https://zhuanlan.zhihu.com/p/605900476</a></li></ul><h3 id="è®¡ç®—ä¸‹æ¨"><a href="#è®¡ç®—ä¸‹æ¨" class="headerlink" title="è®¡ç®—ä¸‹æ¨"></a>è®¡ç®—ä¸‹æ¨</h3><ul><li>PushdownDB: Accelerating a DBMS using S3 Computation (Presto ç”¨äº†è¿™å¥—é€»è¾‘)</li></ul><h3 id="Metadata"><a href="#Metadata" class="headerlink" title="Metadata"></a>Metadata</h3><ul><li>Big Metadata: When Metadata is Big Data</li><li>Delta-Lake</li></ul><h2 id="å­˜å‚¨æ ¼å¼"><a href="#å­˜å‚¨æ ¼å¼" class="headerlink" title="å­˜å‚¨æ ¼å¼"></a>å­˜å‚¨æ ¼å¼</h2><p>Parquet: <a href="https://github.com/apache/parquet-format/blob/master/Encodings.md">https://github.com/apache/parquet-format/blob/master/Encodings.md</a></p><p>ORC: <a href="https://orc.apache.org/specification/ORCv2/">https://orc.apache.org/specification/ORCv2/</a></p><p>Doris: <a href="https://xie.infoq.cn/article/4f7d09d6185fb3055d4e7e51c">https://xie.infoq.cn/article/4f7d09d6185fb3055d4e7e51c</a></p><p>ClickHouse MergeTree</p><p>HyPer</p><p>Umbra: å†…å­˜æ•°æ®åº“çš„ç‰¹æ®Šä¼˜åŒ–</p><p>Kudu: CFileï¼Œæœ¬è´¨ä¸Šå’Œ Doris é‚£äº› Unique æ˜¯åŒä¸€å¥—</p><h3 id="Encoding"><a href="#Encoding" class="headerlink" title="Encoding"></a>Encoding</h3><p><a href="https://github.com/apache/parquet-format/blob/master/Encodings.md">https://github.com/apache/parquet-format/blob/master/Encodings.md</a></p><p>è¦ç‚¹ï¼šå‹ç¼©ç‡ / æ€§èƒ½å¯¹æ¯”ï¼Œèƒ½å¦ SIMDï¼Œé’ˆå¯¹ pattern åšç‰¹å®šçš„ä¼˜åŒ–ï¼ˆå­é—®é¢˜ï¼šå¦‚ä½•è¯†åˆ« patternï¼‰</p><p>è¿˜æœ‰ä¸€äº› HTAP çš„ç¼–ç æ–¹å¼ã€‚</p><p>æ­¤å¤–ï¼Œå…³æ³¨ SIGMODâ€™21 CodecDB</p><h4 id="Query-on-Encoded-Data"><a href="#Query-on-Encoded-Data" class="headerlink" title="Query on Encoded Data"></a>Query on Encoded Data</h4><p>è¦ç‚¹ï¼š<a href="https://blog.mwish.me/2022/01/15/format-thinking-2/#DB-%E7%9B%B4%E6%8E%A5%E5%9C%A8%E5%8E%8B%E7%BC%A9%E7%9A%84%E6%95%B0%E6%8D%AE%E4%B8%8A%E8%BF%9B%E8%A1%8C%E8%AE%A1%E7%AE%97">https://blog.mwish.me/2022/01/15/format-thinking-2/#DB-%E7%9B%B4%E6%8E%A5%E5%9C%A8%E5%8E%8B%E7%BC%A9%E7%9A%84%E6%95%B0%E6%8D%AE%E4%B8%8A%E8%BF%9B%E8%A1%8C%E8%AE%A1%E7%AE%97</a></p><p>DB å¯ä»¥ç›´æ¥åœ¨å‹ç¼©çš„æ•°æ®ä¸Šè·‘ä¸€äº›ç®€å•çš„è®¡ç®—ï¼Œä½†æ˜¯è¿™ä¸ªéœ€è¦è®©å­˜å‚¨çŸ¥é“å…·ä½“èµ°äº†ä»€ä¹ˆæ ·çš„ç®—å­</p><h4 id="Lazy-Evaluation"><a href="#Lazy-Evaluation" class="headerlink" title="Lazy Evaluation"></a>Lazy Evaluation</h4><p>è¦ç‚¹ï¼šè¡Œä¸­çš„åˆ—å¯ä»¥éœ€è¦çš„æ—¶å€™å† loadï¼Œä¸è®¿é—®å¯ä»¥ä¸åŠ è½½ï¼ŒåŠ è½½å‡ºæ¥çš„ç»“æ„ä¹Ÿå¯ä»¥æ ‡è¯†è‡ªå·±æ˜¯ RLE è¿˜æ˜¯ä»€ä¹ˆæ ·çš„ï¼Œæ¥é¿å…ï¼š</p><ol><li>è®¿é—® Page çš„å¼€é”€</li><li>åŠ è½½ä¸éœ€è¦çš„åˆ—çš„å¼€é”€</li></ol><p>è¿™éƒ¨åˆ†å…¶å®å’Œå®ç°ç»‘å®šçš„ç‰¹åˆ«æ­»ï¼Œä¸»è¦æ˜¯ runtime çš„å®ç°ï¼Œç”šè‡³æœ‰ä¸€äº›æ˜¯ Query Optimizer æœ‰å…³çš„éƒ¨åˆ†</p><h4 id="å­—å…¸å’Œå…¨å±€å­—å…¸"><a href="#å­—å…¸å’Œå…¨å±€å­—å…¸" class="headerlink" title="å­—å…¸å’Œå…¨å±€å­—å…¸"></a>å­—å…¸å’Œå…¨å±€å­—å…¸</h4><p>è¦ç‚¹ï¼šå­—å…¸å’Œå­—ç¬¦ä¸²æœ‰åºæ€§</p><p>ä¾‹å¦‚ï¼š<a href="https://forum.starrocks.com/t/topic/1469">StarRocks2.0.1ä½åŸºæ•°å…¨å±€å­—å…¸ä¼˜åŒ–æµ‹è¯•</a> å’Œ <a href="http://mysql.taobao.org/monthly/2022/08/01/">PolarDB MySQLÂ·HTAPÂ·æµ…æIMCIçš„åˆ—å­˜æ•°æ®å‹ç¼©</a> . è¿™é‡Œå…³å¿ƒï¼š</p><ol><li>æ˜¯å¦èµ°åˆ°å­—å…¸ä¸Šï¼ˆæœ‰çš„åœ°æ–¹å­—ç¬¦ä¸²ç±»å‹ä¹‹å¤–çš„ç±»å‹ä¸ä¼šèµ°åˆ°å­—å…¸ä¸Šï¼‰</li><li>å­—å…¸çš„é¡ºåºæ˜¯å¦å’ŒåŸå§‹é¡ºåºä¸€æ ·</li><li>æ˜¯å¦ç‰©åŒ–ï¼ˆå­—å…¸å¯èƒ½ä¸é‚£ä¹ˆæ€¥ç€ç‰©åŒ–ï¼Œä¸Šå±‚å¯ä»¥æ ¹æ®å­—å…¸æ¥åš JOINã€DISTINCT ä¹‹ç±»çš„ä¼˜åŒ–ï¼‰ã€‚</li></ol><h3 id="ç´¢å¼•"><a href="#ç´¢å¼•" class="headerlink" title="ç´¢å¼•"></a>ç´¢å¼•</h3><p>è¿™é‡Œè¯´ç´¢å¼•è¿™ä¸ªè¯æœ‰æ­§ä¹‰ï¼ŒTP æ–¹é¢ä¸€èˆ¬è¿™é‡ŒæŒ‡å…¨å±€çš„ 1:1 çš„ç´¢å¼•ï¼Œè€Œ AP è¿™é‡Œæ—¢æœ‰ 1:1 çš„ç´¢å¼•ï¼Œæ›´å¤šè¿˜æ˜¯ç¨€ç–ç´¢å¼•ã€Page ä¸Šã€RowGroup ä¸Šçš„ä¿¡æ¯ç»Ÿè®¡ã€‚å› ä¸ºåš skipping è¦è€ƒè™‘è¿™äº›ä¿¡æ¯ï¼Œæ‰€ä»¥æˆ‘ä»¬æ±‡æ€»åˆ°ç´¢å¼•è¿™é‡Œã€‚</p><p>è¿™é‡Œæœ‰ï¼š</p><ol><li>Page ä¸Šçš„ç»Ÿè®¡ä¿¡æ¯ï¼Œä¾‹å¦‚ Page Index / Zone Map</li><li>Z-orderingï¼Œå¯ä»¥å½“æˆæ˜¯æ‹å¹³çš„ zone-map</li></ol><p>å¯å‚è€ƒçš„ï¼š</p><ol><li>pinot: <a href="https://docs.pinot.apache.org/basics/indexing">https://docs.pinot.apache.org/basics/indexing</a></li></ol><p>æœ‰å¾ˆå¤šç»Ÿè®¡ä¿¡æ¯ç›¸å…³çš„ï¼Œè§ï¼š<a href="http://dimacs.rutgers.edu/~graham/ssbd.html">http://dimacs.rutgers.edu/~graham/ssbd.html</a> ã€‚è®ºæ–‡æœ‰</p><ul><li><a href="https://15721.courses.cs.cmu.edu/spring2023/papers/04-olapindexes/hentschel-sigmod18.pdf">Column Sketches: A Scan Accelerator for Rapid and Robust Predicate Evaluation</a> </li></ul><p>æ­¤å¤–ï¼Œè¿˜æœ‰ä¸€äº› SuRF ä¹‹ç±»çš„ Succinct ç±»å‹: <a href="https://6.5210.csail.mit.edu/">https://6.5210.csail.mit.edu/</a></p><p>è¿˜éœ€è¦å…³æ³¨ Inverted Indexï¼Œè§ Luceneã€‚</p><h4 id="ç‰¹æ®Šçš„ç´¢å¼•"><a href="#ç‰¹æ®Šçš„ç´¢å¼•" class="headerlink" title="ç‰¹æ®Šçš„ç´¢å¼•"></a>ç‰¹æ®Šçš„ç´¢å¼•</h4><p>æœ¬æ¥ z-ordering åº”è¯¥æ”¾è¿™é‡Œçš„ï¼Œä½†æ˜¯ç”±äºå…¶é‡è¦æ€§ï¼Œæˆ‘ä»¬æ”¾åˆ°äº†ä¸Šé¢ï¼Ÿ</p><ol><li>ç©ºé—´ç´¢å¼•ã€‚</li><li>ç›¸ä¼¼åº¦ç´¢å¼•ï¼š<a href="https://github.com/ClickHouse/ClickHouse/blob/master/docs/en/engines/table-engines/mergetree-family/annindexes.md">https://github.com/ClickHouse/ClickHouse/blob/master/docs/en/engines/table-engines/mergetree-family/annindexes.md</a></li></ol><h3 id="IO-Pattern"><a href="#IO-Pattern" class="headerlink" title="IO Pattern"></a>IO Pattern</h3><h4 id="Share-nothing"><a href="#Share-nothing" class="headerlink" title="Share-nothing"></a>Share-nothing</h4><p>ClickHouse</p><p>Doris</p><h4 id="Shared-storage"><a href="#Shared-storage" class="headerlink" title="Shared-storage"></a>Shared-storage</h4><p>Apache-Arrow</p><p>Velox</p><h3 id="å˜æ›´-Insert-Update-Delete"><a href="#å˜æ›´-Insert-Update-Delete" class="headerlink" title="å˜æ›´ (Insert / Update / Delete)"></a>å˜æ›´ (Insert / Update / Delete)</h3><ul><li><a href="https://ir.cwi.nl/pub/16172/16172D.pdf">Positional Update Handling in Column Stores</a>ï¼šæœ€æ—©ç”¨ Positional Delta æè¿°åˆ é™¤çš„è®ºæ–‡ä¹‹ä¸€</li><li>SQL Server (Delete + Insert çš„ä»£è¡¨ï¼Œè®ºæ–‡å¾ˆå¤šåœ°æ–¹æè¿°éå¸¸è¯¦ç»†ï¼ŒåŒ…æ‹¬ Positional Delete å’Œ Conditional Delete)</li><li>Kudu ï¼ˆDelta File çš„ä»£è¡¨ï¼Œæœºåˆ¶å’Œ MVCC æ˜¯æ•´åˆçš„ï¼ŒUpdate æ”¯æŒå¾ˆé«˜æ•ˆï¼Œä½†æ˜¯å¯¹ Scan / Pruning ä¸æ˜¯å¾ˆå‹å¥½ï¼‰</li><li>ClickHouse MergeTree ï¼ˆMerge-on-Read çš„ä»£è¡¨ï¼Œæš´åŠ›å®ç°ï¼‰</li><li>TiFlash (å¤æ‚çš„æ ‘ç»“æ„)</li><li>S2DB SingleStore</li></ul><h3 id="MVCC"><a href="#MVCC" class="headerlink" title="MVCC"></a>MVCC</h3><h3 id="ç‰¹æ®Šç±»å‹-struct-array-map-json"><a href="#ç‰¹æ®Šç±»å‹-struct-array-map-json" class="headerlink" title="ç‰¹æ®Šç±»å‹: struct / array / map / json"></a>ç‰¹æ®Šç±»å‹: struct / array / map / json</h3><p>dremel and parquet</p><h3 id="Schema-Evolution"><a href="#Schema-Evolution" class="headerlink" title="Schema Evolution"></a>Schema Evolution</h3><p>Iceberg schema evolution</p><h3 id="Compaction"><a href="#Compaction" class="headerlink" title="Compaction"></a>Compaction</h3><p>kudu compaction</p><h4 id="Auto-Clustering"><a href="#Auto-Clustering" class="headerlink" title="Auto Clustering"></a>Auto Clustering</h4><p>snowflake auto clustering</p><h2 id="æ•°æ®å¯¼å…¥"><a href="#æ•°æ®å¯¼å…¥" class="headerlink" title="æ•°æ®å¯¼å…¥"></a>æ•°æ®å¯¼å…¥</h2><p>CDC: databus</p><p>Flink</p><p>Kafka</p><p>Husky</p><p>BigQuery Streaming / Snowflake Unistore</p><h2 id="Data-Lake"><a href="#Data-Lake" class="headerlink" title="Data Lake"></a>Data Lake</h2><ol><li>Iceberg</li><li>Hudi</li><li>DeltaLake</li></ol>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Parquet C++: Statistics</title>
      <link href="/2023/02/26/Parquet-C-Statistics/"/>
      <url>/2023/02/26/Parquet-C-Statistics/</url>
      
        <content type="html"><![CDATA[<p>ä¸Šé¢ä¸€èŠ‚æˆ‘ä»¬è®¨è®ºäº† arrow ç±»å‹åˆ° Parquet ç±»å‹çš„å¤–å±‚ç±»å‹æ˜ å°„ï¼Œæˆ‘ä»¬å­¦åˆ°çš„æŠ€å·§æ˜¯ï¼Œç”¨ arrow çš„ Schema è½¬æ¢æˆ Parquet çš„ Schemaï¼Œåšç±»å‹æ˜ å°„ï¼Œç„¶åå†—ä½™ä¸€ä»½ Parquet çš„ Schemaã€‚è¿™ä¸€èŠ‚ä»‹ç»çš„æ˜¯ Types and Statistics In Parquetã€‚è¿™èŠ‚çš„å†…å®¹ä¹Ÿæ¯”è¾ƒ Dirtyï¼Œä½†æ˜¯è¿˜æ˜¯å¿…è¦çš„ã€‚æ­¤å¤–ï¼Œè¿™èŠ‚ä¼šæ¶‰åŠä¸€äº› Parquet MR çš„ä»£ç ï¼Œå› ä¸ºå®ƒçš„ä»£ç æ˜¯ã€Œå¥½ / å¯¹ã€çš„ã€‚arrow Schema ä¼šæœ‰å¾ˆå¤šé—®é¢˜ï¼Œæˆ‘ä¹Ÿä¼šå°è¯•ä¿®å¤è¿™äº›é—®é¢˜ã€‚</p><p>æ­¤å¤–ï¼Œè¿™èŠ‚åªæ¶‰åŠæ ‡å‡†çš„ã€åè®®ä¸Šçš„ Statisticsï¼Œå¦‚æœç”¨æˆ·æƒ³æ‰“æ´ï¼Œè¿™ç¯‡æ–‡ç« ä¹Ÿå¯ä»¥æä¾›ä¸€äº› arrow çš„å¤–æŒ‚ã€‚</p><h2 id="Parquet-Standard"><a href="#Parquet-Standard" class="headerlink" title="Parquet Standard"></a>Parquet Standard</h2><h3 id="Statistics"><a href="#Statistics" class="headerlink" title="Statistics"></a>Statistics</h3><p>Parquet åè®®ä¸Šæœ¬èº«ä¼šå¸¦æœ‰ä¸€äº› Statisticsï¼Œåˆ†æˆå¤šéƒ¨åˆ†ï¼š</p><p><code>Statistics</code> ç»“æ„(æˆ‘åœ¨ä¸‹é¢åˆ æ‰äº†å…¼å®¹æ€§å¯¹åº”çš„éƒ¨åˆ†ï¼Œä½†æ˜¯å®é™…ä»£ç æ˜¯è¦å¤„ç†çš„)</p><ol><li>è¿™ä¸ªåœ°æ–¹çš„ <code>max_value</code> å’Œ <code>min_value</code> éƒ½æ˜¯ Parquet å†…éƒ¨çš„ç¼–ç ã€‚æ ¹æ® <code>ColumnOrder</code> å†³å®šï¼Œä»€ä¹ˆæ˜¯ ColumnOrder å‘¢ï¼Ÿä¹‹åä»‹ç»</li><li><code>null_count</code> æ˜¯ä¸ªéå¸¸å¥‡æ€ªçš„ä¸œè¥¿ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ <strong>è¿™ä¸ªåœ°æ–¹æ˜¯ Parquet å†…éƒ¨ï¼Œè€Œä¸æ˜¯ç”¨æˆ·å±‚é¢çš„è¯­ä¹‰</strong>ã€‚æ„æ€å°±æ˜¯ï¼Œåœ¨ max-rep-level &gt; 1 çš„åœºæ™¯ä¸‹ï¼Œä½ ç”¨ max-rep-level å°±ä¼šæœ‰å¥‡æ€ªçš„é—®é¢˜äº†</li><li><code>distinct_count</code> ç¨å¾®å¥½ç†è§£ä¸€ç‚¹ï¼Œä½†éœ€è¦æ³¨æ„è¿™ä¸ªå¯¹ null çš„åŒ…å«çš„æƒ…å†µ</li><li>è¿™é‡Œæ‰€æœ‰å­—æ®µéƒ½æ˜¯ optional çš„ï¼ŒStatistics æœ¬èº«ä¹Ÿæ˜¯ Optional çš„</li></ol><p>è¯·çœ‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Statistics per row group and per page</span></span><br><span class="line"><span class="comment"> * All fields are optional.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Statistics</span> &#123;</span><br><span class="line">   <span class="comment">/** count of null value in the column */</span></span><br><span class="line">   <span class="number">3</span>: optional i64 null_count;</span><br><span class="line">   <span class="comment">/** count of distinct values occurring */</span></span><br><span class="line">   <span class="number">4</span>: optional i64 distinct_count;</span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Min and max values for the column, determined by its ColumnOrder.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * Values are encoded using PLAIN encoding, except that variable-length byte</span></span><br><span class="line"><span class="comment">    * arrays do not include a length prefix.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="number">5</span>: optional binary max_value;</span><br><span class="line">   <span class="number">6</span>: optional binary min_value;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆï¼Œè¿™é‡Œä¼šæœ‰ä¸¤ä¸ªåœ°æ–¹æŒæœ‰ Statistics: Page Header å’Œ ColumnChunkMetadata:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** Data page header (è¿™é‡Œæ˜¯ data page v1 çš„ header, v2 ä¹Ÿæœ‰, æ‡’å¾—è´´äº†, ä¸è¿‡ dict æ²¡æœ‰, åªæœ‰ num_values) */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">DataPageHeader</span> &#123;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/** Optional statistics for the data in this page**/</span></span><br><span class="line">  <span class="number">5</span>: optional Statistics statistics;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å’Œï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Description for column metadata</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ColumnMetaData</span> &#123;</span></span><br><span class="line">  <span class="comment">/** Type of this column **/</span></span><br><span class="line">  <span class="number">1</span>: required Type type</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** Set of all encodings used for this column. The purpose is to validate</span></span><br><span class="line"><span class="comment">   * whether we can decode those pages. **/</span></span><br><span class="line">  <span class="number">2</span>: required <span class="built_in">list</span>&lt;Encoding&gt; encodings</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** Path in schema **/</span></span><br><span class="line">  <span class="number">3</span>: required <span class="built_in">list</span>&lt;<span class="built_in">string</span>&gt; path_in_schema</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** optional statistics for this column chunk */</span></span><br><span class="line">  <span class="number">12</span>: optional Statistics statistics;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** Set of all encodings used for pages in this column chunk.</span></span><br><span class="line"><span class="comment">   * This information can be used to determine if all data pages are</span></span><br><span class="line"><span class="comment">   * dictionary encoded for example **/</span></span><br><span class="line">  <span class="number">13</span>: optional <span class="built_in">list</span>&lt;PageEncodingStats&gt; encoding_stats;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½ å¯èƒ½ä¼šå‘ç°ï¼Œæˆ‘å¤šç•™äº†ä¸ª <code>encoding_stats</code>ï¼Œè¿™æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿåˆ«æ€¥åé¢ä¼šè®²ã€‚è¿˜è®°å¾—ä¹‹å‰è¯´çš„å—ï¼Ÿè¿™äº› Statistics æœ¬èº«ä¼šå— Schema æ§åˆ¶ï¼Œè¿™ä¸ª</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Description for file metadata</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">FileMetaData</span> &#123;</span></span><br><span class="line">  <span class="comment">/** Parquet schema for this file.  This schema contains metadata for all the columns.</span></span><br><span class="line"><span class="comment">   * The schema is represented as a tree with a single root.  The nodes of the tree</span></span><br><span class="line"><span class="comment">   * are flattened to a list by doing a depth-first traversal.</span></span><br><span class="line"><span class="comment">   * The column metadata contains the path in the schema for that column which can be</span></span><br><span class="line"><span class="comment">   * used to map columns to nodes in the schema.</span></span><br><span class="line"><span class="comment">   * The first element is the root **/</span></span><br><span class="line">  <span class="number">2</span>: required <span class="built_in">list</span>&lt;SchemaElement&gt; schema;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** Optional key/value metadata **/</span></span><br><span class="line">  <span class="number">5</span>: optional <span class="built_in">list</span>&lt;KeyValue&gt; key_value_metadata</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** String for application that wrote this file.  This should be in the format</span></span><br><span class="line"><span class="comment">   * &lt;Application&gt; version &lt;App Version&gt; (build &lt;App Build Hash&gt;).</span></span><br><span class="line"><span class="comment">   * e.g. impala version 1.0 (build 6cf94d29b2b7115df4de2c06e2ab4326d721eb55)</span></span><br><span class="line"><span class="comment">   **/</span></span><br><span class="line">  <span class="number">6</span>: optional <span class="built_in">string</span> created_by</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Sort order used for the min_value and max_value fields in the Statistics</span></span><br><span class="line"><span class="comment">   * objects and the min_values and max_values fields in the ColumnIndex</span></span><br><span class="line"><span class="comment">   * objects of each column in this file. Sort orders are listed in the order</span></span><br><span class="line"><span class="comment">   * matching the columns in the schema. The indexes are not necessary the same</span></span><br><span class="line"><span class="comment">   * though, because only leaf nodes of the schema are represented in the list</span></span><br><span class="line"><span class="comment">   * of sort orders.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * Without column_orders, the meaning of the min_value and max_value fields</span></span><br><span class="line"><span class="comment">   * in the Statistics object and the ColumnIndex object is undefined. To ensure</span></span><br><span class="line"><span class="comment">   * well-defined behaviour, if these fields are written to a Parquet file,</span></span><br><span class="line"><span class="comment">   * column_orders must be written as well.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * The obsolete min and max fields in the Statistics object are always sorted</span></span><br><span class="line"><span class="comment">   * by signed comparison regardless of column_orders.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="number">7</span>: optional <span class="built_in">list</span>&lt;ColumnOrder&gt; column_orders;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæœ‰ä¸ª <code>ColumnOrder</code>ï¼Œæ­£æ˜¯å¯¹ Statistics å¯¹åº”æ‰€æœ‰é€»è¾‘åˆ—çš„ç»Ÿè®¡çš„æ€»æè¿°:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** Empty struct to signal the order defined by the physical or logical type */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">TypeDefinedOrder</span> &#123;</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Union to specify the order used for the min_value and max_value fields for a</span></span><br><span class="line"><span class="comment"> * column. This union takes the role of an enhanced enum that allows rich</span></span><br><span class="line"><span class="comment"> * elements (which will be needed for a collation-based ordering in the future).</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Possible values are:</span></span><br><span class="line"><span class="comment"> * * TypeDefinedOrder - the column uses the order defined by its logical or</span></span><br><span class="line"><span class="comment"> *                      physical type (if there is no logical type).</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * If the reader does not support the value of this union, min and max stats</span></span><br><span class="line"><span class="comment"> * for this column should be ignored.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">union</span> <span class="title">ColumnOrder</span> &#123;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * The sort orders for logical types are:</span></span><br><span class="line"><span class="comment">   *   UTF8 - unsigned byte-wise comparison</span></span><br><span class="line"><span class="comment">   *   INT8 - signed comparison</span></span><br><span class="line"><span class="comment">   *   INT16 - signed comparison</span></span><br><span class="line"><span class="comment">   *   INT32 - signed comparison</span></span><br><span class="line"><span class="comment">   *   INT64 - signed comparison</span></span><br><span class="line"><span class="comment">   *   UINT8 - unsigned comparison</span></span><br><span class="line"><span class="comment">   *   UINT16 - unsigned comparison</span></span><br><span class="line"><span class="comment">   *   UINT32 - unsigned comparison</span></span><br><span class="line"><span class="comment">   *   UINT64 - unsigned comparison</span></span><br><span class="line"><span class="comment">   *   DECIMAL - signed comparison of the represented value</span></span><br><span class="line"><span class="comment">   *   DATE - signed comparison</span></span><br><span class="line"><span class="comment">   *   TIME_MILLIS - signed comparison</span></span><br><span class="line"><span class="comment">   *   TIME_MICROS - signed comparison</span></span><br><span class="line"><span class="comment">   *   TIMESTAMP_MILLIS - signed comparison</span></span><br><span class="line"><span class="comment">   *   TIMESTAMP_MICROS - signed comparison</span></span><br><span class="line"><span class="comment">   *   INTERVAL - unsigned comparison</span></span><br><span class="line"><span class="comment">   *   JSON - unsigned byte-wise comparison</span></span><br><span class="line"><span class="comment">   *   BSON - unsigned byte-wise comparison</span></span><br><span class="line"><span class="comment">   *   ENUM - unsigned byte-wise comparison</span></span><br><span class="line"><span class="comment">   *   LIST - undefined</span></span><br><span class="line"><span class="comment">   *   MAP - undefined</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * In the absence of logical types, the sort order is determined by the physical type:</span></span><br><span class="line"><span class="comment">   *   BOOLEAN - false, true</span></span><br><span class="line"><span class="comment">   *   INT32 - signed comparison</span></span><br><span class="line"><span class="comment">   *   INT64 - signed comparison</span></span><br><span class="line"><span class="comment">   *   INT96 (only used for legacy timestamps) - undefined</span></span><br><span class="line"><span class="comment">   *   FLOAT - signed comparison of the represented value (*)</span></span><br><span class="line"><span class="comment">   *   DOUBLE - signed comparison of the represented value (*)</span></span><br><span class="line"><span class="comment">   *   BYTE_ARRAY - unsigned byte-wise comparison</span></span><br><span class="line"><span class="comment">   *   FIXED_LEN_BYTE_ARRAY - unsigned byte-wise comparison</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * (*) Because the sorting order is not specified properly for floating</span></span><br><span class="line"><span class="comment">   *     point values (relations vs. total ordering) the following</span></span><br><span class="line"><span class="comment">   *     compatibility rules should be applied when reading statistics:</span></span><br><span class="line"><span class="comment">   *     - If the min is a NaN, it should be ignored.</span></span><br><span class="line"><span class="comment">   *     - If the max is a NaN, it should be ignored.</span></span><br><span class="line"><span class="comment">   *     - If the min is +0, the row group may contain -0 values as well.</span></span><br><span class="line"><span class="comment">   *     - If the max is -0, the row group may contain +0 values as well.</span></span><br><span class="line"><span class="comment">   *     - When looking for NaN values, min and max should be ignored.</span></span><br><span class="line"><span class="comment">   * </span></span><br><span class="line"><span class="comment">   *     When writing statistics the following rules should be followed:</span></span><br><span class="line"><span class="comment">   *     - NaNs should not be written to min or max statistics fields.</span></span><br><span class="line"><span class="comment">   *     - If the computed max value is zero (whether negative or positive),</span></span><br><span class="line"><span class="comment">   *       `+0.0` should be written into the max statistics field.</span></span><br><span class="line"><span class="comment">   *     - If the computed min value is zero (whether negative or positive),</span></span><br><span class="line"><span class="comment">   *       `-0.0` should be written into the min statistics field.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="number">1</span>: TypeDefinedOrder TYPE_ORDER;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™å—å†…å®¹æ¯”è¾ƒå¤§ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹ä½œ <strong>æ ‡å‡†ç›®å‰åªå®ç°äº† TypeDefinedOrder</strong>ï¼Œå¯ä»¥ç†è§£æˆï¼Œä¼šä»¥ä¸‹é¢çš„ def æ¥æŒ‘é€‰ order:</p><ul><li>LogicalType (æˆ–è€… ConvertedType) çš„ Order</li><li>Physical çš„ Order (In the absence of logical types, the sort order is determined by the physical type)</li><li>å¯¹äº floatï¼Œè¿™é‡Œç‰¹æ®Šå¤„ç†äº† NaN çš„ Orderï¼Œè¿™é‡Œæˆ‘è¿™å‡ å¤©æ­£å¥½ç¢°åˆ°ä¸€ä¸ªç±»ä¼¼çš„ issue:<ul><li><a href="https://issues.apache.org/jira/browse/PARQUET-2249">https://issues.apache.org/jira/browse/PARQUET-2249</a></li></ul></li></ul><p>æˆ‘ä»¬å¯ä»¥åšå‡ºå¦‚ä¸‹<strong>æ€»ç»“</strong>ï¼š</p><ol><li><code>FileMetadata</code> ä¸Šæœ‰ Schemaï¼ŒåŒæ—¶ä¹Ÿæœ‰ <code>column_orders</code><ol><li>Order æŒ‰ç…§ LogicalType, Type æ¥å®šä¹‰</li></ol></li><li><code>ColumnChunkMetadata</code> å’Œ <code>Page</code> ä¸Šéƒ½æœ‰å¯¹åº”çš„ Statisticsï¼ŒStatistics æœ¬èº«çš„ Order éµå¾ª <code>FileMetadata</code>. Statistics æœ¬èº«å’Œä¸Šé¢çš„å†…å®¹éƒ½æ˜¯ optional çš„</li></ol><h3 id="Statistic-Dictionary-amp-Corner-Cases"><a href="#Statistic-Dictionary-amp-Corner-Cases" class="headerlink" title="Statistic: Dictionary &amp; Corner Cases"></a>Statistic: Dictionary &amp; Corner Cases</h3><p>ä½ è‚¯å®šè§‰å¾—ä¹‹å‰å·²ç»è®²è¿‡ Statistics äº†ï¼Œä½†æ˜¯ä¹‹å‰å…¶å®è¿˜ç¡®å®äº†ä¸€éƒ¨åˆ†ã€‚æˆ‘ä»¬çŸ¥é“ Page æœ‰ min-maxï¼Œé‚£ä¹ˆï¼š</p><ol><li>å­—å…¸é¡µé¢çš„ Min-Max æ˜¯æ€ä¹ˆå¤„ç†çš„å‘¢ï¼Ÿ</li><li>å­—å…¸é¡µé¢çš„ Layout æ˜¯ä»€ä¹ˆæ ·å­çš„å‘¢ï¼Ÿ</li><li>Null ä¹‹ç±»çš„ï¼Œä¼šä¸ä¼šè¿› ndv å‘¢ï¼Ÿ</li></ol><p>æˆ‘ä»¬å¯ä»¥ä»‹ç»ä¸€äº› Parquet å­—å…¸æ ¼å¼çš„é»‘æš—éƒ¨åˆ†äº†ã€‚è¿™é‡Œå¯ä»¥å…ˆç®€å•ç¿»é˜…ä¸€ä¸‹ Parquet çš„ Encoding éƒ¨åˆ†ï¼š<a href="https://github.com/apache/parquet-format/blob/master/Encodings.md#dictionary-encoding-plain_dictionary--2-and-rle_dictionary--8">https://github.com/apache/parquet-format/blob/master/Encodings.md#dictionary-encoding-plain_dictionary--2-and-rle_dictionary--8</a></p><p>è¿™é‡Œä¼šå‘ç°ï¼Œå­—å…¸æœ‰ç¼–ç  <code>PLAIN_DICTIONARY</code> å’Œ <code>RLE_DICTIONARY</code>.</p><ul><li>PLAIN_DICTIONARY: æ‰€æœ‰é¡µé¢éƒ½æ˜¯ <code>PLAIN_DICTIONARY</code> æ ‡å¤´ï¼Œåœ¨ format-1.0 ä¸­ä½¿ç”¨</li><li>RLE_DICTIONARY: å­—å…¸(index)é¡µæ˜¯ <code>PLAIN</code>, Data é¡µé¢æ˜¯ <code>RLE_DICTIONARY</code></li></ul><p>å®é™…ä¸Šï¼Œæˆ‘ä»¬å¯ä»¥çœ‹ä¸‹ Parquet çš„ Properties:</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">inline</span> ParquetVersion::type <span class="title">version</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> parquet_version_; &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">inline</span> std::string <span class="title">created_by</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> parquet_created_by_; &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">bool</span> <span class="title">page_checksum_enabled</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> page_checksum_enabled_; &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">inline</span> Encoding::type <span class="title">dictionary_index_encoding</span><span class="params">()</span> <span class="type">const</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (parquet_version_ == ParquetVersion::PARQUET_1_0) &#123;</span><br><span class="line">    <span class="keyword">return</span> Encoding::PLAIN_DICTIONARY;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> Encoding::RLE_DICTIONARY;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">inline</span> Encoding::type <span class="title">dictionary_page_encoding</span><span class="params">()</span> <span class="type">const</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (parquet_version_ == ParquetVersion::PARQUET_1_0) &#123;</span><br><span class="line">    <span class="keyword">return</span> Encoding::PLAIN_DICTIONARY;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> Encoding::PLAIN;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆå­—å…¸çš„ Statistics æ˜¯ä»€ä¹ˆæ ·å­çš„å‘¢ï¼Ÿè¿™éƒ¨åˆ†æˆ‘ä»¬å¯ä»¥åœ¨å®ç°é‡Œå­¦ä¹ ï¼Œä¸è¿‡ï¼Œåœ¨æ ‡å‡†ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥è®ºæ–­ï¼š</p><ul><li>å­—å…¸æ•°æ®é¡µçš„ Statistics å’Œéå­—å…¸æ•°æ®é¡µçš„ Statistics é€»è¾‘ä¸Šæ˜¯ä¸€æ ·çš„ï¼Œæ­¤å¤–ï¼Œå› ä¸ºå€Ÿç”¨äº†å­—å…¸ï¼Œå®ƒèƒ½æ›´å¥½çš„å»æ”¶é›† ndv</li><li>å­—å…¸ç´¢å¼•é¡µæ ¹æœ¬æ²¡æœ‰ Statistics</li></ul><p>é‚£ä¹ˆ NaN å‘¢ï¼Ÿå®é™…ä¸Š NaN å¹¶é nullï¼Œä¹Ÿæ˜¯ä¸€ç§ï¼ˆæ ¹æ® IEEE 754ï¼Œå¯èƒ½æ˜¯ä¸¤ç§ï¼‰valuesã€‚</p><h3 id="å®ç°"><a href="#å®ç°" class="headerlink" title="å®ç°"></a>å®ç°</h3><p>æˆ‘ä»¬ä¹‹å‰æåˆ°äº†ï¼ŒParquet Spec æœ‰ Physical çš„ type (<code>Type</code>) å’Œ LogicalType (<code>LogicalType</code> å’Œå…¼å®¹ parquet-format-v1 çš„ <code>ConvertedType</code>)ã€‚è¿™ä¸ª Type ä¼šæœ‰å¯¹åº”çš„ <code>ColumnOrder</code>ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬è¦æŠŠè¿™å¨ä»£ç æ˜ å°„åˆ° C++ ä¸Šã€‚è¿™éƒ¨åˆ†åœ¨ Parquet C++ å®ç°ä¸Šè¿˜æ˜¯æ¯”è¾ƒæ®‹ç¼ºçš„ï¼Œæˆ‘ä»¬ä¹Ÿä¼šå°½é‡æ¯”å¯¹ Java ç‰ˆæœ¬çš„å®ç°ã€‚</p><p>å®ç°åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†: è¯»ï¼Œå†™</p><h4 id="C-å®ç°-å†™"><a href="#C-å®ç°-å†™" class="headerlink" title="C++ å®ç°: å†™"></a>C++ å®ç°: å†™</h4><p>è¿™é‡Œåˆ†ä¸ºå¥½å‡ å±‚ï¼š</p><ol><li>Encoding å±‚ä¹‹ä¸Šï¼šæ€ä¹ˆæ”¯æŒ Statistics</li><li>Page çš„ Statistics</li><li>ColumnChunk å±‚çš„ Statistics</li><li>å…ƒä¿¡æ¯æ”¶é›†</li></ol><p>é¦–å…ˆï¼Œæˆ‘ä»¬ä» Comparator ç±»å‹è®²èµ·ï¼Œè®²è®²ä»–ä¸ºå•¥å¥½ / ä¸å¥½.</p><p>Comparator ç±»å‹çš„æ„æˆ:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Comparator (åˆ›å»ºçš„å·¥å‚)</span><br><span class="line">- TypedComparator (Compare, GetMinMax, GetMinMaxSpaced)</span><br><span class="line">  - TypedComparatorImpl</span><br><span class="line">    + ComparatorHelper&lt;Type, bool is_signed&gt;</span><br></pre></td></tr></table></figure><p>è¿™å—ä¸œè¥¿ç›¸å¯¹æ¯”è¾ƒç®€å•ï¼Œæˆ‘ä»¬å¯ä»¥å…³æ³¨ä¸€ä¸‹ signed å’Œ unsigned çš„å®ç°ã€‚ä»–ä»¬ç”± <code>SortOrder</code> æŒ‡å®šã€‚<code>SortOrder</code> æ˜¯ä¸Šå±‚çš„æ¦‚å¿µï¼Œæˆ‘ä»¬ä¹‹åä¼šä»‹ç»ã€‚æˆ‘ä»¬å…ˆä»‹ç»æ•´æ•°æ¯”è¾ƒï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> DType&gt;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">UnsignedCompareHelperBase</span> &#123;</span><br><span class="line">  <span class="keyword">using</span> T = <span class="keyword">typename</span> DType::c_type;</span><br><span class="line">  <span class="keyword">using</span> UCType = <span class="keyword">typename</span> std::make_unsigned&lt;T&gt;::type;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">static_assert</span>(!std::is_same&lt;T, UCType&gt;::value, <span class="string">&quot;T is unsigned&quot;</span>);</span><br><span class="line">  <span class="built_in">static_assert</span>(<span class="built_in">sizeof</span>(T) == <span class="built_in">sizeof</span>(UCType), <span class="string">&quot;T and UCType not the same size&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// <span class="doctag">NOTE:</span> according to the C++ spec, unsigned-to-signed conversion is</span></span><br><span class="line">  <span class="comment">// implementation-defined if the original value does not fit in the signed type</span></span><br><span class="line">  <span class="comment">// (i.e., two&#x27;s complement cannot be assumed even on mainstream machines,</span></span><br><span class="line">  <span class="comment">// because the compiler may decide otherwise).  Hence the use of `SafeCopy`</span></span><br><span class="line">  <span class="comment">// below for deterministic bit-casting.</span></span><br><span class="line">  <span class="comment">// (see &quot;Integer conversions&quot; in</span></span><br><span class="line">  <span class="comment">//  https://en.cppreference.com/w/cpp/language/implicit_conversion)</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="type">static</span> <span class="type">const</span> T <span class="title">DefaultMin</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="built_in">SafeCopy</span>&lt;T&gt;(std::numeric_limits&lt;UCType&gt;::<span class="built_in">max</span>()); &#125;</span><br><span class="line">  <span class="function"><span class="type">static</span> <span class="type">const</span> T <span class="title">DefaultMax</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="number">0</span>; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="type">static</span> <span class="type">bool</span> <span class="title">Compare</span><span class="params">(<span class="type">int</span> type_length, T a, T b)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">SafeCopy</span>&lt;UCType&gt;(a) &lt; <span class="built_in">SafeCopy</span>&lt;UCType&gt;(b);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="type">static</span> T <span class="title">Min</span><span class="params">(<span class="type">int</span> type_length, T a, T b)</span> </span>&#123; <span class="keyword">return</span> <span class="built_in">Compare</span>(type_length, a, b) ? a : b; &#125;</span><br><span class="line">  <span class="function"><span class="type">static</span> T <span class="title">Max</span><span class="params">(<span class="type">int</span> type_length, T a, T b)</span> </span>&#123; <span class="keyword">return</span> <span class="built_in">Compare</span>(type_length, a, b) ? b : a; &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å› ä¸º <code>DType::c_type</code> å¯¹åº”æ˜¯ signed, æ‰€ä»¥è¿™é‡Œæ“ä½œäº†ä¸€å¥— unsigned æ¥å¤„ç†ã€‚</p><p>é‚£ä¹ˆï¼Œè¿˜æœ‰ä¸ªæ¯”è¾ƒ trickey çš„åœ°æ–¹æ˜¯ INT96 çš„æ¯”è¾ƒï¼Œä¸è¿‡ INT96 å·²ç» deprecated äº†ï¼Œæˆ‘å°±å·æ‡’äº†ã€‚é‡ç‚¹ä»‹ç»ä¸€ä¸‹æµ®ç‚¹æ•°:</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> DType, <span class="type">bool</span> is_signed&gt;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">CompareHelper</span> &#123;</span><br><span class="line">  <span class="keyword">using</span> T = <span class="keyword">typename</span> DType::c_type;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">static_assert</span>(!std::is_unsigned&lt;T&gt;::value || std::is_same&lt;T, <span class="type">bool</span>&gt;::value,</span><br><span class="line">                <span class="string">&quot;T is an unsigned numeric&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">constexpr</span> <span class="type">static</span> T <span class="title">DefaultMin</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> std::numeric_limits&lt;T&gt;::<span class="built_in">max</span>(); &#125;</span><br><span class="line">  <span class="function"><span class="keyword">constexpr</span> <span class="type">static</span> T <span class="title">DefaultMax</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> std::numeric_limits&lt;T&gt;::<span class="built_in">lowest</span>(); &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// MSVC17 fix, isnan is not overloaded for IntegralType as per C++11</span></span><br><span class="line">  <span class="comment">// standard requirements.</span></span><br><span class="line">  <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T1 = T&gt;</span><br><span class="line">  <span class="type">static</span> ::arrow::<span class="type">enable_if_t</span>&lt;std::is_floating_point&lt;T1&gt;::value, T&gt; <span class="built_in">Coalesce</span>(T val,</span><br><span class="line">                                                                             T fallback) &#123;</span><br><span class="line">    <span class="keyword">return</span> std::<span class="built_in">isnan</span>(val) ? fallback : val;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T1 = T&gt;</span><br><span class="line">  <span class="type">static</span> ::arrow::<span class="type">enable_if_t</span>&lt;!std::is_floating_point&lt;T1&gt;::value, T&gt; <span class="built_in">Coalesce</span>(</span><br><span class="line">      T val, T fallback) &#123;</span><br><span class="line">    <span class="keyword">return</span> val;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">bool</span> <span class="title">Compare</span><span class="params">(<span class="type">int</span> type_length, <span class="type">const</span> T&amp; a, <span class="type">const</span> T&amp; b)</span> </span>&#123; <span class="keyword">return</span> a &lt; b; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="type">static</span> T <span class="title">Min</span><span class="params">(<span class="type">int</span> type_length, T a, T b)</span> </span>&#123; <span class="keyword">return</span> a &lt; b ? a : b; &#125;</span><br><span class="line">  <span class="function"><span class="type">static</span> T <span class="title">Max</span><span class="params">(<span class="type">int</span> type_length, T a, T b)</span> </span>&#123; <span class="keyword">return</span> a &lt; b ? b : a; &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªåœ°æ–¹ç”¨ä¸€ä¸ª Coalesce æ¥å¼ºåˆ¶å¹²æ‰ NaN. å…³äºæµ®ç‚¹æ•°æ“ä½œï¼Œå¯ä»¥çœ‹ Specï¼š</p><ul><li>IEEE 754 - 2019 æµ®ç‚¹ç®—æ•°æ ‡å‡† - nicholaswildeçš„æ–‡ç«  - çŸ¥ä¹ <a href="https://zhuanlan.zhihu.com/p/480834719">https://zhuanlan.zhihu.com/p/480834719</a></li><li><a href="https://stackoverflow.com/questions/38798791/nan-comparison-rule-in-c-c">https://stackoverflow.com/questions/38798791/nan-comparison-rule-in-c-c</a></li><li>æ³¨æ„ä¸€ä¸‹æ ‡å‡†åº“æä¾›çš„å‡ ä¸ªæŠ½è±¡ï¼Œä¸‹åˆ—å¯ä»¥ç®€å•è¯´ä¸€ä¸‹<ul><li><code>max</code>: æœ€å¤§å€¼</li><li><code>min</code>: å¯¹æµ®ç‚¹æ•°æ¥è¯´æ˜¯æœ€å°çš„æ­£æ•°</li><li><code>lowest</code> æœ€å°ï¼ˆé NaNï¼‰å€¼</li><li><code>denorm_min</code> ï¼Œå¯ä»¥è¡¨ç¤ºæœ€é è¿‘ 0 çš„æ•°</li></ul></li></ul><p>è¿™ä¸ªåœ°æ–¹å°è£…äº†ä¸€å±‚åï¼Œæœ€åæˆ‘ä»¬å›åˆ°ä¸Šå±‚çš„ <code>Make</code>:</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">std::shared_ptr&lt;Comparator&gt; <span class="title">Comparator::Make</span><span class="params">(Type::type physical_type,</span></span></span><br><span class="line"><span class="params"><span class="function">                                             SortOrder::type sort_order,</span></span></span><br><span class="line"><span class="params"><span class="function">                                             <span class="type">int</span> type_length)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (SortOrder::SIGNED == sort_order) &#123;</span><br><span class="line">    <span class="keyword">switch</span> (physical_type) &#123;</span><br><span class="line">      <span class="keyword">case</span> Type::BOOLEAN:</span><br><span class="line">        <span class="keyword">return</span> std::make_shared&lt;TypedComparatorImpl&lt;<span class="literal">true</span>, BooleanType&gt;&gt;();</span><br><span class="line">      <span class="keyword">case</span> Type::INT32:</span><br><span class="line">        <span class="keyword">return</span> std::make_shared&lt;TypedComparatorImpl&lt;<span class="literal">true</span>, Int32Type&gt;&gt;();</span><br><span class="line">      <span class="keyword">case</span> Type::INT64:</span><br><span class="line">        <span class="keyword">return</span> std::make_shared&lt;TypedComparatorImpl&lt;<span class="literal">true</span>, Int64Type&gt;&gt;();</span><br><span class="line">      <span class="keyword">case</span> Type::INT96:</span><br><span class="line">        <span class="keyword">return</span> std::make_shared&lt;TypedComparatorImpl&lt;<span class="literal">true</span>, Int96Type&gt;&gt;();</span><br><span class="line">      <span class="keyword">case</span> Type::FLOAT:</span><br><span class="line">        <span class="keyword">return</span> std::make_shared&lt;TypedComparatorImpl&lt;<span class="literal">true</span>, FloatType&gt;&gt;();</span><br><span class="line">      <span class="keyword">case</span> Type::DOUBLE:</span><br><span class="line">        <span class="keyword">return</span> std::make_shared&lt;TypedComparatorImpl&lt;<span class="literal">true</span>, DoubleType&gt;&gt;();</span><br><span class="line">      <span class="keyword">case</span> Type::BYTE_ARRAY:</span><br><span class="line">        <span class="keyword">return</span> std::make_shared&lt;TypedComparatorImpl&lt;<span class="literal">true</span>, ByteArrayType&gt;&gt;();</span><br><span class="line">      <span class="keyword">case</span> Type::FIXED_LEN_BYTE_ARRAY:</span><br><span class="line">        <span class="keyword">return</span> std::make_shared&lt;TypedComparatorImpl&lt;<span class="literal">true</span>, FLBAType&gt;&gt;(type_length);</span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        ParquetException::<span class="built_in">NYI</span>(<span class="string">&quot;Signed Compare not implemented&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (SortOrder::UNSIGNED == sort_order) &#123;</span><br><span class="line">    <span class="keyword">switch</span> (physical_type) &#123;</span><br><span class="line">      <span class="keyword">case</span> Type::INT32:</span><br><span class="line">        <span class="keyword">return</span> std::make_shared&lt;TypedComparatorImpl&lt;<span class="literal">false</span>, Int32Type&gt;&gt;();</span><br><span class="line">      <span class="keyword">case</span> Type::INT64:</span><br><span class="line">        <span class="keyword">return</span> std::make_shared&lt;TypedComparatorImpl&lt;<span class="literal">false</span>, Int64Type&gt;&gt;();</span><br><span class="line">      <span class="keyword">case</span> Type::INT96:</span><br><span class="line">        <span class="keyword">return</span> std::make_shared&lt;TypedComparatorImpl&lt;<span class="literal">false</span>, Int96Type&gt;&gt;();</span><br><span class="line">      <span class="keyword">case</span> Type::BYTE_ARRAY:</span><br><span class="line">        <span class="keyword">return</span> std::make_shared&lt;TypedComparatorImpl&lt;<span class="literal">false</span>, ByteArrayType&gt;&gt;();</span><br><span class="line">      <span class="keyword">case</span> Type::FIXED_LEN_BYTE_ARRAY:</span><br><span class="line">        <span class="keyword">return</span> std::make_shared&lt;TypedComparatorImpl&lt;<span class="literal">false</span>, FLBAType&gt;&gt;(type_length);</span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        ParquetException::<span class="built_in">NYI</span>(<span class="string">&quot;Unsigned Compare not implemented&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="built_in">ParquetException</span>(<span class="string">&quot;UNKNOWN Sort Order&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ²¡æœ‰ <code>SortOrder</code> çš„ä¸œè¥¿ï¼Œæ˜¯åˆ›å»ºä¸å‡º Comparator çš„ï¼Œè¿™ä¸ªåœ°æ–¹å¯ä»¥ç•™æ„ä¸€ä¸‹ã€‚æˆ‘ä»¬å›åˆ° Statisticsï¼Œå®ƒçš„å¤šå±‚çº§ç±»ä¼¼ Comparatorã€‚å®ƒå¯¹å¤–ä¼šèµ°ä¸€ä¸ªå«åš <code>EncodedStatistics</code> çš„ä¸œè¥¿ï¼Œå®ƒç®—æ˜¯ thrift <code>Statistics</code> çš„ä¸€ä¸ªåŒ…è£…ï¼Œç”¨æˆ·ä¸éœ€è¦ç›´æ¥å’Œ <code>Statistics</code> æ‰“äº¤é“ã€‚ï¼ˆè¿™ç©æ„ä¸åŒ…æ‹¬ num_valuesâ€¦ä½†æ˜¯ num_values éœ€è¦é  Statistics æ”¶é›†ï¼‰ã€‚</p><p>å®ƒçš„å†…éƒ¨ç»“æ„å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Statistics (nullCount, minmax, Encode)</span><br><span class="line">- TypedStatistics</span><br><span class="line">  - TypedStatisticsImpl</span><br><span class="line">    + TypedComparator</span><br></pre></td></tr></table></figure><p>å¦‚æœåˆ›å»ºå¤±è´¥ï¼Œæ¯”å¦‚ ColumnDescriptor æ²¡æœ‰ SortOrder, è¿™ç©æ„æ ¹æœ¬åˆ›å»ºä¸å‡ºæ¥ã€‚å®ƒå¯ä»¥æ ¹æ® arrow å†™å…¥æ¥æ›´æ–°å†…éƒ¨çš„çŠ¶æ€ã€‚</p><p>å…³äºæ›´æ–°çŠ¶æ€ï¼Œè¿™é‡Œä¹Ÿå¯ä»¥çœ‹ä½œæ˜¯ä¸€ä¸ªè”åŠ¨çš„çŠ¶æ€ï¼š</p><p>æ›´æ–°çš„æ—¶å€™ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">std::pair&lt;T, T&gt; <span class="title">GetMinMax</span><span class="params">(<span class="type">const</span> T* values, <span class="type">int64_t</span> length)</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">  <span class="built_in">DCHECK_GT</span>(length, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">  T min = Helper::<span class="built_in">DefaultMin</span>();</span><br><span class="line">  T max = Helper::<span class="built_in">DefaultMax</span>();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int64_t</span> i = <span class="number">0</span>; i &lt; length; i++) &#123;</span><br><span class="line">    <span class="type">const</span> <span class="keyword">auto</span> val = <span class="built_in">SafeLoad</span>(values + i);</span><br><span class="line">    min = Helper::<span class="built_in">Min</span>(type_length_, min, Helper::<span class="built_in">Coalesce</span>(val, Helper::<span class="built_in">DefaultMin</span>()));</span><br><span class="line">    max = Helper::<span class="built_in">Max</span>(type_length_, max, Helper::<span class="built_in">Coalesce</span>(val, Helper::<span class="built_in">DefaultMax</span>()));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;min, max&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è®¾ç½®çš„æ—¶å€™ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// In case of floating point types, the following rules are applied (as per</span></span><br><span class="line"><span class="comment">// upstream parquet-mr):</span></span><br><span class="line"><span class="comment">// - If any of min/max is NaN, return nothing.</span></span><br><span class="line"><span class="comment">// - If min is 0.0f, replace with -0.0f</span></span><br><span class="line"><span class="comment">// - If max is -0.0f, replace with 0.0f</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">::arrow::<span class="type">enable_if_t</span>&lt;std::is_floating_point&lt;T&gt;::value, optional&lt;std::pair&lt;T, T&gt;&gt;&gt;</span><br><span class="line"><span class="built_in">CleanStatistic</span>(std::pair&lt;T, T&gt; min_max) &#123;</span><br><span class="line">  T min = min_max.first;</span><br><span class="line">  T max = min_max.second;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Ignore if one of the value is nan.</span></span><br><span class="line">  <span class="keyword">if</span> (std::<span class="built_in">isnan</span>(min) || std::<span class="built_in">isnan</span>(max)) &#123;</span><br><span class="line">    <span class="keyword">return</span> ::std::<span class="literal">nullopt</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (min == std::numeric_limits&lt;T&gt;::<span class="built_in">max</span>() &amp;&amp; max == std::numeric_limits&lt;T&gt;::<span class="built_in">lowest</span>()) &#123;</span><br><span class="line">    <span class="keyword">return</span> ::std::<span class="literal">nullopt</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  T zero&#123;&#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (min == zero &amp;&amp; !std::<span class="built_in">signbit</span>(min)) &#123;</span><br><span class="line">    min = -min;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (max == zero &amp;&amp; std::<span class="built_in">signbit</span>(max)) &#123;</span><br><span class="line">    max = -max;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;&#123;min, max&#125;&#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">SetMinMaxPair</span><span class="params">(std::pair&lt;T, T&gt; min_max)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// CleanStatistic can return a nullopt in case of erroneous values, e.g. NaN</span></span><br><span class="line">    <span class="keyword">auto</span> maybe_min_max = <span class="built_in">CleanStatistic</span>(min_max);</span><br><span class="line">    <span class="keyword">if</span> (!maybe_min_max) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">auto</span> min = maybe_min_max.<span class="built_in">value</span>().first;</span><br><span class="line">    <span class="keyword">auto</span> max = maybe_min_max.<span class="built_in">value</span>().second;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!has_min_max_) &#123;</span><br><span class="line">      has_min_max_ = <span class="literal">true</span>;</span><br><span class="line">      <span class="built_in">Copy</span>(min, &amp;min_, min_buffer_.<span class="built_in">get</span>());</span><br><span class="line">      <span class="built_in">Copy</span>(max, &amp;max_, max_buffer_.<span class="built_in">get</span>());</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="built_in">Copy</span>(comparator_-&gt;<span class="built_in">Compare</span>(min_, min) ? min_ : min, &amp;min_, min_buffer_.<span class="built_in">get</span>());</span><br><span class="line">      <span class="built_in">Copy</span>(comparator_-&gt;<span class="built_in">Compare</span>(max_, max) ? max : max_, &amp;max_, max_buffer_.<span class="built_in">get</span>());</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>åœ¨è¿™ä¸ªå±‚é¢ä¸Šï¼Œæˆ‘ä»¬å°±èƒ½å¾ˆå¥½ç†è§£ min-max äº†ã€‚</p><h5 id="SortOrder"><a href="#SortOrder" class="headerlink" title="SortOrder"></a>SortOrder</h5><p>æˆ‘ä»¬ä¸ŠèŠ‚ä»‹ç» Schema çš„æ—¶å€™æ²¡ä»‹ç» SortOrderï¼Œå› ä¸º Parquet Standard é‡Œé¢æ²¡æœ‰è¿™ä¸ªä¸œè¥¿ï¼ˆæœ‰å« sort_order çš„åˆ«çš„ä¸œè¥¿ï¼‰ã€‚è¿™ä¸ªæ˜¯ C++ Parquet å†…éƒ¨å®ç° order ç”¨çš„ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">SortOrder::type <span class="title">sort_order</span><span class="params">()</span> <span class="type">const</span> </span>&#123;</span><br><span class="line">  <span class="keyword">auto</span> la = <span class="built_in">logical_type</span>();</span><br><span class="line">  <span class="keyword">auto</span> pt = <span class="built_in">physical_type</span>();</span><br><span class="line">  <span class="keyword">return</span> la ? <span class="built_in">GetSortOrder</span>(la, pt) : <span class="built_in">GetSortOrder</span>(<span class="built_in">converted_type</span>(), pt);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œç›¸å½“äº spec é‡Œé¢çš„ <code>TypeDefinedOrder</code>ï¼Œå®ç°ä¸Šå½“æˆäº†å¤šä»½ SIGNED, UNSIGNED, UNKNOWN. <code>LogicalType</code> éƒ½ä¼šå®šä¹‰è‡ªå·±çš„ SortOrderï¼Œæ¯”å¦‚ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">LogicalType</span>::Impl::Int <span class="keyword">final</span> : <span class="keyword">public</span> LogicalType::Impl::Compatible,</span><br><span class="line">                                     <span class="keyword">public</span> LogicalType::Impl::Applicable &#123;</span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="keyword">friend</span> <span class="keyword">class</span> <span class="title class_">IntLogicalType</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="type">bool</span> <span class="title">is_applicable</span><span class="params">(parquet::Type::type primitive_type,</span></span></span><br><span class="line"><span class="params"><span class="function">                     <span class="type">int32_t</span> primitive_length = <span class="number">-1</span>)</span> <span class="type">const</span> <span class="keyword">override</span></span>;</span><br><span class="line">  <span class="function"><span class="type">bool</span> <span class="title">is_compatible</span><span class="params">(ConvertedType::type converted_type,</span></span></span><br><span class="line"><span class="params"><span class="function">                     schema::DecimalMetadata converted_decimal_metadata)</span> <span class="type">const</span> <span class="keyword">override</span></span>;</span><br><span class="line">  <span class="function">ConvertedType::type <span class="title">ToConvertedType</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">      schema::DecimalMetadata* out_decimal_metadata)</span> <span class="type">const</span> <span class="keyword">override</span></span>;</span><br><span class="line">  <span class="function">std::string <span class="title">ToString</span><span class="params">()</span> <span class="type">const</span> <span class="keyword">override</span></span>;</span><br><span class="line">  <span class="function">std::string <span class="title">ToJSON</span><span class="params">()</span> <span class="type">const</span> <span class="keyword">override</span></span>;</span><br><span class="line">  <span class="function">format::LogicalType <span class="title">ToThrift</span><span class="params">()</span> <span class="type">const</span> <span class="keyword">override</span></span>;</span><br><span class="line">  <span class="function"><span class="type">bool</span> <span class="title">Equals</span><span class="params">(<span class="type">const</span> LogicalType&amp; other)</span> <span class="type">const</span> <span class="keyword">override</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="type">int</span> <span class="title">bit_width</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> width_; &#125;</span><br><span class="line">  <span class="function"><span class="type">bool</span> <span class="title">is_signed</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> signed_; &#125;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span>:</span><br><span class="line">  <span class="built_in">Int</span>(<span class="type">int</span> w, <span class="type">bool</span> s)</span><br><span class="line">      : LogicalType::<span class="built_in">Impl</span>(LogicalType::Type::INT,</span><br><span class="line">                          (s ? SortOrder::SIGNED : SortOrder::UNSIGNED)),</span><br><span class="line">        <span class="built_in">width_</span>(w),</span><br><span class="line">        <span class="built_in">signed_</span>(s) &#123;&#125;</span><br><span class="line">  <span class="type">int</span> width_ = <span class="number">0</span>;</span><br><span class="line">  <span class="type">bool</span> signed_ = <span class="literal">false</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ä¹Ÿæœ‰ä¸€äº›ç±»å‹ï¼Œæ¯”å¦‚ VOIDï¼Œå¯¹åº”çš„ Statistics æ˜¯ undefined.</p><p>ç›®å‰çš„å®ç°æœ‰ä¸ªé—®é¢˜ï¼Œå¦‚æœæ˜¯ undefined (ç”šè‡³æ˜¯ç±»å‹æ ‡å¿—å¥‡æ€ªäº†ä¸€äº›)ï¼Œå°±ä¼šäº§ç”Ÿ comparator ç”Ÿæˆçš„å¼‚å¸¸ï¼Œç„¶åæ— æ³•äº§ç”Ÿ statisticsã€‚è¿™äº›ä¼šå½±å“ interval ç›¸å…³çš„ç±»å‹ã€‚</p><p>åœ¨æœ€ç»ˆå†™å…¥çš„æ—¶å€™ï¼Œä¼šæœ‰ä¸¤ç§ statistics:</p><ol><li><code>page_statistics</code>: æ¯ä¸ªé¡µé¢ä¸Šçš„</li><li><code>column_statistics</code>: æ±‡æ€»çš„ statistics.</li></ol><p>åœ¨åˆ›å»ºçš„æ—¶å€™ï¼Œå†…å®¹å¦‚ä¸‹:</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">TypedColumnWriterImpl</span>(ColumnChunkMetaDataBuilder* metadata,</span><br><span class="line">                      std::unique_ptr&lt;PageWriter&gt; pager, <span class="type">const</span> <span class="type">bool</span> use_dictionary,</span><br><span class="line">                      Encoding::type encoding, <span class="type">const</span> WriterProperties* properties) &#123;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">  <span class="keyword">if</span> (properties-&gt;<span class="built_in">statistics_enabled</span>(descr_-&gt;<span class="built_in">path</span>()) &amp;&amp;</span><br><span class="line">      (SortOrder::UNKNOWN != descr_-&gt;<span class="built_in">sort_order</span>())) &#123;</span><br><span class="line">    page_statistics_ = <span class="built_in">MakeStatistics</span>&lt;DType&gt;(descr_, allocator_);</span><br><span class="line">    chunk_statistics_ = <span class="built_in">MakeStatistics</span>&lt;DType&gt;(descr_, allocator_);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>æ¯ä¸ªé¡µé¢ä¼šæ”¶é›† page statisticsï¼Œç„¶åå†™å…¥ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">EncodedStatistics <span class="title">Encode</span><span class="params">()</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">  EncodedStatistics s;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">HasMinMax</span>()) &#123;</span><br><span class="line">    s.<span class="built_in">set_min</span>(<span class="keyword">this</span>-&gt;<span class="built_in">EncodeMin</span>());</span><br><span class="line">    s.<span class="built_in">set_max</span>(<span class="keyword">this</span>-&gt;<span class="built_in">EncodeMax</span>());</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">HasNullCount</span>()) &#123;</span><br><span class="line">    s.<span class="built_in">set_null_count</span>(<span class="keyword">this</span>-&gt;<span class="built_in">null_count</span>());</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> s;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å’Œï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function">EncodedStatistics <span class="title">GetPageStatistics</span><span class="params">()</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">   EncodedStatistics result;</span><br><span class="line">   <span class="keyword">if</span> (page_statistics_) result = page_statistics_-&gt;<span class="built_in">Encode</span>();</span><br><span class="line">   <span class="keyword">return</span> result;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="comment">// å…·ä½“å†™å…¥</span></span><br><span class="line"> EncodedStatistics page_stats = <span class="built_in">GetPageStatistics</span>();</span><br><span class="line"> page_stats.<span class="built_in">ApplyStatSizeLimits</span>(properties_-&gt;<span class="built_in">max_statistics_size</span>(descr_-&gt;<span class="built_in">path</span>()));</span><br><span class="line"> page_stats.<span class="built_in">set_is_signed</span>(SortOrder::SIGNED == descr_-&gt;<span class="built_in">sort_order</span>());</span><br><span class="line"> <span class="built_in">ResetPageStatistics</span>();</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">std::unique_ptr&lt;DataPage&gt; page_ptr = std::<span class="built_in">make_unique</span>&lt;DataPageV1&gt;(</span><br><span class="line"> compressed_data_copy, num_values, encoding_, Encoding::RLE, Encoding::RLE,</span><br><span class="line"> uncompressed_size, page_stats);</span><br></pre></td></tr></table></figure><p>æœ€åï¼Œå€ŸåŠ© <code>ToThrift</code> è½¬åŒ–ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> <span class="keyword">inline</span> format::Statistics <span class="title">ToThrift</span><span class="params">(<span class="type">const</span> EncodedStatistics&amp; stats)</span> </span>&#123;</span><br><span class="line">  format::Statistics statistics;</span><br><span class="line">  <span class="keyword">if</span> (stats.has_min) &#123;</span><br><span class="line">    statistics.__set_min_value(stats.<span class="built_in">min</span>());</span><br><span class="line">    <span class="comment">// If the order is SIGNED, then the old min value must be set too.</span></span><br><span class="line">    <span class="comment">// This for backward compatibility</span></span><br><span class="line">    <span class="keyword">if</span> (stats.<span class="built_in">is_signed</span>()) &#123;</span><br><span class="line">      statistics.__set_min(stats.<span class="built_in">min</span>());</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (stats.has_max) &#123;</span><br><span class="line">    statistics.__set_max_value(stats.<span class="built_in">max</span>());</span><br><span class="line">    <span class="comment">// If the order is SIGNED, then the old max value must be set too.</span></span><br><span class="line">    <span class="comment">// This for backward compatibility</span></span><br><span class="line">    <span class="keyword">if</span> (stats.<span class="built_in">is_signed</span>()) &#123;</span><br><span class="line">      statistics.__set_max(stats.<span class="built_in">max</span>());</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (stats.has_null_count) &#123;</span><br><span class="line">    statistics.__set_null_count(stats.null_count);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (stats.has_distinct_count) &#123;</span><br><span class="line">    statistics.__set_distinct_count(stats.distinct_count);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> statistics;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢æ˜¯ Page å±‚ï¼ŒColumnChunk å±‚ä¼š Merge Page å±‚çš„ï¼Œç›´åˆ°å®Œæˆï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">ResetPageStatistics</span><span class="params">()</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (chunk_statistics_ != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">    chunk_statistics_-&gt;<span class="built_in">Merge</span>(*page_statistics_);</span><br><span class="line">    page_statistics_-&gt;<span class="built_in">Reset</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="C-å®ç°-è¯»"><a href="#C-å®ç°-è¯»" class="headerlink" title="C++ å®ç°: è¯»"></a>C++ å®ç°: è¯»</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Extracts encoded statistics from V1 and V2 data page headers</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> H&gt;</span><br><span class="line"><span class="function">EncodedStatistics <span class="title">ExtractStatsFromHeader</span><span class="params">(<span class="type">const</span> H&amp; header)</span> </span>&#123;</span><br><span class="line">  EncodedStatistics page_statistics;</span><br><span class="line">  <span class="keyword">if</span> (!header.__isset.statistics) &#123;</span><br><span class="line">    <span class="keyword">return</span> page_statistics;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="type">const</span> format::Statistics&amp; stats = header.statistics;</span><br><span class="line">  <span class="comment">// Use the new V2 min-max statistics over the former one if it is filled</span></span><br><span class="line">  <span class="keyword">if</span> (stats.__isset.max_value || stats.__isset.min_value) &#123;</span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> check if the column_order is TYPE_DEFINED_ORDER.</span></span><br><span class="line">    <span class="keyword">if</span> (stats.__isset.max_value) &#123;</span><br><span class="line">      page_statistics.<span class="built_in">set_max</span>(stats.max_value);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (stats.__isset.min_value) &#123;</span><br><span class="line">      page_statistics.<span class="built_in">set_min</span>(stats.min_value);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (stats.__isset.max || stats.__isset.min) &#123;</span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> check created_by to see if it is corrupted for some types.</span></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> check if the sort_order is SIGNED.</span></span><br><span class="line">    <span class="keyword">if</span> (stats.__isset.max) &#123;</span><br><span class="line">      page_statistics.<span class="built_in">set_max</span>(stats.max);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (stats.__isset.min) &#123;</span><br><span class="line">      page_statistics.<span class="built_in">set_min</span>(stats.min);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (stats.__isset.null_count) &#123;</span><br><span class="line">    page_statistics.<span class="built_in">set_null_count</span>(stats.null_count);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (stats.__isset.distinct_count) &#123;</span><br><span class="line">    page_statistics.<span class="built_in">set_distinct_count</span>(stats.distinct_count);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> page_statistics;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶å C++ æ–°ç‰ˆæœ¬ä¸­ï¼Œæœ‰ä¸ª <code>DataPageStats</code> ç”¨åˆ°äº†è¿™ä¸ªç©æ„ã€‚</p><p>å®ç°çš„ç¼ºç‚¹</p><ul><li>å­—å…¸é¡µé¢æ²¡æœ‰æ”¶é›† ndv</li><li>éœ€è¦ comparatorã€‚LogicalType Comparator ç¼ºå¤±çš„è¯ï¼Œä¼šå®Œå…¨æ²¡æœ‰ Statisticsï¼Œå¯¹ Interval ä¹‹ç±»çš„ç±»å‹å¾ˆä¸å‹å¥½</li><li>æœ‰å‡ éƒ¨åˆ†çš„å®ç°æ„Ÿè§‰å¯¹è¯»å‡ºæ¥å¤„ç†ä¸å¤ªå‹å¥½ï¼Œæ¯”å¦‚ null_count / ndv</li></ul><h2 id="PageStats-amp-ColumnIndex"><a href="#PageStats-amp-ColumnIndex" class="headerlink" title="PageStats &amp; ColumnIndex"></a>PageStats &amp; ColumnIndex</h2><p>ColumnChunk ä¸Šè¿˜ä¼šæœ‰ PageStatistics:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/** Set of all encodings used for pages in this column chunk.</span><br><span class="line"> * This information can be used to determine if all data pages are</span><br><span class="line"> * dictionary encoded for example **/</span><br><span class="line">13: optional list&lt;PageEncodingStats&gt; encoding_stats;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ˜¯å†³å®šå†…éƒ¨é¡µé¢çš„ encoding çš„ï¼Œå¯ä»¥åš Dict encoding æ£€æµ‹ã€‚</p><p>ColumnIndex ä¸Šä¼šæœ‰ä¸€äº›ä¸œè¥¿ï¼Œä½ çœ‹çœ‹å°±æ‡‚äº†ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Description for ColumnIndex.</span></span><br><span class="line"><span class="comment"> * Each &lt;array-field&gt;[i] refers to the page at OffsetIndex.page_locations[i]</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ColumnIndex</span> &#123;</span></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * A list of Boolean values to determine the validity of the corresponding</span></span><br><span class="line"><span class="comment">   * min and max values. If true, a page contains only null values, and writers</span></span><br><span class="line"><span class="comment">   * have to set the corresponding entries in min_values and max_values to</span></span><br><span class="line"><span class="comment">   * byte[0], so that all lists have the same length. If false, the</span></span><br><span class="line"><span class="comment">   * corresponding entries in min_values and max_values must be valid.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="number">1</span>: required <span class="built_in">list</span>&lt;<span class="type">bool</span>&gt; null_pages</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Two lists containing lower and upper bounds for the values of each page</span></span><br><span class="line"><span class="comment">   * determined by the ColumnOrder of the column. These may be the actual</span></span><br><span class="line"><span class="comment">   * minimum and maximum values found on a page, but can also be (more compact)</span></span><br><span class="line"><span class="comment">   * values that do not exist on a page. For example, instead of storing &quot;&quot;Blart</span></span><br><span class="line"><span class="comment">   * Versenwald III&quot;, a writer may set min_values[i]=&quot;B&quot;, max_values[i]=&quot;C&quot;.</span></span><br><span class="line"><span class="comment">   * Such more compact values must still be valid values within the column&#x27;s</span></span><br><span class="line"><span class="comment">   * logical type. Readers must make sure that list entries are populated before</span></span><br><span class="line"><span class="comment">   * using them by inspecting null_pages.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="number">2</span>: required <span class="built_in">list</span>&lt;binary&gt; min_values</span><br><span class="line">  <span class="number">3</span>: required <span class="built_in">list</span>&lt;binary&gt; max_values</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Stores whether both min_values and max_values are ordered and if so, in</span></span><br><span class="line"><span class="comment">   * which direction. This allows readers to perform binary searches in both</span></span><br><span class="line"><span class="comment">   * lists. Readers cannot assume that max_values[i] &lt;= min_values[i+1], even</span></span><br><span class="line"><span class="comment">   * if the lists are ordered.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="number">4</span>: required BoundaryOrder boundary_order</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** A list containing the number of null values for each page **/</span></span><br><span class="line">  <span class="number">5</span>: optional <span class="built_in">list</span>&lt;i64&gt; null_counts</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæœ‰ä¸ªé—®é¢˜ï¼Œå°±æ˜¯å¯¹ NaN çš„å¤„ç†ï¼Œè¿™å—æ­£åœ¨ RFC å¤„ç†ä¸­ï¼š<a href="https://issues.apache.org/jira/browse/PARQUET-2249">https://issues.apache.org/jira/browse/PARQUET-2249</a> .</p><p>å…¶ä»–å¾ˆå¤šéƒ¨åˆ†å…¶å®ä¹Ÿä¾èµ– PageStatistics çš„æ”¶é›†å’Œéšå«çš„ SortOrderã€‚å“ï¼Œè¿™ä¸‹ä»¤äººå”å˜˜äº†</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Parquet C++: from schema to schema</title>
      <link href="/2023/02/18/Parquet-C-from-schema-to-schema/"/>
      <url>/2023/02/18/Parquet-C-from-schema-to-schema/</url>
      
        <content type="html"><![CDATA[<p>è¿™èŠ‚æˆ‘ä»¬è®¨è®ºä¸€ä¸ªé‡è¦ä½†æ˜¯ trivial çš„è¯é¢˜ï¼ŒSchemaã€‚è¿™ä¸ªè¯é¢˜åœ¨å¤„ç†ç±»å‹çš„æ—¶å€™é¢å¤–é‡è¦ï¼Œç”¨æˆ·éœ€è¦é€‰æ‹©ç±»å‹ï¼Œæ¥æ„å»ºåˆç†çš„æŠ½è±¡ï¼Œè€Œè¿™é‡Œæœ‰å‡ ä¸ªé—®é¢˜ï¼š</p><ul><li>ï¼ˆè¿™é‡Œæˆ‘ä»¬è®¨è®º Primitive Typesï¼‰ <a href="https://github.com/apache/parquet-format/blob/master/LogicalTypes.md">https://github.com/apache/parquet-format/blob/master/LogicalTypes.md</a> Parquet ç‰©ç†ç±»å‹ç»™çš„å¹¶ä¸å¤šï¼Œè€Œ LogicalType æ”¯æŒä¸æ˜¯å®Œå…¨çš„æ”¯æŒã€‚è¿™é‡Œé¢ä¸´ä¸€ä¸ªç±»å‹æ˜ å°„çš„å…³ç³»</li><li>æ¯ä¸ªç±»å‹çš„ Order ä¹‹ç±»çš„éƒ½æ˜¯ä¸ä¸€æ ·çš„ï¼ŒOrder ä¼šå½±å“å¯¹åº” Statistics çš„ç”Ÿæˆ</li><li>ç”¨æˆ·çš„ç±»å‹ã€Statistics <strong>ä¸ä¸€å®šç­‰äº</strong> Parquet å†…éƒ¨çš„ Statisticsï¼Œè¿™ä¸ªæœ‰ç‚¹åç›´è§‰ï¼Œæœ€å…¸å‹çš„åœºæ™¯æ˜¯ count å’Œ nullã€‚æ­¤å¤–è¿˜è¦è€ƒè™‘å¾ˆå¤š Sort Order çš„ä¸œè¥¿</li><li>å¤–å¤´çš„æ•°æ®å†™è¿› Parquet ä¹Ÿéœ€è¦æœ‰ä¸€ä¸ªåˆç†çš„ Order Mapping å’Œå¯¹åº”çš„ Mappingï¼Œæ¥å®Œæˆé«˜æ•ˆçš„å†™</li></ul><p>è¿™æ•´ä¸ªé“¾è·¯å¹¶ä¸å¤æ‚ï¼Œä½†æ˜¯å¾ˆç¹çã€‚ä½†æ˜¯å¦‚æœä¸ç†è§£è¿™ä¸€å—ï¼Œå¿…ç„¶ä¼šç¢°åˆ°é—®é¢˜ã€‚</p><h2 id="Arrow-Schema"><a href="#Arrow-Schema" class="headerlink" title="Arrow Schema"></a>Arrow Schema</h2><p>arrow schema è·¯å¾„åœ¨ <code>src/arrow/type.h</code>ã€‚å®ƒæ˜¯ä¸€ä¸ªå¾ˆå¹²å‡€çš„ arrow schema. åœ¨å†…å­˜ä¸­æ˜¯ä¸€ä¸ªæ ‘å½¢ç»“æ„</p><p>å…³äº fieldId, è¿™ä¸ªéœ€è¦ç”¨æˆ·æ‰‹åŠ¨è¿›è¡Œç¼–ç ï¼š</p><blockquote><p>The parquet format supports an optional integer field_id which can be assigned to a field. Arrow will convert these field IDs to a metadata key named PARQUET:field_id on the appropriate field.</p></blockquote><h2 id="Parquet-Schema"><a href="#Parquet-Schema" class="headerlink" title="Parquet Schema"></a>Parquet Schema</h2><p>parquet schema åœ¨å†…å­˜ä¸­æ˜¯ä¸€ä¸ªæ ‘å½¢çš„å±‚çº§å…³ç³»ï¼Œå†™åˆ°ç£ç›˜ä¸Šä¼šä»¥ dfs çš„å½¢å¼ flatten. åœ¨æ ‡å‡†ä¸­ï¼ˆè§ç³»åˆ— 1ï¼‰æœ‰æ¯”è¾ƒè¯¦ç»†çš„æè¿°ã€‚è¿™é‡Œç®€å•å›é¡¾ä¸€ä¸‹å­˜å‚¨ä¸­çš„ schema: <a href="https://blog.mwish.me/2022/09/18/Parquet-Part1-Basic/#%E7%B1%BB%E5%9E%8B%E7%B3%BB%E7%BB%9F%E5%92%8C%E9%80%BB%E8%BE%91%E7%B1%BB%E5%9E%8B">https://blog.mwish.me/2022/09/18/Parquet-Part1-Basic/#%E7%B1%BB%E5%9E%8B%E7%B3%BB%E7%BB%9F%E5%92%8C%E9%80%BB%E8%BE%91%E7%B1%BB%E5%9E%8B</a></p><ol><li><code>SchemaElement</code> æ ‘çš„å¶å­ç»“ç‚¹ï¼ŒåŒ…æ‹¬å¯¹åº”çš„ç±»å‹ï¼ˆLogical, Physicalï¼‰å’Œä¸€äº›å¥‡æ€ªçš„å­—æ®µï¼ˆFLBA é•¿åº¦ã€æµ®ç‚¹æ•°ç²¾åº¦ï¼‰</li><li><code>FileMetaData</code> ä¸­åŒ…å« <code>list&lt;SchemaElement&gt; schema</code> </li></ol><p>ä¸Šé¢æ˜¯å­˜å‚¨çš„ã€‚å†…å­˜ç»“æ„å¯¹åº”è·¯å¾„åœ¨ <code>src/parquet/schema.h</code>. ç®€å•ä»‹ç»ä¸€ä¸‹ï¼Œè¿™å—é€»è¾‘å¦‚ä¸‹ï¼š</p><ul><li><code>ColumnPath</code>: Schema ä¸­æŸä¸ªè·¯å¾„ã€‚å®ç°ä¸Šæ˜¯ä¸€ä¸ª <code>vector&lt;string&gt;</code>, å¯ä»¥ä»¥ dot-path çš„å½¢å¼å–è·¯å¾„ (<code>root.struct.field</code>)</li><li><code>Node</code>: å•ä¸ªèŠ‚ç‚¹çš„ base-classï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™ä¸ª Node <strong>æ˜¯ Parquet ä¸­çš„ Node</strong>ï¼Œè€Œä¸å®Œå…¨ç­‰äºç”¨æˆ·çš„ schema<ul><li>Node æœ‰ Primitive å’Œ Group ä¸¤ç§ç±»å‹ï¼Œå¯ä»¥ç†è§£ Group æ˜¯å¸¦å´½çš„</li><li>åŒ…å« RepititionTypeã€<code>field_id</code>ï¼Œï¼ˆå¯èƒ½å­˜åœ¨çš„ï¼‰çˆ¶äº²èŠ‚ç‚¹ï¼Œæœ¬èŠ‚ç‚¹çš„ nameã€LogicalType (è¿™é‡Œè¿˜å®ç°äº† ConvertTypeï¼Œæ¶å¿ƒå•Š)</li></ul></li><li><code>PrimitiveNode</code>: åŒ…å« PhysicalTypeï¼Œè‡ªç„¶ä¹Ÿå°±åŒ…å« SchemaElement ä¸­ <em>é‚£äº›å¥‡æ€ªçš„å­—æ®µ</em> å’Œ ColumnOrder</li><li><code>GroupNode</code>: åœ¨ Parquet å†…éƒ¨çš„ mapï¼Œç›¸å½“äºåªæœ‰ LogicalType (åªæœ‰ <code>PrimitiveNode</code> æœ‰ Physical Type)ï¼Œè¿™å±‚æ²¡æœ‰ fieldId çš„æ¦‚å¿µ</li></ul><p>ä¸Šé¢æ˜¯ Node çº§åˆ«ï¼Œä¸‹é¢æ˜¯ Column (<strong>Physical</strong>) çº§åˆ«çš„ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// The ColumnDescriptor encapsulates information necessary to interpret</span></span><br><span class="line"><span class="comment">// primitive column data in the context of a particular schema. We have to</span></span><br><span class="line"><span class="comment">// examine the node structure of a column&#x27;s path to the root in the schema tree</span></span><br><span class="line"><span class="comment">// to be able to reassemble the nested structure from the repetition and</span></span><br><span class="line"><span class="comment">// definition levels.</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PARQUET_EXPORT</span> ColumnDescriptor &#123;</span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="built_in">ColumnDescriptor</span>(schema::NodePtr node, <span class="type">int16_t</span> max_definition_level,</span><br><span class="line">                   <span class="type">int16_t</span> max_repetition_level,</span><br><span class="line">                   <span class="type">const</span> SchemaDescriptor* schema_descr = NULLPTR);</span><br><span class="line"> <span class="keyword">private</span>:</span><br><span class="line">  schema::NodePtr node_;</span><br><span class="line">  <span class="type">const</span> schema::PrimitiveNode* primitive_node_;</span><br><span class="line"></span><br><span class="line">  <span class="type">int16_t</span> max_definition_level_;</span><br><span class="line">  <span class="type">int16_t</span> max_repetition_level_;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å’Œå¯¹åº”çš„ <code>SchemaDescriptor</code>ï¼Œè¿™é‡Œæ˜¯ Parquet Schema æ€»çš„ Containerï¼Œä¹Ÿå°±æ˜¯ Parquet å†…éƒ¨ Schema çš„æ ¸å¿ƒäº†ã€‚æˆ‘ä»¬éœ€è¦çŸ¥é“ï¼š</p><ol><li>RootNode ä¸€å®šæ˜¯ä¸ª <code>struct</code>ï¼Œä½†æŸç§æ„ä¹‰ä¸Šï¼Œå®ƒçš„ field-id å…¶å®æ— æ‰€è°“</li><li>RootNode çš„ç¬¬å‡ ä¸ªå­—æ®µæ ‡å¿—è¿™ä¸ª Schema é•¿ä»€ä¹ˆé¬¼æ ·</li><li>å¯ä»¥é€šè¿‡ <code>Column(idx)</code> å–åˆ° <strong>ç‰©ç†ä¸Šçš„ Column</strong></li></ol><p>å¥½äº†ï¼Œè¿™æ ·ä½ å°±å¯ä»¥ä» <code>SchemaDescriptor</code> æ‹¿åˆ°å¯¹åº”çš„ä¸œè¥¿äº†ï¼Œé¡ºå¸¦è¯´ä¸€å¥ï¼ŒSchemaDescriptor ç»“æ„å¾ˆç®€å•å¥½ç©ï¼Œæˆ‘ä¸€å®šå¾—è´´å‡ºæ¥çœ‹çœ‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"> <span class="keyword">private</span>:</span><br><span class="line">  <span class="keyword">friend</span> <span class="keyword">class</span> <span class="title class_">ColumnDescriptor</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Root Node</span></span><br><span class="line">  schema::NodePtr schema_;</span><br><span class="line">  <span class="comment">// Root Node</span></span><br><span class="line">  <span class="type">const</span> schema::GroupNode* group_node_;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">BuildTree</span><span class="params">(<span class="type">const</span> schema::NodePtr&amp; node, <span class="type">int16_t</span> max_def_level,</span></span></span><br><span class="line"><span class="params"><span class="function">                 <span class="type">int16_t</span> max_rep_level, <span class="type">const</span> schema::NodePtr&amp; base)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Result of leaf node / tree analysis</span></span><br><span class="line">  std::vector&lt;ColumnDescriptor&gt; leaves_;</span><br><span class="line"></span><br><span class="line">  std::unordered_map&lt;<span class="type">const</span> schema::PrimitiveNode*, <span class="type">int</span>&gt; node_to_leaf_index_;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Mapping between leaf nodes and root group of leaf (first node</span></span><br><span class="line">  <span class="comment">// below the schema&#x27;s root group)</span></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  <span class="comment">// For example, the leaf `a.b.c.d` would have a link back to `a`</span></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  <span class="comment">// -- a  &lt;------</span></span><br><span class="line">  <span class="comment">// -- -- b     |</span></span><br><span class="line">  <span class="comment">// -- -- -- c  |</span></span><br><span class="line">  <span class="comment">// -- -- -- -- d</span></span><br><span class="line">  std::unordered_map&lt;<span class="type">int</span>, schema::NodePtr&gt; leaf_to_base_;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Mapping between ColumnPath DotString to the leaf index</span></span><br><span class="line">  std::unordered_multimap&lt;std::string, <span class="type">int</span>&gt; leaf_to_idx_;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="Serialize-è½¬åŒ–ä¸º-Thrift"><a href="#Serialize-è½¬åŒ–ä¸º-Thrift" class="headerlink" title="Serialize: è½¬åŒ–ä¸º Thrift"></a>Serialize: è½¬åŒ–ä¸º Thrift</h3><p>ä¸Šé¢è¯´çš„å†…å­˜ç»“æ„å’Œå­˜å‚¨ç»“æ„è‚¯å®šæ˜¯èƒ½å¤Ÿäº’ç›¸è½¬æ¢çš„ï¼Œè§ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">ToParquet</span><span class="params">(<span class="type">const</span> GroupNode* schema, std::vector&lt;format::SchemaElement&gt;* out)</span> </span>&#123;</span><br><span class="line">  <span class="function">SchemaVisitor <span class="title">visitor</span><span class="params">(out)</span></span>;</span><br><span class="line">  schema-&gt;<span class="built_in">VisitConst</span>(&amp;visitor);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä¼šå¼ºåˆ¶ä½¿ç”¨ DFS é¡ºåºé€’å½’çš„å» Visitï¼Œæ¯æ¬¡ <code>push_back</code> ä¸€ä¸ª Schemaï¼Œæ­£å¥½å’Œ <code>FileMetaData</code> ä¸Š <code>list</code> çš„é¡ºåºå»åˆ</p><h3 id="Arrow-Parquet-Bridge"><a href="#Arrow-Parquet-Bridge" class="headerlink" title="Arrow-Parquet Bridge"></a>Arrow-Parquet Bridge</h3><p>ä½ æˆ–è®¸ä¼šè§‰å¾—ï¼Œè®²å®Œäº† Parquet å’Œ Arrow schema å°±å®Œç»“äº†ã€‚ä½†å¹¶æ²¡æœ‰ã€‚<strong>Parquet Schema æ ¼å¼æ˜¯ä¸€ä¸ªæ ‘å½¢çš„æ ¼å¼ï¼Œè€Œä¸”å¯èƒ½ä¸ç­‰ä»·äº Arrow çš„æ ¼å¼</strong>ã€‚è¿™å¥è¯è¯´çš„æœ‰ç‚¹éš¾ç†è§£ï¼Œæˆ‘ä»¬ç›´æ¥çœ‹ä¾‹å­ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// List encodings: using the terminology from Impala to define different styles</span></span><br><span class="line"><span class="comment">// of representing logical lists (a.k.a. ARRAY types) in Parquet schemas. Since</span></span><br><span class="line"><span class="comment">// the converted type named in the Parquet metadata is ConvertedType::LIST we</span></span><br><span class="line"><span class="comment">// use that terminology here. It also helps distinguish from the *_ARRAY</span></span><br><span class="line"><span class="comment">// primitive types.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// One-level encoding: Only allows required lists with required cells</span></span><br><span class="line"><span class="comment">//   repeated value_type name</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Two-level encoding: Enables optional lists with only required cells</span></span><br><span class="line"><span class="comment">//   &lt;required/optional&gt; group list</span></span><br><span class="line"><span class="comment">//     repeated value_type item</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Three-level encoding: Enables optional lists with optional cells</span></span><br><span class="line"><span class="comment">//   &lt;required/optional&gt; group bag</span></span><br><span class="line"><span class="comment">//     repeated group list</span></span><br><span class="line"><span class="comment">//       &lt;required/optional&gt; value_type item</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// 2- and 1-level encoding are respectively equivalent to 3-level encoding with</span></span><br><span class="line"><span class="comment">// the non-repeated nodes set to required.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// The &quot;official&quot; encoding recommended in the Parquet spec is the 3-level, and</span></span><br><span class="line"><span class="comment">// we use that as the default when creating list types. For semantic completeness</span></span><br><span class="line"><span class="comment">// we allow the other two. Since all types of encodings will occur &quot;in the</span></span><br><span class="line"><span class="comment">// wild&quot; we need to be able to interpret the associated definition levels in</span></span><br><span class="line"><span class="comment">// the context of the actual encoding used in the file.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// NB: Some Parquet writers may not set ConvertedType::LIST on the repeated</span></span><br><span class="line"><span class="comment">// SchemaElement, which could make things challenging if we are trying to infer</span></span><br><span class="line"><span class="comment">// that a sequence of nodes semantically represents an array according to one</span></span><br><span class="line"><span class="comment">// of these encodings (versus a struct containing an array). We should refuse</span></span><br><span class="line"><span class="comment">// the temptation to guess, as they say.</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">ListEncoding</span> &#123;</span><br><span class="line">  <span class="keyword">enum</span> <span class="title class_">type</span> &#123; ONE_LEVEL, TWO_LEVEL, THREE_LEVEL &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢è¿™ä¸ªä¾‹å­å¹¶ä¸å¤æ‚ï¼ˆåªè¦ä½ ä¸æ”¹è¿™å—çš„ä»£ç ï¼Œå°±å¾ˆå¥½ç†è§£ï¼‰ã€‚ä½†å®ƒæ­ç¤ºäº†ä¸€ä¸ªäº‹å®ï¼š</p><ol><li>å¤–éƒ¨çš„ Schema å’Œ Parquet Schema æ˜ å°„å…³ç³»ä¸ä¸€å®šä¸€æ ·</li><li>ä¸€ä¸ªå­—æ®µéœ€è¦åˆ†é…çš„ fieldId å¯èƒ½æ²¡é‚£ä¹ˆç®€å•å¤„ç†</li></ol><p><code>src/parquet/arrow/schema.h</code> åšçš„å°±æ˜¯ arrow-parquet æ ¼å¼é—´çš„ Bridgeã€‚å®ƒã€Œç¬¦åˆ Parquet æ ‡å‡†ï¼Œä½†ä¸æ˜¯ Parquet æ ‡å‡†çš„ä¸€éƒ¨åˆ†ã€ï¼Œä½†ã€Œå¿…é¡»è¦è¿™ä¸ªæ¡¥æ¢ï¼Œæ‰èƒ½æ„å»º Parquetã€ã€‚</p><p>æˆ‘ä»¬å¯ä»¥åœ¨ testing æ‰¾åˆ°ä¸€ä¸ªå¾ˆå¥½çš„ sample ä»£ç ï¼Œåœ¨æˆ‘ä»¬è·³è¿›ç»†èŠ‚ä¹‹å‰ï¼Œå¯ä»¥ç®€å•çœ‹çœ‹è¿™å—çš„ä»£ç ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">::<span class="function">arrow::Status <span class="title">RoundTripSchema</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> std::vector&lt;std::shared_ptr&lt;Field&gt;&gt;&amp; fields,</span></span></span><br><span class="line"><span class="params"><span class="function">    std::shared_ptr&lt;::parquet::ArrowWriterProperties&gt; arrow_properties =</span></span></span><br><span class="line"><span class="params"><span class="function">        ::parquet::default_arrow_writer_properties())</span> </span>&#123;</span><br><span class="line">  arrow_schema_ = ::arrow::<span class="built_in">schema</span>(fields);</span><br><span class="line">  std::shared_ptr&lt;::parquet::WriterProperties&gt; properties =</span><br><span class="line">      ::parquet::<span class="built_in">default_writer_properties</span>();</span><br><span class="line">  <span class="built_in">RETURN_NOT_OK</span>(<span class="built_in">ToParquetSchema</span>(arrow_schema_.<span class="built_in">get</span>(), *properties.<span class="built_in">get</span>(),</span><br><span class="line">                                *arrow_properties, &amp;parquet_schema_));</span><br><span class="line">  ::parquet::schema::<span class="built_in">ToParquet</span>(parquet_schema_-&gt;<span class="built_in">group_node</span>(), &amp;parquet_format_schema_);</span><br><span class="line">  <span class="keyword">auto</span> parquet_schema = ::parquet::schema::<span class="built_in">FromParquet</span>(parquet_format_schema_);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">FromParquetSchema</span>(parquet_schema.<span class="built_in">get</span>(), &amp;result_schema_);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å­—æ®µçº§åˆ«-SchemaField"><a href="#å­—æ®µçº§åˆ«-SchemaField" class="headerlink" title="å­—æ®µçº§åˆ«: SchemaField"></a>å­—æ®µçº§åˆ«: SchemaField</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// \brief Bridge between an arrow::Field and parquet column indices.</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">PARQUET_EXPORT</span> SchemaField &#123;</span><br><span class="line">  std::shared_ptr&lt;::arrow::Field&gt; field;</span><br><span class="line">  std::vector&lt;SchemaField&gt; children;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Only set for leaf nodes</span></span><br><span class="line">  <span class="type">int</span> column_index = <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">  parquet::internal::LevelInfo level_info;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="type">bool</span> <span class="title">is_leaf</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> column_index != <span class="number">-1</span>; &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å¾ˆå¥½æ‡‚ï¼Œè¿™é‡Œæ³¨æ„ï¼š</p><ol><li><code>column_index</code> æ ‡æ³¨ leaf çš„å®é™… column</li><li><code>level_info</code> æ ‡æ³¨ parquet å¯¹åº”çš„ Level</li></ol><p>åœ¨å¶å­ä¸Šä¼šæœ‰æ‰¾åˆ° parquet çš„ column_index. éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™ä¸ªå’Œ arrow çš„ Schema æ˜¯å¯¹åº”çš„ï¼Œä½†æ˜¯å’Œ Parquet çš„ Schema ä¸æ˜¯ä¸€ä¸€å¯¹åº”çš„ï¼</p><p>è¿™ä¸ªæ€ä¹ˆç†è§£å‘¢ï¼Œæˆ‘ä»¬å…ˆç•™ä¸ªå…³å­ï¼Œå¯ä»¥å…ˆç†è§£æˆè¿™é‡Œè¡¨ç¤ºçš„æ˜¯ã€Œ Parquet ä¸­å­˜åœ¨ï¼Œarrow ä¸­ä¹Ÿå­˜åœ¨çš„ Schemaã€ã€‚</p><h3 id="SchemaManifest"><a href="#SchemaManifest" class="headerlink" title="SchemaManifest"></a>SchemaManifest</h3><p><code>SchemaManifest</code> æ˜¯å†™å…¥çš„æ—¶å€™ï¼ŒParquet è½¬ arrow çš„å·¥å…·ï¼ŒåŒæ—¶ä¹Ÿæ˜¯è¯»å–çš„æ—¶å€™ï¼Œarrow è½¬ Parquet çš„å·¥å…·ï¼Œä½†è€å®è¯´ï¼Œè¿™ä¸ªå·¥å…·å¹¶ä¸æ€ä¹ˆã€Œæ˜¾è€Œæ˜“è§ã€ã€‚ä½¿ç”¨æ–¹æ³•è¦çœ‹ä»£ç æ‰èƒ½çŸ¥é“æ˜¯åœ¨åšä»€ä¹ˆã€‚è¿™å—ä»£ç ä¸»è¦åœ¨ï¼š<code>ArrowColumnWriterV2::Make</code> è¿™å¥—ä»£ç é‡Œé¢ã€‚ä¹‹å‰æˆ‘ä»¬åœ¨è¿™ç¯‡åšå®¢ Part-2 å…¶å®ä»‹ç»åˆ°äº†è¿™å—çš„æµç¨‹ï¼Œä½†æ˜¯æ›´å…³æ³¨äºå†…éƒ¨çš„ writer æ˜¯æ€ä¹ˆå†™å…¥ def-level å’Œ rep-level çš„ï¼Œä»Šå¤©ä»‹ç»çš„å†…å®¹ç®€å•ä¸€äº›ï¼Œå•çº¯è®²å‡ ä¸ª Array åˆ° Parquet Array çš„æ˜ å°„å…³ç³»ã€‚</p><p>æœ¬æ¥æˆ‘ä»¬åº”è¯¥å¦‚åŒå‰é¢ä¸€æ ·ï¼Œä»‹ç» <code>SchemaManifest</code> è¿™ä¸ªç±»å‹ï¼Œä½†æˆ‘ä»¬è¿˜æ˜¯å…ˆä» User å±‚é¢æ¥ä»‹ç»ä¸€äº›ï¼Œé¦–å…ˆï¼Œæˆ‘ä»¬çœ‹çœ‹ä¸€ä¸ªå¥‡å¦™çš„é€’å½’ cacl. è¿™ä¸ªæ˜¯æ ¹æ® Arrow çš„ç±»å‹æ¥åš Calcã€‚æˆ‘æƒ³ä»»ä½•ä¸€ä¸ªå¤§ä¸€å­¦ç”Ÿéƒ½èƒ½å†™å‡ºæ¥â€¦</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">CalculateLeafCount</span><span class="params">(<span class="type">const</span> DataType* type)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (type-&gt;<span class="built_in">id</span>() == ::arrow::Type::EXTENSION) &#123;</span><br><span class="line">    type = <span class="built_in">checked_cast</span>&lt;<span class="type">const</span> ExtensionType&amp;&gt;(*type).<span class="built_in">storage_type</span>().<span class="built_in">get</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// Note num_fields() can be 0 for an empty struct type</span></span><br><span class="line">  <span class="keyword">if</span> (!::arrow::<span class="built_in">is_nested</span>(type-&gt;<span class="built_in">id</span>())) &#123;</span><br><span class="line">    <span class="comment">// Primitive type.</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="type">int</span> num_leaves = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">const</span> <span class="keyword">auto</span>&amp; field : type-&gt;<span class="built_in">fields</span>()) &#123;</span><br><span class="line">    num_leaves += <span class="built_in">CalculateLeafCount</span>(field-&gt;<span class="built_in">type</span>().<span class="built_in">get</span>());</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> num_leaves;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªåœ°æ–¹ï¼Œåˆ›å»º SchemaManifest çš„æ—¶å€™ï¼Œä¼šåœ¨ä¸‹åˆ—æ„å»º physical-column-to-index å’Œ node-to-parent çš„ mappingã€‚ç„¶å Writer å€ŸåŠ©è¿™äº›æ˜ å°„æ¥æ‰¾åˆ°æ‰€æœ‰çš„ Leafï¼Œå®Œæˆå¯¹åº”çš„å†™ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">SchemaTreeContext</span> &#123;</span><br><span class="line">  SchemaManifest* manifest;</span><br><span class="line">  ArrowReaderProperties properties;</span><br><span class="line">  <span class="type">const</span> SchemaDescriptor* schema;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">LinkParent</span><span class="params">(<span class="type">const</span> SchemaField* child, <span class="type">const</span> SchemaField* parent)</span> </span>&#123;</span><br><span class="line">    manifest-&gt;child_to_parent[child] = parent;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">RecordLeaf</span><span class="params">(<span class="type">const</span> SchemaField* leaf)</span> </span>&#123;</span><br><span class="line">    manifest-&gt;column_index_to_field[leaf-&gt;column_index] = leaf;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>æ³¨æ„ï¼Œè¿™é‡Œè¿˜æ˜¯æ²¡æœ‰ <code>FieldId</code> è¿™ä¸ªæ¦‚å¿µçš„ï¼Œé‚£ä¹ˆâ€¦ä»€ä¹ˆåœ°æ–¹æœ‰å‘¢ï¼Ÿç­”æ¡ˆå¾ˆç¬¦åˆç›´è§‰ï¼š<code>::arrow::Schema</code>.</p><p>ä½ è‚¯å®šè¦éª‚å¨˜äº†ï¼Œ<code>::arrow::Schema</code> æœ‰ï¼Œä½ ä¸ºå•¥è¦è®²è¿™ä¹ˆå¤šã€‚è¿™ä½ å°±ä¸å¯¹äº†ï¼Œä½ å»ç¿»ç¿» <code>arrow::Schema</code>  çš„ä»£ç ï¼Œè‚¯å®šæ‰¾ä¸åˆ° fieldIdï¼Œæ€ä¹ˆä¼šæ˜¯å‘¢ï¼Ÿè®°å¾—æˆ‘æœ€æ—©è´´çš„ä¸ï¼š</p><blockquote><p>The parquet format supports an optional integer field_id which can be assigned to a field. Arrow will convert these field IDs to a metadata key named PARQUET:field_id on the appropriate field.</p></blockquote><p>åœ¨ arrow schema ä¸‹ï¼Œæœ‰ä¸€å¥—è¿™æ ·çš„æ¥å£ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// \defgroup arrow-to-parquet-schema-conversion Functions to convert an Arrow</span></span><br><span class="line"><span class="comment">/// schema into a Parquet schema.</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// @&#123;</span></span><br><span class="line"></span><br><span class="line">PARQUET_EXPORT</span><br><span class="line">::<span class="function">arrow::Status <span class="title">FieldToNode</span><span class="params">(<span class="type">const</span> std::shared_ptr&lt;::arrow::Field&gt;&amp; field,</span></span></span><br><span class="line"><span class="params"><span class="function">                            <span class="type">const</span> WriterProperties&amp; properties,</span></span></span><br><span class="line"><span class="params"><span class="function">                            <span class="type">const</span> ArrowWriterProperties&amp; arrow_properties,</span></span></span><br><span class="line"><span class="params"><span class="function">                            schema::NodePtr* out)</span></span>;</span><br><span class="line"></span><br><span class="line">PARQUET_EXPORT</span><br><span class="line">::<span class="function">arrow::Status <span class="title">ToParquetSchema</span><span class="params">(<span class="type">const</span> ::arrow::Schema* arrow_schema,</span></span></span><br><span class="line"><span class="params"><span class="function">                                <span class="type">const</span> WriterProperties&amp; properties,</span></span></span><br><span class="line"><span class="params"><span class="function">                                <span class="type">const</span> ArrowWriterProperties&amp; arrow_properties,</span></span></span><br><span class="line"><span class="params"><span class="function">                                std::shared_ptr&lt;SchemaDescriptor&gt;* out)</span></span>;</span><br><span class="line"></span><br><span class="line">PARQUET_EXPORT</span><br><span class="line">::<span class="function">arrow::Status <span class="title">ToParquetSchema</span><span class="params">(<span class="type">const</span> ::arrow::Schema* arrow_schema,</span></span></span><br><span class="line"><span class="params"><span class="function">                                <span class="type">const</span> WriterProperties&amp; properties,</span></span></span><br><span class="line"><span class="params"><span class="function">                                std::shared_ptr&lt;SchemaDescriptor&gt;* out)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// @&#125;</span></span><br></pre></td></tr></table></figure><p><code>FieldToNode</code> å®Œæˆäº† <code>arrow</code> çš„ <code>Field</code> (å¯èƒ½åŒ…å«åµŒå¥—ç»“æ„) åˆ° Parquet çš„ Node çš„è½¬æ¢ã€‚è¿™é‡Œæˆ‘ä»¬å…³æ³¨ä¸¤ä¸ªäº‹æƒ…ï¼š</p><ol><li>FieldId çš„å¡«å†™</li><li>ç±»å‹è½¬åŒ–ï¼ˆå°¤å…¶æ˜¯åµŒå¥—ç±»å‹ï¼‰ã€‚</li></ol><p>å…³äº FieldId å¡«å†™ï¼Œå†…å®¹åœ¨æœ€å¼€å§‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Status <span class="title">FieldToNode</span><span class="params">(<span class="type">const</span> std::string&amp; name, <span class="type">const</span> std::shared_ptr&lt;Field&gt;&amp; field,</span></span></span><br><span class="line"><span class="params"><span class="function">                   <span class="type">const</span> WriterProperties&amp; properties,</span></span></span><br><span class="line"><span class="params"><span class="function">                   <span class="type">const</span> ArrowWriterProperties&amp; arrow_properties, NodePtr* out)</span> </span>&#123;</span><br><span class="line">  std::shared_ptr&lt;<span class="type">const</span> LogicalType&gt; logical_type = LogicalType::<span class="built_in">None</span>();</span><br><span class="line">  ParquetType::type type;</span><br><span class="line">  Repetition::type repetition = <span class="built_in">RepetitionFromNullable</span>(field-&gt;<span class="built_in">nullable</span>());</span><br><span class="line">  <span class="type">int</span> field_id = <span class="built_in">FieldIdFromMetadata</span>(field-&gt;<span class="built_in">metadata</span>());</span><br></pre></td></tr></table></figure><p>è¿™ä¸ª <code>FieldIdFromMetadata</code> å°±æ˜¯æˆ‘ä»¬ä¸€å¼€å§‹æçš„ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">constexpr</span> <span class="type">char</span> FIELD_ID_KEY[] = <span class="string">&quot;PARQUET:field_id&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="function">std::shared_ptr&lt;::arrow::KeyValueMetadata&gt; <span class="title">FieldIdMetadata</span><span class="params">(<span class="type">int</span> field_id)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (field_id &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> ::arrow::<span class="built_in">key_value_metadata</span>(&#123;FIELD_ID_KEY&#125;, &#123;<span class="built_in">ToChars</span>(field_id)&#125;);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">FieldIdFromMetadata</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> std::shared_ptr&lt;<span class="type">const</span> ::arrow::KeyValueMetadata&gt;&amp; metadata)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!metadata) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="type">int</span> key = metadata-&gt;<span class="built_in">FindKey</span>(FIELD_ID_KEY);</span><br><span class="line">  <span class="keyword">if</span> (key &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  std::string field_id_str = metadata-&gt;<span class="built_in">value</span>(key);</span><br><span class="line">  <span class="type">int</span> field_id;</span><br><span class="line">  <span class="keyword">if</span> (::arrow::internal::<span class="built_in">ParseValue</span>&lt;::arrow::Int32Type&gt;(</span><br><span class="line">          field_id_str.<span class="built_in">c_str</span>(), field_id_str.<span class="built_in">length</span>(), &amp;field_id)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (field_id &lt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="comment">// Thrift should convert any negative value to null but normalize to -1 here in case</span></span><br><span class="line">      <span class="comment">// we later check this in logic.</span></span><br><span class="line">      <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> field_id;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œè¿™ä¸ªä¼šæ ‡è®°åœ¨ <code>arrow::Field</code> çš„ <code>KeyValueMetadata</code> ä¸Šï¼Œåœ¨ Schema ä¸Šåšé¢å¤–çš„ KVï¼Œç„¶åæ ‡æ³¨å­—æ®µç±»å‹ï¼</p><p>é‚£ä¹ˆï¼ŒSchemaManifest æ€ä¹ˆæ¢å¤å‘¢â€¦ç­”æ¡ˆä¹Ÿæœ‰å‘ï¼Œä½ ä¸€å®šè§‰å¾—æˆ‘æ˜¯è¯´ä» <code>SchemaDescriptor</code> æ¥æ¢å¤â€¦å®é™…ä¸å®Œå…¨æ˜¯çš„ï¼Œçœ‹ä»£ç ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Status <span class="title">SchemaManifest::Make</span><span class="params">(<span class="type">const</span> SchemaDescriptor* schema,</span></span></span><br><span class="line"><span class="params"><span class="function">                            <span class="type">const</span> std::shared_ptr&lt;<span class="type">const</span> KeyValueMetadata&gt;&amp; metadata,</span></span></span><br><span class="line"><span class="params"><span class="function">                            <span class="type">const</span> ArrowReaderProperties&amp; properties,</span></span></span><br><span class="line"><span class="params"><span class="function">                            SchemaManifest* manifest)</span> </span>&#123;</span><br><span class="line">  SchemaTreeContext ctx;</span><br><span class="line">  ctx.manifest = manifest;</span><br><span class="line">  ctx.properties = properties;</span><br><span class="line">  ctx.schema = schema;</span><br><span class="line">  <span class="type">const</span> GroupNode&amp; schema_node = *schema-&gt;<span class="built_in">group_node</span>();</span><br><span class="line">  manifest-&gt;descr = schema;</span><br><span class="line">  manifest-&gt;schema_fields.<span class="built_in">resize</span>(schema_node.<span class="built_in">field_count</span>());</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Try to deserialize original Arrow schema</span></span><br><span class="line">  <span class="built_in">RETURN_NOT_OK</span>(</span><br><span class="line">      <span class="built_in">GetOriginSchema</span>(metadata, &amp;manifest-&gt;schema_metadata, &amp;manifest-&gt;origin_schema));</span><br><span class="line">  <span class="comment">// Ignore original schema if it&#x27;s not compatible with the Parquet schema</span></span><br><span class="line">  <span class="keyword">if</span> (manifest-&gt;origin_schema != <span class="literal">nullptr</span> &amp;&amp;</span><br><span class="line">      manifest-&gt;origin_schema-&gt;<span class="built_in">num_fields</span>() != schema_node.<span class="built_in">field_count</span>()) &#123;</span><br><span class="line">    manifest-&gt;origin_schema = <span class="literal">nullptr</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="built_in">static_cast</span>&lt;<span class="type">int</span>&gt;(schema_node.<span class="built_in">field_count</span>()); ++i) &#123;</span><br><span class="line">    SchemaField* out_field = &amp;manifest-&gt;schema_fields[i];</span><br><span class="line">    <span class="built_in">RETURN_NOT_OK</span>(<span class="built_in">NodeToSchemaField</span>(*schema_node.<span class="built_in">field</span>(i), <span class="built_in">LevelInfo</span>(), &amp;ctx,</span><br><span class="line">                                    <span class="comment">/*parent=*/</span><span class="literal">nullptr</span>, out_field));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// TODO(wesm): as follow up to ARROW-3246, we should really pass the origin</span></span><br><span class="line">    <span class="comment">// schema (if any) through all functions in the schema reconstruction, but</span></span><br><span class="line">    <span class="comment">// I&#x27;m being lazy and just setting dictionary fields at the top level for</span></span><br><span class="line">    <span class="comment">// now</span></span><br><span class="line">    <span class="keyword">if</span> (manifest-&gt;origin_schema == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">auto</span> origin_field = manifest-&gt;origin_schema-&gt;<span class="built_in">field</span>(i);</span><br><span class="line">    <span class="built_in">RETURN_NOT_OK</span>(<span class="built_in">ApplyOriginalMetadata</span>(*origin_field, out_field));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> Status::<span class="built_in">OK</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªåœ°æ–¹ä¼šå°è¯• <code>origin_schema</code>ï¼Œæ‹¿åˆ° <code>FileMetadata</code> çš„ <code>origin_schema</code>: ä¸€ä¸ª <code>arrow::Schema</code> ã€‚åŸæ¥ï¼Œè¿™ä¸ªç‹—å± arrow æŠŠè‡ªå·± Schema é¢å¤–å­˜äº†ä¸€ä»½ï¼ŒæƒŠå–œä¸æƒŠå–œã€‚</p><p>è¿™é‡Œé¢çš„æ•°æ®æŒ‰ç…§ <code>arrow::ipc</code> çš„æ ¼å¼ç¼–ç ï¼Œæ„æˆäº†ä¸€ä¸ªã€Œç¼–ç åçš„ <code>arrow::Schema</code>ã€ï¼ˆæœ‰ä¸€ç§æš´éœ²ç»™äº†ç”¨æˆ·åˆæ²¡æœ‰å®Œå…¨æš´éœ²çš„æ„Ÿè§‰ï¼‰ï¼Œç„¶åæŠŠ key-value-metadata ä¸­ arrow schema å»æ‰ï¼Œå†æ‹·è´äº†ä¸€ä»½ï¼Œå°±æ„æˆäº† <code>origin_schema</code>. å½“ç„¶ï¼Œå¦‚æœä¸åŒ…å« <code>origin_schema</code> å¯¹åº”çš„ keyï¼Œè¿™é‡Œå°±ä»€ä¹ˆéƒ½ä¸åšã€‚</p><p>ä½ å¯èƒ½ä¼šå¥½å¥‡ï¼Œ<code>arrow::schema</code> æœ‰ä»€ä¹ˆç”¨å‘¢ï¼Ÿæœ‰äº†å®ƒï¼Œparquet è‡ªå·±çš„ Schema å°±ä¸åšæ•°äº†å˜›ï¼Ÿ</p><p>æˆ‘ä»¬éœ€è¦æå‰ä»‹ç»ä¸€ç‚¹ï¼šarrow Schema å’Œ Parquet Schema çš„æ˜ å°„å…³ç³»ã€‚Parquet æœ¬èº«æ˜¯ Java ç¤¾åŒºçš„äººæå‡ºæ¥çš„ï¼Œè€Œ arrow çš„ä½œè€…æ—©æœŸéƒ½æ˜¯ Python kernel é‚£äº›ä½œè€…ã€‚è¿™ä¸¤å—çš„ç±»å‹ä¸ä¸€å®šä¹Ÿä¸åº”è¯¥ä¸€å®šå®Œå…¨åŒ¹é…çš„ã€‚</p><p>è¿™éƒ¨åˆ†æˆ‘ä»¬è¿˜æ˜¯ç›´æ¥è¯»ä»£ç ï¼Œä¸‹é¢è¿™é‡Œåˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼š</p><ul><li>å¤„ç† nested type, è¿™é‡Œç”¨äº†ä¸€ä¸ª <code>GetFactory</code> å‡½æ•°ï¼Œæ ¹æ® leaf çš„ vectorï¼Œç”Ÿæˆä¸€ä¸ª nested schema</li><li>å¶å­: æ¯”å¦‚ï¼ŒåŸæ¥ Parquet åªæœ‰ Stringï¼Œé‚£ä¹ˆ arrow ä¸‹æ„è¯†è½¬æ¢æˆ <code>LargeString</code>ï¼Œè¿™é‡Œä¼šåšä¸€äº›ç®€å•çš„ç±»å‹ä¿®æ­£</li></ul><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Result&lt;<span class="type">bool</span>&gt; <span class="title">ApplyOriginalStorageMetadata</span><span class="params">(<span class="type">const</span> Field&amp; origin_field,</span></span></span><br><span class="line"><span class="params"><span class="function">                                          SchemaField* inferred)</span> </span>&#123;</span><br><span class="line">  <span class="type">bool</span> modified = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">auto</span>&amp; origin_type = origin_field.<span class="built_in">type</span>();</span><br><span class="line">  <span class="keyword">auto</span>&amp; inferred_type = inferred-&gt;field-&gt;<span class="built_in">type</span>();</span><br><span class="line"></span><br><span class="line">  <span class="type">const</span> <span class="type">int</span> num_children = inferred_type-&gt;<span class="built_in">num_fields</span>();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (num_children &gt; <span class="number">0</span> &amp;&amp; origin_type-&gt;<span class="built_in">num_fields</span>() == num_children) &#123;</span><br><span class="line">    <span class="built_in">DCHECK_EQ</span>(<span class="built_in">static_cast</span>&lt;<span class="type">int</span>&gt;(inferred-&gt;children.<span class="built_in">size</span>()), num_children);</span><br><span class="line">    <span class="type">const</span> <span class="keyword">auto</span> factory = <span class="built_in">GetNestedFactory</span>(*origin_type, *inferred_type);</span><br><span class="line">    <span class="keyword">if</span> (factory) &#123;</span><br><span class="line">      <span class="comment">// The type may be modified (e.g. LargeList) while the children stay the same</span></span><br><span class="line">      modified |= origin_type-&gt;<span class="built_in">id</span>() != inferred_type-&gt;<span class="built_in">id</span>();</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Apply original metadata recursively to children</span></span><br><span class="line">      <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; inferred_type-&gt;<span class="built_in">num_fields</span>(); ++i) &#123;</span><br><span class="line">        <span class="built_in">ARROW_ASSIGN_OR_RAISE</span>(</span><br><span class="line">            <span class="type">const</span> <span class="type">bool</span> child_modified,</span><br><span class="line">            <span class="built_in">ApplyOriginalMetadata</span>(*origin_type-&gt;<span class="built_in">field</span>(i), &amp;inferred-&gt;children[i]));</span><br><span class="line">        modified |= child_modified;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (modified) &#123;</span><br><span class="line">        <span class="comment">// Recreate this field using the modified child fields</span></span><br><span class="line">        ::<span class="function">arrow::FieldVector <span class="title">modified_children</span><span class="params">(inferred_type-&gt;num_fields())</span></span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; inferred_type-&gt;<span class="built_in">num_fields</span>(); ++i) &#123;</span><br><span class="line">          modified_children[i] = inferred-&gt;children[i].field;</span><br><span class="line">        &#125;</span><br><span class="line">        inferred-&gt;field =</span><br><span class="line">            inferred-&gt;field-&gt;<span class="built_in">WithType</span>(<span class="built_in">factory</span>(std::<span class="built_in">move</span>(modified_children)));</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (origin_type-&gt;<span class="built_in">id</span>() == ::arrow::Type::TIMESTAMP &amp;&amp;</span><br><span class="line">      inferred_type-&gt;<span class="built_in">id</span>() == ::arrow::Type::TIMESTAMP) &#123;</span><br><span class="line">    <span class="comment">// Restore time zone, if any</span></span><br><span class="line">    <span class="type">const</span> <span class="keyword">auto</span>&amp; ts_type = <span class="built_in">checked_cast</span>&lt;<span class="type">const</span> ::arrow::TimestampType&amp;&gt;(*inferred_type);</span><br><span class="line">    <span class="type">const</span> <span class="keyword">auto</span>&amp; ts_origin_type =</span><br><span class="line">        <span class="built_in">checked_cast</span>&lt;<span class="type">const</span> ::arrow::TimestampType&amp;&gt;(*origin_type);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If the data is tz-aware, then set the original time zone, since Parquet</span></span><br><span class="line">    <span class="comment">// has no native storage for timezones</span></span><br><span class="line">    <span class="keyword">if</span> (ts_type.<span class="built_in">timezone</span>() == <span class="string">&quot;UTC&quot;</span> &amp;&amp; !ts_origin_type.<span class="built_in">timezone</span>().<span class="built_in">empty</span>()) &#123;</span><br><span class="line">      <span class="keyword">if</span> (ts_type.<span class="built_in">unit</span>() == ts_origin_type.<span class="built_in">unit</span>()) &#123;</span><br><span class="line">        inferred-&gt;field = inferred-&gt;field-&gt;<span class="built_in">WithType</span>(origin_type);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">auto</span> ts_type_new = ::arrow::<span class="built_in">timestamp</span>(ts_type.<span class="built_in">unit</span>(), ts_origin_type.<span class="built_in">timezone</span>());</span><br><span class="line">        inferred-&gt;field = inferred-&gt;field-&gt;<span class="built_in">WithType</span>(ts_type_new);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    modified = <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (origin_type-&gt;<span class="built_in">id</span>() == ::arrow::Type::DURATION &amp;&amp;</span><br><span class="line">      inferred_type-&gt;<span class="built_in">id</span>() == ::arrow::Type::INT64) &#123;</span><br><span class="line">    <span class="comment">// Read back int64 arrays as duration.</span></span><br><span class="line">    inferred-&gt;field = inferred-&gt;field-&gt;<span class="built_in">WithType</span>(origin_type);</span><br><span class="line">    modified = <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (origin_type-&gt;<span class="built_in">id</span>() == ::arrow::Type::DICTIONARY &amp;&amp;</span><br><span class="line">      inferred_type-&gt;<span class="built_in">id</span>() != ::arrow::Type::DICTIONARY &amp;&amp;</span><br><span class="line">      <span class="built_in">IsDictionaryReadSupported</span>(*inferred_type)) &#123;</span><br><span class="line">    <span class="comment">// Direct dictionary reads are only supported for a couple primitive types,</span></span><br><span class="line">    <span class="comment">// so no need to recurse on value types.</span></span><br><span class="line">    <span class="type">const</span> <span class="keyword">auto</span>&amp; dict_origin_type =</span><br><span class="line">        <span class="built_in">checked_cast</span>&lt;<span class="type">const</span> ::arrow::DictionaryType&amp;&gt;(*origin_type);</span><br><span class="line">    inferred-&gt;field = inferred-&gt;field-&gt;<span class="built_in">WithType</span>(</span><br><span class="line">        ::arrow::<span class="built_in">dictionary</span>(::arrow::<span class="built_in">int32</span>(), inferred_type, dict_origin_type.<span class="built_in">ordered</span>()));</span><br><span class="line">    modified = <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ((origin_type-&gt;<span class="built_in">id</span>() == ::arrow::Type::LARGE_BINARY &amp;&amp;</span><br><span class="line">       inferred_type-&gt;<span class="built_in">id</span>() == ::arrow::Type::BINARY) ||</span><br><span class="line">      (origin_type-&gt;<span class="built_in">id</span>() == ::arrow::Type::LARGE_STRING &amp;&amp;</span><br><span class="line">       inferred_type-&gt;<span class="built_in">id</span>() == ::arrow::Type::STRING)) &#123;</span><br><span class="line">    <span class="comment">// Read back binary-like arrays with the intended offset width.</span></span><br><span class="line">    inferred-&gt;field = inferred-&gt;field-&gt;<span class="built_in">WithType</span>(origin_type);</span><br><span class="line">    modified = <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (origin_type-&gt;<span class="built_in">id</span>() == ::arrow::Type::DECIMAL256 &amp;&amp;</span><br><span class="line">      inferred_type-&gt;<span class="built_in">id</span>() == ::arrow::Type::DECIMAL128) &#123;</span><br><span class="line">    inferred-&gt;field = inferred-&gt;field-&gt;<span class="built_in">WithType</span>(origin_type);</span><br><span class="line">    modified = <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Restore field metadata</span></span><br><span class="line">  std::shared_ptr&lt;<span class="type">const</span> KeyValueMetadata&gt; field_metadata = origin_field.<span class="built_in">metadata</span>();</span><br><span class="line">  <span class="keyword">if</span> (field_metadata != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (inferred-&gt;field-&gt;<span class="built_in">metadata</span>()) &#123;</span><br><span class="line">      <span class="comment">// Prefer the metadata keys (like field_id) from the current metadata</span></span><br><span class="line">      field_metadata = field_metadata-&gt;<span class="built_in">Merge</span>(*inferred-&gt;field-&gt;<span class="built_in">metadata</span>());</span><br><span class="line">    &#125;</span><br><span class="line">    inferred-&gt;field = inferred-&gt;field-&gt;<span class="built_in">WithMetadata</span>(field_metadata);</span><br><span class="line">    modified = <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> modified;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨è¿™é‡Œï¼Œå°±ä¼šäº§ç”Ÿå¸¦ field-id çš„å­—æ®µã€‚</p><h4 id="å›åˆ°-FieldToNode"><a href="#å›åˆ°-FieldToNode" class="headerlink" title="å›åˆ° FieldToNode"></a>å›åˆ° FieldToNode</h4><p>æˆ‘ä»¬å†æ¬¡å›åˆ° FieldToNodeï¼Œç»™è¿™èŠ‚æ”¶å°¾ä¸€ä¸‹ã€‚æˆ‘ä»¬ä¹‹å‰è¯´è¿‡ï¼Œ<code>FieldToNode</code> ä¸­ï¼Œ<code>arrow::Field</code> æ•°é‡å¯èƒ½å°‘äº Parquet çš„ Schemaã€‚é‚£ä¹ˆè¿™ä¸ªæ˜ å°„æ˜¯æ€ä¹ˆå®ç°çš„ï¼Ÿç¼ºå¤±å­—æ®µ fieldId æ€ä¹ˆå¡«ï¼Ÿç­”æ¡ˆæ˜¯å¡«äº†ä¸ªå¯‚å¯ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Status <span class="title">FieldToNode</span><span class="params">(<span class="type">const</span> std::string&amp; name, <span class="type">const</span> std::shared_ptr&lt;Field&gt;&amp; field,</span></span></span><br><span class="line"><span class="params"><span class="function">                   <span class="type">const</span> WriterProperties&amp; properties,</span></span></span><br><span class="line"><span class="params"><span class="function">                   <span class="type">const</span> ArrowWriterProperties&amp; arrow_properties, NodePtr* out)</span> </span>&#123;</span><br><span class="line">...</span><br><span class="line">    <span class="keyword">case</span> ArrowTypeId::FIXED_SIZE_LIST:</span><br><span class="line">    <span class="keyword">case</span> ArrowTypeId::LARGE_LIST:</span><br><span class="line">    <span class="keyword">case</span> ArrowTypeId::LIST: &#123;</span><br><span class="line">      <span class="keyword">auto</span> list_type = std::<span class="built_in">static_pointer_cast</span>&lt;::arrow::BaseListType&gt;(field-&gt;<span class="built_in">type</span>());</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">ListToNode</span>(list_type, name, field-&gt;<span class="built_in">nullable</span>(), field_id, properties,</span><br><span class="line">                        arrow_properties, out);</span><br><span class="line">    &#125;          </span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬æŠŠè§†è§’åˆ‡æ¢åˆ° <code>ListToNode</code>:</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Status <span class="title">ListToNode</span><span class="params">(<span class="type">const</span> std::shared_ptr&lt;::arrow::BaseListType&gt;&amp; type,</span></span></span><br><span class="line"><span class="params"><span class="function">                  <span class="type">const</span> std::string&amp; name, <span class="type">bool</span> nullable, <span class="type">int</span> field_id,</span></span></span><br><span class="line"><span class="params"><span class="function">                  <span class="type">const</span> WriterProperties&amp; properties,</span></span></span><br><span class="line"><span class="params"><span class="function">                  <span class="type">const</span> ArrowWriterProperties&amp; arrow_properties, NodePtr* out)</span> </span>&#123;</span><br><span class="line">  NodePtr element;</span><br><span class="line">  std::string value_name =</span><br><span class="line">      arrow_properties.<span class="built_in">compliant_nested_types</span>() ? <span class="string">&quot;element&quot;</span> : type-&gt;<span class="built_in">value_field</span>()-&gt;<span class="built_in">name</span>();</span><br><span class="line">  <span class="built_in">RETURN_NOT_OK</span>(<span class="built_in">FieldToNode</span>(value_name, type-&gt;<span class="built_in">value_field</span>(), properties, arrow_properties,</span><br><span class="line">                            &amp;element));</span><br><span class="line"></span><br><span class="line">  NodePtr list = GroupNode::<span class="built_in">Make</span>(<span class="string">&quot;list&quot;</span>, Repetition::REPEATED, &#123;element&#125;);</span><br><span class="line">  *out = GroupNode::<span class="built_in">Make</span>(name, <span class="built_in">RepetitionFromNullable</span>(nullable), &#123;list&#125;,</span><br><span class="line">                         LogicalType::<span class="built_in">List</span>(), field_id);</span><br><span class="line">  <span class="keyword">return</span> Status::<span class="built_in">OK</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæ’å…¥äº†ä¸€ä¸ªæ²¡ fieldId çš„ Listï¼Œå¯¹åº” fieldId ä¸º <code>-1</code>ï¼Œå˜»å˜»ã€‚</p><h4 id="åµŒå¥—ç»“æ„å…¼å®¹æ€§è§£æ"><a href="#åµŒå¥—ç»“æ„å…¼å®¹æ€§è§£æ" class="headerlink" title="åµŒå¥—ç»“æ„å…¼å®¹æ€§è§£æ"></a>åµŒå¥—ç»“æ„å…¼å®¹æ€§è§£æ</h4><p>è¿™éƒ¨åˆ†è¿˜æ˜¯è¦åˆ° arrow çš„è½¬æ¢ä¸­ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Status <span class="title">NodeToSchemaField</span><span class="params">(<span class="type">const</span> Node&amp; node, LevelInfo current_levels,</span></span></span><br><span class="line"><span class="params"><span class="function">                         SchemaTreeContext* ctx, <span class="type">const</span> SchemaField* parent,</span></span></span><br><span class="line"><span class="params"><span class="function">                         SchemaField* out)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// Workhorse function for converting a Parquet schema node to an Arrow</span></span><br><span class="line">  <span class="comment">// type. Handles different conventions for nested data.</span></span><br><span class="line"></span><br><span class="line">  ctx-&gt;<span class="built_in">LinkParent</span>(out, parent);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Now, walk the schema and create a ColumnDescriptor for each leaf node</span></span><br><span class="line">  <span class="keyword">if</span> (node.<span class="built_in">is_group</span>()) &#123;</span><br><span class="line">    <span class="comment">// A nested field, but we don&#x27;t know what kind yet</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">GroupToSchemaField</span>(<span class="built_in">static_cast</span>&lt;<span class="type">const</span> GroupNode&amp;&gt;(node), current_levels, ctx,</span><br><span class="line">                              parent, out);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// Either a normal flat primitive type, or a list type encoded with 1-level</span></span><br><span class="line">    <span class="comment">// list encoding. Note that the 3-level encoding is the form recommended by</span></span><br><span class="line">    <span class="comment">// the parquet specification, but technically we can have either</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// required/optional $TYPE $FIELD_NAME</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// or</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// repeated $TYPE $FIELD_NAME</span></span><br><span class="line">    <span class="type">const</span> <span class="keyword">auto</span>&amp; primitive_node = <span class="built_in">static_cast</span>&lt;<span class="type">const</span> PrimitiveNode&amp;&gt;(node);</span><br><span class="line">    <span class="type">int</span> column_index = ctx-&gt;schema-&gt;<span class="built_in">GetColumnIndex</span>(primitive_node);</span><br><span class="line">    <span class="built_in">ASSIGN_OR_RAISE</span>(std::shared_ptr&lt;ArrowType&gt; type,</span><br><span class="line">                    <span class="built_in">GetTypeForNode</span>(column_index, primitive_node, ctx));</span><br><span class="line">    <span class="keyword">if</span> (node.<span class="built_in">is_repeated</span>()) &#123;</span><br><span class="line">      <span class="comment">// One-level list encoding, e.g.</span></span><br><span class="line">      <span class="comment">// a: repeated int32;</span></span><br><span class="line">      <span class="type">int16_t</span> repeated_ancestor_def_level = current_levels.<span class="built_in">IncrementRepeated</span>();</span><br><span class="line">      out-&gt;children.<span class="built_in">resize</span>(<span class="number">1</span>);</span><br><span class="line">      <span class="keyword">auto</span> child_field = ::arrow::<span class="built_in">field</span>(node.<span class="built_in">name</span>(), type, <span class="comment">/*nullable=*/</span><span class="literal">false</span>);</span><br><span class="line">      <span class="built_in">RETURN_NOT_OK</span>(<span class="built_in">PopulateLeaf</span>(column_index, child_field, current_levels, ctx, out,</span><br><span class="line">                                 &amp;out-&gt;children[<span class="number">0</span>]));</span><br><span class="line"></span><br><span class="line">      out-&gt;field = ::arrow::<span class="built_in">field</span>(node.<span class="built_in">name</span>(), ::arrow::<span class="built_in">list</span>(child_field),</span><br><span class="line">                                  <span class="comment">/*nullable=*/</span><span class="literal">false</span>, <span class="built_in">FieldIdMetadata</span>(node.<span class="built_in">field_id</span>()));</span><br><span class="line">      out-&gt;level_info = current_levels;</span><br><span class="line">      <span class="comment">// At this point current_levels has consider this list the ancestor so restore</span></span><br><span class="line">      <span class="comment">// the actual ancestor.</span></span><br><span class="line">      out-&gt;level_info.repeated_ancestor_def_level = repeated_ancestor_def_level;</span><br><span class="line">      <span class="keyword">return</span> Status::<span class="built_in">OK</span>();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      current_levels.<span class="built_in">Increment</span>(node);</span><br><span class="line">      <span class="comment">// A normal (required/optional) primitive node</span></span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">PopulateLeaf</span>(column_index,</span><br><span class="line">                          ::arrow::<span class="built_in">field</span>(node.<span class="built_in">name</span>(), type, node.<span class="built_in">is_optional</span>(),</span><br><span class="line">                                         <span class="built_in">FieldIdMetadata</span>(node.<span class="built_in">field_id</span>())),</span><br><span class="line">                          current_levels, ctx, parent, out);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä¼šèµ°åˆ° <code>ListToSchemaField</code>ï¼Œç„¶åæ ¹æ® <code>node</code> æ¥è§£æå¯¹åº”çš„é€»è¾‘ã€‚</p><h2 id="ç»“è¯­"><a href="#ç»“è¯­" class="headerlink" title="ç»“è¯­"></a>ç»“è¯­</h2><p>ä»Šå¤©è¿™æ®µå†™çš„æœ‰ç‚¹ä¹±ã€‚è¿™äº›å†…å®¹å¹¶ä¸åƒ btr é‚£ä¹ˆé€»è¾‘ä¸Šå¤æ‚ï¼Œä½†æ˜¯è¿˜æ˜¯å……æ»¡äº†å¤æ‚æ€§ï¼šä¸¤ä¸ªç³»ç»Ÿé—´çš„ Schema è½¬ä¹‰å±‚ä¹Ÿæ˜¯å¾ˆå¤æ‚çš„ã€‚</p><p>å½“æˆ‘ä»¬å®¡è§†è¿™å¥—çš„æ—¶å€™ï¼Œæˆ‘ä»¬ä¼šå‘ç°ï¼Œä¸ä»…æ˜¯ arrowï¼Œæ‰€æœ‰ç”¨ Parquet çš„ç³»ç»Ÿéƒ½ä¼šé‡åˆ°è¿™äº›é—®é¢˜ï¼Œè¿™äº›ä»£ç å®é™…ä¸Šæ˜¯ã€Œé€šç”¨ä»£ç ã€ã€‚å¹¶ä¸”è¿˜æœ‰å¾ˆå¤šå…¼å®¹æ€§é—®é¢˜ã€‚ä¹Ÿå¸Œæœ›è¿™ç¯‡æ–‡ç« èƒ½å¸®è¯»è€…è¯†ç ´ä¸€äº›æ‹¼å‡‘ç³»ç»Ÿçš„å¹å˜˜ã€‚</p><p>å†æ¬¡æ„Ÿå¹ç°å®ä¸–ç•Œå·¥ç¨‹çš„æ— é™å¤æ‚åº¦ã€‚</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>SIGMOD&#39;22: SingleStore</title>
      <link href="/2023/02/05/SIGMOD-22-SingleStore/"/>
      <url>/2023/02/05/SIGMOD-22-SingleStore/</url>
      
        <content type="html"><![CDATA[<p>SingleStore çš„å‰èº«æ˜¯å·®ä¸å¤šå’Œ Snowflake åŒä¸€æ—¶é—´å¼€å§‹åšçš„ MemSQLï¼Œæœ€æ—©ä»–ä»¬æ˜¯åšä¸€ä¸ªå¿«é€Ÿçš„å†…å­˜æ•°æ®åº“ï¼Œä½†æ˜¯äº‹å®è¯æ˜ï¼Œåšè¿™å¥—çš„ VoltDB å‘€ä»€ä¹ˆçš„éƒ½æ··å¾—ä¸å¤ªå¥½ï¼ˆSAP Hana å•†ä¸šåšçš„å¥½ï¼Œæ··å¾—è¿˜è¡Œï¼Œå…¶å®ƒè²Œä¼¼éƒ½æ²¡æ€ä¹ˆå·å‡ºæ¥ï¼Ÿï¼‰ã€‚ç„¶åä»–ä»¬è¿˜åšä¸“æœ‰éƒ¨ç½²/Shared-nothingï¼Œæ²¡æœ‰å’Œ snowflake ä¸€æ ·é€‰æ‹©åš Cloudï¼ˆshared-nothing å’Œ cloud ä¸ä¸€å®šæœ‰å†²çªï¼Œä¸è¿‡æ‡‚æˆ‘æ„æ€å°±è¡Œï¼‰ã€‚è¿™ä¸¤ä¸ªåˆèµ·æ¥ï¼Œå¾—äº†ï¼Œå•†ä¸šä¸Šå°±æ²¡é‚£ä¹ˆæˆåŠŸå‘—ã€‚ä¸è¿‡äº‹æƒ…æ²¡åšæˆï¼ŒæŠ€èƒ½æ˜¯ä¸ä¼šä¸¢çš„ï¼Œä¸€ç¾¤äººç§¯ç´¯çš„ç»éªŒä¹Ÿä¸å®¹æ˜“ä¸¢ï¼Œä½•å†µçº¿ä¸‹éƒ¨ç½²å‘€ debug å‘€ä»€ä¹ˆçš„å…¶å®æŒºè€ƒéªŒèƒ½åŠ›çš„ã€‚</p><p>SingleStore è‡ªç§°å–çš„æ˜¯ HTAPï¼Œä»–æ”¯æŒä¸¤ç§æ¨¡å¼ï¼šShared Nothing éƒ¨ç½²å’Œç»‘å®š BLOB Storage(ç±»ä¼¼ S3) éƒ¨ç½²ã€‚å°½ç®¡ AWS EBS æä¾›äº†æ¯”è¾ƒå¯é çš„å—å­˜å‚¨æœåŠ¡ï¼Œä½†æ˜¯æ„Ÿè§‰æ˜¯å› ä¸ºæˆæœ¬å’Œæ€§èƒ½çš„åŸå› ï¼Œä¹Ÿå› ä¸ºå®ƒä»¬æ¯”è¾ƒç†Ÿæ‚‰ Shared-Nothing è¿™å¥—ï¼Œï¼ˆä¸çŸ¥é“æ˜¯ä¸æ˜¯ä¹Ÿæœ‰åœ¨ä¸€å¥—ä»£ç ä¸Šåšå¼‚åœ°çš„åŸå› ï¼‰ï¼Œæ‰€ä»¥æ²¡ç”¨ EBSã€‚å®ƒæ‰¿è¯ºå¼€ S3 çš„æ—¶å€™ï¼Œæˆæœ¬ä¹Ÿä¸‹æ¥äº†ï¼Œæ’å…¥æ€§èƒ½ä¹Ÿå¥½äº†ã€‚å½“ç„¶æˆ‘å®é™…æ„Ÿè§‰å®ƒå¼€å¯ BLOB STORAGE ä½œä¸ºç¼“å­˜çš„æ—¶å€™ï¼Œæ’å…¥ä¾§èƒ½åŠ›æ²¡æœ‰é‚£ä¹ˆå¥½ï¼ŒP99 ç†è®ºä¸Šåº”è¯¥ä¼šå¾ˆå—é™äº S3 çš„æ€§èƒ½ã€‚ä¸è¿‡æ„Ÿè§‰å¯¹äºå¤§éƒ¨åˆ†ç”¨æˆ·æ¥è¯´ï¼Œæ’å…¥ P99 æ˜¯ä¸æ˜¯åªè¦èƒ½å‘ç°åŸå› å°±è¡Œï¼Œç‰¹æ®Šçš„ç”¨æˆ·å¯ä»¥é åŠ é’±æ¥è§£å†³ï¼Œè®©æ•°æ®å°½é‡åšä¸€ä¸ªå…¨ç¼“å­˜ã€‚æˆ‘ä»¬åœ¨åé¢ä¹Ÿä¼šåˆ†æè¿™ä¸€å¥—æ¶æ„å’Œ CockroachDB / TiDB ä¹‹ç±» TP æ¶æ„çš„åŒºåˆ«ã€‚</p><p>SingleStore è‡ªç§°å¯¹æ‰‹æ˜¯ã€Œå„ç§ domain-specificã€çš„æ•°æ®å­˜å‚¨ï¼Œå®ƒæ„Ÿè§‰æœ‰ç‚¹ç±»ä¼¼å›½å†…åœ¨èŠçš„ã€Œå¤šæ¨¡ã€è¿™ä¸ªè¯ï¼ˆäº§å“è§ Lindormï¼‰ï¼Œå®ƒå°è¯•çš„æ˜¯ one-fit allã€‚äº§å“è®¤ä¸ºï¼Œå¤šç§æ•°æ®åº“åœ¨å®ç°å±‚é¢è¦æŠŠä¸€å¥—ä¸œè¥¿åšå¾ˆå¤šéï¼ˆåŒ…æ‹¬ logging / ETL / å„ç§ç›¸ä¼¼çš„ä¼˜åŒ–ï¼‰ï¼Œè€Œç”¨æˆ·éœ€æ±‚ä¸å¤–ä¹æ˜¯é‚£å‡ ä¸ªï¼šsatisfying a breadth of requirements for transactional and analytical workloadsã€‚ä»ç»“è®ºæ¥çœ‹ï¼Œå®ƒä¹Ÿæœ‰ä¸€å®šå¯¹ flexible çš„æ•°æ®ç»“æ„çš„æ”¯æŒã€‚ä¸è¿‡å…·ä½“æ€ä¹ˆæ ·ä¹Ÿå¾—çœ‹å¸‚åœºçš„æ€åº¦ã€‚ç¬”è€…è®¤ä¸ºï¼Œè¿™äº›å†…å®¹æœ‰ç‚¹å¤§å…¬å¸å®ç°è€…è§†è§’ï¼Œåœ¨å¤§å…¬å¸é‡Œé¢ï¼Œå¤šä¸ªå›¢é˜Ÿæ”¶ç¼–ä¸ºåŒä¸€å¥—ç»„ä»¶èƒ½å¤Ÿæä¾›æ¯”è¾ƒå¥½çš„ç»„ç»‡æ¶æ„ä¼˜åŠ¿ï¼Œç„¶åçœ‹å„ä¸ªç»„ä»¶åˆ†å±‚ï¼Œå¾ˆå¤šæ•°æ®åº“å¯èƒ½åšä¸åˆ°ä¸“æœ‰çš„ç±»å‹ç»„ä»¶é‚£ä¹ˆä¼˜ç§€ï¼Œä½†æ˜¯å¾ˆå¤šä¼˜åŒ–ä¹Ÿæ˜¯é€šç”¨çš„ã€‚ä½†è¿™äº›ä¸œè¥¿å¯¹ç”¨æˆ·æ¥è¯´æˆ‘ä¸ªäººæ„Ÿè§‰æ²¡é‚£ä¹ˆå¤§æ„ä¹‰ï¼Ÿé™¤äº†ä¸€å¥—ç³»ç»Ÿ ETL ä¹‹ç±»çš„å¥½åšå¾ˆå¤šï¼Œå¥½åƒç”¨æˆ·è¿˜ä¸æ˜¯ä»€ä¹ˆæ–¹ä¾¿ç”¨ä»€ä¹ˆï¼Ÿéš¾é“ç”¨æˆ·ä¹°å®ƒåœ¨ä¸Šé¢å†™è‡ªå·±çš„ç³»ç»Ÿå—ï¼ˆå›§ï¼‰ã€‚æ€»ä¹‹ SingleStore Database Engine çš„å‰é¢å¯ä»¥æ˜¯å®ƒ manage çš„ Serviceï¼Œä¹Ÿå¯ä»¥æ˜¯ç”¨æˆ·è‡ªå·±æå‡ºæ¥çš„å®‰è£… binary ï¼ˆè¿˜è®°å¾—æœ€æ—© MemSQL æ˜¯çº¿ä¸‹éƒ¨ç½²å—ï¼‰ã€‚</p><p>ä¸Šé¢æ˜¯å¯¹ S2DB çš„ä¸€ä¸ªå¤§è‡´çš„ overviewï¼Œä¸‹é¢éƒ¨åˆ†ä¼šå¤§æ”¹è¿‡ä¸€ä¸‹è®ºæ–‡ä¸­ SingleStore çš„æ¶æ„ï¼Œå…ˆæå‰è¯´ä¸€å¥è¿™æ–‡ç« å†™çš„éå¸¸ç»†ï¼Œæ¶æ„ä»‹ç»è¿˜æ˜¯å¾ˆç»†è‡´çš„ã€‚</p><h3 id="å¤§è‡´æ€è·¯"><a href="#å¤§è‡´æ€è·¯" class="headerlink" title="å¤§è‡´æ€è·¯"></a>å¤§è‡´æ€è·¯</h3><ul><li>Shared-nothing æ¨¡å¼ä¸ç”¨æï¼Œè‚¯å®šæ˜¯ Cloud Blob Storage ç›¸å¯¹ EBS æˆæœ¬ä½ã€‚ä¸è¿‡ï¼ŒS3 å¯¹å¤–æš´éœ²æ•°æ®ä¸ä¸¢æ˜¯é è°±çš„ï¼Œä½†æ˜¯ä¸å¯ç”¨åªæœ‰å››ä¸ªä¹ï¼Œè¿™è¡¨ç¤ºéœ€è¦åšå¾ˆå¤šä¸œè¥¿æ¥ work around ( delta-io ä¼¼ä¹ä¼šå°è¯•ä¸€ç›´æäº¤ï¼Ÿï¼‰ã€‚æ‰€ä»¥å¼•å…¥äº† local-diskã€‚è¯´æ²¡ç”¨ ebs æ˜¯å› ä¸º ebs å»¶è¿Ÿ + æˆæœ¬ + ä¸ä¸€å®šç”¨çš„ä¸Šå®ƒçš„å¤åˆ¶ã€‚æ‰€ä»¥åœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒSingleStore è‡ªå·±åšäº†ä¸€å¥—å¤åˆ¶ï¼Œç„¶ååœ¨å•æœºä¸Šå¤„ç†è¿™äº›é—®é¢˜ã€‚ï¼ˆ<em>ä¸ç®¡åšçš„å¥½ä¸å¥½ï¼Œè¿™ä¸ªç†ç”±åº”è¯¥è¿˜æ˜¯è¯´å¾—è¿‡å»çš„</em>ï¼‰<ul><li>èŠ‚ç‚¹åˆ†ä¸ºä¸¤ç§ï¼šaggregator , leaf. Aggregator è´Ÿè´£æŸ¥è¯¢ï¼ŒMaster Aggregator è´Ÿè´£ fail-over ç›¸å…³çš„ä¸€äº›ä¿¡æ¯</li><li>ç”¨ Hash Partition æ¥åˆ†ç‰‡</li><li>ä¸ºäº†é™ä½å»¶è¿Ÿï¼Œåœ¨ local disk ä¸Šåšäº‹åŠ¡ï¼Œç„¶å async ç§»åŠ¨åˆ° BLOB Storage ç«¯ã€‚æäº¤æ˜¯é å¤šå‰¯æœ¬æ¥ä¿è¯æ­£ç¡®æ€§çš„<ul><li>BLOB ç«¯åŒ…å«æ•°æ®ï¼ˆæ˜¾è€Œæ˜“è§ï¼‰å’Œæ—¥å¿—ï¼ˆæ”¯æŒ PITRï¼‰</li><li>å¯ä»¥è®¾ç½®ç±»ä¼¼ TiFlash è¿™æ ·çš„ Learnerï¼Œç”¨æ¥æ”¯æŒä¸€äº› AP æŸ¥è¯¢</li></ul></li><li>SingleStore çš„æœ¬åœ°å¤åˆ¶ï¼ˆä¸åŒ…æ‹¬ Read-Replicaï¼‰åªä¼šç»´æŠ¤ HAï¼Œä¸ä¼šç»´æŠ¤è¯»æµé‡ã€‚è§ Figure 2ï¼ŒS2DB è®¤ä¸ºè¯»æµé‡èµ°ä¸»å°±è¡Œï¼Œå¤‡åªä¸ºäº† HAï¼Œå› ä¸ºè¿™éƒ¨åˆ†ä¸èƒ½å‡å°‘è´Ÿè½½ï¼ˆæ„Ÿè§‰ç›¸å¯¹äº TiDBï¼Œå¤§è‡´ idea æ²¡é—®é¢˜ï¼Œé‚£å¯¹äºçƒ­ç‚¹è¯·æ±‚ã€æ…¢èŠ‚ç‚¹æˆ–è€…çƒ­åˆ†åŒºå‘¢ï¼Ÿï¼‰</li><li>SingleStore å®ç°äº†å¼‚åœ°å¼‚æ­¥å¤åˆ¶ï¼Œè¿™ä¸ªä¹Ÿæœ‰ç‚¹ç±»ä¼¼ Read-Replicaï¼Œå¯ä»¥è¢«è¯»ã€‚è¿™é‡Œä¹Ÿå…è®¸ä»å¼‚åœ°å¤‡ä»½ä¸­ failoverï¼Œä½†å¿…é¡»è¦ DBA æ¥æ“ä½œ</li></ul></li><li>åœ¨å•æœºä¸Šï¼Œæä¾›äº† Unified table storage. è¿™é‡Œéœ€è¦æ”¯æŒå¿«é€Ÿçš„ Scanï¼Œæ’å…¥å’Œç‚¹æŸ¥ã€‚è¿™å—ç†è®ºä¸Šå¯èƒ½é HTAP ä¼šå†™ä¸€å †å¯¹åº”çš„å¼•æ“ï¼ŒSingleStore è¿™é‡Œå‡†å¤‡äº†å•ä¸€çš„ table storage åšæœ¬åœ°å­˜å‚¨æ”¯æŒã€‚å®ƒæä¾›çš„æ¦‚å¿µç±»ä¼¼ LSM-Treeï¼Œç›¸å¯¹äºä¼ ç»Ÿçš„ LSM-Treeï¼Œåº”è¯¥æ›´æ¥è¿‘ Mesa æˆ–è€… Snowflake é‚£ç§æ¦‚å¿µã€‚è¿™é‡Œæ¦‚å¿µå¦‚ä¸‹ï¼šsort keys, secondary keys, shard keys, unique keys å’Œ row-level lockingï¼ˆç›¸å¯¹ Kudu æ¥è¯´ï¼Œå®ƒè¿™äº›æ¦‚å¿µåº”è¯¥åšçš„ç»†å’Œå®½æ³›å¾ˆå¤šï¼Œ<strong>å¯¹å¤–</strong>å½¢æ€æœ‰ç‚¹ç‚¹ç±»ä¼¼ SQL Server çš„ Columnar æ”¯æŒï¼Ÿï¼‰<ul><li>In-memory row store: lockfree skip list, å†™å†™æ‚²è§‚é”ã€è¯»å†™ä¸å†²çªï¼ŒRow å›ºå®šå¤§å°ç»‘å®š bookeeping ä¿¡æ¯ï¼Œå˜é•¿å­—æ®µé¢å¤–å­˜å‚¨<ul><li>æœ‰ Partition çº§åˆ«çš„ Loggingï¼Œä¼šæœ‰ä¸€ä¸ªè¿›ç¨‹æ¥ checkpoint</li><li>ï¼ˆçœ‹ä¸‹æ¥æ„Ÿè§‰æ˜¯ in-memory tp systemï¼Œæœ‰ç‚¹ç±»ä¼¼ Hekatonï¼Ÿå“¦ç»“åˆä»–ä»¬ä¹‹å‰åš MemSQL çš„ï¼Œæ„Ÿè§‰ä¸€åˆ‡åˆç†äº†èµ·æ¥â€¦ï¼‰</li></ul></li><li>åˆ—å­˜è¡¨è¢«ç»„ç»‡ä¸º [è¡¨ - segments - data files] çš„ä¸‰çº§æ¦‚å¿µï¼Œä¸è¿‡æ„Ÿè§‰ segment æ˜¯ frozen çš„ï¼Œå…ƒä¿¡æ¯å­˜å‚¨åœ¨ä¸€ä¸ª RowStore ä¸­ï¼ŒåŒ…æ‹¬è¿™äº›æ–‡ä»¶çš„ä½ç½®ï¼Œencodingï¼ŒColumn min-max ç­‰ï¼Œ<strong>ä¹Ÿæœ‰ä¸€ä¸ª delete bit-vec</strong><ul><li>ä¸Šé¢çš„éƒ¨åˆ†æ˜¯æ‰€æœ‰ AP ç³»ç»Ÿå·®ä¸å¤ªå¤šçš„ï¼Œä½†æ˜¯è¿™é‡Œé’ˆå¯¹ç‚¹æŸ¥æ›´æ–°åšäº†ä¼˜åŒ–ï¼šå…è®¸ Seekï¼Œä¸éœ€è¦ decoding æ‰€æœ‰çš„ row ï¼ˆä¾‹å¦‚åˆ©ç”¨ LZ4 + RLEï¼Œè§ï¼š<a href="https://www.singlestore.com/blog/winter-2022-universal-storage-part-5/">https://www.singlestore.com/blog/winter-2022-universal-storage-part-5/</a> ï¼‰</li><li>Sort Key å¯ä»¥æ‰‹åŠ¨æŒ‡å®šé”®æ’åº</li><li>ç±»ä¼¼ snowflakeï¼Œè¿™é‡Œä¹Ÿä¼šæœ‰åå°çš„è¿›ç¨‹å»åš Compaction</li></ul></li><li>æ¯ä¸ª ColumnStore ä¸­ï¼Œéƒ½æœ‰ä¸€ä¸ªè¡Œå­˜çš„è¡¨ä½œä¸ºå‰å°å†™ï¼Œç„¶åæœ‰ä¸€ä¸ª background flusher é äº‹åŠ¡ç§»åŠ¨åˆ° ColumnStore ä¸­ï¼ˆè¿™å—æˆ‘æ„Ÿè§‰å’Œ SQL Server æ²¡æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Œç›´æ¥å»çœ‹é‚£ç¯‡å¥½äº†ï¼‰ã€‚</li></ul></li><li>æ‰§è¡Œå±‚ co-locate JOIN è¯·æ±‚ï¼Œåˆ†åŒºè£å‰ªï¼Œä¹Ÿæ”¯æŒ Codegen</li></ul><p><img src="https://image.mwish.me/blog-image/f1.png" alt="f1"></p><h3 id="å­˜ç®—åˆ†ç¦»çš„æ¶æ„"><a href="#å­˜ç®—åˆ†ç¦»çš„æ¶æ„" class="headerlink" title="å­˜ç®—åˆ†ç¦»çš„æ¶æ„"></a>å­˜ç®—åˆ†ç¦»çš„æ¶æ„</h3><p>S2DB å…è®¸æœ¬åœ°å¤šå‰¯æœ¬å†™æ¥æäº¤ï¼Œç„¶åå£°ç§°è¿™æ ·æ›´å¯æ§ï¼ˆç¡®å®ï¼‰ã€‚åœ¨ Log ç³»ç»Ÿæœ‰ä¸‹é¢ä¸€æ®µï¼Œæˆ‘å¤åˆ¶ä¸€ä¸‹åŸæ–‡ï¼Œå› ä¸ºä¸æ˜¯ç™¾åˆ†ç™¾ç¡®å®šæ„æ€ï¼š</p><blockquote><p>The in-cluster replication is fast and log pages can be replicated out-of-order and replicated early without waiting for transaction commit. Replicating out-of-order allows small transactions to commit without waiting for big transactions, guaranteeing that commits have low and predictable latency.</p></blockquote><p>æˆ‘ä¸ªäººçŒœæµ‹ï¼Œè¿™ä¸ªåº”è¯¥æ˜¯æœ‰ä¸ª mtr æˆ–è€…æ“ä½œçº§åˆ«çš„æ—¥å¿—ç»„ï¼Œç„¶åå¤åˆ¶çš„æ—¶å€™ä¸éœ€è¦ç­‰äº‹åŠ¡å®Œæˆï¼Œè€Œæ˜¯ç­‰å¾… Page æˆ–è€… Log Buffer æ”’æ»¡ï¼Œä¸çŸ¥é“æˆ‘ç†è§£å¯¹ä¸å¯¹ï¼Œæ„Ÿè§‰å¾ˆ trivial å˜›â€¦</p><p>è¿™é‡Œå†™å¤šä»½çš„æ—¶å€™ï¼Œä¸ºäº†ä½å»¶è¿Ÿå¼€äº†ä¸ªæŒ‚ï¼Œåªè¦3å‰¯æœ¬å†…å­˜å†™å®Œäº†å°±è¡Œã€‚è¿™é‡Œè®ºæ–‡è¯´äº†è¿˜æ˜¯æœ‰ä¸€å®šæ¦‚ç‡ä¼šä¸¢å†…å­˜æ•°æ®çš„ã€‚è¿™é‡Œå®ƒå†™äº†ä¸ªå¾ˆæœ‰æ„æ€çš„åŸå› ï¼š</p><blockquote><p>While SingleStore supports synchronously committing to local disk as well, this tradeoff often doesnâ€™t make sense in cloud environments where loss of a host often implies loss of the local storage attached to that host. For this reason, S2DB doesnâ€™t synchronously commit transactions to local disk by default.</p></blockquote><p>è€ƒè™‘åˆ°å®ƒä¸æŒ‚è½½ EBSï¼Œç¡®å®å¾ˆæœ‰æ„æ€â€¦</p><p><img src="https://image.mwish.me/blog-image/f2.png" alt="f2"></p><p>è§‚å¯Ÿä¸Šé¢å‡ å¼ å›¾ï¼Œè¿™é‡Œ (a) -&gt; (b) æ˜¯ä¸€ä¸ª flushï¼Œ(b) -&gt; (c) æ˜¯ä¸€ä¸ªåˆ é™¤ï¼Œæˆ‘ä»¬ç¨å¾®è¯¦ç»†ä¸€ç‚¹ä»‹ç»æµç¨‹ï¼š</p><ul><li>Flush: è¿™é‡Œé¦–å…ˆæœ‰ä¸€ç‚¹ Log is database çš„æ„Ÿè§‰ï¼Œå…ˆåˆ›å»º Create data file LSN çš„æ ‡è®°ï¼Œç„¶å name datafileï¼Œæ•°æ®æ–‡ä»¶ä¹Ÿå¯ä»¥ä» Log ä¸­æ¢å¤</li><li>Column ä¸­çš„åˆ é™¤ï¼šå¯ä»¥æ³¨æ„åˆ°ï¼Œè¿™é‡Œ<strong>åˆ é™¤æ ‡è®°åˆ°äº† Meta é‡Œé¢</strong>ã€‚å…¶å® Doris / StarRocks çš„ä¸»é”®æ¨¡å‹åˆ é™¤ä¹Ÿæ˜¯æ ‡è®°åˆ° Meta çš„ RocksDB å­˜å‚¨ä¸­çš„ï¼ŒDelta-IO å¯å†™ Log å¯å†™é¢å¤–æ–‡ä»¶ï¼Œiceberg spec å¾—å†™æ–‡ä»¶ã€‚è€Œåœ¨ SingleStore ä¸­ï¼Œ<strong>Meta è¢«å­˜å‚¨åœ¨ RowStore ä¸­</strong>ã€‚</li></ul><p>ä¸Šè¿°æ˜¯ä¸€ä¸ªå•æœºå†™å…¥çš„æµç¨‹ï¼Œè€ƒè™‘åˆ°å…±äº«å­˜å‚¨å±‚ï¼Œè¿™é‡Œéœ€è¦å†æ¬¡å‰è¿›ï¼š</p><p><img src="https://image.mwish.me/blog-image/f3.png" alt="f3"></p><ul><li>Committed Log ä¼šè¢«ä¸Šä¼ åˆ°è¿œç«¯ï¼Œåº”è¯¥æœ‰ä¸€ä¸ª Safe LSN çš„æœºåˆ¶ï¼ˆç±»ä¼¼ Auroraï¼‰ï¼Œèƒ½å¤ŸæŠŠæŸä¸ª LSn ä¹‹åçš„ä¸Šä¼ åˆ°è¿œç«¯ã€‚</li><li>æ–°çš„ ColumnStore æ•°æ®æ–‡ä»¶ä¼šè¢«å¼‚æ­¥å°½å¿«ä¸Šä¼ åˆ°è¿œç«¯ã€‚ç„¶å Cold Data å°±å¯ä»¥è¢«éš”ç¦»äº†ï¼ˆæˆ‘æœ‰ä¸€ç‚¹æ¯”è¾ƒå¥½å¥‡ï¼Œå°±æ˜¯è¿™ä¸ªæ–‡ä»¶æ˜¯ master å£°ç§°ç„¶ååŒæ­¥ç»™æ‰€æœ‰èŠ‚ç‚¹çš„ï¼Œè¿˜æ˜¯ replica æ¥åˆ°æ—¥å¿—ä¹Ÿå¯ä»¥å£°ç§°ï¼Ÿä¸è¿‡ä¸€ä¸‹æ²¡æ‰¾åˆ°ã€‚å°±æ˜¯ï¼ŒLSN æäº¤ä¹‹åï¼Œæ•°æ®æ–‡ä»¶æ²¡ä¸Šä¼ ï¼Œæ„Ÿè§‰ä¹Ÿè¦èƒ½æ¢å¤ï¼Ÿè¿™ä¸ªæ—¶å€™ä¹Ÿè¦ detact å‡ºæ–‡ä»¶åœ¨æœ¬åœ°è¿˜æ˜¯åœ¨è¿œç«¯å§ï¼Ÿæ„Ÿè§‰è¿™ä¸ªæ²¡æè¿°çš„å¾ˆæ¸…æ¥šï¼Ÿï¼‰</li><li>Master å¯ä»¥ä¸Šä¼  RowStore çš„ Snapshotã€‚</li><li>è¿™é‡Œè¿˜æœ‰ä¸ª workspace çš„æŠ½è±¡ï¼Œå…è®¸å¯¹ä¸€ä»½æ•°æ®æœ‰ä¸åŒçš„èµ„æºã€‚ä¸Šå›¾æœ‰ä¸€ä¸ª Read-only workspaceã€‚è¿™é‡Œä¼šä» Blob æ‹‰æ–‡ä»¶ / RowStore çš„ snapshotï¼Œ<strong>ç„¶åå…è®¸ä»è¿œç«¯æœºå™¨ tail log(æ„Ÿè§‰æ˜¯å› ä¸ºæäº¤æœ¬èº«å’Œå…±äº«å­˜å‚¨ä¸ç»‘å®šï¼Œæ‰€ä»¥è¦è¿™ä¹ˆæï¼‰</strong></li></ul><p>è®ºæ–‡çš„è¯„ä¼°ä¸­ï¼Œæ–‡ç«  novelty åœ¨äºä¸éœ€è¦åœ¨ Shared-Storage åšæäº¤ï¼Œé™ä½äº†ç³»ç»Ÿç¨³å®šæ€§ä¸­å¯¹å…±äº«å­˜å‚¨çš„ä¾èµ–ã€‚è¿™æœ¬æ¥æ˜¯å¥½çš„ï¼Œä¸è¿‡æ–‡ç« ä¹Ÿè¯´äº†ï¼Œè¿™ä¸ªæ„Ÿè§‰ç›¸å½“äºè¦è‡ªå·±å¤šç®¡ç†ä¸€å±‚çŠ¶æ€ï¼Œå°¤å…¶æ˜¯åœ¨ failoverã€membership change çš„æ—¶å€™ã€‚æ–‡ç« æäº†ä¸ªå¾ˆæœ‰æ„æ€çš„æ•°å­—ï¼ŒAurora Storage æˆæœ¬å¤§æ¦‚æ˜¯ S3 çš„å››å€ã€‚</p><blockquote><p>ç¬”è€…è®¤ä¸ºè¿™ç®—æ˜¯å·¥ç¨‹ä¸Šå¤§åŠ›å‡ºå¥‡è¿¹ã€‚S3 / EBS ä¸Šå­˜å‚¨èƒ½æŠ½è±¡æ‰å¾ˆå¤šéº»çƒ¦ã€‚æ¯”å¦‚å†™åœ¨ EBS ä¸Šï¼Œå¯èƒ½ä½ å°±å½“æˆæ•°æ®æœ¬èº«å¾ˆé è°±äº†ã€‚SingleStore è¿™æ ·éœ€è¦æ‰‹åŠ¨ç®¡ SSDï¼Œè€Œä¸”è¿˜æœ‰å¾ˆå¤šé—®é¢˜ã€‚ä¸è¿‡é‰´äºä»–ä»¬åš MemSQL å‡ºèº«ï¼Œå¯ä»¥èƒ½æ¯”è¾ƒç†Ÿæ‚‰è¿™ä¸€å¥—ã€‚å†æ¬¡æ„Ÿå¹ä¸€ä¸‹å·¥ç¨‹åŸºç¡€å¥½çš„å¥½å¤„ã€‚</p></blockquote><h4 id="æ¶æ„å¸¦æ¥çš„æ”¶ç›Š"><a href="#æ¶æ„å¸¦æ¥çš„æ”¶ç›Š" class="headerlink" title="æ¶æ„å¸¦æ¥çš„æ”¶ç›Š"></a>æ¶æ„å¸¦æ¥çš„æ”¶ç›Š</h4><ul><li>æœ¬åœ° SSD çš„æ€§èƒ½ï¼ˆæœ¬è´¨ä¸Šæ˜¯æŠŠå®¹é”™ã€ä¸‹å±‚ä¾èµ–çš„ä¸œè¥¿è¯•ç€ä¸€å®šç¨‹åº¦ä¸Šä»ä¸»è¯»å†™é“¾è·¯å¹²æ‰äº†ï¼Œè¿™å—æ€§èƒ½æˆ‘å…¶å®æ²¡æµ‹è¿‡ï¼Œæ‡‚çš„å¯ä»¥è®²è®²ï¼‰</li><li>BLOBå­˜å‚¨æ—¥å¿—å¸¦æ¥çš„åŠŸèƒ½ã€‚è¿™é‡Œå®ƒè§‰å¾—å³åƒåˆ°äº† SSD å†™çš„å¥½ï¼Œåˆèƒ½ç”¨å»‰ä»·å­˜å‚¨æ¥å­˜æ“ä½œæ—¥å¿—ã€‚å¯ä»¥ PITRã€Time Travel</li><li>åˆ›å»º Read Only èŠ‚ç‚¹</li></ul><p>è¿™äº›æ„Ÿè§‰å¤§å®¶éƒ½åšäº†ï¼Œä¸è¿‡ä»–ä»¬è¦æ˜¯èƒ½åšçš„å¾ˆå¥½ï¼Œé‚£ç¡®å®çœŸçš„å¾ˆå‰å®³å•Šâ€¦</p><h3 id="Unified-Table-Storage"><a href="#Unified-Table-Storage" class="headerlink" title="Unified Table Storage"></a>Unified Table Storage</h3><p>SingleStore çš„ç‰¹ç‚¹æ˜¯è¦æ”¯æ’‘ HTAP çš„è´Ÿè½½ã€‚å‹ç¼©å‘€ä»€ä¹ˆçš„å¤§å®¶éƒ½æ˜¯ä¸€ä¸ªåšæ³•ï¼Œä¹Ÿæ²¡å•¥æ–°ä¸œè¥¿ã€‚ä½†æ˜¯å®ƒåœ¨ Secondary Indexes è¿™é‡Œæè¿°åº”è¯¥æ˜¯æ¯”è¾ƒè¯¦ç»†çš„ï¼Œçœ‹å®Œå¤§è‡´å¯ä»¥æ‘¸æ¸…æ¥šè¿™æ–¹é¢çš„ä¸€äº›è¯¦ç»†è®¾è®¡ã€‚æ­¤å¤–å®ƒè¿˜æä¾›äº† Row-level Locking æ¥é¿å…å†²çªã€‚è¿™äº›ä¸œè¥¿æœ¬èº«å¹¶ä¸æ˜¯å¾ˆæ–°ï¼Œä½†æ˜¯å®ƒè¿™é‡Œå†™çš„è¿˜æ˜¯æ¯”è¾ƒå®Œå–„çš„ã€‚å†æ¬¡æ³¨æ„ï¼Œè¿™è¾¹è¯­ä¹‰è¿˜æ˜¯å¿«é€Ÿçš„ç‚¹æŸ¥/æ’å…¥/Scan.</p><p>ç®€å•æ¥è¯´ï¼Œåœ¨ ColumnStorage å±‚ï¼Œå®ƒåšçš„ä¼˜åŒ–æ˜¯ï¼š</p><ul><li>Delete + Insert ç»™ key æ ‡è®°åˆ é™¤å–ä»£ Merge-on-Readï¼ˆåœ¨æ–°å±‚å†™ Tombstoneï¼‰ï¼Œå› ä¸ºåœ¨æ–°å±‚å†™ tombstone å¯¹(blindçš„)å†™å…¥æœ¬èº«å‹å¥½ä¸€äº›ï¼Œä½†æ˜¯å¯¹ç‚¹æŸ¥å¾ˆä¸å¥½ã€‚æ‰€ä»¥æ„Ÿè§‰ä¸€èˆ¬æ”¯æŒ pk æ¨¡å‹ä¹‹ç±»çš„åˆ†ææ•°æ®äº§å“éƒ½æ˜¯ Delete + Insertã€‚</li><li>Delete è¢«æ ‡è®°åœ¨ Meta ä¸­ï¼ˆæ„Ÿè§‰å®ƒè¿™é‡Œè®¾è®¡æ˜¯ä¸ä¼šæœ‰å¤§æ‰¹ Deleteï¼Œæ¯”å¦‚æŸä¸ª Select æ¯éš”2è¡Œåˆ ä¸€ä¸ªæ•°æ®ï¼Œè¿˜æ˜¯è¿™ç§èƒ½è¢«ä»–ä»¬éå¸¸å¥½çš„å‹ç¼©ï¼Ÿä¸ç„¶è¿™é‡Œå†™å…¥ Meta ä¼šå¾ˆå¤§ã€‚Delta-io åœ¨è¿™æ–¹é¢æ ¼å¼è®¾è®¡ä¸Šåšäº†ä¸€äº› workaroundï¼‰</li></ul><h4 id="Secondary-Indexes"><a href="#Secondary-Indexes" class="headerlink" title="Secondary Indexes"></a>Secondary Indexes</h4><p>LSM ä¸Šåš Seconday Index ä¸€ç›´æ¯”è¾ƒ hackï¼Œåœ¨ <strong>LSM-based Storage Techniques: A Survey</strong> é‡Œé¢ä¹Ÿæœ‰æåˆ°ã€‚S2DB è¿™é‡Œçš„äº®ç‚¹æ˜¯æä¾›äº†ä¸€ä¸ªåˆ†å¸ƒå¼ä¸Šçš„ç´¢å¼•è§£å†³æ–¹æ¡ˆï¼š</p><ul><li>åœ¨ Segment å±‚å¼•å…¥ inverted indexï¼Œæä¾›[ç´¢å¼•åˆ— â€” row-offset-within-segment]çš„æ˜ å°„</li><li>åœ¨å…¨å±€å¼•å…¥ <Key Hash, Segment> çš„ Global Hash Indexï¼Œç´¢å¼•æŒ‡å‘è¿™ä¸ª key çš„ Location. æ²¡æœ‰æ”¯æŒ Ordered Index æ˜¯å› ä¸ºâ€¦è¿˜æ²¡å®ç°ã€‚ç‰©ç†ç»“æ„ä¸Š Global Hash Index ä¹Ÿæ˜¯ä¸ª LSMTreeã€‚<ul><li>å½“ Compaction å‘ç”Ÿçš„æ—¶å€™ï¼Œè¿™é‡Œå…è®¸ Lazy Deletionã€‚å³ç‰©ç†ä¸Šåˆ é™¤çš„æ–‡ä»¶è¿˜åœ¨ GHI ä¸­ï¼ˆä¼°è®¡è®¿é—®çš„æ—¶å€™è¿˜è¦å›æŸ¥ Metaï¼‰ï¼Œæ¥é€šè¿‡ä¸€éƒ¨åˆ†çš„è¯»å‡å°å†™æ”¾å¤§</li><li>å†™æ”¾å¤§æ˜¯ $O(log(N))$ çš„çº§åˆ«</li><li>åªå­˜å‚¨ Hash å’Œ Unique Valueã€‚Value å­˜å‚¨åœ¨å¯¹åº”çš„ Inverted index é‡Œï¼Œçœ‹å›¾ã€‚</li><li>ï¼ˆå…¶å®æˆ‘æœ‰ç‚¹å¥½å¥‡ï¼ŒGHI æ”¾å¤§è¿™ä¹ˆå¤§ï¼Œä»¥è‡³äºè¦è¿™ä¹ˆä¼˜åŒ–å—â€¦ï¼‰</li><li>è¿™ä¸ªæ¶æ„å¤§å¤§ä¼˜åŒ–äº† Point Read on Secondary Indexï¼Œå› ä¸ºåªéœ€è¦ O(log(Segment))  çš„ Complexityï¼Œå‡å°‘äº†å¯¹ Segment çš„è®¿é—®ï¼ˆæ¯”å¦‚æ¯ä¸ª Segment è®¿é—® Bloom Filterï¼‰ã€‚</li><li>å…è®¸å¹¶å‘è¯»å¤šä¸ªç´¢å¼•ç„¶å mergeï¼Œç±»ä¼¼ PostgreSQL è®¿é—®å¤šä¸ªç´¢å¼•é‚£å¥—ï¼Ÿ</li><li>è€ƒå¯Ÿè¿™ä¸ªç»“æ„ï¼Œè¿™é‡Œæ•°æ® Layout éƒ½æ˜¯åˆ°å…·ä½“ä½ç½®çš„æ˜ å°„ï¼Œè€Œä¸æ˜¯æŒ‡å‘æŸä¸ª keyã€‚è¿™ä¸ªéƒ¨åˆ†åˆ†åˆ«æœ‰ä¸åŒçš„å¥½å¤„åå¤„ï¼š<ul><li>å¥½å¤„ï¼šè¯»å¯¹åº”çš„ Secondary Index ä¸éœ€è¦å›è¡¨ï¼Œå‡å°‘ä¸€æ¬¡æŸ¥è¯¢</li><li>åå¤„ï¼šç‰©ç†ç»“æ„å˜æ›´å¸¦æ¥çš„åå°å†™æ”¾å¤§ï¼ˆmerge inverted indexï¼Œå¤„ç† deletedï¼‰å’Œå‰å°è¯»æ”¾å¤§</li></ul></li></ul></li></ul><p><img src="https://image.mwish.me/blog-image/f4.png" alt="f4"></p><p>ä¸‹é¢ä»‹ç»ä¸¤ä¸ªåœ¨è¿™å¥—ä¸Šé¢çš„æ‰©å±•ï¼š</p><ul><li>Multi-column secondary index</li><li>Uniqueness enforcement</li></ul><p>è¿™ä¸¤ä¸ªéƒ½ç”¨åŒä¸€å¥—æ¨¡å‹å®ç°ã€‚</p><p>ï¼ˆä¸è¿‡æ¯”è¾ƒå¥½å¥‡ RowStore è¿™å¥—æ€ä¹ˆåšçš„ï¼Œç¡¬ Scanï¼Ÿï¼‰</p><h4 id="Row-Level-Locking"><a href="#Row-Level-Locking" class="headerlink" title="Row-Level Locking"></a>Row-Level Locking</h4><p>ï¼ˆæ„Ÿè§‰è¿™å—ç±»ä¼¼ SQL Serverï¼‰</p><ul><li>éœ€è¦å‡è¡¡ Flusherï¼ŒMerge ä»»åŠ¡å’Œå‰å°å·¥ä½œ</li><li>åœ¨ RowStore ä¸Šå®ç°äº† row-level locking. è¿™é‡Œè€ƒè™‘åˆ°ä¸€ä¸ªäº‹å®ï¼šæäº¤ä¹‹å‰å†™éƒ½ä¼šåœ¨ RowStore ä¸­æ ‡è®°ï¼ˆMeta åˆ é™¤å‘¢ï¼Ÿç­”æ¡ˆæ˜¯ä¼šå…ˆè¿› RowStoreã€‚æ„Ÿè§‰è¿™å—æœ‰ç‚¹ç‚¹ç±»ä¼¼ Kudu.ï¼‰è¿™é‡Œåšçš„ç±»ä¼¼ ARIES/IMï¼šä¸¥æ ¼æŠŠ RowStore çš„ Primary Key å½“é”ã€‚</li><li>å…è®¸ Flush / Merge å’Œå‰å°æ“ä½œ Reorderï¼Œè¿™å—å®ƒè¯´çš„æ¯”è¾ƒè™šï¼Œæˆ‘æ„Ÿè§‰å…¶å®ä¹Ÿç±»ä¼¼ Kuduï¼Œå…ˆå‰å°æ“ä½œï¼Œç„¶ååå°æŠŠå‰å°æ“ä½œç§»åŠ¨åˆ°æ–°çš„ Segment ä¸Š</li></ul><h3 id="Adaptive-query-execution"><a href="#Adaptive-query-execution" class="headerlink" title="Adaptive query execution"></a>Adaptive query execution</h3><p>è¿™é‡Œæ”¯æŒåˆ†ç‰‡è¯·æ±‚ï¼Œåˆ†åŒºè£å‰ªï¼Œä¹Ÿæ”¯æŒ Codegen</p><p>è®¿é—® S2DB Unified Table Storage æœ‰ä¸‹é¢å‡ å±‚ï¼š</p><ul><li>æ‰¾åˆ°éœ€è¦è¯»çš„ Segments</li><li>ä¸‹æ¨ Filter</li><li>é€‰æ‹©æ€§ Decoding</li></ul><p>æ„Ÿè§‰æ‰€æœ‰ AP äº§å“éƒ½ä¸€ä¸ªæ ·ï¼Œå‘µå‘µäº†ã€‚</p><h4 id="Segment-Skipping"><a href="#Segment-Skipping" class="headerlink" title="Segment Skipping"></a>Segment Skipping</h4><ol><li>GHI å’Œ min-max éƒ½å¯ä»¥ä½¿ç”¨</li><li>O(log(N)) çš„æ—¶é—´ï¼ŒN -&gt; Segment</li><li>S2DB ä¼š adaptively çš„é€‰ç”¨ Secondary Indexï¼Œå¦‚æœ lookup å¤ªå¤šï¼Œä»–å°±ä¼šè½¬åŒ–æˆç¡¬ Scanã€‚</li><li>å¦‚æœå°è¡¨ Join å¤§è¡¨ï¼Œè€Œä¸”å¯ä»¥ç”¨åˆ° Secondary Indexï¼Œé‚£ä¹ˆ S2DB ä¼šç”¨ Join Index Filter æ¥åš Dynamic Filterã€‚</li></ol><h4 id="Filtering"><a href="#Filtering" class="headerlink" title="Filtering"></a>Filtering</h4><p>åœ¨æ‰§è¡Œå±‚ï¼ŒS2DB æœ‰ä¸‹åˆ—ä¸åŒçš„ Filterï¼Œå‡è®¾æœ‰ä¸€ä¸ª (col1 = val1) çš„ eq expr:</p><ul><li>Regular Filter: æ ¹æ®å‰ä¸€ä¸ªè¡¨è¾¾å¼çš„æ‰§è¡Œç»“æœï¼Œæ¥ (masked) decode col1ï¼Œæ‰§è¡Œè¡¨è¾¾å¼</li><li>Encoded Filter: ç›´æ¥åœ¨ compressed value ä¸Šæ‰§è¡Œã€‚<ul><li>å¯¹äº Dictionary è¿™æ ·çš„æ•°æ®æ¥è¯´ï¼Œå¦‚æœ ndv å¾ˆå°ï¼Œé‚£ä¹ˆæ•ˆæœéå¸¸å¥½ï¼Œåä¹‹ä¸æ€ä¹ˆå¥½</li></ul></li><li>Group Filter: å…ˆä¸€æŠŠ decode æ‰€æœ‰ filtered columnï¼Œç„¶åå…¨éƒ¨æ‰§è¡Œã€‚å¦‚æœ Selectivity å¾ˆé«˜çš„è¯ï¼ˆå³ filter è¿‡æ»¤æ€§èƒ½ä¸å¤ªå¥½ï¼‰ï¼Œè¿™æ ·æ€§èƒ½å¾ˆå¥½ã€‚åŒæ—¶ï¼Œåªæœ‰æŸå‡ ä¸ªä¸­é—´çš„ Filter è¿‡æ»¤å¥½çš„è¯ï¼Œä¹Ÿä¼šæ¯”è¾ƒå¥½</li><li>Secondary index Filter: èµ° Secondary index è¯»</li></ul><p>S2DB ä¼šå¯¹è¡¨è¾¾å¼æ‰§è¡Œåšé‡‡æ ·ï¼Œç„¶åæ ¹æ®é‡‡æ ·ç»“æœæ¥ Execã€‚æ­¤å¤–ï¼Œè¿™é‡Œè¿˜ä¼š Reorder Filtersï¼Œæ¥åŠ å¿«ç›¸å…³çš„æ‰§è¡Œã€‚</p><p>(è¿™å‡ å¥—é™¤äº† Secondary Index Filter, Velox æˆ–å¤šæˆ–å°‘éƒ½æœ‰ï¼Ÿ)</p><h3 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h3><h3 id="SingleStore"><a href="#SingleStore" class="headerlink" title="SingleStore"></a>SingleStore</h3><ul><li>[SIGMODâ€™22] Cloud-Native Transactions and Analytics in SingleStore</li><li>SingleStore Blog: <a href="https://www.singlestore.com/blog/winter-2022-universal-storage-part-5/">https://www.singlestore.com/blog/winter-2022-universal-storage-part-5/</a></li></ul><h3 id="CRDB"><a href="#CRDB" class="headerlink" title="CRDB"></a>CRDB</h3><ul><li><a href="http://link.zhihu.com/?target=https%3A//www.cockroachlabs.com/blog/how-we-built-cockroachdb-serverless/">How we built a forever-free serverless SQL database</a></li></ul><h3 id="TiDB"><a href="#TiDB" class="headerlink" title="TiDB"></a>TiDB</h3><ul><li>ä»€ä¹ˆï¼Ÿæ¯” MySQL æ€§ä»·æ¯”æ›´é«˜çš„ TiDB Cloud Serverless Tier æ¥äº†ï¼Ÿ<a href="https://zhuanlan.zhihu.com/p/596570801">https://zhuanlan.zhihu.com/p/596570801</a></li><li>åŸºäº Raft æ‰“é€ ç‰©ç†ä¸€è‡´æ€§äº‘åŸç”Ÿå­˜å‚¨å¼•æ“ <a href="https://www.bilibili.com/video/BV1B44y1o7H5/">https://www.bilibili.com/video/BV1B44y1o7H5/</a></li></ul><h3 id="å…¶å®ƒ"><a href="#å…¶å®ƒ" class="headerlink" title="å…¶å®ƒ"></a>å…¶å®ƒ</h3><ul><li>Andy Pavlo å…³äºå¤åˆ¶çš„ä¸€äº›è¯„è®ºï¼Œå¯ä»¥å¸®åŠ©ç†è§£è¿™ç¯‡æ–‡ç« ï¼š<a href="https://ottertune.com/blog/how-amazon-rds-replication-works-and-why-the-faas-database-problem-wont-happen-in-aws/">https://ottertune.com/blog/how-amazon-rds-replication-works-and-why-the-faas-database-problem-wont-happen-in-aws/</a></li></ul>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>mwish 2022 acgn summary</title>
      <link href="/2023/01/29/mwish-2022-acgn-summary/"/>
      <url>/2023/01/29/mwish-2022-acgn-summary/</url>
      
        <content type="html"><![CDATA[<h2 id="Anime"><a href="#Anime" class="headerlink" title="Anime"></a>Anime</h2><p>ä»Šå¹´çœ‹çš„åŠ¨ç”»æ¯”è¾ƒå°‘ã€‚å°±æä¸€ä¸‹å€¼å¾—ä¸€æçš„ä½œå“ã€‚</p><h3 id="Cyberpunk-Edgerunners"><a href="#Cyberpunk-Edgerunners" class="headerlink" title="Cyberpunk: Edgerunners"></a>Cyberpunk: Edgerunners</h3><p>ä½œä¸ºä¸€å Trigger é»‘â€¦æˆ‘æ‰¿è®¤æˆ‘å…¶å®å¯¹è¿™éƒ¨ä½œå“è¿˜ç®—æ»¡æ„ã€‚netflix å’Œ trigger æœ€è¿‘çš„æœ€ä½³ä½œå“ï¼Œé£æ ¼ä¸Š trigger çš„é£æ ¼å’Œ tears in the rain çš„ cyberpunk æ„Ÿç»“åˆçš„æ¯”è¾ƒå¥½ï¼Œè„šæœ¬ä¸Šè™½ç„¶æœ‰äº›åœ°æ–¹æ¯”è¾ƒç²—ç³™ï¼Œä½†æ˜¯å¤§æ¦‚é€»è¾‘è¿˜æ˜¯é€šé¡ºçš„ï¼Œtrigger å’ŒåŸä½œç¼–å‰§éƒ½äº’ç›¸åšäº†å…‹åˆ¶ï¼Œç»™å‡ºäº†ä¸€ä¸ªå¾ˆä¸é”™çš„å°å“ä½œå“ã€‚</p><p>äº”åå²šæµ·çš„æ¼”å‡ºï¼ˆåœ¨ dynazenon ep10 ä¹‹åï¼‰å†æ¬¡ç»™æˆ‘ç•™ä¸‹äº†æ¯”è¾ƒæ·±çš„å°è±¡ã€‚å¹´è½»äººå¤§æœ‰å¯ä¸ºã€‚</p><h3 id="ã‚¬ãƒ¼ãƒ«ã‚º-amp-ãƒ‘ãƒ³ãƒ„ã‚¡ãƒ¼-åŠ‡å ´ç‰ˆï¼ˆå°‘å¥³ä¸æˆ˜è½¦-å‰§åœºç‰ˆï¼‰"><a href="#ã‚¬ãƒ¼ãƒ«ã‚º-amp-ãƒ‘ãƒ³ãƒ„ã‚¡ãƒ¼-åŠ‡å ´ç‰ˆï¼ˆå°‘å¥³ä¸æˆ˜è½¦-å‰§åœºç‰ˆï¼‰" class="headerlink" title="ã‚¬ãƒ¼ãƒ«ã‚º&amp;ãƒ‘ãƒ³ãƒ„ã‚¡ãƒ¼ åŠ‡å ´ç‰ˆï¼ˆå°‘å¥³ä¸æˆ˜è½¦ å‰§åœºç‰ˆï¼‰"></a>ã‚¬ãƒ¼ãƒ«ã‚º&amp;ãƒ‘ãƒ³ãƒ„ã‚¡ãƒ¼ åŠ‡å ´ç‰ˆï¼ˆå°‘å¥³ä¸æˆ˜è½¦ å‰§åœºç‰ˆï¼‰</h3><p>æ‹–æ‹–æ²“æ²“çš„å‰§æƒ…ï¼Œå¤©é©¬è¡Œç©ºçš„æˆ˜æ–—ã€‚çœ‹ç¾å°‘å¥³åŠ¨ç‰©å›­å£èƒ¡é£™å¦å…‹è¿˜çœŸæŒºçˆ½ï¼Œæ°´å²›åŠªç¡®å®æ˜¯æ‡‚çš„ã€‚</p><h3 id="ãƒ‹ãƒ³ã‚¸ãƒ£ã‚¹ãƒ¬ã‚¤ãƒ¤ãƒ¼-ãƒ•ãƒ­ãƒ ã‚¢ãƒ‹ãƒ¡ã‚¤ã‚·ãƒ¨ãƒ³ï¼ˆå¿è€…æ€æ‰‹ï¼‰"><a href="#ãƒ‹ãƒ³ã‚¸ãƒ£ã‚¹ãƒ¬ã‚¤ãƒ¤ãƒ¼-ãƒ•ãƒ­ãƒ ã‚¢ãƒ‹ãƒ¡ã‚¤ã‚·ãƒ¨ãƒ³ï¼ˆå¿è€…æ€æ‰‹ï¼‰" class="headerlink" title="ãƒ‹ãƒ³ã‚¸ãƒ£ã‚¹ãƒ¬ã‚¤ãƒ¤ãƒ¼ ãƒ•ãƒ­ãƒ ã‚¢ãƒ‹ãƒ¡ã‚¤ã‚·ãƒ¨ãƒ³ï¼ˆå¿è€…æ€æ‰‹ï¼‰"></a>ãƒ‹ãƒ³ã‚¸ãƒ£ã‚¹ãƒ¬ã‚¤ãƒ¤ãƒ¼ ãƒ•ãƒ­ãƒ ã‚¢ãƒ‹ãƒ¡ã‚¤ã‚·ãƒ¨ãƒ³ï¼ˆå¿è€…æ€æ‰‹ï¼‰</h3><p>ç‹‚æ”¾çš„ cult ç‰‡ï¼Œä¸€ä¸ªè¯­è¨€å­¦å®ä¾‹ï¼Œå®é™…å¥½çœ‹ï¼æ•…äº‹æœ¬èº«å€’æ˜¯æ¯”è¾ƒå¹³å‡¡çš„æ­£é‚ªå¯¹æŠ—é‚£ä¸€å¥—ï¼Œä½†æ˜¯å¥ˆä½•é£æ ¼ä¸Šå®åœ¨å¤ªæœ‰è¶£å‘³äº†ï¼šå£èƒ¡é£æ ¼ã€é£æ ¼åŒ–è€Œå¥‡æ€ªçš„è¯­è¨€ï¼Œæ¼”å‡ºæ–¹é¢çš„å¥‡æ€ªæ–¹æ³•ã€‚yeaaaaaartï¼ç‹å®ˆä¹‰ï¼</p><h3 id="ã‚†ã‚‹ã‚­ãƒ£ãƒ³â–³"><a href="#ã‚†ã‚‹ã‚­ãƒ£ãƒ³â–³" class="headerlink" title="ã‚†ã‚‹ã‚­ãƒ£ãƒ³â–³"></a>ã‚†ã‚‹ã‚­ãƒ£ãƒ³â–³</h3><p>è¿™ä¸€å¹´å•ƒäº†æ‘‡æ›³éœ²è¥ S2 å’Œå‰§åœºç‰ˆâ€¦æ€ä¹ˆè¯´å‘¢ï¼Œå…¶å®æœ‰é‚£ä¹ˆç‚¹ç‚¹å¤±æœ›ï¼š</p><ul><li>1-4, 8 è¿™å‡ é›†è¿˜ä¸é”™ã€‚ç›¸å¯¹ç¬¬ä¸€å­£æ·¡æ·¡çš„äººé™…å…³ç³»ï¼Œè¿™ä¸€å­£æ˜æ˜¾çƒ­é—¹äº†å¾ˆå¤šã€‚</li><li>å‰§åœºç‰ˆï¼šå‰åŠæ®µäº”åˆ†ï¼ŒååŠæ®µæ¥è¿‘7åˆ†ã€‚ç‰‡å­å¤§æ„æ˜¯æ‰“å·¥äººçš„çˆ±å¥½ï¼Œä»¥ä¸€è…”çƒ­è¡€å¼€å§‹ï¼ŒæŒ«æŠ˜ä¸å›å½’ç”Ÿæ´»ä¸ºè½¬æŠ˜ï¼Œç»§ç»­æ¨è¿›ä¸ºå°¾ã€‚éœ²è¥ä½œä¸ºå¹¶ä¸ç®—æœ‰ä¸»çº¿çš„åŠ¨ç”»ï¼Œå…¶å®åœ¨å‰§åœºé‡Œçœ‹èŠ‚å¥æ˜¯ä¸å¤ªè¡Œçš„ï¼Œçœ‹å‰é¢æœ‰ç§å°ä»™å¥³å…¬æ¬¾å¼€partyçš„å¥‡å¦™è§‚æ„Ÿï¼Œå€’æ˜¯ååŠæ®µå›å½’ç”Ÿæ´»æœ‰äº†ç‚¹å‘³é“ï¼šåœ¨ç”Ÿæ´»çš„å¿™ç¢Œä¸­æ…¢æ…¢åšæŒçš„æ‰æ˜¯çˆ±å¥½å˜›ã€‚ç‰‡å­è¿˜æ˜¯æŒºèœçš„ï¼Œä¸»è¦è¿˜æ˜¯æ„Ÿè§‰éœ²è¥è¿™ä¸ªèŠ‚å¥åšå‰§åœºç‰ˆå®‰ä¸ªæ•…äº‹å°±ä¸åˆé€‚ã€‚</li></ul><p>è¯´æ¥æˆ‘ä¸ºä»€ä¹ˆæ²¡çœ‹å®Œå‘å±±è¿›å‘ï¼Œæˆ‘æœ‰ç½ªæˆ‘æœ‰ç½ªæˆ‘æœ‰ç½ªæˆ‘æœ‰ç½ªæˆ‘æœ‰ç½ª</p><h3 id="ç”Ÿå¾’ä¼šã®ä¸€å­˜"><a href="#ç”Ÿå¾’ä¼šã®ä¸€å­˜" class="headerlink" title="ç”Ÿå¾’ä¼šã®ä¸€å­˜"></a>ç”Ÿå¾’ä¼šã®ä¸€å­˜</h3><p>è‘µå…³å— + ç‹—å§ çš„ Neta ç‰‡ã€‚çœ‹çš„éå¸¸ä¹‹ä¹ã€‚JFRX è€å¸ˆæ¨èçš„æ—¶å€™è¯´ï¼Œå•å…ƒå‰§è®²ç›¸å£°æœ€ä¹å‘µï¼Œè¿›äº†ä¸»çº¿å°±ä¸€èˆ¬äº†â€”â€”æœçœŸå¦‚æ­¤ã€‚ç®—æ˜¯é  neta æ’‘èµ·æ¥çš„ä½œå“å§ï¼Œéå¸¸å€¼å¾—ä¸€çœ‹ã€‚</p><h3 id="BLEACH-åƒå¹´è¡€æˆ¦ç¯‡"><a href="#BLEACH-åƒå¹´è¡€æˆ¦ç¯‡" class="headerlink" title="BLEACH åƒå¹´è¡€æˆ¦ç¯‡"></a>BLEACH åƒå¹´è¡€æˆ¦ç¯‡</h3><p>æ”¾åœ¨è¿™é‡Œæ²¡ä»€ä¹ˆåˆ«çš„åŸå› ï¼Œåªæ˜¯çœŸçš„åªæœ‰æ„Ÿå¹â€¦æƒ³è¯´çš„æœ‰å¾ˆå¤šï¼ŒåŒ…æ‹¬å°ä¸‘ç¤¾ç»™çš„å¥½èµ„æºï¼Œè¿‡äº†å‡ å¹´å†çœ‹è¿™éƒ¨ä½œå“çš„å†·é™ï¼Œæ°‘å·¥æ¼«çš„å·¨å¤§å·å¬åŠ›ã€‚æœ€ååªèƒ½è½»å¹ä¸€å£°ï¼Œè¿˜æ˜¯æ°‘å·¥æ¼«æœ‰å·å¬åŠ›ã€‚</p><h3 id="86â€•ã‚¨ã‚¤ãƒ†ã‚£ã‚·ãƒƒã‚¯ã‚¹"><a href="#86â€•ã‚¨ã‚¤ãƒ†ã‚£ã‚·ãƒƒã‚¯ã‚¹" class="headerlink" title="86â€•ã‚¨ã‚¤ãƒ†ã‚£ã‚·ãƒƒã‚¯ã‚¹"></a>86â€•ã‚¨ã‚¤ãƒ†ã‚£ã‚·ãƒƒã‚¯ã‚¹</h3><p>å¯¹æˆ‘æ¥è¯´æœ€å¤§çš„æƒŠå–œï¼Œæ¯å‘¨ç­‰ç€çœ‹çš„ç‰‡ã€‚ä¸¥æ ¼æ¥è¯´åŸä½œå…¶å®å¾ˆå¤šåœ°æ–¹æŒºèœçš„ï¼Œå®‰é‡Œå°å§æ˜¾ç„¶æ˜¯é‚£ç§æƒ³å¥½ä¸€ä¸ªæµªæ¼«çš„åœºæ™¯ï¼ˆæ¯”å¦‚èŠ±æµ·ç›¸é‡æˆ–è€…åœ¨çºªå¿µç¢‘è§é¢ï¼‰ç„¶åå†å»å†™æ•…äº‹çš„ï¼Œæœ¬èº«å¥¹çš„è®¾å®šä¹‹ç±»çš„éƒ½å¾ˆç®€å•ç”šè‡³ç®€é™‹ã€‚ä½†è¿™ä»½æ°”è´¨å’Œ A1 çš„å¹´è½»æ¼”å‡ºå®¶ä»¬æ¸´æœ›è¡¨ç°çš„æ°”è´¨ç»“åˆåœ¨äº†ä¸€èµ·ï¼Œå°±æˆäº†ä¸€ç§æ·³æœ´è€Œæœ‰æœæ°”çš„ç¾ã€‚è¿™è®©å¾ˆå¤šç¼ºç‚¹çœ‹ä¸Šå»éƒ½å¾ˆå¯çˆ±ã€‚çœŸå¥½å•Šã€‚</p><h3 id="ãƒ¡ã‚¤ãƒ‰ã‚¤ãƒ³ã‚¢ãƒ“ã‚¹-çƒˆæ—¥ã®é»„é‡‘éƒ·ï¼ˆæ¥è‡ªæ·±æ¸Š-çƒˆæ—¥çš„é»„é‡‘ä¹¡ï¼‰"><a href="#ãƒ¡ã‚¤ãƒ‰ã‚¤ãƒ³ã‚¢ãƒ“ã‚¹-çƒˆæ—¥ã®é»„é‡‘éƒ·ï¼ˆæ¥è‡ªæ·±æ¸Š-çƒˆæ—¥çš„é»„é‡‘ä¹¡ï¼‰" class="headerlink" title="ãƒ¡ã‚¤ãƒ‰ã‚¤ãƒ³ã‚¢ãƒ“ã‚¹ çƒˆæ—¥ã®é»„é‡‘éƒ·ï¼ˆæ¥è‡ªæ·±æ¸Š çƒˆæ—¥çš„é»„é‡‘ä¹¡ï¼‰"></a>ãƒ¡ã‚¤ãƒ‰ã‚¤ãƒ³ã‚¢ãƒ“ã‚¹ çƒˆæ—¥ã®é»„é‡‘éƒ·ï¼ˆæ¥è‡ªæ·±æ¸Š çƒˆæ—¥çš„é»„é‡‘ä¹¡ï¼‰</h3><p>åˆ†æ•°æ˜¯è®¾ Ep.1ï¼ŒEp.7-Ep.10 ä¸ºé«˜åˆ†ï¼Œç„¶ååˆ«çš„é›†ä¸€åˆ†åˆ†å¾€ä¸‹æ‰£çš„ã€‚å±äºçº¯ç²‰ä¸å‘ä½œå“ã€‚å¯ä»¥çœ‹åˆ°æ•´ä¸ªæ•…äº‹è¿˜æ˜¯æ¯”è¾ƒç²¾å¦™çš„ï¼Œä½†æ˜¯è¢«æ‹–çš„å¤ªé•¿äº†ï¼Œç¨å¾®çŸ­ä¸€ç‚¹åè€Œä¼šå¥½ä¸ä¸å°‘ã€‚ç»“å°¾å‡ é›†è¯¥è¡€è…¥ã€è¯¥å†²å‡»çš„åœ°æ–¹çš„åœ°æ–¹åè€Œç»•è¿‡äº†ï¼Œè½ç‚¹æ”¾åœ¨äº†æ¯äº²-å¥³å„¿-é»„é‡‘è¿™å¯¹å…³ç³»ä¸Šï¼Œåªèƒ½è¯´æœ‰ç‚¹é—æ†¾å§ã€‚åçŸ¥åè§‰çš„æ˜¯ï¼Œæœ€å·§å¦™çš„è®¾å®šæ˜¯æ„¿æœ›è›‹çš„è®¾å®šï¼Œæ— æ¯”å·§å¦™çš„æ‰­æ›²ã€‚</p><h3 id="ã‹ãã‚„æ§˜ã¯å‘Šã‚‰ã›ãŸã„-ã‚¦ãƒ«ãƒˆãƒ©ãƒ­ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯-ï¼ˆè¾‰å¤œå¤§å°å§æƒ³è®©æˆ‘å‘Šç™½-è¶…çº§æµªæ¼«-ï¼‰"><a href="#ã‹ãã‚„æ§˜ã¯å‘Šã‚‰ã›ãŸã„-ã‚¦ãƒ«ãƒˆãƒ©ãƒ­ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯-ï¼ˆè¾‰å¤œå¤§å°å§æƒ³è®©æˆ‘å‘Šç™½-è¶…çº§æµªæ¼«-ï¼‰" class="headerlink" title="ã‹ãã‚„æ§˜ã¯å‘Šã‚‰ã›ãŸã„-ã‚¦ãƒ«ãƒˆãƒ©ãƒ­ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯-ï¼ˆè¾‰å¤œå¤§å°å§æƒ³è®©æˆ‘å‘Šç™½-è¶…çº§æµªæ¼«-ï¼‰"></a>ã‹ãã‚„æ§˜ã¯å‘Šã‚‰ã›ãŸã„-ã‚¦ãƒ«ãƒˆãƒ©ãƒ­ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯-ï¼ˆè¾‰å¤œå¤§å°å§æƒ³è®©æˆ‘å‘Šç™½-è¶…çº§æµªæ¼«-ï¼‰</h3><p>é¡¶å°–çš„æ‹çˆ±å–œå‰§æ—¥å¸¸æ¼”å‡ºï¼Œæ—¥å¸¸å›çš„å„ç§è¡¨ç°è®©äººå°è±¡æ·±åˆ»ï¼Œæˆ‘çœŸè¯šå»ºè®®å¯ä»¥æŠŠè¿™é‡Œå‡ é›†ä¹å­æ¼”å‡ºå›æ‹‰å»çœ‹çœ‹ã€‚ä½†æ˜¯å¯èƒ½å‡ºäºåŸä½œçš„ç“¶é¢ˆï¼Œæ„Ÿæƒ…çš„çˆ†å‘éå¸¸çš„æ— åŠ›ã€‚</p><p>è¯´çœŸçš„ï¼Œå›å¤´å›é¡¾ä¸€ä¸‹ï¼Œå‡ ä¸ªåœ°æ–¹æ¼”å‡ºçœŸçš„å¾ˆä¸é”™ï¼Œä¹Ÿæœ‰ä¹å­ã€‚ä½†æ˜¯æ„Ÿè§‰ä»å¤´åˆ°å°¾äººç‰©å¡‘é€ è¿˜æ˜¯å‡ ä¹ä¸€æ ·çš„å•è–„ã€‚å¯¼è‡´ä¸­é—´æˆ‘å¾ˆå¼€å¿ƒï¼Œè§£å†³çš„æ—¶å€™æˆ‘ä¸€è„¸æ‡µé€¼ï¼šä½ ä»¬åœ¨æå•¥ï¼Ÿ</p><h3 id="ã‚¤ãƒã‚»ãƒ³ã‚¹ï¼ˆæ”»å£³æœºåŠ¨é˜Ÿ2-æ— ç½ªï¼‰"><a href="#ã‚¤ãƒã‚»ãƒ³ã‚¹ï¼ˆæ”»å£³æœºåŠ¨é˜Ÿ2-æ— ç½ªï¼‰" class="headerlink" title="ã‚¤ãƒã‚»ãƒ³ã‚¹ï¼ˆæ”»å£³æœºåŠ¨é˜Ÿ2 æ— ç½ªï¼‰"></a>ã‚¤ãƒã‚»ãƒ³ã‚¹ï¼ˆæ”»å£³æœºåŠ¨é˜Ÿ2 æ— ç½ªï¼‰</h3><p>æŠ¼äº•å®ˆçš„ç››å¤§æ¼”å‡ºï¼Œç»æ— ä»…æœ‰çš„è±ªåé˜µå®¹ã€‚ä¸œæ–¹å“²å­¦ã€æ‰ä¹¦è¢‹ã€æ¶è¶£å‘³èåˆåœ¨ä¸€éƒ¨ä½œå“ä¸­ã€‚æ•´ä¸ªæ•…äº‹çš„é€»è¾‘è¿˜æ˜¯å¾ˆæ¸…æ™°çš„ï¼Œä½†æ˜¯ä½œå“å‡ ä¹æ²¡æœ‰è®©ä½ å¾ˆå…³æ³¨è¿™ä¸ªä¸»çº¿ï¼Œè€Œæ˜¯å…³æ³¨å½±åƒã€ç¬¦å·å’Œç»†èŠ‚ï¼šäººå¶ã€è®°å¿†ã€åŠ¨ç‰©ã€ghostã€‚</p><p>æœ‰ä¸ªå¤–æŒ‚æ˜¯ ã€Šæ— ç½ª METHODS æŠ¼äº•å®ˆæ¼”å‡ºç¬”è®°ã€‹ï¼Œå¼€ä¸ªæŒ‚å›æ¥çœ‹ä½“éªŒä¼šå¥½ä¸å°‘ã€‚</p><h3 id="ã‚¤ãƒªãƒ¤ã®ç©ºã€UFOã®å¤ï¼ˆä¼Šé‡Œé‡çš„å¤©ç©ºã€UFOçš„å¤å¤©ï¼‰"><a href="#ã‚¤ãƒªãƒ¤ã®ç©ºã€UFOã®å¤ï¼ˆä¼Šé‡Œé‡çš„å¤©ç©ºã€UFOçš„å¤å¤©ï¼‰" class="headerlink" title="ã‚¤ãƒªãƒ¤ã®ç©ºã€UFOã®å¤ï¼ˆä¼Šé‡Œé‡çš„å¤©ç©ºã€UFOçš„å¤å¤©ï¼‰"></a>ã‚¤ãƒªãƒ¤ã®ç©ºã€UFOã®å¤ï¼ˆä¼Šé‡Œé‡çš„å¤©ç©ºã€UFOçš„å¤å¤©ï¼‰</h3><p>å¹´åº¦æœ€å–œæ¬¢ã€æœ€æƒŠå–œçš„å‡ éƒ¨ä½œå“ä¹‹ä¸€ã€‚ä¸–ç•Œç³»çš„ä»£è¡¨ä½œä¹‹ä¸€ï¼Œä»å¤å¤©çš„ç»“æŸåˆ°å¤å¤©çœŸæ­£ç»“æŸçš„æ¼«é•¿æ—…è¡Œã€‚Ep.3 å’Œ Ep.4 æ˜¯éå¸¸å€¼å¾—ä¸€çœ‹çš„æ¼”å‡ºå›ï¼šå¼‚è´¨çš„æ—¶é—´æ„Ÿã€å…‰å½±ã€å†™å®ã€‚</p><h3 id="ãƒ•ã‚¿ã‚³ã‚¤-ã‚ªãƒ«ã‚¿ãƒŠãƒ†ã‚£ãƒ–ï¼ˆåŒæ‹-Alternativeï¼‰"><a href="#ãƒ•ã‚¿ã‚³ã‚¤-ã‚ªãƒ«ã‚¿ãƒŠãƒ†ã‚£ãƒ–ï¼ˆåŒæ‹-Alternativeï¼‰" class="headerlink" title="ãƒ•ã‚¿ã‚³ã‚¤ ã‚ªãƒ«ã‚¿ãƒŠãƒ†ã‚£ãƒ–ï¼ˆåŒæ‹ Alternativeï¼‰"></a>ãƒ•ã‚¿ã‚³ã‚¤ ã‚ªãƒ«ã‚¿ãƒŠãƒ†ã‚£ãƒ–ï¼ˆåŒæ‹ Alternativeï¼‰</h3><p>é’æ¶©ç‹‚æ”¾çš„ ufo. ç¬¬ä¸€é›†æ°›å›´å’Œæ¼”å‡ºç±»ä¼¼ FLCLï¼Œè€Œåç»­åˆæœ‰æ‚ é•¿æ·±æ²‰çš„æµªæ¼«ï¼Œæƒ³å¿…æ‰¾ UFO çš„åœºæ™¯ä¼šåœ¨æˆ‘çš„è„‘æµ·é©»ç•™å¾ˆä¹…ã€‚</p><h3 id="ã“ã®ä¸–ç•Œã®ï¼ˆã•ã‚‰ã«ã„ãã¤ã‚‚ã®ï¼‰ç‰‡éš…ã«-ï¼ˆåœ¨è¿™ä¸–ç•Œ-æ›´å¤šä¸€äº›-çš„è§’è½ï¼‰"><a href="#ã“ã®ä¸–ç•Œã®ï¼ˆã•ã‚‰ã«ã„ãã¤ã‚‚ã®ï¼‰ç‰‡éš…ã«-ï¼ˆåœ¨è¿™ä¸–ç•Œ-æ›´å¤šä¸€äº›-çš„è§’è½ï¼‰" class="headerlink" title="ã“ã®ä¸–ç•Œã®ï¼ˆã•ã‚‰ã«ã„ãã¤ã‚‚ã®ï¼‰ç‰‡éš…ã« ï¼ˆåœ¨è¿™ä¸–ç•Œ(æ›´å¤šä¸€äº›)çš„è§’è½ï¼‰"></a>ã“ã®ä¸–ç•Œã®ï¼ˆã•ã‚‰ã«ã„ãã¤ã‚‚ã®ï¼‰ç‰‡éš…ã« ï¼ˆåœ¨è¿™ä¸–ç•Œ(æ›´å¤šä¸€äº›)çš„è§’è½ï¼‰</h3><p>çŸ¥ååæˆ˜è´¥å¤§æ¯’è‰ï¼ˆè¯¯ï¼‰ã€‚åœ¨å¹´åº•å›é¡¾æ¥çœ‹æ„Ÿè§‰æ´å¯ŸåŠ›çœŸå¼ºã€‚ä»¥æ— çŸ¥äº«å—å¹¸ç¦ï¼Œä»¥æ¸©å’Œè”ç³»å½¼æ­¤ï¼Œä»¥å¯Ÿè§‰æ¥å‘ç°ç—›è‹¦ï¼Œä»¥ç”Ÿå‘½åŠ›å’Œæ–°çš„ç”Ÿå‘½æ¥é¢å¯¹æ­»äº¡ã€‚èƒ½å¤Ÿæ„Ÿå—åˆ°ç”Ÿå‘½æåº¦é¡½å¼ºçš„ç”Ÿå‘½åŠ›ã€‚</p><p>å…¶å®å…³äºè¿™éƒ¨ä½œå“çš„åæˆ˜è´¥ï¼Œæˆ‘è®¤ä¸ºå®ƒå¤šå°‘è®²è¿°çš„æ˜¯ã€Œåœ¨è°è¨€ä¸­ç”Ÿå­˜çš„äººã€è¿™æ ·ä¸€ä¸ªæ•…äº‹ã€‚ã€Œæˆ‘ä»¬å±‹å­é‡Œè¿˜æœ‰äº”ä¸ªäººï¼Œæˆ‘è¿˜æœ‰ä¸€åªæ‰‹ã€åˆ°å‘ç°è¿™ä¸€åˆ‡éƒ½æ˜¯æ å¤ºæ¥çš„è°è¨€ï¼Œæœ‰ä»€ä¹ˆèƒ½æ¯”è¿™ä¸ªæ›´è®½åˆºå‘¢ï¼Ÿ</p><h3 id="ãƒ–ãƒ©ãƒƒã‚¯ãƒ»ã‚¸ãƒ£ãƒƒã‚¯-OVAï¼ˆæ€ªåŒ»é»‘æ°å…‹-OVAï¼‰"><a href="#ãƒ–ãƒ©ãƒƒã‚¯ãƒ»ã‚¸ãƒ£ãƒƒã‚¯-OVAï¼ˆæ€ªåŒ»é»‘æ°å…‹-OVAï¼‰" class="headerlink" title="ãƒ–ãƒ©ãƒƒã‚¯ãƒ»ã‚¸ãƒ£ãƒƒã‚¯ OVAï¼ˆæ€ªåŒ»é»‘æ°å…‹ OVAï¼‰"></a>ãƒ–ãƒ©ãƒƒã‚¯ãƒ»ã‚¸ãƒ£ãƒƒã‚¯ OVAï¼ˆæ€ªåŒ»é»‘æ°å…‹ OVAï¼‰</h3><p>ä¹…é—»å‡ºï¨‘çµ±ç›‘ç£å¤§åï¼Œçœ‹äº”ç‚¹è€å¸ˆå†™çš„å¸–å­é‡Œè¿™éƒ¨ ova æ˜¯æ¯”è¾ƒå¥½çš„å…¥é—¨ä½œå“ã€‚çœ‹çš„æ—¶å€™æ„Ÿè§‰ä¸€è¨€ä»¥è”½ä¹‹ï¼Œå°±æ˜¯ã€ŒåŠ›é‡ã€ï¼šæƒ…èŠ‚çš„å†²çªã€å½±ç›¸çš„å…‰å½±ä½“ç°ã€ç”Ÿå‘½æ„å¿—ã€‚è¡¨ç°å‡ºæ¥æ— æ¯”çš„ä¼ŸåŠ›ã€‚</p><h2 id="Novel"><a href="#Novel" class="headerlink" title="Novel"></a>Novel</h2><h3 id="Flowers-for-Algernonï¼ˆçŒ®ç»™é˜¿å°”å‰ä¾¬çš„èŠ±æŸï¼‰"><a href="#Flowers-for-Algernonï¼ˆçŒ®ç»™é˜¿å°”å‰ä¾¬çš„èŠ±æŸï¼‰" class="headerlink" title="Flowers for Algernonï¼ˆçŒ®ç»™é˜¿å°”å‰ä¾¬çš„èŠ±æŸï¼‰"></a>Flowers for Algernonï¼ˆçŒ®ç»™é˜¿å°”å‰ä¾¬çš„èŠ±æŸï¼‰</h3><p>å…¶å®æˆ‘è§‰å¾—â€¦æŒºèœçš„ã€‚å¥½çš„ä¸€ç‚¹åœ¨äºï¼Œä½œå“è¯ç”Ÿçš„æ—¶ä»£ç‚¹å­è¿˜çœŸçš„ä¸é”™ã€‚åçš„ä¸€ç‚¹åœ¨äºï¼Œè¾ƒç¯‡å¹…è€Œè¨€èŠ‚å¥å†—ä½™çš„å¤ªå¤šäº†ã€‚è‡ªæˆ‘/è®°å¿†/å…³ç³»/çˆ±éƒ½æ˜¯å¾ˆé‡è¦çš„éƒ¨åˆ†ï¼Œä½†æ˜¯æ„Ÿè§‰è¿™äº›å…¶å®åœ¨ä¸­æ®µé‡å¤çš„è¿‡å¤šäº†ã€‚</p><h3 id="ãªã‚ã‚‰ã‹ãªä¸–ç•Œã¨ã€ãã®æ•µï¼ˆå¹³æ»‘ä¸–ç•Œå’Œå®ƒçš„æ•Œäººï¼‰"><a href="#ãªã‚ã‚‰ã‹ãªä¸–ç•Œã¨ã€ãã®æ•µï¼ˆå¹³æ»‘ä¸–ç•Œå’Œå®ƒçš„æ•Œäººï¼‰" class="headerlink" title="ãªã‚ã‚‰ã‹ãªä¸–ç•Œã¨ã€ãã®æ•µï¼ˆå¹³æ»‘ä¸–ç•Œå’Œå®ƒçš„æ•Œäººï¼‰"></a><strong>ãªã‚ã‚‰ã‹ãªä¸–ç•Œã¨ã€ãã®æ•µï¼ˆå¹³æ»‘ä¸–ç•Œå’Œå®ƒçš„æ•Œäººï¼‰</strong></h3><p> éå¸¸æ—¥æœ¬SFçš„ä½œå“ï¼šSFå…ƒç´ ä¸­ï¼Œå¯¹å¾€æ˜”ä½œå“çš„è‡´æ•¬å åˆ°å¤šæ•°ï¼Œä½†æ²¡æœ‰å½¢æˆä¸€ç§äº’æ–‡å¼çš„å…¨æ–°ä½“éªŒæˆ–è€…å®Œå…¨è´´åˆæ•…äº‹çš„è®¾å®šï¼›åå€’æ˜¯å¿ƒæ€€é¬¼èƒçš„äººç‰©ç®€å•çš„è¿½æ±‚æ¯”è¾ƒæœ‰æ„æ€ã€‚å‡ ä¸ªæ•…äº‹åŸºæœ¬éƒ½6åˆ†å§ï¼Œä¸è¿‡è¶Šåé¢è¶Šæœ‰æ„æ€ã€‚</p><p>BTWï¼Œæˆ‘æ˜¯çœŸä¸çŸ¥é“æ—¥æœ¬äººä¸ºå•¥è¿™ä¹ˆå–œæ¬¢ä¼´åç»ƒâ€¦</p><h3 id="ãŠéš£ã®å¤©ä½¿æ§˜ã«ã„ã¤ã®é–“ã«ã‹é§„ç›®äººé–“ã«ã•ã‚Œã¦ã„ãŸä»¶"><a href="#ãŠéš£ã®å¤©ä½¿æ§˜ã«ã„ã¤ã®é–“ã«ã‹é§„ç›®äººé–“ã«ã•ã‚Œã¦ã„ãŸä»¶" class="headerlink" title="ãŠéš£ã®å¤©ä½¿æ§˜ã«ã„ã¤ã®é–“ã«ã‹é§„ç›®äººé–“ã«ã•ã‚Œã¦ã„ãŸä»¶"></a><strong>ãŠéš£ã®å¤©ä½¿æ§˜ã«ã„ã¤ã®é–“ã«ã‹é§„ç›®äººé–“ã«ã•ã‚Œã¦ã„ãŸä»¶</strong></h3><p>å¾ˆèœï¼Œä½†å¾ˆæœ‰æ•™è‚²æ„ä¹‰ï¼Œçœ‹å®Œç¬¬ä¸€å·æˆ‘ç«‹é©¬å¼€å§‹äº†3å¤©æ‰“æ‰«ä¸€æ¬¡å«ç”Ÿçš„ç”Ÿæ´»ã€‚æœ¬ä¹¦åœ¨åŠŸèƒ½æ€§ä¸Šå¯ä»¥è¯´å¯¹æˆ‘ç¬¬ä¸€äº†ï¼ˆè¯¯ï¼‰ã€‚</p><h3 id="é»„æ˜è‰²ã®è© ä½¿ã„ï¼ˆé»„æ˜è‰²çš„å’ä½¿ï¼‰"><a href="#é»„æ˜è‰²ã®è© ä½¿ã„ï¼ˆé»„æ˜è‰²çš„å’ä½¿ï¼‰" class="headerlink" title="é»„æ˜è‰²ã®è© ä½¿ã„ï¼ˆé»„æ˜è‰²çš„å’ä½¿ï¼‰"></a>é»„æ˜è‰²ã®è© ä½¿ã„ï¼ˆé»„æ˜è‰²çš„å’ä½¿ï¼‰</h3><p>æ»¡è¶³äº†æˆ‘å¯¹è½»å°è¯´çš„æƒ³è±¡ï¼Œè‰²å½©ä¸æ­Œå’çš„ç¾å¥½è®¾å®šï¼ŒåŠ ä¸Šåˆ»æ¿äººç‰©å’Œç®€çŸ­çš„æ„æ—å°æ•…äº‹ã€‚æ²¡å•¥å…´è¶£çš„ä¹Ÿå¯ä»¥å…ˆæŠŠç¬¬ä¸€å·çœ‹äº†ã€‚è®¾å®šã€æ–‡å­—ã€æ’ç”»å’Œè½»å°è¯´è¿™ç§é¢˜æå¥‘åˆåº¦é«˜ï¼Œæ•…äº‹æœ¬èº«å¾ˆç®€é™‹ï¼Œä½†æ˜¯è¶³å¤Ÿäº†ã€‚</p><h3 id="æˆ¦ã†å¸æ›¸ï¼ˆæˆ˜æ–—å¸ä¹¦ï¼‰"><a href="#æˆ¦ã†å¸æ›¸ï¼ˆæˆ˜æ–—å¸ä¹¦ï¼‰" class="headerlink" title="æˆ¦ã†å¸æ›¸ï¼ˆæˆ˜æ–—å¸ä¹¦ï¼‰"></a>æˆ¦ã†å¸æ›¸ï¼ˆæˆ˜æ–—å¸ä¹¦ï¼‰</h3><p>åˆåœŸåˆå¥½åˆåœŸåˆå¥½ã€‚æ•…äº‹ç®—æ˜¯ä¸€å·ä¸€ç¯‡ã€‚æ•…äº‹çš„èŠ‚å¥æŒ‰ç…§1/2-6/7-8/9-10 é”™å¼€ï¼Œå¯ä»¥å½“ä½œæ˜¯å·ä¸ºåˆ‡åˆ†çš„ä¸­ç¯‡é›†ã€‚é™¤å¼€ç¬¬ä¸€å·çš„å¥‡å¹»æ„Ÿï¼Œå…¶ä½™å·ä¸€èˆ¬æŒ‰ç…§è§£å¯† + æˆ˜æ–—çš„å½¢å¼å±•å¼€ã€‚æ¶æ„å’Œæ•…äº‹å¹¶ä¸æ–°é¢–ï¼Œä½†äººç‰©æå†™éå¸¸å‡ºè‰²å¹¶åˆä¹é€»è¾‘ï¼Œä»¥ 1/5/6 ä¸‰å·ä¸ºä»£è¡¨ã€‚æ”¶å°¾ç¯‡è™½ç„¶æ„Ÿè§‰æ¶æ„å’Œä¹‹å‰å¯¹ä¸ä¸Šï¼Œæ•…äº‹æ¶æ„ä¹Ÿå¾ˆè€å¥—ï¼Œä½†æ˜¯äººç‰©å’Œå¯¹è¯æå†™çš„ç›¸å½“æœ‰ä¿¡æœåŠ›ã€‚çº¯è®ºåˆ†æ•°çš„è¯ï¼Œè¿™ä¸ªæ”¶å°¾æ˜¯ä¸å€¼è¿™ä¸ªåˆ†çš„ï¼Œä½†å°±å½“ä½œç»™æˆ‘çœ‹åˆ°çš„å¹»å…‰åŠ ä¸€æ˜Ÿå§ã€‚</p><h3 id="Kongres-Futurologicznyï¼ˆæœªæ¥å­¦å¤§ä¼šï¼‰"><a href="#Kongres-Futurologicznyï¼ˆæœªæ¥å­¦å¤§ä¼šï¼‰" class="headerlink" title="Kongres Futurologicznyï¼ˆæœªæ¥å­¦å¤§ä¼šï¼‰"></a>Kongres Futurologicznyï¼ˆæœªæ¥å­¦å¤§ä¼šï¼‰</h3><p>çœ‹åˆ°ä¸€ä¸ªè¯„è®ºè¯´ï¼šè±å§†å’Œ PKD å—‘çš„æ˜¯ä¸æ˜¯ä¸åŒâ€¦</p><p>ä½•ç­‰ç‹‚æ°”çš„ä½œå“ï¼ä½•ç­‰è“¬å‹ƒçš„æƒ³è±¡ï¼ä»æœªæ¥å­¦å¤§ä¼šå¼€å§‹ï¼Œåˆ°æ¥çš„äº‹ä»¶å’Œè§‚ç‚¹åƒåšç‰©é¦†ã€åƒä¸€æ³¢åˆä¸€æ³¢çš„æµªæ½®ä¸€èˆ¬ç‹‚æ¶Œè€Œæ¥ã€‚æƒ³æ³•åƒæ½®æ°´ä¸€æ ·æ¶Œå‡ºï¼Œéšç€è¯å“ä¸€æ­¥æ­¥å‘Šè¯‰ä½ ï¼šä»€ä¹ˆæ˜¯ç®€å•çš„ã€ä»€ä¹ˆæ˜¯å›°éš¾çš„ï¼Œæœ€åå°†å¤§å¹•æ­å¼€ï¼Œå±•ç°å‡ºä¸€ä¸ªæ·±é‚ƒçš„ç–¯ç‹‚çš„è®½åˆºä¸–ç•Œã€‚è€Œæœªæ¥å°šæœªå¼€å§‹ï¼Œæˆ‘ä»¬è¿˜ç«™åœ¨ä¸€åˆ‡çš„ç«¯ç‚¹ä¸Šï¼è¿™æ˜¯ä½•ç­‰çš„ç‹‚æ°”ã€å†·é™ä¸æµªæ¼«å•Šï¼</p><p>ä¸è¿‡è¯è¯´å›æ¥ï¼Œæ„Ÿè§‰è±å§†æœ¬äººå…¶å®ä¹ŸæŒºã€Œå¤§ç”·å­©çš„ã€ï¼Œè™½ç„¶é»‘å±æ®µå­ä¿¡æ‰‹æ‹ˆæ¥ï¼Œè·¨å­¦ç§‘åŠŸåº•ä¹Ÿæœ‰ä¸€äº›ï¼Œä½†æ˜¯ç›¸å¯¹äºç§‘æŠ€ç†è®ºï¼Œæ›´æ³¨é‡ç§‘æŠ€å½±åƒã€äººå£å’Œäººæ–‡ã€‚</p><h3 id="äººé¡ã¯è¡°é€€ã—ã¾ã—ãŸï¼ˆäººç±»è¡°é€€ä¹‹åï¼‰"><a href="#äººé¡ã¯è¡°é€€ã—ã¾ã—ãŸï¼ˆäººç±»è¡°é€€ä¹‹åï¼‰" class="headerlink" title="äººé¡ã¯è¡°é€€ã—ã¾ã—ãŸï¼ˆäººç±»è¡°é€€ä¹‹åï¼‰"></a>äººé¡ã¯è¡°é€€ã—ã¾ã—ãŸï¼ˆäººç±»è¡°é€€ä¹‹åï¼‰</h3><p>è™½ç„¶æˆ‘ä¸æ˜¯ç”°ä¸­ä¿¡å¾’â€¦ä½†æ˜¯è¿™éƒ¨ç¡®å®é¥¶æœ‰è¶£å‘³ï¼è¯¥æ‰“ç”°ä¸­ + key çš„èåœäº†ï¼</p><p>1-6å·æ˜¯æ¬¢ä¹æ—¥å¸¸ï¼Œå‰é¢å†™çš„åƒå¾ˆå¤šè°éŸ³memeçš„å°‘å„¿ä½œå“ï¼Œéšç€è¶Šå†™çº¦è½¬å‘ä¸€äº› sf å’Œç”°ä¸­å‘³çš„ä¸œè¥¿ã€‚7-9å·æœ‰ä¸€ç§å¿«ä¹è€Œæœ¦èƒ§çš„ç¾æ„Ÿå’Œæ¢ç´¢çš„æµªæ¼«ã€‚ä½œå“æä¾›äº†æ¢¦å¹»èˆ¬çš„å‰§åœºã€sf çš„æµªæ¼«æ„Ÿå’Œç¼“ç¼“æµç•…çš„æ¸©æƒ…ï¼Œç›¸å¯¹ç”°ä¸­å…¶å®ƒä½œå“åˆæ˜¯åæ„é€ ä¸”åè½»çš„ï¼ˆP.S. 5å·ä¹‹ååœ¨ç»“å°¾è¿˜åœ¨èŠè‡ªå·±åœ¨å†™ Rewriteï¼‰ã€‚çœŸå¥½å•Šï¼</p><h3 id="ç§‘å¹»æ–‡å­¦è®ºçº²"><a href="#ç§‘å¹»æ–‡å­¦è®ºçº²" class="headerlink" title="ç§‘å¹»æ–‡å­¦è®ºçº²"></a><strong>ç§‘å¹»æ–‡å­¦è®ºçº²</strong></h3><p>åœ¨å´å²©è¿™é‡Œï¼Œç§‘å¹»æœ¬èº«çš„æ€§è´¨è¢«å¸¦ç€ç›®çš„å’Œæƒ³è±¡è¢«å¡‘é€ ï¼Œä½†è¿™ç§æ–¹æ³•å…¶å®æ˜¯å’Œæ€§è´¨å¤šè€Œæ³›çš„ä¸åŒæ—¶ä»£ç§‘å¹»å‰²è£‚çš„ï¼Œå› æ­¤ä½œè€…å¸Œæœ›åœ¨æ–‡åŒ–ä¸­åè¿‡æ¥è€ƒå¯Ÿç§‘å¹»åœ¨å…¶ä¸­çš„å«ä¹‰ã€‚ä½œè€…æŠŠç§‘å¹»ä½œå®¶åˆ†ä¸ºä½œå®¶ç°‡ä»¥è€ƒå¯Ÿï¼ˆæœ¬äººè§‰å¾—å…¶å®è°±ç³»çš„æ–¹æ³•ä¼šæ›´ç§‘å­¦ä¸€ç‚¹ï¼‰ï¼Œä»‹ç»äº†å¥³æ€§ã€å¤§ç”·å­©ã€è¾¹ç¼˜ã€è½ä¼è€…ä½œå®¶ç°‡ï¼Œå¹¶ä¸”ç”¨å¯¹ç§‘å­¦çš„ã€å¯¹ç¤¾ä¼šçš„æ€åº¦æ¥è€ƒå¯Ÿè¿™äº›ä½œè€…ï¼Œå¾—å‡ºäº†ä¸€äº›ç»“è®ºã€‚ä½†æˆ‘è§‰å¾—è¿™äº›åˆ’åˆ†æœ¬èº«å¾ˆæœ‰æ„æ€ï¼Œä½†æ²¡é‚£ä¹ˆä¸¥è°¨ã€‚ä½†æœ¬ä¹¦è¿˜æ˜¯ç»™äº†å¾ˆè¯¦å®çš„ä»‹ç»çš„ï¼Œè€Œä¸”é‡‘å¥é¢‘å‡ºã€‚æœ€åä»‹ç»å®Œä¹‹åï¼Œä½œè€…è¿˜æ˜¯æ€»ç»“å¹¶å±•æœ›äº†ä¸€ä¸‹ SF å’Œä¸»æµæ–‡å­¦ã€‚æ„Ÿè§‰ä¸æ˜¯å¾ˆå¥½çš„ç§‘å¹»å²ï¼Œä½†ç¡®å®æ˜¯å€¼å¾—ç®€ä»‹çš„åˆ†æææ–™ã€‚</p><h3 id="The-Gnostic-Religionï¼ˆè¯ºæ–¯æ›¿å®—æ•™ï¼‰"><a href="#The-Gnostic-Religionï¼ˆè¯ºæ–¯æ›¿å®—æ•™ï¼‰" class="headerlink" title="The Gnostic Religionï¼ˆè¯ºæ–¯æ›¿å®—æ•™ï¼‰"></a>The Gnostic Religionï¼ˆè¯ºæ–¯æ›¿å®—æ•™ï¼‰</h3><p>ã€Œé‚£äº›æ²¡æœ‰å®¶ä¹¡çš„äººæœ‰ç¥¸äº†ã€ï¼ä»å¤ä»£è¢«æ’æŒ¤çš„ã€å½·å¾¨æ— æªçš„äººä»¬çš„è¯ºæ–¯æ›¿è¿åŠ¨ï¼Œä¸é¥è¿œç°åœ¨çš„å­˜åœ¨ä¸»ä¹‰/è™šæ— ä¸»ä¹‰ä¹‹é—´è¿æ¥äº†èµ·æ¥ã€‚åœ¨åŸé‚¦æ–‡åŒ–ç ´ç­ã€ç½—é©¬å…´èµ·çš„æ—¶å€™ï¼Œå¯¹ä¸–ç•Œã€è§„å¾‹æ€€æœ‰ææƒ§çš„äººä»¬å­•è‚²äº†æ·±é‚ƒçš„è®¾å®šï¼šä¸å¯çŸ¥çš„ç¥æ˜ã€ç ´è´¥çš„å®‡å®™ã€çµå’ŒçŸ¥è¯†çš„ä¿¡ä»°ã€å¯¹ä¸–ç•Œå’Œè§„å¾‹çš„åŒå€¦ã€é€ƒé¿ä¸åæŠ—ã€‚åŒæ—¶åˆæœ‰åŒ¹é…çš„è¯¦ç»†ä¸–ç•Œè§‚ã€‚å¼ æ–°æ¨Ÿçš„åºè¨€å¯çœŸéš¾è¯»ï¼ŒæŠŠçº¦çº³æ–¯å’Œè™šæ— ä¸»ä¹‰â€”å­˜åœ¨ä¸»ä¹‰çš„è¯Šæ–­ã€äºŒå…ƒè®ºç­‰ä»·å€¼æŒ‚é’©ï¼Œå†™çš„ä¸é”™ï¼Œå¥ˆä½•çœŸçš„é•¿â€¦</p><h2 id="Comic"><a href="#Comic" class="headerlink" title="Comic"></a>Comic</h2><h3 id="ã‚ˆã¤ã°ã¨-ï¼ˆå››å¶å¦¹å¦¹ï¼‰"><a href="#ã‚ˆã¤ã°ã¨-ï¼ˆå››å¶å¦¹å¦¹ï¼‰" class="headerlink" title="ã‚ˆã¤ã°ã¨!ï¼ˆå››å¶å¦¹å¦¹ï¼‰"></a>ã‚ˆã¤ã°ã¨!ï¼ˆå››å¶å¦¹å¦¹ï¼‰</h3><p>å¤ªå¥½çœ‹å•¦ï¼ä½œè€…ç”»ç”»é€è§†åŠŸåº•å¤ªå¼ºäº†ï¼å››å¶å¦¹å¦¹æ˜¯é‚£ç§çœŸæ­£çš„ç†Šå­©å­ï¼Œåœ¨ä½œå“é‡Œä½ èƒ½æ„Ÿå—åˆ°å¥¹åŒæ—¶å…·æœ‰è°ƒçš®çš„ç ´åæ€§å’Œå­©ç«¥çš„æœ¬çœŸæ€§ï¼Œä½†è¿™è‚¡ç ´ååŠ›æœ¬è´¨ä¸Šä¹Ÿæ˜¯æœ¬çœŸçš„ä¸€éƒ¨åˆ†ã€‚å¥¹é•¿å¤§å¯èƒ½ä¼šæˆä¸ºå„ç§å„æ ·çš„å°æœ‹å‹ï¼Œå°±è®©æˆ‘ä»¬çæƒœè¹¦è¹¦è·³è·³çš„å››å¶å¦¹å¦¹å§ï¼ˆå†µä¸”å¥¹åªæŠ˜è…¾è‡ªå·±äººï¼Œä¸ä¼šæŠ˜è…¾è¯»è€…ï¼‰ã€‚</p><h3 id="Berserkï¼ˆå‰‘é£ä¼ å¥‡ï¼‰"><a href="#Berserkï¼ˆå‰‘é£ä¼ å¥‡ï¼‰" class="headerlink" title="Berserkï¼ˆå‰‘é£ä¼ å¥‡ï¼‰"></a>Berserkï¼ˆå‰‘é£ä¼ å¥‡ï¼‰</h3><p>ä½œå“æ²¡æœ‰å®Œç»“ï¼Œä½†æ˜¯å› ä¸ºä¼—æ‰€å‘¨çŸ¥çš„åŸå› ï¼Œè¿˜æ˜¯æ ‡ä¸ªå·²è¯»å§ã€‚</p><p>å‡ ä¸ªç¯‡ç« ä¸­ï¼Œæ•…äº‹å’Œç»“æ„éƒ½å¾ˆå®Œç¾ï¼Œæ•´ä¸ªä½œå“æ•…äº‹æµ‘ç„¶ä¸€ä½“ï¼šé»„é‡‘æ—¶ä»£ç¯‡çš„å®Œç¾æ‚²å‰§ã€æ–­ç½ªå¡”ç¯‡ç»ä½³çš„ç»“æ„ã€æç«¯ç»†è…»çš„äººç‰©å…³ç³»ã€‚å†æ¬¡è‡´æ•¬ä¸‰æµ¦ã€‚</p><h3 id="ã»ã—ã®ã•ã¿ã ã‚Œï¼ˆæƒ‘æ˜Ÿå…¬ä¸»èœ¥èœ´éª‘å£«ï¼‰"><a href="#ã»ã—ã®ã•ã¿ã ã‚Œï¼ˆæƒ‘æ˜Ÿå…¬ä¸»èœ¥èœ´éª‘å£«ï¼‰" class="headerlink" title="ã»ã—ã®ã•ã¿ã ã‚Œï¼ˆæƒ‘æ˜Ÿå…¬ä¸»èœ¥èœ´éª‘å£«ï¼‰"></a>ã»ã—ã®ã•ã¿ã ã‚Œï¼ˆæƒ‘æ˜Ÿå…¬ä¸»èœ¥èœ´éª‘å£«ï¼‰</h3><p>é•¿æ¿å’ŒçŸ­æ¿éƒ½å¾ˆæ˜æ˜¾çš„ä½œå“ã€‚å°‘å¹´å‘çš„æ¯ç­ä¸–ç•Œä¸æ‹¯æ•‘ä¸–ç•Œï¼Œå„ç§å„æ ·çš„æˆé•¿ï¼Œä»¥åŠä¸€å£æ°”æ¨è¿›ä¸‹å»çš„æœ€ç»ˆæˆ˜ã€‚ç»å¤§éƒ¨åˆ†ç™»åœºäººç‰©éƒ½èƒ½ç•™ä¸‹éå¸¸æ·±åˆ»çš„å°è±¡ã€‚ä½†è¿™é‡Œå¾ˆå¤šéƒ¨åˆ†ç»†èŠ‚ä¹Ÿæ²¡èƒ½å®Œæ•´çš„æ¨è¿›ä¸‹å»ã€‚</p><h2 id="Game"><a href="#Game" class="headerlink" title="Game"></a>Game</h2><p>è¿™éƒ¨åˆ†å†™çš„å¾ˆå°‘ï¼Œå› ä¸ºæ‰‹å¤´ä¸€å †æ‰“äº†ä¸€åŠæ²¡æ‰“å®Œçš„æ¸¸æˆï¼Œå¯ä»¥è¯´æ¬ äº†ä¸€å±è‚¡å€ºâ€¦</p><h3 id="Ys-VIII-Lacrimosa-of-DANA"><a href="#Ys-VIII-Lacrimosa-of-DANA" class="headerlink" title="Ys VIII -Lacrimosa of DANA-"></a>Ys VIII -Lacrimosa of DANA-</h3><p>æŒºå¯æƒœçš„ï¼Œè¿‘ä¹äºæ²¡æœ‰çš„æ¼”å‡ºå’Œ90%éƒ½æ˜¯æ–­èŠ‚å¥çš„é©±é€æˆ˜æŠŠä¸€ä¸ªarpgå’Œå¿«ä¹æ¢ç´¢çš„æµç¨‹åˆ‡çš„ç¨€ç¢ã€‚ç¬¬äºŒç« åˆè‡­åˆé•¿ï¼Œç¬¬ä¸‰ç« å¼€å§‹æ¸å…¥ä½³å¢ƒï¼Œå¤ä»£çº¿å¥½è¯„ï¼Œé»„è‰²ä¸¹å¨œå¥½çˆ½ï¼Œç¬¬å››ç« ç»“å°¾ã€ç¬¬å…­ç« å‰é¢ã€æœ€åä¸€ç« bosså‡ ä¸ªåœ°æ–¹è¿˜æœ‰ç‚¹å°è±¡ã€‚</p><p>è¯´çœŸçš„ï¼Œæˆ‘ç©ç©ºè½¨çš„æ—¶å€™éƒ½æ„Ÿè§‰æ¼”å‡ºè¯¥æœ‰çš„éƒ½æœ‰ï¼Œç©ä¼Šè‹8çš„æ—¶å€™æ„Ÿè§‰æ¼”å‡ºå¥½ç‚¹æˆ‘çœ¼æ³ªå°±æ‰ä¸‹æ¥äº†ï¼Œå¯æƒœä¸ä»…æ²¡æœ‰å¥½æ¼”å‡ºï¼Œè¿˜è¦æ‹‰æˆ‘èµ¶ç´§å»ä¿å«æ‘åº„ï¼Œæ‘å£é€šé©¬æ¡¶ã€‚</p><h3 id="Ruina-å»ƒéƒ½ã®ç‰©èª"><a href="#Ruina-å»ƒéƒ½ã®ç‰©èª" class="headerlink" title="Ruina å»ƒéƒ½ã®ç‰©èª"></a>Ruina å»ƒéƒ½ã®ç‰©èª</h3><p>14 å°æ—¶æ‰“å®Œä¸€å‘¨ç›®æ³•å¸ˆçº¿ï¼Œå¸¦çš„é’æ¢…ç«¹é©¬ + ç›—è´¼ + é¾™å¥³ã€‚åˆ«çš„å‰§æƒ…æ˜¯äº‘å®Œçš„â€¦è€å®è¯´äº‘ä¸å®Œï¼Œå› ä¸ºå¾ˆå¤šç»†èŠ‚å¤¹æ‚åœ¨æ”¯çº¿ä¸­äº†</p><p>æ”¾åœ¨ 2022 çš„è§†è§’çœ‹ï¼ŒRuina å¤§éƒ¨åˆ†æš—ç¤ºè¿˜æ˜¯å¾ˆç®€å•çš„ï¼Œå™äº‹ä¹Ÿæ˜¯è™½ç„¶æœ‰ä¸€å®šæš—çº¿ï¼Œä½†æ˜¯è¿˜æ˜¯å¾ˆä¸€æœ¬é“çš„ã€‚ç³»ç»Ÿä¹Ÿæ¯”è¾ƒç®€å•ã€‚è¢«å¤¸è€€æ¯”è¾ƒå¤šçš„æ–‡æœ¬ç¡®å®æ¯”è¾ƒç²¾ç»†ï¼Œåœ¨é£æ ¼ä¸Šç¼åˆäº† ç½—é©¬ + å„åœ°çš„ç¥è¯æ•…äº‹ï¼Œå¯¹è¿™äº›éƒ¨åˆ†ç†Ÿæ‚‰çš„äººå¯èƒ½ä¼šç›¸å¯¹æœ‰ä¹å­ä¸€äº›ã€‚åœ¨ç¢ç‰‡åŒ–å™äº‹å·²ç»å¾ˆå¤§ç¨‹åº¦ä¸Šè¢«ç§‘æ™®äº†çš„ä»Šå¤©ï¼Œå…¶å®è¿™ä¸ªæ•…äº‹è¿˜æ˜¯æœ‰é‚£ä¹ˆä¸€ç‚¹ç‚¹è€æ—§çš„ã€‚ä¸è¿‡å¾ˆå¤šç»†èŠ‚è¿˜æ˜¯è—åœ¨äººç‰©å°å°çš„å¯¹è¯ä¸­çš„ï¼Œç©èµ·æ¥å€’æ˜¯é¥¶æœ‰è¶£å‘³ã€‚</p><p>ä½œå“æ¯”è¾ƒå¥½çš„åœ°æ–¹å°±æ˜¯æ„Ÿè§‰ï¼Œè™½ç„¶æ˜¯åŒäººä½œå“ï¼Œä½†æ˜¯ä½œè€…åˆ¶ä½œçš„å´æ˜¯éå¸¸æœ‰è€å¿ƒï¼Œæ•´ä¸ªä½œå“æµ‘ç„¶ä¸€ä½“ã€‚ç›¸å¯¹æ¥è¯´æ‰“ç£¨çš„è¿˜æ˜¯å¾ˆä¸é”™çš„</p><h3 id="ã‚¼ãƒãƒ–ãƒ¬ã‚¤ãƒ‰3ï¼ˆå¼‚åº¦ç¥å‰‘3ï¼‰"><a href="#ã‚¼ãƒãƒ–ãƒ¬ã‚¤ãƒ‰3ï¼ˆå¼‚åº¦ç¥å‰‘3ï¼‰" class="headerlink" title="ã‚¼ãƒãƒ–ãƒ¬ã‚¤ãƒ‰3ï¼ˆå¼‚åº¦ç¥å‰‘3ï¼‰"></a>ã‚¼ãƒãƒ–ãƒ¬ã‚¤ãƒ‰3ï¼ˆå¼‚åº¦ç¥å‰‘3ï¼‰</h3><p>æŠŠæˆ‘ç©é­”æ€”äº†ï¼Œåˆƒæ‰¹å˜åˆƒé»‘ï¼ˆè¯¯ï¼‰ã€‚å…¶å®ä½œå“å¤§çº²ä»å¤´å¼€å§‹æ£æµ‹ä½œè€…æ„æ€çš„è¯ï¼Œå¤§æ¦‚æ˜¯çŸ¥é“é«˜æ¡¥è¦è®²å•¥çš„ï¼ŒåŒæ—¶æŒ‡å¼•ç³»ç»Ÿå’Œç”»é¢è´¨é‡å²è¯—çº§æå‡ï¼Œè¿™çœŸçš„æ˜¯ switch ä¸Šçš„æ¸²æŸ“è´¨é‡å—ï¼Ÿä½†ç›¸å¯¹æ¥è¯´è„šæœ¬åŠ›ä¸‹é™å¤ªä¸¥é‡äº†ï¼ŒåŒæ—¶å‰§æƒ…ç¼–æ’æ„Ÿè§‰é—®é¢˜æŒºå¤§çš„ï¼Œæ„Ÿè§‰æƒ³è®²çš„ä¸œè¥¿å¤ªå¤šï¼Œåè€Œé…¿æˆäº†é¡¹ç›®ç¾éš¾ï¼Œå¯¼è‡´æ²¡å¤´æ²¡å°¾çš„ï¼ŒåŠ ä¸Šè„šæœ¬åŠ›ä¸‹é™ï¼Œå¯¼è‡´èƒ½è®²å¥½çš„ä¸œè¥¿éƒ½æ²¡è®²å¥½ã€‚</p><p>æœ¬æ¥æœ¬ä½œæ ¸å¿ƒäººç‰©åœ¨æ ¸å¿ƒçš„å¯¹è°ˆä¸­åº”è¯¥æ˜¯æ­ç¤ºæ•´ä¸ªå™äº‹çš„æ„å›¾çš„ï¼Œä½†æ˜¯å› ä¸ºæ­¤äººå·²ç»æ²¦è½ä¸ºäº†å–œå‰§äººç‰©ï¼Œæ‰€ä»¥æ˜¾å¾—ä½œå“è¿‡äºçˆ†ç¬‘ã€‚</p><h3 id="Baldr-Sky"><a href="#Baldr-Sky" class="headerlink" title="Baldr Sky"></a>Baldr Sky</h3><p>ï¼ˆå¤©å›½çš„ gigaâ€¦ï¼‰Steam åŠä»·å…¥æœ¬ä½“ã€‚é‡å¤å¯¹è¯ä¸æ˜¯å¾ˆå¤šï¼Œè®°å¿†æº¯è¡Œä¹Ÿæœ‰ä¸€äº›æ–°å‰§æƒ…ï¼Œæœ‰çš„ç½‘å‹åæ§½çš„ä¸€äº›ä¸èƒ½è·³è¿‡çš„é—®é¢˜ï¼Œåœ¨ Steam ç‰ˆæœ¬åº”è¯¥ä¿®å¤äº†ã€‚ä½œå“çš„é­…åŠ›æ¥æºäºä¸–ç•Œè§‚ã€è‰¯å¥½çš„å­¦é™¢ç¯‡/ç°ä»£ç¯‡åˆ‡æ¢ã€ä¸°å¯Œçš„å‰§æƒ…å’Œæˆ˜æ–—æ¼”å‡ºã€‚ å‰ä¸‰æ¡çº¿æ„Ÿæƒ…ç›¸å¯¹ç»†è…»ä¸€äº›ï¼Œè•¾çº¿/è®°å¿†æº¯è¡Œæ˜¯ Sora ä¸ºæ•°ä¸å¤šå¡‘é€ çš„åœ°æ–¹ï¼ˆä½†ä¿—è¯è¯´çš„å¥½ï¼Œæ­»äººæ˜¯ä¸å¯æˆ˜èƒœçš„ï¼‰ï¼Œè•¾çº¿æœ‰ç€ä¸°å¯Œçš„ç«‹åœºä»‹ç»ï¼Œèœå¶çº¿åˆ™å¾ˆç»†è…»çš„å±•ç°äº†ä¸€ä¸ªå‡¡äººè§†è§’ä¸‹çš„ä¸–ç•Œï¼Œåƒå¤çº¿å°†å‰é¢çš„çŸ›ç›¾æ¿€åŒ–å¹¶ç‚¹ç‡ƒã€‚äºšå­£çº¿æµªæ¼«æ¥è‡ªäºã€ŒHello Worldã€ï¼Œè€ŒçœŸçº¿ç»“å°¾ç¡®å®æ„ŸåŠ¨äº†æˆ‘ã€‚è€Œç©ºçº¿å®Œæˆäº†å†™å¾—å¾ˆåƒåŠ›ï¼Œä½†æ˜¯ç¡®å®åšå®Œäº†çš„æ•…äº‹ã€‚æˆ˜æ–—ç³»ç»Ÿéå¸¸æœ‰æ„æ€ï¼Œä¸è¿‡æˆ‘åŸºæœ¬åªç”¨æ°‘å·¥è¿æ‹› Normal å’Œ Hard æ··ç€æ‰“ã€‚</p><h3 id="BLACKSOULSII-æ„›ã—ãè²´æ–¹ã¸è´ˆã‚‹ä¸æ€è­°ã®å›½"><a href="#BLACKSOULSII-æ„›ã—ãè²´æ–¹ã¸è´ˆã‚‹ä¸æ€è­°ã®å›½" class="headerlink" title="BLACKSOULSII -æ„›ã—ãè²´æ–¹ã¸è´ˆã‚‹ä¸æ€è­°ã®å›½-"></a><strong>BLACKSOULSII -æ„›ã—ãè²´æ–¹ã¸è´ˆã‚‹ä¸æ€è­°ã®å›½-</strong></h3><p>ä»Šå¹´æœ€å¤§çš„æƒŠå“+æƒŠå–œä¹‹ä¸€â€¦dlsite å…¥çš„ï¼Œå®Œæˆåº¦é«˜çš„ä¸å¯æ€è®®ï¼Œæ¸¸æˆé˜´é—´çš„ä¸å¯æ€è®®ï¼Œå¾ˆå¤šåœ°æ–¹ä¸çœ‹æ”»ç•¥è¿˜æ˜¯æŒºåƒåŠ›çš„ï¼Œä¸è¿‡æ€»è§‰å¾—æ•°å€¼ç«Ÿç„¶æœ€åä¹Ÿæ²¡å´©ï¼ˆæˆ–è€…éƒ½æ¢æˆæœºåˆ¶æ€ªäº†ï¼‰ï¼Œå™äº‹ç›¸å¯¹éå¸¸å·§å¦™ã€‚Blacksouls2 ç”¨ä¸€ç§ç–¯ç‹‚ã€çŒå¥‡çš„æ–¹å¼æ¥è®²è¿°äº†ä¸å¯æ€è®®å›½åº¦ä¸çˆ±ã€‚</p><p>è¯¥ç©ç¥ä¹‹å¤©å¹³äº†ï¼Œgoï¼</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>mwish 2022 summary</title>
      <link href="/2023/01/28/mwish-2022-summary/"/>
      <url>/2023/01/28/mwish-2022-summary/</url>
      
        <content type="html"><![CDATA[<p>æ¿€è¡çš„ 2022 å¹´ç»“æŸäº†ã€‚äººå¹´é¾„å¤§äº†çš„ä¸€ä¸ªæ„Ÿå—å°±æ˜¯ï¼Œæ„Ÿè§‰æ—¶é—´çš„æµåŠ¨å¿«äº†å¾ˆå¤šï¼Œæ˜æ˜æ˜¯ä¸€æ ·çš„ä¸€å¹´ï¼Œå´æ˜æ˜¾æ„Ÿè§‰åšçš„äº‹æƒ…å˜å°‘äº†ï¼ˆæˆ‘ä¹Ÿåœ¨æƒ³æœ‰æ²¡æœ‰ä¸€ç§å¯èƒ½æ˜¯æˆ‘åšçš„äº‹æƒ…çœŸçš„å˜å°‘äº†ï¼Œè¿™ä¸ªå¯èƒ½æ€§å¤ªè¿‡å¯æ€•ï¼Œå¯¼è‡´æˆ‘ä¸æ•¢å¾€ä¸‹æƒ³äº†ï¼‰ã€‚è™½ç„¶æ²¡åšä»€ä¹ˆäº‹æƒ…ï¼Œè¿™ 365 å¤©è¿˜æ˜¯ç¡¬ç€è¿‡æ´»äº†è¿‡å»ï¼Œæ€»å¾—æ†‹ç‚¹æ–‡å­—å‡ºæ¥ã€‚è¿™ä¸€å¹´ï¼Œå¯¹æˆ‘æ¥è¯´ä¸»é¢˜åº”è¯¥æ˜¯ã€Œæ·±å…¥ã€é€‰æ‹©ä¸è‡ªç”±ã€ã€‚</p><p>è¿™ä¸€å¹´æ‰©å±•çš„çŸ¥è¯†é¢ç¡®å®ä¸å¤ªå¤šï¼Œæˆ‘è¿˜æ˜¯å•¥éƒ½ä¸ä¼šã€‚ä¸è¿‡åœ¨ä»¥å‰æµ®å…‰æ å½±çœ‹è¿‡çš„å‡ ä¸ªé¢†åŸŸç¨å¾®èŠ±äº†ä¸€ç‚¹ç²¾åŠ›ï¼Œåšåˆ°äº† Revisit:</p><ul><li>Btree ä¸Šè¯¦ç»† Survey äº†ä¸€ä¸‹ PostgreSQL / InnoDB / WiredTiger çš„å®ç°ï¼Œä¹Ÿäº†è§£äº†ä¸€ä¸‹æ–°é²œçš„ Bw-Tree å’Œ LLAMAï¼Œç„¶åå¯¹å…¶ä¸­éƒ¨åˆ†è®¾è®¡å¤§æ¦‚çŸ¥é“äº†ä¸€äº›å¥—è·¯ï¼Œä¹Ÿå’Œ FTL ä¹‹ç±»çš„çŸ¥è¯†å¯¹æ¥ä¸Šäº†ã€‚ç”¨è¿™äº›çŸ¥è¯†å» Revisit LSM ç”šè‡³ WiscKey çš„æ—¶å€™ï¼Œå‘ç°äº†å¾ˆå¤šè¯´æ³•å…¶å®æ˜¯æœ‰é—®é¢˜çš„ã€‚å¾ˆå¤š pros and cons åœ¨å­˜å‚¨å¼•æ“ä¸Šå…¶å®ä¸å®Œå…¨æ˜¯å¾ˆæŠ½è±¡çš„æœ€å¤–å±‚è®¾è®¡ï¼Œè€Œæ˜¯å¤–å±‚è®¾è®¡ + å®ç°çš„è´´åˆã€‚è¿™è®©æˆ‘æƒ³èµ·äº† rsygg ä¹‹å‰å¯¹æˆ‘è¯´çš„è¯ï¼šã€Œå…¶å®è¿™äº›éƒ½æ²¡æœ‰ä»€ä¹ˆåŒºåˆ«ã€ã€‚å½“æ—¶è¿˜ä¸ç†è§£ï¼Œç°åœ¨æƒ³æ¥ï¼Œå¤§å¸ˆæœç„¶æ˜¯å¤§å¸ˆã€‚</li><li>æ·±å…¥å»åšäº†ä¸€äº›æ ¼å¼ç›¸å…³çš„ä¸œè¥¿ã€‚å…¶å®æœ¬æ¥åšçš„ç±»ä¼¼åˆ†å¸ƒå¼ç³»ç»Ÿä¸Šæå„ç§ sync å’ŒèŠ±æ´»ï¼Œå¯¹ Log å’Œå¹¶å‘å†™è¿™äº›æ¯”è¾ƒæ•æ„Ÿï¼Œè¢«æ´¾å»åšæ ¼å¼å…¶å®æœ‰é‚£ä¹ˆç‚¹ç‚¹å°å°çš„ä¸ç”˜å¿ƒï¼Œä¸è¿‡æ¥ä¸‹æ¥ç¡®å®å‘ç°äº†å¾ˆå¤šé—®é¢˜ï¼Œç°åœ¨æˆ‘æ„Ÿè§‰æˆ‘å·®ä¸å¤šéƒ½èƒ½é»˜å†™å‡º Parquet çš„ standard å’Œè¿™ä¸ªæ ¼å¼çš„ä¸€äº›é—®é¢˜äº†ï¼Œæ„Ÿè§‰å¾ˆå¤šæ—¶å€™ get hands dirty æ‰èƒ½å‘ç°å…¶ä¸­å¾ˆå¤šå®ç°çš„å›°éš¾åœ¨ä»€ä¹ˆåœ°æ–¹ã€‚</li><li>å¤§æ¦‚è¿‡äº†ä¸€éè¥¿æ–¹ç°ä»£å²ã€‚ä»¥å‰è‰è‰çš„çœ‹è¿‡ä¸€äº›æ”¿æ²»å“²å­¦å’Œç¤¾ä¼šå­¦ï¼Œä½†æ˜¯å¹¶ä¸æ¸…æ¥šèƒŒæ™¯å’Œæ–‡åŒ–è¯­å¢ƒï¼Œå¤§æ¦‚çœ‹äº†ä¸€éè¥¿æ–¹ç°ä»£å²ä¹‹åï¼Œå» Revisit ä¹‹å‰çœ‹çš„æ”¿æ²»å“²å­¦ã€ç¤¾ä¼šå­¦å’Œè¥¿æ–¹å†å²ï¼Œå¾ˆå¤šåœ°æ–¹å¤§æ¦‚èƒ½ç†è§£å…¶ä¸­çš„å¹´ä»£å’Œè¯­å¢ƒäº†ï¼ˆè¿™æ–¹é¢ä¹Ÿæ˜¯çœ‹ä¹¦å¤ªå›°éš¾ï¼Œæ¯”å¦‚ä¹‹å‰çœ‹ã€Šè·¯æ˜“æ³¢æ‹¿é©¬çš„é›¾æœˆåå…«æ—¥ã€‹çš„æ—¶å€™ï¼Œå®Œå…¨çœ‹ä¸æ‡‚äººå¤´ï¼Œç„¶åçœ‹ä¸€äº›åˆ©ç»´å¦ä¹‹ç±»çš„ä¹¦çš„æ—¶å€™ï¼Œä¹Ÿä¸å¤ªæ‡‚èƒŒæ™¯ï¼‰ã€‚æ„Ÿè§‰ä¹‹åçœ‹è¥¿æ–¹/å›½å†…æ–‡å­¦çš„æ—¶å€™ï¼Œä¹Ÿåº”è¯¥å…ˆè¿‡ä¸€éå¯¹åº”çš„åŸºç¡€ï¼ˆåœ£ç»ã€è·é©¬å²è¯—ã€å²è®°ç­‰ç­‰ï¼‰ï¼Œè¦ä¸ç„¶å¾ˆå¤šåœ°æ–¹ä¼šå®Œå…¨å¤±å»å‘³é“ã€å¤±å»çœ‹æ‡‚éšå–»çš„èƒ½åŠ›å’Œå“å‘³æ–‡å­—é­…åŠ›çš„é«˜å¦™ã€‚</li></ul><p>å…¶å®è¿™äº›ä¸œè¥¿éƒ½ä¸æ˜¯å¾ˆéš¾ï¼Œä½†æ˜¯è¿˜æ˜¯è¦æ‘’å¼ƒæµ®èºçš„æƒ³æ³•ï¼Œç›¸å¯¹äºçœ‹20ç¯‡åšå®¢æˆ–è€…å•ä¸€çš„å°è§†é¢‘ï¼Œè¦æŠ½å‡ºæ—¶é—´å»å•ƒä¸€äº›ä»£ç /ä¸“è‘—ï¼Œæ‰èƒ½æ›´å¥½çš„å»å›é¡¾ä¹‹å‰çš„å†…å®¹ï¼Œå¤§æ¦‚çŸ¥é“å®ƒä»¬åœ¨è®²ä»€ä¹ˆï¼Œä»¥å…ä¸Šäº†çŸ¥è¯†åˆ†å­çš„éª—ã€‚å›è¿‡å¤´æ¥è¯´ï¼ŒçŸ¥è¯†åˆ†å­æ˜¯çœŸçš„å¾ˆèƒ½éª—äººçš„ï¼Œå€’ä¸èƒ½è¯´å¤§å®¶éƒ½æ˜¯æ•…æ„çš„ã€‚æˆ‘è¯•å›¾è¿™æ ·æè¿°ï¼š</p><ul><li>æ¯ä¸ªè®ºè¿°å¯èƒ½åŒ…å«äºæŸä¸€ç§å™äº‹ï¼ˆSSD çš„æ€§èƒ½ï¼Œç¤¾ä¼šè¿è¡Œçš„é™æ€æ¡ä»¶ï¼‰</li><li>è¿™ä¸ªå™äº‹é€šå¸¸æœ‰æ­£ç¡®çš„ä¸€é¢ï¼ˆSSD ç¡®å®èƒ½é å¹¶å‘ä¸Šååé‡ï¼Œæœ‰çš„é™æ€æ¡ä»¶ç¡®å®ä¼šå½±å“ç¤¾ä¼šï¼‰</li><li>ä½†æ˜¯å®ƒä»¬å¿½ç•¥äº†å¾ˆå¤šåˆ«çš„é—®é¢˜ï¼Œå¯¼è‡´è¿™ä¸ªç»“è®ºå¹¶éå®Œå…¨çš„ Solidï¼ˆio çš„å½±å“ï¼Œç¤¾ä¼šæœ¬èº«æ€§è´¨æ˜¯ç›¸å…³è”çš„ã€å†å²æ€§çš„ï¼‰</li></ul><p>ç½‘ä¸Šå¾ˆå¤šè®ºè¿°éƒ½åŒ…å«äºæŸä¸€ç§å™äº‹ï¼Œè¿™ç§å™äº‹å¹¶éå®Œå…¨æ­£ç¡®çš„ï¼Œæ”¯æŒè€…ä¼šå®Œå…¨ç›¸ä¿¡è¿™ä¸€ç§å™äº‹ã€åå¯¹è€…ä¼šæ ¹æ®è¿™ä¸ªç»“è®ºå¹¶éå®Œå…¨ solid è€Œå…¨é¢é©³æ–¥è¿™ç§è®ºè¿°ï¼Œç”šè‡³è¿›è¡Œäººèº«æ”»å‡»ã€‚ä½†æˆ‘è§‰å¾—äº‹æƒ…è¿˜æ˜¯å¾ˆå¤æ‚çš„ï¼š</p><ul><li>ä¸€ä¸ªè®ºè¿°ï¼Œå¦‚æœæŠ“ä½äº†ä¸€äº›ç»“æ„æ€§ã€åŠŸèƒ½æ€§ç”šè‡³æ˜¯å†å²æ€§çš„ç‰¹å¾ï¼Œå°±æ˜¯æœ‰ä»·å€¼çš„</li><li>ä¸€äº›å™äº‹ä¸å…ä¼šå¸¦ä¸Šä¸€äº›å“²å­¦æ€§è´¨ï¼ˆå“ªæ€•æ˜¯ç‰©ç† cs è¿™æ ·æ¯”è¾ƒæ‰å®çš„é¢†åŸŸï¼‰å¯»æ‰¾ä¸€äº›å®Œå…¨æ­£ç¡®çš„å™äº‹åœ¨ CS ç”šè‡³ç‰©ç†é¢†åŸŸéƒ½æœ‰å›°éš¾ï¼Œæ›´ä¸è¦è¯´ä¸€äº›ç¤¾ä¼šå­¦ç§‘äº†ï¼Œä½†æ˜¯å› æ­¤å¦å®šä¸Šè¿°è®ºè¿°çš„â€¦æ°´å¹³ä¹Ÿå°±èœåˆ°é‚£é‡Œäº†ï¼Œæ²¡å¿…è¦è¾©è®ºäº†ã€‚</li></ul><p><img src="https://image.mwish.me/blog-image/Fku9KPrUYAAep7m.jpeg" alt="Fku9KPrUYAAep7m"></p><p>æ‰€ä»¥ç»“è®ºè¿˜æ˜¯ï¼šå¤šçœ‹å¤šæ–¹é¢çš„è®ºè¿°ã€å®Œæ•´çš„ææ–™ï¼Œä½ å°±ä¼šå‘ç°äº’è”ç½‘å…¶å®æ˜¯åˆ†å±‚çš„ï¼Œä¹‹å‰è§‰å¾—éƒ½å¾ˆå‰å®³çš„äººå…¶å®ä¸€å¤§åŠæ˜¯æ°´è´§ï¼ˆå½“ç„¶æˆ‘ä¹Ÿæ˜¯æ°´è´§ï¼Œæ˜¯æ°´è´§æ²¡å•¥ä¸å¥½çš„ï¼Œå“ˆå“ˆï¼‰ã€‚å½“ç„¶ä¸å¤ªå¥½çš„åœ°æ–¹æ˜¯æˆ‘ä»Šå¹´è„¾æ°”ç¡®å®æš´èºäº†ä¸å°‘ï¼Œè¿™ä¸ªå¾—æ”¹â€¦</p><p>ä¸è¿‡è€å®è¯´ï¼Œä¸Šè¿°è¯´çš„éƒ½æ˜¯å¾ˆå¤šæ­£ç»è®ºè¿°çš„äººäº†ã€‚å¾ˆå¤šäººå–œæ¬¢è„±ç¦»æ–‡æœ¬ï¼Œç„¶åå‘æ•£åˆ°ä¸€äº›å’Œæ–‡æœ¬æ²¡å•¥å…³ç³»çš„ä¸œè¥¿ã€‚å¦‚æœè¿™æ˜¯åŒäººåˆ›ä½œçš„è¯ï¼Œé‚£æˆ‘æ˜¯å¾ˆæ¬¢è¿çš„ï¼ˆæ¯”å¦‚å„ç§æ¸¸æˆçš„åŒäººåˆ›ä½œï¼‰ã€‚ä½†æ˜¯æ­£ç»è®¨è®ºé—®é¢˜çš„æ—¶å€™ï¼Œéšæ„æ¯”å–»ã€è„±ç¦»é—®é¢˜ã€è„±ç¦»æ–‡æœ¬ï¼ŒåŸºæœ¬ä¸Šå¯ä»¥è®¤ä¸ºæ²¡æœ‰è®¨è®ºé—®é¢˜çš„èƒ½åŠ›ï¼Œç›´æ¥æ‹‰é»‘å°±è¡Œäº†ã€‚</p><p>æœ‰ä¸€ä¸ªæ¯”è¾ƒå¼€å¿ƒçš„äº‹æƒ…æ˜¯ï¼Œä»Šå¹´åšä¸Šäº†ç‹—ç¾¤ä¸»ï¼Œæœ‰äº†è‡ªå·±çš„ QQ ç¾¤ã€‚ä¹‹å‰å»ºè¿‡å‡ ä¸ªç¾¤ï¼Œéƒ½å› ä¸ºæ²¡ç®¡ä¸‹å»ï¼Œå¯¼è‡´æœ€ç»ˆæ²¡äººäº†ï¼Œä»Šå¹´è‡ªå·±å»ºäº†ä¸ªè¯»ä¹¦æœ‰å…³çš„ç¾¤ï¼Œç›®å‰å¸å¼•äº†ä¸å°‘å¥½ç©çš„ç¾¤å‹ï¼šæœ‰ç¿»è¯‘èå£«æ¯”äºšçš„è€å“¥ã€ä¹Ÿæœ‰ galgame å¤§å¸ˆã€å†™ galgame çš„è„šæœ¬å®¶ã€å†å²å’Œå“²å­¦çˆ±å¥½è€…ã€SFå¤§å¸ˆã€‚ä½œä¸ºä¸€ä¸ªç‹—ç¾¤ä¸»ï¼Œæˆ‘æ„Ÿè§‰è‡ªå·±ä»€ä¹ˆéƒ½ä¸å¦‚ä»–ä»¬ï¼Œæ‰€ä»¥ä¹Ÿèƒ½åœ¨äº¤æµä¸­å­¦åˆ°å¾ˆå¤šã€‚æ¯”è¾ƒå¼€å¿ƒçš„å°±æ˜¯ï¼Œå³ä½¿ç¾¤é‡Œæœ‰çŸ›ç›¾ï¼Œæˆ‘ä½œä¸ºç¾¤ä¸»ä¹Ÿèƒ½æ¯”è¾ƒå¥½åè°ƒä¸‹å»ï¼Œç„¶åè¿™ä¸ªå°ç¾¤çœŸçš„ç»™æˆ‘è¿è¥ä¸‹æ¥äº†ï¼Œæ¯å¤©éƒ½èƒ½å­¦åˆ°æ–°çš„ï¼ˆæ²¡ç”¨çš„ï¼‰çŸ¥è¯†å’Œæœ‰ä¸€äº›æœ‰ä»·å€¼çš„è®¨è®ºï¼ˆè¿˜æœ‰æ¯å¤©çš„å¿«ä¹é»‘å±ï¼‰ã€‚å…¶å®æˆ‘ä»æ¥ä¸æ•¢åˆ›å»ºä»€ä¹ˆç å†œç¾¤ï¼Œæ„Ÿè§‰ç å†œäº’ç›¸å¹é»‘çš„æ°›å›´è¿˜æ˜¯å¾ˆæµ“åšçš„ï¼Œä¸æ˜¯åŠ¨è¾„xç¥å°±æ˜¯äº’ç›¸é»‘å±ï¼Œå…¶å®æ²¡å•¥æ„æ€ã€‚æˆ‘ä»Šå¹´ä¹Ÿä¸æ€ä¹ˆåœ¨çŸ¥ä¹å‘æ–‡ç« äº†ï¼Œå› ä¸ºå…¨æ˜¯ç‚¹èµçš„ï¼Œå‡ ä¹æ²¡æœ‰äººå¯¹ä½ è¿›è¡Œæ‰¹åˆ¤ã€‚æ€ä¹ˆä¼šå–œæ¬¢è¢«æ‰¹åˆ¤å‘¢ï¼Ÿç­”æ¡ˆæ˜¯å¾ˆå¤šä¸œè¥¿ä½ å‘å‡ºæ¥ä¹Ÿä¸æ˜¯å®Œå…¨æ‡‚ï¼Œè¦ç»è¿‡ä¸å°‘è®¨è®ºï¼Œæ‰èƒ½å†åœ¨åŸæ–‡æœ¬ä¸Šå½¢æˆä¸€äº›æœ‰ä»·å€¼çš„ã€solid çš„ç»“è®ºï¼Œå…¨æ˜¯å¤¸è€€å’Œå…¨æ˜¯æ‹‰è¸©ä¸€æ ·ï¼Œéƒ½æ²¡æœ‰ä»€ä¹ˆä»·å€¼å’ŒåŠ›é‡ã€‚</p><p><img src="https://image.mwish.me/blog-image/FnZGSdfaEAIXJ0I.jpeg" alt="FnZGSdfaEAIXJ0I"></p><p>æ¥ä¸‹æ¥ä¸€ä¸ªè¯é¢˜æ˜¯ã€Œé€‰æ‹©ä¸è‡ªç”±ã€ã€‚è¿™æ˜¯ä¸€ä¸ªå¾ˆå¤§çš„è¯é¢˜ï¼Œæˆ‘å¿…é¡»åªèšç„¦åœ¨ä¸ªäººä¸Šã€‚è¿™ä¸€å¹´æˆ‘è¿˜æ˜¯æ¢äº†ä¸ªå·¥ä½œï¼ˆå¤§æ¦‚æ˜¯åœ¨å†™<a href="https://blog.mwish.me/2022/07/03/%E6%AF%95%E4%B8%9A%E4%B8%A4%E5%B9%B4%E8%AE%B0/">è¿™ç¯‡åšå®¢</a>çš„æ—¶å€™ï¼‰ã€‚é‚£ä¸ªæ—¶å€™æˆ‘ä»åŒ—äº¬è·‘åˆ°äº†æ­å·ï¼Œç„¶åæ¢äº†ä¸ªå·¥ä½œã€‚å…¶å®æŒ‰èŒä¸šå‘å±•çœ‹ï¼ŒåŒ—äº¬äº’è”ç½‘å’ŒåŸå¸‚é‡‘èæ˜¯æ¯”æ­å·å¥½çš„ï¼Œçœ‹äº†é™†é“­çš„ä¹¦ï¼Œæˆ‘ä¹ŸçŸ¥é“äº†å¤§å›½å¤§åŸçš„æ„ä¹‰ã€‚åŒæ—¶ï¼Œåœ¨ä¹‹å‰çš„ç»„æˆ‘è¿‡çš„è¿˜ç®—èˆ’æœï¼Œè€æ¿å’ŒåŒäº‹éƒ½å¾ˆå¥½ï¼Œæˆ‘å¹²çš„æ´»ä¹Ÿä¸ç®—æ‚æ´»ï¼Œå¾ˆå¤šæ—¶å€™è‡ªç”±åº¦æ¯”æˆ‘ç°åœ¨é«˜å¤šäº†ï¼Œç°åœ¨æˆ‘åšçš„åè€Œç›¸å¯¹æ‚ä¸€äº›ã€‚æˆ‘æ˜¯æƒ³è¯´ï¼Œå¹¶ä¸èƒ½è¯´æˆ‘æ¢ä¸ªå·¥ä½œå°±ä»€ä¹ˆé—®é¢˜éƒ½è§£å†³äº†ï¼Œå¾ˆå¤šä¸œè¥¿ä¸æ˜¯ä¸‡çµè¯ï¼Œä½†è¿™æ˜¯åœ¨è¯´ï¼Œé€‰æ‹©çš„ç»“æœå¹¶ä¸éƒ½æ˜¯è‡ªå·±æƒ³è¦çš„ï¼Œä½†æ˜¯è¿™æ˜¯ä½ é€‰å‡ºæ¥çš„ï¼Œæ‰€ä»¥ä¹Ÿæ²¡å•¥æŠ±æ€¨çš„ã€‚é‡è¦çš„æ˜¯ã€Œèƒ½é€‰ã€å’Œã€Œæ„¿æ„é€‰ã€ï¼šã€Œæˆ‘èƒ½ï¼Œæˆ‘ä¹Ÿæ„¿æ„ä»åŒ—äº¬æ¢åˆ°æ­å·ï¼Œè¿™æ˜¯å› ä¸ºæˆ‘ä¸æ˜¯é‚£ä¹ˆ Care è¿™ç‚¹èŒä¸šå‘å±•å‰æ™¯ï¼Œæˆ‘æ›´å–œæ¬¢å—æ–¹çš„èˆ’é€‚æ°›å›´å’Œç¦»å®¶è¿‘ï¼Œåœ¨è¿™é‡Œæˆ‘å¯ä»¥è½»æ¾å‡ å‘¨å›ä¸€æ¬¡å®¶ã€ã€Œæˆ‘æœ‰ç‚¹å¸Œæœ›æ¢ä¸€ä»½å·¥ä½œï¼Œç„¶åæ¥è§¦åˆ°ä¸€äº›ä¸åŒçš„äººå’Œä¸åŒçš„å·¥ä½œç¯å¢ƒï¼Œè¿™ä¹Ÿèƒ½è®©æˆ‘ revisit ä¸€äº›ä¹‹å‰åšçš„äº‹æƒ…ã€ã€‚</p><p><img src="https://image.mwish.me/blog-image/C9D52720-75AB-4C50-9BDF-C3BF86CD37ED.png" alt="C9D52720-75AB-4C50-9BDF-C3BF86CD37ED"></p><p>è¿™ä¸ªæ—¶å€™è¯»è€…å¯èƒ½ä¼šè§‰å¾—ã€Œä½  tm åœ¨æ”¾å±ï¼Œè¿™äº›ä¸æ˜¯æƒ³å½“ç„¶çš„å—ã€ã€‚æˆ‘è§‰å¾—è¿˜çœŸä¸æ˜¯ï¼Œåšé€‰æ‹©çš„æ—¶å€™ï¼Œäººæ˜¯ä¼šè¢«å¾ˆå¤šè§‚å¿µæŸç¼šçš„ï¼Œå¯èƒ½è¢«åŠ¨è¢«é€‰æ‹©ç»“æœä¸Šä¼šæ›´å¥½ã€‚è‡ªå·±é€‰ä¸œè¥¿æœ‰ä¸€ç§éšé£æ¼‚æ³Šçš„æ„Ÿè§‰ï¼Œä½ çŸ¥é“å¾ˆå¯èƒ½æ˜¯é”™çš„ï¼Œè€Œä¸”é”™äº†å°±æ²¡æœ‰å¯ä»¥æŠ±æ€¨çš„å¯¹è±¡äº†ï¼šä½ ä¸é‚£ä¹ˆå¥½æŠŠä½ çš„é—®é¢˜ç”©ç»™åˆ«äººï¼Œè¿™æ˜¯å­¤ç‹¬å’Œè‡ªå·±çš„å¯¹æŠ—äº†ã€‚ä½†æ˜¯æˆ‘è§‰å¾—ï¼Œé€‰æ‹©çš„æƒåŠ›å’Œè‡ªç”±è¿˜æ˜¯å¾ˆé‡è¦çš„ï¼Œä½ å¿…é¡»è‡ªå·±åšæŠ‰æ‹©ï¼Œç„¶åå¯¹æ­¤è´Ÿè´£äº†ã€‚ç¤¾ä¼šæ¯•ç«Ÿæ˜¯ç”±äººç»„æˆçš„ï¼Œå³ä½¿æœ‰ç¤¾ä¼šå’Œå®¶åº­çš„é˜»åŠ›ï¼Œä½ è‡ªå·±ä¹Ÿæ˜¯è‡ªç”±çš„ï¼Œä½ æ˜¯ä½ è‡ªå·±çš„é€‰æ‹©ï¼Œä½ ä¹Ÿè¦æ„è¯†åˆ°ï¼Œä½ ä¸æ˜¯æ²¡æœ‰é€‰æ‹©ã€‚</p><p><img src="https://image.mwish.me/blog-image/C5CE8D59-4533-4D96-BADD-38D6F49FAD51.png" alt="C5CE8D59-4533-4D96-BADD-38D6F49FAD51"></p><p>æœ€åï¼Œ2022 å¹´æ˜¯å¾ˆåŠ¨è¡çš„ä¸€å¹´ã€‚å¤§å®¶è¢«å°äº†å¾ˆä¹…ï¼Œåœ¨å°æ§åï¼Œå¯èƒ½ä¹Ÿå¤±å»äº†è‡ªå·±çˆ±çš„äº²äººã€‚åœ¨è¿™é‡Œå‘å¤§å®¶çš„ç—›è‹¦è‡´æ„ï¼Œä¸ºé€å»çš„åŒèƒé»˜å“€ã€‚å¸Œæœ›å¤§å®¶ 2023 å¹´èƒ½å°‘å¤±å»ä¸€äº›ï¼Œä¸€åˆ‡ä¸ºäº†ç¾å¥½çš„è®°å¿†ã€‚</p><p><img src="https://image.mwish.me/blog-image/FC2245C9-1DB2-411C-8C40-4818A699C181.png" alt="FC2245C9-1DB2-411C-8C40-4818A699C181"></p><p>é¢„ç¥å¤§å®¶ 2023 å¿«ä¹ã€‚</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Fast21 RocksDB Design</title>
      <link href="/2023/01/22/Fast21-RocksDB/"/>
      <url>/2023/01/22/Fast21-RocksDB/</url>
      
        <content type="html"><![CDATA[<p>ç¦» Google å¼€æº leveldbï¼Œç»™æˆ‘ä»¬ä¸€ä¸ªå¾ˆç²¾å·§çš„ç©å…·å®ç°ï¼Œå·²ç»è¿‡å»äº†å¾ˆä¹…å¾ˆä¹…ã€‚Facebook å¼€æºçš„ RocksDB æˆäº†å·¥ä¸šç•Œä½¿ç”¨ KV æ„å»ºè½¯ä»¶çš„é»˜è®¤æ ‡å‡†ã€‚RocksDB æ˜¯ä¸€ä¸ªåŠŸèƒ½éå¸¸å®Œå¤‡çš„ KV å¼•æ“ï¼Œå®ƒè¢«ä½¿ç”¨åœ¨å„ç§å¤§è§„æ¨¡çš„åˆ†å¸ƒå¼ç³»ç»Ÿä¸­å’Œå•æœºå¼•æ“ä¸­ã€‚</p><p>æœ¬æ–‡æ˜¯ FASTâ€™21 ä¸­ Facebook å‘è¡¨çš„æ–‡ç« ï¼Œæè¿°äº† RocksDB åœ¨ 2012 - 2020 çš„æ¼”è¿›ã€‚</p><p>10å¹´å‰ï¼ŒFacebook çš„å·¥ç¨‹å¸ˆæ‹¿åˆ° LevelDBï¼Œåªæ˜¯é’ˆå¯¹ SSD å’Œå¤§è§„æ¨¡åˆ†å¸ƒå¼ç³»ç»Ÿä½¿ç”¨ï¼ŒåŒæ—¶æƒ³ä¼˜åŒ–ä¸€ä¸‹ Compactionï¼Œäºæ˜¯ä»–ä»¬æ·»åŠ äº† Compactionã€‚å¾ˆå¤šå¹´åçš„ä»Šå¤©ï¼ŒRocksDB æœ‰äº†éå¸¸ä¸°å¯Œçš„åŠŸèƒ½ã€éå¸¸ä¸°å¯Œçš„ Tunning ä½“éªŒã€‚æˆ–è®¸è¿™ä¹Ÿç»™äº†æˆ‘ä»¬ä¸€äº›æ„å»ºè½¯ä»¶ä¸Šçš„æš—ç¤ºï¼šå…ˆåšå¥½ä¸€ä»¶äº‹æƒ…ï¼Œå†æ…¢æ…¢åšå¥½åˆ«çš„äº‹æƒ…ã€‚</p><p>è®ºæ–‡çš„å°¾éƒ¨é™„äº†ä¸€å¼  2012 - 2020 çš„ RocksDB åŠŸèƒ½å¹´è¡¨ï¼Œè¯»èµ·æ¥ä»¤äººæ„Ÿå¹ï¼šã€Œå‰å¾€æ— é™çš„å½¼æ–¹ï¼Œé‚£æ˜¯æˆä¸ºç¥çš„æ¼«é•¿é“è·¯ã€</p><p><img src="https://image.mwish.me/blog-image/output.png" alt="output"></p><p>æ–‡ç« çš„å¼€å§‹ä»‹ç»äº† RocksDB çš„ä¸€äº›ç»éªŒï¼š</p><ol><li>åœ¨å†™å…¥/è¯»å–ç­‰å„ä¸ªæ–¹é¢çš„é…ç½®/tuning</li><li>ä¸åŒè´Ÿè½½ä¸Šéƒ½èƒ½æ”¯æŒ</li><li>é…ç½® / Metrics / å®Œå–„çš„ debug tools å’Œè¿ç§»å·¥å…·ç­‰</li></ol><p>RocksDB æœ¬èº«éå¸¸é…ç½®åŒ–ã€‚ç½‘ä¸Šå¾ˆå¤šåœ°æ–¹ä»‹ç»çš„æ˜¯å®ƒçš„ä¸»è¦é“¾è·¯ï¼Œä½†æ˜¯å®ƒå¾ˆå¤šç»„ä»¶éƒ½æ˜¯å¯é…ç½®çš„ï¼ˆè®ºæ–‡åªæäº†äº®ç‚¹ï¼Œæˆ‘åé¢ä¼šææ›´å¤šï¼‰ï¼š</p><ol><li>WAL Treatment</li><li><strong>Compaction Strategy</strong><ol><li>RUM Conjunction</li><li>Dostoyevsky</li><li>å¯ä»¥æœ‰é«˜è¯»å†™åå</li></ol></li></ol><p>è¿™é‡Œ RocksDB ä¹Ÿæœ‰ä¸åŒçš„ workload:</p><ol><li>Database (æœ€ä¸»è¦çš„åº”ç”¨): crdb, tidb, MyRocksâ€¦<ol><li>è¯»å†™æ··åˆè´Ÿè½½</li><li>è¯»ï¼šç‚¹æŸ¥ + Iterator</li><li>ä¼šæœ‰ Transaction å’Œ Backup</li></ol></li><li>Stream Processing: eg, Flink, Kafka Stream, Samza, Facebook Stylus<ol><li>é‡å†™</li><li>è¯»ï¼šç‚¹æŸ¥ / Iterator</li><li>ä¼šæœ‰æ—¶é—´çª—å£å’Œ ckpt (å…¶å®æˆ‘ä¸æ˜¯å¾ˆç†Ÿæ‚‰ï¼Œä¹‹åå¯ä»¥çœ‹çœ‹ Flinkï¼‰</li></ol></li><li>Logging / queueing service: Facebook LogDevice, Uber Cherami, Iron.io<ol><li>é‡å†™</li><li>è¯»ï¼šç‚¹æŸ¥ / Iterator</li><li>æ”¯æŒ HDDï¼Œæ¯”å¦‚ Logging æ ¹æœ¬ä¸ç”¨é‚£ä¹ˆå¥½æ€§èƒ½ï¼Œä¸è¿‡æ„Ÿè§‰ queue è¿˜å¥½ï¼ˆè¯è¯´æˆ‘æ„Ÿè§‰ queue å’Œ Stream æœ¬è´¨åŒºåˆ«æ˜¯å•¥æ ·çš„å‘¢â€¦ï¼‰</li></ol></li><li>Index Service: Facebook Dragon, Rockset<ol><li>åº”è¯¥æ˜¯ç±»ä¼¼åˆ†æ / è®­ç»ƒç”¨çš„ Servicing å¼•æ“</li><li>é‡è¯»</li><li>è¯» Pattern ä¸º Iteratorï¼Œç›¸å½“äºæ˜¯ batch scan</li><li>è´Ÿè½½åº”è¯¥æ˜¯è®­ç»ƒå‡ºæ¥çš„ä¸œè¥¿ bulk loadï¼ŒçŒå…¥æ•°æ®</li></ol></li><li>Caching on SSD: Netflix EVCache ( è¿™é‡Œè¿˜å†™äº† Pikaï¼Œä½†æˆ‘æ„Ÿè§‰ Pika ä¸å®Œå…¨æ˜¯ in-memory cache äº†ï¼Œè¿˜æ˜¯ç®— DBï¼‰<ol><li>é‡å†™</li><li>è¯»ï¼šç‚¹æŸ¥</li><li>å¯ä»¥ä¸¢å¼ƒå­˜å‚¨çš„å¯¹è±¡</li></ol></li></ol><p>ä¸‹é¢ç»™äº†ä¸ªè´Ÿè½½è¡¨æ ¼ï¼Œå…¶å®å¾ˆæœ‰å‚è€ƒä»·å€¼</p><p><img src="https://image.mwish.me/blog-image/output-1.png" alt="table-2"></p><p>å¯ä»¥çœ‹åˆ°ï¼ŒRocksDB è¿™äº›è´Ÿè½½éƒ½å¯ä»¥æ”¯æŒï¼Œéå¸¸å¼ºæ‚ã€‚</p><p>åŒæ—¶ï¼Œæ‰€æœ‰ç³»ç»Ÿéƒ½éœ€è¦ checksumï¼ˆè™½ç„¶ RocksDB å¯èƒ½ä¼šè¦æ±‚ç”¨æˆ·è‡ªå·±åœ¨ä¸Šå±‚ç»´æŠ¤æ­£ç¡®æ€§ï¼‰ï¼ŒåŒæ—¶ä¹Ÿè¦æŠŠé”™è¯¯åˆç†æŠ›ç»™ä¸Šå±‚ã€‚è¿™äº›ä¸œè¥¿ xjb å†™è½¯ä»¶æ˜¯ä¸ä¼šç¢°åˆ°çš„ï¼Œä½†æ˜¯åšä¸€å¥—ä¸¥æ ¼çš„å­˜å‚¨ç³»ç»Ÿï¼Œè¿˜æ˜¯éå¸¸å¿…è¦çš„ã€‚RocksDB ä¼šåšä¸€äº›é€ä¸ªkeyçš„ checksumï¼Œä¹Ÿä¼šåå°æ£€éªŒã€å‘é€æ•°æ®çš„æ—¶å€™æ ¡éªŒç­‰ã€‚</p><p>é™¤äº†ä¸Šè¿°å­˜å‚¨ç³»ç»ŸåŠŸèƒ½ï¼Œè¿™é‡Œè¿˜æœ‰ï¼š</p><ul><li>Monitoring framework</li><li>Performance profiling</li><li>Debug tools</li></ul><p>è¿™é‡Œ RocksDB æœ¬èº«å¯ä»¥ä¸ŠæŠ¥ä¸€äº›ä¿¡æ¯ï¼Œç„¶åè¢«ä½¿ç”¨åˆ°æ¡†æ¶ä¸­ã€‚</p><p>ä¸Šè¿°è¿™äº›ä¸œè¥¿éƒ½æ˜¯ RocksDB æ¼«é•¿å¼€å‘çš„ä¸€éƒ¨åˆ†ï¼Œæœ¬è®ºæ–‡è®²è¿°äº† RocksDB å…«å¹´çš„å¼€å‘å²å’Œ design choice.</p><p>æ–‡ç« çš„ç¼–æ’æ˜¯ï¼š</p><ol><li>SSD / LSM çš„åŸºç¡€ / LSM æ€ä¹ˆé€‚é…å„ç§åº”ç”¨</li><li>ä¸»è¦çš„ä¼˜åŒ–åœ¨ 12 - 20 å¹´çš„æµå˜</li><li>RocksDB åœ¨å¤§è§„æ¨¡åˆ†å¸ƒå¼ç³»ç»Ÿï¼ˆshared-nothing ç³»ç»Ÿï¼Œå¤šç§Ÿæˆ·ï¼Œå‡çº§ï¼Œå¤‡ä»½ç­‰ï¼‰ä¸­çš„ç»éªŒæ•™è®­</li><li>Failure Handling / CRC ç­‰å¤„ç†ï¼Œè¿™éƒ¨åˆ†å®é™…ä¸Šæ˜¯éå¸¸å·¥ç¨‹ç»éªŒçš„ã€‚RocksDB çš„éƒ¨ç½²ä¸­å‡ºç°äº†å¾ˆå¤š failure ç›¸å…³çš„ç»éªŒæ•™è®­ï¼Œåœ¨æ„å»ºé²é‚¦ç³»ç»Ÿä¸­ï¼Œè¿™äº›éƒ½éœ€è¦å­¦ä¹ çš„</li></ol><h2 id="SSD-LSM"><a href="#SSD-LSM" class="headerlink" title="SSD / LSM"></a>SSD / LSM</h2><p><img src="https://image.mwish.me/blog-image/output-2.png" alt="Figure-1"></p><p>LSM æœ¬èº«è¢«è®¤ä¸ºæ˜¯é¡ºåºå†™ï¼Œç›¸å¯¹æ¥è¯´å¯¹ SSD ä¼šå‹å¥½ä¸€äº›ï¼ˆä¸æ WiscKeyï¼‰ã€‚RocksDB çš„ä¸»è¦æ¶æ„å¦‚ä¸Šå›¾ï¼š</p><ol><li>WAL</li><li>MemTable</li><li>SSTable<ol><li>ï¼ˆåœ¨ä»»ä½• Compaction ä¸‹ï¼‰L0 éƒ½å…è®¸é‡å¤çš„ Range</li><li>SST æœ‰å¯¹åº”çš„ BF ï¼ˆåé¢ä¹Ÿæ‘¸å‡ºäº†å¾ˆå¤šåˆ«çš„ç´¢å¼•ï¼‰</li><li>å¤šç§ Compactionï¼Œå¦‚ä¸‹å›¾ã€‚RocksDB ç”¨ Compaction çš„æ–¹å¼æ¥åè°ƒ RUM / å†™æ”¾å¤§ä¹‹ç±»çš„å‚æ•°ï¼Œæ¥å®ç°ä¸€äº›å…·ä½“çš„ tunning / ä¼˜åŒ–ã€‚<ol><li>Level: æ­£å¸¸çš„ LevelDB é‚£ç§å‹ç¼©ã€‚</li><li>Tiered: Universal Compactionã€‚RocksDB ä½¿ç”¨äº† L0 å±‚çš„ç‰¹æ€§æ¥å®ç°å®ƒ</li><li>FIFO: å¯¹ In-memory caching ä½¿ç”¨ï¼ŒæŒ‰ç…§ä¸€å®šé¡ºåºæ¸…é‡å‹ç¼©ï¼Œpurge æ‰ä¸€äº›æ—§çš„æ–‡ä»¶ã€‚é€‚åˆç”¨æ¥å®ç°ä¸€äº›ç±»ä¼¼ cache è¿™æ ·å¯ä»¥ discard çš„åŠŸèƒ½ã€‚</li></ol></li></ol></li></ol><h3 id="Compaction-ä¼˜åŒ–å²"><a href="#Compaction-ä¼˜åŒ–å²" class="headerlink" title="Compaction ä¼˜åŒ–å²"></a>Compaction ä¼˜åŒ–å²</h3><p><img src="https://image.mwish.me/blog-image/output-3.png" alt="output (3)"></p><p>Compaction æ–¹å¼çš„é€‰æ‹©å¯ä»¥æ ¹æ®åº”ç”¨çš„æ€§è´¨ç”šè‡³å®¢æˆ·çš„ b éœ€æ±‚æ¥é€‰æ‹©ã€‚åŒæ—¶ï¼Œè®ºæ–‡ä»¥å†å²æ¼”åŒ–ã€æ—¶é—´é¡ºåºçš„æ–¹å¼ï¼Œä»‹ç»äº† RocksDB Compaction çš„æ¼”è¿›ã€‚</p><p>æœ€æ—©çš„æ—¶å€™ï¼ŒLevelDB å®ç°äº† Leveled Compactionï¼Œè¿™ç§æ–¹å¼è‡ªç„¶ WA å¾ˆå¤§ã€‚RocksDB å®ç°äº†å¹¶è¡Œ Compaction åï¼Œç£ç›˜å—åˆ°çš„å‹åŠ›æ›´æ˜¯å˜å¤§äº†ã€‚æ‰€ä»¥ï¼Œæœ€æ—©æœŸï¼ŒRocksDB ä¼˜åŒ–çš„ç›®æ ‡æ˜¯ WAã€‚å…³äº RocksDB è§‚å¯Ÿåˆ°çš„æ”¾å¤§ï¼Œé™¤äº† Table 3ï¼Œè¿˜æœ‰ä¸‹å›¾ï¼š</p><p><img src="https://image.mwish.me/blog-image/79e23b93-13bc-4494-bfd6-000fb3e17a80.png" alt="79e23b93-13bc-4494-bfd6-000fb3e17a80"></p><p>è¿™é‡Œç»Ÿè®¡äº†å„å±‚çš„ WAï¼Œæ›´æœ‰æ„ä¹‰ã€‚åŒæ—¶ï¼ŒWA é™¤äº† LSM å±‚çš„æ”¾å¤§ï¼Œè¿˜æœ‰ä¸€äº› WAL çš„æ”¾å¤§ï¼Œå› ä¸º SSD Block æ˜¯ 4/8/16KB ç­‰å¤§å°å¯¹é½çš„ï¼Œæ‰€ä»¥ WAL å†™ + Sync åœ¨ block-io å±‚å…¶å®æ˜¯å¾ˆé‡çš„ï¼Œå¯èƒ½ä¼šæœ‰æˆç™¾å€çš„å†™æ”¾å¤§ã€‚åŒæ—¶ï¼ŒLeveled Compaction ä¼šå¤§æ¦‚å¯¹åº” 10-30 å€å†™æ”¾å¤§ã€‚æ€»ä¹‹ï¼ŒRocksDB å¸Œæœ›ä¼˜åŒ– WAã€‚</p><p>è¿™é‡Œ RocksDB å¼•å…¥äº† Tiered Compactionï¼Œå³ <strong>Universal Compaction</strong>. ä¸‹é¢æ˜¯ ZippyDB å’Œ MyRocks å¼•å…¥ Tiered Compaction ä¹‹åçš„æƒ…æ™¯ï¼š</p><p><img src="https://image.mwish.me/blog-image/9838ec55-a634-4b87-a352-ec9ff85fdb81.png" alt="9838ec55-a634-4b87-a352-ec9ff85fdb81"></p><p>RocksDB çš„ä½¿ç”¨è€…åœ¨å†™å…¥å‰§çƒˆçš„æ—¶å€™ï¼Œé€šå¸¸ä¼šä½¿ç”¨ Universal Compactionï¼Œè¯»è¦æ±‚é«˜ä¼šä½¿ç”¨ Leveled Compactionã€‚</p><p>WA ä¼˜åŒ–å®Œäº†ï¼Œä¸‹é¢ä¼˜åŒ– Spaceã€‚è¯»è€…å¯èƒ½æ‡µé€¼äº†ï¼ŒLeveled Compaction ä¸æ˜¯æœ¬æ¥ Space æ”¾å¤§å°±å¾ˆå°å—ï¼Ÿè¿™é‡Œå…¶å®è¿˜æ¶‰åŠä¸€ç¯‡è®ºæ–‡: </p><p><a href="https://research.facebook.com/publications/optimizing-space-amplification-in-rocksdb/">https://research.facebook.com/publications/optimizing-space-amplification-in-rocksdb/</a></p><p>RocksDB çš„è®¾è®¡è€…ä»¬è®¤ä¸ºï¼Œå®é™…ä¸Šï¼Œå¯¹å¤§éƒ¨åˆ†ç”¨æˆ·æ¥è¯´ï¼ŒRocksDB ä¸Šå±‚å’Œ SSD å†™å¼€é”€éƒ½ç”¨ä¸åˆ°ä¸Šé™ï¼Œ<strong>å¤§éƒ¨åˆ†åº”ç”¨æ ¹æœ¬ä¸ä¼šé‚£ä¹ˆæç«¯çš„å»å†™ã€‚å¯¹å¤§éƒ¨åˆ†åº”ç”¨æ¥è¯´ï¼Œåˆ©ç”¨ç©ºé—´æ˜¯æ¯”è¾ƒé‡è¦çš„äº‹æƒ…ï¼Œè¿™æ ·å¯èƒ½èƒ½æä¾›æ›´å¤šçš„èµ„æºåˆ©ç”¨ã€‚</strong></p><p>å› ä¸º Leveled Compaction å·²ç»æ˜¯ç©ºé—´ä¼˜åŒ–çš„äº†ï¼Œæ‰€ä»¥ RocksDB æå‡ºäº† <strong>Dynamic Leveled Compaction:</strong></p><ul><li>æ¯å±‚çš„å¤§å°ä¼šæ ¹æ®æœ€åä¸€å±‚çš„å¤§å°åŠ¨æ€è°ƒæ•´</li><li>ç›¸å¯¹é…ç½®æ­»çš„ Leveled Compactionï¼Œæ›´æœ‰ç©ºé—´åˆ©ç”¨ç‡</li><li>Leveled Compaction å¦‚æœé…ç½®æ­»ï¼Œå¾ˆå¤šæ—¶å€™ä¼š fallback åˆ°å¾ˆå¥‡æ€ªçš„æƒ…å†µï¼Œæ¯”å¦‚å…ˆè½æ·±å±‚ï¼Œå†è½æµ…å±‚ï¼Œç„¶åå·¥ç¨‹ä¸Šæ”¾å¤§å…¶å®æ¯”è¾ƒå¤§ï¼ŒRocksDB è¯´æœ€å¤§æœ‰å¤§æ”¹ 90%ã€‚å¯¹äº Dynamic Leveled Compactionï¼Œç”¨æˆ·å¯ä»¥è·å¾—å¾ˆç¨³å®šçš„å‹ç¼©ç‡</li><li>å¼€å¯äº†è¿™ä¸ªåŠŸèƒ½ä¹‹åï¼Œåœ¨ UDB ä¸­ï¼Œç©ºé—´å ç”¨æ¯” InnoDB é™ä½äº† 50%ã€‚</li></ul><p><img src="https://image.mwish.me/blog-image/Table-4.png" alt="Table-4"></p><p>RocksDB æ¥ä¸‹æ¥å¸Œæœ›ä¼˜åŒ– CPUï¼ˆæˆ‘ä¼°æ‘¸ç€å¤šå°‘å› ä¸ºä¹‹å‰å¤šçº¿ç¨‹å†™æœ‰äº›ç²—æš´äº†ï¼‰ã€‚ä¸åŒé…ç½®çš„æœºå™¨ã€ä¸åŒçš„è´Ÿè½½ï¼ŒCPU / SSD ç“¶é¢ˆå…¶å®æ˜¯ä¸ä¸€æ ·çš„ã€‚è™½ç„¶è¿™ä¹ˆè¯´ï¼Œä¸è¿‡ä»¥å‰ HDD æˆ–è€… SSD æ¯”è¾ƒç³Ÿå¿ƒçš„æ—¶å€™ï¼Œç“¶é¢ˆä¸€èˆ¬ä¼šå‡ºç°åœ¨ç›˜ä¸Šï¼Œä½†éšç€ç›˜æ€§èƒ½å˜å¥½ï¼Œåœ¨æœ‰äº›é…ç½®ä¸Šï¼Œå¯èƒ½ç“¶é¢ˆä¼šå¼€å§‹å‡ºç°åœ¨ CPU ä¸Šäº†ï¼ˆRocksDB è®ºæ–‡é‡Œä¹Ÿè¯´ï¼Œä»–ä»¬ç›˜ä¸€èˆ¬ä¸æ˜¯é‚£ä¹ˆå¥½æ‰“æ»¡ï¼Œå¤§éƒ¨åˆ†æƒ…å†µç“¶é¢ˆä¸ä¸€å®šåœ¨ç›˜ä¸Šï¼Œä¸è¿‡æˆ‘è§‰å¾—ç“¶é¢ˆåœ¨ç›˜ä¸Šå¯èƒ½æ˜¯ä¸ªå¾ˆå¤æ€ªçš„äº‹æƒ…ï¼Œä¾‹å¦‚ queuing ç®—ä¸ç®—ç›˜ä¸Š io é€ æˆå½±å“å¤§å‘¢ï¼Ÿï¼‰ã€‚å¦‚å›¾ï¼š</p><p><img src="https://image.mwish.me/blog-image/836223A7-DB77-45E3-885F-3AA6CF743929.png" alt="836223A7-DB77-45E3-885F-3AA6CF743929"></p><p><img src="https://image.mwish.me/blog-image/836223A7-DB77-45E3-885F-3AA6CF743929.png" alt="836223A7-DB77-45E3-885F-3AA6CF743929"></p><p>è‡³å°‘ï¼Œåœ¨ Facebook éƒ¨ç½² ZippyDB çš„åœºæ™¯ä¸­ï¼ŒCPU å¼€å§‹ä¸€å®šç¨‹åº¦ä¸Šæˆä¸ºç“¶é¢ˆï¼š</p><p><img src="https://image.mwish.me/blog-image/A5A6FEC9-C5A8-404E-8FD5-D74CBAD3A627.png" alt="A5A6FEC9-C5A8-404E-8FD5-D74CBAD3A627"></p><p>åœ¨è¿™ç§æƒ…å†µä¸‹ï¼š</p><ul><li>å¯èƒ½å¯ä»¥é‡‡ç”¨æ›´è½»çš„å‹ç¼©ç­–ç•¥</li><li>ä¸é€‚åˆ SSDï¼Œå› ä¸ºå¯èƒ½æ“¦å†™å¤ªå¤šæå SSD äº†</li></ul><p>RocksDB å¯ä»¥é…ç½®å‹ç¼©ç›¸å…³é…ç½®ï¼Œå’Œ Hash-map ç›¸å…³çš„ memtable / Fileï¼Œæ¥ä¼˜åŒ– CPU</p><h3 id="RocksDB-å’Œæ–°æŠ€æœ¯"><a href="#RocksDB-å’Œæ–°æŠ€æœ¯" class="headerlink" title="RocksDB å’Œæ–°æŠ€æœ¯"></a>RocksDB å’Œæ–°æŠ€æœ¯</h3><ol><li>Open-channel SSD, multi-stream SSD, ZNS:<ol><li>æä¾›äº†æ›´å¥½çš„ SSD ç®¡ç†ï¼Œé™ä½ Query Latencyï¼Œå‡å°‘ flash erase cycles</li><li>åªæœ‰å°‘æ•°åº”ç”¨èƒ½æœ‰ä¼˜åŒ–ï¼ŒåŒæ—¶ç»´æŠ¤éº»çƒ¦å¾ˆå¤§</li><li>è§ RFCï¼š è¿™éƒ¨åˆ†ç›®å‰åœ¨å¤–éƒ¨ç»´æŠ¤ã€‚æœªæ¥å¯èƒ½ä¼šæŠ½å‡ºä¸€ä¸ª FS å±‚ï¼ˆç±»ä¼¼ arrow::fs? )</li><li><a href="https://github.com/facebook/rocksdb/pull/6961">https://github.com/facebook/rocksdb/pull/6961</a></li></ol></li><li>In-Storage Computing:<ol><li>å¹¶ä¸çŸ¥é“æ”¶ç›Šæœ‰å¤šå¤§</li><li>API ç›¸å…³çš„è®¾è®¡æš‚æ—¶ä¸å¥½å†³å®š</li></ol></li><li>Disaggregated (remote) storage:<ol><li>èƒ½å¤Ÿåˆ©ç”¨å¥½ CPU / SSD èµ„æº ï¼ˆæ± åŒ–ï¼Ÿï¼‰</li><li>éœ€è¦å¤„ç† IO Latency å’Œä¸‹å±‚ QoS</li><li>ï¼ˆæ˜¯ä¸æ˜¯å¯ä»¥å‚è€ƒ CloudJump ?ï¼‰</li></ol></li><li>Storage Class Memory (å·²ç»äº¡æ•…çš„å‚²è…¾?ï¼‰<ol><li>æ‰©å±• DRAMï¼Œä½†æ˜¯å®ç° block cache å’Œ memtable ä¼šæ¯”è¾ƒéš¾</li><li>è®¾è®¡ä¸ºä¸»è¦å­˜å‚¨ï¼šé€šå¸¸ IO æ²¡é‚£ä¹ˆæ˜¯ç“¶é¢ˆï¼ˆè™½ç„¶æ„Ÿè§‰å»¶è¿Ÿæœ‰é—®é¢˜ï¼Œä½†æ˜¯æ„Ÿè§‰å› ä¸ºå»¶è¿Ÿæ¢ï¼Œæˆæœ¬ä¹Ÿå¤ªé«˜äº†ï¼‰</li><li>ä½œä¸º WALï¼šå¯èƒ½éœ€è¦é¢å¤–è®¾è®¡ä¸€éƒ¨åˆ† Staging Areaï¼Œç±»ä¼¼ WAS?</li></ol></li></ol><h3 id="å›é¡¾"><a href="#å›é¡¾" class="headerlink" title="å›é¡¾"></a>å›é¡¾</h3><p>ç›®å‰ï¼ŒSSD çš„ä»·æ ¼è¿˜æ²¡æœ‰é‚£ä¹ˆä½ï¼Œå°½ç®¡å¤§å®¶ç”»é¥¼ä»–çš„ä»·æ ¼ä¼šå¾ˆä½ï¼Œä½†æ˜¯ SSD å­˜å‚¨å¯†åº¦ä¹‹ç±»çš„è¿˜æ˜¯ä¸å¦‚ HDDï¼ŒåŒæ—¶ä»·æ ¼è¿˜æ˜¯æ²¡æœ‰é‚£ä¹ˆå»‰ä»·ï¼Œæ‰€ä»¥å¯¹å¤§éƒ¨åˆ†ç”¨æˆ·æ¥è¯´ï¼ŒèŠ‚çœç©ºé—´å’Œ WA è¿˜æ˜¯æ¯”è¾ƒé‡è¦çš„ã€‚</p><p>ä¸ç®¡æ€ä¹ˆæ ·ï¼ŒRocksDB éƒ½æä¾›äº†è¶³å¤Ÿå¤šçš„é€‰é¡¹ã€‚æ­¤å¤–ï¼Œå¯¹äºå¤§ Valueï¼ŒRocksDB è¿˜å¼€å‘å¹¶é‡æ–°å¼€å‘äº† BlobDBï¼Œæ¥å‡å°‘å¤§ Value é€ æˆçš„ WAã€‚</p><h2 id="åœ¨å¤§è§„æ¨¡åˆ†å¸ƒå¼ç³»ç»Ÿä¸Šçš„ç»éªŒ"><a href="#åœ¨å¤§è§„æ¨¡åˆ†å¸ƒå¼ç³»ç»Ÿä¸Šçš„ç»éªŒ" class="headerlink" title="åœ¨å¤§è§„æ¨¡åˆ†å¸ƒå¼ç³»ç»Ÿä¸Šçš„ç»éªŒ"></a>åœ¨å¤§è§„æ¨¡åˆ†å¸ƒå¼ç³»ç»Ÿä¸Šçš„ç»éªŒ</h2><p>RocksDB æœ¬èº«å¹¶ä¸æ˜¯ä¸€ä¸ªå¤§è§„æ¨¡åˆ†å¸ƒå¼ç³»ç»Ÿï¼Œåªæ˜¯ä¸€ä¸ªç”¨åˆ°æŒ‚è½½ç›˜çš„åº“ã€‚ä½†æ˜¯ RocksDB çš„ç”¨æˆ·å¾ˆå¤šæ˜¯éœ€è¦å¦¥å–„ç»´æŠ¤çš„å¤§è§„æ¨¡åˆ†å¸ƒå¼ç³»ç»Ÿï¼Œæ–‡ç« åœ¨ä¸‹é¢å‡ ç‚¹ä¸Šè¿›è¡Œäº†ä»‹ç»ï¼š</p><ul><li>èµ„æºç®¡ç†</li><li>WAL å¤„ç†</li><li>æ–‡ä»¶æ‰¹é‡åˆ é™¤</li><li>æ•°æ®æ ¼å¼å…¼å®¹æ€§</li><li>Configuration Management</li></ul><h3 id="èµ„æºç®¡ç†"><a href="#èµ„æºç®¡ç†" class="headerlink" title="èµ„æºç®¡ç†"></a>èµ„æºç®¡ç†</h3><p>å¯¹äº Shared-nothing æ¶æ„ï¼Œå•å°æœºå™¨ä¸€èˆ¬ä¼šæœ‰å¾ˆå¤š RocksDB Instanceï¼Œæ¯ä¸ªæœåŠ¡ä¸€ä¸ª Shardã€‚åœ¨å®è·µä¸­ï¼ŒShard çš„é‡çº§ä¸€èˆ¬æ˜¯æ•°åç”šè‡³æ•°ç™¾çš„ã€‚è¿™ä¸ªæ—¶å€™ï¼Œèµ„æºå…±äº«å’Œé™åˆ¶å°±å˜å¾—å¾ˆé‡è¦äº†ã€‚è¿™é‡Œå¯ä»¥é…ç½®çš„èµ„æºæœ‰ï¼š</p><ul><li>MemTable / Block Cache çš„å†…å­˜</li><li>Compaction çš„ IO å¸¦å®½</li><li>Compaction çš„çº¿ç¨‹æ•°ç›®</li><li>ç£ç›˜æ€»ç”¨é‡</li><li><em>æ–‡ä»¶åˆ é™¤ç‡</em><ul><li>è¿™é‡Œå’Œ SSD TRIM çŠ¶æ€æœ‰å…³ï¼Œè§åæ–‡</li></ul></li></ul><p>RocksDB å…è®¸å®šä¹‰ä¸€ä¸ªåº“çš„å±€éƒ¨èµ„æºç®¡ç†ï¼ˆResource Controllerï¼‰ï¼Œæ¥ç®¡ç†èµ„æºï¼Œeg:</p><ul><li><a href="https://github.com/facebook/rocksdb/blob/main/db/write_controller.h">https://github.com/facebook/rocksdb/blob/main/db/write_controller.h</a></li></ul><p>è¿™å…è®¸ä½œå‡ºä¸€äº›ä¸Šå±‚æ§åˆ¶å®šä¹‰ã€‚æ­¤å¤–ï¼Œè¿™é‡Œæ˜¯åº“çº§åˆ«çš„å¤„ç†ï¼Œæœºå™¨çº§åˆ«çš„å¤„ç†ä¼šéš¾å¾—å¤šï¼Œå› ä¸ºæ¶‰åŠä¸€ä¸ªå…¨å±€èµ„æºçš„ç®¡ç†ã€‚å› ä¸ºæ¯ä¸ª Instance åœ¨å½“å‰å®ç°ä¹Ÿä¸ä¼šç®¡åˆ«çš„ä¿¡æ¯ï¼Œè¿™é‡Œæåˆ°äº†ä¸¤ç§ admission control å’Œèµ„æºç­–ç•¥ï¼š</p><ul><li>ä¸€å¼€å§‹ä½¿ç”¨ Compaction ç‡ä½ï¼Œåªæœ‰æœ‰ lag æ‰æ‹‰å¤§é¢‘ç‡<ul><li>ä¸ä¸€å®šèƒ½æ§åˆ¶å¥½ï¼Œè€Œä¸”è¿™ä¸ªä¼šå¯¼è‡´ä¸€èˆ¬çš„èµ„æºåˆ©ç”¨ç‡æ¯”é¢„æœŸä½</li></ul></li><li>åœ¨å¤šä¸ª Instance ä¸­é—´å…±äº«èµ„æºå¼€é”€</li></ul><p>è¿™é‡Œä¹Ÿæåˆ°ï¼Œå¯¹äº CPU èµ„æºï¼Œå¯ä»¥é€‚å½“ä½¿ç”¨æ± åŒ–çš„å†…å­˜ï¼Œè¿™æ ·å¯ä»¥è®©ç³»ç»Ÿçº¿ç¨‹æ•°ä¸è‡³äºè¿‡å¤šã€‚ï¼ˆæ„Ÿè§‰è¿™ç§äº‹è¦æ±‚åšæ›´ç²¾ç»†çš„è°ƒåº¦ï¼Œç„¶åä»ç³»ç»Ÿå±‚ç§»åŠ¨åˆ° RocksDB å±‚ï¼‰ã€‚</p><h3 id="WAL-ç®¡ç†"><a href="#WAL-ç®¡ç†" class="headerlink" title="WAL ç®¡ç†"></a>WAL ç®¡ç†</h3><p>å•æœºæ•°æ®åº“é€šå¸¸éœ€è¦å¼€å¯ <code>sync</code> æ¨¡å¼ï¼Œä½†æ˜¯åˆ†å¸ƒå¼æ•°æ®åº“å¯èƒ½å†™äº†ä¸‰å‰¯æœ¬ï¼Œåœ¨å•æœºçš„è¦æ±‚ä¸Šï¼Œå¯èƒ½äººå®¶é›†ç¾¤ä¼˜åŒ–çš„ä¸å¥½ï¼Œå¯¼è‡´è¦å¼€ asyncã€‚åŒæ—¶ï¼Œå¯èƒ½ä¹Ÿæœ‰åˆ†å¸ƒå¼ç³»ç»ŸåªæŠŠ RocksDB å½“æˆå­˜å‚¨ï¼Œç„¶å<strong>å†™è‡ªå·±çš„æ—¥å¿—</strong>ï¼Œè¿™ä¸ªæ—¶å€™ä¹Ÿä¼šæŠŠ sync å…³æ‰ã€‚è¿™é‡Œå¼•å…¥äº†ä¸‹åˆ—æ¨¡å¼ï¼š</p><ul><li>NO-WAL</li><li>Buffered WAL</li><li>Sync</li></ul><h3 id="æ–‡ä»¶åˆ é™¤é™åˆ¶"><a href="#æ–‡ä»¶åˆ é™¤é™åˆ¶" class="headerlink" title="æ–‡ä»¶åˆ é™¤é™åˆ¶"></a>æ–‡ä»¶åˆ é™¤é™åˆ¶</h3><p>æ–‡ä»¶è¿™ä¸ªæ¦‚å¿µæ˜¯åœ¨ os å’Œ fs å±‚å¼•å…¥çš„æŠ½è±¡ã€‚åƒ XFS è¿™æ ·çš„ SSD å¤„ç†çš„æ¯”è¾ƒå¥½çš„ FSï¼Œä¸€èˆ¬å¯èƒ½ä¼šåœ¨åˆ é™¤æ–‡ä»¶çš„æ—¶å€™ç»™ FTL ä¹‹ç±»çš„å‘ TRIMã€‚TRIM å¯ä»¥é€è¿‡æ–‡ä»¶å±‚å‘Šè¯‰ SSDï¼Œè¿™éƒ¨åˆ†æ•°æ®å·²ç»ä¸éœ€è¦äº†ï¼Œå» issue SSD æ¥è¿›è¡Œå¯èƒ½çš„å›æ”¶ï¼Œé™ä½éœ€è¦çš„ OP çš„å¼€é”€</p><p>è¿™ç§æ–¹æ³•ï¼Œåœ¨ Compaction çš„æ—¶å€™ä¹Ÿæœ‰é—®é¢˜ï¼Œå°±æ˜¯åˆ é™¤æ–‡ä»¶å¤§é‡ TRIM å¯èƒ½è§¦å‘ SSD GCã€‚è¿™é‡Œé€šè¿‡ç”¨æˆ·æµ‹å¾ˆå¥‡æ€ªçš„æ¨æ–­ batch del çš„è¡Œä¸ºï¼Œæ¥é˜²æ­¢è§¦å‘ GCï¼Œå…¶å®è¿˜æ˜¯è›®æ€ªçš„ï¼Œç½‘å‹è¯„ä»·ï¼š</p><p><img src="https://image.mwish.me/blog-image/4f1b4f01-d028-4611-a3b5-18a7461e2267.png" alt="4f1b4f01-d028-4611-a3b5-18a7461e2267"></p><h3 id="æ ¼å¼å…¼å®¹æ€§"><a href="#æ ¼å¼å…¼å®¹æ€§" class="headerlink" title="æ ¼å¼å…¼å®¹æ€§"></a>æ ¼å¼å…¼å®¹æ€§</h3><p>RocksDB æ¯éš”ä¸€ä¸ªæœˆä¼šå‘ä¸€æ¬¡å°ç‰ˆæœ¬ï¼Œç”±äº CD çš„æƒ…å†µï¼Œæ–°ç‰ˆæœ¬å¦‚æœæœ‰ bugï¼Œä¹Ÿéœ€è¦å›æ»šã€‚è¿™ä¸ªæå‡ºäº†æ ¼å¼å…¼å®¹æ€§çš„è¦æ±‚ã€‚RocksDB é™¤äº†å¼€å‘æ–°åŠŸèƒ½ä¸€èˆ¬ä¼šä¿è¯æ ¼å¼ä¸å˜ï¼ŒåŒæ—¶ï¼Œä¸èƒ½åˆ é™¤æ—§ç‰ˆæœ¬ä»£ç ä¸­å¯¹æ ¼å¼çš„å…¼å®¹ã€‚</p><p>RocksDB ä¹Ÿä¼šé‡‡å–å‰å‘å…¼å®¹ï¼Œè¿™ä¸ªå°±æ›´éš¾äº†ã€‚è¿™é‡Œä¼šæœ‰ä¸€äº›ç±»ä¼¼ Protobuf ä¹‹ç±»çš„æœºåˆ¶æ¥ä¿è¯ï¼ŒRocksDB è‡³å°‘èƒ½æ‰“å¼€ä¸€å¹´å†…çš„æœªæ¥å†™çš„æ–‡ä»¶ã€‚è¿™ä¸ªæ„Ÿè§‰éœ€è¦åœ¨è®¾è®¡ä¸Šä¸‹åŠŸå¤«ï¼ŒåŒæ—¶æ„Ÿè§‰ä¹Ÿå¯èƒ½å’Œå„ç§é…ç½®ä¹‹ç±»çš„æœ‰å…³ã€‚</p><p>ï¼ˆæˆ‘ä¸ªäººçš„ä½“éªŒæ˜¯ï¼šå…ˆå†™å¥½æ–°æ ¼å¼ä»£ç ï¼Œæµ‹è¯•å®Œå–„åå†ä¸Šçº¿ï¼Œä¸Šçº¿ä¹‹å‰ï¼Œæ–°æ—§ç‰ˆæœ¬éƒ½æ”¯æŒè¯»è¿™ä»½æ ¼å¼ï¼‰ã€‚</p><h3 id="Manage-Configurations"><a href="#Manage-Configurations" class="headerlink" title="Manage Configurations"></a>Manage Configurations</h3><p>LevelDB çš„é…ç½®ç®¡ç†æ˜¯æ¯”è¾ƒç®€å•çš„ï¼ŒLevelDB ä¼šæŠŠ Version ç›¸å…³çš„é€»è¾‘åšåˆ° VersionSet é‡Œå¤´ï¼š</p><ul><li><a href="https://github.com/mapleFU/mwish-leveldb-notes/blob/master/db/version_set.h#L362-L363">https://github.com/mapleFU/mwish-leveldb-notes/blob/master/db/version_set.h#L362-L363</a></li></ul><p>RocksDB æœ‰å¾ˆå¤šå¯ä»¥æ›´æ”¹çš„é…ç½®ï¼Œè¿™äº›é…ç½®å·²ç»éå¸¸å¤æ‚äº†ï¼Œé¦–å…ˆï¼Œåœ¨æ­£ç¡®æ€§æ ¡éªŒä¸Šï¼ŒRocksDB åœ¨ <code>New</code>ä¹‹åå¯èƒ½ä¼šè®°å½•é…ç½®ï¼Œç„¶åï¼Œä¹‹åæ‰“å¼€çš„æ—¶å€™ï¼Œä¼šæ ¹æ®ç”¨æˆ·çš„ Options å¯¹æ¯”è¿™äº›é…ç½®ï¼ŒæŸ¥çœ‹ï¼š</p><ul><li>æ‰“å¼€çš„é…ç½®å’Œè¿™ä¸ªæ–‡ä»¶æ˜¯å¦å…¼å®¹</li><li>å¦‚æœä¸å…¼å®¹ï¼Œå¯èƒ½ä¼šæœ‰ä¸€ä¸ª rewrite å·¥å…·ï¼Œèƒ½å¤Ÿè¿ç§»åˆ°å…¼å®¹çš„é…ç½®ä¸Š</li></ul><p>æ­¤å¤–ï¼Œä¸€ä¸ªå¾ˆå¤æ‚çš„äº‹æƒ…æ˜¯ï¼ŒRocksDB çš„å‚æ•°å¾ˆå¤æ‚ã€‚æœ¬æ¥è¿™äº›ä¸œè¥¿å¯ä»¥é»˜è®¤å‚æ•°ï¼ˆDynamoDB è®ºæ–‡é‡Œè¯´ä»–ä»¬éƒ½æ²¡å•¥å¯¹å¤–å‚æ•°ï¼Œè™½ç„¶æˆ‘è§‰å¾—å¾ˆç„ï¼‰ã€‚åŒæ—¶ï¼Œä»–ä»¬ä½œä¸ºä¸€ä¸ªåº“ï¼Œåªèƒ½æä¾›å‚æ•°å‡ºå»ï¼Œè®©ä¸Šå±‚å»å¡«ã€‚è¿™ä¸ªåœ°æ–¹ç»´æŠ¤è¿™äº›å‚æ•°è¿˜æ˜¯å¾ˆå¤æ‚çš„ã€‚RocksDB å›¢é˜Ÿè¡¨ç¤ºï¼Œä¼šè€ƒè™‘ automatic adaptivityï¼Œä½†æ˜¯è¿™æ ·åŠ¨æ€è°ƒæ•´å‚æ•°ä¹Ÿæ˜¯éå¸¸å¤æ‚çš„ã€‚</p><h3 id="Backup-amp-Replication"><a href="#Backup-amp-Replication" class="headerlink" title="Backup &amp; Replication"></a>Backup &amp; Replication</h3><p>RocksDB æœ‰å‡ ç§ copying æ–¹å¼ï¼š</p><ul><li>Logical Copying<ul><li>æºç«¯ï¼šScan å‡ºæ¥ï¼ˆå°½é‡ä¸ fill cache æˆ–è€…å¡«å……ä¸€äº›ä¸éœ€è¦çš„ Compaction Statisticsï¼‰</li><li>ç›®æ ‡ç«¯ Bulk Loading</li></ul></li><li>Physical Copying: Copying SST and Ingest<ul><li>æä¾›è‡ªèº«çš„å·¥å…·ï¼Œå»åš SST Ingest</li><li>è¿™é‡Œéœ€è¦å€Ÿç”¨æ–‡ä»¶çš„è¯­ä¹‰ï¼Œæ‰€ä»¥ RocksDB è®¤ä¸ºï¼ŒBlock Device ä¸Šåšï¼Œè¿™å¥—ä¾¿æ·ç¨‹åº¦è¿˜æ˜¯ä¸å¦‚ FS ä¸Šåšã€‚</li></ul></li></ul><p>RocksDB ç”šè‡³æä¾›äº†ä¸€ä¸ª Backup Engineï¼Œå› ä¸º Backup å¯èƒ½æœ‰å¤šä»½ï¼š<a href="http://rocksdb.org/blog/2014/03/27/how-to-backup-rocksdb.html">http://rocksdb.org/blog/2014/03/27/how-to-backup-rocksdb.html</a> ã€‚ç”¨æˆ·å¯ä»¥åœ¨ Backup Engine ä¸Šåšè‡ªå·±çš„å®ç°ã€‚</p><p>è¿™äº›ä¸œè¥¿åœ¨ API ä¸Šéƒ½æœ‰ä¸€å®šçš„å¤æ‚æ€§ï¼š</p><ol><li>æŠŠä¸€ä¸ª Ordered Seq ç»™é‡æ”¾</li><li>ä¸æ˜¯é‚£ä¹ˆåœ¨æ„ Order çš„é‡æ”¾</li></ol><p>è¿™é‡Œæœ‰ä¸€ä¸ªé—®é¢˜æ˜¯ï¼Œä¸åŒäº Dgraph çš„ Badgerï¼Œç›®å‰ RocksDB è¿˜ä¸èƒ½ Take ä¸€ä¸ª user-defined Timestampï¼Œç„¶å Out-of-Order å†™ã€‚</p><h2 id="é”™è¯¯å¤„ç†"><a href="#é”™è¯¯å¤„ç†" class="headerlink" title="é”™è¯¯å¤„ç†"></a>é”™è¯¯å¤„ç†</h2><p>é”™è¯¯å¤„ç†æ˜¯åªè¦åœ¨å¤§å…¬å¸ç¢°è¿‡ SB ç¡¬ä»¶å°±ä¸€å®šä¼šé‡åˆ°çš„é—®é¢˜ã€‚RocksDB æœ‰æ¯”è¾ƒå¤šçš„ç»éªŒæ¥åšç›¸å…³çš„é”™è¯¯å¤„ç†ã€‚</p><p>RocksDB åœ¨é”™è¯¯å¤„ç†ä¸Šæœ‰ä¸¤ä¸ªå±‚æ¬¡ï¼š</p><ol><li>ç»™æ‰€æœ‰å¯èƒ½ corrupt çš„åœ°æ–¹åš checksum</li><li>æ£€æŸ¥é”™è¯¯ï¼Œå°½æ—©å‘ç°é”™è¯¯ï¼Œé˜²æ­¢é™é»˜é”™è¯¯å½±å“å‰¯æœ¬æˆ–è€…åœ¨åˆ«çš„é“¾è·¯ä¸Šå½±å“é›†ç¾¤</li><li>ç»´æŠ¤æŠ›å‡ºé”™è¯¯çš„åˆé€‚è¯­ä¹‰</li></ol><p>RocksDB é¢ä¸´ç€ä¸‹é¢çš„é”™è¯¯ï¼š</p><ul><li>SSD ç›˜æ•…éšœ<ul><li>ç”±äºæ€§èƒ½åŸå› ï¼Œç”¨æˆ·å¯èƒ½ä¸ä¼šå¼€å¯ DIF/DIX ç­‰æ ¡éªŒæ–¹å¼</li></ul></li><li>å†…å­˜ / CPU æ•…éšœï¼šå‘ç°åŸå› è¾ƒå°‘ï¼Œä¸è¿‡æˆ‘å§‘ä¸”ä¹Ÿç¢°åˆ°è¿‡å‡ æ¬¡</li><li>è½¯ä»¶æ•…éšœï¼ˆå˜¿å˜¿ï¼Œå¾ˆå¸¸è§çš„ï¼Œæˆ‘ç¢°åˆ°è¿‡å¾ˆè›‹ç–¼çš„ï¼‰</li><li>ç½‘ç»œä¼ è¾“çš„æ—¶å€™äº§ç”Ÿçš„é—®é¢˜ï¼ˆç½‘å¡ç­‰ï¼‰</li></ul><p>æ ¹æ® RocksDB çš„ç»Ÿè®¡ï¼š</p><ul><li>åœ¨ FBï¼Œæ¯ 100PB æ•°æ®ï¼Œä¸€ä¸ªæœˆä¼šå‡ºç°ä¸‰æ¬¡ corrupt<ul><li>40% çš„æƒ…å†µä¸‹ï¼Œè¿™äº› Corrupt å·²ç»æ‰©æ•£åˆ°äº†åˆ«çš„æœºå™¨ä¸Š</li></ul></li><li>ç½‘ç»œç³»ç»Ÿå¯èƒ½ä¼šæœ‰æ¯ PB 17æ¬¡ checksum mismatch ï¼ˆfbâ€¦ è¿™ä¹ˆç‰›é€¼çš„å—ï¼‰</li></ul><p>åŸºäºä»¥ä¸Šçš„æƒ…å†µï¼ŒFB è®¤ä¸ºï¼Œéœ€è¦å°½æ—©æ‰¾åˆ° Corruptï¼Œæ¥å‡å°‘å› ä¸º Corrupt äº§ç”Ÿçš„ Downtimeã€‚åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œè¿˜æ˜¯èƒ½å¤Ÿç”¨æ­£ç¡®å‰¯æœ¬ä»£æ›¿é”™è¯¯å‰¯æœ¬æ¥ä¿®æ­£æ•°æ®çš„ï¼š</p><p><img src="https://image.mwish.me/blog-image/Figure-4.png" alt="Figure-4"></p><p>è¿™é‡Œåœ¨ LevelDB çš„ Block Checksum å’Œ WAL Checksum ä¹‹å¤–ï¼Œæä¾›äº†ä¸å°‘å±‚æ¬¡çš„ Checksumï¼Œå¦‚ä¸Šå›¾ã€‚ï¼š</p><ol><li>Block Integrity:<ol><li>SST Block å’Œ WAL Block ä¼šå¸¦æœ‰ crc</li><li>æ¯æ¬¡è¯»ï¼ŒåŒ…æ‹¬ SST Ingestï¼Œbulk loading éƒ½è¦éªŒ</li></ol></li><li>File Integrity:<ol><li>SST æ–‡ä»¶æœ¬èº«ä¼šè¢« Crc ä¸€å±‚ï¼Œå› ä¸ºæœ‰çš„æ—¶å€™ä¼šèµ°æ–‡ä»¶æ•´ä¸ªä¼ è¾“ï¼Œä½†æ˜¯ WAL ç›®å‰è¿˜æ²¡æœ‰</li></ol></li><li>Handoff Integrity:<ol><li>æ•°æ®ç®—å®Œäº†ä¼šç»™ Write API ä¸€ä»½ï¼Œåœ¨æ”¶åˆ°ä¸€ç«¯åš checkã€‚è¿™ä¸ªåœ¨ Oracle ASM ä¹‹ç±»çš„ç³»ç»Ÿå®ç°äº†ã€‚</li></ol></li></ol><p>RocksDB ä¼šåšä¸Šé¢çš„ä¿æŠ¤ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œå†…å­˜é€»è¾‘ä¸Šï¼ŒMemTable ä¹‹ç±»çš„æ²¡æœ‰ä¿æŠ¤ã€‚RocksDB ä¼šç¼–ç  Per-Key-Value-Pair çš„ checksumï¼Œæ¥å®Œæˆä¸Šå±‚çš„ä¿æŠ¤ï¼Œé˜²æ­¢å†™å…¥çš„æ—¶å€™å‡ºç°é”™è¯¯ã€‚</p><p>æ­¤å¤–ï¼ŒRocksDB çš„å“²å­¦ä¼šï¼š</p><ol><li>å°½é‡è¿”å›é”™è¯¯</li><li>å¦‚æœæ˜¯æ— æ³•å•æœºæ¢å¤çš„é”™è¯¯ï¼Œä¸ŠæŠ¥ç»™ç”¨æˆ·ã€‚</li></ol>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>2020.1 - 2020.7</title>
      <link href="/2023/01/01/%E6%88%91%E7%9A%84-2020-%E5%B9%B4/"/>
      <url>/2023/01/01/%E6%88%91%E7%9A%84-2020-%E5%B9%B4/</url>
      
        <content type="html"><![CDATA[<p>2020 å¹´æ˜¯æˆ‘åœ¨å¤§å­¦çš„æœ€åä¸€å¹´ï¼Œä¹Ÿæ˜¯æ¯•ä¸šèµ°å‘ç¤¾ä¼šçš„ç¬¬ä¸€å¹´ï¼Œè¿™ä¸€å¹´å¯¹æˆ‘æ¥è¯´éå¸¸è·Œå®•èµ·ä¼ã€‚æ¯å½“æˆ‘çœ‹åˆ°çŸ¥ä¹çš„æˆåŠŸäººå£«ï¼Œéƒ½ä¼šæƒ³èµ·æˆ‘åœ¨é‚£ä¸€å¹´åˆçš„å¥‡å¦™ç»å†ï¼Œç„¶åäº§ç”Ÿä¸€ç§ç—›è‹¦å’Œæƒ†æ€…çš„æ„Ÿè§‰ã€‚ä¸ªäººçš„å¥‡å¦™ç»å†å…¶å®æ˜¯ä¸è¶³ä¸ºå¤–äººé“ä¹Ÿçš„ï¼Œå› ä¸ºè¯´å‡ºæ¥å°±ä¸æ­¢ä½ è‡ªå·±è§‰å¾—è‡ªå·±æ˜¯å‚»é€¼ï¼Œå¤§å®¶éƒ½è§‰å¾—ä½ æ˜¯å‚»é€¼äº†ã€‚è¿™æœ‰ç‚¹åƒåœ¨äº’è”ç½‘ä¸Šè„±è£¤å­ã€‚ä¸è¿‡äº‹æƒ…éƒ½è¿‡å»ä¸¤å¹´äº†ï¼Œäººæ”¾è‡ªå·±å°æ—¶å€™ä¸ç©¿è£¤å­çš„ç…§ç‰‡é¡¶å¤šä¹Ÿå°±éª‚éª‚ä½ çˆ¶æ¯ä¸æ–‡é›…æ˜¯ä¸æ˜¯ã€‚å“ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä¹Ÿä¸æƒ³è®©è‡ªå·±è¡¨ç°é‚£ä¹ˆå‚»é€¼ï¼Œä¸è¿‡æ—¢ç„¶æˆ‘åˆè ¢åˆç–¾ä¸–æ„¤ä¿—ï¼Œé‚£å¤šè¾“å‡ºç‚¹åƒåœ¾æƒ…ç»ªä¹ŸæŒºå¥½çš„ï¼Œå¥½æ­¹çˆ½äº†</p><p>å½“æ—¶åœ¨ä¸€å®¶å¾ˆä¸é”™çš„æ•°æ®åº“ç›¸å…³çš„å…¬å¸å®ä¹ ï¼Œä¸è¿‡å› ä¸ºåŒäº‹éƒ½å¤ªå‰å®³äº†ï¼Œè€Œæˆ‘é‚£ä¼šå„¿å®Œå…¨ä¸ä¼šå†™ä»£ç ï¼Œæ‰€ä»¥ç”Ÿæ´»çš„å¾ˆç—›è‹¦ã€‚æœ‰ä¸€ç§å¤§å®¶äººéƒ½å¾ˆå¥½ï¼Œå¯¹æˆ‘ä¹Ÿå¾ˆå¥½ï¼Œæœ€å¤§çš„é”™è¯¯å°±æ˜¯æˆ‘å‡ºç°åœ¨äººç¾¤é‡Œçš„æ„Ÿè§‰ã€‚è™½ç„¶æˆ‘æ¯”è¾ƒåŠªåŠ›çš„æƒ³è·Ÿä¸Šå¤§ä¼™å„¿ï¼Œä½†æ˜¯æ°´å¹³æœ‰é™è€Œå¤©èµ„ä¸èªé¢–ï¼Œæˆ‘å¤šå°‘æœ‰ä¸€ç§å¥‡å¦™çš„æ„Ÿè§‰ã€‚å¥‡å¦™æ„Ÿè§‰ä¸€æ˜¯æ„Ÿè§‰è·Ÿæˆ‘ä¸€èµ·å®ä¹ çš„åŒäº‹è¯´çš„ä¸œè¥¿æˆ‘ä¸€ä¸ªéƒ½å¬ä¸æ‡‚ï¼Œç¬¬äºŒä¸ªæ˜¯å‰è¾ˆè¯´çš„è¯æˆ‘ä¹Ÿä¸é‚£ä¹ˆèƒ½å¬æ‡‚ã€‚å°è±¡å¾ˆæ·±çš„æ˜¯ï¼Œå‰è¾ˆå»é¢è¯•ä¸€ä¸ªå°ä¼™å„¿ï¼Œå›å¤´è·Ÿæˆ‘è¯´åŸºç¡€ä¸å¤ªè¡Œï¼Œæˆ‘ä¸ºä¸ºå•¥åŸºç¡€ä¸å¤ªè¡Œï¼Œå‰è¾ˆè¯´ï¼šä»–ç«Ÿç„¶ä¸æ‡‚ã€Œâ€¦ã€ã€‚è¿™ä¸ªåè¯æˆ‘åæ¥çŸ¥é“æ˜¯ä»€ä¹ˆæ„æ€ï¼Œä½†å¯¹å½“æ—¶æˆ‘æ¥è¯´æ˜¯ä¸€ä¸ªæˆ‘æŒ‡ä»¤é›†æ²¡æœ‰çš„æŒ‡ä»¤ï¼Œäºæ˜¯æ‚²ä¼¤çš„æ„Ÿè§‰æ²¹ç„¶è€Œç”Ÿã€‚æƒ³å¿…é‚£ä¸ªæ—¶å€™ HR åº”è¯¥æŠŠæ‹›æˆ‘è¿›å»å½“ä½œæ‹›è˜äº‹æ•…äº†ã€‚å½“ç„¶ï¼Œå°½ç®¡å¦‚æ­¤ï¼Œæˆ‘ä½œä¸ºå…¬å¸çš„é›‡å‘˜ï¼Œè¿˜æ˜¯è¦å»å…¬å¸å¹´ä¼šçš„ï¼Œäºæ˜¯æ·±å¤œåç€é«˜é“æ‘¸å»äº†åŒ—äº¬ã€‚å½“æ—¶è·Ÿå…³ç³»å¥½çš„åŒäº‹ä½ä¸€é—´å®¾é¦†ï¼Œç¿» IM å‘ç°åŒäº‹åœ¨èŠæˆ‘æä¸æ‡‚çš„ä¸œè¥¿ï¼Œäºæ˜¯å°±ååœ¨å®¾é¦†é‡Œçœ‹ PPTï¼Œæƒ³ç€è®©è‡ªå·±ä¸é‚£ä¹ˆå¤±è´¥ã€‚å¹´ä¼šçš„æ—¶å€™ï¼Œå¤§å®¶éƒ½å¾ˆçƒ­é—¹ï¼Œæˆ‘åœ¨ iPad Kindle ä¸Šçœ‹ã€Šåœ¨ç»†é›¨ä¸­å‘¼å–Šã€‹ï¼Œç„¶åé—·å¤´çœ‹ç€èœã€‚æ—è¾¹çš„åŒäº‹çœ‹ç€æˆ‘è¿™ä¹ˆèƒ½åƒï¼Œå†çœ‹çœ‹æˆ‘è‚¥èƒ–çš„èº«æï¼Œæ„Ÿè§‰å­¦åˆ°äº†ä¸€äº›æ•™è®­ã€‚è¿™ä¼šå„¿è€æ¿è¿‡æ¥æ‰¾æˆ‘ä»¬èŠå¤©ï¼Œçœ‹åˆ°ç‰›é€¼çš„å®ä¹ åŒäº‹ç‚¹äº†ç‚¹å¤´ï¼Œçœ‹åˆ°æˆ‘è¯´ã€Œå“ï¼Œä½ è¦åŠªåŠ›å‘€ã€ã€‚</p><p>ç¬¬äºŒå¤©ç¦»å¼€åŒ—äº¬çš„æ—¶å€™ï¼Œå› ä¸ºæˆ‘ç–å¿½ç»™é«˜é“è¯¯ç‚¹äº†ã€‚ä¸è¿‡å¹¸äºå¦‚æ­¤ï¼Œæˆ‘å¾—ä»¥å»¶è¿Ÿäº†å‡ ä¸ªå°æ—¶åœ¨åŒ—äº¬çš„è¡Œç¨‹ï¼Œç©¿ç€å»å¹´å†¬å¤©æ¥åŒ—äº¬çš„æ—¶å€™å’Œèˆå‹ G ä¸€èµ·é€‰è´­çš„æ£‰è¢„ï¼Œé€›äº†é€›å…µå™¨åšç‰©é¦†ã€‚è¿™é¢‡æœ‰ç‚¹ã€Œ é¸¢é£æˆ¾å¤©è€…ï¼Œæœ›å³°æ¯å¿ƒï¼›ç»çº¶ä¸–åŠ¡è€…ï¼Œçª¥è°·å¿˜åã€çš„æ„Ÿè§‰ã€‚é€›å®Œä¹‹åï¼Œæˆ‘çœ‹ç€ä¸­é—´çš„æˆ˜æ–—æœºï¼Œæ„Ÿè§‰å¿ƒæƒ…å¥½å¤šäº†ã€‚å›å®¶äº†ï¼Œç„¶åè·Ÿèˆå‹çº¦å¥½å¼€å­¦çš„æ—¶å€™ä¸€èµ·å» Kokia çš„ Liveã€‚å½“ç„¶è¿™ä¸ªæ—¶å€™çš„æˆ‘ä¸çŸ¥é“æˆ‘æ¯•ä¸šä¹‹åå›å»åŒ—äº¬ï¼Œä¹Ÿä¸çŸ¥é“ï¼Œå½±å“æˆ‘ä»¬è¿™å‡ å¹´æœ€å¤§çš„äº‹å°±è¦å‡ºç°äº†ã€‚1æœˆçš„æ—¶å€™ç–«æƒ…å‡ºç°äº†ï¼Œå…¨å›½å„åœ°å¼€å§‹å°ç€ï¼Œç¬¬ä¸€æ¬¡å¤§è¿‡å¹´çš„åœ¨å®¶é‡Œå’Œçˆ¸å¦ˆä¸‰ä¸ªäººåƒé¥­ï¼Œä¸è¿‡çœ‹åŠ¨ç”»è¿˜æŒºæ¬¢ä¹çš„ã€‚æœŸé—´ä¹Ÿæœ‰ä¸€äº›åœ¨å…¬å¸å†™å†™ä»£ç ï¼Œè·‘è·‘ k8s çš„æ‚æ´»ã€‚ä¸è¿‡å†æ€ä¹ˆæ ·ä¸èƒ½å½±å“è¿‡å¹´å˜›ã€‚åœ¨å®¶é‡Œä¸€è¾¹ç¿»ç€æ¯•ä¸šè®¾è®¡æœ‰å…³çš„ä¸œè¥¿ä¸€è¾¹å¿«ä¹è¿‡å¹´ï¼ŒæœŸé—´ä¸€ç›´åœ¨çœ‹ã€ŠHeart Catch å…‰ä¹‹ç¾å°‘å¥³ã€‹ã€‚</p><p><img src="/Users/fuxuwei/Downloads/AD69FF47-A3DF-491C-8433-BE5EAE553ED7.png" alt="AD69FF47-A3DF-491C-8433-BE5EAE553ED7"></p><p>å¯’å‡è¿‡äº†ä¹‹åï¼Œå›åˆ°äº†ä¸€è¾¹ä¸Šç­ä¸€è¾¹å‡†å¤‡æ¯•è®¾ä¸€è¾¹å­¦ä¹ çš„ç”Ÿæ´»ã€‚è¿™é‡Œæœ‰ä¸ªå°æ’æ›²æ˜¯ï¼Œ17æ¥¼çš„å“¥ä»¬å¾€æ¥¼é“ä¸Šä¸¢åƒåœ¾ï¼Œè¢«æ¥¼ä¸Šçš„ä¸¢çƒŸå¤´ç‚¹ç€äº†ï¼Œç»“æœæ¥¼ä¸Šå†’çƒŸç€ç«â€¦ç®—æ˜¯æˆ‘åŠä¸ªæœˆç¬¬äºŒæ¬¡çœ‹åˆ°å°åŒºå†’ç«ï¼Œå½“æ—¶æ„Ÿè§‰æ—¥å­è¿‡å¾—å¤ªå¥‡æ€ªäº†ã€‚è¿™ä¼šå„¿ä¸Šç­æ¯”è¾ƒå¿™ï¼Œç„¶åæˆ‘åˆåœ¨åˆ©ç”¨ä¸‹ç­æ—¶é—´åš 6.824ï¼Œè€Œæˆ‘å®åœ¨å¤ªèœäº†ï¼Œå—ä¸äº†è‡ªå·±äº†ã€‚åˆå› ä¸ºå…³åœ¨å®¶é‡Œï¼Œæ²¡æ³•å’ŒåŒå­¦äº¤æµï¼Œæœ‰ç‚¹äº‹å®ä¸Šçš„çƒ¦é—·ã€‚åœ¨å¹²äº†ä¸€ä¸ªæœˆä¹‹åï¼Œè¶Šæ¥è¶Šè¢«è‡ªå·±èœåˆ°ä¸è¡Œã€‚è¿™ä¸ªæ—¶å€™ï¼Œèˆå‹ G å‘Šè¯‰æˆ‘ä»–è·‘å»å¤´æ¡äº†ã€‚æˆ‘å¿ƒæƒ³ä½ ä¹‹å‰ä¸æ˜¯ç­¾äº†ä¸‰æ–¹å—ï¼Œè¿™æ˜¥æ‹›æ‰¾å·¥ä½œè¿™ä¹ˆéš¾ï¼Œå’‹è¿˜å»äº†å‘¢ï¼Œèˆå‹ G å¯¹æˆ‘è¯´ï¼š</p><blockquote><p>å•Šæˆ‘è§‰å¾—å¹²ç€å¤ªæ— èŠäº†ï¼Œå¤´æ¡å¥½æ­¹æœ‰ä¸œè¥¿åšï¼Œæˆ‘ä¹Ÿå¯ä»¥å¤šå†™å†™ä»£ç </p></blockquote><p>ç„¶åæˆ‘çªç„¶ç»·ä¸ä½äº†ï¼Œæˆ‘å°±æƒ³æ‰¾ä¸ªå·¥ä½œï¼Œèƒ½æ¥å—æˆ‘è¿™ç§èœé€¼ã€‚è¿™è¯å¬ç€æœ‰ç‚¹æ‰­æ›²ï¼Œä¸æ˜¯è¯´å»äº†å¤§ä½¬äº‘é›†çš„åœ°æ–¹ä¸€å®šå¥½å—ï¼Ÿå½“ç„¶å¥½ï¼Œå‰ææ˜¯ä½ è·Ÿçš„ä¸Šã€‚äº‹å®è¯æ˜æˆ‘è·Ÿä¸ä¸Šï¼Œä½†æˆ‘åˆæƒ³å†™ä»£ç ã€‚ä½ åˆ«çœ‹æˆ‘è¯´è¿™ä¹ˆåˆ«æ‰­ï¼Œäººè¿˜æ˜¯æœ‰æƒ³è¦è¯æ˜è‡ªå·±çš„æƒ³æ³•çš„ï¼Œè™½ç„¶å¾ˆå¼±æ™ºã€‚æœ‰å¥è¯æ€ä¹ˆè¯´çš„æ¥ç€ï¼Ÿã€Œæƒ³åšæ³•å¸ˆï¼Œæ— è®ºæ˜¯å¤šä¹ˆè¹©è„šçš„æ³•å¸ˆã€ã€‚äºæ˜¯è¿™ä¼šå„¿æˆ‘å†³å®šè·‘å»ææ˜¥æ‹›äº†ã€‚è¿™ä¹Ÿæ˜¯æˆ‘ç¬¬ä¸€æ¬¡å»çœŸçš„æ‰¾å·¥ä½œã€‚å› ä¸ºå®ä¹ æˆ‘å°±æ²¡é¢å‡ å®¶ã€‚äºæ˜¯å……æ»¡æŒ«æŠ˜çš„æ˜¥æ‹›å¼€å§‹äº†ã€‚</p><p>å½“æ—¶è§‰å¾—è‡ªå·±å¥½æ­¹èƒ½åŠ åŠ æ²¹ï¼Œç„¶åä¸€è¾¹åˆ· 6.824ã€ä¸€è¾¹å·¥ä½œã€ä¸€è¾¹å‡†å¤‡æ˜¥æ‹›ï¼Œå½“æ—¶æœ€æ•¬ä»°é˜¿é‡Œäº‘å’Œä¸€äº›çŸ¥é“çš„åšå­˜å‚¨çš„å°å‚ï¼Œç„¶åæŠŠç®€å†ä¸¢è¿‡å»ï¼Œäºæ˜¯æœ‰äº†ä¸‹åˆ—ç»å†ï¼š</p><ul><li>é˜¿é‡Œäº‘ç­‰äº†ä¸¤ä¸ªæ˜ŸæœŸï¼Œæ²¡æœ‰ç¬”è¯•æ²¡æœ‰é¢è¯•ï¼Œæµç¨‹å˜æˆäº† Rejected</li><li>æŠ•çš„æŸä¸ªå­˜å‚¨å°å…¬å¸ï¼Œä¸€é¢æˆ‘å…¶å®é¢çš„ä¸æ˜¯å¾ˆå¥½ï¼Œä½†æ˜¯é¢è¯•å®˜è¯´ï¼šä½ æƒ³çš„ä¸å¤Ÿæ·±ï¼Œä¸è¿‡æˆ‘æ”¾ä½ å»é¢ä¸‹ä¸€ä¸ªäº†ã€‚ç„¶åäºŒé¢æˆ‘è§‰å¾—è‡ªå·±ç­”çš„è¿˜è¡Œï¼Œç„¶åâ€¦æ³æ— éŸ³è®¯äº†ï¼ˆäº‹åæ”¶åˆ°åˆ«äººçš„è¯„ä»·ï¼Œè§‰å¾—æˆ‘æ¯”è¾ƒæµ®èºï¼Œæˆ‘è§‰å¾—è¯„ä»·çš„éå¸¸ä¸­è‚¯ï¼‰ã€‚</li></ul><p>æç€ä»Šå¤©ä½ çœ‹è¿™äº›ç ´äº‹å…¶å®éƒ½æ²¡å•¥ï¼Œä½ äººèœå˜›ï¼Œå°±åº”è¯¥è¢«æŒ‚ã€‚ä½†æ˜¯æ¯”è¾ƒæƒ³å»çš„åœ°æ–¹éƒ½æŠŠè‡ªå·± Rej äº†ï¼Œå¯¹å¿ƒæ€æ‰“å‡»å…¶å®çœŸçš„ä¸å°çš„ï¼Œå’±ä»¬å‡ºå»é¢è¯•åˆä¸æ˜¯ç†æ™ºåŠ¨ç‰©å¯¹å§â€¦</p><p>å“¦é¡ºå¸¦ä¸€ææˆ‘ leetcode åˆ°ä»Šå¤©åªå†™äº† 90 é¢˜ï¼Œå¤§éƒ¨åˆ†æ—¶å€™è¿˜æ˜¯é‚£ä¼šå„¿å†™çš„ï¼Œå“ˆå“ˆã€‚</p><p>è¿™ä¼šå„¿æˆ‘ä¹Ÿåªæœ‰æ€»ç»“ç»éªŒäº†ï¼ŒæŠŠé¢è¯•å®˜é—®çš„ä¸œè¥¿å¥½å¥½å­¦ä¹ ï¼Œäº‰å–è®©ä¸Šæ¬¡é—®è¿‡çš„ä¸‹æ¬¡å­¦ä¼šäº†å¯¹å§ã€‚é‚£ä¼šå„¿æˆ‘æŠŠ 6.824 å‰ä¸‰ä¸ª Lab å†™å®Œäº†ï¼ˆå…¶å®äº‹åæƒ³ç”»äº†å¾ˆå¤šæ—¶é—´ï¼Œè€Œä¸”å·¥ä¸šç•Œåš Raft çš„çœ‹æˆ‘çŸ¥è¯†è·Ÿçœ‹ç€å‚»é€¼æŠ¥èœåä¸€æ ·ï¼Œå“ˆå“ˆï¼‰ï¼Œç„¶åçœ‹äº†ä¸å°‘ LSM å’Œ Btreeã€æ“ä½œç³»ç»Ÿ çš„ææ–™ï¼Œé‚£ä¸ªæ—¶å€™æ²‰è¿·åœ¨ä»€ä¹ˆç‰›å®¢å’ŒçŸ¥ä¹åˆ·åˆ«äººçš„é¢ç»ã€‚é¢ç»æ„Ÿè§‰å°±æ˜¯è¿™ç¾¤å°¼ç›å¤§å››å¤§ä¸‰çš„æ€ä¹ˆå•¥éƒ½ä¼šï¼Œé¢ WXG æŠ–éŸ³ é˜¿é‡Œå·´å·´ä¹‹ç±»çš„é¢ç»ç»™æˆ‘ç•™ä¸‹äº†éå¸¸é•¿æ—¶é—´çš„å¿ƒé‡Œé˜´å½±ï¼Œæ„Ÿè§‰åœ¨å¤§å­¦è¿™äº›äººåšäº†ä¸€ä¸‡ä¸ª web é¡¹ç›®ï¼Œä» Linux å†…æ ¸ç²¾é€šåˆ° Spring æ ‡å‡†å†ç²¾é€šåˆ°ä¸­é—´ä»¶ã€‚æˆ‘ä»–å¦ˆå´ä»€ä¹ˆéƒ½ä¸ä¼šï¼Œæˆ‘ä»–å¦ˆå´ä»€ä¹ˆéƒ½ä¸ä¼šï¼Œæˆ‘ä»–å¦ˆå´ä»€ä¹ˆéƒ½ä¸ä¼šã€‚</p><p>ç„¶åæ¥ç€é¢å‘—ï¼ŒæŠ•äº†ç½‘æ˜“å‘€å•†æ±¤å•Šå¾®è½¯å•Šç™¾åº¦å•Š360å•Šä»€ä¹ˆçš„ï¼Œé‡Œé¢ä¸€åŠæ²¡ç†æˆ‘ï¼Œæœ‰çš„é¢è¯•æ¯”è¾ƒéš¾ï¼Œæˆ‘ä¹Ÿå°½åŠ›å›ç­”å°½åŠ›åšé¢˜ï¼Œç„¶åå¥½å¥½æ”¶é›†èµ„æ–™ï¼Œå¥½å¥½å‡†å¤‡ã€‚è¿™æ®µæ—¶é—´èƒ–äº†ä¸å°‘ï¼Œå‹åŠ›æ¯”è¾ƒå¤§ï¼Œå¤©å¤©åœ¨å®¶é‡Œå—¯åƒï¼Œåƒäº†çœ‹ä»€ä¹ˆå‰‘æŒ‡ offer é¢ç»æ¥ç€åˆ·ã€‚è¿˜è¦ä¸Šç­æ¥è¿œç¨‹å·¥ä½œã€‚åšé¢˜è¿™ä¸œè¥¿åˆ«çœ‹æˆ‘åªåˆ·äº†ä¸ƒå…«å lcï¼ˆé‚£ä¼šå„¿è¿˜æ²¡ 90ï¼Œå“ˆå“ˆï¼‰ï¼Œå¤§éƒ¨åˆ†é¢˜è¿˜æ˜¯æœ‰æ€è·¯èƒ½å†™çš„ï¼Œä¸è¿‡æœ‰æ—¶å€™ä¼šæ¼è¾¹ç•Œæ¡ä»¶ï¼Œç„¶åæƒ³èµ·æ¥æŠ½è‡ªå·±å˜´å·´ã€‚æœ‰çš„é¢è¯•å®˜ä¼šé—®ä¸€äº›åŸºç¡€é¢˜ï¼Œé—®çš„æ¯”è¾ƒæ·±æˆ‘ä¹Ÿç­”ä¸å‡ºæ¥ï¼Œä¸è¿‡è€å®è¯´å½“æ—¶å¤§éƒ¨åˆ†å…«è‚¡æ–‡èƒŒç†Ÿäº†ï¼Œäººå®¶è¯´å•¥ä½ éƒ½èƒ½åº”ä¸¤å¥ï¼ˆç°åœ¨çœ‹æ¥ï¼Œæˆ‘æ€€ç–‘æœ‰çš„é¢è¯•å®˜å¯èƒ½ä¹Ÿæ²¡é‚£ä¹ˆæ‡‚ï¼Œå“ˆå“ˆï¼‰ã€‚é¢è¯•å¤šäº†å¥½å¤„å°±æ˜¯ï¼Œä½ è¶Šé¢è¶Šâ€¦æ‡‚å…«è‚¡æ–‡äº†ï¼Œé™¤äº†å¯¹æ–¹èŠçš„å¾ˆæ·±ï¼Œä¸ç„¶ä½ æ€»èƒ½å¿½æ‚ ä¸¤å¥ã€‚è¿™å°±æ˜¯æˆ‘ä»¬æ“…é•¿çš„ä¸œéƒ­å…ˆç”Ÿä¹‹é“å§ã€‚</p><p>è¯´èµ·æ¥æŒºç´¯çš„ï¼Œå…¶å®èº«ä½“ä¸å’‹ç´¯ï¼Œä¸»è¦æ˜¯å¿ƒç†æœ‰ä¸€ç§å¾ˆæŠ˜ç£¨çš„æ„Ÿè§‰ï¼Œæ¯å¤©åœ¨ç¡è§‰çš„æ—¶å€™å¦å®šè‡ªå·±ã€‚äººä»¬å¸¸è¯´è¦å’Œè‡ªå·±è¿‡çš„å»ï¼Œè¦é™ä½è¦æ±‚ï¼Œè¯´çœŸçš„ï¼Œè¿™äº›éƒ½æ˜¯æ­£ç¡®çš„åºŸè¯ï¼ŒçœŸåˆ°è‡ªå·±çœ¼å‰é™¤äº†ç„¦è™‘è¿˜æ˜¯ç„¦è™‘ï¼Œå°¤å…¶æ˜¯åŒå­¦éƒ½æ‰‹æ¡ offer çš„æ—¶å€™ã€‚æ¯å¤©èººåœ¨åºŠä¸Šéƒ½æœ‰é‚£ä¹ˆç‚¹æ€€ç–‘è‡ªå·±çš„äººç”Ÿï¼Œå¦ˆçš„ï¼Œæˆ‘ä¸Šå¤§å­¦éƒ½å­¦äº†å•¥æï¼Ÿ</p><p>æŒ‰ç†è¯´è¿™æ®µæ—¶é—´åº”è¯¥ 100% æŠ•å…¥åœ¨å·¥ä½œå’Œå­¦ä¹ ä¸­ï¼Œä¸è¿‡æŠ—å‹è‰°éš¾ï¼Œæ„Ÿè°¢ bangumi å’ŒåŠ¨ç”»ç¾¤çš„æœ‹å‹ï¼Œæ„Ÿè°¢æ—¥æœ¬åŠ¨ç”»ï¼Œæˆäº†æˆ‘æ‰¾å·¥ä½œæ—¶å€™çš„è°ƒå‰‚å“ã€‚å½“ç„¶ï¼Œæˆ‘è¿˜è®°å¾—é¢è¯•æŸå¸çš„æ—¶å€™ï¼Œå› ä¸ºçœ‹åŠ¨ç”»é”™è¿‡é¢è¯•çš„æ—¶é—´ï¼Œæˆ‘èµ¶ç´§å‘é‚®ä»¶è¿‡å»è¯´æˆ‘å®¶åœç”µäº†ï¼Œèƒ½ä¸èƒ½æ™šåŠå°æ—¶é¢è¯•â€¦è¿™ç®—æ˜¯ä¸€ä¸ªæ¯”è¾ƒæœ‰æ„æ€çš„å°æ’æ›²å§ã€‚ä½ é—®æˆ‘ä¸æ˜¯è¿™æ®µæ—¶é—´è‹¦å¤§ä»‡æ·±æ¯å¤©éš¾å—å˜›ï¼Ÿå…¶å®ä¹Ÿæ²¡æœ‰ï¼Œæ—¥å­æ€»å¾—è¿‡ä¸‹å»æ˜¯ä¸æ˜¯â€¦äººæ˜¯å¾ˆé¡½å¼ºçš„ï¼Œä¸€å¤©æ€»æœ‰é‚£ä¹ˆå¤šæ—¶é—´å…¶å®è¿˜è›®å¼€å¿ƒçš„ã€‚è¿™ä¼šå„¿è¿˜æ˜¯éå¸¸æ„Ÿè°¢å®¶é‡Œäººå¯¹æˆ‘çš„æ”¯æŒï¼Œæ¯å¤©æ—©ä¸Šæ‹‰æˆ‘å»æ•£æ­¥ã€‚å‘¼å¸ä¸€ä¸‹è·¯è¾¹æ–°é²œç©ºæ°”ä¹‹åï¼Œäººä¸Šç­åç‰¢çš„ç²¾ç¥å°±æ²¡æœ‰é‚£ä¹ˆå¼ºäº†ã€‚ä¹Ÿæ„Ÿè°¢äº’è”ç½‘çš„å°ä¼™ä¼´å’Œèˆå‹ã€‚</p><p>åœ¨å››æœˆä¸­æ—¬çš„æ—¶å€™ï¼Œæ‹¿åˆ°äº† 360 å’Œç½‘æ˜“çš„ offerï¼Œæˆ‘æ°¸è¿œæ„Ÿè°¢ä½ ä»¬ï¼Œè™½ç„¶æˆ‘æ²¡å»ï¼Œä½†çœŸçš„å¤ªæ„Ÿè°¢äº†ï¼è¿™ä¼šå„¿æœ‰äº†ç€è½ï¼Œæˆ‘æ„Ÿå—åˆ°äº†ä¸€ç§å–œæ‚¦ï¼Œå¦ˆçš„ï¼Œç»ˆäºæœ‰äººè®¤å¯æˆ‘äº†ï¼æˆ‘æ˜¯å¤‡èƒä¹Ÿæ— æ‰€è°“ï¼Œæ˜¯ä¸‰æµé€‰æ‹©ä¹Ÿæ— æ‰€è°“ï¼Œä»–å¦ˆçš„æœ‰äººè®¤å¯æˆ‘ä»·å€¼äº†ï¼Œèµ„æœ¬å®¶æ„¿æ„å‰¥å‰Šæˆ‘äº†ï¼</p><p>å››æœˆåº•ï¼Œå­¦æ ¡å…è®¸æˆ‘ä»¬å›å­¦æ ¡ï¼Œåœ¨å®¶è‚¥äº†è¿™ä¹ˆå¤šï¼Œä¹Ÿæ¯•ç«Ÿå¾—å›å»äº†ã€‚æœ‰äº† offer ä¹‹åæ„Ÿè§‰å¿ƒæƒ…å¥½äº†ä¸€äº›ï¼Œåœ¨å…¬å¸æˆ‘è¯·äº†ä¸ªé•¿å‡ï¼Œåœ¨è·¯ä¸ŠæŠŠã€Šè®¸ä¸‰è§‚å–è¡€è®°ã€‹çœ‹å®Œäº†ã€‚å…œå…œè½¬è½¬åˆ°äº†å¿ƒçˆ±çš„å­¦æ ¡ï¼Œå›åˆ°äº†å®¿èˆï¼Œæˆ‘ä»¬å®¿èˆç«Ÿç„¶æ²¡å‘éœ‰ï¼Œæˆ‘çš„å¤©ã€‚çœ‹è§æŠ±ç€è¥¿ç“œæ‰“æ¸¸æˆçš„èˆå‹ Lï¼Œæˆ‘å¿ƒæƒ…ä¸ç¦å¥½äº†ä¸å°‘ï¼ˆèˆå‹å·²ç»ç”³è¯·åˆ°äº†ç¾å›½çš„å­¦æ ¡äº†ï¼Œä¸è¿‡çœ‹ç€ä»–æˆ‘å°±è´¼ä»–å¦ˆå¼€å¿ƒï¼‰ã€‚äºæ˜¯æˆ‘åœ¨å®¿èˆç»§ç»­äº†é¢è¯•çš„ç”Ÿæ´»ï¼ŒæœŸé—´æ‹¿åˆ°äº† TX çš„ ç™½èœ Offerã€‚èˆå‹ G å›æ¥åçœ‹æˆ‘èƒ–äº†è¿™ä¹ˆå¤šï¼Œç‹ ç‹ çš„å˜²è®½äº†æˆ‘ä¸€é¡¿ã€‚</p><p>ï¼ˆåœ¨å®¿èˆé¢è¯•çš„æ—¶å€™ï¼Œä¹Ÿæœ‰ä¸å°‘å°æ’æ›²ï¼Œä¸‹åˆä¸‰ç‚¹é¢è¯•ï¼Œç„¶åèˆå‹è§‰å¾—æˆ‘æ‰“æ‰°ä»–ç¡è§‰äº†ï¼Œé»‘ç€è„¸æŠŠæˆ‘ä»å®¿èˆèµ¶å‡ºå»äº†ï¼Œäºæ˜¯æˆ‘åˆ°æ¥¼é“é‡Œå»å®Œæˆé¢è¯•äº†ï¼Œä»¤äººæ„Ÿå¹â€¦ï¼‰</p><p>äº”æœˆï¼Œæ‹¿åˆ°äº†è‡ªå·±åŒ…æœ€å¤§çš„ä¸€ä¸ª offerï¼Œè¿˜æ˜¯åœ¨å­¦æ ¡çš„å½“åœ°ï¼Œä¸è¿‡è€å®è¯´ï¼Œé¢è¯•å®˜ç»™æˆ‘ä¸€ç§ 30 å²çš„äºº 40å²çš„è„¸çš„æ²§æ¡‘æ„Ÿï¼Œåˆå¬è¯´åŠ ç­éå¸¸ç‹ ï¼Œèƒ–äº†å¾ˆå¤šçš„æˆ‘å½“æ—¶çœ‹ç€æœ‰ç‚¹çŠ¯æ€µã€‚è¿™ä¼šå„¿æ„Ÿè§‰40%çš„å…¬å¸æ²¡ç†è‡ªå·±ï¼Œ40% å…¬å¸æŠŠè‡ªå·±æŒ‚äº†ï¼Œ20% çš„å…¬å¸ç»™è‡ªå·±å‘äº† offerï¼Œä½†ä¹Ÿéå¸¸çº ç»“å»å“ªã€‚æ€å‰æƒ³åï¼Œç¤¾æçš„æˆ‘æ‰¾äº†ä¸€åœˆå…³ç³»å¥½çš„ç½‘å‹ï¼Œè¯´ã€Œæ‚¨å¥½ï¼Œæˆ‘æ˜¯åœ¨æ‰¾å·¥ä½œçš„æœ¬ç§‘ç”Ÿï¼Œèƒ½ç»™æˆ‘ä¸€ä¸ªé¢è¯•æœºä¼šå˜›â€¦ã€ã€‚</p><p>æœ‰ä¸€ä¸ªç½‘å‹å¬åˆ°äº†æˆ‘çš„è¯·æ±‚ï¼Œç„¶åæŠŠæˆ‘ç®€å†æŠ•æ”¾äº†å‡ å®¶ï¼Œæˆ‘æˆåŠŸå¾—åˆ°äº†é¢è¯•æœºä¼šã€‚è¿™ä¹Ÿæ˜¯æˆ‘æœ€ç»ˆå»çš„åœ°æ–¹ã€‚ä¸è¿‡æ®è¯´é¢è¯•é¢çš„ä¸å’‹å¥½ã€‚1å¹´ä¹‹åï¼Œæˆ‘çš„ä¸€é¢é¢è¯•å®˜å¯¹æˆ‘è¯´ï¼šã€Œå½“æ—¶çœ‹è§ä¸€ä¸ªè‚¥å®…åœ¨æ˜æš—çš„ç¯å…‰ä¸‹è¯´ç€æˆ‘å¬ä¸æ‡‚çš„è¯ï¼Œçµ®çµ®å¨å¨ï¼Œå¾ªç¯å¾€å¤ï¼Œæˆ‘æœ‰ç‚¹æƒ³ç›´æ¥æŠŠä»–æŒ‚äº†ï¼Œä¸è¿‡è€æ¿è¯´å†çœ‹çœ‹ï¼Œä¸çŸ¥é“æ€ä¹ˆæŠŠä½ è¿™ä¸ªèœé€¼æ”¾è¿›æ¥äº†ã€‚ã€ä½ çœ‹ï¼Œäººç”Ÿå°±æ˜¯è¿™ä¹ˆæˆå‰§æ€§ã€‚æ‹¿åˆ°è¿™å®¶ä¹‹åï¼Œæˆ‘é«˜å…´çš„è·³äº†èµ·æ¥è¯´è¯·å®¢ï¼Œè¢«åœŸè±ªåŒå­¦æ‹‰ç€å»è¯·å®¢åƒæ—¥æ–™ï¼Œäº”ä¸ªäººåƒäº†ä¸€åƒæˆ‘è¿˜æ²¡åƒé¥±ï¼Œå¦ˆçš„ï¼ŒçœŸé»‘ã€‚</p><p>ç„¶åæˆ‘å°±é€‰æ‹©äº†è¿™å®¶ï¼Œæ„Ÿè°¢è¿™ä¸ªç½‘å‹å’Œä¸å«Œå¼ƒæˆ‘çš„åŒäº‹ï¼ŒçœŸçš„ï¼Œéå¸¸æ„Ÿè°¢ã€‚</p><p>ä¹Ÿå¾ˆæŠ±æ­‰æˆ‘çš„å‰åŒäº‹ä»¬ï¼Œæˆ‘æ°´å¹³å¤ªå·®äº†ï¼Œæ²¡æœ‰è¾¾åˆ°ä½ ä»¬çš„é¢„æœŸï¼Œä¹Ÿæ²¡å¹²æˆä»€ä¹ˆäº‹æƒ…ï¼Œè¿™å¾ˆä»¤äººé—æ†¾ã€‚æˆ‘è¿˜è®°å¾—æˆ‘å½“æ—¶è¯´è¦è·‘è·¯çš„æ—¶å€™ï¼Œè€æ¿å’Œå¸¦æˆ‘çš„å‰è¾ˆéƒ½è¯­é‡å¿ƒé•¿å¯¹æˆ‘è¯´äº†åŠå¤©ã€‚ä¸æ˜¯è¦æˆ‘ç•™ä¸‹ï¼Œè€Œæ˜¯çœŸåˆ‡è¯´å·¥ä½œçš„æ—¶å€™è¦æ³¨æ„æ€ä¹ˆæ€ä¹ˆæ ·ã€‚å› ä¸ºæˆ‘çš„åŸå› æ‹–ç´¯å¤§å®¶ï¼Œå¾ˆå¯¹ä¸èµ·ã€‚</p><p>ç„¶åå°±æ˜¯æ¯•ä¸šæœ€åçš„æ—¶å€™äº†ï¼Œæˆ‘å’ŒåŒå­¦é€›äº†ä»¥å‰æ²¡å»çš„åŠ¨ç‰©å›­ã€å›¾ä¹¦é¦†ã€ä¹¦åº—ã€åƒä¸œè¥¿çš„åœ°æ–¹ã€‚è¯´çœŸçš„ï¼Œäººé€‰æ‹©çš„æ—¶å€™ï¼Œæœ€ç»ˆä¼šçŸ¥é“è‡ªå·±é”™è¿‡äº†ä»€ä¹ˆï¼Œæˆ‘ç¬¬ä¸€æ¬¡æ„Ÿå—åˆ°ï¼Œè‡ªå·±å­¦æ ¡æ‰€åœ¨çš„åŸå¸‚è¿™ä¹ˆå¤§ï¼Œæœ‰è¿™ä¹ˆå¤šä¸œè¥¿ã€‚å½“æ—¶æˆ‘ä¹Ÿçœ‹äº†å¾ˆå¤šåŠ¨ç”»ç‰‡ã€‚å“¦è¯´åˆ°æ¯•è®¾ï¼Œæˆ‘æ˜¯ä¹‹å‰èŠ±ä¸€ä¸ªæœˆåœ¨æ‰¾å·¥ä½œæœŸé—´åšäº†ä¸ªä¸€åŠï¼Œæ‰¾åˆ°å·¥ä½œåï¼Œå¤§æ¦‚é«˜å¼ºåº¦è‚äº†2ä¸ªæ˜ŸæœŸã€‚ä½ çœ‹ï¼Œæœ¬ç§‘ç”Ÿæ¯•è®¾å°±æ˜¯è¿™ä¹ˆæ°´ï¼Œæˆ‘æ„Ÿè§‰æˆ‘å°±æ˜¯ä¸­å›½æ•™è‚²çš„è´¥ç±»ï¼Œæœ¬ç§‘æ•™è‚²çš„æ¼ç½‘ä¹‹é±¼ã€‚æ€ä¹ˆåŠå‘¢ï¼Œç”Ÿæ´»è¿˜å¾—è¿‡ä¸‹å»ã€‚</p><p>æ¯•ä¸šçš„ä¸‹åˆæ˜¯æ¯•ä¸šå…¸ç¤¼ï¼Œä¸Šåˆå­¦é™¢æ‹æ¯•ä¸šç…§ã€‚æˆ‘çœ‹åŠ¨ç”»ç‰‡çœ‹åˆ°å…­ç‚¹æ²¡å»ã€‚ä¸‹åˆæ¯•ä¸šå…¸ç¤¼å€’æ˜¯å°è±¡å¾ˆæ·±ã€‚æ¯”è¾ƒçœŸæŒšçš„æ˜¯å­¦ç”Ÿä»£è¡¨ï¼Œä¹Ÿæ˜¯åœŸæœ¨çš„ï¼Œæˆç»©ä¸ç®—å¥½é‚£ç§ï¼Œè·Ÿæˆ‘ä»¬è®²è‡ªå·±æ‰¾ä¸åˆ°å·¥ä½œçš„äº‹æƒ…ï¼Œå¤ªæœ‰æ„æ€äº†ã€‚æ‹¨ç©—çš„æ—¶å€™ï¼Œæˆ‘å¿˜è®°äº†è‡ªå·±çš„åƒåœ¾ç»©ç‚¹ï¼Œå¿˜äº†è‡ªå·±å­¦ä¹ ä¸Šä¸å¥½ç»™å­¦æ ¡æŠ¹é»‘ï¼ŒçœŸåˆ‡æ„Ÿå—åˆ°ã€Œæˆ‘ä»–å¦ˆä¹Ÿæ˜¯ä¸ªå­¦å£«äº†ã€ã€‚å»æ‹¿æ¯•ä¸šè¯çš„æ—¶å€™ï¼Œæˆ‘è·Ÿå…³ç³»å¥½çš„å­¦é•¿ä¸€ç›´è¯´ï¼Œã€Œæˆ‘ä¹Ÿæ˜¯å­¦å£«äº†ï¼Œä½ å¯¹æˆ‘å°Šé‡ç‚¹ã€ã€‚å“¦å¯¹äº†ä¸ºä»€ä¹ˆæ˜¯å­¦é•¿ï¼Œå› ä¸ºä»–åœ¨æœ¬æ ¡è¯»ç ”äº†â€¦åªè§ä»–ç”¨çœ‹å‚»é€¼çš„çœ¼ç¥çœ‹ç€æˆ‘ï¼Œä½†ä¸çŸ¥é“ä¸ºå•¥ï¼Œæˆ‘å°±æ˜¯ä»–å¦ˆå¾ˆå¼€å¿ƒã€‚</p><p>å…¶å®ä¹Ÿæ²¡é‚£ä¹ˆå¼€å¿ƒï¼Œæœ‰ç‚¹æƒ†æ€…ï¼Œæ¯•ä¸šå…¸ç¤¼è¿‡å®Œï¼Œå¤§å®¶å°±è¦æ”¶æ‹¾è¡Œæå„å¥”ä¸œè¥¿äº†ã€‚æœ‰çš„åŒå­¦å»æ¯•ä¸šæ—…è¡Œï¼Œä½†æˆ‘çœŸçš„å¾ˆå®³æ€•è‡ªå·±å› ä¸ºå¤ªèœè¢«è£å‘˜ï¼Œæ‰€ä»¥å†³å®šæ—©ç‚¹å…¥èŒï¼Œå°±å‡†å¤‡äº†ä¸€å‘¨æ—¶é—´å›å®¶ï¼Œåœ¨å®¶å‘†å‡ å¤©å°±å»åŒ—äº¬ã€‚æ‹¿ç€è¡Œæç®±ç¦»å¼€å®¿èˆçš„æ—¶å€™ï¼Œæ„Ÿè§‰æœ‰å¾ˆå¤šè¯æƒ³å’ŒåŒå­¦è¯´ï¼Œåˆä»€ä¹ˆéƒ½è¯´ä¸å‡ºæ¥ã€‚è¿™äº›å¯å®¤å¯èƒ½ä¼šç•™ç»™åˆ«çš„æ ¡åŒºè¿‡æ¥çš„ï¼Œä¹Ÿå¯èƒ½ç•™ç»™æ–°ç”Ÿï¼Œä½†æ˜¯å†æ²¡æœ‰æˆ‘ä»¬çš„èº«å½±ï¼Œåªæœ‰ä¸€ä¸ªä¸ªåŒå­¦ç¦»å¼€ã€‚</p><p>å…¶å®æˆ‘æ”¾è¿™äº›è¯ï¼Œä¸æ˜¯æŠ±ç€æŸç§å¿†è‹¦æ€ç”œæˆ–è€…æ•™è®­ç°åœ¨æ‰¾å·¥ä½œçš„äººè¯´ä»€ä¹ˆè¯ï¼Œè™½ç„¶æˆ‘ç¡®å®æœ‰ç‚¹åƒç¥¥æ—å«‚ã€‚ç°åœ¨æ‰¾å·¥ä½œçš„ï¼Œæ°´å¹³ä¸ªä¸ªæ¯”æˆ‘ç°åœ¨è¿˜å¼ºã€‚æˆ‘èƒ½æ•™ä¸ªé”¤å­ã€‚è¿™ç§ç»å†æ˜¯æ¯ä¸ªäººç‹¬æœ‰çš„ã€ç¢ç‰‡çš„ï¼Œè€Œä¸”å¹¶ä¸ä¸ºå¤–äººé“ä¹Ÿã€‚åªæ˜¯ï¼Œå¦‚æœæœ‰æŸä¸ªä¸é‚£ä¹ˆæˆåŠŸçš„äººçœ‹åˆ°äº†ï¼Œèƒ½æ”¶åˆ°ä¸€äº›æ…°è—‰ï¼Œæƒ³åŠæ³•åˆ°æœ€åéƒ½åŠªåŠªåŠ›ï¼Œæˆ–è€…è¯´ç”¨æ›´åŠ ä¹è§‚çš„å¿ƒæ€çœ‹è‡ªå·±çš„è¯ï¼Œæˆ‘è§‰å¾—æˆ‘å°±å¾ˆå¼€å¿ƒäº†ã€‚ä½ ç§ï¼Œæ–‡ç« ä¸­æåˆ°çš„äººï¼Œä½ åˆ«å’Œæˆ‘æèµ·ä»–ä»¬ä»»ä½•ä¸€ä¸ªäººï¼Œè¦ä¸ç„¶æˆ‘å…¨éƒ½èƒ½æƒ³èµ·æ¥ã€‚</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>[VLDB&#39;22] CloudJump: å­˜å‚¨å±‚ä¸Šäº‘ä¼˜åŒ–</title>
      <link href="/2023/01/01/VLDB-22-CloudJump-optimizing-cloud-databases-for-cloud-storages/"/>
      <url>/2023/01/01/VLDB-22-CloudJump-optimizing-cloud-databases-for-cloud-storages/</url>
      
        <content type="html"><![CDATA[<p>Aurora é£æ ¼ç³»ç»Ÿç”¨åˆ†å¸ƒå¼å—å­˜å‚¨ / S3 ç­‰æœåŠ¡ä»£æ›¿ï¼ˆæˆ–è€…åŠ æ·±äº†ï¼‰äº† SSD / HDD çš„å­˜å‚¨æ ˆï¼Œè·å¾—äº†æ›´æ·±ä¸€å±‚çš„å­˜å‚¨æ ˆã€æ›´å¤§çš„å­˜å‚¨å¯æ‰©å±•æ€§ã€‚ä½†åœ¨è¿™ç‚¹ä¸Šï¼Œäº†è§£è¿™ä¸€å±‚æ–°çš„æ ˆçš„æ€§èƒ½å°±å˜å¾—æ›´åŠ é‡è¦äº†ã€‚CloudJump æ˜¯ PolarDB å›¢é˜Ÿçš„åœ¨å—å­˜å‚¨ä¸Šçš„ä¸€äº›ç ”ç©¶äº§ç‰©ï¼Œè™½ç„¶è®ºæ–‡ä¸»ä½“ç ”ç©¶å¯¹è±¡æ˜¯ InnoDB ä¸ºä¸»çš„ Btreeï¼Œä½†å®ƒä¹Ÿå…è®¸æŠŠè¿™éƒ¨åˆ†ç»“æœæ‰©å±•åˆ° LSM-Tree ä¸Šï¼Œè®ºæ–‡æè¿°äº†å¯¹ RocksDB çš„ä¸€äº›ä¿®æ”¹ã€‚è¿™ç¯‡æ–‡ç« æå‡ºçš„å†…å®¹å’Œè§£å†³æ–¹æ¡ˆæ˜¯å®åœ¨çš„ï¼Œåšçš„å·¥ä½œéå¸¸ Solidï¼Œä½†æ˜¯ï¼Œä½†çœ‹è¿™ç¯‡æ–‡ç« æ„Ÿè§‰ä½œè€…å¾ˆå¤šæ€è·¯æ²¡æœ‰å¾ˆå¥½çš„å‘Šè¯‰æˆ‘ä»¬ï¼Œæˆ–è€…æ˜¯æŠŠå†…éƒ¨é»‘è¯ç›´æ¥å†™å¤–é¢äº†ï¼Œå¾ˆå¤šä¸œè¥¿æˆ‘çœ‹çš„å¾ˆæ‡µé€¼ï¼Œè€Œä¸”å›¾ç‰‡å¶å°”å†’å‡ºä¸¤ä¸ªé”™å­—ï¼Œå°¼ç›ã€‚æ–‡ç« æœ€å¥½çš„é˜…è¯»æ–¹å¼æ˜¯çœ‹ baotiao çš„ talk ã€Œ<em>æ­ç§˜ PolarDB è®¡ç®—å­˜å‚¨åˆ†ç¦»æ¶æ„æ€§èƒ½ä¼˜åŒ–ä¹‹è·¯</em>ã€å’Œæ–‡æœ«ä¸€ä¸ªç¦»èŒäº†çš„å¤§ä½¬å†™çš„è¯„è®ºã€‚ç„¶åæŠ±ç€è¿™éƒ¨åˆ†ç†è§£å†å»è¯»åŸè®ºæ–‡ã€‚</p><p>è¯»æœ¬æ–‡ä¹‹å‰ï¼Œå‡å®šè¯»è€…å¯¹ InnoDB æœ‰ç€ä¸€å®šçš„äº†è§£ã€‚</p><p>æœ¬è®ºæ–‡åˆ†äº†å¾ˆå¤šä¼˜åŒ–ç»†èŠ‚ï¼Œä½†æ˜¯æ ¸å¿ƒç‚¹å…¶å®åªæœ‰ä¸€ä¸ªï¼š</p><blockquote><p>äº‘å­˜å‚¨æœ‰ç€æ›´é«˜çš„å»¶è¿Ÿã€æ›´å¤§çš„èšåˆå¸¦å®½ã€æ›´ä¸å¥½çš„ IO è°ƒåº¦èƒ½åŠ›ã€æ›´å¥½çš„éšæœºè¯»æ€§èƒ½ã€‚éœ€è¦<strong>åˆ©ç”¨å¸¦å®½ï¼Œä¼˜åŒ–å»¶è¿Ÿ</strong>ã€‚</p></blockquote><p>åœ¨é˜¿é‡Œäº‘ NASã€å—å­˜å‚¨è¿™äº›ä¸œè¥¿è¶Šæ¥è¶Šå¥½ä¹°çš„ä»Šå¤©ï¼Œæˆ‘ä»¬åº”è¯¥æŠŠå—å­˜å‚¨å½“æˆæ–°çš„ç‰ˆæœ¬ç­”æ¡ˆï¼Œæ‰€ä»¥åº”è¯¥å»çœ‹çœ‹è¿™ä¸ªæ–‡ç« æ˜¯æ€ä¹ˆå†™æ€ä¹ˆä¼˜åŒ–çš„ã€‚</p><p>Block Storage å¯ä»¥ç…ä¸€çœ¼æˆ‘ä¹‹å‰å†™çš„ WAS: <a href="https://blog.mwish.me/2022/11/24/SOSP-11-Windows-Azure-Storage/">https://blog.mwish.me/2022/11/24/SOSP-11-Windows-Azure-Storage/</a></p><p>ä¸€èˆ¬æ¥è¯´ï¼Œäº‘ä¸Šå—å­˜å‚¨ä¼šæä¾›ï¼š</p><ul><li>QoS</li><li>Admission Control</li><li>å¼¹æ€§è®¡è´¹</li><li>æœ¬èº«æ¥å£æ¯”è¾ƒ generalï¼Œå¯ä»¥é¿å… vendor in</li></ul><p><img src="https://image.mwish.me/blog-image/E9FE8C2B-8043-4F46-9A5F-3CDF3CBF7DEB.png" alt="E9FE8C2B-8043-4F46-9A5F-3CDF3CBF7DEB"></p><p>å›¾ä¸Šæ˜¯ä¸€ä¸ªå¯¹åº”çš„æ¶æ„. è¿™å¥—ä¸œè¥¿ç°åœ¨æœ‰ï¼š</p><ul><li>MySQL ç­‰<ul><li>Aurora</li><li>PolarDB</li><li>Socrates</li></ul></li><li>LSM<ul><li>Anna</li><li>RocksDB-Cloud (Rockset)</li></ul></li></ul><p><em>æ³¨æ„ä¸€ä¸ªå¾ˆå®¹æ˜“å¿½ç•¥çš„ä¸€ç‚¹ï¼ŒDB node ä¸Šæ²¡æœ‰ Cache ç›¸å…³çš„ä¿¡æ¯ï¼Œè¿™é‡Œæ˜¯æ–‡ç« åé¢ä¼šæåˆ°çš„ä¸€ä¸ªåœ°æ–¹</em></p><p>è¿™é‡Œè¿˜æä¾›äº†ä¸€ç§ Aurora çš„æ€è·¯ï¼šåœ¨ Storage Tier å» Apply Logï¼Œåšåˆ°çœŸæ­£çš„ Log-is-database (å¯ä»¥æƒ³è±¡ä¸€ä¸‹ä¸ºä»€ä¹ˆ PolarDB ä¸æ˜¯å®Œå…¨çš„ Log-is-database) é€šè¿‡å‡å°‘å­˜å‚¨é€šç”¨æ€§æ¥å‡å°‘å¸¦å®½å¼€é”€ã€‚è¿™ç›¸å½“äºå®šåˆ¶å­˜å‚¨å±‚çš„å®ç°ã€‚Socrates å…¶å®ä¹Ÿæ˜¯ä¸€ç§è¿™æ ·çš„æ€è·¯ã€‚è¿™æ ·å‡å°‘äº†å†™å¸¦å®½çš„é™åˆ¶ï¼Œè€Œæå‡äº†ç³»ç»Ÿçš„ä¸Šé™ã€‚ä½†æ˜¯è¿™ç§æ–¹æ¡ˆæœ¬èº«æ˜¯ä½œä¸ºä¸€ç§ç‰¹è´¨åŒ–çš„å­˜å‚¨ï¼Œåœ¨ PolarDB è®¾è®¡è€…æ€è·¯ä¸­æåˆ°ï¼ŒPolarDB è¿™ç§æŠ½å‡ºä¸€ä¸ª FS å±‚å¯èƒ½åœ¨è¿™ä¸ªæ–¹é¢ä¸Šå¹¶ä¸ä¼˜é›…ï¼Œä½†æ˜¯å¯ä»¥æä¾›æ›´å¥½çš„å¯¹ MySQL é€‚é…çš„èƒ½åŠ›ï¼ŒåŒæ—¶ï¼ŒPolarDB ä¹Ÿå¯ä»¥ä¾èµ–ä»»æ„çš„å—å­˜å‚¨æœåŠ¡ï¼Œè¿™ä¹Ÿæä¾›äº†äº‘ä¸Šçš„æ‰©å±•æ€§ã€‚ä¸è¿‡å†è¯´ä¸‹å»æ„Ÿè§‰å°±æ¶‰åŠä¸€äº›ç±»ä¼¼é˜¿é‡Œäº‘æ”¿æ²»é—®é¢˜æˆ–è€…äº§å“å”®å–æœåŠ¡çš„é—®é¢˜äº†ï¼Œæ€è€ƒè¿™ä¸ªå°±ä¸æ˜¯æˆ‘è¿™ä¸ªæŠ€æœ¯å‘˜çš„ä¸“é•¿äº†ã€‚æœ‰ä»€ä¹ˆè¯„è®ºå€’æ˜¯å¯ä»¥æä¸€ä¸‹ã€‚</p><p>æœ¬è®ºæ–‡æä¾›äº†ä¸€ç§ä¼˜åŒ–æ¡†æ¶ï¼Œé€šè¿‡å¯¹æ¯” äº‘ä¸Šå—å­˜å‚¨æœåŠ¡å’Œ SSD çš„ bandwidth, latency, å¼¹æ€§, å®¹é‡ï¼Œæ¥ä»‹ç»å®ƒä»¬å¯¹æ•°æ®åº“å®ç°çš„å½±å“ï¼Œç„¶åè¿›è¡Œç›¸å…³çš„ä¼˜åŒ–ã€‚ä¸‹é¢æœ‰ä¸€ä¸ªå¯¹æ¯”çš„ç¡¬ä»¶æ€§èƒ½è¡¨æ ¼ï¼š</p><p><img src="https://image.mwish.me/blog-image/FD0FD85E-428C-4382-A83E-91FA7331F3BD.png" alt="FD0FD85E-428C-4382-A83E-91FA7331F3BD"></p><p>å¯ä»¥çœ‹åˆ°ï¼š</p><ul><li>ä» baotiao çš„æ¼”è®²ä¸Šçœ‹ï¼ŒStorage X å…¶å®æ˜¯ ebs ç›˜ã€‚ä¸ºäº†é¿å… benchmark ç¢°ç“·ï¼Œè¿™é‡Œä¼šé¿å…æåˆ°åå­—ï¼Œä¸è¿‡è¿™ä¸ªæµ‹è¯•åº”è¯¥æ˜¯å¯¹ PolarDB éå¸¸æœ‰åˆ©çš„</li><li>Latency è¿™é‡Œå·¦è¾¹æ˜¯å¹³å‡ï¼Œå³è¾¹æ˜¯æ–¹å·®ã€‚å…¶ä»–çš„éƒ½æ˜¯æ°ªé‡‘å¯ä»¥ä¹°çš„å¤§å°ä¸Šé™ã€‚è¿™é‡Œå¯ä»¥æä¸€ä¸‹ï¼Œé˜¿é‡Œäº‘çš„ ESSD å’Œ PolarStore éƒ½èµ°çš„æ˜¯ RDMAï¼Œç›¸å¯¹æ¥è¯´æä¾›äº†å¾ˆå¥½çš„æ€§èƒ½å’Œæš´åŠ›ä¼˜åŒ–ç©ºé—´ã€‚</li><li>äº‘å­˜å‚¨æœ‰ç€æ›´å¤§çš„ Volumeï¼Œæ›´å¤§çš„æ€»å¸¦å®½ï¼Œä½†æ˜¯ latency å¯èƒ½ä¼šéå¸¸é«˜. æ® baotiao è¯´ï¼Œåˆ· Page ä¸€èˆ¬å»¶æ—¶æ˜¯ 50usï¼Œåœ¨äº‘ç›˜ä¸Šä¼šå‡åˆ° 200usã€‚å’Œæœ¬æ–‡æµ‹è¯•æ•°æ®åŸºæœ¬ä¸Šæ˜¯ä¸€ä¸ªé‡çº§çš„ã€‚</li><li>åœ¨äº‘å­˜å‚¨ä¸­ï¼Œå¤šä¸ªèŠ‚ç‚¹ä¹‹é—´çš„åˆ†æ•£è®¿é—®<strong>è¯»å†™éƒ½å¯ä»¥</strong>åˆ©ç”¨æ›´å¤šçš„ç¡¬ä»¶èµ„æºï¼Œä¾‹å¦‚å°†å•ä¸ªå¤§I/Oå¹¶å‘åˆ†æ•£è‡³ä¸åŒå­˜å‚¨èŠ‚ç‚¹ ï¼Œå……åˆ†åˆ©ç”¨èšåˆå¸¦å®½ã€‚</li></ul><p>æ–‡ç« æ¼”ç¤ºäº†ä¸€ä¸‹å¸¦å®½æ‰“æ»¡çš„åœºæ™¯ï¼Œæˆ‘æ„Ÿè§‰è™½ç„¶å±äºæ‹¼å‡‘ï¼Œç±»ä¼¼ WiscKey è®² IO ä¸²è¡Œå’Œå¹¶è¡Œçš„ï¼Œä½†æ˜¯åœ¨è¿ç§»ä»£ç è€Œä¸æ˜¯å¾ˆç²¾ç»†çš„ä»é›¶å¼€å§‹å†™çš„æ—¶å€™ï¼Œè¿˜æ˜¯æœ‰ä¸€äº›é“ç†çš„ï¼š</p><p>ä¸‹é¢ Local SSD å’Œ Cloud storage å¯¹æ¯”å¯ä»¥çœ‹çœ‹ï¼ŒåŒæ—¶ scattered I/O æ˜¯åˆ©ç”¨æ‰“æ•£ IO ä¹‹åçš„ç­–ç•¥ã€‚å½“ç„¶æˆ‘ä¸ªäººè§‰å¾—çº¿ç¨‹æ˜¯ Polar çš„å·¥ç¨‹ï¼Œè€Œä¸æ˜¯ä¸¥è°¨çš„ IO æµ‹è¯•æœ¯è¯­ï¼Œä¸è¿‡è¿™ä¸ªå›¾å·²ç»èƒ½æ¯”è¾ƒå¥½çš„è¡¨ç¤ºä¸€äº›ç»“è®ºäº†ã€‚</p><p><img src="https://image.mwish.me/blog-image/4CA96E19-8F62-4A93-AEB6-2E2A87DF217B.png" alt="4CA96E19-8F62-4A93-AEB6-2E2A87DF217B"></p><p>åŒæ—¶ï¼Œè¿™é‡Œå…±äº«ä¸€ç»„ IO æ± å­çš„è¯ï¼Œå¦‚æœå¹¶å‘ä¸Šå»äº†ï¼ŒæŠŠ IO-queue æ‰“æ»¡äº†ï¼Œå»¶æ—¶å¯èƒ½ä¼šå—åˆ°ä¸€å®šçš„å½±å“ï¼Œè€Œ WAL è¿™ç§<strong>å‰å°ä½œä¸š</strong>åº”è¯¥å¤§éƒ¨åˆ†æ—¶å€™æ˜¯å»¶æ—¶æ›´æ•æ„Ÿçš„ï¼ˆç”¨æˆ· SQL å¯èƒ½å¡åœ¨ Page è¯»å’Œ WAL å†™ä¸Šï¼‰ï¼ŒFlush Page åˆ™å¸¦å®½æ›´åŠ æ•æ„Ÿï¼Œè¿™é‡Œä¹Ÿåšäº†ä¸€äº›å®éªŒã€‚è¿™é‡Œ Flush å äº† 80% çš„å¸¦å®½ï¼Œç„¶ååœ¨å¸¦å®½å ç“¶é¢ˆçš„åœºæ™¯ä¸‹ï¼Œ Flush å¡äº†ä¸€ä¸‹å‰å° Log æ„Ÿè§‰å°±çˆ†ç‚¸äº†ï¼š</p><p><img src="https://image.mwish.me/blog-image/28544914-5294-4B23-B7F9-B3103820E0D9.png" alt="28544914-5294-4B23-B7F9-B3103820E0D9"></p><p>CloudJump é¢ä¸´ä»¥ä¸‹æŠ€æœ¯æŒ‘æˆ˜ï¼š</p><ul><li>è¿œç¨‹åˆ†å¸ƒå¼å­˜å‚¨é›†ç¾¤çš„è®¿é—®å¯¼è‡´äº‘å­˜å‚¨æœåŠ¡çš„<strong>I/Oå»¶è¿Ÿé«˜</strong>ï¼›</li><li>é€šå¸¸èšåˆI/Oå¸¦å®½æœªè¢«å……åˆ†åˆ©ç”¨ï¼Œè¿™ä¸ªé—®é¢˜ä½“ç°åœ¨æ¯”è¾ƒå¤šæ–¹é¢ï¼Œåæ–‡ç»†è®²ï¼›</li><li>åœ¨å…·æœ‰æœ¬åœ°å­˜å‚¨çš„å•æœºä¸Šè¿è¡Œè‰¯å¥½ä½†éœ€è¦é€‚åº”äº‘å­˜å‚¨è€Œå¯¼è‡´ç‰¹æ€§æ”¹å˜çš„ä¼ ç»Ÿè®¾è®¡ï¼Œä¾‹å¦‚ page cacheï¼ˆè¿™ä¸ªåœ°æ–¹åº”è¯¥æ˜¯æŒ‡ RW / RO èŠ‚ç‚¹çš„ Page Cacheï¼Œä¹‹é—´åŒæ­¥æŒ‰ç…§ CPU é‚£æ ·è®¾è®¡ç›¸å½“äºèµ°ä¸€å¥— MESI åè®®ï¼‰ï¼›</li><li>é•¿é“¾è·¯å¯¼è‡´å„ç§æ•°æ®åº“I/Oæ“ä½œä¹‹é—´çš„éš”ç¦»åº¦è¾ƒä½ï¼ˆä¾‹å¦‚ï¼Œæ—¥å¿—åˆ·å†™ä¸å¤§é‡æ•°æ®I/Oçš„ç«äº‰ï¼Œä¸€èˆ¬æ—¥å¿—åˆ·å†™åœ¨ç”¨æˆ·å‰å°é“¾è·¯ä¸Šï¼Œæ•°æ® I/O åœ¨åå°çš„é“¾è·¯ç³»ç»Ÿä¸Šï¼‰ï¼›<ul><li>æˆ‘ç†è§£æœ¬èº« SSD IO ä¹Ÿæœ‰è¿™ä¸ªé—®é¢˜ï¼Œä½†æ˜¯ SSD IO å¸¦å®½åŸºæœ¬ä¸é‚£ä¹ˆèƒ½æ‰“æ»¡ï¼Œä¸Šäº‘åŠ å‰§äº†è¿™ä¸ªé—®é¢˜ï¼Œä¸çŸ¥é“ ScyllaDB æ˜¯æ€ä¹ˆå¤„ç†çš„ã€‚<a href="https://www.scylladb.com/2022/08/03/implementing-a-new-io-scheduler-algorithm-for-mixed-read-write-workloads/">https://www.scylladb.com/2022/08/03/implementing-a-new-io-scheduler-algorithm-for-mixed-read-write-workloads/</a> çœ‹ä¸Šå»è¿™ä¸ªåœ°æ–¹ CommitLog åº”è¯¥ä¼šå•ç‹¬æœ‰ä¸€éƒ¨åˆ† IO</li></ul></li><li>äº‘ç”¨æˆ·å…è®¸ä¸”å¯èƒ½ä½¿ç”¨éå¸¸å¤§çš„å•è¡¨æ–‡ä»¶ï¼ˆä¾‹å¦‚æ•°åTBï¼‰è€Œä¸è¿›è¡Œæ•°æ®åˆ‡åˆ†ï¼Œè¿™åŠ å‰§äº†I/Oé—®é¢˜çš„å½±å“ã€‚</li></ul><p>è¿™é‡Œä¹Ÿå¼•å…¥äº†ä¸€äº›ä¼˜åŒ–å› ç´ ï¼ˆä¸‹é¢è®ºæ–‡çš„ç”¨è¯æå…¶æ··ä¹±ï¼Œçœ‹å†…å®¹æ¯”è¯æ±‡æ›´é‡è¦ï¼‰ï¼š</p><ul><li><strong>Thread-level Parallelism</strong>ï¼šä¾‹å¦‚ä¾æ®I/Oç‰¹æ€§å®éªŒï¼Œé‡‡ç”¨ï¼ˆæ›´ï¼‰å¤šçº¿ç¨‹çš„æ—¥å¿—ã€æ•°æ®I/Oçº¿ç¨‹åŠå¼‚æ­¥I/Oæ¨¡å‹ï¼Œå°†<strong>æ•°æ®å……åˆ†æ‰“æ•£åˆ°å¤šä¸ªå­˜å‚¨èŠ‚ç‚¹ä¸Š</strong>ã€‚<ul><li>æœ¬è´¨ä¸Šè¿™ä¸ªå…¶å®å’Œ InnoDB åº”è¯¥å…³ç³»å¾ˆå¤§ï¼Œå› ä¸ºæ— è®ºæœ¬èº« InnoDB è¿˜æ˜¯ RocksDBï¼ŒWAL éƒ½æ˜¯å•çº¿ç¨‹å†™çš„ï¼Œç”šè‡³æœ‰çš„åº“ Page éƒ½æ˜¯å•çº¿ç¨‹åˆ·çš„ã€‚è¿™é‡Œä¼šæŠŠè¿™ä¸ªå•çº¿ç¨‹è¿›è¡Œæ‹†åˆ†ã€‚è¿™é‡ŒæŒ‡çš„å½“ç„¶ä¸æ˜¯ Morsel Driven Database Exec é‚£ç§ Parallelismï¼Œä¸‹æ–‡ Task-Level Parallelism åŒç†</li><li>å®é™…ä¸Šï¼Œå•çº¿ç¨‹çš„è¿™ç§å†™ï¼Œåœ¨å•æœºç¯å¢ƒå¯èƒ½å¯ä»¥æ‰“æ»¡å­˜å‚¨ï¼Œä½†æ˜¯åœ¨äº‘å­˜å‚¨å»¶è¿Ÿçˆ†ç‚¸çš„åœºæ™¯ä¸‹ï¼Œè¿™ä¸ªå°±å¾ˆæˆé—®é¢˜äº†ã€‚è¿™é‡Œä¼šå¯¼è‡´è¿™ä¸ªæˆä¸ºç“¶é¢ˆã€‚PolarDB åˆ‡åˆ†äº†æ—¥å¿—å¤§å°ï¼Œç„¶åå†™å…¥çš„æ—¶å€™å» log writer ä¼šæ ¹æ®æ¯ä¸ª Partition çš„ Log çŠ¶å†µå»åšå…·ä½“çš„ IOï¼ˆå¯ä»¥å›é¡¾ä¸€ä¸‹ InnoDB Redo Logï¼Œå®ƒæœ¬èº«ä¹Ÿæ˜¯åˆ†æˆä¸åŒä¸åŒå°å—çš„ï¼Œè§å…¶ LSN è·å–é€»è¾‘ï¼‰ã€‚å½“ç„¶ baotiao è¯´è¿™é‡Œæœ‰ä¸€äº›å¯¹é½å—å¤§å°çš„ä¼˜åŒ–ï¼Œå’Œä¸ç”¨ ftruncate åˆå§‹åŒ–å—å…¨0çš„ä¼˜åŒ–ï¼Œæ¥é™ä½ç”¨æˆ·é“¾è·¯ä¸Šçš„å¼€é”€ã€‚</li></ul></li><li><strong>Task-level Parallelism</strong>ï¼šä¾‹å¦‚å¯¹é›†ä¸­Log bufferæŒ‰Page Partitionåˆ†ç‰‡ï¼Œå®ç°å¹¶è¡Œå†™å…¥å¹¶åŸºäºåˆ†ç‰‡è¿›è¡Œå¹¶è¡ŒRecoveryã€‚<ul><li>æœ¬è´¨ä¸Šï¼Œè¿™ä¸ªç±»ä¼¼åˆ· Page çš„æ—¶å€™çš„ IOã€‚ä½ å¦‚æœèµ°ä¸€æ¡æµï¼Œåˆ·åˆ°ä¸€å—ç›˜ä¸Šå°±å¾ˆå°´å°¬ï¼Œè¿™é‡Œä¹Ÿå¯¹è¿™éƒ¨åˆ†è¿›è¡Œäº†åˆ‡åˆ†ï¼Œè®©ä¸åŒçš„ Page (æˆ–è€…è¯´ SST ç”šè‡³æ˜¯ SST Blockï¼‰èƒ½å¤Ÿåˆ·åˆ°ä¸åŒçš„ Chunk ä¸Šï¼Œæ¥æä¾›ä¼˜åŒ–ã€‚</li><li>è¿™ä¸ªä¼˜åŒ–ä¸ä»…æ˜¯å†™é“¾è·¯ä¸Šçš„ï¼Œæ¢å¤é“¾è·¯ä¸Šä¹Ÿå¯ä»¥ä»¥åŒæ ·çš„æ–¹å¼å¾—åˆ°è¯»çš„ super bonusã€‚</li></ul></li><li><strong>Reduce remote read and Prefetching</strong>ï¼šä¾‹å¦‚é€šè¿‡æ”¶é›†å¹¶èšåˆåŸåˆ†æ•£metaè‡³ç»Ÿä¸€çš„superblockï¼Œå°†å¤šä¸ªI/Oåˆä¸€å®ç°fast validatingï¼›é€šè¿‡é¢„è¯»åˆ©ç”¨èšåˆè¯»å¸¦å®½ã€å‡å°‘è¯»ä»»åŠ¡å»¶æ—¶ï¼›é€šè¿‡å‹ç¼©ã€filterè¿‡æ»¤å‡å°‘è¯»å–æ•°æ®é‡ã€‚ä¸æœ¬åœ°SSDä¸Šç›¸æ¯”ï¼Œè¿™äº›æŠ€æœ¯åœ¨äº‘å­˜å‚¨ä¸Šæ›´èƒ½è·å¾—æ”¶ç›Šã€‚<ul><li>è¿™ä¸ªåœ°æ–¹æ˜¯è¯´ï¼Œå¤šä¸ªç¢ I/O åˆæˆä¸€ä¸ªçœŸå®å¯¹è¿œç«¯çš„ IOï¼ŒLinux çš„ä¸€äº› deadline ä¹‹ç±»çš„é˜Ÿåˆ—ä¹Ÿä¼šåš IO åˆå¹¶ï¼Œæ„Ÿè§‰æ˜¯çº¿ä¸Šå¯èƒ½æ¯”è¾ƒç±»ä¼¼</li><li>å½“ç„¶ï¼ŒPrefetching ä¸æ˜¯ä¸‡çµè¯ï¼Œæœ¬è´¨ä¸Š Scan Task ä¼šè®© DB å±‚åš Prefetchingï¼Œä½†æ˜¯ Prefetching ä¹Ÿä¼šå ç”¨ç³»ç»Ÿçš„å†…å­˜ã€‚æ„Ÿè§‰åšèµ·æ¥æ˜¯ä¸€ä¸ªå¾ˆéš¾å¾ˆç²¾ç»†çš„äº‹æƒ…ï¼Œåˆæ˜¯å˜´çš®åŠ¨ä¸€ä¸‹ï¼Œå®ç°å¾ˆéš¾çš„ä¸œè¥¿ã€‚</li></ul></li><li><strong>Fine-grained Locking and Lock-free Data Structures</strong>ï¼šäº‘å­˜å‚¨ä¸­è¾ƒé•¿çš„I/Oå»¶è¿Ÿæ”¾å¤§äº†åŒæ­¥å¼€é”€ï¼Œä¸»è¦é’ˆå¯¹Update-in-placeç³»ç»Ÿï¼Œå®ç°æ— é”åˆ·è„ã€æ— é”SMOç­‰ã€‚<ul><li>å¸¦é” I/O æœ¬æ¥å°±æ¯”è¾ƒé‡äº†ï¼Œåœ¨äº‘ç¯å¢ƒå¸¦é” IO æ„Ÿè§‰ä¼šé‡ä¸ŠåŠ é‡ã€‚è¿™ä¸ªåœ°æ–¹å¯ä»¥ç”¨ä¸€äº›æ–¹æ³•æ¥æš´åŠ›ä¼˜åŒ–ã€‚å½“ç„¶è¿™éƒ¨åˆ†æ˜¯å¹ç‰›ä¸¤ä¸ªå­—ï¼Œå·¥ç¨‹åšæ­»äººçš„é‡è¦å…¸èŒƒã€‚</li></ul></li><li><strong>Scattering among Distributed Nodes</strong>ï¼šåœ¨äº‘å­˜å‚¨ä¸­ï¼Œå¤šä¸ªèŠ‚ç‚¹ä¹‹é—´çš„åˆ†æ•£è®¿é—®å¯ä»¥åˆ©ç”¨æ›´å¤šçš„ç¡¬ä»¶èµ„æºï¼Œä¾‹å¦‚å°†å•ä¸ªå¤§I/Oå¹¶å‘åˆ†æ•£è‡³ä¸åŒå­˜å‚¨èŠ‚ç‚¹ ï¼Œå……åˆ†åˆ©ç”¨èšåˆå¸¦å®½ã€‚<ul><li>è¿™ä¸ªåœ°æ–¹çœ‹ä¸Šå»å’Œ Reduce Remote Read çŸ›ç›¾ï¼Œå…¶å®æ˜¯å° IO åˆå¹¶ï¼Œå¤§ I/O çŒœæµ‹ Chunk çš„åˆ†å¸ƒæ¥å¹¶è¡Œè®¿é—®ã€‚æ„Ÿè§‰è¿™ä¸ªéœ€è¦æœ‰ä¸€äº›å¯¹ Chunk å†…å®¹çš„å…ˆéªŒçŸ¥è¯†ã€‚æˆ–è€…æ‰‹åŠ¨å¹²é¢„è¿™ä¸­é—´çš„ç‰©ç†åˆ†å¸ƒã€‚</li><li>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œè¯»å†™éƒ½èƒ½ä» Scatter ä¸­å—ç›Šã€‚ä½†æœ¬èº« Scatter ä¹Ÿæ„å‘³ç€å¾ˆå¤šå¥‡æ€ªçš„ä¸œè¥¿ã€‚æˆ‘ä¸ªäººè§‰å¾—è¿™ç©æ„åœ¨å¤§å…¬å¸èƒ½æ‰¾åˆ°å­˜å‚¨å±‚çš„äººæ­£é¢ PVP æˆ–è€…æ‹‰ä»–ä»¬ä¸€èµ·ä¼˜åŒ–çš„è¯ä¼šæ¯”è¾ƒå¥½åšã€‚</li></ul></li><li><strong>Bypassing Caches</strong>ï¼šé€šè¿‡Bypassing Cachesæ¥é¿å…åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿçš„cache coherenceï¼Œå¹¶åœ¨DBå±‚é¢ä¼˜åŒ–I/Oæ ¼å¼åŒ¹é…å­˜å‚¨æœ€ä½³requestæ ¼å¼ã€‚<ul><li>å…¶å®è™½ç„¶ Parquet æ˜¯åˆ—å­˜æ ¼å¼ï¼Œä½†æ˜¯ä½ å¯ä»¥ç±»æ¯”è¿ç§»åˆ° Parquet çš„ Footerã€‚Footer åŒ…å«æ‰€æœ‰ rg çš„ä¿¡æ¯ã€‚</li><li>è¿™ä¸ªåœ°æ–¹åº”è¯¥æ˜¯ç»•è¿‡åˆ†å¸ƒå¼ç¼“å­˜ï¼Œæˆ‘ä¸ªäººç†è§£æ˜¯ï¼Œå¯¹ TP ç³»ç»Ÿè€Œè¨€ï¼Œåˆ†å¸ƒå¼ç¼“å­˜æœ¬èº«ä¸æ˜¯é‚£ä¹ˆå¥½çš„ä¸œè¥¿ï¼Œå•æœº cache ä¸€ä¸‹å·®ä¸å¤šå¾—äº†</li></ul></li><li><strong>Scheduling Prioritized I/O Tasks</strong>ï¼šç”±äºè®¿é—®é“¾è·¯æ›´é•¿ï¼ˆå¦‚è·¯å¾„ä¸­å­˜åœ¨æ›´å¤šçš„æ’é˜Ÿæƒ…å†µï¼‰ï¼Œä¸å¡«I/Oè¯·æ±‚é—´çš„éš”ç¦»æ€§ç›¸å¯¹æœ¬åœ°å­˜å‚¨æ›´ä½ï¼Œå› æ­¤éœ€è¦åœ¨DBå±‚é¢å¯¹ä¸åŒI/Oè¿›è¡Œæ‰“æ ‡ã€è°ƒåº¦ä¼˜å…ˆçº§ï¼Œä¾‹ï¼šä¼˜å…ˆWALã€é¢„è¯»åˆ†çº§ã€‚<ul><li>ï¼ˆå¯¹ç€ ScyllaDB å—¯æŠ„ï¼ï¼‰</li><li>æœ¬è´¨ä¸Šï¼Œè¿™ä¸ªç›¸å½“äºè®¾è®¡ Log Page ç­‰ä¸åŒå½¢å¼çš„ IOï¼Œåœ¨ db å±‚æ‰“æ ‡ï¼Œfs å±‚å¤„ç†ã€‚</li></ul></li></ul><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œå¯ä»¥åœ¨å®ç°å±‚æ¬¡æ˜ç¡®ä¸€ä¸‹è¯­ä¹‰ã€‚è¿™é‡Œæœ‰çš„ä¸œè¥¿æ˜¯ fs å±‚åšçš„ï¼Œæœ‰çš„ä¸œè¥¿æ˜¯ db å±‚åšçš„ã€‚fs å±‚å¯ä»¥åˆå¹¶æˆ–è€…æ“ä½œä¸€äº›åœ¨ fs ä¸Šè¿ç»­çš„æ“ä½œï¼Œä½†æ˜¯å¾ˆå¤šä¸œè¥¿å…¶å®æ˜¯è¦ db æ¥æ‰“ tag æˆ–è€…ä»¥ä¸€äº›æ–¹å¼æ¥ååŒå®Œæˆçš„ã€‚</p><p>è¿™é‡Œåœ¨ä¸‹å›¾è¿›è¡Œäº†è¯„ä¼°ï¼š</p><p><img src="https://image.mwish.me/blog-image/685DC7F0-FD35-4EEB-B01C-3F1E0ECCD458.png" alt="685DC7F0-FD35-4EEB-B01C-3F1E0ECCD458"></p><p>ï¼ˆä½ çœ‹è¿™é‡Œå…¨éƒ½æ˜¯é»‘è¯ï¼Œæˆ‘ä¸ç»™ä½ è§£é‡Šä¸€éä½ è¿˜åœ¨è¿™å—¯æƒ³ä»–åœ¨æä»€ä¹ˆèŠ±æ‹›å‘¢ï¼Œä½ æ˜¯ä¸æ˜¯å¾—æ„Ÿè°¢ä¸€ä¸‹æˆ‘ï¼‰</p><p>è¿™é‡Œè¿˜æœ‰ä¸€ä¸ªç»†èŠ‚ï¼Œæ˜¯ç»å…¸çš„ btr å’Œ LSM å¤§æˆ˜ã€‚è¿™ä¸ªåœ°æ–¹å¯ä»¥ Ref ä¸€ä¸‹ä½œè€…åœ¨çŸ¥ä¹ä¸Šçš„ä¸€ç‚¹ Notesï¼Œä¸ä¿è¯å¯¹ï¼Œä½†æ˜¯çœ‹ç€ç¡®å®æœ‰è‡ªå·±çš„æ€è€ƒï¼š</p><blockquote><p>ä»è®ºæ–‡çš„è§’åº¦ï¼Œæˆ‘ä»¬éœ€è¦è¿½æ±‚è®¨è®ºçš„å®Œå¤‡æ€§ï¼Œå¤„å¤„éƒ½ä¼šå¯¹æ¯” B-tree å’Œ LSM-treeï¼Œçœ‹èµ·æ¥æ˜¯åœ¨å›ç­”ä¸€ä¸ªå­˜å‚¨å¼•æ“æŠ€æœ¯é€‰å‹çš„é—®é¢˜ã€‚å…·ä½“çš„å†…å®¹æ¬¢è¿å¤§å®¶åˆ°æ–‡ç« é‡Œå»çœ‹ã€‚æ­¤å¤„æˆ‘æƒ³åŒºåˆ†ä¸€ä¸ªæ¦‚å¿µï¼Œå°±æ˜¯äº§å“ä¼˜å…ˆçš„é€‰å‹å’ŒæŠ€æœ¯ä¼˜å…ˆçš„é€‰å‹æ˜¯ä¸ä¸€æ ·çš„ã€‚</p><p>ä»æŠ€æœ¯è§’åº¦æ¥è¯´ï¼ŒLSM-tree éš¾ä»¥æä¾›ç¨³å®šçš„æ€§èƒ½ï¼Œå…¶è¯»å†™æ”¾å¤§éƒ½å¤ªå¤§äº†ã€‚ä¸ºäº†åšæˆä¸€ä¸ªå¥½çš„äº§å“ï¼Œåƒ OB è¿™æ ·ç”¨ LSM-tree ç”¨å¾—æ¯”è¾ƒå¥½çš„ç³»ç»Ÿï¼Œå…¶å®æ˜¯ä½¿ç”¨äº†ä¸€äº›æˆæœ¬è¾ƒé«˜çš„æ¶æ„æ‰å®ç°çš„è¿™ä¸€ç‚¹ã€‚æ¯”å¦‚å¤§å®¶å¦‚æœç‚¹å¼€ OB çš„ TPC-C ç»“æœï¼Œä¼šå‘ç°å®ƒçš„å•ä¸ªæ•°æ®åº“èŠ‚ç‚¹åæ‹¥ 712 GB å†…å­˜ï¼Œè€Œæ•´ä¸ªé›†ç¾¤åƒè¿™æ ·çš„å¤§èŠ‚ç‚¹ä¸€å…±æœ‰ 1557 ä¸ªã€‚å¦‚æœæ²¡æœ‰æ¯”è¾ƒå¤§çš„è§„æ¨¡ï¼Œåƒ OB è¿™æ ·çš„åˆ†å¸ƒå¼æ•°æ®åº“å¾ˆéš¾å®ç° 8 å°æ—¶å†… tpmC æ€§èƒ½æ³¢åŠ¨å°äº 2% è¿™æ ·çš„æ€§èƒ½ç¨³å®šæ€§è¦æ±‚ã€‚åœ¨äº‘ä¸Šï¼ŒOB éœ€è¦ä½¿ç”¨å¤šç§Ÿæˆ·è¿™æ ·çš„å½¢å¼æ¥é™ä½å•ä¸ªç”¨æˆ·çš„ä½¿ç”¨æˆæœ¬ã€‚</p><p>OB åšè¿™æ ·çš„è®¾è®¡æ˜¯å› ä¸ºä»–ä»¬ä¸€å¼€å§‹å°±å‡è®¾äº†å……è¶³çš„å†…å­˜ï¼Œå……è¶³åˆ°ä¸€ä¸ªæ•°æ®åº“çš„å†…å­˜å¯ä»¥å……åˆ†ç¼“å­˜ä¸€å¤©ä¹‹å†…çš„æ‰€æœ‰å˜æ›´ï¼Œä»¥è‡³äºæ¯å¤©åªéœ€è¦åœ¨å¤œæ·±äººé™çš„æ—¶å€™åšä¸€æ¬¡ compaction å°†å†…å­˜é‡Œé¢çš„å˜æ›´ä¸ç£ç›˜ä¸Šçš„åŸºçº¿æ•°æ®åˆå¹¶ã€‚è¿™æ ·ä¸ä»…æ€§èƒ½ç¨³å®šï¼Œè€Œä¸” compaction å¯¹èµ„æºçš„å ç”¨ä¹Ÿè¢«å°½å¯èƒ½åœ°éšè—äº†ï¼ŒOB ç”šè‡³è¿˜åœ¨åŒä¸€ä¸ª paxos group å†…æè½®è½¬åˆå¹¶ï¼Œè¿›ä¸€æ­¥éšè— compaction çš„å½±å“ã€‚è¿™å¥—è®¾è®¡æŒºå‰å®³çš„ï¼Œå°±æ˜¯å¤ªè´µäº†ã€‚</p><p>å¦‚æœå¤§å®¶äº†è§£å…¬å…±äº‘æ•°æ®åº“çš„è¯å°±ä¼šçŸ¥é“ï¼Œç»å¤§éƒ¨åˆ†ç”¨æˆ·çš„æ•°æ®åº“èŠ‚ç‚¹ä¸€èˆ¬æ˜¯ 4C8G æˆ–è€… 8C16G è¿™æ ·çš„å°è§„æ ¼ï¼Œä¸ OB çš„èŠ‚ç‚¹è§„æ¨¡ç›¸å·®éå¸¸å¤§ã€‚</p><p>åŒä¸€ä¸ª LSM-tree subtable å†…éƒ¨ä¸åŒçš„åˆ†å±‚ä¹‹é—´å› ä¸ºå­˜åœ¨æ•°æ®è€¦åˆï¼Œä¸ºäº†åšä¸€ä¸ª getï¼Œå¦‚æœæˆ‘ä»¬åªå®šä½ä¸€ä¸ª extentï¼Œæ˜¯æ²¡åŠæ³•ç¡®å®šå…¶ä¸­å­˜å‚¨çš„æ•°æ®æ˜¯ä¸æ˜¯æˆ‘ä»¬æ‰€éœ€è¦çš„ key çš„å®Œæ•´ valueã€‚è¿™æ ·ä¸åˆ©äº LSM-tree çš„æ•°æ®åƒ page ä¸€æ ·åœ¨åˆ†å¸ƒå¼å­˜å‚¨é›†ç¾¤é‡Œé¢è‡ªç”±åœ°æ‘†æ”¾ã€‚å¦‚æœ extent æ‰“æ•£äº†ï¼Œæ¯æ¬¡æŸ¥è¯¢çš„æ—¶å€™éƒ½éœ€è¦åšè·¨ç•Œç‚¹çš„ mergeã€‚</p></blockquote><p>ï¼ˆä¸Šæ–‡æ‘˜è‡ªçŸ¥ä¹æ–‡ç« ï¼š<a href="https://zhuanlan.zhihu.com/p/548215678"> https://zhuanlan.zhihu.com/p/548215678</a> ä¸Šäº‘æ˜¯å­˜å‚¨å¼•æ“æŠ€æœ¯çš„åˆ†æ°´å²­ã€‚æœ¬äººä¿ç•™æ€åº¦ã€‚æ„Ÿè§‰ LSM-Tree æœ¬è´¨ä¸Šæ˜¯æŠŠè¿™ä¸ªå¼€é”€ä» btr çš„ implicit çš„å¹³å¸¸çš„é‡æ“ä½œä¸­æš´éœ²ç»™äº†ç”¨æˆ·ã€‚è‡³äºè¯»å†™ï¼Œå®é™…ä¸Šè¿™æ˜¯ä¸€ä¸ªå¾ˆå¤æ€ªçš„é—®é¢˜ï¼Œå› ä¸º DB å¹¶ä¸æ˜¯ kv å¼•æ“ï¼Œæœ‰å¤§é‡çš„ RWN åœºæ™¯ã€‚ç›´è§‰å’Œç½‘ä¸Šå…³äº LSM çš„ä¸€å¥è¯è¯´æ¸…æ¥šçš„å¯¹æ¯”ææ–™å®é™…ä¸Šæˆ‘è§‰å¾—éƒ½æ˜¯çœŸç©ºçƒå‹å¯¹æ¯”ã€‚<em>æˆ‘ä¸ªäººè§‰å¾—ï¼Œæˆ‘ä»¬åªèƒ½å…³æ³¨ï¼Œåœ¨å…·ä½“å®ç°ä¸Šï¼Œæ¯ä¸ªé“¾è·¯ IO æ˜¯ä»€ä¹ˆæ ·çš„ï¼Œä»€ä¹ˆåœ¨å‰å°ï¼Œä»€ä¹ˆåœ¨åå°</em>ã€‚ï¼‰</p><h2 id="PolarDB-çš„ä¼˜åŒ–"><a href="#PolarDB-çš„ä¼˜åŒ–" class="headerlink" title="PolarDB çš„ä¼˜åŒ–"></a>PolarDB çš„ä¼˜åŒ–</h2><p><img src="https://image.mwish.me/blog-image/2e5f67c2-763c-49b3-926e-7b795df30525.png" alt="2e5f67c2-763c-49b3-926e-7b795df30525"></p><p>è¿™é‡Œçš„ P æ˜¯é‡‡ç”¨çš„ä¼˜åŒ–ï¼Œåœ¨ RW èŠ‚ç‚¹ä¸Šï¼Œä¸»è¦å’Œå†™é“¾è·¯æœ‰å…³ã€‚è¿™é‡Œæœ€å¤šå¯ä»¥æœ‰ 15 ä¸ª RO èŠ‚ç‚¹ï¼Œåœ¨ ROã€€èŠ‚ç‚¹ä¸Šï¼Œé‡‡å–äº†ä¸€äº›è¯»ç›¸å…³çš„å’Œæ¢å¤ç›¸å…³çš„ä¼˜åŒ–ã€‚ä¸€äº›ä¼˜åŒ–ä¸¤è¾¹éƒ½æœ‰ï¼ŒåŒ…æ‹¬ Page å’Œ Log çš„ Readã€‚</p><h3 id="Accelerating-Persistent-WAL"><a href="#Accelerating-Persistent-WAL" class="headerlink" title="Accelerating Persistent WAL"></a>Accelerating Persistent WAL</h3><p>è¿™é‡Œè§‚å¯Ÿåˆ°ï¼Œå¤§éƒ¨åˆ† mtr ä¸²è¡Œæ‹·è´ï¼Œè€Œä¸”åªå†™ä¸€ä¸ª Pageï¼Œè¿™é‡Œç”¨ Link_buf æ¥ Merge å¯¹ä¸‹å±‚çš„ IOï¼Œè½¬åŒ–ä¸ºå¤§å—çš„å¯èƒ½è·¨ Block çš„é¡ºåº IO</p><p>è¿™é‡Œé‡‡å–çš„ä¼˜åŒ–æ˜¯ï¼Œåˆ‡åˆ† Log Bufferï¼ŒæŒ‰ç…§ Page_ID åšä¸€äº›å°½é‡ç»†çš„åˆ‡åˆ†ã€‚</p><p><img src="https://image.mwish.me/blog-image/9e4b54b1-9bf1-470a-82df-8b0b7d62d08c.png" alt="9e4b54b1-9bf1-470a-82df-8b0b7d62d08c"></p><p>è¿™é‡Œå¼•å…¥äº†ä¸€ä¸ªç±»ä¼¼å‘é‡æ—¶é’Ÿçš„æ¦‚å¿µï¼Œç„¶åæŠŠ InnoDB çš„æ—¥å¿—å†™åˆ‡åˆ†æˆäº†å‡ ä¸ªé˜¶æ®µï¼š</p><p>å‰å°ï¼š</p><ul><li>Reserve RLSN</li><li>Copy å¤šä¸ªéƒ¨åˆ†çš„æ—¥å¿—ï¼ˆå¯èƒ½ç»å¤§éƒ¨åˆ†æ—¶å€™åªæœ‰ä¸€ä»½ï¼Ÿï¼‰</li><li>æ ‡è®°æ‹·è´å®Œæˆ</li></ul><p>Log ç›¸å…³çš„çº¿ç¨‹ï¼š</p><ul><li>åˆ·çš„æ—¶å€™ï¼Œæ¨é«˜ PLSN</li><li>æ‹¿åˆ° BLSNï¼Œç„¶ååˆ· PLSN - BLSN çš„æ•°æ®</li><li>å¹¶è¡Œå»åˆ·ä¸åŒçš„æ—¥å¿—ï¼Œè¿™é‡Œæœ‰ä¸€äº›ç»†èŠ‚è¦åœ¨åé¢ IO å±‚è®¨è®ºã€‚</li></ul><p>åŸå…ˆçš„ LSN è¢«è®¾è®¡ä¸º GPLSNã€‚è¿™é‡Œç›¸å½“äºä»åŸæ¥ LSN å†æ‰©å±•äº†ä¸€å¥—æœºåˆ¶ï¼Œè€Œä¸æ˜¯ç”¨å‘é‡æ—¶é’Ÿå®Œå…¨å–ä»£ GPLSNã€‚è¿™ä¸ªåœ°æ–¹çš„æ­£ç¡®æ€§æ„Ÿè§‰æ˜¯æ¯”è¾ƒ trickey çš„ï¼Œå› ä¸ºæˆ‘æ„Ÿè§‰å…¶å®æœ‰ä¸€ä¸ª LSN å’Œæ—¥å¿—å®Œæ•´æ€§çš„é—®é¢˜ï¼Œ<em>å› ä¸ºå¦‚æœ round-robin çš„è¯è¿˜å¥½ï¼Œä¸ round-robin çš„è¯ï¼ŒLSN æ„Ÿè§‰ä¸å¤ªå¥½ç›´æ¥æ˜ å°„åˆ°æ‰€æœ‰çš„ PLSN</em>ï¼Œä¸è¿‡æ„Ÿè§‰å·¥ç¨‹ä¸Šä¹Ÿæ˜¯å¯ä»¥è§£å†³è¿™äº›é—®é¢˜çš„ï¼Œçœ‹æ–‡ç« ä¼¼ä¹æ˜¯ Log File æœ‰ GLSN â€” Log çš„æ˜ å°„ã€‚</p><p>è¿™é‡Œè¿˜è®¾è®¡äº† Rw åˆ° Ro çš„ Redo Log RDMA å†™ï¼Œæ¥é¿å… fetchlog æ¥å¤§å¹…åº¦å½±å“ RO èŠ‚ç‚¹ï¼ˆæ—¥å¿—æµæ˜¯æ— é™çš„ï¼Œä¸€ç›´æ‹‰æœ¬èº«æ˜¯ä¸ªå¾ˆ trickey çš„äº‹æƒ…ï¼‰ï¼Œä¸è¿‡æ„Ÿè§‰è¿™éƒ¨åˆ†å°±å¾ˆ trickey äº†ï¼Œæœ‰ç‚¹å¤©é¡¶æ˜Ÿç§‘æŠ€ã€‚</p><p>Log Writer å®ç°å¦‚ä¸‹å›¾ï¼š</p><p><img src="https://image.mwish.me/blog-image/ee256e3c-e296-43a2-80ea-01a62fc16ac7.png" alt="ee256e3c-e296-43a2-80ea-01a62fc16ac7"></p><p><img src="https://image.mwish.me/blog-image/13e355c9-774f-46bc-9f05-c5da334c38a9.png" alt="13e355c9-774f-46bc-9f05-c5da334c38a9"></p><p>è¿™é‡Œä¼šæŠŠå•æ®µåˆ‡ç¢çš„ Log Buffer å†åˆ†æˆç»†å°çš„ Log Sliceï¼Œç„¶åå•ä¸ªæ‰“ Buffer å¯èƒ½ä¼šåˆ†é…ç»™å•ä¸ªçº¿ç¨‹ï¼Œæ‰¾å®ƒçš„ Log Writer èµ° async io å‘é€ã€‚è¾¾åˆ°äº†å³èšåˆ IOï¼ˆlog æœ¬èº«æ˜¯ä¸€ç§èšåˆï¼‰åˆåˆ‡ç¢ IO çš„æ–¹å¼ã€‚ä¸è¿‡ IO ä»»åŠ¡å¤šäº†ï¼Œæœ¬è´¨ä¸Šä¹Ÿæ˜¯ä¸€ç§å¾ˆ trickey çš„äº‹æƒ…ã€‚æˆ‘æ„Ÿè§‰è¿™ç§æ–¹æ³•ç±»ä¼¼å¤§åŠ›å‡ºå¥‡è¿¹ã€‚</p><h3 id="Fast-Recovery"><a href="#Fast-Recovery" class="headerlink" title="Fast Recovery"></a>Fast Recovery</h3><p>InnoDB çš„ Log Replay æœ‰ä¸¤ç§å½¢å¼ï¼š</p><ol><li>Crash recovery</li><li>Log Apply in RO node</li></ol><p>ä¼ ç»Ÿçš„ DB æ¢å¤éœ€è¦è¯» HDD/SSD æ•£åœ¨å„å¤„çš„å…ƒä¿¡æ¯ï¼Œç„¶åæ ¹æ®è¿™äº›ä¿¡æ¯ï¼Œå†èµ° ARIES åè®®æ¢å¤ã€‚PolarDB ä¸­å¿ƒåŒ–äº† InnoDB / MySQL çš„å…ƒæ•°æ®ï¼Œè¿›äº†ä¸€ä¸ª Superblock ï¼ˆå¯ä»¥æƒ³è±¡ä¸€ä¸‹ Parquet çš„ Footer éƒ¨åˆ†ä½œä¸ºå¯¹æ¯”ï¼Ÿï¼‰</p><p>è¿™é‡Œå’Œå†™æ—¥å¿—ä¸€æ ·ï¼Œæ¢å¤ä¹Ÿå¯ä»¥å¹¶è¡Œæ¢å¤ï¼Œç„¶ååœ¨ Log File çš„ Header åšäº†ä¸€äº› GLSN â€” Log çš„æ˜ å°„ï¼Œæ¥ä¿è¯ Fast Seekingã€‚</p><p><img src="https://image.mwish.me/blog-image/cd9f6315-8e55-41f0-a28a-f9178e8506aa.png" alt="cd9f6315-8e55-41f0-a28a-f9178e8506aa"></p><p><img src="https://image.mwish.me/blog-image/54a1cd01-ec78-4265-a749-2dcb9984f520.png" alt="54a1cd01-ec78-4265-a749-2dcb9984f520"></p><p>è¿™é‡Œå›å¤çš„æ—¶å€™ï¼Œå¦‚æœæŸä¸ª mtr æ¶‰åŠäº†å¤šä¸ª Pageï¼Œå¯¼è‡´æ¶‰åŠäº†å¤šä¸ª Partitionï¼Œä¹Ÿè¦åŸå­æ¢å¤ã€‚è¿™é‡Œçš„åšæ³•æ˜¯ï¼ŒæŠŠæ‰€æœ‰çš„é€»è¾‘æ“ä½œå’Œæ–‡ä»¶æ“ä½œæ”¾åœ¨ Log Partition 0ï¼Œå¯¼è‡´æœ‰å¤æ‚çš„äº‹åŠ¡å¿…é¡»ç”± Log Partition 0 æ¥åšä¸€äº›å…¨å±€çš„æ¢å¤æµç¨‹ï¼Œç„¶åé€šçŸ¥ Applierã€‚è¿™é‡Œå†æ¢å¤çš„æ—¶å€™ç»´æŠ¤äº†ä¸€ä¸ª recover GLSN æ¥å®ç°è¿™å¥—é€»è¾‘ã€‚</p><p>ï¼ˆå§æ§½ç‰›é€¼ç‰›é€¼ç‰›é€¼ç‰›é€¼ï¼‰</p><h3 id="Prefetching"><a href="#Prefetching" class="headerlink" title="Prefetching"></a>Prefetching</h3><p><img src="https://image.mwish.me/blog-image/d1121804-646f-4184-a010-367088987e93.png" alt="d1121804-646f-4184-a010-367088987e93"></p><p>Prefetch ä¹Ÿæ˜¯ä¸ªå·¥ç¨‹ä¸Šåšèµ·æ¥å®é™…ä¸Šéå¸¸æ¶å¿ƒçš„äº‹æƒ…ï¼Œè¿™é‡Œæœ‰å‡ ç§ Patternï¼š</p><ul><li>Cluster Index ä¸Šçš„ Scanï¼Œè‚¯å®š prefetch</li><li>Secondary Index çš„ Scanï¼ŒBatch Key prefetch</li><li>Locality: æŸä¸ª Page ç»å¸¸è¢«æŸ¥å¤§æ¦‚ç‡ç»å¸¸è¢«æ›´æ–°ï¼Œæ‰€ä»¥å¾ˆå¯èƒ½æœ‰ SMOï¼Œå¯èƒ½éœ€è¦ Prefetch SMO éœ€è¦çš„ Page</li></ul><h3 id="Fine-grained-Locking"><a href="#Fine-grained-Locking" class="headerlink" title="Fine-grained Locking"></a>Fine-grained Locking</h3><p>è¿™é‡Œåˆ†æˆä¸¤éƒ¨åˆ†ï¼š</p><ul><li>Index optimization: PolarDB ä¼˜åŒ–æˆäº†æ— æ•Œæ— æ•Œæ— æ•Œçš„ Bw-Treeã€‚æœ¬è´¨ä¸Šè¿˜æ˜¯å¤„ç†å¤æ‚çš„åè®®å’Œ SMO é—®é¢˜ã€‚</li><li>Shadow Page: æœ¬è´¨ä¸Šæ„Ÿè§‰æ˜¯ä¸€ç§å†…å­˜æ¢é”å¼€é”€ã€‚å› ä¸ºè¿™é‡Œçš„é—®é¢˜ä¸æ˜¯æ›´æ–°ï¼Œè€Œæ˜¯å¸¦ Page é” IOã€‚</li></ul><h3 id="Multiple-I-O-Queues-and-Scheduler"><a href="#Multiple-I-O-Queues-and-Scheduler" class="headerlink" title="Multiple I/O Queues and Scheduler"></a>Multiple I/O Queues and Scheduler</h3><p>è¿™ç®—æ˜¯ IO å…±äº«å±‚å¾ˆå¸¸è§çš„ç­–ç•¥äº†ã€‚ä¸è¿‡è¿™é‡Œä¸æ˜¯é å­˜å‚¨å±‚æ ¹æ®ä»˜è´¹ QoSï¼Œè€Œæ˜¯ä¸€ä¸ªä¼˜å…ˆçº§è°ƒåº¦å±‚ã€‚</p><p><img src="https://image.mwish.me/blog-image/765baf88-ad76-4f7a-ad19-2614d260d25a.png" alt="765baf88-ad76-4f7a-ad19-2614d260d25a"></p><ul><li>Log IO æœ¬èº«æ˜¯ä¼˜å…ˆçš„ï¼Œæ”¾åˆ° Private Queue</li><li>Private æ»¡äº†èµ°åˆ°å…¨å±€çš„ Queue</li><li>Page è¿™ç§æ“ä½œèµ„æºæ¯”è¾ƒé‡ï¼Œä¸èƒ½æŠ¢å  Log-IO çš„èµ„æºï¼Œä½†æ˜¯å¯ä»¥åœ¨è‡ªå·±çš„èµ„æºæ± é‡Œé¢è¿›è¡Œã€‚</li></ul><h3 id="Aligned-I-O"><a href="#Aligned-I-O" class="headerlink" title="Aligned I/O"></a>Aligned I/O</h3><p>è¿™é‡Œåˆ†æˆå‡ ä¸ªéƒ¨åˆ†ã€‚å› ä¸ºå—å­˜å‚¨çš„ Block å¯èƒ½å¾ˆå¤§ï¼ŒPolarFS æ˜¯ 4-128 KBï¼Œè¿™ä¸ªåœ°æ–¹éœ€è¦è°ƒæ•´å¯¹åº”çš„ å¤§å°ï¼š</p><ol><li>Log I/O éœ€è¦å¯¹é½ä¸€å®šçš„å¤§å°å’Œæ ¼å¼</li><li>Data I/O éœ€è¦è€ƒè™‘ Compressed Page å’Œé Compressed Pageï¼Œåšä¸€äº› IO å¤„ç†</li><li>Vanilla MySQL ä¼šåˆå¹¶ç›¸é‚»çš„ Page å†™ï¼Œè¿™é‡Œå¯èƒ½ä¼šé˜»æ­¢è¿™ç§åˆå¹¶æ¥åˆ©ç”¨èšåˆå¸¦å®½</li></ol><p>ï¼ˆå…¶å® 1/2 æˆ‘æ²¡æœ‰å®Œå…¨çœ‹æ‡‚ç»†èŠ‚ï¼Œæ‡‚çš„å¯ä»¥è®²è®²ï¼‰</p><h3 id="Experiments-and-Evaluation"><a href="#Experiments-and-Evaluation" class="headerlink" title="Experiments and Evaluation"></a>Experiments and Evaluation</h3><p><img src="https://image.mwish.me/blog-image/99e39b0b-dda9-466a-a858-38277d404bdb.png" alt="99e39b0b-dda9-466a-a858-38277d404bdb"></p><h2 id="References"><a href="#References" class="headerlink" title="References"></a><strong>References</strong></h2><ul><li>PolarDB-CloudJumpï¼šä¼˜åŒ–åŸºäºäº‘å­˜å‚¨æœåŠ¡çš„äº‘æ•°æ®åº“(å‘è¡¨äºVLDB 2022) <a href="http://mysql.taobao.org/monthly/2022/06/01/">http://mysql.taobao.org/monthly/2022/06/01/</a></li><li>è¿‡å»5å¹´ï¼ŒPolarDBäº‘åŸç”Ÿæ•°æ®åº“æ˜¯å¦‚ä½•è¿›è¡Œæ€§èƒ½ä¼˜åŒ–çš„ï¼Ÿ <a href="https://zhuanlan.zhihu.com/p/535421993">https://zhuanlan.zhihu.com/p/535421993</a></li><li><a href="https://zhuanlan.zhihu.com/p/548215678"> https://zhuanlan.zhihu.com/p/548215678</a> ä¸Šäº‘æ˜¯å­˜å‚¨å¼•æ“æŠ€æœ¯çš„åˆ†æ°´å²­</li><li>Talk: <em>æ­ç§˜ PolarDB è®¡ç®—å­˜å‚¨åˆ†ç¦»æ¶æ„æ€§èƒ½ä¼˜åŒ–ä¹‹è·¯</em></li><li><a href="https://zhuanlan.zhihu.com/p/547171082">https://zhuanlan.zhihu.com/p/547171082</a> ç½‘æ˜“çš„äº‘åŸç”Ÿæ•°æ®åº“ï¼Œæåˆ°äº†è¿™é‡Œå¸¦æ¥çš„æ€§èƒ½ä¼˜åŒ–</li></ul>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>SQL Server Columnar Stores</title>
      <link href="/2022/12/24/SQL-Server-Columnar-Stores/"/>
      <url>/2022/12/24/SQL-Server-Columnar-Stores/</url>
      
        <content type="html"><![CDATA[<p>SQL Server åœ¨ 2012 å¹´ - 2015 å¹´é—´æ¨å‡ºäº†å¥½å‡ ç¯‡æœ‰å…³åˆ—å­˜çš„è®ºæ–‡ã€‚åœ¨å·®ä¸å¤šåŒä¸€æ—¶é—´ï¼Œå®ƒè¿˜æœ‰ä¸€ç³»åˆ—å†…å­˜æ•°æ®åº“å¼•æ“ç›¸å…³çš„è®¨è®ºã€‚åœ¨ 2015 å¹´çš„è®ºæ–‡ä¸­ï¼Œè¿™äº›å†…å®¹è¢«åˆå¹¶èµ·æ¥äº†ã€‚éšåï¼ŒSQL Server åˆæœ‰ä¸€äº›è¯„ä¼°å¯¹åº”æ•ˆç‡çš„è®ºæ–‡ï¼Œè¿™é‡Œæåˆ°çš„åˆ—è¡¨å¦‚ä¸‹ï¼š</p><ul><li>[SIGMODâ€™11] SQL server column store indexes</li><li>[SIGMODâ€™13] Enhancements to SQL Server Column Stores</li><li>[VLDBâ€™15] Real-Time Analytical Processing with SQL Server</li></ul><p>åŒæ—¶ï¼Œåœ¨å†…å­˜æ•°æ®åº“æ–¹é¢ï¼Œè®ºæ–‡å…¶å®è¿˜æ›´å¤šä¸€äº›ï¼š</p><ul><li>[CIDRâ€™11] Deuteronomy: Transaction Support for Cloud Data</li><li>[VLDBâ€™11] High-Performance Concurrency Control Mechanisms for Main-Memory Databases</li><li>[SIGMODâ€™13] Hekaton: SQL serverâ€™s memory-optimized OLTP engine</li><li>[ICDEâ€˜13] The Bw-Tree: A B-tree for New Hardware Platforms</li><li>[PVLDBâ€™14] Trekking Through Siberia: Managing Cold Data in a Memory-Optimized Database</li><li>[IEEEâ€™14] Compilation in the Microsoft SQL Server Hekaton Engine</li></ul><p>åœ¨ VLDBâ€™15 çš„è®ºæ–‡ä¸­ï¼Œè¿™äº›ä¸œè¥¿ç»ˆäºè¢«ç»“åˆåˆ°ä¸€èµ·ï¼Œå¯ä»¥åœ¨ Hekaton ä¸Šè·‘åˆ—å­˜å¼•æ“äº†ã€‚</p><p>è¿™äº›ä¸œè¥¿ä¹Ÿå¯ä»¥è¢«æ”¾åˆ°æ‰€è°“çš„ HTAP å®å¤§å™äº‹ä¸­ï¼š</p><p><img src="https://image.mwish.me/blog-image/628BF470-2E67-426B-B1BA-E6203D36421E.png" alt="628BF470-2E67-426B-B1BA-E6203D36421E"></p><p>å½“ç„¶æˆ‘ä»¬å¯ä»¥è®¤å¯ HTAP æ˜¯ä¸ªå•†ä¸šæ¦‚å¿µï¼Œä½†æ˜¯æŠ€æœ¯æ˜¯çœŸçš„ï¼Œæˆ‘ä»¬è¿˜æ˜¯è¦çœ‹çœ‹è¿™äº›ä¸œè¥¿æ˜¯æ€ä¹ˆåšçš„ã€‚</p><p>å…ˆå›é¡¾ä¸€ä¸‹åˆ—å­˜çš„ä¸‰ç¯‡è®ºæ–‡ï¼Œç®€å•ä»‹ç»ä¸€ä¸‹ä»–ä»¬çš„åŒ…å«çš„å†…å®¹ï¼š</p><ul><li>SQL Server Column Store Indexes è¿™ç¯‡æ–‡ç« æ˜¯æœ€æ—©çš„ï¼Œä»‹ç»äº† Column Store Indexesï¼Œå€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡ŒåŸºæœ¬ä¸Šæ˜¯æ²¡æœ‰æ›´æ–°çš„ handling çš„ï¼Œåº”è¯¥åªæœ‰ Batch æ’å…¥ï¼Œè¿™é‡ŒåŠŸèƒ½åº”è¯¥ç±»ä¼¼ Secondary çš„è¦†ç›–ç´¢å¼•ï¼Œç”¨æˆ·çš„æŸ¥è¯¢å¦‚æœå¯èƒ½çš„è¯ï¼Œå¯ä»¥ç›´æ¥èµ°è¿™ä¸ª Indexï¼Œç„¶åå¯ä»¥ä¸èµ°ä¸»è¡¨ã€‚è¿™ç¯‡æ–‡ç« ä¹Ÿæè¿°äº†æ‰§è¡Œå’Œä¼˜åŒ–å™¨ä¸Šåšçš„ä¸€äº›ä¼˜åŒ–å·¥ä½œ</li><li>Enhancements to SQL Server Column Stores è¿™ç¯‡æ–‡ç« æ”¯æŒäº†æ›´æ–°å’ŒæŠŠå®ƒå½“ä½œè¦†ç›–ç´¢å¼•ï¼ŒåŒæ—¶ï¼Œå¢åŠ äº† UPDATE Handling å’Œä¸€äº› Join ç®—å­çš„ç»†å¾®å®ç°ã€‚ç°åœ¨ SQL Server å¼•æ“æŠŠæ•°æ®çš„ schema ç»„è£…æˆ RowGroups å’Œ Delta-in-row-groupã€‚è¿™é‡Œæœ‰ä¸€äº› hacking è¿˜æ²¡è´´å‡ºæ¥ã€‚è¿™é‡Œåº”è¯¥æ˜¯æ”¯æŒäº†æ“ä½œå¾ˆé‡çš„ Update</li><li>Real-Time Analytical Processing with SQL Server ç»“åˆäº† Hekaton å¼•æ“ï¼ŒåŒæ—¶ï¼Œç»™ Column Stores åšäº†å†å¢å¼ºï¼Œç°åœ¨å¯ä»¥æ”¯æŒ Primary å’Œ Secondary çš„ Column Index ä¸Š Updateï¼Œç„¶åå†…å­˜å¯¹æ¥ Hekaton å¼•æ“ï¼Œè¿™å¥—æ“ä½œåœ¨ Delta-in-row-group ä¸Šå†å°äº†ä¸€å±‚é€»è¾‘ã€‚</li></ul><p>æˆ‘å°†å¾ªåºæ¸è¿›ç®€å•ä»‹ç»ä¸€ä¸‹ï¼Œè¿™å¥—ç³»ç»Ÿæ˜¯æ€ä¹ˆå®ç°çš„</p><h2 id="SQL-Server-Column-Store-Indexes"><a href="#SQL-Server-Column-Store-Indexes" class="headerlink" title="SQL Server Column Store Indexes"></a>SQL Server Column Store Indexes</h2><p>è¿™ä¸ªç‰ˆæœ¬æ˜¯ç›¸å½“äºç»™ SQL Server æ·»åŠ ä¸€ä¸ª secondary index ç‰ˆæœ¬ï¼Œç„¶åè®¾è®¡äº†ä¸€ä¸ªç±»ä¼¼ Parquet çš„æ ¼å¼ã€‚</p><p>è¿™é‡Œå®šä¹‰åˆ—å­˜ä¸ºä¸€ç§æ–°çš„ç´¢å¼•ç±»å‹ï¼Œè¿™ä¸ªç´¢å¼•æˆ‘æ¨æµ‹ä¸æ˜¯ RDBMS é‚£ç§ç´¢å¼•ï¼Œæ„Ÿè§‰æ˜¯ä¸€ä¸ªä»…æ”¯æŒæ’å…¥å¯¹éƒ¨åˆ†åˆ—çš„ä¸€ä¸ª mv ã€‚è¿™é‡Œä¸»è¦ä»»åŠ¡è¿˜æ˜¯ç»™ AP æŸ¥è¯¢ã€‚å®ƒåŸºäº SQL Server åšçš„ BLOB(LOB) åŠŸèƒ½ï¼ˆæ„Ÿè§‰è¿™å¥—å•æœºå’Œåˆ†å¸ƒå¼éƒ½ç ”ç©¶å¾—æ¯”è¾ƒé€å½»äº†ï¼‰ã€‚åŸºäº BLOBï¼Œå®ƒæœ‰å¦‚ä¸‹çš„è§†å›¾ï¼š</p><p><img src="https://image.mwish.me/blog-image/1280X1280.png" alt="1280X1280"></p><p>å’Œ</p><p><img src="https://image.mwish.me/blog-image/1280X1280-1.png" alt="1280X1280 (1)"></p><ul><li>Pageï¼šåŸºæœ¬æ¦‚å¿µå¯ä»¥å¹³ç§»è‡ª Parquet çš„ Pageï¼Œå˜é•¿</li><li>(Column) Segment: Parquet Column Chunk</li><li>RowGroup: å¯¹åº” Parquet çš„ RowGroupï¼Œåœ¨è¿™ç¯‡è®ºæ–‡é‡Œé¢å¤§æ¦‚æœ‰ç™¾ä¸‡è¡Œçº§åˆ«çš„æ•°æ®</li><li>Directory: ç±»ä¼¼ Parquet çš„ Metadata / Footer</li></ul><p>ä¸Šå±‚çš„ä¸€äº› Locking / Logging / Recovery / Partition ä¹‹ç±»çš„ç­–ç•¥å°½é‡ç”¨ SQL Server çš„ä»£ç </p><h3 id="Data-Encoding-and-Compression"><a href="#Data-Encoding-and-Compression" class="headerlink" title="Data Encoding and Compression"></a>Data Encoding and Compression</h3><p>Encoding éƒ¨åˆ†å¾ˆè‰å°ï¼Œæ²¡å•¥è¯´çš„ï¼Œæˆ‘ç›¸ä¿¡å¾®è½¯ï¼Œä¸è¿‡è¿™ç¯‡æ–‡ç« æè¿°ç¡®å®å¾ˆç³™ã€‚å¾®è½¯åé¢å¥½åƒå‡ºäº†ä¸€äº› CompressDB ä¹‹ç±»çš„è®ºæ–‡ï¼Œè¿™é‡Œä¸ä»‹ç»äº†</p><p>åé¢è¿˜æè¿°äº†ä¸€äº› RLE + Bit-packing ç›¸å…³çš„ï¼Œå¯ä»¥ç›´æ¥å‚è€ƒ Parquet çš„ RLE æ ¼å¼ï¼Œæ€»çš„æ¥è¯´æ˜¯æ²¡æœ‰ä»€ä¹ˆæ–°ä¸œè¥¿çš„ã€‚</p><h4 id="Optimal-Row-Ordering"><a href="#Optimal-Row-Ordering" class="headerlink" title="Optimal Row Ordering"></a>Optimal Row Ordering</h4><p>è¿™éƒ¨åˆ†æ¯”è¾ƒæœ‰æ„æ€ï¼Œå…¶å®æŸç§ç¨‹åº¦ä¸Šæœ‰ç‚¹ Auto Clustering çš„å‘³é“ï¼Œæˆ‘ä»¬è€ƒè™‘ä»¥ä¸‹é€»è¾‘ï¼š</p><ul><li>æ•°æ®æœ‰ä¸€è‡´æ€§çš„æƒ…å†µä¸‹ï¼Œencoding æ€§èƒ½å’Œæ•ˆç‡ä¼šå¾ˆå¥½ï¼Œä¸€ä¸ªéå¸¸å¥½çš„ä¾‹å­æ˜¯ RLE / DELTA</li><li>å› ä¸ºåªä¼šåœ¨è¿™ä¸ªç´¢å¼•ä¸Šè·‘ä¸€äº›åˆ†æï¼Œæ‰€ä»¥ Order å¹¶ä¸é‡è¦</li></ul><p>æ‰€ä»¥ä¼šæ ¹æ®æ•°æ®æ¥é‡æ–°ç»„ç»‡ï¼Œæé«˜æ€§èƒ½</p><p>å½“ç„¶ï¼Œå¯¹å¤šåˆ—æ•°æ®è¿›è¡Œè¿™æ ·çš„æ“ä½œæ˜¯ä¸ªæ¯”è¾ƒå¤æ‚çš„é—®é¢˜ï¼Œå› ä¸ºæœ¬è´¨ä¸Šéœ€è¦ä¸€ä¸ªè¡¡é‡æªæ–½æ¥ä¿è¯è¿™ä¸ªä¸œè¥¿å¯¹ç”¨æˆ·æ˜¯æœ‰æ•ˆçš„ï¼Œå¤šåˆ—çš„æŸä¸ª optimal çš„ç­–ç•¥å¯èƒ½æŸå®³å•åˆ—çš„æ€§èƒ½ã€‚</p><p>è®ºæ–‡è¯´è¿™é‡Œé‡‡ç”¨äº† Vertipaqâ„¢ algorithmã€‚å¥½åƒ auto clustering ä¼šä½¿ç”¨ z-ordering ä¸€ç±»çš„ç®—æ³•ã€‚</p><h4 id="Caching-å’Œ-IO"><a href="#Caching-å’Œ-IO" class="headerlink" title="Caching å’Œ IO"></a>Caching å’Œ IO</h4><p>BLOB å› ä¸ºæ˜¯å˜é•¿çš„ï¼Œåœ¨ Disk ä¸Šå¯èƒ½ä¼šè·¨å¤šä¸ª Disk Pageã€‚è¿™é‡Œè®¾è®¡äº†ä¸€ä¸ª Buffer Pool ï¼ˆæ„Ÿè§‰ç±»ä¼¼ TUM æ–°é¡¹ç›®é‚£å¥—ï¼Ÿï¼‰æ¥ç¼“å­˜å¯¹è±¡</p><p>è¿™é‡Œä¼šæœ‰ä¸¤ç§ read-ahead:</p><ul><li>Column Segment å†…éƒ¨çš„ Read-ahead</li><li>Column Segment é—´çš„ Read-ahead</li></ul><p>æˆ‘ä¸ªäººæ„Ÿè§‰è¿™ä¸ªè¿˜æ˜¯å¾ˆéš¾åšçš„ã€‚</p><h3 id="Query-Handling-and-Optimization"><a href="#Query-Handling-and-Optimization" class="headerlink" title="Query Handling and Optimization"></a>Query Handling and Optimization</h3><p>è¿™é‡Œä½œè€…åŸºäºä¸‹åˆ—é€»è¾‘æ¨æ–­ï¼š</p><ul><li>Column Store Index ä¼šå¤§å¤§å‡å°‘è¯» Disk çš„ IO å¼€é”€</li><li>æ‰€ä»¥ï¼ŒCPU å¯èƒ½ä¼šæˆä¸ºä¸€ä¸ªç“¶é¢ˆç‚¹</li></ul><p>è¿™é‡Œä¼šé‡‡ç”¨ vectorize çš„æ–¹å¼åšè®¡ç®—ã€‚</p><p>è¿™å¥—ä¸œè¥¿æœ¬èº«æ¯”è¾ƒå¤æ‚ï¼Œä¸è¿‡å°½é‡ç®€å•çš„è¯´ï¼š</p><ul><li>å¤ç”¨äº†ä¹‹å‰çš„ SQL Engine<ul><li>å‡å°‘å®ç°å¼€é”€ï¼Œä¿æŒç”¨æˆ·é€æ˜åº¦ï¼ŒåŒæ—¶ Query å¯ä»¥åŒæ—¶åŒ…å« Row å’Œ Column çš„å¤„ç†æ¨¡å¼</li><li>å…è®¸ Query åœ¨è¿è¡ŒæœŸ<strong>åŠ¨æ€å˜æ›´</strong>æ‰§è¡Œæ¨¡å¼ï¼ˆè¿™é‡Œç›®çš„å†™äº†ä¸€äº›å¥‡æ€ªçš„ä¸œè¥¿ï¼Œæ„Ÿè§‰ä¸Šæ˜¯æ—©æœŸå®ç°åŸå› ï¼Œä¸è¿‡è¿™ä¸ªå§‘ä¸”ä¹Ÿå¾ˆè¯±æƒ‘äººï¼‰</li><li>å…è®¸åˆ—å­˜ä¸ºæ­£äº¤ featureï¼Œä¸ºäº‹åæåˆ«çš„äº‹æƒ…åšå‡ºé“ºå«</li></ul></li></ul><p>åœ¨æ‰§è¡Œçš„æ—¶å€™æœ‰ä¸€äº› tricksï¼Œè€ƒè™‘åˆ°è¿™äº› tricks å®é™…ä¸Šè¿˜æ˜¯æŒºé‡è¦çš„ï¼Œå…·ä½“åˆ—å­˜æ˜¯ä¸æ˜¯å¯ä»¥å‚è€ƒä¸€ä¸‹ Veloxï¼š</p><ul><li>æ·»åŠ äº† Batch Operator<ul><li>Access Method å…è®¸ä¸‹æ¨ bitmap filter å’Œè°“è¯</li><li>å°½é‡ç›´æ¥åœ¨å‹ç¼©çš„æ•°æ®ä¸Šåšæ“ä½œ</li></ul></li><li>ä½¿ç”¨ Delayed String Materialization</li><li>Bitmap Filter è¢«æ”¹æˆä¸€ç§å¾ˆæ³›ç”¨çš„æ ¼å¼ï¼Œæ ¹æ®æ•°æ®åˆ†å¸ƒçš„ä¸åŒï¼Œæ‰§è¡Œä¸åŒçš„é€»è¾‘ï¼ˆç±»ä¼¼ Roaring Bitmap?ï¼‰</li><li>åšäº† Runtime Resource Management</li></ul><p>åœ¨ Query Optimization é˜¶æ®µï¼ŒQuery Optimizer å¯ä»¥æ ¹æ® RowGroup çš„å¤§å°æ¥ä¼°ç®—ä¸€äº› IO å¼€é”€ï¼Œæ¥è¿›è¡Œä¼˜åŒ–ã€‚åœ¨è¿™ç¯‡è®ºæ–‡é‡Œé¢ï¼Œæ„Ÿè§‰ RowGroups éƒ½æ¯”è¾ƒé™æ€ï¼Œéƒ½æ˜¯ immutable çš„ï¼Œæ‰€ä»¥æ„Ÿè§‰è¿™å—åšçš„ä¼šä¸ç®—å¾ˆå¤æ‚</p><p>ç›´è§‚æ„Ÿå—æ˜¯ï¼ŒColumn Store Indexes å¯¹ Point Get å’Œ Range Scan æ€§èƒ½æ¯”è¾ƒå·®ã€‚</p><p>å®ç°ä¸Šï¼ŒBatch æ“ä½œä¼šè¢«å®šä¹‰æˆ Batch æ˜¯ä¸€ä¸ª Physical Propertyï¼Œç”¨è¿™ä¸ªæ¥ä¿è¯æŸ¥è¯¢çš„æ€§è´¨ã€‚</p><p>åœ¨ Join ä¸­ï¼Œè¿™é‡Œä¼šå°è¯•åœ¨ Build é˜¶æ®µæ„å»º bitmapï¼Œç±»ä¼¼ dynamic-filterï¼Œç„¶åä¸‹æ¨åˆ° Probe-Sideã€‚è¿™é‡Œå¦‚æœæœ‰å¤šå¼ è¡¨ Joinï¼Œå®ƒä¼šæŠ½å–å‡º Join çš„æ¡ä»¶ï¼ŒæŸ¥çœ‹å“ªäº›è¡¨æ˜¯äº‹å®è¡¨ï¼Œå“ªäº›è¡¨æ˜¯ç»´åº¦è¡¨ï¼Œæ ¹æ®è¿™ä¸ªæ„å»º DF.</p><p>ä¸‹é¢ä¸¾å‡ ä¸ªæŸ¥è¯¢çš„ä¾‹å­ï¼š</p><p><img src="https://image.mwish.me/blog-image/6a37acef-9139-498f-b3aa-fad333d99bf0.png" alt="6a37acef-9139-498f-b3aa-fad333d99bf0"></p><h2 id="Enhancements-to-SQL-Server-Column-Stores"><a href="#Enhancements-to-SQL-Server-Column-Stores" class="headerlink" title="Enhancements to SQL Server Column Stores"></a>Enhancements to SQL Server Column Stores</h2><p>è¿™ç¯‡æ–‡ç« å…è®¸ Column Index å¯ä»¥æ›´æ–°ï¼Œå¹¶ä¸”å¯ä»¥ä½œä¸º Primary Index(å¯ä»¥ç±»æ¯”æˆ MySQL çš„ Cluster Indexï¼‰ å­˜åœ¨ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™ç¯‡æ–‡ç« æœ¬èº«æ²¡å¤ªæï¼Œä½†æ˜¯ç»“åˆåé¢çš„è®ºæ–‡å¯ä»¥çœ‹å‡ºæ¥ï¼Œå®ƒè¿™ä¸ªæ˜¯ç»™æ•°ä»“å‹åº”ç”¨è®¾è®¡çš„</p><p>è¿™æ–‡ç« å‰é¢é€¼é€¼å¨å¨äº†ä¸€ä¸‹ä¹‹å‰çš„è®¾è®¡ï¼š</p><p><img src="https://image.mwish.me/blog-image/76541149-7baa-4bac-a729-a4128f6f786e.png" alt="76541149-7baa-4bac-a729-a4128f6f786e"></p><h3 id="ä¼˜åŒ–ä¹‹å‰çš„è®¾è®¡"><a href="#ä¼˜åŒ–ä¹‹å‰çš„è®¾è®¡" class="headerlink" title="ä¼˜åŒ–ä¹‹å‰çš„è®¾è®¡"></a>ä¼˜åŒ–ä¹‹å‰çš„è®¾è®¡</h3><p>å’Œ Parquet ä¸åŒçš„åº”è¯¥æ˜¯å­—å…¸çš„å¤„ç†æ–¹å¼ã€‚è®ºæ–‡æ„Ÿè§‰æ²¡ç‰¹åˆ«è¯¦ç»†æŒ‡å‡ºä¸åŒåˆ—å­—å…¸æ˜¯æ€ä¹ˆå¤„ç†æ€ä¹ˆ fallback çš„ï¼Œä¸è¿‡æ„Ÿè§‰ä¹Ÿä¸ care äº†ã€‚</p><p>SQL Server æœ‰ä¸¤ç§å­—å…¸ï¼š</p><ul><li>Global Dictionary: æŸä¸ª Column çš„å…¨éƒ¨å­—å…¸</li><li>Local Dictionary: æŸä¸ª RowGroup çš„å­—å…¸</li></ul><p>è¿™é‡Œçš„æ„å»ºé‡‡å–äº†è¿™æ ·çš„æµç¨‹ï¼š</p><ul><li>é‡‡æ ·ï¼Œå†³å®šæ˜¯å¦è¦æ„å»º global index</li><li>æ„å»º Index</li></ul><p>æ¯”è¾ƒå€¼å¾—ä¸€æçš„æ˜¯ï¼ŒIndex Build é˜¶æ®µå†…å­˜å¼€é”€ä¼šæ¯”è¾ƒå¤§ï¼Œè¿™é‡Œéœ€è¦ï¼š</p><ul><li>æå‰ç”³è¯·å¥½å†…å­˜çš„ä¸€ä¸ªé˜ˆå€¼</li><li>æ ¹æ®å†…å­˜ï¼Œå¯ä»¥åˆ†é…åˆ‡ RowGroup ä¹‹ç±»çš„å¤§å°ï¼Œè¿˜å¯ä»¥åˆ‡æˆå¤šä¸ª DOP æ¥æ„å»ºï¼Œæ¯ä¸ªçº¿ç¨‹æ‹¿ç€ä¸€å¤§å—å†…å­˜<ul><li>è¿™ä¸ªåœ°æ–¹ï¼Œçº¿ç¨‹è¿‡å¤šï¼Œå¯èƒ½ä¼šåˆ‡çš„è¿‡ç¢ï¼Œé€ æˆä¸€ä¸ªæ¬¡ä¼˜çš„é€‰é¡¹ã€‚æ‰€ä»¥è¿™ä¸ªåœ°æ–¹ä¼šåŠ¨æ€è°ƒæ•´ DOPï¼Œæ¥åŠ¨æ€æ§åˆ¶çº¿ç¨‹çš„æ•°é‡ã€‚è¿™é‡Œè°ƒæ•´æ–¹å¼æ˜¯æ ¹æ®ç³»ç»Ÿæ¯ä¸ªçº¿ç¨‹å®é™…å ç”¨çš„å†…å­˜å¯ä»¥åæ˜ è¿™æ‰¹æ•°æ®çš„åˆ†å¸ƒï¼Œç”¨è¿™äº›æƒ…å†µæ¥åŠ¨æ€çš„å†³å®šï¼Œåœ¨é¢„ä¼°çš„è¿™äº›å†…å­˜èµ„æºä¸‹ï¼Œå¼€å¤šå°‘ä¸ªçº¿ç¨‹æ¯”è¾ƒåˆé€‚ã€‚</li></ul></li></ul><h3 id="SQL-Server-ç›¸å…³è¯­ä¹‰å…¼å®¹"><a href="#SQL-Server-ç›¸å…³è¯­ä¹‰å…¼å®¹" class="headerlink" title="SQL Server ç›¸å…³è¯­ä¹‰å…¼å®¹"></a>SQL Server ç›¸å…³è¯­ä¹‰å…¼å®¹</h3><h4 id="é‡‡æ ·"><a href="#é‡‡æ ·" class="headerlink" title="é‡‡æ ·"></a>é‡‡æ ·</h4><p>é‡‡æ · / ç»Ÿè®¡æ˜¯ä¸ªæ¯”è¾ƒå¸¸è§çš„éœ€æ±‚äº†ï¼Œæ•°æ®åº“å†…éƒ¨éœ€è¦é‡‡æ ·æ¥æ”¯æŒ statisticsï¼ŒClickHouse / Snowflake ä»¥åŠå¾ˆå¤šç°ä»£æ•°æ®äº§å“è¿˜è¦é«˜æ•ˆæ”¯æŒ SAMPLE ç®—å­ï¼Œæ¥å¸®åŠ©é‚£äº›ä¸çŸ¥é“åœ¨åšä»€ä¹ˆçš„ç§‘å­¦å®¶æ¥é«˜æ•ˆçš„éšæœº SAMPLE ä¸€äº›è¡Œã€‚</p><p>SQL Server çš„æŸ¥è¯¢ä¼˜åŒ–ä¼šéœ€è¦ç»Ÿè®¡ä¿¡æ¯ï¼Œé Primary Index çš„ç´¢å¼•ä¸éœ€è¦åš Statisticï¼Œå› ä¸ºå®ƒè®¤ä¸ºå¯ä»¥åœ¨ Primary Index ä¸Šåšæ”¶é›†å³å¯ã€‚è¿™é‡Œæœ‰ä¸¤ç§æ”¶é›†ç´¢å¼•ä¸Šä¿¡æ¯çš„æ¨¡å¼ï¼š</p><ul><li>é«˜æ€§èƒ½ï¼Œä½ Accuracy<ul><li>éšæœºé€‰ä¸­ RowGroupï¼Œåœ¨ RowGroup å†…éšæœºé€‰ä¸­ Rowã€‚ä¸Šé¢çš„é€‰æ‹©ç‡ç”±é‡‡æ ·æ¯”ä¾‹æ¥æ‰‹åŠ¨å®šä¹‰</li><li>åœ¨æ„å»ºå­—å…¸çš„æ—¶å€™å°è¯•é‡‡æ ·ï¼Œé€‰æ‹©è¿™ç§æ–¹å¼</li></ul></li><li>é«˜å‡†ç¡®åº¦ï¼Œé«˜ IO å’Œ CPU å¼€é”€<ul><li>æ‰«ææ‰€æœ‰ Column Segmentsmï¼Œåœ¨é‡Œé¢éšæœºé€‰ä¸­ä¸€äº› Row</li><li>åœ¨æ„å»º Histogram çš„æ—¶å€™ä½¿ç”¨è¿™ç§æ–¹å¼ã€‚</li></ul></li></ul><h4 id="UUID-Bookmark-support"><a href="#UUID-Bookmark-support" class="headerlink" title="UUID(Bookmark) support"></a>UUID(Bookmark) support</h4><p>è¿™é‡Œ Bookmark ç±»ä¼¼ PG çš„ <code>(page, slotId)</code>, query optimizer ä¹‹ç±»çš„éƒ½ä¼šä¾èµ–è¿™ä¸ª Bookmarkã€‚è¿™é‡Œç”¨ <code>(rowGroupId, rowId)</code>æ¥ä»£è¡¨ bookmarkã€‚</p><p>çªç„¶å‘ç°ï¼Œæœ¬è´¨ä¸Šè¿™ä¸ªå’Œ id å˜æ›´æˆ–è€… WiscKey GC æ˜¯ä¸€æ ·çš„åœºæ™¯ã€‚</p><h3 id="Update-Handling"><a href="#Update-Handling" class="headerlink" title="Update Handling"></a>Update Handling</h3><p><img src="https://image.mwish.me/blog-image/f6140d49-24e8-4203-81ce-ea28c77d939a.png" alt="f6140d49-24e8-4203-81ce-ea28c77d939a"></p><p>Columnar çš„ç›´æ¥æ›´æ–°æ˜¯ä¸€ä¸ªå¾ˆå¤§çš„æ€§èƒ½ä¸‹é™ï¼Œè¿™é‡Œå¸Œæœ›åœ¨ä¸æŸå®³å‹ç¼©æ€§èƒ½ï¼ˆæœ‰çš„æ ¼å¼ï¼Œåƒä¸€äº› HTAP çš„æ ¼å¼ï¼Œé€šè¿‡ micro-block ä¹‹ç±»çš„æ–¹å¼æ¥åšç›´æ¥æ›´æ–°ã€‚æ„Ÿè§‰å‹ç¼©ç‡è‚¯å®šæ¯”ä¸è¿‡è¿™äº›åˆ—çš„æ ¼å¼ï¼‰ã€‚è¿™é‡Œè¿˜æ˜¯å¸Œæœ›å†™æ¯”è¾ƒå¿«ã€‚</p><p>è¿™é‡Œè¡¨æ ¼æ›´å¤šæ˜¯ data warehouse çš„äº‹å®è¡¨ï¼Œæ•°æ®ä¸€èˆ¬ä¼šæœ‰å¤§é‡çš„æ’å…¥å’Œæ¯”è¾ƒå°‘é‡çš„æ›´æ–°å’Œåˆ é™¤ã€‚è¿™é‡Œå¯ä»¥çœ‹ä¸Šå›¾ï¼š</p><ul><li>å†…å­˜ä¸­ï¼š<ul><li>æ–°æ’å…¥çš„è®°å½•è¢«å†™é“ delta store ä¸­ï¼Œè¿™æ˜¯ä¸€ä¸ª btreeã€‚è¿™ä¸ªé˜¶æ®µåº”è¯¥è¿˜æ²¡æœ‰äº§ç”Ÿä¸€ä¸ª RowGroup Idï¼Œç³»ç»Ÿä¼šç»™å®ƒç”Ÿæˆä¸€ä¸ª unique integer çš„ keyã€‚</li><li>ç£ç›˜çš„åˆ é™¤è®°å½•è¢«è¡¨ç¤ºåœ¨ delete bitmap ä¸­</li></ul></li><li>ç£ç›˜ä¸­ï¼š<ul><li>Delta Store çš„ Btree å¯¹åº”ç£ç›˜ç»“æ„</li><li>åŒ…å«å¤šä¸ª RowGroup çš„ Column Store</li><li>å†…å­˜ä¸­çš„ delete bitmap åœ¨å­˜å‚¨ä¸­å¯èƒ½æ˜¯ä¸ª Btree</li></ul></li></ul><p>åšä¸åŒæ“ä½œçš„æ—¶å€™ï¼š</p><ul><li>Insert: æ’å…¥ delta store</li><li>Delete: å¦‚æœæ˜¯ delta store çš„è®°å½•ï¼Œé‚£ä¹ˆç›´æ¥åˆ é™¤å®ƒã€‚å¦åˆ™æ’å…¥ delete bitmap</li><li>Update: æ‹†åˆ†æˆ Delete + Insert</li><li>Merge: æ‹†åˆ†æˆ Delete + Insert ç­‰æ“ä½œ</li></ul><p>Delta Store æ„Ÿè§‰ä¸Šæœ‰é‚£ä¹ˆä¸€ç‚¹ç±»ä¼¼ RocksDB çš„ MemTable æˆ–è€… Kudu çš„ MemRowSetï¼Œæœ¬èº«è¡Œå­˜ + 1 ä»½ activeï¼Œåé¢çš„ä¼šè¢«æ…¢æ…¢ç§»åŠ¨åˆ° Disk ä¸Šçš„åˆ—å­˜ç»“æ„ä¸Šã€‚è¿™é‡Œéœ€è¦è¯´æ˜çš„æ˜¯ï¼Œå’Œ RocksDB çš„ MemTable ä¸åŒï¼Œè¿™é‡Œçš„å®é™…ä¸Šéƒ½è¿˜æ˜¯ active çš„ï¼Œä½†æ˜¯ delete å¯èƒ½è¿˜æ˜¯ä¼šè¿›æ¥</p><p>åœ¨ move é˜¶æ®µä¸­ï¼Œå†™æ­£åœ¨ move ä¸­çš„ Delta ä¼šè¢« Block ä½ï¼Œç›´åˆ° move æ“ä½œå®Œæˆï¼ˆå…¶å®è¿™ä¸ª Kudu å¥½åƒéƒ½æœ‰å®ç°ï¼‰ã€‚move å’Œè¯»å–æ˜¯å¯ä»¥å¹¶å‘çš„ã€‚åœ¨ move å®Œæˆä¹‹åï¼Œå¯ä»¥åœ¨å…ƒä¿¡æ¯ä¸­åšæäº¤ï¼Œé˜Ÿä¹‹åçš„äº‹åŠ¡ï¼Œå†™å…¥çš„ RoiwGroup å¯è§ï¼Œç„¶å Delta ä¸å¯è§ã€‚ç­‰å¾…ä¾èµ– delta çš„äº‹åŠ¡éƒ½å®Œæˆåï¼Œè¿™ä¸ª delta å°±å¯ä»¥ GC äº†</p><p>Bulk Insert ä¼šè¢«é¢å¤–å¤„ç†ï¼Œé€šå¸¸ Bulk Insert å¯èƒ½æ˜¯æŸä¸ª ETL Job çš„ä¸€éƒ¨åˆ†ï¼ŒRow å¾ˆå¤šä¼šç›´æ¥æ„æˆä¸€ä¸ª RowGroupã€‚å¦‚æœ Row ä¸å¤Ÿå¤šï¼Œè¿™ä¸ªåœ°æ–¹ä¼šå…ˆ Build å‡ºä¸€ä¸ª Delta Storeã€‚è¿™é‡Œ SQL Server å¼ºè°ƒäº†ä¸€ä¸‹ï¼Œå¸Œæœ›ä¿è¯æ¯ä¸ª RowGroup æœ‰ç™¾ä¸‡è¡Œæ•°æ®ã€‚</p><p>è¿™ä¸ªåœ°æ–¹ï¼ŒScan å¯ä»¥åšçš„éå¸¸å¹²å‡€ï¼Œå› ä¸ºå¯¹ Delete çš„å¤„ç†å¯ä»¥å®Œå…¨åœ¨ç®—å­å±‚ï¼ˆScan Operatorï¼‰è§£å†³ã€‚ä¸è¿‡æˆ‘æƒ³äº†ä¸‹ï¼Œæ¯”æ–¹è¯´æŸ¥è¯¢ä¼˜åŒ–æœ¬æ¥å¯ä»¥ç®€å•ä» Zone Map è¯» Count(*)ï¼Œä½†æ˜¯ç°åœ¨éœ€è¦ Zone Map çš„ Count è®°å½•å‡å» Delete å¯¹åº”çš„æ•°ç›®ï¼Œè¿™ä¸ªæµç¨‹ç¨å¾®å˜å¾— Trick äº†ä¸€äº›ã€‚æ€»ä¹‹ä¸Šå±‚åšä¸€äº›ä¼˜åŒ–çš„æ—¶å€™è¦è€ƒè™‘åˆ°è¿™ä¸€ä¸ªæµç¨‹ã€‚</p><p>æœ‰å¤§é‡åˆ é™¤è®°å½•çš„ row ä¼šå¤§å¤§é™ä½æ€§èƒ½ï¼Œåœ¨å¤§é‡çš„åˆ é™¤åå¯ä»¥åšä¸€ä¸ª Compaction æ¥æé«˜æ€§èƒ½ï¼Œä¸è¿‡æˆ‘æ„Ÿè§‰ Compaction æµç¨‹ä¹Ÿç±»ä¼¼ Kudu çš„ Compaction æˆ–è€… WiscKey çš„ GCï¼Œéœ€è¦æ³¨æ„æ˜ å°„å…³ç³»çš„ç»´æŠ¤ã€‚</p><p>ä¸åŒçš„ delta store å¯ä»¥åˆ†ç»™ä¸åŒçš„çº¿ç¨‹å»è¯»ï¼Œå› ä¸ºè¯» delta store å¾ˆæ…¢ã€‚</p><p>åœ¨æ‰§è¡Œçš„æ—¶å€™ï¼Œè¿™é‡Œä¼šå°è¯•æ¨ä¸€äº› bitmap ä¸‹æ¥ï¼Œç±»ä¼¼ dynamic-filterã€‚å­˜å‚¨å±‚ä¼šå¤„ç†è¿™ä¸ª BFï¼Œæ¥ä¼˜åŒ–æ‰«æï¼ˆæ„Ÿè§‰ BF å­—å…¸ä¹‹ç±»çš„å¯ä»¥åˆä½œï¼‰ï¼š</p><blockquote><p>To avoid this explosion, hash join operators now store information about bitmaps and their estimated selectivity. At implementation time, the selectivity information is passed to the child, enabling it to adjust its cost to account for the bitmap selectivity. In order to limit the amount of optimization requests to child groups the optimizer does not treat each request as different, but rather clusters requests based on their selectivity thus being able to reuse far more than it would otherwise.</p></blockquote><p>è¿™é‡Œå¯¹å¾ˆå°‘è®¿é—®çš„åˆ†åŒºï¼Œè¿˜ä¼šé‡‡å–æ›´æ¿€è¿›çš„æ–¹å¼å»å‹ç¼©ï¼Œæ¥èŠ‚çº¦ç©ºé—´ã€‚</p><h2 id="Real-time-analytical-processing-with-SQL-server"><a href="#Real-time-analytical-processing-with-SQL-server" class="headerlink" title="Real-time analytical processing with SQL server"></a>Real-time analytical processing with SQL server</h2><p><img src="https://image.mwish.me/blog-image/6b4dfa96-ee75-4097-a568-b6c2ca127a48.png" alt="6b4dfa96-ee75-4097-a568-b6c2ca127a48"></p><p>è¿™ç¯‡è®ºæ–‡å¤§æ¦‚çš„ç»“æ„å¯ä»¥çœ‹ä¸Šå›¾ã€‚å›¾ç‰‡æ²¡æœ‰ä»€ä¹ˆæ„æ€ï¼Œä¸€äº›ç»†èŠ‚è¿˜æ˜¯å¾ˆå€¼å¾—ä¸€æçš„ã€‚</p><p>æ–‡ç« ä½œäº 2015ï¼Œç®—æ˜¯æœ‰ä¸ª Hekaton å†…å­˜ + Disk é€»è¾‘äº†ã€‚å†…å­˜æ•°æ®åº“ä¸æ˜¯å·²ç»å¤Ÿå¿«äº†å—ï¼Ÿè®ºæ–‡è®¤ä¸ºï¼Œè¿™æ ·è¿˜æ˜¯å¯ä»¥ä¼˜åŒ–ä¸€äº› AP æŸ¥è¯¢ã€‚åœ¨ä¹‹å‰ï¼Œæ·»åŠ  CSI ä¼šè®©è¡¨åªè¯»ï¼Œ13 å¹´çš„è®ºæ–‡è®©ä¸»è¡¨å¯ä»¥æ˜¯ä¸€ä¸ª Column Index Storeï¼Œæ¥ç»™æ•°æ®ä»“åº“æä¾›è´Ÿè½½ã€‚è¿™ç¯‡æ–‡ç« ç®—æ˜¯æä¾›äº†ä¸€ä¸ªå¯æ›´æ–°çš„ Secondary Indexã€‚è¿™ä¸ªæœ‰ä»€ä¹ˆåŒºåˆ«å‘¢ï¼Ÿç­”æ¡ˆæ˜¯ä»–ä»¬è®¤ä¸ºæ›´æ–° Primary Indexï¼Œè¯´æ˜æ•´ä¸ªè¡¨éƒ½æ˜¯ Column Indexï¼Œæœ¬èº«æ˜¯ä¸ªæ•°æ®ä»“åº“ã€‚Secondary Index å¯èƒ½ä¸»è¡¨æ˜¯ä¸ª Btrï¼Œæ˜¯ä¼˜åŒ–æŸä¸€ç±» AP æŸ¥è¯¢ï¼Œæ‰€ä»¥å¸Œæœ›æ›´æ–°æœ‰æ›´å¥½çš„é€‚é… TP çš„æ€§èƒ½ã€‚SQL Server ç”¨äº†ä¸ªå¾ˆå·§å¦™çš„æ–¹æ³•æ¥æ“ä½œã€‚</p><p>æˆ‘ä»¬å¯ä»¥ä»ç»“è®ºä¸Šæ¨æ–­ï¼Œç±»ä¼¼ TiDB ç”¨ TiFlash è¾¾åˆ°äº† HTAPï¼Œè¿™ç¯‡æ–‡ç« è®¾æƒ³æ˜¯å‡†å¤‡ä¸€ä¸ªç´¢å¼•ï¼Œç„¶åç”¨å†…å­˜ä¸­çš„ç´¢å¼•æ¥å®ç° HTAPï¼Œå®é™…ä¸Šè¿™æ ·ä¸éœ€è¦ Log æµæ¥åŒæ­¥ï¼Œä½†æ˜¯éœ€è¦éš”ç¦»ç›¸å…³çš„æŸ¥è¯¢è´Ÿè½½ï¼ŒåŒæ—¶ä¹Ÿè¦æ³¨æ„å¯¹ä¸»é“¾è·¯æ€§èƒ½çš„å½±å“ã€‚</p><p><img src="https://image.mwish.me/blog-image/e7e704b2-004c-4572-ae2b-c6fcf5d88fac.png" alt="e7e704b2-004c-4572-ae2b-c6fcf5d88fac"></p><h3 id="CSI-On-In-Memory-Tables"><a href="#CSI-On-In-Memory-Tables" class="headerlink" title="CSI On In-Memory Tables"></a>CSI On In-Memory Tables</h3><p><img src="https://image.mwish.me/blog-image/c4d3a298-df8d-4c9f-aa58-5260cadd7e22.png" alt="c4d3a298-df8d-4c9f-aa58-5260cadd7e22"></p><p>è¿™é‡Œæ‰€æœ‰é è°±çš„å†…å®¹éƒ½åœ¨å†…å­˜ä¸­ï¼ŒTail Index éƒ¨åˆ†çš„å†…å­˜æ²¡æœ‰è¢«å†™å…¥ Column Storeã€‚è¿™é‡Œç›¸å½“äºç”¨ In-memory Table éƒ¨åˆ†ä»£æ›¿äº† Delta Store çš„éƒ¨åˆ†ï¼Œæ¥æé«˜äº†æ›´æ–°æ€§èƒ½ã€‚åˆ é™¤çš„æ•°æ®ä¼šè¢«æ”¾åˆ° Deleted Rows Table ä¸­ï¼Œè¿™ä¹Ÿå¹¶ä¸å…¨åŒäº Delete Bit Mapã€‚æœ‰ä¸€ä¸ª Data Migration Task ä¼šè¿ç§» Tail Index ï¼ˆæ²¡æœ‰å†™å…¥ Column Store ï¼‰åˆ° Column Store ä¸­ï¼Œè¿™éƒ¨åˆ†æœ‰ä¸€ä¸ªå¾ˆ Trick çš„åœ°æ–¹ï¼Œå°±æ˜¯æœ¬èº« Hekaton å¼•æ“å°±å¤„ç†äº† MVCCï¼Œç„¶åæ•°æ®ä¸åˆ·ä¸‹å»æ­£ç¡®æ€§ä¹Ÿæ˜¯ä¿è¯çš„ï¼Œæ‰€ä»¥ï¼Œ<strong>è¿™é‡Œä¸ºäº†ä¸è®© deleted rows è¢«é¢‘ç¹æ›´æ–°ï¼Œæ‰€ä»¥ä¸ä¼šå¸Œæœ›æŸäº›è¢«é¢‘ç¹æ›´æ–°çš„è¡Œè¢«åˆ·ä¸‹å»ï¼Œè€Œæ˜¯å¸Œæœ›è¿™äº›éƒ¨åˆ†èƒ½å¤Ÿä¸€ç›´è¢« Keep åœ¨å†…å­˜ä¸­</strong>ã€‚</p><p>è¢«å®ç°æˆäº†ä¸¤éƒ¨åˆ†ï¼š</p><ul><li>Stage1: çº¿ç¨‹æŠŠé hot çš„éƒ¨åˆ†åˆ·ä¸‹å»ï¼Œè¿™ä¸ªæ—¶å€™ä½¿ç”¨ä¸€ä¸ªè¯»äº‹åŠ¡ï¼Œå†™å®Œä¹‹åè¿™äº›è®°å½•éƒ½ç›¸å½“äºæ˜¯åˆ é™¤çš„ã€‚<ul><li>è¿™ä¸ªåœ°æ–¹æœ‰ä¸ª Hack æ˜¯ï¼ŒDeleted Rows Table åº”è¯¥æ˜¯ä¸ªç‰¹åŒ–çš„å®ç°ï¼Œå¯ä»¥ mark ä¸€æ•´ä¸ªèŒƒå›´çš„åˆ é™¤ï¼Œé€šè¿‡è¿™ä¸ªæ¥å‡å°æ’å…¥çš„æ—¶å€™ mark as deleted çš„å¼€é”€ã€‚</li></ul></li><li>Stage2: ç”¨å¤šä¸ªäº‹åŠ¡å›å¡« row-id å’Œ mark as undeletedã€‚è¿™éƒ¨åˆ†å¯èƒ½å’Œç”¨æˆ·äº‹åŠ¡å†²çªã€‚è¿™éƒ¨åˆ†çš„å†…éƒ¨äº‹åŠ¡åšäº†ç‰¹æ®Šå¤„ç†ï¼Œè®©å®ƒå°½é‡ä¸å½±å“ç”¨æˆ·çš„äº‹åŠ¡ã€‚</li></ul><p>åŒæ—¶ï¼Œåœ¨ flush çš„æ—¶å€™å¯èƒ½ä¼šé¡ºå¸¦æ‰§è¡Œä¸€äº› RowGroup Cleanupï¼Œå¦‚æœä¸€äº› Row Group è¢«åˆ é™¤çš„å·®ä¸å¤šäº†ï¼Œé‚£ä¹ˆï¼Œåœ¨ Flush çš„æ—¶å€™å¯èƒ½ç›¸å½“äºä¼šæŠŠå®ƒä»¬åˆèµ·æ¥ï¼ˆæ„Ÿè§‰ä¸Šï¼Œè¿™ä¸ªè¡¨ç¤ºæ‰€æœ‰ Row Group éƒ½åœ¨åŒä¸€å±‚ï¼Œæ²¡æœ‰ L1 L2 çš„æ¦‚å¿µï¼‰ã€‚</p><h2 id="Updating-Secondary-Column-Stores"><a href="#Updating-Secondary-Column-Stores" class="headerlink" title="Updating Secondary Column Stores"></a>Updating Secondary Column Stores</h2><p>Primary çš„ä¸€ä¸ªé—®é¢˜æ˜¯ï¼Œéœ€è¦ Hekaton Table é«˜åº¦é…åˆã€‚Secondary ç›¸å½“äº Hekaton Table æ²¡æœ‰é‚£ä¹ˆå¥½çš„èƒ½åŠ›å»é…åˆä½ ã€‚æ‰€ä»¥è¿™é‡Œéœ€è¦ä¸€äº›åˆ«çš„æ–¹å¼æ¥å¤„ç†è¿™éƒ¨åˆ†é€»è¾‘ã€‚</p><p><img src="https://image.mwish.me/blog-image/2b26a32a-fb5c-4890-8978-eeeaed4454d7.png" alt="2b26a32a-fb5c-4890-8978-eeeaed4454d7"></p><p>è¿™éƒ¨åˆ†ä¸­ï¼Œç›¸å½“äºæ·»åŠ äº†ä¸€ä¸ª Delete Bufferï¼Œè¿™æ˜¯ä¸€ä¸ªç±»ä¼¼ InnoDB Change Buffer çš„ä¸œè¥¿ï¼Œå› ä¸ºæ‰¾åˆ°åŸè®°å½•æ˜¯éå¸¸æ˜‚è´µçš„ï¼Œéœ€è¦ä¸€æ¬¡ç‚¹æŸ¥ã€‚è¿™é‡Œå¼•å…¥äº†ä¸€ä¸ª delete bufferï¼Œæ¥ä¸“é—¨å¤„ç†è¿™ç±»åœºæ™¯ã€‚Delete Buffer æœ¬èº«æ˜¯ä¸€ä¸ªåŒ…å«åˆ é™¤ key çš„ Btreeã€‚å®ƒçš„æ ¼å¼æ˜¯ <code>&lt;Key, Delete-Generation&gt;</code>ï¼Œè¿™ä¸ª Generation æ˜¯ Delta move çš„ Generationï¼Œåˆ é™¤çš„æ—¶å€™ï¼Œä¼šç”¨æœ€é«˜çš„ Generation æ¥åˆ é™¤ã€‚</p><p>æŸ¥è¯¢ Delete Buffer çš„æ—¶å€™ï¼Œè¿™å¥—é€»è¾‘æ²¡æœ‰å†å°åœ¨è½¬æ¢å±‚ï¼Œè€Œæ˜¯æ’å…¥äº†ä¸€ä¸ª Join ç®—å­ï¼ˆanti-semi-joinï¼‰ï¼Œæ¥å¸¦ä¸Š Delete Bufferã€‚è¿™é‡Œåœ¨ Build é˜¶æ®µä¼šç®—å‡º key çš„ min-max æ˜¯å¦åœ¨è¿™ä¸ª row-group ä¸­ï¼Œæ¥è·³è¿‡ delete-buffer å¯¹ä¸€äº› RowGroup çš„è®¿é—®ã€‚</p><p>æ³¨æ„ï¼Œè¿™ä¸ª delete bitmap æ›´æ¥è¿‘ä¸Šä¸€ç¯‡è®ºæ–‡çš„å®šä¹‰ï¼Œè€Œä¸æ˜¯ primary index ä¸­é‚£ä¸ªä½¿ç”¨çš„å®šä¹‰ã€‚</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>InnoDB Link_buf</title>
      <link href="/2022/12/10/InnoDB-Link-buf/"/>
      <url>/2022/12/10/InnoDB-Link-buf/</url>
      
        <content type="html"><![CDATA[<p>InnoDB åœ¨ MySQL 8.0 ä¹‹åï¼Œæä¾›äº† Lock-Free WAL çš„æœºåˆ¶ï¼Œé¡ºåºç”³è¯· LSNï¼Œç„¶åæŠŠå†…å®¹æ‹·è´åˆ° Log åº”è¯¥å†™å…¥çš„ Buffer ä¸­ï¼Œæœ€åå†™å…¥ Diskï¼Œç„¶åé€šçŸ¥ä¸Šå±‚ã€‚åŒæ—¶ï¼ŒPage Flush å’Œè¿™å¥—æœºåˆ¶æ˜¯è”åŠ¨çš„ï¼ŒFlushList å’Œè¿™å¥—æ—¥å¿—æµç¨‹éœ€è¦è”åŠ¨ã€‚</p><p>ä¸ºä»€ä¹ˆéœ€è¦è´´è¿™å—å‘¢ï¼Ÿç›¸å¯¹äºä¸€èˆ¬çš„ mpmcï¼Œmpsc ç­‰é˜Ÿåˆ—ï¼ŒWAL æ˜¯ä¸€ä¸ªåœ¨æ•°æ®åº“ä¸­å¾ˆå¸¸ç”¨ï¼Œä¸ concurrent-queue æœ‰å…±åŒç‚¹ï¼Œä½†æ˜¯ä¹Ÿæœ‰ä¸åŒçš„å†…å®¹ã€‚å› ä¸ºå®ƒæ¶‰åŠå†…å­˜æ‹·è´å’Œ IOã€‚</p><p>æˆ‘ä»¬å…ˆç®€çŸ­ä»‹ç»ä¸€ä¸‹ä»åˆ«çš„æ–‡ç« æŠ„æ¥çš„ä»£ç å…¥å£ï¼ŒInnoDB å¯¹å†…å®¹çš„ä¿®æ”¹ä¼šèµ° mtrï¼Œmtr ä¼šæœ‰å¯¹ buffer çš„é”å’Œ Page Change çš„ Logsï¼ŒLog åœ¨ mtr æ‰§è¡Œé˜¶æ®µä¼š buffer åœ¨ mtr çš„å†…å­˜ä¸­ï¼Œåœ¨ commit é˜¶æ®µä¼šç§»åŠ¨åˆ° <code>log_sys_t::buf</code> ä¸­ï¼Œè¿™é‡Œä¼šé€šè¿‡ <code>log_sys_t::buf</code> æ¥å†™ï¼Œæ—¥å¿—ä¼šè¢«æ‹·è´åœ¨ Log Buffer ä¸­ï¼Œå½“é…ç½® <code>innodb_flush_log_at_trx_commit=1</code> çš„æ—¶å€™ï¼Œè¿™é‡Œä¼šåœ¨ txn-commit çš„æ—¶å€™æŒä¹…åŒ–æ—¥å¿—ã€‚</p><p>å†™å…¥ Log æ˜¯åœ¨ mtr æäº¤çš„æ—¶å€™ï¼š</p><ul><li>åˆ†é… LSN</li><li>ç­‰å¾…å†…å­˜çš„ Ring Buffer åŒ€å‡ºè¶³å¤Ÿçš„ç©ºé—´ï¼Œç„¶å Link åˆ°å¯¹åº”çš„ç»“æ„ä¸­</li><li>æ‹·è´åˆ°å†…å­˜ Buffer ä¸­</li></ul><p>åœ¨è¿™ä¹‹åï¼ŒPage çš„å†™å…¥å°±è¢«å†™å…¥åˆ°å†…å­˜çš„ Log Buffer äº†ï¼Œéšåï¼Œè„é¡µéœ€è¦è¢«åŠ å…¥ flush listï¼Œè¿™ä¸ªæ—¶å€™ï¼Œä¸ºäº†ç»´æŠ¤è„é¡µå†™å…¥çš„é¡ºåºï¼Œä¼šæœ‰ï¼š</p><ul><li><code>redo_log_mark_dirty_pages</code>: æ ‡è®°é¡µé¢ä¸º dirty</li><li>Link åˆ°å¯¹åº”çš„ç»“æ„ä¸­</li><li>ç”± Recent Closer çº¿ç¨‹æ¥å¤„ç†</li></ul><p>éœ€è¦è¯´æ˜çš„æ˜¯ï¼ŒFlush å’Œ LSN å¼ºç›¸å…³ï¼Œå› ä¸º ckpt ä¾èµ– LSNï¼Œè¿™ä¸ªå¯ä»¥è¯´æ˜¯ Recover å±‚çš„åŸå› ï¼ŒInnoDB çš„ Page ä¼šæœ‰ä¸‹é¢ä¸¤ä¸ªå‚æ•°ï¼š</p><ul><li><p><code>oldest_modification</code></p></li><li><p><code>newest_modification</code></p></li></ul><p>è¿™ä¸¤ä¸ªè¯å«ä¹‰å’Œå­—é¢æ„æ€å·®ä¸å¤šï¼Œmtr ä¿®æ”¹å•é¢— index å¯èƒ½ä¼šä¿®æ”¹å¤šä¸ª Pageï¼ˆè™½ç„¶æ¦‚ç‡ä¸Šå¯ä»¥å½“æˆå¤§éƒ¨åˆ†ä¹è§‚çš„åœºæ™¯ï¼Œå®ƒåªä¼šä¿®æ”¹ä¸€ä¸ª Pageï¼Œä½†æ˜¯æ¶‰åŠ SMO æˆ–è€…ä»€ä¹ˆçš„æ—¶å€™ï¼Œå¯èƒ½ä¼šä¿®æ”¹å¤šä¸ª Pageï¼‰ï¼Œå®ƒåœ¨ mtr commit çš„æ‹·è´ log é˜¶æ®µéœ€è¦æŒæœ‰è¿™äº›é¡µé¢çš„é”ã€‚è¿™ä¸ªåœ°æ–¹ä¼šå°½é‡è®© flush list æŒ‰ç…§ oldest modification çš„æ—¶é—´ä¸‹åˆ·ï¼Œåœ¨ 8.0 ä¹‹å‰çš„ç‰ˆæœ¬ï¼Œç”šè‡³æ˜¯æŒ‰ç…§è¿™ä¸ªé¡ºåºä¸‹åˆ·çš„ï¼š</p><p><img src="https://image.mwish.me/blog-image/ca7f50ef0815b17696656e1a27259016.png" alt="ca7f50ef0815b17696656e1a27259016"></p><p>è¿™ä¸ªå’Œ checkpoint çš„å’Œ Recover çš„å¤„ç†æœ‰å…³ï¼Œcheckpoint çš„æ—¶å€™ï¼Œä»æŸä¸ª Checkpoint LSN ä¸­æ¢å¤ï¼Œå¯èƒ½è¦è€ƒè™‘ LSN å’Œæ¢å¤ä¹‹é—´çš„å…³ç³»ï¼š</p><p><img src="https://image.mwish.me/blog-image/15a26426373819f5d7028880cf357f51.png" alt="15a26426373819f5d7028880cf357f51"></p><p>å¦åˆ™çš„è¯ï¼Œè¿™ä¸ªå¯èƒ½æ¢å¤çš„æ—¶å€™ï¼Œéœ€è¦ä¸€äº›ç‰¹æ®Šçš„å¤„ç†æœºåˆ¶ï¼š</p><p><img src="https://image.mwish.me/blog-image/577871cca6c66b0c091720e103568f7b.png" alt="577871cca6c66b0c091720e103568f7b"></p><p>åœ¨æ–°çš„ Design ä¸­ï¼Œè¿™é‡Œå¤§æ¦‚ä¼šç»´æŠ¤ä¸€äº›ä¹±åºåº¦ï¼Œç„¶åè®©å¯¹åº” Page åœ¨ L çš„åŒºé—´å†…ä¿è¯ä¸€å®šçš„ Orderã€‚</p><p>ç³»ç»Ÿä¸­ï¼Œç»´æŠ¤äº†ä¸‹é¢çš„å˜é‡ï¼š</p><ul><li>(<code>Link_buf</code>) <code>recent_written</code>: è®°å½•å†…å­˜æ‹·è´çš„ write. æŠ¤å†™log bufferçš„å®ŒæˆçŠ¶æ€, <code>recent_written</code>ä¸­ç»´æŠ¤çš„æœ€å¤§LSN, Mè¡¨ç¤º, æ‰€æœ‰å°äºè¿™ä¸ªMçš„LSNéƒ½å·²ç»å°†å®ƒçš„redo logå†™å…¥log buffer. è€Œè¿™ä¸ªMä¹Ÿæ˜¯(å¦‚æœè¿™ä¸‹crash, å¯èƒ½ä¼šè§¦å‘çš„)å´©æºƒæ¢å¤çš„æˆªæ­¢ä½ç‚¹, åŒæ—¶ä¹Ÿæ˜¯ä¸‹ä¸€ä¸ªå†™log bufferæ“ä½œçš„å¼€å§‹ä½ç‚¹.</li><li>(<code>Link_buf</code>) <code>recent_closed</code>: ç»´æŠ¤ flush LSN çš„é€’å¢æ€§è´¨</li><li>é¢å¤–çš„åå°çº¿ç¨‹(<code>log_writer</code>/ <code>log_flusher</code>, <code>log_flush_notifier</code>, <code>log_checkpointer</code>, â€¦</li></ul><p>è¿™ç¯‡æ–‡ç« ä¸ä¼šä»‹ç»å¤ªå¤š Buffer Pool æ— é” flushing çš„ç»†èŠ‚ï¼Œå› ä¸ºå†™æ–‡ç« çš„æ—¶å€™æˆ‘ä¹Ÿæ²¡å®Œå…¨ææ‡‚ã€‚</p><h2 id="ä»£ç å…¥å£"><a href="#ä»£ç å…¥å£" class="headerlink" title="ä»£ç å…¥å£"></a>ä»£ç å…¥å£</h2><p>å…·ä½“è€Œè¨€ï¼Œè¿™å—ç›¸å…³çš„ä»£ç åœ¨ <code>log0buf.cc</code> é‡Œé¢ï¼Œè¿™é‡Œé¢ä¹Ÿæœ‰ä¸å°‘çš„æè¿°ï¼Œç„¶åä¸€äº›å¤´æ–‡ä»¶å®šä¹‰åœ¨ <code>log0log.h</code> é‡Œé¢ï¼Œ<code>log_t</code> ç±»å‹åœ¨ <code>log0types.h</code> é‡Œé¢. å¤–ç•Œè°ƒç”¨åœ¨ mtr çš„ä»£ç ä¸­ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** Write the redo log record, add dirty pages to the flush list and release</span></span><br><span class="line"><span class="comment">the resources. */</span></span><br><span class="line"><span class="type">void</span> <span class="type">mtr_t</span>::Command::<span class="built_in">execute</span>() &#123;</span><br><span class="line">  <span class="built_in">ut_ad</span>(m_impl-&gt;m_log_mode != MTR_LOG_NONE);</span><br><span class="line"></span><br><span class="line">  ulint len;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> UNIV_HOTBACKUP</span></span><br><span class="line">  len = <span class="built_in">prepare_write</span>();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (len &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="type">mtr_write_log_t</span> write_log;</span><br><span class="line"></span><br><span class="line">    write_log.m_left_to_write = len;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">auto</span> handle = <span class="built_in">log_buffer_reserve</span>(*log_sys, len);</span><br><span class="line"></span><br><span class="line">    write_log.m_handle = handle;</span><br><span class="line">    write_log.m_lsn = handle.start_lsn;</span><br><span class="line">    write_log.m_rec_group_start_lsn = handle.start_lsn;</span><br><span class="line"></span><br><span class="line">    m_impl-&gt;m_log.for_each_block(write_log);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">ut_ad</span>(write_log.m_left_to_write == <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">ut_ad</span>(write_log.m_lsn == handle.end_lsn);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">log_wait_for_space_in_log_recent_closed</span>(*log_sys, handle.start_lsn);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">DEBUG_SYNC_C</span>(<span class="string">&quot;mtr_redo_before_add_dirty_blocks&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">add_dirty_blocks_to_flush_list</span>(handle.start_lsn, handle.end_lsn);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">log_buffer_close</span>(*log_sys, handle);</span><br><span class="line"></span><br><span class="line">    m_impl-&gt;m_mtr-&gt;m_commit_lsn = handle.end_lsn;</span><br><span class="line"></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">DEBUG_SYNC_C</span>(<span class="string">&quot;mtr_noredo_before_add_dirty_blocks&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">add_dirty_blocks_to_flush_list</span>(<span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/* !UNIV_HOTBACKUP */</span></span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">release_all</span>();</span><br><span class="line">  <span class="built_in">release_resources</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="LSN-åˆ†é…"><a href="#LSN-åˆ†é…" class="headerlink" title="LSN åˆ†é…"></a>LSN åˆ†é…</h3><p>æˆ‘ä»¬ä¸è¿‡åº¦ç‰µæ¶‰ mtr çš„ç»†èŠ‚ï¼Œé¦–å…ˆè¿™é‡Œéœ€è¦ reserve å¯¹åº”çš„ lsn:</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@see @ref sect_redo_log_buf_reserve</span><br><span class="line">@param[in,out]logredo log</span><br><span class="line">@param[in]lennumber of data bytes to reserve <span class="keyword">for</span> write</span><br><span class="line">@<span class="keyword">return</span> handle that represents the reservation */</span><br><span class="line">Log_handle <span class="built_in">log_buffer_reserve</span>(<span class="type">log_t</span> &amp;log, <span class="type">size_t</span> len);</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä¼šåˆ©ç”¨ <code>fetch_add</code> æ¥æ‹‰å¤§å¯¹åº”çš„å†…å®¹ï¼Œè¿™é‡Œæœ‰ä¸ªåŒºåˆ«æ˜¯ sn å’Œ lsn:</p><ul><li>sn æ˜¯é€»è¾‘çš„ bytes</li><li>lsn æ˜¯ç‰©ç†ä¸Šçš„ bytes bias</li></ul><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Log_handle <span class="title">log_buffer_reserve</span><span class="params">(<span class="type">log_t</span> &amp;log, <span class="type">size_t</span> len)</span> </span>&#123;</span><br><span class="line">  Log_handle handle;</span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Reserve space in sequence of data bytes: */</span></span><br><span class="line">  <span class="type">const</span> <span class="type">sn_t</span> start_sn = log.sn.<span class="built_in">fetch_add</span>(len);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Ensure that redo log has been initialized properly. */</span></span><br><span class="line">  <span class="built_in">ut_a</span>(start_sn &gt; <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Headers in redo blocks are not calculated to sn values: */</span></span><br><span class="line">  <span class="type">const</span> <span class="type">sn_t</span> end_sn = start_sn + len;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">LOG_SYNC_POINT</span>(<span class="string">&quot;log_buffer_reserve_before_sn_limit_for_end&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Translate sn to lsn (which includes also headers in redo blocks): */</span></span><br><span class="line">  handle.start_lsn = <span class="built_in">log_translate_sn_to_lsn</span>(start_sn);</span><br><span class="line">  handle.end_lsn = <span class="built_in">log_translate_sn_to_lsn</span>(end_sn);</span><br><span class="line"></span><br><span class="line">  ...</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œç”¨ <code>fetch_add</code> æ·»åŠ äº†å¯¹åº”çš„ sn / lsnï¼Œåˆ†é…äº†æ—¥å¿—å¯¹åº”çš„ <code>start_lsn</code> å’Œ <code>end_lsn</code>ï¼Œç„¶åè¿™éƒ¨åˆ†ç®—æ˜¯ LSN åˆ†é…å®Œæˆäº†ï¼Œä¸è¿‡ï¼Œåœ¨åŒä¸€ä¸ªå‡½æ•°ä¸­ï¼Œè¿˜æœ‰ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">if</span> (<span class="built_in">unlikely</span>(end_sn &gt; log.sn_limit_for_end.<span class="built_in">load</span>())) &#123;</span><br><span class="line">    <span class="built_in">log_wait_for_space_after_reserving</span>(log, handle);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">ut_a</span>(<span class="built_in">log_lsn_validate</span>(handle.start_lsn));</span><br><span class="line">  <span class="built_in">ut_a</span>(<span class="built_in">log_lsn_validate</span>(handle.end_lsn));</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (handle);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸€éƒ¨åˆ†æ˜¯è¦ç­‰å¾… Log åˆ†é…è¶³å¤Ÿçš„ç©ºé—´ã€‚è¿™ä¸ªç©ºé—´å¤§å°æ˜¯æ€ä¹ˆä¼šæ˜¯å‘¢ï¼Ÿ</p><h3 id="ç­‰å¾…-LSN"><a href="#ç­‰å¾…-LSN" class="headerlink" title="ç­‰å¾… LSN"></a>ç­‰å¾… LSN</h3><p>(è¿™é‡Œå¯ä»¥å‚è€ƒ InnoDB REDO LOG BUFFERç®¡ç† - ä¸å‡¯çš„æ–‡ç«  - çŸ¥ä¹ <a href="https://zhuanlan.zhihu.com/p/358690853">https://zhuanlan.zhihu.com/p/358690853</a> è¿™ç¯‡æ–‡ç« ï¼Œå†™å¾—æ¯”è¾ƒç»†)</p><p><code>log.sn_limit_for_end</code> æ˜¯ä¸ª atomic variableï¼Œå®ƒçš„æ›´æ–°å—é”ä¿æŠ¤ï¼Œä½†æ˜¯è¯»çš„æ—¶å€™å¯ä»¥ç›´æ¥ fastpath è¯»ï¼Œæ¥ä¿è¯è¯»çš„æ€§èƒ½:</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">    <span class="comment">/** @&#123; */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/** Maximum sn up to which there is free space in both the log buffer</span></span><br><span class="line"><span class="comment">    and the log files. This is limitation for the end of any write to the</span></span><br><span class="line"><span class="comment">    log buffer. Threads, which are limited need to wait, and possibly they</span></span><br><span class="line"><span class="comment">    hold latches of dirty pages making a deadlock possible.</span></span><br><span class="line"><span class="comment">    Protected by: writer_mutex (writes). */</span></span><br><span class="line">    <span class="type">atomic_sn_t</span> sn_limit_for_end;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** Maximum sn up to which there is free space in both the log buffer</span></span><br><span class="line"><span class="comment">and the log files for any possible mtr. This is limitation for the</span></span><br><span class="line"><span class="comment">beginning of any write to the log buffer. Threads check this limitation</span></span><br><span class="line"><span class="comment">when they are outside mini transactions and hold no latches. The formula</span></span><br><span class="line"><span class="comment">used to calculate the limitation takes into account maximum size of mtr</span></span><br><span class="line"><span class="comment">and thread concurrency to include proper margins and avoid issue with</span></span><br><span class="line"><span class="comment">race condition (in which all threads check the limitation and then all</span></span><br><span class="line"><span class="comment">proceed with their mini transactions).</span></span><br><span class="line"><span class="comment">Protected by: writer_mutex (writes). */</span></span><br><span class="line"><span class="type">atomic_sn_t</span> sn_limit_for_start;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œåœ¨ <code>log_wait_for_space_after_reserving</code> é‡Œé¢ï¼Œä¼šèµ°ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">log_wait_for_space_after_reserving</span><br><span class="line">- log_wait_for_space_in_log_buf(log, start_sn)</span><br><span class="line">- - log_write_up_to (ç­‰å¾… start_lsn - log.write_lsn &lt;= log.buf_size)</span><br><span class="line">æŸ¥çœ‹ Log æ˜¯å¦æ¯”è¾ƒå¤§, è¦åˆ†é… Log çš„ Buffer, ä¹Ÿå¯èƒ½èµ° log_write_up_to</span><br><span class="line">- log_wait_for_space_in_log_buf(log, end_sn)</span><br><span class="line">- - log_write_up_to (ç­‰å¾… end_lsn - log.write_lsn &lt;= log.buf_size)</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªåœ°æ–¹ï¼Œå…³é”®çš„å‡½æ•°æ˜¯ <code>log_write_up_to</code>, <code>write_lsn</code> æ˜¯å†™å…¥ buffer çš„ LSNï¼Œè¿™é‡Œä¿è¯è¿™éƒ¨åˆ†å†…å®¹èƒ½å¤Ÿè¢«å†™å…¥.</p><p>è¿™é‡Œå…¶å®æœ‰ä¸ªå¾ˆ confusing çš„åœ°æ–¹ï¼Œå°±æ˜¯è¿™ä¸ªåœ°æ–¹ä¿è¯çš„æ˜¯ç¯çŠ¶ Log çš„æ€»ç©ºé—´å’Œ Log Buffer çš„ç©ºé—´ï¼Œå‡ºç°é—®é¢˜æ¦‚ç‡éå¸¸ä½ã€‚è¿™ä¸ªå’Œåé—® Link_buf ä¹‹ç±»çš„ç©ºé—´ä¸å®Œå…¨ä¸€è‡´ï¼ˆä¸¥æ ¼æ¥è¯´åº”è¯¥æ¯”å®ƒå¤§å¾ˆå¤šï¼Œ</p><h3 id="Link-buf"><a href="#Link-buf" class="headerlink" title="Link_buf"></a>Link_buf</h3><p>æˆ‘ä»¬æå‰ä»‹ç»ä¸€ä¸‹ <code>Link_buf</code>, é¦–å…ˆï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œä¸Šé¢çš„æ‹·è´æ˜¯ä¸€ä¸ªç”³è¯· LSNï¼Œç„¶åå„ä¸ª mtr åˆ†å°æ®µ copy çš„æ¨¡å¼ï¼Œé‚£ä¹ˆï¼Œè¿™ä¸ªåœ°æ–¹åŠ¿å¿…æœ‰å‡ ä¸ª Log æ°´ä½ï¼Œä¸è€ƒè™‘ ckpt é‚£äº›ä¸œè¥¿ï¼Œå°±çœ‹å†…å­˜çš„è¯ï¼š</p><ul><li>å·²ç» Flush çš„ WAL</li><li>æ‹·è´å®Œäº†çš„ WAL</li><li>æ­£åœ¨æ‹·è´å’Œåˆ†é…äº†æ²¡æ‹·è´çš„ WAL</li></ul><p>è¿™ä¸ªæ—¶å€™ï¼Œä¼šæœ‰ä¸‹é¢çš„æ°´ä½å›¾ï¼š</p><p><img src="https://image.mwish.me/blog-image/1eae15078668ccd0d3e54e11f1783dfc.png" alt="1eae15078668ccd0d3e54e11f1783dfc"></p><p>Link_buf ç”¨æ¥ç»´æŠ¤å’Œæ¨è¿›è¿™äº›æ°´ä½ï¼Œå®ƒæŠŠæ•°æ®åˆ’åˆ†ä¸º slotï¼Œå¹¶ä¸”ä¿è¯æ•°ç»„å…ƒç´ (slot)æ›´æ–°æ˜¯åŸå­çš„, ä»¥ç¯å½¢å½¢å¼å¤ç”¨å·²ç»é‡Šæ”¾çš„ç©ºé—´ï¼Œå¹¶å¯ç”¨å•ç‹¬çš„çº¿ç¨‹è´Ÿè´£æ•°ç»„çš„éå†å’Œç©ºé—´å›æ”¶, çº¿ç¨‹åœ¨é‡åˆ°ç©ºå…ƒç´ (empty slot)æ—¶æš‚åœã€‚</p><p>å’Œï¼š</p><p><img src="https://image.mwish.me/blog-image/843bc5776c34866f20b5dc0086474bfc.png" alt="843bc5776c34866f20b5dc0086474bfc"></p><p>è¿™é‡Œå¯ä»¥ç»´æŠ¤ write_lsn å’Œ ready-for-write çš„è¿ç»­ LSNï¼š</p><p><img src="https://image.mwish.me/blog-image/1dc4e6fcece341ee62383b4ab87d95d0.png" alt="1dc4e6fcece341ee62383b4ab87d95d0"></p><p>è¿™é‡Œå®ƒç»´æŠ¤äº†å‡ ä¸ªæ°´ä½å’Œä¸€äº›ä¸­é—´çš„çŠ¶æ€ã€‚</p><p>å…³äº <code>Link_buf</code>ï¼Œè¿™ä¸ªç±»å‹åªæœ‰ä¸‰ç™¾ä½™è¡Œï¼Œå†…å®¹å¯ä»¥å‚è€ƒï¼š<a href="http://mysql.taobao.org/monthly/2019/05/08/">http://mysql.taobao.org/monthly/2019/05/08/</a> ã€‚éœ€è¦ç‰¹åˆ«æ³¨æ„çš„æ˜¯ï¼Œ<code>Link_buf</code> å¾ˆå¤šçº¦æŸæ˜¯éœ€è¦ä¸Šå±‚æ¥ä¿è¯çš„ã€‚</p><p><code>Link_buf</code> ä¼šåˆ†é…ä¸€å—æ¯”è¾ƒå¤§çš„å†…å­˜ï¼ˆè§åæ–‡ï¼‰ç„¶åç”¨äº Linkï¼Œæˆ‘ä»¬å…ˆçœ‹çœ‹ API:</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** Add a directed link between two given positions. It is user&#x27;s</span></span><br><span class="line"><span class="comment">responsibility to ensure that there is space for the link. This is</span></span><br><span class="line"><span class="comment">because it can be useful to ensure much earlier that there is space.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">@param[in]fromposition where the link starts</span></span><br><span class="line"><span class="comment">@param[in]toposition where the link ends (from -&gt; to) */</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">add_link</span><span class="params">(Position from, Position to)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** Advances the tail pointer in the buffer by following connected</span></span><br><span class="line"><span class="comment">path created by links. Starts at current position of the pointer.</span></span><br><span class="line"><span class="comment">Stops when the provided function returns true.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">@param[in]stop_conditionfunction used as a stop condition;</span></span><br><span class="line"><span class="comment">                                (lsn_t prev, lsn_t next) -&gt; bool;</span></span><br><span class="line"><span class="comment">                                returns false if we should follow</span></span><br><span class="line"><span class="comment">                                the link prev-&gt;next, true to stop</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">@return true if and only if the pointer has been advanced */</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> Stop_condition&gt;</span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">advance_tail_until</span><span class="params">(Stop_condition stop_condition)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** Advances the tail pointer in the buffer without additional</span></span><br><span class="line"><span class="comment">condition for stop. Stops at missing outgoing link.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">@see advance_tail_until()</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">@return true if and only if the pointer has been advanced */</span></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">advance_tail</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** @return capacity of the ring buffer */</span></span><br><span class="line"><span class="function"><span class="type">size_t</span> <span class="title">capacity</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** @return the tail pointer */</span></span><br><span class="line"><span class="function">Position <span class="title">tail</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** Checks if there is space to add link at given position.</span></span><br><span class="line"><span class="comment">User has to use this function before adding the link, and</span></span><br><span class="line"><span class="comment">should wait until the free space exists.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">@param[in]positionposition to check</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">@return true if and only if the space is free */</span></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">has_space</span><span class="params">(Position position)</span> <span class="type">const</span></span>;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯ä»¥å€ŸåŠ©å®˜ç½‘çš„å›¾ç‰‡æ¥ç†è§£è¿™äº› API:</p><p><img src="https://image.mwish.me/blog-image/b704115a35af372c5c5c57fc1b2fa78e.png" alt="b704115a35af372c5c5c57fc1b2fa78e"></p><ul><li><code>tail</code>: å…¶å®æ˜¯è¿ç»­çš„é˜Ÿåˆ—çš„å¼€å¤´ï¼Œç”¨æ¥å¼€å§‹è·³è½¬ï¼Œè¿™ä¸ªæ˜¯ä¸€ä¸ª atomic çš„ lsn æˆ–è€…åˆ«çš„ä½ç½®æ ‡è®°</li><li><code>has_space</code> åˆ¤æ–­æœ‰æ²¡æœ‰è¿ç»­ç©ºé—´ï¼Œå› ä¸º <code>Link_buf</code> è¿™å—çš„å†…å­˜å¯èƒ½ä¼šå°‘äºå¯åˆ†é… LSN çš„å†…å­˜</li><li><code>advance_tail_until</code> å’Œ <code>advance_tail</code> éƒ½ä¼šå°è¯•æ¨è¿› tailï¼Œå…¶å®ç›¸å½“äºæ¨è¿›ç©ºé—´ã€‚è¿™ä¸ªå¯èƒ½ä¼šä¼ ä¸€ä¸ªåœæ­¢æ¡ä»¶è¿›å»ã€‚</li><li><code>add_link</code>: æ·»åŠ ä¸€ä¸ª Link, Link æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿå°±æ˜¯å¦‚ä¸Šæ–‡æ‰€è¿°çš„ 4-&gt;, 4-&gt; çš„æ ‡è®°ã€‚</li></ul><p>è¿˜æœ‰ä¸€äº›å†…éƒ¨å®ç°çš„ API:</p><ul><li><code>next_position</code>: è·³è½¬åˆ°ä¸‹ä¸€ä¸ªåœ°å€</li><li><code>clain_position</code>: æŠŠæœ¬åœ°å€ç½® 0</li></ul><p>è¿™é‡Œæ„Ÿè§‰ lock-free ä¹Ÿä¸éš¾ï¼Œå› ä¸ºå‡è®¾</p><ol><li>å¹¶å‘ <code>add_link</code><ol><li>ä¸Šå±‚ä¿è¯äº† from - to çš„åˆ†é…æ˜¯ sn åˆ†é…çš„ï¼ŒåŒæ—¶ï¼Œç”¨æˆ·æ’å…¥çš„ä¸€å®šæ˜¯ <code>has_space</code> çš„ï¼Œä¹‹å‰æ²¡æœ‰ overflow çš„ä¹‹åå¿…å®šä¸å¯èƒ½ overflowï¼Œæ‰€ä»¥æ“ä½œæˆåŠŸçš„æ²¡æœ‰å†²çª</li></ol></li><li>åœ¨ <code>advance_tail</code> çš„æƒ…å†µä¸‹ï¼Œå·²ç»å­˜åœ¨çš„å†™æ˜¯å·²ç» <code>has_space</code> çš„ï¼Œè¿™é‡Œåªä¼šæ¶ˆé™¤å®Œæˆçš„å†™ã€‚æç«¯æƒ…å†µå¹¶å‘ <code>advance_tail</code> çš„æ—¶å€™ï¼Œå¯èƒ½æ¨è¿›ä¸åŸå­ï¼Œæ‰€ä»¥åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹åœ¨ <code>advance_tail</code>ï¼Œè§‚å¯Ÿä¸‹åˆ—ä»£ç å¯ä»¥è½»æ¾å¾—å‡ºè¿™ä¸ªç»“è®º</li></ol><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> Position&gt;</span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> Stop_condition&gt;</span><br><span class="line"><span class="type">bool</span> Link_buf&lt;Position&gt;::<span class="built_in">advance_tail_until</span>(Stop_condition stop_condition) &#123;</span><br><span class="line">  <span class="keyword">auto</span> position = m_tail.<span class="built_in">load</span>();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">    Position next;</span><br><span class="line"></span><br><span class="line">    <span class="type">bool</span> stop = <span class="built_in">next_position</span>(position, next);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (stop || <span class="built_in">stop_condition</span>(position, next)) &#123;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Reclaim the slot. */</span></span><br><span class="line">    <span class="built_in">claim_position</span>(position);</span><br><span class="line"></span><br><span class="line">    position = next;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (position &gt; m_tail.<span class="built_in">load</span>()) &#123;</span><br><span class="line">    m_tail.<span class="built_in">store</span>(position);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Copying-Redo-Log"><a href="#Copying-Redo-Log" class="headerlink" title="Copying Redo Log"></a>Copying Redo Log</h3><p>è¿™èŠ‚å†…å®¹å¯ä»¥å‚è€ƒï¼š<a href="http://mysql.taobao.org/monthly/2021/09/04/">http://mysql.taobao.org/monthly/2021/09/04/</a></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">write_log.m_handle = handle;</span><br><span class="line">write_log.m_lsn = handle.start_lsn;</span><br><span class="line">write_log.m_rec_group_start_lsn = handle.start_lsn;</span><br><span class="line"></span><br><span class="line">m_impl-&gt;m_log.for_each_block(write_log);</span><br></pre></td></tr></table></figure><p><code>write_log</code> æ˜¯ä¸€ä¸ªå‡½æ•°å¯¹è±¡ï¼Œè¿™é‡Œå¯¹æ¯ä¸ª block å†™å…¥è¿™ä¸ªå†…å®¹ï¼Œå…·ä½“çš„ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** Write the block contents to the REDO log */</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">mtr_write_log_t</span> &#123;</span><br><span class="line">  <span class="comment">/** Append a block to the redo log buffer.</span></span><br><span class="line"><span class="comment">  @return whether the appending should continue */</span></span><br><span class="line">  <span class="function"><span class="type">bool</span> <span class="title">operator</span><span class="params">()</span><span class="params">(<span class="type">const</span> <span class="type">mtr_buf_t</span>::<span class="type">block_t</span> *block)</span> </span>&#123;</span><br><span class="line">    <span class="type">lsn_t</span> start_lsn;</span><br><span class="line">    <span class="type">lsn_t</span> end_lsn;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">ut_ad</span>(block != <span class="literal">nullptr</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (block-&gt;<span class="built_in">used</span>() == <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> (<span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    start_lsn = m_lsn;</span><br><span class="line"></span><br><span class="line">    end_lsn = <span class="built_in">log_buffer_write</span>(*log_sys, m_handle, block-&gt;<span class="built_in">begin</span>(),</span><br><span class="line">                               block-&gt;<span class="built_in">used</span>(), start_lsn);</span><br><span class="line"></span><br><span class="line">    m_left_to_write -= block-&gt;<span class="built_in">used</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (m_left_to_write == <span class="number">0</span></span><br><span class="line">        &amp;&amp; m_rec_group_start_lsn / OS_FILE_LOG_BLOCK_SIZE !=</span><br><span class="line">               end_lsn / OS_FILE_LOG_BLOCK_SIZE) &#123;</span><br><span class="line">      <span class="built_in">log_buffer_set_first_record_group</span>(*log_sys, m_handle, end_lsn);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">log_buffer_write_completed</span>(*log_sys, m_handle, start_lsn, end_lsn);</span><br><span class="line"></span><br><span class="line">    m_lsn = end_lsn;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (<span class="literal">true</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  Log_handle m_handle;</span><br><span class="line">  <span class="type">lsn_t</span> m_lsn;</span><br><span class="line">  <span class="type">lsn_t</span> m_rec_group_start_lsn;</span><br><span class="line">  ulint m_left_to_write;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆä»‹ç»ä¸€ä¸‹ <code>mtr_buf_t</code>:</p><blockquote><p>mtr_buf_tæ˜¯ç”±ä¸€ä¸ªåŒå‘é“¾è¡¨ç»„æˆçš„åŠ¨æ€bufferï¼Œæ¯ä¸ªå…ƒç´ æ˜¯512Bå¤§å°çš„bufferï¼ˆ512Båˆšå¥½åŒ¹é…ä¸€ä¸ªlog blockå¤§å°ï¼‰ã€‚éšç€mtr_buf_tå­˜å‚¨çš„æ•°æ®çš„å¢åŠ ï¼Œå®ƒä¼šè‡ªåŠ¨ç”Ÿæˆæ–°çš„512Bçš„bufferï¼Œå¹¶åŠ å…¥åŒå‘é“¾è¡¨ä¸­ã€‚</p></blockquote><p>è¿™é‡Œä¼šèµ° <code>log_buffer_write</code> ï¼Œæ‹·è´å†…å®¹åˆ° log_buffer ä¸­ã€‚</p><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œè¿™ä¸ªå†…å®¹ä¸æ˜¯å®Œå…¨ã€Œä¸€æ¬¡æ€§æ‹·è´ã€çš„ï¼Œè€Œæ˜¯æŒ‰ç…§ <code>block</code> ç²’åº¦æ‹·è´åˆ°å…¬å…± log bufferï¼Œç„¶åè°ƒç”¨ complete çš„ï¼Œè¿™é‡Œæ¶‰åŠä¸¤ä¸ªå‡½æ•°ï¼š</p><ul><li>log_buffer_write</li><li>log_buffer_write_completed</li></ul><p><code>log_buffer_write</code> ä¼šå®Œæˆæ‹·è´ï¼Œæ‹·è´æœ‰ä»€ä¹ˆéš¾çš„å‘¢ï¼Ÿç­”æ¡ˆæ˜¯è¿™é‡Œä¼šæŠŠ block è½¬åŒ–æˆ innodb ç‰©ç† Redo Log çš„æ ¼å¼ï¼Œè¿˜æ˜¯è¦ä¸€äº›è½¬åŒ–çš„ã€‚è¿™é‡Œä¼šæ‹·è´åˆ°å…¬å…±çš„ log buf ä¸­ã€‚</p><p><code>log_buffer_write_completed</code> ç›¸å¯¹æ¥è¯´å¤æ‚ä¸€äº›ï¼Œæˆ‘ä»¬é¦–å…ˆçœ‹ä¸€äº›åˆ«çš„å®šä¹‰ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** Default value of innodb_log_recent_written_size (in bytes). */</span></span><br><span class="line"><span class="keyword">constexpr</span> ulong INNODB_LOG_RECENT_WRITTEN_SIZE_DEFAULT = <span class="number">1024</span> * <span class="number">1024</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** Minimum allowed value of innodb_log_recent_written_size. */</span></span><br><span class="line"><span class="keyword">constexpr</span> ulong INNODB_LOG_RECENT_WRITTEN_SIZE_MIN = OS_FILE_LOG_BLOCK_SIZE;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** Maximum allowed value of innodb_log_recent_written_size. */</span></span><br><span class="line"><span class="keyword">constexpr</span> ulong INNODB_LOG_RECENT_WRITTEN_SIZE_MAX = <span class="number">1024</span> * <span class="number">1024</span> * <span class="number">1024UL</span>;</span><br></pre></td></tr></table></figure><p>å’Œ:</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** Number of slots in a small buffer, which is used to allow concurrent</span></span><br><span class="line"><span class="comment">writes to log buffer. The slots are addressed by LSN values modulo number</span></span><br><span class="line"><span class="comment">of the slots. */</span></span><br><span class="line">ulong srv_log_recent_written_size = INNODB_LOG_RECENT_WRITTEN_SIZE_DEFAULT;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä¼šç­‰å¾…æœ‰è¶³å¤Ÿçš„ç©ºé—´ç„¶å <code>add_link</code>:</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">log_buffer_write_completed</span><span class="params">(<span class="type">log_t</span> &amp;log, <span class="type">const</span> Log_handle &amp;handle,</span></span></span><br><span class="line"><span class="params"><span class="function">                                <span class="type">lsn_t</span> start_lsn, <span class="type">lsn_t</span> end_lsn)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Let M = log.recent_written_size (number of slots).</span></span><br><span class="line"><span class="comment">  For any integer k, all lsn values equal to: start_lsn + k*M</span></span><br><span class="line"><span class="comment">  correspond to the same slot, and only the smallest of them</span></span><br><span class="line"><span class="comment">  may use the slot. At most one of them can fit the range</span></span><br><span class="line"><span class="comment">  [log.buf_ready_for_write_lsn..log.buf_ready_ready_write_lsn+M).</span></span><br><span class="line"><span class="comment">  Any smaller values have already used the slot. Hence, we just</span></span><br><span class="line"><span class="comment">  need to wait until start_lsn will fit the mentioned range. */</span></span><br><span class="line"></span><br><span class="line">  <span class="type">uint64_t</span> wait_loops = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (!log.recent_written.<span class="built_in">has_space</span>(start_lsn)) &#123;</span><br><span class="line">    ++wait_loops;</span><br><span class="line">    <span class="built_in">os_thread_sleep</span>(<span class="number">20</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">unlikely</span>(wait_loops != <span class="number">0</span>)) &#123;</span><br><span class="line">    <span class="built_in">MONITOR_INC_VALUE</span>(MONITOR_LOG_ON_RECENT_WRITTEN_WAIT_LOOPS, wait_loops);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Disallow reordering of writes to log buffer after this point.</span></span><br><span class="line"><span class="comment">  This is actually redundant, because we use seq_cst inside the</span></span><br><span class="line"><span class="comment">  log.recent_written.add_link(). However, we&#x27;ve decided to leave</span></span><br><span class="line"><span class="comment">  the seperate acq-rel synchronization between user threads and</span></span><br><span class="line"><span class="comment">  log writer. Reasons:</span></span><br><span class="line"><span class="comment">          1. Not to rely on internals of Link_buf::add_link.</span></span><br><span class="line"><span class="comment">          2. Stress that this synchronization is required in</span></span><br><span class="line"><span class="comment">             case someone decided to weaken memory ordering</span></span><br><span class="line"><span class="comment">             inside Link_buf. */</span></span><br><span class="line">  std::<span class="built_in">atomic_thread_fence</span>(std::memory_order_release);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Note that end_lsn will not point to just before footer,</span></span><br><span class="line"><span class="comment">  because we have already validated that end_lsn is valid. */</span></span><br><span class="line">  log.recent_written.<span class="built_in">add_link</span>(start_lsn, end_lsn);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Log-Writer-amp-amp-Log-Flusher"><a href="#Log-Writer-amp-amp-Log-Flusher" class="headerlink" title="Log Writer &amp;&amp; Log Flusher"></a>Log Writer &amp;&amp; Log Flusher</h3><p>è¿™éƒ¨åˆ†ä»£ç åœ¨ <code>log0write.cc</code>ï¼Œè¿™é‡Œä¸ºäº†å†²çªï¼Œæ‹†åˆ†æˆäº†å¤šä¸ªçº¿ç¨‹æ¥åš Log çš„å†™å…¥ã€‚</p><p><img src="https://image.mwish.me/blog-image/innodb_notify.png" alt="innodb_notify"></p><p>(å›¾ç‰‡æ¥è‡ª CatKang çš„åšå®¢)</p><p>é¦–å…ˆï¼Œæˆ‘ä»¬å…³æ³¨ Log-Writer Threadï¼Œä»–ä¼šç”¨ <code>Link_buf</code> å»è¿½é‚£äº›å®Œæˆçš„æ“ä½œï¼ŒæŠŠå®ƒä»¬ Link èµ·æ¥ï¼Œå…·ä½“çš„æ¡ä»¶æ˜¯ï¼š</p><ul><li>é‡åˆ°çš„éƒ½æ˜¯è¿ç»­çš„ï¼ˆè§ <code>Link_buf</code> çš„å›¾ï¼‰</li><li>ä¸å¤§äºä¸€å®šå¤§å°ï¼ˆå¯èƒ½ 4kï¼‰</li></ul><p>æ”¶é›†å®Œä¹‹åï¼Œå®ƒä¼šæ ‡è®°å‡ºå¯¹åº”çš„æ•°æ®ï¼Œç„¶åæ˜ å°„åˆ°ç£ç›˜ç»“æ„ä¸Šï¼Œæ ‡è®° Header ä¹‹ç±»çš„å†…å®¹ã€‚è¿™é‡Œæœ‰ä¸ªå°ç»†èŠ‚æ˜¯ <code>incomplete block</code> åœ¨å…¶ä¸­çš„å¤„ç†ï¼Œå…·ä½“å¯è§ï¼šInnoDBï¼šredo logï¼ˆ1ï¼‰ - Skywalkerçš„æ–‡ç«  - çŸ¥ä¹ <a href="https://zhuanlan.zhihu.com/p/386710765">https://zhuanlan.zhihu.com/p/386710765</a></p><p>è¿™é‡Œ Log Writer ä¼šé€šè¿‡ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">log_advance_ready_for_write_lsn</span><br><span class="line">- advance_tail_until</span><br></pre></td></tr></table></figure><p>ç­‰è°ƒç”¨æ¥æ¨è¿›ã€‚</p><h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><ul><li><a href="https://mysqlserverteam.com/mysql-8-0-new-lock-free-scalable-wal-design/">https://mysqlserverteam.com/mysql-8-0-new-lock-free-scalable-wal-design/</a></li><li><a href="http://mysql.taobao.org/monthly/2018/06/01/">http://mysql.taobao.org/monthly/2018/06/01/</a> (ä¸Šé¢è¿™ç¯‡çš„ç¿»è¯‘)</li><li><a href="https://catkang.github.io/2020/02/27/mysql-redo.html">https://catkang.github.io/2020/02/27/mysql-redo.html</a> InnoDB Redo Log çš„ä¸€ä¸ª generalï¼ŒåŒ…æ‹¬å„å±‚ï¼Œæœ¬æ–‡åªæ˜¯å…¶ä¸­ä¸€ä¸ªå°ç¢ç‰‡</li><li>InnoDB Redo Log è°ƒæ•´ï¼Œå…è®¸åŠ¨æ€è°ƒæ•´ Redo Logï¼š<a href="http://mysql.taobao.org/monthly/2022/09/03/">http://mysql.taobao.org/monthly/2022/09/03/</a></li><li>Rsygg ç¥æ–‡ InnoDB ç¡®å®š checkpoint-lsn çš„ä¸€å¤„ç»†èŠ‚ï¼š<a href="https://github.com/rsy56640/triviality/tree/master/content/innodb-ckpt-lsn">https://github.com/rsy56640/triviality/tree/master/content/innodb-ckpt-lsn</a></li><li>InnoDB 5.7 ç‰ˆæœ¬çš„å®ç°ï¼Œæ²¡å…¨éƒ¨çœ‹å®Œï¼Œç®€å•è¿‡äº†ä¸€éï¼Œæ‹¥æœ‰ä¸€å®šå‚è€ƒå’Œå¯¹æ¯”ä»·å€¼ï¼š<a href="http://liuyangming.tech/06-2019/LogBufferAndBufferPool.html">http://liuyangming.tech/06-2019/LogBufferAndBufferPool.html</a></li><li>InnoDB REDO LOG BUFFERç®¡ç† - ä¸å‡¯çš„æ–‡ç«  - çŸ¥ä¹ <a href="https://zhuanlan.zhihu.com/p/358690853">https://zhuanlan.zhihu.com/p/358690853</a></li><li><a href="http://mysql.taobao.org/monthly/2021/09/04/">http://mysql.taobao.org/monthly/2021/09/04/</a></li><li><a href="http://mysql.taobao.org/monthly/2019/05/08/">http://mysql.taobao.org/monthly/2019/05/08/</a></li><li>InnoDBï¼šredo logï¼ˆ1ï¼‰ - Skywalkerçš„æ–‡ç«  - çŸ¥ä¹ <a href="https://zhuanlan.zhihu.com/p/386710765">https://zhuanlan.zhihu.com/p/386710765</a></li></ul>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>[SOSP&#39;11] Windows Azure Storage</title>
      <link href="/2022/11/24/SOSP-11-Windows-Azure-Storage/"/>
      <url>/2022/11/24/SOSP-11-Windows-Azure-Storage/</url>
      
        <content type="html"><![CDATA[<p>ç°ä»£ç³»ç»Ÿä¸­ï¼Œå¯¹è±¡å­˜å‚¨æ­£åœ¨æˆä¸ºè¶Šæ¥è¶Šé‡è¦çš„ç³»ç»ŸåŸºæœ¬ç»„ä»¶ã€‚ä»¥ S3 ä¸ºé¦–çš„å¯¹è±¡å­˜å‚¨æä¾›äº†å¹³å°çš„å±‚çº§è¿‘ä¹æ— é™çš„å­˜å‚¨ç©ºé—´ã€‚é˜¿é‡Œäº‘äº§å“è¿™é‡Œæœ‰ä¸€ä¸ªæ¯”è¾ƒç®€å•çš„ä»‹ç»ï¼š<a href="https://help.aliyun.com/document_detail/140812.html">https://help.aliyun.com/document_detail/140812.html</a></p><p>ç›¸å¯¹äºæ²¡ä»€ä¹ˆä»‹ç»çš„ S3ï¼ŒWindows Azure Storage åœ¨ SOSPâ€™11 æä¾›äº†æ¯”è¾ƒè¯¦ç»†çš„æè¿°ã€‚æ® References ä¸­çš„å°é“æ¶ˆæ¯ï¼Œæœ¬æ–‡å¾ˆå¤šä½œè€…å»äº†é˜¿é‡Œäº‘ï¼Œå‚ä¸äº†é˜¿é‡Œäº‘ pangu çš„åˆ¶ä½œã€‚è¿™ç¯‡è®ºæ–‡ç»†èŠ‚æ¯”è¾ƒå¤šï¼Œè™½ç„¶ç½‘ä¸Šæœ‰å¾ˆå¤šçš„ä»‹ç»ææ–™ï¼Œä½†æˆ‘æ— è®ºå¦‚ä½•éƒ½çœ‹ä¸å¤ªæ‡‚ï¼Œæ‰€ä»¥çœ‹äº†ä¸€éåŸè®ºæ–‡ã€‚è¿™ç¯‡æ–‡ç« è¿˜æ˜¯ç›¸å½“ç¡¬æ ¸çš„ï¼Œå¾ˆè¯¦ç»†çš„æè¿°äº† Windows Azure Storage çš„å†…å®¹ï¼Œç®€å•ä»‹ç»ä¸€ä¸‹æœ¬æ–‡çš„äº®ç‚¹ï¼š</p><ol><li>åˆ†å±‚çš„ç³»ç»Ÿï¼šåˆ†å¸ƒå¼å—å­˜å‚¨å±‚ï¼ˆStreaming Layerï¼‰ï¼Œå‡ ä¹æ— çŠ¶æ€ Partition - æ•°æ®ç»“æ„å±‚ï¼ˆPartition Layerï¼‰ï¼Œæ— çŠ¶æ€çš„ Front End</li><li>Stream Layer: åœ¨ HDD å’Œ SSD Write Cache ä¸Šæä¾›ä¸€è‡´æ€§å’Œæ€§èƒ½ã€åå° EC èŠ‚çœæˆæœ¬ï¼ŒæŠ½è±¡äº†å¾ˆå¥½çš„ Block / Extent æ¨¡å‹ï¼Œåˆ†å¸ƒå¼ä¸€è‡´æ€§çš„è¯­ä¹‰ï¼ˆæ¯” GFS é‚£å¨ç­”è¾©å†™çš„å¥½å¾ˆå¤šï¼‰ã€‚ä¸€è‡´æ€§è¯­ä¹‰å¯ä»¥å…³æ³¨è¿™ä¸ªæ˜¯ä¸€ä¸ª append only çš„å—ï¼Œè€Œé k-v è¿™ç§å†…å®¹ï¼Œæ‰€ä»¥å¾ˆå¤šåœ°æ–¹å¯ä»¥ä¼˜åŒ–å¤„ç†ã€‚åŒæ—¶ï¼Œè¿™å—ä¹Ÿæ˜¯å¤šç§Ÿæˆ·çš„ï¼Œå› ä¸ºå¯¹å¤–æä¾›çš„æ˜¯å—å­˜å‚¨ï¼Œæ‰€ä»¥è¿™å—ç›¸å¯¹ä¸å¤æ‚ï¼Œä½†è®ºæ–‡æ²¡æœ‰æ·±å…¥è®¨è®ºç­–ç•¥æ˜¯æ€ä¹ˆåšçš„ã€‚</li><li>Partition Layer: ç›¸å½“äº Stream Layer ä¸Šçš„åº”ç”¨å±‚ï¼Œå’Œ Stream Layer ä¸€äº›æœåŠ¡åš co-locate éƒ¨ç½²ï¼Œåœ¨åˆ†å¸ƒå¼å—å­˜å‚¨ä¸ŠååŒç»´æŠ¤ä¸€è‡´æ€§ï¼ˆåªé  Stream Layer çš„è¯ï¼Œä¸€äº› corner case è¯­ä¹‰æ˜¯æ¨¡ç³Šçš„ï¼‰ï¼Œåœ¨ä¸Šé¢åˆ†åˆ«ç»´æŠ¤ wal å±‚å’Œæ•°æ®å±‚ï¼Œæ¥ä¿è¯æ€§èƒ½ã€‚åŒæ—¶ Partition Layer å¯¹å¤–æä¾›å„ç§æ•°æ®ç»“æ„ï¼ˆå¯ä»¥ç®€å•ç±»æ¯” Redisï¼‰ï¼ŒåŒæ—¶ï¼Œå®ƒä¹Ÿç”¨è¿™ä¸ªæŠ½è±¡æœåŠ¡å†…éƒ¨ï¼Œæ¥å®Œæˆå†…éƒ¨å…ƒä¿¡æ¯çš„å­˜å‚¨ã€‚æ­¤å¤– Partition Layer åº”è¯¥è¿˜ä¼šæ ¹æ®è´Ÿè½½åšä¸€äº› repartition, split, merge (è®ºæ–‡è®°ä½œ load balance)ã€‚è®ºæ–‡æ²¡æœ‰è®¨è®º admission control å’Œå¤šç§Ÿæˆ·çš„å®ç°ã€‚</li></ol><p>æ­¤å¤–ï¼Œå¯¹äºç”¨æˆ·è€Œè¨€ï¼Œç³»ç»Ÿæ˜¯ä¸Šå±‚çš„ Windows Azure Storageï¼Œç¼©å†™ä¸º WASã€‚WAS ä¼šæœ‰åœ°åŒºé—´çš„(geographic)å¼‚æ­¥ç¾å¤‡ã€ä¸»å’Œå¤‡ï¼Œåœ¨å•ä¸ªåœ°åŒºå†…ï¼Œå®ƒä¹Ÿæœ‰ stamp çš„æ¦‚å¿µï¼Œå»åšä¸€äº›å†…éƒ¨çš„ replicaã€‚</p><p>æ–‡ç« äº®ç‚¹è¿˜æ˜¯é è°±çš„æ¶æ„å’Œéå¸¸è¯¦ç»†çš„å†…å®¹ï¼ŒåŒ…æ‹¬ä¸€è‡´æ€§è¯­ä¹‰ä¹‹ç±»çš„ã€‚æˆ‘ä»¬éœ€è¦å…³æ³¨å®ç°ç«¯å’Œåº”ç”¨ç«¯æ˜¯æ€ä¹ˆå…±åŒå®ç°å—å­˜å‚¨è¯­ä¹‰çš„ã€‚ä¸Šå±‚çš„ WAS ä¼šæ¯”è¾ƒç®€å•çš„ç•¥è¿‡ã€‚</p><h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>WAS åœ¨è®ºæ–‡ä¸­å¯¹å¤–æä¾›äº†å‡ ç§ç»“æ„ï¼šBlob, Queue, Tablesã€‚è¿™å‡ ä¸ªç›¸å¯¹æ¥è¯´éƒ½æ˜¯å¾ˆé‡è¦çš„äº§å“ï¼Œå°±ä¸ä»‹ç»äº†ã€‚æŒ‰ç…§ ref ä¸­çš„æš—ç¤ºï¼Œæ„Ÿè§‰è¿™å‡ ä¸ªåŠŸèƒ½éƒ½æ˜¯ç»„ç»‡ä¸Šçš„è€ƒé‡ï¼Œæ„Ÿè§‰è¿™å‡ ç§è¿˜æ˜¯ã€Œè¢«ç»Ÿä¸€ã€åˆ°ä¸€èµ·çš„ï¼ˆæ¯”å¦‚ queue tables éƒ½å¯ä»¥ç”¨å¿«çš„è¯­ä¹‰æ¥å®ç°ï¼Œä½†æ˜¯ workload æœ‰ä¸€äº›å¾ˆç»†å¾®çš„å·®åˆ«ï¼Œä¸è¿‡éƒ½åšçš„å¾ˆå¥½ä¼°è®¡ä¹Ÿæ²¡å•¥å…³ç³») ã€‚å¤§å‚çœ‹ä¸Šå»æ€»æ˜¯ç—´è¿·ç»Ÿä¸€çš„æ¶æ„â€¦</p><p>WAS å£°ç§°æä¾›äº†å¼ºä¸€è‡´æ€§(Strong Consistency)ã€é«˜å¯ç”¨æ€§(HA)ã€åˆ†åŒºå®¹å¿(Partition tolerant)ï¼›åŒæ—¶ï¼Œå®ƒå¯¹å¤–æä¾›äº† global çš„ namespace (è¿™ä¸ªå¯ä»¥ç±»æ¯”é˜¿é‡Œäº‘æˆ–è€… aws ä¹° oss çš„ bucketã€è´¦å·é‚£ç§æ¦‚å¿µ)ï¼›æ­¤å¤–å®ƒè¿˜æœ‰å¤šåœ°ã€ä½†æœºæˆ¿çš„ç¾å¤‡ã€‚WAS è¿˜æä¾›äº†å¤šç§Ÿæˆ·ï¼Œå¯¹å¤–æä¾›äº†å­˜å‚¨æ± çš„æ¨¡å‹ã€‚</p><p>æ–‡ç« çš„é€»è¾‘é¡ºåºå¤§æ¦‚æ˜¯ï¼š</p><ul><li>WAS çš„ namespace æŠ½è±¡å’Œå®ç°</li><li>WAS çš„æ¶æ„åˆ†å±‚ï¼Œè¿™é‡Œä»‹ç»äº† WAS çš„ä¸‰å±‚æ¶æ„</li><li>å—å­˜å‚¨å±‚ Streaming Layer çš„å®ç°ï¼ŒåŒ…æ‹¬å•æœºå’Œ replicaã€ä¸€è‡´æ€§è¯­ä¹‰</li><li>Partition Layer çš„ä»‹ç»</li><li>å¹é€¼ç¯èŠ‚å’Œå†…éƒ¨ä½¿ç”¨</li><li>â€¦</li></ul><h2 id="Global-Partitioned-Namespace"><a href="#Global-Partitioned-Namespace" class="headerlink" title="Global Partitioned Namespace"></a>Global Partitioned Namespace</h2><p>åœ¨è¿™é‡Œï¼ŒWAS æŠŠå¯¹åº” namespace çš„å†…å®¹åšåˆ°äº† URL ä¸­:</p><p><img src="https://image.mwish.me/blog-image/745178C0-C27C-412C-85EE-347FC139C8CC.png" alt="745178C0-C27C-412C-85EE-347FC139C8CC"></p><p>ç„¶åï¼ŒWAS å¼•å…¥äº†ä¸€ä¸ª DNS ç³»ç»Ÿï¼Œæ¥åšå¯¹åº”çš„å¤„ç†ï¼š</p><p><img src="https://image.mwish.me/blog-image/34EEDFD9-8268-4050-B5D9-DA34474BBFEA.png" alt="34EEDFD9-8268-4050-B5D9-DA34474BBFEA"></p><p>è¿™ä¸ª URL å…¶å®éå¸¸å¥½ç†è§£ï¼š</p><ol><li>AccountName: ç”¨æˆ·æ·»åŠ /é€‰æ‹©çš„è´¦æˆ·(æˆ–è®¸åŒ…å«å­è´¦æˆ·)çš„åç§°, ä½œä¸º dns çš„ host name</li><li>PartitionName å…·ä½“å®šä½ Storage ä¸Šçš„æ•°æ®ï¼Œè¿™ä¸ª PartitionName æ„Ÿè§‰ç±»ä¼¼å­å¯¹è±¡</li><li>ObjectName ä¸ä¸€å®šæ‰€æœ‰çš„å†…å®¹éƒ½æœ‰ï¼Œå®ƒç”¨æ¥å®šä½ç¡®åˆ‡çš„ object. <strong>åœ¨åŒä¸€ä¸ª PartitionName ä¸‹çš„å¤šä¸ª Object å¯ä»¥å®Œæˆäº‹åŠ¡æ“ä½œ</strong></li></ol><p>å…·ä½“è€Œè¨€ï¼Œè¿™ä¸ªåªæ˜¯ä¸€ä¸ªæ¨¡å‹ç»„ç»‡ï¼Œä¸åŒæ•°æ®ç»“æ„ä¼šç”¨ä¸åŒçš„æ–¹å¼ä½¿ç”¨è¿™ä¸ªæ•°æ®ï¼Œå·²çŸ¥ä¸Šäº‘è‚¯å®šæœ‰ AccountName:</p><ol><li>BLOB æ²¡æœ‰ ObjectName, å¯¹åº”ä¸€ä¸ª PartitionName (<code>Blob: PartitionName</code>)</li><li>Table ä¸­çš„ä¸€ä¸ª PrimaryKey å¯¹åº”ä¸€ä¸ª PartitionName å’Œ ObjectNameï¼Œè¿™å…è®¸ Table æŠŠè¡¨ç»„ç»‡åˆ°ä¸åŒçš„ Partition ä¸‹ï¼ˆæ„Ÿè§‰è¦æ¶‰åŠåˆ†å¸ƒå¼äº‹åŠ¡äº† orzï¼‰ã€‚(<code>Table: &#123;Partitions: &#123;objects&#125;</code>)</li><li>Queue åç§°æ˜¯ PartitionName ï¼Œå¯¹åº”çš„æ¯ä¸ªå¯¹è±¡æœ‰ä¸€ä¸ª <code>ObjectName</code>: <code>&lt;PartitionName, [objectNames]&gt;</code></li></ol><h2 id="High-Level-Architecture"><a href="#High-Level-Architecture" class="headerlink" title="High Level Architecture"></a>High Level Architecture</h2><p>Windows Azure Storage çš„æœåŠ¡è¢«æ‰˜ç®¡ç»™ Windows Azure Fabric Controllerï¼Œè¿è¡Œåœ¨å„åœ°ï¼Œè¿™ä¸ªæ„Ÿè§‰ç±»ä¼¼ä¸€ä¸ªäº‘å¹³å°ï¼Œåšå®¹å™¨/èŠ‚ç‚¹çš„ç®¡æ§ã€‚WAS æœ¬èº«è´Ÿè´£å„ä¸ªå®¹å™¨/èŠ‚ç‚¹å†…æ•°æ®çš„ replication å’Œ data placementã€‚</p><p>å¦‚ä¸Šé¢çš„ Figure 1, WAS æœåŠ¡å™¨åŒ…å« Storage Stamp å’Œ Location Serviceã€‚</p><p>Storage Stamp æ˜¯ä¸€ä¸ªç‰©ç†ä¸€äº›çš„æ¦‚å¿µï¼Œæ„Ÿè§‰åƒæ˜¯éƒ¨ç½²åœ¨ä¸€èµ·çš„ä¸€ç»„é«˜å¯†å­˜å‚¨æœºå™¨ç»„æˆçš„å®¹é”™çš„é›†ç¾¤ï¼Œæ‹¥æœ‰ä¸€ä¸ªè™šæ‹Ÿ ip (VIP)ï¼Œæˆ‘ä»¬æ‘˜å½•ä¸€ä¸‹è¯¦ç»†çš„å®šä¹‰ï¼š</p><blockquote><p>Storage Stamps â€“ A storage stamp is a cluster of N racks of storage nodes, where each rack is built out as a separate fault domain with redundant networking and power. Clusters typically range from 10 to 20 racks with 18 disk-heavy storage nodes per rack. Our first generation storage stamps hold approximately 2PB of raw storage each. Our next generation stamps hold up to 30PB of raw storage each.</p></blockquote><p>åŒæ—¶ï¼ŒStorage Stamp ä¼šå¸Œæœ›å¤šç§Ÿæˆ·æ¥ä¿è¯å ç”¨ï¼Œç³»ç»Ÿä¼šä¿è¯ 70% å·¦å³çš„å®¹é‡ / äº‹åŠ¡(tps?) / å¸¦å®½åˆ©ç”¨ç‡ã€‚Storage Stamp ä¼šå°½é‡é¿å…ç£ç›˜å ç”¨è¾¾åˆ° 80% ä»¥ä¸Šï¼Œæ¥é¿å…ä¸€äº›çªå‘çš„é”™è¯¯å¯¼è‡´ stamp å†…å®¹é‡ä¸è¶³ï¼ŒåŒæ—¶ï¼Œå› ä¸ºå½“æ—¶ç¡¬ä»¶å¤§å¤šæ˜¯ HDDï¼ŒHDD å¤–é“æ¯”å†…é“å¿«ï¼ˆåˆ†è¿‡ç¡¬ç›˜æ‡‚çš„éƒ½æ‡‚ï¼‰ï¼Œæ‰€ä»¥ å®ƒä¹Ÿæ›´å¸Œæœ›ç”¨å¤–é“ä¸Šçš„ç©ºé—´ã€‚å½“å•ä¸ª Storage Stamp èµ„æºåˆ©ç”¨ç‡è¶…è¿‡ 70%ï¼Œè¿™é‡Œå¯èƒ½ä¼šå°è¯•åœ¨ Partition Layer åšä¸€äº›è°ƒåº¦ã€‚</p><p>Location Service (LS) æ˜¯ä¸€ä¸ªå…ƒä¿¡æ¯æˆ–è€… Catalog æ€§è´¨çš„ç³»ç»Ÿï¼Œå®ƒä¼šå­˜æ”¾åŒºåŸŸçš„ account namespaceï¼ŒåŒæ—¶ç®¡ç†å„ä¸ª Storage Stamp çš„é›†ç¾¤ä¿¡æ¯ã€‚ç±»ä¼¼ BigTableï¼ŒLS è‡ªå·±ä¼šæŠŠæ•°æ®è½åœ¨ Storage Stamp ä¸Šï¼Œç„¶åä¹Ÿæœ‰å¤‡ä»½å’Œæ¢å¤çš„æµç¨‹ã€‚</p><p>LS ä¼šçŸ¥é“æœ‰å“ªäº›åœ°åŒºå“ªäº›æœºæˆ¿ï¼Œç„¶åä¼š track ä¸€ä¸‹å¯¹åº”æœºæˆ¿çš„æƒ…å†µå’Œå­˜å‚¨å ç”¨ã€‚å½“ä¸€ä¸ªæ–°çš„åˆ›å»ºè´¦æˆ·è¯·æ±‚è¿‡æ¥çš„æ—¶å€™ï¼Œå®ƒéœ€è¦æŒ‡å®š location affinityï¼ˆç”¨æˆ·åœ¨ä»€ä¹ˆåœ°æ–¹ç”¨ï¼‰ï¼ŒLS ä¼šæ ¹æ®è¿™ä¸ªè¯·æ±‚çš„ location affinityï¼Œæ¥é¢„æµ‹å¹¶å†³å®šè¿™ä¸ªèµ„æºçš„ primary storage stampã€‚å®ƒä¼šåœ¨è¿™ä¸ª stamp è®°å½•å…ƒä¿¡æ¯ï¼Œç„¶åæ›´æ–° DNS è·¯ç”±ï¼ŒæŠŠèµ„æº url çš„ domain æŒ‡å‘ storage stamp çš„ VIPã€‚</p><h3 id="Storage-Stamp-å†…çš„ä¸‰å±‚æ¶æ„"><a href="#Storage-Stamp-å†…çš„ä¸‰å±‚æ¶æ„" class="headerlink" title="Storage Stamp å†…çš„ä¸‰å±‚æ¶æ„"></a>Storage Stamp å†…çš„ä¸‰å±‚æ¶æ„</h3><p>è¿™é‡Œè‡ªåº•å‘ä¸Šçš„ä»‹ç» Storage Stamp çš„ä¸‰å±‚æ¶æ„ï¼š</p><ol><li><p>Stream Layer: Storage Stamp å†…çš„åˆ†å¸ƒå¼å—å­˜å‚¨. å®ƒæœ‰å‡ ä¸ªæ¦‚å¿µ</p><ol><li>Stream:ä¸€ä¸ªå¤§çš„å¯ä»¥ append çš„ bit stream</li><li>Extents: ä¸å›ºå®šå¤§å°çš„ Chunk (å¯ä»¥å¯¹æ¯” GFS Chunk)</li></ol></li><li><p>Partition Layer: è¿™é‡Œæœºå™¨å¯èƒ½å’Œ Stream Layer åš co-locate éƒ¨ç½²ï¼Œå®ƒæä¾›äº†</p><ol><li>å•æœº<ol><li>Blob, Table, Queue çš„è¯­ä¹‰ç®¡ç†</li><li>å’Œä¸Šå±‚çš„ dns ååŒå¤„ç† PartitionName ç­‰é€»è¾‘ï¼Œæ¯•ç«Ÿ dns åªä¼š resolve host</li><li>Transaction Ordering / Strong Consistencyï¼Œéƒ¨åˆ†å’Œ Stream Layer åç»Ÿç®¡ç†ï¼Œéƒ¨åˆ†è‡ªå·±ç®¡ç†</li><li>Storing/Caching å„ç§æ•°æ®</li></ol></li><li>åˆ†å¸ƒå¼: ç±»ä¼¼ TiKV HBaseï¼Œå¯¹æ•°æ®æŒ‰ç…§ PartitionName è¿›è¡Œ Range Partitionï¼Œå¹¶åšäº†å¯èƒ½çš„ Merge / Split ç­‰ç®¡ç†</li></ol></li><li>Front-End Layer: ç”± stateless çš„æœåŠ¡å™¨ç»„æˆï¼Œæ¥å—è¯·æ±‚ï¼Œç„¶åæŠŠè¯·æ±‚è·¯ç”±åˆ° Partition Layer çš„æœåŠ¡å™¨ã€‚ç³»ç»Ÿä¼šæœ‰ä¸€ä¸ª Partition Map æ¥ç»´æŠ¤ç›¸å…³çš„ Partition çš„æ˜ å°„åŒºé—´ã€‚FE ä¼šç¼“å­˜è¿™ä¸ª mapï¼Œç„¶åè½¬å‘è¯·æ±‚ã€‚æ„Ÿè§‰è¿™ä¸ªæŸç§ç¨‹åº¦ä¸Šç›¸å½“äºä¸€ä¸ªå†…éƒ¨ Proxy æˆ–è€…å®¢æˆ·ç«¯</li></ol><h3 id="Two-Replication-Engines"><a href="#Two-Replication-Engines" class="headerlink" title="Two Replication Engines"></a>Two Replication Engines</h3><ul><li>Stream Layer ä¼šåš stamp å†…éƒ¨çš„ <strong>åŒæ­¥å¤åˆ¶</strong>ï¼Œæ¥ä¿è¯ stamp å†…çš„æ•°æ®å®‰å…¨ã€‚è¿™ä¸ªä¼šåœ¨ critical path ä¸Šè¿›è¡Œï¼Œéœ€è¦ç­‰å¾…å¤åˆ¶å®Œæˆæ‰èƒ½è¿”å›ç”¨æˆ· successã€‚å®ƒå…³æ³¨çš„æ˜¯å¤åˆ¶çš„ bitsã€‚å› ä¸ºè¿™ä¸ªåœ¨ä¸»é“¾è·¯ä¸Šï¼Œå®ƒçš„ä¸»è¦ä¼˜åŒ–ç‚¹åœ¨ latency ä¸Šã€‚</li><li>Partition Layer ä¼šåš stamp å’Œ stamp çš„å¤åˆ¶ã€‚å®ƒä¼šåœ¨ä¸»é“¾è·¯ä¹‹å¤–<strong>å¼‚æ­¥å¤åˆ¶</strong>ç»™åˆ«çš„æœºå™¨ã€‚å®ƒå…³æ³¨ Transaction ä¹‹ç±»çš„è¯­ä¹‰ï¼Œå’Œ Objectsï¼Œä½†å¯èƒ½ä¸å¤ªå…³æ³¨å…·ä½“ layoutã€‚ç›¸å¯¹äº Stream Layerï¼Œå®ƒæä¾›çš„æ˜¯æœºæˆ¿çš„å¯é å®¹ç¾ã€‚å› ä¸ºè¿™ä¸ªä¸åœ¨ä¸»é“¾è·¯ä¸Šï¼Œä½†å¯èƒ½æ•°æ®é‡æ¯”è¾ƒå¤§ï¼Œä¼˜åŒ–ç‚¹åˆ™åœ¨ bandwidth ä¸Šã€‚</li></ul><p>è¿™é‡Œè¿˜æœ‰ä¸ªåˆ«çš„é—®é¢˜æ˜¯ï¼Œä¸¤ä¸ª layer ä¹‹é—´ç®¡ç†çš„å¯¹è±¡ä¸åŒï¼ˆç”¨è®ºæ–‡çš„è¯è¯´å°±æ˜¯ namespace ä¸åŒï¼‰åœ¨ stamp å†…å¤åˆ¶çš„æ—¶å€™ï¼Œè¿™é‡Œéœ€è¦ç®¡ç†çš„ä¿¡æ¯éƒ½åœ¨åŒä¸€ä¸ª storage stamp å†…éƒ¨ï¼Œå…ƒä¿¡æ¯å¤§å°ç›¸å¯¹å¯æ§ï¼Œå¯ä»¥ cache åœ¨å†…å­˜ä¸­ã€‚</p><p>ä½œä¸ºå¯¹æ¯”ï¼ŒPartition Layer å…ƒä¿¡æ¯å…¶å®æ˜¯ä¾èµ–ä¸Šå±‚çš„ï¼Œè¿™ä¼¼ä¹å¹¶ä¸åœ¨æ„ä½ æ€ä¹ˆåˆ†ç‰‡è·¯ç”±çš„ï¼Œåªåœ¨äº global object namespace ç®¡ç†çš„å…¶ä½™ replicaï¼Œç„¶åæŠŠå¯¹åº”ä¿¡æ¯ï¼ˆæˆ‘çŒœç±»ä¼¼ binlogï¼‰ä¸¢è¿‡å»ã€‚</p><h2 id="Stream-Layer"><a href="#Stream-Layer" class="headerlink" title="Stream Layer"></a>Stream Layer</h2><p>åœ¨ä»‹ç» Stream Layer ä¹‹å‰ï¼Œæˆ‘ä»¬å¯ä»¥ç®€çŸ­å›é¡¾ä¸€ä¸‹ GFS çš„ consistency:</p><ol><li>å®¢æˆ·ç«¯ç»™ primary å‘è¯·æ±‚ï¼Œè¯·æ±‚ä»¥ chain replica çš„å½¢å¼å¤åˆ¶</li><li>æ•°æ®ä»¥ Chunk çš„å•å…ƒå­˜å‚¨ï¼ŒChunk å¤§å°å¤§æ¦‚æ˜¯ 64MB æˆ–è€…æ•°å€ï¼Œmeta åœ¨ master ä½œä¸ºå†…å­˜ä¸­çš„ä¸€æ£µæ ‘</li><li>å¦‚æœå­˜åœ¨å¹¶å‘ï¼Œé‚£ä¹ˆå¯èƒ½éœ€è¦é‡è¯•ï¼Œå¯ä»¥ä¿è¯ï¼Œå†™å…¥æˆåŠŸçš„æ—¶å€™ï¼Œåç§»é‡åœ¨æ‰€æœ‰å‰¯æœ¬ä¸Šéƒ½æ˜¯ä¸€æ ·çš„</li></ol><p>WAS Stream Layer æä¾›äº†æ›´åŠ æ¸…æ™°çš„å®šä¹‰å’ŒæŠ½è±¡ï¼Œåœ¨å•æœºå­˜å‚¨ä¸Šï¼Œå¼•å…¥äº† Block - Extent - Stream è¿™ä¸€ä¸ªå¤šçº§åˆ«çš„ç»“æ„æ¦‚å¿µã€‚åˆ†å¸ƒå¼å­˜å‚¨ä¸Šï¼Œå¼•å…¥äº†æ›´åŠ è¯¦ç»†çš„æè¿°è¯­ä¹‰ã€‚</p><p><img src="https://image.mwish.me/blog-image/33E6F3A9-02C5-46BD-ABC7-346D10ADE99E.png" alt="33E6F3A9-02C5-46BD-ABC7-346D10ADE99E"></p><ul><li>Block æ˜¯ç”¨æˆ· Append å’Œè¯»å–çš„åŸºæœ¬å•å…ƒï¼Œç”¨æˆ·å¯ä»¥ append ä¸€ä¸ªæˆ–è€…å¤šä¸ª Blockï¼ŒBlock ä¹Ÿä¸éœ€è¦æœ‰å›ºå®šå¤§å°ï¼ŒBlock ä¼šè¢« checksumã€‚è¯»å–çš„æ—¶å€™ï¼Œä¹Ÿéœ€è¦åš checksum validation (è¿™é‡Œä¼¼ä¹æ˜¯å‰å°è¯»å–çš„æ—¶å€™åšçš„)ã€‚åŒæ—¶ï¼Œé™¤äº†å‰å°éªŒè¯ï¼Œè¿™é‡Œä¹Ÿä¼šæœ‰ä¸€ä¸ªå¤©çº§çš„åå°çº¿ç¨‹åš validationã€‚</li><li>Extent åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ª Blockï¼ŒExtent çš„å¤§å°ä¸å›ºå®šï¼Œå®ƒåªæœ‰ä¸€ä¸ª appendable çš„ Extent (Unsealed)ï¼Œå…¶ä½™éƒ½æ˜¯ Sealed çš„ï¼Œé‡Œé¢çš„ <strong>é€»è¾‘çš„ bits å†…å®¹</strong> æ˜¯ä¸å¯æ›´æ”¹çš„ã€‚Extent æ˜¯ Stream Layer å¤åˆ¶çš„åŸºæœ¬å•å…ƒã€‚åœ¨è®ºæ–‡å‘è¡¨çš„æ—¶å€™ï¼Œextent ä¼šè¢«å­˜å‚¨åœ¨ä¸€ä¸ª NTFS æ–‡ä»¶ä¸Šï¼Œï¼ˆè¿™ä¸ªå¯èƒ½æ˜¯å› ä¸ºå®ç°å®Œæˆåº¦é—®é¢˜ï¼Ÿå› ä¸ºæ„Ÿè§‰ fs è‡ªå·±ä¹Ÿä¼šå†™ logï¼ŒåŸºæœ¬ log-on-log äº†â€¦ï¼‰ã€‚<ul><li>ä¸Šå±‚ä½¿ç”¨çš„æ—¶å€™ï¼ŒPartition Layer ä¼šå®šä¸€ä¸ª 1GB å·¦å³çš„ Target Extent sizeï¼Œç„¶åå¯èƒ½ä¼š batch å¤šä¸ªå°å¯¹è±¡çš„å†™åˆ°åŒä¸€ä¸ª Block ä¸­ append è¿‡æ¥ã€‚å¦‚æœè¦å†™ä¸€ä¸ªå¾ˆå¤§çš„å¯¹è±¡ï¼Œå¯èƒ½ä¼šæ‹†åˆ†æˆå¾ˆå¤šä¸­ç­‰å¤§å°çš„ï¼ˆGBï¼‰çš„ Block å»å†™ã€‚</li></ul></li><li>Stream æ˜¯ Stream Layer å¯¹ä¸Šå±‚æä¾›çš„æŠ½è±¡ï¼Œå®ƒæœ¬èº«æ˜¯æŒ‡å‘å¤šä¸ª Extent çš„æŒ‡é’ˆ <code>[Pointer-to-Extents]</code>ï¼Œè¿™ä¸ªçŠ¶æ€ç”± Stream Master ç®¡ç†ã€‚è¿™ä¸ªæŠ½è±¡æœ‰ç‚¹ç±»ä¼¼ fpï¼Œå› ä¸º Extent æ˜¯ä¸å¯ä¿®æ”¹çš„ï¼ŒStream å¯ä»¥ç­‰äº Stream + Append Operationsã€‚åªæœ‰æœ€åä¸€ä¸ª Extent æ˜¯å¯å†™çš„</li></ul><h3 id="Stream-Manager-and-Extent-Nodes"><a href="#Stream-Manager-and-Extent-Nodes" class="headerlink" title="Stream Manager and Extent Nodes"></a>Stream Manager and Extent Nodes</h3><p><img src="https://image.mwish.me/blog-image/BBC19237-042E-4534-B1B9-D29495FE4C70.png" alt="BBC19237-042E-4534-B1B9-D29495FE4C70"></p><p>Stream Manager (SM) ç®¡ç† Extent çš„æŠ½è±¡ï¼Œè€Œç›¸å¯¹è€Œè¨€ï¼Œæ•°æ®å­˜å‚¨åœ¨ Extent Node( EN ) ä¸Šã€‚ç±»ä¼¼ Chubbyï¼Œå®ƒæ˜¯ä¸€ä¸ª Paxos é›†ç¾¤ï¼Œå› ä¸ºå…ƒæ•°æ®æ•°é‡ç›¸å¯¹å¯æ§ï¼ˆé—®é¢˜ï¼šå¦‚æœæœ‰å¾ˆå¤šå¾ˆå°çš„ Extent æ„Ÿè§‰è¿™ä¸ªä¼šç–¯ç‹‚åŠ£åŒ–ï¼Œä¸è¿‡åº”è¯¥ä¸æ˜¯å¸¸è§åœºæ™¯ï¼‰ã€‚SM è´Ÿè´£åšçš„äº‹æƒ…ç›¸å½“äºç®¡æ§çš„ master:</p><ol><li>è´Ÿè´£å“åº” client çš„ create extent è¯·æ±‚ï¼ŒæŒ‘é€‰å¯¹åº”çš„ä¸»å¤‡æœºå™¨ï¼Œç„¶ååˆ›å»º Extent</li><li>ç»´æŠ¤ Stream - Extent çš„æ˜ å°„å’ŒçŠ¶æ€</li><li>ç›‘æ§ EN çš„çŠ¶æ€</li><li>(3) ä¸­ EN çŠ¶æ€å‡ºé—®é¢˜ï¼Œæˆ–è€…å‡ºç° corrupt ç­‰æƒ…å†µçš„æ—¶å€™ï¼Œå»æ‹‰èµ·å¤‡ç„¶åä¿®å¤æ•°æ®ï¼Œç»´æŠ¤å¤šå‰¯æœ¬</li><li>GC æ‰æ²¡æœ‰è¢« reference çš„ Extent</li><li>åšä¸€äº›åå°æ“ä½œï¼ŒæŠŠ Sealed Extent ç»™ EC ä¼˜åŒ–ï¼ˆç°åœ¨åº”è¯¥æœ‰å¾ˆå¤šä¸éœ€è¦è¿™æ ·ï¼Œåœ¨å‰å°å†™çš„æ—¶å€™ç›´æ¥ ECï¼‰</li></ol><p>è®ºæ–‡é‡Œæåˆ°äº†å‡ ä¸ªç‚¹ï¼š</p><ul><li>SM ä¼šå‘¨æœŸæ€§æ‹‰ EN çš„æ•°æ®ï¼Œç„¶åæ¥æ£€æŸ¥æ˜¯å¦ä¸€è‡´</li><li>å¯¹äº Extent çš„ Replacement ç­–ç•¥ï¼Œè¿™é‡Œ SM æŒ‘é€‰ EN æ˜¯ randomly çš„ï¼Œä½†ä¸ä¼šæŒ‘é€‰åœ¨åŒä¸€ä¸ª fault domains ä¸­ï¼Œä¸çŸ¥é“ä¸ºå•¥é€‰ random</li></ul><p>SM åªç®¡ç† Extentï¼Œä¸ç®¡ç† blockï¼ˆå®é™…ä¸Š SM ä¸å» aware block ä¿¡æ¯ï¼‰ï¼Œç”¨æˆ· append çš„æ—¶å€™ï¼Œè¿™é‡Œä¸€èˆ¬ä¸ä¼šè·Ÿ SM æ‰“äº¤é“ï¼Œç›´æ¥èµ°æœ€åä¸€ä¸ª Extent å» appendï¼Œæ‰€ä»¥ç»å¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼ŒSM ä¸ä¼š block critical pathã€‚</p><p>ä¸‹é¢è®ºæ–‡æä¾›äº†ä¸€ä¸ª SM ç®¡ç†å…ƒæ•°æ®çš„ç®€å•è®¡ç®—ï¼Œè¿™é‡Œä½¿ç”¨äº† 32GB å†…å­˜çš„èŠ‚ç‚¹ï¼Œç„¶å SM æ‰“äº¤é“çš„ client åªä¼šæœ‰ Partition Layerï¼Œåœ¨è®ºæ–‡ä¼°ç®—ä¸­ï¼ŒStream ä¸ä¼šå¤šäº 100K ä¸ªï¼ŒExtent ä¸ä¼šå¤§äº 50M ä¸ªï¼Œæ‰€ä»¥æ€»å†…å­˜å¯ä»¥é™åˆ¶åœ¨ 32GB å†…ã€‚</p><p>EN åˆ™ä¸çŸ¥é“ Stream çš„æ¦‚å¿µï¼Œå®ƒä¼šçŸ¥é“ SM assign ç»™å®ƒçš„ primary / backup çš„ topologyï¼Œ</p><ul><li>å•ä¸ª Extent å­˜å‚¨ä¸Šï¼ŒExtent ä¼šè¢«å­˜å‚¨æˆä¸€ä¸ªæ–‡ä»¶ï¼Œæ¯ä¸ª block ä¼šæœ‰ checksumï¼Œç„¶åè¿˜ä¼šæœ‰ä¸€ä¸ª Block Indexï¼Œæ¥æ˜ å°„ Block çš„ä½ç½® (æˆ‘çŒœç±»ä¼¼ LevelDB?).</li><li>åœ¨ ENæœåŠ¡å™¨ä¸­ï¼ŒæœåŠ¡å™¨ä¼šæœ‰ä¸ªè‡ªå·±ç®¡ç†çš„ Extent åˆ—è¡¨ï¼Œæ¯ä¸ªåˆ—è¡¨åŒ…å«å¯¹åº”çš„ Peers.</li></ul><h3 id="Append-Operation-and-Sealed-Extents"><a href="#Append-Operation-and-Sealed-Extents" class="headerlink" title="Append Operation and Sealed Extents"></a>Append Operation and Sealed Extents</h3><p>é¦–å…ˆæˆ‘æ„Ÿè§‰ä¸€èˆ¬è¦æ˜ç¡®ä¸€ç‚¹ï¼Œæˆ‘ä¸ªäººæ„Ÿè§‰æ¯”è¾ƒåˆé€‚å¤šè§çš„å—å­˜å‚¨åœºæ™¯éƒ½æ˜¯å•å†™è€…ï¼Œç„¶åæœ‰ä¸€ä¸ªåˆ†å¸ƒå¼é” / epoch ä¹‹ç±»çš„é€»è¾‘æ¥ä¿è¯åªæœ‰å•ä¸ª writerï¼Œæœ‰çš„å—å­˜å‚¨ä¹Ÿä¼šåœ¨æœåŠ¡å†…ç½®ä¸€å¥— cas æˆ–è€… leader æœºåˆ¶ï¼Œç„¶åæ–¹ä¾¿ç”¨æˆ·ä¿è¯ Single Writerã€‚è¿™é‡Œå¯ä»¥å‚è€ƒ <a href="https://github.com/opencurve/curve/blob/master/docs/cn/CurveFS%E6%94%AF%E6%8C%81%E5%A4%9A%E6%8C%82%E8%BD%BD.pdf">Curve çš„è°ƒç ”æ–‡æ¡£</a> , è¿™é‡Œå¯¹å¤šæŒ‚è½½å’Œ leader åšäº†ä¸€äº›æ¦‚è¿°ï¼Œåº”è¯¥æ¯”è¾ƒæ¥è¿‘å·¥ä¸šç•Œçš„æƒ…å†µã€‚</p><p>å›åˆ° WAS Stream Layerï¼Œè¿™é‡Œ append ä¼šä¿è¯ï¼š</p><ul><li><p>å•ä¸ª appendï¼Œå³ä½¿æ˜¯å¤šä¸ª block çš„ appendï¼Œä¹Ÿæ˜¯ atomic çš„ã€‚</p></li><li><p>å¦‚æœå‡ºç°é”™è¯¯ï¼Œå®¢æˆ·ç«¯å¯èƒ½éœ€è¦ Seal Extent (æ„Ÿè§‰ç°åœ¨å¾ˆå¤š Truncate + Seal) ç„¶åæ¥ç€å†™ï¼Œæˆ–è€…ç›´æ¥é‡è¯•ã€‚å‘è®ºæ–‡çš„æ—¶å€™ WAS Stream Layer åº”è¯¥æ˜¯æ²¡æœ‰ Truncate + Seal è¯­ä¹‰çš„ï¼Œæ‰€ä»¥å¦‚æœè¦é‡è¯•ï¼Œå¯èƒ½ä¼šå’Œ GFS ä¸€æ ·ï¼Œéœ€è¦å¤„ç†é‡å¤è®°å½•</p><ul><li>å¯¹ Metadata æˆ–è€… Commit Logï¼Œè¿™ä¸ªä¼šåœ¨ Partition Layer æ ¹æ® LSN ä¹‹ç±»çš„ä¸œè¥¿å»é‡</li><li>å¯¹ row data æˆ–è€… blob, åªæœ‰æœ€åä¸€ä¸ªæˆåŠŸçš„å†™ä¼šè¢«ä¸Šå±‚ refï¼Œç©ºç™½çš„å†…å®¹ç­‰å¾… GCï¼ˆè¿™ä¸ªåœ°æ–¹è¿˜æ˜¯æœ‰ç‚¹å¥‡æ€ªçš„ï¼Œå› ä¸ºå¦‚æœæ²¡ Seal Extent çš„è¯ï¼Œæœ‰çš„å†…å®¹è¿˜åœ¨åŒä¸€ä¸ª Extent é‡Œé¢ï¼Œè¿™ä¸ªæ„Ÿè§‰å¾—æš—ç¤ºæœ‰ WiscKey ä¹‹ç±»çš„ GC æœºåˆ¶äº†ï¼Œæˆ–è€…å•çº¯å°±ç•™åœ¨é‚£ï¼Œç­‰å¾…æ•´ä¸ª Extent æ²¡æœ‰è¢« Ref äº†ï¼‰</li></ul></li><li><p>Extent åˆ°è¾¾ä¸€å®šå¤§å°æˆ–è€…ä¸»åŠ¨ Seal åï¼Œé‡Œé¢é€»è¾‘å†…å®¹ä¸èƒ½æ”¹ï¼Œä½†æ˜¯å®é™…å†…å®¹å¯ä»¥è¢« EC æ¡å¸¦åŒ–ä¹‹ç±»çš„æ–¹å¼ä¼˜åŒ–</p></li></ul><h3 id="Stream-Layer-Intra-Stamp-Replication"><a href="#Stream-Layer-Intra-Stamp-Replication" class="headerlink" title="Stream Layer Intra-Stamp Replication"></a>Stream Layer Intra-Stamp Replication</h3><p>Stream Layer å’Œ Partition Layer éœ€è¦åä½œï¼Œæ¥ä¿è¯é è°±çš„ replicationã€‚Stream Layer æä¾›äº†å¦‚ä¸‹ä¿è¯ï¼š</p><ul><li>record è¿”å›æˆåŠŸä¹‹åï¼Œåç»­çš„è¯»ä¸€å®šå¯ä»¥è¯»åˆ°è¿™æ¡è®°å½•ï¼Œå¯¹åº”çš„è®°å½•æ˜¯ immutable çš„(æ„Ÿè§‰å¦‚æœæ”¯æŒ truncate, è¿™ä¸ªè¯­ä¹‰ä¹Ÿä¼šå˜å¾—ç•¥å¾®æœ‰ç‚¹å¥‡æ€ª, åªèƒ½è¯´ä¸Šå±‚å¯ä»¥çº¦æŸéœ€è¦ truncate çš„æ•°æ®æ˜¯æœªå†³çš„ï¼Œä¸ä¼šè¢«è¯»å–)</li><li>ä» sealed extent è¯»ï¼Œæ°¸è¿œä¼šè¯»åˆ°ç›¸åŒçš„å†…å®¹</li></ul><p>è¿™ä¸ªåœ°æ–¹ replication æ˜¯ä¸ºäº†å¤„ç†è½¯ä»¶é”™è¯¯æˆ–è€…å„ç§é”™è¯¯ï¼š</p><blockquote><p>We consider faults ranging from disk and node errors to power failures, network issues, bit-flip and random hardware failures, as well as software bugs. These faults can cause data corruption; checksums are used to detect such corruption.</p></blockquote><p>ï¼ˆå“ï¼Œçªç„¶æƒ³èµ·åœ¨å‰å¸ç¢°åˆ°çš„å‚»é€¼äº‹æƒ…ï¼Œé›†ç¾¤è½¯ä»¶ bug æŠŠæ‰€æœ‰å‰¯æœ¬å†™å…¥äº† bug æ•°æ®ğŸ˜…å—å­˜å‚¨è¿™å—è¿˜æ˜¯è¦éå¸¸å°å¿ƒå†™ä»£ç çš„â€¦ï¼‰</p><h4 id="Replication-Flow"><a href="#Replication-Flow" class="headerlink" title="Replication Flow"></a>Replication Flow</h4><p>è¿™é‡Œä¼šä»¥ chain-replica æˆ–è€…æ˜Ÿå‹çš„å½¢å¼å†™å…¥ï¼Œpeers åœ¨ Extent è¿˜æ´»è·ƒçš„æ—¶å€™ä¸ä¼šå˜æ›´ï¼Œclient ä¼šç¼“å­˜ active extentï¼Œç„¶åç›´æ¥å†™ primaryï¼Œè¿™é‡Œå¿…é¡»å†™ Primaryï¼Œä½†æ˜¯å¯ä»¥ä» replica è¯»ã€‚è¿™ä¸ªåœ°æ–¹æœ‰ä¸ªåœ°æ–¹ï¼Œæ„Ÿè§‰æ˜¯è¯´éœ€è¦ä¿è¯ uncommitted çš„æ•°æ®æ²¡å•¥è¯»è€…ï¼Œå› ä¸ºè¿™ä¸ªå†…å®¹æ˜¯ appendable byte streamï¼Œæ‰€ä»¥æ¯” kv å¥½ä¿è¯è¿™äº›ã€‚</p><p>å†™å…¥çš„æ—¶å€™ï¼Œå› ä¸ºéƒ½è¦èµ° primaryï¼Œæ‰€ä»¥éœ€è¦ primary åšä¸€äº›å†™ç›¸å…³çš„å†³ç­–ï¼š</p><ol><li>åœ¨æœ¬ Extent ä¸­ï¼Œè¯·æ±‚çš„ append å¯¹åº”çš„ offset</li><li>å¤šä¸ªå®¢æˆ·ç«¯å¹¶å‘ append çš„æ—¶å€™ï¼Œè¿™äº› append çš„ ordering (æˆ‘æ„Ÿè§‰æœ¬è´¨å’Œ 1 æ˜¯ä¸€ä¸ªé—®é¢˜)</li><li>åœ¨æ‰€æœ‰ secondary éƒ½ä¿è¯æˆåŠŸçš„æ—¶å€™ï¼Œæ‰è¿”å› success<ol><li>åŒæ—¶ï¼Œå› ä¸ºæœ‰ (2) çš„çº¦æŸï¼Œè¿™é‡Œä¼šæŒ‰åº ack ï¼ˆçœ‹ç€å„å°æœºå™¨ä¹Ÿæ˜¯æŒ‰åº append + ack çš„ï¼‰ã€‚æœ€åæˆåŠŸ append çš„ä½ç½®ä¼šæ˜¯è¿™ä¸ª replica çš„ <strong>commit length</strong> ï¼Œæ ¹æ®ç®€å•æ¨ç†å¯ä»¥çŸ¥é“ï¼Œè¿™ä¸ª commit length å¯èƒ½æ¯” client ack å¤§ï¼Œæ‰€ä»¥ä¼šæœ‰ corner case å¤„ç†</li></ol></li></ol><p>client å‘ç°é”™è¯¯çš„æ—¶å€™ï¼Œéœ€è¦ä»¥æœ€å°çš„ commit length å» sealï¼Œç„¶å allocate æ–°çš„ extentï¼Œè®ºæ–‡è¯´è¿™ä¸ªå¹³å‡æ—¶é—´ä¼šæœ‰ä¸ª 20msï¼ˆä¸çŸ¥é“ç³»ç»Ÿè‡ªå·±èƒ½ä¸èƒ½æœ‰ä¸ª double buffer?ï¼‰ã€‚è¢« Seal çš„ Extent å¦‚æœå‘ç°åå°æ‰å¤‡ä»½äº†ï¼ŒSM ä¼šå¸®å®ƒæ‹‰èµ·é è°±çš„ replicaï¼Œå¦‚å‰æ–‡æ‰€è¿°ã€‚</p><p>ï¼ˆä¸ç¦ç¿»äº†ä¸€ç¯‡è‡ªå·±ä¸¤å¹´å‰å†™çš„ blog: <a href="https://blog.mwish.me/2020/08/06/notes-on-craq/">https://blog.mwish.me/2020/08/06/notes-on-craq/</a> ï¼Œæ—¶é—´è¿‡å¾—çœŸå¿«å•Šï¼‰</p><h4 id="Sealing"><a href="#Sealing" class="headerlink" title="Sealing"></a>Sealing</h4><p>SM ä¼šåœ¨ Partition å¸®åŠ©ä¸‹å»åš Sealingï¼Œè¿™é‡Œä¼šæœ‰å¯èƒ½æœ‰ä¸‰æœºå™¨ commit length ä¸ä¸€è‡´çš„æƒ…å†µï¼ˆè®ºæ–‡æåˆ°ä¼šæœ‰ä¸¤å°æœºå™¨æˆ–è€…æœ‰ç›¸åŒçš„ commit lengthï¼Œæˆ‘æ„Ÿè§‰è¿™ä¸ªæš—ç¤ºäº†ç›¸å…³çš„å¤åˆ¶æµç¨‹ï¼Œä¸è¿‡æˆ‘è§‰å¾—è¿™ä¸ªå…·ä½“å†™ä»£ç è¿˜æ˜¯å¾ˆå®¹æ˜“ä¸‰ä¸ªä¸ä¸€è‡´çš„ï¼‰ã€‚æˆ‘ä¸ªäººè§‰å¾—ä¸€ä¸ªæ¯”è¾ƒç†æƒ³çš„çŠ¶æ€æ˜¯ client-side é€‰å‡ºä¸€ä¸ªçŠ¶æ€ï¼Œå½“ç„¶ï¼Œclient ä¹Ÿæœ‰æŒ‚æ‰çš„æ—¶å€™ï¼Œå›åˆ°è®ºæ–‡ä¸­ï¼Œè®ºæ–‡è¿™é‡Œé€‰æ‹©æ–¹å¼å¯ä»¥çœ‹ä¸‹é¢ã€‚</p><p>SM ä¼šæŒ‰ç…§ <strong>èƒ½è”ç³»åˆ°çš„æœºå™¨çš„ minimal commit length</strong> å» Sealã€‚è¿™ä¸ªåœ°æ–¹æˆ‘æ„Ÿè§‰è¿˜æ˜¯æš—ç¤ºå°±æ˜¯æœ€çŸ­çš„æäº¤äº†æ‰æ˜¯å…¨éƒ¨é›†ç¾¤ä¸­æäº¤çš„é•¿åº¦ï¼Œç„¶åä¾é  2/3 çš„ safety å»ä¿è¯è¿™é‡Œé¢æœ€çŸ­çš„ä¸€å®šå¤§å®¶éƒ½æœ‰ã€ä¸€å®šå·²ç»æäº¤ã€‚</p><p>åœ¨ Seal ä¹‹åï¼Œè¿™é‡Œçš„é•¿åº¦ä¼šè¢« SM force ç„¶åå†ä¹Ÿä¸ä¼šæ”¹å˜ã€‚æ‰€æœ‰çš„ replica éƒ½æ˜¯ bitwise-identical çš„ã€‚</p><h4 id="Interaction-with-Partition-Layer"><a href="#Interaction-with-Partition-Layer" class="headerlink" title="Interaction with Partition Layer"></a>Interaction with Partition Layer</h4><p>client ä¼šç¼“å­˜ active extent çš„ä¿¡æ¯ï¼Œå¹¶ä¸”ï¼Œåœ¨è¯»å– extent çš„æ—¶å€™ï¼Œä¼šæœ‰ä¸¤ç§æ¨¡å¼ï¼š</p><ul><li>è¯»æŒ‡å®šä½ç½®çš„å†…å®¹ï¼Œè¯» <code>(extent + offset, length)</code>ã€‚è¿™é‡Œåªä¼šè¯»å– <strong>ä¹‹å‰è¿”å› success çš„å†…å®¹</strong></li><li>Partition Load çš„æ—¶å€™å» seq scanï¼Œå› ä¸º Partition Layer ä¼šä¿è¯è¿™ä¸ªé˜¶æ®µæ²¡æœ‰ append è¿›æ¥ï¼Œæ‰€ä»¥å¯ä»¥ç›¸å¯¹å®‰å…¨çš„æ¥å®Œæˆè¿™ä¸ªé˜¶æ®µçš„æ“ä½œã€‚è¿™ä¸ªä¼šç»™ Primary EN å‘è¯·æ±‚ï¼Œæ¥æŸ¥è¯¢ commit length. å¦‚æœå‡ºç° commit length ä¸ä¸€è‡´çš„æƒ…å†µï¼Œclient ä¼š seal extent ï¼ˆå¯¹ç…§ä¸Šä¸€èŠ‚ï¼‰ï¼Œç„¶åè¯»åªä¼šè¯» sealed extentã€‚</li></ul><h4 id="Erasure-Coding-Sealed-Extent"><a href="#Erasure-Coding-Sealed-Extent" class="headerlink" title="Erasure Coding Sealed Extent"></a>Erasure Coding Sealed Extent</h4><p>WAS ä¼šæŠŠ Sealed Block EC åŒ–ï¼Œæ¥èŠ‚çœæˆæœ¬ã€‚</p><h4 id="Read-Load-Balancing-amp-amp-Spindle-Anti-Starvation"><a href="#Read-Load-Balancing-amp-amp-Spindle-Anti-Starvation" class="headerlink" title="Read Load-Balancing &amp;&amp; Spindle Anti-Starvation"></a>Read Load-Balancing &amp;&amp; Spindle Anti-Starvation</h4><p>é¦–å…ˆå¯ä»¥å¤ä¹ ä¸€ä¸‹å‰ä¸¤èŠ‚çš„è¯»è¯­ä¹‰ï¼Œè¿™é‡Œå¯ä»¥ä¿è¯ï¼š</p><ul><li>å¯¹äº active extent è¯»çš„æ—¶å€™å¯ä»¥è¯» replicaã€‚</li><li>å¯¹äº ec æ¡å¸¦åŒ–çš„ sealed blobï¼Œè¿™é‡Œä¼šç»™æ‰€æœ‰æœºå™¨å‘è¯·æ±‚ï¼Œç„¶åæ”¶åˆ°èƒ½æ¢å¤çŠ¶æ€çš„è¯·æ±‚å°±è¿”å›ç»™ç”¨æˆ·</li></ul><p>è¯»å–çš„æ—¶å€™è¿˜æœ‰ä¸€äº›åˆ†å¸ƒå¼ç³»ç»Ÿå’Œ io çš„ tricksã€‚WAS ä¼šæœ‰ä¸€äº›ç±»ä¼¼æµæ§çš„æœºåˆ¶ï¼Œå®ƒä¼šï¼š</p><ul><li>è¯·æ±‚å¸¦ä¸Š deadlineï¼Œé¢„ä¼°è¯·æ±‚æ˜¯å¦ä¼šè¶…æ—¶ï¼Œå¦‚æœåˆ¤æ–­è¶…æ—¶ä¼šæå‰è¿”å›ç»™ç”¨æˆ·</li><li>åŸåˆ™ä¸Šï¼ŒWAS ä¼šå°è¯•ä¼˜åŒ–è¯·æ±‚ååè€Œç‰ºç‰²å…¬å¹³æ€§ï¼Œåœ¨ HDD ä¸Šå°½é‡åš seq scanã€‚è¿™é‡Œæœ‰ä¸€ä¸ª io æ’é˜Ÿè§‚å¯Ÿçš„ç­–ç•¥ï¼Œä¸è¿‡è®ºæ–‡æçš„ç­–ç•¥æ¯”è¾ƒç®€å•ï¼Œè€Œä¸”æ„Ÿè§‰æ˜¯ç»™ SSD ä¼˜åŒ–çš„ï¼Œæ„Ÿè§‰å¯ä»¥å‚è€ƒä¹‹åçš„ä¸€äº›è®ºæ–‡å§</li></ul><h4 id="Durability-and-Journaling"><a href="#Durability-and-Journaling" class="headerlink" title="Durability and Journaling"></a>Durability and Journaling</h4><p>è¿™é‡Œ WAS åˆ©ç”¨ SSD å……å½“ä¸€ä¸ªé«˜æ€§èƒ½æŒä¹…åŒ–å†™ç¼“å­˜ï¼Œè¿™æˆ‘ä¸ç¦æƒ³èµ·äº†åˆšåˆšå‡‰å‡‰çš„ Optane é‚£å¥— NVMâ€¦è¿™é‡Œä¾é åŒå†™çš„æ–¹å¼å†™ SSDï¼Œç„¶åSSDå†™å®Œå°±å¯ä»¥æå‰è¿”å›ï¼Œæ¥é™ä½ latencyã€‚SSD åœ¨è¿™é‡Œåªå……å½“å¿«é€Ÿå†™çš„ç¡¬ä»¶ï¼Œä¸€æ—¦å†™åœ¨ HDD ä¸Šå®Œæˆï¼Œä¹‹åçš„è¯·æ±‚éƒ½åœ¨ HDD ä¸Š servingã€‚è®ºæ–‡æŒ‡å‡ºï¼Œè¿™ç‚¹å°† e2e stream append latency avg ä» 30ms é™ä½åˆ° 6msã€‚</p><h2 id="Partition-Layer"><a href="#Partition-Layer" class="headerlink" title="Partition Layer"></a>Partition Layer</h2><p>Stream Layer è™½ç„¶å¹´ä»£æ‰€é™ï¼Œæœ‰çš„åœ°æ–¹åœ¨ 2022 å¹´çœ‹æ¥è¿˜æ˜¯æœ‰ä¼˜åŒ–ç©ºé—´çš„ï¼Œä½†æ˜¯æä¾›äº†å¾ˆå¤šè‡³ä»Šè¿˜åœ¨ç”¨çš„æŠ½è±¡ï¼Œæè¿°è¯­ä¹‰ä¹Ÿæ¯” GFS é‚£è‰å°ç©æ„å…·ä½“å¤šäº†ã€‚</p><p>Partition Layer åˆ™æ˜¯å±•ç°äº†æ€ä¹ˆåœ¨ Stream Layer è¿™ä¸ªåˆ†å¸ƒå¼å—å­˜å‚¨å±‚ä¸ŠåšæŠ½è±¡ï¼Œæ¥æ»¡è¶³ç”¨æˆ·çš„éœ€æ±‚ï¼Œè¿™é‡Œå³å±•ç¤ºäº†æ•°æ®ï¼Œåˆå±•ç¤ºäº† WALï¼ŒåŒæ—¶ä¹Ÿæœ‰ä¸€äº› Partition ç›¸å…³çš„æŠ½è±¡ï¼Œå±•ç°äº†ä¸€ä¸ªåŠå…±äº«å­˜å‚¨çš„ç³»ç»Ÿæ˜¯æ€ä¹ˆå®ç°çš„ã€‚</p><p>Partition Layer æŠ½è±¡å‡ºäº†ä¸€ä¸ªå«åš Object Table (OT) çš„ç»“æ„ï¼Œè¿™æ˜¯ä¸€ä¸ª scalable çš„ range partition çš„ <code>key-&#123;schema&#125;</code> çš„è¡¨ï¼Œè¢«åˆ†æˆæ•°ä¸ª RangePartitionï¼Œéƒ¨ç½²åœ¨ Partition Server ä¸Šã€‚å› ä¸ºæ˜¯ ï¼Œæ‰€ä»¥è¿™éƒ¨åˆ† range ä¸ä¼šé‡å ã€‚</p><p>Partition Layer åˆ©ç”¨ OT çš„æŠ½è±¡ï¼Œåˆ¶ä½œäº†ä¸‹é¢çš„ç»“æ„æ¥æ”¯æŒä¸Šå±‚çš„é€»è¾‘ã€‚è¿™äº›ç»“æ„ç¡®å®å¾ˆå¤šåœ°æ–¹åº”è¯¥ç”¨ç›¸å…³é€»è¾‘æ”¯æŒï¼Œä¸è¿‡çœ‹ä¸Šå»ï¼Œè¿™ä¸ªæ¶æ„ç¡®å®ä¸ºç»Ÿä¸€çš„ä¸€ä»½ä»£ç å¹²å¾ˆå¤šäº‹ä»˜å‡ºäº†åŠªåŠ›ï¼š</p><ul><li>Account Table: Storage Stamp ä¼šä¸Šå±‚æä¾›çš„è´¦æˆ·ä¿¡æ¯</li><li>Schema Table: å­˜æ”¾å„ç§æ•°æ®çš„ Schema</li><li>Partition Map Table: å­˜æ”¾ Partition ç›¸å…³çš„ä¿¡æ¯</li><li>æœ‰ä¸€å †å­æ•°æ®ç»“æ„çš„è¡¨æ ¼ï¼š<ul><li>Blob Table: ä¸º Blob ä½¿ç”¨ï¼Œå­˜å‚¨ç›¸å…³å…ƒä¿¡æ¯</li><li>Entity Table: ä¸º Row çš„ Table ç»“æ„ä½¿ç”¨ï¼Œå­˜æ”¾æ•°æ®</li><li>Message Table</li></ul></li></ul><p>FE å¯ä»¥è®¿é—®è¿™äº› tableï¼Œæ¥æä¾›å¯¹åº”çš„æŠ½è±¡ã€‚æ¯ä¸ª OT éƒ½æœ‰å›ºå®šçš„ Schemaï¼Œå¹¶åœ¨ Schema Table é‡Œé¢å­˜æ”¾äº†å¯¹åº”çš„ Schemaã€‚å…·ä½“è€Œè¨€ï¼Œè¿™é‡Œä¼šæœ‰ pk: <code>(AccountName, PartitionName, ObjectName)</code> ï¼Œçœ‹ï¼Œæ˜¯ä¸æ˜¯å¾ˆç†Ÿæ‚‰â€¦</p><p>OT è¿˜æ”¯æŒäº†åŒä¸€ä¸ª PartitionName çš„äº‹åŠ¡æ“ä½œå’Œ SIã€‚</p><h3 id="Partition-Layer-Architecture"><a href="#Partition-Layer-Architecture" class="headerlink" title="Partition Layer Architecture"></a>Partition Layer Architecture</h3><p><img src="https://image.mwish.me/blog-image/8F4B0A5E-6353-4EFA-93AA-226DB58DE0C4.png" alt="8F4B0A5E-6353-4EFA-93AA-226DB58DE0C4"></p><p>Partition Layer å¯ä»¥ç±»æ¯”ä¸º <code>HBase</code> æˆ–è€… BigTable çš„æ¶æ„ï¼š</p><ul><li>Partition Master (PM) è´Ÿè´£ track / merge / split / assign å¯¹åº”çš„ Range Partition. ç±»ä¼¼ HBaseï¼Œè¿™äº›ä¿¡æ¯ä¹Ÿè¢«å­˜æ”¾åˆ°ä¸‹å±‚çš„ Partition Map Tableã€‚PM æœ‰å¤šå°æœåŠ¡ï¼Œæ ¹æ® Lock Service ç¡®å®š Leader</li><li>Partition Server (PS) æŠŠæ•°æ®å­˜æ”¾åˆ° Stream ä¸­ï¼Œç„¶åè‡ªå·±ä¼šæœ‰ Cacheã€‚å¯¹äº Range Partition çš„åˆ†é…ï¼Œå•æœºä¹Ÿä¼šæŒæœ‰ Lock Service æ¥ç¡®ä¿è¿™ä¸€ç‚¹ï¼ˆæ„Ÿè§‰æœ‰çš„æ—¶å€™å¯ä»¥é è°ƒåº¦å±‚å¼ºè¡Œ fencingï¼Ÿä¸è¿‡è¿™æ ·åº”è¯¥ä¹Ÿèƒ½åšä¸€ä¸ªå¾ˆå¥½çš„ä¿è¯ï¼Œç›¸å½“äºå¸¦äº†ä¸ª epoch äº†ï¼‰</li><li>Lock Service: ç±»ä¼¼ chubby / zkâ€¦</li></ul><p>æ¥ä¸‹æ¥æˆ‘ä»¬å…³æ³¨ Partition Server å¯¹åº”çš„å•æœºç»“æ„æ˜¯æ€ä¹ˆå®ç°çš„ã€‚è¿™é‡Œçš„ç»“æ„æ˜¯ä¸€ä¸ª LSM-Treeï¼Œç„¶åè®ºæ–‡æ²¡æåˆ°æœ‰ CF è¿™æ ·çš„æŠ½è±¡ã€‚Stream åªå±äºä¸€ä¸ª RangePartitionï¼Œè€Œä¸åƒ HBase / BigTable ä¼šå¤šæµåˆä¸€ã€‚æ„Ÿè§‰è¿™ä¸ªæ—¢æœ‰å¥½å¤„åˆæœ‰é—®é¢˜å§ã€‚</p><p><img src="https://image.mwish.me/blog-image/9BE70021-EB5E-4BD9-BC74-28BA9E001236.png" alt="9BE70021-EB5E-4BD9-BC74-28BA9E001236"></p><p>è¿™é‡ŒåŒºåˆ†äº†å‡ ç§ Stream:</p><ul><li><p>Metadata Stream: æ•´ä¸ª Stream çš„å…ƒä¿¡æ¯ï¼Œå¯ä»¥ç”¨æ¥ load åˆ«çš„æ‰€æœ‰çš„ Streamï¼Œç±»ä¼¼ä¼ ç»Ÿæ•°æ®åº“ Catalog / MetaBlockï¼ŒPM é æä¾› metadata stream çš„åç§°æ¥æä¾›ä¿¡æ¯ã€‚è¿™ä¸ªä¿¡æ¯åŒ…å«ï¼š</p><ul><li>Stream çš„åç§°</li><li>ç±»ä¼¼æ•°æ®åº“æ—¥å¿—çš„ ckptï¼Œè¡¨ç¤ºæœ‰æ•ˆåŒºåŸŸçš„ extent + offset</li></ul></li><li>Commit Log Stream: ä¸çŸ¥é“æ˜¯ç‰©ç†è¿˜æ˜¯é€»è¾‘çš„ commit æ—¥å¿—</li><li>æ•°æ®å±‚é¢çš„ Stream:</li><li>Row Data Stream: data å’Œ index å¯¹åº”çš„ checkpointï¼Œå•ä¸ª RangePartition åªæœ‰ä¸€ä¸ª data stream<ul><li>Blob Data Stream: ä¸“é—¨ç»™ Blob ä½¿ç”¨</li></ul></li></ul><p>åœ¨å†…å­˜ä¸­è¿˜æœ‰ index cache , row data cache, bfï¼Œä½†æˆ‘è§‰å¾—â€¦éƒ½æ²¡å•¥æ„æ€ã€‚å…·ä½“å¯ä»¥å‚è€ƒè®ºæ–‡ 5.3 - 5.4 èŠ‚ï¼Œéƒ½æ˜¯æ¯”è¾ƒ trivial çš„ä¸œè¥¿ã€‚</p><h4 id="RangePartition-Load-Balancing"><a href="#RangePartition-Load-Balancing" class="headerlink" title="RangePartition Load Balancing"></a>RangePartition Load Balancing</h4><p>è¿™èŠ‚ä»‹ç»è°ƒåº¦ / merge / splitï¼Œæœ¬æ¥æŒºæ²¡æ„æ€çš„ï¼Œä¸è¿‡å¯ä»¥å…³æ³¨ä¸€ä¸‹å¯¹åº”çš„è¯­ä¹‰å’Œç»´æŠ¤æµç¨‹ï¼š</p><ul><li>åœ¨ç»´æŠ¤çš„æ—¶å€™ï¼ŒWAS ä¼šè®°å½• Partition çš„æ•°é‡ï¼Œå¹¶ä¿æŒåœ¨ low watermater - hight watermark ä¹‹é—´ï¼Œè¿™ä¸ªæ•°é‡å¤§æ¦‚æ˜¯ partition server çš„åå€ã€‚è¿™é‡Œä¼šå°½é‡æ¥ç»´æŠ¤è¿™ä¸ªå€¼ï¼Œå¹¶ä¸”æŒ‰ç…§è¯»å†™æµé‡å’Œ watermark æ¥è§¦å‘ merge - splitã€‚å…¸å‹çš„ stamp ä¼šæœ‰ 75æ¬¡ split / merge, 200 ä¸ª RangePartition</li><li>è¿™é‡Œä¼š track tps / pending transaction count / é™æµ / CPU ä½¿ç”¨ç‡ / ç½‘ç»œ / å»¶è¿Ÿ æ¥å†³å®šæ˜¯å¦ split / merge</li><li>split / merge ç±»ä¼¼ <code>hbase</code>ï¼Œæˆ‘ä»¬å…³æ³¨åŒºåˆ«ï¼š<ul><li>ä¸‹å±‚ Streaming å®ç°äº†å¯¹ Extent çš„ Ref-Counting</li><li>åœ¨ Split çš„æ—¶å€™ï¼ŒåŒæ ·ä¼šè§¦å‘ ckptã€‚Split çš„æ—¶å€™ä¹Ÿæ˜¯ç°åœ¨åŒä¸€å°æœåŠ¡å™¨ä¸Šåˆ†è£‚æˆä¸¤ä»½ï¼Œå†è°ƒåº¦èµ°ï¼›Merge çš„æ—¶å€™ä¹Ÿä¼šå…ˆè°ƒåº¦åˆ°åŒä¸€å°æœºå™¨ä¸Š</li><li>PS å®šä¹‰äº† MultiModify, æ ¹æ®éœ€è¦ Split çš„æµï¼Œfork ä¸¤ä¸ª refï¼Œç„¶åè°ƒåº¦æµé‡å³å®Œæˆã€‚æ²¡æœ‰ HBase é‚£ä¹ˆå¤æ‚</li><li>Merge æ“ä½œæ„Ÿè§‰æ¯”è¾ƒè‰å°ï¼ŒMultiModifyå•çº¯åˆå¹¶ä¸¤ä¸ª commit æµï¼Œæ„Ÿè§‰å¯¹ Truncate ä¸å¤ªå‹å¥½ï¼Ÿ</li></ul></li></ul><h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><ul><li>Blogs<ul><li><a href="https://fuzhe1989.github.io/2021/05/02/windows-azure-storage-a-highly-available-cloud-storage-service-with-strong-consistency/">https://fuzhe1989.github.io/2021/05/02/windows-azure-storage-a-highly-available-cloud-storage-service-with-strong-consistency/</a> (ä½œè€…æäº†ä¸€äº›ä»–çœ‹åˆ°çš„ç›¸å¯¹ç»†ä¸€äº›çš„åœ°æ–¹ï¼Œç„¶åä¹Ÿä»‹ç»äº†è¿™ä¸ªè®ºæ–‡é‡Œé¢å¾ˆå¤šå¤§ä½¬å»äº†é˜¿é‡Œäº‘)</li><li><a href="https://zhuanlan.zhihu.com/p/33951960">https://zhuanlan.zhihu.com/p/33951960</a> (ä½œè€…æ˜¯é˜¿é‡Œäº‘è¡¨æ ¼å­˜å‚¨çš„ï¼Œæ„Ÿè§‰ä»‹ç»ç›¸å¯¹æ¥è¯´æœ‰ä¸€äº›å†…éƒ¨ä¸€äº›çš„è§‚ç‚¹)</li></ul></li><li><a href="https://bluexp.netapp.com/blog/azure-storage-behind-the-scenes">https://bluexp.netapp.com/blog/azure-storage-behind-the-scenes</a></li><li>é˜¿é‡Œäº‘çš„ç›˜å¤ï¼Œå…¬å¼€ææ–™ä¹Ÿæ¯”è¾ƒå€¼å¾—çœ‹ï¼š<a href="https://developer.aliyun.com/article/291207">https://developer.aliyun.com/article/291207</a></li></ul>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Introduction to velox</title>
      <link href="/2022/11/13/Introduction-to-velox/"/>
      <url>/2022/11/13/Introduction-to-velox/</url>
      
        <content type="html"><![CDATA[<p>Velox æ˜¯ facebook å†…éƒ¨å¼€æºå‡ºçš„ä¸€å¥—å•æœºçš„å‘é‡åŒ–æ‰§è¡Œå¼•æ“ï¼Œfacebook å¸Œæœ› Velox èƒ½å¤Ÿä»£æ›¿å„å¤§ AP ç³»ç»Ÿçš„æ‰§è¡Œå±‚ï¼Œå¹¶å°è¯•ç”¨å®ƒæ¥åš ML ç³»ç»Ÿå’Œ ad-hoc åˆ†ææŸ¥è¯¢ç”šè‡³ batch æŸ¥è¯¢çš„æ‰§è¡Œå¼•æ“ã€‚åŒæ—¶ï¼Œåœ¨æ‰§è¡Œä¹‹å¤–ï¼Œå®ƒä¹Ÿæä¾›äº†ä¸€ç‚¹å°å°çš„ä¼˜åŒ–èƒ½åŠ›ã€‚æš‚æ—¶ä¸è€ƒè™‘æœ‰äººæå‡ºçš„ RFC ä¸­å’Œå†™å…¥ã€äº‹åŠ¡æœ‰å…³çš„éƒ¨åˆ†ï¼Œå®ƒè´Ÿè´£çš„å†…å®¹å¦‚ä¸‹ï¼š</p><ol><li>IOï¼Œè¯»å– <em>dwio</em>ï¼ŒParquet, ORC ç­‰å†…å®¹ï¼ˆä¸»è¦æ˜¯ dwio æ ¼å¼ï¼‰ï¼ŒåŒæ—¶ä¹ŸåŒ…æ‹¬ç¡¬ä»¶ä»‹è´¨ï¼ˆs3, ssd..ï¼‰å’Œæœ¬åœ°çš„ cacheï¼›å’Œè¿œç«¯èµ„æºäº¤äº’</li><li>é€šç”¨çš„ã€é«˜æ€§èƒ½ã€å¯æ‰©å±•çš„ vectorize computing ç®—å­ã€åº“å®ç°ï¼ˆIO çš„ Scan, Sink ä¹Ÿæ˜¯ä¸€éƒ¨åˆ†ï¼Œä½†æ˜¯æˆ‘ä»¬æš‚ä¸”åˆ†å¼€äº†ï¼‰<ol><li>Type system, columnar memory data, expression evaluation, operators</li></ol></li><li>èµ„æºç®¡ç†ï¼šç®¡ç† memory arenas, buffer management, tasks, drivers, CPU çº¿ç¨‹æ± å’Œçº¿ç¨‹æ‰§è¡Œ and thread execution, spilling å’Œç¼“å­˜</li></ol><p>åŸåˆ™ä¸Šï¼Œvelox æ¥å— Query Optimizer ä¼˜åŒ–åçš„å•æœº Planï¼Œç”¨å•æœºèŠ‚ç‚¹ä¸Šçš„èµ„æºã€‚ä¸Šå±‚è¦ä½¿ç”¨å®ƒå¯èƒ½è¦æœ‰ä¸€ä¸ªè½¬ä¹‰å±‚ï¼ˆä¾‹å¦‚ï¼ŒPresto æ®è¯´åœ¨å°è¯•ç”¨ï¼Œå°±èµ·äº†ä¸ªå•ç‹¬çš„é¡¹ç›® Prestissimoï¼‰ï¼Œç”¨äºè¦æŠŠè½¬ä¹‰çš„æ•°æ®ä¸¢è¿›æ¥ã€‚å½“ç„¶ï¼Œå®ƒè¿˜æƒ³å¤„ç†ç±»ä¼¼ ML ç­‰åœºæ™¯ï¼Œè¿™é‡Œæœ‰ç‚¹ç±»ä¼¼å‰è¾ˆ <a href="ä» Weld è®ºæ–‡çœ‹æ‰§è¡Œå™¨çš„ä¼˜åŒ–æŠ€æœ¯ - Eric Fuçš„æ–‡ç«  - çŸ¥ä¹ https://zhuanlan.zhihu.com/p/56138380">Weld</a></p><p>Velox æ¯”è¾ƒå¤§çš„è´¡çŒ®æ˜¯æä¾›äº†ä¸€å¥—æ¯”è¾ƒå¥½çš„å®é™…èŒƒæœ¬ï¼Œä¸œè¥¿ç®—ä¸ä¸Šæœ‰ä»€ä¹ˆæ–°ä¸œè¥¿ï¼Œä½†æ˜¯åœ¨æ¯”è¾ƒå¹²å‡€çš„æƒ…å†µä¸‹ï¼ŒæŠŠå„ç‚¹éƒ½åšåˆ°äº†ï¼Œé¡¹ç›®ä¹Ÿæ¯”è¾ƒæ•´æ´ã€‚è™½ç„¶è¡Œæ•°æ¯”è¾ƒå¤šï¼Œä½†æ˜¯å¤§å¤´è¿˜æ˜¯åœ¨ <code>functions</code> ä¹‹ç±»çš„å¾ˆç»†èŠ‚çš„ä¸œè¥¿ä¸Šã€‚éƒ¨åˆ†ä»£ç è™½ç„¶ä¸ç®—ç‰¹åˆ«å¥½ï¼ˆæ„Ÿè§‰æ˜¯å¼€æºæ²¡å¼€å‡€æˆ–è€…ç•™äº†å‘ï¼‰ï¼Œä½†æ˜¯ä¹Ÿç®—æœ‰æ¯”è¾ƒé«˜çš„å®Œæˆåº¦äº†ã€‚</p><p>Meta æŠŠ Velox å¼€æºå‡ºæ¥å¸Œæœ›èƒ½å¤Ÿå…±å»ºï¼Œç›®å‰ Ahana, Intel, Voltron Data ä¹‹ç±»çš„å…¬å¸åœ¨å…±å»º Veloxï¼Œçœ‹äº†ä¸‹ commit é¢‘ç‡ï¼Œä¸æ¯”å›½å†…å‡ ä¸ªæ˜æ˜Ÿå¼€æºå…¬å¸æäº¤é¢‘ç‡ä½ã€‚ä»–ä»¬ä¹Ÿå¸Œæœ›ï¼Œè¿™æ³¢èƒ½ä¸€èµ·å«–åˆ°æ ‡å‡†åŒ–è¯­ä¹‰å’Œæ–°ç¡¬ä»¶çš„ç¾Šæ¯›ï¼ˆè¿™ä¹ˆçœ‹ Influxdb-io ä¸Š arrow-datafusion è´¼èˆ¹æ˜¯ä¸æ˜¯æœ‰ç‚¹äºï¼‰ã€‚å°½ç®¡æœ‰äººè®¤ä¸ºï¼Œè¿™ä¸œè¥¿å¯èƒ½ä¼šå› ä¸ºå„ç§ API éƒ½è¦å†™ä¸ªè½¬ä¹‰å±‚æå¾—éå¸¸æ¶å¿ƒï¼Œä½†æ˜¯è¿™å‡ å®¶ç°åœ¨è¿˜æ˜¯æ¯”è¾ƒæœŸå¾… Velox èƒ½æ•´å‡ºä¸€ä¸ªå¥½æ´»çš„</p><p>æ€»è€Œè¨€ä¹‹ï¼Œé—²æ‰¯è¿™ä¹ˆå¤šï¼Œæˆ‘ä»¬è¿˜æ˜¯ä»‹ç»ä¸€äº› Velox çš„ä¸»è¦è´¡çŒ®ã€‚è¿™é‡Œæ²¡æœ‰ç ”ç©¶ä¸Šçš„è´¡çŒ®ï¼Œå…¨éƒ½æ˜¯å·¥ç¨‹ä¸Šçš„ï¼š</p><ol><li>å®Œå–„çš„å„ç±» expression / operator / io å®ç°</li><li>ä¸€äº› adaptive çš„ç®—å­é€‰æ‹©ã€Lazy Eval ç­‰</li><li>å®éªŒçš„ codegen</li></ol><p>ä¸‹é¢å¯ä»¥ç®€å•ä»‹ç»ä¸€äº›ï¼Œä¹Ÿè´´ä¸€äº›ç®€å•çš„ç”¨æˆ·ä»£ç ã€‚</p><h2 id="Type-System"><a href="#Type-System" class="headerlink" title="Type System"></a>Type System</h2><p>è¿™é‡Œæ”¯æŒäº† Scalar Type å’Œ Complex Type: <a href="https://facebookincubator.github.io/velox/develop/types.html">https://facebookincubator.github.io/velox/develop/types.html</a></p><p>åŸºæœ¬ä¸Šéƒ½æ˜¯ä»éœ€æ±‚æ¥çš„ï¼Œä» Spark å’Œ Presto é‡Œé¢å¼„æ¥çš„å„ä¸ªç±»å‹ã€‚å€¼å¾—ä¸€æçš„æ˜¯ï¼Œæœ‰äº›ä¸ªç±»å‹å°±ç‰¹åˆ«çº ç»“ï¼š</p><ul><li>ï¼ˆå„ç§ç¼–ç çš„ï¼‰å­—ç¬¦ä¸²</li><li>ï¼ˆå„ç§ç²¾åº¦çš„ï¼‰Decimal</li><li>ï¼ˆå„ç§ï¼‰Timestamp</li></ul><p>å€¼å¾—ä¸€æçš„æ˜¯ï¼Œå¯¹ç±»å‹çš„æ£€æŸ¥è¢«æ”¾åˆ°äº†è¡¨è¾¾å¼çš„ Compilation é˜¶æ®µï¼š<a href="https://facebookincubator.github.io/velox/develop/expression-evaluation.html#compilation">https://facebookincubator.github.io/velox/develop/expression-evaluation.html#compilation</a> ã€‚è€Œæ‰§è¡Œçš„æ—¶å€™ï¼Œé€šå¸¸éƒ½å·²ç»åšå¥½äº†è½¬å‹ï¼Œè¦ä¹ˆå°±ç›´æ¥æŠ¥é”™äº†ã€‚è¿™å—æœ¬æ¥åº”è¯¥åœ¨åé¢ä»‹ç»ï¼Œä½†æ˜¯é‰´äºè¿™å…¶å®æ˜¯ type system çš„ä¸€éƒ¨åˆ†ï¼Œæ‰€ä»¥åº”è¯¥åœ¨ type system è¿™èŠ‚ä»‹ç»ã€‚</p><p>Velox ä¼šæœ‰ä¸ª <code>resolveVectorFunction</code> å‡½æ•°ï¼Œå®ƒæœ‰ä¸ªå‡½æ•°åç§°çš„ <code>map</code> å·¥å‚ï¼Œè¾“å…¥ä¸€ä¸ª <code>ITypedExpr</code>ï¼Œç„¶åå¯ä»¥æ‹¿åˆ°ä¸€ä¸ªè¡¨è¾¾å¼é‡Œé¢æ‰€æœ‰çš„å‚æ•°ï¼Œç„¶åèµ°å¯¹åº”çš„åˆ—è¡¨ï¼Œæ‰¾åˆ°åç§°ä¸‹æ‰€æœ‰çš„å‡½æ•°ç»„ï¼Œè¿›è¡Œç±»å‹åŒ¹é…ï¼ŒåŒ¹é…é€šè¿‡å°±ç”¨ï¼Œæ²¡æœ‰å°±æ‰¾ä¸‹ä¸€ä¸ªï¼Œéƒ½æ²¡æœ‰å°±å‘Šè¯‰ç”¨æˆ·ã€‚</p><p>ç”¨æˆ·è¿˜å¯ä»¥æ·»åŠ è‡ªå·±çš„ç±»å‹æ‰©å±•ï¼Œæ¯”å¦‚ Presto æ·»åŠ äº† HyperLogLogï¼Œeg: <a href="https://github.com/facebookincubator/velox/commit/1e8e0d7c1db3f11ff322f702322070a968dab3df">https://github.com/facebookincubator/velox/commit/1e8e0d7c1db3f11ff322f702322070a968dab3df</a> ã€‚ç®€è€Œè¨€ä¹‹ï¼Œç”¨æˆ·å¯ä»¥æ¯”è¾ƒæ–¹ä¾¿çš„åœ¨ Velox ä¸Šå°è£…ç±»å‹å’Œå¯¹åº”çš„å®ç°ã€‚</p><h3 id="Vectors"><a href="#Vectors" class="headerlink" title="Vectors"></a>Vectors</h3><p>ç±»ä¼¼ Arrow çš„ Array (è¿™ç¯‡åšå®¢æœ‰å¾ˆå¤šä¸é”™çš„å›¾ï¼š<a href="https://blog.mwish.me/2022/10/04/Parquet-Part2-arrow-Parquet-code-path/">https://blog.mwish.me/2022/10/04/Parquet-Part2-arrow-Parquet-code-path/</a> )ï¼ŒVelox ä¹Ÿæœ‰ä¸€å¥—è¡¨ç¤ºåˆ—å­˜çš„æ ¼å¼ï¼šVectorï¼Œå†…å®¹å’Œ arrow å·®ä¸å¤šï¼Œæˆ‘ä»¬ä¸»è¦å…³æ³¨åŒºåˆ«ï¼š</p><ol><li>æ•°æ®ä» MemoryPool ä¸­ç”³è¯·ï¼ˆè®°å¾— arrow çš„ memory pool å—ï¼Ÿç”³è¯·æ•°æ® 64B å¯¹é½é‚£ä¸ªï¼‰ï¼Œæ•°æ®ä¼šè¢«å¼•ç”¨è®¡æ•°ç®¡ç†ï¼Œåªæœ‰ä¸€ä¸ª owner çš„æ•°æ®æ‰å¯æ›´æ”¹ï¼Œå¦åˆ™è¦æ‹·è´ï¼Œä¸è¿‡å…è®¸ cowã€‚</li><li>æä¾›äº† encoding æ”¯æŒï¼Œç±»ä¼¼ abadi è®ºæ–‡çš„ expression on compressed data:<ol><li>æ”¯æŒ flat, dictionary, constant  (å‰å‡ ç§ arrow ä¹Ÿæ”¯æŒ), Sequence(RLE), bias(FOR) çš„ç¼–ç </li><li>æä¾›äº† <code>DecodedVector</code> çš„æŠ½è±¡ï¼Œæ¥é¿å…å†™ä¸€äº› <code>if (XXEncoding) then ComputeOnEncoded() else if (encoding ) flatten</code> çš„é¢æ¡ä»£ç </li></ol></li><li>æ”¯æŒ Lazy Evaluationã€‚è¿™ä¸ªç±»ä¼¼æˆ‘ä»¬åœ¨ Presto è®ºæ–‡æåˆ°çš„ï¼Œå¯ä»¥å‡å°‘ä¸€å®šçš„ filter é‡ï¼ŒåŒæ—¶ç”šè‡³å¯èƒ½å‡å°‘ IO ï¼Œæ¯”å¦‚ï¼ˆå‡å°‘ io æ˜¯ä¸ªå¾ˆ hack çš„äº‹æƒ…ï¼Œå°¤å…¶æ˜¯ä½ å¦‚æœåšäº† prefetchâ€¦æˆ‘å¯¹è®ºæ–‡çš„æ€åº¦æŠ±æœ‰è‹¦ç¬‘èˆ¬çš„æ€€ç–‘ï¼‰<ol><li>è¿™é‡Œè¿˜æ”¯æŒ pushdownï¼Œè¿™ä¸ªæ„Ÿè§‰åƒæ˜¯å’Œä¸Šé¢ encoding æœ‰ç‚¹é‡å¤ï¼Œç›¸å½“äºæŠŠè®¡ç®—ä¸‹æ¨æ¥é¿å… materialize çš„å¼€é”€</li></ol></li><li>åœ¨å­—ç¬¦ä¸²å¤„ç†ä¸Šï¼Œå‚è€ƒäº† TUM çš„ Umbraï¼Œå¦‚ä¸‹é¢çš„è¯»ã€‚è¿™é‡Œç›¸å½“äºåœ¨æ•°æ®åº“æ–¹é¢åšäº†çŸ­è·¯è´Ÿè½½ï¼Œè®©å¤§éƒ¨åˆ†æ“ä½œç†”æ–­åœ¨çŸ­å­—ç¬¦ä¸²å¤„ã€‚æ­¤å¤–ï¼Œarrow çš„ string æœ¬èº«è¦æ±‚æ˜¯åœ¨ä¸€ä¸ª buffer ä¸­è¿ç»­çš„ï¼Œå¤„ç†æ–¹å¼ç±»ä¼¼ arrayã€‚Velox è®¤ä¸ºè¿™ä¹Ÿèƒ½åŠ é€Ÿ substr ä¹‹ç±»çš„æ“ä½œï¼Œè®©å¯¹åº”é•¿å­—ç¬¦ä¸²å‡å°‘ copyã€‚</li><li>Out-of-order write: å¯¹äº switch case æˆ–è€… if elseï¼Œåœ¨å‘é‡åŒ–ä¸­ï¼Œä¼šç®—å‡ºä¸€ç»„ä½ç½®æˆ–è€… true/false å‘é‡ï¼Œç„¶åè®©å¯¹åº”çš„åœ°æ–¹å†™ã€‚è¿™ä¸ªå¯¹ä¸€èˆ¬çš„ç±»å‹ä¼˜åŒ–ä¸å¤§ï¼Œä½†æ˜¯å¯¹å˜é•¿ç±»å‹å¯ä»¥æœ‰ä¸€å®šçš„ä¼˜åŒ–ã€‚æ¯”å¦‚è¯´ï¼Œæœ‰ä¸€ç»„ if else å‘é‡ï¼Œç„¶åå†™ string ç±»å‹ã€‚å¯¹äº arrow æ¥è¯´ï¼Œå› ä¸ºå†…å®¹åœ¨ buffer </li><li>Velox è¿˜æä¾›äº†è½¬æˆ arrow çš„ apiï¼Œæˆ‘è§‰å¾—è¿™ç”¨æ¥æ‹‰å±éå¸¸æ–¹ä¾¿</li></ol><p><img src="https://image.mwish.me/blog-image/3049626C-606E-40C1-8281-3C980FDD3603.png" alt="3049626C-606E-40C1-8281-3C980FDD3603"></p><p><img src="https://image.mwish.me/blog-image/string-views.png" alt="string-views"></p><p><img src="https://image.mwish.me/blog-image/string-vector.png" alt="string-vector"></p><h2 id="Expression-Eval"><a href="#Expression-Eval" class="headerlink" title="Expression Eval"></a>Expression Eval</h2><p>Velox çš„æŸ¥è¯¢æœ€æ—©ä¼šæ˜¯ä¸€ä¸ª Plan Node ç»„æˆçš„æ ‘ï¼Œç»è¿‡ Planner æˆä¸ºä¸€ä¸ª Pipeline + Operator çš„ç»“æ„ã€‚</p><p><img src="https://image.mwish.me/blog-image/local-planner.png" alt="local-planner"></p><p>è€Œåœ¨ <code>FilterNode</code>, <code>ProjectNode</code>, <code>AggregationNode</code>, å„ç§ Join çš„ Node å’Œ OrderBy çš„ Node ä¸­ï¼Œä¼šæœ‰å„ç§ Expressionsã€‚åœ¨ Velox ä¸­ï¼Œå¤„ç†å‰çš„ Expression <code>core::ITypedExpr</code> ä¼šåœ¨ compile åç»‘å®šæ‰§è¡Œéœ€è¦çš„ <code>core::Expr</code>. Expressions åŒ…å«ï¼š</p><ul><li>FieldAccessTypedExpr</li><li>ConstantTypedExpr</li><li>CallTypedExpr<ul><li>å‰å‡ ä¸ªéƒ½æ¯”è¾ƒç®€å•ï¼Œè¿™ä¸ªåŒ…å«äº† and, or, if, switch, cast, try(try ä¸€ä¸ªè¡¨è¾¾å¼ï¼Œæœ‰é—®é¢˜è¿”å› nullï¼‰, coalesce (è¿”å›ç¬¬ä¸€ä¸ªé null çš„è¡¨è¾¾å¼)</li></ul></li><li>CastTypedExpr</li><li>LambdaTypedExpr</li></ul><p>è¿™äº› <code>ITypedExpr</code> ä¼šç»„ç»‡æˆä¸€ä¸ªè¡¨è¾¾å¼æ ‘çš„å…³ç³»ï¼Œä» root è¿æ¥åˆ°å­èŠ‚ç‚¹ï¼Œå¯èƒ½æ˜¯ä¸ª AND æ ‘ä¹‹ç±»çš„ã€‚åŒæ—¶ï¼Œè¡¨è¾¾å¼ä¹Ÿä¼šæœ‰ä¸€äº› metadata ä½œä¸ºæ ‡è®°ï¼Œæ¯”å¦‚æ˜¯å¦ <code>determinstic</code>ã€<code>null propagation</code> çš„æ€§è´¨ï¼Œè§ï¼š<a href="https://facebookincubator.github.io/velox/develop/expression-evaluation.html#expression-metadata">https://facebookincubator.github.io/velox/develop/expression-evaluation.html#expression-metadata</a></p><p>è¡¨è¾¾å¼æ ‘çš„æ‰§è¡Œä¸æ˜¯ push / pull çš„å•å‘æµï¼Œè€Œæ˜¯æ¯ä¸ª batch è‡ª root åˆ°å¶èŠ‚ç‚¹çš„æ±‚å€¼ï¼Œç„¶åæ ¹æ®ä¸‹å±‚èŠ‚ç‚¹çš„ç»“æœï¼Œæœ€åäº§ç”Ÿä¸€ç»„æŸä¸ªç±»å‹çš„ Vectorã€‚</p><ol><li>è¡¨è¾¾å¼æ˜¯å¦æ˜¯ <em>deterministic</em> çš„ï¼ˆrand, shuffle å¤–çš„å¤§éƒ¨åˆ†å‡½æ•°éƒ½æ˜¯ï¼‰</li><li><em>propagatesNulls</em>: è¾“å…¥ä¸º null çš„æ—¶å€™ï¼Œè¾“å‡ºæ˜¯å¦ä¸º nullï¼Œå¯ä»¥åœ¨è¾“å…¥ä¸º null çš„æ—¶å€™å…å»ä¸€äº›è®¡ç®—</li><li>â€¦</li></ol><p>è¿™äº› attributes èƒ½åœ¨æ‰§è¡Œç«¯åœ¨è¡¨è¾¾å¼ä¸Šç»™å‡ºå¾ˆå¤§çš„ä¼˜åŒ–çš„ç©ºé—´ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œå¦‚æœè¾“å…¥è¢«å‘ç°ï¼Œè™½ç„¶æœ‰å¾ˆå¤šè¡Œï¼Œä½†æ˜¯é™å®šåœ¨å­—å…¸å†…ç­‰ï¼Œå°±ä¼šæœ‰å¾ˆå¤§çš„ä¼˜åŒ–ç©ºé—´ã€‚æˆ–è€…å‘ç°ä¼š propagate null çš„è¯ï¼Œæ˜¯ null çš„è¡¨è¾¾å¼å°±ä¸ç”¨å†è¢«æŠ˜è…¾ä¸€èŒ¬å­ï¼Œç›´æ¥ null set ä¼ é€’ã€‚</p><h3 id="Compilation"><a href="#Compilation" class="headerlink" title="Compilation"></a>Compilation</h3><p>Compile é˜¶æ®µä¼šæ‹¿åˆ°ä¸€ä¸ªæˆ–å¤šä¸ªè¡¨è¾¾å¼æ ‘ï¼Œé¦–å…ˆä¼šè¿›è¡Œç±»å‹åŒ¹é…çš„è®¡ç®—ï¼ˆè¯¦è§ä¹‹å‰çš„ Type System ä¸€èŠ‚ï¼‰ï¼Œç„¶åä¼šè¿›è¡Œä¸€äº›ç®€å•çš„è¡¨è¾¾å¼ä¼˜åŒ–ã€‚è¿™ä¸€ç‚¹å…¶å®æœ‰é‚£ä¹ˆç‚¹ç‚¹æ€ªï¼Œæœ‰çš„ä¼˜åŒ–æ˜¯æ‰§è¡Œä¸Šçš„ï¼Œå› ä¸º Velox è‡ªå·±æ‰§è¡Œçš„æ—¶å€™å¯ä»¥æŠ½å‡ºå¾ˆå¤šä¸Šé¢æ‰€è¯´çš„ attributesï¼Œç„¶ååˆ©ç”¨é‡Œé¢çš„ç‰¹æ€§æ¥ä¼˜åŒ–ã€‚æ„Ÿè§‰ä¸€èˆ¬çš„ç³»ç»Ÿä¸­ï¼Œå› ä¸ºæ²¡æœ‰è¿™ç§ plan - plan ä¹‹é—´çš„ gapï¼Œæ‰€ä»¥æ²¡æœ‰è¿™ä¹ˆä¸€ä¸ªã€Œå†ä¼˜åŒ–ã€çš„è½¬æ¢å±‚ã€‚</p><p>è¿™é‡Œä»–ä¼šæŠŠ <code>TypedExpr</code> è½¬æˆå…·ä½“çš„ exprï¼Œå…·ä½“é“¾è·¯å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">- compileExpressions // å¤„ç†å¤šç»„ (vector&lt;ITypedExpr&gt;)</span><br><span class="line">  - compileExpression // å¤„ç†å•ä¸ª ITypedExpr æ ‘</span><br><span class="line">    èµ°è¡¨è¾¾å¼ç¼–è¯‘ç¼“å­˜, å°è¯•ä» scope æåˆ°ç›¸åŒçš„å­è¡¨è¾¾å¼</span><br><span class="line">    compileInput, å…ˆä»è¾“å…¥æ•°æ®çš„ç±»å‹å¼€å§‹ç¼–è¯‘, å¯¹å­è¡¨è¾¾å¼å¯èƒ½åšä¸€äº›å¸¸é‡æŠ˜å ï¼Œè¡¨è¾¾å¼æŠ˜å </span><br><span class="line">    æ ¹æ® root è¡¨è¾¾å¼çš„ç±»å‹, åˆ†å‘å¤„ç†</span><br><span class="line">    æ ¹æ®ç±»å‹å’Œå‡½æ•°åç§°(å­—ç¬¦ä¸²) æ‹¿åˆ° candidate å‡½æ•°</span><br><span class="line">    å®Œæˆ</span><br></pre></td></tr></table></figure><p>åœ¨è¿™ä¸ªæµç¨‹ä¸­ï¼Œè¿˜æœ‰ä¸€äº›ç‰¹æ®Šçš„ä¼˜åŒ–ï¼š</p><h4 id="Common-SubExpression-Detection"><a href="#Common-SubExpression-Detection" class="headerlink" title="Common SubExpression Detection"></a>Common SubExpression Detection</h4><p><img src="https://image.mwish.me/blog-image/cse.png" alt="cse"></p><p>åœ¨ Expression ç¼–è¯‘çš„æ—¶å€™ï¼Œä¼šæœ‰ä¸€ä¸ª <code>Scope</code> åšä¸Šä¸‹æ–‡ã€‚Scope é—´ä¹Ÿæœ‰çˆ¶çº§å…³ç³»ã€‚è¿™é‡Œå®ƒä¼šæŠŠç¼–è¯‘å¥½çš„è¡¨è¾¾å¼ä¸¢åˆ° Scope ä¸­ï¼Œå½“è¡¨è¾¾å¼ç”Ÿæˆäº†ä¸¤é <code>upper(a)</code> çš„æ—¶å€™ï¼Œä»–ä»¬ä¼šè¢«ç”¨åŒä¸€ä¸ªè¡¨è¾¾å¼è¿›è¡Œè®¡ç®—ã€‚</p><h4 id="Flatten-ANDs-and-ORs"><a href="#Flatten-ANDs-and-ORs" class="headerlink" title="Flatten ANDs and ORs"></a>Flatten ANDs and ORs</h4><p>è¡¨è¾¾å¼ä¼šæ ‡æ³¨å¯å¦ foldã€‚velox ä¼šå°è¯•å» fold è¿™äº›è¡¨è¾¾å¼æ ‘ï¼Œè¿™ä¸€éƒ¨åˆ†å‘ç”Ÿäº Compile é˜¶æ®µ</p><p><img src="https://image.mwish.me/blog-image/flatten-and.png" alt="flatten-and"></p><h5 id="flatten-concat-like-functions"><a href="#flatten-concat-like-functions" class="headerlink" title="flatten concat-like functions"></a>flatten concat-like functions</h5><p>è¿™é‡Œå’Œä¸Šé¢ç±»ä¼¼ï¼Œæ¯”å¦‚ <code>f(x1, f(x2, f(x3, x4))) == f(x1, x2, x3, x4)</code>ï¼Œè¿™é‡Œä¼šå°è¯•æŠ˜å ï¼Œé¿å…æ·±æ ˆ</p><h4 id="Constant-Folding"><a href="#Constant-Folding" class="headerlink" title="Constant Folding"></a>Constant Folding</h4><p>åšä¸€äº›å¸¸é‡æŠ˜å ï¼Œç›¸å½“äºæå‰è®¡ç®—ã€‚</p><h3 id="Adaptive-Conjunct-Reordering-in-AND-and-OR"><a href="#Adaptive-Conjunct-Reordering-in-AND-and-OR" class="headerlink" title="Adaptive Conjunct Reordering in AND and OR"></a>Adaptive Conjunct Reordering in AND and OR</h3><p>è¿™ä¸ªåœ¨å®˜ç½‘ä¸Šæ˜¯ä¸€ä¸ªæ‰§è¡Œç«¯ç­–ç•¥ï¼Œè€Œåœ¨ä»£ç é‡Œâ€¦æˆ‘åœ¨ compile æ²¡çœ‹åˆ°ï¼Œåœ¨ <code>ConjunctExpr::evalSpecialForm</code> é‡Œé¢ï¼Œå‘ç°äº†ç›¸å…³çš„æ–¹æ³• <code>maybeReorderInputs()</code>ã€‚çœ‹æ¥è®ºæ–‡ä¹Ÿå­˜åœ¨å¹ç‰›é€¼æˆåˆ†ï¼Ÿè¿˜æ˜¯åé¢è¢«ç§»èµ°äº†ï¼Ÿ</p><p>è¿™é‡Œä¼šæ ¹æ® and or çš„ selectivity é€‰æ‹©ï¼Œè®¡ç®—çš„æ—¶å€™ï¼Œè¿™é‡Œä¼šç»Ÿè®¡ selectivityï¼Œ<code>and</code> ä¼šå°½é‡å‰ç½® <code>false</code> çš„è¡¨è¾¾å¼ï¼Œ<code>or</code> ä¼šå°½é‡å‰ç½® <code>true</code> çš„è¡¨è¾¾å¼ï¼Œæ¥åŠ¨æ€é€‚åº”æ€§ç†”æ–­è¡¨è¾¾å¼è®¡ç®—ã€‚</p><h3 id="Evaluation"><a href="#Evaluation" class="headerlink" title="Evaluation"></a>Evaluation</h3><p>åœ¨æ‰§è¡Œç«¯ï¼Œ<code>FilterProject</code> çš„ operator ä¼šä¸€æ¬¡æ€§å®Œæˆ <code>Filter + Project</code> çš„æ‰§è¡Œï¼Œè¾“å…¥æ˜¯ <code>EvalCtx</code>ï¼ŒåŒ…å« <code>RowVector</code> å’Œ <code>SelectivityVector</code>. <code>::eval</code> æ–¹æ³•ç”¨æ¥è¯„ä¼°è¡¨è¾¾å¼ã€‚</p><p><code>ExprSet</code> åŒ…å«ä¸€ä¸ªæˆ–è€…å¤šä¸ª <code>Expr</code>, å®ƒä¼šè°ƒç”¨ <code>Expr::eval</code>ã€‚æ‰§è¡Œçš„æ—¶å€™ï¼Œè¿™é‡Œä¼šåˆ¤æ–­æ˜¯å¦æ˜¯ä¸€ä¸ªé‡å¤çš„å­è¡¨è¾¾å¼ï¼Œå¦‚æœæ˜¯ã€‚è¿™é‡Œä¼šç¼“å­˜è®¡ç®—ç»“æœã€‚</p><p>å½“è¾“å…¥æ˜¯å­—å…¸ç¼–ç çš„æ—¶å€™ï¼Œç¡®å®šæ€§çš„è¡¨è¾¾å¼å¯ä»¥åªç®—å­—å…¸ä¸­çš„ distinct valueã€‚æ–‡ç« ä¸¾äº†ä¸ªä¾‹å­ï¼Œ<code>UPPER(colors)</code>, ç„¶å colors åªæœ‰ <code>red, blue, yellow</code> ä¸‰ç§ï¼Œä½†æœ‰å¾ˆå¤šå€¼çš„æ—¶å€™ï¼Œç®—è¿™ä¸‰ç§å°±è¡Œäº†ã€‚è¿™ç§æŠ€æœ¯å…·ä½“æ‰§è¡Œå¤§æ¦‚å¦‚ä¸‹ï¼š</p><p><code>Expr::peelEncodings ()</code>: <code>f(g(input))</code> ä¸­ï¼Œè¿›å…¥è¡¨è¾¾å¼ï¼Œè¡¨è¾¾å¼å‘ç°è¿™ä¸€ç‚¹ï¼Œç„¶åæŠŠè¾“å…¥æ¢æˆå­—å…¸çš„ distinct è¾“å…¥äº†</p><p>è¿™é‡Œè¿˜æœ‰å­—å…¸çš„ memorizingï¼Œç»“æœå°±æ¯”è¾ƒç®€å•ï¼šå­—å…¸æ²¡å˜æ›´å°±ä¸€ç›´ç”¨åŒä¸€ä¸ªå­—å…¸å¯¹è±¡ã€‚</p><p>ä¼š propagate null çš„è¯ï¼Œæ˜¯ null çš„è¡¨è¾¾å¼å°±ä¸ç”¨å†è¢«æŠ˜è…¾ä¸€èŒ¬å­ï¼Œç›´æ¥ null set ä¼ é€’ï¼Œå¦‚æœæ˜¯å­—å…¸çš„è¯ï¼Œå…è®¸æŠŠå­—å…¸é‡Œä¸€äº›ä¸œè¥¿è®¾ç½®æˆ nullã€‚</p><p>Velox å®˜ç½‘æœ‰ä¸ªä¸€å›¾é€Ÿé€šï¼Œæˆ‘çœ‹äº†ä¸‹ï¼Œå’Œä»£ç æ˜¯å¯¹çš„ä¸Šçš„ï¼š</p><p><img src="https://image.mwish.me/blog-image/expression-evaluation.png" alt="expression-evaluation"></p><h3 id="Flat-No-Nulls-Fast-Path"><a href="#Flat-No-Nulls-Fast-Path" class="headerlink" title="Flat No-Nulls Fast Path"></a>Flat No-Nulls Fast Path</h3><p>å’Œæˆ‘ä»¬åˆšæ‰çš„ <code>propagateNulls_</code> å’Œå¤„ç†ç›¸å¯¹ï¼Œè¿™é‡Œå¦‚æœå…¨éƒ¨éç©ºï¼Œé‚£ä¹ˆå¯ä»¥ skip ä¸€äº› null handlingï¼Œæ ¹æ®åŸæ–‡ï¼Œåœ¨å°äº 1000 rows çš„çŸ­è¡¨è¾¾å¼ä¸­ï¼Œè¿™ç§ä¼˜åŒ–ç›¸å¯¹èƒ½èµ·åˆ°æ¯”è¾ƒå¥½çš„æ•ˆæœã€‚åœ¨ Velox ä¸­ï¼ŒVector functions (åé¢ä¼šä»‹ç») ä¼šæä¾›ä¸€ä¸ª <code>supportsFlatNoNullsFastPath()</code> çš„è¯­ä¹‰ï¼Œæ¥å¸®åŠ©è¯„ä¼°èµ° fastPath</p><h4 id="Evalution-If-Switch"><a href="#Evalution-If-Switch" class="headerlink" title="Evalution If/Switch.."></a>Evalution If/Switch..</h4><p>å…ˆæ‰§è¡Œ conditionï¼Œç„¶åå»æŒ‰åºæ‰§è¡Œ casesï¼š <a href="https://facebookincubator.github.io/velox/develop/expression-evaluation.html#evaluation-of-if-switch">https://facebookincubator.github.io/velox/develop/expression-evaluation.html#evaluation-of-if-switch</a></p><h3 id="Codegen"><a href="#Codegen" class="headerlink" title="Codegen"></a>Codegen</h3><p>åœ¨è®ºæ–‡å†™ä½œçš„æ—¶å€™ï¼ŒVelox ä¼šè®²è¡¨è¾¾å¼ç”Ÿæˆ C++ ä»£ç ï¼Œç„¶ååŠ¨æ€é“¾æ¥åˆ°ç¨‹åºä¸­ã€‚æ—¥å‰ï¼ŒVelox é‡‡ç”¨çš„è¿˜æ˜¯ç›´æ¥ç”¨ç¼–è¯‘å™¨ç¼–è¯‘ï¼Œè€Œæ²¡æœ‰ç”¨æ—¶é«¦çš„ LLVM-codegenã€‚æ–‡ç« è®¤ä¸º codegen å¯¹ ETL è¿™ç§å¤§ job å¯èƒ½æ•ˆæœå¥½ä¸€äº›ï¼Œå› ä¸ºè¡¨è¾¾å¼æ•´ä½“éƒ½ä¸ä¼šå˜ï¼Œè€Œ ETL job åæ­£ä¼šå¾ˆå¤§ã€‚</p><p>ç›®å‰ï¼ŒVelox åŸºæœ¬è¿˜æ˜¯å…¨éƒ¨å‘é‡åŒ–çš„æ–¹å¼ï¼Œcodegen ä»£ç åœ¨ <code>experimental</code> ä¸‹é¢ã€‚</p><h2 id="Functions"><a href="#Functions" class="headerlink" title="Functions"></a>Functions</h2><p>ç”¨æˆ·å¯ä»¥è®¤ä¸ºï¼ŒæŸç§ç¨‹åº¦ä¸Š functions æ˜¯ expr çš„ä¸€ä¸ªå°éƒ¨åˆ†(<code>Call</code> æœ‰å…³çš„ Expr)ã€‚Velox å†…éƒ¨æä¾›äº†ä¸å°‘è¯¥æœ‰çš„å‡½æ•°ï¼ŒåŒæ—¶ï¼Œç”¨æˆ·ä¹Ÿå¯ä»¥ç›¸å¯¹æ–¹ä¾¿çš„æ·»åŠ å‡½æ•°ã€‚æ¯”è¾ƒæ¶å¿ƒçš„æ˜¯ï¼Œè¿™å¸®äººæ„Ÿè§‰æ²¡é‚£ä¹ˆé‚£ä¹ˆæ‡‚ C++ï¼Œæ‰€ä»¥â€¦åŠ èµ·æ¥ä¹Ÿæœ‰ç‚¹å°è›‹ç–¼ã€‚è¿™ä½“ç°åœ¨ä»€ä¹ˆåœ°æ–¹å‘¢ï¼Ÿä¸€æ¥ Velox åŒºåˆ†äº† Vector çš„å‡½æ•°å’Œ Simple Functionsï¼Œç„¶åè¿˜æœ‰ä¹‹å‰æˆ‘ä»¬æåˆ°çš„å„ç§ determine ç­‰ç­‰ï¼Œè¿™äº›ä¸œè¥¿å èµ·æ¥ï¼ŒåŠ ä¸Šç±»å‹ç³»ç»Ÿåšçš„æ¯”è¾ƒç³™ï¼Œæ€»çš„æ¥è¯´åŠ ä¸œè¥¿ä¹Ÿæ²¡æœ‰é‚£ä¹ˆæ–¹ä¾¿ã€‚å½“ç„¶ï¼Œç›¸å¯¹è‡ªå·±ä»å¤´å¼€å§‹å†™ï¼Œè‚¯å®šæ˜¯å¾ˆä¸æ»‘çš„ã€‚</p><p>å¯¹äºæ¥æ”¶å•ä¸ªè¾“å…¥è¿”å›å•ä¸ªè¾“å‡ºï¼Œç¡®å®šç±»å‹çš„å‡½æ•°ï¼Œå³ Scalar Functionsã€‚ Velox è®¤ä¸ºï¼ŒSimple Function ä¸æ˜¯é‚£ä¹ˆå¥½ä¼˜åŒ–ï¼Œè€Œä¸”å‘é‡åŒ–ä¹Ÿå®¹æ˜“å‡ºé”™çš„æƒ…å†µä¸‹ï¼Œå¯ä»¥ä½¿ç”¨ Simple Functions + å‘é‡åŒ–çš„æ–¹å¼æ¥å¤„ç†é—®é¢˜ã€‚Velox ä¼šä½¿ç”¨ä¸€å¥—æ¡†æ¶æ¥åŒ…è£… Simple Functionsï¼Œç„¶åå°½é‡è®©å…¶èƒ½è‡ªåŠ¨å‘é‡åŒ–ã€‚</p><p><img src="https://image.mwish.me/blog-image/D40EF3D5-58F5-4B04-9E20-423639A128F8.png" alt="D40EF3D5-58F5-4B04-9E20-423639A128F8"></p><p>Velox åœ¨ç¼–ç¨‹æ¡†æ¶ä¸Šä¹Ÿåšäº†å¾ˆå¤šä¼˜åŒ–ï¼Œæ¯”å¦‚æ ‡æ³¨æ˜¯å¦ nullableï¼Œä½¿ç”¨ zero-copyï¼Œå¤„ç† deterministicã€‚è®ºæ–‡è¿˜æåˆ°äº†ä¸€é¡¹å…³äºç¼–ç çš„ä¼˜åŒ–ï¼šè®©ç”¨æˆ·æŒ‡å®š ASCii, Utf8 ç­‰ç¼–ç ï¼ŒåŒæ—¶å¯ä»¥å°½é‡ä¼˜åŒ–å…¶ä¸­çš„æ‹·è´ï¼Œå¯ä»¥ ref åŸå†…å®¹çš„åœ°æ–¹ä¸éœ€è¦æ‹·è´ã€‚</p><p><img src="https://image.mwish.me/blog-image/E4BA6100-A4CF-4EF4-B41D-906E4A3EFCE1.png" alt="E4BA6100-A4CF-4EF4-B41D-906E4A3EFCE1"></p><p>ï¼ˆè¶Šå†™æˆ‘è§‰å¾—è¶Šåƒ TiKV Coprocessor äº†ï¼Œæƒ³èµ·æˆ‘çš„é’æ˜¥å¹´åå’Œå¤±è´¥è®°å¿†äº†ï¼‰</p><p>ï¼ˆè®ºæ–‡ç”šè‡³æ²¡æ€ä¹ˆæ Vectorize functionsï¼Œä¼°è®¡æ˜¯è§‰å¾—è·Ÿç”¨æˆ·ä»‹ç»æœ€ç®€å•çš„å°±è¡Œï¼Œä¸è¿‡æˆ‘è§‰å¾— Vectorize çš„éƒ¨åˆ†ä¹ŸæŒºæœ‰æ„æ€çš„ï¼š<a href="https://facebookincubator.github.io/velox/develop/scalar-functions.html#vector-functions">https://facebookincubator.github.io/velox/develop/scalar-functions.html#vector-functions</a> ï¼‰</p><h3 id="Aggragations"><a href="#Aggragations" class="headerlink" title="Aggragations"></a>Aggragations</h3><p>Aggragations åœ¨ Agg ç›¸å…³çš„ Operator ä¸‹å¤´ï¼Œä½¿ç”¨ <code>HashAggregation</code> è¿›è¡Œç›¸å…³çš„è®¡ç®—</p><p><img src="https://image.mwish.me/blog-image/7A390174-95B3-4BB9-A979-73B5F5907A34.png" alt="7A390174-95B3-4BB9-A979-73B5F5907A34"></p><ul><li>Partial: ç±»ä¼¼ shuffle ä¸­ä½¿ç”¨çš„ï¼Œæ ¹æ®æ•°æ®ç”Ÿæˆä¸€äº›ä¸­é—´ç»“æœ</li><li>Final: å¤„ç† <code>Partial</code> çš„ç»“æœ</li><li>Single: æ•°æ®å¾ˆå°ä¸ç”¨ shuffleï¼Œæˆ–è€…æ•°æ®å·²ç»è¢«æŒ‰ç…§ group key æ¥åš partition</li><li>Intermediate: ç±»ä¼¼ MR ä¸­çš„ shuffleï¼Œä»ä¸­é—´æ•°æ®ç”Ÿæˆä¸­é—´æ•°æ®ï¼Œåœ¨ Partial å’Œ Final ä¹‹é—´</li></ul><p>Sum, min, max ä¸­ï¼Œpartial å’Œ final åšçš„æ˜¯åŒä¸€ç§è®¡ç®—ï¼Œè€Œæœ‰çš„æ“ä½œåˆ™ä¸åŒã€‚æ¯”å¦‚ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT a, b, count(c) FROM t GROUP BY 1, 2</span><br></pre></td></tr></table></figure><p>partial ä¼šåšä¸€äº›åˆ†åŒºæ“ä½œï¼ŒFinal åˆ™æ˜¯å°† partial æ•°æ®åˆå¹¶èµ·æ¥ã€‚</p><h4 id="Aggregations-ç»“æœçš„å†…å­˜ç®¡ç†"><a href="#Aggregations-ç»“æœçš„å†…å­˜ç®¡ç†" class="headerlink" title="Aggregations ç»“æœçš„å†…å­˜ç®¡ç†"></a>Aggregations ç»“æœçš„å†…å­˜ç®¡ç†</h4><p>è¿™é‡Œç±»ä¼¼è¡Œå­˜çš„æ•°æ®åº“ï¼Œä¼šæœ‰å¦‚ä¸‹çš„æ ¼å¼ï¼š</p><p><img src="https://image.mwish.me/blog-image/aggregation-layout.png" alt="aggregation-layout"></p><p>Velox ä¼šè¯†åˆ«å‡ºæ“ä½œæ˜¯å¦æ˜¯å®šé•¿æ“ä½œï¼Œç„¶ååšå¤„ç†ã€‚</p><h4 id="å¦‚ä½•æ·»åŠ ä¸€ä¸ª-Aggregator"><a href="#å¦‚ä½•æ·»åŠ ä¸€ä¸ª-Aggregator" class="headerlink" title="å¦‚ä½•æ·»åŠ ä¸€ä¸ª Aggregator"></a>å¦‚ä½•æ·»åŠ ä¸€ä¸ª Aggregator</h4><p>ä¸ºå•¥è¿™ä¸ªè¦ä¸“é—¨å†™å‘¢ï¼Ÿå› ä¸ºè¿™ä¸ªæˆ‘ä»¬å¯ä»¥è€ƒè™‘ä¸€ä¸‹ï¼ŒAgg å¾ˆå¤šæ—¶å€™æ˜¯å¸¦ä¸€äº›ä¸Šä¸‹æ–‡çš„ï¼Œæ¯”å¦‚å¯¹åˆ—çš„ mapã€‚è®ºæ–‡é‡Œé¢è¿ function éƒ½åªä»‹ç»äº† simpleâ€¦</p><p>ï¼ˆè¿™ä¸ªåœ°æ–¹æˆ‘åˆæƒ³èµ·äº† TiKV Coprocessor é‚£å † proc macro å’Œæˆ‘é‚£å¤±è´¥çš„é’æ˜¥ï¼‰</p><p>å‚è€ƒï¼š<a href="https://facebookincubator.github.io/velox/develop/aggregate-functions.html#aggregate-class">https://facebookincubator.github.io/velox/develop/aggregate-functions.html#aggregate-class</a></p><p>è¿™é‡Œä¼šè€ƒè™‘å‡ ç§ agg:</p><p>Global aggregation, two aggregates: â€œcountâ€ and â€œsumâ€:</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="built_in">count</span>(<span class="operator">*</span>), <span class="built_in">sum</span>(b) <span class="keyword">FROM</span> t</span><br></pre></td></tr></table></figure><p>Aggregation with three aggregates: â€œcountâ€ and two â€œsumâ€s.</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> a, <span class="built_in">count</span>(<span class="operator">*</span>), <span class="built_in">sum</span>(b), <span class="built_in">sum</span>(c) <span class="keyword">FROM</span> t <span class="keyword">GROUP</span> <span class="keyword">BY</span> <span class="number">1</span></span><br></pre></td></tr></table></figure><p>é¦–å…ˆï¼Œéœ€è¦è€ƒè™‘å„ä¸ªé˜¶æ®µï¼Œæ¯”å¦‚ <code>Prepare</code>é˜¶æ®µçš„æ•°æ®å‡†å¤‡ï¼Œå…¶æ¬¡è€ƒè™‘ä¸­é—´æ•°æ®æ˜¯å¦æ˜¯å®šé•¿çš„ï¼Œè¿™ä¸ªä¼šå½±å“è¡Œç›¸å…³çš„è®¿é—®å’Œå†™å…¥ï¼ˆAccumulator sizeï¼‰ã€‚ç„¶åå¯ä»¥åˆ†åˆ«å®ç°å¯¹åº” global aggregation å’Œ groupby aggregation ç›¸å…³çš„å†…å®¹äº†ã€‚</p><h2 id="Plan-Nodes-and-Operators"><a href="#Plan-Nodes-and-Operators" class="headerlink" title="Plan Nodes and Operators"></a>Plan Nodes and Operators</h2><p><img src="https://image.mwish.me/blog-image/velox-logical-planner.png" alt="velox-logical-planner"></p><p>Plan Node å’Œ Operator çš„æ˜ å°„å‡ ä¹æ˜¯ä¸€å¯¹ä¸€çš„ï¼Œå½“ç„¶æœ‰å‡ ä¸ªä¾‹å¤–ï¼š</p><ol><li>Filter node + Project node ä¼šè¢«æŠ˜å æˆ <code>FilterProject</code> ( æˆ‘ä»¬ä¹‹å‰è¿˜æåˆ°è¿‡å®ƒï¼Œå˜¿ )</li><li>å¤šäºä¸¤ä¸ªå­èŠ‚ç‚¹çš„ä¼šè¢«æ‹†åˆ†ï¼Œæ¯”å¦‚è¯´ HashJoin ä¼šæ‹†æˆ HashBuild å’Œ HashProbe</li></ol><p>æœ‰ä¸€äº›ç‰¹æ®Šçš„åœ°æ–¹å¯ä»¥å‚è€ƒï¼š<a href="https://facebookincubator.github.io/velox/develop/operators.html">https://facebookincubator.github.io/velox/develop/operators.html</a></p><p>ç±»ä¼¼ Presto çš„æ¦‚å¿µï¼Œé‡Œé¢çš„æ‰§è¡Œå•å…ƒä¸Šå±‚æ¦‚å¿µå« Top ( Presto çš„ Job æ˜¯ä¸€ä¸ªå¸¦ç‚¹åˆ†å¸ƒå¼æ„å‘³çš„å•å…ƒï¼Œè€Œ Velox åˆ™æ˜¯å•æœºçš„)ã€‚Task æ•°æ®å¯èƒ½æ¥æºäº TableScan æˆ–è€… Exchangeï¼Œç„¶åå¯èƒ½ä»¥å¦ä¸€ä¸ª Exchange ç»“å°¾ã€‚è¿™é‡Œä¼šæœ‰ Pipeline æ¥é©±åŠ¨æ‰§è¡Œï¼Œæ¯ä¸ª Pipeline å¯èƒ½æœ‰ä¸€åˆ°å¤šä¸ªæ‰§è¡Œçš„ Driverï¼ŒDriver å¯èƒ½ bound åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸Šï¼Œå¹¶ç®¡ç†æ‰§è¡Œçš„çŠ¶æ€ã€‚è¿™éƒ¨åˆ†ç±»ä¼¼ Presto äº†ï¼Œæ„Ÿå…´è¶£å¯ä»¥å›å¤´çœ‹çœ‹ã€‚æˆ‘ä»¬å°±ä¸“é—¨æŒ‘ä¸€äº› Velox ä»‹ç»ç»†ä¸€ç‚¹çš„æ¦‚å¿µå›¾æ¥è´´å§ï¼Œéƒ½è¯»åˆ°è¿™äº†ï¼Œé«˜ä½å¾—å­¦ç‚¹æ–°ä¸œè¥¿æ˜¯ä¸ã€‚</p><p>è¿™é‡Œä¸¾äº†ä¸€äº› HashJoin å’Œ Local Exchange çš„ä¾‹å­ï¼Œè¿™äº›éƒ½æ˜¯ä¸ºäº†æ‰©å¤§å¹¶å‘ï¼Œæ³¨æ„ï¼Œä¸‹æ–‡ä¸ºä¾‹å­ï¼Œä¸ä»£è¡¨å®ç°ä¸€å®šä¼šè¿™æ ·ï¼š</p><p><img src="https://image.mwish.me/blog-image/join.png" alt="join"></p><p>è¿™é‡Œ Build å’Œ Probe éƒ½æ˜¯å¹¶å‘çš„ï¼ŒBuild æœ‰ä¸‰ä¸ªçº¿ç¨‹ï¼ŒProbe æœ‰ä¸¤ä¸ªçº¿ç¨‹å»æ‰§è¡Œã€‚ç„¶åç»“æœè¢«æ”¾åˆ° <code>JoinBridge</code> ä¸­ã€‚</p><p>åœ¨ Velox ä¸­ï¼ŒLocal Exchange å¯ä»¥ä»å¤šä¸ªçº¿ç¨‹/ä¸€ä¸ªçº¿ç¨‹ &lt;-&gt; å¤šä¸ªçº¿ç¨‹/ä¸€ä¸ªçº¿ç¨‹ä¸­è½¬æ¢ï¼Œå¸®å¿™å®Œæˆè¿™ä¸ªå·¥ä½œã€‚</p><h3 id="Split"><a href="#Split" class="headerlink" title="Split"></a>Split</h3><p>åœ¨ Velox ä¸­ï¼Œç³»ç»Ÿä¹Ÿæœ‰ Splitï¼ŒVelox ä¸è´Ÿè´£åˆ†å¸ƒå¼ï¼Œä½†æ˜¯å¤–éƒ¨å¯ä»¥é€šè¿‡<code>Task::addSplit(planNodeId, split)</code> api æ¥æ·»åŠ  Splitï¼ŒSplit è¢«ç»„ç»‡åœ¨é˜Ÿåˆ—ä¸­æ¶ˆè´¹ï¼š</p><p><img src="https://image.mwish.me/blog-image/task-splits.png" alt="task-splits"></p><p>Local Exchange ç­‰æ“ä½œä¹Ÿä¼šè¢«ä» Queue ä¸­æ¶ˆè´¹</p><h3 id="IO"><a href="#IO" class="headerlink" title="IO"></a>IO</h3><p>è¯»å–ç®—å­å’Œ FilterProject å¯ä»¥å’Œ IO æ•´åˆåœ¨ä¸€èµ·ã€‚Presto ä¾§é‡å»è¯»è¿œç«¯çš„æ•°æ®æºå’Œå¼€æ”¾çš„æ¥å£ï¼ŒVelox åˆ™æ˜¯æœ‰ä¸€å¥— IOã€‚å®ƒé»˜è®¤ä½¿ç”¨ dwio æ ¼å¼å¯ä»¥å¾ˆå¥½çš„å»åšç®—å­ä¸‹æ¨ç­‰æ“ä½œï¼ŒåŒæ—¶ï¼Œè¿™é‡Œä¹Ÿæœ‰ adaptive è°ƒæ•´ç®—å­é¡ºåºçš„æ“ä½œï¼ˆå¦‚å‰æ–‡æ‰€è¿°ï¼‰ã€‚</p><p>æœ€è¿‘ Velox ä¹Ÿåœ¨åšä¸€äº› Parquet Native çš„ä¼˜åŒ–ï¼Œè§ï¼š<a href="https://github.com/facebookincubator/velox/discussions/2411">https://github.com/facebookincubator/velox/discussions/2411</a></p><h3 id="Hash-Joins"><a href="#Hash-Joins" class="headerlink" title="Hash Joins"></a>Hash Joins</h3><p>å¯¹äº HashJoinï¼ŒVelox æœ‰ kInner, kLeft, kRight, kFull, kLeftSemi, kRightSemi, kAnti è¿™å‡ ç§ã€‚</p><p><img src="https://image.mwish.me/blog-image/hash-join-node.png" alt="hash-join-node"></p><p>Velox åœ¨ Agg å’Œ HashJoin ä¸­ï¼Œéƒ½ä½¿ç”¨ <code>velox::exec::HashTable</code>. å®ƒæ ¹æ®æ˜¯å¦å¿½ç•¥ null keys åšäº†ä¸€äº›ç‰¹åŒ–ï¼ŒJOIN KEY ç­‰ä¼šå‘—å­˜æˆä¸€ä¸ªè¡Œå­˜çš„ <code>RowContainer</code> æ¥å¤„ç†</p><p>Velox ä¼šä½¿ç”¨ <code>velox::exec::VectorHasher</code> æ¥ hash å¯¹åº”çš„ keyï¼Œå½“ key ç©ºé—´å¯ä»¥è¢«ç®€å•æ•´ç†åˆ° u64 ä¸­æ—¶ï¼ŒVelox ä¼šä½¿ç”¨è¿™äº›ä¼˜åŒ–ï¼Œæ¥é¿å…å—¯ç®—å“ˆå¸Œã€‚</p><p> <code>velox::exec::HashTable</code> æ˜¯ä¸€ä¸ªå•çº¿ç¨‹çš„å“ˆå¸Œè¡¨ï¼Œè¿™é‡Œæœ‰ä¸€äº›ä¸‹é¢çš„ç­–ç•¥ï¼š</p><ol><li><a href="https://github.com/facebookincubator/velox/commit/765cc2d793cc194f5f44b97ad011e29666ceed70">https://github.com/facebookincubator/velox/commit/765cc2d793cc194f5f44b97ad011e29666ceed70</a> (æ¯ä¸ª executor å»å¤„ç†ä¸åŒçš„éƒ¨åˆ†)</li><li><a href="https://github.com/facebookincubator/velox/commit/0d38da85bae9c6e87a4bbdbc42d428c6c3cd4d87">https://github.com/facebookincubator/velox/commit/0d38da85bae9c6e87a4bbdbc42d428c6c3cd4d87</a> (åˆå¹¶å¤šç»„ hash build)</li></ol><p>é¢˜å¤–è¯ï¼Œfolly è¿™é‡Œè¯´å®ç°å‚è€ƒäº† F14ï¼Œè¿™é‡Œä½¿ç”¨è¡Œå­˜çš„ hashtableï¼Œä½œè€…è®¤ä¸ºè¿™é‡Œ hash ç›¸å…³çš„ attributes è¿˜æ˜¯å­˜ä¸€èµ·å¥½ï¼Œç„¶åä¼šä½¿ç”¨ <code>prefetch</code> ç­‰æ–¹å¼äº¤é”™å†…å­˜è¯»å–ã€‚Databend æœ€è¿‘å®ç°äº†å­—ç¬¦ä¸²ç‰¹æ”»çš„ SAHAï¼Œä¼˜åŒ–æ•ˆæœè´¼å¥½ï¼Œæ„Ÿè§‰è¿™ç§å°±æ˜¯ç‰¹åŒ–åœºæ™¯ç‰¹åŒ–å®ç°ä¸€å®šæ˜¯æ— æ•Œçš„ã€‚</p><h4 id="Dynamic-Filter-Pushdown"><a href="#Dynamic-Filter-Pushdown" class="headerlink" title="Dynamic Filter Pushdown"></a>Dynamic Filter Pushdown</h4><p>å¯¹äº inner, left semi, right semi è¿™å‡ ç§ JOINï¼ŒVelox å…è®¸ä½¿ç”¨ Dynamic Filter Pushdown:</p><p><img src="https://image.mwish.me/blog-image/join-dynamic-filters.png" alt="join-dynamic-filters"></p><p>HashProbe ä¸­ï¼ŒVectorHasher å¦‚æœå‘ç°å¯¹è±¡é›†åˆå¾ˆå°‘ï¼Œå¯ä»¥æŠŠä¿¡æ¯æ¨åˆ°å­˜å‚¨ä¸Šï¼Œæ¥åšç›¸å…³çš„ä¼˜åŒ–ã€‚</p><h4 id="æ‚é¡¹"><a href="#æ‚é¡¹" class="headerlink" title="æ‚é¡¹"></a>æ‚é¡¹</h4><p>è¿™é‡Œè¿˜å®ç°äº† broadcast join, anti joins ç­‰ï¼Œæ­¤å¤–ï¼Œè¿™é‡Œè¿˜æœ‰ statistics ç›¸å…³çš„æ•°æ®ï¼Œé˜²æ­¢åšè´Ÿä¼˜åŒ–ï¼š<a href="https://facebookincubator.github.io/velox/develop/joins.html#execution-statistics">https://facebookincubator.github.io/velox/develop/joins.html#execution-statistics</a></p><p>è¿™é‡Œè¿˜å®ç°äº† merge joinï¼Œä¸è¿‡æ„Ÿè§‰ç¯‡å¹…ä¸é•¿ï¼š</p><p><img src="https://image.mwish.me/blog-image/merge-join-pipelines.png" alt="merge-join-pipelines"></p><h2 id="Memory-Management"><a href="#Memory-Management" class="headerlink" title="Memory Management"></a>Memory Management</h2><p>Velox çš„ caching çš„å†…å­˜ç®¡ç†æœ‰ç‚¹ç±»ä¼¼ umbraã€‚å®ƒè¡¨ç¤ºï¼š</p><ol><li>å°å¯¹è±¡ä¼šä» heap ä¸Šç”³è¯·</li><li>data cache, hash table, è¯»æ•°æ®çš„ buffer ä¼šä½¿ç”¨ mmap å’Œ madvise æ¥ç®¡ç†</li></ol><p>è¿™é‡Œä¼šæœ‰å±‚çº§çš„ MemoryTrackerï¼Œæ¥ç®¡ç†è¿™äº›å†…å­˜ï¼Œç„¶åä¸Šå±‚å¯ä»¥é€šè¿‡ <code>spilling</code> æ¥è®©å†…å­˜å†™å‡ºã€‚Spill ç›¸å…³çš„éƒ¨åˆ†å’Œ Presto è®ºæ–‡æè¿°çš„å·®ä¸å¤šï¼Œæ²¡æœ‰ä»€ä¹ˆç‰¹åˆ«çš„ï¼Œéƒ½è¦åœ¨ Drive / Operator ä¸Šå¼€æ´.</p><p>å€¼å¾—ä¸€æçš„æ˜¯ç¼“å­˜éƒ¨åˆ†ï¼ŒVelox å†™äº†ä¸€å¥—ç¨ç¨å¤æ‚çš„å¤§å¯¹è±¡ç¼“å­˜ï¼ˆæ²¡ç”¨ CacheLibï¼Œæ„Ÿè§‰æ˜¯æ²¡å•¥å°å¯¹è±¡éœ€æ±‚ï¼Ÿæˆ‘ä¸æ‡‚å•Šï¼‰ã€‚ç±»ä¼¼ Umbraï¼Œå®ƒä¼šæœ‰ä¸åŒå¤§å°çš„ mmap ç©ºé—´åšå†…å­˜æ± ï¼Œå½“æ²¡æœ‰äºº pin è¿™äº›å†…å­˜çš„æ—¶å€™ï¼Œè¿™éƒ¨åˆ†å¯ä»¥æ¢å‡ºã€‚</p><p>Velox è¿˜èƒ½å¤Ÿåˆå¹¶ IOï¼Œè¯»å– S3ï¼ŒHDFSï¼Œç„¶åä¸¢åˆ°å†…å­˜/SSD ç¼“å­˜ã€‚Velox è¯»å–è¿œç«¯çš„æ—¶å€™ï¼Œä¼šåˆå¹¶ç›¸é‚»è¯»ï¼Œå¯¹ SSD ä¼šåˆå¹¶è¯»åˆ° 20K ï¼Œå¯¹ SSD ä¼šåˆå¹¶è¯»åˆ° 500Kã€‚è¿™å‡ ä¸ªæ„Ÿè§‰å¯ä»¥å‚è€ƒ arrow å»ç„å­¦è°ƒå‚ã€‚</p><p>Velox è¿˜ä¼šåš Prefetchï¼Œè¿™é‡Œï¼Œè®¿é—®åˆ—å­˜å¯¹è±¡çš„æ–¹å¼å¦‚ä¸‹ï¼š</p><ol><li>è¯» metadataï¼Œè¿™ä¸ªé€šå¸¸ä¸ä¼šå¾ˆå¤§ï¼Œé€šè¿‡ metadata å¯ä»¥æ‹¿åˆ°å¯¹è±¡å¤§æ¦‚çš„å¤§å°</li><li>è¯»å…·ä½“çš„ buffer</li></ol><p>Velox è¿™é‡Œä¼šè®°å½•å„åˆ—çš„ selectivityï¼Œç„¶åå°è¯•å» prefetch selectivity é«˜çš„ï¼Œæ¥é™ä½å»¶è¿Ÿã€‚</p><h2 id="ç»“è¯­"><a href="#ç»“è¯­" class="headerlink" title="ç»“è¯­"></a>ç»“è¯­</h2><p>å°½ç®¡ Velox è¿™ä¸ªé¡¹ç›®çš„æœªæ¥å°šä¸æ˜æ™°ï¼ŒåŒæ—¶æ²¡æœ‰æ•°æ®å†™å’Œäº‹åŠ¡ç›¸å…³çš„éƒ¨åˆ†ï¼Œä½†æ˜¯å®ƒç»™æˆ‘ä»¬å±•ç°äº†ä¸€ä¸ªå•æœºæµ‹çš„å®Œæ•´æŸ¥è¯¢å¼•æ“ï¼ŒåŒ…æ‹¬ IO, Executor, Operator, Driver, Pipeline å’Œå„ä¸ªç®—å­ã€‚</p><p>Velox ä»£ç æ³¨é‡Šç®—ä¸å¾—å¥½ï¼Œæ„Ÿè§‰ä½œè€…ä»¬ä¹Ÿæ²¡æœ‰é‚£ä¹ˆæ‡‚ C++ï¼Œæˆ‘çœ‹çš„æ—¶å€™éå¸¸è›‹ç–¼çš„ä¸€ç‚¹æ˜¯ï¼Œè¿™äº›äººä¼ å‚æ•°æ„Ÿè§‰éƒ½æ˜¯çå‡ æŠŠå†™çš„ï¼Œä¸€ç‚¹éƒ½ä¸ç®¡è¯»è€…çš„æ„Ÿè§‰ï¼Œä½†æ˜¯ fb ç›¸å…³çš„ç»éªŒç¡®å®å¾ˆä¸°å¯Œï¼Œè™½ç„¶å¾…å®Œå–„ï¼Œä½†ç¡®å®ç»™ä»–ä»¬æå‡ºæ¥äº†ï¼Œè¿˜æçš„ä¸é”™ã€‚è¿˜æ˜¯è¦è™šå¿ƒå­¦ä¹ ï¼Œçœ‹çœ‹ä»–ä»¬æ˜¯å’‹æçš„ã€‚</p><h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><ul><li><a href="https://facebookincubator.github.io/velox/develop">https://facebookincubator.github.io/velox/develop</a></li><li>Facebook Veloxæºç æµ…è¯» - ä¸è¦å«é†’æˆ‘çš„æ–‡ç«  - çŸ¥ä¹ <a href="https://zhuanlan.zhihu.com/p/438656081">https://zhuanlan.zhihu.com/p/438656081</a></li></ul>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>x86 and SIMD programming Part0: Background</title>
      <link href="/2022/11/05/x86-and-SIMD-programming/"/>
      <url>/2022/11/05/x86-and-SIMD-programming/</url>
      
        <content type="html"><![CDATA[<p>ä½œä¸ºæŒ‡ä»¤é›†å¹¶è¡Œçš„ä¸€éƒ¨åˆ†ï¼ŒSIMD å·²ç»è¢«å¤§å¹…åº¦ç”¨æ¥æé«˜ç¨‹åºçš„æ€§èƒ½äº†ã€‚è€Œåœ¨æ•°æ®åº“ç³»ç»Ÿä¸­ï¼Œåˆ†æå‹æ•°æ®åº“ä¹Ÿå¤§é‡ä½¿ç”¨ SIMD æ¥åš vectorizeï¼Œæ¥æé«˜æ€§èƒ½ã€‚æœ¬æ å°½é‡ä»‹ç»ä¸€ä¸‹åŸºæœ¬çš„ SIMD çš„å†å²ã€éœ€æ±‚å’ŒåŸºç¡€ï¼Œç„¶ååé¢ä¹Ÿä¼šè®²åˆ° AVX2 çš„å…¥é—¨ã€xsimd åº“å’Œè®©ç¼–è¯‘å™¨è‡ªåŠ¨æ¥åšå‘é‡åŒ–ã€‚åœ¨è¿™é‡Œï¼Œäº†è§£ç¡¬ä»¶å’ŒæŒ‡ä»¤é›†æ˜¯æ¯”è¾ƒé‡è¦çš„ç»„æˆéƒ¨åˆ†ï¼Œè€Œè™½ç„¶ ARM å¹³å°ä¹Ÿæœ‰è‡ªå·±çš„ SIMD æŒ‡ä»¤é›†ï¼Œä½†ä½œä¸º db ç ”å‘ï¼Œæˆ‘ä»¬è¿˜æ˜¯ä»¥ x86 çš„ä¸ºå‡†ï¼ˆå€’ä¸æ˜¯çœ‹ä¸èµ· armï¼Œå°±å•çº¯å…ˆä¸èŠ±æ—¶é—´å§ï¼‰ã€‚</p><p>CPU æœ‰ä¸€äº›æŠ€æœ¯æ¥å¸®å¿™ä¼˜åŒ–ï¼Œæ¯”å¦‚ Hyper Threading / Super Scalarï¼ŒCPU ä¹Ÿæœ‰ä¸“é—¨çš„ SIMD å¤„ç†å•å…ƒã€‚è¿™ä½¿å¾—äººä»¬å¯ä»¥ç»™å‡ºæ›´å¥½çš„å®ç°ã€‚åœ¨æ•°æ®åº“é‡Œé¢ï¼Œè¿‘å¹´æ¥å·åˆ°çˆ†ç‚¸çš„åˆ†æå‹æ•°æ®åº“é¢†åŸŸä¹Ÿå¸Œæœ›èƒ½å¤Ÿåˆ©ç”¨å¥½ SIMDã€‚</p><p>è¨€å½’æ­£ä¼ ï¼Œç¨‹åºå‘˜æ—©æœŸå…¶å®æ˜¯æ²¡é‚£ä¹ˆæ‡‚å¹¶å‘ç¼–ç¨‹çš„ï¼ŒåŸå› å¤§æ¦‚åœ¨ <a href="https://blog.mwish.me/2022/05/04/perfbook-notes-hardware/">perfbook é‚£èŠ‚</a> ä¹Ÿè®²è¿‡ï¼Œä»¥å‰ç¡¬ä»¶æå‡éƒ½æ˜¯å¯ä»¥ç›´æ¥åæ˜ åˆ°ç¨‹åºä¸Šï¼Œå•¥éƒ½ä¸åšæ€§èƒ½å°±æå‡äº†ï¼Œä½†æ˜¯ç°åœ¨çš„ç¨‹åºå‘˜å¿…é¡» get hands dirtyï¼Œæ¥äº†è§£ä¸€ä¸‹ä¸‹å±‚çš„æŠ½è±¡ï¼Œæ¥ä¸€æŠŠæ…ä¸‹å»è·å¾—æ€§èƒ½ã€‚åŒæ—¶ï¼Œæœ‰çš„æ—¶å€™æ€§èƒ½ã€ç”Ÿäº§åŠ›ã€é€šç”¨æ€§æ˜¯ä¸ªä¸è‚¯èƒ½ä¸‰è§’ï¼Œè¿™ä¸ªåœ¨ perfbook é‚£èŠ‚ä¹Ÿæœ‰æåˆ°ã€‚è¿™è¯æœ‰ç‚¹å¤ªä¿—äº†ï¼Œä¸‹é¢çš„å›¾å…¶å®æ˜¯æ¯”è¾ƒå¥½ç†è§£çš„ï¼š</p><p><img src="https://image.mwish.me/blog-image/0EDCEC2A-2361-4560-91DD-68FE51B150D8.png" alt="0EDCEC2A-2361-4560-91DD-68FE51B150D8"></p><p>è¿™é‡Œè¿˜æœ‰ä¸€å¼ å…³äºå†…å­˜å¸¦å®½å’Œé¢‘ç‡æœ‰å…³çš„å›¾ï¼š</p><p><img src="https://image.mwish.me/blog-image/5FC1C556-0F2B-474B-B12E-4A6EAC8405FF.png" alt="5FC1C556-0F2B-474B-B12E-4A6EAC8405FF"></p><p>ï¼ˆå®é™…ä¸Šï¼Œå¯ä»¥çœ‹ ref 4ï¼Œå•çº¿ç¨‹å·²ç»è·‘ä¸æ»¡å†…å­˜å¸¦å®½äº†ï¼Œä¸è¿‡å†…å­˜å¸¦å®½ä»ç„¶å—åˆ°é™åˆ¶ï¼‰</p><p>å…³äºæ€§èƒ½ï¼Œè¿™é‡Œè¿˜æœ‰ä¸€äº› hints:</p><ol><li>cache miss å¯èƒ½å¾ˆé‡ï¼Œå¯èƒ½ç›¸å½“äºå‡ åå‡ ç™¾æ¡æŒ‡ä»¤ï¼Œå½“ç„¶ï¼ŒIO å°±æ›´é‡äº†</li><li>éœ€è¦åˆ©ç”¨ SIMDã€å¤šæ ¸ã€å¤šçº¿ç¨‹ç”šè‡³ GPU ç”šè‡³ç‰¹æ®Šç¡¬ä»¶æ¥æ”¹å–„æ€§èƒ½</li><li>å†™ fastcode å¯èƒ½æ¶‰åŠä»£ç é‡å¤§ã€å¤šçº¿ç¨‹åè°ƒã€ä¸è·¨å¹³å°ï¼ˆæ¯”å¦‚å•å¹³å° SIMD çš„é—®é¢˜ï¼‰ï¼ŒåŒæ—¶ï¼ŒCompiler å¯èƒ½ä¹Ÿä¸ä¸€å®šèƒ½å¤Ÿç”Ÿæˆåˆé€‚çš„ä»£ç ã€‚å¤šçº¿ç¨‹å¿…ä¸å¤šè¯´ï¼ŒSIMD å¯èƒ½ä¹Ÿæ²¡æ³•ç”Ÿæˆå¾ˆå¥½çš„é€‰é¡¹ï¼Œå®é™…ä¸Šå¾ˆå¤šåœ°æ–¹ï¼ˆä¾‹å¦‚ TiFlashã€ClickHouseï¼‰éƒ½æ˜¯å†™ä¾¿äºå‘é‡åŒ–çš„ä»£ç ï¼Œå°½é‡è®©ç¼–è¯‘å™¨è‡ªåŠ¨å‘é‡åŒ–ç„¶ååŠ ä¸€äº›ç¼–è¯‘å‚æ•°æ¥æ£€æŸ¥ï¼Œä¸€äº›å…³é”®è·¯å¾„ä¹Ÿå¾—è‡ªå·±æ‰‹æ“ SIMD æˆ–è€…ç”¨ SIMD åº“ã€‚</li></ol><p><img src="https://image.mwish.me/blog-image/18C67A41-F361-4853-8F9E-E1F4E5F61D01.png" alt="18C67A41-F361-4853-8F9E-E1F4E5F61D01"></p><h2 id="ç¡¬ä»¶å‘å±•å’Œç¡¬ä»¶åŸºç¡€"><a href="#ç¡¬ä»¶å‘å±•å’Œç¡¬ä»¶åŸºç¡€" class="headerlink" title="ç¡¬ä»¶å‘å±•å’Œç¡¬ä»¶åŸºç¡€"></a>ç¡¬ä»¶å‘å±•å’Œç¡¬ä»¶åŸºç¡€</h2><p><img src="https://image.mwish.me/blog-image/D8C704E9-F29C-48E4-8B8E-E9387C8DBE44.png" alt="D8C704E9-F29C-48E4-8B8E-E9387C8DBE44"></p><p>X86-64 å¹³å°æ˜¯ x86-32 çš„ä¸€ä¸ªæ‰©å±•ã€‚å½“ç„¶ï¼Œè¿™é‡Œ x86 æŒ‡çš„æ˜¯ ISAï¼Œä¸ä¹‹ç­‰åŒçš„æ˜¯ RISC-Vã€ARMã€POWERã€MISC ç­‰ã€‚è€Œä¸åŒçš„æ˜¯ä¸‹å±‚çš„å®ç°å’Œ microarchï¼Œæ¯”å¦‚ cacheline çš„é•¿åº¦ã€‚x86 æ˜¯ä¸€ä¸ª CISC æŒ‡ä»¤é›†ï¼Œä½†æ˜¯å®ƒçš„æŒ‡ä»¤ä¼šè¢«å¤„ç†æˆ RISC çš„ï¼Œä»¥è·å–æ€§èƒ½ï¼š</p><p><img src="https://image.mwish.me/blog-image/AFA12812-C13B-4C01-BA95-E6E92971B7E5.png" alt="AFA12812-C13B-4C01-BA95-E6E92971B7E5"></p><p>ä¸‹é¢æ˜¯ä¸€ä¸ª Intel èŠ¯ç‰‡çš„å›¾ï¼Œæ¥è‡ª wiki:</p><p><img src="https://image.mwish.me/blog-image/IntelProcessorRoadmap-4v.svg.png" alt="IntelProcessorRoadmap-4v.svg"></p><p>Intel åœ¨ 06 å¹´æå‡º tick-tock æ¨¡å‹: Tick ä¸€æ¬¡ä»£è¡¨åˆ¶ç¨‹ï¼ˆProcessï¼‰æ›´æ–°ï¼Œåˆ©ç”¨ç¡¬ä»¶æå‡ï¼›Tock ä»£è¡¨ä½œå‡ºæ–°çš„æ¶æ„ã€‚è¿™ä¸ªç­–ç•¥åæ¥è¢«æ›´æ–°ä¸º Processâ€“architectureâ€“optimization æ¨¡å‹ï¼š</p><p><img src="https://image.mwish.me/blog-image/A5C7244A-F0A4-4EFE-8C73-B02694C904D8.png" alt="A5C7244A-F0A4-4EFE-8C73-B02694C904D8"></p><p>æœ€æ—©å‡ºç°çš„èŠ¯ç‰‡æ˜¯ 16ä½çš„ Intel 8086, Intel 8088, Intel 80186, Intel 80286ã€‚æ¸¸æˆçš„å¼€ç«¯æ˜¯ 1985 å¹´çš„ Intel 80386ï¼Œå®ƒæœ€åˆé‡‡ç”¨äº† 32ä½çš„ IA-32 æ¶æ„ï¼ˆ æ­¤å¤–ï¼Œè¿˜æœ‰ä¸ªåå­—å¾ˆåƒçš„ã€åˆ›é€ è€…åŒæ ·åŒ…å« Intel çš„ IA-64ï¼Œåˆ™æ˜¯å¦ä¸€ä¸ªæŒ‡ä»¤é›†ã€‚ï¼‰ï¼Œå®ƒæœ‰å„ç§å¯„å­˜å™¨ã€4GB çš„è™šæ‹Ÿåœ°å€ç©ºé—´ã€åŸºäºé¡µçš„è™šæ‹Ÿå†…å­˜ã€‚80386 æœ‰ç‹¬ç«‹çš„ 80387 FPUã€‚åœ¨ 80486 ä¸­ï¼Œè¿™äº›è¢«é›†æˆåˆ°äº†ç³»ç»Ÿä¸­ï¼Œå³ x87 FPUã€‚å®é™…ä¸Šï¼ŒFPU å’Œ SIMD å¾ˆå¤šå¤„ç†çš„é€»è¾‘ç±»ä¼¼ï¼Œä¸€å®šç¨‹åº¦ä¸Šï¼Œå®ƒä»¬æ˜¯è¢«æ•´åˆåˆ°ä¸€èµ·çš„ã€‚</p><p>x86-32 å¹³å°åœ¨ 93-95 å¹´æ¨å‡ºçš„ P5 microarchitecture ä¸­ï¼ŒMMX æŠ€æœ¯å‡ºç°ï¼Œå®ƒç”¨ 64-bits ä½å®½çš„å¯„å­˜å™¨æ¥åŒæ—¶å¤„ç†å¤šä¸ªæ•´æ•°ã€‚</p><p>åœ¨ P6 æ¶æ„çš„ Pentium Pro (1995) å’Œ Pentium II (1997) ä¸­ï¼ŒIntel å¼•å…¥äº† superscalarï¼Œdecode / dispatch / execute å¯ä»¥ä¹±åºæ‰§è¡Œã€‚Pentium æœ‰ä¸ªä½ å¯èƒ½å¾ˆç†Ÿæ‚‰çš„åå­—ï¼Œå«ã€Œå¥”è…¾ã€ã€‚</p><p>99 å¹´å¼•å…¥çš„ P6 æ¶æ„çš„ Pentium III ä¸­ï¼ŒSSEï¼ˆStreaming SIMD extensionsï¼‰ æŒ‡ä»¤é›†è¢«å¼•å…¥äº†ï¼Œå®ƒåŠ å…¥äº†ä¸€ç»„ 128bits çš„å¯„å­˜å™¨ï¼Œå¯ä»¥è¿›è¡Œ SIMD çš„å•ç²¾åº¦æµ®ç‚¹è¿ç®—.</p><p>ä¸€å¹´åï¼Œ2000 å¹´ï¼ŒIntel æ¨å‡ºäº† Netburst æ¶æ„ï¼Œå¹¶å¼•å…¥äº† SSE2ï¼Œå®ƒè¡¥å…¨äº† SSE å¤„ç†åŒç²¾åº¦æµ®ç‚¹æ•°çš„èƒ½åŠ›ï¼ŒåŒæ—¶ï¼Œå®ƒåœ¨ SSE å¼•å…¥çš„å¯„å­˜å™¨ä¸Šè¡¥é½äº†æ•´æ•°è¿ç®—çš„èƒ½åŠ›ã€‚04 å¹´ï¼ŒSSE3 æ¨å‡ºï¼Œå¹¶è¿è¡Œåœ¨åˆ¶ç¨‹ 90nm çš„ Pentium å’Œ Xeon æ¶æ„ä¸Šï¼Œè¿™ä¸€ä»£æ¶æ„æœ‰ hyper-threading. 06å¹´æ¨å‡ºçš„ Core æ¶æ„ï¼ˆé…·ç¿ï¼‰åšäº†ä¸å°‘ä¼˜åŒ–ã€é™ä½äº†èƒ½è€—ï¼ŒåŒæ—¶å¼•å…¥äº† SSSE3 æŒ‡ä»¤é›†å’Œ SSE4.1ï¼Œä»–ä»¬æ²¡æœ‰å¼•å…¥æ–°çš„å¯„å­˜å™¨ï¼ŒåŒæ—¶ï¼Œhyper-threading ä¹Ÿè¢«å»é™¤äº†ã€‚2008 å¹´çš„ Nehalem å†æ¬¡å¼•å…¥äº† hyper-threadingï¼ŒåŒæ—¶ä¹Ÿå¼•å…¥äº† SSE æœ€åçš„ SSE4.2 æŒ‡ä»¤é›†ï¼Œè¿™ä¸ªæŒ‡ä»¤é›†æ‰©å±•äº† SSE å¯„å­˜å™¨ä¸Šçš„å­—ç¬¦ä¸²/æ–‡æœ¬å¤„ç†ã€‚</p><p>2011 å¹´ Intel æ¨å‡ºäº† Sandy Bridge æ¶æ„ï¼Œå®ƒå¼•å…¥äº† Advanced Vector Extensions (AVX) è¿™ä¸€ SIMD æŒ‡ä»¤é›†ï¼Œå®ƒç”¨ 256-bits çš„å¯„å­˜å™¨æ¥å¤„ç†æ•°æ®ï¼Œè¿™æå‡äº†å¯„å­˜å™¨çš„å®½åº¦ï¼Œä¸€å®šç¨‹åº¦ä¸Šå‡å°äº†å¼€é”€.</p><p>2013 å¹´ Intel æ¨å‡ºäº† Haswell æ¶æ„ï¼ŒåŒæ—¶ï¼Œå®ƒå¼•å…¥äº† AVX2ï¼Œå®é™…ä¸Šï¼Œç°åœ¨æ¯”è¾ƒå¸¸ç”¨çš„ç¼–è¯‘å‚æ•°åŒ…å« <code>-mavx2 -march=haswell</code>ï¼ŒåŒæ—¶ï¼Œå®ƒæä¾›äº†ä¸€ç»„ data transfer ç›¸å…³çš„æŒ‡ä»¤ï¼š</p><ul><li>broadcast: æŠŠä¸€ä¸ªå€¼å¹¿æ’­åˆ°å¤šä¸ªä½ç½®</li><li>gather: æŠŠå¤šä¸ªä¸è¿ç»­ä½ç½®çš„å†…å­˜åŠ è½½</li><li>permute: ç»™å‡ºä¸€ç»„ index, æŒ‰ç…§ index æ¥åŠ è½½æ•°æ®</li></ul><p>Haswell è¿˜å¼•å…¥äº† FMA æ“ä½œï¼ŒFMA ä»£è¡¨ Fused Multiply-Add, eg:</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* matrix multiplication; A, B, C are n x n matrices of doubles */</span> </span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; n; i++)</span><br><span class="line">  <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; n; j++) </span><br><span class="line">    <span class="keyword">for</span> (k = <span class="number">0</span>; k &lt; n; k++) </span><br><span class="line">      C[i*n+j] += A[i*n+k]*B[k*n+j];</span><br></pre></td></tr></table></figure><p>è¿™ç§ <code>x = x + y * z</code> çš„æ“ä½œï¼Œåªä¼šèˆå…¥(rounding) ä¸€æ¬¡ã€‚</p><p>2017 å¹´ï¼ŒIntel çš„ Skylake-X ä¸­ï¼Œå¼•å…¥äº† AVX512ï¼Œä½¿ç”¨ 512-bits çš„å¯„å­˜å™¨ã€‚</p><p>ä½œä¸º Intel ä¹‹å¤–æœ€å¤§çš„ x86 å‚å•†ï¼ŒAMD ä¹Ÿå¯¹ SIMD è¿›è¡Œè¿‡æ”¯æŒï¼Œ zen æ¶æ„æ”¯æŒäº† AVX2ï¼Œè€Œä¹‹å‰çš„ K8 æ¶æ„æ”¯æŒäº† MMXã€SSEã€SSE2ã€SSE3ï¼ŒAMD å¼•å…¥äº† SSE4a å’Œ FMA4 ç­‰ Intel ä¸å¤ªæ”¯æŒçš„æŒ‡ä»¤é›†ã€‚</p><p>åœ¨ ARM èŠ¯ç‰‡ä¸Šï¼Œä¹Ÿå­˜åœ¨ SIMD æŒ‡ä»¤é›†ã€‚NEON æœ‰ 128-bit çš„å¯„å­˜å™¨ã€‚æ­¤å¤–è¿˜æœ‰ NEON64 ç­‰æŒ‡ä»¤é›†ã€‚</p><p>åœ¨ RISC-V ä¸Šï¼Œ<a href="https://github.com/riscv/riscv-v-spec">Vector</a> æ‰©å±•å‰å‡ ä¸ªæœˆåˆšåˆš stableï¼Œä¸è¿‡ç¼–è¯‘å™¨è¿˜æœ‰ä¸€äº› instrinct æ²¡æœ‰å®šä¸‹æ¥ï¼Œæœ‰å¾…å¤šæ–¹ç»§ç»­æ¨è¿›ã€‚</p><h2 id="Intel-and-Skylake"><a href="#Intel-and-Skylake" class="headerlink" title="Intel and Skylake"></a>Intel and Skylake</h2><p>Intel æœºå™¨æ‰§è¡ŒæŒ‡ä»¤çš„æ—¶å€™ï¼Œå¤§è‡´é€»è¾‘å¦‚ä¸‹ï¼š</p><p><img src="https://image.mwish.me/blog-image/02878185-F1E5-4D59-850D-1D898DE7B4CD.png" alt="02878185-F1E5-4D59-850D-1D898DE7B4CD"></p><p>è¿™æ˜¯ä¸€ä¸ª Superscalar çš„æ¨¡å‹ï¼Œè¿™é‡Œå¯ä»¥å‚è€ƒæˆ‘ä»¬ä¹‹å‰çš„ notes:</p><p><a href="https://blog.mwish.me/2020/10/21/SDS-Intro-RISC-V-Datapath-4-Pipeline/#Multiple-issue-%E2%80%9CSuperscalar%E2%80%9D">https://blog.mwish.me/2020/10/21/SDS-Intro-RISC-V-Datapath-4-Pipeline/#Multiple-issue-%E2%80%9CSuperscalar%E2%80%9D</a></p><p>è¿™é‡Œï¼ŒæŒ‡ä»¤è¢«è§£ç åï¼Œä½ ä¼šçœ‹åˆ°ä¸€ç»„ portsï¼Œæ¥å¸®åŠ©è¿›è¡Œç¨‹åºçš„æ‰§è¡Œ</p><p><img src="https://image.mwish.me/blog-image/EE09112C-4AB4-44EC-8BBD-DC9A51B04448.png" alt="EE09112C-4AB4-44EC-8BBD-DC9A51B04448"></p><p>å¯ä»¥å›é¡¾ä¸€ä¸‹ä¹‹å‰ notes é‡Œé¢ OoO çš„å›¾ï¼Œè¿™é‡Œåˆä¸€äº› SIMD/fp ç­‰çš„æ‰§è¡Œå•å…ƒã€‚</p><p>æ¯æ¡æŒ‡ä»¤æ‰§è¡Œçš„æ•ˆç‡æ˜¯ä¸ä¸€æ ·çš„ï¼ŒåŒæ—¶å¦‚ä¸Šå›¾ï¼Œfp fmaã€SIMD log å¯èƒ½æœ‰å¤šä¸ªæ‰§è¡Œå•å…ƒï¼Œè¿™ä¸ä¼šå½±å“å»¶è¿Ÿï¼Œä½†ä¼šå½±å“ååï¼š</p><p><img src="https://image.mwish.me/blog-image/3A279C0B-9D87-498A-9B44-9649281E2475.png" alt="3A279C0B-9D87-498A-9B44-9649281E2475"></p><p>å…³äºç›¸å…³æŒ‡ä»¤ï¼Œå¯ä»¥è®¿é—®ï¼š<a href="https://www.agner.org/optimize/instruction_tables.pdf">https://www.agner.org/optimize/instruction_tables.pdf</a></p><p>ä½ ä¹Ÿè®¸ä¼šå‘ç° div ç‰¹åˆ«æ…¢ï¼Œå¯ä»¥å‚è€ƒ ref 11 æ¥å­¦ä¹ ã€‚è¿™ä¸ªä¹Ÿå¯ä»¥è®¡ç®—å‡ºå„ä¸ªæŒ‡ä»¤çš„ flops/cycle</p><h2 id="è¡¡é‡åº”ç”¨-Besides-O-N"><a href="#è¡¡é‡åº”ç”¨-Besides-O-N" class="headerlink" title="è¡¡é‡åº”ç”¨: Besides O(N)"></a>è¡¡é‡åº”ç”¨: Besides O(N)</h2><p>complexity æ˜¯ç¨‹åºå‘˜éƒ½å¾ˆç†Ÿæ‚‰çš„ä¸œè¥¿ï¼Œæœ‰ä¸€ä¸ªå¾ˆå¥½çš„å…¥é—¨å›ç­”ï¼š</p><ul><li>ä¸ºä»€ä¹ˆæ—¶é—´å¤æ‚åº¦ä¸­å¯ä»¥å¿½ç•¥å¸¸æ•°? - ä¼Šè‰é›…SAMAçš„å›ç­” - çŸ¥ä¹ <a href="https://www.zhihu.com/question/361692674/answer/2635594762">https://www.zhihu.com/question/361692674/answer/2635594762</a></li></ul><p>è¿™é‡Œï¼Œç¨‹åºçš„åˆ†æå¯ä»¥å¼•å…¥å¯¹å†…å­˜ - è®¡ç®—çš„è®¿é—®ï¼ŒåŒºåˆ†æ“ä½œæ˜¯ memory bound è¿˜æ˜¯ compute bound:</p><p><img src="https://image.mwish.me/blog-image/CF950F53-1EA1-4CC7-B961-E8B11A7A8FB6.png" alt="CF950F53-1EA1-4CC7-B961-E8B11A7A8FB6"></p><p>å’Œ</p><p><img src="https://image.mwish.me/blog-image/999085C9-F9CB-42C3-A8FB-2BB92F4A60EB.png" alt="999085C9-F9CB-42C3-A8FB-2BB92F4A60EB"></p><p>æœ‰ä¸€ä¸ªå¾ˆæœ‰è¶£çš„ case åœ¨ ref 4:  <a href="https://stackoverflow.com/questions/18159455/why-vectorizing-the-loop-does-not-have-performance-improvement/18159503">https://stackoverflow.com/questions/18159455/why-vectorizing-the-loop-does-not-have-performance-improvement/18159503</a></p><h2 id="æŸ¥çœ‹ä½ çš„æœºå™¨"><a href="#æŸ¥çœ‹ä½ çš„æœºå™¨" class="headerlink" title="æŸ¥çœ‹ä½ çš„æœºå™¨"></a>æŸ¥çœ‹ä½ çš„æœºå™¨</h2><p>å­¦ä»¥è‡´ç”¨ï¼Œç¬”è€…æœ‰ä¸€å°æ­è½½äº† Apple M1 çš„ Mac å’Œ AMD 3800X èŠ¯ç‰‡çš„å°å¼æœºï¼Œå¯ä»¥çœ‹åˆ°ï¼Œä¸‹é¢å¯¹åº”çš„å‚æ•°ï¼š</p><ol><li><a href="https://en.wikichip.org/wiki/amd/ryzen_7/3800x">https://en.wikichip.org/wiki/amd/ryzen_7/3800x</a></li><li><a href="https://en.wikichip.org/wiki/apple/mx/m1">https://en.wikichip.org/wiki/apple/mx/m1</a></li></ol><h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><ol><li>Intel tick-tock: <a href="https://zh.wikipedia.org/wiki/Intel_Tick-Tock">https://zh.wikipedia.org/wiki/Intel_Tick-Tock</a></li><li>Mircoarch cheatsheet: <a href="https://github.com/akhin/microarchitecture-cheatsheet/">https://github.com/akhin/microarchitecture-cheatsheet/</a></li><li>Micro arch æœ‰å…³çš„åšå®¢: </li><li>ä¸€ä¸ªéå¸¸æœ‰è¶£çš„é—®é¢˜: <a href="https://stackoverflow.com/questions/18159455/why-vectorizing-the-loop-does-not-have-performance-improvement/18159503">https://stackoverflow.com/questions/18159455/why-vectorizing-the-loop-does-not-have-performance-improvement/18159503</a></li><li>x86 wiki: <a href="https://zh.wikipedia.org/wiki/X86">https://zh.wikipedia.org/wiki/X86</a></li><li>VLIW wiki: <a href="https://zh.wikipedia.org/wiki/%E8%B6%85%E9%95%BF%E6%8C%87%E4%BB%A4%E5%AD%97">https://zh.wikipedia.org/wiki/%E8%B6%85%E9%95%BF%E6%8C%87%E4%BB%A4%E5%AD%97</a></li><li>æŒ‡ä»¤çº§å¹¶è¡Œï¼Œçº¿ç¨‹çº§å¹¶è¡Œï¼Œæ•°æ®çº§å¹¶è¡ŒåŒºåˆ«ï¼Ÿçº¿ç¨‹çš„æ¦‚å¿µæ˜¯ä»€ä¹ˆï¼Ÿ - ç”¨å¿ƒé˜çš„å›ç­” - çŸ¥ä¹ <a href="https://www.zhihu.com/question/21823699/answer/172571488">https://www.zhihu.com/question/21823699/answer/172571488</a></li><li>FMA wiki: <a href="https://en.wikipedia.org/wiki/FMA_instruction_set">https://en.wikipedia.org/wiki/FMA_instruction_set</a></li><li>Intelâ€™s Haswell CPU Microarchitecture: <a href="https://www.realworldtech.com/haswell-cpu/">https://www.realworldtech.com/haswell-cpu/</a></li><li>Instruction table: <a href="https://www.agner.org/optimize/instruction_tables.pdf">https://www.agner.org/optimize/instruction_tables.pdf</a></li><li>Div: <a href="https://stackoverflow.com/questions/26907523/branch-alignment-for-loops-involving-micro-coded-instructions-on-intel-snb-famil">https://stackoverflow.com/questions/26907523/branch-alignment-for-loops-involving-micro-coded-instructions-on-intel-snb-famil</a>  å’Œ <a href="https://stackoverflow.com/questions/4125033/floating-point-division-vs-floating-point-multiplication">https://stackoverflow.com/questions/4125033/floating-point-division-vs-floating-point-multiplication</a></li></ol>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Kudu: Storage for Fast Analytics on Fast Data</title>
      <link href="/2022/10/30/Kudu-Storage-for-Fast-Analytics-on-Fast-Data/"/>
      <url>/2022/10/30/Kudu-Storage-for-Fast-Analytics-on-Fast-Data/</url>
      
        <content type="html"><![CDATA[<p>Kudu æ˜¯ä¸€ä¸ªå£°ç§°ã€Œæ—¢èƒ½å¿«é€Ÿæ›´æ–°ã€åˆèƒ½å¿«é€ŸæŸ¥è¯¢ã€çš„åˆ†å¸ƒå¼å­˜å‚¨ã€‚å®ƒç”± Cloudera å¼€å‘ï¼Œä½œä¸º Hadoop ç”Ÿæ€ä¸­å­˜å‚¨çš„æ›¿ä»£å“ï¼Œå¹¶åœ¨ 2013 å¹´å¼€æºã€‚Cloudera ä½¿ç”¨äº† Impala + Kudu çš„æ¶æ„æ¥ä½œä¸ºä¸€äº›æ›¿ä»£ï¼ˆ Impala å¯ä»¥è§†ä½œ Presto ç±»ä¼¼çš„äº§å“ï¼Œæ”¯æŒåœ¨ HDFS/Hive ä¸Šåšé«˜æ•ˆçš„æŸ¥è¯¢ï¼Œå›½å†…çš„ Apache Doris ä¹Ÿæ˜¯æ—©æœŸä» Impala fork è¿‡æ¥çš„ï¼‰ã€‚</p><p>Tips: Kudu å’Œ Impala éƒ½æ˜¯ç¾Šï¼ŒKudu æ˜¯ ã€Œæ»è§’ç¾šã€ï¼ŒImpala æ˜¯å°ä¸€äº›çš„é»‘æ–‘ç¾šã€‚</p><p>Kudu çš„æ¨¡å‹ä»¥ Primary Key ä¸ºä¸»ï¼Œç±»ä¼¼ StarRocks çš„ä¸»é”®æ¨¡å‹ã€‚ä¹‹åæˆ‘ä»¬ä¹Ÿä¼šä»‹ç»ï¼Œä¸æŒ‰ Primary Key æŸ¥è¯¢çš„æ—¶å€™ï¼ŒKudu çš„æ€§èƒ½ä¼šå…‰é€Ÿæ‹‰èƒ¯ã€‚è®ºæ–‡å†™äº 2015 å¹´ï¼Œç›¸å¯¹äº Presto è¿™ç§åŒæ · 2013 å·¦å³æ”¾å‡ºæ¥ï¼Œä½†æ˜¯ 2019 å¹´æ‰å‘è¡¨è®ºæ–‡çš„ç³»ç»Ÿè€Œè¨€ï¼ŒKudu å¾ˆå¤šåœ°æ–¹æ˜¾å¾—æ²¡æœ‰é‚£ä¹ˆè¯¦å°½ã€‚å¾ˆå¤šåœ°æ–¹ç¿»ä¸€äº›å·¥ä¸šç•Œä½¿ç”¨è€…çš„ blog ä¹Ÿèƒ½å‘ç°ä¸€äº›é—®é¢˜ã€‚ä¸è¿‡ Kudu ä½¿ç”¨å¥½åƒç›¸å¯¹å°‘ä¸€äº›ï¼Œå›½å†…çœ‹åˆ°ç½‘æ˜“åº”è¯¥æœ‰äººç”¨ã€‚</p><p>Kudu ä½¿ç”¨çš„è¿˜æ˜¯ shared-nothing çš„å¤„ç†æ–¹å¼ï¼ŒåŒæ—¶ï¼ŒKudu çš„æ–‡ä»¶å†™å…¥ä¹‹åä¹Ÿæ˜¯ä¸å¯æ›´æ–°çš„ã€‚Base + Delta çš„æ–¹å¼è¢«é‡‡ç”¨ä»¥å¤„ç†è¿™ä¸ªæ¨¡å‹ã€‚Kudu Delta å¤„ç†çš„æ–¹å¼ç›¸å¯¹æ¥è¯´æœ‰ç‚¹ç±»ä¼¼ Position Delta Treeã€‚é˜…è¯» Kudu è®ºæ–‡ï¼Œæˆ‘è®¤ä¸ºåº”è¯¥ä¸»è¦å…³æ³¨ã€ŒTablet å­˜å‚¨ã€çš„éƒ¨åˆ†ï¼Œå…¶ä»–éƒ¨åˆ†æœ‰çš„ä¸æ˜¯å¾ˆé‡è¦ï¼Œæœ‰çš„æˆ‘ç”šè‡³è®¤ä¸ºéå¸¸è‰å°ã€‚</p><p>Cloudera å½“æ—¶å¸Œæœ›çš„ workload æ˜¯ï¼š</p><ol><li>éœ€è¦æœ‰ streaming ingest çš„æ•°æ®ç®¡çº¿ï¼ŒåŒæ—¶æ”¯æŒä¸€äº› updates</li><li>æœ‰ä¸€äº›å®šæ—¶ä½œä¸šæ¥åˆ†æ</li><li>é«˜ååçš„å­˜å‚¨</li><li>low-latency random access</li></ol><p><img src="https://image.mwish.me/blog-image/v2-86f0de0018e144b5d5b7335dc5002e75_r.jpeg" alt="v2-86f0de0018e144b5d5b7335dc5002e75_r"></p><p>Kudu æä¾›äº†å¯¹åº”çš„ api:</p><ol><li>Row-level inserts / updates / deletes</li><li>Table Scan</li></ol><p>Kudu å†…éƒ¨ä½¿ç”¨ <code>Cfile</code> æ ¼å¼å­˜å‚¨æ–‡ä»¶ã€‚è¿™æ˜¯ Kudu ç»™è‡ªå·±æçš„é€‚åˆè‡ªå·±çš„åˆ—å­˜æ–‡ä»¶æ ¼å¼ã€‚</p><p>ä¸‹é¢æ˜¯è®ºæ–‡çš„éƒ¨åˆ†ï¼Œåœ¨é˜…è¯»çš„æ—¶å€™ï¼Œæˆ‘ä¼šå°½é‡ä»¥è®ºæ–‡ä¸ºä¸»è½´ï¼Œä½†æ˜¯å‚è€ƒ Kudu æœ€æ–°çš„å®ç°ã€‚</p><h2 id="Concepts"><a href="#Concepts" class="headerlink" title="Concepts"></a>Concepts</h2><p>Table: æœ‰å®šä¹‰å¥½ Schema çš„æ ¼å¼çš„è¡¨ï¼Œä¸€ä¸ª subset çš„å­—æ®µä¼šè¢«å®šä¹‰ä¸º primary keyã€‚primary key æ¨¡å‹ä¸Šå¿…é¡»æ˜¯ unique çš„ï¼Œå¯¹ primary key çš„åˆ é™¤è¢«å®šä¹‰ä¸ºå¿«é€Ÿçš„æ“ä½œï¼Œå¦åˆ™å¯èƒ½ä¼šæ‰«å…¨è¡¨ï¼Œå› ä¸ºå®ƒä¸æ”¯æŒ secondary indexã€‚</p><p>Schema ä¸­ï¼Œå¯ä»¥è§†ä½œ <code>&lt;varchar: T&gt;</code> çš„æ˜ å°„ï¼ŒKudu ä¼¼ä¹ä¸æ”¯æŒåµŒå¥—ç»“æ„ï¼Œå¦‚æœæœ‰åµŒå¥—çš„ç»“æ„ï¼Œåº”è¯¥æŠŠè¿™éƒ¨åˆ†å†…å®¹å±•å¼€ã€‚å…³äº Kudu çš„ç±»å‹å¯ä»¥å‚è€ƒï¼š<a href="https://kudu.apache.org/docs/schema_design.html#column-design">https://kudu.apache.org/docs/schema_design.html#column-design</a></p><p>å…³äº DDLï¼ŒKudu æ”¯æŒä¸€äº›åŸºæœ¬çš„ schema changeï¼Œåœ¨ç”¨æˆ·å±‚é¢éœ€è¦æ‰§è¡Œ alter tableï¼ŒKudu ä¼šç»™æ¯ä¸ª column ç»´æŠ¤ä¸€ä¸ª idï¼ŒåŒæ—¶ Primary Key æ˜¯ä¸èƒ½å˜æ›´çš„ã€‚è¿™é‡Œ Kudu çš„ Schema Change ç³»ç»Ÿæ„Ÿè§‰è¿˜æ˜¯æ¯”è¾ƒç®€é™‹çš„ï¼Œæ„Ÿè§‰ç±»å‹æå‡ä»€ä¹ˆçš„æ”¯æŒéƒ½ä¸æ˜¯å¾ˆå¥½ï¼Œnested ä¹Ÿä¸å¤ªæ”¯æŒï¼Œä»¤äººå”å˜˜ã€‚ä¸è¿‡ï¼ŒåŒå…¶ä»–åˆ—å­˜ç³»ç»Ÿä¸€æ ·ï¼ŒKudu å¯¹åˆ—ä¹Ÿä¼šåšä¸€äº› encodingï¼Œæ¥æå‡å¯¹åº”çš„å‹ç¼©ç‡ã€‚</p><p>å¯¹äºå†™æ¥è¯´ï¼ŒKudu å‰å°å¯ä»¥ç”¨å¯¹ pk çš„ <code>Insert</code>, <code>Delete</code>, <code>Update</code> å‡ ç§ APIã€‚è®ºæ–‡æˆæ–‡çš„æ—¶å€™ï¼Œç³»ç»Ÿå°šæœªæ”¯æŒåˆ†å¸ƒå¼äº‹åŠ¡ï¼Œåªèƒ½åœ¨å•ä¸ª <code>Tablet</code> å†…æ‰§è¡Œäº‹åŠ¡ï¼ˆå¯ä»¥æ”¯æŒå•è¡Œäº‹åŠ¡ï¼‰ã€‚ç›®å‰ Kudu å·²ç»æ”¯æŒåˆ†å¸ƒå¼äº‹åŠ¡ï¼Œä¸è¿‡æ”¯æŒçš„å¥½ä¸å¥½å¦è¯´ã€‚</p><p>Kudu æœ‰ä¸€ä¸ª HLC æ—¶é—´æˆ³ç³»ç»Ÿï¼Œå‚è€ƒäº†æ–‡ç« ï¼š</p><p>å®ƒçš„å†™æœ‰ä¸¤ç§æ¨¡å¼ï¼š</p><ol><li><code>CLIENT_PROPAGATED</code> Consistency: æ²¡å•¥åŒæ­¥ï¼Œclient ç”Ÿæˆæ—¶é—´æˆ³åšäº‹åŠ¡</li><li><code>COMMIT_WAIT</code> : ä¼šåšåŒæ­¥ï¼Œå®ƒå£°ç§°è‡ªå·±åšåˆ°äº†å¤–éƒ¨ä¸€è‡´æ€§ã€‚è¿™æ˜¯ä¸€ä¸ªå®éªŒæ€§åŠŸèƒ½ï¼Œä¸é¼“åŠ±åœ¨ç”Ÿäº§ç¯å¢ƒæ‰“å¼€ï¼ŒåŒæ—¶ï¼Œå¤š tablets äº‹åŠ¡ç›®å‰åªæ”¯æŒ rcï¼Œç„¶åå•ä¸ª tablet åªæ”¯æŒä¸€ä¸ªäº‹åŠ¡ã€‚</li></ol><p>è€Œè¯»ä¹Ÿæœ‰ä¸åŒçš„æ¨¡å¼ï¼š</p><ol><li><code>READ_LATEST</code></li><li><code>REAT_AT_SNAPSHOT</code></li><li><code>READ_YOUR_WRITES</code></li></ol><p>kudu åœ¨è¯»çš„æ—¶å€™æ”¯æŒ Scan / Projection / Filterã€‚</p><p>Kudu å¯ä»¥ç”¨ HLC ç”Ÿæˆå†…éƒ¨çš„æ—¶é—´ï¼Œä½†ä¹Ÿå…è®¸ç”¨æˆ·è‡ªå·±å†™æ—¶é—´ç„¶åç»™ä¸€ä¸ªæ—¶é—´æŸ¥è¯¢ã€‚</p><h2 id="Architecture"><a href="#Architecture" class="headerlink" title="Architecture"></a>Architecture</h2><p><img src="https://image.mwish.me/blog-image/BFA1827EA0FEB0E7FB3E455EB07D2502.jpg" alt="BFA1827EA0FEB0E7FB3E455EB07D2502"></p><p><img src="https://image.mwish.me/blog-image/23BFF20A-4E90-4062-8248-38F9C0A416CA.png" alt="23BFF20A-4E90-4062-8248-38F9C0A416CA"></p><p>å…¶å®ä¸Šé¢çš„æ¶æ„æœ‰ç‚¹ç±»ä¼¼ HBaseï¼Œä¸åŒçš„æ˜¯ï¼Œè¿™é‡Œè¿˜æ˜¯èµ°äº† Raft è€Œä¸æ˜¯ ZK æ¥ç®¡ç†é›†ç¾¤ã€‚è§ï¼š<a href="https://github.com/apache/kudu/tree/master/src/kudu/consensus">https://github.com/apache/kudu/tree/master/src/kudu/consensus</a> ã€‚èµ° Raft ç®¡ç†æ„Ÿè§‰æ€§èƒ½å®¹æ˜“æ‹‰ï¼Œä½†æ˜¯ç›¸å¯¹æ¥è¯´èƒ½å†™çš„æ¯”è¾ƒç®€å•ï¼Œè€Œä¸”ä¾èµ–ä¹Ÿå°‘äº†ã€‚</p><p>å½“ç„¶ï¼Œå¦‚æœéœ€è¦æŠŠ Kudu æš´éœ²ç»™ Impala æˆ–è€…ç»™å¤–éƒ¨æŸ¥è¯¢ï¼Œå¯èƒ½è¿™é‡Œä¼šéœ€è¦ Hive Metastore æ¥æš´éœ²è¿™äº›æ•°æ®ã€‚</p><p>Master èŠ‚ç‚¹è¿è¡Œçš„ä¹Ÿæ˜¯ tabletã€‚å’Œå­˜å‚¨æ•°æ®çš„èŠ‚ç‚¹è·‘ç€åŒä¸€å¥—ä»£ç ï¼Œä½†å»ºè®®è¿˜æ˜¯è·‘åœ¨æ›´å¥½çš„æœåŠ¡å™¨ä¸Šã€‚</p><p>å¯¹äº Tablet æœåŠ¡å™¨ï¼Œä¹‹å‰æœ‰ä¸€äº›é…ç½®ä¸Šçš„å»ºè®®ï¼š</p><ol><li>ä¸ºäº†è·å¾—å¯¹å¤§äº‹å®è¡¨çš„æœ€ä¼˜æ‰«ææ€§èƒ½ï¼Œå»ºè®®ä¿æŒä¸€ä¸ªtabletå¯¹åº”ä¸€ä¸ªCPUæ ¸çš„æ¯”ä¾‹ã€‚ä¸è¦å°†è¢«å¤åˆ¶çš„è¡¨è®¡ç®—åœ¨å†…ï¼Œåº”è¯¥åªè€ƒè™‘Leader tabletçš„æ•°é‡ã€‚å¯¹äºå°ç»´åº¦çš„è¡¨ï¼Œå¯ä»¥åªåˆ†é…å‡ ä¸ªtablet</li><li>å»ºè®®æ¯ä¸ª tablet æœ€å¤šåŒ…å« 2000ä¸ª tabletsï¼Œè®ºæ–‡ä¸­æ¨èæ¯å°æœºå™¨ 10-100 ä¸ª tabletsï¼Œæˆ‘ä¼°æ‘¸ç€å¯ä»¥æŒ‰ç…§ CPU å’Œ Disk æ•°é‡æ‹</li></ol><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒKudu çš„ WAL æ˜¯ Tablet çº§åˆ«çš„ï¼ˆä½œä¸ºå¯¹æ¯”ï¼Œå†™åœ¨ HDFS ä¸Šçš„ HBase æœ€åˆæ˜¯ä¸€æ¡ WAL æµï¼Œç„¶åè¢«å°ç±³æ‰©å±•åˆ°å¤šæ¡ï¼‰ã€‚ç›¸å¯¹è€Œè¨€ï¼ŒKudu Tablet é—´æ¢å¤å¯èƒ½æ¯”è¾ƒç‹¬ç«‹ï¼Œä½†æ˜¯ä¼°è®¡ IO çš„ admission control ä¼šç›¸å¯¹å¤æ‚ä¸€äº›ã€‚</p><h3 id="Partition"><a href="#Partition" class="headerlink" title="Partition"></a>Partition</h3><p>Kudu çš„ Partition å±äº ã€Œæ²¡å•¥æ„æ€ä½†æ˜¯å¾ˆå®ç”¨ã€çš„ç±»å‹ï¼Œå®ƒé¦–å…ˆä¼šæŒ‰ç…§ Primary key æ¥åˆ† partition åˆ°ä¸åŒ tablets ä¸Šã€‚å®ƒæä¾›äº†ä¸€ç§ hash - range æ··åˆçš„ Partition ç­–ç•¥:</p><ol><li>Range partition</li><li>hash partition</li><li>multilevel partition</li></ol><p>æœ¬è´¨ä¸Šï¼Œå…¶å® Kudu æŠ½è±¡æ¯”è¾ƒç®€å•ï¼Œç”¨æˆ·å¯ä»¥æƒ³è±¡æˆï¼š</p><ol><li>èµ°ä¸€åˆ°å‡ ç»„ä¸åŒçš„ hash</li><li>ç„¶åå¯¹ hash åçš„ binary è¿›è¡Œ range åˆ†ç‰‡</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ç”¨æˆ·æŒ‡å®šä¸€ä¸ª fn, æŠŠ pk åˆ— (pk1, pk2, ...) æ˜ å°„åˆ°ä¸€ä¸ª binary</span><br></pre></td></tr></table></figure><h4 id="Range-Partition"><a href="#Range-Partition" class="headerlink" title="Range Partition"></a>Range Partition</h4><p>å¯¹äº range partitionï¼Œä¾‹å­å¦‚ä¸‹ï¼š</p><p><img src="https://image.mwish.me/blog-image/range-partitioning-example.png" alt="range-partitioning-example"></p><p>ä½¿ç”¨çš„æ—¶å€™ï¼Œä¹Ÿå¯ä»¥å‚è€ƒ sample: <a href="https://docs.cloudera.com/cdp-private-cloud-base/7.1.6/impala-reference/topics/impala-kudu-partitioning.html#pnavId2">https://docs.cloudera.com/cdp-private-cloud-base/7.1.6/impala-reference/topics/impala-kudu-partitioning.html#pnavId2</a></p><p>Kudu ä¹Ÿå…è®¸åŠ¨æ€æ’å…¥ Range Partitionã€‚</p><h4 id="Hash-Partition"><a href="#Hash-Partition" class="headerlink" title="Hash Partition"></a>Hash Partition</h4><p>Hash Partition ä¼šæŠŠè¡Œåˆ†é…åˆ° bucket ä¸­ï¼Œå¦‚ä¸‹å›¾ï¼š</p><p><img src="https://image.mwish.me/blog-image/hash-partitioning-example.png" alt="hash-partitioning-example"></p><p>è¿™é‡Œå¯ä»¥æŒ‡å®š <code>PARTITION BY HASH(...) PARTITIONS 50</code> è¿™æ ·ã€‚</p><h4 id="Multi"><a href="#Multi" class="headerlink" title="Multi"></a>Multi</h4><p><img src="https://image.mwish.me/blog-image/1DE6DE48-5A42-48A2-81FE-2443BB0367CA.png" alt="1DE6DE48-5A42-48A2-81FE-2443BB0367CA"></p><p>è¿™é‡Œï¼Œå¯ä»¥æŒ‰ç…§æ‰‹åŠ¨æŒ‡å®š range + hash æˆ–è€… hash + hash åšåˆ†ç‰‡ï¼š</p><p><img src="https://image.mwish.me/blog-image/hash-range-partitioning-example.png" alt="hash-range-partitioning-example"></p><p> ç›´è§‚çš„æ„Ÿå—è¿˜æ˜¯ï¼ŒTablet / Partition / Bucket è¿˜æ˜¯å®šçš„æ¯”è¾ƒæ­»çš„ï¼Œåœ¨ç½‘æ˜“çš„åšå®¢é‡Œè®¨è®ºè¿‡ï¼Œå½“æ•°æ®å¾ˆå°‘çš„æ—¶å€™ï¼ŒKudu ä¹Ÿä¼šæŒ‰ç…§ç»™å®šçš„ Bucket æ•°é‡å»åˆ†åŒºã€‚ç½‘æ˜“åœ¨ä»–ä»¬çš„åšå®¢é‡Œæåˆ°äº†è¿™ä¸ªé—®é¢˜ã€‚æ³¨æ„ï¼Œè™½ç„¶ä¸åŒ Partition çš„ bucket-id æ˜¯ç›¸åŒçš„ï¼Œä½†æ˜¯å®ƒä»¬å­˜å‚¨åœ¨ä¸åŒçš„ Tablet ä¸Šã€‚</p><p>Hash Parition æ–¹å¼ç±»ä¼¼é™æ€åˆ†ç‰‡ï¼Œä»ä»£ç å¯ä»¥çœ‹åˆ°ï¼š</p><ul><li><a href="https://github.com/apache/kudu/blob/77d3ea465bb1a1fa778cccd8432553032f51bd27/src/kudu/common/partition.cc#L1361-L1384">https://github.com/apache/kudu/blob/77d3ea465bb1a1fa778cccd8432553032f51bd27/src/kudu/common/partition.cc#L1361-L1384</a> </li><li><a href="https://github.com/apache/kudu/blob/77d3ea465bb1a1fa778cccd8432553032f51bd27/src/kudu/common/partition.h#L136">https://github.com/apache/kudu/blob/77d3ea465bb1a1fa778cccd8432553032f51bd27/src/kudu/common/partition.h#L136</a></li></ul><p>è¿™é‡Œé’ˆå¯¹ hash è®¾ç½®äº† rangeï¼Œç„¶åå¯¹æå‰åˆ‡åˆ†å¥½çš„ hash range æ¥åˆ†ç‰‡</p><p>Kudu çš„ Parition å¯ä»¥å¼•å…¥ä¸€äº› Pruning: <a href="https://github.com/apache/kudu/blob/master/docs/design-docs/scan-optimization-partition-pruning.md">https://github.com/apache/kudu/blob/master/docs/design-docs/scan-optimization-partition-pruning.md</a> . è¿™ä¸ª Pruning ç±»ä¼¼ä¸æŠŠ Task å‘ç»™è¢«è£å‰ªçš„ bucketã€‚</p><p>Partition è¿˜æœ‰ä¸€äº›å°é—®é¢˜ï¼Œå¯¹äº Kudu çš„çƒ­ç‚¹å†™ï¼Œå¦‚æœå†™çš„æ˜¯æŸä¸€ä¸ª Partitionï¼Œé‚£ä¹ˆ WAL èƒ½æ¯”è¾ƒå¥½çš„å¤„ç†ã€‚æœ‰ä¸€ç§ <code>backfill</code> çš„åœºæ™¯ï¼Œå³ scan æ•°æ®å›å¡«ï¼Œè¿™ç§åœºæ™¯å› ä¸ºä½ç¼“å­˜å‘½ä¸­ç‡ï¼Œæ‰€ä»¥æ€§èƒ½ä¼šæ¯”è¾ƒå·®ã€‚</p><h3 id="Replication"><a href="#Replication" class="headerlink" title="Replication"></a>Replication</h3><p>Kudu èµ°çš„æ˜¯ shared-nothing + Raft çš„æ¨¡å¼ï¼Œå…¶å®æˆ‘ä¸ç†è§£ä¸ºå•¥èµ° Raftâ€¦ Kudu Raft å®ç°åº”è¯¥æ¯”è¾ƒç®€å•ï¼Œå®ƒçš„ WAL èµ°çš„æ˜¯ Raftï¼Œå„å°æœºå™¨çš„çŠ¶æ€æœºå…è®¸ä¸ä¸€è‡´ã€‚</p><p>è™½ç„¶è¡¨é¢è¯´èµ°äº† Raftï¼Œä½†æ˜¯ Kudu å®é™…ä¸Šç±»ä¼¼ ZooKeeper çš„ A-linearizableï¼Œå†™çš„æ—¶å€™èµ° Raftï¼Œè¯»çš„æ—¶å€™å¯ä»¥æœ¬åœ°è¯»ã€‚ä¸çŸ¥é“å®ƒè¿™ä¸ªå’Œäº‹åŠ¡æ€ä¹ˆååŒè®¾è®¡çš„ï¼ˆç›´è§‚æ„Ÿå—å°±æ˜¯çœ‹è¿™ç©æ„ä¸å¦‚èŠ±æ—¶é—´å»æŠ˜è…¾ MongoDBï¼Œå› ä¸ºå®ƒè¿™å‡ æ–¹é¢çš„è®¾è®¡éƒ½éå¸¸è‰å°ï¼Œè®©æˆ‘ä»¬ä¸è¦æŠ˜ç£¨è‡ªå·±ï¼Œè·³è¿‡å®ƒä»¬å§ï¼‰ã€‚</p><p>ç›¸å¯¹æ¥è¯´ï¼ŒKudu çš„ Compaction æ˜¯ä¸ªæœ¬åœ°çš„ç¨‹åºï¼Œä¸æ¶‰åŠå…¨å±€çš„ Raftã€‚ä¼¼ä¹è¿™ä¸ªæ˜¯å„ä¸ªæœºå™¨è‡ªå·±å¤„ç†çš„ï¼š</p><blockquote><p>Kudu does not replicate the on-disk storage of a tablet, but rather just its operation log. The physical storage of each replica of a tablet is fully decoupled.</p></blockquote><p>æ¯”è¾ƒå‚»é€¼çš„æ˜¯ï¼Œåœ¨å®ƒçš„æ–‡æ¡£é‡Œï¼Œå¯¹ config changeï¼Œå®ƒè¿˜æ˜¯é å•æ­¥å˜æ›´å®ç°çš„â€¦é¢æˆ‘åªèƒ½è¯´ä»–å¼€å¿ƒå°±è¡Œï¼š<a href="https://github.com/apache/kudu/blob/master/docs/design-docs/raft-config-change.md">https://github.com/apache/kudu/blob/master/docs/design-docs/raft-config-change.md</a></p><h3 id="Kudu-Master"><a href="#Kudu-Master" class="headerlink" title="Kudu Master"></a>Kudu Master</h3><p>ä¹‹å‰è¯´åˆ°äº†ï¼ŒKudu çš„ Tablet ç”± Raft æ¥åŒæ­¥ WALï¼Œå› ä¸º Raft çš„å­˜åœ¨ï¼Œæ‰€ä»¥å…¶å® Tablet çš„åˆ†é…æ˜¯æ¯”è¾ƒé è°±çš„ï¼Œé›†ç¾¤èƒ½å¤Ÿä»è¿™é‡Œé¢å»ºç«‹å‡ºä¿¡æ¯ï¼ŒåŒæ—¶ç›¸å¯¹ HBase æ¥è¯´ï¼Œå°‘äº†å¤„ç† RIT çš„éº»çƒ¦ã€‚</p><p><img src="https://image.mwish.me/blog-image/B195D594-DC70-42BC-B5DC-237A192FBBA2.png" alt="B195D594-DC70-42BC-B5DC-237A192FBBA2"></p><p>è¿™é‡Œ master å¯ä»¥ï¼š</p><ol><li>ä½œä¸º tablet directory</li><li>å­˜å‚¨å…ƒæ•°æ®ï¼Œä½œä¸ºä¸€ä¸ª meta serviceï¼Œå¹¶å¤„ç† DDL ç­‰æ“ä½œ<ol><li>åœ¨åˆ›å»ºè¡¨çš„æ—¶å€™ï¼Œè¿™é‡Œä¼šå¼‚æ­¥çš„ pick TabletServer å» Assign Tablet</li><li>åœ¨åˆ é™¤è¡¨å’Œ DDL çš„æ—¶å€™ï¼Œè¿™é‡Œä¼šéœ€è¦è®©å­èŠ‚ç‚¹çŠ¶æ€å®Œæˆ</li><li>ç±»ä¼¼ HBaseï¼Œè¿™é‡Œçš„çŠ¶æ€æ¨è¿›æ˜¯å¹‚ç­‰çš„</li></ol></li><li>ç›‘æ§ tablet serverï¼Œé€‚å½“çš„è°ƒåº¦ tablets</li></ol><p>åœ¨å®ç°çš„æ—¶å€™ï¼Œå®ƒç±»ä¼¼ GFS Masterï¼ŒæŠŠç›®å½•ä¿¡æ¯å…¨éƒ¨ç¼“å­˜åœ¨å†…å­˜ä¸­ã€‚ç„¶åä¸åŒäº Tabletï¼Œè¯»åœ¨è¿™é‡Œä¸å¯ä»¥èµ° Replica å»åšä¸ä¸€è‡´çš„è¯»ã€‚</p><p>ä¸Šé¢è¯´åˆ°çš„éƒ¨åˆ†æˆ‘ä»¬å¯ä»¥è¿›è¡Œç¨å¾®ç»†è‡´ä¸€äº›çš„æè¿°ï¼ŒKudu çš„ Master ä¼šç»´æŠ¤æˆ <code>sys.catalog</code> è¡¨ã€‚å†™ã€è¯»ä¸¥æ ¼éµç…§ Raft çš„ syntaxã€‚è¿™é‡Œç»´æŠ¤äº†ä¸‹åˆ—çš„ä¿¡æ¯ï¼š</p><ol><li>[Table Id] -&gt; TableInfo</li><li>[Table Name] -&gt; TableInfo</li><li>[Tablet Id] -&gt; TabletInfo</li></ol><p>è€Œ TableInfo åˆ™åŒ…å«äº† [tablet-start-key] -&gt; TabletInfo çš„æœ‰åº key-range mappingã€‚</p><p>åˆ›å»ºå’Œåˆ é™¤è¡¨éƒ½è¢«è§†ä½œåŸå­çš„å¤šä¸ª stepï¼Œåˆ›å»ºåŒ…å« preparing, running ç­‰å¤šä¸ªçŠ¶æ€ï¼Œè¿™é‡Œä¼šå…ˆæ¨è¿› preparingï¼Œå†æ¨è writingï¼Œç„¶åè¿”å›ç»™ç”¨æˆ·ï¼Œç„¶åè¿™é‡Œä¸ä¼šåˆ›å»º tabletsã€‚ç›´åˆ° <strong>Table Assignment</strong> é˜¶æ®µæ‰ä¼šåˆ é™¤</p><p>å¯¹äºåˆ è¡¨ï¼Œæƒ…å†µä¹Ÿå·®ä¸å¤šï¼Œè¿™é‡Œä¼šå¯¹è¡¨æ ‡è®° â€œdeletedâ€ï¼Œç„¶åå¯¹è¡¨å‘é€çš„è¯·æ±‚å°†å¤±è´¥ã€‚ä½†æ˜¯ Tablet ä¼šèµ° DeleteTablet è¯·æ±‚å¼‚æ­¥çš„è¿›è¡Œåˆ é™¤ã€‚</p><p>åœ¨ Table Assignment é˜¶æ®µï¼Œè¿™é‡Œä¼šæŒ‘é€‰æœºå™¨ï¼Œç„¶åå‘é€ CreateTablet è¯·æ±‚ï¼Œå¹¶å¸¦æœ‰ä¸€ä¸ªè¶…æ—¶ã€‚<code>CatalogManagerBgTasks</code> ä¼šç›‘å¬ä¿¡æ¯ï¼Œå¦‚æœè¿”å›äº†å¯¹åº”çš„å¿ƒè·³ï¼Œé‚£ä¹ˆ Tablet åˆ›å»ºæˆåŠŸï¼Œå¦åˆ™éœ€è¦æŒ‘é€‰å¦ä¸€ä¸ª Tablet Server äº†ã€‚</p><p><code>CatalogManagerBgTasks</code> æ˜¯ä¸€ä¸ªå¾ˆé‡è¦çš„çº¿ç¨‹ï¼Œå®ƒä¼šç»´æŠ¤å¿ƒè·³ï¼Œç„¶åæ ¹æ®å¿ƒè·³æ¥ï¼š</p><ol><li>æŠŠå¾ˆä¹…æ²¡å‘å¿ƒè·³çš„ tablet åˆ‡æˆ replaced çŠ¶æ€</li><li>ç»™æ¯åˆ›å»ºçš„ tablet æŒ‘é€‰çŠ¶æ€ï¼Œå¯åŠ¨ leaderï¼Œç„¶åå¯åŠ¨å®ƒä»¬</li><li>ç§»åŠ¨åˆ æ‰äº†çš„ tablets</li></ol><p>Tablet çš„æ•…éšœæ¢å¤ä¾èµ– Raftï¼Œé™¤æ­¤ä¹‹å¤–ï¼Œè¿™é‡Œè¿˜æœ‰ä¸ªç±»ä¼¼ DNS çš„æœåŠ¡ï¼Œå½“æ‹‰èµ·æ–°çš„ master çš„æ—¶å€™ï¼Œéœ€è¦è®© leader æŒ‡å‘åŒä¸€ä¸ª DNS CNAMEã€‚</p><p>Master è¿˜è´Ÿè´£å½“ Tablet Directoryï¼Œclient çš„ç¼“å­˜æœ‰å¯èƒ½æ˜¯æ—§çš„ï¼Œè¿™é‡Œæ²¡è®²è¿°æœ‰æ²¡æœ‰ epoch æ¥ç»´æŠ¤è¿™äº›ä¿¡æ¯ã€‚åªæ˜¯è¯´ï¼Œå‘åˆ°çš„ä¸æ˜¯ tablet master çš„è¯ï¼Œä¼šé‡æ–°è®¿é—® Masterã€‚</p><h2 id="Tablet-Storage"><a href="#Tablet-Storage" class="headerlink" title="Tablet Storage"></a>Tablet Storage</h2><p>tablet storage æ˜¯ Kudu æœ€é‡è¦çš„ä¸€éƒ¨åˆ†ï¼Œå› ä¸ºâ€¦è¿™æ˜¯æœ‰è‡ªå·±ä¸œè¥¿çš„ä¸€éƒ¨åˆ†ï¼Œä½ çœ‹å‰é¢çš„å†…å®¹ä¸æ˜¯çƒ‚å¤§è¡—çš„å—ï¼ˆç¬‘ï¼‰ï¼ˆå½“ç„¶è¦åšå¥½ä¹Ÿè¦ä¸€ç•ªåŠŸå¤«ï¼‰ã€‚Tablet Storage æ˜¯ Kudu æ¯”è¾ƒç‹¬ç‰¹çš„ä¸€éƒ¨åˆ†ï¼Œå®ƒå¯ä»¥è¢«è§†ä¸ºä¸€ä¸ªå•æœºçš„å¼•æ“ï¼Œå› ä¸ºæ„Ÿè§‰é™¤äº† WALï¼Œä¸æ˜¯å¾ˆ Care åˆ†å¸ƒå¼çš„é‚£å †é€»è¾‘ã€‚</p><p>çœ‹ Tablet Storage çš„æ—¶å€™ï¼Œéœ€è¦æ³¨æ„è¿™ä¸ªæ¨¡å‹è¿˜æ˜¯æœ‰é™åˆ¶çš„ï¼ŒPrimary Key åœ¨å…¶ä¸­å æœ‰éå¸¸é‡è¦çš„åœ°ä½</p><p>Tablet Storage æ˜¯æ¯ä¸ª Table ä¸‹çš„æ¯ä¸ª Tablet ä¸€ä»½çš„ã€‚ä¸»è¦æ”¯æŒï¼š</p><ol><li>Fast Columnar Scans: è¿™é‡Œå®ç°äº† CFileï¼Œè‡ªå·±çš„åˆ—å­˜æ ¼å¼ï¼Œç„¶åå¼•å…¥äº† bitshuffle ç­‰ encoding æ–¹å¼æ¥åšç¼–ç </li><li>Random Updates: å¯¹ primary key èƒ½å¤Ÿå¿«é€Ÿæ›´æ–°ï¼Œrandom access å¸Œæœ›æœ‰ $O(lg n)$ çš„ complexity</li></ol><p><img src="https://image.mwish.me/blog-image/E9F57C87-0442-42C1-8F8B-620615781030.png" alt="E9F57C87-0442-42C1-8F8B-620615781030"></p><p>ç±»ä¼¼ LSM Treeï¼ŒKudu ç»„ç»‡äº† RowSets:</p><ol><li>MemRowSets: åœ¨å†…å­˜é‡Œçš„ RowSets</li><li>DiskRowSets: ç›˜ä¸Šçš„ RowSets</li></ol><p>MemRowSets é‡‡ç”¨äº†ä¸€ä¸ª MVCC çš„ B-tree å®ç°ï¼Œå‚è€ƒäº† MassTreeï¼Œå…·ä½“å®ç°äºï¼š<a href="https://github.com/apache/kudu/blob/master/src/kudu/tablet/concurrent_btree.h">https://github.com/apache/kudu/blob/master/src/kudu/tablet/concurrent_btree.h</a></p><p>å…¶å®è¿™ä¸ªå®ç°æœ‰ç‚¹ç±»ä¼¼ SkipListï¼ŒåŸºæœ¬ä¸Šä¹Ÿæ˜¯ append ä½œä¸ºå†™ã€‚ç„¶åéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œåˆ©ç”¨äº† SIMD å’Œ JIT åŠ é€Ÿï¼ˆæˆ–è®¸ç±»ä¼¼ ART ï¼‰ï¼Œç„¶å MemRowSets æ˜¯ä¸€ä¸ªè¡Œå­˜ã€‚</p><blockquote><p>NOTE: other systems such as C-Store call the MemRowSet the â€œwrite optimized storeâ€ (WOS), and the on-disk files the â€œread-optimized storeâ€ (ROS).</p></blockquote><h3 id="DiskRowSet"><a href="#DiskRowSet" class="headerlink" title="DiskRowSet"></a>DiskRowSet</h3><h4 id="CFile"><a href="#CFile" class="headerlink" title="CFile"></a>CFile</h4><p>DiskRowSets ç”± CFile ç»„æˆï¼Œå‡†ç¡®çš„è¯´ï¼Œåœ¨ä¸€ä¸ª DiskRowSet å†…ï¼Œæ¯åˆ—éƒ½ä¼šæœ‰ä¸€ä¸ª CFileã€‚CFile æ˜¯ä¸€ä¸ªé€»è¾‘æ–‡ä»¶ï¼ŒKudu å¼•å…¥äº†ä¸€ä¸ª BlockManager å±‚ï¼Œå¯èƒ½ä¼šæŠŠå¤šä¸ª CFile æ˜ å°„åˆ°åŒä¸€ä¸ªç‰©ç†æ–‡ä»¶ä¸Šã€‚</p><p>å®ƒç”±ä¸åŒçš„éƒ¨åˆ†ç»„æˆï¼ŒåŒ…æ‹¬ï¼š</p><ol><li>Header</li><li>Footer</li><li>ä¸åŒç§ç±»çš„ Block: ç±»ä¼¼ data blocks, nullable data blocks, index blocks, dictionary blocks</li></ol><p>å‹ç¼©å’Œ encoding ä»¥ Block (ç±»ä¼¼ Parquet çš„ Page) ä¸ºç²’åº¦è¿›è¡Œã€‚æ¯ä¸ª Block å¯ä»¥é€‰æ‹©è‡ªå·±çš„ encoding æ–¹å¼ã€‚æ­¤å¤–ï¼Œè¿™é‡Œè¿˜æœ‰å¯¹åº”çš„ Index:</p><p>è¿™é‡Œç”¨ç±»ä¼¼ Position Delta Tree çš„æ–¹å¼ç»„ç»‡ Indexï¼Œæœ‰ä¸‹é¢ä¸¤ç§å¯¹åº”çš„ Index:</p><ol><li>Positional Index: ç±»ä¼¼ PDT æˆ–è€… Parquet ä¸­æŸåˆ—çš„ Offset Index</li><li>å¦‚æœå¯¹åº”çš„æ•°æ®æœ‰ sorted orderï¼Œé‚£ä¼šæœ‰è¿™äº›æ•°æ®çš„ç¨€ç–ç´¢å¼•</li></ol><p>æ•°æ®ä¼šå†™åˆ° ã€ŒLeaf Blockã€ä¸Šï¼ŒKudu ä¼šç»´æŠ¤é€»è¾‘çš„ Internal Blockï¼Œç„¶åæœ€åæŒ‰ Post-Order å†™å…¥ï¼š</p><p><img src="https://image.mwish.me/blog-image/D045E99C-2BA6-4E14-9129-0D90345BB981.png" alt="D045E99C-2BA6-4E14-9129-0D90345BB981"></p><p>ä¾‹å¦‚ä¸‹é¢å°±ä¼šå†™ <code>[Int 2] [Int 1] [Int 0]</code></p><p>æˆ‘ä»ç½‘ä¸ŠæŠ„äº†ä¸ªå¥½å¿ƒäººç”»çš„å›¾ï¼ˆRef 5ï¼‰ï¼š</p><p><img src="https://image.mwish.me/blog-image/014448C5-6AAA-4654-9C92-1B94A9030255.png" alt="014448C5-6AAA-4654-9C92-1B94A9030255"></p><p>å…¶å®å’Œ Parquet å·®ä¸å¤šï¼Œä¸è¿‡ Parquet ä¼°æ‘¸ç€æ²¡ Btrï¼Œå¾—çº¿æ€§æˆ–è€…äºŒåˆ†</p><h5 id="BloomFile"><a href="#BloomFile" class="headerlink" title="BloomFile"></a>BloomFile</h5><p>BloomFile æ˜¯ç‹¬ç«‹çš„ CFile æ–‡ä»¶ï¼Œé¢å¤–å­˜äº†ä¸€ä»½ï¼Œä½œä¸ºéœ€è¦çš„åˆ—çš„ BloomFilterã€‚æœ‰äº† BFï¼Œé‚£ä¹ˆä¸Šé¢é‚£å›¾æ“ä½œè¿›è¡Œä¹‹å‰ï¼Œè¿˜è¦æŸ¥ä¸€ä¸‹å¯¹åº”çš„ BF äº†ã€‚</p><p>BF ä¼šè¢«å¤„ç†åˆ° 4KB çš„ Page ä¸­ï¼Œç„¶åå¿«é€ŸæŸ¥è¯¢ã€‚</p><h3 id="DeltaRowSet"><a href="#DeltaRowSet" class="headerlink" title="DeltaRowSet"></a>DeltaRowSet</h3><p>DiskRowSet ç”± MemRowSet flush è€Œæ¥ï¼Œç±»ä¼¼ RocksDBï¼Œæˆ‘ä»¬ä¹Ÿèƒ½çŸ¥é“å¯¹åº”çš„ min-max å€¼ï¼Œç”¨ä»¥æ”¯æŒåç»­çš„ compactionã€‚</p><p>ä½œä¸º Primary Key æ¨¡å‹ï¼Œä¸åŒäº RocksDB / LevelDBï¼Œè™½ç„¶ DiskRowSet å¯ä»¥è·¨èŒƒå›´ï¼Œä½†æ˜¯å•ä¸ª Primary Key åªå¯èƒ½å‡ºç°åœ¨ä¸€ä¸ªæ–‡ä»¶ä¸­ï¼š</p><p><img src="https://image.mwish.me/blog-image/8a52d89f9e118ec3d5899cf0c7cfc560.webp" alt="8a52d89f9e118ec3d5899cf0c7cfc560"></p><p>Kudu åŒºåˆ†äº†å‡ ç§æ›´æ–°æ“ä½œï¼š</p><ol><li>Update</li><li>Delete</li><li>REINSERT</li></ol><p>Update å’Œ Delete æ²¡æœ‰è½åœ¨ MemRowSetï¼Œè¿™ç‚¹éœ€è¦æ³¨æ„ã€‚ç„¶å REINSERT æ˜¯å’Œ Delete å¯¹åº”çš„ï¼Œå¦‚æœæœ‰åˆ é™¤æ•°æ®åæ¥åˆé‡æ–°æ’å›å»äº†ï¼Œä¼šçºªå½•ä¸€æ¡ REINSERTã€‚è¿™é‡Œä¿è¯äº† BloomFilter æŸ¥åˆ°çš„ä¸œè¥¿ç›¸å¯¹é è°±ï¼Œå½’å±åŒä¸€ä¸ª DiskRowSetã€‚</p><p>è¿™é‡Œæ›´æ–°è®°å½• ä¹Ÿæ˜¯ä» Mem æ¥çš„ï¼Œå¦‚ä¸‹ï¼š</p><p><img src="https://image.mwish.me/blog-image/48396E10-749F-4E6C-88EE-E79637ED0AC9.png" alt="48396E10-749F-4E6C-88EE-E79637ED0AC9"></p><p>Delta MS æ˜¯å†…å­˜çš„éƒ¨åˆ†ï¼Œè¿™é‡Œä¼šæŒ‰ç…§ <code>(row_id, timestamp, RowChangeList)</code> ç»´æŠ¤ï¼š</p><ol><li>RowId å¾ˆç‰¹æ®Šï¼Œç±»ä¼¼ PDT ä¸­çš„æ¦‚å¿µï¼Œæ˜¯æ–‡ä»¶ä¸­å¯¹åº”çš„è¡Œå·ã€‚æ³¨æ„ï¼ŒæŸä¸€è¡Œè¢«åˆ é™¤ï¼Œè¿™ä¸ª RowId ä»ç„¶ç•™ç€</li><li>timestamp å¾ˆå¥½æ‡‚</li><li>RowChangeList æ˜¯å¯¹è¿™ä¸€è¡Œå„ä¸ªåˆ—æ“ä½œçš„ç‰©ç†æ—¥å¿—</li></ol><p>Mem çš„å˜æ›´ä¹Ÿæ˜¯å­˜æ”¾åœ¨åŒæ ·çš„ btree ä¸­ï¼ŒåŒæ—¶ï¼Œè¿™é‡Œå¯ä»¥æ ¹æ® index æ¥æ‰¾åˆ°å¯¹åº”çš„è¡Œå·ã€‚è¿™é‡Œå¯ä»¥ Flush æˆå¯¹åº”æ ¼å¼çš„ Redo æ–‡ä»¶ï¼Œå¦‚ä¸‹å›¾ï¼š</p><p><img src="https://image.mwish.me/blog-image/5FECFBF7-8589-485D-B69A-4702C316B1BE.png" alt="5FECFBF7-8589-485D-B69A-4702C316B1BE"></p><p><img src="https://image.mwish.me/blog-image/8F9B8DCC-3A58-434D-AE05-2C45C0CB5D7B.png" alt="8F9B8DCC-3A58-434D-AE05-2C45C0CB5D7B"></p><h3 id="Compaction"><a href="#Compaction" class="headerlink" title="Compaction"></a>Compaction</h3><p>Compaction çš„æ—¶å€™ï¼Œå¯èƒ½ä¼šæœ‰å¤šä¸ª RowSet åš Compactionï¼Œä¹Ÿå¯ä»¥æ˜¯å•ä¸ªæ–‡ä»¶åš Compactionã€‚è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä¸ºäº†æ»¡è¶³ MVCCï¼ŒBase + Redo æ–‡ä»¶å¯èƒ½ä¼šå˜æˆ Base + Undo æ–‡ä»¶</p><p>Redo è®°å½•æˆ‘ä»¬ä¹‹å‰åº”è¯¥ä»‹ç»è¿‡ï¼Œä¸‹é¢ç®€å•è®²è®² Undo:</p><p><img src="https://image.mwish.me/blog-image/D38B3E53-8A9D-4AA6-ABAC-1133EC3E799E.png" alt="D38B3E53-8A9D-4AA6-ABAC-1133EC3E799E"></p><p>ä¸åŒäº ARIESï¼Œä¸€èˆ¬ Kudu ä¼šç”Ÿæˆå•å‘çš„ Redo è®°å½•ï¼Œç„¶åå½“ Compaction å‘ç”Ÿçš„æ—¶å€™ï¼ŒRDBMSï¼Œå¦‚ PGï¼Œå¯èƒ½ä¼šå­˜ä¸€å † Redoï¼Œç„¶åæ‰¾åˆ°ä¸€ä¸ªæœ€è¿‘ç‰ˆæœ¬æ¢å¤ã€‚åœ¨ Kudu ä¸­ï¼Œæ–‡ä»¶ç”Ÿå‘½å‘¨æœŸå¤§æ¦‚æ˜¯ï¼š</p><ul><li>Redo -&gt; Base / Undo -&gt; è¢«åˆå¹¶æˆ–è€…å›æ”¶</li></ul><p>è¿™æ ·é¿å…äº†ç»´æŠ¤æ¯ä¸ªæ—§ç‰ˆæœ¬çš„æ–‡ä»¶è§†å›¾å’Œå¯¹å®ƒä»¬çš„ refï¼ˆä½œä¸ºå¯¹æ¯”ï¼ŒRocksDB çš„ VersionSetï¼‰</p><h4 id="Compaction-1"><a href="#Compaction-1" class="headerlink" title="Compaction"></a>Compaction</h4><p>Compaction å¯ä»¥è¢«åˆ†ä¸º Major å’Œ Minor çš„</p><h5 id="Delta-Compaction"><a href="#Delta-Compaction" class="headerlink" title="Delta Compaction"></a>Delta Compaction</h5><p><img src="https://image.mwish.me/blog-image/63B946FB-CF2B-4E44-878C-8B735690EFC9.png" alt="63B946FB-CF2B-4E44-878C-8B735690EFC9"></p><p>Minor REDO delta compaction: åˆå¹¶ delta redo æˆä¸€ä¸ª redoï¼Œé‡çº§å¾ˆè½»ï¼Œå‡å°å¯¹åº”å¯¹ Delta çš„ IOã€‚å®ç°é€»è¾‘å°±æ˜¯åŸå°ä¸åŠ¨çš„åˆå¹¶å¤šä¸ª Deltaï¼Œåº”è¯¥èƒ½é€šè¿‡ IO æ¥æå‡å‹ç¼©ç‡ï¼Œå‡å°‘å¤šæ–‡ä»¶ IO å’Œ fds</p><p><img src="https://image.mwish.me/blog-image/7D2628DB-2089-4B26-9465-29DBBC1A304C.png" alt="7D2628DB-2089-4B26-9465-29DBBC1A304C"></p><p>Major Redo Delta Compaction å¦‚ä¸Šå›¾ï¼Œè¿™ä¸ªåœ°æ–¹è¦é‡å†™ base æ–‡ä»¶ï¼Œç„¶åæŠŠåŸæœ¬çš„ redo å˜æˆ undoã€‚åŒæ—¶ï¼Œè¿™ä¸ªåœ°æ–¹ä¹Ÿä¸ä¼šæ”¹å˜ row idã€‚è¿™é‡Œæœ‰ä¸€ä¸ªç‰¹æ®Šçš„åœ°æ–¹ï¼Œå°±æ˜¯å¯ä»¥å•ç‹¬å¤„ç†é¢‘ç¹æ›´æ–°çš„åˆ—ï¼Œå‰©ä¸‹çš„ä»ç„¶åœ¨ redo delta ä¸­ã€‚</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œcompaction å®Œæˆä¹‹åï¼Œå³å¯ä»¥ç§»é™¤ä¹‹å‰çš„æ–‡ä»¶ã€‚</p><h5 id="Range-Compactions"><a href="#Range-Compactions" class="headerlink" title="Range Compactions"></a>Range Compactions</h5><p><img src="https://image.mwish.me/blog-image/924AD8CD-2483-4F80-B792-32BB4F45E41E.png" alt="924AD8CD-2483-4F80-B792-32BB4F45E41E"></p><p>è¿™ä¸ªæœ‰ç‚¹ç±»ä¼¼ RocksDB çš„ Compactionï¼Œä½†å®ƒçš„æ“ä½œå…¶å®ç›¸å½“é‡ï¼Œæˆ‘ä»¬å¯ä»¥è®¨è®ºä¸€ä¸‹å¯¹åº”çš„é—®é¢˜ï¼šrow_id ä¼šæ”¹å˜ï¼Œå‡è®¾ï¼š</p><ol><li>æŸä¸ªæ¨¡å‹è·‘çš„å¥½å¥½çš„ï¼Œéœ€è¦ Compaction äº†</li><li>Compaction è¿›è¡Œçš„æ—¶å€™ï¼Œå†™å…¥è¿˜åœ¨ä¸æ–­è¿›æ¥</li><li>Compaction å®Œæˆäº†ï¼ŒRowSet çš„å†™åŸºäºäº†ä¹‹å‰çš„ row_id</li><li>å¯„ï¼</li></ol><p>Kudu é‡‡ç”¨äº†å¦‚ä¸‹çš„å®ç°ç­–ç•¥ï¼š</p><p><img src="https://image.mwish.me/blog-image/77BE0595-D501-4CCA-80CC-15F14CED8FD0.png" alt="77BE0595-D501-4CCA-80CC-15F14CED8FD0"></p><p>è¿™é‡Œï¼Œå®ƒåŠ å…¥äº†ä¸€ä¸ªåŒå†™çš„ RowSetï¼Œç„¶åCompaction çš„æ—¶å€™ï¼Œå¯¹åº”çš„å˜æ›´ä¼šå³å†™æ—§çš„åˆå°è¯•å†™å…¥æ–°çš„ï¼Œç›¸å½“äºæŠŠæ—§çš„å†™åœ¨æ–°çš„ row_id é‡æ”¾ä¸€éã€‚</p><h4 id="æœºåˆ¶"><a href="#æœºåˆ¶" class="headerlink" title="æœºåˆ¶"></a>æœºåˆ¶</h4><p>åœ¨ Kudu ä¸­ï¼ŒCompaction è¢«å»ºæ¨¡ä¸ºä¸€ä¸ªæœ€ä¼˜åŒ–æ¨¡å‹ï¼Œè¿™é‡Œä¼šæ ¹æ® width å’Œ depth æ¥è¿›è¡Œå‹ç¼©ï¼š</p><p><img src="https://image.mwish.me/blog-image/231397D0-122C-491B-A7B3-809D440BFA07.png" alt="231397D0-122C-491B-A7B3-809D440BFA07"></p><p>å¦‚ä¸Šå›¾ï¼Œè¿™é‡Œä¼šæŒ‘é€‰åˆé€‚çš„èŒƒå›´ï¼Œç„¶åå» compaction</p><p>å…·ä½“çš„è®¨è®ºè§ï¼š<a href="https://github.com/apache/kudu/blob/master/docs/design-docs/compaction-policy.md">https://github.com/apache/kudu/blob/master/docs/design-docs/compaction-policy.md</a></p><h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><ol><li>Kudu paper</li><li>Index Skip Scan Optimization: <a href="https://kudu.apache.org/2018/09/26/index-skip-scan-optimization-in-kudu.html">https://kudu.apache.org/2018/09/26/index-skip-scan-optimization-in-kudu.html</a></li><li>Apache Kudu åœ¨ç½‘æ˜“çš„å®è·µ <a href="https://www.infoq.cn/article/kgwyqb5wer5wl8cquweq">https://www.infoq.cn/article/kgwyqb5wer5wl8cquweq</a></li><li><a href="https://www.slideshare.net/cloudera/apache-kudu-technical-deep-dive">https://www.slideshare.net/cloudera/apache-kudu-technical-deep-dive</a></li><li>Kudu CFile è§£è¯»ï¼š<a href="https://www.jianshu.com/p/789c286e7077">https://www.jianshu.com/p/789c286e7077</a></li></ol>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>ICDE&#39;19: Presto: SQL on Everything</title>
      <link href="/2022/10/21/Presto-SQL-on-Everything/"/>
      <url>/2022/10/21/Presto-SQL-on-Everything/</url>
      
        <content type="html"><![CDATA[<p>æœ¬æ æƒ³ä»‹ç»ä¸€äº›å¤§æ•°æ®å’Œ OLAP ç›¸å…³çš„ä¸œè¥¿ï¼Œå› ä¸ºæœ¬äººå¯¹å¤§æ•°æ®ç›¸å¯¹æ²¡æœ‰å­˜å‚¨é‚£ä¹ˆç†Ÿæ‚‰ï¼Œæ‰€ä»¥å¾ˆå¤šåœ°æ–¹å¯èƒ½æ—©æœŸå†™ä½œçš„æ—¶å€™ä¸ä¼šæœ‰å¤ªå¤šè‡ªå·±çš„ç†è§£ï¼Œä»¥åè¯»ä»£ç æˆ–è€…ä»€ä¹ˆçš„æ—¶å€™ä¼šå°½é‡è¡¥å……ä¸€ä¸‹ã€‚è¿™é‡Œçš„ Ref æ®µä¹Ÿä¼šå¼•ç”¨ä¸€äº›å›½å†…ä»‹ç»çš„äºŒæ‰‹æ–‡ç« ï¼Œæ¥ä¾¿äºåšä¸€äº›ç®€å•ç†è§£ã€‚</p><p>Presto åœ¨ facebook å†…éƒ¨æ¯”è¾ƒæ—©çš„æ—¶å€™ä¼šåœ¨ Hadoop ç³»çš„ç³»ç»Ÿä¸ŠæŸ¥è¯¢ã€‚13 å¹´å·¦å³çš„æ—¶å€™å¼€æºå‡ºæ¥äº†ï¼Œæ®è¯´ facebook è‡ªå·±æ²¡é‚£ä¹ˆç®¡ï¼Œç„¶å fb å‡ºæ¥ä¸€æ³¢äººæäº†ä¸ª Presto DBï¼Œåæ¥æ›´åä¸º Trinoã€‚åœ¨å›½å†…ä½¿ç”¨è€…ä¸­ï¼Œç”¨æˆ·ä¼šä½¿ç”¨ Presto æ¥åšä¸€äº› ad-hoc çš„ AP æŸ¥è¯¢ï¼Œç„¶åç”¨ Spark åšä¸€äº› batch jobã€‚æœ¬æ–‡åœ¨ 19 å¹´å‘è¡¨äº ICDEï¼Œä½œä¸º Presto çš„æ€»ç»“ã€‚è®ºæ–‡æ¯”è¾ƒç®€å•ç›´æ¥ï¼Œæ²¡æœ‰æ‰¯å¾ˆå¤šèŠ±å¤´ï¼Œè€Œæ˜¯æ¯”è¾ƒç®€å•çš„ä»‹ç»äº†ä¸€ä¸‹ Presto éƒ½åœ¨åšä»€ä¹ˆã€‚æ–‡ç« ç»†èŠ‚è¿˜æ˜¯å¾ˆå¤šçš„ï¼ŒåŸºæœ¬ä¸Šå¯ä»¥ä½œä¸ºä¸€ä¸ªå¼•æ“çš„è¯¦ç»†ä»‹ç»ã€‚</p><p>è®ºæ–‡çš„æ ‡é¢˜æ˜¯ SQL on Everythingï¼Œç”¨æˆ·å¯ä»¥è®¾ç½® connector (æ•°æ®æº) ä¹‹åï¼Œè¿è¡Œ SQLã€‚æºå¤´åŒ…æ‹¬ HDFSã€S3ï¼Œä¹ŸåŒ…æ‹¬ä¸€äº›å¯¹åº”çš„å¤–è¡¨ã€‚å®ƒä¼šè§£æ SQLï¼Œç„¶åå»åˆ†å¸ƒå¼çš„æ‰§è¡Œå®ƒä»¬ã€‚Presto åŒ…æ‹¬äº†</p><ol><li>SQL å¯¹åº”çš„è§£æå’Œä¼˜åŒ–ã€‚è¿™é‡Œçš„é‡ç‚¹åº”è¯¥å…³æ³¨è¿™ä¸ª Plan æ˜¯æ€ä¹ˆåˆ†å¸ƒå¼è°ƒåº¦å’Œæ‰§è¡Œçš„ã€‚</li><li>Connectorï¼Œå¯¹åº”ç±»å‹ä¸°å¯Œçš„æ•°æ®æºã€‚æ–°æ•°æ®æºåº”è¯¥ä¹Ÿå¯ä»¥ç¼–å†™è‡ªå·±çš„ connectorã€‚</li></ol><p>æ¥ä¸‹æ¥ä¸Šè®ºæ–‡å§</p><h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>Presto è®¤ä¸ºè‡ªå·±çš„å…³é”®å­—æ˜¯ï¼šadaptive / extensible / flexible:</p><ul><li>Adaptive: å¤šç§Ÿæˆ·ã€å¯æ‰©å±•åˆ°æ•°åƒèŠ‚ç‚¹åºå¤§çš„é›†ç¾¤ä¸­ã€èƒ½å¤„ç† memory / io / cpu bound çš„å„ç§ä¼˜åŒ–ã€‚</li><li>Extensible: å…è®¸ç”¨æˆ·å¯¹æ¥å„ç§æ•°æ®æºçš„æ•°æ®ï¼Œåªè¦ connector é è°±</li><li>Flexible: æ”¯æŒå„ç§ç±»å‹çš„è´Ÿè½½</li></ul><p>æ­¤å¤–ï¼Œå®ƒè¿˜è¦æ±‚æ”¯æŒé«˜æ€§èƒ½ï¼šæ–°çš„æŸ¥è¯¢ä¸ä¼šèµ·æ–°çš„ JVM å®¹å™¨ï¼Œè€Œæ˜¯åœ¨å•æœº worker çš„ long running JVM è¿›ç¨‹ä¸­è¿è¡Œã€‚è¿™ç”¨è°ƒåº¦å’Œèµ„æºç®¡ç†çš„å¤æ‚åº¦æ¥ä¼˜åŒ–äº† response timeã€‚</p><p>è¿™ç¯‡è®ºæ–‡æè¿°äº†ï¼š</p><ol><li>Presto çš„æ¶æ„å’Œå®ç°</li><li>ä¸€äº›å…³é”®ä¼˜åŒ–å¯¹æ€§èƒ½çš„æå‡æŒ‡æ ‡ã€‚</li></ol><h2 id="Use-cases"><a href="#Use-cases" class="headerlink" title="Use cases"></a>Use cases</h2><p>è®ºæ–‡æè¿°äº†å‡ ä¸ª use cases:</p><ol><li>Interative analytics:<ol><li>å¤„ç†å°‘é‡æ•°æ® ( 50GB-3TB çš„å‹ç¼©æ•°æ®)</li><li>å¹¶å‘ 50-100</li><li>å¯¹<strong>å“åº”æ—¶é—´</strong>æ¯”è¾ƒæ•æ„Ÿ</li><li>å¯èƒ½ä¼š killï¼Œ æˆ–è€… limit æ¥é™åˆ¶æŸ¥è¯¢ç»“æœ</li></ol></li><li>Batch ETL<ol><li>transformation å¸¦æ¥çš„ CPU å¼€é”€å¤§ã€aggregation å’Œ Join å†…å­˜å¼€é”€å¯èƒ½å¤§è‡´æ•° TB</li><li><strong>ååé‡</strong>å¾ˆé‡è¦ï¼Œå“åº”æ—¶é—´æ²¡é‚£ä¹ˆé‡è¦</li></ol></li><li>A/B Testing:<ol><li>æ•°å°æ—¶å†…å®Œæˆåˆ†æ</li><li>ç»“æœå®Œæ•´ä¸”å‡†ç¡®</li><li><strong>å¯ä»¥æ‹¿åˆ°å„ä¸ªæ—¶é—´æ®µçš„åˆ†æ</strong>ï¼Œæ‰€ä»¥é¢„èšåˆå¯èƒ½ä¸å¤ªé€‚åˆ</li><li>å¯èƒ½éœ€è¦ JOIN å‡ ä¸ªéå¸¸å¤§çš„æ•°æ®é›†ï¼Œæ¯”å¦‚ user, device, test, event attributes</li><li>æŸ¥è¯¢ç›¸å¯¹ä¹‹å‰å‡ ä¸ªæ¯”è¾ƒå›ºå®š</li></ol></li><li>å¼€å‘è€…/å¹¿å‘Š åˆ†æ (å¥½å®¶ä¼™ï¼Œæˆ‘ç”¨çš„ Google analytics åº”è¯¥å°±æ˜¯è¿™ç§)<ol><li>ç»™ç”¨æˆ·è€Œéå¼€å‘è€…ä½¿ç”¨</li><li>æŸ¥è¯¢ç›¸å¯¹æ¯”è¾ƒå›ºå®šï¼ŒåŒ…æ‹¬ Join / Aggregation with window </li><li>æ•°æ®æ€»é‡å¾ˆå¤§ï¼Œä½†æ˜¯å¯ä»¥è¿‡æ»¤æ‰éå¸¸å¤šçš„æ•°æ®</li><li>æŸ¥è¯¢æ—¶é—´å°½é‡åœ¨ ~50ms - 5s</li></ol></li></ol><h2 id="Architecture-overview"><a href="#Architecture-overview" class="headerlink" title="Architecture overview"></a>Architecture overview</h2><p><img src="https://image.mwish.me/blog-image/2B26F07F-6136-4021-960C-D6A68CEBB857.png" alt="2B26F07F-6136-4021-960C-D6A68CEBB857"></p><p>Presto çš„è¿›ç¨‹åˆ†ä¸ºä¸¤ç§ï¼š</p><ol><li>Coordinator</li><li>Worker</li></ol><p>è¿™ä¸ª Coordinator å’Œ 2PC é‚£ä¸ªä¸æ˜¯ä¸€ä¸ªä¸œè¥¿ï¼Œå®ƒè´Ÿè´£è§£æ SQLã€åˆ†å‘æŸ¥è¯¢ï¼ˆå¯èƒ½ä¸€äº›ç‰¹åˆ«è½»çš„ SQLï¼Œæˆ–è€…åœ¨ meta ç›´æ¥å¤„ç†å®Œçš„ã€schema ç›¸å…³çš„ä¸ä¼šå‘ç»™ workerï¼Ÿï¼‰ã€‚å®ƒè´Ÿè´£ï¼š</p><ol><li>è¯·æ±‚çš„ queue</li><li>ç”Ÿæˆã€ä¼˜åŒ– distributed execution planner</li></ol><p>Worker åˆ™è´Ÿè´£è¯»å–æ•°æ®ã€æ‰§è¡Œ Coordinator äº§ç”Ÿçš„å„ä¸ªç®—å­ï¼Œå®ƒä¹Ÿè´Ÿè´£è¯»å–å¯¹åº”æ•°æ®æºçš„å„ç§æ•°æ®ã€‚æœ€åº•å±‚çš„ worker ä¼šåˆ†é…åˆ°å¯¹åº”çš„ splitï¼Œsplit æ˜¯å¤–éƒ¨å­˜å‚¨ç³»ç»Ÿçš„å¯¹åº”æ•°æ®/æ•°æ®èŒƒå›´ã€‚æ‰§è¡Œçš„æ—¶å€™æœ‰ä¸‹åˆ—å‡ ä¸ªåŸºæœ¬ç»„æˆéƒ¨åˆ†ï¼š</p><ol><li>Statement: ç”¨æˆ·å¯¹åº”çš„ SQL æŸ¥è¯¢</li><li>Query: Presto æ”¶åˆ°ç”¨æˆ·æŸ¥è¯¢çš„æ—¶å€™ï¼Œç”Ÿæˆçš„ Queryï¼Œè¿™é‡Œå¯ä»¥å½“æˆ Presto å¤„ç† sql åçš„ç»“æ„</li><li>Stage: SQL ä¼šè¢«æ‹†æˆå¤šä¸ª stage</li><li>Taskï¼šå•ä¸ª Stage å†…ä¼šæœ‰å¤šä¸ª Task</li></ol><p>å•æœºçš„å¹¶å‘ä¸­ï¼Œæœºå™¨é å¹¶å‘æ‰§è¡Œ Task æ¥åšåˆ°å¹¶å‘ï¼ŒExecution å°½é‡æ˜¯ pipeline æ‰§è¡Œçš„ã€‚Stage é—´çš„æ•°æ®ä¼šå°½é‡å­˜å‚¨åœ¨ memory ä¸­ï¼Œå½“åœ¨ node é—´ shuffle æ•°æ®çš„æ—¶å€™ï¼Œä¹Ÿä¼šå°½é‡ç”¨ buffer æ¥é™ä½ latency (recall: Spark RDD)ã€‚</p><p>Presto æä¾›äº†å¾ˆå¤š Plugin APIï¼ŒåŒ…æ‹¬ï¼š</p><ol><li>Data types / functions / ACL / event consumer / queuing policies</li><li>æœ€é‡è¦çš„æ˜¯ï¼Œå®ƒå¼€æ”¾äº†å¯¹åº”æ•°æ®æºçš„ connector æ¥å£ï¼š<ol><li>Metadata  API: Data å¯¹åº”çš„å…ƒæ•°æ®ï¼Œæ¯”å¦‚ schema ç­‰ï¼Œå…¶å®æ˜¯ä¸€ç»„ç¹æ‚çš„ api</li><li>Data Location API: æ•°æ®åˆ†å¸ƒçš„ api</li><li>Data Source API: è¯»å–æ•°æ®çš„ API</li><li>Data Sink AP: å†™å…¥æ•°æ®çš„ API</li></ol></li></ol><p>å®é™…ä¸Šï¼ŒPresto ä¸ä»…å¯ä»¥å€ŸåŠ©è¿™äº› API å®Œæˆå’Œä¼˜åŒ–å¯¹æ•°æ®æºçš„æŸ¥è¯¢ï¼Œç”šè‡³å¯ä»¥å€ŸåŠ©è¿™å¥— apiï¼Œæ¯”è¾ƒè½»æ¾å®Œæˆä¸€äº›ä»»åŠ¡ï¼Œæ¯”å¦‚è¯´è”é‚¦æŸ¥è¯¢</p><h2 id="System-Design"><a href="#System-Design" class="headerlink" title="System Design"></a>System Design</h2><p>Presto æ¥å— SQL æŸ¥è¯¢ï¼ŒåŒæ—¶ï¼Œæœ‰ RESTful HTTP å®¢æˆ·ç«¯å’ŒåŒ…æ‹¬ JDBC åœ¨å†…çš„å„ç§è¿æ¥ï¼ŒæŸ¥è¯¢ç”ŸæˆåŒ…æ‹¬ä½ ä»¬éƒ½å¬åˆ°è…»çš„å‡ éƒ¨åˆ†ï¼š</p><ol><li>Parsing: ç”¨åŸºäº Antlr çš„ Parser æ¥å°† SQL è½¬æˆ astï¼Œç„¶ååšä¸€äº›è¯­ä¹‰ä¸Šçš„åˆ†æ</li><li>Logical Planning: å¤„ç† astï¼Œç”Ÿæˆ PlanNode çš„æ ‘ï¼Œå¦‚ä¸‹å›¾ï¼ˆè¿™ä¸ª SQL è¦ç”¨åˆ°å¾ˆåé¢ï¼‰</li></ol><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">  orders.orderkey, <span class="built_in">SUM</span>(tax) </span><br><span class="line"><span class="keyword">FROM</span> orders</span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> lineitem</span><br><span class="line">  <span class="keyword">ON</span> orders.orderkey <span class="operator">=</span> lineitem.orderkey </span><br><span class="line"><span class="keyword">WHERE</span> discount <span class="operator">=</span> <span class="number">0</span> </span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> orders.orderkey</span><br></pre></td></tr></table></figure><p><img src="https://image.mwish.me/blog-image/1B137B26-BBA4-4044-8828-EE73D637522C.png" alt="1B137B26-BBA4-4044-8828-EE73D637522C"></p><p>ç„¶åè¿›å…¥ Optimization é˜¶æ®µã€‚è®ºæ–‡é‡Œ Optimizer æè¿°çš„æ¯”è¾ƒç®€å•ï¼ŒCMU Talk 2021 <a href="https://www.youtube.com/watch?v=ZwaVZplVmVA&amp;ab_channel=CMUDatabaseGroup">ä»‹ç»</a>äº†ä¸€äº› Trino Optimizer çš„è®¾è®¡ã€‚å®ƒæœ‰ rbo å’Œ cbo éƒ¨åˆ†ï¼Œä¼šæ ¹æ®ä»£ä»·ç®—å„ç§ MPP ä¼˜åŒ–ï¼Œä¹‹åæˆ‘åº”è¯¥ä¼šä¸“é—¨ä»‹ç»ã€‚æ¯”è¾ƒå…³é”®çš„æ˜¯è¿™é‡Œä¼šæ ¹æ®ä¸‹åˆ—ä¿¡æ¯ä½œå†³ç­–ï¼š</p><ol><li>Data Layouts: æ ¹æ® Data Layout API æ‹¿åˆ° partitioning, sorting, grouping, indices ç›¸å…³çš„ propertiesã€‚</li><li>Predicate Pushdown: æ ¹æ® connector é€‰æ‹©æ˜¯å¦ä¸‹æ¨ range / equalityï¼Œæå‡æŸ¥è¯¢æ€§èƒ½<ol><li>è¿™åŒ…æ‹¬å¯èƒ½æ¨ä¸€äº› selection filter ä¹‹ç±»çš„ä¸œè¥¿ï¼Œæˆ–è€…è¦ä¸è¦æ¨ä¸€äº›ä¸œè¥¿åˆ°å­˜å‚¨ä¸Šï¼Œconnector ä¼šæä¾›ä¸€äº›ç›¸å…³çš„ä¿¡æ¯ï¼Œè¿˜æ˜¯å¾ˆç®¡ç”¨çš„</li></ol></li><li>inter-node parallelism (å¢å¤§ node é—´å¹¶å‘): å¯ä»¥å¹¶è¡Œçš„éƒ¨åˆ†å¯ä»¥æ‹†åˆ†æˆä¸“é—¨çš„ stageï¼Œä¸¾ä¸ªæœ€ç®€å•çš„ä¾‹å­ï¼Œæ‰«æå¤§é‡ç®€å•æ•°æ®ï¼Œç„¶å aggã€‚è¿™ä¸ªå› ä¸ºæ‰«æå¤§é‡ç®€å•æ•°æ®åœ¨æœ‰äº›æƒ…å†µä¸‹æ‹†åˆ†å¼€æ¥å¹¶è¡Œæ‰«ææ˜¯å¯èƒ½æ›´ä¼˜çš„ï¼Œæ‰€ä»¥è¿™é‡Œå¯ä»¥å”±åˆ†æˆä¸€ä¸ª stageï¼Œæ¯ä¸ª stage åœ¨éƒ¨åˆ† input data ä¸Šæ‰§è¡ŒåŒæ ·çš„æ“ä½œã€‚stage è®¡ç®—å®Œæ¯•ç»“æœä¼šæ”¾åˆ°æœ¬åœ°çš„å†…å­˜ buffer ä¸­ã€‚Stage ä¹‹å‰ä¾é  Shuffle æ¥è¿›è¡Œäº¤äº’ã€‚Shuffle å°†å¸¦æ¥æ¯”è¾ƒé‡çš„ CPU å’Œç½‘ç»œå¼€é”€ï¼Œæ‰€ä»¥ Optimizer åº”è¯¥æ…é‡ä½œå‡ºæŠ‰æ‹©ã€‚Figure 3 è¡¨ç¤ºäº† Optimizer å¤§æ¦‚ç”Ÿæˆçš„å†…å®¹ï¼ˆåé¢ä¼šå¯¹è¿™ä¸ªå†ä¼˜åŒ–ï¼‰ï¼š</li></ol><p><img src="https://image.mwish.me/blog-image/A4D930D9-5D5D-4E27-B570-06206A282597.png" alt="A4D930D9-5D5D-4E27-B570-06206A282597"></p><p>ç”Ÿæˆä¹‹åï¼Œä¼˜åŒ–å™¨éœ€è¦æ ¹æ®ä¸€äº› API æ¥è¿›è¡Œä¼˜åŒ–ï¼ŒåŒ…æ‹¬ï¼š</p><ol><li>Data Layout Properties: å¯ä»¥æ ¹æ® partition ä¹‹ç±»çš„ï¼Œæ¥åšä¸€äº› co-located join ç›¸å…³çš„ä¼˜åŒ–ï¼›æˆ–è€…å¦‚æœå‘ç°æŸä¸ª Join Column æ˜¯ Index çš„æ—¶å€™ï¼Œèµ° index nested loop joinï¼›ä¹Ÿå¯ä»¥æ ¹æ® MySQL çš„ Partition å’Œè¿æ¥çš„æ€§è´¨æ¥åšä¼˜åŒ–ã€‚åœ¨ Batch ETL æˆ–è€… AP æŸ¥è¯¢ä¸­ï¼Œè¿™é‡Œä¹Ÿå¯ä»¥åšå¾ˆå¤šçš„æ•°æ®è£å‰ªã€‚</li><li>Node Properties: è¿™é‡Œ Node æ˜¯æŒ‡ PlanNodeï¼Œè¿™ä¸ªç±»ä¼¼ Cascades æ¨¡å‹æåˆ°çš„ Propertiesï¼ŒèŠ‚ç‚¹ä¼šæœ‰ partition / sorting / bucketing ä¹‹ç±»çš„ä¿¡æ¯ã€‚æŸ¥è¯¢ä¹Ÿå¯ä»¥è®¾ç½® Preferenceï¼Œè¡¨ç¤ºäº²å’Œçš„ã€å¿…è¦çš„ propertiesï¼Œåœ¨ä¼˜åŒ– shuffle çš„æ—¶å€™ï¼ŒPresto ä¼šå°½é‡æ»¡è¶³æ›´å¤šçš„ Propertiesã€‚å¯ä»¥æ ¹æ®è¿™äº›ä¿¡æ¯æ¥å’Œ Data Layout Properties ä¸€æ ·ä¼˜åŒ–æŸ¥è¯¢ã€å‡å°‘ shuffleã€‚è¿™æ ·å½“ç„¶ä¹Ÿå¯èƒ½ä¼šå¯¼è‡´ä¸€å®šçš„ da ta skewï¼Œå› ä¸ºæœ¬æ¥æ˜¯æœ‰ä¸€å®š dop è¢«åˆ†æˆ stage çš„ï¼Œç°åœ¨ stage åˆå¹¶äº†ï¼Œæ‰€ä»¥å€¾æ–œçš„æ¦‚ç‡ä¹Ÿä¼šæé«˜ã€‚è¿™ä¸ª Figure3 ä¸­çš„è¡¨è¾¾å¼ï¼Œå¦‚æœæœ‰ä¸€äº› layout properties æ˜¯å¯ä»¥å°è¯•åˆå¹¶çš„ã€‚</li></ol><p>è¿˜æœ‰ä¸€äº› intra-node parallelism çš„å¤„ç†ï¼šåœ¨å•ä¸ª node ä¸­ï¼Œå¯èƒ½ä¼šå› ä¸º skew ï¼ˆæ¯”å¦‚ç”¨æˆ·éšä¾¿å†™äº†ä¸ª SQLï¼Œæ²¡å’‹ä¼˜åŒ–ï¼Œä¹Ÿæ²¡å’‹è®¾è®¡ partitionï¼Œå°±å¾ˆå®¹æ˜“ skewï¼‰æˆ–è€… job æœ¬èº«å¤ªå¤§ï¼ˆåœ¨å°‘é‡èŠ‚ç‚¹æ‰§è¡Œé‡ ETLï¼‰å¯¼è‡´ Task å¾ˆé‡ï¼Œç„¶å Task çš„ Executor æ²¡æ³•å¿«é€Ÿæ¶ˆè´¹ä¸‹æ¸¸ç”Ÿæˆçš„æ•°æ®ï¼Œè¿™ä¹Ÿä¸å¤ªè¡Œã€‚èŠ‚ç‚¹å†…å¹¶è¡Œèƒ½ç¨å¾®ç¼“è§£ä¸€äº›è¿™äº›ç—‡çŠ¶ï¼Œå¦‚ä¸‹å›¾ï¼š</p><p><img src="https://image.mwish.me/blog-image/8ECB9443-012A-41F5-A956-E9A331423D2E.png" alt="8ECB9443-012A-41F5-A956-E9A331423D2E"></p><p>è¿™é‡Œåœ¨ Hash Join çš„ Build Side ä¸­ï¼Œåœ¨ Pipeline 1 å’Œ Pipeline 2 ä¸­å¼•å…¥äº†å¹¶å‘ï¼ˆæˆ‘æ„Ÿè§‰è¿™ä¸ªç›¸å½“äºè¯†åˆ«åˆ°ä¸éœ€è¦å¤š stage å¤„ç†ï¼Œä½†æ˜¯æ‰§è¡Œçš„æ—¶å€™ä¼šåœ¨ä¸€äº› operator é‡Œå°è¯•å¹¶å‘ï¼Ÿï¼‰ï¼ŒåŸæœ¬çš„ Scan -&gt; Hash è¢«æ‹†åˆ†æˆäº†ä¸¤ä¸ª pipelineã€‚</p><p>æ‰€ä»¥å›é¡¾ä¸€ä¸‹ï¼ŒOptimizer å¤§æ¦‚ä¼šï¼š</p><p><img src="https://image.mwish.me/blog-image/7B7E3B3A-0D27-4EBA-AC39-244B61584C69.png" alt="7B7E3B3A-0D27-4EBA-AC39-244B61584C69"></p><h3 id="Scheduling"><a href="#Scheduling" class="headerlink" title="Scheduling"></a>Scheduling</h3><p>Coordinator ä¼šæŠŠ Plan Stage äº§ç”Ÿçš„ Executable Tasks åˆ†å‘ç»™ workersï¼Œç„¶åä¹Ÿä¼šæœ‰ task stages -&gt; task stages çš„æ•°æ®é€šè·¯ï¼Œè®©æœ€åæœ‰ä¸€ä¸ªæ‰§è¡Œæ ‘ã€‚</p><p>Task å¯èƒ½åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ª Pipelineï¼ŒPipeline æ˜¯ Operator çš„é“¾ï¼ˆlike HyPer)ï¼Œå½“ Optimizer å‘ç°ä¸€ä¸ª Pipeline éœ€è¦å†…éƒ¨å¹¶è¡Œæ¥æé«˜æ€§èƒ½çš„æ—¶å€™ï¼Œå°±ä¼šå°è¯•å¹¶è¡Œï¼ˆæˆ‘è§‰å¾—åŸºæœ¬ä¸Šå°±æ˜¯ Figure 4ï¼‰ã€‚å…¶å®è¿™é‡Œå¯ä»¥è§†ä½œåœ¨<strong>ä¸åŒçº§åˆ«</strong>åšæ‹†åˆ†æ“ä½œï¼š</p><ol><li>Probe Build å¯èƒ½è¢«æ‹†åˆ†æˆ Stage1 -&gt; Shuffle -&gt; Stage2</li><li>è¿™é‡Œåœ¨åŒä¸€ä¸ª Stage ä¸­ï¼Œæˆäº† Pipeline2 -&gt; LocalShuffle -&gt; Pipeline1</li></ol><p>é¡ºå¸¦ä¸€æï¼Œæˆ‘æœäº†ä¸‹ googleï¼Œç«Ÿç„¶æ²¡æœåˆ° LocalShuffle è¿™ä¸ªè¯ã€‚</p><p>ä¸Šè¿°æ˜¯ Optimizer çš„éƒ¨åˆ†è¡Œä¸ºï¼Œç„¶å Execution çš„æ—¶å€™ï¼Œè°ƒåº¦è¡Œä¸ºå¦‚ä¸‹ï¼š</p><ol><li>çœ‹é‚£äº› Stages éœ€è¦è¢«è°ƒåº¦</li><li>çœ‹å¤šå°‘äººç‰©éœ€è¦è¢«è°ƒåº¦ï¼Œè¢«æ”¾ç½®åˆ°å“ªäº› node ä¸Š</li></ol><p><strong>Stage Scheduling</strong> æœ‰ all-at-once å’Œ phased ä¸¤ç§ç­–ç•¥ï¼š</p><ol><li>All-at-once å…¨éƒ¨è°ƒåº¦ï¼Œå‡å°‘äº†ä¸€å®šçš„ latencyï¼ˆä½†æ˜¯èµ„æºå¼€é”€å¯èƒ½æ¯”è¾ƒå¤§ï¼Ÿï¼‰</li><li>Phase Scheduling éœ€è¦é¿å…æ­»é”ï¼Œæ¯”å¦‚é¿å… Probe æ¯” Build å…ˆè¿è¡Œã€‚åœ¨ Batch ETL åœºæ™¯å¤§å¤§å‡å°‘äº†å†…å­˜å¼€é”€ã€‚</li></ol><p>å½“ Scheduler éœ€è¦æ‰§è¡ŒæŸä¸ª Stage çš„æ—¶å€™ï¼Œè¿™é‡Œéœ€è¦ assign ä¸€å®šæ•°ç›®çš„ tasks åˆ°å¯¹åº”çš„ nodes ä¸Šã€‚Stage è¢«åˆ†ä¸º Leaf Stage å’Œ Intermediate Stageã€‚Leaf Stage ä» Connector é‡Œé¢è¯»å–æ•°æ®ï¼Œè€Œ intermediate stage ä¼šæ‹¿åˆ°åˆ«çš„ Stage ç”Ÿæˆçš„æ•°æ®ã€‚</p><p>å¯¹äº Leaf Stageï¼Œè¿™é‡Œä¼šæ ¹æ® Connector å’Œ network ç›¸å…³çš„é…ç½®ï¼Œæ¥åˆ†é…ä»»åŠ¡åˆ°å„ä¸ªèŠ‚ç‚¹ä¸Šï¼š</p><ol><li>æç«¯çš„è¯´ï¼Œå¦‚æœæ˜¯ shared-nothing éƒ¨ç½²ï¼ŒLeaf Stage éœ€è¦å®Œå…¨åˆ†é…åˆ°å¯¹åº”çš„æ•°æ®èŠ‚ç‚¹ä¸Š</li><li>æ­¤å¤–ï¼Œä¼šæ ¹æ®ä¹‹å‰æåˆ°çš„ Connector Data Layout ç›¸å…³çš„ API åšè°ƒåº¦ã€‚</li></ol><p>åˆ†æåœºæ™¯æœ‰å¾ˆå¤§ä¸€éƒ¨åˆ†å¼€é”€åœ¨è§£å‹ã€decodingåˆ—å­˜ç¼–ç ã€è¿‡æ»¤å’Œæ•°æ®ç±»å‹è½¬æ¢ä¸Šã€‚è¿™äº›ä»»åŠ¡ç®—æ˜¯ cpu + io bound çš„ï¼Œæ‰€ä»¥å®ƒä»¬ä¼šè¢« dispatch åˆ°<strong>å°½é‡å¤š</strong>çš„èŠ‚ç‚¹ä¸Šï¼ˆè€å®è¯´ï¼Œæˆ‘è§‰å¾—åº”è¯¥æœ‰ä¸ªæ ¹æ®ç»Ÿè®¡ç®—çš„è®¡ç®—å…¬å¼ï¼Œæ¯”å¦‚ï¼š<a href="https://github.com/apache/arrow/blob/master/cpp/src/arrow/io/caching.cc#L52">https://github.com/apache/arrow/blob/master/cpp/src/arrow/io/caching.cc#L52</a> ï¼‰</p><p>è¿™é‡Œä¹Ÿä¼šæ ¹æ®ç½‘ç»œæ¥åšä¸€äº›é…ç½®ï¼Œæ¯”å¦‚è¦æ±‚å°½é‡è¯»åŒä¸€ä¸ªæœºæˆ¿çš„æ•°æ®ã€‚</p><p>å¯¹äº Intermediate Stagesï¼Œè¿™é‡Œä¼šæ ¹æ® properties å’Œæ•°æ®åˆ†å¸ƒå†³å®š worker / task æ•°é‡ï¼Œç”šè‡³èƒ½å¤Ÿä¸€å®šæƒ…å†µä¸‹åŠ¨æ€æ›´æ–° tasks æ•°ç›®ã€‚</p><p>åœ¨ Leaf Stage ä¸­çš„ worker ä¼šè¢«åˆ†é… Connector ä¸­å®šä¹‰çš„ splitï¼Œè¿™ä¸ª split ç›¸å½“äºæ•°æ®æºä¸­çš„ä¸€æ®µæ•°æ®ï¼Œæ¯”å¦‚ Parquet / ORC æ–‡ä»¶ä¸­çš„æŸæ®µï¼Œæˆ–è€…æ˜¯ Redis çš„ server, key-value ç­‰ã€‚Leaf Stage éœ€è¦è¢« assign å¯¹åº”çš„ Split æ‰æ˜¯å¯è¿è¡Œçš„ï¼Œè€Œä¸­é—´èŠ‚ç‚¹åœ¨ assign åä¸€ç›´å¯è¿è¡Œï¼Œå¹¶ä¸”åœ¨æ¶ˆè´¹å®Œä¸Šæ¸¸æ•°æ®æˆ–è€… abort ä¹‹åå®Œæˆã€‚</p><p><img src="https://image.mwish.me/blog-image/E1FE9C7F-A989-48EE-A1C1-07BDC5B092BF.png" alt="E1FE9C7F-A989-48EE-A1C1-07BDC5B092BF"></p><p>å…³äº Task çš„åˆ†å‘ï¼Œè¿™é‡Œä¼šè®© Connector æšä¸¾å¯¹åº”çš„ splitï¼Œç„¶åä¸€ç‚¹ç‚¹åˆ†å‘ç»™ workerï¼Œè¿™ä¸ªåœ°æ–¹å¸Œæœ›ï¼š</p><ol><li>Hive ä¹‹ç±»çš„ Connector æšä¸¾å¯èƒ½éœ€è¦å¾ˆä¹…ï¼Œè¿™é‡Œå¯ä»¥éƒ¨åˆ†è§£è€¦æŸ¥è¯¢æ—¶é—´</li><li>ä¸å¤„ç†å®Œæ‰€æœ‰æ•°æ®å°±ç”ŸæˆæŸ¥è¯¢ç»“æœ</li><li>worker ä¸Šç»´æŠ¤ split é˜Ÿåˆ—ï¼Œcoordinator ä¼šæ ¹æ®é˜Ÿåˆ—å‰©ä½™é•¿åº¦æ¥åšä¸€äº›è°ƒåº¦ï¼Œæ¥ä¸€å®šç¨‹åº¦é¿å… skew å’Œé€‚é…è´Ÿè½½</li><li>split æå®Œäº†å°±ä¸ä¸€å®šè¦å­˜åœ¨å†…å­˜ä¸­äº†ï¼Œåœ¨è®¿é—®å‡ ç™½ä¸‡ä¸ª split çš„æ—¶å€™ï¼Œé™ä½å†…å­˜å’Œ tracking çš„å¼€é”€ã€‚</li></ol><p>å½“ç„¶ï¼Œè¿™ä¸ªå¯èƒ½ä¹Ÿä¼šå¯¼è‡´ä¼°è®¡æŸ¥è¯¢è¿›åº¦ä¸å‡†ç¡®ã€‚</p><h2 id="Execution"><a href="#Execution" class="headerlink" title="Execution"></a>Execution</h2><h3 id="å•æœºæ‰§è¡Œ"><a href="#å•æœºæ‰§è¡Œ" class="headerlink" title="å•æœºæ‰§è¡Œ"></a>å•æœºæ‰§è¡Œ</h3><p><img src="https://image.mwish.me/blog-image/066C1494-660B-4ABF-A322-2A673A75F354.png" alt="066C1494-660B-4ABF-A322-2A673A75F354"></p><p>Presto åœ¨å•æœºæ‰§è¡Œä¸Šæœ‰ Operator å’Œ Driver ä¸¤ä¸ªæ¦‚å¿µï¼ŒDriver ç±»ä¼¼ä¹‹å‰æ‰§è¡Œå›¾ä¸­çš„å•ä¸ª Pipeline ä¸­çš„å•ä¸ªå¹¶è¡Œå•å…ƒï¼Œåœ¨è®ºæ–‡ä¸­ï¼ŒDriver ç‰¹ç‚¹æ˜¯ï¼š</p><ol><li>ä»¥ Page ä¸ºå•ä½ï¼Œå¤„ç†æ•°æ®ï¼ŒPage ç±»ä¼¼ Figure 5</li><li>Pipeline çš„å¤„ç† Operatorï¼Œè¿™é‡Œå¯ä»¥å¾ˆç®€å•çš„å‘ç°å“ªäº›æ˜¯ blocking çŠ¶æ€ï¼Œç„¶åå¯ä»¥è®©å‡ºçº¿ç¨‹ï¼›éé˜»å¡çŠ¶æ€çš„ Page å¯ä»¥åœ¨ Operator ä¹‹é—´ç§»åŠ¨</li></ol><p><img src="https://image.mwish.me/blog-image/42C83D4A-3E2B-465F-B378-99C5A866DF9D.png" alt="42C83D4A-3E2B-465F-B378-99C5A866DF9D"></p><h3 id="Shuffle"><a href="#Shuffle" class="headerlink" title="Shuffle"></a>Shuffle</h3><p>å¯¹äº Shuffle è€Œè¨€ï¼ŒPresto ä½¿ç”¨é•¿è½®è¯¢æ¥æ‹‰å–æ•°æ®ï¼Œå³ä½¿æ•°æ®å¾ˆå°ï¼Œè¿™æ ·ä¹Ÿæœ‰è‰¯å¥½çš„ä¸é«˜çš„ latencyã€‚buffer ä¹Ÿéœ€è¦ä¸€å®šçš„è°ƒæ•´ï¼Œbuffer å¤ªå°æˆ–è€…æ¶ˆè´¹è·Ÿä¸ä¸Šå¯¼è‡´ full çš„è¯ï¼Œsplit å¤„ç†å°±æ— æ³•ç»§ç»­äº†ï¼Œè€Œä¸”ä¼šå ç€å¤§å—å†…å­˜ï¼›åä¹‹ï¼Œå¦‚æœ buffer åˆ©ç”¨ç‡ä¸å¤Ÿï¼Œæ¯æ¬¡ç§¯æ”’äº†ä¸€äº›å° buffer éƒ½è¢«å–èµ°äº†ï¼Œé‚£ä¹ˆå®é™…ä¸Šç½‘ç»œè¿™äº›å¼€é”€å°±ä¼šæ¯”è¾ƒå¤§ã€‚</p><p>è¿™é‡Œé€šè¿‡ç›‘æ§æ¥è°ƒæ•´æ¶ˆè´¹ç«¯ï¼ˆä¸‹æ¸¸ï¼‰ä¸è¾“å‡ºç«¯ï¼ˆä¸Šæ¸¸ï¼‰çš„æ•°æ®ï¼š</p><ol><li>å½“ä¸Šæ¸¸ buffer åˆ©ç”¨ç‡æŒç»­æ¯”è¾ƒé«˜ï¼Œè¿™é‡Œä¼šå°è¯•å‡å°‘åˆ†é…ç»™å®ƒçš„ splitï¼Œæ¥é™ä½ç”Ÿäº§ç«¯æ•°æ®äº§ç”Ÿã€‚è®ºæ–‡æŒ‡å‡ºè¿™æ ·èƒ½ä¼˜åŒ–ä¸å°‘å¯¹åº”çš„å†…å­˜å¼€é”€ã€‚</li><li>æ¥æ”¶ç«¯ä¼šè®¡ç®—è‡ªå·±æ¯ä¸ªè¯·æ±‚å¹³å‡ä»ä¸‹æ¸¸è·å–äº†å¤šå°‘ bytesï¼Œç„¶åæ¥ç®—ä¸€ä¸ªåˆç†çš„è·å–æ•°æ®çš„å¹¶å‘ã€‚</li></ol><h3 id="å†™æ“ä½œ"><a href="#å†™æ“ä½œ" class="headerlink" title="å†™æ“ä½œ"></a>å†™æ“ä½œ</h3><p>å¯¹äºå†™æ“ä½œï¼ŒPresto ä¹Ÿä¼šè°ƒæ•´å¯¹åº”çš„å¹¶å‘åº¦ã€‚å½“å†™å…¥ Buffer å ç”¨è¿‡å¤§çš„æ—¶å€™ï¼Œè¿™é‡Œä¼šå¢å¤§å†™çš„å¹¶å‘åº¦ï¼Œæ¥è°ƒæ•´å¯¹åº”çš„æ•ˆç‡ï¼ˆè¿™é‡Œä¸¾äº†ä¸ª S3 + Hive çš„ä¾‹å­ï¼Œä½†æˆ‘æ²¡å®Œå…¨ get åˆ°ï¼‰ã€‚</p><h3 id="èµ„æºç®¡ç†"><a href="#èµ„æºç®¡ç†" class="headerlink" title="èµ„æºç®¡ç†"></a>èµ„æºç®¡ç†</h3><p>å› ä¸ºéœ€è¦æ‰§è¡Œä¸åŒçš„ Taskï¼ŒTask åˆåŒ…å«å„ç§ Pipelineï¼Œè‡ªç„¶ï¼Œåš Task çº§åˆ«æˆ–è€…æ›´ä¸‹å±‚çš„è°ƒåº¦å’Œèµ„æºç®¡ç†ä¹Ÿå¾ˆé‡è¦ã€‚è¿™é‡Œå•ä¸ªé›†ç¾¤å¯èƒ½æœ‰æ•°ç™¾çš„å¹¶å‘ï¼ŒåŒæ—¶ä¹Ÿæœ‰ä¸€ä¸ªèµ„æºç®¡ç†ç³»ç»Ÿã€‚</p><h4 id="CPU-Scheduling"><a href="#CPU-Scheduling" class="headerlink" title="CPU Scheduling"></a>CPU Scheduling</h4><p>Presto æœ€å…³æ³¨çš„èµ„æºå°±æ˜¯ CPUã€‚node çº§åˆ«çš„ scheduler å¯¹ turnaround time æ—¶é—´çŸ­çš„å°æŸ¥è¯¢åšäº†ç‰¹æ®Šçš„ä¼˜åŒ–ï¼ŒåŒæ—¶ï¼Œå¯¹ CPU èµ„æºéœ€æ±‚å·®ä¸å¤šçš„æŸ¥è¯¢åšäº†å…¬å¹³å…±äº«(fair sharing)çš„è°ƒåº¦ã€‚Task çš„èµ„æºä½¿ç”¨é‡ç­‰ä»·äºæ¯ä¸ª split çš„ CPU time ä¹‹å’Œï¼ŒåŒæ—¶ï¼Œè°ƒåº¦çš„æ—¶å€™ï¼ŒèŠ‚ç‚¹ä¼šè®°å½•è‡ªå·± node ä¸Š Task æ‰§è¡Œçš„æ—¶é—´ï¼Œç„¶ååš Task-level çš„è°ƒåº¦ã€‚</p><p>åœ¨å¹¶å‘å¤„ç†ä¸Šï¼ŒPresto ä½¿ç”¨äº†åä½œå¤šä»»åŠ¡çš„æ¨¡å‹ã€‚æ¯ä¸ªä»»åŠ¡æœ€å¤šæœ‰ä¸€ä¸ª 1ç§’é’Ÿçš„æ—¶é—´ç‰‡ï¼Œåœ¨è¿è¡Œå®Œ 1 ç§’åï¼Œå®ƒéœ€è¦é‡æ–°è¿›å…¥ä»»åŠ¡é˜Ÿåˆ—ã€‚å½“ output buffer æ»¡äº†ï¼ˆä¸‹æ¸¸æ¶ˆè´¹æ•°æ®æ…¢ï¼‰æˆ–è€…ä¸Šæ¸¸ buffer ç©ºã€ç³»ç»Ÿæ²¡æœ‰è¶³å¤Ÿå†…å­˜çš„æ—¶å€™ï¼Œç³»ç»Ÿä¼šè°ƒåº¦åˆ«çš„ä»»åŠ¡ã€‚</p><p>åœ¨è°ƒåº¦ç­–ç•¥ä¸Šï¼ˆå³é€‰æ‹©ä¸‹ä¸€ä¸ªè°ƒåº¦çš„ä»»åŠ¡ï¼‰ï¼ŒPresto ä½¿ç”¨äº† MLFQ æ¥åšè°ƒåº¦ï¼Œç”¨ CPU Time æ¥åšè°ƒåº¦çš„æŒ‡æ ‡ã€‚åœ¨æ‰§è¡Œä¸Šï¼Œè¿™ä¸ªä¾é  connector æä¾›çš„ async api å’Œ yield signalï¼Œè¿™æ · io-task å°±å¯ä»¥è®©å‡ºå¯¹åº”çš„ cpu äº†ã€‚åŒæ—¶ï¼Œç›¸å¯¹æ¥è¯´ï¼Œbatch etl è°ƒåº¦ä¼˜å…ˆçº§ä¼šä½ä¸€äº›ï¼Œè€ŒçŸ­çš„ä»»åŠ¡é€šå¸¸ä¼šè¢«å¾ˆå¿«çš„æ‰§è¡Œ</p><h4 id="Memory-Management"><a href="#Memory-Management" class="headerlink" title="Memory Management"></a>Memory Management</h4><p>å†…å­˜ç”³è¯·éœ€è¦èµ° Poolï¼Œç„¶åè¢«æ ‡è®°ä¸º user memory æˆ–è€… system memoryï¼š</p><ol><li>user memory: å’Œç”¨æˆ·çš„è¾“å…¥æ•°æ®æœ‰å…³ï¼Œèƒ½å¤Ÿåé¦ˆç»™ç”¨æˆ·</li><li>system memory: ç³»ç»Ÿå†…éƒ¨çš„å®ç°ï¼Œå¤§å°å’Œç”¨æˆ·å…³ç³»ä¸å¤§ï¼Œæ¯”å¦‚ shuffle buffers</li></ol><p>è¿™ä¸¤ä¸ªé™åˆ¶æ˜¯åˆ†ç¦»çš„ï¼ŒåŒæ—¶ï¼Œè¶…è¿‡äº†èŠ‚ç‚¹çº§åˆ«å†…å­˜é™åˆ¶æˆ–è€…å„ä¸ªèŠ‚ç‚¹æ€»å†…å­˜å¼€é”€è¶…è¿‡é™åˆ¶çš„ Query ä¼šè¢« kill æ‰ã€‚è€Œå¦‚æœæœºå™¨å†…å­˜ä¸å¤Ÿï¼Œtask allocate ä¸å‡ºå†…å­˜ï¼Œå®ƒä¼š blocking ç›´åˆ°èƒ½å¤Ÿç”³è¯·å†…å­˜ã€‚</p><p>èŠ‚ç‚¹çº§åˆ«å†…å­˜å’Œæ€»å†…å­˜å¯ä»¥é™åˆ¶å¹¶è¡Œåº¦ã€é˜²æ­¢ skewï¼Œè¿™ä¸ªéƒ½â€¦è«åå¾ˆå¥½æ‡‚ï¼Œæ„Ÿè§‰å¯ä»¥å‚è€ƒ DynamoDB çš„ WCU / RCUã€‚å½“ç„¶ï¼Œè¿™é‡Œ Batch ETL ä¼šé‡åˆ°å†…å­˜ä¸å¤Ÿç”¨çš„æƒ…å†µï¼Œæ‰€ä»¥è¿™é‡Œæä¾›äº† Spilling å’Œ Reserved Pool:</p><ol><li>Reserved Pool: é¢„ç•™å†…å­˜æ± ï¼Œç±»ä¼¼ DynamoDB çš„ burst èµ„æºæ± ï¼Œå·²ç»<a href="https://github.com/trinodb/trino/issues/6677">æ— äº†</a>ï¼Œå› ä¸º trino è®¨è®ºè€…è®¤ä¸ºè¿™ç©æ„æ²¡æœ‰èµ·åˆ°å®é™…çš„ä½œç”¨</li><li>spilling state to disk. <strong>Presto supports spilling for hash joins and aggregations.</strong><ol><li>However, we do not conï¬gure any of the Facebook deployments to spill. Cluster sizes are typically large enough to support several TBs of distributed memory, users appreciate the predictable latency of fully inmemory execution, and local disks would increase hardware costs (especially in Facebookâ€™s shared-storage deployments).</li></ol></li></ol><h3 id="Fault-Tolerance"><a href="#Fault-Tolerance" class="headerlink" title="Fault Tolerance"></a>Fault Tolerance</h3><p>åœ¨è®ºæ–‡å‘è¡¨çš„æ—¶å€™ï¼ŒPresto ä¼¼ä¹å¯¹ fault tolerance æ”¯æŒä¸æ˜¯å¾ˆå¥½ï¼š</p><ol><li>Task / Stage ä¹‹ç±»çš„é”™è¯¯ï¼Œä¼šé‡è¯•</li><li>Coorindator çš„é”™è¯¯ä¼šå¯¼è‡´æ•´ä¸ªæœåŠ¡ä¸å¯ç”¨ã€‚åœ¨ fbï¼ŒInteractive analytics å’Œ batch etl ç”¨ standby coordinatorï¼ŒA/B å’Œ analysis åˆ™ç”¨å¤šä¸ªé›†ç¾¤ã€‚</li><li>Presto è®¤ä¸º ckpt ä¹‹ç±»çš„ç­–ç•¥éƒ½è¿‡é‡äº†ï¼Œæ‰€ä»¥å†™æ–‡ç« çš„æ—¶å€™è¿˜æ²¡æ”¯æŒã€‚å¬è¯´è¿˜æœ‰ç”¨ Presto on Spark æ”¯æŒ batch ETL çš„ï¼ŒçœŸçš„ç‰›æ‰¹</li></ol><h2 id="Query-Processing-Optimizations"><a href="#Query-Processing-Optimizations" class="headerlink" title="Query Processing Optimizations"></a>Query Processing Optimizations</h2><h3 id="JVM"><a href="#JVM" class="headerlink" title="JVM"></a>JVM</h3><p>åˆ©ç”¨ JITï¼Œè°ƒæ•´ GCã€‚ä¸æ‡‚ Javaï¼Œä¸é”è¯„äº†ã€‚</p><h3 id="Codegen"><a href="#Codegen" class="headerlink" title="Codegen"></a>Codegen</h3><p>ä¸æ‡‚ï¼Œä¸é”è¯„äº†ã€‚</p><h3 id="File-Format-Features"><a href="#File-Format-Features" class="headerlink" title="File Format Features"></a>File Format Features</h3><p>è¿™ä¸ªæˆ‘å¯å¤ªæ‡‚äº†â€¦</p><p><img src="https://image.mwish.me/blog-image/862369FC-A797-4C3B-8959-D0CBFCA1A827.png" alt="862369FC-A797-4C3B-8959-D0CBFCA1A827"></p><p>è¿™å›¾æœ‰æ¯”è¾ƒç»†èŠ‚çš„éƒ¨åˆ†ï¼š</p><ol><li>Page æ˜¯æœ‰ä¸åŒçš„åˆ—çš„</li><li>Page å†…åˆ—å—ä¸º blockï¼Œå¯èƒ½æ˜¯ç¼–ç çš„æ•°æ®</li><li>å¦‚æœæ˜¯å­—å…¸ç¼–ç ï¼Œé‚£ä¹ˆå­—å…¸æ˜¯å¯ä»¥ reuse çš„</li></ol><h3 id="Lazy-Data-Loading"><a href="#Lazy-Data-Loading" class="headerlink" title="Lazy Data Loading"></a>Lazy Data Loading</h3><blockquote><p>Connectors can generate lazy blocks, which read, decompress, and decode data only when cells are actually accessed.</p><p>Given that a large fraction of CPU time is spent decompressing and decoding and that it is common for ï¬lters to be highly selective, this optimization is highly effective when columns are infrequently accessed.</p></blockquote><p>è¿™é‡Œç±»ä¼¼ <code>Select a where b &lt; xxx;</code> çš„æ—¶å€™ï¼Œå¦‚æœè¿‡æ»¤æ•ˆç‡å¥½ï¼Œå¾ˆå¤š a ç›¸å…³çš„åˆ—å°±ä¸ç”¨ä¸€èµ·è§£å‹äº†ï¼Œä½†å®ç°èµ·æ¥å…¶å®æ˜¯å¾ˆå¤šè„æ´»çš„ã€‚</p><h3 id="Operating-on-Compressed-Data"><a href="#Operating-on-Compressed-Data" class="headerlink" title="Operating on Compressed Data"></a>Operating on Compressed Data</h3><p>å‚è€ƒ abadi çš„è®ºæ–‡ï¼Œæˆ‘ä¹‹å‰åšå®¢ä¹Ÿæåˆ°è¿‡ï¼š<a href="https://blog.mwish.me/2022/01/15/format-thinking-2/#DB-%E7%9B%B4%E6%8E%A5%E5%9C%A8%E5%8E%8B%E7%BC%A9%E7%9A%84%E6%95%B0%E6%8D%AE%E4%B8%8A%E8%BF%9B%E8%A1%8C%E8%AE%A1%E7%AE%97">https://blog.mwish.me/2022/01/15/format-thinking-2/#DB-%E7%9B%B4%E6%8E%A5%E5%9C%A8%E5%8E%8B%E7%BC%A9%E7%9A%84%E6%95%B0%E6%8D%AE%E4%B8%8A%E8%BF%9B%E8%A1%8C%E8%AE%A1%E7%AE%97</a></p><h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><ol><li>Trino: The Definition Guide (è¿™æœ¬ä¹¦æœ‰ç¬¬äºŒç‰ˆï¼Œä½†æˆ‘æ²¡ä¸‹è½½åˆ°é è°±çš„ï¼Œæ‰€ä»¥ç¿»äº†ä¸‹ç¬¬ä¸€ç‰ˆ)</li><li>Prestoæ¦‚è¿°ï¼šç‰¹æ€§ã€åŸç†ã€æ¶æ„ <a href="https://zhuanlan.zhihu.com/p/260399749">https://zhuanlan.zhihu.com/p/260399749</a> </li><li>Presto Explain: <a href="https://prestodb.io/docs/current/sql/explain.html">https://prestodb.io/docs/current/sql/explain.html</a></li><li>åˆ†å¸ƒå¼SQLæŸ¥è¯¢å¼•æ“åŸç†ï¼ˆä»¥Presto SQLä¸ºä¾‹ï¼‰<a href="https://zhuanlan.zhihu.com/p/293775390">https://zhuanlan.zhihu.com/p/293775390</a></li><li>Presto æ˜¯å¦‚ä½• schedule task çš„? <a href="https://zhuanlan.zhihu.com/p/58959725">https://zhuanlan.zhihu.com/p/58959725</a></li><li>Presto æ•°æ®å¦‚ä½•è¿›è¡Œshuffle <a href="https://zhuanlan.zhihu.com/p/61565957">https://zhuanlan.zhihu.com/p/61565957</a></li><li><a href="https://docs.qq.com/slide/DZVhBRlhqc2dhVHda">https://docs.qq.com/slide/DZVhBRlhqc2dhVHda</a></li></ol>]]></content>
      
      
      <categories>
          
          <category> bigdata </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>Parquet Part3: read rep and def levels</title>
      <link href="/2022/10/19/Parquet-Part3-read-rep-and-def-levels/"/>
      <url>/2022/10/19/Parquet-Part3-read-rep-and-def-levels/</url>
      
        <content type="html"><![CDATA[<p>ä¹‹å‰çš„ Part2 ä»‹ç»äº† Parquet çš„ rep-level, def-level çš„å†™å…¥. Parquet ä¼šæ ¹æ®ç”¨æˆ·è¾“å…¥çš„ <code>Array</code>ï¼Œæ¥æ ¹æ® schema çš„åµŒå¥—å’Œä¸­é—´çš„å…ƒæ•°æ®ï¼Œç»™ä¸€ä¸ª column çš„æ•°æ®æ„å»ºå¯¹åº”çš„æ ˆã€‚åœ¨è¿è¡Œçš„æ—¶å€™ï¼Œè¿™é‡Œä¼šæ‰¾åˆ°è¿ç»­çš„å­—æ®µï¼Œç„¶åç»™å®šå¯¹åº”çš„ rep-level å’Œ def-level æ¥å¡«å……æ•°æ®ã€‚</p><p>åœ¨å†™å…¥çš„æ—¶å€™ï¼Œç”¨æˆ·ä¼šç»™å®šä¸€ä¸ª <code>Array</code>ï¼Œç„¶åè®© Parquet æŠŠ array ä¸­çš„æ•°æ®åºåˆ—åŒ–æˆ <code>rep-level</code>, <code>def-level</code> å’Œå€¼ï¼Œè¿™äº›ä¸œè¥¿ä¼šè¢«ç¼–ç åˆ° <code>Page</code> ä¸­ï¼Œä»¥ <code>DATA_PAGE_V2</code> ä¸ºä¾‹ï¼š</p><ol><li>ä¼šæœ‰ä¸ª PageHeaderï¼Œå‘Šè¯‰ä½ æœ‰æ²¡æœ‰ rep-level å’Œ def-levelï¼Œå’Œå¯¹åº”é•¿åº¦</li><li>rep-level å’Œ def-level è¢« rle/bit-packing ç¼–ç </li><li>Page å¯èƒ½è¢«ç¼–ç ä¸å‹ç¼©ï¼Œä¼šè®°å½•ç›¸å…³çš„å†…å®¹</li></ol><p>è¯»å–çš„æ—¶å€™ï¼Œè¿™äº›ä¸œè¥¿ä¹Ÿä¼šæŒ‰ç…§ schema è§£æï¼Œä½†æ˜¯éœ€è¦å›è¿‡å¤´æ¥æ³¨æ„ä¸€ä¸‹ï¼Œè¯»å–çš„æ—¶å€™ä¹Ÿæ˜¯ä¸€ä¸ªå±‚æ¬¡è¯»å–ï¼Œä½†æ˜¯éœ€è¦ä»ä¸€ç»„ rep-level / def-level æ¥æ¢å¤å¤šå±‚çš„ä¿¡æ¯äº†ã€‚</p><p>æˆ‘ä»¬å¯ä»¥å†å›é¡¾ä¸€ä¸‹ï¼Œ<code>parquet</code> åœ¨ arrow é¡¹ç›®çš„è·¯å¾„æ˜¯ï¼š<code>cpp/src/parquet/</code>:</p><ol><li><code>cpp/src/parquet/</code>ï¼šç›®å½•ä¸‹æœ‰åŸºæœ¬çš„ parquet çš„ schema å’Œå®ç°ï¼ŒåŒ…æ‹¬ Page çš„å¤„ç†ã€å‹ç¼©ã€column çš„å¤„ç†ï¼Œè¿™é‡Œéƒ½æ˜¯ç¬¦åˆæ ‡å‡†çš„ï¼Œå®ƒä¼šå€Ÿç”¨éƒ¨åˆ† <code>arrow</code> çš„åº“å’Œå®ç°</li><li><code>cpp/src/parquet/arrow</code>ï¼š<code>arrow</code> çš„è½¬ä¹‰å±‚ï¼Œèƒ½å¤ŸæŠŠ arrow çš„ä¸œè¥¿è§£æè¯»ã€å†™åˆ° parquet ä¸Šï¼Œè¿™é‡Œçš„ <code>FileReader</code> ç­‰éƒ½ä¼šåŒ…è£… <code>cpp/src/parquet</code> ä¸Šçš„æ•°æ®ï¼Œç„¶åå¤„ç† <code>rep-level</code> å’Œ <code>def-level</code>ã€‚<strong>ä¸Šä¸€ç¯‡åšå®¢é‡Œé¢ levels çš„æ„å»ºå°±æ˜¯åœ¨ arrow ä¸‹é¢çš„ </strong>ã€‚</li></ol><p>Arrow è¯»å–çš„å¯¹åº”é“¾è·¯å¤§æ¦‚å¦‚ä¸‹ï¼š</p><ol><li><code>ParquetFileReader</code> æ˜¯æœ€å¤–å±‚çš„æ•°æ®ï¼Œç”¨ <code>ParquetFileReader::Open</code> ç­‰ç›¸å…³çš„ api æ¥æ‰“å¼€å¯¹åº”çš„æ–‡ä»¶ã€‚è¿™é‡Œå¯ä»¥æ ¹æ® <code>RowGroup(rgId)</code> è¿™ä¸ªå‡½æ•°ï¼Œåˆ›å»ºå¯¹åº”çš„ <code>RowGroupReader</code></li><li><code>SerializedFile</code> å®ç°äº† <code>ParquetFileReader::Contents</code>ï¼Œå…·ä½“å®ç°äº† <code>ParquetFileReader</code> çš„å¯¹åº”é€»è¾‘ï¼Œå®ƒå¯ä»¥åŠ è½½ parquet çš„ footerï¼Œç„¶åè§£æ Footerã€‚æ ¹æ®è§£æçš„ Footer æ¥åŠ è½½å¯¹åº”çš„ <code>RowGroupReader</code><ol><li>åœ¨æ–‡ä»¶ IO ä¸Šï¼Œè¿™é‡Œæœ‰ä¸€ä¸ª <code>::arrow::io::internal::ReadRangeCache</code> è¡¨ç¤ºå¯¹æŸä¸ªèŒƒå›´çš„ cachingã€‚ç„¶åæœ‰ä¸€ç»„å’Œè¿™ä¸ªæœ‰å…³çš„ api è¡¨ç¤ºæ˜¯å¦ç¼“å­˜</li><li><code>ReaderProperties</code> è¡¨ç¤ºè¿™ä¸ª Reader çš„é…ç½®ï¼Œæ¯”å¦‚æ˜¯å¦ä½¿ç”¨ caching ç­‰</li><li>æœ‰ <code>FileMetaData</code> çš„ APIï¼Œæ³¨æ„ï¼Œè¿™ä¸ªç›¸å½“äºå¯¹ parquet ä¾èµ–çš„ thrift ç”Ÿæˆçš„ä»£ç çš„ wrapperã€‚Parquet ä¸å¯¹å¤–æš´éœ² thriftï¼Œè€Œæ˜¯æš´éœ²å¯¹åº”çš„è‡ªå·±çš„ API Wrapperï¼Œæ€ä¹ˆè¯´å‘¢ï¼Œå¯ä»¥è¯´è¿™ä¸ªæŠ½è±¡æ¯”è¾ƒå¥½ï¼Œä½†æ˜¯æ€§èƒ½ä¹Ÿç¡®å®æ¯”è¾ƒæŒ«ï¼ˆè€ƒè™‘æç«¯åœºæ™¯ï¼Œåªéœ€è¦ä¸€ä¸ª countï¼Œä¹Ÿå¾—æŠŠ Footer æ•´ä¸ªè§£æï¼‰</li></ol></li><li><code>RowGroupReader</code>å¯ä»¥è¿”å› <code>parquet::ColumnReader</code> å’ŒæŸä¸ª Column çš„ <code>PageReader</code></li><li><code>SerializedRowGroup</code> å®ç°äº† <code>RowGroupReader::Contents</code>ï¼ŒæŒæœ‰æŸä¸ª RowGroup çš„ MetaData</li><li><code>PageReader</code> æœ‰ <code>SerializedPageReader</code> è¿™ä¸ªå®ç°ï¼Œå¯¹å¤–è¿”å›å¯¹åº”çš„è§£å‹ä¹‹åçš„ <code>Page</code> å¯¹è±¡ï¼Œè¿™é‡Œå¯ä»¥æ˜¯æ•°æ®é¡µã€å­—å…¸é¡µé¢ã€Index Pageã€‚</li><li><code>parquet::ColumnReader</code> åœ¨ <code>PageReader</code> ä¸ŠåŒ…è£…äº†ä¸€å±‚è®°å½•è¯»å–çš„ APIï¼Œæ ¹æ® <code>ReadBatch</code> å’Œ <code>ReadBatchSpaced</code> ä¹‹ç±»çš„ api æ¥è¯»å–å¯¹åº”çš„æ•°æ®ï¼Œç„¶åè¿”å›ç»™ä¸Šå±‚ã€‚è¿™é‡Œä¹Ÿä¼šè¯»å– <code>Page</code> ä¸Šçš„ Levelï¼Œæ¥æ¢å¤å¯¹åº”çš„è®°å½•</li><li><code>parquet::arrow</code> æ¨¡å—ä¼šè°ƒç”¨ä¸Šæ–‡å¯¹åº”çš„ä¸œè¥¿ï¼Œå®ƒæœ‰ä¸€ä¸ª <code>ColumnReader</code>ï¼Œæ³¨æ„è¿™ä¸ª <code>ColumnReader</code> ä¸è¦å’Œä¸Šé¢ <code>ColumnReader</code> ææ··äº†ï¼Œè¿™æ˜¯ç”¨æ¥æ¢å¤ <code>Array</code> çš„</li></ol><h3 id="è¯»å–-Parquet-ä¸­çš„é“¾è·¯"><a href="#è¯»å–-Parquet-ä¸­çš„é“¾è·¯" class="headerlink" title="è¯»å–: Parquet ä¸­çš„é“¾è·¯"></a>è¯»å–: Parquet ä¸­çš„é“¾è·¯</h3><p>è¿™å—è¯»å–æ¯”å†™å…¥ç®€å•å¾ˆå¤šï¼Œå¤§æ¦‚æ˜¯ï¼š</p><ol><li>æ¯ä¸€åˆ—è¯» rep-level, def-level è‡ªå·±å°±èƒ½æ¢å¤è‡ªå·±è¿™å±‚çš„æ•°æ®</li><li>ä¸Šå±‚æ‰¾åˆ° children çš„ levelï¼Œç„¶åå¯ä»¥æ¢å¤</li></ol><p>æ‰€æœ‰çš„æ¢å¤éƒ½ç»ç”± <code>ColumnReader</code>ï¼Œå¶å­ç»“ç‚¹æ¢å¤å®ç°åœ¨ <code>TypedRecordReader</code> ä¸­ï¼Œ<code>LeafReader</code> åˆ›å»º <code>TypeRecordReader</code> æ¥è¯»å–ã€‚è€Œä¸Šå±‚åœ¨ <code>ListReader</code> å’Œ <code>StructReader</code> ä¸­æ¢å¤ï¼Œæ¢å¤çš„æ—¶å€™éœ€è¦ä»å­èŠ‚ç‚¹ä¸­æŒ‘é€‰ä¸€ä¸ª <code>TypedRecordReader</code> æ¥æ¢å¤ä¸€äº›ä¿¡æ¯. <code>ColumnReader</code> è¿™ä¸ª API åªæœ‰å¶å­ç»“ç‚¹æœ‰ã€‚</p><p><code>ColumnReader</code> çš„ API éå¸¸ç®€å•ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">PARQUET_EXPORT</span> ColumnReader &#123;</span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="keyword">virtual</span> ~<span class="built_in">ColumnReader</span>() = <span class="keyword">default</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="type">static</span> std::shared_ptr&lt;ColumnReader&gt; <span class="title">Make</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">      <span class="type">const</span> ColumnDescriptor* descr, std::unique_ptr&lt;PageReader&gt; pager,</span></span></span><br><span class="line"><span class="params"><span class="function">      ::arrow::MemoryPool* pool = ::arrow::default_memory_pool())</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Returns true if there are still values in this column.</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="type">bool</span> <span class="title">HasNext</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> Type::type <span class="title">type</span><span class="params">()</span> <span class="type">const</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="type">const</span> ColumnDescriptor* <span class="title">descr</span><span class="params">()</span> <span class="type">const</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Get the encoding that can be exposed by this reader. If it returns</span></span><br><span class="line">  <span class="comment">// dictionary encoding, then ReadBatchWithDictionary can be used to read data.</span></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  <span class="comment">// \note API EXPERIMENTAL</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> ExposedEncoding <span class="title">GetExposedEncoding</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">protected</span>:</span><br><span class="line">  <span class="keyword">friend</span> <span class="keyword">class</span> <span class="title class_">RowGroupReader</span>;</span><br><span class="line">  <span class="comment">// Set the encoding that can be exposed by this reader.</span></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  <span class="comment">// \note API EXPERIMENTAL</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">SetExposedEncoding</span><span class="params">(ExposedEncoding encoding)</span> </span>= <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæœ‰ä¸€äº›åˆ«çš„ç»“æ„ï¼Œæˆ‘ä»¬å…ˆæ¥æ•´ç†ä¸€ä¸‹ç»§æ‰¿å…³ç³»ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// æä¾›äº† ReadBatch, ReadBatchSpaced å’Œ Skip, ä¾¿äºç”¨æˆ·è¯»å–æŸä¸€åˆ—çš„å…·ä½“æ•°æ®.</span></span><br><span class="line"><span class="comment">/// è¿™ä¸ªä¹Ÿæ˜¯ä¸€ä¸ªæ¥å£å±‚, ç›¸å¯¹ `ColumnReader` æä¾›äº†é€šç”¨çš„æ¥å£, è¿™é‡Œæä¾›äº† Batch è¯»æŸä¸ªç±»å‹çš„æ¥å£. </span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> DType&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TypedColumnReader</span> : <span class="keyword">public</span> ColumnReader &#123;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// å®ç°äº†ä»æŸä¸ª decoder æ¥è¯» values, è¯» rep-level å’Œ def-levels.</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// è¿™é‡Œä¹Ÿæœ‰ä¸€äº›åˆ—ç»´æŠ¤çš„ä¿¡æ¯, æ¯”å¦‚å¯¹åº”çš„ decoder, è¿˜æœ‰ä¸€äº›é™æ€ä¿¡æ¯, æ¯”å¦‚ Column å¯¹åº”çš„æœ€å¤§çš„ def-level å’Œ</span></span><br><span class="line"><span class="comment">/// rep-level, è®°åš descr å’Œ level info.</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// è¿™é‡Œæ˜¯ Column Reader, æ‰€ä»¥å¤„ç†è¿”å›å¯¹åº”çš„æ˜¯ ColumnChunk, è¿™é‡Œä¼šç»´æŠ¤éœ€è¦å¤„ç†çš„ value æ•°é‡ </span></span><br><span class="line"><span class="comment">///  (ColumnMetaData ä¼šè®°å½• `num_values`, ä»£è¡¨å€¼è€Œéè¡Œ)</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// è¿™é‡Œä¹Ÿå¤„ç†äº† levels (rep-level å’Œ def-level) çš„ decoder, å› ä¸ºè¿™ä¸¤ä¸ªå’ŒæŸä¸ªå…·ä½“çš„ç±»å‹æ˜¯æ— å…³çš„.</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> DType&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ColumnReaderImplBase</span> &#123;</span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="keyword">using</span> T = <span class="keyword">typename</span> DType::c_type;</span><br><span class="line">  <span class="keyword">using</span> DecoderType = TypedDecoder&lt;DType&gt;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// å…·ä½“çš„ reader å®ç°, å®ç°äº† ReadBatch, ReadBatchSpaced å’Œ Skip.</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> DType&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TypedColumnReaderImpl</span> : <span class="keyword">public</span> TypedColumnReader&lt;DType&gt;,</span><br><span class="line">                              <span class="keyword">public</span> ColumnReaderImplBase&lt;DType&gt; &#123;</span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="keyword">using</span> T = <span class="keyword">typename</span> DType::c_type;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œå…·ä½“å®ç°ä¼šåœ¨ <code>TypedColumnReader</code> å’Œ <code>TypedColumnReaderImpl</code> ä¸­ã€‚å¯¹å¤–æ¥å£æœ‰ <code>Skip</code>, <code>ReadBatch</code>ï¼Œæœ‰ä¸€ä¸ªæ¯”è¾ƒå¤æ‚çš„ <code>ReadBatchSpaced</code> çš„æ¥å£å·²ç» deprecated äº†ã€‚</p><p>æˆ‘ä»¬ä¸“æ³¨åœ¨ <code>ReadBatch</code> ä¸Šï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// API to read values from a single column. This is a main client facing API.</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> DType&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TypedColumnReader</span> : <span class="keyword">public</span> ColumnReader &#123;</span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="keyword">typedef</span> <span class="keyword">typename</span> DType::c_type T;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Read a batch of repetition levels, definition levels, and values from the</span></span><br><span class="line">  <span class="comment">// column.</span></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  <span class="comment">// Since null values are not stored in the values, the number of values read</span></span><br><span class="line">  <span class="comment">// may be less than the number of repetition and definition levels. With</span></span><br><span class="line">  <span class="comment">// nested data this is almost certainly true.</span></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  <span class="comment">// Set def_levels or rep_levels to nullptr if you want to skip reading them.</span></span><br><span class="line">  <span class="comment">// This is only safe if you know through some other source that there are no</span></span><br><span class="line">  <span class="comment">// undefined values.</span></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  <span class="comment">// To fully exhaust a row group, you must read batches until the number of</span></span><br><span class="line">  <span class="comment">// values read reaches the number of stored values according to the metadata.</span></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  <span class="comment">// This API is the same for both V1 and V2 of the DataPage</span></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  <span class="comment">// @returns: actual number of levels read (see values_read for number of values read)</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="type">int64_t</span> <span class="title">ReadBatch</span><span class="params">(<span class="type">int64_t</span> batch_size, <span class="type">int16_t</span>* def_levels, <span class="type">int16_t</span>* rep_levels,</span></span></span><br><span class="line"><span class="params"><span class="function">                            T* values, <span class="type">int64_t</span>* values_read)</span> </span>= <span class="number">0</span>;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œï¼Œä¼šæ ¹æ® <code>batch_size</code> æ¥å¡«å……æ•°æ®ï¼Œè¿™é‡Œåˆ†ä¸ºï¼š</p><ol><li><code>def_levels</code> å’Œ <code>rep_levels</code>ï¼Œä¸¤ä¸ª <code>i16</code> æ•°ç»„ï¼Œä»£è¡¨å¯¹åº”çš„ levelsï¼Œå¯èƒ½æ²¡æœ‰è¯»ï¼Œè¿™ä¸¤ä¸ªæ˜¯ç­‰é•¿çš„ï¼ˆä¸ç­‰é•¿ä¼šæŠ›å‡º exceptionï¼‰</li><li><code>values</code>ï¼Œå…·ä½“çš„å€¼</li><li><code>values_read</code>, ä»£è¡¨å…·ä½“ä»å­˜å‚¨è¯»äº†å¤šå°‘<strong>é null å€¼</strong>ã€‚å°½é‡ä» rep_levels å’Œ def_levels æ¥åˆ¤æ–­è¿™ä¸ªå€¼</li></ol><p>çœ‹çœ‹å®ç°ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> DType&gt;</span><br><span class="line"><span class="type">int64_t</span> TypedColumnReaderImpl&lt;DType&gt;::<span class="built_in">ReadBatch</span>(<span class="type">int64_t</span> batch_size, <span class="type">int16_t</span>* def_levels,</span><br><span class="line">                                                <span class="type">int16_t</span>* rep_levels, T* values,</span><br><span class="line">                                                <span class="type">int64_t</span>* values_read) &#123;</span><br><span class="line">  <span class="comment">// HasNext invokes ReadNewPage</span></span><br><span class="line">  <span class="keyword">if</span> (!<span class="built_in">HasNext</span>()) &#123;</span><br><span class="line">    *values_read = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// TODO(wesm): keep reading data pages until batch_size is reached, or the</span></span><br><span class="line">  <span class="comment">// row group is finished</span></span><br><span class="line">  <span class="type">int64_t</span> num_def_levels = <span class="number">0</span>;</span><br><span class="line">  <span class="type">int64_t</span> values_to_read = <span class="number">0</span>;</span><br><span class="line">  <span class="comment">// è¯» levels, ç„¶åä¹Ÿåˆ¤æ–­å‡ºå“ªäº›æ˜¯ null, å¦‚æœæœ‰ null æˆ–è€…é‡Œé¢æ¶ˆè´¹å®Œäº†, å…·ä½“è¦è¯»çš„å€¼å¯èƒ½ä¼šå°äº `batch_size`.</span></span><br><span class="line">  <span class="built_in">ReadLevels</span>(batch_size, def_levels, rep_levels, &amp;num_def_levels, &amp;values_to_read);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è¯»å–é null çš„ value, åœ¨æ²¡æœ‰è¯»å®Œè¿™ä¸ª Page çš„æ—¶å€™, values_read == values.</span></span><br><span class="line">  *values_read = <span class="keyword">this</span>-&gt;<span class="built_in">ReadValues</span>(values_to_read, values);</span><br><span class="line">  <span class="type">int64_t</span> total_values = std::<span class="built_in">max</span>(num_def_levels, *values_read);</span><br><span class="line">  <span class="type">int64_t</span> expected_values =</span><br><span class="line">      std::<span class="built_in">min</span>(batch_size, <span class="keyword">this</span>-&gt;num_buffered_values_ - <span class="keyword">this</span>-&gt;num_decoded_values_);</span><br><span class="line">  <span class="keyword">if</span> (total_values == <span class="number">0</span> &amp;&amp; expected_values &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    std::stringstream ss;</span><br><span class="line">    ss &lt;&lt; <span class="string">&quot;Read 0 values, expected &quot;</span> &lt;&lt; expected_values;</span><br><span class="line">    ParquetException::<span class="built_in">EofException</span>(ss.<span class="built_in">str</span>());</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">this</span>-&gt;<span class="built_in">ConsumeBufferedValues</span>(total_values);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> total_values;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä¼šï¼š</p><ol><li>æ ¹æ® <code>batch_size</code> å’Œå†…éƒ¨çš„çŠ¶æ€ï¼Œçœ‹çœ‹è¯»å¤šå°‘å€¼ï¼Œç„¶åè§£æå¯¹åº”çš„ <code>levels</code>ã€‚( <code>ReadLevels</code> )</li><li>è¯»å–å¯¹åº”çš„é null çš„ values (<code>ReadValues</code>, é‡Œé¢ä¼šè°ƒç”¨ <code>decoder-&gt;Decode</code>)</li><li>è¿”å›çš„æ˜¯è¯»çš„æ‰€æœ‰åŒ…æ‹¬ null çš„å€¼çš„æ•°ç›®ï¼Œ<code>values_read</code> ä¼šå­˜æ”¾ <code>values</code> ä¸­å†…å®¹çš„é•¿åº¦ (<code>ConsumeBufferedValues</code> )</li></ol><p>è¿™é‡Œæˆ‘ä»¬é‡ç”³ä¸€ä¸ªæ¯”è¾ƒ hack çš„åœ°æ–¹ï¼Œå°±æ˜¯å˜é‡åç§°é—®é¢˜ï¼Œè¿™ä¸ªä¹Ÿæ¶‰åŠåˆ°ä¸€äº› Decoder å†…éƒ¨çš„é€»è¾‘ï¼š</p><ol><li><code>num_buffered_values_</code>: Page ä¸­çš„ <strong>values</strong> çš„æ°´ä½</li><li><code>num_decoded_values_</code>: decode æˆåŠŸåå‡ºå»çš„ <strong>values</strong> çš„æ°´ä½</li></ol><p>ä½ ä¼šå‘ç°æˆ‘è¿™é‡Œçš„ç”¨è¯æ˜¯ Levels è€Œä¸æ˜¯ Valuesâ€¦æˆ‘ä»¬çœ‹çœ‹ä¹‹å‰åšå®¢é‡Œçš„ <code>num_values</code> çš„é€»è¾‘( <a href="https://blog.mwish.me/2022/09/18/Parquet-Part1-Basic/">https://blog.mwish.me/2022/09/18/Parquet-Part1-Basic/</a> )ï¼š</p><blockquote><p>DataPageV2 ä¼šæœ‰ <code>num_rows</code>ï¼Œè¡¨ç¤ºå¯¹åº”è¡Œçš„æ•°é‡ã€‚<strong>åœ¨æœ‰åµŒå¥—çš„æƒ…å†µä¸‹ï¼Œè¿™ä¸ªä¸ç­‰äº <code>num_values</code></strong>.</p><p>è¿™é‡Œä»£è¡¨çš„æ˜¯ã€ŒåŒ…æ‹¬ nullsï¼Œè¿™ä¸ª <code>ColumnChunk</code> å¯¹åº”å€¼çš„æ•°é‡ã€è€Œéã€Œè¿™ä¸ª <code>ColumnChunk</code> å¯¹åº”è¡Œçš„æ•°é‡ã€ã€‚è¿™ä¸ªåœ°æ–¹æˆ‘è¯´çš„å¯èƒ½æœ‰ä¸€ç‚¹éš¾ç†è§£ï¼Œæ¯”å¦‚å¯¹äº <code>optional i32</code> çš„å¹³å¦æ•°æ®ï¼Œè¿™é‡Œç­‰ä»·äºè¡Œæ•°ï¼Œè€Œå¯¹äº <code>repeated &lt;optional i32&gt;</code>ï¼Œè¿™é‡Œä»£è¡¨å†…å±‚çš„æ•°é‡ã€‚<code>PageHeader</code> çš„ <code>num_values</code> ä¹ŸåŒç†ã€‚</p></blockquote><p>è¿™é‡Œä¼šæ ¹æ® page æ¥è®¾ç½®å¯¹åº”çš„å€¼ï¼ŒåŒæ—¶è·Ÿ <code>HasNextInternal()</code> è¿™ä¸ªæ¥å£è”åˆä½¿ç”¨ï¼Œæ¥ä¸åœ fetch pageã€‚ï¼ˆvalues, rows/record, levels è¿™äº›æ¦‚å¿µæ¯”è¾ƒæ··ä¹±ï¼Œæ³¨æ„åŒºåˆ†ï¼‰ã€‚</p><p>è¿™ä¸ªåœ°æ–¹è§£æäº†å¯¹åº”çš„ä¸œè¥¿ï¼Œç„¶åè¿”å›äº†å¯¹åº”çš„æ•°å€¼ã€‚å½“ç„¶ï¼Œè¿™é‡Œé€»è¾‘æ¯”è¾ƒç®€å•ã€‚</p><p>è¿™ä¸ªåœ°æ–¹å¯ä»¥æ€»ç»“æ€§è´¨çš„æ”¾ä¸€å¼ æµç¨‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ç±»å‹ç»„åˆ:</span><br><span class="line">- ColumnReader(ColumnReaderImpl, TypedColumnReader): åŒ…å«æ•°æ® decoder, rep-level å’Œ def-level çš„ Decoder, page reader</span><br><span class="line">- RecordReader(æ³¨å†Œæ•°æ®çš„ buffer, rep-level buffer, def-level buffer, page buffer)</span><br></pre></td></tr></table></figure><h4 id="TypedRecordReader-ç»„ç»‡æˆè¾“å‡ºè¡Œè€Œä¸æ˜¯è¾“å‡º-Value"><a href="#TypedRecordReader-ç»„ç»‡æˆè¾“å‡ºè¡Œè€Œä¸æ˜¯è¾“å‡º-Value" class="headerlink" title="TypedRecordReader: ç»„ç»‡æˆè¾“å‡ºè¡Œè€Œä¸æ˜¯è¾“å‡º Value"></a>TypedRecordReader: ç»„ç»‡æˆè¾“å‡ºè¡Œè€Œä¸æ˜¯è¾“å‡º Value</h4><p><code>TypedRecordReader</code> æä¾›äº†ä¸€ç»„å¤æ‚ä¸€ç‚¹çš„å‡½æ•°ï¼š<code>ReadRecords</code> å’Œ <code>ReadRecordData</code>ï¼Œè¿™ä¸ªå°±ç›¸å½“äºã€Œè¯»ä¸Šå±‚çš„å‡ è¡Œã€äº†ã€‚è¿™ä¸ªæ˜¯ç»™ <code>parquet::arrow</code> å‡†å¤‡çš„ç»“æ„ã€‚</p><p>è¿™å¥—ç›¸å½“äºæŠŠ Values çš„è¯»å–äº¤ç»™ <code>ColumnReaderImpl</code> å±‚ï¼Œç„¶ååœ¨ä¸Šé¢å°è£…äº† Row çš„ Readã€‚å®ƒç›¸å½“äºä¸€ä¸ªç‰¹ç§ç±»å‹çš„è®°å½•ç»„ç»‡å™¨ï¼Œèƒ½è¡¨ç¤ºå…·ä½“å¤„ç†çš„ã€Œè¡Œã€ï¼Œè€Œ <code>ColumnReader</code> å¤„ç†çš„å†…å®¹æ˜¯ â€œvaluesâ€.</p><p>è¿™éƒ¨åˆ†ç›¸å½“äº</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> internal &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// \brief Stateful column reader that delimits semantic records for both flat</span></span><br><span class="line"><span class="comment">/// and nested columns</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// \note API EXPERIMENTAL</span></span><br><span class="line"><span class="comment">/// \since 1.3.0</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">RecordReader</span> &#123;</span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="function"><span class="type">static</span> std::shared_ptr&lt;RecordReader&gt; <span class="title">Make</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">      <span class="type">const</span> ColumnDescriptor* descr, LevelInfo leaf_info,</span></span></span><br><span class="line"><span class="params"><span class="function">      ::arrow::MemoryPool* pool = ::arrow::default_memory_pool(),</span></span></span><br><span class="line"><span class="params"><span class="function">      <span class="type">const</span> <span class="type">bool</span> read_dictionary = <span class="literal">false</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">virtual</span> ~<span class="built_in">RecordReader</span>() = <span class="keyword">default</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// \brief Attempt to read indicated number of records from column chunk</span></span><br><span class="line">  <span class="comment">/// \return number of records read</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="type">int64_t</span> <span class="title">ReadRecords</span><span class="params">(<span class="type">int64_t</span> num_records)</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// \brief Pre-allocate space for data. Results in better flat read performance</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">Reserve</span><span class="params">(<span class="type">int64_t</span> num_values)</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// \brief Clear consumed values and repetition/definition levels as the</span></span><br><span class="line">  <span class="comment">/// result of calling ReadRecords</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">Reset</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// \brief Transfer filled values buffer to caller. A new one will be</span></span><br><span class="line">  <span class="comment">/// allocated in subsequent ReadRecords calls</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> std::shared_ptr&lt;ResizableBuffer&gt; <span class="title">ReleaseValues</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// \brief Transfer filled validity bitmap buffer to caller. A new one will</span></span><br><span class="line">  <span class="comment">/// be allocated in subsequent ReadRecords calls</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> std::shared_ptr&lt;ResizableBuffer&gt; <span class="title">ReleaseIsValid</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// \brief Return true if the record reader has more internal data yet to</span></span><br><span class="line">  <span class="comment">/// process</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="type">bool</span> <span class="title">HasMoreData</span><span class="params">()</span> <span class="type">const</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// \brief Advance record reader to the next row group</span></span><br><span class="line">  <span class="comment">/// \param[in] reader obtained from RowGroupReader::GetColumnPageReader</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">SetPageReader</span><span class="params">(std::unique_ptr&lt;PageReader&gt; reader)</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">DebugPrintState</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// \brief Decoded definition levels</span></span><br><span class="line">  <span class="function"><span class="type">int16_t</span>* <span class="title">def_levels</span><span class="params">()</span> <span class="type">const</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">reinterpret_cast</span>&lt;<span class="type">int16_t</span>*&gt;(def_levels_-&gt;<span class="built_in">mutable_data</span>());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// \brief Decoded repetition levels</span></span><br><span class="line">  <span class="function"><span class="type">int16_t</span>* <span class="title">rep_levels</span><span class="params">()</span> <span class="type">const</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">reinterpret_cast</span>&lt;<span class="type">int16_t</span>*&gt;(rep_levels_-&gt;<span class="built_in">mutable_data</span>());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// \brief Decoded values, including nulls, if any</span></span><br><span class="line">  <span class="function"><span class="type">uint8_t</span>* <span class="title">values</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> values_-&gt;<span class="built_in">mutable_data</span>(); &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// \brief Number of values written including nulls (if any)</span></span><br><span class="line">  <span class="function"><span class="type">int64_t</span> <span class="title">values_written</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> values_written_; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// \brief Number of definition / repetition levels (from those that have</span></span><br><span class="line">  <span class="comment">/// been decoded) that have been consumed inside the reader.</span></span><br><span class="line">  <span class="function"><span class="type">int64_t</span> <span class="title">levels_position</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> levels_position_; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// \brief Number of definition / repetition levels that have been written</span></span><br><span class="line">  <span class="comment">/// internally in the reader</span></span><br><span class="line">  <span class="function"><span class="type">int64_t</span> <span class="title">levels_written</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> levels_written_; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// \brief Number of nulls in the leaf</span></span><br><span class="line">  <span class="function"><span class="type">int64_t</span> <span class="title">null_count</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> null_count_; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// \brief True if the leaf values are nullable</span></span><br><span class="line">  <span class="function"><span class="type">bool</span> <span class="title">nullable_values</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> nullable_values_; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// \brief True if reading directly as Arrow dictionary-encoded</span></span><br><span class="line">  <span class="function"><span class="type">bool</span> <span class="title">read_dictionary</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> read_dictionary_; &#125;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">protected</span>:</span><br><span class="line">  <span class="type">bool</span> nullable_values_;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å†…éƒ¨çŠ¶æ€, è¡¨ç¤ºç°åœ¨çš„è®°å½•æ˜¯å¦æ˜¯åœ¨æŸè¡Œçš„è¡Œé¦–, ç”¨æ¥æ¨è¿› records_read</span></span><br><span class="line">  <span class="type">bool</span> at_record_start_;</span><br><span class="line">  <span class="comment">// è¯»çš„è¡Œæ•°çš„è®¡æ•°</span></span><br><span class="line">  <span class="type">int64_t</span> records_read_;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// values çŠ¶æ€çš„è®°å½•å™¨.</span></span><br><span class="line">  <span class="comment">// è¿™éƒ¨åˆ†ä¹Ÿéœ€è¦å¤„ç†</span></span><br><span class="line">  <span class="type">int64_t</span> values_written_;</span><br><span class="line">  <span class="type">int64_t</span> values_capacity_;</span><br><span class="line">  <span class="type">int64_t</span> null_count_;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ä¸‹é¢è¿™é‡Œæä¾›äº†ä¸€ä¸ª buffer</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">// è§£æå‡ºçš„ levels</span></span><br><span class="line">  <span class="type">int64_t</span> levels_written_;</span><br><span class="line">  <span class="comment">// è¡Œ Parsing å®Œçš„ records</span></span><br><span class="line">  <span class="type">int64_t</span> levels_position_;</span><br><span class="line">  <span class="type">int64_t</span> levels_capacity_;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å˜é•¿è®°å½•çš„ value buffer</span></span><br><span class="line">  std::shared_ptr&lt;::arrow::ResizableBuffer&gt; values_;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// In the case of false, don&#x27;t allocate the values buffer (when we directly read into</span></span><br><span class="line">  <span class="comment">// builder classes).</span></span><br><span class="line">  <span class="type">bool</span> uses_values_;</span><br><span class="line"></span><br><span class="line">  std::shared_ptr&lt;::arrow::ResizableBuffer&gt; valid_bits_;</span><br><span class="line">  std::shared_ptr&lt;::arrow::ResizableBuffer&gt; def_levels_;</span><br><span class="line">  std::shared_ptr&lt;::arrow::ResizableBuffer&gt; rep_levels_;</span><br><span class="line"></span><br><span class="line">  <span class="type">bool</span> read_dictionary_ = <span class="literal">false</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œå­˜æ”¾äº†å„ç§å†…å®¹ï¼Œèƒ½åˆ‡æ¢ Page ç„¶åè§£æé“æœ¬åœ°çš„ <code>values_</code> ä¸Šï¼Œæ˜¯ä¸€ä¸ªæœ‰çŠ¶æ€çš„è¯»è€…ã€‚</p><p><code>TypedRecordReader::ReadRecord</code> è¯»å‡ºå…·ä½“çš„æ•°æ®ï¼Œè¿™ä¸ªåœ°æ–¹ä¼šæ ¹æ®ä¸¤ä¸ª level é€‰æ‹©ä»åº•å±‚è¯»å¤šå°‘è¡Œã€‚æœ€é‡è¦çš„å‡½æ•°åœ¨ <code>ReadRecordData</code>ï¼Œè¿™ä¸ªä¼šæŠŠå¯¹åº”çš„é€»è¾‘ç¼–ç»„æˆ arrayï¼Œç„¶åè®¾ç½® nullã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Return number of logical records read</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// è¯»åˆ° level ä¹‹å, æ¥è¯»å…·ä½“æ•°æ®æƒ¹</span></span><br><span class="line"><span class="function"><span class="type">int64_t</span> <span class="title">ReadRecordData</span><span class="params">(<span class="type">int64_t</span> num_records)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// Conservative upper bound</span></span><br><span class="line">  <span class="type">const</span> <span class="type">int64_t</span> possible_num_values =</span><br><span class="line">      std::<span class="built_in">max</span>(num_records, levels_written_ - levels_position_);</span><br><span class="line">  <span class="built_in">ReserveValues</span>(possible_num_values);</span><br><span class="line"></span><br><span class="line">  <span class="type">const</span> <span class="type">int64_t</span> start_levels_position = levels_position_;</span><br><span class="line"></span><br><span class="line">  <span class="type">int64_t</span> values_to_read = <span class="number">0</span>;</span><br><span class="line">  <span class="type">int64_t</span> records_read = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>-&gt;max_rep_level_ &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">// æœ‰é‡å¤æˆ–è€…ç©ºçš„ï¼Œèµ° delimit</span></span><br><span class="line">    records_read = <span class="built_in">DelimitRecords</span>(num_records, &amp;values_to_read);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">this</span>-&gt;max_def_level_ &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">// æ²¡æœ‰é‡å¤ï¼Œåªæœ‰å¯ç©ºã€‚é‚£ä¹ˆ written - position å°±æ˜¯æ•°ç›®.</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// No repetition levels, skip delimiting logic. Each level represents a</span></span><br><span class="line">    <span class="comment">// null or not null entry</span></span><br><span class="line">    records_read = std::<span class="built_in">min</span>(levels_written_ - levels_position_, num_records);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// This is advanced by DelimitRecords, which we skipped</span></span><br><span class="line">    levels_position_ += records_read;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    records_read = values_to_read = num_records;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å…·ä½“è¯»å€¼çš„é€»è¾‘</span></span><br><span class="line">  <span class="type">int64_t</span> null_count = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> (leaf_info_.<span class="built_in">HasNullableValues</span>()) &#123;</span><br><span class="line">    ValidityBitmapInputOutput validity_io;</span><br><span class="line">    validity_io.values_read_upper_bound = levels_position_ - start_levels_position;</span><br><span class="line">    validity_io.valid_bits = valid_bits_-&gt;<span class="built_in">mutable_data</span>();</span><br><span class="line">    validity_io.valid_bits_offset = values_written_;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// def level æ‹†åˆ†</span></span><br><span class="line">    <span class="built_in">DefLevelsToBitmap</span>(<span class="built_in">def_levels</span>() + start_levels_position,</span><br><span class="line">                      <span class="comment">/* level çš„æ•°é‡ */</span> levels_position_ - start_levels_position, leaf_info_,</span><br><span class="line">                      &amp;validity_io);</span><br><span class="line">    values_to_read = validity_io.values_read - validity_io.null_count;</span><br><span class="line">    null_count = validity_io.null_count;</span><br><span class="line">    <span class="built_in">DCHECK_GE</span>(values_to_read, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">ReadValuesSpaced</span>(validity_io.values_read, null_count);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">DCHECK_GE</span>(values_to_read, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">ReadValuesDense</span>(values_to_read);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>-&gt;leaf_info_.def_level &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">// Optional, repeated, or some mix thereof</span></span><br><span class="line">    <span class="keyword">this</span>-&gt;<span class="built_in">ConsumeBufferedValues</span>(levels_position_ - start_levels_position);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// Flat, non-repeated</span></span><br><span class="line">    <span class="keyword">this</span>-&gt;<span class="built_in">ConsumeBufferedValues</span>(values_to_read);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// Total values, including null spaces, if any</span></span><br><span class="line">  values_written_ += values_to_read + null_count;</span><br><span class="line">  null_count_ += null_count;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> records_read;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œè¿˜æ˜¯æ¯”è¾ƒå¤æ‚çš„ï¼Œæœ¬èº«æ˜¯ä¸ªå¤šç»§æ‰¿ï¼Œ<code>TypedRecordReader</code> ç»§æ‰¿äº† <code>ColumnReaderImpl</code> å’Œ <code>RecordReader</code>ï¼Œè¿™ä¸¤ä¸ªéƒ½æ˜¯æœ‰çŠ¶æ€çš„ï¼ŒçŠ¶æ€åˆè´¼å¤šï¼Œæˆ‘è§‰å¾—è®¾è®¡çš„è®©æˆ‘çœ‹äº†å¤´ç—›ã€‚ä½†ä¸Šé¢è¿™æ®µä»£ç å…¶å®æŒºå¥½æ‡‚çš„ï¼š</p><p>è®¡ç®— <code>records_read</code> (è¯»çš„è¡Œ) å’Œ <code>values_to_read</code> éœ€è¦è¯»çš„ <code>rep-level</code> å’Œ <code>def-level</code> ä¸å€¼</p><ol><li>å½“ <code>max_def_level_</code> å’Œ <code>max_rep_level_</code> éƒ½ç­‰äº 0 çš„æ—¶å€™ï¼Œschema æ˜¯å¹³å¦çš„ï¼Œä¸”æ²¡æœ‰å€¼ä¸º nullï¼Œæ‰€ä»¥è¯»çš„ è¡Œå’Œè®°å½•æ•°é‡éƒ½æ˜¯å›ºå®šçš„ï¼Œä¹Ÿæ²¡æœ‰ rep-level å’Œ def-level</li><li>å½“ <code>max_def_level_ != 0</code> ï¼Œ<code>max_rep_level_ == 0</code> çš„æ—¶å€™ï¼Œschema æ˜¯å¹³å¦çš„ï¼Œä½†æ˜¯æœ‰çš„å€¼å¯èƒ½ä¸º nullï¼Œ<strong>è¿™é‡Œè¯»å– num-record æ¡ def level å°±è¡Œäº†</strong>, å¯ä»¥è§£æè¿™äº›è¡Œè§£æå‡º nullï¼Œä½†ä¸ç”¨å¤„ç†é‡å¤çš„ rep/def.</li><li>å¦åˆ™ï¼Œèµ° <code>DelimitRecords</code>ï¼Œå»è§£æè¡Œçš„æ•°é‡. è¿™æ®µåº”è¯¥æ˜¯æ•´ä¸ª Parquet è¯»æµç¨‹æœ€ hack çš„ä¸€éƒ¨åˆ†ä»£ç äº†</li></ol><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// Process written repetition/definition levels to reach the end of</span></span><br><span class="line"><span class="comment">// records. Process no more levels than necessary to delimit the indicated</span></span><br><span class="line"><span class="comment">// number of logical records. Updates internal state of RecordReader</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// è¿™ä¸ªå‡½æ•°åªä¼šå‘ç”Ÿåœ¨ rep-level å’Œ def-level éƒ½åœ¨çš„æƒ…å†µä¸‹. è¿™é‡Œä¼šæ ¹æ®å†…éƒ¨çŠ¶æ€ `at_record_start_` </span></span><br><span class="line"><span class="comment">//  åˆ¤æ–­æ˜¯å¦åœ¨ä¸€ä¸ªè¡Œçš„å¼€å¤´. ç›®æ ‡æ˜¯ä¸è¶Šè¿‡ `levels_written_` çš„æƒ…å†µä¸‹è¯» `num_records` è¡Œ.</span></span><br><span class="line"><span class="comment">// è¿”å›è¯»çš„è¡Œæ•°å’Œ values</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// \return Number of records delimited</span></span><br><span class="line"><span class="function"><span class="type">int64_t</span> <span class="title">DelimitRecords</span><span class="params">(<span class="type">int64_t</span> num_records, <span class="type">int64_t</span>* values_seen)</span> </span>&#123;</span><br><span class="line">  <span class="type">int64_t</span> values_to_read = <span class="number">0</span>;</span><br><span class="line">  <span class="type">int64_t</span> records_read = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="type">const</span> <span class="type">int16_t</span>* def_levels = <span class="keyword">this</span>-&gt;<span class="built_in">def_levels</span>() + levels_position_;</span><br><span class="line">  <span class="type">const</span> <span class="type">int16_t</span>* rep_levels = <span class="keyword">this</span>-&gt;<span class="built_in">rep_levels</span>() + levels_position_;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">DCHECK_GT</span>(<span class="keyword">this</span>-&gt;max_rep_level_, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Count logical records and number of values to read</span></span><br><span class="line">  <span class="comment">// è¯» level_position æ¥åˆ¤æ–­å†…å®¹</span></span><br><span class="line">  <span class="comment">// è¿™é‡Œçš„é€»è¾‘ä¼šå…ˆè¯» rep_level, æ¥æŸ¥ä¸€ä¸‹è¡Œçš„å˜æ›´, rep_level == 0 ä¸€å®šåˆ‡äº†è¡Œ, è¯»å®Œäº†å°±ä¼šè¿”å›.</span></span><br><span class="line">  <span class="comment">// ç„¶åä¼šæ£€æŸ¥ `def_level`, çœ‹è¿™ä¸ªæ˜¯å¦æ˜¯ null. ä¸æ˜¯ null å°±ä¼šæ·»åŠ  `values_to_read`.</span></span><br><span class="line">  <span class="comment">// **é 0 çš„ rep-level ä¸ä¼šè¢«è¿™ä¸€å±‚å¤„ç†**</span></span><br><span class="line">  <span class="keyword">while</span> (levels_position_ &lt; levels_written_) &#123;</span><br><span class="line">    <span class="type">const</span> <span class="type">int16_t</span> rep_level = *rep_levels++;</span><br><span class="line">    <span class="comment">// rep_level == 0 çš„æ—¶å€™, ä¸€å®šæ˜¯æ•´è¡Œçš„å¼€å¤´.</span></span><br><span class="line">    <span class="keyword">if</span> (rep_level == <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="comment">// If at_record_start_ is true, we are seeing the start of a record</span></span><br><span class="line">      <span class="comment">// for the second time, such as after repeated calls to</span></span><br><span class="line">      <span class="comment">// DelimitRecords. In this case we must continue until we find</span></span><br><span class="line">      <span class="comment">// another record start or exhausting the ColumnChunk</span></span><br><span class="line">      <span class="comment">//</span></span><br><span class="line">      <span class="comment">// ä¸Šä¸€æ¬¡èµ°å®Œäº†è¿™è¡Œ, å°±ä¼š `!at_record_start_`.</span></span><br><span class="line">      <span class="keyword">if</span> (!at_record_start_) &#123;</span><br><span class="line">        <span class="comment">// We&#x27;ve reached the end of a record; increment the record count.</span></span><br><span class="line">        ++records_read;</span><br><span class="line">        <span class="keyword">if</span> (records_read == num_records) &#123;</span><br><span class="line">          <span class="comment">// We&#x27;ve found the number of records we were looking for. Set</span></span><br><span class="line">          <span class="comment">// at_record_start_ to true and break</span></span><br><span class="line">          at_record_start_ = <span class="literal">true</span>;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// We have decided to consume the level at this position; therefore we</span></span><br><span class="line">    <span class="comment">// must advance until we find another record boundary</span></span><br><span class="line">    at_record_start_ = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">const</span> <span class="type">int16_t</span> def_level = *def_levels++;</span><br><span class="line">    <span class="keyword">if</span> (def_level == <span class="keyword">this</span>-&gt;max_def_level_) &#123;</span><br><span class="line">      ++values_to_read;</span><br><span class="line">    &#125;</span><br><span class="line">    ++levels_position_;</span><br><span class="line">  &#125;</span><br><span class="line">  *values_seen = values_to_read;</span><br><span class="line">  <span class="keyword">return</span> records_read;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯»å®Œä¹‹åï¼Œè¿™é‡Œä¼šå…·ä½“æŠŠå€¼è¯»åˆ° buffer ä¸­ã€‚å¦‚æœå¶å­ç»“ç‚¹é <code>null</code>ï¼Œé‚£å°±ç›´æ¥ <code>ReadValuesDense</code> äº†ï¼Œç¬¦åˆé€»è¾‘ï¼Œå¦åˆ™çš„è¯ï¼Œè¿™é‡Œä¼šï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å…·ä½“è¯»å€¼çš„é€»è¾‘</span></span><br><span class="line"><span class="type">int64_t</span> null_count = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">if</span> (leaf_info_.<span class="built_in">HasNullableValues</span>()) &#123;</span><br><span class="line">  ValidityBitmapInputOutput validity_io;</span><br><span class="line">  validity_io.values_read_upper_bound = levels_position_ - start_levels_position;</span><br><span class="line">  validity_io.valid_bits = valid_bits_-&gt;<span class="built_in">mutable_data</span>(); <span class="comment">// æŒ‡å‘ `valid_bits_` å†…éƒ¨æ•°ç»„.</span></span><br><span class="line">  validity_io.valid_bits_offset = values_written_;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// def level æ‹†åˆ†</span></span><br><span class="line">  <span class="built_in">DefLevelsToBitmap</span>(<span class="built_in">def_levels</span>() + start_levels_position,</span><br><span class="line">                    <span class="comment">/* level çš„æ•°é‡ */</span> levels_position_ - start_levels_position, leaf_info_,</span><br><span class="line">                    &amp;validity_io);</span><br><span class="line">  values_to_read = validity_io.values_read - validity_io.null_count;</span><br><span class="line">  null_count = validity_io.null_count;</span><br><span class="line">  <span class="built_in">DCHECK_GE</span>(values_to_read, <span class="number">0</span>);</span><br><span class="line">  <span class="built_in">ReadValuesSpaced</span>(validity_io.values_read, null_count);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„é€»è¾‘æ„Ÿè§‰å†™çš„â€¦æœ‰ç‚¹æ€ªï¼Œå®ƒä¼šæ ¹æ® <code>values_read_upper_bound</code> å’Œ <code>valid_bits_offset</code> æ¥å¡«å…… <code>valid_bits</code> å’Œ <code>null_count</code> å’Œ <code>values_read</code>ï¼Œè¿™é‡Œåº”è¯¥ç›¸å½“äºä¸€ä¸ªå†…éƒ¨æ£€æŸ¥ï¼Œæ¯•ç«Ÿ <code>values_read</code> å‰é¢åªæœ‰ <code>rep_level == 0, def_level != 0</code> çš„æ—¶å€™æ²¡ç®—è¿‡ğŸ˜…ã€‚è¿™é‡Œä¼šç»™å‡º Levelï¼ŒæŠŠå¯¹åº”çš„ count ç”¨ simd è§£æå®Œï¼Œç„¶åç®—åˆ° <code>validity_io</code> é‡Œé¢ï¼Œç„¶åç”¨ <code>ReadValuesSpaced</code> è¯»å–å¯¹åº”çš„æ•°æ®ã€‚è¿™ä¸€å—çŠ¶æ€ä¼ é€’éå¸¸ä¹±ï¼Œå»ºè®®ä¸æ”¹è¿™å—ä»£ç æ„ä¼šä¸€ä¸‹å°±å¥½äº†ã€‚è¿™å—ä½œè€…ä¸»è¦æ˜¯ Micah Cornfield å’Œ Wesmï¼Œä»£ç æ€§èƒ½ç¡®å®ä¸é”™ï¼Œä½†æ˜¯å†™çš„å¥½æš´åŠ›å•Šã€‚</p><p>æ€»ä¹‹ï¼Œè¿™é‡Œä¼šæ‹¿åˆ°è¡Œæ•°ã€<code>null_count</code> å’Œ <code>null-bitmap</code>ï¼Œç„¶åå®Œæˆè¯»å–ã€‚</p><p>è¿™é‡Œè¿˜æœ‰ä¸ªæ¯”è¾ƒ hack çš„åœ°æ–¹ï¼Œå°±æ˜¯ <code>levels_position_</code> çš„å¤„ç†ï¼Œè¿™æ®µä»£ç æ¯”è¾ƒ hackingï¼Œå®ƒä¼šï¼š</p><ol><li>åœ¨åº•å±‚çš„æ—¶å€™ï¼Œå°±çŸ¥é“æœ‰å¤šå°‘è¡Œæ•°æ®ï¼Œrecord reader è§£æå‡ºä¸€ä¸ª record æ•°ç›®</li><li>ä¸Šå±‚æ ¹æ® Def-Rep è§£æå‡º List / Map çš„ size å’Œ nullableï¼Œæ¢å¤å‡ºä¸Šå±‚çš„æ•°æ®</li></ol><p>æ‰€ä»¥ï¼Œè§£æçš„æ—¶å€™ï¼Œæœ‰2ä¸ª levels:</p><ol><li>levels position: ç›®å‰è¯»çš„è¡Œçš„ levels</li><li>levels written: ä» page ä¸­æå‡ºæ¥çš„ levels</li></ol><h3 id="parquet-arrow-ä»-arrow-æ¢å¤-Array-æ•°æ®"><a href="#parquet-arrow-ä»-arrow-æ¢å¤-Array-æ•°æ®" class="headerlink" title="parquet/arrow: ä» arrow æ¢å¤ Array æ•°æ®"></a>parquet/arrow: ä» arrow æ¢å¤ Array æ•°æ®</h3><p>ä¸Šé¢æˆ‘ä»¬æ‹¿åˆ°äº† api å’Œä» Column ä¸­è¯»æ•°æ®çš„é€»è¾‘ï¼Œä¸‹é¢è¿™é‡Œéœ€è¦ä» Parquet æ‹¿åˆ°çš„è¿ç»­æ•°æ®ä¸­æ¢å¤ arrow çš„æ•°æ®ã€‚å¯¹åº”çš„å®ç°åœ¨ <code>parquet/arrow/reader</code> ä¸­ã€‚å†æ¬¡æé†’ä¸€ä¸‹ï¼Œè¿™é‡Œ <code>namespace</code> æ˜¯ <code>parquet::arrow</code>ï¼Œè´Ÿè´£ <code>arrow</code> ä¸€äº›å¤æ‚æ ¼å¼å’Œ parquet äº’è½¬ã€‚</p><h4 id="ColumnReader"><a href="#ColumnReader" class="headerlink" title="ColumnReader"></a>ColumnReader</h4><p>å¤´æ–‡ä»¶ä¸­ï¼Œæœ‰ä¸€ä¸ª <code>ColumnReader</code>ï¼Œä½œä¸ºè¯»å–æ¥å£</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// At this point, the column reader is a stream iterator. It only knows how to</span></span><br><span class="line"><span class="comment">// read the next batch of values for a particular column from the file until it</span></span><br><span class="line"><span class="comment">// runs out.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// We also do not expose any internal Parquet details, such as row groups. This</span></span><br><span class="line"><span class="comment">// might change in the future.</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PARQUET_EXPORT</span> ColumnReader &#123;</span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="keyword">virtual</span> ~<span class="built_in">ColumnReader</span>() = <span class="keyword">default</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Scan the next array of the indicated size. The actual size of the</span></span><br><span class="line">  <span class="comment">// returned array may be less than the passed size depending how much data is</span></span><br><span class="line">  <span class="comment">// available in the file.</span></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  <span class="comment">// When all the data in the file has been exhausted, the result is set to</span></span><br><span class="line">  <span class="comment">// nullptr.</span></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  <span class="comment">// Returns Status::OK on a successful read, including if you have exhausted</span></span><br><span class="line">  <span class="comment">// the data available in the file.</span></span><br><span class="line">  <span class="keyword">virtual</span> ::<span class="function">arrow::Status <span class="title">NextBatch</span><span class="params">(<span class="type">int64_t</span> batch_size,</span></span></span><br><span class="line"><span class="params"><span class="function">                                    std::shared_ptr&lt;::arrow::ChunkedArray&gt;* out)</span> </span>= <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ColumnReaderImpl</span> : <span class="keyword">public</span> ColumnReader &#123;</span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> Status <span class="title">GetDefLevels</span><span class="params">(<span class="type">const</span> <span class="type">int16_t</span>** data, <span class="type">int64_t</span>* length)</span> </span>= <span class="number">0</span>;</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> Status <span class="title">GetRepLevels</span><span class="params">(<span class="type">const</span> <span class="type">int16_t</span>** data, <span class="type">int64_t</span>* length)</span> </span>= <span class="number">0</span>;</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="type">const</span> std::shared_ptr&lt;Field&gt; <span class="title">field</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  ::<span class="function">arrow::Status <span class="title">NextBatch</span><span class="params">(<span class="type">int64_t</span> batch_size,</span></span></span><br><span class="line"><span class="params"><span class="function">                            std::shared_ptr&lt;::arrow::ChunkedArray&gt;* out)</span> <span class="keyword">final</span> </span>&#123;</span><br><span class="line">    <span class="built_in">RETURN_NOT_OK</span>(<span class="built_in">LoadBatch</span>(batch_size));</span><br><span class="line">    <span class="built_in">RETURN_NOT_OK</span>(<span class="built_in">BuildArray</span>(batch_size, out));</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> x = <span class="number">0</span>; x &lt; (*out)-&gt;<span class="built_in">num_chunks</span>(); x++) &#123;</span><br><span class="line">      <span class="built_in">RETURN_NOT_OK</span>((*out)-&gt;<span class="built_in">chunk</span>(x)-&gt;<span class="built_in">Validate</span>());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> Status::<span class="built_in">OK</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">virtual</span> ::<span class="function">arrow::Status <span class="title">LoadBatch</span><span class="params">(<span class="type">int64_t</span> num_records)</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">virtual</span> ::<span class="function">arrow::Status <span class="title">BuildArray</span><span class="params">(<span class="type">int64_t</span> length_upper_bound,</span></span></span><br><span class="line"><span class="params"><span class="function">                                     std::shared_ptr&lt;::arrow::ChunkedArray&gt;* out)</span> </span>= <span class="number">0</span>;</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="type">bool</span> <span class="title">IsOrHasRepeatedChild</span><span class="params">()</span> <span class="type">const</span> </span>= <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå†…å®¹åˆ†ä¸ºä¸¤éƒ¨åˆ†:</p><ol><li><p><code>LoadBatch</code>: åˆ©ç”¨ä¹‹å‰è®²çš„ <code>RecordReader</code> æ¥æŠŠä¸€ä¸ª Batch çš„è¡ŒåŠ è½½åˆ° Values çš„ Buffer ä¸­</p></li><li><p><code>BuildArray</code>ï¼š æ„å»ºå†…å­˜ arrayï¼Œå¯èƒ½ä¼šä»å­èŠ‚ç‚¹æ„å»ºçˆ¶èŠ‚ç‚¹</p></li></ol><p>è¿™é‡Œå…¶å®è¿˜å¯èƒ½è¦è½¬å‹ï¼Œä¸ºä»€ä¹ˆè¦è½¬å‹å‘¢ï¼Ÿparquet åŸºç¡€ç±»å‹å…¶å®æ²¡å‡ ä¸ªï¼Œæ¯”æ–¹è¯´ int8ï¼Œå®ƒä¹Ÿä¼šç”¨æ›´å¤§çš„ int å»å‹ç¼©ã€‚æ‰€ä»¥è¿™é‡Œè¦è½¬å‹åˆ°å†…å­˜çš„æ ¼å¼ä¸­</p><h4 id="LeafReader"><a href="#LeafReader" class="headerlink" title="LeafReader"></a>LeafReader</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Leaf reader is for primitive arrays and primitive children of nested arrays</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">LeafReader</span> : <span class="keyword">public</span> ColumnReaderImpl &#123;</span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="function">Status <span class="title">GetDefLevels</span><span class="params">(<span class="type">const</span> <span class="type">int16_t</span>** data, <span class="type">int64_t</span>* length)</span> <span class="keyword">final</span> </span>&#123;</span><br><span class="line">    *data = record_reader_-&gt;<span class="built_in">def_levels</span>();</span><br><span class="line">    *length = record_reader_-&gt;<span class="built_in">levels_position</span>();</span><br><span class="line">    <span class="keyword">return</span> Status::<span class="built_in">OK</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function">Status <span class="title">GetRepLevels</span><span class="params">(<span class="type">const</span> <span class="type">int16_t</span>** data, <span class="type">int64_t</span>* length)</span> <span class="keyword">final</span> </span>&#123;</span><br><span class="line">    *data = record_reader_-&gt;<span class="built_in">rep_levels</span>();</span><br><span class="line">    *length = record_reader_-&gt;<span class="built_in">levels_position</span>();</span><br><span class="line">    <span class="keyword">return</span> Status::<span class="built_in">OK</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="type">bool</span> <span class="title">IsOrHasRepeatedChild</span><span class="params">()</span> <span class="type">const</span> <span class="keyword">final</span> </span>&#123; <span class="keyword">return</span> <span class="literal">false</span>; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function">Status <span class="title">LoadBatch</span><span class="params">(<span class="type">int64_t</span> records_to_read)</span> <span class="keyword">final</span></span>;</span><br><span class="line"></span><br><span class="line">  ::<span class="function">arrow::Status <span class="title">BuildArray</span><span class="params">(<span class="type">int64_t</span> length_upper_bound,</span></span></span><br><span class="line"><span class="params"><span class="function">                             std::shared_ptr&lt;::arrow::ChunkedArray&gt;* out)</span> <span class="keyword">final</span> </span>&#123;</span><br><span class="line">    *out = out_;</span><br><span class="line">    <span class="keyword">return</span> Status::<span class="built_in">OK</span>();</span><br><span class="line">  &#125;</span><br><span class="line"> <span class="keyword">private</span>:</span><br><span class="line">  std::shared_ptr&lt;ChunkedArray&gt; out_;</span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">NextRowGroup</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    std::unique_ptr&lt;PageReader&gt; page_reader = input_-&gt;<span class="built_in">NextChunk</span>();</span><br><span class="line">    record_reader_-&gt;<span class="built_in">SetPageReader</span>(std::<span class="built_in">move</span>(page_reader));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  std::shared_ptr&lt;ReaderContext&gt; ctx_;</span><br><span class="line">  std::shared_ptr&lt;Field&gt; field_;</span><br><span class="line">  std::unique_ptr&lt;FileColumnIterator&gt; input_;</span><br><span class="line">  <span class="type">const</span> ColumnDescriptor* descr_;</span><br><span class="line">  std::shared_ptr&lt;RecordReader&gt; record_reader_;</span><br><span class="line">&#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘æŠŠ LoadBatch å®ç°æ‘˜å‡ºæ¥äº†ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Status <span class="title">LoadBatch</span><span class="params">(<span class="type">int64_t</span> records_to_read)</span> <span class="keyword">final</span> </span>&#123;</span><br><span class="line">  BEGIN_PARQUET_CATCH_EXCEPTIONS</span><br><span class="line">  out_ = <span class="literal">nullptr</span>;</span><br><span class="line">  record_reader_-&gt;<span class="built_in">Reset</span>();</span><br><span class="line">  <span class="comment">// Pre-allocation gives much better performance for flat columns</span></span><br><span class="line">  record_reader_-&gt;<span class="built_in">Reserve</span>(records_to_read);</span><br><span class="line">  <span class="keyword">while</span> (records_to_read &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!record_reader_-&gt;<span class="built_in">HasMoreData</span>()) &#123;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">int64_t</span> records_read = record_reader_-&gt;<span class="built_in">ReadRecords</span>(records_to_read);</span><br><span class="line">    records_to_read -= records_read;</span><br><span class="line">    <span class="keyword">if</span> (records_read == <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="built_in">NextRowGroup</span>();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">RETURN_NOT_OK</span>(</span><br><span class="line">      <span class="built_in">TransferColumnData</span>(record_reader_.<span class="built_in">get</span>(), field_, descr_, ctx_-&gt;pool, &amp;out_));</span><br><span class="line">  <span class="keyword">return</span> Status::<span class="built_in">OK</span>();</span><br><span class="line">  END_PARQUET_CATCH_EXCEPTIONS</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>è¿™é‡Œä¼šä» <code>record_reader_</code> é‡Œé¢æ‰€è¦æ•°æ®ï¼Œç„¶ååˆ‡ Page æˆ–è€… row_groupï¼Œç›´åˆ°è¯»å®Œæˆ–è€…æ»¡è¶³ batch</li><li>åˆ©ç”¨ <code>TransferColumnData</code> åšè½¬å‹ï¼Œç„¶å <code>BuildArray</code> æ²¡æœ‰ä»»ä½•å¼€é”€</li></ol><p>å®ƒéš¾ä¸€ç‚¹çš„å†…éƒ¨å®ç°éƒ½åœ¨ <code>RecordReader</code> äº†ï¼Œå“ï¼Œæ˜¯çœŸçš„åˆæ¶å¿ƒåˆéš¾å‘¢â€¦</p><h4 id="List-Struct"><a href="#List-Struct" class="headerlink" title="List / Struct"></a>List / Struct</h4><p>è¿™ä¸ªä¼šæ‰¾åˆ°ä¸€ä¸ªé è°±çš„ childï¼Œç„¶åä»è¿™é‡Œé¢æ‹‰ rep-level å’Œ def-levelï¼Œæ¥æ¢å¤å¯¹åº”çš„è®°å½•</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">PARQUET_NO_EXPORT</span> StructReader : <span class="keyword">public</span> ColumnReaderImpl &#123;</span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="function"><span class="keyword">explicit</span> <span class="title">StructReader</span><span class="params">(std::shared_ptr&lt;ReaderContext&gt; ctx,</span></span></span><br><span class="line"><span class="params"><span class="function">                        std::shared_ptr&lt;Field&gt; filtered_field,</span></span></span><br><span class="line"><span class="params"><span class="function">                        ::parquet::internal::LevelInfo level_info,</span></span></span><br><span class="line"><span class="params"><span class="function">                        std::vector&lt;std::unique_ptr&lt;ColumnReaderImpl&gt;&gt; children)</span></span></span><br><span class="line"><span class="function">      : ctx_(std::move(ctx)),</span></span><br><span class="line"><span class="function">        filtered_field_(std::move(filtered_field)),</span></span><br><span class="line"><span class="function">        level_info_(level_info),</span></span><br><span class="line"><span class="function">        children_(std::move(children)) &#123;</span></span><br><span class="line">    <span class="comment">// æ‰¾åˆ°é è°±çš„è®°å½•ï¼Œæ¥è®¾ç½®ä¸€ä¸ª `def_rep_level_child_`, å³æœ‰ level çš„ child.</span></span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function">Status <span class="title">LoadBatch</span><span class="params">(<span class="type">int64_t</span> records_to_read)</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">    <span class="comment">// é€’å½’è®©å­èŠ‚ç‚¹ build batch</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">const</span> std::unique_ptr&lt;ColumnReaderImpl&gt;&amp; reader : children_) &#123;</span><br><span class="line">      <span class="built_in">RETURN_NOT_OK</span>(reader-&gt;<span class="built_in">LoadBatch</span>(records_to_read));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> Status::<span class="built_in">OK</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function">Status <span class="title">BuildArray</span><span class="params">(<span class="type">int64_t</span> length_upper_bound,</span></span></span><br><span class="line"><span class="params"><span class="function">                    std::shared_ptr&lt;ChunkedArray&gt;* out)</span> <span class="keyword">override</span></span>;</span><br><span class="line">  <span class="function">Status <span class="title">GetDefLevels</span><span class="params">(<span class="type">const</span> <span class="type">int16_t</span>** data, <span class="type">int64_t</span>* length)</span> <span class="keyword">override</span></span>;</span><br><span class="line">  <span class="function">Status <span class="title">GetRepLevels</span><span class="params">(<span class="type">const</span> <span class="type">int16_t</span>** data, <span class="type">int64_t</span>* length)</span> <span class="keyword">override</span></span>;</span><br><span class="line">  <span class="function"><span class="type">const</span> std::shared_ptr&lt;Field&gt; <span class="title">field</span><span class="params">()</span> <span class="keyword">override</span> </span>&#123; <span class="keyword">return</span> filtered_field_; &#125;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span>:</span><br><span class="line">  <span class="type">const</span> std::shared_ptr&lt;ReaderContext&gt; ctx_;</span><br><span class="line">  <span class="type">const</span> std::shared_ptr&lt;Field&gt; filtered_field_;</span><br><span class="line">  <span class="type">const</span> ::parquet::internal::LevelInfo level_info_;</span><br><span class="line">  <span class="type">const</span> std::vector&lt;std::unique_ptr&lt;ColumnReaderImpl&gt;&gt; children_;</span><br><span class="line">  ColumnReaderImpl* def_rep_level_child_ = <span class="literal">nullptr</span>;</span><br><span class="line">  <span class="type">bool</span> has_repeated_child_;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆï¼Œæˆ‘ä»¬çœ‹ <code>LoadBatch</code> å°± Load äº†æ‰€æœ‰å­èŠ‚ç‚¹ï¼Œæ‰€ä»¥è¿™é‡Œé‡ç‚¹åœ¨ <code>BuildArray</code> ä¸Šï¼Œè¿™é‡Œç”¨åˆ°äº†æˆ‘ä»¬ä¹‹å‰çœ‹åˆ°çš„ <code>ValidityBitmapInputOutput</code> ï¼ˆæˆ‘ä¹‹å‰åæ§½è¿‡çš„ï¼Œåœ¨ <code>RecordReader</code> é‚£å—ä»£ç é‚£ï¼‰ã€‚è¿™é‡Œæçš„åˆ°ä¸€ä¸ªå¶å­ç»“ç‚¹çš„ rep-level å’Œ def-levelï¼Œç„¶åæ ¹æ®è¿™ä¸€ä¸ªå¶å­ç»“ç‚¹çš„ levels å°±èƒ½æ¢å¤æ‰€æœ‰çš„ä¿¡æ¯ï¼Œè¿™é‡Œæœ‰ä¸€äº›è§£æå‡½æ•°ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åªè€ƒè™‘ def-level, ç”¨äºå¶å­ç»“ç‚¹.</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DefLevelsToBitmap</span><span class="params">(<span class="type">const</span> <span class="type">int16_t</span>* def_levels, <span class="type">int64_t</span> num_def_levels,</span></span></span><br><span class="line"><span class="params"><span class="function">                       LevelInfo level_info, ValidityBitmapInputOutput* output)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// It is simpler to rely on rep_level here until PARQUET-1899 is done and the code</span></span><br><span class="line">  <span class="comment">// is deleted in a follow-up release.</span></span><br><span class="line">  <span class="keyword">if</span> (level_info.rep_level &gt; <span class="number">0</span>) &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(ARROW_HAVE_RUNTIME_BMI2)</span></span><br><span class="line">    <span class="keyword">if</span> (CpuInfo::<span class="built_in">GetInstance</span>()-&gt;<span class="built_in">HasEfficientBmi2</span>()) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">DefLevelsToBitmapBmi2WithRepeatedParent</span>(def_levels, num_def_levels,</span><br><span class="line">                                                     level_info, output);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    standard::<span class="built_in">DefLevelsToBitmapSimd</span>&lt;/*has_repeated_parent=*/<span class="literal">true</span>&gt;(</span><br><span class="line">        def_levels, num_def_levels, level_info, output);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    standard::<span class="built_in">DefLevelsToBitmapSimd</span>&lt;<span class="comment">/*has_repeated_parent=*/</span><span class="literal">false</span>&gt;(</span><br><span class="line">        def_levels, num_def_levels, level_info, output);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DefRepLevelsToList</span><span class="params">(<span class="type">const</span> <span class="type">int16_t</span>* def_levels, <span class="type">const</span> <span class="type">int16_t</span>* rep_levels,</span></span></span><br><span class="line"><span class="params"><span class="function">                        <span class="type">int64_t</span> num_def_levels, LevelInfo level_info,</span></span></span><br><span class="line"><span class="params"><span class="function">                        ValidityBitmapInputOutput* output, <span class="type">int32_t</span>* offsets)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">DefRepLevelsToListInfo</span>&lt;<span class="type">int32_t</span>&gt;(def_levels, rep_levels, num_def_levels, level_info,</span><br><span class="line">                                  output, offsets);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DefRepLevelsToList</span><span class="params">(<span class="type">const</span> <span class="type">int16_t</span>* def_levels, <span class="type">const</span> <span class="type">int16_t</span>* rep_levels,</span></span></span><br><span class="line"><span class="params"><span class="function">                        <span class="type">int64_t</span> num_def_levels, LevelInfo level_info,</span></span></span><br><span class="line"><span class="params"><span class="function">                        ValidityBitmapInputOutput* output, <span class="type">int64_t</span>* offsets)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">DefRepLevelsToListInfo</span>&lt;<span class="type">int64_t</span>&gt;(def_levels, rep_levels, num_def_levels, level_info,</span><br><span class="line">                                  output, offsets);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ ¹æ® def-rep æ¥ç®—, æ‹¿åˆ°å¶å­ç»“ç‚¹çš„ level æ¨æ–­çˆ¶äº²çš„åˆ—è¡¨.</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DefRepLevelsToBitmap</span><span class="params">(<span class="type">const</span> <span class="type">int16_t</span>* def_levels, <span class="type">const</span> <span class="type">int16_t</span>* rep_levels,</span></span></span><br><span class="line"><span class="params"><span class="function">                          <span class="type">int64_t</span> num_def_levels, LevelInfo level_info,</span></span></span><br><span class="line"><span class="params"><span class="function">                          ValidityBitmapInputOutput* output)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// DefReplevelsToListInfo assumes it for the actual list method and this</span></span><br><span class="line">  <span class="comment">// method is for parent structs, so we need to bump def and ref level.</span></span><br><span class="line">  level_info.rep_level += <span class="number">1</span>;</span><br><span class="line">  level_info.def_level += <span class="number">1</span>;</span><br><span class="line">  <span class="built_in">DefRepLevelsToListInfo</span>&lt;<span class="type">int32_t</span>&gt;(def_levels, rep_levels, num_def_levels, level_info,</span><br><span class="line">                                  output, <span class="comment">/*offsets=*/</span><span class="literal">nullptr</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>offsets</code> å‚æ•°æ˜¯ç»™ <code>List</code> è¿™æ ·å†…å®¹å‡†å¤‡çš„ã€‚ä¸è€ƒè™‘ offset æƒ…å†µä¸‹ï¼Œstruct å¯¹åº”é€»è¾‘ï¼š</p><ol><li>å½“ <code>rep_levels</code> æ¯”è‡ªèº«å¤§çš„æ—¶å€™ï¼Œè¯´æ˜æ˜¯å­èŠ‚ç‚¹åœ¨é‡å¤ï¼Œskip</li><li>å¦‚æœ rep-level ç­‰äºè‡ªèº«ï¼Œè¯´æ˜åœ¨è‡ªå·±è¿™å±‚é‡å¤ï¼ˆå¯¹ç»“æ„ä½“æ˜¯ä¸å¯èƒ½çš„ï¼Œæ‰€ä»¥ä¸è€ƒè™‘ï¼‰</li><li>å¦‚æœ rep-level å°è‡ªèº«ï¼Œè¯´æ˜çˆ¶çº§é‡å¤ã€‚è¿™é‡Œå¯ä»¥æ ¹æ® def-level æ¥åˆ¤æ–­è‡ªå·±æ˜¯å¦æ˜¯ null</li></ol><p>æˆ‘ä»¬ç®€å•çœ‹çœ‹ï¼Œä¸‹é¢çš„ä»£ç åˆ æ‰äº† <code>offsets</code> å’Œ Struct ä¸ä¼š touch çš„é€»è¾‘ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> OffsetType&gt;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DefRepLevelsToListInfo</span><span class="params">(<span class="type">const</span> <span class="type">int16_t</span>* def_levels, <span class="type">const</span> <span class="type">int16_t</span>* rep_levels,</span></span></span><br><span class="line"><span class="params"><span class="function">                            <span class="type">int64_t</span> num_def_levels, LevelInfo level_info,</span></span></span><br><span class="line"><span class="params"><span class="function">                            ValidityBitmapInputOutput* output, OffsetType* offsets)</span> </span>&#123;</span><br><span class="line">  OffsetType* orig_pos = offsets;</span><br><span class="line">  optional&lt;::arrow::internal::FirstTimeBitmapWriter&gt; valid_bits_writer;</span><br><span class="line">  <span class="keyword">if</span> (output-&gt;valid_bits) &#123;</span><br><span class="line">    valid_bits_writer.<span class="built_in">emplace</span>(output-&gt;valid_bits, output-&gt;valid_bits_offset,</span><br><span class="line">                              output-&gt;values_read_upper_bound);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> x = <span class="number">0</span>; x &lt; num_def_levels; x++) &#123;</span><br><span class="line">    <span class="comment">// Skip items that belong to empty or null ancestor lists and further nested lists.</span></span><br><span class="line">    <span class="keyword">if</span> (def_levels[x] &lt; level_info.repeated_ancestor_def_level ||</span><br><span class="line">        rep_levels[x] &gt; level_info.rep_level) &#123;</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">ARROW_PREDICT_FALSE</span>(</span><br><span class="line">              (valid_bits_writer.<span class="built_in">has_value</span>() &amp;&amp;</span><br><span class="line">               valid_bits_writer-&gt;<span class="built_in">position</span>() &gt;= output-&gt;values_read_upper_bound) ||</span><br><span class="line">              (offsets - orig_pos) &gt;= output-&gt;values_read_upper_bound)) &#123;</span><br><span class="line">        std::stringstream ss;</span><br><span class="line">        ss &lt;&lt; <span class="string">&quot;Definition levels exceeded upper bound: &quot;</span></span><br><span class="line">           &lt;&lt; output-&gt;values_read_upper_bound;</span><br><span class="line">        <span class="keyword">throw</span> <span class="built_in">ParquetException</span>(ss.<span class="built_in">str</span>());</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (valid_bits_writer.<span class="built_in">has_value</span>()) &#123;</span><br><span class="line">        <span class="comment">// the level_info def level for lists reflects element present level.</span></span><br><span class="line">        <span class="comment">// the prior level distinguishes between empty lists.</span></span><br><span class="line">        <span class="keyword">if</span> (def_levels[x] &gt;= level_info.def_level - <span class="number">1</span>) &#123;</span><br><span class="line">          valid_bits_writer-&gt;<span class="built_in">Set</span>();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          output-&gt;null_count++;</span><br><span class="line">          valid_bits_writer-&gt;<span class="built_in">Clear</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        valid_bits_writer-&gt;<span class="built_in">Next</span>();</span><br><span class="line">      &#125;</span><br><span class="line">    </span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (valid_bits_writer.<span class="built_in">has_value</span>()) &#123;</span><br><span class="line">    valid_bits_writer-&gt;<span class="built_in">Finish</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (offsets != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">    output-&gt;values_read = offsets - orig_pos;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (valid_bits_writer.<span class="built_in">has_value</span>()) &#123;</span><br><span class="line">    output-&gt;values_read = valid_bits_writer-&gt;<span class="built_in">position</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (output-&gt;null_count &gt; <span class="number">0</span> &amp;&amp; level_info.null_slot_usage &gt; <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="built_in">ParquetException</span>(</span><br><span class="line">        <span class="string">&quot;Null values with null_slot_usage &gt; 1 not supported.&quot;</span></span><br><span class="line">        <span class="string">&quot;(i.e. FixedSizeLists with null values are not supported)&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é‚£å¯¹äº <code>List</code> æ¥è¯´ï¼Œæˆ‘ä»¬ä¼šéœ€è¦ <code>offsets</code>ï¼Œæ¥ç¡®å®šå®ƒæ²¡æ¯æ®µåç§»é‡æ˜¯å¤šå°‘ã€‚è€Œä¸” <code>rep-level</code> å¯èƒ½ç­‰äºè‡ªèº«ï¼Œæˆ‘ä»¬å†æ¥çœ‹çœ‹è¿™ä¸ªå‡½æ•°çš„å®Œæ•´ç‰ˆï¼ˆä¸€ä¸ªå‡½æ•°è´´ä¸¤éï¼Œä½ æ°´å­—æ•°æ˜¯çœŸçš„ç‰›é€¼ï¼‰ï¼š</p><p>è¿™é‡Œæ³¨æ„ï¼š</p><ol><li>å½“ <code>rep_levels</code> æ¯”è‡ªèº«å¤§çš„æ—¶å€™ï¼Œè¯´æ˜æ˜¯å­èŠ‚ç‚¹åœ¨é‡å¤ï¼Œskip</li><li>å¦‚æœ rep-level ç­‰äºè‡ªèº«ï¼Œè¯´æ˜åœ¨è‡ªå·±è¿™å±‚é‡å¤ï¼Œç»™ list æ·»åŠ ä¸€ä¸ªå…ƒç´ ï¼Œ<code>*offset += 1</code></li><li>å¦‚æœ rep-level å°è‡ªèº«ï¼Œè¯´æ˜çˆ¶çº§é‡å¤ã€‚è¿™é‡Œå‘å‰ç§»åŠ¨ offsetsï¼Œå¯ä»¥æ ¹æ® def-level æ¥åˆ¤æ–­è‡ªå·±æ˜¯å¦æ˜¯ nullã€‚å¦‚æœè‡ªå·±ä¸æ˜¯ nullï¼Œè¯´æ˜æœ‰ä¸ªæ–°æˆå‘˜ï¼Œå¾—æ·»åŠ ä¸‹ offsets</li></ol><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> OffsetType&gt;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DefRepLevelsToListInfo</span><span class="params">(<span class="type">const</span> <span class="type">int16_t</span>* def_levels, <span class="type">const</span> <span class="type">int16_t</span>* rep_levels,</span></span></span><br><span class="line"><span class="params"><span class="function">                            <span class="type">int64_t</span> num_def_levels, LevelInfo level_info,</span></span></span><br><span class="line"><span class="params"><span class="function">                            ValidityBitmapInputOutput* output, OffsetType* offsets)</span> </span>&#123;</span><br><span class="line">  OffsetType* orig_pos = offsets;</span><br><span class="line">  optional&lt;::arrow::internal::FirstTimeBitmapWriter&gt; valid_bits_writer;</span><br><span class="line">  <span class="keyword">if</span> (output-&gt;valid_bits) &#123;</span><br><span class="line">    valid_bits_writer.<span class="built_in">emplace</span>(output-&gt;valid_bits, output-&gt;valid_bits_offset,</span><br><span class="line">                              output-&gt;values_read_upper_bound);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> x = <span class="number">0</span>; x &lt; num_def_levels; x++) &#123;</span><br><span class="line">    <span class="comment">// Skip items that belong to empty or null ancestor lists and further nested lists.</span></span><br><span class="line">    <span class="keyword">if</span> (def_levels[x] &lt; level_info.repeated_ancestor_def_level ||</span><br><span class="line">        rep_levels[x] &gt; level_info.rep_level) &#123;</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (rep_levels[x] == level_info.rep_level) &#123;</span><br><span class="line">      <span class="comment">// A continuation of an existing list.</span></span><br><span class="line">      <span class="comment">// offsets can be null for structs with repeated children (we don&#x27;t need to know</span></span><br><span class="line">      <span class="comment">// offsets until we get to the children).</span></span><br><span class="line">      <span class="keyword">if</span> (offsets != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">ARROW_PREDICT_FALSE</span>(*offsets == std::numeric_limits&lt;OffsetType&gt;::<span class="built_in">max</span>())) &#123;</span><br><span class="line">          <span class="keyword">throw</span> <span class="built_in">ParquetException</span>(<span class="string">&quot;List index overflow.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        *offsets += <span class="number">1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">ARROW_PREDICT_FALSE</span>(</span><br><span class="line">              (valid_bits_writer.<span class="built_in">has_value</span>() &amp;&amp;</span><br><span class="line">               valid_bits_writer-&gt;<span class="built_in">position</span>() &gt;= output-&gt;values_read_upper_bound) ||</span><br><span class="line">              (offsets - orig_pos) &gt;= output-&gt;values_read_upper_bound)) &#123;</span><br><span class="line">        std::stringstream ss;</span><br><span class="line">        ss &lt;&lt; <span class="string">&quot;Definition levels exceeded upper bound: &quot;</span></span><br><span class="line">           &lt;&lt; output-&gt;values_read_upper_bound;</span><br><span class="line">        <span class="keyword">throw</span> <span class="built_in">ParquetException</span>(ss.<span class="built_in">str</span>());</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// current_rep &lt; list rep_level i.e. start of a list (ancestor empty lists are</span></span><br><span class="line">      <span class="comment">// filtered out above).</span></span><br><span class="line">      <span class="comment">// offsets can be null for structs with repeated children (we don&#x27;t need to know</span></span><br><span class="line">      <span class="comment">// offsets until we get to the children).</span></span><br><span class="line">      <span class="keyword">if</span> (offsets != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">        ++offsets;</span><br><span class="line">        <span class="comment">// Use cumulative offsets because variable size lists are more common then</span></span><br><span class="line">        <span class="comment">// fixed size lists so it should be cheaper to make these cumulative and</span></span><br><span class="line">        <span class="comment">// subtract when validating fixed size lists.</span></span><br><span class="line">        *offsets = *(offsets - <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> (def_levels[x] &gt;= level_info.def_level) &#123;</span><br><span class="line">          <span class="keyword">if</span> (<span class="built_in">ARROW_PREDICT_FALSE</span>(*offsets == std::numeric_limits&lt;OffsetType&gt;::<span class="built_in">max</span>())) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="built_in">ParquetException</span>(<span class="string">&quot;List index overflow.&quot;</span>);</span><br><span class="line">          &#125;</span><br><span class="line">          *offsets += <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (valid_bits_writer.<span class="built_in">has_value</span>()) &#123;</span><br><span class="line">        <span class="comment">// the level_info def level for lists reflects element present level.</span></span><br><span class="line">        <span class="comment">// the prior level distinguishes between empty lists.</span></span><br><span class="line">        <span class="keyword">if</span> (def_levels[x] &gt;= level_info.def_level - <span class="number">1</span>) &#123;</span><br><span class="line">          valid_bits_writer-&gt;<span class="built_in">Set</span>();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          output-&gt;null_count++;</span><br><span class="line">          valid_bits_writer-&gt;<span class="built_in">Clear</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        valid_bits_writer-&gt;<span class="built_in">Next</span>();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (valid_bits_writer.<span class="built_in">has_value</span>()) &#123;</span><br><span class="line">    valid_bits_writer-&gt;<span class="built_in">Finish</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (offsets != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">    output-&gt;values_read = offsets - orig_pos;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (valid_bits_writer.<span class="built_in">has_value</span>()) &#123;</span><br><span class="line">    output-&gt;values_read = valid_bits_writer-&gt;<span class="built_in">position</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (output-&gt;null_count &gt; <span class="number">0</span> &amp;&amp; level_info.null_slot_usage &gt; <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="built_in">ParquetException</span>(</span><br><span class="line">        <span class="string">&quot;Null values with null_slot_usage &gt; 1 not supported.&quot;</span></span><br><span class="line">        <span class="string">&quot;(i.e. FixedSizeLists with null values are not supported)&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>è¿™ç¯‡æ–‡ç« ç»§ç»­è®²äº† parquet çš„ C++ æ ‡å‡†åº“æ€ä¹ˆè¯»å–å†…å®¹çš„ã€‚ç®€å•ä»‹ç»äº†ä¸€ä¸‹ æ–‡ä»¶ â€” Column çš„è¯»å–æµã€‚<code>Column</code> ä¸‹é¢çš„ç¼–ç è¿™ç¯‡æ–‡ç« å¹¶æ²¡æœ‰æ¶µç›–ã€‚å¦‚æœçœ‹ä¸æ‡‚çš„è¯â€¦æ„Ÿè§‰ä¹Ÿå¾ˆæ­£å¸¸ï¼Œå› ä¸ºæ„Ÿè§‰è¿™å—ä»£ç æœ¬èº«å†™çš„è´¨é‡å°±â€¦ä¸€èˆ¬èˆ¬ï¼ˆä¸»è¦æ˜¯æ„Ÿè§‰æŠ½è±¡ç¨‹åº¦å¤ªä½äº†ï¼Œè€Œä¸”æŠ½çš„å¾ˆä»¤äººå›°æƒ‘ï¼‰ï¼Ÿä¸è¿‡èƒ½æŠŠè¿™å¥—ä¸œè¥¿åšå‡ºæ¥è¿˜æ˜¯è›®ç‰›é€¼çš„ï¼Œè€å®è¯´æˆ‘çœ‹ç€å°±å¤´ç–¼ã€‚è¿™æ–‡ç« çœ‹æ‡‚èƒ½æ˜ç™½å¤§æ¦‚æµç¨‹æˆ‘è§‰å¾—å°±å¾ˆä¸é”™äº†ï¼Œæˆ‘ä¹Ÿæ˜¯åŠå½“ç¬”è®°è‡ªå·±å†™çš„ã€‚</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Parquet Part2: arrow Parquet and levels</title>
      <link href="/2022/10/04/Parquet-Part2-arrow-Parquet-code-path/"/>
      <url>/2022/10/04/Parquet-Part2-arrow-Parquet-code-path/</url>
      
        <content type="html"><![CDATA[<p>arrow ä»£ç åº“åŒ…å«äº† Parquet çš„ C++ å®˜æ–¹å®ç°ï¼Œå°½ç®¡ impala ä¹‹ç±»çš„ç¬¬ä¸‰æ–¹å®ç°å¤„ç†çš„åŠŸèƒ½è¦å¤šä¸€äº›ï¼Œä½†æ˜¯ back to basicsï¼Œçœ‹çœ‹ parquet è¿™ä¸ªä¹Ÿä¸æ˜¯ä¸€ä»¶åäº‹ã€‚</p><p>éœ€è¦å£°æ˜çš„æ˜¯ï¼Œå¦‚ Velox æ‰€è¯´ï¼Œä½¿ç”¨ Parquet æ¥è®¿é—® IO æœ¬èº«ä¹Ÿéœ€è¦ä¸€äº›å¤æ‚çš„é¡¹ç›®ã€‚è¿™äº›éƒ¨åˆ†å¯èƒ½åŒ…æ‹¬ï¼š</p><ol><li>è°“è¯ä¸‹æ¨</li><li>IO è®¿é—®</li><li>Lazy Decoding</li><li>å…¨å±€å­—å…¸</li></ol><p>å…·ä½“å¯ä»¥å‚è€ƒ abadi çš„è®ºæ–‡ï¼Œå…¶å®æ²¡ä»€ä¹ˆéš¾çš„ï¼Œå·¥ç¨‹ä¸ŠåŸºæœ¬ä¸Šä¹Ÿæ²¡å•¥èŠ±å¤´ï¼Œå—¯å†™å°±æ˜¯äº†ã€‚è¿™äº›å¯èƒ½ä¹‹åä»‹ç»çš„æ—¶å€™ä¼šè®²ï¼Œå…ˆå°±è·³è¿‡å§ã€‚æˆ‘ä»¬ç›´æ¥è¿›å…¥æ­£é¢˜ï¼šParquet çš„ arrow å®˜æ–¹å®ç°ã€‚</p><p>è¿™ä¸€ç‰ˆæœ¬å®ç°æœ‰ä¸€äº›é¡»çŸ¥ï¼š</p><ol><li>æ•°æ®æ¥æºæ˜¯ arrow (é€šå¸¸æ˜¯ <code>arrow::Array</code>)ï¼Œschema ä¹Ÿæ¥è‡ª arrowã€‚</li><li>parquet å®˜æ–¹çš„ thrift åœ¨ï¼š<a href="https://github.com/apache/parquet-format/blob/master/src/main/thrift/parquet.thrift">https://github.com/apache/parquet-format/blob/master/src/main/thrift/parquet.thrift</a> ã€‚arrow åŒ…è£…äº†ä¸€å±‚è®¿é—®å±‚ï¼Œä½äº <code>src/parquet/metadata.h</code>ã€‚å†…éƒ¨å®ç°æ”¾åœ¨ <code>parquet/thrift_internal.h</code></li><li>å¯¹æ–‡ä»¶çš„è®¿é—®åŒ…å«åœ¨äº† <code>src/parquet/platform.h</code>ï¼Œå…¶ä¸­ï¼Œ<code>::arrow::io::InputStream</code> æ˜¯å¯¹è¾“å…¥æµçš„æŠ½è±¡ã€<code>::arrow::io::RandomAccessFile</code> æ˜¯å¯¹è¾“å…¥æ–‡ä»¶çš„æŠ½è±¡ã€‚å…³äºè¿™äº›ï¼Œç›¸å…³çš„å†…å®¹å®ç°åœ¨ <code>arrow/io</code> ä¸‹ï¼Œéƒ¨åˆ†å®ç°è€…æ¯”å¦‚ mmap æ–‡ä»¶ã€hdfs æ–‡ä»¶ã€‚è€Œ arrow è¿˜æœ‰ä¸€å¥—æ–‡ä»¶ç³»ç»Ÿçš„æŠ½è±¡ï¼Œæ¯”å¦‚ <code>arrow/filesystem</code>ï¼Œå®ç°äº† <code>s3</code> å’Œ <code>local</code> çš„æ–‡ä»¶ç³»ç»ŸæŠ½è±¡ï¼ˆä¸çŸ¥é“ä¸ºå•¥ <code>HadoopFileSystem</code> åœ¨ç›®å‰ç‰ˆæœ¬æ²¡æœ‰æ”¾åˆ° filesystem ä¸‹ï¼‰ã€‚</li><li>è¾“å‡ºè¢«åŒ…è£…åœ¨ <code>::arrow::io::BufferOutputStream</code> ä¸­ï¼Œè¿™ä¸ªä¹Ÿæ”¯æŒ mmap, s3, hdfs ç­‰</li><li>åŠ å¯†ã€é»˜è®¤å€¼ã€é…ç½®å€¼ç›¸å…³çš„é…ç½®åœ¨ <code>properties.h</code> é‡Œé¢</li></ol><p>ä¸Šé¢éƒ½æ˜¯é…ç½®çš„é€»è¾‘ã€‚arrow çš„ä»£ç å®ç°å¤§é‡é‡‡ç”¨äº† pimpl çš„é€»è¾‘ï¼Œæœ‰ä¸€å †:</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">XXX</span> &#123;</span><br><span class="line"> <span class="keyword">class</span> <span class="title class_">Contents</span> &#123;...&#125;;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line"> std::unique_ptr&lt;Contents&gt; contents_;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢è¿™æ ·çš„ sb é€»è¾‘</p><h2 id="Arrow-cheatsheet"><a href="#Arrow-cheatsheet" class="headerlink" title="Arrow cheatsheet"></a>Arrow cheatsheet</h2><p>è™½ç„¶æˆ‘ä»¬ä¸»é¢˜ä¸æ˜¯ä»‹ç» Arrowï¼Œä¸è¿‡å¯ä»¥ç®€å•ä»‹ç»ä¸€ä¸‹ arrow çš„ç±»å‹ç³»ç»Ÿï¼Œæä¾›ä¸€äº›ç®€å•çš„ cheatsheetã€‚å…·ä½“å¯¹ arrow ä»‹ç»ä¼°è®¡ä¹Ÿä¸å¤šã€‚</p><h3 id="Array"><a href="#Array" class="headerlink" title="Array"></a>Array</h3><p>Array æ˜¯å…¶ä¸­æœ€åŸºæœ¬çš„ç±»å‹ï¼Œå¤§æ¦‚æ˜¯ã€Œåˆ—å¼æ•°ç»„ã€çš„æ¦‚å¿µï¼Œæ”¯æŒ nullã€åµŒå¥—ã€å˜é•¿ã€æ•°ç»„æ ¼å¼ç­‰ã€‚å¦å¤–ï¼Œå¯ä»¥ä»ä»£ç å±‚é¢æ³¨æ„ä¸€ä¸‹ï¼Œè¿™é‡Œçš„å­—ç¬¦ä¸² Buffer å¯èƒ½å¹¶ä¸éœ€è¦ ownedï¼Œä½†æ˜¯éœ€è¦æ˜¯è¿ç»­çš„ï¼Œå‡ ä¸ªéƒ¨åˆ†éœ€è¦åœ¨åŒä¸€ä¸ª buffer é‡Œï¼Œä¹‹é—´æ²¡æœ‰ paddingã€‚æ•°æ®å› ä¸ºéœ€è¦ $O(1)$ æ‰¾åˆ°ä½ç½®ï¼Œæ‰€ä»¥æ˜¯ null çš„åœ°æ–¹ä¼šæ˜¯ä¸€ä¸ª undefined çš„å€¼ï¼Œä½†æ˜¯è¦å ç€å†…å­˜ã€‚</p><p>ä¸‹é¢çš„å†…å®¹æœ‰ä¸¤ä¸ªæ¥æºï¼š</p><ol><li>å®˜æ–¹çš„ formatï¼Œå¾ˆå¿«å¯ä»¥è¯»å®Œï¼Œå¤§æ¦‚30åˆ†é’Ÿï¼š<a href="https://arrow.apache.org/docs/format/Columnar.html#fixed-size-list-layout">https://arrow.apache.org/docs/format/Columnar.html#fixed-size-list-layout</a> </li><li>In-Memory Analytics with Apache Arrow ç¬¬ä¸€ç« ï¼Œè¿™é‡Œçš„å›¾ç‰‡éå¸¸å¥½ã€‚</li></ol><p><img src="https://image.mwish.me/blog-image/D113AFDFF7CD13071A3A407B9CED5CC3.png" alt="D113AFDFF7CD13071A3A407B9CED5CC3"></p><p>Build Blocks:</p><ol><li>Array lengths: æ ‡å‡†å»ºè®®ä½¿ç”¨ 64 bytes çš„ i64ï¼Œä½†æ˜¯ 32 bytes (i32) ä¹Ÿç¬¦åˆæ ‡å‡†ã€‚æ–‡ç« æåˆ°å¦‚æœå…ƒç´ ç‰¹åˆ«å¤šï¼Œå»ºè®®æ‹†åˆ†æˆå¤šä¸ª i32 å¯ä»¥è¡¨ç¤ºçš„æ•°ç»„</li><li>Buffer<ol><li>å®˜æ–¹å»ºè®®æŒ‰ç…§ 64 bytes æ¥å¯¹é½ Bufferï¼Œè¿™æ–¹ä¾¿ä½¿ç”¨ SIMD å’Œå¼€å¯ä¸€äº› SIMD ä¸Šçš„ä¼˜åŒ–ã€‚ç›®å‰ AVX512 å¯„å­˜å™¨å®½åº¦æ˜¯ 512 bitsã€‚</li></ol></li><li>null count / Validity bitmaps: null count  è¡¨ç¤ºå…ƒç´ æ˜¯ null çš„ä¸ªæ•°ï¼Œæ˜¯ 0 çš„æ—¶å€™å¯ä»¥ä¸éœ€è¦ validity bitmapsã€‚å¦‚æœé 0ï¼Œå¯èƒ½æœ‰ä¸€ä¸ª 64 bytes padding çš„ bitmapã€‚bitmap æŒ‰ç…§ LSB å®šä¹‰ï¼Œå¤§äº 64B çš„å†…å®¹</li></ol><p>å…·ä½“ä¾‹å­å¯ä»¥çœ‹çœ‹ä¸‹å›¾ï¼š</p><p><img src="https://image.mwish.me/blog-image/83EE405A-49D0-4A4A-89E7-9BB222B2505E.png" alt="83EE405A-49D0-4A4A-89E7-9BB222B2505E"></p><p><img src="https://image.mwish.me/blog-image/3139E767-4789-4593-B147-B2618FE224F7.png" alt="3139E767-4789-4593-B147-B2618FE224F7"></p><p>éœ€è¦ç‰¹åˆ«æ³¨æ„çš„æ˜¯ä¸€äº›æœ‰ã€ŒåµŒå¥—ã€æ€§è´¨çš„ç»“æ„ï¼Œä¸¾ä¾‹å­ï¼š<code>List&lt;T&gt;</code>, <code>List&lt;List&lt;T&gt;&gt;</code>ï¼Œ<code>Struct</code>ï¼š</p><p>åµŒå¥—é€»è¾‘ä¸­ï¼Œæˆ‘ä»¬éœ€è¦å°å°çš„å…³æ³¨ä¸€ä¸‹ã€Œçˆ¶çº§æ˜¯ nullã€æ˜¯æ€ä¹ˆå¤„ç†çš„ï¼Œåœ¨ Array ä¸­ï¼Œè¿™ä¸ªé çˆ¶çº§åˆ« null æ¥è§£å†³ã€‚åœ¨ struct ä¸­ï¼Œè¿™ä¸ªé çˆ¶çº§åˆ« null â€” å­çº§åˆ« null æ¥åŒºåˆ†ã€‚å¯ä»¥çœ‹åˆ°ï¼Œè¿™ä¸ªæ¯” dremel é‚£ç§è¿˜æ˜¯ç®€å•äº†å¾ˆå¤šçš„ã€‚</p><p><img src="https://image.mwish.me/blog-image/C865616E-E6CF-47FD-8440-A0F5E5EF8F47.png" alt="C865616E-E6CF-47FD-8440-A0F5E5EF8F47"></p><p><img src="https://image.mwish.me/blog-image/0A39F9FA-54F7-4E5A-8FBC-FAD7AB5FE42B.png" alt="0A39F9FA-54F7-4E5A-8FBC-FAD7AB5FE42B"></p><p>é¢å¤–éœ€è¦æçš„æ˜¯å­—å…¸ï¼Œå®ƒä»¬ä¼šæœ‰æŒ‡å‘å­—å…¸çš„é€»è¾‘ï¼š</p><p><img src="https://image.mwish.me/blog-image/49EB35E6-7864-49CA-B433-FB985F598909.png" alt="49EB35E6-7864-49CA-B433-FB985F598909"></p><h2 id="Rep-Level-and-Def-Levels"><a href="#Rep-Level-and-Def-Levels" class="headerlink" title="Rep Level and Def Levels"></a>Rep Level and Def Levels</h2><p>ç†è®ºè®²äº†è¿˜æ˜¯æ²¡æ„æ€ï¼Œçœ‹ä»£ç å§</p><p>ä»£ç å…¥å£ï¼š</p><p>è¿™æ˜¯ä¸€ä¸ª Level Builderï¼Œå¤–å±‚çš„ä½¿ç”¨å…¥å£åœ¨ï¼š</p><ol><li><code>ArrowColumnWriterV2::Make</code>ï¼Œåˆ›å»ºå¯¹åº”çš„ <code>MultipathLevelBuilder</code>. <code>ArrowColumnWriterV2</code> æ˜¯æŸä¸ªå…·ä½“çš„åˆ—çš„ writerã€‚è¿™ä¸ªåœ°æ–¹ï¼ŒWriter ä¼šåˆ† chunk æ‹¿åˆ°ä¸åŒçš„ Arrayï¼Œæ„å»ºå¯¹åº”çš„ <code>MultipathLevelBuilder</code></li><li><code>MultipathLevelBuilder</code> å†™å…¥ä¼šè¿”å›ä¸€ä¸ª <code>MultipathLevelBuilderResult</code>ï¼Œä¸Šå±‚æ ¹æ®è¿™ä¸ªæ‹¿åˆ° <code>rep-level</code> å’Œ <code>def-level</code>ï¼Œç„¶åå†™å…¥</li></ol><p>ä¸‹é¢ç®€å•çœ‹ä¸€ä¸‹è¿™äº›æ¥å£ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// \brief Result for a single leaf array when running the builder on the</span></span><br><span class="line"><span class="comment">/// its root.</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">MultipathLevelBuilderResult</span> &#123;</span><br><span class="line">  <span class="comment">/// \brief The Array containing only the values to write (after all nesting has</span></span><br><span class="line">  <span class="comment">/// been processed.</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// No additional processing is done on this array (it is copied as is when</span></span><br><span class="line">  <span class="comment">/// visited via a DFS).</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// leaf_array æ˜¯å†™å…¥é¡µé¢çš„æ•´ä¸ª array, å³æ•´åˆ—çš„æ•°æ®</span></span><br><span class="line">  std::shared_ptr&lt;::arrow::Array&gt; leaf_array;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// \brief Might be null.</span></span><br><span class="line">  <span class="type">const</span> <span class="type">int16_t</span>* def_levels = <span class="literal">nullptr</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// \brief  Might be null.</span></span><br><span class="line">  <span class="type">const</span> <span class="type">int16_t</span>* rep_levels = <span class="literal">nullptr</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// \brief Number of items (int16_t) contained in def/rep_levels when present.</span></span><br><span class="line">  <span class="comment">/// def-level å’Œ rep-level é•¿åº¦æ˜¯ä¸€æ ·çš„, æ‰€ä»¥éœ€è¦ä¸€ä¸ª level æ¥æç¤º</span></span><br><span class="line">  <span class="type">int64_t</span> def_rep_level_count = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// \brief Contains element ranges of the required visiting on the</span></span><br><span class="line">  <span class="comment">/// descendants of the final list ancestor for any leaf node.</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// The algorithm will attempt to consolidate visited ranges into</span></span><br><span class="line">  <span class="comment">/// the smallest number possible.</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// This data is necessary to pass along because after producing</span></span><br><span class="line">  <span class="comment">/// def-rep levels for each leaf array it is impossible to determine</span></span><br><span class="line">  <span class="comment">/// which values have to be sent to parquet when a null list value</span></span><br><span class="line">  <span class="comment">/// in a nullable ListArray is non-empty.</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// This allows for the parquet writing to determine which values ultimately</span></span><br><span class="line">  <span class="comment">/// needs to be written.</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// å†™å…¥çš„å†…å®¹åœ¨ `leaf_array` ä¸­çš„èŒƒå›´</span></span><br><span class="line">  std::vector&lt;ElementRange&gt; post_list_visited_elements;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// Whether the leaf array is nullable.</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// leaf æ˜¯å¦æ˜¯ nullable çš„</span></span><br><span class="line">  <span class="type">bool</span> leaf_is_nullable;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ç„¶åç”¨ <code>Write</code> æ¥å£å»èµ° callbackï¼Œæ¥å¾€ writer å†™å…¥æ•°æ®ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Status <span class="title">WriteColumnChunk</span><span class="params">(<span class="type">const</span> std::shared_ptr&lt;ChunkedArray&gt;&amp; data, <span class="type">int64_t</span> offset,</span></span></span><br><span class="line"><span class="params"><span class="function">                        <span class="type">int64_t</span> size)</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (arrow_properties_-&gt;<span class="built_in">engine_version</span>() == ArrowWriterProperties::V2 ||</span><br><span class="line">      arrow_properties_-&gt;<span class="built_in">engine_version</span>() == ArrowWriterProperties::V1) &#123;</span><br><span class="line">    <span class="built_in">ARROW_ASSIGN_OR_RAISE</span>(</span><br><span class="line">        std::unique_ptr&lt;ArrowColumnWriterV2&gt; writer,</span><br><span class="line">        ArrowColumnWriterV2::<span class="built_in">Make</span>(*data, offset, size, schema_manifest_,</span><br><span class="line">                                  row_group_writer_));</span><br><span class="line">    <span class="keyword">return</span> writer-&gt;<span class="built_in">Write</span>(&amp;column_write_context_);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> Status::<span class="built_in">NotImplemented</span>(<span class="string">&quot;Unknown engine version.&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Writes out all leaf parquet columns to the RowGroupWriter that this</span></span><br><span class="line"><span class="comment">// object was constructed with.  Each leaf column is written fully before</span></span><br><span class="line"><span class="comment">// the next column is written (i.e. no buffering is assumed).</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Columns are written in DFS order.</span></span><br><span class="line"><span class="function">Status <span class="title">Write</span><span class="params">(ArrowWriteContext* ctx)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> leaf_idx = <span class="number">0</span>; leaf_idx &lt; leaf_count_; leaf_idx++) &#123;</span><br><span class="line">    ColumnWriter* column_writer;</span><br><span class="line">    <span class="built_in">PARQUET_CATCH_NOT_OK</span>(column_writer = row_group_writer_-&gt;<span class="built_in">NextColumn</span>());</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span>&amp; level_builder : level_builders_) &#123;</span><br><span class="line">      <span class="built_in">RETURN_NOT_OK</span>(level_builder-&gt;<span class="built_in">Write</span>(</span><br><span class="line">          leaf_idx, ctx, [&amp;](<span class="type">const</span> MultipathLevelBuilderResult&amp; result) &#123;</span><br><span class="line">            <span class="type">size_t</span> visited_component_size = result.post_list_visited_elements.<span class="built_in">size</span>();</span><br><span class="line">            <span class="built_in">DCHECK_GT</span>(visited_component_size, <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">if</span> (visited_component_size != <span class="number">1</span>) &#123;</span><br><span class="line">              <span class="keyword">return</span> Status::<span class="built_in">NotImplemented</span>(</span><br><span class="line">                  <span class="string">&quot;Lists with non-zero length null components are not supported&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">const</span> ElementRange&amp; range = result.post_list_visited_elements[<span class="number">0</span>];</span><br><span class="line">            std::shared_ptr&lt;Array&gt; values_array =</span><br><span class="line">                result.leaf_array-&gt;<span class="built_in">Slice</span>(range.start, range.<span class="built_in">Size</span>());</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> column_writer-&gt;<span class="built_in">WriteArrow</span>(result.def_levels, result.rep_levels,</span><br><span class="line">                                             result.def_rep_level_count, *values_array,</span><br><span class="line">                                             ctx, result.leaf_is_nullable);</span><br><span class="line">          &#125;));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">PARQUET_CATCH_NOT_OK</span>(column_writer-&gt;<span class="built_in">Close</span>());</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> Status::<span class="built_in">OK</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œèµ°äº† <code>MultipathLevelBuilder::Write</code>ï¼Œç„¶åé‡Œé¢èµ°äº†å›è°ƒï¼Œå›è°ƒå‡½æ•°çš„å‚æ•°å°±æ˜¯ä¹‹å‰æåˆ°çš„ <code>MultipathLevelBuilderResult</code>ã€‚è¿™ä¸ªå‡½æ•°ç»™æ²¡æœ‰ rep-level å’Œ def-level çš„è¾“å…¥åŠ ä¸Šäº†è¿™ä¸¤ä¸ª levelï¼Œä¹‹å <code>ColumnWriter</code> å°±å¯ä»¥æ‹¿åˆ° def-level, rep-level å’Œå€¼å»å†™äº†ã€‚é‚£ä¹ˆï¼Œè¿™é‡Œçš„å…³é”®åº”è¯¥å°±æ˜¯ rep-level å’Œ def-level æ˜¯æ€ä¹ˆæ„å»ºçš„äº†ã€‚</p><p>è¿™éƒ¨åˆ†å…³é”®çš„å†…å®¹åœ¨ <code>parquet/arrow/path_internal.cc</code> ä¸‹é¢ã€‚æˆ‘ä»¬ç®€å•ä»‹ç»ä¸€ä¸‹å¯¹åº”çš„ç®—æ³•ï¼š</p><ol><li>è¾“å…¥æ˜¯å¯¹åº”çš„ arrow Array å’Œç›¸å…³çš„ schema</li><li>dfs çš„æ–¹å¼æ¨æ–­å‡ºï¼Œã€Œè¿™ä¸ªåœ°æ–¹æœ€å¤§çš„ def-level æ˜¯ä»€ä¹ˆï¼Œrep-level æ˜¯ä»€ä¹ˆã€</li><li>æ‹¿åˆ°ç”¨æˆ·çš„è¾“å…¥ arrayï¼Œè¿›è¡Œè®¡ç®—</li></ol><p>åœ¨æ­¥éª¤ (2)ï¼Œarrow ä¼šæ ¹æ®è¾“å…¥æ•°æ®æ„å»ºå‡ºæ ‘ï¼Œæœ‰ä¸¤ç§èŠ‚ç‚¹ï¼š</p><ol><li>ListNode / StructNode / MapNode: æœ‰å­èŠ‚ç‚¹ä¸”éç»ˆæ­¢çš„èŠ‚ç‚¹</li><li>TerminalNode: ç»ˆæ­¢çš„èŠ‚ç‚¹ã€‚è¿™é‡ŒåŒ…æ‹¬ <code>AllNullsTerminalNode</code>(æ‰€æœ‰æˆå‘˜éƒ½æ˜¯ nullï¼‰ã€<code>AllPresentTerminalNode</code>ï¼ˆå…¨éƒ½æœ‰ï¼Œä¸”çˆ¶çº§åˆ«æ²¡æœ‰ null çš„èŠ‚ç‚¹ï¼‰ï¼Œ<code>NullableTerminalNode</code> å¯èƒ½æœ‰ null ä½†ä¸å»ä¸º null</li></ol><p>ä¸€èˆ¬æ¥è¯´ï¼Œå¯ä»¥ç†è§£ <code>TerminalNode</code> ä¸ºå¶å­ç»“ç‚¹ï¼Œè€Œå…¶å®ƒèŠ‚ç‚¹ä¸ºéå¶å­ç»“ç‚¹ï¼Œä½†æ˜¯ä¹Ÿæœ‰ä¸€äº›ç‰¹æ®Šæƒ…å†µï¼Œæ¯”å¦‚çˆ¶çº§å°±å‘ç°å…¨éƒ¨æ˜¯ null äº†ï¼Œè¿™é‡Œä¹Ÿå¯èƒ½æ˜¯ä¸ª <code>TerminalNode</code>ã€‚</p><p>æ¯ä¸ª <code>Node</code> æœ‰ä¸€ä¸ª <code>Run</code> æ–¹æ³•ï¼Œä½œä¸º (3) éœ€è¦çš„å‡½æ•°ï¼Œä½†æ˜¯å‚æ•°å¹¶ä¸ç›¸åŒï¼ŒNode ä¹‹é—´ä¹Ÿä¸æ˜¯ç»§æ‰¿å…³ç³»ï¼Œè€Œæ˜¯ç»„åˆå…³ç³»ï¼Œç”± <code>variant</code> åŒ…è£…ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Contains static information derived from traversing the schema.</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">PathInfo</span> &#123;</span><br><span class="line">  <span class="comment">// The vectors are expected to the same length info.</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Note index order matters here.</span></span><br><span class="line">  <span class="keyword">using</span> Node =</span><br><span class="line">      std::variant&lt;NullableTerminalNode, ListNode, LargeListNode, FixedSizeListNode,</span><br><span class="line">                   NullableNode, AllPresentTerminalNode, AllNullsTerminalNode&gt;;</span><br><span class="line"></span><br><span class="line">  std::vector&lt;Node&gt; path;</span><br><span class="line">  std::shared_ptr&lt;Array&gt; primitive_array;</span><br><span class="line">  <span class="type">int16_t</span> max_def_level = <span class="number">0</span>;</span><br><span class="line">  <span class="type">int16_t</span> max_rep_level = <span class="number">0</span>;</span><br><span class="line">  <span class="type">bool</span> has_dictionary = <span class="literal">false</span>;</span><br><span class="line">  <span class="type">bool</span> leaf_is_nullable = <span class="literal">false</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯ä»¥çœ‹çœ‹ä¸Šé¢çš„ <code>PathInfo</code>ï¼Œè¿™é‡Œçš„ç›®æ ‡å°±æ˜¯æ„å»ºä¸€ä¸ªè¿™æ ·çš„ <code>PathInfo</code>.</p><h3 id="PathBuilder-æ„å»º-Node-é˜¶æ®µ"><a href="#PathBuilder-æ„å»º-Node-é˜¶æ®µ" class="headerlink" title="PathBuilder: æ„å»º Node é˜¶æ®µ"></a>PathBuilder: æ„å»º Node é˜¶æ®µ</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// static</span></span><br><span class="line">::arrow::Result&lt;std::unique_ptr&lt;MultipathLevelBuilder&gt;&gt; MultipathLevelBuilder::<span class="built_in">Make</span>(</span><br><span class="line">    <span class="type">const</span> ::arrow::Array&amp; array, <span class="type">bool</span> array_field_nullable) &#123;</span><br><span class="line">  <span class="keyword">auto</span> constructor = std::<span class="built_in">make_unique</span>&lt;PathBuilder&gt;(array_field_nullable);</span><br><span class="line">  <span class="comment">// é€’å½’åˆ†å‘ç»™ PathBuilder è®¿é—® arrow array, æåˆ°å¯¹åº”çš„ schema. è¿™é‡Œ leaf count å¯èƒ½ä¸æ­¢ 1.</span></span><br><span class="line">  <span class="built_in">RETURN_NOT_OK</span>(<span class="built_in">VisitArrayInline</span>(array, constructor.<span class="built_in">get</span>()));</span><br><span class="line">  <span class="keyword">return</span> std::<span class="built_in">make_unique</span>&lt;MultipathLevelBuilderImpl&gt;(array.<span class="built_in">data</span>(),</span><br><span class="line">                                                     std::<span class="built_in">move</span>(constructor));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œåˆ›å»ºäº†ä¸€ä¸ª <code>PathBuilder</code>ï¼Œç„¶åè®¿é—®äº† <code>VisitArrayInline</code>ï¼Œè¿™é‡Œç›¸å½“äºè‡ªå·±å®šä¹‰äº†ä¸€ä¸ªè®¿é—® array çš„æ–¹æ³•</p><p><code>PathBuilder</code> æä¾›äº† <code>Visit(ä¸åŒçš„ Array)</code> çš„æ–¹æ³•ï¼Œèƒ½å¤Ÿå®ŒæˆåŠ¨æ€åˆ†å‘ã€‚ä¸è¿‡è¿›å…¥å…·ä½“è®¿é—®æ–¹å¼å‰ï¼Œå…ˆæ¥çœ‹çœ‹å®ƒçš„æˆå‘˜ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">PathBuilder</span> &#123;</span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="function"><span class="keyword">explicit</span> <span class="title">PathBuilder</span><span class="params">(<span class="type">bool</span> start_nullable)</span> : nullable_in_parent_(start_nullable) &#123;</span>&#125;</span><br><span class="line"> <span class="keyword">private</span>:</span><br><span class="line">  PathInfo info_;</span><br><span class="line">  std::vector&lt;PathInfo&gt; paths_;</span><br><span class="line">  <span class="type">bool</span> nullable_in_parent_;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><code>nullable_in_parent_</code> è¿™ä¸ªæ˜¯è¡¨ç¤ºï¼Œä»»ä½•çˆ¶äº²çš„è¿™ä¸ªå­—æ®µæ˜¯å¦å¯èƒ½æ˜¯ nullã€‚åœ¨ä»£ç é‡Œï¼Œä¸¢ç»™ PathBuilder è¿™ç©æ„æ˜¯è¿™æ ·çš„ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">bool</span> nullable_root = <span class="built_in">HasNullableRoot</span>(schema_manifest, schema_field);</span><br><span class="line"><span class="keyword">if</span> (leaf_offset == <span class="number">0</span>) &#123;</span><br><span class="line">  is_nullable = nullable_root;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªçœ‹ä¸Šå»æ˜¯ <code>HasNullableRoot</code>ï¼Œä½†æ˜¯ä¸¢ç»™ path çš„ä¸€èˆ¬éƒ½æ˜¯ root çš„ç›´æ¥å„¿å­ï¼Œæ‰€ä»¥è¿™é‡Œè¡¨ç¤ºçš„å°±æ˜¯ <code>parent</code> çš„è¿™ä¸ªå­—æ®µå¯èƒ½ä¸å¯èƒ½æ˜¯ nullã€‚</p><h4 id="å¤„ç†çˆ¶çº§åˆ«-null"><a href="#å¤„ç†çˆ¶çº§åˆ«-null" class="headerlink" title="å¤„ç†çˆ¶çº§åˆ« null"></a>å¤„ç†çˆ¶çº§åˆ« null</h4><p>æœ‰ä¸€ä¸ªå¾ˆå¸¸è§çš„å‡½æ•°æ˜¯ <code>MaybeAddNullable</code>ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ·»åŠ å¯¹åº”çš„ def-level,</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">MaybeAddNullable</span><span class="params">(<span class="type">const</span> Array&amp; array)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!nullable_in_parent_) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  info_.max_def_level++;</span><br><span class="line">  <span class="comment">// We don&#x27;t use null_count() because if the null_count isn&#x27;t known</span></span><br><span class="line">  <span class="comment">// and the array does in fact contain nulls, we will end up</span></span><br><span class="line">  <span class="comment">// traversing the null bitmap twice (once here and once when calculating</span></span><br><span class="line">  <span class="comment">// rep/def levels). Because this isn&#x27;t terminal this might not be</span></span><br><span class="line">  <span class="comment">// the right decision for structs that share the same nullable</span></span><br><span class="line">  <span class="comment">// parents.</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">LazyNoNulls</span>(array)) &#123;</span><br><span class="line">    <span class="comment">// Don&#x27;t add anything because there won&#x27;t be any point checking</span></span><br><span class="line">    <span class="comment">// null values for the array.  There will always be at least</span></span><br><span class="line">    <span class="comment">// one more array to handle nullability.</span></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// åæ­£éƒ½æ²¡äº†ï¼Œä¸å¦‚ terminal äº†</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">LazyNullCount</span>(array) == array.<span class="built_in">length</span>()) &#123;</span><br><span class="line">    info_.path.<span class="built_in">emplace_back</span>(<span class="built_in">AllNullsTerminalNode</span>(info_.max_def_level - <span class="number">1</span>));</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  info_.path.<span class="built_in">emplace_back</span>(</span><br><span class="line">      <span class="built_in">NullableNode</span>(array.<span class="built_in">null_bitmap_data</span>(), array.<span class="built_in">offset</span>(),</span><br><span class="line">                   <span class="comment">/* def_level_if_null = */</span> info_.max_def_level - <span class="number">1</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå¦‚æœæ˜¯çˆ¶çº§ nullï¼Œå°±ä¼šå¢åŠ  <code>max_def_level</code>ï¼Œç„¶åæ·»åŠ å¯¹åº”çš„èŠ‚ç‚¹é¡¹ã€‚</p><h4 id="è®¿é—®-struct"><a href="#è®¿é—®-struct" class="headerlink" title="è®¿é—® struct"></a>è®¿é—® struct</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Status <span class="title">Visit</span><span class="params">(<span class="type">const</span> ::arrow::StructArray&amp; array)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">MaybeAddNullable</span>(array);</span><br><span class="line">  PathInfo info_backup = info_;</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> x = <span class="number">0</span>; x &lt; array.<span class="built_in">num_fields</span>(); x++) &#123;</span><br><span class="line">    nullable_in_parent_ = array.<span class="built_in">type</span>()-&gt;<span class="built_in">field</span>(x)-&gt;<span class="built_in">nullable</span>();</span><br><span class="line">    <span class="built_in">RETURN_NOT_OK</span>(<span class="built_in">VisitInline</span>(*array.<span class="built_in">field</span>(x)));</span><br><span class="line">    info_ = info_backup;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> Status::<span class="built_in">OK</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä»£ç åº”è¯¥éå¸¸å¥½ç†è§£ï¼Œå°±æ˜¯é€’å½’è®¿é—®ã€‚</p><h4 id="è®¿é—®-ListArray"><a href="#è®¿é—®-ListArray" class="headerlink" title="è®¿é—® ListArray"></a>è®¿é—® ListArray</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">::arrow::<span class="type">enable_if_t</span>&lt;std::is_same&lt;::arrow::ListArray, T&gt;::value ||</span><br><span class="line">                         std::is_same&lt;::arrow::LargeListArray, T&gt;::value,</span><br><span class="line">                     Status&gt;</span><br><span class="line"><span class="built_in">Visit</span>(<span class="type">const</span> T&amp; array) &#123;</span><br><span class="line">  <span class="comment">// å¤„ç†çˆ¶çº§åˆ«å¸¦æ¥çš„ def, å’Œè‡ªèº«åœºæ™¯</span></span><br><span class="line">  <span class="comment">// å¯¹äº parquet çš„ list, è¿™é‡Œç›¸å½“äºä¸¤ç»„æ ‡è®°:</span></span><br><span class="line">  <span class="comment">// List &#123;</span></span><br><span class="line">  <span class="comment">//   repeatable member</span></span><br><span class="line">  <span class="comment">// &#125;</span></span><br><span class="line">  <span class="comment">// è¿™ä¸¤å±‚éƒ½æ˜¯ rep/def å“¦ï½</span></span><br><span class="line">  <span class="built_in">MaybeAddNullable</span>(array);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Increment necessary due to empty lists.</span></span><br><span class="line">  info_.max_def_level++;</span><br><span class="line">  info_.max_rep_level++;</span><br><span class="line">  <span class="comment">// raw_value_offsets() accounts for any slice offset.</span></span><br><span class="line">  ListPathNode&lt;VarRangeSelector&lt;<span class="keyword">typename</span> T::offset_type&gt;&gt; <span class="built_in">node</span>(</span><br><span class="line">      VarRangeSelector&lt;<span class="keyword">typename</span> T::offset_type&gt;&#123;array.<span class="built_in">raw_value_offsets</span>()&#125;,</span><br><span class="line">      info_.max_rep_level, info_.max_def_level - <span class="number">1</span>);</span><br><span class="line">  info_.path.<span class="built_in">emplace_back</span>(std::<span class="built_in">move</span>(node));</span><br><span class="line">  nullable_in_parent_ = array.<span class="built_in">list_type</span>()-&gt;<span class="built_in">value_field</span>()-&gt;<span class="built_in">nullable</span>();</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">VisitInline</span>(*array.<span class="built_in">values</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œ <code>max_rep_level</code> å’Œ <code>max_def_level - 1</code> å¾—å›é¡¾ä¸€ä¸‹ä¸Šä¸€ç¯‡åšå®¢äº†ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> RangeSelector&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ListPathNode</span> &#123;</span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="built_in">ListPathNode</span>(RangeSelector selector, <span class="type">int16_t</span> rep_lev, <span class="type">int16_t</span> def_level_if_empty)</span><br><span class="line">      : <span class="built_in">selector_</span>(std::<span class="built_in">move</span>(selector)),</span><br><span class="line">        <span class="built_in">prev_rep_level_</span>(rep_lev - <span class="number">1</span>),</span><br><span class="line">        <span class="built_in">rep_level_</span>(rep_lev),</span><br><span class="line">        <span class="built_in">def_level_if_empty_</span>(def_level_if_empty) &#123;&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><code>VarRangeSelector</code> åˆ™æŒæœ‰äº† array å…ƒç´ çš„ offsetsï¼Œè¿˜è®°å¾—å‰é¢çš„ <code>ListArray</code> çš„å›¾å—ï¼Ÿ</p><h4 id="è®¿é—®å¶å­ç»“ç‚¹"><a href="#è®¿é—®å¶å­ç»“ç‚¹" class="headerlink" title="è®¿é—®å¶å­ç»“ç‚¹"></a>è®¿é—®å¶å­ç»“ç‚¹</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//! æ˜¯å¹³å¦çš„ array, å¯ä»¥å½“ä½œæ‰¾åˆ°äº†æŸä¸ªå¶å­.</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">::arrow::<span class="type">enable_if_t</span>&lt;std::is_base_of&lt;::arrow::FlatArray, T&gt;::value, Status&gt; <span class="built_in">Visit</span>(</span><br><span class="line">    <span class="type">const</span> T&amp; array) &#123;</span><br><span class="line">  <span class="comment">// åœ¨å¶å­å±‚é¢åŠ ä¸Š terminal info.</span></span><br><span class="line">  <span class="built_in">AddTerminalInfo</span>(array);</span><br><span class="line">  <span class="keyword">return</span> Status::<span class="built_in">OK</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„é‡ç‚¹æ˜¯ <code>AddTerminalInfo</code>ï¼Œæ·»åŠ äº†å¯¹åº”çš„ <code>TerminalNode</code>:</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">AddTerminalInfo</span><span class="params">(<span class="type">const</span> T&amp; array)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// è¿™é‡Œ, leaf_is_nullable ç»ç”± parent å®ç°, è¡¨ç¤ºã€Œçˆ¶çº§åˆ«çš„è¿™ä¸ªå­—æ®µå¯èƒ½æ˜¯ nullableã€çš„ã€‚</span></span><br><span class="line">  info_.leaf_is_nullable = nullable_in_parent_;</span><br><span class="line">  <span class="keyword">if</span> (nullable_in_parent_) &#123;</span><br><span class="line">    info_.max_def_level++; <span class="comment">// (åŠ ä¸Š)è¿™ä¸€å±‚çš„ def-level</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ³¨æ„: rep-level åœ¨åº•å±‚æ˜¯ä¸ä¼šå¤„ç†çš„ï¼Œéƒ½æ˜¯ä¸Šå±‚å¤„ç†çš„ã€‚</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// We don&#x27;t use null_count() because if the null_count isn&#x27;t known</span></span><br><span class="line">  <span class="comment">// and the array does in fact contain nulls, we will end up</span></span><br><span class="line">  <span class="comment">// traversing the null bitmap twice (once here and once when calculating</span></span><br><span class="line">  <span class="comment">// rep/def levels).</span></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  <span class="comment">// å¤„ç†: æ²¡æœ‰ null, éƒ½æ˜¯ null, å¯ä»¥ä¸º null çš„ case. æŠŠè¿™ä¸ªåŠ å…¥ info_.path ä¸­.</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">LazyNoNulls</span>(array)) &#123;</span><br><span class="line">    info_.path.<span class="built_in">emplace_back</span>(AllPresentTerminalNode&#123;info_.max_def_level&#125;);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">LazyNullCount</span>(array) == array.<span class="built_in">length</span>()) &#123;</span><br><span class="line">    info_.path.<span class="built_in">emplace_back</span>(<span class="built_in">AllNullsTerminalNode</span>(info_.max_def_level - <span class="number">1</span>));</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    info_.path.<span class="built_in">emplace_back</span>(<span class="built_in">NullableTerminalNode</span>(array.<span class="built_in">null_bitmap_data</span>(),</span><br><span class="line">                                                 array.<span class="built_in">offset</span>(), info_.max_def_level));</span><br><span class="line">  &#125;</span><br><span class="line">  info_.primitive_array = std::<span class="built_in">make_shared</span>&lt;T&gt;(array.<span class="built_in">data</span>());</span><br><span class="line">  <span class="comment">// çœŸæ­£å¤„ç†è¿™ä¸ª dfs path, æŠŠ fixup çš„ç»“æœåŠ å…¥ paths. è¿™é‡Œé¢ä¼šå¤„ç† rep-level.</span></span><br><span class="line">  paths_.<span class="built_in">push_back</span>(<span class="built_in">Fixup</span>(info_));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ª <code>Fixup</code> æ˜¯å¤„ç† rep-level çš„å‡½æ•°ï¼Œæˆ‘ä»¬å†çœ‹çœ‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// FIXUP ä¼šå¤„ç† rep-level.</span></span><br><span class="line"><span class="function">PathInfo <span class="title">Fixup</span><span class="params">(PathInfo info)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// We only need to fixup the path if there were repeated</span></span><br><span class="line">  <span class="comment">// elements on it.</span></span><br><span class="line">  <span class="keyword">if</span> (info.max_rep_level == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> info;</span><br><span class="line">  &#125;</span><br><span class="line">  FixupVisitor visitor;</span><br><span class="line">  visitor.max_rep_level = info.max_rep_level;</span><br><span class="line">  <span class="keyword">if</span> (visitor.max_rep_level &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    visitor.rep_level_if_null = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ä» 0-æœ€åçš„é¡ºåºè®¿é—®, å˜æ›´ visitor, è¿™ä¸ªåœ°æ–¹ä¼šæŠŠæœ€ä¸Šå±‚çš„ rep-level å¸¦ä¸‹æ¥.</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">size_t</span> x = <span class="number">0</span>; x &lt; info.path.<span class="built_in">size</span>(); x++) &#123;</span><br><span class="line">    std::<span class="built_in">visit</span>(visitor, info.path[x]);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> info;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">FixupVisitor</span> &#123;</span><br><span class="line">  <span class="type">int</span> max_rep_level = <span class="number">-1</span>;</span><br><span class="line">  <span class="type">int16_t</span> rep_level_if_null = kLevelNotSet; <span class="comment">// (ç¬¬ä¸€ä¸ª) ä¸º null çš„æ—¶å€™, éœ€è¦å¤„ç† rep-level çš„.</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// é‡åˆ°äº†ä¸­é—´çš„ä¼šæ‰¾åˆ° rep-level</span></span><br><span class="line">  <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">HandleListNode</span><span class="params">(T&amp; arg)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (arg.<span class="built_in">rep_level</span>() == max_rep_level) &#123;</span><br><span class="line">      arg.<span class="built_in">SetLast</span>();</span><br><span class="line">      <span class="comment">// after the last list node we don&#x27;t need to fill</span></span><br><span class="line">      <span class="comment">// rep levels on null.</span></span><br><span class="line">      rep_level_if_null = kLevelNotSet;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      rep_level_if_null = arg.<span class="built_in">rep_level</span>();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">operator</span><span class="params">()</span><span class="params">(ListNode&amp; node)</span> </span>&#123; <span class="built_in">HandleListNode</span>(node); &#125;</span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">operator</span><span class="params">()</span><span class="params">(LargeListNode&amp; node)</span> </span>&#123; <span class="built_in">HandleListNode</span>(node); &#125;</span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">operator</span><span class="params">()</span><span class="params">(FixedSizeListNode&amp; node)</span> </span>&#123; <span class="built_in">HandleListNode</span>(node); &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// For non-list intermediate nodes.</span></span><br><span class="line">  <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">HandleIntermediateNode</span><span class="params">(T&amp; arg)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (rep_level_if_null != kLevelNotSet) &#123;</span><br><span class="line">      <span class="comment">// åªæœ‰ AllNullsTerminalNode å’Œ NullableTerminalNode å¯èƒ½æœ‰è¿™ä¸ª</span></span><br><span class="line">      arg.<span class="built_in">SetRepLevelIfNull</span>(rep_level_if_null); <span class="comment">// å¦‚æœè¿™å±‚æ˜¯ç©ºçš„æ—¶å€™ï¼Œrep-level æ˜¯ä»€ä¹ˆï¼Œå°±æ˜¯æ‰¾åˆ°ä¸€ä¸ªçˆ¶çº§çš„ rep-level</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">operator</span><span class="params">()</span><span class="params">(NullableNode&amp; arg)</span> </span>&#123; <span class="built_in">HandleIntermediateNode</span>(arg); &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">operator</span><span class="params">()</span><span class="params">(AllNullsTerminalNode&amp; arg)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Even though no processing happens past this point we</span></span><br><span class="line">    <span class="comment">// still need to adjust it if a list occurred after an</span></span><br><span class="line">    <span class="comment">// all null array.</span></span><br><span class="line">    <span class="built_in">HandleIntermediateNode</span>(arg);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">operator</span><span class="params">()</span><span class="params">(NullableTerminalNode&amp;)</span> </span>&#123;&#125;</span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">operator</span><span class="params">()</span><span class="params">(AllPresentTerminalNode&amp;)</span> </span>&#123;&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ª <code>visitor</code> ä¼šæŠŠ <code>rep-level-if-null</code> ç»™å¸¦ä¸‹å»ã€‚</p><h3 id="Write-é˜¶æ®µ"><a href="#Write-é˜¶æ®µ" class="headerlink" title="Write é˜¶æ®µ"></a>Write é˜¶æ®µ</h3><p>Write é˜¶æ®µæ ¸å¿ƒå‡½æ•°åœ¨ WritePath ä¸Šï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">::<span class="function">arrow::Status <span class="title">Write</span><span class="params">(<span class="type">int</span> leaf_index, ArrowWriteContext* context,</span></span></span><br><span class="line"><span class="params"><span class="function">                      CallbackFunction write_leaf_callback)</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">  <span class="built_in">DCHECK_GE</span>(leaf_index, <span class="number">0</span>);</span><br><span class="line">  <span class="built_in">DCHECK_LT</span>(leaf_index, <span class="built_in">GetLeafCount</span>());</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">WritePath</span>(root_range_, &amp;path_builder_-&gt;<span class="built_in">paths</span>()[leaf_index], context,</span><br><span class="line">                   std::<span class="built_in">move</span>(write_leaf_callback));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>WritePath</code> æ¯”è¾ƒå¤æ‚ï¼Œæˆ‘ä»¬çœ‹ä¹‹å‰å…ˆä»‹ç»ä¸€ä¸‹ç®—æ³•ï¼š</p><h4 id="WritePath-çš„ç®—æ³•"><a href="#WritePath-çš„ç®—æ³•" class="headerlink" title="WritePath çš„ç®—æ³•"></a>WritePath çš„ç®—æ³•</h4><p>ç°åœ¨æˆ‘ä»¬æœ‰äº†ä¸€ç»„ node æ ˆï¼Œç„¶åæˆ‘ä»¬å‡è®¾ä¸€ä¸ªåœºæ™¯ï¼š<code>List&lt;List&lt;int&gt;&gt;</code> å’Œ <code>[[1, 2, null], null, [], [null, 1, 2]]</code>ã€‚è¿™ä¸ªæœ¬èº«ä¸éš¾ï¼Œä½†æ˜¯è¿™ä¸ª def å’Œ rep éƒ½æ˜¯ä¼šå˜åŠ¨çš„. è¿™ä¸ªåœ¨ arrow ä¸­å¤§æ¦‚ä¼šè¢«å®ç°æˆ:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ListArray: [[]], valid bitmap, offsets</span><br><span class="line">  ListArray: [], valid bitmap, offsets</span><br><span class="line">     IntArray: buffer, valid bitmap, offsets</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä¼šæ„é€ ä¸€ä¸ª range æ ˆï¼Œå¤§æ¦‚æ˜¯è¿™æ ·çš„ï¼š</p><ol><li>æ‹¿åˆ°æ ¹ç»“ç‚¹</li><li>Nullable -&gt; List -&gt; Nullable -&gt; List -&gt; Int ï¼Œå†™å…¥ 1ï¼Œ2ï¼Œnull å’Œå¯¹åº”çš„ rep-level , def-level</li><li>å›æº¯åˆ°ä¸Šå±‚ï¼Œå‘ç°æˆå‘˜æ˜¯ nullï¼Œå†™å…¥ä¸€ä¸ªå¯¹åº”çš„ rep-level , def-level</li><li>å‘ç°æ ˆæœ‰å…ƒç´ ï¼Œåˆ°ä¸‹å±‚ç»§ç»­å†™å…¥</li></ol><h4 id="å…·ä½“å®ç°"><a href="#å…·ä½“å®ç°" class="headerlink" title="å…·ä½“å®ç°"></a>å…·ä½“å®ç°</h4><p>è¿™é‡Œéœ€è¦ä»‹ç» <code>Iterator</code> ç±»å‹ï¼Œæ¯ä¸€å±‚ä¼šæœ‰ä¸€ä¸ª <code>Run</code>ï¼Œæ‹¿åˆ°å¯¹åº”çš„èŒƒå›´ã€‚æœ‰å¯èƒ½ï¼š</p><ol><li><code>kDone</code> åšå®Œäº†ï¼Œåº”è¯¥å‘ä¸Šå±‚èµ°</li><li><code>kNext</code> åº”è¯¥èµ°è¿›ä¸‹ä¸€å±‚</li></ol><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// \brief Simple result of a iterating over a column to determine values.</span></span><br><span class="line"><span class="keyword">enum</span> <span class="title class_">IterationResult</span> &#123;</span><br><span class="line">  <span class="comment">/// Processing is done at this node. Move back up the path</span></span><br><span class="line">  <span class="comment">/// to continue processing.</span></span><br><span class="line">  kDone = <span class="number">-1</span>,</span><br><span class="line">  <span class="comment">/// Move down towards the leaf for processing.</span></span><br><span class="line">  kNext = <span class="number">1</span>,</span><br><span class="line">  <span class="comment">/// An error occurred while processing.</span></span><br><span class="line">  kError = <span class="number">2</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬ä»¥ nullable ä¸ºä¾‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">IterationResult <span class="title">Run</span><span class="params">(ElementRange* range, ElementRange* child_range,</span></span></span><br><span class="line"><span class="params"><span class="function">                    PathWriteContext* context)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (new_range_) &#123;</span><br><span class="line">    <span class="comment">// Reset the reader each time we are starting fresh on a range.</span></span><br><span class="line">    <span class="comment">// We can&#x27;t rely on continuity because nulls above can</span></span><br><span class="line">    <span class="comment">// cause discontinuities.</span></span><br><span class="line">    valid_bits_reader_ = <span class="built_in">MakeReader</span>(*range);</span><br><span class="line">  &#125;</span><br><span class="line">  child_range-&gt;start = range-&gt;start;</span><br><span class="line">  ::arrow::internal::BitRun run = valid_bits_reader_.<span class="built_in">NextRun</span>();</span><br><span class="line">  <span class="keyword">if</span> (!run.set) &#123;</span><br><span class="line">    range-&gt;start += run.length;</span><br><span class="line">    <span class="built_in">RETURN_IF_ERROR</span>(<span class="built_in">FillRepLevels</span>(run.length, rep_level_if_null_, context));</span><br><span class="line">    <span class="built_in">RETURN_IF_ERROR</span>(context-&gt;<span class="built_in">AppendDefLevels</span>(run.length, def_level_if_null_));</span><br><span class="line">    run = valid_bits_reader_.<span class="built_in">NextRun</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (range-&gt;<span class="built_in">Empty</span>()) &#123;</span><br><span class="line">    new_range_ = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">return</span> kDone;</span><br><span class="line">  &#125;</span><br><span class="line">  child_range-&gt;end = child_range-&gt;start = range-&gt;start;</span><br><span class="line">  child_range-&gt;end += run.length;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">DCHECK</span>(!child_range-&gt;<span class="built_in">Empty</span>());</span><br><span class="line">  range-&gt;start += child_range-&gt;<span class="built_in">Size</span>();</span><br><span class="line">  new_range_ = <span class="literal">false</span>;</span><br><span class="line">  <span class="keyword">return</span> kNext;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä¼šæŒ‰æƒ…å†µæ·»åŠ  levelï¼Œç„¶åè¿”å›ä¸Šä¸€å±‚æˆ–è€…æš—ç¤ºåé¢è¿˜æœ‰ï¼Œèµ°å‘ä¸‹ä¸€å±‚ï¼Œè¿™äº› node éƒ½æ˜¯ <strong>æœ‰çŠ¶æ€çš„</strong>ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// Contains logic for writing a single leaf node to parquet.</span></span><br><span class="line"><span class="comment">/// This tracks the path from root to leaf.</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// |writer| will be called after all of the definition/repetition</span></span><br><span class="line"><span class="comment">/// values have been calculated for root_range with the calculated</span></span><br><span class="line"><span class="comment">/// values. It is intended to abstract the complexity of writing</span></span><br><span class="line"><span class="comment">/// the levels and values to parquet.</span></span><br><span class="line"><span class="function">Status <span class="title">WritePath</span><span class="params">(ElementRange root_range, PathInfo* path_info,</span></span></span><br><span class="line"><span class="params"><span class="function">                 ArrowWriteContext* arrow_context,</span></span></span><br><span class="line"><span class="params"><span class="function">                 MultipathLevelBuilder::CallbackFunction writer)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// æ ˆè¡¨ç¤ºä¸º range æ ˆ</span></span><br><span class="line">  <span class="function">std::vector&lt;ElementRange&gt; <span class="title">stack</span><span class="params">(path_info-&gt;path.size())</span></span>;</span><br><span class="line">  MultipathLevelBuilderResult builder_result;</span><br><span class="line">  builder_result.leaf_array = path_info-&gt;primitive_array;</span><br><span class="line">  builder_result.leaf_is_nullable = path_info-&gt;leaf_is_nullable;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ä¸éœ€è¦å¤„ç†é€’å½’ã€ç‰¹æ®Šåœºæ™¯ï¼Œå—¯å†™å°±æ˜¯äº†</span></span><br><span class="line">  <span class="keyword">if</span> (path_info-&gt;max_def_level == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">// This case only occurs when there are no nullable or repeated</span></span><br><span class="line">    <span class="comment">// columns in the path from the root to leaf.</span></span><br><span class="line">    <span class="type">int64_t</span> leaf_length = builder_result.leaf_array-&gt;<span class="built_in">length</span>();</span><br><span class="line">    builder_result.def_rep_level_count = leaf_length;</span><br><span class="line">    builder_result.post_list_visited_elements.<span class="built_in">push_back</span>(&#123;<span class="number">0</span>, leaf_length&#125;);</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">writer</span>(builder_result);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// root_range ä¸ºè¡Œçš„ offset, æ˜¯æœ€å¤–å±‚çš„ range</span></span><br><span class="line">  stack[<span class="number">0</span>] = root_range;</span><br><span class="line">  <span class="built_in">RETURN_NOT_OK</span>(</span><br><span class="line">      arrow_context-&gt;def_levels_buffer-&gt;<span class="built_in">Resize</span>(<span class="comment">/*new_size=*/</span><span class="number">0</span>, <span class="comment">/*shrink_to_fit*/</span> <span class="literal">false</span>));</span><br><span class="line">  <span class="function">PathWriteContext <span class="title">context</span><span class="params">(arrow_context-&gt;memory_pool, arrow_context-&gt;def_levels_buffer)</span></span>;</span><br><span class="line">  <span class="comment">// We should need at least this many entries so reserve the space ahead of time.</span></span><br><span class="line">  <span class="built_in">RETURN_NOT_OK</span>(context.def_levels.<span class="built_in">Reserve</span>(root_range.<span class="built_in">Size</span>()));</span><br><span class="line">  <span class="keyword">if</span> (path_info-&gt;max_rep_level &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">RETURN_NOT_OK</span>(context.rep_levels.<span class="built_in">Reserve</span>(root_range.<span class="built_in">Size</span>()));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">auto</span> stack_base = &amp;stack[<span class="number">0</span>];</span><br><span class="line">  <span class="keyword">auto</span> stack_position = stack_base;</span><br><span class="line">  <span class="comment">// This is the main loop for calculated rep/def levels. The nodes</span></span><br><span class="line">  <span class="comment">// in the path implement a chain-of-responsibility like pattern</span></span><br><span class="line">  <span class="comment">// where each node can add some number of repetition/definition</span></span><br><span class="line">  <span class="comment">// levels to PathWriteContext and also delegate to the next node</span></span><br><span class="line">  <span class="comment">// in the path to add values. The values are added through each Run(...)</span></span><br><span class="line">  <span class="comment">// call and the choice to delegate to the next node (or return to the</span></span><br><span class="line">  <span class="comment">// previous node) is communicated by the return value of Run(...).</span></span><br><span class="line">  <span class="comment">// The loop terminates after the first node indicates all values in</span></span><br><span class="line">  <span class="comment">// |root_range| are processed.</span></span><br><span class="line">  <span class="keyword">while</span> (stack_position &gt;= stack_base) &#123;</span><br><span class="line">    PathInfo::Node&amp; node = path_info-&gt;path[stack_position - stack_base];</span><br><span class="line">    <span class="keyword">struct</span> &#123;</span><br><span class="line">      <span class="function">IterationResult <span class="title">operator</span><span class="params">()</span><span class="params">(NullableNode&amp; node)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> node.<span class="built_in">Run</span>(stack_position, stack_position + <span class="number">1</span>, context);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="function">IterationResult <span class="title">operator</span><span class="params">()</span><span class="params">(ListNode&amp; node)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> node.<span class="built_in">Run</span>(stack_position, stack_position + <span class="number">1</span>, context);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="function">IterationResult <span class="title">operator</span><span class="params">()</span><span class="params">(NullableTerminalNode&amp; node)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> node.<span class="built_in">Run</span>(*stack_position, context);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="function">IterationResult <span class="title">operator</span><span class="params">()</span><span class="params">(FixedSizeListNode&amp; node)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> node.<span class="built_in">Run</span>(stack_position, stack_position + <span class="number">1</span>, context);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="function">IterationResult <span class="title">operator</span><span class="params">()</span><span class="params">(AllPresentTerminalNode&amp; node)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> node.<span class="built_in">Run</span>(*stack_position, context);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="function">IterationResult <span class="title">operator</span><span class="params">()</span><span class="params">(AllNullsTerminalNode&amp; node)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> node.<span class="built_in">Run</span>(*stack_position, context);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="function">IterationResult <span class="title">operator</span><span class="params">()</span><span class="params">(LargeListNode&amp; node)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> node.<span class="built_in">Run</span>(stack_position, stack_position + <span class="number">1</span>, context);</span><br><span class="line">      &#125;</span><br><span class="line">      ElementRange* stack_position;</span><br><span class="line">      PathWriteContext* context;</span><br><span class="line">    &#125; visitor = &#123;stack_position, &amp;context&#125;;</span><br><span class="line"></span><br><span class="line">    IterationResult result = std::<span class="built_in">visit</span>(visitor, node);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">ARROW_PREDICT_FALSE</span>(result == kError)) &#123;</span><br><span class="line">      <span class="built_in">DCHECK</span>(!context.last_status.<span class="built_in">ok</span>());</span><br><span class="line">      <span class="keyword">return</span> context.last_status;</span><br><span class="line">    &#125;</span><br><span class="line">    stack_position += <span class="built_in">static_cast</span>&lt;<span class="type">int</span>&gt;(result);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">RETURN_NOT_OK</span>(context.last_status);</span><br><span class="line">  builder_result.def_rep_level_count = context.def_levels.<span class="built_in">length</span>();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (context.rep_levels.<span class="built_in">length</span>() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">// This case only occurs when there was a repeated element that needs to be</span></span><br><span class="line">    <span class="comment">// processed.</span></span><br><span class="line">    builder_result.rep_levels = context.rep_levels.<span class="built_in">data</span>();</span><br><span class="line">    std::<span class="built_in">swap</span>(builder_result.post_list_visited_elements, context.visited_elements);</span><br><span class="line">    <span class="comment">// If it is possible when processing lists that all lists where empty. In this</span></span><br><span class="line">    <span class="comment">// case no elements would have been added to post_list_visited_elements. By</span></span><br><span class="line">    <span class="comment">// added an empty element we avoid special casing in downstream consumers.</span></span><br><span class="line">    <span class="keyword">if</span> (builder_result.post_list_visited_elements.<span class="built_in">empty</span>()) &#123;</span><br><span class="line">      builder_result.post_list_visited_elements.<span class="built_in">push_back</span>(&#123;<span class="number">0</span>, <span class="number">0</span>&#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    builder_result.post_list_visited_elements.<span class="built_in">push_back</span>(</span><br><span class="line">        &#123;<span class="number">0</span>, builder_result.leaf_array-&gt;<span class="built_in">length</span>()&#125;);</span><br><span class="line">    builder_result.rep_levels = <span class="literal">nullptr</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  builder_result.def_levels = context.def_levels.<span class="built_in">data</span>();</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">writer</span>(builder_result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Samples-for-write"><a href="#Samples-for-write" class="headerlink" title="Samples for write"></a>Samples for write</h2><p>æ€»è§‰å¾—æˆ‘å†™çš„è¿˜æ˜¯æ¯”è¾ƒæŠ½è±¡çš„ï¼Œæ‰€ä»¥è¿™é‡Œå°è¯•ä¸¾å‡ ä¸ªä¾‹å­ï¼Œæ¥ç®€å•ä»‹ç»ä¸€ä¸‹ï¼Œå› ä¸ºä¹‹å‰å†™å…¥çš„è¿‡äºæŠ½è±¡äº†ã€‚</p><p>æˆ‘ä»¬å›é¡¾ä¸€ä¸‹ï¼š</p><ol><li><code>PathBuilder</code> ä¼šæ ¹æ®ç”¨æˆ·çš„ Schema æ¥æ„å»º nodeï¼Œè¿™äº› node æœ‰ä¸åŒçš„ max-rep-level å’Œ max-def-levelï¼Œä¹Ÿæœ‰ç©ºç¼ºçš„æ—¶å€™åº”è¯¥å†™å…¥çš„ def-levelã€‚è¿™é‡Œä¼šæ„æˆä¸€ä¸ªæ ˆ</li><li>ä¼ é€’æ•°æ®ä¸‹æ¥çš„æ—¶å€™ï¼Œè¿ç»­çš„æ•°æ®ä¼šæ‰¾åˆ°å¯¹åº”çš„æ ˆï¼Œå†™å¯¹åº”çš„ def-level å’Œ rep-level</li></ol><p>æˆ‘ä»¬ä¸‹é¢åˆ—ä¸¾çš„ä¾‹å­éƒ½æ˜¯å†™å…¥ 1024 è¡Œæ•°æ®çš„ï¼Œæˆ‘ä»¬ä¼šä»ç®€å•åˆ°éš¾æ¥ä»‹ç»å†™å…¥ case çš„ä¾‹å­</p><h3 id="Case-1-i32"><a href="#Case-1-i32" class="headerlink" title="Case 1: i32"></a>Case 1: i32</h3><p>æˆ‘ä»¬å‡è®¾æœ‰è¿ç»­çš„ i32, å®ƒä¸æ˜¯ nullable çš„ï¼Œè¿™ä¸ªæ—¶å€™ï¼Œarrow å¯¹åº”çš„ç»“æ„æ˜¯ Fixed çš„ int32 æ•°ç»„ï¼Œæ²¡æœ‰ä»»ä½• valid bitmapã€‚</p><p>è¿™ä¸ªæ—¶å€™ï¼Œ<code>PathBuilder</code>åœ¨æ„å»ºé˜¶æ®µ ä¼šæ„å»ºä¸€ä¸ªä¸‹é¢çš„èŠ‚ç‚¹ï¼š</p><p><img src="https://image.mwish.me/blog-image/parquet-c1.jpg" alt="æµç¨‹å›¾ (1)"></p><p>åœ¨æ„å»ºé˜¶æ®µï¼Œç¨‹åºä¼šæ‰¾åˆ°è¿™ä¸ª nodeï¼Œç„¶åè®¾ç½®è¿­ä»£çš„ <code>range = [0, 1024)</code>ï¼Œç„¶åéå†è¿™ä¸ªæ ˆâ€¦</p><p>ä¸ï¼Œå…¶å®å®ƒä¸ä¼šéå†è¿™ä¸ªæ ˆï¼è¿˜è®°å¾—ä¹‹å‰å—ï¼Ÿå¦‚æœå­—æ®µæ˜¯ <code>optional</code>ï¼Œé‚£ä¹ˆ max-dep + 1ï¼Œå¦‚æœæ˜¯ <code>repeatable</code>, é‚£ä¹ˆ max-dep + 1, max-rep + 1ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œç¨‹åºå¦‚æœæ£€æŸ¥åˆ° <code>max-dep == 0</code>ï¼Œé‚£ä¹ˆè¯´æ˜å¯¹è±¡éƒ½æ˜¯ä¸€å¯¹ä¸€ä¸”æ—  null çš„ï¼Œè¿™ä¸ªåœ°æ–¹å°±ç›´æ¥å†™å…¥æ‰€æœ‰å€¼äº†ï¼</p><h3 id="Case-2-optional-i32"><a href="#Case-2-optional-i32" class="headerlink" title="Case 2: optional i32"></a>Case 2: optional i32</h3><p>æˆ‘ä»¬å‡è®¾æœ‰è¿ç»­çš„ optional i32ï¼Œè¿™ä¸ªæ—¶å€™ï¼Œarrow å¯¹åº”çš„ç»“æ„æ˜¯ Fixed çš„ int32 æ•°ç»„ï¼Œæ²¡æœ‰ä»»ä½• valid bitmapã€‚</p><p>è¿™ä¸ªæ—¶å€™ï¼Œ<code>PathBuilder</code>åœ¨æ„å»ºé˜¶æ®µ ä¼šæ„å»ºä¸€ä¸ªä¸‹é¢çš„èŠ‚ç‚¹ï¼š</p><p><img src="https://image.mwish.me/blog-image/parquet-c2.jpg" alt="æµç¨‹å›¾ (2)"></p><p>åœ¨æ„å»ºé˜¶æ®µï¼Œç¨‹åºä¼šæ‰¾åˆ°è¿™ä¸ª nodeï¼Œç„¶åè®¾ç½®è¿­ä»£çš„ <code>range = [0, 1024)</code>ï¼Œç„¶åéå†è¿™ä¸ªæ ˆï¼ŒæŠŠ <code>[0, 1024)</code> ä¼ ç»™ nodeï¼Œè¿™é‡Œè®¿é—® validation bitsetï¼Œå¦‚æœæœ‰å…ƒç´ ï¼Œå°±åœ¨ def-levels é‡Œé¢åŠ å…¥ 1ï¼Œå¦åˆ™åŠ å…¥ 0ã€‚æ ˆåªæœ‰ä¸€å±‚ï¼Œä¸€æ¬¡è§£å†³ 0-1024 æ‰€æœ‰å…ƒç´ ã€‚è¿™é‡Œä¸å­˜åœ¨ä»»ä½• rep-levelã€‚</p><p>ç‰¹æ®Šæƒ…å†µä¸‹ï¼Œå¦‚æœå‘ç°æ•°æ®å…¨æ˜¯ Nullï¼Œä¼šæ„å»ºä¸€ä¸ªç‰¹æ®Šçš„èŠ‚ç‚¹ï¼š</p><p><img src="https://image.mwish.me/blog-image/parquet-c2-1.jpg" alt="parquet-c2-1"></p><p>è¿™é‡Œä¼šå†™å…¥å…¨æ˜¯ 0 çš„ def-levelï¼Œç„¶åä¸å†™å…¥ä»»ä½• rep.</p><h3 id="Case-3-array-lt-i32-4-gt"><a href="#Case-3-array-lt-i32-4-gt" class="headerlink" title="Case 3: array&lt;i32, 4&gt;"></a>Case 3: <code>array&lt;i32, 4&gt;</code></h3><p>æˆ‘ä»¬å‡è®¾ <code>list</code> ä¸æ˜¯ nullable çš„ï¼Œè¿™ä¸ªæ—¶å€™ä¼šæ€ä¹ˆå†™å…¥å‘¢ï¼Ÿæˆ‘ä»¬å‡è®¾å¯ä»¥æœ‰è¿™æ ·çš„æˆå‘˜ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[[0, 1, 2, 3], [4, 5, 6, 7], [8, 9, 10, 11]]</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå¯¹åº” arrow ä¸­çš„ <code>FixedSizeListArray</code>ï¼Œå¯¹åº”å†…å®¹å¦‚ä¸‹ï¼š</p><p><img src="https://image.mwish.me/blog-image/parquet-c3-0.jpg" alt="parquet-c3-0"></p><p>è¿™æ˜¯ä¸€ä¸ªæœ€ç®€åŒ–çš„æ¨¡å‹äº†ï¼Œå®é™…ä¸Šå¯èƒ½ä¼šå¤æ‚å¾ˆå¤šï¼Œæˆ‘ä»¬å…ˆä¸ç®¡ã€‚è¿™é‡Œè¾“å…¥æ˜¯ <code>range = [0, 3)</code>ï¼Œç„¶åæ•°ç»„å¯¹åº”æ˜¯ <code>Int32Array = [0, 1, 2, 3, 4, 5, ... 11]</code></p><ol><li>ç¬¬ä¸€å±‚æ ˆå¯¹åº”èŒƒå›´æ˜¯ <code>[0, 3)</code></li><li>ç¬¬ä¸€å±‚æ ˆæ‰¾åˆ°ç¬¬ä¸€ä¸ª <strong>éç©º</strong> çš„ï¼Œæ˜¯ç¬¬ 0 ä¸ªï¼Œè¿™ä¸ªæ—¶å€™ï¼Œå¦‚æœæ˜¯ç¬¬ä¸€æ¬¡è®¿é—®ï¼ˆå¼€ä¸€ä¸ªæ–°åˆ—è¡¨ï¼‰ï¼Œå¾ˆæ˜¾ç„¶ï¼Œrep-level ä¼šæ¥è‡ªè‡ªå·±çš„çˆ¶çº§ã€‚ç¬¬ä¸€ä¸ªå…ƒç´ å†™å…¥ <code>prev-rep-level</code>ï¼Œå³ 0.<ol><li>å› ä¸ºè¿™ä¸ªèŠ‚ç‚¹æ˜¯ <code>last_list_node</code>ï¼Œæ‰€ä»¥å®ƒä¼šå‘åæ‰¾åˆ°ç¬¬ä¸€ä¸ªé empty çš„ nodeï¼Œä¼šåœ¨ <code>FillForLast</code> å‡½æ•°æ‰¾åˆ°æ‰€æœ‰å¯¹åº”çš„å†…å®¹ï¼ŒæŠŠ rep-level å¡«å……å®Œæ¯•ï¼Œæ¯é‡åˆ°éç©ºçš„å†…å®¹ï¼Œéƒ½ç»™å››ä¸ªå¡«å…… <code>[0, 1, 1, 1]</code> ç­‰ã€‚ä¸ºä»€ä¹ˆæ˜¯ <code>[0, 1, 1, 1]</code> å‘¢ï¼Ÿç¬¬ä¸€ä¸ªå…ƒç´ éœ€è¦å¡«å…… <code>prev-rep-level</code>ï¼Œå…¶æ¬¡è¦å¡«å…… <code>rep-level</code></li></ol></li><li>å®Œæ¯•åï¼Œè¿™é‡Œè¦æŠŠ <code>[0, 3)</code> è½¬åŒ–ä¸ºä¸‹å±‚éœ€è¦çš„èŒƒå›´ï¼Œ<code>FixSizeListNode</code> å¯¹åº”æ¯ä¸ªå­å…ƒç´  size éƒ½æ˜¯ <code>4</code>ï¼Œæ‰€ä»¥è¿™é‡Œä¼šæ‹¿åˆ° <code>[0, 12)</code> ï¼Œä½œä¸ºå¯¹åº”çš„ range</li><li>æ ˆå¼€å§‹å¤„ç† <code>AllPresentTerminalNode</code>ï¼Œä¸¢ç»™ä¸‹é¢çš„èŒƒå›´æ˜¯ <code>[0, 12)</code>ï¼Œè¿™é‡Œéƒ½ä¸æ˜¯ null çš„ï¼Œå°±ä¼šå†™å…¥å…·ä½“çš„å†…å®¹ï¼Œå†™å®Œå…·ä½“ 12 ä¸ªå€¼å’Œå¯¹åº”çš„ def-levelï¼Œå³ 12ä¸ª 1</li></ol><p>æˆ‘ä»¬å›è¿‡å¤´çœ‹ä¸‹ (2)ï¼Œè¿™é‡Œï¼š</p><ol><li>ä¸€æ—¦æ–°å¼€äº†ä¸€ä¸ª listï¼Œä¸€å®šå†™ä¸€ä¸ªè‡ªå·±çš„ rep-level</li><li>å¦‚æœ list æ˜¯æœ€åä¸€ä¸ª list ( æœ€åå¯èƒ½å¸¦æ¥ rep-level çš„åœ°æ–¹)ï¼Œå®ƒä¼šè´Ÿè´£å†™æ‰€æœ‰å„¿å­çš„ rep-level</li></ol><p><strong>è¿˜æœ‰ï¼Œéç©º å’Œ é null æ˜¯ä¸åŒçš„æ¦‚å¿µï¼Œnull ä¼šæœ‰åˆ«çš„åœ°æ–¹æ¥å¤„ç†ï¼Œæˆ‘ä»¬ä¹‹åä¼šä»‹ç»ã€‚</strong></p><h4 id="Case-3-1-array-lt-optional-i32-4-gt"><a href="#Case-3-1-array-lt-optional-i32-4-gt" class="headerlink" title="Case 3-1: array&lt;optional i32, 4&gt;"></a>Case 3-1: <code>array&lt;optional i32, 4&gt;</code></h4><p>æˆ‘ä»¬å‡è®¾å¯ä»¥æœ‰è¿™æ ·çš„æˆå‘˜ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[[0, null, 2, 3], [4, null, 6, 7], [8, null, 10, 11]]</span><br></pre></td></tr></table></figure><p>è¿™ä¸‹æˆ‘ä»¬éœ€è¦æ”¹å˜æˆ‘ä»¬çš„æ ‘äº†ï¼</p><p><img src="https://image.mwish.me/blog-image/parquet-c3-1.jpg" alt="parquet-c3-1"></p><p>è¿™é‡Œ 1-3 æ­¥å’Œä¹‹å‰ä¸€æ ·ï¼Œ4ä¼šæ ¹æ®èŠ‚ç‚¹å†™å‡ºè‡ªå·±å¯¹åº”çš„ def-level æ˜¯ 1 è¿˜æ˜¯ 2. ç±»ä¼¼ case 2 çš„åœºæ™¯</p><h3 id="Case-List-lt-int32-gt"><a href="#Case-List-lt-int32-gt" class="headerlink" title="Case: List&lt;int32&gt;"></a>Case: <code>List&lt;int32&gt;</code></h3><p>æˆ‘ä»¬å‰é¢ä»‹ç»äº† <code>array&lt;T, 4&gt;</code>ï¼Œæˆ‘åœ¨ç”»å›¾çš„æ—¶å€™ï¼ŒæŠŠ node å½“ä½œ Fixed Sized çš„ Listï¼Œé‚£ä¹ˆå®é™…çš„ <code>List</code> æˆ–è€… <code>repeated</code> ä¼šæ˜¯ä»€ä¹ˆæ ·çš„å‘¢ï¼Ÿ</p><p>è¿™é‡Œæˆ‘ä»¬å¯ä»¥çœ‹çœ‹å¯¹åº”çš„ç±»å‹ç³»ç»Ÿï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// List nodes handle populating rep_level for Arrow Lists and def-level for empty lists.</span></span><br><span class="line"><span class="comment">// Nullability (both list and children) is handled by other Nodes. By</span></span><br><span class="line"><span class="comment">// construction all list nodes will be intermediate nodes (they will always be followed by</span></span><br><span class="line"><span class="comment">// at least one other node).</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Type parameters:</span></span><br><span class="line"><span class="comment">//    |RangeSelector| - A strategy for determine the the range of the child node to</span></span><br><span class="line"><span class="comment">//    process.</span></span><br><span class="line"><span class="comment">//       this varies depending on the type of list (int32_t* offsets, int64_t* offsets of</span></span><br><span class="line"><span class="comment">//       fixed.</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> RangeSelector&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ListPathNode</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> ListNode = ListPathNode&lt;VarRangeSelector&lt;<span class="type">int32_t</span>&gt;&gt;;</span><br><span class="line"><span class="keyword">using</span> LargeListNode = ListPathNode&lt;VarRangeSelector&lt;<span class="type">int64_t</span>&gt;&gt;;</span><br><span class="line"><span class="keyword">using</span> FixedSizeListNode = ListPathNode&lt;FixedSizedRangeSelector&gt;;</span><br></pre></td></tr></table></figure><p>è¿™éƒ¨åˆ†å®ç°å®é™…ä¸Šå’Œ Parquet å…³ç³»ä¸å¤§ï¼ŒParquet åªä¼šçŸ¥é“ä½ æ˜¯ repeatedï¼Œè¿™éƒ¨åˆ†æ˜¯ arrow çš„é€»è¾‘ï¼Œå›é¡¾ä¸€ä¸‹ä¸Šé¢çš„å›¾ï¼š</p><ol><li>Fixed Sized ä¼šåœ¨å…ƒä¿¡æ¯é‡Œé¢å­˜æ”¾è‡ªå·±çš„ size</li><li>é fix sized ä¼šæœ‰ä¸ª offset æ•°ç»„ï¼Œç”¨è¿™ä¸ª offset æ•°ç»„æ¥æ¨æ–­è‡ªå·±çš„ size</li></ol><p>é‚£ä¹ˆï¼Œæˆ‘ä»¬å›é¡¾ 3 çš„ caseï¼Œçœ‹çœ‹ List ä¼šæ€ä¹ˆæ ·ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[[0, null, 2], [], [8, null, 10, 11]]</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä¼šæåˆ° <code>[0, null, 2]</code>ï¼Œå†™å…¥ rep-level <code>[0, 1, 1]</code></p><p>é‡åˆ° <code>[]</code> çš„æ—¶å€™ï¼Œå®ƒä¼šè·³è¿‡è¿™ä¸ªï¼Œç„¶å<strong>å†™å…¥ä¸€ä¸ª rep-level å’Œç©ºç¼ºçš„ def-level</strong></p><p><code>[8, null, 10, 11]</code> ä¼šå†™å…¥ <code>rep-level</code> <code>[0, 1, 1, 1]</code></p><h3 id="Case-4-optional-array-lt-optional-i32-4-gt"><a href="#Case-4-optional-array-lt-optional-i32-4-gt" class="headerlink" title="Case 4: optional array&lt;optional i32, 4&gt;"></a>Case 4: <code>optional array&lt;optional i32, 4&gt;</code></h3><p>æˆ‘ä»¬å‡è®¾å¯ä»¥æœ‰è¿™æ ·çš„æˆå‘˜ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[[0, null, 2, 3], null, [8, null, 10, 11]]</span><br></pre></td></tr></table></figure><p>è¿™ä¸‹æˆ‘ä»¬åˆéœ€è¦æ”¹å˜æˆ‘ä»¬çš„æ ‘äº†ï¼</p><p><img src="https://image.mwish.me/blog-image/parquet-c4-0.jpg" alt="parquet-c4-0"></p><p>è¿™é‡Œï¼Œ<code>NullableNode</code> ä¼šè¯»å–å¯¹åº”çš„ validation bitset, ç„¶åè¿”å›ç»™ä¸‹å±‚ï¼š</p><ol><li>æ ¹èŠ‚ç‚¹ range æ˜¯ <code>[0, 3)</code></li><li>ç¬¬ä¸€æ¬¡å‘ç°ä¸æ˜¯ null çš„ï¼Œè¿ç»­çš„è¿”å› <code>[0, 1)</code> èŒƒå›´ç»™ä¸‹å±‚ï¼Œä¸‹å±‚å’Œä¹‹å‰çš„é€»è¾‘ä¸€æ ·å¤„ç†</li><li>ç¬¬äºŒæ¬¡å‘ç° <code>null</code>ï¼Œè¿™é‡Œéœ€è¦å¡«å…… rep-level å’Œ def-levelï¼Œåˆ†åˆ«å¡«å……ä¸¤ä¸ª <code>0</code> ä¸Šå»</li><li>å‘ç°ä¸º <code>null</code>ï¼Œå†æ¬¡ä»¤å…¶å¡«å……</li></ol>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>future and promise in libc++/folly</title>
      <link href="/2022/09/18/futures-promise-executors-continuation/"/>
      <url>/2022/09/18/futures-promise-executors-continuation/</url>
      
        <content type="html"><![CDATA[<p>future è¡¨ç¤ºä¸€ä¸ªèƒ½æ‹¿åˆ°æŸä¸ªå€¼çš„é¢„æœŸ</p><h2 id="libc-future"><a href="#libc-future" class="headerlink" title="libc++ future"></a>libc++ future</h2><p>é€»è¾‘å†…å®¹ï¼š</p><p><img src="https://image.mwish.me/blog-image/libcpp-future.jpg" alt="libcpp-future"></p><p>å®ç°éƒ¨åˆ†åœ¨ <code>include/c++/v1/future</code> å’Œ</p><p>future ç±»å‹å¦‚ä¸‹:</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">_Rp</span>&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">_LIBCPP_TEMPLATE_VIS</span> _LIBCPP_AVAILABILITY_FUTURE future</span><br><span class="line">&#123;</span><br><span class="line">    __assoc_state&lt;_Rp&gt;* __state_;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">explicit</span> <span class="title">future</span><span class="params">(__assoc_state&lt;_Rp&gt;* __state)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">class</span>&gt; <span class="keyword">friend</span> <span class="keyword">class</span> <span class="title class_">promise</span>;</span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">class</span>&gt; <span class="keyword">friend</span> <span class="keyword">class</span> <span class="title class_">shared_future</span>;</span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// ... </span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œfuture åŒ…è£…äº†ä¸€å±‚ <code>__assoc_state&lt;_rp&gt;</code>, æˆ‘ä»¬è¿› <code>__assoc_state</code> çœ‹çœ‹:</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">_Rp</span>&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">_LIBCPP_AVAILABILITY_FUTURE</span> _LIBCPP_HIDDEN __assoc_state</span><br><span class="line">    : <span class="keyword">public</span> __assoc_sub_state</span><br><span class="line">&#123;<span class="comment">//...</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å“¦ï¼Œä»–æ˜¯ <code>__assoc_sub_state&lt;_Rp&gt;</code> çš„å­ç±»ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">_LIBCPP_TYPE_VIS</span> _LIBCPP_AVAILABILITY_FUTURE __assoc_sub_state</span><br><span class="line">    : <span class="keyword">public</span> __shared_count</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œé¢åŒ…äº†ä¸€å±‚ <code>__shared_count</code>ï¼Œè¿˜è®°å¾—ä¹‹å‰çš„å›¾å—ï¼Ÿè¿™ä¸ªå†…éƒ¨å°±æ˜¯ä¸€ä¸ªå¼•ç”¨è®¡æ•°ï¼Œå®é™…ä¸Š <code>std::shared_ptr</code> ä¹Ÿæ¬ç”¨äº†è¿™å¥—å®ç°ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">_LIBCPP_TYPE_VIS</span> __shared_count</span><br><span class="line">&#123;</span><br><span class="line">    __shared_count(<span class="type">const</span> __shared_count&amp;);</span><br><span class="line">    __shared_count&amp; <span class="keyword">operator</span>=(<span class="type">const</span> __shared_count&amp;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    <span class="type">long</span> __shared_owners_;</span><br><span class="line">    <span class="keyword">virtual</span> ~__shared_count();</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="keyword">virtual</span> <span class="type">void</span> __on_zero_shared() _NOEXCEPT = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">_LIBCPP_INLINE_VISIBILITY</span><br><span class="line">    <span class="type">void</span> __add_shared() _NOEXCEPT;</span><br><span class="line">    _LIBCPP_INLINE_VISIBILITY</span><br><span class="line">    <span class="type">bool</span> __release_shared() _NOEXCEPT;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    <span class="function">_LIBCPP_INLINE_VISIBILITY</span></span><br><span class="line"><span class="function">    <span class="type">long</span> <span class="title">use_count</span><span class="params">()</span> <span class="type">const</span> _NOEXCEPT</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œéœ€è¦è§£é‡Šä¸€ä¸‹ <code>__on_zero_shared</code>ï¼Œè¿™é‡Œå¯ä»¥çœ‹ä½œæ˜¯ç”¨æˆ·è°ƒç”¨çš„ rc == 0 çš„æ—¶å€™æ¸…é™¤èµ„æºçš„å‡½æ•°ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">_LIBCPP_TYPE_VIS</span> _LIBCPP_AVAILABILITY_FUTURE __assoc_sub_state</span><br><span class="line">    : <span class="keyword">public</span> __shared_count</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    exception_ptr __exception_;</span><br><span class="line">    <span class="keyword">mutable</span> mutex __mut_;</span><br><span class="line">    <span class="keyword">mutable</span> condition_variable __cv_;</span><br><span class="line">    <span class="type">unsigned</span> __state_;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">virtual</span> <span class="type">void</span> __on_zero_shared() _NOEXCEPT;</span><br><span class="line">    <span class="type">void</span> __sub_wait(unique_lock&lt;mutex&gt;&amp; __lk);</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">enum</span></span><br><span class="line">    &#123;</span><br><span class="line">        __constructed = <span class="number">1</span>,</span><br><span class="line">        __future_attached = <span class="number">2</span>,</span><br><span class="line">        ready = <span class="number">4</span>,</span><br><span class="line">        deferred = <span class="number">8</span></span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå†…å®¹å¤§æ¦‚æ˜¯ï¼š</p><ol><li><code>__state</code> æ ‡æ³¨äº†å¯¹åº”çš„çŠ¶æ€</li><li><code>__cv_</code> å’Œ <code>__mut_</code> è¡¨ç¤ºäº†å¯¹åº”çš„å¹¶å‘çŠ¶æ€</li><li><code>__exception_</code> è¡¨ç¤ºå­˜åœ¨è¿™é‡Œçš„å¼‚å¸¸</li></ol><p>è¿™é‡Œä¹Ÿæœ‰è®¾ç½®çŠ¶æ€å¯¹åº”çš„æˆå‘˜ï¼ŒåŒ…æ‹¬ <code>__set_value</code> ç­‰ï¼ŒåŸºæœ¬ä¸Šæ˜¯å¤„ç†å¹¶å‘å’Œè®¾ç½®çŠ¶æ€</p><p>å›å¤´çœ‹å¤–é¢ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">_Rp</span>&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">_LIBCPP_AVAILABILITY_FUTURE</span> _LIBCPP_HIDDEN __assoc_state</span><br><span class="line">    : <span class="keyword">public</span> __assoc_sub_state</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">typedef</span> __assoc_sub_state base;</span><br><span class="line">    <span class="keyword">typedef</span> <span class="keyword">typename</span> aligned_storage&lt;<span class="built_in">sizeof</span>(_Rp), alignment_of&lt;_Rp&gt;::value&gt;::type _Up;</span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    _Up __value_;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">virtual</span> <span class="type">void</span> __on_zero_shared() _NOEXCEPT;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"></span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">_Arg</span>&gt;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">set_value</span><span class="params">(_Arg&amp;&amp; __arg)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">_Arg</span>&gt;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">set_value_at_thread_exit</span><span class="params">(_Arg&amp;&amp; __arg)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">_Rp <span class="title">move</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="keyword">typename</span> add_lvalue_reference&lt;_Rp&gt;::<span class="function">type <span class="title">copy</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå¯ä»¥å‘ç° <code>_Up</code> å­˜å‚¨çš„æ˜¯å¯¹åº”çš„å€¼ï¼Œè€Œ <code>__assoc_sub_state</code> å­˜å‚¨çš„æ˜¯çŠ¶æ€ã€‚ä¹‹æ‰€ä»¥æ˜¯ <code>aligned_storage</code>ï¼Œæ˜¯å› ä¸ºè¿™æ˜¯ä¸€å—å¯èƒ½æ²¡åˆå§‹åŒ–çš„å†…å­˜ã€‚æˆ‘ä»¬ç»§ç»­çœ‹çœ‹ <code>wait</code> ä¹‹ç±»çš„ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">_Rp</span>&gt;</span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">_Arg</span>&gt;</span><br><span class="line">_LIBCPP_AVAILABILITY_FUTURE</span><br><span class="line"><span class="type">void</span></span><br><span class="line">__assoc_state&lt;_Rp&gt;::<span class="built_in">set_value</span>(_Arg&amp;&amp; __arg)</span><br><span class="line">&#123;</span><br><span class="line">    unique_lock&lt;mutex&gt; __lk(<span class="keyword">this</span>-&gt;__mut_);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>-&gt;__has_value())</span><br><span class="line">        __throw_future_error(future_errc::promise_already_satisfied);</span><br><span class="line">    ::<span class="keyword">new</span> ((<span class="type">void</span>*)&amp;__value_) _Rp(_VSTD::forward&lt;_Arg&gt;(__arg));</span><br><span class="line">    <span class="keyword">this</span>-&gt;__state_ |= base::__constructed | base::ready;</span><br><span class="line">    __cv_.<span class="built_in">notify_all</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">_Rp</span>&gt;</span><br><span class="line">_Rp</span><br><span class="line">__assoc_state&lt;_Rp&gt;::<span class="built_in">move</span>()</span><br><span class="line">&#123;</span><br><span class="line">    unique_lock&lt;mutex&gt; __lk(<span class="keyword">this</span>-&gt;__mut_);</span><br><span class="line">    <span class="keyword">this</span>-&gt;__sub_wait(__lk);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>-&gt;__exception_ != <span class="literal">nullptr</span>)</span><br><span class="line">        <span class="built_in">rethrow_exception</span>(<span class="keyword">this</span>-&gt;__exception_);</span><br><span class="line">    <span class="keyword">return</span> _VSTD::<span class="built_in">move</span>(*<span class="built_in">reinterpret_cast</span>&lt;_Rp*&gt;(&amp;__value_));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">_Rp</span>&gt;</span><br><span class="line"><span class="keyword">typename</span> add_lvalue_reference&lt;_Rp&gt;::type</span><br><span class="line">__assoc_state&lt;_Rp&gt;::<span class="built_in">copy</span>()</span><br><span class="line">&#123;</span><br><span class="line">    unique_lock&lt;mutex&gt; __lk(<span class="keyword">this</span>-&gt;__mut_);</span><br><span class="line">    <span class="keyword">this</span>-&gt;__sub_wait(__lk);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>-&gt;__exception_ != <span class="literal">nullptr</span>)</span><br><span class="line">        <span class="built_in">rethrow_exception</span>(<span class="keyword">this</span>-&gt;__exception_);</span><br><span class="line">    <span class="keyword">return</span> *<span class="built_in">reinterpret_cast</span>&lt;_Rp*&gt;(&amp;__value_);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆï¼Œ<code>__assoc_sub_state</code> ä¼šè°ƒç”¨ <code>__sub_wait</code>ï¼Œè¿™é‡Œä¼šç­‰å¾…åˆ° <code>__assoc_sub_state</code> çŠ¶æ€åˆç†ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line">__assoc_sub_state::__sub_wait(unique_lock&lt;mutex&gt;&amp; __lk)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (!__is_ready())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (__state_ &amp; <span class="built_in">static_cast</span>&lt;<span class="type">unsigned</span>&gt;(deferred))</span><br><span class="line">        &#123;</span><br><span class="line">            __state_ &amp;= ~<span class="built_in">static_cast</span>&lt;<span class="type">unsigned</span>&gt;(deferred);</span><br><span class="line">            __lk.<span class="built_in">unlock</span>();</span><br><span class="line">            __execute();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="keyword">while</span> (!__is_ready())</span><br><span class="line">                __cv_.<span class="built_in">wait</span>(__lk);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œç›¸å½“äºï¼š</p><ol><li>è®¾ç½®å€¼ï¼šæ‹¿åˆ° <code>_sub_state</code> çš„é”ï¼Œç„¶å placement newï¼Œå†åœ¨ <code>_sub_state</code> ä¸Šé€šçŸ¥</li><li>è¯»å–å€¼(wait) ï¼šç­‰å¾… <code>_sub_state</code> çŠ¶æ€è®¾ç½®å®Œæˆï¼Œç„¶åæ‹¿ <code>__value_</code></li></ol><p>æœ€åï¼Œæˆ‘ä»¬çœ‹çœ‹å¤–å±‚çš„ <code>future</code>:</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">_Rp</span>&gt;</span><br><span class="line">_Rp</span><br><span class="line">future&lt;_Rp&gt;::<span class="built_in">get</span>()</span><br><span class="line">&#123;</span><br><span class="line">    unique_ptr&lt;__shared_count, __release_shared_count&gt; __(__state_);</span><br><span class="line">    __assoc_state&lt;_Rp&gt;* __s = __state_;</span><br><span class="line">    __state_ = <span class="literal">nullptr</span>;</span><br><span class="line">    <span class="keyword">return</span> __s-&gt;<span class="built_in">move</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="promise"><a href="#promise" class="headerlink" title="promise"></a>promise</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// promise&lt;void&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">_LIBCPP_TYPE_VIS</span> _LIBCPP_AVAILABILITY_FUTURE promise&lt;<span class="type">void</span>&gt;</span><br><span class="line">&#123;</span><br><span class="line">    __assoc_sub_state* __state_;</span><br><span class="line"></span><br><span class="line">    <span class="function">_LIBCPP_INLINE_VISIBILITY</span></span><br><span class="line"><span class="function">    <span class="keyword">explicit</span> <span class="title">promise</span><span class="params">(<span class="type">nullptr_t</span>)</span> _NOEXCEPT : __state_(nullptr) &#123;</span>&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">class</span>&gt; <span class="keyword">friend</span> <span class="keyword">class</span> <span class="title class_">packaged_task</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œï¼Œ<code>get_future</code> ä¼šç›´æ¥è¿”å›ä¸€ä¸ª future:</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">_Rp</span>&gt;</span><br><span class="line">future&lt;_Rp&gt;</span><br><span class="line">promise&lt;_Rp&gt;::<span class="built_in">get_future</span>()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (__state_ == <span class="literal">nullptr</span>)</span><br><span class="line">        __throw_future_error(future_errc::no_state);</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">future</span>&lt;_Rp&gt;(__state_);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å›åˆ° future, çœ‹çœ‹å®ƒçš„æ„é€ å‡½æ•°ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">_Rp</span>&gt;</span><br><span class="line">future&lt;_Rp&gt;::<span class="built_in">future</span>(__assoc_state&lt;_Rp&gt;* __state)</span><br><span class="line">    : __state_(__state)</span><br><span class="line">&#123;</span><br><span class="line">    __state_-&gt;__attach_future();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä¾é  <code>__assoc_sub_state&lt;_Rp&gt;::__attach_future</code> æ¥é¿å…é‡å¤ä½¿ç”¨</p><h3 id="packaged-task"><a href="#packaged-task" class="headerlink" title="packaged_task"></a>packaged_task</h3><p><code>std::packaged_task</code> ç±»ä¼¼ <code>std::function</code>ï¼Œæ˜¯ä¸€ä¸ªç±»å‹æ“¦é™¤çš„å‡½æ•°ï¼Œæè¿°ä»»åŠ¡ï¼Œè¿™é‡Œè¿˜å…è®¸ <code>get_future</code> æ¥è®¿é—®ã€‚</p><h3 id="shared-future"><a href="#shared-future" class="headerlink" title="shared_future"></a>shared_future</h3><p><code>shared_future</code> å¯ä»¥åŒ…è£…ä¸€ä¸ª <code>future&lt;T&gt;</code>ï¼Œç„¶åå¤šæ¬¡ä½¿ç”¨ï¼Œå®ƒçš„å†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">template &lt;class _Rp&gt;</span><br><span class="line">class _LIBCPP_TEMPLATE_VIS shared_future</span><br><span class="line">&#123;</span><br><span class="line">    __assoc_state&lt;_Rp&gt;* __state_;</span><br><span class="line"></span><br><span class="line">public:</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">template &lt;class _Rp&gt;</span><br><span class="line">shared_future&lt;_Rp&gt;::~shared_future()</span><br><span class="line">&#123;</span><br><span class="line">    if (__state_)</span><br><span class="line">        __state_-&gt;__release_shared();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>shared_future</code> æœ‰ä¸€å †åç‰¹åŒ–çš„ç‰ˆæœ¬ï¼Œå› ä¸ºå®ƒçš„ <code>get</code> ä¼šéå¸¸æ¶å¿ƒï¼Œ<code>future</code> è¿”å›ä¸€æ¬¡å’‹æéƒ½è¡Œï¼Œ<code>shared_future</code> å¯èƒ½è¦å¤„ç†å¾ˆå¤šè¯­ä¹‰ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">_Rp</span>&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">_LIBCPP_TEMPLATE_VIS</span> shared_future&lt;_Rp&amp;&gt;</span><br><span class="line">&#123;</span><br><span class="line">    __assoc_state&lt;_Rp&amp;&gt;* __state_;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// retrieving the value</span></span><br><span class="line">    <span class="function">_LIBCPP_INLINE_VISIBILITY</span></span><br><span class="line"><span class="function">    _Rp&amp; <span class="title">get</span><span class="params">()</span> <span class="type">const</span> </span>&#123;<span class="keyword">return</span> __state_-&gt;<span class="built_in">copy</span>();&#125;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">_LIBCPP_TYPE_VIS</span> _LIBCPP_AVAILABILITY_FUTURE shared_future&lt;<span class="type">void</span>&gt;</span><br><span class="line">&#123;</span><br><span class="line">    __assoc_sub_state* __state_;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="std-async"><a href="#std-async" class="headerlink" title="std::async"></a>std::async</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">_Fp</span>, <span class="keyword">class</span>... _Args&gt;</span><br><span class="line">_LIBCPP_NODISCARD_AFTER_CXX17</span><br><span class="line">future&lt;<span class="keyword">typename</span> __invoke_of&lt;<span class="keyword">typename</span> decay&lt;_Fp&gt;::type, <span class="keyword">typename</span> decay&lt;_Args&gt;::type...&gt;::type&gt;</span><br><span class="line"><span class="built_in">async</span>(launch __policy, _Fp&amp;&amp; __f, _Args&amp;&amp;... __args)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">typedef</span> __async_func&lt;<span class="keyword">typename</span> decay&lt;_Fp&gt;::type, <span class="keyword">typename</span> decay&lt;_Args&gt;::type...&gt; _BF;</span><br><span class="line">    <span class="keyword">typedef</span> <span class="keyword">typename</span> _BF::_Rp _Rp;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _LIBCPP_NO_EXCEPTIONS</span></span><br><span class="line">    <span class="keyword">try</span></span><br><span class="line">    &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        <span class="keyword">if</span> (__does_policy_contain(__policy, launch::async))</span><br><span class="line">        <span class="keyword">return</span> _VSTD::__make_async_assoc_state&lt;_Rp&gt;(_BF(_VSTD::__decay_copy(_VSTD::forward&lt;_Fp&gt;(__f)),</span><br><span class="line">                                                     _VSTD::__decay_copy(_VSTD::forward&lt;_Args&gt;(__args))...));</span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _LIBCPP_NO_EXCEPTIONS</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">catch</span> ( ... ) &#123; <span class="keyword">if</span> (__policy == launch::async) <span class="keyword">throw</span> ; &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (__does_policy_contain(__policy, launch::deferred))</span><br><span class="line">        <span class="keyword">return</span> _VSTD::__make_deferred_assoc_state&lt;_Rp&gt;(_BF(_VSTD::__decay_copy(_VSTD::forward&lt;_Fp&gt;(__f)),</span><br><span class="line">                                                        _VSTD::__decay_copy(_VSTD::forward&lt;_Args&gt;(__args))...));</span><br><span class="line">    <span class="keyword">return</span> future&lt;_Rp&gt;&#123;&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é‡Œé¢å®ç°å¤§æ¦‚æ˜¯ï¼š</p><ol><li>åˆ›å»º <code>__async_assoc_state</code> æˆ–è€… <code>__defered_assoc_state</code></li><li>lazy æˆ–è€…åŠ¨æ€çš„åˆ›å»ºçº¿ç¨‹</li><li>åˆ›å»º future</li></ol><h2 id="folly-Future-amp-Executor"><a href="#folly-Future-amp-Executor" class="headerlink" title="folly Future &amp; Executor"></a>folly Future &amp; Executor</h2><p>folly Future ç›¸å¯¹äº futureï¼ŒåŸç†å¹¶æ²¡æœ‰å¤ªå¤§å·®å¼‚ï¼Œä½†æ˜¯å¤–å±‚å’Œå®ç°ä¸°å¯Œäº†å¾ˆå¤šï¼š</p><ol><li>ä½¿ç”¨ <code>folly::Function</code>ï¼Œå‡½æ•°å¯¹è±¡æ”¯æŒäº† SBO ç­‰</li><li><code>then</code> ç­‰ç»„åˆå­ï¼Œæ–¹ä¾¿å¤„ç†ä»£ç </li><li><p><code>via</code> ç­‰ï¼Œæ”¯æŒç»‘å®š executorï¼Œå¹¶æŠ½å‡ºäº† <code>Future</code> å’Œ <code>SemiFuture</code> ç­‰ç±»å‹</p><p>folly å¯¹ Future çš„æ”¯æŒç›¸å½“å¤æ‚ï¼Œç»§æ‰¿é“¾å¤§æ¦‚åŒ…æ‹¬ï¼š</p></li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">CoreBase</span><br><span class="line">- Core&lt;T&gt;</span><br><span class="line"></span><br><span class="line">FutureBase&lt;T&gt; (åŒ…å« Core&lt;T&gt;)</span><br><span class="line">- Future&lt;T&gt; / SemiFuture&lt;T&gt;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„ Future å…è®¸é“¾å¼ã€<code>poll</code> æ¥æŸ¥çœ‹æ˜¯å¦æˆåŠŸç­‰ã€‚<code>SemiFuture</code> åˆ™æ˜¯çŠ¶æ€çš„æè¿°ã€‚<code>Future</code> æœ‰å¯¹åº”çš„ Executorï¼Œé  <code>KeepAlive</code> æ¥æŒ‡å‘ Executorï¼Œ<code>SemiFuture</code> åˆ™æ²¡æœ‰ï¼Œé™¤äº† inline æ‰§è¡Œï¼ˆå³åœ¨æœ¬çº¿ç¨‹å°±åœ°æ‰§è¡Œï¼‰ï¼Œä¸ä¼šå…è®¸å¯¹åº”çš„é€»è¾‘å‡ºç°ã€‚</p><p><code>CoreBase</code> æè¿°äº† <code>Future</code> åŸºæœ¬çš„å¯¹åº”çŠ¶æ€ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">///   +----------------------------------------------------------------+</span></span><br><span class="line"><span class="comment">///   |                       ---&gt; OnlyResult -----                    |</span></span><br><span class="line"><span class="comment">///   |                     /                       \                  |</span></span><br><span class="line"><span class="comment">///   |                  (setResult())             (setCallback())     |</span></span><br><span class="line"><span class="comment">///   |                   /                           \                |</span></span><br><span class="line"><span class="comment">///   |   Start ---------&gt;                              ------&gt; Done   |</span></span><br><span class="line"><span class="comment">///   |     \             \                           /                |</span></span><br><span class="line"><span class="comment">///   |      \           (setCallback())           (setResult())       |</span></span><br><span class="line"><span class="comment">///   |       \             \                       /                  |</span></span><br><span class="line"><span class="comment">///   |        \              ---&gt; OnlyCallback ---                    |</span></span><br><span class="line"><span class="comment">///   |         \           or OnlyCallbackAllowInline                 |</span></span><br><span class="line"><span class="comment">///   |          \                                  \                  |</span></span><br><span class="line"><span class="comment">///   |      (setProxy())                          (setProxy())        |</span></span><br><span class="line"><span class="comment">///   |            \                                  \                |</span></span><br><span class="line"><span class="comment">///   |             \                                   ------&gt; Empty  |</span></span><br><span class="line"><span class="comment">///   |              \                                /                |</span></span><br><span class="line"><span class="comment">///   |               \                            (setCallback())     |</span></span><br><span class="line"><span class="comment">///   |                \                            /                  |</span></span><br><span class="line"><span class="comment">///   |                  --------&gt; Proxy ----------                    |</span></span><br><span class="line"><span class="comment">///   +----------------------------------------------------------------+</span></span><br></pre></td></tr></table></figure><p>å› ä¸ºè¦æè¿°ä¸‹ä¸€ä¸ªä»»åŠ¡è¿™æ ·çš„ chainï¼Œæ‰€ä»¥è¿™å¥—é€»è¾‘è¿˜æ˜¯æ¯”è¾ƒæ¶å¿ƒçš„ã€‚æ­¤å¤–ï¼Œ<code>folly::Future</code> é€»è¾‘æ¶‰åŠäº†å¯¹åº”çš„ <code>Executor</code>ï¼Œæ¯ä¸ª future ä¼šæœ‰ dispatch ç»™è°çš„é€»è¾‘ï¼Œè¿™ä¸ªå’Œé“¾å¼ä¸€æ ·ï¼Œå¼•å…¥äº†å¤æ‚åº¦ã€‚</p><h2 id="Why-are-futures-slow"><a href="#Why-are-futures-slow" class="headerlink" title="Why are futures slow"></a>Why are futures slow</h2><p>future åœ¨ C++ ä¸­å‡ºç°åœ¨ C++11 çš„æ ‡å‡†åº“ï¼Œè€Œåˆ«çš„è¯­è¨€ä¹Ÿå¸¸æœ‰ç±»ä¼¼çš„ä¸œè¥¿ã€‚å®ƒæ˜¯ç”±åº“æ¥å®ç°çš„ã€‚ç±»ä¼¼ <code>std::function</code>ï¼Œ<code>std::future</code> æ˜¯å †ä¸Šçš„ã€ç±»å‹æ“¦é™¤çš„ã€‚è¿™ä¸¤éƒ¨åˆ†æŠ½è±¡éƒ½å¸¦æ¥äº†ä¸€å®šçš„å¼€é”€ã€‚</p><p>ä¹‹åä¼šåˆ†åˆ«ä»‹ç» Seastar futureã€Rust futureã€C++ executorsï¼Œæ¥çœ‹çœ‹å®ƒä»¬æ˜¯æ€ä¹ˆæŠ½è±¡çš„ã€‚ç®€å•æ¥è¯´ï¼š</p><ol><li>C++ executors ä¼šæœ‰ sender / receiverï¼Œç”¨æ¨¡ç‰ˆç±»å‹æ¥å°è£…ä»–ä»¬ï¼Œç„¶åæä¾›äº†å„ç§ç®—æ³•æ¥åšæŠ½è±¡</li><li>Rust é  <code>Future&lt;T&gt;</code> æ¥æŠ½è±¡ï¼Œ<code>Box&lt;Future&lt;T&gt;&gt;</code> æ¥è¡¨ç¤ºåŠ¨æ€ä¸€äº›çš„å¯¹è±¡ã€‚<code>Future&lt;T&gt;</code> éœ€è¦å¯ä»¥ <code>poll()</code>ï¼Œä¸Šå±‚çš„çŠ¶æ€æœºæ¥ pollingï¼ŒåšæŸ¥è¯¢</li><li>seastar é æ¨¡å‹çš„æŠ½è±¡ï¼Œæ¥ç®€åŒ–äº†ç›¸å…³çš„é€»è¾‘ã€‚</li></ol><h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><ol><li><p>libcxx future</p></li><li><p>folly future</p></li><li><p>æµ…è°ˆThe C++ Executors <a href="https://zhuanlan.zhihu.com/p/395250667">https://zhuanlan.zhihu.com/p/395250667</a> (ç»ä¸–å¥½æ–‡)</p></li></ol>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Parquet Part1: Basic</title>
      <link href="/2022/09/18/Parquet-Part1-Basic/"/>
      <url>/2022/09/18/Parquet-Part1-Basic/</url>
      
        <content type="html"><![CDATA[<p>Parquet æ˜¯ä¸€ä¸ªç”± Google Dremel æ ¼å¼å¯å‘è€Œæ¥çš„åˆ—å­˜æ ¼å¼ï¼Œåœ¨å¤§æ•°æ®é¢†åŸŸé€šå¸¸ä½œä¸ºå­˜å‚¨æ ¼å¼ï¼Œè¢« iceberg ç­‰æ¹–ã€å„ç§æŸ¥è¯¢å¼•æ“èƒ½å¤Ÿåˆç†çš„ä½¿ç”¨ã€‚Parquet çš„æ ¼å¼å®šä¹‰åœ¨<a href="https://github.com/apache/parquet-format">https://github.com/apache/parquet-format</a> ï¼Œç”±äºå¤§æ•°æ®äº‹å®æ ‡å‡†è¯­è¨€æ˜¯ Javaï¼Œæ‰€ä»¥å…¶ Java å®ç°(  <a href="https://github.com/apache/parquet-mr">https://github.com/apache/parquet-mr</a> ) è¾ƒä¸ºå®Œå–„ã€‚C++ å®ç°ç›®å‰åœ¨ arrow çš„ä»“åº“ä¸‹ï¼š<a href="https://github.com/apache/arrow/tree/master/cpp/src/parquet">https://github.com/apache/arrow/tree/master/cpp/src/parquet</a> ã€‚å®ƒçš„åŠŸèƒ½å®ç°çš„ä¸æ˜¯å¾ˆå®Œå–„ï¼Œå…·ä½“å¯ä»¥è§: <a href="https://arrow.apache.org/docs/cpp/parquet.html">https://arrow.apache.org/docs/cpp/parquet.html</a></p><p>Parquet åœ¨æœ€æ—©è¢«æè¿°ä¸º HDFS ä¸Šçš„æ ¼å¼ï¼Œæ‰€ä»¥æœ‰ HDFS Block/File ç›¸å…³çš„æ¦‚å¿µã€‚</p><p>æ­¤å¤–ï¼Œæœ‰ä¸€äº›åœ°æ–¹ä¼šä¸“é—¨åœ¨è‡ªå·±ä»“åº“é‡Œå®ç°äº†ä¸€äº› parquet ç‰¹æ€§ï¼Œåœ¨ 2011 å¹´è¿™æ ¼å¼è¢«æå‡ºæ¥çš„æ—¶å€™ï¼Œç›¸å…³å¤„ç†é€»è¾‘è¿˜æ˜¯æ¯”è¾ƒå¤æ‚çš„ï¼Œå¯èƒ½æœ‰çš„äººè‡ªå·±å®ç°äº†ä¸€å¥—ï¼Œåˆå’Œè‡ªå·±çš„æ•°æ®ç»“æ„å¾ˆç´§å¯†ï¼Œæ¯”å¦‚ Impala å®ç°äº†ä¸€å¥— parquet æœ‰å…³çš„é€»è¾‘ã€‚è¿™é‡Œæˆ‘å°†ä¼šä»‹ç»ä¸€ä¸‹ parquet å’Œå®˜æ–¹çš„ä»£ç ï¼Œå¸¦å¤§å®¶èµ°è¿›é»‘æš—çš„æ ¼å¼</p><h2 id="Format"><a href="#Format" class="headerlink" title="Format"></a>Format</h2><p><img src="https://image.mwish.me/blog-image/68747470733a2f2f7261772e6769746875622e636f6d2f6170616368652f706172717565742d666f726d61742f6d61737465722f646f632f696d616765732f46696c654c61796f75742e676966.gif" alt="68747470733a2f2f7261772e6769746875622e636f6d2f6170616368652f706172717565742d666f726d61742f6d61737465722f646f632f696d616765732f46696c654c61796f75742e676966"></p><h3 id="Footer-éƒ¨åˆ†"><a href="#Footer-éƒ¨åˆ†" class="headerlink" title="Footer éƒ¨åˆ†"></a>Footer éƒ¨åˆ†</h3><p>è¿™å›¾å¤§æ¦‚å¦‚ä¸Šæ‰€ç¤ºï¼Œç„¶åå®˜æ–¹ä»‹ç»çš„å¾ˆå¥½ï¼š</p><ol><li>è¯»è¿™ä¸ªï¼Œé¦–å…ˆè¦æ‰¾åˆ° tailerï¼Œå‘ç°æ»¡è¶³å¯¹åº”çš„ magic number å’Œ footer lengthã€‚<em>åè¿‡æ¥è¯´ï¼Œmetadata åªåœ¨ ç»“å°¾ï¼Œå…è®¸æ•´ä¸ªæ–‡ä»¶åªå†™ä¸€æ¬¡</em>ï¼Œ</li><li><code>Footer</code> æœ‰æ–‡ä»¶çš„å…ƒä¿¡æ¯ï¼Œç”¨ ThriftCompactProtocol æè¿°ï¼Œè¿™é‡Œç›¸å¯¹ thrift åŸæœ¬ binaryï¼Œå¯èƒ½ä¼šæœ‰ä¸€äº› varint zigzag ä»€ä¹ˆçš„<ol><li>version åº”è¯¥æ˜¯ Parquet å†…éƒ¨çš„ä¿¡æ¯ï¼Œåœ¨ thrift é‡Œé¢æ ‡æ˜äº†æ ¼å¼çš„ç‰ˆæœ¬ï¼Œè¿™é‡Œæœ‰ä¸ª<a href="https://github.com/apache/arrow/pull/13665">æœ‰è¶£çš„ issue</a>ï¼Œé€»è¾‘é—®é¢˜æ¥è‡ªäº file ä½ç‰ˆæœ¬çš„æ—¶å€™ï¼ŒPage å¯èƒ½æ²¡å¸¦ç‰ˆæœ¬ã€‚</li><li>Schema ä»£è¡¨ RowGroup çš„ schemaï¼Œ<strong>æ‰€æœ‰ RowGroup éƒ½éœ€è¦æ˜¯è¿™ä¸ª Schema</strong>ã€‚schema æ„Ÿè§‰å…¶å®å¯èƒ½ä¸å°ï¼Œæœ‰ name / type (åœ¨é€’å½’å®šä¹‰ä¸­çš„ path) ç­‰ï¼Œè¿˜æœ‰ä¸€äº›å­èŠ‚ç‚¹ç›¸å…³çš„ä¿¡æ¯ã€‚è¿™é‡Œè¿˜æœ‰ä¸€ä¸ªå¾ˆé‡è¦çš„ä¿¡æ¯ <strong>field id</strong>, è¿™æ˜¯ä¸Šå±‚ä¼ ä¸‹æ¥çš„ï¼Œå”¯ä¸€çš„å­—æ®µçš„ idï¼Œä¸Šå±‚å¯ä»¥ç”¨è¿™ä¸ªå­—æ®µæ¥åšä¸€äº› schema evolution ç›¸å…³çš„é€»è¾‘<ol><li>Schema ç±»å‹åªæ˜¯ Parquet çš„ç±»å‹ï¼Œå…¶ä¸­å¤–éƒ¨çš„ SQL / ç”¨æˆ·ç±»å‹å®é™…ä¸Šå’Œ Parquet å†…éƒ¨è¿™äº›ç±»å‹ä¸ä¸€å®šèƒ½å¯¹ä¸Šï¼Œç±»å‹éœ€è¦é¢å¤–åšä¸€å±‚æ˜ å°„ / Hackï¼Œå¯èƒ½ä¼šå€ŸåŠ©é¢å¤–çš„ Attributesã€‚</li></ol></li><li>Extra key/value pairs å¯ä»¥å¡ä¸€äº›ä¿¡æ¯ï¼Œåœ¨ arrow çš„ compute æ¨¡å—é‡Œï¼Œç”¨å®ƒæ¥å¡äº†ä¸€äº›å’Œè®¡ç®—æœ‰å…³çš„é€»è¾‘ã€‚è¿™å—æˆ‘è§‰å¾—æœ‰ç‚¹çŸ›ç›¾ï¼Œå› ä¸ºä¸€ä¸ªè¯»è€…å¿…é¡»æ‹¿åˆ° writerã€æ”¶é›†ä¸€äº›ä¿¡æ¯æˆ–è€…ä»€ä¹ˆçš„ï¼Œæ‰ä¼šå¥½æ”¾è¿›å»ï¼Œæˆ‘çœ‹ä¸€èˆ¬çš„åº“åŸºæœ¬æ²¡æœ‰æš´éœ²è¿™ä¸ªæ¥å£å‡ºå»çš„ï¼Œæ„Ÿè§‰åŸºæœ¬ä¸Šæ˜¯ç»™ä¸€äº›èƒ½æ”¹å¾—åŠ¨ parquet çš„äººå¼€æ´ç”¨çš„ã€‚</li></ol></li><li>å‰©ä¸‹ä¼šç»™å‡ºæ¯ä¸ª RowGroup çš„å…ƒä¿¡æ¯ï¼Œé‡Œé¢åŒ…æ‹¬æ¯ä¸ª Column çš„å…ƒä¿¡æ¯ã€‚è¿™é‡Œçš„å•ä½æ˜¯ RowGroupï¼Œæ²¡æœ‰ Page ç²’åº¦çš„ä¿¡æ¯ã€‚å®ƒç›¸å½“äºåœ¨ parquet.thrift é‡Œé¢çš„ <code>RowGroup</code> é‡Œé¢ç»™äº†å®šä¹‰ã€‚æ¯ä¸ª RowGroup æœ‰<strong>æ‰€æœ‰</strong> Columns çš„å®šä¹‰ï¼Œè¿™é‡Œä¼šæœ‰<ol><li>æŒ‡å‘æ•°æ®å—å¤´çš„ <code>file_offset</code>ï¼Œæ•°æ®é¡µå¤´ä¹Ÿæ˜¯ä¸ª thrift ç»“æ„ï¼Œè¿™é‡Œå¯èƒ½ä¼š duplicate ä¸€ä»½ï¼ˆç»“æ„ä¸Šæœ‰ä¸€ä¸ª <code>optional ColumnMetaData</code>ï¼Œåœ¨æ ‡å‡†ä¸Šå…è®¸ä½ å†™æˆ–è€…ä¸å†™ï¼Œä¼°æ‘¸ç€çœ‹å®ç°ï¼‰ï¼Œè¿™ä¸ªç»“æ„å«åš <code>ColumnMetaData</code>ã€‚æˆ‘ä»¬ä¹‹åä»‹ç»æ•°æ®é¡µçš„æ—¶å€™ï¼Œä¼šä»‹ç»è¿™é‡Œã€‚<ol><li>æ³¨æ„ <code>ColumnMetaData</code> ä¸Šæœ‰ä¸€ä¸ª <code>num_values</code>ï¼Œè¿™é‡Œä»£è¡¨çš„æ˜¯ã€ŒåŒ…æ‹¬ nullsï¼Œè¿™ä¸ª <code>ColumnChunk</code> å¯¹åº”å€¼çš„æ•°é‡ã€è€Œéã€Œè¿™ä¸ª <code>ColumnChunk</code> å¯¹åº”è¡Œçš„æ•°é‡ã€ã€‚è¿™ä¸ªåœ°æ–¹æˆ‘è¯´çš„å¯èƒ½æœ‰ä¸€ç‚¹éš¾ç†è§£ï¼Œæ¯”å¦‚å¯¹äº <code>optional i32</code> çš„å¹³å¦æ•°æ®ï¼Œè¿™é‡Œç­‰ä»·äºè¡Œæ•°ï¼Œè€Œå¯¹äº <code>repeated &lt;optional i32&gt;</code>ï¼Œè¿™é‡Œä»£è¡¨å†…å±‚çš„æ•°é‡ã€‚<code>PageHeader</code> çš„ <code>num_values</code> ä¹ŸåŒç†ã€‚</li><li>æ€»æ–‡ä»¶çš„ <code>FileMetaData</code>ã€RowGroup çš„å…ƒæ•°æ®ã€DataPageV2 ä¼šæœ‰ <code>num_rows</code>ï¼Œè¡¨ç¤ºå¯¹åº”è¡Œçš„æ•°é‡ã€‚<strong>åœ¨æœ‰åµŒå¥—çš„æƒ…å†µä¸‹ï¼Œè¿™ä¸ªä¸ç­‰äº <code>num_values</code></strong>.</li></ol></li><li>ä¼šæœ‰ä¸€äº› PageIndex ç›¸å…³çš„åç§»é‡ï¼Œè¿™é‡Œå¯èƒ½æŒ‡å‘ OffsetIndex å’Œ ColumnIndex. æ³¨æ„ï¼Œè¿™é‡ŒæŒ‡å‘çš„æ˜¯ <strong>RowGroup çš„ Index</strong>ã€‚</li><li>ä¼šæœ‰å­—å…¸é¡µç›¸å…³çš„è®°å½•ï¼Œå¦‚æœé‡‡ç”¨äº†å­—å…¸ç¼–ç ï¼ŒColumnChunk çš„ç¬¬ä¸€ä¸ªé¡µé¢ä¼šæ˜¯å­—å…¸é¡µ</li><li>è®°å½•äº†æ€»è¡Œæ•°ï¼Œæœªå‹ç¼©çš„å¤§å°ï¼ˆæœªç»è¿‡å‹ç¼©ï¼Œä½†å·²ç» Encodingï¼‰ï¼Œå‹ç¼©åçš„å¤§å°ï¼ŒRowGroup å¯¹åº”çš„ä½ç½®ï¼ˆå³è¿™ä¸ª rg ä¹‹å‰çš„æ€»è¡Œæ•°ï¼‰</li><li>æœ‰ä¸€ä¸ªç‰¹æ®Šçš„ <code>SortingColumns</code>ï¼Œæ ‡è¯†è¿™ä¸ª RowGroup æŒ‰ç…§ä»€ä¹ˆæ’åºã€‚è¿™é‡Œç±»ä¼¼æ•°æ®åº“çš„ <code>SortingColumn</code>ï¼Œä¼šæœ‰ä¸€äº› <code>nulls_first</code> çš„å¤„ç†ä»€ä¹ˆçš„ã€‚è¿™é‡Œè¿˜æœ‰ä¸€äº›å’Œç±»å‹ç›¸å…³çš„æ’åºè¦æ±‚ <code>ColumnOrder</code>ï¼Œä¼šæŠŠç±»å‹ç¼–ç åˆ°å¯¹åº”çš„é€»è¾‘ä¸­ã€‚<strong>æ³¨æ„ï¼Œsorting æ˜¯ RowGroup çº§åˆ«çš„ sortingï¼Œæ ¼å¼åº”è¯¥æ²¡æœ‰å¼ºåˆ¶æ•´ä¸ªæ–‡ä»¶ç”¨ä¸€æ ·çš„ sorting</strong> ï¼ˆæˆ‘è§‰å¾—è¿™é‡Œå¾ˆé¸¡è´¼ï¼Œschema ç”¨çš„æ˜¯åŒä¸€ä»½ï¼Œä½†æ˜¯ sorting å´å¹¶ä¸æ˜¯â€¦ï¼‰ã€‚</li></ol></li></ol><p>ç»™å‡ºä¸€å¼ æ€»å›¾ï¼š</p><p><img src="https://image.mwish.me/blog-image/FileFormat.gif" alt="FileFormat"></p><h3 id="æ•°æ®éƒ¨åˆ†"><a href="#æ•°æ®éƒ¨åˆ†" class="headerlink" title="æ•°æ®éƒ¨åˆ†"></a>æ•°æ®éƒ¨åˆ†</h3><p>å…ƒä¿¡æ¯ä¸­ï¼Œ<code>ColumnChunk</code> ä¼šåŒ…å«å¯¹åº”çš„ <code>file_path</code> å’Œ <code>file_offset</code>ï¼Œè¿™ç‚¹ <strong>å…è®¸æ•°æ®åˆ†å¸ƒåœ¨åˆ«çš„æ–‡ä»¶</strong>. æ•°æ®æ–‡ä»¶çš„åˆ†å¸ƒå¤§æ¦‚æ˜¯ï¼š</p><ul><li>RowGroup åŒ…å«ä¸€ä¸ªæˆ–è€…å¤šä¸ª ColumnChunk</li><li>ColumnChunk åŒ…å«ä¸€ä¸ªæˆ–è€…å¤šä¸ª Pageï¼Œä¹ŸåŒ…å«äº†å„ç§å…ƒä¿¡æ¯</li></ul><p><strong>æ³¨æ„ï¼ŒColumnChunk çš„å…ƒä¿¡æ¯ï¼ˆColumnMetaDataï¼‰ä¹Ÿå­˜æ”¾åœ¨ ColumnChunk çš„å°¾éƒ¨</strong>ï¼Œåœ¨ IO å®Œæˆåå†™å…¥ã€‚</p><h2 id="ç±»å‹ç³»ç»Ÿå’Œé€»è¾‘ç±»å‹"><a href="#ç±»å‹ç³»ç»Ÿå’Œé€»è¾‘ç±»å‹" class="headerlink" title="ç±»å‹ç³»ç»Ÿå’Œé€»è¾‘ç±»å‹"></a>ç±»å‹ç³»ç»Ÿå’Œé€»è¾‘ç±»å‹</h2><h3 id="åŸºç¡€ç±»å‹"><a href="#åŸºç¡€ç±»å‹" class="headerlink" title="åŸºç¡€ç±»å‹"></a>åŸºç¡€ç±»å‹</h3><p>Parquet åªæ”¯æŒä¸€ç»„å¾ˆå°çš„åŸºç¡€ç±»å‹ï¼Œå«åš <code>Type</code>ï¼Œæˆ‘ä»¬éœ€è¦æŠŠå®ƒå’Œåæ–‡çš„ <code>LogicalType</code> åŒºåˆ†å¼€æ¥ï¼š</p><figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Types supported by Parquet.  These types are intended to be used in combination</span></span><br><span class="line"><span class="comment"> * with the encodings to control the on disk storage format.</span></span><br><span class="line"><span class="comment"> * For example INT16 is not included as a type since a good encoding of INT32</span></span><br><span class="line"><span class="comment"> * would handle this.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">enum </span><span class="title class_">Type</span> &#123;</span><br><span class="line">  BOOLEAN = <span class="number">0</span>;</span><br><span class="line">  INT32 = <span class="number">1</span>;</span><br><span class="line">  INT64 = <span class="number">2</span>;</span><br><span class="line">  INT96 = <span class="number">3</span>;  <span class="comment">// deprecated, only used by legacy implementations.</span></span><br><span class="line">  FLOAT = <span class="number">4</span>;</span><br><span class="line">  DOUBLE = <span class="number">5</span>;</span><br><span class="line">  BYTE_ARRAY = <span class="number">6</span>;</span><br><span class="line">  FIXED_LEN_BYTE_ARRAY = <span class="number">7</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œç‰©ç†ä¸ºå•¥æœ€ä½æ”¯æŒ INT32? å› ä¸ºä½œè€…ä¼¼ä¹è®¤ä¸º i16 i8 èƒ½æ¯”è¾ƒå¥½è¢«å‹ç¼©ã€‚ï¼ˆ2023.2.2: ç›®å‰ä¼¼ä¹åœ¨è®¨è®ºåœ¨ spec é‡Œé¢åŠ å…¥çª„æµ®ç‚¹æ•°ï¼‰ã€‚</p><p>è¿™ä¸ªå­—æ®µé…åˆä¸€ä¸ª <code>LogicalType</code>ï¼Œå…±åŒç»„æˆäº†éœ€è¦çš„ç±»å‹ï¼š</p><figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * LogicalType annotations to replace ConvertedType.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * To maintain compatibility, implementations using LogicalType for a</span></span><br><span class="line"><span class="comment"> * SchemaElement must also set the corresponding ConvertedType from the</span></span><br><span class="line"><span class="comment"> * following table.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">union LogicalType &#123;</span><br><span class="line">  <span class="number">1</span>:  StringType STRING       <span class="comment">// use ConvertedType UTF8</span></span><br><span class="line">  <span class="number">2</span>:  MapType MAP             <span class="comment">// use ConvertedType MAP</span></span><br><span class="line">  <span class="number">3</span>:  ListType LIST           <span class="comment">// use ConvertedType LIST</span></span><br><span class="line">  <span class="number">4</span>:  EnumType ENUM           <span class="comment">// use ConvertedType ENUM</span></span><br><span class="line">  <span class="number">5</span>:  DecimalType DECIMAL     <span class="comment">// use ConvertedType DECIMAL</span></span><br><span class="line">  <span class="number">6</span>:  DateType DATE           <span class="comment">// use ConvertedType DATE</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// use ConvertedType TIME_MICROS for TIME(isAdjustedToUTC = *, unit = MICROS)</span></span><br><span class="line">  <span class="comment">// use ConvertedType TIME_MILLIS for TIME(isAdjustedToUTC = *, unit = MILLIS)</span></span><br><span class="line">  <span class="number">7</span>:  TimeType TIME</span><br><span class="line"></span><br><span class="line">  <span class="comment">// use ConvertedType TIMESTAMP_MICROS for TIMESTAMP(isAdjustedToUTC = *, unit = MICROS)</span></span><br><span class="line">  <span class="comment">// use ConvertedType TIMESTAMP_MILLIS for TIMESTAMP(isAdjustedToUTC = *, unit = MILLIS)</span></span><br><span class="line">  <span class="number">8</span>:  TimestampType TIMESTAMP</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 9: reserved for INTERVAL</span></span><br><span class="line">  <span class="number">10</span>: IntType INTEGER         <span class="comment">// use ConvertedType INT_* or UINT_*</span></span><br><span class="line">  <span class="number">11</span>: NullType UNKNOWN        <span class="comment">// no compatible ConvertedType</span></span><br><span class="line">  <span class="number">12</span>: JsonType JSON           <span class="comment">// use ConvertedType JSON</span></span><br><span class="line">  <span class="number">13</span>: BsonType BSON           <span class="comment">// use ConvertedType BSON</span></span><br><span class="line">  <span class="number">14</span>: UUIDType UUID</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå®ƒæœ‰ä¸ª <code>ConvertedType</code>ï¼ŒåŸºæœ¬ä¸Šæ˜¯å…¼å®¹æ—§å±å±±äº†ï¼Œå±äºæ—§ä»£ç ã€‚æœ‰ä¸€äº›ç‰¹æ®Šç±»å‹éœ€è¦æ³¨æ„ä¸€ä¸‹ï¼š</p><ol><li>Decimal/Time å¯èƒ½æ ¹æ®ç²¾åº¦/ä»£è¡¨çš„ä¸œè¥¿ä¸åŒï¼Œç‰©ç†çš„è¡¨ç¤ºæ˜¯ä¸ä¸€æ ·çš„</li><li>å¯¹äº structï¼Œå¤–å¤´ç›¸å½“äºåªä¼šæŠŠå¶å­ç»“ç‚¹ç¼–ç ï¼Œä½†æ˜¯è¿˜æ˜¯æœ‰ä¸€äº›å¤æ‚ç±»å‹çš„ï¼Œæ¯”å¦‚ LIST å’Œ MAP:<ol><li>List ç›¸å½“äº 2ä¸ªå…ƒç´ ï¼Œ<code>LIST&lt;int&gt;</code> é‡Œé¢ï¼Œå¤–é¢çš„ List æ˜¯ä¸€ç»„æ ‡è®°ï¼Œé‡Œé¢ int åˆæ˜¯ä¸€ç»„æ ‡è®°</li><li>Map åˆ™ç›¸å½“äºä¸‰ä¸ª, <code>Map&lt;K, V&gt;</code> é‡Œé¢ï¼Œ<code>Map</code> <code>K</code> <code>V</code> éƒ½æ˜¯æ ‡è®°</li></ol></li></ol><p>æœ‰ä¸€ç‚¹éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåªæœ‰ Leaf èŠ‚ç‚¹æ‹¥æœ‰ <code>Type</code>ï¼Œå®ƒä¸å¯èƒ½æ˜¯ Map, List, Struct. ä¸­é—´çš„èŠ‚ç‚¹å¯èƒ½ä¼šæ˜¯ï¼š</p><ol><li>List, Map, Struct ä¹‹ç±»çš„åµŒå¥—ç±»å‹</li><li>åˆ«çš„å¯¹åº”çš„é€»è¾‘ç±»å‹</li></ol><p>åµŒå¥—ç»“æ„å®šä¹‰å…¶å®è¿˜æŒºå•°å—¦çš„ï¼Œè¿™æ®µä»£ç çœ‹ç€è¿˜æ˜¯å¾ˆæ¶å¿ƒçš„ï¼Œä½†æ˜¯å¾ˆæ¸…æ™°ï¼Œå¯ä»¥è¯•çœ‹ä¸‹å›¾ï¼š</p><p>List (æœ€å¤–å±‚çš„ optional æ˜¯ List æ˜¯å¦ optional, é‡Œé¢çš„æ˜¯ List member æ˜¯å¦ optional) :</p><figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;list-repetition&gt; <span class="keyword">group</span> &lt;name&gt; (LIST) &#123;</span><br><span class="line">  <span class="keyword">repeated</span> <span class="keyword">group</span> list &#123;</span><br><span class="line">    &lt;element-repetition&gt; &lt;element-type&gt; element;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šè¿°æ˜¯ç†æƒ³åœºæ™¯çš„ Listï¼Œä¸‹åˆ—æ˜¯è¯»å–çš„æ—¶å€™ä¼šé‡åˆ°çš„ä¸€äº›å¥‡æ€ªçš„ä¸œè¥¿çš„å…¼å®¹æ€§ï¼š<a href="https://github.com/apache/parquet-format/blob/master/LogicalTypes.md#backward-compatibility-rules">https://github.com/apache/parquet-format/blob/master/LogicalTypes.md#backward-compatibility-rules</a></p><p>Map çš„ Key åˆ™éœ€è¦ä¸€ä¸ªå­—æ®µï¼Œè€Œä¸”å¿…é¡»è¦ non-null:</p><figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;map-repetition&gt; <span class="keyword">group</span> &lt;name&gt; (MAP) &#123;</span><br><span class="line">  <span class="keyword">repeated</span> <span class="keyword">group</span> key_value &#123;</span><br><span class="line">    <span class="keyword">required</span> &lt;key-type&gt; key;</span><br><span class="line">    &lt;value-repetition&gt; &lt;value-type&gt; value;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>To be honest, æˆ‘æ€»è§‰å¾—å­˜ Map çš„è¯ï¼Œåšä¸åˆ°äºŒåˆ†ï¼Œä¸è¿‡ arrow çš„ Map åº”è¯¥ä¹Ÿæ˜¯è¿™ä¹ˆè‰å°çš„ï¼Ÿ</p><p>è¿™é‡Œä¹Ÿè¦è€ƒè™‘å…¼å®¹æ€§ï¼š<a href="https://github.com/apache/parquet-format/blob/master/LogicalTypes.md#backward-compatibility-rules-1">https://github.com/apache/parquet-format/blob/master/LogicalTypes.md#backward-compatibility-rules-1</a></p><h3 id="Sort-Order-amp-Statistics"><a href="#Sort-Order-amp-Statistics" class="headerlink" title="Sort Order &amp; Statistics"></a>Sort Order &amp; Statistics</h3><ul><li>è¿™ä¸ªåœ°æ–¹æˆ‘ä¸ç¡®å®šè‡ªå·±å®Œå…¨çœ‹æ‡‚äº†ï¼Œå› ä¸º Sort Order åœ¨ C++ å®ç°çš„æ—¶å€™å¾ˆ Shitï¼Œå¿…é¡»è¦æœ‰ SortOrder å’Œ Comparable çš„ä¿¡æ¯æ‰èƒ½å¤Ÿç”Ÿæˆå¯¹åº”çš„</li><li>è‡³å°‘åœ¨ä»Šå¤©(2023.2.2)ï¼Œparquet-format é¡µé¢ä¸Šçš„æè¿°ä¸æ˜¯å¾ˆæ¸…æ™°ã€‚ä½†æ˜¯ parquet.thrift çš„å®šä¹‰æ˜¯ååˆ†æ¸…æ™°çš„</li></ul><p>æˆ‘ç›´æ¥ä»‹ç»ä¸€ä¸‹ Parquet-format çš„å®šä¹‰ï¼Œé¿å…è¯´è½¦è½±è¾˜è¯ï¼š</p><ol><li>LogicalType Order: ç”± LogicalType å®šä¹‰çš„ Orderï¼Œè¿™å¥—ä¸œè¥¿æœ€å¥½åšåˆ°æ ‡å‡†ä¸Šï¼Œä¸ç„¶åº”è¯¥ä¸å¤ªåˆæ³•<ol><li>ç›®å‰æ ‡å‡†ä¸Šç»™æ¯ä¸ª LogicalType éƒ½æœ‰ Order ç›¸å…³çš„å®šä¹‰ï¼Œå¦‚æœæ˜¯ç”¨æˆ·æ˜ å°„çš„ç±»å‹ï¼Œå¯èƒ½è¦æ³¨æ„ç›¸å…³çš„å®šä¹‰</li></ol></li><li>Typeï¼šæŒ‰ç…§ Type çš„å®šä¹‰æ¥è¡Œä¸ºã€‚å…¶ä¸­ INT å¼ºåˆ¶æœ‰ç¬¦å·æ¯”è¾ƒï¼Œbytes ç±»çš„ç±»å‹å¼ºåˆ¶ byte æ¯”è¾ƒ<ol><li>æ¯”è¾ƒ Trickey çš„æ˜¯æµ®ç‚¹æ•°ç±»å‹ï¼Œè¿™é‡Œ Spec åº”è¯¥å†™äº†å¦‚ä½•å¤„ç†ï¼Œæ¯”è¾ƒ Trickey: <a href="https://github.com/apache/parquet-format/blob/master/src/main/thrift/parquet.thrift#L888">https://github.com/apache/parquet-format/blob/master/src/main/thrift/parquet.thrift#L888</a></li></ol></li></ol><p>åœ¨ C++ ç‰ˆæœ¬ä»£ç ä¸­ï¼Œå¦‚æœä¸å¯æ¯”è¾ƒï¼Œå°±ä¸ä¼šç”Ÿæˆä»»ä½• Statisticsã€‚è¿™ä¸ªæ˜¾ç„¶æ˜¯æœ‰é—®é¢˜çš„ã€‚</p><p>Statistics åœ¨ Parquet ä¸­<strong>ã€Œæ°¸è¿œã€</strong> æ˜¯ optional çš„ï¼Œä¸‹é¢æˆ‘æŠŠå…¼å®¹æ€§å­—æ®µè£å‰ªæ‰äº†è´´ä¸€ä¸‹ Statistics:</p><figure class="highlight thrift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Statistics per row group and per page</span></span><br><span class="line"><span class="comment"> * All fields are optional.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Statistics</span> </span>&#123;</span><br><span class="line">   <span class="comment">/** count of null value in the column */</span></span><br><span class="line">   <span class="number">3</span>: <span class="keyword">optional</span> <span class="type">i64</span> null_count;</span><br><span class="line">   <span class="comment">/** count of distinct values occurring */</span></span><br><span class="line">   <span class="number">4</span>: <span class="keyword">optional</span> <span class="type">i64</span> distinct_count;</span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Min and max values for the column, determined by its ColumnOrder.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * Values are encoded using PLAIN encoding, except that variable-length byte</span></span><br><span class="line"><span class="comment">    * arrays do not include a length prefix.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="number">5</span>: <span class="keyword">optional</span> <span class="type">binary</span> max_value;</span><br><span class="line">   <span class="number">6</span>: <span class="keyword">optional</span> <span class="type">binary</span> min_value;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>max_value</code> å’Œ <code>min_value</code> éƒ½æ˜¯ç±»å‹è‡ªå®šä¹‰çš„ï¼ŒæŒ‰ç…§å¯¹åº”çš„å†…å®¹è§£æã€‚</p><h3 id="SchemaElement"><a href="#SchemaElement" class="headerlink" title="SchemaElement"></a>SchemaElement</h3><p><code>SchemaElement</code> æ˜¯ Parquet Schema çš„æœ€é‡è¦éƒ¨åˆ†ä¹‹ä¸€ï¼Œæ²¡ Statistics ä½ è¿˜èƒ½æ´»ï¼Œæ²¡ SchemaElement å°±ç¬‘å˜»äº†ã€‚ç†è§£ SchemaElement ä¹Ÿèƒ½å¸®åŠ©ç†è§£ Nested Type çš„å¤„ç†:</p><figure class="highlight thrift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Represents a element inside a schema definition.</span></span><br><span class="line"><span class="comment"> *  - if it is a group (inner node) then type is undefined and num_children is defined</span></span><br><span class="line"><span class="comment"> *  - if it is a primitive type (leaf) then type is defined and num_children is undefined</span></span><br><span class="line"><span class="comment"> * the nodes are listed in depth first traversal order.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">SchemaElement</span> </span>&#123;</span><br><span class="line">  <span class="comment">/** Data type for this field. Not set if the current element is a non-leaf node */</span></span><br><span class="line">  <span class="number">1</span>: <span class="keyword">optional</span> Type type;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** repetition of the field. The root of the schema does not have a repetition_type.</span></span><br><span class="line"><span class="comment">   * All other nodes must have one */</span></span><br><span class="line">  <span class="number">3</span>: <span class="keyword">optional</span> FieldRepetitionType repetition_type;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** Name of the field in the schema */</span></span><br><span class="line">  <span class="number">4</span>: <span class="keyword">required</span> <span class="type">string</span> name;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** Nested fields.  Since thrift does not support nested fields,</span></span><br><span class="line"><span class="comment">   * the nesting is flattened to a single list by a depth-first traversal.</span></span><br><span class="line"><span class="comment">   * The children count is used to construct the nested relationship.</span></span><br><span class="line"><span class="comment">   * This field is not set when the element is a primitive type</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="number">5</span>: <span class="keyword">optional</span> <span class="type">i32</span> num_children;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** When the original schema supports field ids, this will save the</span></span><br><span class="line"><span class="comment">   * original field id in the parquet schema</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="number">9</span>: <span class="keyword">optional</span> <span class="type">i32</span> field_id;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * The logical type of this SchemaElement</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * LogicalType replaces ConvertedType, but ConvertedType is still required</span></span><br><span class="line"><span class="comment">   * for some logical types to ensure forward-compatibility in format v1.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="number">10</span>: <span class="keyword">optional</span> LogicalType logicalType</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„ç»“æ„ä¸­æˆ‘å»æ‰äº†å…¼å®¹æ€§æœ‰å…³çš„å­—æ®µï¼Œå’Œç±»å‹ Specific çš„å­—æ®µã€‚å¯ä»¥ä» <code>Type</code> å’Œ <code>LogicalType</code> çš„å­˜åœ¨æ€§æ¥ç†è§£ã€‚è¿™ä¸ªç»“æ„ä¼šä»¥ depth-first çš„å½¢å¼å‡ºç°åœ¨ FileMetaData çš„ Schema ä¸­ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * Description for file metadata</span><br><span class="line"> */</span><br><span class="line">struct FileMetaData &#123;</span><br><span class="line">  /** Version of this file **/</span><br><span class="line">  1: required i32 version</span><br><span class="line"></span><br><span class="line">  /** Parquet schema for this file.  This schema contains metadata for all the columns.</span><br><span class="line">   * The schema is represented as a tree with a single root.  The nodes of the tree</span><br><span class="line">   * are flattened to a list by doing a depth-first traversal.</span><br><span class="line">   * The column metadata contains the path in the schema for that column which can be</span><br><span class="line">   * used to map columns to nodes in the schema.</span><br><span class="line">   * The first element is the root **/</span><br><span class="line">  2: required list&lt;SchemaElement&gt; schema;</span><br></pre></td></tr></table></figure><p>å¯ä»¥æ„Ÿå—ä¸€ä¸‹ Leaf Schema å’Œ non-leaf çš„åŒºåˆ«ã€‚</p><h2 id="Data-amp-Page"><a href="#Data-amp-Page" class="headerlink" title="Data &amp; Page"></a>Data &amp; Page</h2><p>DataPage å’Œ Dictionary Page æ˜¯ç³»ç»Ÿçš„é‡è¦éƒ¨åˆ†ï¼Œæ‰¿è½½æ•°æ®ã€‚RowGroup ä¸­ï¼Œæ¯ä¸€åˆ—ä¼šæœ‰ä¸€ä¸ªæˆ–å¤šä¸ª Page å­˜åœ¨ã€‚Page ä¼šæœ‰ä¸€ä¸ª PageHeaderï¼Œé‡Œé¢å¯èƒ½åŒ…å« <code>DataPageHeader</code> æˆ–è€… <code>DictionaryPageHeader</code> æˆ–è€… <code>DataPageHeaderV2</code>ï¼Œè€Œ RowGroup æ²¡æœ‰ Headerï¼ŒRowGroup é åç§»é‡æŒ‡å‘æ¯åˆ—çš„ç¬¬ä¸€ä¸ª Pageã€‚å…³äº Page çš„å…¶ä»–ä¿¡æ¯ï¼Œåˆ™å¯ä»¥åœ¨ <code>PageIndex</code> ä¸­æ‰¾åˆ°ï¼Œåæ–‡å†æè¿™äº›ä¿¡æ¯ã€‚</p><p>PageHeader ä¼šæœ‰ä¸€äº› size ä¹‹ç±»çš„å…ƒä¿¡æ¯ï¼Œä¸è¿‡æœ¬èº« RowGroup çš„ Metadata ä¹Ÿæœ‰ä¸€ä»½è¿™äº›ä¿¡æ¯ã€‚</p><p>æ•°æ®å¯èƒ½ä¼šæœ‰ç¼–ç ä¹‹ç±»çš„ï¼ŒEncoding å’Œ Compression éƒ½ä»¥ Page ä¸ºç²’åº¦ï¼Œåœ¨ Page è§£æçš„æ—¶å€™ä¼šè¯»åˆ°å¯¹åº”çš„æ ‡è®°ã€‚ä¸ºä»€ä¹ˆå‘¢ï¼Ÿå› ä¸ºå‹ç¼©çš„æ—¶å€™ï¼Œè¿™é‡Œä¼šæœ‰ä¸€å®šçš„ fallback ç­–ç•¥ï¼Œrow group ä¸ä¸€å®šæœ‰åŒä¸€ä¸ªç­–ç•¥ã€‚</p><p>é‡Œé¢ repetition level å’Œ definition level ä¼šç´§éšåœ¨ Page Header åï¼Œè¿™é‡Œä¹Ÿä¼šæ ‡è¯†ä»–ä»¬çš„é•¿åº¦ï¼Œè¿™ä¸¤åˆ—ä¼šä»¥ RLE å½¢å¼è¢«å‹ç¼©ã€‚ä¹‹åå°±æ˜¯ values çš„å…·ä½“ç¼–ç äº†ã€‚å½“ç„¶ï¼Œè¿™ä¸¤ä¸ªä¸ä¸€å®šä¼šå†™å…¥ï¼š</p><ol><li>å¦‚æœæ²¡æœ‰ nested å®šä¹‰çš„è¯ï¼Œæ˜¯ä¸éœ€è¦ repetition level çš„</li><li>å¦‚æœè·¯å¾„ä¸Šæ²¡æœ‰ nullable çš„å­—æ®µçš„è¯ï¼Œæ˜¯ä¸éœ€è¦ definition level çš„</li></ol><p>å…·ä½“è¯»å–å’Œå†™å…¥çš„æ—¶å€™ï¼Œä¼šæŒ‰ç…§ ColumnChunk ä¸ºå•ä½å†™å…¥ã€‚å…·ä½“è€Œè¨€ï¼ŒPage å°±æ˜¯æŸåˆ— Column Chunk å†…ä¸€æ‰¹æ•°æ®è€Œå·²ã€‚</p><p><strong>ä¾ç…§ ColumnChunk ä¸ºå•ä½å†™å…¥</strong>æ˜¯ä¸€ä¸ªå¾ˆè›‹ç–¼çš„äº‹æƒ…ï¼Œarrow çš„ parquet å®ç°ä¸­ï¼Œæä¾›äº† <code>buffer</code> å’Œé buffer çš„ ioï¼Œå¦‚æœç”¨æˆ·æ˜¯å…ˆå†™å®Œç¬¬ä¸€ä¸ª Columnï¼Œå†å†™ç¬¬äºŒä¸ª Columnï¼Œé‚£ä¹ˆå°±å¯ä»¥ï¼š</p><ol><li>å†™å®Œç¬¬ä¸€ä¸ª Column æ‰€æœ‰å†…å®¹ï¼Œå†™å®Œå¤šä¸ª Pageï¼Œè¿›è¡Œ ioï¼Œå†™åˆ°æ–‡ä»¶ã€‚å½“ç„¶ä¹Ÿå¯ä»¥ä¸€ä¸ªä¸ª Page å†™è¿›å»ã€‚</li><li>ç¬¬äºŒä¸ª Column å¼€å§‹åŒä¸€ä¸ªæ­¥éª¤â€¦</li></ol><p>æ‰€ä»¥å¦‚æœæŒ‰è¡Œæˆ–è€… vectorized data å†™çš„è¯ï¼Œio å…¶å®ä¸å¤ªå¯èƒ½å®Œå…¨æŒ‰ç…§ç¬¬ä¸€ä¸ª Column â€”&gt; ç¬¬äºŒä¸ª Column è¿™æ ·å†™ï¼Œæ‰€ä»¥å®é™…ä¸Šå¯èƒ½æ˜¯ï¼š</p><ol><li>RowGroup æ‰€æœ‰çš„å†™éƒ½ buffer åœ¨å†…å­˜é‡Œ</li><li>ç›‘æµ‹åˆ°è¦åˆ‡ row groupï¼Œç„¶åä¸€èµ· buffer å†™äº†</li></ol><p>è¿™é‡Œè¿˜ä¼šæœ‰ Statisticsï¼ŒåŒ…æ‹¬ Page åŒ…å«å¤šå°‘è¡Œæ•°æ®ã€é‡Œé¢å¯¹åº” min-max ä¸ºä½•ã€‚è¿™éƒ¨åˆ†å…¶å®æœ‰ä¸€éƒ¨åˆ†å’Œ Page Index åŠŸèƒ½æ˜¯é‡å çš„ã€‚</p><h3 id="V1-vs-V2"><a href="#V1-vs-V2" class="headerlink" title="V1 vs V2"></a>V1 vs V2</h3><p>DataPage æœ‰ä¸¤ä¸ªç‰ˆæœ¬ V1 å’Œ V2ï¼Œç›®å‰ï¼Œå¤§éƒ¨åˆ†åœ°æ–¹æ²¡æœ‰å¹¿æ³›ä½¿ç”¨ DataPageV2ã€‚</p><p>è¿™ä¸¤ä¸ªæ ¼å¼ä¸»è¦åŒºåˆ«æ˜¯ rep-level å’Œ def-level çš„å¤„ç†ï¼ŒV1 ä¸­ï¼Œä¸¤ä¸ª level ä¼šå’Œæ•°æ®ä¸€èµ·è¢«å‹ç¼©ï¼›V2 ä¸­ï¼Œä¸¤ä¸ª level å¹¶æœªè¢«å‹ç¼©ã€‚æ­¤å¤–è¿˜æœ‰äº›æ¯”è¾ƒå¾®å°çš„åŒºåˆ«ï¼Œå…·ä½“å¯ä»¥çœ‹ thrift çš„å®šä¹‰äº†ã€‚</p><p>åœ¨å†…å­˜ä¸­ï¼ŒDataPage å†…å­˜å­˜å‚¨æ–¹å¼éƒ½æ˜¯ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(optional çš„ 16ä½æ•°ç»„) rep-levels</span><br><span class="line">(optional çš„ 16ä½æ•°ç»„) def-levels</span><br><span class="line">data</span><br></pre></td></tr></table></figure><p>levels çš„é•¿åº¦ç”± Header æ¥æ ‡è¯†ã€‚</p><h3 id="åˆ‡åˆ†-Data-amp-Page"><a href="#åˆ‡åˆ†-Data-amp-Page" class="headerlink" title="åˆ‡åˆ† Data &amp; Page"></a>åˆ‡åˆ† Data &amp; Page</h3><p>å®˜æ–¹å¯ä»¥æ ¹æ® Row Group Size (æ¨è 512M - 1GB) å’Œ Page Sizeï¼ˆæ¨è 8kBï¼‰æ¥åˆ‡åˆ†ã€‚å€¼å¾—ä¸€æçš„æ˜¯ï¼Œæ„Ÿè§‰è¿™ä¸ªæ ¼å¼åŸºæœ¬æ²¡åš Random Access ä¼˜åŒ–ï¼Œè¯»å–éƒ½æ˜¯ Page ä¸ºå•ä½çš„ã€‚</p><h3 id="CRC32"><a href="#CRC32" class="headerlink" title="CRC32"></a>CRC32</h3><p>Page ä¼šå¯¹ã€Œä¸Šé¢çš„æ•°æ®ã€åš crcï¼ŒPage æœ¬èº«ä¸ä¼šåš CRCã€‚</p><p>å¦å¤–ï¼Œæˆ‘ç¿»äº†ä¸€ä¸‹ç»å¤§å¤šæ•°å®ç°ï¼Œæˆªè‡³ 2022.10.19ï¼Œparquet-mr åªæœ‰ DataPageV1 å’Œ Dictionary Page ä¼šå†™ CRCï¼ŒC++/Rust ç‰ˆæœ¬åŸºæœ¬éƒ½æ²¡å†™ crcã€‚è€ƒè™‘åˆ°ä¹‹å‰å¾ˆå¤šåœ°æ–¹è½åœ¨ S3 / HDFS ä¸Šï¼Œå…¶å®å¯ä»¥ç†è§£ï¼Œä½†å¼•å…¥äº†æœ¬åœ° SSD ç¼“å­˜ä¹‹åï¼Œææ€•æ²¡æœ‰ CRC çœŸçš„å°±æ­»è·¯ä¸€æ¡äº†ï¼Œç¬”è€…æ­£åœ¨ç»™ C++ æ ‡å‡†çš„ Parquet å®ç° crcã€‚</p><h2 id="Encoding"><a href="#Encoding" class="headerlink" title="Encoding"></a>Encoding</h2><p>Parquet å®˜æ–¹è§„å®šçš„ encoding æ•°é‡ä¸å¤šï¼Œè€Œä¸”å®ç°çœ‹ä¸Šå»æœ‰ç‚¹å¤§ç—…ã€‚æ¯”å¦‚å­—å…¸çš„å®ç°æ˜¯ï¼š</p><ol><li>å…ˆæ­»å‘½å¾€å­—å…¸é‡Œæ”¾</li><li>å­—å…¸ç©ºé—´è¿‡å¤§äº†å°± fallback åˆ° PLAIN<ol><li>è¿™ä¸ªåœ°æ–¹ fallback åˆ° PLAIN è¿™ä¸ªè¯´æ³•æ¯”è¾ƒè®©äººå›°æƒ‘ï¼Œå› ä¸ºæ¯ä¸ª ColumnChunk (RowGroup å†…çš„å•ä¸ª Column) æ˜¯åªæœ‰ä¸€ä¸ªå­—å…¸é¡µçš„ï¼Œè¿™é‡Œç¼–ç çš„æ—¶å€™ï¼Œä¼šä¸æ–­å¾€å­—å…¸é‡Œé¢æ·»åŠ å†…å®¹ï¼Œç„¶åä¹‹å‰çš„é¡µé¢ä¼šç¼“å­˜ä¸‹æ¥ã€‚å¦‚æœå‘ç°è¿‡å¤§ï¼Œè¿™é‡Œä¼šå†™å®Œä¹‹å‰çš„å­—å…¸ + æ•°æ®é¡µé¢</li></ol></li></ol><p>çœ‹ä¸Šå»å°±å¾ˆå‚»é€¼ã€‚</p><p>ä¸è¿‡ï¼Œæœ‰çš„åœ°æ–¹å­—å…¸ä¼šè§„å®šæ˜¯æœ‰åºçš„ï¼ŒParquet å¹¶æ²¡æœ‰è§„å®šå­—å…¸æœ¬èº«æ˜¯æœ‰åºçš„ï¼Œä½†åœ¨å­—å…¸é¡µé¢ä¸Šæä¾›äº†</p><p>ç¼–ç çš„æ ¼å¼è§ï¼š<a href="https://github.com/apache/parquet-format/blob/master/Encodings.md">https://github.com/apache/parquet-format/blob/master/Encodings.md</a></p><ul><li><p>PLAIN æ ¼å¼ï¼šå•¥éƒ½æ²¡æœ‰ï¼Œç›´æ¥å†™æ•°æ®</p><ul><li>å…³äºå˜é•¿çš„å­—æ®µï¼Œè¿™é‡Œä¼šæœ‰ BYTE_ARRAY: å†™4B -&gt; å†™æ•°æ®</li></ul></li><li>å­—å…¸ä¼šæœ‰ <code>PLAIN_DICTIONARY</code> å’Œ <code>RLE_DICTIONARY</code>ã€‚å­—å…¸å‹ç¼©æœ¬èº«ä¼šå‹å®Œä¸€åˆ—ï¼Œç„¶ååœ¨<strong>æ•°æ®é¡µä¹‹å‰</strong>ä¼šæœ‰å­—å…¸é¡µï¼Œå­—å…¸é¡µæ¨èç”¨ PLAIN æ ¼å¼ã€‚<ul><li>åŒä¸€ä¸ª ColumnChunk å…±ç”¨ä¸€ä¸ªå­—å…¸ï¼Œä½†æ˜¯å¯èƒ½é‡Œé¢æœ‰çš„é¡µé¢ä¸ç”¨å­—å…¸ç¼–ç ã€‚</li></ul></li><li>RLE: parquet æ¨èçš„æ˜¯ RLE + Bit-packing æ··åˆæ¨¡å¼ï¼Œè¿™ä¸ªåœ°æ–¹æ˜¯ã€Œèµ° RLE æˆ–è€…èµ° bit-packingã€ï¼Œè¿™æ®µåœ¨ RFC é‡Œé¢ä»‹ç»éå¸¸é¬¼ç•œï¼Œå»ºè®®æ‰¾ä»£ç æ³¨é‡Šè¯»ã€‚</li><li>DELTA: å…ˆèµ° deltaï¼Œå†èµ° bit-packingï¼Œæ•°æ®åœ¨ bit-packing å±‚ä¼šè¢«å‹åˆ°ä¸€å † miniblocks é‡Œé¢</li><li>Delta-length byte array: Delta ç¼–ç ä»¥ä¸‹æ‰€æœ‰å­—ç¬¦çš„<strong>é•¿åº¦</strong>ï¼Œå†æŠŠå†…å®¹æ‹¼è´´</li><li>Delta Strings: å‰ç¼€å‹ç¼©</li></ul><p>å…³äºç¼–ç çš„é€‰æ‹©ï¼Œparquet æ²¡æœ‰åšä»»ä½•å®ç°å’Œè§„å®šï¼Œå»ºè®®è¿è¡Œçš„æ—¶å€™ xjb é€‰å§ã€‚Encoding çš„æ ¼å¼ä¼šæ ‡æ³¨åœ¨ Page çš„é‡Œé¢ï¼Œå› ä¸ºå¯èƒ½åŒä¸€ä¸ª ColumnChunk çš„ä¸åŒ Page ç¼–ç æ–¹å¼ä¸ä¸€æ ·ã€‚</p><h2 id="Page-Index"><a href="#Page-Index" class="headerlink" title="Page Index"></a>Page Index</h2><p><img src="https://image.mwish.me/blog-image/PageIndexLayout.png" alt="PageIndexLayout"></p><p>æˆ‘ä»¬æ³¨æ„åˆ°ï¼ŒMetadata åªæœ‰ rowgroup å±‚é¢çš„ä¿¡æ¯ï¼ŒPage å±‚é¢çš„ä½ç½®å’Œå¤§å°ï¼Œéƒ½éœ€è¦èµ° PageIndexã€‚è¿™ä¸ªå¯ä»¥åšä¸€äº›ç»†ç²’åº¦çš„è£å‰ªã€‚ Metadata çš„ Column ä¸­ï¼Œä¼šæœ‰åœ°æ–¹æŒ‡å‘è¿™å‡ æ®µã€‚</p><p>PageIndex å¸Œæœ›è®©ç‚¹æŸ¥ã€Range Scan on sorting columnsã€Selection èƒ½å¤Ÿä»¥è·³è¿‡ä¸éœ€è¦æ‰«æ Page çš„æ–¹å¼èŠ‚çœ IO / è®¡ç®—çš„èµ„æºï¼Œ<em>åŒæ—¶ full scan ä¸ç”¨æ‰«æè¿™éƒ¨åˆ†æ•°æ®ï¼Œè®©è¿™éƒ¨åˆ†å°½é‡æ²¡æœ‰å¼€é”€</em></p><p>PageIndex æè¿°åœ¨ FileMetaData ä¹‹å‰ï¼Œä¹Ÿå°±æ˜¯æ¥è¿‘æ–‡ä»¶å°¾éƒ¨çš„åœ°æ–¹ã€‚</p><p>PageIndex æ˜¯ä»¥æ–‡ä»¶ä¸­æ•´ä¸ª Column ä¸ºç²’åº¦çš„æ•°æ®ï¼ŒPageIndex åŒ…å«ä¸¤ä¸ªéƒ¨åˆ†ï¼šColumnIndex å’Œ OffsetIndex:</p><ol><li>ColumnIndex ä¼šæ ‡å¿—æŸä¸ª RowGroup çš„æŸä¸ª Column  å†…çš„å„ä¸ª Page çš„ Range ä¿¡æ¯ï¼ŒåŒ…æ‹¬ min-max ã€‚<ol><li>è¿™é‡Œæœ‰ç‚¹ç±»ä¼¼ RocksDBï¼Œæ¯åˆ—å¯ä»¥å­˜æ”¾å‹ç¼©çš„å€¼ï¼Œæ¯”å¦‚ â€œabâ€ â€œdbâ€ å¯ä»¥å­˜ â€œaâ€ â€œdâ€.</li><li>Statistics çš„é—®é¢˜è§ <code>Sort Order</code> ä¸€èŠ‚ï¼Œå…¶å®ç›®å‰çš„å®ç°è¿˜æ˜¯æœ‰æ¯”è¾ƒå¤§é—®é¢˜çš„.</li></ol></li><li>OffsetIndex ä¼šæ ‡è®°å„ä¸ª RowGroup å¯¹åº”çš„ Page çš„åç§»é‡</li></ol><p>è¿™éƒ¨åˆ†çš„ Page ç±»å‹ä¸º <code>INDEX_PAGE</code>, å¯¹åº” thrift ç»“æ„å¦‚ä¸‹ï¼š</p><figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">struct PageLocation &#123;</span><br><span class="line">  <span class="comment">/** Offset of the page in the file **/</span></span><br><span class="line">  <span class="number">1</span>: <span class="keyword">required</span> i64 offset</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Size of the page, including header. Sum of compressed_page_size and header</span></span><br><span class="line"><span class="comment">   * length</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="number">2</span>: <span class="keyword">required</span> i32 compressed_page_size</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Index within the RowGroup of the first row of the page; this means pages</span></span><br><span class="line"><span class="comment">   * change on record boundaries (r = 0).</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="number">3</span>: <span class="keyword">required</span> i64 first_row_index</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">struct OffsetIndex &#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * PageLocations, ordered by increasing PageLocation.offset. It is required</span></span><br><span class="line"><span class="comment">   * that page_locations[i].first_row_index &lt; page_locations[i+1].first_row_index.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="number">1</span>: <span class="keyword">required</span> list&lt;PageLocation&gt; page_locations</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Description for ColumnIndex.</span></span><br><span class="line"><span class="comment"> * Each &lt;array-field&gt;[i] refers to the page at OffsetIndex.page_locations[i]</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">struct ColumnIndex &#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * A list of Boolean values to determine the validity of the corresponding</span></span><br><span class="line"><span class="comment">   * min and max values. If true, a page contains only null values, and writers</span></span><br><span class="line"><span class="comment">   * have to set the corresponding entries in min_values and max_values to</span></span><br><span class="line"><span class="comment">   * byte[0], so that all lists have the same length. If false, the</span></span><br><span class="line"><span class="comment">   * corresponding entries in min_values and max_values must be valid.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="number">1</span>: <span class="keyword">required</span> list&lt;<span class="type">bool</span>&gt; null_pages</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Two lists containing lower and upper bounds for the values of each page</span></span><br><span class="line"><span class="comment">   * determined by the ColumnOrder of the column. These may be the actual</span></span><br><span class="line"><span class="comment">   * minimum and maximum values found on a page, but can also be (more compact)</span></span><br><span class="line"><span class="comment">   * values that do not exist on a page. For example, instead of storing &quot;&quot;Blart</span></span><br><span class="line"><span class="comment">   * Versenwald III&quot;, a writer may set min_values[i]=&quot;B&quot;, max_values[i]=&quot;C&quot;.</span></span><br><span class="line"><span class="comment">   * Such more compact values must still be valid values within the column&#x27;s</span></span><br><span class="line"><span class="comment">   * logical type. Readers must make sure that list entries are populated before</span></span><br><span class="line"><span class="comment">   * using them by inspecting null_pages.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="number">2</span>: <span class="keyword">required</span> list&lt;binary&gt; min_values</span><br><span class="line">  <span class="number">3</span>: <span class="keyword">required</span> list&lt;binary&gt; max_values</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Stores whether both min_values and max_values are orderd and if so, in</span></span><br><span class="line"><span class="comment">   * which direction. This allows readers to perform binary searches in both</span></span><br><span class="line"><span class="comment">   * lists. Readers cannot assume that max_values[i] &lt;= min_values[i+1], even</span></span><br><span class="line"><span class="comment">   * if the lists are ordered.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="number">4</span>: <span class="keyword">required</span> BoundaryOrder boundary_order</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** A list containing the number of null values for each page **/</span></span><br><span class="line">  <span class="number">5</span>: <span class="keyword">optional</span> list&lt;i64&gt; null_counts</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ«çš„å­—æ®µéƒ½æ¯”è¾ƒç®€å•ï¼Œ<code>boundary_order</code> ä¸“é—¨è®°å½•äº† Page Index çš„é¡ºåºæ€§ã€‚è‡³å°‘æ˜¯ RowGroup å†…çš„é¡ºåºæ€§ã€‚</p><h2 id="BloomFilter"><a href="#BloomFilter" class="headerlink" title="BloomFilter"></a>BloomFilter</h2><p><img src="https://image.mwish.me/blog-image/FileLayoutBloomFilter1.png" alt="FileLayoutBloomFilter1"></p><p>BloomFilter å®˜æ–¹å®ç°æœ‰ä¸¤ç§ä½ç½®ã€‚å®˜æ–¹æœ‰ä¸€ä¸ª RowGroup çš„ BloomFilterï¼Œå¯¹éœ€è¦æ„å»ºçš„åˆ—æ„å»º BFã€‚å€¼å¾—ä¸€æçš„æ˜¯ï¼Œä»£ç å®ç°ä¸­ï¼Œè¿™é‡Œéœ€è¦æå‰ guess ï¼ˆæˆ–è€…é¢„çŸ¥ï¼‰è¡Œæ•°ï¼Œæ¥æå‰åˆ†é… BloomFilterã€‚</p><p>è¿™é‡Œçš„ BloomFilter ç®—æ³•å’Œ RocksDB çš„ç±»ä¼¼ï¼Œå…·ä½“æ•°å­¦å¯ä»¥å‚è€ƒï¼š<a href="https://github.com/facebook/rocksdb/wiki/RocksDB-Bloom-Filter#the-math">https://github.com/facebook/rocksdb/wiki/RocksDB-Bloom-Filter#the-math</a> . ä¸è¿‡çœ‹äº†ä¸€ä¸‹ä»£ç åï¼Œæ„Ÿè§‰ RocksDB åšçš„è¦ç»†å¾ˆå¤šã€‚</p><h2 id="Nested-Structure-and-NULL-Serde"><a href="#Nested-Structure-and-NULL-Serde" class="headerlink" title="Nested Structure and NULL: Serde"></a>Nested Structure and NULL: Serde</h2><p>nested å’Œ null éƒ½æ˜¯é  definition level å’Œ repitition level æ¥å®Œæˆçš„ã€‚å¯¹äºä¸¤ä¸ª levelï¼Œè¿™é‡Œä¼šç”¨ <code>RLE</code> è¿›è¡Œç¼–ç ï¼Œç„¶åå­˜æ”¾åœ¨ Page ä¸Šï¼Œæ¯ä¸ª Page åŒ…å«çš„é€»è¾‘å†…å®¹å¤§æ¦‚æ˜¯ï¼š</p><ol><li>Page Header</li><li>Repitition Levels</li><li>Definition Levels</li><li>å…·ä½“çš„å€¼</li></ol><p>ç»™ä¸€ä¸ª <code>Dremel</code> è®ºæ–‡ä¸­çš„ schema å®šä¹‰ï¼š</p><figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">message </span><span class="title class_">Document</span> &#123;</span><br><span class="line">  <span class="keyword">required</span> <span class="type">int64</span> DocId;</span><br><span class="line">  <span class="keyword">optional</span> <span class="keyword">group</span> Links &#123;</span><br><span class="line">    <span class="keyword">repeated</span> <span class="type">int64</span> Backward;</span><br><span class="line">    <span class="keyword">repeated</span> <span class="type">int64</span> Forward; </span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">repeated</span> <span class="keyword">group</span> Name &#123;</span><br><span class="line">    <span class="keyword">repeated</span> <span class="keyword">group</span> Language &#123;</span><br><span class="line">      <span class="keyword">required</span> <span class="type">string</span> Code;</span><br><span class="line">      <span class="keyword">optional</span> <span class="type">string</span> Country; </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">optional</span> <span class="type">string</span> Url; </span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Repetition-Levels"><a href="#Repetition-Levels" class="headerlink" title="Repetition Levels"></a>Repetition Levels</h3><p>å…ˆ repetition levels, è¿™é‡Œåªéœ€è¦ä¿å­˜æœ‰å€¼çš„å­—æ®µï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">DocId</span><br><span class="line">Links.Backward</span><br><span class="line">Links.Forward</span><br><span class="line">Name.Language.Code</span><br><span class="line">Name.Language.Country</span><br><span class="line">Name.Url</span><br></pre></td></tr></table></figure><p>repeatable çš„å­—æ®µæ˜¯ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Links.Backward</span><br><span class="line">Links.Forward</span><br><span class="line">Name</span><br><span class="line">Name.Language</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œå¯¹äºä¸€ä¸ª <code>Name.Language.Code</code>ï¼Œå®ƒæ—¢å¯èƒ½æ˜¯å±äº<strong>æ–°çš„ Name</strong> , ä¹Ÿå¯èƒ½å±äº <code>Name</code> ä¸‹æ–°çš„ Languageã€‚ é‚£ä¹ˆï¼Œå¯¹äº <code>repetition</code> æ¥è¯´ï¼Œå°±æ˜¯ã€Œå®ƒåœ¨å“ªä¸ªçº§åˆ« repeat äº†ã€ã€‚</p><p>é‚£ä¹ˆï¼Œå¦‚æœæ˜¯æŸä¸ªå€¼ã€Œçˆ¶äº²ä¸å­˜åœ¨ï¼Œå¯¼è‡´åº”è¯¥å­˜åœ¨çš„å€¼ä¸å­˜åœ¨ã€çš„è¯ï¼Œæ¯”å¦‚ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Document &#123;</span><br><span class="line">  DocId: ...,</span><br><span class="line">  Name: ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ—¶å€™ï¼ŒLinkID æ˜¯æ®‹ç¼ºçš„ï¼Œè¿™é‡Œå¯ä»¥è¡¥ä¸€ä¸ª <code>NULL</code> çš„è™šæ‹Ÿè®°å½•ï¼Œç„¶åæ ‡æ³¨ä¸€ä¸‹ r å°±å¯ä»¥äº†</p><h3 id="definition-levels"><a href="#definition-levels" class="headerlink" title="definition levels"></a>definition levels</h3><p>å¯¹äºæŸä¸ªå­—æ®µï¼Œå®ƒçš„è·¯å¾„ä¸Šæœ‰å¤šå°‘å€¼æ˜¯ã€Œå¯ä»¥ä¸å­˜åœ¨ã€çš„ï¼Œå¯ä»¥ä¸å­˜åœ¨å³ Schema å®šä¹‰ä¸º nullable æˆ–è€… repeated çš„å­—æ®µã€‚è¿™ä¸ªå­—æ®µä¹ŸåŒ…æ‹¬è‡ªèº«ï¼ˆå¦‚æœè‡ªå·±æ˜¯ nullable æˆ–è€… repeatable çš„è¯ï¼‰ã€‚è¿™ä¸ªè·¯å¾„ä¹Ÿéœ€è¦ç†è§£ä¸€ä¸‹ï¼š</p><ol><li>å¯¹äºéåµŒå¥—çš„å­—æ®µï¼Œå¦‚æœå®ƒæ˜¯ä¸ª optional çš„ï¼Œä¸”ä¸º nullï¼Œé‚£ä¹ˆè‡ªå·±çš„ definition levels å°±ä¸º 0ï¼Œå¦åˆ™ä¸º 1</li><li>åµŒå¥—çš„å­—æ®µå–å†³äºçˆ¶çº§å¯¹åº”çš„å­—æ®µï¼Œ<em>parentçš„ä¸€è¡Œ</em> æ•°æ®çš„æŸä¸€åˆ—è‡³å°‘æœ‰ä¸€ä¸ª d (è¿™è¯æœ‰ç‚¹æ¨¡ç³Šï¼Œæˆ‘æŒ‡çš„æ˜¯ï¼Œå¦‚æœçˆ¶äº²æ˜¯ nullï¼Œè¿™ç©æ„ä¹Ÿå¾—å¸¦ä¸ª dï¼Œè™½ç„¶è¿™è¡Œæ•°æ®ä¸å­˜åœ¨)</li></ol><p><img src="https://image.mwish.me/blog-image/C4B586F5-3356-4CCD-AC3B-A9D22E671185.png" alt="C4B586F5-3356-4CCD-AC3B-A9D22E671185"></p><h3 id="ç¼–ç å’Œè§£ç "><a href="#ç¼–ç å’Œè§£ç " class="headerlink" title="ç¼–ç å’Œè§£ç "></a>ç¼–ç å’Œè§£ç </h3><p>è¿™é‡Œå¯ä»¥çœ‹åˆ°ï¼Œå…¶å®ä¸æ˜¯æ‰€æœ‰å­—æ®µéƒ½éœ€è¦ r/d çš„ï¼Œæ¯”å¦‚ DocId å°±å¯ä»¥éƒ½ä¸è¦ï¼›<code>Name.Language</code> å¯ä»¥ä¸è¦ <code>d</code>ã€‚ç„¶åè¿™ä¸ªç¼–ç è¿˜æ˜¯æœ‰çˆ¶å­å±‚æ¬¡çš„æ¦‚å¿µçš„ï¼Œæ¯”å¦‚æœ‰å‡ æ¡ <code>Name.Language.Country</code> å–å†³æœ‰å‡ æ¡ <code>Name.Language</code>ï¼Œè¿™ä¸ªè®°å½•å¯ä»¥çœ‹çœ‹æˆ‘ä»¬å‰é¢çš„å®šä¹‰å’Œ Schema å®šä¹‰ã€‚Parquet è¯»è€…åœ¨è¯»çš„æ—¶å€™ä¼šåˆ›å»ºä¸€ä¸ª Struct å¯¹åº”çš„ Readerï¼Œæ¥é€’å½’è¯»å–ã€‚ </p><p>ç¼–ç çš„ç®—æ³•å¤§æ¦‚å¦‚ä¸‹ï¼š</p><ol><li>é¦–å…ˆï¼Œä¼šæ ¹æ® Schema æ„å»ºå‡ºä¸€é¢—æ ‘ï¼Œæ¥è¡¨ç¤ºå¯¹åº”çš„ç»“æ„ã€‚è¿™ä¸ªæ ‘çš„æ„å»ºæ–¹å¼ä½¿ç”¨ dfsï¼Œå¤§æ¦‚å¦‚ä¸‹ï¼š</li></ol><p><img src="https://image.mwish.me/blog-image/schema.png" alt="schema"></p><ol><li>å¯¹æ„å»ºå‡ºæ¥çš„æ ‘æ‰«æçš„æ—¶å€™ï¼Œå¸¦ä¸Š r, dï¼Œç„¶åæ„å»º</li></ol><p>æˆ‘ä»¬è®¨è®ºä¸€äº›ç‰¹æ®Šæƒ…å†µï¼š</p><ol><li>å¦‚æœæ­£å¸¸çš„ä¸€æ¡è·¯å¾„å…¨éƒ¨æ²¡æœ‰ nullï¼Œé‚£ä¹ˆ <code>d = è·¯å¾„ä¸Š(åŒ…æ‹¬è‡ªå·±) nullable å’Œ repeatable çš„æ•°é‡</code>ï¼Œ<code>r = è·¯å¾„ä¸Š(åŒ…æ‹¬è‡ªå·±) repeated ä¸­çš„æŸä¸€ä¸ª</code>ã€‚ r å’Œ d éƒ½æ˜¯ æ˜¯ã€Œè‡ªå·±çº§åˆ«çš„ maxã€</li><li>å¦‚æœä¸€ä¸ªè·¯å¾„<strong>è‡ªå·±</strong>æ˜¯ nullï¼Œçˆ¶äº²ä¸å« nullï¼Œé‚£ä¹ˆ <code>d = è·¯å¾„ä¸Š(åŒ…æ‹¬è‡ªå·±) nullable å’Œ repeatable çš„æ•°é‡ - 1</code>ï¼Œå³ <strong>çˆ¶äº²çš„ dï¼Œæˆ–è€…ä¸Šä¸€ä¸ª nullable / repeatable å¯¹è±¡çš„ d</strong>ï¼Œr å’Œ (1) åˆ™ä¸€æ ·ï¼Œ<strong>ä½†æœ€å¤§æ˜¯ä¸€æ ·çš„</strong>ï¼Œéƒ½æ˜¯ã€Œè‡ªå·±çº§åˆ«çš„ rep-maxã€</li><li>ä» 1/2 å…¶å®å¯ä»¥çœ‹å‡ºæ¥ï¼Œnull å¯ä»¥é€šè¿‡ d æ¥ç¡®å®šï¼Œd å¦‚æœå°äºè·¯å¾„ä¸Š nullable/repeatable å€¼æ€»æ•°ï¼Œå°±å¯ä»¥æ˜¯ Null</li><li>å¦‚æœæŸä¸ªè·¯å¾„çˆ¶äº²æ˜¯ nullï¼Œé‚£ä¹ˆ d ä¼šæ›´å°ï¼Œd ä¼šç­‰äºé null çˆ¶çº§çš„ dï¼Œr åˆ™æ˜¯çˆ¶äº²çº§åˆ«æœ€å¤§çš„ rã€‚ç›¸å½“äºæŸä¸ªçº§åˆ«å¼€å§‹ä¸ºç©ºçš„è¯ï¼Œd ä¼šæ˜¯çˆ¶çº§åˆ«çš„ d-maxï¼Œr ä¼šæ˜¯è‡ªå·±çš„ r</li></ol><p>ä¸Šé¢è¿™äº›å†…å®¹éå¸¸é‡è¦ï¼Œå› ä¸º arrow çš„ä»£ç å®é™…ä¸Šæ˜¯é è¿™å¥—è§„åˆ™æ¥å®ç°çš„ã€‚</p><h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ol><li><p>Google Dremelæ•°æ®æ¨¡å‹è¯¦è§£(ä¸Š) <a href="http://static.kancloud.cn/digest/in-memory-computing/202157">http://static.kancloud.cn/digest/in-memory-computing/202157</a></p></li><li><p>Google Dremelæ•°æ®æ¨¡å‹è¯¦è§£(ä¸‹) <a href="http://static.kancloud.cn/digest/in-memory-computing/202158">http://static.kancloud.cn/digest/in-memory-computing/202158</a></p></li><li><p><a href="https://blog.twitter.com/engineering/en_us/a/2013/dremel-made-simple-with-parquet">https://blog.twitter.com/engineering/en_us/a/2013/dremel-made-simple-with-parquet</a></p></li><li><p>ä¸“é—¨è§£é‡Š Parquet / Dremel æ ¼å¼çš„æ–‡ç« ï¼š<a href="https://github.com/julienledem/redelm/wiki/The-striping-and-assembly-algorithms-from-the-Dremel-paper">https://github.com/julienledem/redelm/wiki/The-striping-and-assembly-algorithms-from-the-Dremel-paper</a></p></li><li><p>Rust ç‰ˆæœ¬çš„ Parquet ä¸ºäº†è§£é‡Šå‘äº†å‡ ç¯‡æ–‡ç« ï¼Œå…¶å®ä»‹ç»çš„æ¯”è¾ƒå¥½ï¼š</p><ol><li>Arrow and Parquet Part 1: Primitive Types and Nullability: <a href="https://arrow.apache.org/blog/2022/10/05/arrow-parquet-encoding-part-1/">https://arrow.apache.org/blog/2022/10/05/arrow-parquet-encoding-part-1/</a></li><li>Arrow and Parquet Part 2: Nested and Hierarchical Data using Structs and Lists: <a href="https://arrow.apache.org/blog/2022/10/08/arrow-parquet-encoding-part-2/">https://arrow.apache.org/blog/2022/10/08/arrow-parquet-encoding-part-2/</a></li></ol></li></ol><p>è¿˜æœ‰ä¸€äº›äºŒæ‰‹è¯„è®ºï¼š</p><ol><li><a href="https://zhuanlan.zhihu.com/p/25206176">https://zhuanlan.zhihu.com/p/25206176</a></li><li><a href="https://zhuanlan.zhihu.com/p/25206199">https://zhuanlan.zhihu.com/p/25206199</a></li></ol>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>brpc bthread execution-queue</title>
      <link href="/2022/07/26/brpc-execution-queue/"/>
      <url>/2022/07/26/brpc-execution-queue/</url>
      
        <content type="html"><![CDATA[<p>Execution Queue æœ€æ—©æ˜¯ brpc ä¸­ï¼Œå¤šä¸ªçº¿ç¨‹å¾€ä¸€ä¸ª fd å†™æ•°æ®çš„æ—¶å€™ä½¿ç”¨çš„ï¼Œè¿™é‡Œçš„éœ€æ±‚æ˜¯ï¼š</p><ol><li>æ¯ä¸ªå†™åº”è¯¥ä¸²è¡Œçš„å®Œæˆ</li><li>ä¼šæœ‰å¹¶å‘çš„å†™.</li></ol><p>Execution Queue ä¼šæ¥å—ç”¨æˆ·æŠ•é€’çš„ä»»åŠ¡, æŠ•é€’å®Œæˆä¹‹å, ç”¨æˆ·çº¿ç¨‹å°±ç›´æ¥è¿”å›äº†, ç„¶åè‡ªå·±æŠŠä»»åŠ¡åšå®Œ, å¯èƒ½è¦é ç”¨æˆ·çš„ callback æ¥é€šçŸ¥ç”¨æˆ·å®Œæˆ. åœ¨å†…éƒ¨, ä»»åŠ¡ä¼šç»™ç»™æŠ•é€’ç»™å®ƒçš„ä»»åŠ¡ç»„ batch, ä»»åŠ¡ submit ç»™ä¸€ä¸ªçº¿ç¨‹å¼‚æ­¥ batch å¤„ç†.</p><p>æ­¤å¤–, bthread çš„ execution queue è¿˜æ”¯æŒ cancel ä»»åŠ¡å’Œè°ƒåº¦é«˜ä¼˜å…ˆçº§çš„ä»»åŠ¡.</p><h2 id="Usage"><a href="#Usage" class="headerlink" title="Usage"></a>Usage</h2><p><code>src/bthread/execution_queue.h</code> æè¿°äº†å¦‚ä½•ä½¿ç”¨ execution queue, è¿™äº›ä¸œè¥¿ä¹Ÿå¯ä»¥åœ¨é¡¹ç›®<a href="https://github.com/apache/incubator-brpc/blob/master/docs/cn/execution_queue.md">æ–‡æ¡£</a>é‡Œçœ‹åˆ°.</p><p>è¿™é‡Œå¯ä»¥ç®€å•ä»‹ç»ä¸€ä¸‹è¿™ä¸ªæµç¨‹ï¼Œå¤§æ¦‚è¦å®ç°ä¸€ä¸ª Batch çš„ <code>demo_execute</code> å‡½æ•°ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// Iterate over the given tasks</span></span><br><span class="line"><span class="comment">// </span></span><br><span class="line"><span class="comment">// Examples:</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">user_fn</span><span class="params">(T)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">demo_execute</span><span class="params">(<span class="type">void</span>* meta, TaskIterator&lt;T&gt;&amp; iter)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (iter.<span class="built_in">is_queue_stopped</span>()) &#123;</span><br><span class="line">        <span class="comment">// destroy meta and related resources</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (; iter; ++iter) &#123;</span><br><span class="line">        <span class="comment">// user_fn(*iter)</span></span><br><span class="line">        <span class="comment">// or user_fn(iter-&gt;a_member_of_T)</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œ <code>T</code> æ˜¯ç”¨æˆ·å®šä¹‰çš„ task éœ€è¦å¤„ç†çš„å¯¹è±¡çš„ç±»å‹ã€‚è¿™ä¸ªæœ‰ç‚¹ç»•ï¼Œå› ä¸ºä½ è¿˜è¦å®šä¹‰ <code>demo_execute</code> æ¥å¤„ç†ä¸€ä¸ª batch çš„ä»»åŠ¡ï¼Œå’Œ <code>TaskIterator</code> äº¤äº’ã€‚ä¸¾ä¸ªä¾‹å­ç†è§£ä¸‹ï¼Œæ¯”å¦‚è¯´ï¼Œå¯¹äºç”¨æˆ·çš„ IO å†™åŒä¸€ä¸ª fd çš„ä»»åŠ¡ï¼Œbrpc å®šä¹‰äº†ä¸€ä¸ª <code>T = butil::IOBuf*</code> çš„ä¾‹å­ï¼Œæ¥å¤„ç† IO ç›¸å…³çš„éœ€æ±‚. å…¶å®è¿™ä¸ªå°±å¾ˆå¥½ç†è§£äº†å§ã€‚</p><h3 id="Execution-Queue-çš„ç”Ÿå‘½å‘¨æœŸ"><a href="#Execution-Queue-çš„ç”Ÿå‘½å‘¨æœŸ" class="headerlink" title="Execution Queue çš„ç”Ÿå‘½å‘¨æœŸ"></a>Execution Queue çš„ç”Ÿå‘½å‘¨æœŸ</h3><p>Execution Queue æœ¬èº«ä¼šåœ¨ bthread ä¸­æ‰§è¡Œï¼Œbthread æœ¬èº«æ˜¯æœ‰ä¸€å †å‚æ•°çš„ï¼Œqueue ä¼šæœ‰ä¸€å †å‚æ•°ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">ExecutionQueueOptions</span> &#123;</span><br><span class="line">    <span class="built_in">ExecutionQueueOptions</span>();</span><br><span class="line">    <span class="comment">// Attribute of the bthread which execute runs on</span></span><br><span class="line">    <span class="comment">// default: BTHREAD_ATTR_NORMAL</span></span><br><span class="line">    <span class="type">bthread_attr_t</span> bthread_attr;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Executor that tasks run on. bthread will be used when executor = NULL.</span></span><br><span class="line">    <span class="comment">// Note that TaskOptions.in_place_if_possible = false will not work, if implementation of</span></span><br><span class="line">    <span class="comment">// Executor is in-place(synchronous).</span></span><br><span class="line">    Executor * executor;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ª <code>Executor</code> æ˜¯ä¸€ä¸ª ç”¨æˆ·å®šä¹‰çš„ Executorï¼Œç”¨æˆ·å¯ä»¥å®šä¹‰åœ¨è‡ªå·±çš„çº¿ç¨‹æ± ä¹‹ç±»çš„æ¥æ‰§è¡Œï¼Œä¸è¿‡å¦‚æœç”¨æˆ·è‡ªå·±å®šä¹‰äº†ä¸€ä¸ª Executorï¼Œæ¯”å¦‚ç»‘äº†ä¸ª folly çš„ <code>Executor</code> ç„¶åä¸¢ç»™ folly æ‰§è¡Œï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// Start a ExecutionQueue. If |options| is NULL, the queue will be created with</span></span><br><span class="line"><span class="comment">// the default options. </span></span><br><span class="line"><span class="comment">// Returns 0 on success, errno otherwise</span></span><br><span class="line"><span class="comment">// <span class="doctag">NOTE:</span> type |T| can be non-POD but must be copy-constructible</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">execution_queue_start</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        ExecutionQueueId&lt;T&gt;* id, </span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">const</span> ExecutionQueueOptions* options,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">int</span> (*execute)(<span class="type">void</span>* meta, TaskIterator&lt;T&gt;&amp; iter),</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">void</span>* meta)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">execution_queue_stop</span><span class="params">(ExecutionQueueId&lt;T&gt; id)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">execution_queue_join</span><span class="params">(ExecutionQueueId&lt;T&gt; id)</span></span>;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢ä»»åŠ¡æœ‰ start, stop, å’Œ joinã€‚åŸºæœ¬ä¸Šæ˜¯ä¸€ä¸ªå®Œæ•´çš„æµç¨‹ã€‚<code>ExecutionQueueId&lt;T&gt;</code> æ˜¯ç±»ä¼¼ <code>bthread_id</code> ä¸€æ ·çš„å¼•ç”¨ï¼Œå…³äºè¿™ä¸ªç»“æ„ï¼Œå…¶å®å¯ä»¥å‚è€ƒ brpc çš„ memory-management æ–‡æ¡£ï¼š<a href="https://github.com/apache/incubator-brpc/blob/master/docs/cn/memory_management.md">https://github.com/apache/incubator-brpc/blob/master/docs/cn/memory_management.md</a> ã€‚è¿™é‡ŒåŸºæœ¬ä¸Šæ˜¯ 4B åœ°å€ + 4B ç‰ˆæœ¬å·ã€‚</p><h3 id="æäº¤ä»»åŠ¡"><a href="#æäº¤ä»»åŠ¡" class="headerlink" title="æäº¤ä»»åŠ¡"></a>æäº¤ä»»åŠ¡</h3><p>æäº¤ä»»åŠ¡æœ‰ä¸‹åˆ—çš„ API:</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Thread-safe and Wait-free.</span></span><br><span class="line"><span class="comment">// Execute a task with options. e.g</span></span><br><span class="line"><span class="comment">// bthread::execution_queue_execute(queue, task, &amp;bthread::TASK_OPTIONS_URGENT)</span></span><br><span class="line"><span class="comment">// If |options| is NULL, we will use default options (normal task)</span></span><br><span class="line"><span class="comment">// If |handle| is not NULL, we will assign it with the handler of this task.</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">execution_queue_execute</span><span class="params">(ExecutionQueueId&lt;T&gt; id, </span></span></span><br><span class="line"><span class="params"><span class="function">                            <span class="keyword">typename</span> butil::add_const_reference&lt;T&gt;::type task,</span></span></span><br><span class="line"><span class="params"><span class="function">                            <span class="type">const</span> TaskOptions* options)</span></span>;</span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">execution_queue_execute</span><span class="params">(ExecutionQueueId&lt;T&gt; id, </span></span></span><br><span class="line"><span class="params"><span class="function">                            <span class="keyword">typename</span> butil::add_const_reference&lt;T&gt;::type task,</span></span></span><br><span class="line"><span class="params"><span class="function">                            <span class="type">const</span> TaskOptions* options,</span></span></span><br><span class="line"><span class="params"><span class="function">                            TaskHandle* handle)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// [Thread safe and ABA free] Cancel the corresponding task.</span></span><br><span class="line"><span class="comment">// Returns:</span></span><br><span class="line"><span class="comment">//  -1: The task was executed or h is an invalid handle</span></span><br><span class="line"><span class="comment">//  0: Success</span></span><br><span class="line"><span class="comment">//  1: The task is executing </span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">execution_queue_cancel</span><span class="params">(<span class="type">const</span> TaskHandle&amp; h)</span></span>;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œ <code>execution_queue_execute</code> å¯ä»¥ä¼ å…¥ä¸€ä¸ªå‚æ•°ï¼Œå¸¦ä¸Šä¸€ä¸ª <code>TaskOptions</code>ï¼Œä¹Ÿå¯ä»¥æ‹¿åˆ°ä¸€ä¸ª <code>TaskHandle</code>ï¼Œè¿™ä¸ª handle å¯ä»¥ç”¨æ¥å–æ¶ˆä»»åŠ¡ã€‚ä¸‹é¢åœ¨ <code>TaskOptions</code> è¿˜æœ‰ä¸€äº›æ‰§è¡Œç›¸å…³çš„å‚æ•°ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">TaskOptions</span> &#123;</span><br><span class="line">    <span class="built_in">TaskOptions</span>();</span><br><span class="line">    <span class="built_in">TaskOptions</span>(<span class="type">bool</span> high_priority, <span class="type">bool</span> in_place_if_possible);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Executor would execute high-priority tasks in the FIFO order but before </span></span><br><span class="line">    <span class="comment">// all pending normal-priority tasks.</span></span><br><span class="line">    <span class="comment">// <span class="doctag">NOTE:</span> We don&#x27;t guarantee any kind of real-time as there might be tasks still</span></span><br><span class="line">    <span class="comment">// in process which are uninterruptible.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// Default: false </span></span><br><span class="line">    <span class="type">bool</span> high_priority;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If |in_place_if_possible| is true, execution_queue_execute would call </span></span><br><span class="line">    <span class="comment">// execute immediately instead of starting a bthread if possible</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// Note: Running callbacks in place might cause the dead lock issue, you</span></span><br><span class="line">    <span class="comment">// should be very careful turning this flag on.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// Default: false</span></span><br><span class="line">    <span class="type">bool</span> in_place_if_possible;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">static</span> TaskOptions TASK_OPTIONS_NORMAL = <span class="built_in">TaskOptions</span>(<span class="literal">false</span>, <span class="literal">false</span>);</span><br><span class="line"><span class="type">const</span> <span class="type">static</span> TaskOptions TASK_OPTIONS_URGENT = <span class="built_in">TaskOptions</span>(<span class="literal">true</span>, <span class="literal">false</span>);</span><br><span class="line"><span class="type">const</span> <span class="type">static</span> TaskOptions TASK_OPTIONS_INPLACE = <span class="built_in">TaskOptions</span>(<span class="literal">false</span>, <span class="literal">true</span>);</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å¯¹åº”çš„ä¼˜å…ˆçº§å’Œ <code>inplace</code> ï¼Œ<code>inplace</code> ä¼šåœ¨å‰å°æ‰§è¡Œï¼Œ<code>high_priority</code> ä¼šæŠ•é€’åˆ°é«˜ä¼˜æ‰§è¡Œï¼Œä¸è¿‡è¿™é‡Œè¿˜æ»¡è¶³ä¸²è¡ŒåŒ–çš„è¯­ä¹‰ã€‚</p><p>è¿™é‡Œ <code>cancel</code> æ¥å£æœ‰ç‚¹è®©äººå›°æƒ‘ï¼Œæ²¡æœ‰è¢«æ‰§è¡Œçš„ä»»åŠ¡å¯ä»¥è¢« <code>cancel</code>ï¼Œè¿™ä¸ªå¾—å¯¹ç€ä»£ç æ¥ç†è§£äº†ã€‚</p><h2 id="å®ç°"><a href="#å®ç°" class="headerlink" title="å®ç°"></a>å®ç°</h2><h3 id="ä»ç”¨æˆ·æäº¤ä»»åŠ¡åˆ°-lock-free-çš„æ·»åŠ åˆ°ä»»åŠ¡åˆ—è¡¨"><a href="#ä»ç”¨æˆ·æäº¤ä»»åŠ¡åˆ°-lock-free-çš„æ·»åŠ åˆ°ä»»åŠ¡åˆ—è¡¨" class="headerlink" title="ä»ç”¨æˆ·æäº¤ä»»åŠ¡åˆ° lock-free çš„æ·»åŠ åˆ°ä»»åŠ¡åˆ—è¡¨"></a>ä»ç”¨æˆ·æäº¤ä»»åŠ¡åˆ° lock-free çš„æ·»åŠ åˆ°ä»»åŠ¡åˆ—è¡¨</h3><p>è¿™é‡Œçš„å®ç°å¯ä»¥åœ¨ <code>execution_queue_inl.h</code> å’Œ <code>execution_queue.cc</code> é‡Œé¢ï¼Œå…³é”®ç±»å‹å¦‚ä¸‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">ExecutionQueueId</span> &#123;</span><br><span class="line">    <span class="type">uint64_t</span> value;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä»»åŠ¡çš„çŠ¶æ€</span></span><br><span class="line"><span class="keyword">enum</span> <span class="title class_">TaskStatus</span> &#123;</span><br><span class="line">    UNEXECUTED = <span class="number">0</span>,</span><br><span class="line">    EXECUTING = <span class="number">1</span>,</span><br><span class="line">    EXECUTED = <span class="number">2</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">TaskNode</span>;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ExecutionQueueBase</span>;</span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">void</span> <span class="params">(*clear_task_mem)</span><span class="params">(TaskNode*)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">BAIDU_CACHELINE_ALIGNMENT</span> TaskNode;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ExecutionQueue</span> : <span class="keyword">public</span> ExecutionQueueBase;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TaskIteratorBase</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TaskIterator</span> : <span class="keyword">public</span> TaskIteratorBase;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><code>ExecutionQueue</code> åŒ…äº†ä¸€å±‚ <code>ExecutionQueueBase</code>ï¼Œ<code>ExecutionQueueBase</code> çš„ç»“æ„å¦‚ä¸‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">BAIDU_CACHELINE_ALIGNMENT</span> ExecutionQueueBase &#123;</span><br><span class="line"><span class="built_in">DISALLOW_COPY_AND_ASSIGN</span>(ExecutionQueueBase);</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Forbidden</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Don&#x27;t change the order of _head, _versioned_ref and _stopped unless you </span></span><br><span class="line">    <span class="comment">// see improvement of performance in test</span></span><br><span class="line">    butil::atomic&lt;TaskNode*&gt; BAIDU_CACHELINE_ALIGNMENT _head; <span class="comment">// FIFO çš„å•é˜Ÿåˆ—, è¿™æ˜¯é˜Ÿåˆ—çš„å°¾éƒ¨, é€šè¿‡ cas æ¥ enqueue.</span></span><br><span class="line">    butil::atomic&lt;<span class="type">uint64_t</span>&gt; BAIDU_CACHELINE_ALIGNMENT _versioned_ref; <span class="comment">// æ•´ä¸ªå¯¹åˆ—çš„ _versioned_ref è®¡æ•°å™¨, ç”¨æ¥å¤„ç† aba é—®é¢˜.</span></span><br><span class="line">    butil::atomic&lt;<span class="type">bool</span>&gt; BAIDU_CACHELINE_ALIGNMENT _stopped; <span class="comment">// é˜Ÿåˆ—æ˜¯å¦è¢«å¤–éƒ¨åœæ­¢.</span></span><br><span class="line">    butil::atomic&lt;<span class="type">int64_t</span>&gt; _high_priority_tasks; <span class="comment">// é«˜ä¼˜ä»»åŠ¡è®¡æ•°å™¨, å¯¹åˆ—å’Œæ‰§è¡Œé‡Œæœ‰ä»»ä½•é«˜ä¼˜ä»»åŠ¡éƒ½ä¼šæ·»åŠ è¿™ä¸ªè®¡æ•°å™¨.</span></span><br><span class="line">    <span class="type">uint64_t</span> _this_id;</span><br><span class="line">    <span class="type">void</span>* _meta; <span class="comment">// ç”¨æˆ·å®šä¹‰çš„, ç»‘å®šåˆ°æ•´ä¸ª queue çš„æˆå‘˜, ä½œä¸º execution_func çš„å‚æ•°.</span></span><br><span class="line">    <span class="type">void</span>* _type_specific_function; <span class="comment">// å¯¹åº”ç”¨æˆ·çš„ execution_func</span></span><br><span class="line">    <span class="type">execute_func_t</span> _execute_func; <span class="comment">// ç”¨æˆ·æä¾›çš„æ‰§è¡Œå‡½æ•°</span></span><br><span class="line">    clear_task_mem _clear_func; <span class="comment">// æ¸…é™¤ Task ä¸Šçš„ä¸œè¥¿(ç”¨æˆ·æä¾›) å’Œ Task æŒ‚çš„èŠ‚ç‚¹çš„å†…å­˜.</span></span><br><span class="line">    ExecutionQueueOptions _options;</span><br><span class="line">    butil::atomic&lt;<span class="type">int</span>&gt;* _join_butex;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><code>ExecutionQueueBase</code> è¢«å®ç°æˆä¸€ä¸ªç±»ä¼¼æ ˆçš„ç»“æ„ï¼Œæˆ‘ä¹Ÿè¯´ä¸æ¸…æ˜¯æ ˆè¿˜æ˜¯é˜Ÿåˆ—ï¼Œå› ä¸ºè¿™ä¸ªåœ°æ–¹ enqueue ç±»ä¼¼æ ˆï¼Œå¤„ç†ç±»ä¼¼é˜Ÿåˆ—ã€‚</p><p>è¿™é‡Œçš„å…¥å£æ˜¯:</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">int</span> <span class="title">execution_queue_execute</span><span class="params">(ExecutionQueueId&lt;T&gt; id, </span></span></span><br><span class="line"><span class="params"><span class="function">                       <span class="keyword">typename</span> butil::add_const_reference&lt;T&gt;::type task,</span></span></span><br><span class="line"><span class="params"><span class="function">                       <span class="type">const</span> TaskOptions* options,</span></span></span><br><span class="line"><span class="params"><span class="function">                       TaskHandle* handle)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">typename</span> ExecutionQueue&lt;T&gt;::<span class="type">scoped_ptr_t</span> </span><br><span class="line">        ptr = ExecutionQueue&lt;T&gt;::<span class="built_in">address</span>(id);</span><br><span class="line">    <span class="keyword">if</span> (ptr != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> ptr-&gt;<span class="built_in">execute</span>(task, options, handle);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> EINVAL;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯ä»¥æ¢³ç†ä¸€ä¸‹æ‰§è¡Œçš„é“¾è·¯ï¼š</p><ol><li><code>execution_queue_execute</code> : ç”¨æˆ·æäº¤ä»»åŠ¡åˆ°æŸä¸ª execution queueï¼Œæ´¾å‘ç»™ <code>ExecutionQueue&lt;T&gt;</code> è°ƒç”¨ <code>execute</code>ï¼Œæ¥å…·ä½“æ‰§è¡Œ</li><li>åœ¨ <code>ExecutionQueue&lt;T&gt;::execute</code> ä¸­ï¼Œè¿™é‡Œä¼šé’ˆå¯¹ <code>T</code> åˆ›å»ºå¯¹åº”çš„ <code>TaskNode</code>ï¼Œåˆå§‹åŒ–å†…å­˜å’Œèµ„æºï¼Œç„¶åæŠ•é€’ç»™ <code>ExecutionQueueBase::start_execute</code></li></ol><p>é‚£ä¹ˆèµ°åˆ°æœ€é‡è¦çš„å†…å®¹ <code>ExecutionQueueBase</code> äº†ï¼Œåˆšåˆšæˆ‘ä»¬çœ‹åˆ°äº†ï¼Œå®ƒæœ‰ä¸ª <code>head_</code> æˆå‘˜ï¼Œæ˜¯ä¸ª <code>atomic&lt;TaskNode*&gt;</code>ï¼Œç„¶åè¿˜æœ‰ <code>_high_priority_tasks</code> å’Œ <code>_stopped</code> è¡¨ç¤º â€œæ˜¯å¦æœ‰é«˜ä¼˜æ“ä½œâ€ å’Œ â€œæ˜¯å¦è¢«åœæ­¢â€ã€‚è¿™ä¸¤ä¸ªé…ç½®å’Œ <code>start_execute</code> ç­‰å‡½æ•°å°±æ˜¯è¿™ä¸ªç»“æ„çš„æ ¸å¿ƒäº†ã€‚æˆ‘ä»¬æ¥ç€çœ‹ä»£ç ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//! åˆ›å»ºå¥½ä»»åŠ¡å, ä¼šæŠ•é€’åˆ° start_execute æ¥å¤„ç†</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ExecutionQueueBase::start_execute</span><span class="params">(TaskNode* node)</span> </span>&#123;</span><br><span class="line">    node-&gt;next = TaskNode::UNCONNECTED;</span><br><span class="line">    node-&gt;status = UNEXECUTED;</span><br><span class="line">    node-&gt;iterated = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// _high_priority_tasks æ˜¯è¡¨ç¤ºæ­£åœ¨æ‰§è¡Œçš„/ç­‰å¾…çš„ä»»åŠ¡æ˜¯å¦æœ‰é«˜ä¼˜å…ˆçº§ä»»åŠ¡.</span></span><br><span class="line">    <span class="keyword">if</span> (node-&gt;high_priority) &#123;</span><br><span class="line">        <span class="comment">// Add _high_priority_tasks before pushing this task into queue to</span></span><br><span class="line">        <span class="comment">// make sure that _execute_tasks sees the newest number when this </span></span><br><span class="line">        <span class="comment">// task is in the queue. Although there might be some useless for </span></span><br><span class="line">        <span class="comment">// loops in _execute_tasks if this thread is scheduled out at this </span></span><br><span class="line">        <span class="comment">// point, we think it&#x27;s just fine.</span></span><br><span class="line">        _high_priority_tasks.<span class="built_in">fetch_add</span>(<span class="number">1</span>, butil::memory_order_relaxed);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ‹¿åˆ°ä¸Šä¸€æ¬¡çš„ prev_head, è¿™ä¸ªæ—¶å€™, ç«é€‰è¦æ±‚åªæœ‰ prev_head æ˜¯ nullptr çš„æ—¶å€™,</span></span><br><span class="line">    <span class="comment">// æ‰èƒ½æˆä¸º group çš„ leader.</span></span><br><span class="line">    <span class="comment">// è¿™é‡Œå¦‚æœæ²¡æœ‰æˆä¸º group çš„ leader, ä¼šåœ¨è¿™é‡Œå †ç§¯.</span></span><br><span class="line"></span><br><span class="line">    TaskNode* <span class="type">const</span> prev_head = _head.<span class="built_in">exchange</span>(node, butil::memory_order_release);</span><br><span class="line">    <span class="keyword">if</span> (prev_head != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        node-&gt;next = prev_head;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Group çš„ Leader æœ‰æƒé™æ‰§è¡Œä»»åŠ¡.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// Get the right to execute the task, start a bthread to avoid deadlock</span></span><br><span class="line">    <span class="comment">// or stack overflow</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// å› ä¸ºæ˜¯ leader, å®ƒçš„ next åº”è¯¥æ˜¯ null.</span></span><br><span class="line">    node-&gt;next = <span class="literal">NULL</span>;</span><br><span class="line">    node-&gt;q = <span class="keyword">this</span>;</span><br><span class="line"></span><br><span class="line">    ExecutionQueueVars* <span class="type">const</span> vars = <span class="built_in">get_execq_vars</span>();</span><br><span class="line">    vars-&gt;execq_active_count &lt;&lt; <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (node-&gt;in_place) &#123; <span class="comment">// å¦‚æœæ˜¯ in-place, é‚£ä¹ˆåœ¨æœ¬çº¿ç¨‹(bthread) æ‰§è¡Œ.</span></span><br><span class="line">        <span class="type">int</span> niterated = <span class="number">0</span>;</span><br><span class="line">        _execute(node, node-&gt;high_priority, &amp;niterated);</span><br><span class="line">        TaskNode* tmp = node;</span><br><span class="line">        <span class="comment">// return if no more</span></span><br><span class="line">        <span class="comment">// å¦‚æœæ˜¯é«˜ä¼˜ä»»åŠ¡, é‚£ä¹ˆå¤„ç†ä¸€ä¸‹</span></span><br><span class="line">        <span class="keyword">if</span> (node-&gt;high_priority) &#123;</span><br><span class="line">            _high_priority_tasks.<span class="built_in">fetch_sub</span>(niterated, butil::memory_order_relaxed);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å¦‚æœæœ‰ more_tasks, åˆ‡åˆ°åˆ«çš„çº¿ç¨‹æ‰§è¡Œè¿™ä¸ª group.</span></span><br><span class="line">        <span class="keyword">if</span> (!_more_tasks(tmp, &amp;tmp, !node-&gt;iterated)) &#123;</span><br><span class="line">            vars-&gt;execq_active_count &lt;&lt; <span class="number">-1</span>;</span><br><span class="line">            <span class="built_in">return_task_node</span>(node);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ ¹æ® executor æ¥æ‰§è¡Œ, è¿™ä¸ªæ—¶å€™æ‰§è¡Œæ—¶å€™çš„ `node` æ˜¯é˜Ÿé¦–.</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">nullptr</span> == _options.executor) &#123;</span><br><span class="line">        <span class="comment">// åœ¨åå°çº¿ç¨‹ä¸­, ä½¿ç”¨ _execute_tasks æ¥æ‰§è¡Œ.</span></span><br><span class="line">        <span class="type">bthread_t</span> tid;</span><br><span class="line">        <span class="comment">// We start the execution thread in background instead of foreground as</span></span><br><span class="line">        <span class="comment">// we can&#x27;t determine whether the code after execute() is urgent (like</span></span><br><span class="line">        <span class="comment">// unlock a pthread_mutex_t) in which case implicit context switch may</span></span><br><span class="line">        <span class="comment">// cause undefined behavior (e.g. deadlock)</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">// åœ¨ background ä¸­æ‰§è¡Œ (<span class="doctag">TODO:</span> è¿™ä¸ªåœ°æ–¹ä¼šä¸¢è¿›é˜Ÿåˆ—å—?)</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">bthread_start_background</span>(&amp;tid, &amp;_options.bthread_attr,</span><br><span class="line">                                     _execute_tasks, node) != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">PLOG</span>(FATAL) &lt;&lt; <span class="string">&quot;Fail to start bthread&quot;</span>;</span><br><span class="line">            _execute_tasks(node);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// submit å¼‚æ­¥æ‰§è¡Œ.</span></span><br><span class="line">        <span class="keyword">if</span> (_options.executor-&gt;<span class="built_in">submit</span>(_execute_tasks, node) != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">PLOG</span>(FATAL) &lt;&lt; <span class="string">&quot;Fail to submit task&quot;</span>;</span><br><span class="line">            _execute_tasks(node);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªä»£ç æ¯”è¾ƒé•¿ï¼Œæ…¢æ…¢æ¥ï¼š</p><ol><li>å¦‚æœæ˜¯é«˜ä¼˜ä»»åŠ¡ï¼Œæ·»åŠ é«˜ä¼˜çš„ counterï¼Œæ‰§è¡Œçº¿ç¨‹ä¼šæ£€æµ‹åˆ°è¿™ä¸ª counterï¼Œæ¥åšä¸€äº›ç‰¹æ®Šå¤„ç†</li><li>é€šè¿‡ <code>_head.exchange(node, butil::memory_order_release)</code> æ¥å‘æ ˆä¸­æ¨è¿›å†…å®¹ï¼Œ<code>_head</code> ä¸º 0 çš„æ—¶å€™ï¼Œè®¾ç½®æˆåŠŸçš„èƒ½å¤Ÿæˆä¸ºè¿™ä¸ª group çš„ leaderï¼Œåœ¨è¿™ä¸ª bthread æˆ–è€…çº¿ç¨‹ä¸‹æ‰§è¡Œï¼Œå¦åˆ™è¿”å›ç¨‹åº</li><li>(ä»è¿™é‡Œå¼€å§‹éƒ½æ˜¯ Leader çš„è¡Œä¸º) æ ¹æ® <code>in_place</code> ç­‰å‚æ•°ï¼Œå†³å®šå°±åœ°æ‰§è¡Œè¿˜æ˜¯å¼‚æ­¥æ‰§è¡Œï¼Œæ´¾å‘ç»™ <code>_execute_tasks</code></li></ol><p>åœ¨ <code>_execute_tasks</code> é‡Œé¢æœ‰ä¸ªå¤§å¾ªç¯ï¼Œæ¯æ¬¡ä¼šæŠŠæœ¬ä¸ª batch å°½é‡æ‰§è¡Œå®Œï¼ˆä¸ºä»€ä¹ˆæ˜¯å°½é‡å‘¢ï¼Œæ¥ç€çœ‹ï¼‰ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// è°ƒç”¨ execute æ¥æ‰§è¡Œå¯¹åº”çš„ä»»åŠ¡, è¿™æ˜¯ä¸€ä¸ª static å‡½æ•°, éœ€è¦åˆç†å¤„ç†é«˜ä¼˜å…ˆçº§ä»»åŠ¡.</span></span><br><span class="line"><span class="type">void</span>* ExecutionQueueBase::_execute_tasks(<span class="type">void</span>* arg) &#123;</span><br><span class="line">    ExecutionQueueVars* vars = <span class="built_in">get_execq_vars</span>();</span><br><span class="line">    TaskNode* head = (TaskNode*)arg;</span><br><span class="line">    ExecutionQueueBase* m = (ExecutionQueueBase*)head-&gt;q;</span><br><span class="line">    TaskNode* cur_tail = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="type">bool</span> destroy_queue = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœé˜Ÿåˆ—å¤´å·²ç»æ‰§è¡Œè¿‡, é‚£ä¹ˆåˆ‡ä¸€ä¸ªé˜Ÿåˆ—å¤´(move next), ç„¶åæŠŠä¹‹å‰çš„é˜Ÿåˆ—å¤´</span></span><br><span class="line">        <span class="comment">// å¤„ç†.</span></span><br><span class="line">        <span class="keyword">if</span> (head-&gt;iterated) &#123;</span><br><span class="line">            <span class="built_in">CHECK</span>(head-&gt;next != <span class="literal">NULL</span>);</span><br><span class="line">            TaskNode* saved_head = head;</span><br><span class="line">            head = head-&gt;next;</span><br><span class="line">            m-&gt;<span class="built_in">return_task_node</span>(saved_head);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">int</span> rc = <span class="number">0</span>;</span><br><span class="line">        <span class="comment">// å¦‚æœæœ‰é«˜ä¼˜å…ˆçº§ä»»åŠ¡, è°ƒç”¨ _execute ç›´æ¥å¤„ç†é«˜ä¼˜ä»»åŠ¡, å¦‚æœæ²¡æœ‰é«˜ä¼˜ä»»åŠ¡, è°ƒåº¦èµ°ç­‰å¾…</span></span><br><span class="line">        <span class="comment">//  æŠ•é€’è¿›æ¥ç»§ç»­ç»„ batch.</span></span><br><span class="line">        <span class="keyword">if</span> (m-&gt;_high_priority_tasks.<span class="built_in">load</span>(butil::memory_order_relaxed) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="type">int</span> nexecuted = <span class="number">0</span>;</span><br><span class="line">            <span class="comment">// Don&#x27;t care the return value (å› ä¸ºä¸ä¼šæ‰§è¡Œåˆ° stop).</span></span><br><span class="line">            rc = m-&gt;_execute(head, <span class="literal">true</span>, &amp;nexecuted);</span><br><span class="line">            <span class="comment">// å‡å°‘å¯¹åº”çš„é«˜ä¼˜ä»»åŠ¡æ•°é‡</span></span><br><span class="line">            m-&gt;_high_priority_tasks.<span class="built_in">fetch_sub</span>(</span><br><span class="line">                    nexecuted, butil::memory_order_relaxed);</span><br><span class="line">            <span class="comment">// å¦‚æœ nexecuted == 0, è°ƒåº¦èµ°, ç­‰å¾…ä»»åŠ¡è¢«å¡åˆ°æ‰§è¡Œé˜Ÿåˆ—.</span></span><br><span class="line">            <span class="keyword">if</span> (nexecuted == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// Some high_priority tasks are not in queue</span></span><br><span class="line">                <span class="built_in">sched_yield</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// æ²¡æœ‰é«˜ä¼˜ä»»åŠ¡, æ‰§è¡Œç°æœ‰çš„è¿™æ‰¹.</span></span><br><span class="line">            rc = m-&gt;_execute(head, <span class="literal">false</span>, <span class="literal">NULL</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// æ˜¯å¦æ”¶åˆ° stop å¯¹è±¡.</span></span><br><span class="line">        <span class="keyword">if</span> (rc == ESTOP) &#123;</span><br><span class="line">            destroy_queue = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Release TaskNode until uniterated task or last task</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">// é‡Šæ”¾æ‰ç°åœ¨æ‰€æœ‰çš„æ‰§è¡Œè¿‡çš„å†…å®¹, ä¸è¿‡è¿™é‡Œåªæ˜¯è¿ç»­é‡Šæ”¾, ç›´åˆ°æœ‰ uniterated çš„å¯¹è±¡.</span></span><br><span class="line">        <span class="keyword">while</span> (head-&gt;next != <span class="literal">NULL</span> &amp;&amp; head-&gt;iterated) &#123;</span><br><span class="line">            TaskNode* saved_head = head;</span><br><span class="line">            head = head-&gt;next;</span><br><span class="line">            m-&gt;<span class="built_in">return_task_node</span>(saved_head);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// åˆ°è¿™ä¸ª batch çš„å°¾éƒ¨.</span></span><br><span class="line">        <span class="keyword">if</span> (cur_tail == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (cur_tail = head; cur_tail-&gt;next != <span class="literal">NULL</span>; </span><br><span class="line">                    cur_tail = cur_tail-&gt;next) &#123;&#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// break when no more tasks and head has been executed</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">// æŠŠåŠ è¿›æ¥çš„å’Œå·²æœ‰çš„ç»„æˆä¸€ä¸ªæ–°çš„ Batch, cur_tail å’Œ &amp;cur_tail è¿™ä¸ªæœ‰ç‚¹è®©äººå›°æƒ‘, å› ä¸ºé˜Ÿåˆ—è¦æ»¡è¶³ FIFO æ¡ä»¶,</span></span><br><span class="line">        <span class="comment">// æŠ•é€’è¿›æ¥çš„åŸæœ¬æ˜¯ T3-&gt;T2-&gt;T1. åœ¨ç¬¬ä¸€ä¸ª batch é‡Œé¢, T1 è®¾ç½®åˆ°äº† head = NULL åˆ° head = T1, æ‰€ä»¥ T1 æ˜¯</span></span><br><span class="line">        <span class="comment">// leader, è¿™ä¸ªæ—¶å€™, cur_tail == T1. old_head == T1, new_tail = &amp;T1(å³ head).</span></span><br><span class="line">        <span class="comment">// å†æ¬¡æ‰§è¡Œå®Œçš„æ—¶å€™, è¿™ä¸ªé˜Ÿåˆ—ä¼šå˜æˆ T3-&gt;T2, ä½†æ˜¯æ‰§è¡Œé¡ºåºæ˜¯ T2-&gt;T3, æ‰€ä»¥, old_head å¯¹åº” T2, new_tail ä¹Ÿåº”è¯¥ä¼ å…¥</span></span><br><span class="line">        <span class="comment">// T2.</span></span><br><span class="line">        <span class="comment">// æœ¬æ¥è¿™é‡Œæ²¡æœ‰é—®é¢˜, ä½†æ˜¯å¯èƒ½ has_uniterated == true, éœ€è¦ç¼åˆä¸¤ä¸ªé˜Ÿåˆ—.</span></span><br><span class="line">        <span class="keyword">if</span> (!m-&gt;_more_tasks(cur_tail, &amp;cur_tail, !head-&gt;iterated)) &#123;</span><br><span class="line">            <span class="built_in">CHECK_EQ</span>(cur_tail, head);</span><br><span class="line">            <span class="built_in">CHECK</span>(head-&gt;iterated);</span><br><span class="line">            m-&gt;<span class="built_in">return_task_node</span>(head);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (destroy_queue) &#123;</span><br><span class="line">        <span class="built_in">CHECK</span>(m-&gt;_head.<span class="built_in">load</span>(butil::memory_order_relaxed) == <span class="literal">NULL</span>);</span><br><span class="line">        <span class="built_in">CHECK</span>(m-&gt;_stopped);</span><br><span class="line">        <span class="comment">// Add _join_butex by 2 to make it equal to the next version of the</span></span><br><span class="line">        <span class="comment">// ExecutionQueue from the same slot so that join with old id would</span></span><br><span class="line">        <span class="comment">// return immediately.</span></span><br><span class="line">        <span class="comment">// </span></span><br><span class="line">        <span class="comment">// 1: release fence to make join sees the newest changes when it sees</span></span><br><span class="line">        <span class="comment">//    the newest _join_butex</span></span><br><span class="line">        m-&gt;_join_butex-&gt;<span class="built_in">fetch_add</span>(<span class="number">2</span>, butil::memory_order_release<span class="comment">/*1*/</span>);</span><br><span class="line">        <span class="built_in">butex_wake_all</span>(m-&gt;_join_butex);</span><br><span class="line">        vars-&gt;execq_count &lt;&lt; <span class="number">-1</span>;</span><br><span class="line">        butil::<span class="built_in">return_resource</span>(<span class="built_in">slot_of_id</span>(m-&gt;_this_id));</span><br><span class="line">    &#125;</span><br><span class="line">    vars-&gt;execq_active_count &lt;&lt; <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>è¿™ä¸ªåœ°æ–¹é€»è¾‘å¦‚ä¸‹ï¼š</p><ol><li>å¤„ç†å·²ç»è¿­ä»£å®Œçš„å†…å®¹, è¿™é‡Œæ¶‰åŠ stop ä¹‹ç±»çš„é€»è¾‘</li><li>è°ƒç”¨ <code>_execute</code> å‡½æ•°ï¼Œæ¥å…·ä½“æ‰§è¡Œè¿™ä¸ª batch</li><li>çœ‹çœ‹æœ‰æ²¡æœ‰æ²¡æ‰§è¡Œå®Œçš„ä»»åŠ¡å’Œæœ€æ–°çš„ä»»åŠ¡ï¼Œèµ° <code>_more_tasks</code></li></ol><p>çœ‹å®¢è¿™ä¸ªåœ°æ–¹å¯èƒ½ä¼šæ€ªæˆ‘å…¨éƒ¨è´´ä»£ç äº†ï¼Œä¸è¿‡è¿™ä¸ªåœ°æ–¹æµç¨‹ç¡®å®åªèƒ½ç¡¬è´´ã€‚å› ä¸º (2) (3) éƒ½æ˜¯æœ‰å·¨å‘çš„</p><h3 id="ç‰¹æ®Šæƒ…å†µï¼šç¬¬ä¸€æ¬¡æ‰§è¡Œ"><a href="#ç‰¹æ®Šæƒ…å†µï¼šç¬¬ä¸€æ¬¡æ‰§è¡Œ" class="headerlink" title="ç‰¹æ®Šæƒ…å†µï¼šç¬¬ä¸€æ¬¡æ‰§è¡Œ"></a>ç‰¹æ®Šæƒ…å†µï¼šç¬¬ä¸€æ¬¡æ‰§è¡Œ</h3><p>è¿˜è®°å¾— <code>_head.exchange</code> ä¸ï¼Œè¿™ä¸ªåœ°æ–¹ç¬¬ä¸€æ¬¡è®¾ç½®æˆåŠŸçš„ <code>Node</code> çš„ <code>next</code> æ˜¯ <code>nullptr</code>ï¼Œç¬¬ä¸€æ¬¡æ‰§è¡Œçš„æ—¶å€™ï¼Œæ•´ä¸ª batch åªæœ‰å®ƒä¸€ä¸ªæˆå‘˜ã€‚</p><h3 id="é«˜ä¼˜å…ˆçº§ä»»åŠ¡çš„å¤„ç†"><a href="#é«˜ä¼˜å…ˆçº§ä»»åŠ¡çš„å¤„ç†" class="headerlink" title="é«˜ä¼˜å…ˆçº§ä»»åŠ¡çš„å¤„ç†"></a>é«˜ä¼˜å…ˆçº§ä»»åŠ¡çš„å¤„ç†</h3><p>æˆ‘ä»¬çœ‹åˆ°ï¼Œ<code>start_execute</code> çš„æ—¶å€™ï¼Œè¿™é‡Œå¦‚æœæ˜¯é«˜ä¼˜ä»»åŠ¡ï¼Œå°±ä¼šæ·»åŠ é«˜ä¼˜çš„ counterï¼Œåœ¨ <code>_execute_tasks</code> çš„å¾ªç¯é‡Œï¼Œæˆ‘ä»¬çœ‹åˆ°è¿™é‡Œæ£€æŸ¥äº†é«˜ä¼˜ä»»åŠ¡:</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> rc = <span class="number">0</span>;</span><br><span class="line"><span class="comment">// å¦‚æœæœ‰é«˜ä¼˜å…ˆçº§ä»»åŠ¡, è°ƒç”¨ _execute ç›´æ¥å¤„ç†é«˜ä¼˜ä»»åŠ¡, å¦‚æœæ²¡æœ‰é«˜ä¼˜ä»»åŠ¡, è°ƒåº¦èµ°ç­‰å¾…</span></span><br><span class="line"><span class="comment">//  æŠ•é€’è¿›æ¥ç»§ç»­ç»„ batch.</span></span><br><span class="line"><span class="keyword">if</span> (m-&gt;_high_priority_tasks.<span class="built_in">load</span>(butil::memory_order_relaxed) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="type">int</span> nexecuted = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// Don&#x27;t care the return value (å› ä¸ºä¸ä¼šæ‰§è¡Œåˆ° stop).</span></span><br><span class="line">    rc = m-&gt;_execute(head, <span class="literal">true</span>, &amp;nexecuted);</span><br><span class="line">    <span class="comment">// å‡å°‘å¯¹åº”çš„é«˜ä¼˜ä»»åŠ¡æ•°é‡</span></span><br><span class="line">    m-&gt;_high_priority_tasks.<span class="built_in">fetch_sub</span>(</span><br><span class="line">            nexecuted, butil::memory_order_relaxed);</span><br><span class="line">    <span class="comment">// å¦‚æœ nexecuted == 0, è°ƒåº¦èµ°, ç­‰å¾…ä»»åŠ¡è¢«å¡åˆ°æ‰§è¡Œé˜Ÿåˆ—.</span></span><br><span class="line">    <span class="keyword">if</span> (nexecuted == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// Some high_priority tasks are not in queue</span></span><br><span class="line">        <span class="built_in">sched_yield</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// æ²¡æœ‰é«˜ä¼˜ä»»åŠ¡, æ‰§è¡Œç°æœ‰çš„è¿™æ‰¹.</span></span><br><span class="line">    rc = m-&gt;_execute(head, <span class="literal">false</span>, <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯ä»¥çœ‹çœ‹ <code>_execute</code> å‡½æ•°çš„ç­¾åï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> ExecutionQueueBase::_execute(TaskNode* head, <span class="type">bool</span> high_priority, <span class="type">int</span>* niterated);</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå¯ä»¥çœ‹åˆ°ï¼Œ<code>_execute</code> é‡Œé¢æœ‰ä¸ª <code>high_priority</code> çš„æ ‡è®°ï¼Œè¿™ä¸ªæ˜¯ç”¨æ¥å¹²ä»€ä¹ˆçš„å‘¢ï¼Ÿæˆ‘ä»¬è¿™é‡Œä»‹ç»ä¸€ä¸‹ï¼Œä¸€ä¸ª Batch åªèƒ½æ‰§è¡Œä¸€ç§ä¼˜å…ˆçº§çš„ä»»åŠ¡ï¼Œè¦ä¹ˆé«˜è¦ä¹ˆä½ã€‚å¦‚æœæ’å…¥äº†ä¸€ä¸ªé«˜ä¼˜ä»»åŠ¡ï¼Œå®ƒè¦å°½é‡åœ¨ä½ä¼˜å…ˆçº§ä»»åŠ¡ä¹‹å‰è¢«æ‰§è¡Œã€‚è¿™é‡Œå¯ä»¥æƒ³è±¡ä¸€ä¸‹æä¾›ç»™ç”¨æˆ·çš„æ¨¡å‹ï¼š</p><ul><li>æœ‰ä¸¤ä¸ªé˜Ÿåˆ—ï¼Œä¸€ä¸ªä½ä¼˜ä¸€ä¸ªé«˜ä¼˜</li><li>executor å¹¶éæ˜¯ã€ŒBatch æ‰§è¡Œã€ï¼Œå®ƒæ˜¯ä¸²è¡Œæ‰§è¡Œçš„ï¼Œä»é«˜ä¼˜çœ‹çœ‹æœ‰æ²¡æœ‰ï¼Œæœ‰å°±æ‰§è¡Œï¼Œå¦åˆ™ä»ä½ä¼˜é˜Ÿåˆ—å–<strong>ä¸€ä¸ª</strong>ä»»åŠ¡æ‰§è¡Œ</li></ul><p>å¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œæ˜¯ä¸€ä¸ªé batch æ‰§è¡Œçš„è¯­ä¹‰ï¼Œè¿™ä¸ª <code>_execute</code> é è®¡æ•°å™¨å®ç°äº†ç±»ä¼¼çš„è¯­ä¹‰ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å…·ä½“æ‰§è¡Œçš„é€»è¾‘, start_execute -&gt; execute_task -&gt; execute.</span></span><br><span class="line"><span class="type">int</span> ExecutionQueueBase::_execute(TaskNode* head, <span class="type">bool</span> high_priority, <span class="type">int</span>* niterated) &#123;</span><br><span class="line">    <span class="comment">// å¦‚æœæ˜¯ä¸€ä¸ª stop task, é‚£ä¹ˆå…·ä½“æ‰§è¡Œ</span></span><br><span class="line">    <span class="keyword">if</span> (head != <span class="literal">NULL</span> &amp;&amp; head-&gt;stop_task) &#123;</span><br><span class="line">        <span class="built_in">CHECK</span>(head-&gt;next == <span class="literal">NULL</span>);</span><br><span class="line">        head-&gt;iterated = <span class="literal">true</span>; <span class="comment">// è®¾ç½®è‡ªèº«ä¸º executed.</span></span><br><span class="line">        head-&gt;status = EXECUTED;</span><br><span class="line">        <span class="comment">// å¦‚æœæ˜¯ stop, é‚£ä¹ˆè¿™é‡Œ `high_priority == false`.</span></span><br><span class="line">        <span class="function">TaskIteratorBase <span class="title">iter</span><span class="params">(<span class="literal">NULL</span>, <span class="keyword">this</span>, <span class="literal">true</span>, <span class="literal">false</span>)</span></span>;</span><br><span class="line">        _execute_func(_meta, _type_specific_function, iter);</span><br><span class="line">        <span class="keyword">if</span> (niterated) &#123;</span><br><span class="line">            *niterated = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ESTOP;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">TaskIteratorBase <span class="title">iter</span><span class="params">(head, <span class="keyword">this</span>, <span class="literal">false</span>, high_priority)</span></span>;</span><br><span class="line">    <span class="keyword">if</span> (iter) &#123;</span><br><span class="line">        _execute_func(_meta, _type_specific_function, iter);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// We must assign |niterated| with num_iterated even if we couldn&#x27;t peek</span></span><br><span class="line">    <span class="comment">// any task to execute at the beginning, in which case all the iterated</span></span><br><span class="line">    <span class="comment">// tasks have been cancelled at this point. And we must return the </span></span><br><span class="line">    <span class="comment">// correct num_iterated() to the caller to update the counter correctly.</span></span><br><span class="line">    <span class="keyword">if</span> (niterated) &#123;</span><br><span class="line">        *niterated = iter.<span class="built_in">num_iterated</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæ¯”è¾ƒé‡è¦çš„å®ç°åœ¨ <code>TaskIteratorBase</code> é‡Œé¢ï¼Œè¿™ä¸ªç±»å‹å®ç°äº†æ ¹æ®ä¼˜å…ˆçº§æ¥åˆ¤æ–­æ˜¯å¦è¦è¿­ä»£çš„é€»è¾‘ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä¼ é€’ç»™ execute å‡½æ•°çš„è¿­ä»£å™¨.</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TaskIteratorBase</span> &#123;</span><br><span class="line"><span class="built_in">DISALLOW_COPY_AND_ASSIGN</span>(TaskIteratorBase);</span><br><span class="line"><span class="keyword">friend</span> <span class="keyword">class</span> <span class="title class_">ExecutionQueueBase</span>;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// Returns true when the ExecutionQueue is stopped and there will never be</span></span><br><span class="line">    <span class="comment">// more tasks and you can safely release all the related resources ever </span></span><br><span class="line">    <span class="comment">// after.</span></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">is_queue_stopped</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> _is_stopped; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">operator</span> <span class="title">bool</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    <span class="built_in">TaskIteratorBase</span>(TaskNode* head, ExecutionQueueBase* queue,</span><br><span class="line">                     <span class="type">bool</span> is_stopped, <span class="type">bool</span> high_priority)</span><br><span class="line">        : _cur_node(head)</span><br><span class="line">        , _head(head)</span><br><span class="line">        , _q(queue)</span><br><span class="line">        , _is_stopped(is_stopped)</span><br><span class="line">        , _high_priority(high_priority)</span><br><span class="line">        , _should_break(<span class="literal">false</span>)</span><br><span class="line">        , _num_iterated(<span class="number">0</span>)</span><br><span class="line">    &#123; <span class="keyword">operator</span>++(); &#125;</span><br><span class="line">    ~<span class="built_in">TaskIteratorBase</span>();</span><br><span class="line">    <span class="type">void</span> <span class="keyword">operator</span>++();</span><br><span class="line">    <span class="function">TaskNode* <span class="title">cur_node</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> _cur_node; &#125;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">num_iterated</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> _num_iterated; &#125;</span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">should_break_for_high_priority_tasks</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    TaskNode*               _cur_node;</span><br><span class="line">    TaskNode*               _head;</span><br><span class="line">    ExecutionQueueBase*     _q; <span class="comment">// ç»‘å®šçš„æ•´ä¸ª queue çš„å¯¹è±¡.</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ³¨: å¦‚æœ _is_stopped == true, _high_pri å¿…å®šä¸º false.</span></span><br><span class="line">    <span class="type">bool</span>                    _is_stopped;</span><br><span class="line">    <span class="type">bool</span>                    _high_priority;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¸‹é¢æ˜¯å†…éƒ¨çš„é€»è¾‘.</span></span><br><span class="line">    <span class="type">bool</span>                    _should_break;</span><br><span class="line">    <span class="type">int</span>                     _num_iterated;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªçš„é‡ç‚¹é€»è¾‘åœ¨ <code>should_break_for_high_priority_tasks</code> é‡Œé¢ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æœ‰é«˜ä¼˜ä»»åŠ¡éœ€è¦æ’é˜Ÿ.</span></span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">bool</span> <span class="title">TaskIteratorBase::should_break_for_high_priority_tasks</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!_high_priority &amp;&amp; </span><br><span class="line">            _q-&gt;_high_priority_tasks.<span class="built_in">load</span>(butil::memory_order_relaxed) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        _should_break = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> TaskIteratorBase::<span class="keyword">operator</span>++() &#123;</span><br><span class="line">    <span class="keyword">if</span> (!(*<span class="keyword">this</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å·²ç» iter çš„ä»»åŠ¡ä¸ç”¨å†å¤„ç†.</span></span><br><span class="line">    <span class="keyword">if</span> (_cur_node-&gt;iterated) &#123;</span><br><span class="line">        _cur_node = _cur_node-&gt;next;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æœ‰é«˜ä¼˜ä»»åŠ¡éœ€è¦æ’é˜Ÿçš„æ—¶å€™, éœ€è¦æš‚æ—¶ break æ‰, ç­‰å¾…é«˜ä¼˜å…ˆçº§ä»»åŠ¡æ‰§è¡Œ.</span></span><br><span class="line">    <span class="comment">// å¦‚æœè¿­ä»£ä¸­å‘ç°æœ‰é«˜ä¼˜å…ˆçº§ä»»åŠ¡, é‚£ä¹ˆè¿™é‡Œä¸å†ä¼šæ‰§è¡Œä»»ä¸€ä¸ª task.</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">should_break_for_high_priority_tasks</span>()) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;  <span class="comment">// else the next high_priority_task would be delayed for at most one task</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ²¡æœ‰é«˜ä¼˜å…ˆçº§ä»»åŠ¡, ç„¶åä¸æ˜¯ stop.</span></span><br><span class="line">    <span class="keyword">while</span> (_cur_node &amp;&amp; !_cur_node-&gt;stop_task) &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœä¼˜å…ˆçº§ç­‰åŒ, é‚£ä¹ˆæ‰§è¡Œ: å¦‚æœæœ‰é«˜ä¼˜å…ˆçº§çš„, ä½ä¼˜å…ˆçº§çš„ä¸ä¼šè¢«æ‰§è¡Œ</span></span><br><span class="line">        <span class="keyword">if</span> (_high_priority == _cur_node-&gt;high_priority) &#123;</span><br><span class="line">            <span class="comment">// å¦‚æœæ²¡æœ‰ iterated, é‚£ä¹ˆæå‡ºæ¥è®¾ç½®ä¸€ä¸‹çŠ¶æ€, ç„¶åè¿”å›.</span></span><br><span class="line">            <span class="keyword">if</span> (!_cur_node-&gt;iterated &amp;&amp; _cur_node-&gt;<span class="built_in">peek_to_execute</span>()) &#123;</span><br><span class="line">                ++_num_iterated;</span><br><span class="line">                _cur_node-&gt;iterated = <span class="literal">true</span>;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            _num_iterated += !_cur_node-&gt;iterated;</span><br><span class="line">            _cur_node-&gt;iterated = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å–ä¸‹ä¸€ä¸ªå¯æ‰§è¡Œçš„ä»»åŠ¡ã€‚</span></span><br><span class="line">        _cur_node = _cur_node-&gt;next;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ç»„ä¸‹ä¸€ä¸ª-batch-çš„é€»è¾‘"><a href="#ç»„ä¸‹ä¸€ä¸ª-batch-çš„é€»è¾‘" class="headerlink" title="ç»„ä¸‹ä¸€ä¸ª batch çš„é€»è¾‘"></a>ç»„ä¸‹ä¸€ä¸ª batch çš„é€»è¾‘</h3><p>ç»„ä¸‹ä¸€ä¸ª batch çš„é€»è¾‘åœ¨ <code>_more_tasks</code> ä¸­ï¼Œä½†æˆ‘ä»¬å¿…é¡»è”åŠ¨ä¸Šä¸€èŠ‚ï¼Œå‡è®¾æŸä¸ª Batch:</p><ol><li>æ‰§è¡Œä½ä¼˜ä»»åŠ¡ï¼Œæœ‰äº”ä¸ªä»»åŠ¡ï¼Œæ‰§è¡Œäº†ä¸‰ä¸ªå‘ç°æœ‰é«˜ä¼˜ä»»åŠ¡æ’é˜Ÿäº†</li><li>æ‰§è¡Œé«˜ä¼˜ä»»åŠ¡ï¼Œæœ‰10ä¸ªä»»åŠ¡ï¼Œä½†æ˜¯åªæœ‰ä¸€ä¸ªé«˜ä¼˜ä»»åŠ¡</li></ol><p>è¿™ä¸ªæ—¶å€™ï¼Œç»„ batch çš„æ—¶å€™ï¼Œå¯èƒ½è‡ªå·±æ‰‹å¤´ä¸Šçš„ batch è¿˜æ²¡æ‰§è¡Œå®Œï¼Œç”¨æˆ·åˆæäº¤äº†ï¼Œè¿™å°±æ¶‰åŠåˆ°ä¸¤ä¸ª batch ç¼åˆï¼Œæˆ‘ä»¬å…ˆçœ‹è°ƒç”¨ <code>_more_tasks</code> çš„åœ°æ–¹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// Release TaskNode until uniterated task or last task</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// é‡Šæ”¾æ‰ç°åœ¨æ‰€æœ‰çš„æ‰§è¡Œè¿‡çš„å†…å®¹, ä¸è¿‡è¿™é‡Œåªæ˜¯è¿ç»­é‡Šæ”¾, ç›´åˆ°æœ‰ uniterated çš„å¯¹è±¡.</span></span><br><span class="line"><span class="keyword">while</span> (head-&gt;next != <span class="literal">NULL</span> &amp;&amp; head-&gt;iterated) &#123;</span><br><span class="line">    TaskNode* saved_head = head;</span><br><span class="line">    head = head-&gt;next;</span><br><span class="line">    m-&gt;<span class="built_in">return_task_node</span>(saved_head);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// åˆ°è¿™ä¸ª batch çš„å°¾éƒ¨.</span></span><br><span class="line"><span class="keyword">if</span> (cur_tail == <span class="literal">NULL</span>) &#123;</span><br><span class="line">    <span class="keyword">for</span> (cur_tail = head; cur_tail-&gt;next != <span class="literal">NULL</span>; </span><br><span class="line">            cur_tail = cur_tail-&gt;next) &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// break when no more tasks and head has been executed</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// æŠŠåŠ è¿›æ¥çš„å’Œå·²æœ‰çš„ç»„æˆä¸€ä¸ªæ–°çš„ Batch, cur_tail å’Œ &amp;cur_tail è¿™ä¸ªæœ‰ç‚¹è®©äººå›°æƒ‘, å› ä¸ºé˜Ÿåˆ—è¦æ»¡è¶³ FIFO æ¡ä»¶,</span></span><br><span class="line"><span class="comment">// æŠ•é€’è¿›æ¥çš„åŸæœ¬æ˜¯ T3-&gt;T2-&gt;T1. åœ¨ç¬¬ä¸€ä¸ª batch é‡Œé¢, T1 è®¾ç½®åˆ°äº† head = NULL åˆ° head = T1, æ‰€ä»¥ T1 æ˜¯</span></span><br><span class="line"><span class="comment">// leader, è¿™ä¸ªæ—¶å€™, cur_tail == T1. old_head == T1, new_tail = &amp;T1(å³ head).</span></span><br><span class="line"><span class="comment">// å†æ¬¡æ‰§è¡Œå®Œçš„æ—¶å€™, è¿™ä¸ªé˜Ÿåˆ—ä¼šå˜æˆ T3-&gt;T2, ä½†æ˜¯æ‰§è¡Œé¡ºåºæ˜¯ T2-&gt;T3, æ‰€ä»¥, old_head å¯¹åº” T2, new_tail ä¹Ÿåº”è¯¥ä¼ å…¥</span></span><br><span class="line"><span class="comment">// T2.</span></span><br><span class="line"><span class="comment">// æœ¬æ¥è¿™é‡Œæ²¡æœ‰é—®é¢˜, ä½†æ˜¯å¯èƒ½ has_uniterated == true, éœ€è¦ç¼åˆä¸¤ä¸ªé˜Ÿåˆ—.</span></span><br><span class="line"><span class="keyword">if</span> (!m-&gt;_more_tasks(cur_tail, &amp;cur_tail, !head-&gt;iterated)) &#123;</span><br><span class="line">    <span class="built_in">CHECK_EQ</span>(cur_tail, head);</span><br><span class="line">    <span class="built_in">CHECK</span>(head-&gt;iterated);</span><br><span class="line">    m-&gt;<span class="built_in">return_task_node</span>(head);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæ ¹æ®ä»»åŠ¡æœ‰æ²¡æœ‰æ‰§è¡Œå®Œï¼Œè®¾ç½®äº†ä¸åŒçš„ <code>cur_tail</code> æ¥å¤„ç†ã€‚ç„¶åæˆ‘ä»¬çœ‹ <code>_more_tasks</code>:</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">inline</span> <span class="type">bool</span> ExecutionQueueBase::_more_tasks(</span><br><span class="line">        TaskNode* old_head, TaskNode** new_tail, </span><br><span class="line">        <span class="type">bool</span> has_uniterated) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">CHECK</span>(old_head-&gt;next == <span class="literal">NULL</span>);</span><br><span class="line">    <span class="comment">// Try to set _head to NULL to mark that the execution is done.</span></span><br><span class="line">    TaskNode* new_head = old_head;</span><br><span class="line">    TaskNode* desired = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="type">bool</span> return_when_no_more = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (has_uniterated) &#123; <span class="comment">// desired è®¾ç½®åˆ° old_head, æ–¹ä¾¿ç»„ batch.</span></span><br><span class="line">        desired = old_head;</span><br><span class="line">        return_when_no_more = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// _head å’Œ old_head å¦‚æœç›¸ç­‰, å°±æŠŠ desired è®¾ç½®ç»™ _head. åªæœ‰æ²¡æœ‰æ–°ä»»åŠ¡æ¥çš„æ—¶å€™, ä¼šç›¸ç­‰.</span></span><br><span class="line">    <span class="comment">// desired åœ¨è¿­ä»£å®Œå…¨çš„æ—¶å€™, ä¼šæ˜¯ NULL, è¿™ä¸ªæ—¶å€™é˜Ÿåˆ—ä¹Ÿè®¾ç½®ä¸ºç©º; å¦åˆ™è®¾ç½®ä¸ºè¿™æ¬¡è¿­ä»£çš„å°¾éƒ¨, å…è®¸åˆ«äººå† append.</span></span><br><span class="line">    <span class="comment">// å¤±è´¥çš„æ—¶å€™, æ–°çš„ _head ä¼šè¢«åŠ è½½åˆ° `new_head` ä¸­.</span></span><br><span class="line">    <span class="keyword">if</span> (_head.<span class="built_in">compare_exchange_strong</span>(</span><br><span class="line">                new_head, desired, butil::memory_order_acquire)) &#123;</span><br><span class="line">        <span class="comment">// No one added new tasks.</span></span><br><span class="line">        <span class="comment">// æ²¡æœ‰æ–°ä»»åŠ¡, è¿™é‡Œè¿”å›æœ¬é˜Ÿåˆ—æ˜¯å¦è¿­ä»£å®Œæˆ.</span></span><br><span class="line">        <span class="keyword">return</span> return_when_no_more;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">CHECK_NE</span>(new_head, old_head);</span><br><span class="line">    <span class="comment">// Above acquire fence pairs release fence of exchange in Write() to make</span></span><br><span class="line">    <span class="comment">// sure that we see all fields of requests set.</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Someone added new requests.</span></span><br><span class="line">    <span class="comment">// Reverse the list until old_head.</span></span><br><span class="line">    TaskNode* tail = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">if</span> (new_tail) &#123;</span><br><span class="line">        *new_tail = new_head;</span><br><span class="line">    &#125;</span><br><span class="line">    TaskNode* p = new_head;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="comment">// TODO(mwish): è¿™ä¸ªåœ°æ–¹å’Œ enqueue æœ‰å¹¶å‘, æ²¡æœ‰é—®é¢˜å—.</span></span><br><span class="line">        <span class="keyword">while</span> (p-&gt;next == TaskNode::UNCONNECTED) &#123;</span><br><span class="line">            <span class="comment">// TODO(gejun): elaborate this</span></span><br><span class="line">            <span class="built_in">sched_yield</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        TaskNode* <span class="type">const</span> saved_next = p-&gt;next;</span><br><span class="line">        p-&gt;next = tail;</span><br><span class="line">        tail = p;</span><br><span class="line">        p = saved_next;</span><br><span class="line">        <span class="built_in">CHECK</span>(p != <span class="literal">NULL</span>);</span><br><span class="line">    &#125; <span class="keyword">while</span> (p != old_head);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Link old list with new list.</span></span><br><span class="line">    old_head-&gt;next = tail;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä¼šæŠŠä¸¤ä¸ª queue æ‹¼æˆä¸€ä¸ªï¼Œå¤§æ¦‚é€»è¾‘å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">æ­£åœ¨æ‰§è¡Œçš„ Queue: T1(done)-&gt;T2(done)-&gt;T3(undone, head)</span><br><span class="line">head_ æœ‰å…³çš„ç»“æ„: (head)T6-&gt;T5-&gt;T4-&gt;T3-&gt;T2-&gt;T1</span><br><span class="line"></span><br><span class="line">å›æ”¶ç©ºé—´ï¼Œæ­£åœ¨æ‰§è¡Œçš„ Queue: T3(undone, head)</span><br><span class="line">head_ æœ‰å…³çš„ç»“æ„: (head)T6-&gt;T5-&gt;T4-&gt;T3-&gt;T2-&gt;T1</span><br><span class="line"></span><br><span class="line">æ‹¼æ¥å, queue æœ‰å…³çš„ç»“æ„: T3-&gt;T4-&gt;T5-&gt;T6</span><br><span class="line">head_ æœ‰å…³çš„ç»“æ„: (head)T6-&gt;T5-&gt;T4-&gt;T3</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„æ‰§è¡Œæµç¨‹å¦‚ä¸‹</p><ol><li>å¯¹å·²ç»æ‰§è¡Œçš„ Task çš„èµ„æºå›æ”¶ï¼Œè°ƒç”¨ <code>ExecutionQueueBase::return_task_node</code>ï¼Œåœ¨ <code>_more_tasks</code> ä¹‹å‰å›é¦–æ‰</li><li>ä¼šç»„å¥½ Batchï¼Œç„¶åç­‰å¾…ä¸‹ä¸€æ¬¡æ‰§è¡Œã€‚è¿™é‡Œä¼šå¦‚ä¸Šå›¾ä¸€æ ·æ‹¼æ¥</li><li>å¦‚æœæ²¡æœ‰æ›´å¤šçš„ä»»åŠ¡ï¼Œå¯èƒ½ä¼šå›æ”¶ <code>head</code>s</li></ol><h3 id="Graceful-shutdown"><a href="#Graceful-shutdown" class="headerlink" title="Graceful shutdown"></a>Graceful shutdown</h3><p>å¯¹äºä¸€ä¸ªå…³é—­çš„ queueï¼Œé¦–å…ˆï¼ŒæŠ•é€’çš„ä»»åŠ¡ä¼šå¤±è´¥ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// (åœ¨ class ExecutionQueue&lt;T&gt; é‡Œé¢)</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">execute</span><span class="params">(<span class="keyword">typename</span> butil::add_const_reference&lt;T&gt;::type task,</span></span></span><br><span class="line"><span class="params"><span class="function">                <span class="type">const</span> TaskOptions* options, TaskHandle* handle)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">stopped</span>()) &#123;</span><br><span class="line">            <span class="keyword">return</span> EINVAL;</span><br><span class="line">        &#125;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶æ¬¡ï¼Œè¿™é‡Œæœ‰ä¸€å¥—å¼•ç”¨è®¡æ•°æœºåˆ¶ï¼Œæ¥ä¿è¯æŒæœ‰çš„åœ°æ–¹ä¸ä¼šå¤±æ•ˆï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function">ExecutionQueueBase::<span class="type">scoped_ptr_t</span> <span class="title">ExecutionQueueBase::address</span><span class="params">(<span class="type">uint64_t</span> id)</span></span>;</span><br></pre></td></tr></table></figure><p>å½“å¼•ç”¨è®¡æ•°å·®ä¸å¤šå¾—äº†çš„æ—¶å€™ï¼Œè¿™é‡Œä¼šæŠ•é€’ä¸€äº›å…³é—­çš„ flagï¼Œè°ƒç”¨ <code>_on_recycle</code>:</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="type">void</span> ExecutionQueueBase::_on_recycle() &#123;</span><br><span class="line">    <span class="comment">// Push a closed tasks</span></span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        TaskNode* node = butil::<span class="built_in">get_object</span>&lt;TaskNode&gt;();</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">BAIDU_LIKELY</span>(node != <span class="literal">NULL</span>)) &#123;</span><br><span class="line">            <span class="built_in">get_execq_vars</span>()-&gt;running_task_count &lt;&lt; <span class="number">1</span>;</span><br><span class="line">            node-&gt;stop_task = <span class="literal">true</span>;</span><br><span class="line">            node-&gt;high_priority = <span class="literal">false</span>;</span><br><span class="line">            node-&gt;in_place = <span class="literal">false</span>;</span><br><span class="line">            <span class="built_in">start_execute</span>(node);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">CHECK</span>(<span class="literal">false</span>) &lt;&lt; <span class="string">&quot;Fail to create task_node_t, &quot;</span> &lt;&lt; <span class="built_in">berror</span>();</span><br><span class="line">        ::<span class="built_in">bthread_usleep</span>(<span class="number">1000</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Notes on Btree Implements: PostgreSQL</title>
      <link href="/2022/07/09/Notes-on-Btree-Implements-PostgreSQL/"/>
      <url>/2022/07/09/Notes-on-Btree-Implements-PostgreSQL/</url>
      
        <content type="html"><![CDATA[<p>PostgreSQL ä¹Ÿæœ‰ç´¢å¼•å’Œ BTree ç´¢å¼•ï¼Œä½†æ˜¯å®ƒå’Œ InnoDB æ˜¯æœ‰åŒºåˆ«çš„ï¼ŒInnoDB æœ‰ â€œCluster Indexâ€ï¼Œç´¢å¼•æŒ‡å‘ Cluster Indexï¼ŒCluster Index ä¸Šæ•°æ®æœ‰æ˜¯å®Œæ•´çš„ï¼Œå®ƒä¹Ÿæœ‰ <code>roll_pointer</code> å­—æ®µæŒ‡å‘ Undoã€‚PostgreSQL æ²¡æœ‰ Cluster Indexã€‚å®ƒçš„ä¸»æ•°æ®å­˜å‚¨åœ¨ä¸€ä¸ªå« Heap Table çš„â€å †è¡¨â€ä¸Šï¼Œéœ€è¦æ›´æ–°çš„æ—¶å€™ï¼Œå †è¡¨ä¸Šä¼šæ’å…¥å¯¹åº”çš„ Tupleï¼Œå¦‚æœæ˜¯å­—æ®µæ›´æ–°ï¼Œé‚£ä¹ˆä¼šåœ¨ä¹‹å‰çš„ Tuple è®°å½•ä¸€æ¡æŒ‡å‘ç°æœ‰ Tuple çš„æŒ‡é’ˆã€‚è¿™é‡Œå¯¹åº”çš„é€»è¾‘è§†å›¾å¦‚ä¸‹ï¼š</p><p><img src="https://image.mwish.me/blog-image/190D2463-5889-453A-8310-C1C1058911D5.png" alt="190D2463-5889-453A-8310-C1C1058911D5"></p><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œå¯¹æ¯” InnoDBï¼ŒPostgreSQL ç›¸å½“äº <strong>åªæœ‰ secondary index</strong>ã€‚</p><h2 id="æ¦‚å¿µä»‹ç»"><a href="#æ¦‚å¿µä»‹ç»" class="headerlink" title="æ¦‚å¿µä»‹ç»"></a>æ¦‚å¿µä»‹ç»</h2><h3 id="Tuple"><a href="#Tuple" class="headerlink" title="Tuple"></a>Tuple</h3><p>PostgreSQL çš„ Tuple åˆ†ä¸º <code>HeapTuple</code> å’Œ <code>IndexTuple</code>ï¼Œ<code>HeapTuple</code> æ˜¯ä¸»è¡¨ä¸Šçš„æ•°æ®ï¼Œ<code>IndexTuple</code> æ˜¯ç´¢å¼•ä¸Šå­˜å‚¨çš„æŒ‡å‘ HeapTuple çš„æ•°æ®ï¼Œå®ƒä»¬å¤§è‡´é€»è¾‘å†…å®¹å¦‚ä¸‹ï¼š</p><p><img src="https://image.mwish.me/blog-image/fig-5-02.png" alt="fig-5-02"></p><p><img src="https://image.mwish.me/blog-image/fig-5-03.png" alt="fig-5-03"></p><p>HeapTuple å®šä¹‰åœ¨ pg çš„ <code>src/include/access/htup.h</code>, é™¤äº†ç”¨æˆ·å®šä¹‰çš„å€¼ï¼Œå®ƒåŒ…å«å‡ ä¸ªéšè—å­—æ®µï¼š</p><ol><li><code>t_xmin</code>, <code>t_xmax</code>: <code>t_xmin</code> è¡¨ç¤ºåˆ›å»ºè¿™ä¸ª Tuple çš„äº‹åŠ¡çš„äº‹åŠ¡ idï¼Œå³è¿™ä¸ªäº‹åŠ¡ commit ä¹‹åï¼Œäº‹åŠ¡ id æ¯” <code>t_xmin</code> å¤§çš„å°±å¯ä»¥çœ‹è§ <code>tuple</code> ï¼›<code>t_xmax</code> è¡¨ç¤ºæ›´æ–°æˆ–è€…åˆ é™¤è¿™æ¡è®°å½•çš„äº‹åŠ¡çš„ idï¼ˆå®ƒä¹Ÿå¯ä»¥è¡¨ç¤ºäº‹åŠ¡æ­£åœ¨å¯¹è¿™ä¸ª tuple ä¸Šé”ï¼‰</li><li>å®é™…ä¸Šï¼Œè¯»ä¸€ä¸ª tuple çš„æ—¶å€™ï¼ŒPG å¯èƒ½è¦åˆ¤æ–­ä¸€ä¸‹è¿™ä¸ªäº‹åŠ¡ id çš„çŠ¶æ€æ˜¯ä»€ä¹ˆæ ·å­çš„ï¼ŒTuple çš„éšè—å­—æ®µæœ‰ä¸€äº› info bitsï¼Œå¦‚æœæŸ¥å®Œå¯ä»¥æŠŠç›¸å…³çŠ¶æ€åœ¨ info bits ä¸Šåšæ ‡è®°ï¼Œä¼˜åŒ–æŸ¥è¡¨çš„å¼€é”€</li><li><code>t_cid</code> æ˜¯æ›´æ–°è¿™ä¸ª tuple çš„ command id</li><li><code>t_ctid</code> æ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘ <em>Tuple è‡ªå·±çš„ä½ç½®</em> æˆ–è€… <em>è¢«æ›´æ–°ä¹‹åï¼ŒTupleæ–°çš„ä½ç½®</em></li></ol><p>æˆ‘ä»¬ä»¥ä¸Šå›¾ä¸ºä¾‹ï¼š</p><ol><li>Page çš„ tuple1 è¢« txn_id ä¸º 99 çš„äº‹åŠ¡æ’å…¥ï¼Œå®ƒçš„ <code>t_xmin</code> ä¸º 99ï¼Œ<code>t_ctid</code> æŒ‡å‘è‡ªå·±çš„ä½ç½® <code>(0, 1)</code></li><li>Page çš„ tuple1 è¢« txn_id ä¸º 100 çš„äº‹åŠ¡æ›´æ–°ï¼Œå®ƒçš„ <code>t_xmax</code> ä¸º 100, åˆ›å»ºäº†ä¸€æ¡æ–°çš„è®°å½• Tuple2ï¼Œ<code>t_xmin</code> ä¸º 100ï¼Œ<code>t_xmax</code> ä¸º 0ã€‚Tuple1 çš„ <code>t_ctid</code> æŒ‡å‘ tuple2</li></ol><p>å¯¹äº IndexTupleï¼Œå‡è®¾ä¸»è¡¨å±æ€§æ˜¯ <code>(a, b, c)</code>, è€Œå¯¹ <code>(b)</code> å»ºäº†ç´¢å¼•ï¼Œé‚£ä¹ˆç´¢å¼• Tuple å¯ä»¥è¢«è§†ä½œ <code>&lt;(b), ä¸»è¡¨ä¸Š Tuple çš„ä½ç½®&gt;</code>, åŒæ—¶ï¼Œç´¢å¼•çš„ IndexTuple å¯èƒ½åªæœ‰å¶å­ç»“ç‚¹ä¸Šæ‰æœ‰ä¸»è¡¨ Tuple çš„ä½ç½®ã€‚ å®ƒè¢«å®šä¹‰åœ¨ <code>src/include/access/itup.h</code></p><p><img src="https://image.mwish.me/blog-image/fig-5-06.png" alt="fig-5-06"></p><h3 id="Page"><a href="#Page" class="headerlink" title="Page"></a>Page</h3><p>PostgreSQL çš„ Page æ ¼å¼æ¯”è¾ƒç»Ÿä¸€ï¼Œè€Œä¸”éå¸¸å…¸å‹ï¼Œå…¸å‹åˆ°å¾ˆå¤šæ•°æ®åº“æ•™æä¸Šéƒ½æœ‰ã€‚ç›¸æ¯” InnoDB çš„ ç¨€ç–ç´¢å¼• + å•å‘é“¾è¡¨ + åƒåœ¾é“¾è¡¨ + ç»Ÿè®¡ä¿¡æ¯ï¼ŒPostgreSQL ï¼ˆä»¥é™ä½æ›´æ–°æ€§èƒ½ä¸ºä»£ä»·ï¼‰ä½¿ç”¨äº†ä¸€ä¸ªéå¸¸ç®€å•çš„æ ¼å¼ï¼š</p><p><img src="https://image.mwish.me/blog-image/4C345186-B4D8-435E-9C5B-DDD4D18671A5.png" alt="4C345186-B4D8-435E-9C5B-DDD4D18671A5"></p><p>å¯¹äº Heap Tableï¼Œä¸è€ƒè™‘ GC æ•°æ®ï¼ˆå³ Vacuumï¼‰çš„æƒ…å†µä¸‹ï¼Œæ•°æ®å‡ ä¹æ˜¯åªä¼šå¾€åæ·»åŠ ã€ä¸ä¼šå˜æ›´ä½ç½®çš„ã€‚</p><h3 id="Index"><a href="#Index" class="headerlink" title="Index"></a>Index</h3><p>ç»ˆäºè®²åˆ°æˆ‘ä»¬ä»Šå¤©çš„ä¸»é¢˜äº†â€¦å…¶å®è¿˜æ²¡æœ‰ã€‚æˆ‘ä»¬åˆšæ‰è¯´è¿‡ï¼Œä¸è€ƒè™‘ Vacuum çš„æƒ…å†µä¸‹ï¼Œæ•°æ®å‡ ä¹åªä¼šå¾€åæ·»åŠ ã€ä¸ä¼šå˜æ›´ä½ç½®ã€‚Index éœ€è¦æŒ‡å‘æœ€åˆçš„é‚£ä¸ª Tupleï¼Œå¦‚å›¾æ‰€ç¤ºï¼š</p><p>PostgreSQL æŠŠ Index æ¥å£å’Œ Index ç®¡ç†å™¨æš´éœ²ç»™äº†ç”¨æˆ·ï¼Œç”¨æˆ·å¯ä»¥åˆ›å»º HashIndex, Btree Index ç­‰ç´¢å¼•ã€‚</p><p><img src="https://image.mwish.me/blog-image/fig-5-14.png" alt="fig-5-14"></p><p>æˆ‘ä»¬åˆšæ‰è°ˆåˆ°äº†ï¼Œæ›´æ–°ä¸€ä¸ªå€¼å¯èƒ½ä¼šæ›´æ”¹å®ƒçš„ <code>t_ctid</code>ï¼ŒæŒ‡å‘æ–°çš„ä½ç½®ã€‚è¿™ä¸ªæ—¶å€™ <strong>ç´¢å¼•çš„å€¼ä¸èƒ½æ”¹å˜ï¼ŒåŒæ—¶æ—§å€¼ä¸èƒ½è¢«å›æ”¶</strong>ï¼Œé™¤éç´¢å¼•ç›¸å…³çš„å€¼è¢«æ”¹å˜ã€‚å¦‚æœ Tuple ä¸º <code>(a, b, c)</code>, å¯¹ <code>(b)</code> æ„å»ºäº†ç´¢å¼•ï¼Œç„¶åä¸€ä¸ªè¯·æ±‚ä¿®æ”¹äº† <code>b</code>ï¼Œè¿™ä¸ªæ—¶å€™éœ€è¦åœ¨ç´¢å¼•æ’å…¥ä¸€ä¸ªæ–°çš„å€¼ï¼Œä½†æ—§å€¼ä¹Ÿä¸èƒ½åˆ é™¤ã€‚éœ€è¦ç­‰å¾… vacuum é˜¶æ®µåˆ é™¤ã€‚</p><h3 id="Vacuum"><a href="#Vacuum" class="headerlink" title="Vacuum"></a>Vacuum</h3><p>å¯¹äº PG æ¥è¯´ï¼Œå®ƒåšçš„æ˜¯ä¸€ä¸ªæ¯”è¾ƒå¤æ‚çš„å¤šé˜¶æ®µçš„åˆ é™¤ï¼Œç”¨çš„ Tuple-level GC + VACï¼Œå…·ä½“å¯è§ Vacuum ç›¸å…³çš„ææ–™ï¼ˆLazy Vacuum, Full Vacuumï¼‰</p><ul><li>å¯¹äºäº‹åŠ¡çš„è®°å½•ï¼ŒPostgreSQL ç»´æŠ¤åœ¨ clog é‡Œé¢ï¼Œè¿™å¯ä»¥å½“ä½œä¸€ä¸ªäº‹åŠ¡è¡¨ã€‚å®ƒæ ¹æ®äº‹åŠ¡ id çš„é¡ºåºå­˜åœ¨å„ä¸ª Page ä¸Šï¼Œç¼“å­˜åœ¨å†…å­˜çš„ slru ä¸­ã€‚å½“äº‹åŠ¡æ¨è¿›çš„æ—¶å€™ï¼Œå¯ä»¥ Truncate å‰é¢çš„äº‹åŠ¡è®°å½•æ¥å›æ”¶ç©ºé—´ï¼Œæ¨è¿›ç³»ç»Ÿäº‹åŠ¡</li><li>PostgreSQL çš„ <code>xmax</code> å¦‚æœè¢«æ ‡è®°ä¸” tuple æ²¡æœ‰è¢«ä¸Šé”ï¼Œé‚£ä¹ˆè¿™ä¸ª tuple æ˜¯è¢«åˆ é™¤çš„ï¼Œå¦‚æœ <code>xmax</code> å°äº <code>min-txn</code>ï¼Œé‚£è¿™ä¸ª tuple åœ¨é€»è¾‘ä¸Šä¸ä¼šè¢«ä»»ä½•äº‹åŠ¡çœ‹è§ï¼Œè™½ç„¶ç‰©ç†ä¸Šå®ƒè¿˜å­˜åœ¨</li><li>GC è¿‡ç¨‹ä¸­ï¼ŒPostgreSQL ä¼šæ‰«ææ‰€æœ‰ dead çš„ tupleï¼Œç„¶åæ¸…é™¤å®ƒä»¬ï¼Œè¿™é‡Œé¦–å…ˆæœ‰ä¸€ä¸ª visibilitymap, å¯¹åº”ä»£ç åœ¨ <code>backend/access/heap/visibilitymap</code>ã€‚å¦‚æœæŸä¸ª Page è¢«æ”¹äº†ï¼Œæœ‰ Tuple å¯èƒ½éœ€è¦ GCï¼Œå°±ä¼šç»™ vm è®°ä¸€ä¸‹ï¼Œç„¶åè¿™æ ·çš„ Page æ‰éœ€è¦è¢«æ¸…ç†ï¼Œè¿™æ®µè¿‡ç¨‹ä¸­ï¼Œç´¢å¼•çš„æ•°æ®ä¼šè¢«æ¸…é™¤ï¼Œå¦‚ä¸‹é¢çš„å›¾ã€‚</li><li>ç´¢å¼•æ•°æ®æ¸…é™¤ä¹‹åï¼ŒHeap Tuple çš„æ•°æ®ä¼šè¢«æ ‡è®°åˆ é™¤ï¼Œä½†æ˜¯ slot ä¸Šçš„ä½ç½®è¿˜æ˜¯ä¼šç•™ç€ã€‚</li><li>æ›´æ–°å¯¹åº”çš„ VMï¼Œç§»é™¤ clog ç­‰äº‹åŠ¡è¡¨ä¿¡æ¯ã€‚</li></ul><p><img src="https://image.mwish.me/blog-image/fig-6-01.png" alt="fig-6-01"></p><h3 id="äº‹åŠ¡çŠ¶æ€-CLOG"><a href="#äº‹åŠ¡çŠ¶æ€-CLOG" class="headerlink" title="äº‹åŠ¡çŠ¶æ€: CLOG"></a>äº‹åŠ¡çŠ¶æ€: CLOG</h3><p><img src="https://image.mwish.me/blog-image/fig-5-07.png" alt="fig-5-07"></p><p><img src="https://image.mwish.me/blog-image/fig-5-08.png" alt="fig-5-08"></p><h3 id="WAL-XLog"><a href="#WAL-XLog" class="headerlink" title="WAL: XLog"></a>WAL: XLog</h3><p>PostgreSQL çš„æ—¥å¿—å†™åœ¨ XLog ä¸­ã€‚PostgreSQL æ¨¡å‹ä¸­ï¼Œæ²¡æœ‰ InnoDB çš„ Undo dataï¼Œä½†å®ƒè®¤ä¸ºå®ƒåœ¨ Heap Table ä¸­ç»´æŠ¤äº†å¤šç‰ˆæœ¬ï¼Œæ‰€ä»¥åªå†™äº† Redo Logã€‚</p><h2 id="NBTree"><a href="#NBTree" class="headerlink" title="NBTree"></a>NBTree</h2><p>PostgreSQL çš„ç´¢å¼•ç®¡ç†å™¨å®šä¹‰åœ¨äº† <code>src/backend/access/index</code>ï¼Œè€Œ Btree çš„å®šä¹‰åœ¨ <code>src/backend/access/nbtree</code>ã€‚BTree å¯¹å¤–æä¾›äº† cursor, æ’å…¥ï¼Œåˆ é™¤ç­‰æ¥å£ï¼ŒåŒæ—¶ä¹Ÿå®šä¹‰äº†å¹¶è¡Œè®¿é—®çš„æ¥å£ã€‚</p><p>PostgreSQL å®ç°äº† B-link Treeï¼ŒB-link Tree æ¥è‡ªè®ºæ–‡ Efficient Locking for Concurrent Operations on  B-Trees é€»è¾‘å®šä¹‰å¦‚ä¸‹ï¼š</p><p><img src="https://image.mwish.me/blog-image/68DC4BF6-FEDB-47B0-A10E-A981B22BECC3.png" alt="68DC4BF6-FEDB-47B0-A10E-A981B22BECC3"></p><p><img src="https://image.mwish.me/blog-image/AD6DE068-6D32-4756-8ED3-E841A8969781.png" alt="AD6DE068-6D32-4756-8ED3-E841A8969781"></p><ul><li>æ‰€æœ‰é¡µé¢å¯èƒ½åŒ…å«ä¸€ä¸ª <code>highkey</code>ï¼Œè¡¨ç¤ºæœ¬é¡µé¢å­˜å‚¨çš„ key çš„æœ€å¤§å€¼ã€‚åŒæ—¶å¯èƒ½åŒ…å«ä¸€ä¸ªåˆ†è£‚åˆ°ä¸€åŠéœ€è¦çš„ <code>rightlink</code>ï¼ŒæŒ‡å‘è‡ªå·±èŠ‚ç‚¹çš„å³è¾¹ã€‚æ¯” <code>highkey</code> é«˜çš„å€¼å¯ä»¥å»å³è¾¹æŸ¥è¯¢ï¼Œèµ°åˆ°å³è¾¹çš„è¡Œä¸ºå« <code>moveright</code></li><li>b-link tree çš„åˆ†è£‚æ˜¯åˆ†ä¸ºå¤šé˜¶æ®µçš„<ul><li>åˆ†è£‚çš„æ—¶å€™ï¼Œ<strong>æ°¸è¿œåªä¼šå‘å³åˆ†è£‚</strong>ï¼Œé¦–å…ˆèŠ‚ç‚¹ä¼šåˆ›å»ºä¸€ä¸ªå³èŠ‚ç‚¹ï¼Œä¿®æ”¹ high-keyï¼Œé“¾æ¥ <code>rightlink</code>ï¼Œå®Œæˆæ“ä½œçš„ç¬¬ä¸€æ­¥</li><li>ä¹‹åå‘ç°è¿™é‡Œæœ‰æœªå®Œæˆçš„åˆ†è£‚åï¼Œä¼šåœ¨çˆ¶èŠ‚ç‚¹ä¸Šæ’å…¥å³èŠ‚ç‚¹ï¼Œå®Œæˆåˆ†è£‚ã€‚å¦‚æœçˆ¶èŠ‚ç‚¹åˆ†è£‚ï¼Œé‚£ä¹ˆå›åˆ°ä¸Šä¸€æ­¥ï¼Œé€’å½’å®Œæˆåˆ†è£‚ã€‚</li></ul></li></ul><p>å¯¹äºä¸€ä¸ªä¸‹é™çš„æŸ¥è¯¢ <code>key</code>ï¼Œå®ƒç§»åŠ¨ä¸‹æ¥çš„æ—¶å€™ï¼Œä¼šå…ˆæ¯”è¾ƒ <code>key</code> å’Œ è¿™ä¸ª Page ä¸Šçš„ <code>highkey</code>ï¼Œå¦‚æœè‡ªå·±å°äº Page çš„ highkeyï¼Œé‚£ä¹ˆå°±åœ¨æœ¬é¡µé¢æŸ¥è¯¢ï¼Œå¦åˆ™ä¼šéœ€è¦ <code>moveright</code>ï¼Œç§»åŠ¨åˆ°å³èŠ‚ç‚¹æŸ¥è¯¢ã€‚</p><p>PostgreSQL çš„ Index å¯¹å¤–æš´éœ²äº†ä¸€ç»„ç®¡ç† apiï¼ŒåŒ…æ‹¬ï¼š</p><ol><li>Search</li><li>æ’å…¥èŠ‚ç‚¹</li><li>æ›´æ–°ä¸€äº›èŠ‚ç‚¹çš„å…ƒä¿¡æ¯</li><li>Scan</li><li>Batch çš„åœ¨ vacuum é˜¶æ®µåšåˆ é™¤èŠ‚ç‚¹</li><li>â€¦</li></ol><p>åœ¨ <code>Datum bthandler(PG_FUNCTION_ARGS)</code> è¿™ä¸ªå‡½æ•°æœ‰ç€å°†å‡½æ•° bind åˆ° <code>IndexAm</code> ä¸Šçš„é€»è¾‘ã€‚è¿™é‡Œå…¶å®åŸºæœ¬ä¸Šç›¸å½“äºè™šå‡½æ•°ä»€ä¹ˆçš„äº†ã€‚</p><h3 id="BTree-çš„ç»“æ„å’Œå„ç§Page"><a href="#BTree-çš„ç»“æ„å’Œå„ç§Page" class="headerlink" title="BTree çš„ç»“æ„å’Œå„ç§Page"></a>BTree çš„ç»“æ„å’Œå„ç§Page</h3><p>æˆ‘ä»¬åœ¨åˆšåˆšä»‹ç» InnoDB Btree çš„æ—¶å€™æåˆ°è¿‡ï¼ŒInnoDB æœ‰æ•´ä¸ªç´¢å¼•çš„é”ï¼ŒåŒæ—¶å®ƒçš„ RootPage æ˜¯ä¸ä¼šæ”¹å˜çš„ã€‚</p><p>InnoDB çš„ RootPage æ˜¯ä¼šæ”¹å˜çš„ï¼Œå®ƒæœ‰ä¸€ä¸ª MetaPage æŒ‡å‘å®ƒã€‚Meta æ°¸è¿œæ˜¯æ•´ä¸ªæ ‘çš„ç¬¬ä¸€ä¸ª Pageï¼Œè€Œ Root å’Œ Internal Page å…¶å®æ²¡æœ‰ä»€ä¹ˆåŒºåˆ«ã€‚å¦‚ä¸‹å›¾ï¼š</p><p><img src="https://image.mwish.me/blog-image/IMG_1042.jpg" alt="IMG_1042"></p><p>è¿˜å¯ä»¥æ³¨æ„åˆ°ï¼ŒLeaf Page æ˜¯æœ‰å·¦æŒ‡é’ˆ <code>leftlink</code> çš„ï¼Œè¿™æ˜¯å› ä¸ºåå‘ Scan çš„æ—¶å€™ï¼Œå®ƒå¸Œæœ›ä¸è·å–ä¸Šå±‚ Page ç›´æ¥ Scan ä¸‹æ¥ã€‚</p><p>BTree ç›¸å…³çš„å†…å®¹å®šä¹‰åœ¨ <code>src/include/access/nbtree.h</code>ï¼Œæˆ‘ä»¬å¯ä»¥ä» Meta çœ‹èµ·ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * The Meta page is always the first page in the btree index.</span></span><br><span class="line"><span class="comment"> * Its primary purpose is to point to the location of the btree root page.</span></span><br><span class="line"><span class="comment"> * We also point to the &quot;fast&quot; root, which is the current effective root;</span></span><br><span class="line"><span class="comment"> * see README for discussion.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * MetaPageData æŒ‡å‘</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">BTMetaPageData</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="comment">// ä¸€äº›æ ‡å¿—ä½</span></span><br><span class="line">uint32btm_magic;<span class="comment">/* should contain BTREE_MAGIC */</span></span><br><span class="line">uint32btm_version;<span class="comment">/* nbtree version (always &lt;= BTREE_VERSION) */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// çœŸå®çš„ root</span></span><br><span class="line">BlockNumber btm_root;<span class="comment">/* current root location */</span></span><br><span class="line">uint32btm_level;<span class="comment">/* tree level of the root page */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Fastroot ç›¸å…³çš„å†…å®¹</span></span><br><span class="line">BlockNumber btm_fastroot;<span class="comment">/* current &quot;fast&quot; root location */</span></span><br><span class="line">uint32btm_fastlevel;<span class="comment">/* tree level of the &quot;fast&quot; root page */</span></span><br><span class="line"><span class="comment">/* remaining fields only valid when btm_version &gt;= BTREE_NOVAC_VERSION */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¸€äº› vacuum æœ‰å…³çš„æ ‡è®°.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* number of deleted, non-recyclable pages during last cleanup */</span></span><br><span class="line">uint32btm_last_cleanup_num_delpages;</span><br><span class="line"><span class="comment">/* number of heap tuples during last cleanup (deprecated) */</span></span><br><span class="line">float8btm_last_cleanup_num_heap_tuples;</span><br><span class="line"></span><br><span class="line"><span class="type">bool</span>btm_allequalimage;<span class="comment">/* are all columns &quot;equalimage&quot;? */</span></span><br><span class="line">&#125; BTMetaPageData;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢æ˜¯æ•´ä¸ª Page çš„ä¿¡æ¯ã€‚</p><p>å¯¹äº Internal Page å’Œ Leaf Pageï¼ŒPostgreSQL å¹¶æ²¡æœ‰å¼•å…¥é¢å¤–çš„ç»“æ„ï¼Œå®ƒå’Œæˆ‘ä»¬ä¹‹å‰èŠçš„ Page ç»“æ„æ˜¯ä¸€æ ·çš„ï¼Œåªæ˜¯ Tuple æ˜¯ <code>IndexTuple</code>ï¼Œå°¾éƒ¨å†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> *  åœ¨ Page çš„å°¾éƒ¨, å­˜å‚¨ Page çš„ left å’Œ right çš„å…„å¼ŸèŠ‚ç‚¹å’Œ btree çš„ level,</span></span><br><span class="line"><span class="comment"> *   page çš„ type. Vacuum æœ¬èº«ä¹Ÿä¼šå æœ‰é”.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *BTPageOpaqueData -- At the end of every page, we store a pointer</span></span><br><span class="line"><span class="comment"> *to both siblings in the tree.  This is used to do forward/backward</span></span><br><span class="line"><span class="comment"> *index scans.  The next-page link is also critical for recovery when</span></span><br><span class="line"><span class="comment"> *a search has navigated to the wrong page due to concurrent page splits</span></span><br><span class="line"><span class="comment"> *or deletions; see src/backend/access/nbtree/README for more info.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *In addition, we store the page&#x27;s btree level (counting upwards from</span></span><br><span class="line"><span class="comment"> *zero at a leaf page) as well as some flag bits indicating the page type</span></span><br><span class="line"><span class="comment"> *and status.  If the page is deleted, a BTDeletedPageData struct is stored</span></span><br><span class="line"><span class="comment"> *in the page&#x27;s tuple area, while a standard BTPageOpaqueData struct is</span></span><br><span class="line"><span class="comment"> *stored in the page special area.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *We also store a &quot;vacuum cycle ID&quot;.  When a page is split while VACUUM is</span></span><br><span class="line"><span class="comment"> *processing the index, a nonzero value associated with the VACUUM run is</span></span><br><span class="line"><span class="comment"> *stored into both halves of the split page.  (If VACUUM is not running,</span></span><br><span class="line"><span class="comment"> *both pages receive zero cycleids.)This allows VACUUM to detect whether</span></span><br><span class="line"><span class="comment"> *a page was split since it started, with a small probability of false match</span></span><br><span class="line"><span class="comment"> *if the page was last split some exact multiple of MAX_BT_CYCLE_ID VACUUMs</span></span><br><span class="line"><span class="comment"> *ago.  Also, during a split, the BTP_SPLIT_END flag is cleared in the left</span></span><br><span class="line"><span class="comment"> *(original) page, and set in the right page, but only if the next page</span></span><br><span class="line"><span class="comment"> *to its right has a different cycleid.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *<span class="doctag">NOTE:</span> the BTP_LEAF flag bit is redundant since level==0 could be tested</span></span><br><span class="line"><span class="comment"> *instead.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *<span class="doctag">NOTE:</span> the btpo_level field used to be a union type in order to allow</span></span><br><span class="line"><span class="comment"> *deleted pages to store a 32-bit safexid in the same field.  We now store</span></span><br><span class="line"><span class="comment"> *64-bit/full safexid values using BTDeletedPageData instead.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">BTPageOpaqueData</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="comment">/** ä¸¤ä¸ªå…„å¼Ÿ **/</span></span><br><span class="line"></span><br><span class="line">BlockNumber btpo_prev;<span class="comment">/* left sibling, or P_NONE if leftmost */</span></span><br><span class="line">BlockNumber btpo_next;<span class="comment">/* right sibling, or P_NONE if rightmost */</span></span><br><span class="line"><span class="comment">// æœ¬ tree çš„æ·±åº¦</span></span><br><span class="line">uint32btpo_level;<span class="comment">/* tree level --- zero for leaf pages */</span></span><br><span class="line"><span class="comment">// ä¸‹é¢å‡ è¡Œå°±ä»‹ç»è¿™äº› flags äº†</span></span><br><span class="line">uint16btpo_flags;<span class="comment">/* flag bits, see below */</span></span><br><span class="line">BTCycleIdbtpo_cycleid;<span class="comment">/* vacuum cycle ID of latest split */</span></span><br><span class="line">&#125; BTPageOpaqueData;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘ä»¬å…³æ³¨ <code>btpo_next</code>ï¼Œæ˜¯å¯¹åº”çš„ä¸‹ä¸€é¡µã€‚è¿™æ˜¯ä¸€ä¸ªå®šé•¿çš„å­—æ®µã€‚é‚£ä¹ˆ highkey å­˜åœ¨å“ªé‡Œå‘¢ï¼Ÿç­”æ¡ˆæ˜¯ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *Lehman and Yao&#x27;s algorithm requires a ``high key&#x27;&#x27; on every non-rightmost</span></span><br><span class="line"><span class="comment"> *page.  The high key is not a tuple that is used to visit the heap.  It is</span></span><br><span class="line"><span class="comment"> *a pivot tuple (see &quot;Notes on B-Tree tuple format&quot; below for definition).</span></span><br><span class="line"><span class="comment"> *The high key on a page is required to be greater than or equal to any</span></span><br><span class="line"><span class="comment"> *other key that appears on the page.  If we find ourselves trying to</span></span><br><span class="line"><span class="comment"> *insert a key that is strictly &gt; high key, we know we need to move right</span></span><br><span class="line"><span class="comment"> *(this should only happen if the page was split since we examined the</span></span><br><span class="line"><span class="comment"> *parent page).</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *Our insertion algorithm guarantees that we can use the initial least key</span></span><br><span class="line"><span class="comment"> *on our right sibling as the high key.  Once a page is created, its high</span></span><br><span class="line"><span class="comment"> *key changes only if the page is split.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *On a non-rightmost page, the high key lives in item 1 and data items</span></span><br><span class="line"><span class="comment"> *start in item 2.  Rightmost pages have no high key, so we store data</span></span><br><span class="line"><span class="comment"> *items beginning in item 1.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> P_HIKEY((OffsetNumber) 1)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> P_FIRSTKEY((OffsetNumber) 2)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> P_FIRSTDATAKEY(opaque)(P_RIGHTMOST(opaque) ? P_HIKEY : P_FIRSTKEY)</span></span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯ä»¥ç»™ Page ç”»ä¸€ä¸ªè‰å›¾ï¼Œå¦‚ä¸‹ï¼š</p><p><img src="https://image.mwish.me/blog-image/E586E76B8C150D42A8D7A4AA738ACB98.jpg" alt="E586E76B8C150D42A8D7A4AA738ACB98"></p><p>æ­¤å¤–ï¼Œéœ€è¦æ³¨æ„ï¼Œå¯¹äº Internal Page ç”¨æˆ·çš„ç¬¬ä¸€ä¸ª key ç›¸å½“äº <code>-inf</code>ï¼Œå®ƒå°äºä»»ä½•ä¸€ä¸ªå€¼ã€‚å…·ä½“å¯ä»¥å‚è€ƒ <code>_bt_compare</code> çš„æ³¨é‡Šã€‚</p><p>åœ¨å¶å­ç»“ç‚¹ä¸Šï¼ŒIndexTuple åŒ…å«æœ‰æŒ‡å‘çš„ HeapTuple çš„ä½ç½®ã€‚</p><h4 id="Fastroot"><a href="#Fastroot" class="headerlink" title="Fastroot"></a>Fastroot</h4><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°, <code>MetaPage</code> æœ‰ä¸€ä¸ª <code>fastroot</code>ï¼Œè¿™ä¸ªåœ°æ–¹è¡¨ç¤ºçš„æ˜¯å®é™…é€»è¾‘ä¸Šçš„ Rootï¼Œå¦‚ä¸‹å›¾ï¼š</p><p><img src="https://image.mwish.me/blog-image/C0C2426A8807D6CA2DB200A68939625B.jpg" alt="C0C2426A8807D6CA2DB200A68939625B"></p><p>è¿™é‡Œ Root åˆ°å¾ˆä¸‹å±‚éƒ½åªæœ‰ä¸€ä¸ª linkï¼ˆå¯èƒ½æ˜¯ç”±äºåˆ†è£‚å’Œåˆ é™¤å¯¼è‡´çš„ï¼Œä¸ºä»€ä¹ˆä¼šå½¢æˆè¿™ç§ç»“æ„ä¹‹åä¼šè®²ï¼‰ï¼Œæ‰€ä»¥çœŸå®çš„ root ä¸ç­‰äºè®¿é—®ä¸Šæœ€å¿«æ·çš„ rootï¼ŒMeta ä¼šæœ‰ä¸ª <code>fastroot</code> æ¥æŒ‡å‘å¼€å§‹åˆ†å‰çš„ç»“ç‚¹ï¼Œæ¥ä¼˜åŒ–è¯»</p><h3 id="Btree-çš„æŸ¥æ‰¾å’Œç§»åŠ¨"><a href="#Btree-çš„æŸ¥æ‰¾å’Œç§»åŠ¨" class="headerlink" title="Btree çš„æŸ¥æ‰¾å’Œç§»åŠ¨"></a>Btree çš„æŸ¥æ‰¾å’Œç§»åŠ¨</h3><h4 id="ä¸‹é™"><a href="#ä¸‹é™" class="headerlink" title="ä¸‹é™"></a>ä¸‹é™</h4><p>Btree ä¸‹é™çš„ä¸»è¦é€»è¾‘åœ¨ä¸‹åˆ—ä¸¤ä¸ªå‡½æ•°ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> BTStack _bt_search(Relation rel, BTScanInsert key, Buffer *bufP,</span><br><span class="line">  <span class="type">int</span> access, Snapshot snapshot);</span><br><span class="line"><span class="keyword">extern</span> Buffer _bt_moveright(Relation rel, BTScanInsert key, Buffer buf,</span><br><span class="line"><span class="type">bool</span> forupdate, BTStack <span class="built_in">stack</span>, <span class="type">int</span> access, Snapshot snapshot);</span><br></pre></td></tr></table></figure><p>ä¸€ä¸ªä¸‹é™ï¼Œæ— è®ºæ˜¯æ’å…¥è¿˜æ˜¯æŸ¥æ‰¾ï¼Œéƒ½ä¼šèµ°åˆ° <code>_bt_search</code>ï¼Œä¸è¿‡è¿™ä¸¤ç§æƒ…å†µçš„ <code>access</code> æ ‡è¯†æ˜¯ä¸ä¸€æ ·çš„ã€‚è¯»å–çš„æ—¶å€™ï¼Œ<code>access</code> æ˜¯ <code>BT_READ</code>, å†™å…¥çš„æ—¶å€™æ˜¯<code>BT_WRITE</code> ã€‚<code>Relation</code> æ˜¯æ•´ä¸ªå…³ç³»ï¼ˆå¯ä»¥ç†è§£æˆè¡¨ï¼Œæœ‰ HeapTable å’Œ Index çš„ä¿¡æ¯ï¼‰ï¼Œ<code>BTScanInsert</code> æ˜¯éœ€è¦æŸ¥æ‰¾çš„æˆ–è€…æ’å…¥æœ‰å…³çš„ keyï¼Œä»–å¯èƒ½ä¼šæŒ‡å®šæ˜¯å¦æ˜¯ <code>next_key</code>, æŸ¥è¯¢çš„æ–¹å‘ç­‰ã€‚æœ€åä¼šæœåˆ°å¶å­ç»“ç‚¹ï¼Œè¿”å› <code>BTStack</code>ï¼Œå³ Btree éå†çš„æ—¶å€™çš„æ ˆã€‚</p><p>æˆ‘ä»¬é¦–å…ˆä»‹ç»è¯»çš„ä¸‹é™ï¼Œä¸‹é¢é€»è¾‘å¯¹åº”çš„é€»è¾‘éƒ½åœ¨ <code>_bt_search</code> ä¸­ï¼Œå‡è®¾ç¬¬ä¸€æ¬¡åˆ°ç¬¬ k å±‚</p><ol><li>æ‹¿åˆ°æœ¬ Page çš„è¯»é”ï¼Œå¯¹æœ¬ Page è¿›è¡Œ Pinã€‚æ¯”è¾ƒæœ¬ key å’Œ Page çš„ <code>highkey</code>ã€‚å¦‚æœå°äºç­‰äº <code>highkey</code>ï¼Œé‚£ä¹ˆå¯ä»¥ç»§ç»­ä¸‹é™ï¼Œå¦åˆ™ï¼Œéœ€è¦ <code>_bt_moveright</code> å‘å³ç§»åŠ¨</li><li>å‘å³ç§»åŠ¨çš„æ—¶å€™ï¼Œ<strong>å…ˆæ‹¿åˆ°å³ Page æŒ‡é’ˆï¼Œç„¶åå†é‡Šæ”¾é”å’Œpinï¼Œå† acquire å³è¾¹çš„ Page å’Œé”</strong>ï¼Œç„¶åå›åˆ° (1) çš„é€»è¾‘<ol><li>æ­£ç¡®æ€§ï¼šé‡Šæ”¾é”åï¼Œæœ¬ Page å’Œå³è¾¹çš„ Page å¯èƒ½éƒ½ä¼šåˆ†è£‚ï¼Œå› ä¸º <code>highkey</code> çš„é™å®šï¼Œæœ¬ Page åˆ†è£‚åï¼Œæ‰€æœ‰å€¼ä»ç„¶å°äº highkeyã€‚è€Œå³è¾¹ Page å¦‚æœåˆ†è£‚ï¼Œä¹Ÿåªä¼šå‘å³åˆ†è£‚ã€‚Page å¯èƒ½ä¼šåˆ é™¤ Pageï¼Œè¿™ä¸ªæ—¶å€™åˆ é™¤ Page çš„å¹¶å‘é€»è¾‘ä¼šä¿è¯åˆ é™¤çš„æ­£ç¡®æ€§</li></ol></li><li>å¦‚æœç§»åŠ¨åˆ°äº† <code>key &lt;= highkey</code> çš„åœºæ™¯ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±æ‰¾åˆ°äº†ï¼Œå¦‚æœæ˜¯å¶å­ç»“ç‚¹ï¼Œé‚£å°±è®¿é—®å¶å­ï¼Œå¦åˆ™ä¸‹é™ã€‚è¿™é‡Œé¦–å…ˆæŠŠè¿™ä¸ªèŠ‚ç‚¹æ”¾åˆ° <code>BTStack</code> è¿™ä¸ªéå†çš„æ ˆä¸­ï¼Œç„¶åæŸ¥æ‰¾åˆ°èµ°å“ªä¸ª key ä¸‹é™ï¼ˆè°ƒç”¨ <code>_bt_binsrch</code> åšäºŒåˆ†æŸ¥æ‰¾ï¼‰ï¼Œç„¶å<strong>é‡Šæ”¾è‡ªå·±çš„é”å’Œ pinï¼Œå†ä¸‹é™</strong>ï¼Œè¿™é‡Œä»ç„¶æ˜¯é  <code>highkey</code> ä¿è¯äº†ä¸‹é™çš„æ­£ç¡®æ€§ã€‚</li></ol><p><img src="https://image.mwish.me/blog-image/60C70C6E4770D882C1A15954F931DADF.jpg" alt="60C70C6E4770D882C1A15954F931DADF"></p><p>è¿™é‡Œå°±å¯ä»¥æ­£ç¡®çš„åˆ°è¾¾äº†ã€‚ç„¶åä¸Šé¢æ˜¯è®²ç¬¬ <code>k</code> å±‚ä¸‹é™çš„ã€‚é‚£æ ¹ç»“ç‚¹æ˜¯æ€ä¹ˆæ‹¿åˆ°çš„å‘¢ï¼Ÿè¿™é‡Œä¼šæ‹¿åˆ° <code>fastroot</code>ï¼Œç›´æ¥ä¸‹æ¥å°±è¡Œäº†ã€‚ç”¨æˆ·æ²¡æœ‰æ’å…¥ä»»ä½•å€¼çš„æ—¶å€™ï¼Œroot å¯èƒ½ä¸å­˜åœ¨ã€‚PG å¦‚æœå‘ç° root ä¸å­˜åœ¨ï¼Œé‚£å°±ä¼šç›´æ¥è¿”å› â€œå•¥éƒ½æ²¡æŸ¥åˆ°â€ã€‚</p><p>å¯¹äºæ’å…¥è€Œè¨€ï¼Œå¦‚æœæ²¡æœ‰ RootPageï¼Œä¼šåˆ›å»ºä¸€ä¸ª RootPageã€‚æ’å…¥çš„é€»è¾‘ä» <code>_bt_doinsert</code> å¼€å§‹ï¼ŒBtree ä¼šåœ¨ <code>Relation</code> ä¸Šè®°å½•æœ€å³ Pageï¼Œå¦‚æœ Page æ˜¯ä¸€ä¸ªæœ€å³æ’å…¥ï¼ˆå³å¤§äºæ‰€æœ‰çš„æ’å…¥å€¼ï¼‰ï¼Œé‚£ä¹ˆå®ƒä¼šç›´æ¥èµ°åˆ°æœ€å³ä¾§çš„ page, æŠŠå®ƒå½“ä½œ <code>root</code> (è®°å¾—å—ï¼Œroot åªæ˜¯ä¸€ä¸ªæ­£å¸¸çš„ internal æˆ–è€… leaf page), å¦åˆ™ï¼Œå®ƒä¼šè¿”å›æ ‘çš„ rootã€‚å¦‚æœæ˜¯æ’å…¥çš„è¯ï¼ŒPG å‘ç° root ä¸å­˜åœ¨ï¼Œä¼šç›´æ¥åˆ›å»ºä¸€ä¸ª Rootã€‚</p><p>æ¥ä¸‹æ¥ï¼Œå®ƒä¼šèµ° <code>_bt_search</code>ï¼Œè¿™é‡Œå¤§æ¦‚é€»è¾‘å’Œ 1-3 æ˜¯ä¸€æ ·çš„ã€‚ä¸è¿‡è¯»çš„æ—¶å€™æ‹¿çš„ä»æ ¹åˆ°å¶å­éƒ½æ˜¯è¯»é”ï¼Œä½† <strong>å†™åœ¨å¶å­ç»“ç‚¹çš„æ—¶å€™ä¼šåˆ‡æˆå†™é”</strong>ã€‚</p><p>è¿˜æœ‰ä¸€äº›åœ°æ–¹æœ‰åŒºåˆ«ï¼Œåœ¨å†™é“¾è·¯ä¸Šï¼Œè¿™é‡Œå¦‚æœé‡åˆ°äº†æœªå®Œæˆçš„åˆ†è£‚ï¼Œä¼šé©±åŠ¨çˆ¶èŠ‚ç‚¹æŠŠ <code>rightlink</code> å®Œæˆåˆ†è£‚ï¼Œæ’å…¥çˆ¶èŠ‚ç‚¹ã€‚è¿™éƒ¨åˆ†ä»£ç åœ¨ <code>_bt_moveright</code> å’Œ <code>_bt_finish_split</code> ä¸­ã€‚</p><h3 id="Scan"><a href="#Scan" class="headerlink" title="Scan"></a>Scan</h3><p>PostgreSQL çš„ Scan ä¼šé¦–å…ˆä¸‹é™åˆ°å¶å­èŠ‚ç‚¹ï¼Œç„¶åå‘å³æˆ–è€…å‘å·¦è¿›è¡Œè¿­ä»£ã€‚Scan ç›¸å…³çš„ä¸€ç»„å‡½æ•°å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">bool</span> _bt_first(IndexScanDesc scan, ScanDirection dir); <span class="comment">// æ‰¾åˆ°ç¬¬ä¸€ä¸ªå¯¹åº”ä½ç½®, ç„¶åæŠŠç»“æ„å­˜åœ¨ `scan` é‡Œé¢</span></span><br><span class="line"><span class="type">bool</span> _bt_next(IndexScanDesc scan, ScanDirection dir);  <span class="comment">// å¯¹ scan æåˆ°ä¸‹ä¸€ä¸ªå€¼</span></span><br><span class="line"><span class="type">bool</span> _bt_endpoint(IndexScanDesc scan, ScanDirection dir);</span><br></pre></td></tr></table></figure><p>Scan é¦–å…ˆè¦äº‰å–å¤„ç†æ–¹å‘ï¼Œç„¶å <code>IndexScanDesc</code> æè¿°äº† Index å’Œ <code>ScanKey</code> çš„å…³ç³»ï¼šå¯èƒ½æ˜¯ <code>&gt;=</code>, <code>&lt;=</code>, <code>&gt;</code> , <code>&lt;</code> ç­‰ã€‚è¿™é‡Œæ‰å®é™…æ‰§è¡Œçš„æ—¶å€™ä¼šå˜æˆï¼š</p><ol><li><code>goback</code>: æ˜¯å¦è¦å›é€€ä¸€ä¸ªã€‚å¦‚æœ <code>goback == true</code>ï¼Œå°±è¦å›é€€ä¸€é¡¹</li><li><code>nextkey</code>: æ˜¯å¦è¦æ‹¿åˆ°å¤§äºæœç´¢é¡¹çš„ keyã€‚è¿™ä¸ªæœ‰ç‚¹æ€ªï¼Œ<code>nextkey</code> è®¾ç½®çš„æ—¶å€™ï¼Œä¼šæ‹¿åˆ° <code>item &gt; scan key</code>çš„ï¼Œå¦åˆ™ç›´æ¥ <code>item &gt;= scan key</code> å°±å¯ä»¥äº†</li></ol><p>æœ‰ç‚¹ç»•ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹çœ‹å…·ä½“åˆ†æï¼Œè¿™é‡Œæœ‰ï¼š</p><ol><li>å¦‚æœæ˜¯ <code>&lt;</code>, é‚£ä¹ˆä¼šå½“ <code>&gt;=</code> å¤„ç†ï¼Œç„¶åéœ€è¦ <code>goback</code></li><li>å¦‚æœæ˜¯ <code>&lt;=</code>ï¼Œé‚£ä¹ˆä¼šå½“æˆ <code>&gt;=</code> å¤„ç†ï¼Œéœ€è¦ <code>goback</code> + <code>nextkey</code></li><li>â€¦</li></ol><p>è¿™é‡Œä¼šæ„é€ ä¸€ä¸ªæœç´¢çš„ key å¯¹è±¡ï¼Œæ¥è¿›è¡Œ <code>_bt_search</code>ï¼Œå†èµ° <code>_bt_binsrch</code> åœ¨é¡µé¢ä¸Šå®šä½åˆ°å¯¹åº”çš„ä½ç½®ã€‚</p><p>ä¸‹é¢ä¼šæœ‰ä¸€äº›æ¯”è¾ƒ hack çš„åœ°æ–¹ï¼Œåœ¨å®šä½åˆ°ä½ç½®åï¼Œè¿™é‡Œä¼šç”¨ <code>_bt_readpage</code>æ¥è¯»å‡ºæœ¬é¡µé¢å‰©ä¸‹æ¥æ‰€æœ‰å†…å®¹ï¼Œç„¶å<strong>é‡Šæ”¾é”</strong>ã€‚è¿™ä¸ªåœ°æ–¹æ„Ÿè§‰æœ‰ç‚¹ RC çš„æ„æ€äº†ï¼Œæ–°æ’å…¥çš„æ•°æ®æ„Ÿè§‰ PostgreSQL æ˜¯è¯»ä¸åˆ°çš„ã€‚çŒœæµ‹å®ƒè¿™å°±æ²¡åœ¨æ„è¿™ä¸ªã€‚é‡Šæ”¾é”æ˜¯ä¸ªå¾ˆå¥‡æ€ªçš„åœ°æ–¹ï¼Œæˆ‘ä»¬åé¢ä¼šè®ºè¯å®ƒçš„æ­£ç¡®æ€§ã€‚</p><p><code>_bt_next</code> ç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ªè¦è¯»çš„ç›®æ ‡ã€‚è¿™é‡Œæœ‰ç¼“å­˜çš„è¯ï¼Œä¼šå…ˆè¯»å–è‡ªå·±çš„ç¼“å­˜ï¼Œæ²¡æœ‰çš„è¯ï¼Œä¼šèµ°åˆ°ä¸‹ä¸€ä¸ªé¡µé¢ï¼Œè°ƒç”¨å‡½æ•°: <code>_bt_steppage(IndexScanDesc scan, ScanDirection dir)</code>ã€‚</p><p>å¦‚æœè¦å‘å³ç§»åŠ¨ï¼Œè¿™é‡Œ PostgreSQL ä¼šåœ¨æœåˆ°é¡µé¢ç„¶åæ”¾é”ä¹‹å‰ï¼Œæ‹¿åˆ° Page çš„ right linkï¼Œç„¶ååœ¨éœ€è¦è·³è½¬åˆ°ä¸‹ä¸€ä¸ªé¡µé¢çš„æ—¶å€™æ‹¿åˆ°ï¼Œè¿™é‡Œé€»è¾‘å¦‚ä¸‹å›¾ï¼š</p><p><img src="https://image.mwish.me/blog-image/IMG_1046.jpg" alt="IMG_1046"></p><ol><li>å¦‚æœè‡ªå·±è¿™ä¸ª Page æ²¡æœ‰åˆ†è£‚ï¼Œå³ <code>(1)</code>ï¼Œé‚£ä¹ˆç§»åŠ¨åˆ°æ­£ç¡®çš„é¡µé¢</li><li>å¦‚æœè‡ªå·±è¿™ä¸ª Page åˆ†è£‚äº†ï¼Œç„¶åè¿™é‡Œå¯ä»¥ç›´æ¥ç§»åŠ¨è¿‡å»ã€‚</li></ol><p>è¯»å·¦è¾¹çš„é¡µé¢æ¯”è¾ƒå¤æ‚ï¼Œéœ€è¦éªŒè¯æ¯”è¾ƒå¤šä¸œè¥¿ã€‚è¿™ä¸ªæ—¶å€™ä¼šï¼š</p><ol><li>å…ˆé”ä½æœ¬é¡µé¢ï¼Œ<strong>æ‹¿åˆ° left-link</strong>ï¼Œæ³¨æ„ï¼Œå‘å³ç§»åŠ¨çš„æ—¶å€™æ‹¿çš„æ˜¯åˆšä¸‹æ¥çš„æ—¶å€™æ‹¿åˆ°çš„ right-link, åä¹‹ left-link åˆ™æ˜¯åœ¨éœ€è¦å·¦ç§»çš„æ—¶å€™å†æ‹¿çš„</li><li>æ”¾é”ï¼Œèµ° left-linkï¼Œæ‹¿åˆ° left çš„é¡µé¢çš„é”</li><li>æŸ¥çœ‹å³è¾¹çš„ Page æ˜¯ä¸æ˜¯åŸæ¥çš„ Pageï¼Œå¦‚æœæ˜¯çš„è¯ï¼Œå°±æˆåŠŸäº†ï¼Œå¦åˆ™è¦å‘å³å†ç§»åŠ¨</li></ol><p><img src="https://image.mwish.me/blog-image/IMG_1047.jpg" alt="IMG_1047"></p><p>è¿™é‡Œç›¸å¯¹å³ç§»ä¼šå¤æ‚å¾ˆå¤šã€‚è¿™é‡Œå†é¢å¤–è®¨è®ºä¸€ä¸ª Page è¢«åˆ é™¤çš„æƒ…å†µã€‚è¿™ä¸ªæƒ…å†µä¼šæ ¹æ® high key æ¥åˆ¤æ–­ç§»åŠ¨çš„èŒƒå›´ã€‚</p><h3 id="æ’å…¥å’Œåˆ†è£‚"><a href="#æ’å…¥å’Œåˆ†è£‚" class="headerlink" title="æ’å…¥å’Œåˆ†è£‚"></a>æ’å…¥å’Œåˆ†è£‚</h3><p>B-link tree çš„åˆ†è£‚ä¹Ÿæ˜¯ Btree çš„åˆ†è£‚ï¼Œå’Œ InnoDB ä¸€æ ·ï¼ŒPostgreSQL ä¹Ÿæ”¯æŒæŒ‰ç…§ bytes 50%-50% åˆ†è£‚ï¼Œä¹Ÿèƒ½æ”¯æŒå‘å³åˆ†è£‚ã€‚æˆ‘ä»¬è¿™é‡Œå¯ä»¥å…ˆçœ‹çœ‹æ’å…¥çš„æ—¶å€™ç”¨çš„æ ˆï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">btinsert -- hook åœ¨ä¸Šå±‚æ’å…¥çš„å‡½æ•°</span><br><span class="line">- _bt_doinsert -- è½¬æ¢äº†ä¸€ä¸‹ key, å…·ä½“çš„å»åš insert</span><br><span class="line">  ç”¨æˆ‘ä»¬ä¸Šé¢ä»‹ç»çš„é€»è¾‘, èµ° _bt_search_insert, é‡Œé¢ä¼šèµ°æˆ‘ä»¬ä¸Šé¢çš„é€»è¾‘, éœ€è¦æ³¨æ„çš„æ˜¯, **è¿™é‡Œæ£€æµ‹åˆ°æœªå®Œå…¨åˆ†è£‚çš„ Page, ä¼šåš _bt_finish_split, å®Œæˆåˆ†è£‚**</span><br><span class="line">  åšä¸€äº› checkUnique å’Œäº‹åŠ¡æœ‰å…³çš„ä¸œè¥¿(æ¯”å¦‚ä¸Šé”), å¯èƒ½ä¼šèµ°åˆ° HeapTable ä¸ŠéªŒè¯, æˆ–è€…é  LP_DEAD ç­‰è¾…åŠ©ä½åˆ¤æ–­</span><br><span class="line">  - _bt_insertonpg, å…·ä½“æ’å…¥</span><br><span class="line">  å¦‚æœ PageGetFreeSpace(page) &lt; itemsz, è°ƒç”¨åˆ†è£‚, èµ° _bt_split å’Œ _bt_insert_parent</span><br><span class="line">  å¦åˆ™, ç›´æ¥æ’å…¥é¡µé¢, å†™ä¸€æ¡ xlog, ç„¶åæ ‡è¯† LSN.</span><br></pre></td></tr></table></figure><p>è¿™é‡Œåœ¨æœç´¢çš„æ—¶å€™ï¼Œä¼šæœ‰ä¸€äº›ç‰¹æ®Šçš„é€»è¾‘ï¼Œæœç´¢è·¯å¾„ä¸Šç¢°åˆ°åˆ†è£‚ä¼šåš <code>_finish_split</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * If this page was incompletely split, finish the split now.  We do</span></span><br><span class="line"><span class="comment"> * this while holding a lock on the left sibling, which is not good</span></span><br><span class="line"><span class="comment"> * because finishing the split could be a fairly lengthy operation.</span></span><br><span class="line"><span class="comment"> * But this should happen very seldom.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (P_INCOMPLETE_SPLIT(opaque))</span><br><span class="line">&#123;</span><br><span class="line">_bt_finish_split(rel, rbuf, <span class="built_in">stack</span>);</span><br><span class="line">rbuf = InvalidBuffer;</span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!P_IGNORE(opaque))</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">if</span> (P_RIGHTMOST(opaque))</span><br><span class="line">elog(ERROR, <span class="string">&quot;fell off the end of index \&quot;%s\&quot;&quot;</span>,</span><br><span class="line"> RelationGetRelationName(rel));</span><br></pre></td></tr></table></figure><h4 id="ç¬¬ä¸€é˜¶æ®µ-é¡µé¢åˆ†è£‚"><a href="#ç¬¬ä¸€é˜¶æ®µ-é¡µé¢åˆ†è£‚" class="headerlink" title="ç¬¬ä¸€é˜¶æ®µ: é¡µé¢åˆ†è£‚"></a>ç¬¬ä¸€é˜¶æ®µ: é¡µé¢åˆ†è£‚</h4><p>é¡µé¢åˆ†è£‚ä¼šå¸¦ä¸Šé”ï¼Œç„¶åæŠŠé¡µé¢åˆ†è£‚æˆä¸¤ä»½ï¼Œç„¶åæ ‡è®°é¡µé¢ä¸º unfinished split. ä»£ç é€»è¾‘åœ¨ <code>_bt_split</code>:</p><ol><li><code>_bt_findsplitloc</code> æ‰¾åˆ°åˆ†è£‚ç‚¹ã€‚è¿™é‡Œå‡†å¤‡ä¸´æ—¶çš„ leftpage å’Œ rightpage ä½œä¸ºç›®æ ‡ï¼Œrightpage éœ€è¦æŒä¹…åŒ–åˆ°å­˜å‚¨ä¸­ï¼Œleftpage ä¼šå†™å›åŸæ¥çš„ page1</li><li>äº§ç”Ÿæ–° Page, åœ¨å†…å­˜ç”³è¯· pageï¼Œ è®¾ç½®å†™å…¥çš„ LSNï¼Œå¯»æ‰¾åˆ†è£‚åˆ°å·¦è¾¹çš„ highkey ç­‰</li><li>ç”¨  <code>_pg_addtup</code> æ’å…¥å…ƒç´ ã€‚</li><li>å†™ xlogï¼ŒæŠŠä¸¤è¾¹çš„æ›´æ–°å†™å…¥ log buffer, ç„¶åé‡æ–°è®¾ç½® LSN.</li><li>æ”¾é”</li></ol><h4 id="ç¬¬äºŒé˜¶æ®µ-æ’å…¥çˆ¶èŠ‚ç‚¹"><a href="#ç¬¬äºŒé˜¶æ®µ-æ’å…¥çˆ¶èŠ‚ç‚¹" class="headerlink" title="ç¬¬äºŒé˜¶æ®µ: æ’å…¥çˆ¶èŠ‚ç‚¹"></a>ç¬¬äºŒé˜¶æ®µ: æ’å…¥çˆ¶èŠ‚ç‚¹</h4><p><code>_bt_finish_split</code> åœ¨æ‰«æé˜¶æ®µä¼šæ£€æµ‹åˆ°åˆ†è£‚åˆ°ä¸€åŠçš„èŠ‚ç‚¹ï¼Œä»–ä¼šåˆ¤æ–­è‡ªå·±æ˜¯ä¸æ˜¯ rootï¼Œå¯¹è‡ªå·±å’Œå³èŠ‚ç‚¹ä¸Šå†™é”ï¼ˆä¸‹é™çš„æ—¶å€™ï¼Œéœ€è¦é‡Šæ”¾è¯»é”ï¼Œç„¶ååˆ‡æˆå†™é”ï¼‰ï¼Œç„¶åèµ° <code>_bt_insert_parent</code>ï¼Œè€Œåˆ†è£‚åœ¨ä»£ç ä¸Šä¹Ÿä¼šèµ° <code>_bt_insert_parent</code>ã€‚è¿™é‡Œä¼šæœ‰å¶å­å’Œå…„å¼Ÿé˜¶æ®µçš„å†™é”ã€‚</p><p><code>_bt_insert_parent</code> ä¸­ï¼Œä¹‹å‰ <code>BTStack</code> ä¸Šçš„é”éƒ½é‡Šæ”¾äº†ï¼Œè¿™é‡Œçˆ¶èŠ‚ç‚¹ä¸èƒ½è¢«åˆ é™¤ï¼ˆå› ä¸ºåˆ é™¤æ¯”è¾ƒç‰¹æ®Šï¼‰ï¼Œä½†<strong>å¯èƒ½åˆ†è£‚äº†</strong>ï¼Œæ‰€ä»¥è¦æŸ¥åˆ°çœŸçš„çˆ¶èŠ‚ç‚¹åœ¨å“ªï¼Œç„¶åå†æ’å…¥ã€‚æ’å…¥å¾ˆç®€å•ï¼Œä½†æ˜¯æŸ¥æ‰¾çˆ¶èŠ‚ç‚¹æ¯”è¾ƒ hackï¼Œè¿™éƒ¨åˆ†ä»£ç åœ¨: <code>_bt_getstackbuf</code>:</p><ol><li>æ‰¾åˆ° stack çš„çˆ¶èŠ‚ç‚¹ï¼Œget èµ·æ¥ç„¶åæåˆ°æ­»é”</li><li>(é€’å½’çš„) è°ƒç”¨ <code>_bt_finish_split</code>, å®Œæˆ incomplete split.</li><li>æ‰«æ pageï¼Œçœ‹çœ‹å­èŠ‚ç‚¹æœ‰æ²¡æœ‰å¯¹åº”çš„å¾…å®Œæˆåˆ†è£‚çš„é‚£ä¸ªï¼Œå¦‚æœæœ‰çš„è¯ï¼Œæœç´¢æˆåŠŸ</li><li>å¦åˆ™ï¼Œå°è¯• moveright</li></ol><h4 id="Root-çš„åˆ†è£‚"><a href="#Root-çš„åˆ†è£‚" class="headerlink" title="Root çš„åˆ†è£‚"></a>Root çš„åˆ†è£‚</h4><p>æ ¹èŠ‚ç‚¹çš„åˆ†è£‚å’Œæ­£å¸¸èŠ‚ç‚¹æ²¡æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Œè¿™é‡Œæ ¹åˆ†è£‚ä¼šäº§ç”Ÿä¸€ä¸ªæ–°çš„æ ¹èŠ‚ç‚¹ï¼Œç„¶åè®© meta æŒ‡å‘å®ƒã€‚</p><p><img src="https://image.mwish.me/blog-image/IMG_1048.jpg" alt="IMG_1048"></p><p>è¿™é‡Œèµ°çš„é€»è¾‘æ˜¯ <code>_bt_newroot</code>ï¼Œéœ€è¦ä¿®æ”¹ <code>MetaPage</code> ä¸Šçš„æ ‡è®°</p><h3 id="å¯¹-Key-çš„åˆ é™¤"><a href="#å¯¹-Key-çš„åˆ é™¤" class="headerlink" title="å¯¹ Key çš„åˆ é™¤"></a>å¯¹ Key çš„åˆ é™¤</h3><p>åœ¨åŸæ¥çš„ B-link æ ‘è®ºæ–‡ä¸­ï¼ŒDelete å‡ ä¹æ˜¯ä¸²è¡Œçš„ã€‚å…¶å® B-link tree ä¹Ÿå·®ä¸å¤šï¼Œåˆ é™¤ä¼šå æ® super lockï¼šåˆ çš„æ—¶å€™ï¼Œé¡µé¢è¦æ²¡æœ‰ Pin (é˜²æ­¢ Scan å‡ºé—®é¢˜) ä¹Ÿè¦æ²¡æœ‰ Lockã€‚</p><p>PG ä¸ä¼šå¯¹ key ç®€å•åˆ é™¤ï¼Œåªä¼šåœ¨ vacuum çš„æ—¶å€™è¿›è¡Œåˆ é™¤ã€‚PG è¿˜æœ‰ä¸€ä¸ª simple deleteï¼Œè¿™é‡Œä¼šæŠŠ touch ä¸åˆ°çš„å¤šä½™çš„ç‰ˆæœ¬æ ‡è®°ä¸º <code>LP_DEAD</code>ï¼Œç­‰å¾…å›æ”¶ã€‚</p><p>PG åªæœ‰å¶å­èŠ‚ç‚¹åˆ ç©ºäº†æ‰ä¼šè¢«å›æ”¶ï¼Œå›æ”¶ä¹Ÿæ˜¯å¤šé˜¶æ®µçš„ï¼Œéœ€è¦è°ƒæ•´å…„å¼ŸèŠ‚ç‚¹çš„æŒ‡é’ˆï¼Œæ‰€ä»¥éå¸¸éå¸¸éº»çƒ¦ï¼Œè¿™é‡Œä¼šå…ˆè°ƒæ•´æŒ‡é’ˆï¼Œç„¶åå†æŠŠæ•´ä¸ªå­ç»“æ„æ‘˜é™¤ã€‚</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Notes on Btree Implements: InnoDB</title>
      <link href="/2022/07/04/Notes-on-Btree-Implements-InnoDB/"/>
      <url>/2022/07/04/Notes-on-Btree-Implements-InnoDB/</url>
      
        <content type="html"><![CDATA[<p>BTree çš„å®ç°ä¸€ç›´æ˜¯æœ‰èŒƒæœ¬ä½†å·¥ç¨‹ä¸Šå¾ˆéš¾åšçš„äº‹æƒ…ï¼ŒBtree è‡ªä¸Šä¸–çºª 70 å¹´ä»£è¢«æå‡ºå(1972)ï¼Œå·²ç»æ˜¯ä¸€ä¸ªä¹…ç»è€ƒéªŒçš„ç»“æ„äº†ï¼ˆè¿œæ¯” LSM-Tree å¤è€ï¼‰ï¼Œä½†æ˜¯ B-Tree çš„å¹¶å‘ä¸€ç›´æ˜¯ä»‹ç»ææ–™ä¸å¤šã€å·¥ç¨‹å®ç°éš¾å•ƒçš„éƒ¨åˆ†ã€‚ç›¸å¯¹äº 2021 å¹´å¸¸è§çš„ LSM-Tree è€Œè¨€ï¼Œ[1] B-Tree å®ç°å¤§éƒ¨åˆ†ä¸æ˜¯ immutable çš„ ã€‚[2] B-Tree å¤§éƒ¨åˆ†å’Œå­˜å‚¨å¼•æ“ã€Recover Systemã€äº‹åŠ¡ã€Catalog ç»“åˆå¾—å¾ˆç´§å¯†ï¼Œå¤§éƒ¨åˆ†æ—¶å€™ä¸æ˜¯ä¸€ä¸ªç®€å•çš„ KV æ¥å£ã€‚å¯¼è‡´è¿™ä¸ªå¸¸è§çš„æ•°æ®åº“ç»“æ„å¸¦ä¸Šäº†å¾ˆå¤šç¥ç§˜çš„é¢çº±ã€‚</p><p>æˆ‘ä»¬å¸Œæœ›ä»‹ç» MySQL çš„ InnoDB å¼•æ“ã€PostgreSQL çš„ BTree å¼•æ“å’Œ WiredTiger çš„ COW BTree ç»“æ„ã€‚æ¥ä»‹ç»ä¸€ä¸‹å¸¸è§æ•°æ®åº“çœŸå®ä½¿ç”¨çš„ BTree èŒƒæœ¬ã€‚</p><h2 id="MySQL-InnoDB"><a href="#MySQL-InnoDB" class="headerlink" title="MySQL InnoDB"></a>MySQL InnoDB</h2><p>MySQL InnoDB åŸºäº Jim Gray çš„ Transaction Processing ä¸€ä¹¦å®ç°ã€‚è¿™é‡Œå®ç°äº†ä¸€ä¸ª MVCC çš„ BTreeï¼ŒMVCC æ•°æ®é‡‡ç”¨ N2O çš„å½¢å¼é“¾æ¥ï¼Œä¸»è¡¨æ•°æ®å­˜å‚¨åœ¨ BTree ä¸Šï¼Œç§°ä¸º <strong>Cluster Index</strong>ï¼›ç´¢å¼•æ•°æ®ï¼›æ—§ç‰ˆæœ¬çš„æ•°æ®ä¼šæ”¾åˆ°ä¸€ä¸ª Delta Space é‡Œé¢ã€‚åˆ é™¤å’Œ MVCC çš„å½¢å¼ç»“åˆèµ·æ¥ï¼Œåšæ ‡è®°åˆ é™¤ã€‚</p><p>ä¸€åˆ» BTree çš„ Page ä¼šå°½é‡å­˜æ”¾åœ¨ä¸€èµ·ï¼Œå…·ä½“å¯ä»¥å‚è€ƒ InnoDB çš„è¡¨ç©ºé—´ã€‚åŒä¸€ä¸ªç´¢å¼•ä¸­ï¼Œnon-leaf page ä¼šå­˜å‚¨åœ¨ä¸€ä¸ª Segment ä¸­ï¼›leaf page ä¼šå­˜å‚¨åœ¨ä¸€ä¸ª Segment ä¸­ã€‚Segment ä¼šæŒ‰ç…§ Extent (å¤§å°ä¸º 1MBï¼Œé»˜è®¤ä¸º 64 ä¸ª Page ) ä¸ºå•ä½ï¼Œå‘ç³»ç»Ÿç”³è¯·å­˜å‚¨ç©ºé—´ã€‚</p><h3 id="Page"><a href="#Page" class="headerlink" title="Page"></a>Page</h3><blockquote><p>æ•°æ®é¡µåŒ…æ‹¬ä¸ƒä¸ªéƒ¨åˆ†ï¼Œæ•°æ®é¡µæ–‡ä»¶å¤´ï¼Œæ•°æ®é¡µå¤´ï¼Œæœ€å¤§æœ€å°è®°å½•ï¼Œç”¨æˆ·è®°å½•ï¼Œç©ºé—²ç©ºé—´ï¼Œæ•°æ®ç›®å½•ï¼Œæ•°æ®é¡µå°¾éƒ¨ã€‚ ç®€å•çš„æ¥è¯´ï¼Œæ•°æ®é¡µåˆ†ä¸¤éƒ¨åˆ†ï¼Œä¸€éƒ¨åˆ†å­˜å‚¨æ•°æ®è®°å½•ï¼ŒæŒ‰ç…§è®°å½•çš„å¤§å°é€šè¿‡è®°å½•çš„æŒ‡é’ˆè¿æ¥èµ·æ¥ã€‚å¦å¤–ä¸€éƒ¨åˆ†å­˜å‚¨æ•°æ®é¡µçš„ç›®å½•ï¼Œç”¨æ¥åŠ é€ŸæŸ¥æ‰¾ã€‚</p></blockquote><p>ä»¥ç´¢å¼•é¡µä¸ºä¾‹ï¼š</p><p><img src="https://image.mwish.me/blog-image/mysql_10.png" alt="mysql_10"></p><p>File Header éƒ¨åˆ†ä¼šæ ‡å¿—è¿™é‡Œæ˜¯ä»€ä¹ˆé¡µï¼Œè€Œ File Trailer åˆ™æœ‰ crc å’Œé¡µé¢çš„ lsnã€‚è¿™ä¸€ç»„å†…å®¹ç”± <code>fil</code> æœ‰å…³çš„æ–‡ä»¶ç»„æä¾›ï¼Œä»£ç åœ¨ï¼š<a href="https://github.com/CatKang/InnoDB/blob/master/innobase/include/fil0fil.h#L789">https://github.com/CatKang/InnoDB/blob/master/innobase/include/fil0fil.h#L789</a></p><p><code>page</code> æœ‰å…³çš„æ–‡ä»¶åŸºæœ¬ä¸Šæ˜¯ä¸ºç´¢å¼•é¡µè®¾è®¡çš„ï¼Œ<code>page</code> å¼€å¤´åŸºæœ¬ä¸Šæ˜¯å­˜å‚¨çš„é¡µé¢å…ƒä¿¡æ¯ï¼ŒPage Header ä¹‹ç±»çš„ï¼Œå®ƒçš„å…ƒä¿¡æ¯åœ¨ <code>page0page</code>  ç»´æŠ¤ï¼Œæ“ä½œä¸»è¦åœ¨ï¼š<a href="https://github.com/CatKang/InnoDB/blob/master/innobase/include/page0cur.h">https://github.com/CatKang/InnoDB/blob/master/innobase/include/page0cur.h</a></p><h3 id="Tuple"><a href="#Tuple" class="headerlink" title="Tuple"></a>Tuple</h3><p><img src="https://image.mwish.me/blog-image/66E4B75E-076C-4F97-A65A-C9AB3427F6AD.png" alt="66E4B75E-076C-4F97-A65A-C9AB3427F6AD"></p><p>è¿™äº› Tuple ä¹‹é—´ä¼šæ ¹æ® <code>next_record</code> æ„æˆä¸€ä¸ªå•å‘é“¾è¡¨ï¼ŒæŒ‡å‘ä¸‹ä¸€ä¸ªå­—æ®µçš„ header ä¹‹åï¼ŒçœŸå®ä¿¡æ¯ä¹‹å‰ï¼Œ<code>transaction_id</code> æ˜¯ä¸€ä¸ªé¡ºåºå¢é•¿çš„ idï¼Œç”¨æ¥è¡¨ç¤ºåˆ›å»ºè¿™æ¡è®°å½•çš„äº‹åŠ¡ idï¼Œ<code>roll_pointer</code> æŒ‡å‘ undo ä¸Šçš„è®°å½•ã€‚</p><h3 id="Leaf-Page-Non-Leaf-Page"><a href="#Leaf-Page-Non-Leaf-Page" class="headerlink" title="Leaf Page / Non Leaf Page"></a>Leaf Page / Non Leaf Page</h3><p>ä¸‹é¢çš„ä»£ç å®ç°åœ¨ <code>page0page</code> ç›¸å…³çš„ç³»ç»Ÿä¸­ã€‚</p><p>InnoDB çš„ Page å†…å®¹é‡‡å–åŒå‘é“¾è¡¨ + ç¨€ç–ç´¢å¼•çš„å½¢å¼å®ç°ï¼Œå¤´éƒ¨è¿˜æœ‰ä¸€äº›ç»Ÿè®¡ä¿¡æ¯ï¼Œä¸‹å›¾æ¯”è¾ƒæ¸…æ™°ï¼š</p><p><img src="https://image.mwish.me/blog-image/215370F3-E7ED-4D14-B00C-23DDDAACED2E.png" alt="215370F3-E7ED-4D14-B00C-23DDDAACED2E"></p><p>æ­¤å¤–ï¼ŒPage å†…è¿˜æœ‰é¡µé¢çš„åƒåœ¾é“¾è¡¨ï¼Œå­˜æ”¾åƒåœ¾è®°å½•ï¼š</p><p><img src="https://image.mwish.me/blog-image/D58CA7AD-5362-42E3-9700-4454036DF6C6.png" alt="D58CA7AD-5362-42E3-9700-4454036DF6C6"></p><p>å¯¹ Page çš„æ“ä½œå¯ä»¥çœ‹ï¼š<a href="http://mysql.taobao.org/monthly/2018/04/03/">http://mysql.taobao.org/monthly/2018/04/03/</a></p><p>å¯¹ Page çš„æ“ä½œä¼šè¢«å°è£…åœ¨ <code>mtr</code> é‡Œé¢ï¼Œè¿™é‡Œæ—¥å¿—ç±»ä¼¼ç‰©ç†é€»è¾‘æ—¥å¿—ã€‚å†™ Undo Page ä¹Ÿä¼šè½ mtrã€‚</p><p>åŒä¸€é«˜åº¦çš„ Page ä¼šç»„ç»‡æˆåŒå‘é“¾è¡¨ï¼Œç§°ä¸º Page Listã€‚</p><h4 id="å¯¹é¡µé¢çš„æ“ä½œ"><a href="#å¯¹é¡µé¢çš„æ“ä½œ" class="headerlink" title="å¯¹é¡µé¢çš„æ“ä½œ"></a>å¯¹é¡µé¢çš„æ“ä½œ</h4><p>ç»“åˆä¹‹å‰è¯´åˆ°è¿‡çš„ Page å†…éƒ¨ç»„ç»‡ï¼Œpage çš„æŸ¥æ‰¾å’Œæ’å…¥ã€æ›´æ–°æ“ä½œéƒ½åœ¨ <code>page0cur</code> ç›¸å…³çš„æ–‡ä»¶ä¸­ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¯¹ Page çš„æ“ä½œä¸æ˜¯å•ä¸ªæ“ä½œï¼Œè€Œæ˜¯ä¸€ç»„æ“ä½œï¼Œå…·ä½“è€Œè¨€ï¼Œæ¯”å¦‚è¯´å¯¹ Page çš„æ’å…¥ï¼Œè¿™é‡Œä¼šæ‹¿åˆ°ä¸€ä¸ªå¯¹åº”çš„ cursorï¼ŒæŒ‡å‘æ’å…¥çš„<em>å‰ä¸€æ¡è®°å½•</em>ï¼Œè¯¦è§ä»£ç  <code>page_cur_insert_rec_low</code>:</p><ol><li>æ‰¾åˆ° Page çš„åŸæœ¬çš„ä¿¡æ¯ï¼ŒåŒ…æ‹¬ä¸€äº›ç»Ÿè®¡ä¿¡æ¯</li><li>åœ¨ Page é‡Œæ‰¾åˆ°ç©ºé—²çš„ç©ºé—´æ’å…¥è®°å½•</li><li>ä¿®æ”¹ç»Ÿè®¡ä¿¡æ¯ï¼Œå’Œä¸Šä¸€æ¡è®°å½•çš„ next ï¼ˆè¿˜è®°å¾—å®ƒä»¬æ˜¯å•å‘é“¾è¡¨å—ï¼‰</li></ol><p>æ‰€ä»¥è¿™é‡Œæ’å…¥å®é™…ä¸Šä¸æ˜¯å•æ¡æ“ä½œï¼Œè€Œæ˜¯ä¸€ç»„åˆèµ·æ¥çš„æ“ä½œã€‚</p><p>åˆ é™¤çš„è¯ï¼Œå¯èƒ½ç›´æ¥æ ‡è®° <code>delete_mark</code>ï¼Œç„¶åæ›´æ–°ä¸€äº›ç»Ÿè®¡ä¿¡æ¯å³å¯ã€‚</p><h3 id="Undo"><a href="#Undo" class="headerlink" title="Undo"></a>Undo</h3><p>InnoDB çš„ MVCC å®ç°æ˜¯ Main-Deltaã€‚é€»è¾‘å¦‚ä¸‹æ‰€ç¤ºï¼š</p><p><img src="https://image.mwish.me/blog-image/64C7B2DB-DD5C-40EF-AAE3-AF420AB6A390.png" alt="64C7B2DB-DD5C-40EF-AAE3-AF420AB6A390"></p><p>å…·ä½“è€Œè¨€ï¼Œå¯¹äº InnoDBï¼Œå¦‚æœæœ‰è¡¨ <code>(a: PrimaryKey, b)</code>, ç„¶å b è¢«ä¸¤ä¸ªäº‹åŠ¡æ›´æ–°ä¸¤æ¬¡ï¼Œå¯èƒ½ä¼šæœ‰ï¼š</p><ol><li>Cluster Index: <code>(a: a, b: b2), update by txn2, roll_pointer-&gt;u2</code></li><li>Undo:<ol><li><code>u2: &lt;Undo Update, txn1, (a: a, b: b1), roll_pointer-&gt;u1&gt;</code></li><li><code>u1: &lt;Undo Update, txn1, (a: a, b: b0), roll_pointer-&gt;NULL&gt;</code></li></ol></li></ol><p>åœ¨é€»è¾‘ä¸Šå¦‚ä¸‹å›¾è¡¨ç¤ºï¼š</p><p><img src="https://image.mwish.me/blog-image/undo_logical.png" alt="undo_logical"></p><p>Undo å®é™…ä¸Šæ‰¿æ‹…çš„åŠŸèƒ½ç±»ä¼¼ï¼š</p><ol><li>å›æ»šæ•°æ®åº“æœªå®Œæˆçš„äº‹åŠ¡ï¼ˆæ•™ç§‘ä¹¦ä¸Šçš„ undoï¼Œä¸è¿‡è¿™æ ·å…¶å®æ˜¯<strong>æœ€å¤šåªéœ€è¦ä¸€ä¸ªç‰ˆæœ¬</strong>çš„ï¼‰ï¼Œå¯¹åº”æ¥å£åœ¨ <strong>row_undo</strong>ï¼Œ<strong>trx_roll_pop_top_rec_of_trx</strong> è¿™æ¡é“¾è·¯</li><li>MVCC å›æº¯ç‰ˆæœ¬é“¾ï¼Œä½œä¸º Undo çš„æ•°æ®ï¼Œå¯¹åº”æ¥å£åœ¨åœ¨å‡½æ•°<strong>row_search_mvcc</strong>ä¸­ï¼Œå…³æ³¨<strong>trx_undo_prev_version_build</strong> å’Œ <strong>row_upd_rec_in_place</strong></li></ol><p>ç‰©ç†ç©ºé—´ä¸Šï¼ŒUndo ä¹Ÿæ˜¯ç”± Page ç»„ç»‡çš„ã€‚ä¸€ä¸ªäº‹åŠ¡ä¸»è¦è®°å½•ä¼šä¿ç•™åœ¨ä¸€ä¸ª Undo Page ä¸Šï¼ˆå¤šä½™ä¸€ä¸ªçš„ä¼šå­˜åœ¨ä¸€ä¸ª Page ä¸Šï¼Œä½†æ˜¯ä¸è®¨è®ºï¼‰ï¼Œäº‹åŠ¡çš„è®°å½•ä¼šè¢«ä¸€ä¸ªåŒå‘é“¾è¡¨ history list ä¸²èµ·æ¥ï¼Œç„¶åæŒ‰ç…§å…¨å±€çš„æœ€ä½æ´»è·ƒäº‹åŠ¡å’Œè¿™ä¸ª history list æ¥åšå¤šç‰ˆæœ¬æ•°æ®çš„ GCã€‚</p><p><img src="https://image.mwish.me/blog-image/undo_log_disk_structure.png" alt="undo_log_disk_structure"></p><p>æ­¤å¤–ï¼Œè™½ç„¶ btr æˆ‘ä»¬åé¢æ‰ä¼šä»‹ç»ï¼Œä½†æ˜¯ InnoDB Undo ä¸ä¼šæ¶‰åŠ secondary indexesï¼Œè¿™ç‚¹åœ¨å®˜æ–¹æ–‡æ¡£ä¹Ÿæœ‰æåŠï¼š<a href="https://dev.mysql.com/doc/refman/8.0/en/innodb-multi-versioning.html">https://dev.mysql.com/doc/refman/8.0/en/innodb-multi-versioning.html</a></p><h3 id="Redo"><a href="#Redo" class="headerlink" title="Redo"></a>Redo</h3><p>InnoDB çš„ Redo æ„Ÿè§‰å°±å’Œæ•™ç§‘ä¹¦çš„ Redo å¾ˆæ¥è¿‘äº†ã€‚è¿™é‡Œæœ‰ä¸€äº›åˆ†ç±»ï¼š</p><ol><li>Page å†…æ“ä½œçš„ç‰©ç†é€»è¾‘æ—¥å¿—ï¼Œæ¯”å¦‚ <code>MLOG_REC_INSERT</code>, <code>MLOG_REC_UPDATE_IN_PLACE</code>, <code>MLOG_REC_DELETE</code>ï¼Œå®ƒä»¬ä¼šæœ‰ä¸€äº›æ“ä½œæ ‡æ³¨ä¿®æ”¹çš„é¡µé¢ã€‚</li><li><code>MLOG_FILE_CREATE</code> ç­‰ç©ºé—´çŠ¶æ€çš„æ—¥å¿—</li><li><code>MLOG_MULTI_REC_END</code> ç­‰è¡¨ç¤ºä¸€ç»„æ“ä½œçš„æ—¥å¿—ã€‚æ¯”å¦‚é¡µé¢åˆ†è£‚çš„æ—¶å€™ï¼Œä¼šæœ‰ä¸€ç»„è¡¨ç¤ºæ‹·è´è®°å½•çš„æ—¥å¿—ï¼Œéœ€è¦ç”¨è¿™æ ·çš„æ—¥å¿—ç»“å°¾ã€‚</li></ol><h3 id="Transaction-å’Œ-MTR"><a href="#Transaction-å’Œ-MTR" class="headerlink" title="Transaction å’Œ MTR"></a>Transaction å’Œ MTR</h3><p>æœ€åä»‹ç»ä¸€ä¸‹äº‹åŠ¡å­ç³»ç»Ÿï¼Œå¸Œæœ›èƒ½æŠŠä¸Šé¢çš„ Btree å’Œ Undo å†…å®¹è¿èµ·æ¥ï¼š</p><p>mtr å®Œæˆçš„æ˜¯ atomic, durable çš„å¤šé¡µé¢æ“ä½œï¼Œå®ƒä¼šå°è£…å¯¹<strong>å•ä¸ª</strong>ç´¢å¼•ï¼ˆåŒ…æ‹¬ Cluster Indexï¼‰å’Œ Undo ã€‚mtr recover çš„æ—¶å€™ï¼Œåªæœ‰ redoï¼Œæ²¡æœ‰ rollbackã€‚rollback éƒ½æ˜¯ä¸Šå±‚äº‹åŠ¡çš„ rollbackã€‚</p><p><img src="https://image.mwish.me/blog-image/90D7A363-9443-4B7E-A032-EFF999FFECBD.png" alt="90D7A363-9443-4B7E-A032-EFF999FFECBD"></p><p>å¯¹äº‹åŠ¡çš„æ“ä½œéƒ½ä¼šä¸¢åˆ° mtr çš„ buffer é‡Œé¢ï¼Œæäº¤å®ŒååŸå­æäº¤åˆ° redo ä¸­ã€‚åŒæ—¶ï¼Œè¯»å–å¯èƒ½ä¹Ÿæœ‰ mtrã€‚</p><p>äº‹åŠ¡å±‚ä¼šæœ‰ å¤šä¸ª mtr: åŒ…æ‹¬ç´¢å¼•çš„ mtr, undo çš„ mtrï¼Œäº‹åŠ¡æ˜¯ mtr ä¸Šå±‚çš„æ¦‚å¿µã€‚å®ƒä» Btree è¯»å– mtr ä¸­è¯»åˆ°æ•°æ®ï¼Œç„¶ååœ¨è¿™ä¸€å±‚ä¸Šé”ã€‚</p><h2 id="InnoDB-Btree-çš„æ“ä½œ"><a href="#InnoDB-Btree-çš„æ“ä½œ" class="headerlink" title="InnoDB Btree çš„æ“ä½œ"></a>InnoDB Btree çš„æ“ä½œ</h2><h3 id="ä¸‹é™å’Œ-Latch"><a href="#ä¸‹é™å’Œ-Latch" class="headerlink" title="ä¸‹é™å’Œ Latch"></a>ä¸‹é™å’Œ Latch</h3><p>BTree è®¿é—®éµç…§ Latching Protocolã€‚å…·ä½“ä»£ç åœ¨ <code>btr0btr</code> å’Œ <code>btr0cur</code> ä¸­. <code>btr_cur_t</code> æ˜¯ btr çš„ cursorï¼Œä» <code>btr_cu r_search_to_nth_level</code> ä¸­æ‹¿åˆ°å¯¹åº”çš„ cursorã€‚ç„¶åè¿™é‡Œ <code>btr_cur_t</code> æ’å…¥å’Œåˆ é™¤ã€‚åŒæ—¶ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥å’Œ <code>page0cur</code> ä¸­çš„ <code>page_cur_t</code> ç»“åˆèµ·æ¥ã€‚btree è®¿é—®æœ‰å‡ ç§ flag:</p><blockquote><p>åœ¨B+ treeä¸Šå…±æœ‰ä¸‰ç§æ“ä½œï¼š</p><ul><li>è¯»ï¼ˆ<strong>BTR_SEARCH_LEAF</strong> / <strong>BTR_SEARCH_LEAF</strong>ï¼‰ï¼šåˆ†ä¸ºç‚¹æŸ¥è¯¢å’ŒèŒƒå›´æŸ¥è¯¢</li><li>ä¹è§‚å†™ï¼ˆ<strong>BTR_MODIFY_LEAF</strong>ï¼‰ï¼šä»…å½±å“åˆ°ä¸€ä¸ªç´¢å¼•é¡µçš„å¢åˆ æ”¹</li><li>æ‚²è§‚å†™ï¼ˆ<strong>BTR_MODIFY_TREE</strong>ï¼‰ï¼šå½±å“åˆ°è¶…è¿‡ä¸€ä¸ªç´¢å¼•é¡µçš„å¢åˆ æ”¹ï¼ˆe.g. DELETE SQLå¯¼è‡´äº†é¡µåˆå¹¶ï¼‰</li></ul></blockquote><p>åŒæ—¶ï¼Œ BTree æœ‰ Latch çš„æ¦‚å¿µï¼Œbtree æ“ä½œå¾ˆå¤šéƒ½æœ‰å‚æ•° <code>dict_index_t::lock</code>ï¼Œè¡¨ç¤º btree çš„é”ã€‚Page çš„ latch åœ¨ <code>buf</code> å±‚å®ç°ï¼Œå¤–éƒ¨å¯ä»¥åœ¨è°ƒç”¨ä¼ å…¥ <code>buf_page_get_gen</code> ä¼ å…¥å‚æ•°ã€‚å¶å­ç»“ç‚¹è®¿é—®æœ‰ <code>btr_cur_latch_leaves</code></p><p><code>btr_cur_search_to_nth_level</code> æœ‰ä¸€åƒå¤šè¡Œä»£ç ï¼Œé€»è¾‘æ¯”è¾ƒå¤æ‚ï¼Œåœ¨ 8.0 ç‰ˆæœ¬ä¸­ï¼Œè¯»å–å®ç°é€»è¾‘å¦‚ä¸‹ï¼š</p><ol><li>è·å– index çš„ S é”: <code>mtr_s_lock(..)</code></li><li>ç„¶åæ²¿ç€æœç´¢ btree è·¯å¾„, é‡åˆ°çš„ non-leaf node page éƒ½åŠ  S LOCK</li><li>ç„¶åç›´åˆ°æ‰¾åˆ° leaf node ä»¥å, å¯¹ leaf node page ä¹Ÿæ˜¯ S LOCK ( <code>btr_cur_latch_leaves</code> )</li><li>ç„¶åæŠŠindex-&gt; lock æ”¾å¼€, é‡Šæ”¾æ‰åˆ«çš„ latch ( <code>mtr_release_s_latch_at_savepoint</code> )</li></ol><p><img src="https://image.mwish.me/blog-image/AGN3ghS.png" alt="AGN3ghS"></p><p>å¯¹äºä¿®æ”¹è¯·æ±‚ï¼Œè¿™é‡Œæœ‰ <strong>ä¹è§‚</strong> å’Œ <strong>æ‚²è§‚</strong> ä¸¤ç§ï¼š</p><ol><li>ä¹è§‚ï¼š<code>btr_cur_optimistic_insert</code>ï¼šå‡è®¾æ²¡æœ‰ SMOï¼Œè¿›è¡Œæ’å…¥</li><li>æ‚²è§‚ï¼š<code>btr_cur_pessimistic_insert</code>ï¼šä¹è§‚æ’å…¥å‘ç°å¶å­ä¼šåˆ†è£‚ï¼Œè¿›è¡Œæ’å…¥</li></ol><p>ä¸Šé¢å†…å®¹ä¸ä¼šå‡ºç°åœ¨ <code>btr_cur_search_to_nth_level</code>ï¼Œä¸è¿‡ä¼šå½±å“ <code>btr_cur_search_to_nth_level</code> çš„å‚æ•° <code>btr_latch_mode</code>. ä»–ä»¬æ’å…¥å†…å®¹å¦‚ä¸‹å›¾ï¼š</p><ul><li>ä¹è§‚æ’å…¥ç±»ä¼¼æŸ¥æ‰¾ï¼Œä¹Ÿæ˜¯ S æ‹¿åˆ° index é”ï¼Œæ‹¿åˆ°å¶å­ç»“ç‚¹çš„ X é”ï¼ˆä¸ºäº†ä¸ S é”äº’æ–¥ï¼‰</li><li>æ‚²è§‚æ’å…¥å‡è®¾è‡ªå·±ä¼šå¼•å‘ SMO ï¼Œé¦–å…ˆï¼Œå®ƒä¼šæ‹¿åˆ° SX é”ã€‚SX é”èƒ½å¤Ÿä¸ SX é”äº’æ–¥ï¼ˆå³ä¸æ‚²è§‚çš„æ’å…¥/åˆ é™¤äº’æ–¥ï¼‰ï¼Œä½†ä¸é˜»å¡è¯»å’Œæ— å…³çš„å†™ã€‚ç„¶åï¼Œä¸‹é™çš„æ—¶å€™ï¼Œå› ä¸ºå·²ç»ç»™btree åŠ ä¸Š SX é”, é‚£ä¹ˆæœç´¢è·¯å¾„ä¸Šçš„btree çš„page éƒ½ä¸éœ€è¦åŠ é”, ä½†æ˜¯éœ€è¦æŠŠæœç´¢è¿‡ç¨‹ä¸­çš„page ä¿å­˜ä¸‹æ¥, æœ€åé˜¶æ®µç»™æœç´¢è·¯å¾„ä¸Šæœ‰å¯èƒ½å‘ç”Ÿç»“æ„å˜åŒ–çš„page åŠ x lockã€‚æ­¤å¤–ï¼Œè¿™é‡Œå¶å­éœ€è¦ Xé”ï¼Œä¸”éœ€è¦<strong>å·¦å³å…„å¼Ÿçš„é”</strong>ã€‚</li></ul><p><img src="https://image.mwish.me/blog-image/ye4VVpc.png" alt="ye4VVpc"></p><h3 id="Cursor-amp-Persistent-Cursor"><a href="#Cursor-amp-Persistent-Cursor" class="headerlink" title="Cursor &amp; Persistent Cursor"></a>Cursor &amp; Persistent Cursor</h3><p>å¯¹äºä¸‹é™å‡½æ•°ï¼Œè¿™é‡Œå¯èƒ½ä¼šä¸‹é™å¾ˆå¤šæ¬¡ï¼Œæœ€ç»ˆåˆ°è¾¾å¶å­ç»“ç‚¹ï¼Œä½†å¯¹äºä¸€ä¸ª Scanï¼Œè‚¯å®šä¸èƒ½æ¯æ¬¡ä¸‹é™ä¸€æ¬¡ã€‚è¿™é‡Œè¦æ ¹æ® page ä¸Šçš„ cursor æ¥åšä¸€äº›æ“ä½œï¼ŒåŒ…æ‹¬ scan çš„ next ä»€ä¹ˆçš„ï¼Œè¿™é‡Œæœ‰ä¸€äº›ä¼˜åŒ–ï¼š</p><ol><li><strong>record buffer</strong>ï¼šå¯¹äºè¿ç»­çš„è®°å½•æ‰«æï¼Œåœ¨æ»¡è¶³æ¯”è¾ƒä¸¥æ ¼çš„æ¡ä»¶æ—¶é‡‡ç”¨ record bufferï¼Œé¢„è¯»å‡ æ¡æ•°æ®</li><li><strong>persistent cursor</strong>ï¼ˆæŒä¹…åŒ–æ¸¸æ ‡ï¼Œç®€ç§° pcurï¼‰ï¼šå½“è¿›å…¥ InnoDB å±‚è·å¾—è®°å½•åï¼Œè¿”å› SQL å±‚å‰ï¼Œå½“å‰åœ¨ B-tree ä¸Šçš„ cursor ä¼šè¢«æš‚æ—¶å­˜å‚¨åˆ° <code>row_prebuilt_t::pcur</code> ä¸­ï¼Œå½“å†æ¬¡ä» InnoDB å±‚æ‹¿æ•°æ®æ—¶ï¼Œå¦‚æœå¯¹åº”çš„ buf_block_t æ²¡æœ‰å‘ç”Ÿä»»ä½•ä¿®æ”¹ï¼Œåˆ™å¯ä»¥ç»§ç»­æ²¿ç”¨ä¹‹å‰å­˜å‚¨çš„ cursorï¼ˆoptimistic restore cursorï¼‰ã€‚å¦åˆ™éœ€è¦é‡æ–°å®šä½ï¼ˆpessimistic restore cursorï¼‰ã€‚å¦‚æœæ²¡æœ‰ persistent cursor åˆ™æ¯æ¬¡éƒ½éœ€è¦é‡æ–°å®šä½</li></ol><p>persistent cursor ä»£ç åœ¨ <code>btr_pcur_t</code>ï¼Œæ–‡ä»¶åœ¨ <code>btr0pcur</code>ã€‚<code>btr_pcur_move_to_next_page</code> æè¿°äº†å®ƒè¯»ä¸‹ä¸€ä¸ªé¡µé¢çš„æµç¨‹ï¼ˆæœ¬é¡µé¢éƒ½æ‰«æå®Œäº†ï¼‰ï¼Œè¿™é‡Œä¼šè·å–ä¸‹ä¸€é¡µé¢ï¼Œå†é‡Šæ”¾æœ¬é¡µé¢çš„é”ã€‚<code>restore_position</code> æè¿°äº† <code>pcur</code> å›åˆ°æœ¬é¡µé¢çš„é€»è¾‘ã€‚</p><p>ä¸Šé¢éƒ½æ¯”è¾ƒç®€å•ï¼Œå› ä¸ºç§»åŠ¨åˆ°ä¸‹ä¸€é¡µç›¸å¯¹æ¯”è¾ƒè½»ï¼Œä½†æ˜¯æ¯”è¾ƒå¤æ‚çš„æƒ…å†µæ˜¯é€†åºæ‰«æï¼Œè¿™é‡Œä»£ç åœ¨ <code>move_backward_from_page</code>ï¼Œè¿™é‡Œå¦‚æœæœç´¢äº†å‰ä¸€ä¸ª Page çš„è¯ï¼Œé‚£ä¹ˆä¼šæœ‰é—®é¢˜ï¼šå…ˆé”å³ - å†é”å·¦è¾¹ä¼šè¿èƒŒ latching protocolï¼Œè¿™é‡Œä¼šï¼š</p><ol><li>é‡Šæ”¾ä¹‹å‰çš„ latch</li><li>åœ¨æ ‘ä¸Šä»æ–°æœç´¢ä¹‹å‰çš„å€¼çš„å‰ä¸€ä¸ªå€¼, <code>btr_search_to_nth_level</code> + <code>BTR_SEARCH_PREV</code></li></ol><h3 id="åˆ†è£‚"><a href="#åˆ†è£‚" class="headerlink" title="åˆ†è£‚"></a>åˆ†è£‚</h3><p>æˆ‘ä»¬ä¹‹å‰ä»‹ç»äº† ä¸‹é™ + æ’å…¥çš„æƒ…å†µã€‚åˆ†è£‚/åˆå¹¶éƒ½æ˜¯ SMO æ“ä½œï¼Œä»–ä»¬æ˜¯ç”±æ‚²è§‚çš„æ’å…¥æ¥æä¾›çš„ã€‚</p><p>Btree åˆ†è£‚åœ¨ <code>btr_page_split_and_insert</code>, åœ¨æ’å…¥ Page çš„æ—¶å€™ï¼Œä¼šæœ‰ä¸€äº›å…ƒä¿¡æ¯æ¥è¡¨ç¤ºé¡ºåºæ’å…¥çš„æ¬¡æ•°ï¼Œå¦‚æœæ’å…¥éƒ½æ˜¯é¡ºåºæ’å…¥æˆ–è€…æ»¡è¶³ä¸€å®šæ¡ä»¶ï¼Œé‚£ä¹ˆ Page ä¼šå‘å³åˆ†è£‚ï¼›å¦åˆ™ä¼šæŒ‰ç…§ bytes ç©ºé—´çš„ 50% æ¥è¿›è¡Œåˆ†è£‚ã€‚</p><p><img src="https://image.mwish.me/blog-image/btr_page_split_and_insert.png" alt="btr_page_split_and_insert"></p><h4 id="æ ¹ç»“ç‚¹çš„åˆ†è£‚"><a href="#æ ¹ç»“ç‚¹çš„åˆ†è£‚" class="headerlink" title="æ ¹ç»“ç‚¹çš„åˆ†è£‚"></a>æ ¹ç»“ç‚¹çš„åˆ†è£‚</h4><p>åœ¨ InnoDB ä¸­ï¼ŒBTree çš„ Root Page æ˜¯ä¸ä¼šæ›´æ”¹çš„ã€‚å¦‚æœæ˜¯ RootPage ä»å¶å­ç»“ç‚¹åˆ†è£‚åˆ°æ ¹ç»“ç‚¹ï¼Œå…·ä½“é€»è¾‘å¦‚ä¸‹ï¼š</p><ol><li>äº§ç”Ÿä¸€ä¸ªå¶å­ç»“ç‚¹</li><li>æŠŠæ ¹ç»“ç‚¹æ•°æ®æ‹·è´ä¸Šå»ï¼Œæ ¹ç»“ç‚¹æŒ‡å‘å®ƒ</li><li>è¿™ä¸ªå¶å­ç»“ç‚¹æ‰§è¡Œåˆ†è£‚</li></ol><p><img src="https://image.mwish.me/blog-image/btr_root_raise_and_insert.png" alt="btr_root_raise_and_insert"></p><h3 id="Insert-Buffer"><a href="#Insert-Buffer" class="headerlink" title="Insert Buffer"></a>Insert Buffer</h3><p>insert buffer å¯¹äº non-unique çš„  secondary index æ‰æœ‰ç”¨ï¼Œåœ¨å†™ç´¢å¼•çš„æ—¶å€™ï¼Œæ— æ³•åŠ è½½åˆ°å†…å­˜ä¸­çš„æ—¶å€™ï¼Œæ’å…¥ insert buffer ä½œä¸ºç¼“å­˜ã€‚</p><p>è¿™å—ä»£ç å…¶å®æ¯”è¾ƒ hack è€Œä¸”æ•£åœ¨å„å¤„ï¼Œæ¯”å¦‚è¯»å–çš„æ—¶å€™è¿˜è¦æŸ¥ä¸€ä¸‹æœ‰æ²¡æœ‰ insert buffer é‡Œé¢çš„å†™ï¼Œç„¶åæŠŠæ•°æ®å€’è…¾è¿›å»ã€‚</p><h3 id="ä¸Šå±‚çš„-ICP-å’Œ-Lock"><a href="#ä¸Šå±‚çš„-ICP-å’Œ-Lock" class="headerlink" title="ä¸Šå±‚çš„ ICP å’Œ Lock"></a>ä¸Šå±‚çš„ ICP å’Œ Lock</h3><p>å¯¹ Btree çš„è®¿é—®æœ¬èº«æ˜¯æ²¡æœ‰é”çš„ï¼Œé”æ˜¯åœ¨ä¸Šå±‚æ‹¿åˆ°çš„ã€‚å¯¹äºä¸€ä¸ªæŸ¥è¯¢ + æ›´æ–°è€Œè¨€ï¼Œå¤§æ¦‚é€»è¾‘å¦‚ä¸‹ï¼š</p><ol><li>ä» btr æŸ¥è¯¢éœ€è¦çš„è¡Œ</li><li>ç»™è®°å½•åŠ é”</li><li>ç”³è¯· undo, å†™ undo</li><li>æ›´æ–°å¯¹åº”çš„è¡Œï¼Œè¿™ä¸ªå’Œ undo å…¶å®æ˜¯ä¸åŒçš„ mtr</li><li>commit</li></ol><p>ICP æ˜¯æŸ¥è¯¢çš„æ—¶å€™å¸¦æœ‰å¯¹åº”çš„è°“è¯ï¼Œå¤§æ¦‚é€»è¾‘å¦‚ä¸‹ï¼š<br><img src="https://image.mwish.me/blog-image/v2-d99e782c382bb6bab211faf1d8f432ac_r.jpeg" alt="v2-d99e782c382bb6bab211faf1d8f432ac_r"></p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ol><li><a href="https://catkang.github.io/2020/02/27/mysql-redo.html">https://catkang.github.io/2020/02/27/mysql-redo.html</a></li><li><a href="https://catkang.github.io/2020/02/27/mysql-redo.html">https://catkang.github.io/2020/02/27/mysql-redo.html</a></li><li>InnoDBï¼šB-tree indexï¼ˆ1ï¼‰ - Skywalkerçš„æ–‡ç«  - çŸ¥ä¹ <a href="https://zhuanlan.zhihu.com/p/164705538">https://zhuanlan.zhihu.com/p/164705538</a></li><li>InnoDBï¼šB-tree indexï¼ˆ2ï¼‰ - Skywalkerçš„æ–‡ç«  - çŸ¥ä¹ <a href="https://zhuanlan.zhihu.com/p/164728032">https://zhuanlan.zhihu.com/p/164728032</a></li><li>InnoDBâ€”â€”Btreeä¸MTRçš„ç‰µæ‰¯: <a href="http://liuyangming.tech/05-2019/InnoDB-Mtr.html">http://liuyangming.tech/05-2019/InnoDB-Mtr.html</a></li><li>MySQL Â· æºç åˆ†æ Â· btr_cur_search_to_nth_level å‡½æ•°åˆ†æ: <a href="http://mysql.taobao.org/monthly/2021/07/02/">http://mysql.taobao.org/monthly/2021/07/02/</a></li><li>MySQL Â· å†…æ ¸ç‰¹æ€§ Â· InnoDB btree latch ä¼˜åŒ–å†ç¨‹: <a href="http://mysql.taobao.org/monthly/2020/06/02/">http://mysql.taobao.org/monthly/2020/06/02/</a></li><li><a href="https://mariadb.org/wp-content/uploads/2018/02/Deep-Dive_-InnoDB-Transactions-and-Write-Paths.pdf">https://mariadb.org/wp-content/uploads/2018/02/Deep-Dive_-InnoDB-Transactions-and-Write-Paths.pdf</a></li></ol>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>æ¯•ä¸šä¸¤å¹´è®°</title>
      <link href="/2022/07/03/%E6%AF%95%E4%B8%9A%E4%B8%A4%E5%B9%B4%E8%AE%B0/"/>
      <url>/2022/07/03/%E6%AF%95%E4%B8%9A%E4%B8%A4%E5%B9%B4%E8%AE%B0/</url>
      
        <content type="html"><![CDATA[<p>ä¸çŸ¥ä¸è§‰æ¯•ä¸šä¸¤å¹´äº†ã€‚åœ¨åŒæµçš„å¿«ä¹æ—¶å…‰å¥½åƒè¿˜åœ¨æ˜¨å¤©ä¸€æ ·â€”â€”æ¯•ä¸šå‰å»åŠ¨ç‰©å›­ã€å»åšç‰©é¦†ã€‚æˆ‘å¹¶ä¸æ˜¯ä¸€ä¸ªå¾ˆæœ‰é›†ä½“è£èª‰æ„Ÿçš„äººï¼Œæ¯•ä¸šé‚£å‡ å¤©çš„æ—¶å€™ç­çº§è¯´æ‹æ¯•ä¸šç…§ï¼Œæˆ‘è§‰å¾—å¤ªæ— èŠäº†å°±çœ‹äº†ä¸€æ™šä¸ŠåŠ¨ç”»ç„¶åç¡åˆ°11ç‚¹æ²¡å»ï¼Œåæ­£å¤§éƒ¨åˆ†äººæˆ‘ä¸Šå­¦çš„æ—¶å€™éƒ½ä¸ç†Ÿæ‚‰ï¼Œä¸‹åˆæ‰“ç€çŒç¡å»å‚åŠ æ¯•ä¸šå…¸ç¤¼æ‰¾äººæ‹ç…§ï¼Œæ¯•ä¸šå…¸ç¤¼çš„æ—¶å€™ä¹Ÿä¸å’‹æ¿€åŠ¨ã€‚ä¸è¿‡æ„Ÿè§‰é‚£ä¼šå„¿æ¯•ä¸šå…¸ç¤¼å¤§å®¶æ„Ÿæƒ…è¿˜ç®—å¾ˆçœŸæŒšï¼Œæ ¡é¢†å¯¼è¯´è¦æŠŠè®ºæ–‡å†™åœ¨ç¥–å›½å¤§åœ°ä¸Šï¼Œè´µæ ¡æäº†è¿™ä¹ˆå¤šåœŸå»ºï¼Œæ„Ÿè§‰å€’æ˜¯æŒºçœŸå®ï¼Œåæ­£è´µæ ¡ se ä¸€å±Š 200äººï¼Œcs 100 äººï¼Œæ¯”èµ·åœŸæœ¨ä¸€ä¸ªé™¢ 500 äººï¼Œæ„Ÿè§‰ä»–ä»¬ç¡®å®æŠŠè‡ªå·±è´¡çŒ®è¿‡å»äº†ã€‚å¤§å®¶ç¡®å®å¾ˆäº†ä¸èµ·ï¼Œå½“ç„¶ï¼Œä¹Ÿæ²¡æœ‰å¾—åˆ°ä»€ä¹ˆåº”å¾—çš„å¾…é‡ã€‚è¯´è¿œäº†ï¼Œæ¯”è¾ƒçœŸæŒšçš„æ˜¯å­¦ç”Ÿä»£è¡¨ï¼Œä¹Ÿæ˜¯åœŸæœ¨çš„ï¼Œæˆç»©ä¸ç®—å¥½é‚£ç§ï¼Œè·Ÿæˆ‘ä»¬è®²è‡ªå·±æ‰¾ä¸åˆ°å·¥ä½œçš„äº‹æƒ…ã€‚æ„Ÿè§‰å‚»é€¼åŒæµæ²¡å•¥äººæ–‡æ°”æ¯ï¼Œä¸è¿‡è¿˜æ˜¯æœ‰ç‚¹çœŸæŒšçš„ã€‚å½“ç„¶ï¼Œè¿™æ˜¯å¥½çš„å›å¿†äº†ï¼Œæˆ‘ä¸çŸ¥é“è¿™å‚»é€¼å­¦æ ¡ä¸€å¹´åæå‡ºäº†å˜‰å®šé£Ÿç‰©ä¸­æ¯’ï¼Œä¸¤å¹´åæå‡ºäº†ç”ŸçŒªè‚‰å’Œèµ¶åšå£«ç”Ÿã€‚å¦ˆçš„ï¼Œæˆ‘åˆæƒ³èµ·å˜‰å®šé‚£è¾¹æä¼šç„¶åæŠŠä¸Šå­¦è·¯å°èµ·æ¥çš„å‚»é€¼äº‹æƒ…äº†ï¼Œè¿˜æœ‰ä¸å¤„ç†å­¦æ ¡é‡ç‹—ä»€ä¹ˆçš„ï¼Œè¶Šæƒ³è¶Šæ°”äº†ã€‚</p><p>è¨€å½’æ­£ä¼ ã€‚æˆ‘æ²¡åœ¨å¤§å­¦å­¦åˆ°ä»€ä¹ˆä¸“ä¸šçŸ¥è¯†ï¼Œå¾ˆå¤šä¸œè¥¿éƒ½æ˜¯ breezewish å­¦é•¿å¸¦æˆ‘è¿› PingCAP å®ä¹ ä¹‹åï¼Œæˆ‘ä»é›¶å¼€å§‹è‡ªå­¦çš„ã€‚æŒ‰ç…§ç–¾ä¸–æ„¤ä¿—æˆ–è€…æ¯”è¾ƒä¸Šè¿›çš„äººçš„æ€è·¯ï¼Œæˆ‘åº”è¯¥å¼€å§‹è¯…å’’å›½å†…å­¦æ ¡çš„åå…«ä»£äº†â€”â€”æˆ–è®¸æˆ‘çœŸçš„åº”è¯¥é‚£ä¹ˆåšï¼Œå•Šå“ˆå“ˆï¼Œä¸è¿‡æˆ‘æ€»æ˜¯æƒ³èµ·ä¸€äº›å¥½çš„å›å¿†ï¼ˆå¯èƒ½æ˜¯æ¯•ä¸šäº†ï¼Œè®°å¿†è‡ªåŠ¨ç¾åŒ–äº†å¾ˆå¤šï¼‰ã€‚æƒ³èµ·æˆ‘åœ¨å¤§å­¦å¯¹ä¸èµ·çš„ä¿¡ä»»æˆ‘çš„äººï¼Œæƒ³èµ·æˆ‘é‚£ä¸‰ä¸ªå’Œæˆ‘ä¸€æ ·çˆ±æ‘¸é±¼çš„èˆå‹ã€æƒ³èµ·æ¥¼ä¸‹201å®¿èˆå¤©å¤©è·‘å»å›¾ä¹¦é¦†çš„å¤§æ‰‹å­ä»¬ï¼Œæƒ³èµ· SXKDZ å­¦é•¿å’Œå˜¤å˜¤å­¦é•¿ã€ç¿å­¦é•¿ã€æ´å”ã€ç‹è¿™äº›äººï¼Œåƒå¡æ—æ ¼è¯´çš„ï¼Œâ€œä½ åƒä¸‡åˆ«è·Ÿæˆ‘æèµ·æ¥ï¼Œä½ ä¸€æ—¦æèµ·æ¥ï¼Œæˆ‘å°±èƒ½æƒ³èµ·ä»–ä»¬æ‰€æœ‰äººâ€ï¼Œå“¦ä¸å¯¹ï¼Œæƒ³èµ·æˆ‘å¤§äºŒçš„æ—¶å€™ SXKDZ å­¦é•¿è¯´çš„â€œè¿™æ˜¯æœ€åä¸€ä¸ªä¸Šè¯¾çš„è€å¸ˆéƒ½çŸ¥é“è‡ªå·±åœ¨ä¸Šä»€ä¹ˆè¯¾çš„å­¦æœŸäº†â€ã€‚æˆ‘æƒ³è¯´çš„æ˜¯ï¼Œ16-20 å¹´ï¼Œè¿™ä¸ªå­¦æ ¡æ²¡ç»™æˆ‘ä»€ä¹ˆå‹åŠ›ï¼Œä¹Ÿæ²¡æœ‰çº¦æŸæˆ‘ä»€ä¹ˆï¼Œæˆ‘ç”¨è¿™æ®µæ—¶é—´å¥½å¥½ç©äº†ä¸€ä¸‹ï¼Œè™½ç„¶æ²¡å­¦åˆ°ä»€ä¹ˆï¼Œä½†æˆ‘å¾ˆå¼€å¿ƒï¼Œè¿™å°±æ˜¯è™šåº¦å…‰é˜´çš„å¿«ä¹å§ã€‚åæ­£å’±è¿™å‚»é€¼åœ°æ–¹æ¯•ä¸šçš„ï¼Œå·¥ä½œä¹Ÿéƒ½æ˜¯è‡ªå­¦ï¼Œæ²¡å•¥ä¸ä¸€æ ·çš„ã€‚</p><p>å·¥ä½œä¹‹åå’Œä¸Šå­¦è¿˜æ˜¯æŒºä¸ä¸€æ ·çš„ï¼Œå·¥ä½œæ˜¯ä¸€ä¸ªå¾ˆå¥‡æ€ªçš„äº‹æƒ…ï¼Œæˆ‘å¤§æ¦‚äº”æœˆä»½æ‰æ‰¾åˆ°ä¸€ä»½æ­£å¼çš„ä¸Šå²¸å·¥ä½œï¼Œå½“æ—¶æˆ‘ç»™å¾ˆå¤šåœ°æ–¹æŠ•ç®€å†éƒ½æ²¡å•¥æ»¡æ„ç»“æœï¼Œç„¶åç»™ä¸€ä¸ªçŸ¥ä¹çš„ç½‘å‹å‘äº†ç§ä¿¡é—®èƒ½ä¸èƒ½å¸®æˆ‘æ¨ä¸€æ¨ç®€å†ï¼Œè¿™æ‰åœ¨æ¯•ä¸šä¹‹å‰ç»ˆäºä¸Šäº†å²¸ã€‚æˆ‘æŠ±ç€å¿å¿‘çš„å¿ƒè¿›äº†çŸ¥åçš„å¥¶å¤´ä¹æ‰¹å‘å•† ByteDanceï¼Œè€å®è¯´ï¼Œæ„Ÿè°¢æˆ‘çš„åŒäº‹ä»¬ï¼Œä»–ä»¬å¯¹æˆ‘è¿˜ç®—å¥½ï¼Œè®©æˆ‘è§‰å¾—è‡ªå·±æ˜¯èƒ½å¤Ÿå½“ä¸€ä¸ªç¤¾ä¼šäººçš„ã€‚å·¥ä½œç”¨å¾ˆå•ä¸€çš„é¢†åŸŸæ¥ä¸æ–­æŒ‘æˆ˜ä½ ã€ç”¨æ—¥å¸¸æ€§éº»ç—¹ä½ ã€ç”¨ä¸åŒçš„äººå¹²åŒæ ·çš„äº‹æ¥ç»™ä½ ä¸€ä¸ªå³å¤šå…ƒåˆå•è°ƒçš„ä¸–ç•Œã€‚ç›¸æ¯”åœ¨å­¦æ ¡å¯èƒ½åšä¸€äº›æ··åˆçš„é¡¹ç›®ï¼Œåœ¨å·¥ä½œä¸­ï¼Œä½ éœ€è¦ä¸€å¤©è¶…è¿‡10å°æ—¶çš„åšä¸€ä»¶äº‹ï¼Œè¿™äº›ä¸œè¥¿æ—¢å¿™ç¢Œåˆçç¢ï¼Œè€Œä¸”ç»©æ•ˆæ¯”æˆç»©æ›´å¥‡æ€ªï¼Œå®ƒä¾é ä½ æœ¬èº«çš„æ°´å¹³ï¼Œä½†æ›´ä¾èµ–ä½ æœ‰ä»€ä¹ˆäº‹æƒ…åšã€‚æˆ‘æœ‰å¹¸èµ¶ä¸Šäº†æœ‰ä»£ç å†™çš„æ—¶å€™ï¼Œç»™å›¢é˜Ÿåšäº†ä¸€äº›ç®€å•è´¡çŒ®ï¼Œä¹Ÿå¾ˆä¸å¹¸å¸¸å¸¸è¢«æŠ“ç€å‡Œæ™¨ oncallã€ç”µè¯è¢«æ‰“çˆ†ã€è¢«ä¸šåŠ¡éªšæ‰°åˆ°ç–²äºå¥”å‘½ã€‚å¦ç™½è¯´ï¼Œåœ¨å­—èŠ‚å·¥ä½œæ‰€æœ‰äººéƒ½æ˜¯çç¢çš„ sreï¼ŒåŒæ—¶ä½ çš„è§è¯†ä¸¥æ ¼è¢«é™å®šäºåŒäº‹ä»¬ã€‚è™½ç„¶å¤§å…¬å¸é‡Œé¢æœ‰éå¸¸å¤šçš„å­¦ä¹ èµ„æºï¼Œä½†æ˜¯å¾ˆå¤šä¸œè¥¿æˆ‘ç¡®å®ä¹Ÿæ²¡è®¤çœŸçœ‹ï¼Œç®—æ˜¯è™šåº¦äº†ä¸å°‘å…‰é˜´ã€‚æ„Ÿè°¢ä»»è€å¸ˆåœ¨è¿™æ®µæ—¶é—´æ•™äº†æˆ‘éå¸¸å¤šçš„çŸ¥è¯†ï¼Œç»™æˆ‘å¾ˆå¤šå¸®åŠ©ï¼›ä¹Ÿæ„Ÿè°¢ cc å’Œ zz è¿™ä¸¤ä½åŒäº‹å¸®æˆ‘æŒ¡ä½å’Œè§£å†³äº†å¾ˆå¤šå›°éš¾ï¼Œä¹Ÿæ²¡æœ‰åœ¨å·¥ä½œä¸Šç»™æˆ‘å¤ªå¤§å‹åŠ›ï¼Œç»™äº†æˆ‘ä¸€ä¸ªè¿˜ç®—æ„‰å¿«çš„å·¥ä½œç¯å¢ƒå¹¶ä½œä¸ºæˆ‘çš„å­¦ä¹ æ¦œæ ·ã€‚åˆšå‚åŠ å·¥ä½œçš„æ—¶å€™å¿ƒæ€ç»å¸¸å‡ºé—®é¢˜ï¼Œä¹Ÿé ç€ç¾¤é‡Œçš„æœ‹å‹ä»¬èƒ½èˆ’ç¼“æƒ…ç»ªï¼Œçœ‹ç€å¤§å®¶è½®æµå‘ç—…ï¼Œæ¥åœ¨ 99 ä¸ªæœªæ¥æ¥ç”µä¹‹ä¸­èˆ’ç¼“æƒ…ç»ªã€‚è‡ªå·±ä¹Ÿæ…¢æ…¢èƒ½å¤Ÿç¿»ç€ä¸€äº› pptï¼ŒæŠŠè®¡ç®—æœºå’Œæ•°æ®åº“çš„åŸºç¡€æ…¢æ…¢è¡¥ä¸Šã€‚å¦ç™½è¯´æˆ‘å¾ˆç¬¨ï¼Œæ‚Ÿæ€§å¾ˆå·®ï¼Œå¾ˆå¤šä¸œè¥¿çœ‹äº†ä¸€éä¹Ÿè‰è‰çœ‹è¿‡ï¼Œå…¶å®å¹¶æ²¡æœ‰çœ‹æ‡‚ï¼Œæˆ‘ä¹Ÿä¸æ“…é•¿å’Œäººäº¤æµã€æ‰¾åˆ°åˆé€‚çš„åœ°æ–¹é—®è¿™äº›é—®é¢˜ï¼Œç”šè‡³ä¸æ“…é•¿å†™ä»£ç ï¼Œä¸å¤ªèƒ½æ‰¾åˆ°ä¸€ä¸ªä¸“ä¸€çš„ç›®æ ‡ç„¶åç»§ç»­å¹²å®Œã€‚ä½†æ¯•ç«Ÿè‡ªå·±ä¸€ç›´åœ¨æ…¢æ…¢çœ‹ä¹¦ã€åœ¨ç»„é‡Œå‚ä¸å†™ä»£ç ï¼ŒæŒæ¡çŸ¥è¯†æ¯”åˆ«äººæ…¢å°±æ…¢å‘—ï¼Œæ¯•ç«Ÿæˆ‘è¦çœ‹åŠ¨ç”»æ‰“æ¸¸æˆçš„ï¼Œä¸Šç­å‡‘åˆå‡‘åˆç€è¿‡ç†¬èµ„å†å‘—ï¼Œä¸è¿‡æ»¡æ»¡çš„è¿™æ ·æ„Ÿè§‰ç»ˆäºèƒ½å¤Ÿè·Ÿä¸Šä¸€äº›è¡Œä¸šçŸ¥è¯†çš„èƒŒå½±äº†ï¼Œä¹Ÿèƒ½å¤Ÿåœ¨å…¬å¸ç»„é‡Œå°å°çš„ç«‹è¶³äº†ã€‚è¿™æ®µæ—¶é—´ä¹Ÿç®—å…¥é—¨äº†ä¸€äº›ç¤¾ä¼šç§‘å­¦ï¼Œä»å•¥éƒ½ä¸æ‡‚çš„åˆ°å¯¹æ¶‚å°”å¹²ã€éŸ¦ä¼¯ã€é©¬å…‹æ€ä»–ä»¬æœ‰æµ®å…‰æ å½±çš„äº†è§£ã€‚</p><p>ä½†æ˜¯æ¯•ä¸šä»¥åæœ€å¼€å¿ƒçš„æ—¶å…‰è¿˜æ˜¯å›å®¶æˆ–è€…å»ä¸Šæµ·æ‰¾è€åŒå­¦ã€‚åŒ—äº¬æ˜¯ä¸€ä¸ªå¥‡æ€ªçš„åœ°æ–¹ï¼Œå®ƒç»™æ¯ä¸ªåŒºå›ºå®šäº†ç”¨å¤„ï¼ŒåŒºåˆ†äº†å¸‚å†…å’ŒéƒŠå¤–ï¼ŒåŸå¸‚è¢«ä¸¥æ ¼çš„åˆ‡æˆç¢å—ï¼Œå®ƒæœ‰ä¸°å¯Œçš„æ–‡åŒ–é—äº§å’Œæ‚ ä¹…çš„å†å²ï¼Œä½†åƒåˆ—æ–ä¼å°”æè¿°çš„é‚£æ ·ï¼Œè¿™å¤šå°‘æœ‰ç‚¹åƒã€Œè®¾è®¡ä¸“å®¶ã€è®¾è®¡çš„å±…ä½åŸå¸‚ï¼Œä½ åœ¨è¿™é‡Œæ„Ÿå—ä¸åˆ°ç”Ÿæ´»ã€‚è™½ç„¶æµ·æ·€åŒºå­¦æ ¡æ‰å †ï¼Œä½†å¾ˆéš¾çœ‹åˆ°æ‰€è°“çš„å¯Œæœ‰ç”Ÿæ´»æ°”æ¯çš„äººâ€”â€”æˆ–è®¸æœ‰ï¼Œä½†æœ10æ™š10çš„ç¨‹åºå‘˜å¯èƒ½çœ‹ä¸åˆ°å§ã€‚å®ƒè¿˜ä¼šç”¨æˆ·å£å’Œä»·æ ¼ç­‰æ–¹å¼æ‹’ç»ä½ ã€‚åœ¨è¿™é‡Œï¼Œæˆ‘æ„Ÿå—åˆ°ä¸€è‚¡æµ“æµ“çš„ã€Œå¼‚ä¹¡ã€æ„Ÿâ€”â€”â€œæ²¡æœ‰æ•…ä¹¡çš„äººæœ‰éš¾äº†ï¼â€ä»Šå¹´çš„ç–«æƒ…åŠ é‡äº†è¿™ä¸€ç°è±¡ï¼Œåœ¨å°é—­ã€ä¹±è±¡ã€ç½‘ç»œä¸Šçš„æ°‘ç²¹å’Œ long lockdown ä¸­ï¼Œäººéš¾å…ä¸æ„Ÿå—åˆ°è¿™ä¸ªä¸–ç•Œçš„ç„¦è™‘ã€‚å½“ç„¶ï¼Œæˆ‘ä»¬å¯ä»¥å€Ÿç€è¿™ä¸ªèŠç¦æŸ¯ã€èŠç»æµã€èŠè¿™ä¸ª covid å¤§æµè¡Œå’Œåˆ«çš„å¯æ€œäº‹æƒ…ä¹Ÿå¤šçš„ä¸–ç•Œã€‚ä½†æˆ‘åªæƒ³èŠèŠè¿™ç§æŠ›å¼ƒæ„Ÿå’Œç„¦è™‘: ã€Œå¦‚æœä¸€ç›´å¾…åœ¨è¿™ç§åœ°æ–¹ï¼Œæ˜¯æ²¡æœ‰åŠæ³•å¡‘é€ ç¾å¥½çš„å›å¿†çš„ã€ã€‚ææƒšä¹‹é—´æƒ³èµ·å¿«ä¹çš„æ—¶å€™ï¼Œåœ¨å®¶è¾¹ä¸Šéª‘è½¦ã€åœ¨å®¶é‡Œå’ŒåŒå­¦çœ‹ç”µå½±ã€ç»™çˆ¸å¦ˆä¸‹ç‰‡å­ã€åˆ°å¤§å­¦åŒå­¦å®¶å€Ÿå®¿å’Œæ‰“æ‰«å«ç”Ÿã€‚äººçš„æ—¥å¸¸ç”Ÿæ´»æœ‰å¤šç¾å¥½çš„æ½œåŠ›ï¼Œä½†æ˜¯æ—¥å¸¸æ˜¯ä¸ä¼šè‡ªå·±æ”¹å˜æ—¥å¸¸çš„ï¼Œæ—¥å¸¸è¦é è¶…è¶Šæ€§çš„æˆ–è€…ç ´åæ€§çš„å†…å¤–åŠ›é‡æ¥æ”¹å˜ã€‚æ‰€ä»¥ä»Šå¹´æˆ‘ä¹Ÿå¸Œæœ›è‡ªå·±èƒ½æœ‰ä¸€äº›å˜åŒ–å§ã€‚</p><p>çœ¨çœ¼å°±æ¯•ä¸šä¸¤å¹´äº†ï¼Œæœ¬æ¥æƒ³å†™å†™åŒå­¦ã€å†™å†™å·¥ä½œã€å†™å†™æ„Ÿè°¢çš„åŒäº‹ã€æœŸç›¼ä¸€ä¸‹è‡ªå·±æœªæ¥èƒ½ç¨å¾®ä¸é‚£ä¹ˆèœä¸€ç‚¹ï¼Œä¸è¿‡æ„Ÿè§‰è¿™æˆäº†è€å¹´äººå‘ç‰¢éªšäº†ã€‚æ€»è€Œè¨€ä¹‹ï¼Œå¸Œæœ›å­¦æ ¡çš„å›å¿†èƒ½ä¸€ç›´æ˜¯æˆ‘ç¾å¥½çš„è®°å¿†ï¼Œæˆ‘èƒ½é ç€è¿™ä»½ç¾å¥½çš„å›å¿†ï¼Œåˆ›é€ ä¸€äº›æ–°çš„ç¾å¥½è®°å¿†ã€‚</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>[VLDB&#39;17] An Empirical Evaluation of In-Memory Multi-Version Concurrency Control</title>
      <link href="/2022/07/03/An-Empirical-Evaluation-of-In-Memory-Multi-Version-Concurrency-Control/"/>
      <url>/2022/07/03/An-Empirical-Evaluation-of-In-Memory-Multi-Version-Concurrency-Control/</url>
      
        <content type="html"><![CDATA[<p>æœ¬æ–‡æ˜¯ä¸€ç¯‡å…³äº MVCC çš„ç»¼è¿°ï¼Œå°† MVCC åˆ†ä¸ºäº† protocol, version storage, index-management, gc å››ä¸ªéƒ¨åˆ†, åœ¨ Peleton ä¸Šå®ç°äº†å„ç§ protocol, è¿›è¡Œè¯•éªŒï¼Œç„¶å benchmarkã€‚benchmark ç»“æœæ˜¯ï¼šprotocol ä¸Šçœ‹äº‰ç”¨ï¼Œè¯»å¤šå†™å°‘äº‰ç”¨å¤šçš„è¯ï¼Œ2PL/OCC åè€Œä¸å¤ªè¡Œï¼›N2O å‡ ä¹æ€»æ˜¯æ¯” O2N å¥½ï¼Œä¸è¿‡ O2N å¯ä»¥GCï¼›Delta å ç”¨çš„ç©ºé—´å°ä¸€äº›ï¼ˆDelta ç±»ä¼¼ MySQL Undo log bufferï¼‰ï¼›Txn Level GC å¥½ä¸€äº›ï¼Œä½†å®ç°éš¾åº¦é«˜ä¸€äº›ã€‚</p><p>å½“åˆç¬¬ä¸€æ¬¡çœ‹çš„æ—¶å€™å¤§æ¦‚æ‡‚äº†å¤§æ„ï¼Œä¸è¿‡å½“æ—¶å¯¹ MVCC æ²¡çœ‹è¿‡ä»€ä¹ˆä»£ç ï¼Œä¹Ÿæ²¡æœ‰ä»€ä¹ˆåŸºæœ¬ç†è§£ï¼Œæœ€è¿‘çœ‹ WiredTiger/PostgreSQL/InnoDB çš„æ—¶å€™æ„Ÿè§‰ç†è§£äº†ä¸€äº› contextï¼Œå›å¤´å†™ä¸€ç‚¹æ€»ç»“ï¼Œä¹Ÿæ··æ‚ä¸€äº›æˆ‘å¯¹ WT/PG/InnoDB çš„ç†è§£ã€‚</p><p>å…³äº MVCCï¼Œæœ‰çš„åœ°æ–¹å®é™…æ€€ç–‘å®ƒæ˜¯å¦ç‰ºç‰²äº†ç©ºé—´ä»¥æ¢å–äº†ä¸çŸ¥é“æœ‰æ²¡æœ‰çš„æ€§èƒ½ï¼Œå…³äºè¿™äº›äº‰è®ºï¼Œæˆ‘ä¸ªäººæƒ³æ³•ç±»ä¼¼ Hekaton è®ºæ–‡é‡Œé¢çš„ç†è§£ï¼šMVCC å¯èƒ½åœ¨å†²çªä½çš„æƒ…å†µä¸‹é™ä½äº†æ€§èƒ½å’Œå±€éƒ¨æ€§ï¼Œä½†æ˜¯å¢å¼ºäº†ç³»ç»Ÿå¯¹æŠ—ä¸€äº›æ··åˆè´Ÿè½½çš„èƒ½åŠ›ã€‚åŒæ—¶ï¼ŒMVCC æ–¹ä¾¿æ”¯æŒä¸€äº› Time-Traver æŸ¥è¯¢ï¼ˆç±»ä¼¼ MySQL / PG çš„ PITR ç³»ç»Ÿï¼‰ã€‚</p><p>ä¹‹æ‰€ä»¥æœ‰è¿™ç¯‡è®ºæ–‡ï¼Œæ˜¯å› ä¸º MVCC è™½ç„¶å†å²æ‚ ä¹…ï¼Œä½†æ˜¯å‡ ä¹æ‰€æœ‰æ–°ç³»ç»Ÿéƒ½è‡ªå·±å—¯é€ äº†ä¸€å¥—ï¼Œæ‰€ä»¥éœ€è¦è¡¡é‡ä¸€ä¸‹å¯¹åº”çš„ design choice å’Œ trade-off</p><h3 id="DBMS-Meta-Data"><a href="#DBMS-Meta-Data" class="headerlink" title="DBMS Meta-Data"></a>DBMS Meta-Data</h3><p>è®ºæ–‡è®²æ•°æ®åˆ†ä¸ºä¸‹åˆ—æ•°æ®ï¼Œæ„Ÿè§‰æ˜¯ä½œè€…åœ¨ Peloton å®ç°çš„æ•°æ®ï¼š</p><p><img src="https://image.mwish.me/blog-image/97119CA8-7614-4F6F-841C-386E9B579756.png" alt="97119CA8-7614-4F6F-841C-386E9B579756"></p><p>äº‹åŠ¡éœ€è¦ä¸€ä¸ªç‹¬ç«‹çš„ï¼Œå•è°ƒé€’å¢çš„æ ‡è®°æ¥è¯†åˆ«ï¼Œæ–‡ä¸­è®°ä½œ $T_{id}$ .</p><p>åŒæ—¶ï¼Œç‰©ç†çš„ç‰ˆæœ¬åŒ…æ‹¬äº† <code>txn-id</code>, ä¸¤ä¸ªæ—¶é—´æˆ³å’Œç‰ˆæœ¬æŒ‡é’ˆï¼Œäº‹åŠ¡ id ç±»ä¼¼ Hekaton çš„ï¼Œæœ€é«˜ä½è¡¨ç¤ºæ˜¯å¦æœ‰ write-lockï¼Œç„¶åè®ºæ–‡ç”¨ CAS åšä¿®æ”¹ï¼Œæˆ‘ä»¬å¯ä»¥å¯¹æ¯”ä¸€ä¸‹ PostgreSQL å’Œ InnoDB çš„è®°å½•ï¼š</p><ul><li>PostgreSQL çš„ xmax(ç±»ä¼¼ end-ts ) å……å½“äº† txn-id ä½œç”¨ï¼Œè¡¨ç¤ºå¯¹å¯¹è±¡ä¸Šé”ã€‚è®ºæ–‡é‡Œå¯èƒ½æœ‰å¤šä¸ª in-flight çš„äº‹åŠ¡åœ¨åŒä¸€æ¡è®°å½•ä¸Šï¼Œæ‰€ä»¥æ„Ÿè§‰å¼•å…¥ä¸€ä¸ª txn-id ä¹Ÿæ²¡å•¥é—®é¢˜ã€‚æ­¤å¤–ï¼ŒPostgreSQL çš„è¡Œè¿˜å¼•å…¥äº† info bitsï¼Œé¿å…æŸ¥äº‹åŠ¡è¡¨æ¥ç¡®å®š <code>txn</code> çš„çŠ¶æ€ï¼Œæ‰€ä»¥ç›¸å½“äºä¸Šé¢ txn-id å’Œ end-ts åšåˆ°äº†ä¸€èµ·ï¼ŒPG æœ‰ä¸€ä¸ª <code>c_tid</code>ï¼Œç›¸å½“äºä¸Šé¢çš„ pointerï¼ŒæŒ‡å‘è‡ªå·±æˆ–è€…æ›´æ–°çš„ç‰ˆæœ¬ã€‚</li></ul><p><img src="https://image.mwish.me/blog-image/fig-5-03.png" alt="fig-5-03"></p><ul><li>PostgreSQL çš„ txn-id å’Œæ—¶é—´æ˜¯ 32-bit çš„ï¼Œæ‰€ä»¥æœ€å¤§ä¹Ÿå°±4äº¿ï¼Œå æœ‰ç©ºé—´å°ï¼Œä½†æ˜¯éœ€è¦ FREEZE ï¼ˆå†»ç»“ç‰ˆæœ¬ï¼‰å’Œ Vacuumï¼ˆå›æ”¶ï¼‰æ¥å¤„ç†ã€‚InnoDB å¯èƒ½éœ€è¦ç”¨æˆ·æä¾›çš„ gtid ä»€ä¹ˆçš„ã€‚å®ƒåªæœ‰ä¸€ä¸ªç±»ä¼¼ ts çš„å­—æ®µï¼Œå› ä¸ºæ¯”å®ƒå°çš„å°±ä¼šèµ° undo chainã€‚<strong>PG éœ€è¦ x-min, x-max; ä½† InnoDB ç”¨ txn-id + roll_pointer</strong> åšäº†é€»è¾‘ä¸Šä¸€æ ·çš„äº‹æƒ…ã€‚é‚£åˆ é™¤ä¼šæ€ä¹ˆæ ·å‘¢ï¼ŸInnoDB è®°å½•åˆšè¢«åˆ é™¤ä¼šæŒ‚ä¸Šä¸€ä¸ª delete-markï¼Œç„¶åæŒ‡å‘ undo ä¸Šçš„ delete è®°å½•ã€‚</li><li>InnoDB åªæœ‰ä¸€ä¸ª txn-idï¼Œå¤§äºå°±è¯»å®ƒï¼Œå¦åˆ™å°±èµ°ä¸Šæ–‡ pointer çš„å­—æ®µï¼Œå¦‚ä¸‹å›¾ã€‚è¿™äº›å­—æ®µè¢«ç§°ä¸º hidden columnsã€‚æ­¤å¤–ï¼ŒInnoDB Undo å®é™…ä¸Šå­˜æ”¾çš„æ˜¯<strong>é€»è¾‘æ—¥å¿—</strong></li></ul><p><img src="https://image.mwish.me/blog-image/undo_logical.png" alt="undo_logical"></p><p><img src="https://image.mwish.me/blog-image/31C650E4-80D1-4C76-8A9A-91F8EDD7E522.png" alt="31C650E4-80D1-4C76-8A9A-91F8EDD7E522"></p><p>æ€»çš„æ¥è¯´ï¼Œæ„Ÿè§‰è¿™ç¯‡è®ºæ–‡è¿˜æ˜¯åå†…å­˜æ•°æ®åº“ä¸€äº›ï¼Œç„¶åè€ƒè™‘äº†å¹¶å‘æ›´æ–°ä»€ä¹ˆçš„ã€‚</p><h2 id="Concurrency-Control-Protocol"><a href="#Concurrency-Control-Protocol" class="headerlink" title="Concurrency Control Protocol"></a>Concurrency Control Protocol</h2><p>åœ¨è®ºæ–‡ä¸­ï¼Œcc ç›¸å½“äºå®šä¹‰äº†ï¼š</p><ol><li>æ˜¯å¦å…è®¸ txn è®¿é—®æˆ–è€…æ›´æ–°ä¸€ä¸ª tuple</li><li>å…è®¸ txn æ¥ commit è‡ªèº«çš„æäº¤</li></ol><p>ç»å…¸çš„ Concurrency control åŒ…æ‹¬æˆ‘ä»¬ç†Ÿæ‚‰çš„å†…å®¹ï¼š</p><ol><li><p>Transaction, OCC and Modern Hardware: <a href="https://blog.mwish.me/2022/01/28/Transaction-OCC-and-modern-hardware/">https://blog.mwish.me/2022/01/28/Transaction-OCC-and-modern-hardware/</a></p></li><li><p>äº‹åŠ¡: å¹¶å‘æ§åˆ¶åè®®: 2PL &amp;&amp; TS: <a href="https://blog.mwish.me/2020/11/15/transaction-concurrency-control/">https://blog.mwish.me/2020/11/15/transaction-concurrency-control/</a></p></li></ol><p>å¯èƒ½æ˜¯å‡ºäºå®ç°ç²’åº¦å’Œå­¦æœ¯è¿½æ±‚ï¼Œè®ºæ–‡åªè€ƒè™‘ Tuple Level MVCC + Serializableã€‚å®è·µä¸­ï¼Œæ„Ÿè§‰è¿™äº›çº§åˆ«è¿˜æ˜¯æ¯”è¾ƒé«˜ï¼Œæœ‰æ¯”è¾ƒå¤šçš„åœºæ™¯è¿˜æ˜¯ SI / RR + SELECT for update è¿™ç§ã€‚åŒæ—¶ï¼Œè®ºæ–‡ä¹Ÿæ”¾å¼ƒäº†ä¸­å¿ƒåŒ–çš„ Lock Managerï¼Œè¿™æ ·çš„ä¸œè¥¿å¾ˆå®¹æ˜“æˆä¸ºä¸€ä¸ªæ€§èƒ½ä¸Šçš„ç“¶é¢ˆã€‚</p><h3 id="MVTO"><a href="#MVTO" class="headerlink" title="MVTO"></a>MVTO</h3><p>ç±»ä¼¼ TS åè®®: <a href="https://blog.mwish.me/2020/11/15/transaction-concurrency-control/#TS">https://blog.mwish.me/2020/11/15/transaction-concurrency-control/#TS</a> </p><p><img src="https://image.mwish.me/blog-image/15916E36-99FF-406A-BB36-49819AC7A8B9.png" alt="15916E36-99FF-406A-BB36-49819AC7A8B9"></p><p>è®ºæ–‡ figure 2.a åšäº†ä¸€ä¸ªå›¾ç¤ºï¼Œè¯»ä¼šæ›´æ–°å¯¹åº”çš„ <code>ReadTS</code>, è¿™æ˜¯ä¸€ä¸ªé¢å¤–éœ€è¦çš„å­—æ®µï¼Œè¯»ä¼šå¢åŠ è¿™ä¸ªå­—æ®µçš„å†…å®¹ï¼Œç„¶åå†™çš„æ—¶å€™å†™å…¥çš„ç‰ˆæœ¬ä¸ä»…éœ€è¦è‡ªå·±æ˜¯å”¯ä¸€çš„å†™ï¼Œè¦æ¯”æœ€å¤§çš„è¯»å–ç‰ˆæœ¬é«˜ï¼Œå¦åˆ™å°±è§†ä½œè¯»äº†ä¸åˆæ³•çš„æ•°æ®ã€‚</p><p>å®é™…ä¸Šï¼Œè¿™é‡Œæ„Ÿè§‰åªæœ‰è¯»æœ€æ–°çš„ç‰ˆæœ¬ä¼šå¯¹äº‹åŠ¡æ›´æ–°äº§ç”Ÿå½±å“ï¼Œç„¶åè¿™ä¸ªå¹¶å‘æ„Ÿè§‰éœ€è¦æ§åˆ¶çš„æ¯”è¾ƒå¥½ã€‚</p><h3 id="MVOCC"><a href="#MVOCC" class="headerlink" title="MVOCC"></a>MVOCC</h3><p>æˆ‘å†™è¿‡ä¸€æ®µæ¯”è¾ƒé•¿çš„æ–‡ç« æ¥ä»‹ç» OCCï¼Œå‚è€ƒï¼š<a href="https://blog.mwish.me/2022/01/28/Transaction-OCC-and-modern-hardware/#MVOCC">https://blog.mwish.me/2022/01/28/Transaction-OCC-and-modern-hardware/#MVOCC</a></p><p>MVOCC æœ‰ä¸€ç‚¹å¥½ï¼Œå°±æ˜¯ OCC æ˜¯ read - verification - write ä¸‰ä¸ªé˜¶æ®µã€‚å¯¹äº MVOCC è€Œè¨€ï¼Œå¯ä»¥ç»™æ¯ä¸ªæ•°æ®å¸¦ä¸Šä¸€ä¸ª begin-ts å’Œ end-tsï¼Œè¿™é‡Œå°±ä¸ç”¨æ‹·è´äº‹åŠ¡çš„ private space äº†ï¼Œå–è€Œä»£ä¹‹çš„æ˜¯ GC é—®é¢˜ã€‚</p><p>è®ºæ–‡æè¿°äº†å®ƒçš„ MVOCC ç®—æ³•ï¼ŒåŸå…ˆçš„å®ç°ä¸­ï¼Œé æ‹·è´è¯»å†™é›† + éªŒè¯æ¥è§£å†³ï¼Œè€Œç°åœ¨å¯ä»¥å½“ä½œè¯»çš„ ts å’Œæäº¤ ts ä¹‹é—´åšéªŒè¯ï¼Œçœ‹è¿™æ®µæ—¶é—´æœ‰æ²¡æœ‰è¢«åˆ«äººæ”¹è¿‡ã€‚ç›¸å¯¹ OCCï¼ŒMVOCC å¾ˆå¤šæ—¶å€™ç”šè‡³ç›´è§‚ä¸€äº›ã€‚</p><ol><li>Read phase: æ‹¿åˆ°ä¸€ä¸ªè¯»å–ç”¨çš„ txn-id å’Œ tsï¼Œç”¨æ¥è¯»å–æ•°æ®ï¼Œå†™å…¥çš„æ—¶å€™åªèƒ½å†™å…¥æ²¡æœ‰å†™å…¥å†²çªçš„æ•°æ®ã€‚è¯»å–è®°å½•åˆ° read-set ä¸­</li><li>Validation phase: æ‹¿åˆ° commit ts, çœ‹ read-set æœ‰æ²¡æœ‰è¢«åˆ«äººæ›´æ–°ï¼ˆå› ä¸º ts æ˜¯é€’å¢çš„ï¼Œè¿› validation è¯´æ˜ï¼Œåªæœ‰å‘ç° commit-ts åœ¨ read-ts å’Œè‡ªå·±çš„ commit-ts ä¹‹é—´çš„è®°å½•ï¼Œæ‰éœ€è¦æ”¹æ‰ï¼‰</li><li>æäº¤ï¼ŒæŠŠ MVCC è®°å½•æäº¤</li></ol><p><img src="https://image.mwish.me/blog-image/FA5699F5-1384-4BA3-AC77-C8D32D8CD423.png" alt="FA5699F5-1384-4BA3-AC77-C8D32D8CD423"></p><p>æ˜¾ç„¶ï¼Œä¸Šè¿°ç®—æ³•â€¦å¯èƒ½é¥¿æ­» long runing read-only txnâ€¦</p><h3 id="MV2PL"><a href="#MV2PL" class="headerlink" title="MV2PL"></a>MV2PL</h3><p>ä½œè€…çš„å®ç°ä¸­ï¼Œå®ƒä½¿ç”¨äº† no-wait æ¥å®ç° 2PL çš„å†²çªå¤„ç†ï¼Œåœ¨è¯»çš„æ—¶å€™åŠ è¯»é”ï¼Œå†™çš„æ—¶å€™åŠ å†™é”ã€‚è¿™äº›éƒ½åœ¨ tuple ä¸Šç”¨è®¡æ•°å™¨å®ç°ï¼Œæœ¬è´¨ä¸Šæœ‰ç‚¹ç‚¹å°ç±»ä¼¼ ts åè®®ï¼Œåªä¸è¿‡ ts æ˜¯è¯»çš„æ—¶å€™ inc counterï¼Œ2PL æ˜¯å†™ä¸Šå†™é” + å†™é”å’Œè¯»çš„è®¡æ•°å™¨äº’æ–¥ã€‚å‘ç°æœ‰åˆ«äººåœ¨å†™å°±ç›´æ¥ abort è‡ªå·±ï¼Œæ»¡ç²—æš´çš„ã€‚</p><p><img src="https://image.mwish.me/blog-image/F713048B-C6A6-4F32-A7B9-243DDADFF4BA.png" alt="F713048B-C6A6-4F32-A7B9-243DDADFF4BA"></p><h3 id="Serialization-Certiï¬er"><a href="#Serialization-Certiï¬er" class="headerlink" title="Serialization Certiï¬er"></a>Serialization Certiï¬er</h3><p>ç±»ä¼¼ SSIï¼Œè¯†åˆ« dangerous structureï¼Œæ¥åšå¤„ç†ã€‚ </p><h3 id="è®¨è®º"><a href="#è®¨è®º" class="headerlink" title="è®¨è®º"></a>è®¨è®º</h3><ul><li>MV2PL / MVTS çš„è¯»è¦æ”¹ counter / lockï¼Œæœ‰ä¸€äº›è´Ÿè½½ï¼ŒåŒæ—¶ä¼šå¯¼è‡´ä¸€äº›ä¼ªé˜³æ€§çš„ abortã€‚</li><li>MVOCC çš„ç®—æ³•å¯èƒ½å¯¼è‡´é•¿è¯»äº‹åŠ¡é¥¿æ­»</li></ul><p>ç›¸å…³çš„ï¼Œæœ‰ä¸€äº›ä¼˜åŒ–çš„ææ¡ˆï¼š</p><ol><li>speculatively read uncommitted versions. Hekaton ç”¨äº†è¿™ä¸ª. å¦‚æœäº‹åŠ¡å†²çªå°‘, è¿™æ˜¯è‰¯è¯, å¦åˆ™å°±æ˜¯æ¯’è¯ã€‚ä¸ºäº†åš cascading abort, è¿™é‡Œè¿˜è¦åšä¸€äº› dependency graph ä¹‹ç±»çš„ï¼Œè¿™éš¾å…ä¼šæ˜¯ä¸ªæœ‰äº›ä¸­å¿ƒåŒ–çš„ç»“æ„ã€‚</li><li>eagerly update, Hekaton ä¹Ÿåšäº†è¿™ä¸ªä¼˜åŒ–ï¼Œç¼ºç‚¹åŒ (1)</li></ol><h2 id="Version-Storage"><a href="#Version-Storage" class="headerlink" title="Version Storage"></a>Version Storage</h2><p>è¿™é‡Œçš„å†…å®¹åŒ…å«ï¼š</p><ol><li>æ•°æ®åº“æ€ä¹ˆå­˜å‚¨ä¸åŒçš„ç‰©ç†ç‰ˆæœ¬</li><li>æ¯ä¸ªç‰ˆæœ¬åŒ…å«çš„ä¿¡æ¯</li></ol><p>DBMS å¯ä»¥åŒ…å«ä¸€ä¸ª latch-free çš„åŒä¸€ä¸ª tuple çš„ç‰ˆæœ¬å•é“¾è¡¨ï¼ˆlatch-free çš„åŒé“¾è¡¨æ˜¯å¾ˆéš¾çš„ï¼‰ï¼Œç‰ˆæœ¬é“¾çš„å¤´å¯ä»¥æ˜¯ newest æˆ–è€… oldest çš„äº‹åŠ¡ã€‚</p><h3 id="Append-only-Storage"><a href="#Append-only-Storage" class="headerlink" title="Append-only Storage"></a>Append-only Storage</h3><p>åœ¨ PostgreSQL, Hekaton, MemSQL é‡‡ç”¨çš„æ˜¯è¿™ç§ç­–ç•¥ï¼š</p><p><img src="https://image.mwish.me/blog-image/8B61A2DA-C237-4696-9295-C4EE2572D9C3.png" alt="8B61A2DA-C237-4696-9295-C4EE2572D9C3"></p><p>O2N å’Œ N2O åˆ†åˆ«æ˜¯æ—§åˆ°æ–° â€” æ–°åˆ°æ—§ã€‚</p><p>O2N çš„å¥½å¤„æ˜¯ï¼Œæ²¡æœ‰æ›´æ–°ç´¢å¼•å­—æ®µçš„è¯ï¼Œç´¢å¼•æ˜¯ä¸ç”¨ä¿®æ”¹çš„ï¼Œä½†æ˜¯è¿™ä¸ªæ—¶å€™ DBMS å¯èƒ½è¦èµ°å¾ˆé•¿çš„ç‰ˆæœ¬é“¾æ¥æŸ¥æ‰¾è®°å½•ï¼Œç„¶åèµ° chain æŸ¥æ‰¾è¿˜æ˜¯æ¯”è¾ƒæ…¢çš„ï¼Œæ‰€ä»¥è¿™é‡Œä¾èµ–æ¯”è¾ƒé¢‘ç¹çš„ GC æ¥ä¿è¯æ€§èƒ½ã€‚</p><p>N2O éœ€è¦åœ¨ç´¢å¼•å€¼æ²¡å˜æ›´çš„æ—¶å€™ä¹Ÿæ›´æ–°ç´¢å¼•ï¼Œé€ æˆäº†ä¸€å®šçš„å¼€é”€ã€‚</p><p>å¦ä¸€ä¸ªé—®é¢˜æ˜¯å¯¹ non-inline attributes çš„å¤„ç†ï¼Œæ¯”å¦‚ MySQL çš„ BLOB æˆ–è€… PG çš„ TOASTï¼Œä¸åŒçš„ç‰ˆæœ¬å¯èƒ½å¯ä»¥å…±äº«åŒä¸€ä¸ª BLOBï¼ŒDB ç»´æŠ¤å®ƒçš„ RCï¼Œæ¥é¿å… BLOB ä¸Šçš„å¼€é”€ã€‚</p><p><img src="https://image.mwish.me/blog-image/2807BAAE-7689-48B9-8508-8BA2D8906FA0.png" alt="2807BAAE-7689-48B9-8508-8BA2D8906FA0"></p><p>PostgreSQL çš„ TOAST æœ‰ç±»ä¼¼çš„æŠ€æœ¯ï¼š</p><blockquote><p>The TOAST management code is triggered only when a row value to be stored in a table is wider than <code>TOAST_TUPLE_THRESHOLD</code> bytes (normally 2 kB). The TOAST code will compress and/or move field values out-of-line until the row value is shorter than <code>TOAST_TUPLE_TARGET</code> bytes (also normally 2 kB, adjustable) or no more gains can be had. During an UPDATE operation, values of unchanged fields are normally preserved as-is; so an UPDATE of a row with out-of-line values incurs no TOAST costs if none of the out-of-line values change.</p></blockquote><h3 id="Time-Travel-Storage"><a href="#Time-Travel-Storage" class="headerlink" title="Time-Travel Storage"></a>Time-Travel Storage</h3><p><img src="https://image.mwish.me/blog-image/67ADE0DE-EE4C-4A1A-A354-EDFE8E4039AB.png" alt="67ADE0DE-EE4C-4A1A-A354-EDFE8E4039AB"></p><p>ç±»ä¼¼ Append-Only Storageï¼Œä½†ç‰ˆæœ¬åˆ†æˆäº†ä¸»è¡¨å’Œåˆ«çš„å­˜å‚¨ï¼Œå­˜ä¸€ä¸ªä¸»è¡¨ï¼ŒTime-Travel Table å­˜æ”¾ä¸åŒçš„ç‰ˆæœ¬ã€‚éœ€è¦æ›´æ–°çš„æ—¶å€™ï¼Œè¿™é‡Œéœ€è¦åœ¨ time-travel table ä¸­ç”³è¯·ç©ºé—´ï¼Œç„¶åæŠŠæ•°æ®æ‹·è´è¿‡å»ï¼Œç„¶åæ”¹ä¸»è¡¨ã€‚æ²¡æ”¹ index key çš„è¯ï¼Œindex æ˜¯ä¸éœ€è¦æ›´æ–°çš„ã€‚</p><h3 id="Delta-Main-Storage"><a href="#Delta-Main-Storage" class="headerlink" title="Delta-Main Storage"></a>Delta-Main Storage</h3><p><img src="https://image.mwish.me/blog-image/64C7B2DB-DD5C-40EF-AAE3-AF420AB6A390.png" alt="64C7B2DB-DD5C-40EF-AAE3-AF420AB6A390"></p><p>HyPer, MySQL å’Œ Oracle ä½¿ç”¨äº†è¿™ç§æ–¹æ³•ï¼Œç›¸å¯¹ Time-travel Storageï¼Œè¿™é‡Œå­˜å‚¨çš„æ˜¯ Delta çš„å†…å®¹ï¼Œè€Œéå…¨éƒ¨å†…å®¹ã€‚å¯¹ Update å¯†é›†çš„è´Ÿè½½ï¼Œè¿™ç§é€»è¾‘ç›¸å¯¹æ¥è¯´æ€§èƒ½å¾ˆå¥½ï¼Œä½†æ˜¯å¯¹è¯»æ¥è¯´ï¼Œè¿™ä¼šæœ‰ä¸€å®šçš„é—®é¢˜ã€‚</p><p>ç¬”è€…è®¤ä¸ºï¼Œè¿™é‡Œå¯ä»¥è€ƒè™‘ç±»ä¼¼ logging é‚£ç§ physical / logical ç±»ä¼¼çš„åŒºåˆ«ï¼Œä¸ç”¨å’Œ time-travel åˆ†å¤ªå¼€ï¼Ÿ</p><h3 id="è®¨è®º-1"><a href="#è®¨è®º-1" class="headerlink" title="è®¨è®º"></a>è®¨è®º</h3><p>è¿™é‡Œå…·ä½“çš„ pros &amp; cons åªèƒ½åšä¸€ä¸ª case by case çš„åˆ†æï¼Œå¯¹äº TP workload, append-only åœ¨æ²¡å•¥ overwrite çš„æƒ…å†µä¸‹å·¥ä½œçš„ä¸é”™ï¼Œå› ä¸ºæœ‰ç€ä¸é”™çš„å±€éƒ¨æ€§ï¼Œæœ‰ç‰ˆæœ¬é“¾å°±ç‚¸ç»™ä½ çœ‹ã€‚è¿™ç§æ–¹å¼åŒæ—¶ä¹ŸåŠ é‡äº† index ç®¡ç†çš„éš¾åº¦ã€‚</p><p>PostgreSQL æ˜¯ç°å® Append-Only Storage + N2Oï¼Œå†™å…¥çš„æ•°æ®ä¼šæ›´æ–° <code>xmax</code> å’Œ <code>ctid</code>ï¼ŒæŒ‡å‘æœ€æ–°çš„æ•°æ®ï¼Œç´¢å¼•ä¸ä¼šæ›´æ”¹ã€‚å½“ç´¢å¼•å¼•ç”¨çš„ Tuple æœ€æ–°ç‰ˆæœ¬è¢«åˆ ï¼Œç„¶åæ‰€æœ‰äº‹åŠ¡éƒ½è¯»ä¸åˆ°å®ƒçš„æ—¶å€™ï¼Œæ‰€ä»¥ä¼šæ ‡è®° <code>LP_DEAD</code> æ¥å®ç°æ‡’æƒ°åˆ é™¤ï¼Œç­‰å¾… vacuum è¿›ç¨‹ GCã€‚</p><p>InnoDB ä½¿ç”¨äº† Delta-Main çš„æ–¹å¼ï¼Œä¸»è¡¨æ˜¯ä¸€ä¸ªç´¢å¼•ï¼ŒUndo æ®µè´Ÿè´£å›æ»šã€‚Undo å†™çš„æ˜¯é€»è¾‘æ›´æ–°ï¼Œå…¶å®å°±æ˜¯ delta å­˜å‚¨ã€‚</p><p>WiredTiger ä¼š</p><p>TBD</p><h2 id="Garbage-Collection"><a href="#Garbage-Collection" class="headerlink" title="Garbage Collection"></a>Garbage Collection</h2><p>GC æ˜¯ MVCC æ¯”è¾ƒé‡è¦åˆæ¯”è¾ƒ hack çš„ä¸€å—ï¼Œä¹Ÿæœ‰ Purge/Vacuum è¿™äº›å…³é”®è¯æ¥æè¿°ä»–ä»¬ã€‚å¤§éƒ¨åˆ†é¢å‘ç”¨æˆ·çš„ä»‹ç»ææ–™å¾ˆå°‘æåŠ GC æ˜¯æ€ä¹ˆå·¥ä½œçš„ã€‚</p><p>æ€»çš„æ¥è¯´ï¼ŒGC å¤§æ¦‚åˆ†ä¸ºä¸‰æ­¥ï¼š</p><ol><li>è¯†åˆ«ä¸å†éœ€è¦çš„ç‰ˆæœ¬</li><li>æŠŠä»–ä»¬ä» version chain æ‘˜é™¤ï¼Œç„¶åå¤„ç†ç´¢å¼•å¯¹åº”çš„æƒ…å†µ</li><li>å›æ”¶ç©ºé—´</li></ol><p>å¯èƒ½ç³»ç»Ÿä¼šæœ‰ä¸€ä¸ªæ´»è·ƒäº‹åŠ¡ txn-id ä¸‹ç•Œï¼Œä¼šæ ¹æ®è¿™ä¸ªå›æ”¶ï¼Œä¹Ÿæœ‰ç³»ç»Ÿä¼šæœ‰ä¸€äº›ç»†ç²’åº¦çš„å›æ”¶ï¼Œæ¯”å¦‚ HyPer / SAP HANA çš„å›æ”¶ï¼Œæˆ–è€… crdb çš„ protect tsã€‚å½“ç„¶ï¼Œtxn-id ä½œä¸ºä¸­å¿ƒåŒ– allocator æœ¬èº«ä¼šæ¯”è¾ƒè´¹ã€‚æœ‰ä¸€äº›ç²—ç²’åº¦çš„æ–¹å¼ï¼Œæ¯”å¦‚ç”¨ epoch æ¥æ‰¹é‡åšäº‹åŠ¡çš„å›æ”¶ã€‚</p><p>æœ¬è®ºæ–‡è®² GC åˆ†ä¸ºï¼š</p><ul><li>Tuple Level GC</li><li>Transaction-level GC</li></ul><p><img src="https://image.mwish.me/blog-image/D55A6BAD-A2D6-47C8-BC96-8C547903ACB2.png" alt="D55A6BAD-A2D6-47C8-BC96-8C547903ACB2"></p><h3 id="Tuple-level-Garbage-Collection"><a href="#Tuple-level-Garbage-Collection" class="headerlink" title="Tuple-level Garbage Collection"></a>Tuple-level Garbage Collection</h3><p>è¿™é‡Œç»†åˆ†ä¸º Background Vacuuming (VAC) å’Œ Cooperative Cleaning (COOP)ã€‚</p><p>VAC ä¼šæœ‰åå°çš„ GC è¿›ç¨‹æ¥æ¸…é™¤ã€‚æœ‰ä¸€ç§è‰å°çš„æ–¹å¼æ˜¯è¿™ä¸ªè¿›ç¨‹æ£€æµ‹æœ‰å“ªäº›ç‰ˆæœ¬è¿›è¡Œåˆ é™¤ï¼Œç„¶åæ¸…é™¤ï¼Œè¿™ç§æ–¹å¼å¯¹äºæ¯”è¾ƒå¤§çš„åº“æ¥è¯´æ€§èƒ½è‚¯å®šæ‹‰äº†ã€‚æ–‡ä¸­æå‡ºäº†ä¸¤ç§ä¼˜åŒ–æ–¹å¼ï¼š</p><ol><li>æŠŠå¯¹åº”çš„å¤±è´¥ç‰ˆæœ¬æ³¨å†Œåˆ°æŸä¸ª lock-free çš„åœ°æ–¹ï¼Œç„¶åæ¸…é™¤è¿›ç¨‹ç›´æ¥æ¸…é™¤è¿™äº›ç‰ˆæœ¬</li><li>æ ‡æ³¨å“ªäº›æ•°æ®å—éœ€è¦æ¸…é™¤ï¼Œç„¶åè·³è¿‡ä¸éœ€è¦ GCçš„é‚£äº›å—ï¼ˆPostgreSQL çš„å®ç°é€»è¾‘ç±»ä¼¼è¿™æ ·ï¼‰</li></ol><p>Cooperative Cleaning (COOP) ä¼šåœ¨ N2O ç³»ç»Ÿä¸­ï¼Œéå‰çš„æ—¶å€™å›æ”¶ã€‚PG æ„Ÿè§‰å› ä¸º Tuple ä½ç½®æ˜¯å›ºå®šçš„ï¼Œæ‰€ä»¥è™½ç„¶ N2Oï¼Œä½†æ˜¯æ²¡åŠæ³•è¿™ä¹ˆåšã€‚è¿˜æœ‰ä¸ªé—®é¢˜ï¼Œå°±æ˜¯è¿™ç§å›æ”¶å¦‚æœæ²¡ touch åˆ°å¯¹åº”çš„ç‰ˆæœ¬ï¼Œå°±ä¸å›æ”¶äº†ã€‚Hekaton ç¢°åˆ°è¿‡è¿™ä¸ªé—®é¢˜ï¼Œè§£å†³æ–¹å¼æ˜¯åŠ ä¸Šäº†ä¸ª VACã€‚</p><p>æœ€åï¼Œè¿™èŠ‚æºè®ºæ–‡ä»‹ç»å¾ˆå°‘ï¼Œä½†æˆ‘ä¸ªäººæ„è§æ˜¯ï¼Œè¿™é‡Œ pattern è¿˜æ˜¯æŒºå¤šçš„ã€‚æ¯”å¦‚ Compaction çš„æ—¶å€™å›æ”¶ã€æ ‡æ³¨å›æ”¶çš„ Pageã€æŠŠå›æ”¶çš„ç‰ˆæœ¬æŒ‚èµ·æ¥ç­‰ç­‰ã€‚</p><h3 id="Transaction-level-Garbage-Collection"><a href="#Transaction-level-Garbage-Collection" class="headerlink" title="Transaction-level Garbage Collection"></a>Transaction-level Garbage Collection</h3><p>äº‹åŠ¡ track å¯¹åº”çš„è¯»å†™é›†ï¼Œç„¶ååœ¨å•ä¸ªäº‹åŠ¡æˆ–è€…ä¸€å †äº‹åŠ¡çš„ epoch ç»“æŸçš„æ—¶å€™åš GCã€‚ç¼ºç‚¹æ˜¯ track ç©ºé—´ï¼Œä¼˜ç‚¹åˆ™æ˜¯åŠæ—¶çš„å›æ”¶ã€‚</p><h3 id="è®¨è®º-2"><a href="#è®¨è®º-2" class="headerlink" title="è®¨è®º"></a>è®¨è®º</h3><p>Tuple-level Garbage Collection + VAC åº”è¯¥æ˜¯æœ€å¸¸è§çš„å®ç°æ–¹æ³•ã€‚å¢åŠ  GC çš„çº¿ç¨‹ä¸€èˆ¬éƒ½èƒ½æå‡ GC ç³»ç»Ÿçš„æ€§èƒ½ï¼Œè€Œ long-running txn å¯èƒ½ä¼šå½±å“ GCï¼Œè¿™éœ€è¦ä¸€äº›ç»†ç²’åº¦çš„ GC å®ç°ã€‚</p><p>PostgreSQL å’Œ MySQL InnoDB éƒ½ç»´æŠ¤äº†äº‹åŠ¡çš„åˆ—è¡¨ã€æœ€ä½å’Œæœ€é«˜çš„äº‹åŠ¡æ°´ä½ï¼Œæˆ‘ä»¬ç”¨ txn-table, active-txn-list, min-txn å’Œ max-txn è¡¨ç¤ºã€‚</p><h4 id="PostgreSQL-çš„-Vacuum"><a href="#PostgreSQL-çš„-Vacuum" class="headerlink" title="PostgreSQL çš„ Vacuum"></a>PostgreSQL çš„ Vacuum</h4><p>å¯¹äº PG æ¥è¯´ï¼Œå®ƒåšçš„æ˜¯ä¸€ä¸ªæ¯”è¾ƒå¤æ‚çš„å¤šé˜¶æ®µçš„åˆ é™¤ï¼Œç”¨çš„ Tuple-level GC + VACï¼Œå…·ä½“å¯è§ Vacuum ç›¸å…³çš„ææ–™ï¼ˆLazy Vacuum, Full Vacuumï¼‰</p><ul><li>å¯¹äºäº‹åŠ¡çš„è®°å½•ï¼ŒPostgreSQL ç»´æŠ¤åœ¨ clog é‡Œé¢ï¼Œè¿™å¯ä»¥å½“ä½œä¸€ä¸ªäº‹åŠ¡è¡¨ã€‚å®ƒæ ¹æ®äº‹åŠ¡ id çš„é¡ºåºå­˜åœ¨å„ä¸ª Page ä¸Šï¼Œç¼“å­˜åœ¨å†…å­˜çš„ slru ä¸­ã€‚å½“äº‹åŠ¡æ¨è¿›çš„æ—¶å€™ï¼Œå¯ä»¥ Truncate å‰é¢çš„äº‹åŠ¡è®°å½•æ¥å›æ”¶ç©ºé—´ï¼Œæ¨è¿›ç³»ç»Ÿäº‹åŠ¡</li><li>PostgreSQL çš„ <code>xmax</code> å¦‚æœè¢«æ ‡è®°ä¸” tuple æ²¡æœ‰è¢«ä¸Šé”ï¼Œé‚£ä¹ˆè¿™ä¸ª tuple æ˜¯è¢«åˆ é™¤çš„ï¼Œå¦‚æœ <code>xmax</code> å°äº <code>min-txn</code>ï¼Œé‚£è¿™ä¸ª tuple åœ¨é€»è¾‘ä¸Šä¸ä¼šè¢«ä»»ä½•äº‹åŠ¡çœ‹è§ï¼Œè™½ç„¶ç‰©ç†ä¸Šå®ƒè¿˜å­˜åœ¨</li><li>GC è¿‡ç¨‹ä¸­ï¼ŒPostgreSQL ä¼šæ‰«ææ‰€æœ‰ dead çš„ tupleï¼Œç„¶åæ¸…é™¤å®ƒä»¬ï¼Œè¿™é‡Œé¦–å…ˆæœ‰ä¸€ä¸ª visibilitymap, å¯¹åº”ä»£ç åœ¨ <code>backend/access/heap/visibilitymap</code>ã€‚å¦‚æœæŸä¸ª Page è¢«æ”¹äº†ï¼Œæœ‰ Tuple å¯èƒ½éœ€è¦ GCï¼Œå°±ä¼šç»™ vm è®°ä¸€ä¸‹ï¼Œç„¶åè¿™æ ·çš„ Page æ‰éœ€è¦è¢«æ¸…ç†ï¼Œè¿™æ®µè¿‡ç¨‹ä¸­ï¼Œç´¢å¼•çš„æ•°æ®ä¼šè¢«æ¸…é™¤ï¼Œå¦‚ä¸‹é¢çš„å›¾ã€‚</li><li>ç´¢å¼•æ•°æ®æ¸…é™¤ä¹‹åï¼ŒHeap Tuple çš„æ•°æ®ä¼šè¢«æ ‡è®°åˆ é™¤ï¼Œä½†æ˜¯ slot ä¸Šçš„ä½ç½®è¿˜æ˜¯ä¼šç•™ç€ã€‚</li><li>æ›´æ–°å¯¹åº”çš„ VMï¼Œç§»é™¤ clog ç­‰äº‹åŠ¡è¡¨ä¿¡æ¯ã€‚</li></ul><p><img src="https://image.mwish.me/blog-image/fig-6-01.png" alt="fig-6-01"></p><h4 id="InnoDB-çš„-Purge"><a href="#InnoDB-çš„-Purge" class="headerlink" title="InnoDB çš„ Purge"></a>InnoDB çš„ Purge</h4><p>å¯¹äº MySQL InnoDB æ¥è¯´ï¼Œå®ƒçš„ GC åœ¨ Purge Undo é‡Œï¼ŒIndex Page çš„å›æ”¶æˆ‘ä¸æ˜¯å¾ˆç†Ÿæ‚‰ï¼Œå°±ä¸çŒ®ä¸‘äº†ï¼Œå‰é¢å·²ç»è¯´è¿‡äº†</p><p><img src="https://image.mwish.me/blog-image/undo_log_disk_structure.png" alt="undo_log_disk_structure"></p><p>InnoDB çš„ Undo å­˜åœ¨ Page ä¸Šï¼Œå¯¹è¿™ä¸ª Page çš„æ“ä½œæ˜¯éœ€è¦å†™ <code>mtr</code> å’Œ redo çš„ã€‚äº‹åŠ¡å¯ä»¥ç”³è¯·éœ€è¦å†™ undo logï¼Œç„¶åç³»ç»Ÿä¼šç»™å®ƒåˆ†é…å¯¹åº”çš„ undo pageã€‚åŒæ—¶ï¼Œæ²¡æœ‰æ¸…é™¤çš„äº‹åŠ¡ä¼šæŒ‚åœ¨ history list ä¸Šã€‚é€šè¿‡æ‰«æ history listï¼Œæ¥å›æ”¶è¿™äº›ç‰ˆæœ¬ã€‚</p><h4 id="å…¶ä»–"><a href="#å…¶ä»–" class="headerlink" title="å…¶ä»–"></a>å…¶ä»–</h4><p>WiredTiger çš„ GC æ¯”è¾ƒç®€å•ï¼Œåœ¨ Reconcile çš„æ—¶å€™ï¼Œæ¯ä¸ª tuple ä¼šæŠŠã€Œæ‰€æœ‰äº‹åŠ¡éƒ½å¯è§ã€çš„æ•°æ®å½“ä½œ baseï¼ŒæŠŠä¸å¯è§çš„ç‰ˆæœ¬ GC æ‰</p><p><img src="https://image.mwish.me/blog-image/wt-mem-low.png" alt="wt-mem-low"></p><h2 id="Index-Management"><a href="#Index-Management" class="headerlink" title="Index Management"></a>Index Management</h2><p><img src="https://image.mwish.me/blog-image/992D5709-7238-47B6-8015-E218C786A055.png" alt="992D5709-7238-47B6-8015-E218C786A055"></p><p>DBMS çš„ç´¢å¼•æ›´æ–°å’Œå®ç°æœ‰å…³ï¼Œæ¯”å¦‚ MySQL InnoDB æœ‰ Cluster Index å’Œ Secondary Indexï¼Œç„¶åå¯èƒ½è¿˜æœ‰ Covering Indexã€‚PostgreSQL åˆ™æ˜¯ index + heap tableã€‚</p><p>ã€Œæ›´æ–°ã€ä¹Ÿæ˜¯ä¸ªå¾ˆå¥‡æ€ªçš„äº‹æƒ…ï¼Œæˆ‘ä»¬å¯ä»¥åŒºåˆ†ä¸€ä¸‹ï¼š</p><ul><li>æ›´æ–°çš„å­—æ®µè·Ÿç´¢å¼•æ²¡å…³ç³»</li><li>æ›´æ–°äº†ç´¢å¼•çš„å­—æ®µ</li></ul><p>å®é™…ä¸Šï¼Œåœ¨ MVCC ç³»ç»Ÿä¸­ï¼Œå¾ˆå¤šç´¢å¼•å­—æ®µè¢«æ›´æ–°äº†ï¼ŒåŸºæœ¬ä¸Šè¦æ’å…¥ä¸€æ¡æ–°çš„è®°å½•ï¼ŒåŒæ—¶æ—§çš„è®°å½•ä¹Ÿè¦ä¿ç•™ï¼Œè¿™ç»™ <code>checkUnique</code> å¸¦æ¥äº†ä¸å°éº»çƒ¦ã€‚PostgreSQL åšäº†ä¸€ä¸ª <code>LP_DEAD</code>ï¼Œæ¥ç»™è¿™ç§è¢«æ›´æ–°çš„ç´¢å¼•åšä¼˜åŒ–ï¼Œandy çš„ slide ä¹Ÿæåˆ°äº†è¿™ä¸ªé—®é¢˜ï¼š</p><p><img src="https://image.mwish.me/blog-image/9E78FAF1-5133-435A-82C0-C1AF21FCACAE.png" alt="9E78FAF1-5133-435A-82C0-C1AF21FCACAE"></p><p>è®ºæ–‡å¼•å…¥äº† indirection å’Œ direction çš„æ–¹å¼:</p><ul><li>indirection å¼•å…¥äº†ä¸€ä¸ªé—´æ¥å±‚ï¼Œè¿™ä¸ªé—´æ¥å±‚å¯ä»¥æ˜¯ TupleID æˆ–è€… Primary Key. ç›¸å¯¹æ¥è¯´ï¼ŒPrimaryKey ç©ºé—´å¼€é”€å¤§ä¸€äº›ï¼ŒTupleID ç»´æŠ¤åˆ™å¤æ‚ä¸€äº›ã€‚è¿™ä¸ªæ€ä¹ˆç†è§£å‘¢ï¼Ÿ<ul><li>ç´¢å¼•å­˜çš„æ˜¯ <code>&lt;IndexKeys, PrimaryKey&gt;</code>ï¼Œé‚£ä¹ˆï¼Œæ ¹æ® PK å¯ä»¥æ‰¾åˆ°å”¯ä¸€çš„ä¸»é”®ã€‚å½“ç„¶ï¼Œå¦‚æœ pk å¾ˆå¤§ï¼Œè¿™é‡Œç©ºé—´æ”¾å¤§ä¼šæœ‰ï¼Œå¦‚æœ pk æ˜¯ int ä¹‹ç±»çš„ï¼Œæ„Ÿè§‰ä¹Ÿæ²¡å•¥å¼€é”€å•Šï¼ˆ</li></ul></li><li>direction åˆ™æ˜¯ PG çš„æ–¹æ¡ˆï¼Œç›´æ¥æŒ‡å‘ç‰©ç†ç©ºé—´</li></ul><h3 id="è®¨è®º-3"><a href="#è®¨è®º-3" class="headerlink" title="è®¨è®º"></a>è®¨è®º</h3><p>ä½œè€…è¯„ä»·å¦‚ä¸‹ï¼š</p><blockquote><p>The logical pointer approach is better for write-intensive workloads, as the DBMS updates the secondary indexes only when a transaction modiï¬es the indexes attributes. Reads are potentially slower, however, because the DBMS traverses version chains and perform additional key comparisons. Likewise, using physical pointers is better for read-intensive workloads because an index entry points to the exact version. But it is slower for update operations because this scheme requires the DBMS to insert an entry into every secondary index for each new version, which makes update operations slower.</p></blockquote><p>è¿™é‡Œè¿˜æœ‰ä¸ª Index Only Scan çš„é—®é¢˜ï¼Œä½ çœ‹ï¼Œå¯¹äºæ•°æ® <code>(a, b, c)</code> æœ‰ç´¢å¼• <code>(b)</code>, ç„¶åç”¨æˆ·åª get <code>b</code>ï¼Œæœ¬æ¥æ˜¯ä¸ªå¾ˆç®€å•çš„é—®é¢˜ï¼Œä½†ä½ çš„ç´¢å¼•ä¸Šå¦‚æœä¸ç»´æŠ¤ MVCC ä¿¡æ¯çš„è¯ï¼Œå¯èƒ½å°±å¯„äº†ã€‚</p><p>è¿™é‡Œå¯ä»¥å‚è€ƒ PostgreSQL çš„ Index Only Scanï¼Œå€ŸåŠ©äº†æˆ‘ä»¬ä¸Šä¸€èŠ‚è¯´çš„ vm ç³»ç»Ÿ:</p><p><img src="https://image.mwish.me/blog-image/index-only-scan.png" alt="index-only-scan"></p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p>PostgreSQL éƒ¨åˆ†ï¼š</p><ul><li><p><a href="https://www.interdb.jp/pg">https://www.interdb.jp/pg</a></p></li><li><p><a href="https://blog.yasking.org/a/postgresql-vacuum.html">PosrgreSQL å­¦ä¹ è®¡åˆ’â€”â€”Vacuum æ¸…ç†æœºåˆ¶</a> <a href="https://blog.yasking.org/a/postgresql-vacuum.html">https://blog.yasking.org/a/postgresql-vacuum.html</a></p></li></ul><p>InnoDB éƒ¨åˆ†ï¼š</p><ul><li><p>MySQL Â· æºç åˆ†æ Â· InnoDBçš„read viewï¼Œå›æ»šæ®µå’Œpurgeè¿‡ç¨‹ç®€ä»‹ <a href="http://mysql.taobao.org/monthly/2018/03/01/">http://mysql.taobao.org/monthly/2018/03/01/</a></p></li><li><p>MySQL Â· å¼•æ“ç‰¹æ€§Â· InnoDBä¹‹UNDO LOGä»‹ç» <a href="http://mysql.taobao.org/monthly/2021/12/02/">http://mysql.taobao.org/monthly/2021/12/02/</a></p></li></ul><p>æ„Ÿè°¢åŸè®ºæ–‡ï¼šAn Empirical Evaluation of In-Memory Multi-Version Concurrency Control</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Notes: folly::ThreadLocalPtr</title>
      <link href="/2022/06/12/Notes-folly-ThreadLocalPtr/"/>
      <url>/2022/06/12/Notes-folly-ThreadLocalPtr/</url>
      
        <content type="html"><![CDATA[<p>ææ–™ï¼š</p><ol><li><a href="https://github.com/facebook/folly/blob/main/folly/docs/ThreadLocal.md">https://github.com/facebook/folly/blob/main/folly/docs/ThreadLocal.md</a></li><li>æ— é”ç¼–ç¨‹å®è·µï¼šRocksDB ThreadLocalPtrå‰–æ - æ¨å‡¿è®©çš„æ–‡ç«  - çŸ¥ä¹ <a href="https://zhuanlan.zhihu.com/p/398409455">https://zhuanlan.zhihu.com/p/398409455</a></li><li><a href="https://github.com/halty/writing/blob/master/Folly_Source_Insight_Series-ThreadLocalPtr.md">https://github.com/halty/writing/blob/master/Folly_Source_Insight_Series-ThreadLocalPtr.md</a></li></ol><p>Thread Local æ˜¯å¾ˆå¸¸è§çš„ä¸œè¥¿ï¼Œ<code>errno</code> å°±æ˜¯è‘—åçš„ thread local å˜é‡ã€‚å®ƒä»¬é€šå¸¸ç”¨ä½œä¸€äº›ä¼˜åŒ–ã€‚å…³äº thread localï¼Œä¸€èˆ¬è®¤ä¸ºæœ‰ä¸‹é¢æ¥å£ï¼š</p><ol><li>Gcc ç­‰ç›¸å…³çš„ <code>__thread</code> : <a href="https://gcc.gnu.org/onlinedocs/gcc/Thread-Local.html">https://gcc.gnu.org/onlinedocs/gcc/Thread-Local.html</a></li><li><code>pthread_key</code> ç›¸å…³çš„ POSIX æ¥å£ï¼Œå’Œå…¶ä»–å¹³å°æä¾›çš„æ¥å£.</li><li><code>thread_local</code> ç­‰è¯­è¨€å…³é”®å­—ï¼Œå®ƒçš„åˆå§‹åŒ–ç±»ä¼¼ <code>static</code></li></ol><p>å…³äº TLS æ˜¯æ€ä¹ˆåšçš„ï¼Œä¸‹é¢è¿™ç¯‡åšå®¢ç»™äº†ä¸€ä¸ªå¾ˆå¥½çš„ä»‹ç»ï¼š<a href="https://chao-tic.github.io/blog/2018/12/25/tls">https://chao-tic.github.io/blog/2018/12/25/tls</a> </p><p>å¦‚æœå¯¹ç¼–è¯‘ã€é“¾æ¥ã€ELFç›¸å…³çš„ä¸œè¥¿æ„Ÿå…´è¶£ï¼Œè¿˜å¯ä»¥çœ‹çœ‹ï¼š<a href="https://maskray.me/blog/2021-02-14-all-about-thread-local-storage">https://maskray.me/blog/2021-02-14-all-about-thread-local-storage</a></p><p><code>folly::ThreadLocal</code> å®ç°äº†å’Œ <code>pthread_key</code> ç›¸å…³ api ä¸€æ ·æ€§èƒ½çš„ TLSï¼Œå¹¶ä¸”æä¾›äº† <code>accessAllThreads</code> çš„èƒ½åŠ›ï¼ˆå®é™…ä¸Šä»‹ç» perfbook çš„æ—¶å€™ï¼Œä½ ä¼šå‘ç°å¤§éƒ¨åˆ†ä¸œè¥¿éƒ½éœ€è¦ç±»ä¼¼çš„è¯­ä¹‰ï¼‰</p><hr><p>Folly çš„ <code>ThreadLocalPtr</code> æ¥å£å¦‚ï¼š<code>ThreadLocalPtr&lt;T, Tag, AccessMethod&gt;</code>ï¼Œæ¯ä¸ª Tag ä¼šæœ‰ä¸€ç»„æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰çš„ <code>StaticMeta&lt;Tag&gt;</code> å¯¹è±¡ï¼Œ<code>StaticMeta&lt;Tag&gt;</code> å¯¹è±¡æŒæœ‰ä¸€ä¸ª <code>ThreadEntry</code> çš„åŒå‘é“¾è¡¨ï¼ˆ<code>ThreadEntryList</code>ï¼‰ï¼Œä¸ºäº†ç»´æŠ¤è¿™ä¸ªåŒå‘é“¾è¡¨ï¼Œå®ƒæŒæœ‰äº†åŒå‘é“¾è¡¨çš„ Header (<code>head_</code>) ï¼ŒåŒæ—¶ï¼ŒåŒå‘é“¾è¡¨æ˜¯å¾ˆéš¾å¹¶å‘çš„ï¼Œæ‰€ä»¥å®ƒæŒæœ‰äº†ä¸€ä¸ª mutexï¼Œæ¥ä¿è¯è¿™ä¸ªé“¾è¡¨è®¿é—®å’Œæ’å…¥çš„å®‰å…¨æ€§ã€‚</p><p>æ¯ä¸ªçº¿ç¨‹ï¼Œå¦‚æœéœ€è¦ï¼Œä¼šæœ‰ä¸€ä¸ª <code>ThreadEntry</code> å¯¹è±¡ã€‚ä»–ä»¬è¢« <code>StaticMeta&lt;Tag&gt;</code> ç®¡ç†ï¼Œé‡Œé¢æœ‰ä¸€ä¸ª <code>vector</code>(æ²¡æœ‰å®ç°æˆ vector, ä½†å…¶å®å¯ä»¥ç†è§£æˆ vectorï¼Œæ²¡å•¥é—®é¢˜)ã€‚<strong>æ¯ä¸ª TLS å¯¹è±¡æœ‰ä¸€ä¸ªå›ºå®šçš„ id, è¡¨ç¤ºè‡ªå·±åœ¨ vector é‡Œé¢æ˜¯ç¬¬å‡ ä½, ä¸€ä¸ª Tag åœ¨æ¯ä¸ªçº¿ç¨‹ä¸­å¯èƒ½å£°æ˜äº†å¤šä¸ª TLS å¯¹è±¡ï¼Œæ‰€ä»¥ç”¨ä¸€ä¸ª Vector</strong>ã€‚TLS è¯»çš„æ—¶å€™ï¼Œä¼šæ‰¾åˆ°æœ¬çº¿ç¨‹çš„ <code>ThreadEntry</code> å¯¹è±¡ï¼Œçœ‹çœ‹è‡ªå·±åœ¨ <code>vector</code> ç¬¬å‡ ä¸ªï¼Œç„¶åè·å– vector ä¸­çš„å¯¹è±¡ã€‚å¯¹è±¡ç”± <code>ElementWrapper</code> åŒ…è£…ï¼Œè¿™ä¸ª Wrapper åŒ…è£…äº†ä¸€ä¸‹ç”¨æˆ·çš„ææ„å‡½æ•°ã€‚</p><p><code>StaticMeta::getThreadEntrySlow</code> ç”¨æ¥åˆ›å»ºçº¿ç¨‹çš„ TLS å¯¹è±¡ï¼ˆ<code>ThreadEntry</code>ï¼‰ï¼ŒæŠŠ <code>ThreadEntry</code> å¯¹è±¡æ³¨å†Œåœ¨ <code>pthread_getspecific</code> ä¸­ã€‚è¿™ä¸ªå’Œ OS æœ‰ä»€ä¹ˆåŒºåˆ«å‘¢ï¼Ÿç­”æ¡ˆåœ¨äºåŸæœ¬æ˜¯å¤šä¸ª Keyï¼Œç°åœ¨æ¯ä¸ª tag åªéœ€è¦ä¸€ä¸ª keyã€‚</p><p>ä½¿ç”¨ TLS çš„æ—¶å€™ï¼Œä¼šæ‹¿åˆ° <code>StaticMeta&lt;Tag&gt;</code> çš„å•ä¾‹å¯¹è±¡ï¼Œç„¶ååœ¨è°ƒç”¨è·å–æœ¬çº¿ç¨‹å¯¹è±¡çš„æ—¶å€™ï¼Œè°ƒç”¨ <code>StaticMeta::get(EntryID*)</code>ï¼Œæ¥è·å–æœ¬çº¿ç¨‹çš„ TLS å¯¹è±¡ã€‚æ¯ä¸ª <code>ThreadLocalPtr</code> æŒæœ‰ä¸€ä¸ª <code>id_</code> ï¼Œè¿™ä¸ª <code>id_</code> å®ç°æ˜¯ä¸€ä¸ª <code>EntryID</code>, ä¿å­˜äº†ä¸€ä¸ª <code>atomic&lt;uint32_t&gt;</code>ã€‚è¿™ä¸ª id ä¹Ÿæ˜¯ç”± <code>StaticMeta&lt;Tag&gt;</code> åˆ†é…çš„ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä¸€äº›ç´§å¼ æƒ…å†µä¸‹ï¼Œ<code>ThreadEntry</code> çš„ <code>ElementWrapper</code> æ•°ç»„ä¼šéœ€è¦æ‰©å®¹ï¼Œè¿™ä¸ªæ—¶å€™è¦å ç”¨å…¨å±€çš„é”ï¼Œç„¶åä¸€ä¸ªä¸ªæ‰©å®¹ï¼Œä¼šå¾ˆè´¹ã€‚</p><p><code>accessAll</code> çš„æ—¶å€™ï¼Œä¹Ÿè¦å æ® <code>StaticMeta&lt;Tag&gt;</code> çš„é”ï¼Œæ­¤å¤–ï¼Œè¿˜æœ‰ä¸ª <code>accessALlThreadsLock_</code>ï¼Œä¸è¿‡æˆ‘æ²¡çœ‹å‡ºæ¥è¿™ä¸ªç©æ„æœ‰ä»€ä¹ˆç‰¹åˆ«å¤§çš„æ„ä¹‰ã€‚ä»–ä»¬ä¼šæ ¹æ® TLS å¯¹è±¡çš„ id éå†æ¯ä¸ªæ•°ç»„ï¼Œç„¶åè®¿é—®å¯¹åº” index ä¸Šçš„å¯¹è±¡ã€‚</p><p><img src="https://image.mwish.me/blog-image/ThreadLocalPtr.jpeg" alt="ThreadLocalPtr"></p><p>ä¸Šå›¾æ¥è‡ªåšå®¢ï¼š<a href="https://github.com/halty/writing/blob/master/Folly_Source_Insight_Series-ThreadLocalPtr.md">https://github.com/halty/writing/blob/master/Folly_Source_Insight_Series-ThreadLocalPtr.md</a> </p><p>æ„Ÿè°¢å…è®¸çŒæ°´</p><hr><p>åœ¨ä½¿ç”¨ä¸Šï¼Œfolly çš„ <code>HazardPointer</code>ã€<code>CachedIntCounter</code> ç­‰å®¹å™¨éƒ½ä½¿ç”¨äº† TLS ptrï¼Œè€Œ RocksDB è‡ªå·±å†™äº†ä¸€å¥— <code>ThreadLocalPtr</code>ï¼Œä½†æ˜¯å®ç°çš„æœºåˆ¶å·®ä¸å¤šï¼Œå°‘äº† Tag ä¹‹ç±»çš„ï¼Œå¤šç»´æŠ¤äº†ä¸€ä¸ªæ›´æ–°çš„è¯­ä¹‰ï¼Œè¯¦è§ï¼š<a href="https://zhuanlan.zhihu.com/p/398409455">https://zhuanlan.zhihu.com/p/398409455</a></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Parallel and Distributed Query Processing</title>
      <link href="/2022/06/05/Parallel-and-Distributed-Query-Processing/"/>
      <url>/2022/06/05/Parallel-and-Distributed-Query-Processing/</url>
      
        <content type="html"><![CDATA[<p>è¿™ä¸€èŠ‚å¯¹åº”çš„æ˜¯ Database System Concept çš„åˆ†å¸ƒå¼æŸ¥è¯¢æ‰§è¡Œéƒ¨åˆ†ã€‚è¿™ä¸€éƒ¨åˆ†å¯èƒ½æœ¬èº«æè¿°çš„å†…å®¹æ˜¯åˆ†å¸ƒå¼æ‰§è¡Œï¼ˆä¹Ÿå¯ä»¥è”ç³»åˆ°ä¸€ä¸ªç°åœ¨å¾ˆæµè¡Œçš„è¯ï¼šMPPï¼‰ï¼Œä½†åŒæ—¶å¯èƒ½æ¶‰åŠä¸€äº›éåˆ†å¸ƒå¼æ‰§è¡Œçš„å†…å®¹ï¼ŒåŒ…æ‹¬ï¼š</p><ol><li>åœ¨å•æœºç³»ç»Ÿä¸Šï¼Œä¹Ÿèƒ½ç”¨ exchange ç­‰ç®—å­åšä¸€äº›å¹¶è¡ŒåŒ–ã€‚ç‰¹åˆ«æ˜¯ï¼Œå¦‚æœä½ æŒ‰ç…§ NUMA / Core åˆ‡åˆ†è´Ÿè½½ï¼Œå°±å¯ä»¥å‘ç°è¿™äº›éƒ¨åˆ†çš„äº‹æƒ…ä¹Ÿæ˜¯ä¸€ç§åˆ†å¸ƒå¼æ‰§è¡Œï¼Œå½“ç„¶ bus å¯èƒ½æ¯”ç½‘ç»œé€šä¿¡é è°±å¾ˆå¤š</li><li>ç”Ÿæˆ Plan æ–¹é¢ï¼Œæœ¬èº« Plan å°±å¾ˆéš¾ç”Ÿæˆäº†ï¼Œç„¶ååˆæè¿™ä¹ˆä¸€å¥—ï¼Œå°±æ›´éš¾äº†</li></ol><p>æ•™ç§‘ä¹¦ä¸Šè¿™èŠ‚å†™çš„ç›¸å½“ç›¸å½“ç»†ï¼Œç”šè‡³åŒ…æ‹¬ä¸€äº› fdw å’Œæ•°æ®æ¹–çš„å†…å®¹ã€‚è™½ç„¶æˆ‘æœ¬äººä¸æ˜¯å¾ˆæ‡‚åˆ†å¸ƒå¼æŸ¥è¯¢å¤„ç†ï¼Œä½†æ˜¯è¿™å—å†…å®¹ç¡®å®è®²çš„å¾ˆå¥½ã€‚</p><h2 id="åˆ†å¸ƒå¼æ•°æ®åº“çš„æ¶æ„"><a href="#åˆ†å¸ƒå¼æ•°æ®åº“çš„æ¶æ„" class="headerlink" title="åˆ†å¸ƒå¼æ•°æ®åº“çš„æ¶æ„"></a>åˆ†å¸ƒå¼æ•°æ®åº“çš„æ¶æ„</h2><p>å…¶å®ç½‘ç»œè¿˜æ˜¯ä¸ªæŒºå¤æ‚çš„ä¸œè¥¿çš„ï¼Œä½†æ˜¯ç›®å‰å¤§å®¶éƒ½å¾ˆèƒ½æŠ½è±¡ï¼Œå®é™…ä¸Šç›®å‰å¾ˆå¤šåœ°æ–¹éƒ¨ç½²çš„ç½‘ç»œéƒ½ç±»ä¼¼ä¸‹é¢çš„ <code>(e)</code>:</p><p><img src="https://image.mwish.me/blog-image/51EA3B2A-6300-474A-808E-457F875D5167.png" alt="51EA3B2A-6300-474A-808E-457F875D5167"></p><p>å½“ç„¶ï¼Œéšç€ç¡¬ä»¶å‘å±•ï¼Œå®é™…ä¸Šå¤§å®¶ä¹Ÿä¼šæœ‰ä¸€äº›å…¶ä»–æ–¹æ¡ˆï¼Œæ¯”å¦‚æ„å»º RDMA ç½‘ç»œã€‚</p><p>å¯¹äºå•æœºè€Œè¨€ï¼Œåšå®¢ï¼ˆ<a href="https://blog.mwish.me/2022/05/04/perfbook-notes-hardware/ï¼‰æåˆ°äº†å…¶ä¸­çš„è®¿é—®æ•ˆç‡ï¼Œæ€»ä¹‹è®¿é—®ä¸´è¿‘å†…å­˜">https://blog.mwish.me/2022/05/04/perfbook-notes-hardware/ï¼‰æåˆ°äº†å…¶ä¸­çš„è®¿é—®æ•ˆç‡ï¼Œæ€»ä¹‹è®¿é—®ä¸´è¿‘å†…å­˜</a> bandwidth æ˜¯è®¿é—®è¿œç«¯çš„æ•°å€ï¼Œé€Ÿåº¦ä¹Ÿå¿«äº†å¾ˆå¤šï¼š</p><p><img src="https://image.mwish.me/blog-image/C055FAB3-9FB7-4133-B8C3-65B37789DDAB.png" alt="C055FAB3-9FB7-4133-B8C3-65B37789DDAB"></p><p>æœ€åæ˜¯ä¸€äº›å…±äº« XX çš„æ¶æ„ï¼Œè¿™å›¾æ—¢å¯ä»¥æ˜¯å•æœºæˆ¿çš„ï¼Œä¹Ÿå¯ä»¥æ˜¯é›†ç¾¤æ¦‚å¿µä¸Šçš„ï¼ˆæ¯”å¦‚æˆ‘ä»¬ç»å¸¸è¯´ ClickHouse/TiDB æ˜¯ Shared Nothingï¼Œè€Œ snowflake/Aurora æ˜¯ Shared Storageï¼‰ï¼š</p><p><img src="https://image.mwish.me/blog-image/01958C33-98F6-47D8-A1A3-3FC18B61C1E2.png" alt="01958C33-98F6-47D8-A1A3-3FC18B61C1E2"></p><p>å…³äºå¹¶è¡Œæ‰§è¡ŒæŸ¥è¯¢ï¼Œç»å…¸çš„ä¾‹å­æ˜¯ interquery parallelism å’Œ intraquery parallelismã€‚è¿™ä¸¤ç§æ“ä½œæ˜¯äº’è¡¥çš„ã€‚å‰è€…æ¯”å¦‚å¯¹ Sortã€Join ç­‰æ“ä½œåšå¹¶è¡ŒåŒ–ï¼Œåè€…ä¾‹å¦‚ Pipeline Execution çš„æ—¶å€™ï¼Œå¹¶è¡Œå¤„ç†ä¸åŒçš„ Pipelineã€‚å¹¶è¡ŒæŸ¥è¯¢é€šå¸¸å’Œæ¶æ„ç›¸å…³ï¼Œè¿™é‡Œä»¥ shared nothing æ¶æ„ä¸ºä¾‹å­åšè®¨è®º</p><h2 id="Sort-Join-ç­‰æ“ä½œçš„å¹¶è¡Œæ‰§è¡Œ"><a href="#Sort-Join-ç­‰æ“ä½œçš„å¹¶è¡Œæ‰§è¡Œ" class="headerlink" title="Sort/Join ç­‰æ“ä½œçš„å¹¶è¡Œæ‰§è¡Œ"></a>Sort/Join ç­‰æ“ä½œçš„å¹¶è¡Œæ‰§è¡Œ</h2><h3 id="å¹¶è¡Œæ’åº"><a href="#å¹¶è¡Œæ’åº" class="headerlink" title="å¹¶è¡Œæ’åº"></a>å¹¶è¡Œæ’åº</h3><p><img src="https://image.mwish.me/blog-image/A35B426B-C144-4DB9-A30A-87513D29A332.png" alt="A35B426B-C144-4DB9-A30A-87513D29A332"></p><p>æ–¹æ¡ˆ (1) æ˜¯ å…ˆåš range partition, ç„¶åå† Local Sortï¼›æ–¹æ¡ˆ 2 æ˜¯å…ˆ Local Sortï¼Œç„¶åå†åœ¨å„ä¸ªèŠ‚ç‚¹ä¸²è¡Œ Mergeã€‚</p><p>å¯¹äºæ–¹æ¡ˆ 1ï¼Œè¿™é‡Œæˆ‘ä»¬æ˜¾ç„¶ä¼šè”æƒ³åˆ°æ•°æ®çš„ Skew ä¸Šï¼Œå¯¹äº <code>(a)</code>ï¼Œå¯ä»¥ç”¨è™šæ‹ŸèŠ‚ç‚¹ç­‰æ–¹å¼ï¼ŒæŠŠæ•°æ®åˆ‡ç¢ï¼Œå½“ç„¶è¿™ä¸ªå¯èƒ½å¼•å…¥åˆ«çš„ç½‘ç»œé€šä¿¡æµç¨‹ã€‚å¯¹äºæ–¹æ¡ˆ 2ï¼Œå®é™…ä¸Šï¼Œæœ¬åœ°æ’åºå®Œåï¼Œåœ¨èµ° (2) å¯èƒ½ä¼šå˜å¾—å¾ˆå¥‡æ€ªï¼Œè¿™é‡Œå¯èƒ½ä¼šæœ‰ execution skewï¼Œå³åœ¨æ¯ä¸ªèŠ‚ç‚¹æ¥æ”¶å®Œåï¼Œæ‰èƒ½å¤„ç†åˆ°ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ã€‚è¿™é‡Œä¹Ÿæœ‰æ”¹å–„æˆå¹¶è¡Œå¤„ç†çš„æ–¹å¼ï¼šè¿™é‡Œå¯èƒ½éœ€è¦æå‰å¯¹æ•°æ®èŒƒå›´åˆ†åŒºï¼Œç„¶åæŒ‰ç…§æ•°æ®åº”è¯¥è¢«åˆ†åŒºåˆ°å“ª å¹¶è¡Œ + Chunk å‘é€ã€‚</p><p>è§‚å¯Ÿåˆ°ï¼Œå¦‚æœæ•°æ®åœ¨æ¯ä¸ªåœ°æ–¹å·²ç»æ’åºå¥½ï¼Œæˆ–è€…æ˜¯èŒƒå›´åˆ†ç‰‡çš„è¯ï¼Œç›¸å½“äºå¾ˆå¤šä¸œè¥¿å·²ç»æ‰§è¡Œå¥½äº†ï¼Œè¿™è¿˜æ˜¯æŒºçˆ½çš„ã€‚</p><h3 id="å¹¶è¡Œ-Join"><a href="#å¹¶è¡Œ-Join" class="headerlink" title="å¹¶è¡Œ Join"></a>å¹¶è¡Œ Join</h3><p>æˆ‘ä»¬å¯ä»¥å…ˆå›é¡¾ä¸€ä¸‹å•æœº Join çš„æ‰§è¡Œæ–¹å¼ï¼š<a href="https://blog.mwish.me/2021/02/08/Notes-on-Query-Execution/#Join">https://blog.mwish.me/2021/02/08/Notes-on-Query-Execution/#Join</a></p><p>JOIN æœ‰å¾ˆå¤šå½¢å¼ï¼Œä¸€äº›ç®€å•çš„å½¢å¼ä¸­ï¼Œæ¯”å¦‚å†…è¿æ¥ + ç­‰å€¼è¿æ¥ï¼Œå¯ä»¥ä½¿ç”¨ç±»ä¼¼å•æœº Hash Join çš„æ–¹å¼ã€‚å½“ç„¶ï¼Œè¿™é‡Œåˆ†ç‰‡å¯ä»¥æŒ‰ç…§ Range/Hash ä»»æ„ä¸€ç§æ–¹å¼åˆ†ç‰‡ã€‚Hash Join çš„å¾ˆå¤šä¼˜åŒ–è¿™é‡Œä¹Ÿèƒ½ç”¨ä¸Šï¼Œæ¯”å¦‚éƒ¨åˆ†ç¼“å­˜åœ¨å†…å­˜ä¸­ã€‚</p><p><img src="https://image.mwish.me/blog-image/1526690F-EE20-43B5-B6AE-7688D7F76048.png" alt="1526690F-EE20-43B5-B6AE-7688D7F76048"></p><p>å¯¹äºä¸€äº›è¿æ¥æ¡ä»¶éç­‰å€¼çš„ï¼Œå¯ä»¥é‡‡ç”¨ broadcast-join çš„æ–¹å¼ï¼šå°†æŸä¸ªå…³ç³»åˆ†åŒºï¼Œå¹¶ä¸”å°†å¦ä¸€ä¸ªå…³ç³»ï¼ˆå°½é‡è¦å°ï¼‰å¤åˆ¶åˆ°æ‰€æœ‰çš„èŠ‚ç‚¹ä¸Šï¼Œè¿™ç§æ–¹å¼è¢«ç§°ä¸º Asymmetric fragment and replicateã€‚è¿˜æœ‰æ›´ç‹ çš„æ–¹å¼ï¼Œå°±æ˜¯ä¸¤è¾¹å…¨éƒ¨æ‹†äº†ï¼Œç„¶åå…¨éƒ¨æ‹·è´ï¼šå…³ç³» s, r éƒ½è¢«æ‹†æˆ m, n ä»½ï¼Œåˆ†é…åˆ° $m * n$ ä¸ªèŠ‚ç‚¹ä¸Šï¼Œäº§ç”Ÿ Joinã€‚ Fragment and replicate æ–¹å¼æ›´æ™®é€‚ä¸€äº›ã€‚è€Œå¯¹äº skewï¼Œå¯ä»¥ç”¨ç±»ä¼¼è™šæ‹ŸèŠ‚ç‚¹ + work steal çš„æ–¹å¼å¤„ç†æˆ–è€…æ‹†åˆ†ã€‚</p><p><img src="https://image.mwish.me/blog-image/F31EE37E-F4D4-4105-A093-2A92002DA520.png" alt="F31EE37E-F4D4-4105-A093-2A92002DA520"></p><p>å¯¹äºå…¶ä»–æ“ä½œæ¥è¯´ï¼Œæ‰§è¡Œæ–¹å¼å¦‚ä¸‹ï¼š</p><ol><li>Selection ä¸­ï¼Œå¦‚æœæœ‰å¯¹æŸ¥è¯¢çš„å±æ€§æœ‰åˆ†åŒºï¼Œé‚£ä¹ˆç»™å›ºå®šçš„åˆ†åŒºå‘é€æŸ¥è¯¢ã€‚å¦‚æœæ²¡æœ‰åˆ†åŒºï¼Œé‚£ä¹ˆéœ€è¦æ‰€æœ‰çš„èŠ‚ç‚¹å¹¶è¡Œèµ°æŸ¥è¯¢</li><li>duplicate elimination ä¸­ï¼Œå¯ä»¥å€ŸåŠ©æ’åº + å»é‡æ‰§è¡Œ</li><li>å¯¹äº Projectionï¼Œå¯ä»¥æŒ‰ç…§æ˜¯å¦ dedup æ¥åˆ†ç±»ï¼Œå¦‚æœå»é‡ï¼Œé‚£ä¹ˆå¯èƒ½èµ° 2ï¼›å¦åˆ™å¯ä»¥ç›´æ¥æ¨ä¸‹å»</li><li>Aggregation: è¿™é‡Œæ¯”å¦‚è¯´ sum/count/avg å¯ä»¥åˆ†åŒºï¼Œç„¶åå•æœºè¿”å›å¯¹åº”çš„ sum/count/(sum, count)ï¼Œç„¶åå¯¹æ¯ä¸ªæœºå™¨è¿”å›çš„ç»¼åˆå¤„ç†</li></ol><p>å®é™…ä¸Šï¼Œè¿™é‡Œè¿˜å¯ä»¥è€ƒè™‘åˆ° Map-Reduce çš„æ¨¡å‹ï¼š</p><p><img src="https://image.mwish.me/blog-image/750E9CBC-0DBB-4911-A353-C7B4F03764F8.png" alt="750E9CBC-0DBB-4911-A353-C7B4F03764F8"></p><ul><li>Map å¯ä»¥è§†ä¸ºæŸç§ç±»å‹çš„ Projection ç®—å­</li><li>Reduce å¯ä»¥è§†ä¸ºä¸€ç§ç”¨æˆ·å®šä¹‰çš„ Agg ç®—å­</li><li>Combine ç±»ä¼¼ä¸€ä¸ª pre-aggregateï¼Œç›¸å½“äºéƒ¨åˆ† agg çš„æ“ä½œ</li><li>Shuffle å®šä¹‰æ‰“åˆ° Reduce ä¸Šçš„åˆ†ç‰‡è§„åˆ™</li><li>æ ¹æ®å·¥ä½œè¿›å±•åŠ¨æ€è°ƒåº¦</li><li>BSP æ¨¡å‹ï¼Œæ‰§è¡Œå®Œ Map æ‰èƒ½æ‰§è¡Œ Reduce</li></ul><p>å®é™…ä¸Šï¼ŒMap-Reduce è¿˜æœ‰ Map-side join å’Œ Reduce-side join:</p><ol><li>Map-side join ä¼šåœ¨ map é˜¶æ®µäº§ç”Ÿä¸åŒçš„ join-keyï¼Œè¿™æ ·èƒ½å¤Ÿåœ¨ Reduce ä¹‹å‰å°±åˆ’åˆ†åˆ°ä¸€èµ·</li><li>Broadcast join ä¹Ÿæ˜¯ä¸€ç§ map-side joinï¼Œå°å…³ç³»ä¼šè¢« Map é˜¶æ®µ broadcast åˆ°æ‰€æœ‰åœ°æ–¹</li><li>Reduce-side join: Each mapper tags each row of two relations to identify which relation the row come from. After that, rows of which keys have the same key value are copied to the same reducer during shuï¬„ing.</li></ol><p>å…³äº Map-Reduceï¼Œä¸€ç¯‡æ¯”è¾ƒå¥½çš„ææ–™æ˜¯ KAIST çš„ <em>Parallel Data Processing with MapReduce: A Survey</em></p><h2 id="Operator-çš„å¹¶è¡Œæ‰§è¡Œ"><a href="#Operator-çš„å¹¶è¡Œæ‰§è¡Œ" class="headerlink" title="Operator çš„å¹¶è¡Œæ‰§è¡Œ"></a>Operator çš„å¹¶è¡Œæ‰§è¡Œ</h2><p>é¦–å…ˆï¼ŒPipeline + Push çš„æ¨¡å‹ï¼Œç›¸å¯¹ Pull çš„æ¨¡å‹ï¼Œå®é™…ä¸Šæ˜¯å¾ˆå¥½å¹¶è¡Œçš„ã€‚å„ä¸ªé˜¶æ®µéƒ½æ˜¯èƒ½å¹¶è¡Œçš„ï¼Œä¸€ä¸ªå¾ˆæ˜æ˜¾çš„åœ°æ–¹æ˜¯ï¼Œä¸€äº›é blocking operatorï¼Œå¯ä»¥è¿è¡Œç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…å¹¶è¡Œã€‚</p><p>æ­¤å¤–ï¼Œä¸å…³è”çš„ Operator æ˜¯å¯ä»¥å¹¶è¡Œå®Œæˆçš„ã€‚</p><p>æœ€åæˆ‘ä»¬å¯ä»¥å¼•å…¥è‘—åçš„ Exchange ç®—å­ã€‚è¿™ä¸ªç®—å­æœ€æ—©æ¥æºäº Volcano æ¨¡å‹ï¼Œå®ƒå¯¹æ•°æ®è¿›è¡ŒæŸç§ç¨‹åº¦çš„åˆ†åŒºï¼Œç„¶åæŒ‰ç…§è¿™ç§åˆ†åŒºæ¥æ‰§è¡Œï¼š</p><p><img src="https://image.mwish.me/blog-image/1E1CD9BE-B5B7-4DF4-9469-F3B6358AE707.png" alt="1E1CD9BE-B5B7-4DF4-9469-F3B6358AE707"></p><p><img src="https://image.mwish.me/blog-image/76F108B0-F7FA-42B6-BEB4-C121C613108D.png" alt="76F108B0-F7FA-42B6-BEB4-C121C613108D"></p><p>Exchange ç®—å­ç›¸å½“äºæ‰‹åŠ¨çš„åˆ†åŒº + å½’å¹¶ï¼Œæ¥åšæ•°æ®ä¸Šçš„å¹¶è¡Œã€‚ä¸‹å›¾ä¸ºä¸€ä¸ªåˆ†å¸ƒå¼æ‰§è¡Œçš„ sample:</p><p><img src="https://image.mwish.me/blog-image/6706C982-3FA1-4495-898B-9FB669D243AF.png" alt="6706C982-3FA1-4495-898B-9FB669D243AF"></p><p>ä¸Šé¢çš„å†…å®¹è¡¨ç¤ºäº†å•éƒ¨åˆ†çš„ Pipeline å’Œ Pipeline ä¹‹é—´çš„ä¾èµ–å…³ç³»ã€‚</p><p>åˆ†å¸ƒå¼æŸ¥è¯¢æ‰§è¡Œè¿˜å¾—è€ƒè™‘ä¸€äº›åˆ«çš„ä¸œè¥¿ï¼Œæ¯”å¦‚æ•…éšœï¼Œè¿™é‡Œæœ‰ä¸¤ç§å¯ä»¥å‚è€ƒçš„æ–¹æ¡ˆï¼š</p><ol><li>Map-Reduce é‚£ç§ BSP çš„æ–¹æ¡ˆ</li><li>Spark çš„ RDD æ–¹æ¡ˆ</li></ol><h3 id="å…±äº«å†…å­˜ç³»ç»Ÿçš„æŸ¥è¯¢å¤„ç†"><a href="#å…±äº«å†…å­˜ç³»ç»Ÿçš„æŸ¥è¯¢å¤„ç†" class="headerlink" title="å…±äº«å†…å­˜ç³»ç»Ÿçš„æŸ¥è¯¢å¤„ç†"></a>å…±äº«å†…å­˜ç³»ç»Ÿçš„æŸ¥è¯¢å¤„ç†</h3><p>è¿™ä¸ªç±»ä¼¼åœ¨å•æœºçš„ NUMA ç³»ç»Ÿä¸Šå¹¶è¡Œå¤„ç†æŸ¥è¯¢ã€‚ä¹‹å‰çš„å†…å®¹ä¹Ÿæ˜¯èƒ½ç”¨ä¸Šçš„ï¼Œä½†æ˜¯æœ‰ä¸€äº›æ¯”è¾ƒå¾®å¦™çš„ä¸åŒï¼š</p><ol><li>å¯¹äº broadcast joinï¼Œå°è¡¨æ•°æ®å¯èƒ½å¯ä»¥æ”¾åœ¨å…±äº«å†…å­˜ä¸­ï¼Œç”¨æ›´å·§å¦™çš„æ–¹å¼å…±äº«ï¼ˆä¸è¿‡ä¼°æ‘¸ç€ä¹Ÿå¾—è€ƒè™‘ cache ä»€ä¹ˆçš„ï¼Œæ„Ÿè§‰å®é™…åŒºåˆ«ä¸å¤§ï¼‰</li><li>Work-steal ä¼šå˜å¾—ç®€å•å¾ˆå¤šï¼Œå°½ç®¡å¤šæ ¸ç³»ç»Ÿè®¿é—®åˆ«çš„åœ°æ–¹æ•°æ®ä¹Ÿæœ‰æƒ©ç½šï¼Œä½†æ˜¯ä¼šæ¯” shard nothing ç³»ç»Ÿå°å¾ˆå¤šå¾ˆå¤šã€‚å¯ä»¥ç”¨è¿™ç§æ–¹å¼é¿å… skew</li><li>Hash Join æ—¢å¯ä»¥ç”¨ shared nothing çš„æ–¹å¼å¤„ç†ã€ä¹Ÿå¯ä»¥è®©å…³ç³» Hash Join ç´¢å¼•è¡¨å°ä¸€äº›ï¼Œç„¶åå¹¶è¡Œ Build -&gt; å¹¶è¡Œ Probe ï¼ˆç±»ä¼¼ Morsel è°ƒåº¦è®ºæ–‡æåˆ°çš„ï¼‰</li></ol><p>æœ€åˆé€‚çš„ç®—æ³•ä¸€èˆ¬éƒ½æ˜¯ NUMA-Aware çš„ï¼Œå…·ä½“å¯ä»¥å‚è€ƒ Morsel æˆ–è€…ä¸€äº›æŸ¥è¯¢æ‰§è¡Œç›¸å…³çš„è®ºæ–‡ã€‚</p><h2 id="æŸ¥è¯¢ä¼˜åŒ–å’Œä»£ä»·"><a href="#æŸ¥è¯¢ä¼˜åŒ–å’Œä»£ä»·" class="headerlink" title="æŸ¥è¯¢ä¼˜åŒ–å’Œä»£ä»·"></a>æŸ¥è¯¢ä¼˜åŒ–å’Œä»£ä»·</h2><p>è¿™é‡Œç›¸å¯¹äºä¹‹å‰æˆ‘ä»¬ä»‹ç»çš„å•æœº Plannerï¼Œè¦è€ƒè™‘çš„ä¸œè¥¿æ›´å¤šäº†ï¼š</p><ol><li>æ€ä¹ˆå¯¹ Operator è¿›è¡Œå¹¶è¡ŒåŒ–ï¼šåŒ…æ‹¬ä½¿ç”¨ä»€ä¹ˆç®—æ³•ã€æ€ä¹ˆåˆ†åŒºã€æ€ä¹ˆæ’å…¥ Exchange ç®—å­</li><li>å¦‚ä½•å¯¹è®¡åˆ’è¿›è¡Œè°ƒåº¦ï¼ŒåŒ…æ‹¬ï¼š<ol><li>Operator ä½¿ç”¨å¤šå°‘èŠ‚ç‚¹</li><li>å°†ä»€ä¹ˆè®¡ç®— Pipeline åŒ–</li><li>åˆ†è¾¨ä¸²è¡Œ/å¹¶è¡Œçš„æ‰§è¡Œ</li></ol></li></ol><p>ä¹¦ä¸Šä¸¾äº†ä¸ªæœ‰ç‚¹åƒ Interesting order çš„ä¾‹å­ï¼Œæ¥è¯´æ˜åˆ†å¸ƒå¼ Plan çš„å¤æ‚æ€§:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">r JOIN s ON r.A = s.A AND r.B = s.B</span><br></pre></td></tr></table></figure><p>å¯¹äºä¸Šè¿°å†…å®¹è€Œè¨€ï¼ŒæŠŠ <code>r</code> å’Œ <code>s</code> æŒ‰ç…§ <code>A</code> , <code>B</code>, <code>(A, B)</code> åˆ†åŒºä¸­ï¼Œ<code>(A, B)</code> æ˜¾ç„¶æ˜¯æœ€åˆé€‚çš„ï¼Œä½†æ˜¯å¦‚æœæŸ¥è¯¢å¦‚ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT SUM(s.C) from (r JOIN s ON r.A = s.A AND r.B = s.B) GROUP BY s.A;</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆï¼Œå¦‚æœæŒ‰ç…§ <code>(A, B)</code> åˆ†åŒºï¼Œè¿™é‡Œå¯èƒ½åˆè¦æŒ‰ç…§ A æ¥åšä¸€æ¬¡èšåˆï¼Œå¯èƒ½æŒ‰ç…§ <code>A</code> åˆ†åŒºä»£ä»·åˆæ˜¯æœ€å°çš„ã€‚</p><p>åœ¨å¹¶è¡Œæ¨¡å‹ä¸­ï¼Œè¿˜æœ‰ä¸€äº›å…³äºä»£ä»·çš„é—®é¢˜ï¼Œåœ¨ RDBMS ä¸­ï¼Œæˆ‘ä»¬ä»¥ä¹‹å‰åšå®¢ä¸¾çš„ä¾‹å­ä¸ºä¾‹ï¼š<a href="https://blog.mwish.me/2021/11/05/An-Overview-of-Query-Optimization-in-Relational-Systems/#Statistics-And-Cost-Estimation">https://blog.mwish.me/2021/11/05/An-Overview-of-Query-Optimization-in-Relational-Systems/#Statistics-And-Cost-Estimation</a></p><p>è¿™é‡Œçš„ Cost å°±æ˜¯èµ„æºæ¶ˆè€—çš„ costï¼Œå³ IO Cost + CPU cost + memory + bandwidthâ€¦</p><p>ä½ å¯èƒ½è§‰å¾—å¾ˆè‡ªç„¶ï¼Œä½†æ˜¯å®é™…ä¸Šåˆ†å¸ƒå¼ç³»ç»Ÿé‡Œï¼Œä¸¤ä¸ª Plan ã€Œèµ„æºæ¶ˆè€—ã€ç›¸åŒï¼Œä½†æ˜¯ç”±äºå¹¶è¡Œèƒ½åŠ›ï¼Œå¯èƒ½æ‰§è¡Œæ—¶é—´ä¸ä¸€æ ·ï¼Œè¿™é‡Œè¿˜è¦è€ƒè™‘ã€Œresponse-time cost modelã€ï¼šå‡è®¾ p1, p2 éƒ¨åˆ†èƒ½å¹¶è¡Œï¼Œè¿™éƒ¨åˆ†ä»£ä»·å¯èƒ½å°±æ˜¯ $max(p1, p2)$ ï¼Œå®ƒè¦è€ƒè™‘åœ¨å¤šä¸ªèŠ‚ç‚¹è¿›è¡Œè¿ç®—çš„å¯åŠ¨æˆæœ¬ï¼ˆstart-up costï¼‰å’Œ skewã€‚</p><p>æœ€åï¼Œå¯¹äºç›¸å…³çš„ Plan ç”Ÿæˆï¼Œå› ä¸ºè¿™é‡Œ Card åˆå¤§äº†ä¸å°‘ï¼Œæ‰€ä»¥ä¼šéå¸¸éº»çƒ¦ã€‚ä¼˜åŒ–å™¨å¯èƒ½ä¼šç”¨å¯å‘å¼çš„æ–¹æ³•ï¼šç”Ÿæˆæœ€ä½³çš„å•æœºæ‰§è¡Œè®¡åˆ’ï¼Œç„¶ååˆ†å¸ƒå¼åŒ–ã€‚è¿™é‡Œå¯ä»¥å‚è€ƒ CockroachDB çš„æ–‡æ¡£ï¼š<a href="https://github.com/cockroachdb/cockroach/blob/master/docs/RFCS/20160421_distributed_sql.md">https://github.com/cockroachdb/cockroach/blob/master/docs/RFCS/20160421_distributed_sql.md</a></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>crossbeam-epoch</title>
      <link href="/2022/06/04/crossbeam-epoch/"/>
      <url>/2022/06/04/crossbeam-epoch/</url>
      
        <content type="html"><![CDATA[<p><code>crossbeam-epoch</code> æ˜¯ crossbeam ç”¨æ¥ç®¡ç†å†…å­˜çš„å­åŒ…ï¼Œå®ƒå®ç°äº† epoch-based reclaimã€‚å¹¶å‘ç¼–ç¨‹çš„æ—¶å€™ä¼šæœ‰å†…å­˜å›æ”¶é—®é¢˜å’Œ ABA é—®é¢˜ï¼Œä½†æœ¬è´¨ä¸Šï¼Œè§£å†³äº†å†…å­˜é—®é¢˜ï¼Œå°±è§£å†³äº† ABA é—®é¢˜ï¼Œå› ä¸ºåè€…æœ¬è´¨æ˜¯å†…å­˜ reuse å¯¼è‡´çš„ã€‚</p><p>Epoch Based Reclaim æœ‰ç‚¹ç±»ä¼¼æŸç§ç¨‹åº¦ä¸Šçš„ RCï¼Œä½†æ˜¯å®ƒçš„ RC çš„ç²’åº¦è¦ç²—å¾ˆå¤šï¼šé’ˆå¯¹ Epochï¼Œè€Œéé’ˆå¯¹ Objectï¼Œè¿™è®©ç»´æŠ¤å’Œä½¿ç”¨å®ƒçš„ä»£ä»·å˜å°äº†å¾ˆå¤šï¼Œå®ƒå¼•å…¥çš„è¯­ä¹‰å¦‚ä¸‹ï¼š</p><blockquote><p>There are a few non-GC-based ways of managing memory for lock-free code, but they all come down to the same core observations:</p><ol><li>There are two sources of reachability at play â€“ the data structure, and the snapshots in threads accessing it. Before we delete a node, we need to know that it cannot be reached in either of these ways.</li><li>Once a node has been unlinked from the data structure, no <em>new</em> snapshots reaching it will be created.</li></ol></blockquote><p>ç»¼ä¸Šï¼Œä¸€ä¸ªå¯¹è±¡åªèƒ½è¢«åˆ é™¤ä¸€æ¬¡ï¼Œéšç€æœ€åä¸€ä¸ªå¯èƒ½å¯èƒ½è¯»åˆ°å®ƒçš„çº¿ç¨‹ç»“æŸï¼Œå®ƒå°±æ˜¯ã€Œå¯æ¸…é™¤ã€çš„äº†ï¼Œå®ƒä¼šéšç€ epoch çš„æ¨é«˜è€Œæ¸…é™¤ã€‚</p><p><code>crossbeam-epoch</code> å®ç°äº†ä¸Šè¿°çš„è¯­ä¹‰ï¼Œå¹¶å¼•å…¥äº†ä¸€å¥—å­ç³»ç»Ÿï¼Œæ¥è¡¨ç¤ºå¯¹åº”çš„å†…å­˜æŒ‡é’ˆå’Œå¼•ç”¨ã€‚</p><p>Epoch æä¾›äº†ï¼š</p><ol><li>Global Epoch Counter (å–å€¼ 0/1/2, ä¸‰ä¸ª epoch è¿­ä»£)</li><li>æ¯ä¸ª Epoch æŒ‚çš„ Garbage</li><li>æ¯ä¸ª Thread æ˜¯å¦æ˜¯ â€œActiveâ€ çš„</li><li>æ¯ä¸ª Thread çš„ Epoch</li></ol><p>æ¯ä¸ªçº¿ç¨‹å¯åŠ¨çš„æ—¶å€™ï¼Œä¼šæŠŠè‡ªå·±çš„ Epoch è®¾ç½®æˆå…¨å±€çš„ Epochï¼Œunlink ä¸€ä¸ªå¯¹è±¡çš„æ—¶å€™ï¼Œä¼šæ”¾åˆ° Global Garbage åˆ—è¡¨ä¸­ï¼Œã€Œå½“å‰ Epochã€å¯¹åº”çš„åœ°æ–¹ã€‚çº¿ç¨‹å®Œæˆæ“ä½œçš„æ—¶å€™ï¼Œä¼šæ¸…é™¤ Active æ ‡è®°ã€‚è¿™é‡Œæœ‰3ä¸ª epochï¼Œæ²¡æœ‰ä»»ä½•è¯»è€…çš„ Epoch ç†è®ºä¸Šæ˜¯ <code>current - 2</code>, å®ƒä¸Šé¢çš„å¯¹è±¡å¯ä»¥è¢« GCã€‚</p><p>æ€§èƒ½ç›¸å…³å¯è§ï¼š<em>Performance of memory reclamation for lockless synchronization</em></p><h2 id="API-of-crossbeam-epoch"><a href="#API-of-crossbeam-epoch" class="headerlink" title="API of crossbeam-epoch"></a>API of crossbeam-epoch</h2><p><code>pin()</code> äº§ç”Ÿä¸€ä¸ªæœ¬çº¿ç¨‹çš„ <code>Guard</code> ï¼Œ<code>Guard</code> æ²¡é€€å‡ºè¡¨ç¤ºè¿™ä¸ªçº¿ç¨‹è¿˜åœ¨æ´»è·ƒï¼Œå®é™…ä¸Šå°±æ˜¯ æŸä¸ªçº¿ç¨‹/ç‰ˆæœ¬çš„ RAIIã€‚</p><p>ç„¶åæœ‰ä¸‹é¢çš„æ™ºèƒ½æŒ‡é’ˆï¼š</p><blockquote><p>To put the <code>Guard</code> to use, Crossbeam provides a set of three pointer types meant to work together:</p><ul><li><code>Owned&lt;T&gt;</code>, akin to <code>Box&lt;T&gt;</code>, which points to uniquely-owned data that has not yet been published in a concurrent data structure.</li><li><code>Shared&lt;&#39;a, T&gt;</code>, akin to <code>&amp;&#39;a T</code>, which points to shared data that may or may not be reachable from a data structure, but it guaranteed not to be freed during lifetime <code>&#39;a</code>.</li><li><code>Atomic&lt;T&gt;</code>, akin to <code>std::sync::atomic::AtomicPtr</code>, which provides atomic updates to a pointer using the <code>Owned</code> and <code>Shared</code> types, and connects them to a <code>Guard</code>.</li></ul></blockquote><p>ä¸Šé¢çš„ç±»å‹è¶³ä»¥è¡¨è¿°äº†ï¼Œå…·ä½“è§ï¼š<a href="https://aturon.github.io/blog/2015/08/27/epoch/">https://aturon.github.io/blog/2015/08/27/epoch/</a></p><p>ä¸€äº›è¦ç‚¹æ˜¯ï¼ˆåœ¨ä¸Šæ–‡çš„ Managing garbage æ®µï¼‰ï¼š</p><ol><li>unlink çš„æ—¶å€™å¯ä»¥è¿è¡Œ destructor, è€Œ ebr åªå…·ä½“å›æ”¶å†…å­˜ï¼ˆå®‰å…¨æ€§ï¼šæ“ä½œéƒ½ä¼šèµ° casï¼‰</li><li>çº¿ç¨‹æœ‰ä¸€äº› TLS çš„åƒåœ¾åˆ—è¡¨ï¼Œå¯èƒ½ä¼šåœ¨æœ‰ä¸€å®šé˜ˆå€¼çš„æ—¶å€™ emit åˆ°å…¨å±€çš„åˆ—è¡¨ä¸­</li><li><code>epoch::pin</code> çš„æ—¶å€™ï¼Œå¯èƒ½ä¼š emit åƒåœ¾ç”šè‡³è§¦å‘åƒåœ¾æ¸…ç†</li></ol><h2 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h2><h3 id="Tools"><a href="#Tools" class="headerlink" title="Tools"></a>Tools</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">âœ  src git:(master) tree</span><br><span class="line">.</span><br><span class="line">â”œâ”€â”€ atomic.rs</span><br><span class="line">â”œâ”€â”€ collector.rs</span><br><span class="line">â”œâ”€â”€ default.rs</span><br><span class="line">â”œâ”€â”€ deferred.rs</span><br><span class="line">â”œâ”€â”€ epoch.rs</span><br><span class="line">â”œâ”€â”€ guard.rs</span><br><span class="line">â”œâ”€â”€ internal.rs</span><br><span class="line">â”œâ”€â”€ lib.rs</span><br><span class="line">â””â”€â”€ sync</span><br><span class="line">    â”œâ”€â”€ list.rs</span><br><span class="line">    â”œâ”€â”€ mod.rs</span><br><span class="line">    â””â”€â”€ queue.rs</span><br></pre></td></tr></table></figure><p>é¦–å…ˆï¼Œæˆ‘ä»¬å…³æ³¨ä¸€ä¸‹å‘¨è¾¹å·¥å…·ï¼Œä¾‹å­æ˜¯ <code>sync</code> ç›®å½•ï¼Œè¿™ä¸ªç›®å½•æœ‰ç‚¹å¾ªç¯å¼•ç”¨çš„å‘³é“ï¼Œç”¨ <code>crossbeam-epoch</code> å®ç°äº†ä¸¤ä¸ªç»„ä»¶ï¼š</p><ol><li>å¹¶å‘çš„ linked-list queueï¼šæŒ‰ç…§ <a href="http://dl.acm.org/citation.cfm?id=248106">http://dl.acm.org/citation.cfm?id=248106</a> å’Œ <a href="https://doi.org/10.1007/978-3-540-30232-2_7">https://doi.org/10.1007/978-3-540-30232-2_7</a> å®ç°</li><li>å¹¶å‘çš„ä¾µå…¥å¼é“¾è¡¨ï¼š<a href="http://www.cs.tau.ac.il/~afek/p73-Lock-Free-HashTbls-michael.pdf">http://www.cs.tau.ac.il/~afek/p73-Lock-Free-HashTbls-michael.pdf</a></li></ol><p>ä¸Šé¢ä¸¤ä¸ª case å¯ä»¥å½“ä½œå®ç°çš„ä¾‹å­ï¼Œç„¶å crossbeam-epoch ä¹Ÿç”¨åˆ°äº†å®ƒä¿©ã€‚</p><p>Queue çš„æ¥å£æ¯”è¾ƒç®€å•ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">impl</span>&lt;T&gt; Queue&lt;T&gt; &#123;</span><br><span class="line">    <span class="comment">/// Create a new, empty queue.</span></span><br><span class="line">    <span class="title function_ invoke__">pub</span>(<span class="keyword">crate</span>) <span class="keyword">fn</span> <span class="title function_">new</span>() <span class="punctuation">-&gt;</span> Queue&lt;T&gt;;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/// Adds `t` to the back of the queue, possibly waking up threads blocked on `pop`.</span></span><br><span class="line">    <span class="title function_ invoke__">pub</span>(<span class="keyword">crate</span>) <span class="keyword">fn</span> <span class="title function_">push</span>(&amp;<span class="keyword">self</span>, t: T, guard: &amp;Guard);</span><br><span class="line">    </span><br><span class="line">        <span class="comment">/// Attempts to dequeue from the front.</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// Returns `None` if the queue is observed to be empty.</span></span><br><span class="line">    <span class="title function_ invoke__">pub</span>(<span class="keyword">crate</span>) <span class="keyword">fn</span> <span class="title function_">try_pop</span>(&amp;<span class="keyword">self</span>, guard: &amp;Guard) <span class="punctuation">-&gt;</span> <span class="type">Option</span>&lt;T&gt;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Attempts to dequeue from the front, if the item satisfies the given condition.</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// Returns `None` if the queue is observed to be empty, or the head does not satisfy the given</span></span><br><span class="line">    <span class="comment">/// condition.</span></span><br><span class="line">    <span class="title function_ invoke__">pub</span>(<span class="keyword">crate</span>) <span class="keyword">fn</span> <span class="title function_">try_pop_if</span>&lt;F&gt;(&amp;<span class="keyword">self</span>, condition: F, guard: &amp;Guard) <span class="punctuation">-&gt;</span> <span class="type">Option</span>&lt;T&gt;</span><br><span class="line">    <span class="keyword">where</span></span><br><span class="line">        T: <span class="built_in">Sync</span>,</span><br><span class="line">        F: <span class="title function_ invoke__">Fn</span>(&amp;T) <span class="punctuation">-&gt;</span> <span class="type">bool</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è€Œ List æ˜¯ä¸€ä¸ªä¾µå…¥å¼ç»“æ„ï¼Œå¤§æ¦‚éœ€è¦å®ç°ä¸€ä¸ª <code>IsElement</code>:</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// An entry in a linked list.</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// An Entry is accessed from multiple threads, so it would be beneficial to put it in a different</span></span><br><span class="line"><span class="comment">/// cache-line than thread-local data in terms of performance.</span></span><br><span class="line"><span class="meta">#[derive(Debug)]</span></span><br><span class="line"><span class="title function_ invoke__">pub</span>(<span class="keyword">crate</span>) <span class="keyword">struct</span> <span class="title class_">Entry</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// Implementing this trait asserts that the type `T` can be used as an element in the intrusive</span></span><br><span class="line"><span class="comment">/// linked list defined in this module. `T` has to contain (or otherwise be linked to) an instance</span></span><br><span class="line"><span class="comment">/// of `Entry`.</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// # Example</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// ```ignore</span></span><br><span class="line"><span class="comment">/// struct A &#123;</span></span><br><span class="line"><span class="comment">///     entry: Entry,</span></span><br><span class="line"><span class="comment">///     data: usize,</span></span><br><span class="line"><span class="comment">/// &#125;</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// impl IsElement&lt;A&gt; for A &#123;</span></span><br><span class="line"><span class="comment">///     fn entry_of(a: &amp;A) -&gt; &amp;Entry &#123;</span></span><br><span class="line"><span class="comment">///         let entry_ptr = ((a as usize) + offset_of!(A, entry)) as *const Entry;</span></span><br><span class="line"><span class="comment">///         unsafe &#123; &amp;*entry_ptr &#125;</span></span><br><span class="line"><span class="comment">///     &#125;</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">///     unsafe fn element_of(entry: &amp;Entry) -&gt; &amp;T &#123;</span></span><br><span class="line"><span class="comment">///         let elem_ptr = ((entry as usize) - offset_of!(A, entry)) as *const T;</span></span><br><span class="line"><span class="comment">///         &amp;*elem_ptr</span></span><br><span class="line"><span class="comment">///     &#125;</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">///     unsafe fn finalize(entry: &amp;Entry, guard: &amp;Guard) &#123;</span></span><br><span class="line"><span class="comment">///         guard.defer_destroy(Shared::from(Self::element_of(entry) as *const _));</span></span><br><span class="line"><span class="comment">///     &#125;</span></span><br><span class="line"><span class="comment">/// &#125;</span></span><br><span class="line"><span class="comment">/// ```</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// This trait is implemented on a type separate from `T` (although it can be just `T`), because</span></span><br><span class="line"><span class="comment">/// one type might be placeable into multiple lists, in which case it would require multiple</span></span><br><span class="line"><span class="comment">/// implementations of `IsElement`. In such cases, each struct implementing `IsElement&lt;T&gt;`</span></span><br><span class="line"><span class="comment">/// represents a distinct `Entry` in `T`.</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// For example, we can insert the following struct into two lists using `entry1` for one</span></span><br><span class="line"><span class="comment">/// and `entry2` for the other:</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// ```ignore</span></span><br><span class="line"><span class="comment">/// struct B &#123;</span></span><br><span class="line"><span class="comment">///     entry1: Entry,</span></span><br><span class="line"><span class="comment">///     entry2: Entry,</span></span><br><span class="line"><span class="comment">///     data: usize,</span></span><br><span class="line"><span class="comment">/// &#125;</span></span><br><span class="line"><span class="comment">/// ```</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="title function_ invoke__">pub</span>(<span class="keyword">crate</span>) <span class="keyword">trait</span> <span class="title class_">IsElement</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="comment">/// Returns a reference to this element&#x27;s `Entry`.</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">entry_of</span>(_: &amp;T) <span class="punctuation">-&gt;</span> &amp;Entry;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Given a reference to an element&#x27;s entry, returns that element.</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// ```ignore</span></span><br><span class="line">    <span class="comment">/// let elem = ListElement::new();</span></span><br><span class="line">    <span class="comment">/// assert_eq!(elem.entry_of(),</span></span><br><span class="line">    <span class="comment">///            unsafe &#123; ListElement::element_of(elem.entry_of()) &#125; );</span></span><br><span class="line">    <span class="comment">/// ```</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// # Safety</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// The caller has to guarantee that the `Entry` is called with was retrieved from an instance</span></span><br><span class="line">    <span class="comment">/// of the element type (`T`).</span></span><br><span class="line">    <span class="keyword">unsafe</span> <span class="keyword">fn</span> <span class="title function_">element_of</span>(_: &amp;Entry) <span class="punctuation">-&gt;</span> &amp;T;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// The function that is called when an entry is unlinked from list.</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// # Safety</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// The caller has to guarantee that the `Entry` is called with was retrieved from an instance</span></span><br><span class="line">    <span class="comment">/// of the element type (`T`).</span></span><br><span class="line">    <span class="keyword">unsafe</span> <span class="keyword">fn</span> <span class="title function_">finalize</span>(_: &amp;Entry, _: &amp;Guard);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// A lock-free, intrusive linked list of type `T`.</span></span><br><span class="line"><span class="meta">#[derive(Debug)]</span></span><br><span class="line"><span class="title function_ invoke__">pub</span>(<span class="keyword">crate</span>) <span class="keyword">struct</span> <span class="title class_">List</span>&lt;T, C: IsElement&lt;T&gt; = T&gt;;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªç»“æ„å°±ï¼Œéå¸¸ä¾µå…¥å¼ï¼Œç‰›é€¼çš„ã€‚</p><h4 id="Epoch"><a href="#Epoch" class="headerlink" title="Epoch"></a>Epoch</h4><p>ç„¶åæ˜¯ epoch æœ‰å…³çš„ç±»å‹ï¼Œä¸‹é¢è¿™éƒ¨åˆ†åœ¨ <code>epoch.rs</code>:</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//! The global epoch</span></span><br><span class="line"><span class="comment">//!</span></span><br><span class="line"><span class="comment">//! The last bit in this number is unused and is always zero. Every so often the global epoch is</span></span><br><span class="line"><span class="comment">//! incremented, i.e. we say it &quot;advances&quot;. A pinned participant may advance the global epoch only</span></span><br><span class="line"><span class="comment">//! if all currently pinned participants have been pinned in the current epoch.</span></span><br><span class="line"><span class="comment">//!</span></span><br><span class="line"><span class="comment">//! If an object became garbage in some epoch, then we can be sure that after two advancements no</span></span><br><span class="line"><span class="comment">//! participant will hold a reference to it. That is the crux of safe memory reclamation.</span></span><br></pre></td></tr></table></figure><p>çœ‹ä¸Šé¢çš„è¡¨ç¤ºï¼ŒEpoch æœ€åä¸€ä½è¡¨ç¤ºæ˜¯å¦ pinï¼Œè¿™ä¸ªåœ¨å…¨å±€ Epoch é‡Œé¢æ˜¯æ²¡æœ‰æ„ä¹‰çš„ï¼Œä½†æ˜¯å±€éƒ¨æ•°æ®å¯¹è±¡å¯èƒ½ä¾èµ–è¿™ä¸ªæ•°æ®ï¼Œè€Œå‰é¢çš„æ•°æ®ä»£è¡¨å…·ä½“ç‰ˆæœ¬ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// An epoch that can be marked as pinned or unpinned.</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// Internally, the epoch is represented as an integer that wraps around at some unspecified point</span></span><br><span class="line"><span class="comment">/// and a flag that represents whether it is pinned or unpinned.</span></span><br><span class="line"><span class="meta">#[derive(Copy, Clone, Default, Debug, Eq, PartialEq)]</span></span><br><span class="line"><span class="title function_ invoke__">pub</span>(<span class="keyword">crate</span>) <span class="keyword">struct</span> <span class="title class_">Epoch</span> &#123;</span><br><span class="line">    <span class="comment">/// The least significant bit is set if pinned. The rest of the bits hold the epoch.</span></span><br><span class="line">    data: <span class="type">usize</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œè¿˜åŒ…äº†ä¸€å±‚ <code>AtomicEpoch</code>, <code>AtomicEpoch</code> æä¾›äº†å¯¹ <code>Epoch</code> çš„ <code>load</code>, <code>store</code> å’Œ <code>cas</code> æ“ä½œï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// An atomic value that holds an `Epoch`.</span></span><br><span class="line"><span class="meta">#[derive(Default, Debug)]</span></span><br><span class="line"><span class="title function_ invoke__">pub</span>(<span class="keyword">crate</span>) <span class="keyword">struct</span> <span class="title class_">AtomicEpoch</span> &#123;</span><br><span class="line">    <span class="comment">/// Since `Epoch` is just a wrapper around `usize`, an `AtomicEpoch` is similarly represented</span></span><br><span class="line">    <span class="comment">/// using an `AtomicUsize`.</span></span><br><span class="line">    data: AtomicUsize,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="Deferred"><a href="#Deferred" class="headerlink" title="Deferred"></a>Deferred</h4><p><code>Deferred</code> æ˜¯ä¸€ä¸ª defer çš„ <code>data</code> + <code>destructor</code>, æˆ‘æ„Ÿè§‰å¯ä»¥ <code>Box&lt;Fn(...)&gt;</code>ï¼Œä¸è¿‡å®ƒè¿™æ„Ÿè§‰æ³›ç”¨å¾ˆå¤šã€‚å®ƒé è°±çš„åŠŸèƒ½å¦‚ä¸‹ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// Number of words a piece of `Data` can hold.</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// Three words should be enough for the majority of cases. For example, you can fit inside it the</span></span><br><span class="line"><span class="comment">/// function pointer together with a fat pointer representing an object that needs to be destroyed.</span></span><br><span class="line"><span class="keyword">const</span> DATA_WORDS: <span class="type">usize</span> = <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// Some space to keep a `FnOnce()` object on the stack.</span></span><br><span class="line"><span class="keyword">type</span> <span class="title class_">Data</span> = [<span class="type">usize</span>; DATA_WORDS];</span><br><span class="line"></span><br><span class="line"><span class="comment">/// A `FnOnce()` that is stored inline if small, or otherwise boxed on the heap.</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// This is a handy way of keeping an unsized `FnOnce()` within a sized structure.</span></span><br><span class="line"><span class="title function_ invoke__">pub</span>(<span class="keyword">crate</span>) <span class="keyword">struct</span> <span class="title class_">Deferred</span> &#123;</span><br><span class="line">    call: <span class="keyword">unsafe</span> <span class="title function_ invoke__">fn</span>(*<span class="keyword">mut</span> <span class="type">u8</span>),</span><br><span class="line">    data: MaybeUninit&lt;Data&gt;,</span><br><span class="line">    _marker: PhantomData&lt;*<span class="title function_ invoke__">mut</span> ()&gt;, <span class="comment">// !Send + !Sync</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Deferred</span> &#123;</span><br><span class="line">    <span class="comment">/// Constructs a new `Deferred` from a `FnOnce()`.</span></span><br><span class="line">    <span class="title function_ invoke__">pub</span>(<span class="keyword">crate</span>) <span class="keyword">fn</span> <span class="title function_">new</span>&lt;F: <span class="title function_ invoke__">FnOnce</span>()&gt;(f: F) <span class="punctuation">-&gt;</span> <span class="keyword">Self</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Calls the function.</span></span><br><span class="line">    <span class="meta">#[inline]</span></span><br><span class="line">    <span class="title function_ invoke__">pub</span>(<span class="keyword">crate</span>) <span class="keyword">fn</span> <span class="title function_">call</span>(<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">call</span> = <span class="keyword">self</span>.call;</span><br><span class="line">        <span class="keyword">unsafe</span> &#123; <span class="title function_ invoke__">call</span>(<span class="keyword">self</span>.data.<span class="title function_ invoke__">as_mut_ptr</span>() <span class="keyword">as</span> *<span class="keyword">mut</span> <span class="type">u8</span>) &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶å®å¾ˆæ˜æ˜¾äº†ï¼Œæ„Ÿè§‰è¿˜æ˜¯æŒºç®€å•çš„ã€‚</p><h4 id="Bag"><a href="#Bag" class="headerlink" title="Bag"></a>Bag</h4><p>åœ¨ <code>internal.rs</code> é‡Œé¢ï¼Œå®ç°äº† <code>Bag</code> å’Œ <code>SealedBag</code>. <code>Bag</code> æ˜¯ä¸€ç»„ <code>Deferred</code>, è€Œ <code>SealedBag</code> åˆ™æ˜¯å®šäº†æŸä¸ªç‰ˆæœ¬çš„ <code>SealedBag</code>, ä»–ä»¬å†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//! # Thread-local bag</span></span><br><span class="line"><span class="comment">//!</span></span><br><span class="line"><span class="comment">//! Objects that get unlinked from concurrent data structures must be stashed away until the global</span></span><br><span class="line"><span class="comment">//! epoch sufficiently advances so that they become safe for destruction. Pointers to such objects</span></span><br><span class="line"><span class="comment">//! are pushed into a thread-local bag, and when it becomes full, the bag is marked with the current</span></span><br><span class="line"><span class="comment">//! global epoch and pushed into the global queue of bags. We store objects in thread-local storages</span></span><br><span class="line"><span class="comment">//! for amortizing the synchronization cost of pushing the garbages to a global queue.</span></span><br></pre></td></tr></table></figure><p>ä»£ç ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// Maximum number of objects a bag can contain.</span></span><br><span class="line"><span class="meta">#[cfg(not(crossbeam_sanitize))]</span></span><br><span class="line"><span class="keyword">const</span> MAX_OBJECTS: <span class="type">usize</span> = <span class="number">62</span>;</span><br><span class="line"><span class="meta">#[cfg(crossbeam_sanitize)]</span></span><br><span class="line"><span class="keyword">const</span> MAX_OBJECTS: <span class="type">usize</span> = <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// A bag of deferred functions.</span></span><br><span class="line"><span class="title function_ invoke__">pub</span>(<span class="keyword">crate</span>) <span class="keyword">struct</span> <span class="title class_">Bag</span> &#123;</span><br><span class="line">    <span class="comment">/// Stashed objects.</span></span><br><span class="line">    deferreds: [Deferred; MAX_OBJECTS],</span><br><span class="line">    len: <span class="type">usize</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Bag</span> &#123;</span><br><span class="line">    <span class="comment">/// Returns a new, empty bag.</span></span><br><span class="line">    <span class="title function_ invoke__">pub</span>(<span class="keyword">crate</span>) <span class="keyword">fn</span> <span class="title function_">new</span>() <span class="punctuation">-&gt;</span> <span class="keyword">Self</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Returns `true` if the bag is empty.</span></span><br><span class="line">    <span class="title function_ invoke__">pub</span>(<span class="keyword">crate</span>) <span class="keyword">fn</span> <span class="title function_">is_empty</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="type">bool</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Attempts to insert a deferred function into the bag.</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// Returns `Ok(())` if successful, and `Err(deferred)` for the given `deferred` if the bag is</span></span><br><span class="line">    <span class="comment">/// full.</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// # Safety</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// It should be safe for another thread to execute the given function.</span></span><br><span class="line">    <span class="title function_ invoke__">pub</span>(<span class="keyword">crate</span>) <span class="keyword">unsafe</span> <span class="keyword">fn</span> <span class="title function_">try_push</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, deferred: Deferred) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;(), Deferred&gt;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Seals the bag with the given epoch.</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">seal</span>(<span class="keyword">self</span>, epoch: Epoch) <span class="punctuation">-&gt;</span> SealedBag;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// A pair of an epoch and a bag.</span></span><br><span class="line"><span class="meta">#[derive(Default, Debug)]</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">SealedBag</span> &#123;</span><br><span class="line">    epoch: Epoch,</span><br><span class="line">    _bag: Bag,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// It is safe to share `SealedBag` because `is_expired` only inspects the epoch.</span></span><br><span class="line"><span class="keyword">unsafe</span> <span class="keyword">impl</span> <span class="title class_">Sync</span> <span class="keyword">for</span> <span class="title class_">SealedBag</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">SealedBag</span> &#123;</span><br><span class="line">    <span class="comment">/// Checks if it is safe to drop the bag w.r.t. the given global epoch.</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">is_expired</span>(&amp;<span class="keyword">self</span>, global_epoch: Epoch) <span class="punctuation">-&gt;</span> <span class="type">bool</span> &#123;</span><br><span class="line">        <span class="comment">// A pinned participant can witness at most one epoch advancement. Therefore, any bag that</span></span><br><span class="line">        <span class="comment">// is within one epoch of the current one cannot be destroyed yet.</span></span><br><span class="line">        global_epoch.<span class="title function_ invoke__">wrapping_sub</span>(<span class="keyword">self</span>.epoch) &gt;= <span class="number">2</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å¤–éƒ¨æ¥å£"><a href="#å¤–éƒ¨æ¥å£" class="headerlink" title="å¤–éƒ¨æ¥å£"></a>å¤–éƒ¨æ¥å£</h3><p>å¤–éƒ¨å¾ˆå¤šæ¥å£æ˜¯ç°åœ¨ <code>default.rs</code> é‡Œé¢ã€‚å¾ˆå¤šè¯»è€…å¯èƒ½ä¼šå¾ˆå›°æƒ‘ï¼Œåˆšåˆšä¸æ˜¯è¿˜åœ¨è®²å·¥å…·ç±»å—ï¼Œç°åœ¨æ€ä¹ˆå¤–éƒ¨æ¥å£äº†ï¼Œç­”æ¡ˆæ˜¯å‰©ä¸‹å†…å®¹éƒ½æ˜¯ç´§å¯†ç¼åˆçš„ï¼Œé€‚åˆè‡ªé¡¶å‘ä¸‹è®²äº†ã€‚å·¥å…·å…ˆçœ‹å®Œï¼Œç„¶åè‡ªé¡¶å‘ä¸‹æ¨è¿›ï¼Œè¿˜æŒºå¥½çš„ã€‚</p><p><a href="https://github.com/crossbeam-rs/crossbeam/blob/master/crossbeam-epoch/src/default.rs">https://github.com/crossbeam-rs/crossbeam/blob/master/crossbeam-epoch/src/default.rs</a></p><p>è¿™é‡Œæœ‰ï¼š</p><ol><li>å…¨å±€ lazy_static çš„ <code>Collector</code></li><li>å•ä¸ªçº¿ç¨‹ä¸€ä¸ªçš„ <code>LocalHandle</code>, ç”± <code>COLLECTOR.register()</code> ç”Ÿæˆ</li></ol><p>ç„¶åå¤–éƒ¨çš„ <code>pin</code> æ¥å£ä¼šæ‹¿åˆ° tls çš„ <code>LocalHandle</code>, ç”¨å®ƒæ¥ <code>pin</code>.</p><p>è€Œ <code>Collector</code> å’Œ <code>LocalHandle</code> åˆ™æ˜¯ å†…éƒ¨çš„ <code>Global</code> å’Œ <code>Local</code> çš„åŒ…è£…å™¨ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// An epoch-based garbage collector.</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">Collector</span> &#123;</span><br><span class="line">    <span class="title function_ invoke__">pub</span>(<span class="keyword">crate</span>) global: Arc&lt;Global&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Collector</span> &#123;</span><br><span class="line">    <span class="comment">/// Creates a new collector.</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">new</span>() <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">        <span class="keyword">Self</span>::<span class="title function_ invoke__">default</span>()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Registers a new handle for the collector.</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">register</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> LocalHandle &#123;</span><br><span class="line">        Local::<span class="title function_ invoke__">register</span>(<span class="keyword">self</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/// A handle to a garbage collector.</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">LocalHandle</span> &#123;</span><br><span class="line">    <span class="title function_ invoke__">pub</span>(<span class="keyword">crate</span>) local: *<span class="keyword">const</span> Local,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">LocalHandle</span> &#123;</span><br><span class="line">    <span class="comment">/// Pins the handle.</span></span><br><span class="line">    <span class="meta">#[inline]</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">pin</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> Guard &#123;</span><br><span class="line">        <span class="keyword">unsafe</span> &#123; (*<span class="keyword">self</span>.local).<span class="title function_ invoke__">pin</span>() &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Returns `true` if the handle is pinned.</span></span><br><span class="line">    <span class="meta">#[inline]</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">is_pinned</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="type">bool</span> &#123;</span><br><span class="line">        <span class="keyword">unsafe</span> &#123; (*<span class="keyword">self</span>.local).<span class="title function_ invoke__">is_pinned</span>() &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Returns the `Collector` associated with this handle.</span></span><br><span class="line">    <span class="meta">#[inline]</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">collector</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> &amp;Collector &#123;</span><br><span class="line">        <span class="keyword">unsafe</span> &#123; (*<span class="keyword">self</span>.local).<span class="title function_ invoke__">collector</span>() &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Drop</span> <span class="keyword">for</span> <span class="title class_">LocalHandle</span> &#123;</span><br><span class="line">    <span class="meta">#[inline]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">drop</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">unsafe</span> &#123;</span><br><span class="line">            Local::<span class="title function_ invoke__">release_handle</span>(&amp;*<span class="keyword">self</span>.local);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¿©å“¥ä»¬åŸºæœ¬å±äºå¥—å¨ƒåŒ…è£…ï¼Œæ‰€ä»¥æˆ‘ä»¬æœ€åå½“ç„¶å¿…é¡»å†æ¥çœ‹çœ‹ <code>internal.rs</code>ï¼Œè¿™é‡Œé¢ä¸œè¥¿ä¸»è¦æœ‰ Global å’Œ Local:</p><p>Global æ˜¯å…¨å±€çŠ¶æ€æ± å­ï¼Œç”± Collector åŒ…è£…ï¼ˆç­‰ä¸‹ä¼šè®²ï¼‰ï¼Œå†…å®¹å¤§æ¦‚å¦‚ä¸‹ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// The global data for a garbage collector.</span></span><br><span class="line"><span class="title function_ invoke__">pub</span>(<span class="keyword">crate</span>) <span class="keyword">struct</span> <span class="title class_">Global</span> &#123;</span><br><span class="line">    <span class="comment">/// The intrusive linked list of `Local`s.</span></span><br><span class="line">    locals: List&lt;Local&gt;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// The global queue of bags of deferred functions.</span></span><br><span class="line">    queue: Queue&lt;SealedBag&gt;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// The global epoch.</span></span><br><span class="line">    <span class="title function_ invoke__">pub</span>(<span class="keyword">crate</span>) epoch: CachePadded&lt;AtomicEpoch&gt;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Global ä¼šæŒ‚ç€ï¼š</p><ol><li><code>SealedBag</code> çš„é˜Ÿåˆ—ï¼Œä½œä¸ºå»¶è¿Ÿè°ƒç”¨çš„å‡½æ•°</li><li><code>List&lt;Local&gt;</code>ï¼Œä½œä¸ºæ´»è·ƒçš„çº¿ç¨‹çš„ä¾µå…¥å¼é“¾è¡¨</li><li><code>epoch</code>, å…¨å±€çš„ atomic epochï¼Œæœ€åä¸€ä½æ˜¯æ— ç”¨çš„</li></ol><p>Global çš„æ–¹æ³•å¾—å…¨è´´å‡ºæ¥ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">impl</span> <span class="title class_">Global</span> &#123;</span><br><span class="line">    <span class="comment">/// Number of bags to destroy.</span></span><br><span class="line">    <span class="keyword">const</span> COLLECT_STEPS: <span class="type">usize</span> = <span class="number">8</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Creates a new global data for garbage collection.</span></span><br><span class="line">    <span class="meta">#[inline]</span></span><br><span class="line">    <span class="title function_ invoke__">pub</span>(<span class="keyword">crate</span>) <span class="keyword">fn</span> <span class="title function_">new</span>() <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">        <span class="keyword">Self</span> &#123;</span><br><span class="line">            locals: List::<span class="title function_ invoke__">new</span>(),</span><br><span class="line">            queue: Queue::<span class="title function_ invoke__">new</span>(),</span><br><span class="line">            epoch: CachePadded::<span class="title function_ invoke__">new</span>(AtomicEpoch::<span class="title function_ invoke__">new</span>(Epoch::<span class="title function_ invoke__">starting</span>())),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Pushes the bag into the global queue and replaces the bag with a new empty bag.</span></span><br><span class="line">    <span class="title function_ invoke__">pub</span>(<span class="keyword">crate</span>) <span class="keyword">fn</span> <span class="title function_">push_bag</span>(&amp;<span class="keyword">self</span>, bag: &amp;<span class="keyword">mut</span> Bag, guard: &amp;Guard) &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">bag</span> = mem::<span class="title function_ invoke__">replace</span>(bag, Bag::<span class="title function_ invoke__">new</span>());</span><br><span class="line"></span><br><span class="line">        atomic::<span class="title function_ invoke__">fence</span>(Ordering::SeqCst);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">epoch</span> = <span class="keyword">self</span>.epoch.<span class="title function_ invoke__">load</span>(Ordering::Relaxed);</span><br><span class="line">        <span class="keyword">self</span>.queue.<span class="title function_ invoke__">push</span>(bag.<span class="title function_ invoke__">seal</span>(epoch), guard);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Collects several bags from the global queue and executes deferred functions in them.</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// Note: This may itself produce garbage and in turn allocate new bags.</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// `pin()` rarely calls `collect()`, so we want the compiler to place that call on a cold</span></span><br><span class="line">    <span class="comment">/// path. In other words, we want the compiler to optimize branching for the case when</span></span><br><span class="line">    <span class="comment">/// `collect()` is not called.</span></span><br><span class="line">    <span class="meta">#[cold]</span></span><br><span class="line">    <span class="title function_ invoke__">pub</span>(<span class="keyword">crate</span>) <span class="keyword">fn</span> <span class="title function_">collect</span>(&amp;<span class="keyword">self</span>, guard: &amp;Guard) &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">global_epoch</span> = <span class="keyword">self</span>.<span class="title function_ invoke__">try_advance</span>(guard);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">steps</span> = <span class="keyword">if</span> <span class="built_in">cfg!</span>(crossbeam_sanitize) &#123;</span><br><span class="line">            usize::<span class="title function_ invoke__">max_value</span>()</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">Self</span>::COLLECT_STEPS</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> <span class="variable">_</span> <span class="keyword">in</span> <span class="number">0</span>..steps &#123;</span><br><span class="line">            <span class="keyword">match</span> <span class="keyword">self</span>.queue.<span class="title function_ invoke__">try_pop_if</span>(</span><br><span class="line">                &amp;|sealed_bag: &amp;SealedBag| sealed_bag.<span class="title function_ invoke__">is_expired</span>(global_epoch),</span><br><span class="line">                guard,</span><br><span class="line">            ) &#123;</span><br><span class="line">                <span class="literal">None</span> =&gt; <span class="keyword">break</span>,</span><br><span class="line">                <span class="title function_ invoke__">Some</span>(sealed_bag) =&gt; <span class="title function_ invoke__">drop</span>(sealed_bag),</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Attempts to advance the global epoch.</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// The global epoch can advance only if all currently pinned participants have been pinned in</span></span><br><span class="line">    <span class="comment">/// the current epoch.</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// Returns the current global epoch.</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// `try_advance()` is annotated `#[cold]` because it is rarely called.</span></span><br><span class="line">    <span class="meta">#[cold]</span></span><br><span class="line">    <span class="title function_ invoke__">pub</span>(<span class="keyword">crate</span>) <span class="keyword">fn</span> <span class="title function_">try_advance</span>(&amp;<span class="keyword">self</span>, guard: &amp;Guard) <span class="punctuation">-&gt;</span> Epoch &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">global_epoch</span> = <span class="keyword">self</span>.epoch.<span class="title function_ invoke__">load</span>(Ordering::Relaxed);</span><br><span class="line">        atomic::<span class="title function_ invoke__">fence</span>(Ordering::SeqCst);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// TODO(stjepang): `Local`s are stored in a linked list because linked lists are fairly</span></span><br><span class="line">        <span class="comment">// easy to implement in a lock-free manner. However, traversal can be slow due to cache</span></span><br><span class="line">        <span class="comment">// misses and data dependencies. We should experiment with other data structures as well.</span></span><br><span class="line">        <span class="keyword">for</span> <span class="variable">local</span> <span class="keyword">in</span> <span class="keyword">self</span>.locals.<span class="title function_ invoke__">iter</span>(guard) &#123;</span><br><span class="line">            <span class="keyword">match</span> local &#123;</span><br><span class="line">                <span class="title function_ invoke__">Err</span>(IterError::Stalled) =&gt; &#123;</span><br><span class="line">                    <span class="comment">// A concurrent thread stalled this iteration. That thread might also try to</span></span><br><span class="line">                    <span class="comment">// advance the epoch, in which case we leave the job to it. Otherwise, the</span></span><br><span class="line">                    <span class="comment">// epoch will not be advanced.</span></span><br><span class="line">                    <span class="keyword">return</span> global_epoch;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="title function_ invoke__">Ok</span>(local) =&gt; &#123;</span><br><span class="line">                    <span class="keyword">let</span> <span class="variable">local_epoch</span> = local.epoch.<span class="title function_ invoke__">load</span>(Ordering::Relaxed);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// If the participant was pinned in a different epoch, we cannot advance the</span></span><br><span class="line">                    <span class="comment">// global epoch just yet.</span></span><br><span class="line">                    <span class="keyword">if</span> local_epoch.<span class="title function_ invoke__">is_pinned</span>() &amp;&amp; local_epoch.<span class="title function_ invoke__">unpinned</span>() != global_epoch &#123;</span><br><span class="line">                        <span class="keyword">return</span> global_epoch;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        atomic::<span class="title function_ invoke__">fence</span>(Ordering::Acquire);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// All pinned participants were pinned in the current global epoch.</span></span><br><span class="line">        <span class="comment">// Now let&#x27;s advance the global epoch...</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">// Note that if another thread already advanced it before us, this store will simply</span></span><br><span class="line">        <span class="comment">// overwrite the global epoch with the same value. This is true because `try_advance` was</span></span><br><span class="line">        <span class="comment">// called from a thread that was pinned in `global_epoch`, and the global epoch cannot be</span></span><br><span class="line">        <span class="comment">// advanced two steps ahead of it.</span></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">new_epoch</span> = global_epoch.<span class="title function_ invoke__">successor</span>();</span><br><span class="line">        <span class="keyword">self</span>.epoch.<span class="title function_ invoke__">store</span>(new_epoch, Ordering::Release);</span><br><span class="line">        new_epoch</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œï¼Œå…¶ä»–å‡½æ•°å«ä¹‰éƒ½éå¸¸æ¸…æ™°ï¼Œéš¾ä¸€ç‚¹çš„æ˜¯ <code>try_advance</code> ï¼Œå¦‚æœå®ƒå‘ç°ç°åœ¨æ‰€æœ‰æ´»è·ƒçº¿ç¨‹éƒ½æ˜¯ <code>pinned</code> çš„ï¼Œä¸”ç­‰äºè‡ªèº«å‘¨æœŸï¼Œé‚£ä¹ˆå®ƒä¼šæ¨è¿›ã€‚è¿™ä¸ªåœ°æ–¹æœ‰ç‚¹éš¾æ‡‚ï¼Œæˆ‘ä»¬å¯ä»¥å›é¡¾ä¸€ä¸‹ï¼Œå¯ä»¥æ¨è¿›æ˜¯å› ä¸ºåªæœ‰è¿™ä¸ªç‰ˆæœ¬çš„ reader äº†ï¼Œå†ä¹‹å‰çš„æ•°æ®å¯¹è±¡å¯ä»¥ gc æ‰ï¼Œè¿™é‡Œå’Œ <code>pin</code> çš„æµç¨‹æ˜¯æœ‰å…³çš„ã€‚æ€»ä¹‹ï¼Œæ¯ä¸ª <code>Local</code> éƒ½æ˜¯æœ¬å‘¨æœŸä¸” pin äº†ï¼Œå°±å¯ä»¥æ¨è¿› + å›æ”¶äº†ã€‚å›æ”¶æµç¨‹è§ <code>collect</code></p><p>è‡³äº Localï¼Œå…¶å®æŒºâ€¦å¬ä¸ RAII çš„ï¼Œå®ƒä¼šåœ¨ <code>register</code> çš„æ—¶å€™ åˆ›å»ºï¼Œ<code>pin</code> çš„æ—¶å€™åˆå§‹åŒ–ï¼Œ<code>release_handle</code> çš„æ—¶å€™é”€æ¯ã€‚å®ƒæœ¬èº«ä¼šè¢« TLS çš„ä½¿ç”¨ï¼Œå’Œçº¿ç¨‹ç»‘å®šï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// Participant for garbage collection.</span></span><br><span class="line"><span class="title function_ invoke__">pub</span>(<span class="keyword">crate</span>) <span class="keyword">struct</span> <span class="title class_">Local</span> &#123;</span><br><span class="line">    <span class="comment">/// A node in the intrusive linked list of `Local`s.</span></span><br><span class="line">    entry: Entry,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// The local epoch.</span></span><br><span class="line">    epoch: AtomicEpoch,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// A reference to the global data.</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// When all guards and handles get dropped, this reference is destroyed.</span></span><br><span class="line">    collector: UnsafeCell&lt;ManuallyDrop&lt;Collector&gt;&gt;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// The local bag of deferred functions.</span></span><br><span class="line">    <span class="title function_ invoke__">pub</span>(<span class="keyword">crate</span>) bag: UnsafeCell&lt;Bag&gt;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// The number of guards keeping this participant pinned.</span></span><br><span class="line">    guard_count: Cell&lt;<span class="type">usize</span>&gt;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// The number of active handles.</span></span><br><span class="line">    handle_count: Cell&lt;<span class="type">usize</span>&gt;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Total number of pinnings performed.</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// This is just an auxiliary counter that sometimes kicks off collection.</span></span><br><span class="line">    pin_count: Cell&lt;Wrapping&lt;<span class="type">usize</span>&gt;&gt;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½ ä¼šå‘ç°å®ƒä¹Ÿæœ‰ä¸ª <code>epoch</code>, æ²¡é”™ï¼Œè¿™ç©æ„åªæœ‰ <code>pin</code> çš„æ—¶å€™ä¼šåˆå§‹åŒ–ã€‚æˆ‘çœ‹è¿˜æœ‰ <code>repin</code> ä»€ä¹ˆçš„ï¼Œä¼°è®¡æ˜¯ä¸ºäº†ä¼˜åŒ–å‡†å¤‡çš„å§ã€‚</p><p>æœ€åæœ‰ä¸ª <code>Guard</code>ï¼Œæœ¬èº«å°±æ˜¯å¾ˆç®€å•çš„ç»‘å®š <code>Local</code> çš„ç»„ä»¶äº†ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ<code>Local</code> å’Œ <code>Guard</code> å¤§éƒ¨åˆ†æ¥å£éƒ½æ˜¯ä¸²è¡Œçš„ï¼Œåªæœ‰è¯» epoch çš„æ—¶å€™ï¼Œä¼šå¹¶è¡Œï¼Œå®ƒä¹Ÿåªé  epoch å’Œ <code>collector</code> ä¸ Global äº’ç›¸é€šä¿¡</p><h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul><li><a href="https://aturon.github.io/blog/2015/08/27/epoch/">https://aturon.github.io/blog/2015/08/27/epoch/</a></li></ul>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Scheduling Blog Overview</title>
      <link href="/2022/05/29/Scheduling-Blog-Overview/"/>
      <url>/2022/05/29/Scheduling-Blog-Overview/</url>
      
        <content type="html"><![CDATA[<p>ä»Šå¤©æœ¬æ¥æ‰“ç®—çœ‹ <em>Morsel-Driven Parallelism: A NUMA-Aware Query Evaluation Framework for the Many-Core Age</em> è¿™ç©æ„ï¼Œçœ‹äº†ä¸€ç‚¹ä¹‹åæ„Ÿè§‰è‡ªå·±ç†æ€§ä¸ŠçŸ¥é“è¿™ç¯‡æ–‡ç« æ˜¯æŠŠ Task åˆ‡ç¢äº†ï¼Œç„¶åè°ƒåº¦çš„æ—¶å€™æ ¹æ®æ•°æ®äº²å’Œæ€§æ¥åšå¤„ç†ï¼Œç„¶ååšäº†ååŒè°ƒåº¦ã€‚ä½†æ˜¯çœ‹åˆ°è¿™äº›è¯æ±‡çš„æ—¶å€™ï¼Œå¥½åƒä¸€ç‚¹éƒ½æƒ³ä¸èµ·æ¥å’‹åšçš„ï¼Œæ„Ÿè§‰æˆ‘å¯¹è°ƒåº¦ç³»ç»Ÿç†è§£æ˜¯ä¸€ç‰‡ç©ºç™½ã€‚çŸ¥é“å®ƒåœ¨è®²å•¥ä¹Ÿä¸èƒ½æ¸…æ™°çš„ç†è§£å†…å®¹ã€‚</p><p>åˆšçœ‹äº†çœ‹é™ˆæµ·æ³¢çš„ os ä¹¦ç¬¬å…­ç« ï¼Œçªç„¶ç†è§£äº†å¾ˆå¤šåè¯ï¼Œä¸è¿‡æ„Ÿè§‰è®° notes ä¹Ÿä¸å¦‚åŸä¹¦è¿™ä¸€ç« å¥½ï¼Œæ‰€ä»¥å¹²è„†åšä¸€ä¸ªç´¢å¼•ã€‚æ¥æè¿°æˆ‘å¯¹è°ƒåº¦ç³»ç»Ÿåè¯ç†è§£ã€‚</p><p>è¿™ç¯‡æ–‡ç« æ˜¯çå‡ æŠŠå†™çš„ï¼Œå¾ˆå¤šä¸œè¥¿æˆ‘ä¹Ÿå°±å…ˆå å‘ï¼Œæ‰€ä»¥æ²¡å•¥å¿…è¦çœ‹ï¼Œä¸»è¦æ˜¯ä»¥åç†æ¸…æ¥šäº†å¯ä»¥åœ¨è¿™é‡Œå›è¿‡å¤´æ¥å†™å†™ã€ŒåŸæ¥æ˜¯è¿™æ ·ã€</p><h2 id="åŸºæœ¬æ¦‚å¿µ-OS"><a href="#åŸºæœ¬æ¦‚å¿µ-OS" class="headerlink" title="åŸºæœ¬æ¦‚å¿µ: OS"></a>åŸºæœ¬æ¦‚å¿µ: OS</h2><p>è¿™é‡Œæœ€å¥½å‚è€ƒé™ˆæµ·æ³¢çš„ <em>&lt;ç°ä»£æ“ä½œç³»ç»Ÿï¼šåŸç†ä¸å®ç°&gt;</em> æ¥ç†è§£ã€‚</p><p>è¿™é‡Œæœ‰ä¸€ä¸ªä»»åŠ¡ï¼ˆTaskï¼‰çš„æ¦‚å¿µï¼ŒLinux é‡Œé¢çº¿ç¨‹/è¿›ç¨‹éƒ½æ˜¯ <code>task_struct</code> é‡Œé¢éƒ½æ˜¯ Taskã€‚è¿™é‡Œè¿˜ä¼šæ¶‰åŠåˆ«çš„ä¸œè¥¿ï¼ŒåŒ…æ‹¬ï¼š</p><ol><li>ä¼˜å…ˆçº§ï¼ˆPriorityï¼‰</li><li>æ—¶é—´ç‰‡ï¼ˆTimesliceï¼‰</li><li>Deadline</li><li>â€¦</li></ol><p>å…³äºè°ƒåº¦ç›®æ ‡ï¼Œ</p><p>æ€§èƒ½ç›¸å…³æŒ‡æ ‡æœ‰ï¼šååé‡ï¼ˆå•ä½æ—¶é—´å†…å¤„ç†çš„ä»»åŠ¡æ•°é‡ï¼‰ã€å‘¨è½¬æ—¶é—´ï¼ˆä»»åŠ¡å‘èµ·åˆ°ç»“æŸçš„æ—¶é—´ï¼‰ã€å“åº”æ—¶é—´</p><p>éæ€§èƒ½ç›¸å…³ï¼šå…¬å¹³æ€§ã€èµ„æºåˆ©ç”¨ç‡</p><p>ä»»åŠ¡å¯èƒ½æœ‰ä¸åŒç±»å‹ï¼Œæ¯”å¦‚<strong>æ‰¹å¤„ç†</strong>ç±»å‹æ›´å¸Œæœ›æœ‰æ›´å¤§çš„ååé‡ã€æ›´å°çš„å‘¨è½¬æ—¶é—´ï¼›<strong>äº¤äº’å¼ä»»åŠ¡</strong>ä¼šå¸Œæœ›æœ‰æ›´å°çš„å“åº”æ—¶é—´ï¼›å®æ—¶ä»»åŠ¡ä¼šå¸Œæœ›æœ‰æ›´å¥½çš„å®æ—¶æ€§ï¼›ç§»åŠ¨è®¾å¤‡å¯èƒ½å¸Œæœ›å¼€é”€å°ä¸€ç‚¹ï¼Œå®ƒè¿˜å¤§å°æ ¸ä»€ä¹ˆçš„ã€‚</p><p>åŒæ—¶ï¼Œä»»åŠ¡æ•°é‡ä¼šå¾ˆå¤šï¼Œè€Œä¸”ç°ä»£ç³»ç»Ÿæœ¬èº«ä¹Ÿå‘å¤šæ ¸å‘å±•ï¼ˆè¯¦è§ï¼š<a href="https://blog.mwish.me/2022/05/04/perfbook-notes-hardware/">https://blog.mwish.me/2022/05/04/perfbook-notes-hardware/</a> å’Œ <a href="https://blog.mwish.me/2022/05/02/Arch-Blog-Overviews/">https://blog.mwish.me/2022/05/02/Arch-Blog-Overviews/</a> ï¼‰ã€‚æ‰€ä»¥ä¹Ÿä¼šå¸Œæœ›èƒ½ç”¨ä¸Šæ‰€æœ‰çš„ CPUã€è°ƒåº¦å¼€é”€å°ã€‚</p><p>ç„¶åä¸åŒä»»åŠ¡æŒ‡æ ‡æ˜¯ä¸ä¸€æ ·çš„ï¼ˆå½“æ—¶çœ‹è¿™é‡Œä¸å¤ªç†è§£ï¼Œä½†æ˜¯çœ‹ AP/TP/HSAP ç­‰å·¥ä¸šç•Œéœ€æ±‚ï¼Œå°±ä¼šæ˜ç™½å¾ˆå¤šäº†ï¼‰ï¼Œè¿™é‡Œä¹Ÿæœ‰å„ç§ trade-offï¼š</p><ol><li>è°ƒåº¦å¼€é”€ vs è°ƒåº¦æ•ˆæœ</li><li>ä¼˜å…ˆçº§ vs å…¬å¹³æ€§</li><li>æ€§èƒ½ vs èƒ½è€—</li></ol><p>å…³äºä¸Šé¢çš„ï¼Œè¿˜æœ‰ä¸€äº› os çš„åšå®¢æŒ‡å‡ºå®ƒä»¬çš„ trade-off ï¼Œæ¯”å¦‚ SOCCâ€™14 çš„ Tales of the Tail: Hardware, OS, and Application-level Sources of Tail Latency</p><h3 id="è°ƒåº¦æœºåˆ¶"><a href="#è°ƒåº¦æœºåˆ¶" class="headerlink" title="è°ƒåº¦æœºåˆ¶"></a>è°ƒåº¦æœºåˆ¶</h3><p>é•¿æœŸã€çŸ­æœŸã€ä¸­æœŸè°ƒåº¦ï¼Œé•¿æœŸæ§åˆ¶æ˜¯å¦ spawn taskï¼ŒçŸ­æœŸå¤„ç†ä»»åŠ¡çŠ¶æ€ï¼Œä¸­æœŸæ ¹æ® IO ç­‰çŠ¶å†µè°ƒæ•´</p><p><img src="https://image.mwish.me/blog-image/DE0BC35E-653F-4B34-98CB-B2A5E35462CA.png" alt="DE0BC35E-653F-4B34-98CB-B2A5E35462CA"></p><p><img src="https://image.mwish.me/blog-image/E2C862EC-D7E8-4B59-91D0-D4A2E6444DD0.png" alt="E2C862EC-D7E8-4B59-91D0-D4A2E6444DD0"></p><h3 id="å•æ ¸è°ƒåº¦"><a href="#å•æ ¸è°ƒåº¦" class="headerlink" title="å•æ ¸è°ƒåº¦"></a>å•æ ¸è°ƒåº¦</h3><p>FCFS/SJF/MLFQ/RR ï¼ŒæŠ¢å /éæŠ¢å ï¼Œæ˜¯å¦æœ‰ä¼˜å…ˆçº§ï¼ˆå¤šçº§åé¦ˆé˜Ÿåˆ—ï¼‰ï¼Œæ˜¯å¦æœ‰ä»½é¢ï¼ˆæ¯”å¦‚å„ä¸ªç”¨æˆ·ä»˜äº†ä¸åŒçš„é’±ï¼Œé‚£ä¹ˆè°ƒåº¦ä¼šæ ¹æ® stride æˆ–è€…å½©ç¥¨æ¥è°ƒåº¦ï¼‰</p><p>ä¸Šé¢å…¶å®ä¸æ˜¯è°æ¯”è°æ›´ä¼˜ï¼Œè€Œè¦è€ƒè™‘å„ç§ åŠŸèƒ½éœ€æ±‚ / trade-off</p><h3 id="å®æ—¶è°ƒåº¦"><a href="#å®æ—¶è°ƒåº¦" class="headerlink" title="å®æ—¶è°ƒåº¦"></a>å®æ—¶è°ƒåº¦</h3><p>TBD</p><h3 id="å¤šæ ¸è°ƒåº¦"><a href="#å¤šæ ¸è°ƒåº¦" class="headerlink" title="å¤šæ ¸è°ƒåº¦"></a>å¤šæ ¸è°ƒåº¦</h3><p><img src="https://image.mwish.me/blog-image/89918942-3B8F-493A-AF3E-9AE58BB381F6.png" alt="89918942-3B8F-493A-AF3E-9AE58BB381F6"></p><p>é¦–å…ˆè€ƒè™‘ååŒè°ƒåº¦/ç¾¤ç»„è°ƒåº¦ï¼Œä¸Šå±‚çŸ¥é“ä»»åŠ¡çš„åˆ†ç»„/ååŒæƒ…å†µï¼Œå°±æ›´èƒ½åˆ©ç”¨å¤šæ ¸çš„æ€§èƒ½ã€‚ä¾‹å¦‚ BSP æ¨¡å‹ï¼ˆå¸¸ç”¨äºç±»ä¼¼ MR/å›¾è®¡ç®—ï¼‰ã€‚</p><p>è¿™é‡Œè¿˜è¦è€ƒè™‘ä¸¤çº§è°ƒåº¦ï¼Œè¿™æ ·èƒ½ä¿è¯è°ƒåº¦çš„å¼€é”€æ˜¯å°çš„ï¼ˆè€ƒè™‘ NUMA ç­‰æƒ…å†µï¼‰ï¼š</p><p><img src="https://image.mwish.me/blog-image/60BBDBE5-2C89-4B54-B9B0-E2EA96080CD8.png" alt="60BBDBE5-2C89-4B54-B9B0-E2EA96080CD8"></p><p>è°ƒåº¦è¦è€ƒè™‘è°ƒåº¦çš„å¼€é”€ï¼ŒLinux æœ‰ä¸€ä¸ª Per-Entity Load Tracing æœºåˆ¶æ¥è€ƒè™‘ã€‚</p><p>ç„¶åè°ƒåº¦åˆ°ä¸åŒ core å¼€é”€ä¹Ÿä¸åŒï¼Œæ‰€ä»¥æœ‰ï¼š</p><p><img src="https://image.mwish.me/blog-image/AE849A38-8937-40C4-B68A-A24A3EDD15F9.png" alt="AE849A38-8937-40C4-B68A-A24A3EDD15F9"></p><h3 id="Linux-è°ƒåº¦"><a href="#Linux-è°ƒåº¦" class="headerlink" title="Linux è°ƒåº¦"></a>Linux è°ƒåº¦</h3><p>CFS ç­‰ï¼š</p><p><img src="https://image.mwish.me/blog-image/5F54B43F-6BA8-4576-9FE1-776FB791ADB1.png" alt="5F54B43F-6BA8-4576-9FE1-776FB791ADB1"></p><h3 id="å…¶ä»–"><a href="#å…¶ä»–" class="headerlink" title="å…¶ä»–"></a>å…¶ä»–</h3><ul><li>Tokio è°ƒåº¦ï¼Œåœ¨ coroutine ä¸Šå¼•å…¥äº†ä¸€äº› ts ç­‰ï¼š<a href="https://tokio.rs/blog/2019-10-scheduler">https://tokio.rs/blog/2019-10-scheduler</a> å’Œ <a href="https://tokio.rs/blog/2020-04-preemption">https://tokio.rs/blog/2020-04-preemption</a></li></ul><h2 id="åˆ†å¸ƒå¼è°ƒåº¦ç³»ç»Ÿ"><a href="#åˆ†å¸ƒå¼è°ƒåº¦ç³»ç»Ÿ" class="headerlink" title="åˆ†å¸ƒå¼è°ƒåº¦ç³»ç»Ÿ"></a>åˆ†å¸ƒå¼è°ƒåº¦ç³»ç»Ÿ</h2><p>ã€Šå¤§æ•°æ®æ—¥çŸ¥å½•ã€‹ç¬¬å››ç« ã€‚</p><p>é™æ€åˆ’åˆ†æ˜¯å¾ˆå¥½çš„æ–¹æ³•ï¼Œä½†æ˜¯èµ„æºåˆ©ç”¨ç‡ä¸é«˜ï¼Œæ›´æœŸæœ›æŠŠèµ„æºå½“ä½œæ•´ä½“ç®¡ç†ï¼š</p><p><img src="https://image.mwish.me/blog-image/F762A867-E008-4306-B743-BC2F4392614A.png" alt="F762A867-E008-4306-B743-BC2F4392614A"></p><p>è¿™é‡Œè¦è€ƒè™‘ï¼šworkload çš„èµ„æºçš„æ€§è´¨ï¼ˆCPU/Disk/GPUï¼Œæœ‰æ— çŠ¶æ€ï¼‰ï¼›æ•°æ®å±€éƒ¨æ€§ï¼ˆNode -&gt; Rack -&gt; Clusterï¼‰ï¼›è°ƒåº¦çš„æ˜¯å¦æŠ¢å ï¼ˆèƒ½å¦æš‚åœ/å¹²æ­»æ­£åœ¨è·‘çš„ä»»åŠ¡ï¼Œè¿˜æ˜¯åªèƒ½ä» spare ä¸­åˆ†é…èµ„æºï¼‰</p><p>ä¹Ÿè¦è€ƒè™‘å•æœºå„ç§èµ„æºéš”ç¦»çš„æ–¹æ³•ï¼Œæ˜¯å¦é¥¿æ­»ä»»åŠ¡ç­‰ã€‚</p><p>è°ƒåº¦å™¨ä¹Ÿæœ‰ä¸åŒçš„ç±»å‹ï¼š</p><p><img src="https://image.mwish.me/blog-image/B606A247-F83F-4F87-BDFD-D76908EA3036.png" alt="B606A247-F83F-4F87-BDFD-D76908EA3036"></p><p>è¿˜æœ‰ä¸åŒçš„è°ƒåº¦ç®—æ³•ï¼š</p><p><img src="https://image.mwish.me/blog-image/31432F80-4DEE-4105-B7CC-3A736E84463D.png" alt="31432F80-4DEE-4105-B7CC-3A736E84463D"></p><h2 id="DB-çš„è°ƒåº¦ç³»ç»Ÿ"><a href="#DB-çš„è°ƒåº¦ç³»ç»Ÿ" class="headerlink" title="DB çš„è°ƒåº¦ç³»ç»Ÿ"></a>DB çš„è°ƒåº¦ç³»ç»Ÿ</h2><p>ç›¸å¯¹æˆ‘ä»¬ä¹‹å‰æçš„ OS è°ƒåº¦æ¥è¯´ï¼ŒDB è°ƒåº¦ç³»ç»Ÿå¯èƒ½å¯ä»¥ï¼š</p><ol><li>æ ¹æ® Plan å’Œ Catalog é¢„ä¼°å„ç§å¼€é”€</li><li>æ›´å¥½çš„å¹¶è¡Œï¼ŒååŒè°ƒåº¦ï¼Œæ¯”å¦‚ Exchange ç®—å­</li><li>å•æœºè¿˜å¥½ï¼Œåˆ†å¸ƒå¼çš„è¯ï¼Œå¼€é”€ä¼šå¼•å…¥ç½‘ç»œå¼€é”€ï¼Œè¿˜ç®—æœªçŸ¥</li></ol><p>ææ–™æœ‰ï¼š</p><ol><li><a href="https://15721.courses.cs.cmu.edu/spring2020/papers/12-scheduling/p743-leis.pdf">Morsel-Driven Parallelism: A NUMA-Aware Query Evaluation Framework for the Many-Core Age</a></li><li><a href="https://15721.courses.cs.cmu.edu/spring2020/papers/12-scheduling/p1442-psaroudakis.pdf">Scaling Up Concurrent Main-Memory Column-Store Scans: Towards Adaptive NUMA-aware Data and Task Placement</a></li><li>SQL æŸ¥è¯¢çš„åˆ†å¸ƒå¼æ‰§è¡Œä¸è°ƒåº¦ <a href="https://zhuanlan.zhihu.com/p/100949808">https://zhuanlan.zhihu.com/p/100949808</a></li><li>PolarDB å¹¶è¡Œè®¡ç®—æ¡†æ¶ <a href="https://zhuanlan.zhihu.com/p/346320114">https://zhuanlan.zhihu.com/p/346320114</a></li></ol><p>Spark, Presto, StarRocks ç­‰</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Constant Time Recovery in Azure SQL Database</title>
      <link href="/2022/05/28/Constant-Time-Recovery-in-Azure-SQL-Database/"/>
      <url>/2022/05/28/Constant-Time-Recovery-in-Azure-SQL-Database/</url>
      
        <content type="html"><![CDATA[<p>ä¼ ç»Ÿçš„ ARIES ç®—æ³•ä¸€ç›´æ˜¯ã€Œæ•°æ®åº“çš„æˆäººç¤¼ã€ï¼ŒAzure SQL ä¹‹å‰ç”¨çš„æ˜¯ ARIES ç®—æ³•å®ç°æ¢å¤ã€‚ä½†æ˜¯åœ¨æœ‰é•¿äº‹åŠ¡çš„æ—¶å€™ï¼Œæ¢å¤ä¼šæ¯”è¾ƒæ¶å¿ƒï¼Œç‰¹åˆ«æ˜¯åœ¨ Undo é˜¶æ®µã€‚è¦æ‹¿åˆ°é•¿äº‹åŠ¡ä¿®æ”¹è¿‡çš„æ¯ä¸ªåœ°æ–¹ç»™ä»–å—¯ Undo å›æ¥ï¼Œç›´åˆ°è¿™ä¸ªé•¿äº‹åŠ¡ Log å¼€å¤´ï¼Œç„¶åè¿™äº› Log ä¹Ÿä¸èƒ½ GC æ‰ï¼Œè¿™ä¸ªæ˜¾ç„¶å°±å¾ˆ waste of timeã€‚</p><p>Azure SQL æ›¾ç»é‡åˆ°è¿‡ä¸€ä¸ªå¤§äº‹åŠ¡ï¼Œæ”¹äº†ä¸€å †å…ƒç´ ï¼Œæ¢å¤çš„æ—¶å€™èŠ±äº† 12ä¸ªå°æ—¶ã€‚åæ¥ Azure SQL åœ¨åŸå…ˆ ARIES çš„åŸºç¡€ä¸Šå®ç°äº†å¹¶è¡Œæ¢å¤ï¼Œè®©è¿™ä¸ªæ—¶é—´å˜å¿«ä¸å°‘ã€‚ä¸è¿‡è¿™ä¸ªå¯ä»¥çœ‹å‡ºï¼Œæ··åˆè´Ÿè½½ä¸‹æ¢å¤ç¡®å®æ˜¯æˆé—®é¢˜çš„ã€‚</p><p>æ­¤å¤–ï¼Œå…¬å¸å†…éƒ¨çš„æ•°æ®åº“å¯ä»¥è·‘åœ¨ä¸€äº›æ ¸å¿ƒç¡¬ä»¶ä¸Šï¼Œåˆ©ç”¨å„ç§è§„æ¨¡æ•ˆåº”ï¼Œæ¥é™ä½æˆæœ¬ï¼›æ ¸å¿ƒæœåŠ¡ç”šè‡³è‡ªå·±æœ‰ä¸€å¥—ç¡¬ä»¶è®¾å¤‡ï¼Œä½†æ˜¯ï¼Œä½œä¸ºäº‘ä¸Šçš„ TP æ•°æ®åº“ï¼Œå¯èƒ½éœ€è¦è€ƒè™‘ï¼š</p><ol><li>æ•°æ®è§„æ¨¡å˜å¤§ï¼Œå¯èƒ½ä¼šå¯¼è‡´å•æœºæ•°æ®è§„æ¨¡å˜å¤§ï¼Œæ¢å¤æ—¶é—´å˜é•¿</li><li>äº‘ä¸Šç¡¬ä»¶ä¸ä¸€å®šå¥½ï¼Œå¢åŠ äº†å„ç§å‡ºç°é—®é¢˜çš„æ¦‚ç‡</li><li>å¯èƒ½ä¼šæœ‰å„ç§äº‘ä¸Šè½¯ä»¶å‡çº§ã€è°ƒåº¦ä¹‹ç±»çš„äº‹æƒ…ï¼Œå¯¼è‡´å‡ºé—®é¢˜é¢‘ç‡å˜é«˜</li></ol><p>è®ºæ–‡åœ¨ SQL Server ä¸­è®¾è®¡äº† Constant Time Recovery(CTR) çš„æ¢å¤æœºåˆ¶ï¼Œå°† MVCC å’Œ Undo ç»“åˆï¼Œå®ç°äº†å¸¸æ•°æ—¶é—´æ¢å¤çš„æ¢å¤ç®—æ³•ã€‚ç„¶åè¿›è¡Œäº†ä¸å°‘å·¥ç¨‹ä¼˜åŒ–ï¼ŒåŒ…æ‹¬å°äº‹åŠ¡ä¼˜åŒ–ç­‰ï¼Œå› ä¸ºæ²¡æœ‰å¤§äº‹åŠ¡çš„æƒ…å†µä¸‹æ¢å¤æœ¬èº«å¾ˆå¿«ï¼Œæ‰€ä»¥å®ƒå°½é‡åªè®©å¤§äº‹åŠ¡èµ°è¿™å¥—æœºåˆ¶ã€‚æœ‰äº†è¿™ä¸ªæ¢å¤ç®—æ³•åï¼Œå¸¦é•¿äº‹åŠ¡çš„ç³»ç»Ÿæ¢å¤æ—¶é—´å¤§å¤§å‡å°‘äº†ã€‚</p><h2 id="ä¹‹å‰çš„è®¾è®¡æ¨¡å‹"><a href="#ä¹‹å‰çš„è®¾è®¡æ¨¡å‹" class="headerlink" title="ä¹‹å‰çš„è®¾è®¡æ¨¡å‹"></a>ä¹‹å‰çš„è®¾è®¡æ¨¡å‹</h2><p>SQL Server ä¹‹å‰ä½¿ç”¨çš„æ˜¯ä¿®æ”¹è¿‡çš„ ARIESï¼Œå…·ä½“è€Œè¨€ï¼Œå®ƒçš„æ•°æ®æ¨¡å‹æ˜¯æ•°æ® + Logï¼Œæ•°æ®å’Œ Log æ˜¯åˆ†å¼€å­˜å‚¨çš„ï¼ŒLog éµå¾ª ARIES çš„è¯­ä¹‰ï¼Œå¦‚ä¸‹å›¾ï¼š</p><p><img src="https://image.mwish.me/blog-image/1EE46719-2743-4D24-9B39-819CDC57EEDB.png" alt="1EE46719-2743-4D24-9B39-819CDC57EEDB"></p><p>å®ƒçš„æ•°æ®åœ¨å†…å­˜ä¸­é€»è¾‘ä¸Šæ˜¯ MVCC çš„ï¼Œæ¨¡å‹æ˜¯ N2O + Main/Deltaã€‚è¿™é‡Œå®ƒçš„ Delta æ˜¯ä¸€ä¸ª volatile çš„ç»“æ„ï¼Œå› ä¸º crash ä¹‹åå®ƒè®¤ä¸ºä¸éœ€è¦ä¹‹å‰é‚£äº›æ•°æ®äº†ï¼Œè¯¦è§ Figure3:</p><p><img src="https://image.mwish.me/blog-image/F8277752-FDF1-4D22-8604-77A2D0A235F5.png" alt="F8277752-FDF1-4D22-8604-77A2D0A235F5"></p><p>åœ¨ç³»ç»Ÿä¸­ï¼Œå®ƒä¼šèµ°ä¸€ä¸ª Recover çš„æµç¨‹ï¼Œç±»ä¼¼ ARIESï¼Œä½†æ˜¯æœ‰ä¸€äº›å°å°çš„åŒºåˆ«ï¼Œå¦‚ Figure2:</p><p><img src="https://image.mwish.me/blog-image/76002207-4750-4DDD-9410-0C08E189746A.png" alt="76002207-4750-4DDD-9410-0C08E189746A"></p><p>æˆ‘ä»¬éƒ½å¾ˆç†Ÿæ‚‰ ARIES çš„æµç¨‹ï¼Œæ‰€ä»¥ä¼šçœ‹åˆ° Phase 2a: <code>Redo Lock Acquisition</code> è¿™ç©æ„æ¯”è¾ƒå¥‡æ€ªï¼Œæ€ä¹ˆä¼šæ˜¯å‘¢ï¼Ÿå› ä¸ºåœ¨ SQL Server ä¸­ï¼Œå®ƒåœ¨ Redo å®Œäº†å°±å¯ä»¥ Serve å¤–éƒ¨ç³»ç»Ÿäº†ã€‚é‚£æ²¡ Undo å®Œçš„æ€ä¹ˆåŠå‘¢ï¼ŸRedo çš„æ—¶å€™ä¼šå ä¸Šè¯¥è·å¾—çš„é”ï¼Œè¿™ä¸ªæ—¶å€™è¯·æ±‚çš„äº‹åŠ¡ä¼šè¢«è¿™äº›é” block ä½ï¼Œç›´åˆ° Undo å®Œæˆã€‚è¿™ç›¸å½“äºç”¨ Phase 2a çš„æ¢å¤æ—¶é—´æ¢æ¥äº†æ²¡æœ‰é”çš„å„ä¸ª Tuple çš„æ¢å¤æ—¶é—´ã€‚</p><h2 id="Constant-Time-Recovery"><a href="#Constant-Time-Recovery" class="headerlink" title="Constant Time Recovery"></a>Constant Time Recovery</h2><p>è¿™ä¸ªç®—æ³•ç›®æ ‡å¦‚ä¸‹ï¼š</p><blockquote><ul><li>Database recovery in constant time, regardless of the user workload and transaction sizes.</li><li>Transaction rollback in constant time regardless of the transaction size.</li><li>Continuous transaction log truncation, even in the presence of long running transactions.</li></ul></blockquote><p>å…·ä½“è€Œè¨€ï¼Œè¿™ä¸ªç®—æ³•æŠŠå¯¹æ•°æ®åº“çš„æ“ä½œåˆ†ä¸ºäº†ä¸‹é¢çš„ç±»å‹ï¼š</p><ol><li>Data Modifications</li><li>System Operations</li><li>Logical and Other Non-versioned operations</li></ol><h4 id="Data-Modifications"><a href="#Data-Modifications" class="headerlink" title="Data Modifications"></a>Data Modifications</h4><p>å¯¹äº Data Modificationsï¼Œå°±æ˜¯ Row/Tuple çš„ä¿®æ”¹ï¼Œç”±å¤–éƒ¨äº‹åŠ¡é©±åŠ¨ã€‚è¿™é‡Œæ”¹åŠ¨å¦‚ä¸‹ï¼š</p><ol><li>ç”±ä¸€ä¸ª volatile çš„å†…å®¹å­˜å‚¨ç‰ˆæœ¬ï¼Œæ”¹æˆå’Œ InnoDB é‚£æ ·çš„æŒä¹…åŒ–å­˜å‚¨ã€‚è¿™ä¸ªä¼°è®¡å®ç°å°±ç±»ä¼¼ InnoDB Undo é‚£å¥—</li><li>ç‰ˆæœ¬é“¾å¯ä»¥è£… aborted çš„ç‰ˆæœ¬ï¼Œæ— è®ºåœ¨ main è¿˜æ˜¯ delta ä¸­ã€‚abort çš„ç‰ˆæœ¬å¯ä»¥è¢«å¿½ç•¥</li><li>æ¯ä¸ª Row ä¸Šä¼šæœ‰ä¸€ä¸ª TxnIDï¼Œå¯ä»¥è¯†åˆ«å‡ºå®ƒæ˜¯å¦è¢« abortï¼Œæ¥åˆ¤æ–­æ˜¯å¦å¯è¯»å–</li></ol><p>é‚£ä¹ˆå®é™…ä¸Šï¼Œæ¢å¤çš„æ—¶å€™ï¼Œ<strong>åªéœ€è¦çŸ¥é“å“ªäº›äº‹åŠ¡ abort äº†ï¼Œå¹¶ä¸éœ€è¦æ‰‹åŠ¨ undo è¿™äº›ã€‚è€Œå¤šä½™çš„ç‰ˆæœ¬ç”± GC( Cleanup ) æ¥å›æ”¶</strong>ã€‚</p><h4 id="System-Operations"><a href="#System-Operations" class="headerlink" title="System Operations"></a>System Operations</h4><p>è¿™é‡Œé€šå¸¸æ˜¯ç©ºé—´(Page) çš„ alloc æˆ–è€… deallocï¼ŒSMO æ“ä½œã€‚è¿™äº›æ“ä½œæœ¬èº«ä¸é‚£ä¹ˆå¸¦ç‰ˆæœ¬ã€‚å®ƒä»¬å…¶å®ä¸ä¸€å®šä¼šè¢«äº‹åŠ¡å®Œæˆä¹‹å undoneï¼Œä¸€èˆ¬ä¼šæœ‰ä¸€äº›åå°çº¿ç¨‹æ¥å›æ”¶è¿™äº›æ•°æ®ã€‚</p><h4 id="Logical-and-Other-Non-versioned-Operations"><a href="#Logical-and-Other-Non-versioned-Operations" class="headerlink" title="Logical and Other Non-versioned Operations"></a>Logical and Other Non-versioned Operations</h4><p>è¿™é‡Œæ“ä½œåŒ…æ‹¬ Logical çš„æ“ä½œï¼Œæ¯”å¦‚ Lock acquisitionï¼›æˆ–è€…æ˜¯ä¸€äº›éœ€è¦åœ¨ Recover ä¹‹å‰å°± aware çš„è¡Œä¸ºï¼Œæ¯”å¦‚ä¿®æ”¹ Catalog çš„æ“ä½œã€‚è¿™äº›æ“ä½œæ˜¯éç‰ˆæœ¬åŒ–çš„ï¼Œä½†ä»ç„¶æ˜¯å¯å›æ»šçš„ã€‚CTR ä½¿ç”¨äº†ä¸€ä¸ªç‹¬ç«‹çš„ SLog ç³»ç»Ÿæ¥æ‰¿è½½è¿™äº›æ“ä½œã€‚</p><h3 id="Persistent-Version-Storage"><a href="#Persistent-Version-Storage" class="headerlink" title="Persistent Version Storage"></a>Persistent Version Storage</h3><p>è¿™ä¸ªæˆ‘çœ‹äº†ä¸‹ï¼Œå’Œ MySQL çš„ Undo Space æ²¡å•¥åŒºåˆ«ã€‚è¿™é‡Œé€šè¿‡ <code>&lt;PageID, SlotID&gt;</code> å®šä½å…·ä½“çš„ Rowï¼Œæœ‰ç‚¹ç±»ä¼¼ PG HeapTuple é‚£å¥—ã€‚ç„¶åä¿®æ”¹æ“ä½œåæ­£ä¹Ÿå’Œ MySQL mtr å·®ä¸å¤šã€‚ä¸€äº›ä¼˜åŒ–å¦‚ä¸‹ï¼š</p><blockquote><p>The off-row PVS leverages the table infrastructure to simplify storing and accessing versions but is highly optimized for concurrent inserts. The accessors required to read or write to this table are cached and partitioned per core, while inserts are logged in a non-transactional manner (logged as redo-only operations) to avoid instantiating additional transactions. Threads running in parallel can insert rows into different sets of pages to eliminate contention. Finally, space is pre-allocated to avoid having to perform allocations as part of generating a version.</p></blockquote><p>è¿˜æœ‰ä¸€ä¸ªä¼˜åŒ–ç‚¹æ˜¯ in-row version store:</p><p><img src="https://image.mwish.me/blog-image/9A30DEDC-1EC1-44B3-8500-20D3160224CD.png" alt="9A30DEDC-1EC1-44B3-8500-20D3160224CD"></p><p>è¿™é‡Œæ˜¯ä¸€ä¸ª trade-offï¼Œå°† row ç©ºé—´æ”¾å¤§å’Œä¿®æ”¹åšåˆ°æœ¬åœ°åšæƒè¡¡ï¼Œè¿™ç§æ–¹å¼èƒ½å¾ˆå¥½çš„ä¼˜åŒ– Deleted çš„ç»“æ„ï¼Œåœ¨ main æ ‡è®°åˆ é™¤å³å¯ã€‚</p><p><img src="https://image.mwish.me/blog-image/665C7137-EB70-4AC3-8734-270C38E5A003.png" alt="665C7137-EB70-4AC3-8734-270C38E5A003"></p><p>å½“ç„¶ï¼Œè¿™é‡Œæœ‰ä¸ªé—®é¢˜ï¼Œå°±æ˜¯è¿™äº›ç©ºé—´æ”¾å¤§ä¼šä¸ä¼šæœ‰å½±å“ã€‚SQL Server ä¼¼ä¹ä¼šåˆ¤æ–­ <em>Delta ä¼šä¸ä¼šå¾ˆå¤§</em> å’Œ <em>è¿™æ ·æ ‡è®°ä¼šä¸ä¼šå½±å“åˆ†è£‚</em> æ¥å†³å®šæ˜¯å¦åšæˆ inline çš„</p><h3 id="Logical-Revert"><a href="#Logical-Revert" class="headerlink" title="Logical Revert"></a>Logical Revert</h3><p>è¿™é‡Œå…¶å®å°±æ˜¯ï¼Œå¯¹äº Data Modificationï¼ŒæŸç§æ„ä¹‰ä¸Šè¯´ Redo å®Œå°±è¡Œäº†ï¼Œç„¶åæŸ¥çš„æ—¶å€™ï¼ŒMainTable æ‰«ä¸€æ‰«ï¼Œå¦‚æœæŸä¸ªç‰ˆæœ¬ abort äº†å°±ä¸è¦è¯»å®ƒï¼Œå°±è¡Œäº†ã€‚å¦‚æœæœ€æ–°çš„ç‰ˆæœ¬æ˜¯ä¸ª aborted çš„ï¼Œé‚£ä¹ˆå¯èƒ½æœ‰ä¸‹å›¾çš„ä¼˜åŒ–ï¼š</p><p><img src="https://image.mwish.me/blog-image/2786AFA9-67ED-4B8F-AE4B-9A29506ECB4A.png" alt="2786AFA9-67ED-4B8F-AE4B-9A29506ECB4A"></p><ol><li>Logical Revertï¼ŒæŠŠ Version Store çš„å†…å®¹æåˆ°ä¸»è¡¨ä¸­ï¼Œç¼©çŸ­é“¾é•¿ã€‚è¿™ç”±ä¸€ä¸ª System Transaction å®Œæˆï¼Œè€Œä¸”æ˜¯åªä¿®æ”¹å•ä¸ª Row çš„æ“ä½œï¼Œæ‰€ä»¥ä¼šéå¸¸éå¸¸çŸ­</li><li>Overwrite: æ–°äº‹åŠ¡ç›´æ¥è¦†ç›–æ‰ä¸»è¡¨çš„ aborted version</li></ol><h4 id="Transaction-State-Management"><a href="#Transaction-State-Management" class="headerlink" title="Transaction State Management"></a>Transaction State Management</h4><p>ä¸€èˆ¬äº‹åŠ¡å†…éƒ¨ä¼š keep å†…å­˜çš„äº‹åŠ¡è¡¨é›†åˆï¼Œä¹‹æ‰€ä»¥åªè¦åœ¨å†…å­˜ä¸­ï¼Œå› ä¸ºè¿™äº›å¯ä»¥æ ¹æ® Log å…¨é‡æ„å»ºã€‚MySQL çš„æ¨¡å‹å’Œ SQL Server ä¿®æ”¹åå·®ä¸å¤šï¼Œä½†æ˜¯å®ƒæœ‰ Undo æµç¨‹ï¼Œæ‰€ä»¥ä¸éœ€è¦å¼•å…¥é¢å¤–çš„ç»“æ„ã€‚</p><p>SQL Server å› ä¸ºä¼šåœ¨ Main/Delta ä¸­ç›´æ¥æœ‰ aborted çš„ç»“æ„ï¼Œæ‰€ä»¥å¿…é¡»å¼•å…¥ä¸€ä¸ª aborted äº‹åŠ¡è¡¨ï¼Œæ¥è¿›è¡Œæ“ä½œã€‚è¿™ä¸ª aborted äº‹åŠ¡è¡¨çš„å¢/åˆ ä¹Ÿè¦è½ Logã€‚å½“æŸä¸ªäº‹åŠ¡ abortedï¼Œå®ƒä¼šè¢«åŠ å…¥è¡¨ä¸­ï¼Œå½“å®ƒä¿®æ”¹çš„æ‰€æœ‰ rows ä¸å¯è§äº†ï¼ˆç”± Cleanup æ“ä½œå®Œæˆï¼‰ï¼Œè¿™ä¸ªä¸œè¥¿ä¼šåœ¨äº‹åŠ¡è¡¨ä¸­è¢«å›æ”¶æ‰ã€‚</p><p>CTR å¼•å…¥äº†ä¸€ä¸ª Aborted Transaction Mapï¼Œæ¥å­˜å‚¨è¿™äº›ä¿¡æ¯ï¼ŒATM è¿˜ä¼šéšç€ ckpt å­˜å‚¨ä¸‹å»ï¼ŒåŠ é€Ÿæ¢å¤ï¼š</p><blockquote><p>CTR stores the aborted transaction information in the â€œAborted Transaction Mapâ€ (ATM), a hash table that allows fast access based on the Transaction Id. When a transaction aborts, before releasing any locks, it will add its Transaction Id to the ATM and generate an â€œABORTâ€ log record indicating that it was aborted.</p><p>As part of the Undo phase, any uncommitted transactions will also be marked as aborted, generating the corresponding ABORT log records, and added to the ATM.</p><p>Once all versions generated by an aborted transaction have been reverted, the transaction is no longer interesting for recovery and can be removed from the ATM. Removing a transaction is also a logged operation, using a â€œFORGETâ€ log record, to guarantee that the content of the ATM is recovered correctly.</p></blockquote><p>è¯»è€…è‚¯å®šä¼šæœ‰ä¸€ä¸ªç–‘é—®ï¼ŒATM ä¼šä¸ä¼šç–¯ç‹‚è†¨èƒ€ï¼Œä¸‹ä¸€å°èŠ‚å°±æ˜¯è®²è¿™ä¸ªçš„ã€‚</p><h4 id="Short-Transaction-Optimization"><a href="#Short-Transaction-Optimization" class="headerlink" title="Short Transaction Optimization"></a>Short Transaction Optimization</h4><p>ATM ä¼šå¸¦æ¥ä¸¤ç§é—®é¢˜ï¼š</p><ol><li>ä»»ä½•ä¸€ä¸ªå°äº‹åŠ¡ï¼Œå¦‚æœ abort äº†ï¼Œè¦è®° logï¼›å¦‚æœæ¸…ç†å®Œäº†ï¼Œè¿˜è¦è®° logã€‚ç›¸å¯¹åŸæœ¬ ARIES æ¥è¯´ï¼Œç©ºé—´å’Œå»¶è¿Ÿéƒ½ä¼šæ”¾å¤§</li><li>ATM æœ¬èº«å¯èƒ½è†¨èƒ€</li></ol><p>æ€»ä¹‹ï¼Œå¼•å…¥ ATM è®©ç³»ç»Ÿèƒ½å¤Ÿå¸¸æ•°æ—¶é—´æ¢å¤ï¼Œä½†æ˜¯è¿™ä¼šå¯¹æ€§èƒ½é€ æˆä¸å°çš„è´Ÿé¢å½±å“ã€‚è¿™é‡Œå¼•å…¥äº†ä¸€ä¸ªåŠ¨æ€æŠ‰æ‹©æ–¹æ¡ˆï¼š<strong>ã€Œåªæœ‰å¤§äº‹åŠ¡ä¼šèµ° CTRï¼Œå°äº‹åŠ¡å°±èµ°åŸæ¥çš„ï¼Œå› ä¸ºä¸å½±å“ã€</strong>ï¼š</p><blockquote><p>To optimize for both scenarios, CTR dynamically decides, based on the transaction size, whether a transaction should be marked as aborted, using the CTR mechanisms, or undone using the transaction log.</p></blockquote><p>å…¶å®æˆ‘è§‰å¾—å¾ˆåˆç†ï¼Œè¿™ä¹ˆä¿®æ”¹ä»¥åï¼Œæ•´ä¸ªç®—æ³•ä¸æ˜¯ã€Œå¸¸æ•°æ—¶é—´ã€äº†ï¼Œä½†æ˜¯è§£å†³äº†æ ¹æœ¬é—®é¢˜ã€‚</p><h3 id="Non-versioned-Operations"><a href="#Non-versioned-Operations" class="headerlink" title="Non-versioned Operations"></a>Non-versioned Operations</h3><p>ä¸Šé¢ä»‹ç»äº†æ­£å¸¸çš„ data-modification ç‰ˆæœ¬åŒ–è¯­ä¹‰çš„æ“ä½œï¼Œè¿™é‡Œå†æ¥ä»‹ç»ä¸€ä¸‹ non-version çš„æ“ä½œï¼Œè¿™é‡Œæœ‰ä¸‹é¢å¯¹åº”çš„æµï¼š</p><blockquote><ul><li>é€»è¾‘ä¸Šçš„é”å’Œ SMO æ“ä½œï¼Œå¯¹ Page çš„ç”³è¯·/é‡Šæ”¾ç­‰</li><li>å¯¹ Catalogã€Schema ä¹‹ç±»çš„ç³»ç»Ÿçš„ä¿®æ”¹</li><li>å¯¹ç³»ç»Ÿå¯åŠ¨/å…³é—­ä¹‹ç±»çš„ metapage çš„ä¿®æ”¹</li></ul></blockquote><p>è¿™äº›ä¸œè¥¿æ˜¯éç‰ˆæœ¬åŒ–çš„ï¼ŒSQL Server æŠ½äº†ä¸€æ¡é¢å¤–çš„æµæ¥ä¼˜åŒ–ã€‚</p><h4 id="SLog-A-Secondary-Log-Stream"><a href="#SLog-A-Secondary-Log-Stream" class="headerlink" title="SLog: A Secondary Log Stream"></a>SLog: A Secondary Log Stream</h4><blockquote><p>SLog is a secondary log stream designed to only track nonversioned operations that must be redone or undone using information from the corresponding log records.</p></blockquote><p>æœ¬è´¨ä¸Šåˆæ˜¯ä¸€ä¸ª Log æµå­˜å‚¨ç³»ç»Ÿï¼Œå¦‚ä¸‹å›¾ï¼š</p><p><img src="https://image.mwish.me/blog-image/5B8EE8B5-479B-4F4E-B322-26F2701F2B18.png" alt="5B8EE8B5-479B-4F4E-B322-26F2701F2B18"></p><p>å®ƒä»¬ä¼šå­˜å‚¨åˆ°å†…å­˜ä¸­ï¼Œç„¶å Batch Flush ä¸‹å»ï¼š</p><blockquote><p>When a checkpoint occurs, all in-memory records with LSN â‰¤ the Checkpoint Begin LSN get serialized and written into the transaction log.</p></blockquote><p>è¿™ä¸ªæ—¶å€™å¯ä»¥å†åº¦å¼•å…¥å˜æ›´äº†çš„ç³»ç»Ÿï¼š</p><p><img src="https://image.mwish.me/blog-image/8F2FC8D4-E2D1-494C-814E-7DC971EE6C7F.png" alt="8F2FC8D4-E2D1-494C-814E-7DC971EE6C7F"></p><h4 id="Leveraging-System-Transactions"><a href="#Leveraging-System-Transactions" class="headerlink" title="Leveraging System Transactions"></a>Leveraging System Transactions</h4><p>è¿™é‡Œè¿˜æ˜¯åŒæ ·çš„é—®é¢˜ï¼Œå…¨ä¸¢ SLog æœ¬èº«å¤ªå å†…å­˜äº†ã€‚è¿™é‡ŒæŠŠ Page åˆ†é…/é‡Šæ”¾ä¸¢ç»™äº†åŸæ¥çš„ ARIES ç³»ç»Ÿæ¥åšå¤„ç†ã€‚</p><h3 id="Redo-Locking-Optimization"><a href="#Redo-Locking-Optimization" class="headerlink" title="Redo Locking Optimization"></a>Redo Locking Optimization</h3><p>åŸå…ˆçš„ SQL Server ä¸ºå•¥è¦ Lock å‘¢ï¼Ÿå› ä¸ºå®ƒå¸Œæœ›åªå¯¹ è¦ Undo çš„åœ°æ–¹ Lockã€‚é‚£æ–°çš„ CTR åè®®é‡Œï¼Œ RW èŠ‚ç‚¹çš„æ¢å¤ä¸­ï¼Œæˆ‘è¿™ SLog å¤„ç†å®Œå°±æ²¡äº‹äº†ï¼Œé‚£ä¸ºå•¥è¿˜è¦ Lock å‘¢ï¼Ÿè¿™é‡Œåšçš„éå¸¸å·¥ç¨‹åŒ–ï¼šå¦‚æœæ˜¯åˆ†å¸ƒå¼çš„ ROèŠ‚ç‚¹ï¼ŒReplay Logï¼Œé‚£å®ƒä¹Ÿä¸çŸ¥é“è¿™ä¸ªäº‹åŠ¡åæ¥å’‹æ ·äº†ï¼Œæ‰€ä»¥è¿˜æ˜¯è¦çš„ã€‚è¿˜æœ‰ä¸€äº›åˆ†å¸ƒå¼äº‹åŠ¡çš„åœºæ™¯ï¼Œä¹Ÿæ˜¯éœ€è¦ Lock çš„ã€‚</p><p>è¿™é‡Œå¼•å…¥äº†ä¸€äº›ç»†ç²’åº¦çš„é”ï¼Œè®©è¿™ç§åœºæ™¯ä¸‹äº‹åŠ¡å®Œæˆâ€”é€šçŸ¥å˜å¾—é«˜æ•ˆï¼ŒåŒæ—¶è®©è¿™ä¸ªé”æ˜¯ Multi-Version çš„ï¼Œä¸å½±å“ä¸€äº›ä¸é˜»å¡çš„è¯»ã€‚</p><h3 id="Aggressive-Log-Truncation"><a href="#Aggressive-Log-Truncation" class="headerlink" title="Aggressive Log Truncation"></a>Aggressive Log Truncation</h3><p>TBD</p><h3 id="Background-Cleanup"><a href="#Background-Cleanup" class="headerlink" title="Background Cleanup"></a>Background Cleanup</h3><p>TBD</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>perfbook notes: defered processing</title>
      <link href="/2022/05/24/perfbook-notes-defered-processing/"/>
      <url>/2022/05/24/perfbook-notes-defered-processing/</url>
      
        <content type="html"><![CDATA[<h2 id="Data-ownership"><a href="#Data-ownership" class="headerlink" title="Data ownership"></a>Data ownership</h2><p>ä¸€ç§é¿å… Locking å¼€é”€çš„æ–¹å¼æ˜¯ï¼Œè®©æ•°æ®å±äºæŸä¸ª CPU/Threadï¼Œå›åˆ°å¹¶è¡Œè®¾è®¡çš„ç­–ç•¥ï¼Œä½ ä¼šå‘ç°è¿™ä¸ªæ˜¯å®Œç¾è´´åˆçš„ï¼š</p><blockquote><p>Interestingly enough, data ownership covers each of the â€œbig threeâ€ parallel design techniques: It partitions over threads (or CPUs, as the case may be), it <strong>batches</strong> all local operations, and its elimination of synchronization operations is weakening carried to its logical extreme.</p></blockquote><p>è¿™é‡Œæœ‰å‡ ç§æ–¹å¼æ¥åšè¿™äº›æ“ä½œï¼š</p><ol><li>data å…¨æ˜¯çº¿ç¨‹è‡ªèº«çš„ï¼Œä¸éœ€è¦åŒæ­¥æ–¹æ¡ˆ</li><li>Data æ¥è‡ªä¸€ä¸ªå…±äº«åŒºåŸŸï¼Œä½†æ˜¯æ¯ä¸ªçº¿ç¨‹ manage å…¶ä¸­çš„ä¸€éƒ¨åˆ†ï¼ˆæƒ³è±¡ä¸€ä¸ªå›ºå®š slot çš„ bucketï¼‰</li><li>function shippingï¼Œç”¨ä¸€äº›æ–¹å¼æ¥è®¿é—®åˆ«çš„åœ°æ–¹ own çš„æ•°æ®</li><li>Designated Threadï¼Œç‰¹å®šçš„çº¿ç¨‹è®¿é—®è¿™äº›æ•°æ®</li></ol><p>å…³äº (1) æˆ‘ä»¬å¯ä»¥å›é¡¾ Counter çš„æ–¹æ¡ˆï¼Œcounter æ•°æ®æ˜¯çº¿ç¨‹/CPU è‡ªèº«çš„ã€‚åªèƒ½è‡ªå·±å•çº¿ç¨‹æ·»åŠ ï¼Œä½†åˆ«çš„çº¿ç¨‹å¯ä»¥å» readã€‚åœ¨ Linux Kernel ä¸­ï¼Œä¹Ÿæœ‰è¿™ç§æƒ…å†µï¼šæŸä¸ª CPU A åœ¨ <strong>interrupt disabled</strong> çš„æƒ…å†µä¸‹ï¼Œå¯ä»¥è¯»å–ä¸€äº›è‡ªå·±çš„å˜é‡ï¼›åˆ«çš„ CPU B åœ¨æ‹¿åˆ°äº†è¿™ä¸ª CPU A çš„ per-CPU é”çš„æ—¶å€™ï¼Œæ‰èƒ½è¯» CPU A çš„è¿™äº›å˜é‡ï¼›è€Œ CPU A åœ¨æ›´æ–°çš„æƒ…å†µä¸‹ï¼Œéœ€è¦ <strong>interrupt disabled</strong> + CPU A çš„ Per-CPU lockã€‚Per-CPU çš„ memory allocator ä¹Ÿæ˜¯ä¸€ä¸ªå¾ˆå¥½çš„ä¾‹å­ã€‚</p><p>function shipping ç±»ä¼¼ counter é‚£èŠ‚çš„ä¿¡å· counterã€‚é€šè¿‡ä¸€äº›é€šä¿¡çš„æ–¹å¼ï¼Œæ¥è·å–ï¼ˆæ‹¿èµ°ï¼‰åˆ«çš„çº¿ç¨‹çš„æ•°æ®ï¼Œè¿™é€šå¸¸å¯ä»¥å¼•å…¥ä¸€äº› concurrent queue æˆ–è€… message queue ä¸€ç±»çš„ä¸œè¥¿ã€‚è¿™é‡Œè¿˜ä¼šæ¶‰åŠåˆ°ä¸€ä¸ªã€Œå“ªäº›çº¿ç¨‹ç®¡è‡ªå·±çš„æ•°æ®ã€è¿™ç§é—®é¢˜ã€‚å…¶å®è¿™ä¸ªå¯ä»¥å‚è€ƒçº¿ç¨‹æ± ä¹‹ç±»çš„ï¼Œèµ° queue åˆ†é…ï¼Œtokio åº”è¯¥æœ‰ä¸é”™çš„åšå®¢æè¿°å®ƒä»¬çš„æ–¹æ¡ˆã€‚</p><p>è¿˜æœ‰ä¸€ç§æ–¹å¼æ˜¯ Designated Threadï¼Œå³ä¸€ä¸ª/å¤šä¸ªç‰¹å®šçš„çº¿ç¨‹è®¿é—®ç‰¹å®šçš„æ•°æ®ã€‚è¿™ä¸ªå¯ä»¥å‚è€ƒ <code>eventually</code>ï¼Œæœ€ç»ˆä¸€è‡´æ€§çš„ counterï¼Œå³æœ‰ä¸€ä¸ª <code>eventual</code> çº¿ç¨‹æ‰«æ‰€æœ‰çº¿ç¨‹çš„ counterï¼ŒæŠŠä»–ä»¬ç§»åŠ¨åˆ° <code>global</code>ã€‚è¿™ä¸ªå°±ç”¨ä¸€ä¸ªç‰¹å®šçš„çº¿ç¨‹æ¥å¹¶å‘ã€‚è¿™ä¸ªæ€è·¯åœ¨é counter ä¹Ÿå¾ˆå¸¸è§ï¼Œæ¯”å¦‚ <code>rpc</code> å¯èƒ½ä¼šæœ‰ç‰¹å®šçš„çº¿ç¨‹æ¥æ‰«æ•°æ®ï¼Œå¤„ç†å›è°ƒã€‚</p><p>æœ‰ä¸€ç§æå‡å¹¶å‘çš„æ–¹å¼ï¼Œå°±æ˜¯å°†å…±äº«çš„å¹¶å‘åŒæ­¥ç‚¹ï¼Œå˜æˆç§æœ‰çš„æ•°æ®ã€‚</p><blockquote><p>Data ownership is perhaps the most underappreciated synchronization mechanism in existence. When used properly, it delivers unrivaled simplicity, performance, and scalability. Perhaps its simplicity costs it the respect that it deserves. Hopefully a greater appreciation for the subtlety and power of data ownership will lead to greater level of respect, to say nothing of leading to greater performance and scalability coupled with reduced complexity.</p></blockquote><h2 id="Deferred-Processing"><a href="#Deferred-Processing" class="headerlink" title="Deferred Processing"></a>Deferred Processing</h2><p>å¯¹äºå¹¶è¡Œç³»ç»Ÿæ¥è¯´ï¼Œdeferred processing èƒ½å‡å¼±å¯¹åŒæ­¥åŸè¯­çš„éœ€æ±‚ï¼Œå¹¶å¤§å¤§æå‡æ€§èƒ½ã€‚è¿™é‡Œä¼šä»‹ç»ï¼š</p><ol><li>Reference counting</li><li>hazard pointers</li><li>sequence locking</li><li>RCU</li></ol><p>è¿™é‡Œä¸¾äº†ä¸€ä¸ª Practical çš„ä¾‹å­ï¼š</p><p><img src="https://image.mwish.me/blog-image/04885DC0-FF37-4AD8-9792-56E7FBFF6494.png" alt="04885DC0-FF37-4AD8-9792-56E7FBFF6494"></p><p>è¿™é‡Œæä¾›çš„æ˜¯ä¸€ä¸ªé“¾è¡¨ï¼Œé“¾è¡¨æœ‰ lookup, add, del çš„éœ€æ±‚ï¼Œå•çº¿ç¨‹ä»£ç å¦‚ä¸‹ï¼š<a href="https://github.com/paulmckrcu/perfbook/blob/master/CodeSamples/defer/route_seq.c">https://github.com/paulmckrcu/perfbook/blob/master/CodeSamples/defer/route_seq.c</a></p><p>æ˜¾ç„¶ï¼Œç½‘ç»œæ ˆç›¸å…³çš„ä»£ç æ˜¯ä¸å¤ªä¼šå•çº¿ç¨‹çš„ï¼Œæ‰€ä»¥éœ€è¦å¹¶è¡Œæ–¹å¼æ¥å¤„ç†ã€‚</p><h3 id="Reference-Counting"><a href="#Reference-Counting" class="headerlink" title="Reference Counting"></a>Reference Counting</h3><p>rc ä½œä¸ºä¸€ä¸ªå¸¸è§æ–¹æ¡ˆæ˜¯å¾ˆå¸¸ç”¨çš„ã€‚<code>Arc</code> å’Œ <code>shared_ptr</code> éƒ½æ˜¯ä¸€ç§å¹¶å‘çš„ RCï¼Œå…³äºå®ƒä»¬çš„è¯­ä¹‰ï¼Œboost æœ‰å¾ˆç²¾å½©çš„ä»‹ç»ï¼š<a href="https://www.boost.org/doc/libs/1_63_0/doc/html/atomic.html">https://www.boost.org/doc/libs/1_63_0/doc/html/atomic.html</a> . æ®ä¼ ï¼ŒRC å¯ä»¥è¿½æº¯åˆ°ä¸Šä¸–çºªå››äº”åå¹´ä»£é‡Œé¢è®¡ç®—æœºç¡¬ä»¶ç®¡ç†çš„æµç¨‹ä¸Šï¼Œè¦ç”¨çš„åœ°æ–¹è´´ä¸ªæ¡ï¼Œæ²¡æ¡äº†æ‰èƒ½å…³ã€‚</p><p>perfbook ç»™äº†ä¸€ä¸ªä¸æ˜¯å¾ˆå®Œå–„çš„å®ç°ï¼š<a href="https://github.com/paulmckrcu/perfbook/blob/master/CodeSamples/defer/route_refcnt.c">https://github.com/paulmckrcu/perfbook/blob/master/CodeSamples/defer/route_refcnt.c</a> </p><p>RC ä¼šéœ€è¦å¯¹ä¸€ä¸ª atomic çš„è®¡æ•°å™¨ï¼Œé€šè¿‡ faa æ¥å¢åŠ /å‡å°‘ counterã€‚æˆ‘ä»¬ä¹‹å‰è®²åˆ° faa çš„é™åˆ¶ï¼Œå®é™…ä¸Šå¯ä»¥å‚è€ƒä¸‹å›¾ï¼š</p><p><img src="https://image.mwish.me/blog-image/77841631-8B37-407F-8529-CF2704D4D054.png" alt="77841631-8B37-407F-8529-CF2704D4D054"></p><p>è¿™é‡Œ ref-cnt éšç€ CPU/Thread å¢å¤šï¼Œä¸å¤ªæ˜¯ scalable çš„ã€‚</p><p>Ref-cnt è¿˜æœ‰ä¸ªé—®é¢˜ï¼Œå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬å‡è®¾æœ‰ä¸€å— RC çš„å†…å­˜ï¼Œé‚£è¿™ä¸ª <code>count</code> æœ¬èº«å’Œ <code>data</code> æ”¾åœ¨ä¸€èµ·çš„è¯ï¼Œå¯èƒ½æ˜¯ä¸åˆé€‚çš„ï¼Œæ‰€ä»¥ä¸€èˆ¬å®ç°ä¸Šï¼Œæ§åˆ¶å—å’Œæ•°æ®å—å¯èƒ½æ˜¯åˆ†å¼€çš„ã€‚è¿™ç‚¹ä¹Ÿå¯å‘äº†åç»­çš„ä¸€äº›å†…å®¹ã€‚</p><h3 id="Hazard-Pointer"><a href="#Hazard-Pointer" class="headerlink" title="Hazard Pointer"></a>Hazard Pointer</h3><p>hzdptr æ€è·¯å’Œ ref-cnt æœ‰ç‚¹ç±»ä¼¼ï¼Œä¸è¿‡ï¼š</p><blockquote><p>Rather than incrementing an integer stored in the data element, instead store a pointer to that data element in per-CPU (or per-thread) lists. Each element of these lists is called a hazard pointer [Mic04].</p></blockquote><p>è¿™é‡Œ hazard pointer éµå®ˆè§„åˆ™ï¼š</p><ol><li>å¦‚æœè¢« free äº†ï¼Œåç»­å†ä¹Ÿä¸ä¼šå¢åŠ è¿™ä¸ªè¢« free çš„çº¿ç¨‹çš„è¯»è€…</li><li>ä¸ç»´æŠ¤è®¡æ•°ï¼Œè€Œæ˜¯æ¯ä¸ªçº¿ç¨‹ç»´æŠ¤ä¸€ä¸ª hazptr åˆ—è¡¨ï¼ˆå®é™…ä¸Šå°±ç±»ä¼¼è®¡æ•°ï¼‰ã€‚æŸä¸ªå…ƒç´ çš„å¼•ç”¨è®¡æ•° ç­‰äº æ‰€æœ‰çº¿ç¨‹çš„åˆ—è¡¨ä¸­ï¼ŒæŒ‡å‘è¿™å—å†…å­˜åœ°å€ä¸­ hazptr çš„æ€»é‡ã€‚</li><li>Batch è®¿é—®ï¼Œæ¥å‡è½»è®¡ç®— (2) ä¸­å¼•ç”¨è®¡æ•°çš„å¼€é”€ã€‚</li></ol><p>ä¸‹é¢æ˜¯ä½¿ç”¨çš„æ—¶å€™ï¼š</p><ol><li>Hazptr åœ¨è®¿é—®çš„æ—¶å€™ï¼Œéƒ½è¦è®°å½•åˆ°æœ¬çº¿ç¨‹çš„ hazptr åˆ—è¡¨ä¸­ï¼Œè¿™é‡Œä¼šè°ƒç”¨ API <code>hp_record</code> æˆ–è€… <code>hp_try_record</code> æ¥æ³¨å†Œã€‚å®ƒä¼šæ³¨å†Œåˆ°æœ¬çº¿ç¨‹çš„åˆ—è¡¨ä¸­ã€‚åœ¨è®¿é—®çš„æ—¶å€™ï¼Œè¿™é‡ŒæŠ½å‡ºäº†ä¸€ä¸ª grace å€¼ï¼Œ<code>HAZPTR_POISON</code> ï¼Œå®ç°ä¸º <code>0x8</code>ï¼Œè¿™ä¸ªå€¼ç”¨æ¥è¡¨ç¤º hazptr çš„ç‰¹æ®Šå€¼ã€‚å½“å†™å…¥æˆ–è€…åˆ é™¤çš„æ—¶å€™ï¼Œéœ€è¦é è¿™ä¸ªå€¼è¡¨ç¤ºã€Œè¢«åˆ æ‰äº†ã€æˆ–è€…ã€ŒçŠ¶æ€æœªå†³ã€ã€‚</li><li>åœ¨æ‘˜é™¤çš„æ—¶å€™ï¼Œä¸ä¼šç›´æ¥ free å†…å­˜ï¼Œè€Œä¼šèµ° <code>hazptr_free_later</code>ï¼Œæ³¨å†Œåˆ°ä¸€ä¸ª free åˆ—è¡¨ä¸­ã€‚<code>hazptr_free_later</code> åŒæ—¶æœ‰ä¸€ä¸ªè®¡æ•°å™¨ï¼Œå¦‚æœé‡Œé¢å…ƒç´ è¿‡å¤šçš„è¯ï¼Œä¼šè§¦å‘ <code>hazptr_scan</code>ï¼ŒåšçœŸæ­£çš„åˆ é™¤ï¼ˆè¿™é‡Œä½“ç°äº† Batch æ“ä½œï¼‰</li><li><code>hazptr_scan</code> ä¼šæŠŠå…¨å±€çš„å¼•ç”¨åˆ—è¡¨æ‰«å‡ºæ¥ï¼Œç„¶åå’Œæœ¬çº¿ç¨‹çš„ free åˆ—è¡¨å¯¹æ¯”ï¼Œçœ‹çœ‹æœ‰æ²¡æœ‰è¢«å¼•ç”¨çš„ï¼Œæ²¡æœ‰è¢« hazptr å¼•ç”¨å°±å¯ä»¥ gc æ‰äº†ã€‚æ³¨æ„ï¼šfree åˆ—è¡¨ä¸­çš„å¯¹è±¡åœ¨è¢« free ä¹‹åå°±ä¸å†ä¼šè¢«å¼•ç”¨ï¼Œè€Œä¸”è‡³å¤šè¢« free ä¸€æ¬¡ã€‚</li></ol><p>ä¸Šè¿°å°±æ˜¯é£é™©æŒ‡é’ˆçš„æµç¨‹ï¼Œå…·ä½“çš„å®ç°ä¼šå¤æ‚å¾ˆå¤šï¼Œä¸»è¦æ˜¯æœ‰å¾ˆå¤šå¹¶å‘çš„å° corner case è¦å¤„ç†ã€‚</p><p>hazptr ä»£ç å¯ä»¥å‚è€ƒï¼š</p><ol><li>Folly: <a href="https://github.com/facebook/folly/blob/main/folly/synchronization/Hazptr.h">https://github.com/facebook/folly/blob/main/folly/synchronization/Hazptr.h</a></li><li>perfbook: <a href="https://github.com/paulmckrcu/perfbook/blob/master/CodeSamples/defer/hazptr.h">https://github.com/paulmckrcu/perfbook/blob/master/CodeSamples/defer/hazptr.h</a> å’Œ <a href="https://github.com/paulmckrcu/perfbook/blob/master/CodeSamples/defer/hazptr.c">https://github.com/paulmckrcu/perfbook/blob/master/CodeSamples/defer/hazptr.c</a></li></ol><p>å¯¹ä¸Šè¿°è¿™äº› api çš„ä½¿ç”¨ï¼Œå¯ä»¥å‚è€ƒ perfbook çš„ä¾‹å­ï¼š<a href="https://github.com/paulmckrcu/perfbook/blob/master/CodeSamples/defer/route_hazptr.c">https://github.com/paulmckrcu/perfbook/blob/master/CodeSamples/defer/route_hazptr.c</a> ã€‚è¿™é‡Œæ³¨æ„åˆ°ï¼Œç”±äº <code>hazptr</code> åˆ—è¡¨å¯èƒ½è¢«ä¿®æ”¹ï¼Œä¸€æ—¦é‡ä¸Šäº† <code>HAZPTR_POISON</code>ï¼Œè¿™é‡Œå°±ä¼šé‡è¯•ã€‚ä¸è¿‡è¿™ä¹Ÿä¸æ˜¯å¿…é¡»çš„ï¼Œè¿™é‡Œæåˆ°ï¼š</p><blockquote><p>In certain cases, restart can be avoided by using link counting as exempliï¬ed by the UnboundedQueue and  ConcurrentHashMap data structures implemented in Folly open-source library.</p></blockquote><p>ä¸‹é¢æ˜¯æ€§èƒ½ç›¸å…³ï¼š</p><p><img src="https://image.mwish.me/blog-image/3BCAF617-31BD-4713-A98F-D44F3F23915C.png" alt="3BCAF617-31BD-4713-A98F-D44F3F23915C"></p><p>å¯ä»¥çœ‹åˆ°ï¼Œç”±äºåˆ©ç”¨äº† Batchingï¼Œhazptr ç›¸å¯¹æ¥è¯´æ€§èƒ½æå‡ä¸å°‘ã€‚</p><h3 id="Sequence-Locks"><a href="#Sequence-Locks" class="headerlink" title="Sequence Locks"></a>Sequence Locks</h3><blockquote><p>Sequence locks are used in the Linux kernel for readmostly data that must be seen in a consistent state by readers. However, unlike reader-writer locking, readers do not exclude writers. Instead, like hazard pointers, sequence locks force readers to retry an operation if they detect activity from a concurrent writer.</p></blockquote><p>è¿™ä¸ªæ–¹å¼å¯ä»¥ç†è§£ä¸ºæœ‰ç‚¹ç±»ä¼¼åœ¨æ•°æ®åº“ OCC Validation ä¸­åšçš„é‚£æ ·ã€‚å®ƒéœ€è¦åœ¨æ•°æ®ä¸Šæœ‰ä¸€ä¸ªå¯¹åº”çš„ seqï¼Œè¿™é‡Œä¼šå…è®¸å¤šè¯»è€…ã€å•å†™è€…ï¼Œå¹¶ä¸”è¯»è€…å¦‚æœæ˜¯éœ€è¦é‡è¯•çš„ï¼Œè¿™ä¸ªå…¶å®ä¹Ÿå¯ä»¥å¯¹æ¯” OCCã€‚ç»“è®ºå°±æ˜¯ï¼Œå’Œ OCC ç±»ä¼¼ï¼Œæ²¡æœ‰æ›´æ–°çš„æ—¶å€™ï¼Œæ€§èƒ½ä¼šéå¸¸å¥½ã€‚</p><p>perfbook ä¸Šçš„ seqlock æœ‰ç‚¹é‚ªé—¨ï¼Œå®ƒä¸å…³å¿ƒã€Œæœ‰æ²¡æœ‰è¯»åˆ°ä¸€ä¸ªä¸€è‡´çš„å¿«ç…§ã€ï¼Œå®ƒåœ¨å¼€å§‹æ›´æ–°çš„æ—¶å€™ä¼šæŠŠ <code>seq</code> è®¾ç½®ä¸ºå¥‡æ•°ï¼Œç„¶åæ›´æ–°å®Œæˆä¼šè®¾ç½®ä¸ºå¶æ•°ã€‚</p><p>å¯¹äºè¯»å†™ï¼Œè¿™é‡Œæ¥å£æœ‰ï¼š</p><ol><li><code>read_seqbegin</code> å’Œ <code>read_seqretry</code></li><li><code>write_seqlock</code> å’Œ <code>write_sequnlock</code></li></ol><p><img src="https://image.mwish.me/blog-image/C0251FC1-7B61-440C-B9D8-F10E8A8B3DD2.png" alt="C0251FC1-7B61-440C-B9D8-F10E8A8B3DD2"></p><p>è¿™ä¸ªå®ç°æ˜¯éå¸¸ç®€å•çš„ï¼š<a href="https://github.com/paulmckrcu/perfbook/blob/master/CodeSamples/defer/seqlock.h">https://github.com/paulmckrcu/perfbook/blob/master/CodeSamples/defer/seqlock.h</a> ã€‚å®ƒæä¾›äº†ä¸€ç§ä¸é˜»å¡ï¼Œè€Œæ˜¯é‡è¯•è¯»çš„ã€Œä¹è§‚è¯»å†™é”ã€ã€‚</p><p>å½“ç„¶ï¼Œç”¨æˆ‘ä»¬ä¹‹å‰ Lock çš„è§†è§’åˆ†æï¼Œè¿™ä¸ªæ–¹æ¡ˆéœ€è¦æ›´ç²¾ç»†çš„è®¾è®¡ï¼Œå› ä¸ºè¿™é‡Œè¯»å¯èƒ½ä¼šè¢«ä¸åœçš„å†™å…¥é¥¿æ­»ï¼Œæ­£å¦‚ç³»ç»Ÿæè¿°çš„ï¼š</p><blockquote><p>Both the read-side and write-side critical sections of a sequence lock can be thought of as transactions, and sequence locking therefore can be thought of as a limited form of transactional memory, which will be discussed in Section 17.2. The limitations of sequence locking are: (1) Sequence locking restricts updates and (2) sequence locking does not permit traversal of pointers to objects that might be freed by updaters. These limitations are of course overcome by transactional memory, but can also be overcome by combining other synchronization primitives with sequence locking.</p></blockquote><p>ä¸è¿‡ï¼Œå®ƒçš„å¥½å¤„æ˜¯ï¼Œæ²¡æœ‰å†™å…¥è€…çš„æ—¶å€™ï¼Œç³»ç»Ÿæ˜¯ scalable çš„ã€‚</p><p><img src="https://image.mwish.me/blog-image/B8059A1F-F9F4-4BAD-B5CA-8BB637F88D5F.png" alt="B8059A1F-F9F4-4BAD-B5CA-8BB637F88D5F"></p><h3 id="RCU"><a href="#RCU" class="headerlink" title="RCU"></a>RCU</h3><p>Perfbook çš„ä½œè€…æ˜¯ RCU çš„æå‡ºè€…ï¼Œæ‰€ä»¥ä»–èŠ±äº†æ¯”ä¸Šé¢å†…å®¹åˆèµ·æ¥å—¨å”±çš„ç¯‡å¹…æ¥ä»‹ç» RCU æŠ€æœ¯ã€‚å½“ç„¶ï¼Œè¿™ä¹Ÿæ˜¯å€¼å¾—çš„ã€‚RCU å®é™…ä¸Šæ˜¯æœ‰å¾ˆå¤šå˜ä½“çš„ï¼ŒåŒ…æ‹¬ Double Buffer è¿™ç§ã€‚</p><p>å¯¹äº RCï¼Œå®ƒæŠŠ faa çš„å·¨å¤§å¼€é”€ä¸¢ç»™äº†è¯»è€…ï¼Œè®©è¯»è€…ä¸ scalableï¼›hazptr å‡å°äº†åŒæ­¥å¼€é”€ï¼Œä½†æ˜¯çº¿ç¨‹éœ€è¦è®°å½•ç›¸å…³çš„ ptrï¼Œè¯»å†…å­˜éœ€è¦æœ‰ <code>WRITE_ONCE</code> ä¹‹ç±»çš„æ¥å£æ¥å†™å…¥ï¼Œè¿™ä¹Ÿå¯èƒ½æœ‰ä¸€å®šå¼€é”€ï¼›seqlock é¿å…äº†è¯»ç›¸å…³çš„ contentionï¼Œä½†æ˜¯å†™éå¸¸æ‹‰èƒ¯ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå®ƒä»¬å¯ä»¥è§†ä¸ºã€Œåœ¨åŒä¸€å—å†…å­˜ç©ºé—´ä¸Šçš„å¹¶å‘ã€ã€‚è¿™äº›æ¥å£åœ¨è¯»çš„æ—¶å€™ï¼Œä¹Ÿéœ€è¦å¼•å…¥ <code>memory barrier</code>ï¼Œæ¥åšåŒæ­¥ã€‚</p><p>RCU(read-copy update) æä¾›äº† APIï¼Œå…è®¸é€šè¿‡å¢å¤§æ›´æ–°ä»£ä»·ï¼Œæ¥è®©è¯»å¯æ‰©å±•ã€‚ä¹¦åé¢ä»‹ç»äº†ç»å…¸çš„ RCUã€åŸºæœ¬çš„ RCU æ¦‚å¿µã€å†…æ ¸ Linux APIã€RCU çš„ç”¨å¤„ã€‚</p><h4 id="ä»ä¸€ä¸ªæŒ‡é’ˆå¼€å§‹çš„-RCU-Introduction"><a href="#ä»ä¸€ä¸ªæŒ‡é’ˆå¼€å§‹çš„-RCU-Introduction" class="headerlink" title="ä»ä¸€ä¸ªæŒ‡é’ˆå¼€å§‹çš„ RCU Introduction"></a>ä»ä¸€ä¸ªæŒ‡é’ˆå¼€å§‹çš„ RCU Introduction</h4><p><img src="https://image.mwish.me/blog-image/963AF616-C2C7-4FB2-A67F-85CC643E5DBE.png" alt="963AF616-C2C7-4FB2-A67F-85CC643E5DBE"></p><p>è¿™é‡Œçš„æ¨¡å‹æ˜¯ä¸€ä¸ªæŒ‡å‘ç»“æ„ä½“çš„æŒ‡é’ˆï¼Œç„¶åå®ç° Insert å’Œ Deleteã€‚</p><p>Insert ç›¸å¯¹äºç”¨ <code>atomic</code> æ¥å£è¯»å†™æŒ‡é’ˆæ²¡å•¥åŒºåˆ«ï¼ŒFigure 9.6 åˆ™æ˜¯æ­£å¸¸çš„ <code>std::atomic</code> æŒ‡é’ˆé‚£å¥—ï¼ˆè¿™é‡Œç”¨çš„æ˜¯å†…æ ¸çš„å„ç§æ¥å£ï¼Œä¸è¿‡æ„æ€æ‡‚å°±è¡Œï¼‰ã€‚</p><p>Delete å°±æœ‰åŒºåˆ«äº†ï¼åŒºåˆ«åœ¨äºï¼Œ<code>gptr</code> è®¾ç½®æ˜¯å¾ˆæ–¹ä¾¿çš„ï¼Œä½†ä¹‹å‰å¯èƒ½æœ‰è¯»è€…åœ¨è¯»ï¼Œæ‰€ä»¥è¿™é‡Œæ¶‰åŠä¸€ä¸ª GC çš„è¿‡ç¨‹ã€‚è¿™é‡Œè¦ã€Œç­‰å¾…ä¹‹å‰è¯»è€…ï¼ˆpre-existing readersï¼‰å®Œæˆï¼Œç„¶åå† <code>free</code>ã€</p><p><img src="https://image.mwish.me/blog-image/BB98CABE-1A28-4403-BFAD-196E131C327B.png" alt="BB98CABE-1A28-4403-BFAD-196E131C327B"></p><p>è¿™é‡Œæœ‰ä¸ªé—®é¢˜ï¼šå¦‚ä½•ã€Œç­‰å¾…ä¹‹å‰è¯»è€…å®Œæˆã€ï¼Ÿ</p><ol><li>é¦–å…ˆæƒ³åˆ°çš„æ˜¯ RCï¼Œä¸è¿‡æˆ‘ä»¬ä¹‹å‰ä»‹ç»è¿‡äº† RC çš„ç¼ºç‚¹ï¼Œhazptr ä¹Ÿæœ‰ä¸€å®šå¼€é”€</li><li>memory synchronization æ¯”è¾ƒæ˜‚è´µï¼Œé€šå¸¸ä¼šå¼•å…¥ mbï¼Œæ‰€ä»¥ç”¨ registerï¼Œæ¯”å¦‚æŸ¥çœ‹åˆ«çš„çº¿ç¨‹çš„ PCã€‚è¿™ç§æ–¹æ³•å°±å¤ª hacking äº†</li><li>ç­‰å¾…å›ºå®šé•¿åº¦çš„æ—¶é—´ï¼Œç­‰åˆ°ç†è®ºä¸Šæ²¡æœ‰ reader äº†ã€‚è¿™ä¸ªåœ¨å®æ—¶ç³»ç»Ÿå¯èƒ½æœ‰ç”¨ï¼Œä½†æ˜¯å¤ª hacking äº†</li><li>ä¸é‡Šæ”¾äº†ï¼Œleaking memory! ç»™æˆ‘æ‘†ï¼è¿™å¯ä»¥ç”± GC æ¥å„ç§å¤„ç†ã€‚</li><li>åœæ­¢ç¨‹åºï¼Œç›´åˆ° pre-existing readers å®Œæˆâ€¦è¿™ä¸æ˜¯å›æ¥äº†å—ï¼Ÿç­”æ¡ˆæ˜¯ï¼Œè¿™é‡Œç›¸å¯¹ RC é‚£ç§è¯»è€… GCï¼Œè¿™é‡Œéœ€è¦ å˜æ›´å€¼ + åŒæ­¥ + å†™è€… GCã€‚å½“æ‰€æœ‰çº¿ç¨‹å®Œæˆæ—¶ï¼ŒRCU å®Œæˆäº† <em>grace period</em>ï¼Œå¯ä»¥ GC äº†ã€‚</li></ol><p>æ–¹æ¡ˆ (5) å’Œå†…æ ¸æ­£å¥½æœ‰ä¸€äº›åœ°æ–¹åŒ¹é…ï¼Œè¿˜è®°å¾— <code>spin_lock</code> å¯èƒ½ä¼šå…³ä¸­æ–­å—ï¼š</p><blockquote><p>The spinning threads will not relinquish their CPUs until they acquire the lock, but the thread holding the lock cannot possibly release it until one of the spinning threads relinquishes a CPU. This is a classic deadlock situation, and this deadlock is avoided by forbidding blocking while holding a spinlock.</p></blockquote><p>è¿™æ ·ç³»ç»Ÿå°±ä¼šç±»ä¼¼ä¸€ä¸ªéæŠ¢å çš„ç³»ç»Ÿï¼Œé‚£ä¹ˆï¼Œä¸»çº¿ç¨‹è¦åšä»€ä¹ˆå‘¢ï¼Ÿç­”æ¡ˆæ˜¯ <code>context swtich</code> åˆ°æ¯ä¸ªçº¿ç¨‹ä¸Šï¼Œè¿™æ ·å°±èƒ½ä¿è¯å®ƒä»¬å®Œæˆäº†ï¼Œå¦‚å›¾ï¼š</p><p><img src="https://image.mwish.me/blog-image/6566C47B-B026-4AD8-823F-CA68D6695468.png" alt="6566C47B-B026-4AD8-823F-CA68D6695468"></p><blockquote><p>This approach is termed quiescent state based reclamation (QSBR) [HMB06].</p></blockquote><p>æ‰€ä»¥ï¼Œæœ€ç®€å•çš„å®ç°æ˜¯ï¼Œè¿› RCU è¯»åŒºåŸŸå…³ä¸­æ–­ï¼Œåˆ é™¤çš„æ—¶å€™ï¼Œéœ€è¦ <code>synchronize_rcu()</code>ï¼Œæ¥ context switch åˆ°æ¯ä¸ª CPU ä¸Šï¼Œä¿è¯åº¦è¿‡ä¸´ç•ŒåŒºã€‚</p><p>é‚£ä¹ˆï¼Œåœ¨è¿™é‡Œï¼ŒRCU ç‰¹ç‚¹æ˜¯ï¼Œè¯»å¯æ‰©å±•ï¼Œä¸ç”¨é¸Ÿå†™è€…ã€‚æ¥å£ç±»ä¼¼ï¼š</p><ol><li><code>rcu_read_lock</code> å’Œ <code>rcd_read_unlock</code>ï¼Œåœ¨æˆ‘ä»¬ä¸Šé¢ä¾‹å­æ˜¯å¼€å…³ä¸­æ–­</li><li><code>synchronize_rcu</code>, ä¿è¯æ‰€æœ‰è¯»è€…å®Œæˆï¼Œåœ¨æˆ‘ä»¬ä¸Šé¢ä¾‹å­æ˜¯è°ƒåº¦</li><li><code>rcu_ assign_pointer()</code> and <code>rcu_dereference()</code>, å‘å¸ƒæŒ‡é’ˆã€‚</li></ol><h4 id="RCU-Fundamentals"><a href="#RCU-Fundamentals" class="headerlink" title="RCU Fundamentals"></a>RCU Fundamentals</h4><p>è¿™é‡Œæ˜¯ RCU éœ€è¦ä¾èµ–çš„åŸºç¡€ï¼š</p><ol><li>æ’å…¥ï¼špublish-subscribe mechanism</li><li>åˆ é™¤å’Œå†…å­˜å›æ”¶ï¼šwaiting for pre-existing RCU readers enabled deletion</li><li>å¹¶å‘æ›´æ–°ï¼šmaintaining multiple versions of recently updated objects</li></ol><h5 id="Publish-Subscribe-Mechanism"><a href="#Publish-Subscribe-Mechanism" class="headerlink" title="Publish-Subscribe Mechanism"></a>Publish-Subscribe Mechanism</h5><p>æˆ‘ä»¬ä¹‹å‰é  atomic æ›´æ–°æŒ‡é’ˆæ¥å‘å¸ƒï¼Œå®é™…ä¸Š RCU éœ€è¦è¿™ç§æœºåˆ¶ï¼Œæ¥ä¿è¯ã€Œæ—§çš„ç‰ˆæœ¬ä¸å†è¢«è¯»åˆ°ã€ã€‚</p><p><img src="https://image.mwish.me/blog-image/41DE6CA6-1269-4D58-A3A3-A8F59D013650.png" alt="41DE6CA6-1269-4D58-A3A3-A8F59D013650"></p><p>è¿™é‡Œéœ€è¦ä¿è¯ï¼š</p><ol><li>pointer çš„ pusblishï¼Œå³ <code>rcu_assign_pointer</code> æ˜¯åŸå­çš„</li><li>pointer çš„ deref ï¼Œå³ subscribe æ˜¯åŸå­çš„ï¼Œè¡¨ç°ä¸º<code>rcu_dereference</code></li></ol><p>è¿™é‡Œå¯ä»¥è§†ä½œæ˜¯ä¸€ç»„å‘å¸ƒ-è®¢é˜…çš„ apiã€‚</p><h5 id="Wait-For-Pre-Existing-RCU-Readers"><a href="#Wait-For-Pre-Existing-RCU-Readers" class="headerlink" title="Wait For Pre-Existing RCU Readers"></a>Wait For Pre-Existing RCU Readers</h5><p>RCU è¯»åŒºåŸŸè¢«ç§°ä¸º RCU read-side critical sectionï¼Œç”± <code>rcu_read_lock</code> å’Œ <code>rcu_read_unlock</code>:</p><p><img src="https://image.mwish.me/blog-image/48ABD729-5EBE-4CD4-A71C-AEF661EF9CF5.png" alt="48ABD729-5EBE-4CD4-A71C-AEF661EF9CF5"></p><p><code>synchronize_rcu</code> ä¼šåœ¨å‘å¸ƒä¹‹åï¼Œç­‰å¾…ä¹‹å‰çš„è¯»è€…å®Œæˆã€‚è¿™é‡Œæˆ‘ä»¬èŠåˆ°äº† context switchã€‚è€Œ <code>DoublyBuffer</code> å¯èƒ½ä¼šç”¨ lock å’Œ cv æ¥åšï¼Œè¯­ä¹‰ä¸Šæ˜¯å·®ä¸å¤šçš„ã€‚</p><h5 id="Maintain-Multiple-Versions-of-Recently-Updated-Objects"><a href="#Maintain-Multiple-Versions-of-Recently-Updated-Objects" class="headerlink" title="Maintain Multiple Versions of Recently Updated Objects"></a>Maintain Multiple Versions of Recently Updated Objects</h5><p>è¿™é‡Œä¹‹å‰ä¸¾çš„ä¾‹å­éƒ½æ˜¯å•ä¸ªå€¼çš„ä¾‹å­ï¼Œå®é™…ä¸Šï¼Œå¹¶å‘çš„å†™ä¹Ÿæ˜¯å¯è¡Œçš„ï¼Œåªè¦èƒ½ç»´æŠ¤å¤šä¸ªç‰ˆæœ¬ã€‚</p><p>å½“ç„¶ï¼Œè¿™é‡Œå¯èƒ½è¦å’Œåˆ«çš„æ–¹æ³•ç»“åˆï¼Œå¦‚å›¾ 9.15ï¼Œè¿™é‡Œ RCU ä¸ä¼šä¿è¯ã€Œè¯»åˆ°ä¸€è‡´æ€§å¿«ç…§ã€ï¼š</p><p><img src="https://image.mwish.me/blog-image/C2794F61-0FD2-4975-953C-152CEEDD10F3.png" alt="C2794F61-0FD2-4975-953C-152CEEDD10F3"></p><p>å½“ç„¶ï¼Œå¾ˆå¤š RCU ä½¿ç”¨çš„æƒ…å†µæ˜¯ point getï¼Œåœ¨ point get ä¸‹ï¼Œè¿™ç§æƒ…å†µé€šå¸¸æ˜¯å¯ä»¥å®¹å¿çš„ï¼Œå¦‚æ–‡ç« æ‰€è¿°ï¼š</p><blockquote><p>In summary, maintaining multiple versions is exactly what enables the extremely low overheads of RCU readers, and as noted earlier, many algorithms are unfazed by multiple versions. However, there are algorithms that absolutely cannot handle multiple versions. There are techniques for adapting such algorithms to RCU [McK04], but these are beyond the scope of this section.</p></blockquote><h4 id="Kernel-çš„-RCU-API"><a href="#Kernel-çš„-RCU-API" class="headerlink" title="Kernel çš„ RCU API"></a>Kernel çš„ RCU API</h4><p>Linux å¹¶ä¸æ˜¯æœ‰ä¸€ä¸ª RCU APIï¼Œè€Œæ˜¯æœ‰ä¸€ç»„â€¦Paul åœ¨ LWN å†™è¿‡ï¼š<a href="https://lwn.net/Articles/777036/">https://lwn.net/Articles/777036/</a></p><p>è¿™é‡Œè¿˜æä¾›äº† callback å’Œ barrier ç›¸å…³çš„å†…å®¹ï¼Œå¦‚ï¼š</p><blockquote><p>The asynchronous update-side primitive, call_rcu(), invokes a speciï¬ed function with a speciï¬ed argument after a subsequent grace period. For example, call_rcu(p,f); will result in the â€œRCU callbackâ€ f(p) being invoked after a subsequent grace period. There are situations, such as when unloading a Linux-kernel module that uses call_rcu(), when it is necessary to wait for all outstanding RCU callbacks to complete [McK07e]. The rcu_barrier() primitive does this job.</p></blockquote><p>é™¤äº†ç»å…¸çš„æˆ‘ä»¬åˆšæ‰ä»‹ç»çš„ä¸€äº› APIï¼Œè¿™é‡Œè¿˜æœ‰ <code>srcu</code>, <code>s</code> å³ sleepableï¼Œå®ƒä½¿ç”¨ç±»ä¼¼ blocking api æ¥å®ç° rcu æœºåˆ¶ã€‚</p><p>æ­¤å¤–ï¼ŒRCU è¿˜æœ‰å„ç§ list æœ‰å…³çš„ APIã€‚</p><h4 id="RCU-Usage"><a href="#RCU-Usage" class="headerlink" title="RCU Usage"></a>RCU Usage</h4><p><a href="https://lwn.net/Articles/263130/">https://lwn.net/Articles/263130/</a> è¿™é‡Œå°æ ‡é¢˜ç‰¹åˆ«å¥½ï¼š</p><ol><li><a href="https://lwn.net/Articles/263130/#RCU is a Reader-Writer Lock Replacement">RCU is a Reader-Writer Lock Replacement</a></li><li><a href="https://lwn.net/Articles/263130/#RCU is a Restricted Reference-Counting Mechanism">RCU is a Restricted Reference-Counting Mechanism</a></li><li><a href="https://lwn.net/Articles/263130/#RCU is a Bulk Reference-Counting Mechanism">RCU is a Bulk Reference-Counting Mechanism</a></li><li><a href="https://lwn.net/Articles/263130/#RCU is a Poor Man&#39;s Garbage Collector">RCU is a Poor Manâ€™s Garbage Collector</a></li><li><a href="https://lwn.net/Articles/263130/#RCU is a Way of Providing Existence Guarantees">RCU is a Way of Providing Existence Guarantees</a></li><li><a href="https://lwn.net/Articles/263130/#RCU is a Way of Waiting for Things to Finish">RCU is a Way of Waiting for Things to Finish</a></li></ol><p>è¿˜æœ‰å„ç§ performance å›¾ï¼Œç›´æ¥çœ‹å°±æ˜¯äº†ã€‚</p><h3 id="Which-to-Choose"><a href="#Which-to-Choose" class="headerlink" title="Which to Choose?"></a>Which to Choose?</h3><p><img src="https://image.mwish.me/blog-image/6567DA82-6B70-40C4-AF96-3ED5E95BBC77.png" alt="6567DA82-6B70-40C4-AF96-3ED5E95BBC77"></p><p>åœ¨ folly çš„ hazptr ä¹Ÿå†™äº†ä¸€ä¸‹è¿™äº›å…·ä½“çš„åŒºåˆ«ï¼š<a href="https://github.com/facebook/folly/blob/main/folly/synchronization/Hazptr.h">https://github.com/facebook/folly/blob/main/folly/synchronization/Hazptr.h</a></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>perfbook notes: parallel, mutex, fastpath</title>
      <link href="/2022/05/04/perfbook-notes-parallel-mutex-fastpath/"/>
      <url>/2022/05/04/perfbook-notes-parallel-mutex-fastpath/</url>
      
        <content type="html"><![CDATA[<p>åœ¨ä»‹ç»å®Œç¡¬ä»¶åï¼Œperfbook ç”¨ scalable-counter ä¸ºä¾‹å­ï¼Œä»‹ç»äº†å¹¶å‘æ•°æ®ç»“æ„çš„è®¾è®¡ã€‚è¿™é‡Œé¢æœ‰ä¸€äº›å¤§æ¦‚çš„è¦ç‚¹ï¼š</p><ol><li>Partition<ol><li>æ ¹æ® Core æˆ–è€…çº¿ç¨‹æ¥ Partitionã€‚æ¯”å¦‚ counterã€allocatorã€‚<code>malloc()</code> å’Œ <code>inc()</code> å¯èƒ½ä¸æŒ‡å®šå…·ä½“çš„ keyï¼Œå› æ­¤è¿™ä¸ªèµ„æºå¯ä»¥æ± åŒ–ï¼Œç»‘å®šåœ¨ CPUã€Thread ä¹‹ç±»çš„å¯¹è±¡ä¸Š</li><li>æ ¹æ® key æ¥ partitionã€‚<code>get(key)</code> æœ¬èº«å¯ä»¥åšä¸€äº› Partitionï¼Œæ¥ä¿è¯ç²’åº¦</li></ol></li><li>Fastpathã€Slowpath å’Œå¼€é”€<ol><li>ç†æƒ³æƒ…å†µä¸‹ï¼Œæ‰€æœ‰æ“ä½œå¼€é”€éƒ½å¾ˆä½ï¼Œä½†æ˜¯ä¸å¯èƒ½ï¼Œæ‰€ä»¥è¦æœ‰ä¸ª trade-off</li><li>ã€Œå¼€é”€ã€å¯ä»¥æ ¹æ®æ“ä½œçš„ç²’åº¦æ¥æƒè¡¡ï¼Œä¸èƒ½è¯´ã€Œé”æ“ä½œå¾ˆé‡ã€ã€Œatomic å¾ˆè½»ã€å°±è¡Œï¼Œè€Œè¦å¯¹æ¯”ä¸´ç•ŒåŒºã€æ‰§è¡Œ Path çš„å†…å®¹å’Œæ‰§è¡Œæ—¶é—´ï¼Œæ¥è€ƒé‡è¿™ä¸ªå¼€é”€æ˜¯ä¸æ˜¯è¿‡å¤§ã€‚</li><li>å¯ä»¥åŒºåˆ† Fastpath å’Œ Slowpathï¼Œå¾ˆå°‘æƒ…å†µæ‰§è¡Œ</li></ol></li><li>Batching<ol><li>å°†æ“ä½œæ‰¹é‡å¤„ç†</li></ol></li></ol><p>è¿™é‡Œå…ˆç”¨ <code>counting</code> åšäº†ä¸€ä¸ªå…¥é—¨ä»‹ç»ï¼Œç„¶åå¼•å…¥äº† Paritition/Synchronize Designï¼Œæœ€åä»‹ç»äº†ä¸€äº› Locking å’Œ Locking ç›¸å…³çš„è®¾è®¡ã€‚</p><h2 id="Counting"><a href="#Counting" class="headerlink" title="Counting"></a>Counting</h2><p>Scalable Counting æ˜¯ä¸€ä¸ªæ¯”è¾ƒå¼€æ”¾çš„é—®é¢˜ï¼Œè¿™é‡Œåˆ—ä¸¾äº†ä¸‹é¢çš„éœ€æ±‚ï¼š</p><ol><li>Statistics</li><li>Approximate limit / Exact limit</li><li>Ref-count</li></ol><p>æœ€æœ´ç´ çš„æ€è·¯å½“ç„¶æ˜¯ <code>std::atomic&lt;uint64_t&gt;</code> ä¸€æŠŠæ¢­ã€‚ä½†æ˜¯å®ƒä¸æ˜¯ scalable çš„ï¼Œå›é¡¾ä¸€ä¸‹æˆ‘ä»¬ä¸Šä¸€èŠ‚æè¿°çš„ï¼Œå¯èƒ½å®ƒè¦ä¿è¯æ“ä½œçš„æ—¶å€™ï¼Œæ•°æ®ç”±ä½ çš„ Cacheline ä¿æŠ¤ï¼š</p><p><img src="https://image.mwish.me/blog-image/28AFE9DD-5AFE-4E26-B965-00AEEE83CF9E.png" alt="28AFE9DD-5AFE-4E26-B965-00AEEE83CF9E"></p><p><img src="https://image.mwish.me/blog-image/1D331DF5-8280-4232-A5B6-EAF9995CCB4F.png" alt="1D331DF5-8280-4232-A5B6-EAF9995CCB4F"></p><p>è¿™é‡Œå°±æœ‰ä¸ªä¸¥è‚ƒçš„åŒæ­¥é—®é¢˜ã€‚è€Œä¸”å¯èƒ½æ˜¯è·¨ socket çš„ã€‚å½“ç„¶å¯ä»¥ä¿è¯è¿™é‡Œçš„ç»Ÿè®¡ä¿¡æ¯æ˜¯å‡†çš„ã€‚è¿™é‡Œä¸‹é¢æœ‰å‡ ç§ counter :</p><ol><li>statistical counter: ç»Ÿè®¡ï¼Œè®¡ç®—æ€»å’Œï¼Œå¾ˆå¯èƒ½ä¸å‡†ï¼Œä½†éå¸¸é«˜æ•ˆ</li><li>Approximate Limit Counters: å°‘è®¸è¶…è¿‡ limit é™åˆ¶ä¹Ÿå¯ä»¥</li><li>Exact Limit Counters: ä¸å…è®¸è¶…è¿‡é™åˆ¶</li></ol><p>è¿™é‡Œç¨‹åºç”¨äº† Per-CPUï¼Œè¿™ä¸ªåœ¨å†…æ ¸å…¶å®ä¸éš¾åšï¼Œåœ¨ç”¨æˆ·æ€çš„è¯ï¼Œå¯ä»¥å‚è€ƒ <code>TCMalloc</code> ç”¨çš„ <code>rseq(2)</code>ï¼š</p><ol><li><a href="https://www.efficios.com/blog/2019/02/08/linux-restartable-sequences/">https://www.efficios.com/blog/2019/02/08/linux-restartable-sequences/</a></li><li><a href="https://google.github.io/tcmalloc/rseq.html">https://google.github.io/tcmalloc/rseq.html</a></li></ol><p>ç›¸å¯¹äº Per-CPUï¼Œä¸€äº›åœ°æ–¹ä¼šä½¿ç”¨ Per-Thread çš„ç¨‹åºã€‚perfbook ä»‹ç»äº†ä¸ºä»€ä¹ˆæ²¡æœ‰æä¾› Per-Thread è®¾æ–½ï¼š</p><blockquote><p>A key limitation that the Linux kernel imposes is a compile-time maximum bound on the number of CPUs, namely, <code>CONFIG_NR_CPUS</code>, along with a typically tighter boot-time bound of <code>nr_cpu_ids</code>. In contrast, in user space, there is not necessarily a hard-coded upper limit on the number of threads.</p></blockquote><p>ä¸€èˆ¬çš„ç”¨æˆ·ç¨‹åºå¯èƒ½ä¼šç”¨ Doubly List æ¥æŒ‚ä¸€äº›ç»Ÿè®¡ä¿¡æ¯ã€‚</p><h3 id="statistical-counter"><a href="#statistical-counter" class="headerlink" title="statistical counter"></a>statistical counter</h3><p>ä¸€ç§æ–¹å¼æ˜¯ï¼Œç”¨ Per-CPU æˆ–è€…<strong>å›ºå®š</strong>å¤§å°çš„ Arrayï¼Œç„¶åæ¯ä¸ªçº¿ç¨‹/CPU ç”¨ <code>WRITE_ONCE</code> å†™æœ¬åœ° counterï¼Œè¯»çš„æ—¶å€™è¯»èµ·æ¥æ‰€æœ‰çš„ counterã€‚è¿™ä¸ªåœ°æ–¹ç»Ÿè®¡ä¸ä¸€å®šå®Œå…¨å‡†ç¡®ï¼Œå› ä¸ºç»Ÿè®¡çš„æ—¶å€™å¯èƒ½ counter è¿˜ä¼šå¢åŠ ã€‚è¿™ç§æ–¹æ³•å‡ ä¹æ˜¯ Linear scalable çš„ï¼Œä½†æ˜¯å—é™äº <strong>å›ºå®šå¤§å°</strong>ã€‚</p><p>Counter å¯èƒ½å¯ä»¥æ ¹æ® TLS æ¥å®ç°ã€‚<code>inc</code> å¯¹åº”çš„æ“ä½œåº”ç”¨åœ¨ <code>TLS</code> ä¸Šï¼Œçº¿ç¨‹é”€æ¯çš„æ—¶å€™ï¼Œä¼šè·å– <code>lock</code>, ç„¶åæŠŠæ“ä½œæŒ‚é åœ¨ <code>global_count</code> ä¸Šã€‚è¯»å–çš„æ—¶å€™ï¼Œéœ€è¦è¯»å– æ¯ä¸ªçº¿ç¨‹çš„ count + <code>global_count</code>ã€‚è¿™é‡Œå…·ä½“ä»£ç å¦‚ä¸‹ï¼š<a href="https://github.com/paulmckrcu/perfbook/blob/master/CodeSamples/count/count_tstat.c">https://github.com/paulmckrcu/perfbook/blob/master/CodeSamples/count/count_tstat.c</a></p><p>è¿™é‡Œæœ‰ä¸€ä¸ªå°ç“¶é¢ˆåœ¨äºï¼Œè¯»å– <code>global_count</code> å¯èƒ½éœ€è¦é”ã€‚çº¿ç¨‹é”€æ¯ä¹Ÿéœ€è¦é”ï¼Œè¿™ä¸ªæ˜¯<strong>å‡†ç¡®çš„ï¼Œä½†æ˜¯ä¸ scalable</strong>ã€‚è¿™é‡Œå¯ä»¥è€ƒè™‘ <strong>Eventual consistency</strong>ï¼Œè¾¾åˆ°æœ€ç»ˆä¸€è‡´æ€§å³å¯ï¼š<a href="https://github.com/paulmckrcu/perfbook/blob/master/CodeSamples/count/count_stat_eventual.c">https://github.com/paulmckrcu/perfbook/blob/master/CodeSamples/count/count_stat_eventual.c</a></p><p>è¿™é‡Œå¼•å…¥äº†ä¸€ä¸ª<strong>é¢å¤–çš„çº¿ç¨‹</strong>æ¥å¤„ç†æ•°æ®ï¼Œè¯»çš„æ—¶å€™åªéœ€è¦è¯»å– <code>global_count</code>ï¼Œå†™ä¹Ÿåªè¦ç›´æ¥å†™ï¼Œé¢å¤–çš„çº¿ç¨‹ä¼šå®šæœŸæŠŠå€¼åˆå¹¶åˆ° <code>global_count</code>.</p><p>è¿™äº›å®ç°èƒ½å¤Ÿç‰ºç‰²å‡†ç¡®æ€§ï¼Œä½†æ˜¯æä¾›è¿‘çº¿å½¢çš„å¯æ‰©å±•æ€§ã€‚</p><h3 id="Approximate-Limit-Counters"><a href="#Approximate-Limit-Counters" class="headerlink" title="Approximate Limit Counters"></a>Approximate Limit Counters</h3><blockquote><p>Suppose further that these structures are short-lived, that this limit is rarely exceeded, and that this limit is approximate in that it is OK to exceed it sometimes by some bounded amount.</p></blockquote><p>è¿™é‡Œä¼šæœ‰é¢‘ç¹çš„ <code>inc(size)</code> å’Œ <code>dec(size)</code> æ“ä½œï¼Œå¸Œæœ›ä¸è¦è¶Šç•Œè¿‡äºç¦»è°±ã€‚</p><p>ä¸€ä¸ªç®€å•çš„æƒ³æ³•æ˜¯ï¼Œæ¯”å¦‚è®¡æ•°æ˜¯ 10000ï¼Œæœ‰ 100 ä¸ªçº¿ç¨‹ï¼Œå°±æ¯ä¸ª 100 ä¸ªã€‚ä½†æ˜¯è¿™å¯¹ä»»ä½•æœ‰ skew çš„ workload éƒ½å¤ªåƒåœ¾äº†ã€‚è¿™é‡Œæœ‰ä¸€ä¸ªæ–¹æ³•ï¼Œæ˜¯ä¸Šé¢ä¸€ä¸ªæ–¹æ³•çš„ä¿®æ”¹ç‰ˆï¼š</p><ol><li>æ­£å¸¸åˆ†é…çš„æ—¶å€™ï¼Œæ¯ä¸ªçº¿ç¨‹ä¼šæœ‰ä¸€éƒ¨åˆ†å‰©ä½™çš„ <code>counter</code> åˆ†é…å™¨ï¼Œå®ƒæœ‰ <code>countermax</code> å’Œ <code>counter</code>ã€‚æ­£å¸¸æƒ…å†µï¼ˆfast path) ä¼š <code>++counter</code>ï¼Œç„¶åä¿è¯ <code>counter &lt; countermax</code></li><li>(Slow path): å¦‚æœ <code>counter == countermax</code>ï¼Œé‚£ä¹ˆè¿™é‡Œä¼šæŠŠ <code>counter</code> ä¸­çš„ä¸€åŠç§»åŠ¨ç»™ <code>globalcount</code>ï¼Œå†å›åˆ° (1). è¿™é‡Œè¿˜æ¶‰åŠåˆ°ä¸€ä¸ªé™åˆ¶ï¼Œæˆ‘ä»¬ä¼šæœ‰ <code>globalcountmax</code>, å¦‚æœ <code>globalcount</code> è¶…è¿‡äº† maxï¼Œé‚£ä¹ˆè®¡æ•°å™¨å°±æº¢å‡ºäº†ã€‚</li><li>(slow path): å¦‚æœ <code>counter == 0</code>, ä¸”è¿˜éœ€è¦å‡å°‘ï¼Œç±»ä¼¼ (2)ï¼Œä» <code>globalcount</code> æ¥ Steal.</li></ol><p><img src="https://image.mwish.me/blog-image/AE328AD5-DBF0-4D0A-B31A-9FDA957675F4.png" alt="AE328AD5-DBF0-4D0A-B31A-9FDA957675F4"></p><p>å…·ä½“ä»£ç ï¼š<a href="https://github.com/paulmckrcu/perfbook/blob/master/CodeSamples/count/count_lim_app.c">https://github.com/paulmckrcu/perfbook/blob/master/CodeSamples/count/count_lim_app.c</a></p><p>è¿™é‡Œåœ¨ add, sub çš„æ—¶å€™å¯èƒ½ä¼šæœ‰è¶…é™åˆ¶çš„æƒ…å†µã€‚å¯¼è‡´æ— æ³•æ¨è¿›ã€‚ä¸ºä»€ä¹ˆå‘¢ï¼Ÿè¿™é‡Œå¯èƒ½ä¼šæœ‰èƒ½åˆ†é…ï¼Œä½†æ˜¯å®é™…ä¸Šåˆ†é…ä¸å‡ºçš„æƒ…å†µï¼š</p><p><img src="https://image.mwish.me/blog-image/C3AA88D1-78AC-46A8-BF6C-060C7549F7FC.png" alt="C3AA88D1-78AC-46A8-BF6C-060C7549F7FC"></p><p>è¿™é‡Œï¼Œ<code>0</code> éœ€è¦å¢åŠ ï¼Œä½†æ˜¯å¯èƒ½åˆ«çš„ <code>countermax</code> è¿˜æœ‰å‰©ä½™ï¼Œä½†æ˜¯å®ƒç”³è¯·ä¸å‡ºæ¥äº†ã€‚</p><h3 id="Exact-Limit-Counters"><a href="#Exact-Limit-Counters" class="headerlink" title="Exact Limit Counters"></a>Exact Limit Counters</h3><p>å¦‚æœè¦èƒ½å‡†ç¡®åˆ†é…ï¼Œè¿™å¿…å®šæ¶‰åŠ slowpath ä¸‹å‘åˆ«çš„ counter ç´¢è¦å†…å®¹ã€‚è¿™ä¸ªå°±æ¶‰åŠè·¨çº¿ç¨‹äº¤äº’äº†ï¼Œè¿™é‡Œæä¾›äº†ä¸¤ç§æ–¹æ¡ˆã€‚æ–¹æ¡ˆ1æ˜¯å…¨éƒ¨èµ°åŸå­æŒ‡ä»¤ï¼š</p><ul><li><a href="https://github.com/paulmckrcu/perfbook/blob/master/CodeSamples/count/count_lim_atomic.c">https://github.com/paulmckrcu/perfbook/blob/master/CodeSamples/count/count_lim_atomic.c</a></li></ul><p>è¿™ä¸ªçš„ <code>read_count</code> ä¸ä¸€å®šå®Œå…¨å‡†ï¼Œä½†æ˜¯ä¸Šçº¿å’Œä¸‹ç•Œéƒ½æ˜¯å‡†ç¡®çš„ï¼Œç¼ºç‚¹æ˜¯æ‰€æœ‰å†™æ“ä½œåŸºæœ¬éƒ½æ˜¯ä¸ª CASã€‚</p><p>è¿™é‡Œè¿˜ç”¨ä¿¡å·å’ŒçŠ¶æ€æœºåšäº†ä¸ªæ¯”è¾ƒå¤æ‚çš„ç³»ç»Ÿï¼Œå¤§æ¦‚æ€è·¯æ˜¯ï¼š</p><ol><li>æœ¬çº¿ç¨‹çš„æ·»åŠ æ˜¯ <code>WRITE_ONCE</code> åŸå­å³å¯ï¼ˆç±»æ¯”äº <code>relaxed</code> ï¼‰</li><li>Slowpath éœ€è¦èµ° <code>pthread_kill</code>ï¼Œåˆ«çš„çº¿ç¨‹æ”¶åˆ°ä¿¡å·åï¼Œä¼šè‡ªå·±æäº¤ä¿¡æ¯</li><li>å› ä¸ºä¿¡å·æ˜¯å¯é‡å…¥çš„ï¼Œæ‰€ä»¥éœ€è¦å†™ä¸€ä¸ªå¾ˆå¤æ‚çš„çŠ¶æ€æœºï¼Œå¦‚ä¸‹å›¾ï¼š</li></ol><p><img src="https://image.mwish.me/blog-image/7C9EAE64-1FBE-4A4C-AEBD-768E34E0E202.png" alt="7C9EAE64-1FBE-4A4C-AEBD-768E34E0E202"></p><h3 id="è®¨è®º"><a href="#è®¨è®º" class="headerlink" title="è®¨è®º"></a>è®¨è®º</h3><p><img src="https://image.mwish.me/blog-image/34EEB050-4CC0-4255-A116-376142A6C045.png" alt="34EEB050-4CC0-4255-A116-376142A6C045"></p><ol><li>Partitioning promotes performance and scalability.</li><li>Partial partitioning, that is, partitioning applied only to common code paths, works almost as well.</li><li>Batch Updates</li><li>Read-only code paths should remain read-only: Spurious synchronization writes to shared memory kill performance and scalability, as seen in the count_end.c row of Table 5.1. ï¼ˆè®°å¾—æˆ‘ä»¬çš„ eventual å—ï¼Ÿï¼‰</li><li>Parallel performance and scalability is usually a balancing act: Beyond a certain point, optimizing some code paths will degrade others.</li><li>Diï¬€erent levels of performance and scalability will aï¬€ect algorithm and data-structure design, as do a large number of other factors. Figure 5.1 illustrates this point: Atomic increment might be completely acceptable for a two-CPU system, but be completely inadequate for an eight-CPU system.</li></ol><p>åé¢åˆæ€»ç»“äº†ä¸‰ç‚¹ï¼š</p><p>(1) partitioning over CPUs or threads, (2) batching so that more work can be done by each expensive synchronization operations, and (3) weakening synchronization operations where feasible.</p><h2 id="Partition-and-Synchronization-Design"><a href="#Partition-and-Synchronization-Design" class="headerlink" title="Partition and Synchronization Design"></a>Partition and Synchronization Design</h2><p>è¿™é‡Œä»‹ç»çš„æ˜¯ Partition ç›¸å…³çš„è®¾è®¡ã€‚ä»‹ç»äº†å“²å­¦å®¶ç”¨é¤é—®é¢˜å’ŒåŒç«¯é˜Ÿåˆ—ã€‚è¿™é‡Œæœ‰å‡ ä¸ªè¦è€ƒé‡çš„ç‚¹ï¼š</p><ol><li>performance</li><li>scalability</li><li>response time</li></ol><p>å¯¹äºå“²å­¦å®¶è¿›é¤é—®é¢˜ï¼Œå¾ˆå¤šåœ°æ–¹ä¼šè€ƒè™‘ Dijkstra çš„ç¼–å·ç®—æ³•ã€‚è¿™é‡Œæœ‰ä¸€ä¸ªé—®é¢˜æ˜¯è¿™ä¸ªç®—æ³•å¯èƒ½æœ‰æ´»é”ï¼Œå¯èƒ½çœŸçš„æ²¡äººåœ¨æ¨è¿›ã€‚ä¸€ç§å¯é çš„æ–¹å¼æ˜¯å›ºå®šè°æ‹¿ä»€ä¹ˆå‰å­ï¼Œç›´æ¥ scalable äº†ã€‚</p><p>å¦ä¸€ä¸ªé—®é¢˜æ˜¯åŒç«¯é˜Ÿåˆ—ã€‚å¯¹äº Compound Double-Ended Queueï¼Œè¿™é‡Œç±»ä¼¼ Btree çš„ iteratorï¼Œä¼šè§„å®šä¸€ä¸ªè·å–é”çš„æ–¹å‘ï¼š</p><p><img src="https://image.mwish.me/blog-image/12F8C1A4-EEE5-44F3-8CE6-993E5F0DA147.png" alt="12F8C1A4-EEE5-44F3-8CE6-993E5F0DA147"></p><p>è·å–é”çš„æ–¹å‘éƒ½æ˜¯ å·¦-&gt;å³ï¼Œå¦‚æœå³å‘å·¦å‰è¿›ï¼Œéœ€è¦å…ˆé‡Šæ”¾è‡ªå·±çš„é”ï¼Œæ‹¿åˆ°å·¦è¾¹ï¼Œå† grab å›æ¥ï¼ˆæ„Ÿè§‰è¿™è¿˜æ¶‰åŠ data-ownership çš„é—®é¢˜ï¼Œå“â€¦ï¼‰ã€‚</p><p>å…³äºè¿™ç§é˜Ÿåˆ—ï¼Œè¿˜æœ‰ä¸€ä¸ªæœ€å…ˆæ’å…¥ä¸€äº›å…ƒç´ çš„é—®é¢˜ï¼Œä¹Ÿå°±æ˜¯é˜Ÿåˆ—æ˜¯ç©ºçš„ã€åªæœ‰ä¸€ä¸ªå…ƒç´ çš„æ—¶å€™åº”è¯¥æ€ä¹ˆæ“ä½œã€‚å‚è€ƒï¼š<a href="https://github.com/paulmckrcu/perfbook/blob/46ff2e75ea1b645dabc7405884ddf666f94b4b07/CodeSamples/SMPdesign/locktdeq.c">https://github.com/paulmckrcu/perfbook/blob/46ff2e75ea1b645dabc7405884ddf666f94b4b07/CodeSamples/SMPdesign/locktdeq.c</a></p><p>è¿™é‡Œåšçš„è¿˜æ˜¯æ¯”è¾ƒ hack çš„ã€‚æœ‰ä¸€ä¸ªè®¨è®ºæ˜¯å…³äºè¿™ä¸ª queue çš„è¯­ä¹‰ï¼ˆå¦‚æœä½ å†™ Rustï¼Œå…¶å®ä¼šè§åˆ°ä»€ä¹ˆ mpmc ä¹‹ç±»çš„ï¼Œæˆ–è€…ä¸€äº› Linearizable ä¹‹ç±»çš„ï¼‰ï¼š</p><blockquote><p>In fact, as noted by Dice et al. [DLM + 10], an unsynchronized single-threaded double-ended queue signiï¬cantly outperforms any of the parallel implementations they studied.</p><p>Furthermore, these strict FIFO queues are strictly FIFO only with respect to linearization points [HW90]  that are not visible to the caller, in fact, in these examples, the linearization points are buried in the lock-based critical sections.</p><p>All that said, if you are pushing all the data used by your concurrent program through a single queue, you really need to rethink your overall design.</p></blockquote><h3 id="Design-Criteria"><a href="#Design-Criteria" class="headerlink" title="Design Criteria"></a>Design Criteria</h3><p>è¿™é‡Œè€ƒè™‘çš„æ˜¯ä¸€äº›å¹¶å‘çš„è®¾è®¡åŸåˆ™ï¼Œå…¶å®è¿˜æ˜¯æ¯”è¾ƒé‡è¦çš„ã€‚åŒ…æ‹¬ä¸´ç•ŒåŒºå¤§å°ï¼Œå¯¹ä»€ä¹ˆä¸Šé”ä¹‹ç±»çš„ã€‚ä»¥å‰æˆ‘ç¡®å®åªä¼šè§‰å¾—ã€Œxxå¹¶å‘å¥½ã€ã€Œxxæœ‰ç“¶é¢ˆã€ï¼Œä½†æ˜¯æ²¡æœ‰æ¯”è¾ƒç»†çš„æ€è€ƒè¿™äº›é—®é¢˜ã€‚</p><p>ç¬¬ä¸€ä¸ªæ˜¯ä»€ä¹ˆè®©ä½ ç«Ÿç„¶éœ€è¦å¹¶å‘ï¼Œå¯èƒ½æ˜¯ï¼š</p><ol><li>Speedup (è¿™é‡Œè€ƒè™‘é˜¿å§†è¾¾å°”å®šå¾‹)</li><li>Contention: CPU æ•°é‡ä¸Šæ¥ä¹‹åï¼Œä¼šä¸ä¼šæœ‰ Lock/Memory ç­‰èµ„æºçš„ç«äº‰</li><li>Work-to-Synchronization Ratio: å¹¶å‘å¯èƒ½æœ‰ message latency, locking primitives, atomic instructions, memory barrier çš„å¼€é”€ã€‚å¦‚æœä¸´ç•ŒåŒºä¹‹ç±»çš„é‡Œé¢çš„ä¸œè¥¿æ¯”åŒæ­¥å¼€é”€æ“ä½œé‡ï¼Œé‚£å°±å¯ä»¥ï¼ˆ for example: <a href="https://github.com/apache/incubator-brpc/issues/363ï¼‰">https://github.com/apache/incubator-brpc/issues/363ï¼‰</a></li><li>Read-to-Write Ratio: A data structure that is rarely updated may often be replicated rather than partitioned</li><li>Complexity: å¯èƒ½å¹¶è¡Œçš„ç¨‹åºä¼šå¤æ‚å¾ˆå¤šï¼Œå…¶å®ä¸€ä¸ªå·¥ä¸šç•Œå¾ˆè´´è¿‘çš„ä¾‹å­å°±æ˜¯ Redisï¼Œå¯ä»¥è€ƒè™‘ä¸€ä¸‹ç»™ Redis å¢åŠ å¹¶è¡Œä¹‹åä¼šæœ‰ä»€ä¹ˆé—®é¢˜</li></ol><p><img src="https://image.mwish.me/blog-image/824F4B98-460F-4941-8B38-CA14CAA45F52.png" alt="824F4B98-460F-4941-8B38-CA14CAA45F52"></p><h3 id="Synchronization-Granularity"><a href="#Synchronization-Granularity" class="headerlink" title="Synchronization Granularity"></a>Synchronization Granularity</h3><p>å¦‚æœç¨‹åºå…¨æ˜¯ä¸²è¡Œçš„ï¼Œé‚£ä¹ˆåµç²’åº¦éƒ½æ²¡æœ‰ï¼Œä¸è¿‡ï¼š</p><p><img src="https://image.mwish.me/blog-image/0A3C39FC-F2C3-40CD-A690-36F9A0F9913E.png" alt="0A3C39FC-F2C3-40CD-A690-36F9A0F9913E"></p><p>ï¼ˆæˆ‘è§‰å¾—å¾ˆåæˆ‘ä½œä¸ºä¸€ä¸ª 16 å¹´æ‰å­¦è®¡ç®—æœºçš„äººçš„ç›´è§‰å°±æ˜¯ï¼Œä¸æ”¹ä»£ç ç¨‹åºç«Ÿç„¶ä¼šè¶Šè·‘è¶Šå¿«â€¦å¯èƒ½è¿™å°±æ˜¯æ‘©å°”å®šå¾‹å§ï¼‰</p><p>æœ€å¸¸è§çš„æ–¹å¼è¢«è¿™é‡Œç§°ä¸º <strong>Code Locking</strong>ï¼Œå°±æ˜¯æˆ‘ä»¬æœ€å¸¸è§çš„ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">C::func</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="function">std::lock_guard&lt;std::mutex&gt; <span class="title">l</span><span class="params">(mu_)</span></span>;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯¹æ•´ä¸ªä»£ç æ®µä¸Šé”ã€‚</p><p>å¦ä¸€ç§è¢«ç§°ä¸º <strong>data locking</strong>:</p><blockquote><p>You should use data locking when contention must be reduced, and where synchronization overhead is not limiting speedups.</p></blockquote><p>è¿™é‡Œ lock å¯èƒ½ä¼šè¢«ç»‘å®šåœ¨æŸä¸ª <code>bucket</code> æˆ–è€…ç»“æ„ä¸Šï¼Œç±»ä¼¼åˆ†æ¡¶ hashingï¼Œæˆ–è€… Linux çš„ <code>dcache</code>ï¼Œå¯ä»¥å½“ä½œè¿™é‡Œæ¯” code locking æä¾›äº†æ›´ç»†çš„ç²’åº¦ï¼Œç»™æŸä¸ª <code>key</code> å¯¹åº”çš„ <code>bucket</code> æˆ–è€…æ›´ç»†çš„ç²’åº¦æä¾›é”å®šã€‚</p><p>è¿™é‡Œè¿˜æœ‰ä¸ª data ownership çš„é—®é¢˜ï¼Œæ¯”æ–¹è¯´ç»™æŸä¸ªçº¿ç¨‹/CPU åˆ’åˆ†ä¸€äº›æ•°æ®ã€‚è¿™ä¸ªçš„é—®é¢˜æ˜¯ï¼Œå›å¿†åˆ° countingï¼Œè¿™é‡Œè¦å¤„ç† skewã€hotspot å’Œä¸€äº›å¿…è¦çš„è·¨çº¿ç¨‹é€šä¿¡çš„é—®é¢˜ã€‚</p><h3 id="Parallel-Fastpath"><a href="#Parallel-Fastpath" class="headerlink" title="Parallel Fastpath"></a>Parallel Fastpath</h3><p>å¯¹äºå¹¶å‘æ¥è¯´ï¼Œè®¾è®¡ç»†ç²’åº¦çš„å¹¶å‘ç­–ç•¥å®é™…ä¸Šæ˜¯å¾ˆéš¾çš„ã€‚ä¸€ä¸ªç²—ç²’åº¦çš„å¹¶å‘ç»“æ„ä¼šè®©äººæƒ³åˆ°ã€Œä¸€æŠŠå¤§é”ã€ï¼Œè€Œç»†ç²’åº¦çš„ç»“æ„åˆ™å¯èƒ½ä»å„ç§ corner caseã€åŸè¯­ç”šè‡³åˆ°ä¸€äº›å†…å­˜å›æ”¶ç­–ç•¥ã€‚</p><p>fastpath æ€è·¯å…¶å®åœ¨ä¹‹å‰çš„ counter ç³»ç»Ÿä¸­å°±åŸºæœ¬æåˆ°äº†ï¼Œå°±æ˜¯åœ¨å¸¸è§„è·¯å¾„ä¸‹å¼€é”€å¾ˆå°ï¼Œåªæœ‰å¿…è¦çš„æ—¶å€™å¼•å…¥ä¸€äº›é‡çš„å¼€é”€ã€‚ä¸‹é¢æåˆ°äº†ä¸€äº›ä½¿ç”¨ fastpath çš„åœºæ™¯ï¼š</p><p><img src="https://image.mwish.me/blog-image/E39EA9B2-16C2-4AB7-818F-191C8D87BB12.png" alt="E39EA9B2-16C2-4AB7-818F-191C8D87BB12"></p><ul><li>Read-Write Locking: å½“<strong>åŒæ­¥å¼€é”€å¾ˆå°</strong> ï¼ˆä¾‹å¦‚åŒæ­¥ç›¸å¯¹äºä¸´ç•ŒåŒºéå¸¸å°ï¼Œè¿™ç‚¹å¾ˆé‡è¦ï¼‰çš„æ—¶å€™ï¼Œå¯ä»¥å¼•å…¥ reader-write lockingã€‚å½“ç„¶ï¼Œè¿™é‡Œæ²¡æœ‰æš—ç¤ºä»»ä½•å®ç°ï¼ˆRW Lock å¯èƒ½ä¼šæœ‰å„ç§å„æ ·çš„å®ç°ï¼‰</li><li>Hierarchical Locking: æœ‰ä¸€ä¸ª ç²—ç²’åº¦é” â€” ç»†ç²’åº¦é”çš„å±‚æ¬¡ã€‚è¿™é‡Œå¼•å…¥äº†å¤šä½™çš„é”ï¼Œä½†æ˜¯å‡å°äº†ä¸€å®šæƒ…å†µä¸‹çš„å†²çªã€‚å½“åœ¨ç»†ç²’åº¦é”ä¸Šæ“ä½œå…¶å®è¿˜æ¯”è¾ƒé‡çš„æ—¶å€™ï¼Œè¿™ç§æ–¹å¼å¹¶è¡ŒåŒ–äº†å®ƒçš„è®¿é—®ã€‚</li><li>Resource Allocator Caches: è¿™ä¸ª pattern é€šå¸¸æ˜¯é‚£ç§ä¸å…·åçš„èµ„æºï¼Œæœ‰ä¸€äº› per-CPU çš„èµ„æºï¼Œå’Œä¸€äº›å…¨å±€çš„èµ„æºã€‚å…·ä½“å¯ä»¥å‚è€ƒ <code>TCMalloc</code> ã€<code>JeMalloc</code> ã€<code>MiMalloc</code>ç”šè‡³ <code>PtMalloc</code>.</li></ul><p>æˆ‘å°±ä¸ä¸€ä¸€ä¸¾ä¾‹äº†ï¼Œè¿™é‡Œè¿˜æœ‰ä¸ª pool:</p><p><img src="https://image.mwish.me/blog-image/1E3AAC09-C5B8-42E7-9BBE-8888FB3DE74E.png" alt="1E3AAC09-C5B8-42E7-9BBE-8888FB3DE74E"></p><p>å½“ç„¶ï¼Œç°å®ä¸­çš„æ± å­å¯èƒ½ä¼šæœ‰å„ç§çš„ size-classï¼Œèƒ½å¤ŸæŠŠå†…å­˜è¿”å›ç»™ç³»ç»Ÿï¼ˆ<code>munmap</code> æˆ–è€… <code>sbrk</code> ç¼©å°ï¼‰ï¼Œè¿™é‡Œä¹Ÿä¸¾äº†ä¸€äº›å®é™…ä¸Šå¹¶å‘çš„ä¾‹å­ï¼Œä»–ä»¬é€šå¸¸æ˜¯æ··åˆçš„ï¼š</p><p><img src="https://image.mwish.me/blog-image/71BAD532-A9D2-4D47-84B9-A9074CA1C090.png" alt="71BAD532-A9D2-4D47-84B9-A9074CA1C090"></p><h2 id="Locking"><a href="#Locking" class="headerlink" title="Locking"></a>Locking</h2><p>Locking æ˜¯æœ€é€šç”¨çš„å¹¶å‘åŒæ­¥æ‰‹æ®µï¼Œå°½ç®¡å¯èƒ½ä¼šæœ‰ä¸‹é¢çš„é—®é¢˜ï¼š</p><blockquote><p>Locking stands accused of inciting deadlocks, convoying, starvation, unfairness, data races, and all manner of other concurrency sins. </p></blockquote><p>è¿™é‡Œæœ‰ä¸€äº› pattern:</p><ol><li>ä½¿ç”¨ lock hierarchy æ¥åšæ­»é”é¿å…</li><li>ç”¨å·¥å…·æ¥æ£€æµ‹æ­»é”</li><li>ç”¨ä¸€äº›å¯¹ locking çš„æ¨¡å¼å¾ˆå‹å¥½çš„æ•°æ®ç»“æ„</li><li>ä½¿ç”¨ä¸€äº›ä¸Šé¢ä»‹ç»çš„ partition æ¥å‡å°‘ lock contention</li><li>å’Œåˆ«çš„å·¥å…·åè°ƒï¼Œåªåœ¨ slowpath ç­‰åœ°æ–¹ä½¿ç”¨ lock ç”šè‡³é¿å… lock</li><li>å¥½å¥½åœ° bench lock æ˜¯ä¸æ˜¯çœŸæœ‰é—®é¢˜ï¼Œä¼šä¸ä¼šå½±å“ä½ ï¼ˆæœ‰ä¸€äº›æµ‹ contention çš„å·¥å…·ä»€ä¹ˆçš„ï¼‰</li></ol><h3 id="æ­»é”é¿å…å’Œ-Lock-Hierarchy"><a href="#æ­»é”é¿å…å’Œ-Lock-Hierarchy" class="headerlink" title="æ­»é”é¿å…å’Œ Lock Hierarchy"></a>æ­»é”é¿å…å’Œ Lock Hierarchy</h3><p>æ­»é”å’Œæ´»é”ä¸€ç›´æ˜¯æ¯”è¾ƒè®©äººå¤´ç–¼çš„é—®é¢˜ï¼Œå°¤å…¶æ˜¯ï¼Œå¦‚æœä½ è·‘åœ¨ä¸€ä¸ª stackless coroutine ä¸Šï¼Œé‚£ä½  debug éƒ½ä¼šè¦é ä¸€äº› user-space çš„ lockingï¼ŒæŠŠäººæ•´åã€‚</p><p>Locking Hierarchies æè¿°çš„æ˜¯é”çš„å±‚çº§ã€è·å–é”çš„é¡ºåºã€‚æ¯”å¦‚å…ˆæ‹¿å¤§é” -&gt; æ‹¿ç»†é” -&gt; æ”¾å¤§é”ï¼Œå¦‚æœç»†é”è¦ grab å¤§é”ä¼°è®¡è¦æ¶‰åŠä¸€äº›åè®®ï¼Œæ¯”å¦‚å…ˆæŠŠè‡ªå·±æ”¾äº†ï¼Œç„¶åè·å–ä¸‹æ¥å†æŸ¥æŸ¥è‡ªå·±æœ‰æ²¡æœ‰è¢«æ”¹ã€‚</p><p>è¿™é‡Œä½œè€…å¼•å…¥äº†ä¸€äº›é—®é¢˜ï¼ˆåœ¨ 7.1.1ï¼‰ï¼Œå³ï¼Œlibrary function å’Œ lock åº”è¯¥æ€ä¹ˆé€‚é…ï¼Œæ¯”å¦‚ä½ ç¼–å†™äº†ä¸€ä¸ªå¹¶è¡Œç®—æ³•ä»£ç ï¼Œç„¶åæŠŠå®ƒä»¬ä¸­çš„å†…å®¹ä¸¢åˆ°äº†åº“é‡Œï¼Œç„¶ååº“æ²¡æœ‰æŒ‰ç…§ä½ çš„ hierachy é”ï¼Œè€Œæ˜¯ xjb ä¹±é”ï¼Œè¿™å°±é€ æˆäº†æ­»é”é—®é¢˜ï¼ˆä¸è¿‡ç¬”è€…è®¤ä¸ºï¼Œç°å®åœºæ™¯åº”è¯¥å¾ˆå°‘ä¼šè¿™æ ·æŠŠå¸¦é”å†…å®¹ä¸¢è¿›åº“ï¼Ÿä½œè€…ä¹Ÿè®¤ä¸ºåº”è¯¥åœ¨è¿™ç§å‡½æ•°ä¹‹å‰é‡Šæ”¾é”ï¼‰ã€‚ä½œè€…ä¸ºäº†è®¨è®ºè¿™ä¸ªå¼•å…¥äº† <strong>Local Locking Hierarchies</strong> å’Œ <strong>Layered Locking Hierarchies</strong>ï¼š</p><p><img src="https://image.mwish.me/blog-image/9B314C2B-1C22-4762-B899-E8B620EDC014.png" alt="9B314C2B-1C22-4762-B899-E8B620EDC014"></p><p>å¯¹äº Local Locking Hierarchy, è¦è·å¾—ä¸‹ä¸€ä¸ªé”ä¹‹å‰ï¼Œéƒ½é‡Šæ”¾æ‰æœªçŸ¥çš„é”ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±ä¸ä¼šæœ‰è¿™ç§é—®é¢˜äº†ã€‚å½“ç„¶ï¼Œè¿™è¡¨ç¤ºæœ€å¤šæŒæœ‰ 1æŠŠé”ï¼Œå¯èƒ½å’Œå±‚æ¬¡ç›®æ ‡æ¯”èµ·æ¥æ€ªæ€ªçš„ã€‚</p><p>Layered Locking Hierarchy åœ¨åº“è¿™é‡Œä¹Ÿå¼•å…¥äº†è·å–é”çš„å±‚æ¬¡ï¼Œæ¥è¾¾æˆç›®æ ‡ï¼š</p><p><img src="https://image.mwish.me/blog-image/291A6825-116C-48B6-8507-E0D42EC990DD.png" alt="291A6825-116C-48B6-8507-E0D42EC990DD"></p><p>ä»¥ä¸Šæè¿°çš„éƒ½æ˜¯åœ¨å±‚æ¬¡é€»è¾‘ä¸Šã€Œå¯ä»¥é¿å…æ­»é”ã€çš„æ–¹æ¡ˆï¼Œå°±æ˜¯ç¨‹åºæœ¬æ¥ä¸åº”è¯¥æœ‰å†²çªï¼Œå¯ä»¥è®©ä»–ä»¬æ²¡æœ‰ã€‚ä½†æ˜¯æœ‰çš„æ—¶å€™ï¼Œç¨‹åºå°±æ­£ç»å°±è¯¥æœ‰å†²çªï¼Œæ¯”å¦‚ï¼š</p><ol><li>å¹¶å‘ BTree æœ‰ä¸€ä¸ªå·¦å‘å³çš„è¿­ä»£å™¨ï¼Œæœ‰ä¸€ä¸ªå³å‘å·¦çš„è¿­ä»£å™¨</li><li>ä¸åŒå±‚æ¬¡çš„ç³»ç»Ÿï¼ˆæ¯”å¦‚ç½‘ç»œåè®®æ ˆï¼‰é‡Œé¢æœ‰ä¸€ä¸ªä¸‹é™çš„ï¼Œæœ‰ä¸€ä¸ªä¸Šå‡çš„</li></ol><p>è¿™é‡Œå¯ä»¥å¼•å…¥ <strong>conditional locking</strong>ï¼Œæ¥è®©æŸä¸ªæ–¹å‘çš„ locking åšè¯•æ¢æ€§çš„ä¸Šé”ï¼Œæ­£å¦‚ï¼š</p><blockquote><p>One way to avoid deadlocks in this case is to impose a locking hierarchy, but when it is necessary to acquire a lock out of order, acquire it conditionally</p></blockquote><p>ç›¸å¯¹äºä¸Šé¢çš„é”å®šæ–¹æ¡ˆï¼Œè¿˜æœ‰ä¸€ç§ç²—æš´ä½†æœ‰æ•ˆçš„æ–¹æ¡ˆï¼šAcquire Needed Locks Firstã€‚è¿™å°±åœ¨å¤„ç†å‰éƒ½æ‚²è§‚çš„éƒ½å—¯é”ä¸Šï¼Œç±»ä¼¼ 2PLï¼Œæˆ–è€… TiDB çš„æ‚²è§‚é”æ¨¡å‹ã€‚è¿™ç§æ–¹å¼å¯èƒ½ä¼šå¸¦æ¥æ´»é”çš„é—®é¢˜ï¼Œè¿™äº›ç³»ç»Ÿéœ€è¦å¾ˆå¼ºçš„èƒ½åŠ›æ¥å¤„ç† Transaction abortï¼Œèƒ½å¤Ÿ abort/å›æ»šæ‰äº‹åŠ¡ã€‚</p><p>æœ€åä¸€ç§æ–¹æ¡ˆæ¯”è¾ƒ hackingï¼Œå°±æ˜¯ç±»ä¼¼ local locking hierarchyï¼Œä¸€ä¸ªæ—¶é—´åŒä¸€ä¸ªåœ°æ–¹åªæŒæœ‰ä¸€æŠŠé”ã€‚æ„Ÿè§‰è¿™ä¸ªéœ€è¦æŠŠå¹¶å‘è®¾è®¡çš„éå¸¸ç»†å¿ƒã€‚</p><p>æœ€åï¼Œè¿™é‡Œè®¨è®ºäº†ä¸€ä¸‹ <code>lock</code>/<code>unlock</code> å’Œ <code>signal</code> é…åˆçš„è¯­ä¹‰ï¼Œè¿™å¯èƒ½ä¼šè®©ç³»ç»Ÿå˜å¾—éå¸¸å¤æ‚ï¼ˆä¿¡å·å¯é‡å…¥æ„Ÿè§‰æ˜¯ä¸ªéå¸¸è›‹ç–¼çš„é—®é¢˜ï¼‰ã€‚</p><p>æ­¤å¤–ï¼Œè¿˜æœ‰ livelock ç›¸å…³çš„é—®é¢˜ï¼Œä¹Ÿä¼šå¯¼è‡´ starvationï¼šé•¿æ—¶é—´å†…ç±³æœ‰ä¸€ä¸ª worker åœ¨æ­£å¸¸å·¥ä½œã€‚è¿™å¯èƒ½å¯ä»¥å¼•å…¥ä¸€ä¸ªå‘ç°è¿™äº›é—®é¢˜çš„ <strong>contention manger</strong>ï¼Œç„¶åå¼•å…¥ä¸€äº› <code>backoff</code> ç­–ç•¥ï¼Œæ¯”å¦‚æŒ‡æ•°é€€é¿ã€‚æœ‰ä¸€ç§å¤§åŠ›å‡ºå¥‡è¿¹çš„æ–¹æ¡ˆï¼Œå°±æ˜¯è®¾ç½®ä¸€ä¸ªé€€é¿æ¬¡æ•°ï¼Œä¹è§‚è¿™æ ·é‡è¯•ï¼Œä¸è¡Œå°±ä¸Šä¸ªå…¨å±€é”ï¼Œæ‚²è§‚æ‰§è¡Œã€‚</p><p>è¿˜æœ‰ä¸€äº›å¥‡æ€ªçš„ unfairness é—®é¢˜ï¼Œæ¯”å¦‚æŸä¸ª core æˆ–è€…ä»€ä¹ˆä¼šä¸ä¼šæ¯”åˆ«çš„ core æ›´å®¹æ˜“æ‹¿åˆ°é”ï¼›åŒæ—¶ï¼Œé”ä¹Ÿä¼šæœ‰æ¯”è¾ƒé‡çš„ cache missï¼Œæˆ‘ä»¬å¯ä»¥çœ‹çœ‹ä¹‹å‰çš„ <code>Hardware</code> é‚£èŠ‚çš„æƒ…å†µã€‚æœ€ç®€å•çš„ <code>spinlock</code> éƒ½æ¯æ¬¡ä¼šèµ°ä¸€ä¸ª <code>acq</code> çš„ CASï¼Œè¿™ä¸ªä¹Ÿçœ‹åŒæ­¥å’Œæ‰§è¡Œä¹‹é—´çš„å¼€é”€å¯¹æ¯”æ¥å†³å®šäº†ã€‚</p><h3 id="Types-of-Locks"><a href="#Types-of-Locks" class="headerlink" title="Types of Locks"></a>Types of Locks</h3><p>é”å®šé€šå¸¸é€šè¿‡ <code>atomic</code> (ç”¨æˆ·æ€ä¸æ¨è spinlock )ã€<code>futex</code> åŠ ä¸Šä¸€äº›ç”¨æˆ·æ€çš„ flag å®ç°ã€‚è¿™é‡Œå¯èƒ½ä¸ä¼šç›´æ¥ç”¨ pthread çš„å·¥å…·ï¼Œæ¯”å¦‚æ•°æ®åº“çš„ Pageã€‚</p><p>ç”¨æˆ·æ€å®ç°ä¸€èˆ¬åŸºäº <code>futex</code>ï¼Œæœ‰çš„åœ°æ–¹ä¼šå¼•å…¥ä¸€äº›èŠ±æ´»ï¼Œæ¯”å¦‚ <code>MCS Lock</code> ï¼Œæˆ–è€… <code>WTF::ParkingLot</code> è¿™ç§å¹¶å‘è®¾æ–½ã€‚ä½†ä¸ç®¡åŸºäºä»€ä¹ˆï¼Œè¿™é‡Œæœ‰ä¸€äº›å…±æ€§çš„é—®é¢˜éœ€è¦è®¨è®ºã€‚åŒ…æ‹¬é”çš„äº’æ–¥ã€è¯»å†™å’Œå®ƒä»¬çš„è¯­ä¹‰ã€‚</p><h4 id="Exclusive-Lock"><a href="#Exclusive-Lock" class="headerlink" title="Exclusive Lock"></a>Exclusive Lock</h4><p>ç»å…¸çš„é”ï¼Œè¿™é‡Œè¯­ä¹‰å¯èƒ½æœ‰ï¼š</p><ol><li>Strict FIFO</li><li>Approximate FIFO</li><li>FIFO within priority level</li><li>Random</li><li>Unfair</li></ol><p>ä¸åŒçš„é”å¯ä»¥æœ‰ä¸åŒçš„ç­–ç•¥ï¼Œè¶Šä¸Šé¢çš„ï¼Œä¿è¯è¶Šå¼ºã€ä»£ä»·è¶Šé«˜ã€‚</p><h4 id="Reader-Writer-Lock"><a href="#Reader-Writer-Lock" class="headerlink" title="Reader-Writer Lock"></a>Reader-Writer Lock</h4><p>æˆ‘ä»¬ç»å¸¸è¢«ä»‹ç»è¯´è¯»å†™é”ä¼šå¼•å…¥å·¨å¤§å¼€é”€ï¼Œè¿™æ˜¯å› ä¸ºè¯»å†™é”å®ç°çš„æ—¶å€™å¯èƒ½è¦å¼•å…¥é¢å¤–çš„é€»è¾‘ç”šè‡³é¢å¤–çš„é”ï¼Œè¿™äº›ä¿¡æ¯ç”šè‡³é”çš„ç»´æŠ¤å¼€é”€æ˜¯æ¯”è¾ƒå¤§çš„ã€‚</p><blockquote><p>The classic reader-writer lock implementation involves a set of counters and ï¬‚ags that are manipulated atomically. This type of implementation suï¬€ers from the same problem as does exclusive locking for short critical sections: The overhead of acquiring and releasing the lock is about two orders of magnitude greater than the overhead of a simple instruction.</p><p>Of course, if the critical section is long enough, the overhead of acquiring and releasing the lock becomes negligible. However, because only one thread at a time can be manipulating the lock, the required critical-section size increases with the number of CPUs.</p><p>The canonical use case for readerwriter locking involves very long read-side critical sections, preferably measured in hundreds of microseconds or even milliseconds.</p></blockquote><p>Brpc ä¹Ÿæ˜¯å› ä¸ºè¿™ä¸ªåŸå› ï¼Œä¸å¤ªåœ¨åº“é‡Œå†™ bthread çš„ rwlockã€‚</p><p>Rw lock å¯èƒ½æœ‰ä¸åŒçš„è¯­ä¹‰å’Œä¸åŒçš„å®ç°ï¼Œç„¶åé€šç”¨å®ç°å‡ ä¹éƒ½ä¸é‚£ä¹ˆä»¤äººæ»¡æ„ï¼Œæ‰€ä»¥éœ€è¦æ ¹æ®è‡ªå·±çš„éœ€æ±‚æ¥å®šåˆ¶ï¼š</p><ol><li>è¯»è€…ä¼˜å…ˆçš„å®ç°ï¼Œå¯èƒ½ä¼šæ°¸ä¹…é¥¿æ­»æŸä¸ª writer</li><li>Batch-fair çš„å®ç°ï¼Œè¯»è€…å’Œå†™è€…éƒ½ä¼šäº’ç›¸ Batch çš„æ¥è®¿é—®</li><li>å†™è€…ä¼˜å…ˆçš„å®ç°</li></ol><h4 id="æ›´ç»†çš„é”è¯­ä¹‰"><a href="#æ›´ç»†çš„é”è¯­ä¹‰" class="headerlink" title="æ›´ç»†çš„é”è¯­ä¹‰"></a>æ›´ç»†çš„é”è¯­ä¹‰</h4><p><img src="https://image.mwish.me/blog-image/465B1D27890482CA56D68CE6529B4E3D.png" alt="465B1D27890482CA56D68CE6529B4E3D"></p><p>ä½œè€…è¿™é‡Œä¸¾ä¾‹äº† VAX/VMS DLMã€‚ç¬”è€…ä½œä¸º DB RDï¼Œè§‰å¾—è¿™é‡Œå…¶å®å¯ä»¥å‚è€ƒ Btree å„ç§ Latch åè®®ï¼Œæ¯”å¦‚ SX Latch ä»€ä¹ˆçš„ã€‚ç¬”è€…è®¤ä¸ºï¼Œè¿™é‡Œå…³é”®ç‚¹æ˜¯ï¼š</p><ol><li>çŸ¥é“ä»€ä¹ˆå¯ä»¥å’Œä»€ä¹ˆå¹¶å‘ï¼Œç”»å‡ºå¹¶å‘çš„å›¾</li><li>å¼„æ¸…æ¥šè¿™æ ·å¼€é”€æ˜¯å¦åˆé€‚ï¼Œç±»ä¼¼ RW-Latch é‚£ä¸ªé—®é¢˜ï¼Œå®ƒçš„å¼€é”€æ¯”é€šå¸¸çš„äº’æ–¥é”é«˜äº†å‡ å€ã€‚è¿™æ˜¯å€¼å¾—çš„å—ï¼Ÿ</li></ol><h3 id="é”çš„å®ç°"><a href="#é”çš„å®ç°" class="headerlink" title="é”çš„å®ç°"></a>é”çš„å®ç°</h3><p>è¿™éƒ¨åˆ†å¯ä»¥çœ‹çœ‹æˆ‘çˆ¹ rsyggï¼ˆå¾å©šä¸­ï¼‰å†™çš„ï¼š <a href="https://github.com/rsy56640/triviality/tree/master/content/%E8%B0%88%E8%B0%88%E5%B9%B6%E5%8F%91#mutex">https://github.com/rsy56640/triviality/tree/master/content/%E8%B0%88%E8%B0%88%E5%B9%B6%E5%8F%91#mutex</a> æˆ–è€… futex is trickey</p><p>ä¸è¿‡è¿™éƒ¨åˆ†å…¶å®æ›´å¤šä»‹ç»çš„æ˜¯ç”¨æˆ·å±‚æ¬¡çš„é”å®ç°ï¼Œåå‘ç­–ç•¥è€Œéæœºåˆ¶ã€‚</p><p>Atomic + CAS è‡ªç„¶å¯ä»¥å®ç°é”ï¼Œåœ¨ low contention çš„æ—¶å€™ç”šè‡³å¯ä»¥å·¥ä½œçš„å¾ˆå¥½ã€ä¹Ÿæœ‰å¾ˆå°çš„ meory footprintï¼Œä½†æ˜¯åœ¨é«˜å ç”¨çš„æƒ…å†µä¸‹å¯èƒ½å°±ç‚¸äº†ã€‚</p><p>ticket lock å®ç°äº† strict FIFO çš„è¯­ä¹‰ï¼Œå®ƒçš„æ´»è·ƒåº¦å¯èƒ½å€¼å¾—å•†æ¦·ã€‚è€Œè§£é”ä¸­ï¼Œä¸ºäº†ä¸ä¸€æ¬¡é€šçŸ¥æ‰€æœ‰çš„ç­‰å¾…è€…ï¼Œåˆ™éœ€è¦å¼•å…¥ä¸€äº› queue ï¼ˆæƒ³è±¡ futex çš„è¯­ä¹‰ï¼‰ï¼Œè¿™æ ·å®ƒåªéœ€è¦é€šçŸ¥è¯¥å”¤é†’çš„çº¿ç¨‹ã€‚ä¸è¿‡è¿™äº›ç­–ç•¥ä¼šå¯¼è‡´åœ¨ low-contention çš„æƒ…å†µä¸‹ï¼Œå¢å¤§é”ç›¸å…³çš„å¼€é”€ã€‚</p><p>æ­¤å¤–ï¼Œè¿™é‡Œè¿˜æœ‰ä¼˜å…ˆçº§åè½¬çš„é—®é¢˜ï¼Œå é”çš„çº¿ç¨‹å¦‚æœæ˜¯ä¸ªä½ä¼˜å…ˆçº§çš„çº¿ç¨‹çš„è¯ï¼Œè¿™é‡Œå°±ä¼šæœ‰å¥‡æ€ªçš„é—®é¢˜ï¼Œæ¯”å¦‚å®ƒè¢«è°ƒåº¦èµ°æ•´ä¸ªç³»ç»Ÿå°±æ²¡äººå·¥ä½œäº†ã€‚è¿™é‡Œæœ‰ä¸¤ç§æ–¹æ¡ˆï¼šå é”äº†å°±ä¸èƒ½è¢«è°ƒåº¦èµ°ï¼›ä½¿ç”¨ä¼˜å…ˆçº§åè½¬ã€‚</p><p>è¿™é‡Œä½œè€…è¿˜æåˆ°äº†ä¸ç”¨åŸå­æŒ‡ä»¤å®ç° lock çš„æ–¹æ¡ˆï¼Œæˆ‘åªèƒ½è¯´çœŸçš„ç‰›é€¼ã€‚</p><p>æœ€åï¼š</p><blockquote><p>The Linux kernel now uses queued spinlocks [Cor14b], but because of the complexity of implementations that provide good performance across the range of contention levels, the path has not always been smooth [Mar18, Dea18].</p><p>Nevertheless, you should carefully consider this important safety tip: Use the standard synchronization primitives whenever humanly possible. The big advantage of the standard synchronization primitives over roll-your-own eï¬€orts is that the standard primitives are typically much less bug-prone.8</p></blockquote><h3 id="Lock-Based-Existence-Guarantees"><a href="#Lock-Based-Existence-Guarantees" class="headerlink" title="Lock-Based Existence Guarantees"></a>Lock-Based Existence Guarantees</h3><p>Existence æ¯”è¾ƒå¥‡æ€ªï¼Œä¸è¿‡è¿™é‡Œè®¨è®ºçš„å†…å®¹æŒºæ­£ç»çš„ï¼š</p><ol><li>Global/Static local variable çš„ existance</li><li>Global/Static local variable çš„åŠ è½½</li><li>Heap ä¸Šå˜é‡çš„å­˜åœ¨æ€§ï¼Œæ¯”æ–¹è¯´ç»™æ•°æ®åº“ <code>LockManager</code> çš„ä¸€ä¸ªè¯·æ±‚ï¼Œä¼šè¢«æ”¾åˆ°é˜Ÿåˆ—é‡Œï¼Œç­‰å¾…é€šçŸ¥ã€‚è¿™ä¸ªè¢«é€šçŸ¥å®Œä¹‹åï¼Œå¯èƒ½è¢«å›æ”¶</li></ol><p>è¿™é‡Œå¯ä»¥ï¼š</p><ul><li>æŠŠ Lock æˆ–è€…ä¸€ä¸ªæ ‡å¿—å’Œå¯¹è±¡æŠ½å¼€ï¼Œç„¶åç”¨è¿™ä¸ªå¯¹è±¡æ¥è¯†åˆ«</li></ul>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>perfbook notes: Hardware</title>
      <link href="/2022/05/04/perfbook-notes-hardware/"/>
      <url>/2022/05/04/perfbook-notes-hardware/</url>
      
        <content type="html"><![CDATA[<p>Perfbook å…¨ç§°æ˜¯ <em>Is Parallel Programming Hard, And, If So, What Can You Do About It?</em> ä½œè€…æ˜¯ Paul E. McKenneyï¼Œä¹Ÿæ˜¯ RCU çš„å‘æ˜è€…ã€‚è¿™æœ¬ä¹¦ç›¸å¯¹æ¥è¯´è¯­æ³•æœ‰ç‚¹ç‚¹éš¾ï¼Œæˆ‘ä¸ªäººçœ‹çš„æœ‰é‚£ä¹ˆç‚¹å°åƒåŠ›ï¼Œä½†æ˜¯ä½œè€…èƒ½å¤Ÿéå¸¸å½¢è±¡çš„æè¿°å¹¶å‘æ•°æ®ç»“æ„æ˜¯æ€ä¹ˆè®¾è®¡çš„ï¼Œå¹¶ä¸”ä» scalable-counterã€partitionã€lockã€data-ownership ä»‹ç»åˆ° RCUã€‚ä¹¦å…·ä½“å†…å®¹å¾ˆå¥½ï¼Œä¹Ÿå€¼å¾—æˆ‘åšä¸€äº›ç¬”è®°ä»¥ä¾¿æœªæ¥å›é¡¾ã€‚</p><p>ä¹¦çš„ç¼–å†™ä¼šåŒ…æ‹¬ä¸€äº› Quizï¼Œæœ‰çš„è¿˜æ˜¯æ¯”è¾ƒæœ‰éš¾åº¦çš„ï¼Œå¸®åŠ©è‡ªå·±ç†è§£é—®é¢˜ã€‚æˆ‘çš„ç¬”è®°åªä¾›è‡ªå·±åšä¸€ä¸ªå›é¡¾å’Œä¸€äº›å·¥ä¸šç•Œå®ç°çš„å‚è€ƒï¼Œæ‰€ä»¥ä¸ä¼šå®Œå…¨å‚è€ƒåŸä¹¦çš„å¸ƒå±€ã€‚</p><p>Chap2-4 æè¿°äº†ä¸€äº› smp çš„åŸè¯­å’Œæ€§èƒ½</p><h2 id="å¹¶è¡Œç¼–ç¨‹çš„éœ€æ±‚ã€åŸºæœ¬æ€§èƒ½ä¸åŸè¯­"><a href="#å¹¶è¡Œç¼–ç¨‹çš„éœ€æ±‚ã€åŸºæœ¬æ€§èƒ½ä¸åŸè¯­" class="headerlink" title="å¹¶è¡Œç¼–ç¨‹çš„éœ€æ±‚ã€åŸºæœ¬æ€§èƒ½ä¸åŸè¯­"></a>å¹¶è¡Œç¼–ç¨‹çš„éœ€æ±‚ã€åŸºæœ¬æ€§èƒ½ä¸åŸè¯­</h2><p>å¹¶è¡Œç¼–ç¨‹åœ¨ä¸Šä¸–çºªæ˜¯ä¸ªéå¸¸å°ä¼—çš„é¢†åŸŸï¼Œåªæœ‰ä¸“ä¸šäººå£«ä¼šå†™ã€‚ä½†æ˜¯éšç€ CPU æ’ä¸ŠåŠŸè€—å¢™ï¼Œè¿™ä¸€å°ä¼—é¢†åŸŸç°åœ¨å·²ç»æˆäº†å¤§ä¼—å· b ä¹‹åœ°ã€‚ç°åœ¨æœ‰ <code>tbb</code>ã€<code>folly</code> ç­‰åº“ï¼Œä¹Ÿæœ‰ <code>thread</code> <code>atomic</code> ç­‰ç¼–ç¨‹å·¥å…·/åŸè¯­ã€‚æ­¤å¤–ï¼Œè¿˜æœ‰ä¸€äº›ç”¨æˆ·æ€çº¿ç¨‹ã€åç¨‹ä¹Ÿåœ¨è¿‘å¹´é‡æ–°å—åˆ°å…³æ³¨ï¼Œå®ƒä»¬å¯ä»¥å‡å°‘çº¿ç¨‹è°ƒåº¦å’Œåˆ‡æ ˆæˆ–è€…ç”³è¯·æ ˆçš„å¼€é”€ã€å’Œ <code>async</code> ç­‰è¯­æ³•ç»“åˆï¼Œç”¨äºä¼˜åŒ–ä»£ç å’Œæ”¹å–„æ€§èƒ½ã€‚</p><p><img src="https://image.mwish.me/blog-image/7BF7E021-3D1F-4F27-9BAB-EC772C386339.png" alt="7BF7E021-3D1F-4F27-9BAB-EC772C386339"></p><p>å¹¶è¡ŒåŒ–çš„ä¼˜åŠ¿åœ¨äºï¼š</p><ol><li><p>Performance: åŒ…æ‹¬ scalability( performance per CPU) å’Œ efficiency (performance per watt), è¿™ä¸¤ä¸ªä¸œè¥¿éƒ½é‡è¦ï¼Œä¸€èµ·æ‰èƒ½æ‹¼å‡ºä¸ªä¸é”™çš„æœ€ç»ˆç»“æœã€‚åŒæ—¶å¦‚æœä½ çš„ç¨‹åºå¤Ÿå¿«ã€æ²¡æœ‰æ€§èƒ½é—®é¢˜ï¼Œé‚£ä¸²è¡Œå°±ä¸²è¡Œå§ã€‚</p></li><li><p>Productivity:  é€šè¿‡ä½ çš„ä¸œè¥¿ï¼Œå®ç°å†…å®¹çš„ç”Ÿäº§åŠ›</p></li><li><p>Generality: æ–¹æ³•çš„é€šç”¨æ€§ã€‚äº‹å®ä¸Šæˆ‘ä»¬ä¹‹å‰è®¨è®ºçš„ RCU ä»€ä¹ˆçš„ api ç›¸å¯¹æ¥è¯´æ€§èƒ½å¥½ï¼Œä½†æ˜¯é€šç”¨æ€§ç¡®å®å·®ä¸å°‘ã€‚</p></li></ol><p>è¿™é‡Œè€ƒå¯Ÿäº† C++ POSIX Thread API(Performanceã€Generality)ï¼ŒJava ï¼ˆç›¸è¾ƒ C++ ç‰ºç‰²äº†ä¸€ç‚¹æ€§èƒ½ï¼‰ã€SQL (ä¸å¤ªæ³›ç”¨ã€é¢†åŸŸä¸“ä¸€ï¼Œä½†æœ‰ç€å¥½çš„æ€§èƒ½å’Œ Productivity)ã€‚</p><p>ç„¶åä½œè€…æ•´äº†å¼ å›¾ï¼Œå†è®²äº†ä¸‹ OS/ç¡¬ä»¶ å±‚é¢æ˜¯å¦‚ä½•å¯¹ä¸Šè¿°å†…å®¹å–èˆå’ŒæŠ½è±¡çš„ã€‚å› ä¸º OS æœ¬èº«æ˜¯ä¸€ä¸ªå¾ˆã€Œé€šç”¨ã€çš„ä¸œè¥¿ï¼Œæ‰€ä»¥å®ƒçš„ Performance/Generality çš„è¦æ±‚æ˜¯å¾ˆé«˜çš„ï¼Œè€Œè¶Šä¸Šå±‚çš„åº”ç”¨å¯èƒ½å¯¹ Productivity è¦æ±‚è¶Šé«˜ã€‚</p><p><img src="https://image.mwish.me/blog-image/77B09222-65ED-4732-B215-09355B46E7A6.png" alt="77B09222-65ED-4732-B215-09355B46E7A6"></p><h3 id="Alternatives-to-Parallel-Programming"><a href="#Alternatives-to-Parallel-Programming" class="headerlink" title="Alternatives to Parallel Programming"></a>Alternatives to Parallel Programming</h3><p>è¿™ä¸€èŠ‚çš„å†…å®¹éå¸¸çš„å·¥ç¨‹å¸ˆæ™ºæ…§ï¼Œä»‹ç»äº†å¦‚ä½•ã€Œä¸ç¼–å†™ä¸€ä¸ªå¹¶è¡Œçš„ç³»ç»Ÿï¼Œåˆç”¨ä¸Šç¡¬ä»¶è¿™äº›åŠŸèƒ½ã€ï¼š</p><ol><li>è¿è¡Œå¤šä¸ªä¸²è¡Œç³»ç»Ÿçš„ instanceï¼Œå¹¶èƒ½å¤Ÿå¯¹ workload partition</li><li>ç”¨å·²æœ‰çš„å¹¶è¡Œç³»ç»Ÿ</li><li>ä¸²è¡Œä¸Šè¿›è¡Œä¼˜åŒ–ï¼Œä¼˜åŒ–åˆ°ä¸ç”¨å¹¶è¡Œä¹Ÿè¿è¡Œçš„æŒºå¥½</li></ol><h3 id="What-Makes-Parallel-Programming-Hard"><a href="#What-Makes-Parallel-Programming-Hard" class="headerlink" title="What Makes Parallel Programming Hard?"></a>What Makes Parallel Programming Hard?</h3><p><img src="https://image.mwish.me/blog-image/CE768DAC-77B4-4D12-8878-B0BF058C4302.png" alt="CE768DAC-77B4-4D12-8878-B0BF058C4302"></p><p>å› ä¸ºè¿™ä¸ªåœ°æ–¹è¦æˆåŠŸçš„åˆ‡åˆ†ä»»åŠ¡ï¼Œç„¶åæ—¢ç„¶æœ‰åˆ‡åˆ†ï¼Œé‚£è¿è¡Œä¹‹ç±»çš„è¿˜æœ‰é€šä¿¡çš„äº‹æƒ…è¦è€ƒè™‘ï¼ŒåŒæ—¶è¿˜è¦è€ƒè™‘èµ„æºç®¡ç†ã€å›æ”¶ etcâ€¦ æœ¬èº«è¿™äº›ä»»åŠ¡éƒ½æœ‰ç›¸å¯¹çš„å¤æ‚æ€§ã€‚</p><p>è¿™ä¸€èŠ‚ç›¸å½“äºä»‹ç»äº†ã€Œå¹¶å‘ç¼–ç¨‹ä¸ºä»€ä¹ˆè¿™ä¹ˆéš¾ã€ã€‚å…¶å®å¯ä»¥çœ‹åˆ°ï¼Œè·Ÿæˆ‘ä¸ªäººçš„æƒ³è±¡ä¸åŒï¼Œè¿™ä¸ªé¢†åŸŸæ˜¯</p><h2 id="Hardware-and-its-Habits"><a href="#Hardware-and-its-Habits" class="headerlink" title="Hardware and its Habits"></a>Hardware and its Habits</h2><p>ä¸€ä¸ªç°ä»£çš„ CPU å¤§æ¦‚åœ¨æ‰§è¡Œçš„æ—¶å€™ä¼šæœ‰ï¼š</p><ol><li>pipelines</li><li>Superscalar</li><li>Speculative execution</li><li>â€¦</li></ol><p>å…·ä½“æˆ‘æ„Ÿè§‰ 15-418 ç»™çš„ææ–™æ¯”è¾ƒå¥½ã€‚</p><p><img src="https://image.mwish.me/blog-image/4C310521-6C51-4748-8D82-672D94AC3D52.png" alt="4C310521-6C51-4748-8D82-672D94AC3D52"></p><p>å…³äºç°ä»£ CPUï¼Œæœ¬èº«æ€§èƒ½ä¸‹é™çš„åŸå› ï¼Œperfbook åˆ—äº†ï¼š</p><ol><li>Pipeline ç›¸å…³ï¼Œæ¯”å¦‚ branch mispredict/structural hazard: <a href="https://blog.mwish.me/2020/10/21/SDS-Intro-RISC-V-Datapath-4-Pipeline/">https://blog.mwish.me/2020/10/21/SDS-Intro-RISC-V-Datapath-4-Pipeline/</a></li><li>Memory Reference: è¿™é‡Œä¸å…‰æ˜¯è®¿é—®å†…å­˜çš„å¼€é”€ï¼Œæ›´å¤šçš„æ˜¯ï¼Œç»™å‡ºä¸€ä¸ªåœ°å€ï¼Œç„¶åè®¿é—®å…¶å†…å­˜çš„å¼€é”€ã€‚</li><li>Atomic Operations: è¿™ä¸ªåœ°æ–¹ä¸æ¶‰åŠ memory barrier, åº”è¯¥æŒ‡çš„å°±æ˜¯å¯¹æŸæ®µå†…å­˜çš„ atomic æ“ä½œã€‚åŸå­æ“ä½œæœ‰çš„åœ°æ–¹æ˜¯è¿èƒŒ CPU å‡è®¾çš„ã€‚atomic op çš„æ“ä½œç»å¸¸è¦ï¼š<ol><li>ä¿è¯æ•°æ®æ˜¯è¿™ä¸ª cacheline æ‰€æœ‰çš„</li><li>æ“ä½œå®Œåæ•°æ®è¿˜å½’å±äºè¿™ä¸ª cacheline</li><li>pipeline must be delayed or even ï¬‚ushed in order to perform the setup operations that permit a given atomic operation to complete correctly.</li></ol></li><li>Memory Barriers: memory barriers åœ¨è¯­è¨€å±‚é¢ä¸Šç»å¸¸å’Œ atomic op æ”¾åœ¨ä¸€èµ·è®¨è®ºï¼Œä½†æ˜¯è¿™ä¸ªå¯èƒ½éœ€è¦å¯¹ Writer Buffer ä¹‹ç±»çš„ä¸œè¥¿åšç‰¹æ®Šå¤„ç†ï¼Œå¯èƒ½ä¼šå½±å“åº”èƒ½</li><li>Cache Miss: æ‡‚å¾—éƒ½æ‡‚ã€‚</li><li>I/O Operations: æ‡‚å¾—éƒ½æ‡‚ã€‚å¯æƒœæˆ‘ä¸æ‡‚ io_uringï¼Œä»¤äººå”å˜˜ã€‚</li></ol><p>æŒ‰ç…§æˆ‘å·æ¥çš„å›¾ï¼š</p><p><img src="https://image.mwish.me/blog-image/F373D15D-0CE9-4427-80BE-B4545FAA35BE.png" alt="F373D15D-0CE9-4427-80BE-B4545FAA35BE"></p><h3 id="ç¡¬ä»¶åŠå…¶å‡è®¾"><a href="#ç¡¬ä»¶åŠå…¶å‡è®¾" class="headerlink" title="ç¡¬ä»¶åŠå…¶å‡è®¾"></a>ç¡¬ä»¶åŠå…¶å‡è®¾</h3><p><img src="https://image.mwish.me/blog-image/734E9D9B-1488-432F-B534-2817C6FD327A.png" alt="734E9D9B-1488-432F-B534-2817C6FD327A"></p><p>ä¸Šé¢æ˜¯ perfbook çš„å›¾ï¼Œæˆ‘ä» 15-418 å·äº†å‡ å¼ å›¾ï¼š</p><p><img src="https://image.mwish.me/blog-image/3DB734F8-B806-4A45-91AA-97DBA2E3B272.png" alt="3DB734F8-B806-4A45-91AA-97DBA2E3B272"></p><p><img src="https://image.mwish.me/blog-image/0D78679C-E152-4396-AE71-8A643D8F7770.png" alt="0D78679C-E152-4396-AE71-8A643D8F7770"></p><p>è¿™å‡ å¼ å›¾åº”è¯¥æ¦‚è¿°äº† NUMAã€SIMD ä¹‹ç±»çš„ã€‚</p><p>perfbook ä¸¾äº†ä¸ªä¾‹å­ï¼Œåœ¨æŸä¸ªæ¶æ„ä¸­ï¼Œå¦‚æœ CPU (CPU0) æƒ³è¦å†™ä¸€ä¸ªè·¨ Socket çš„ mem åœ°å€ï¼Œå¯èƒ½ä¼šï¼š</p><ol><li>check local cache(L1, L2)</li><li>èµ°ç›®å½•åè®®ï¼Œç»™ CPU0 æˆ–è€…åˆ«çš„ CPU å‘é€æŒ‡ä»¤ï¼Œç„¶åè®©è¿™ä¸ª Cacheline æåˆ°è‡ªå·±ä¸Šå¤´</li><li>cacheline åˆ°è‡ªå·±ä¸Šï¼ŒçœŸæ­£å¯å†™</li><li>å…·ä½“å†™</li></ol><p>ä¸‹é¢ä¸€å¼ å›¾ä»‹ç»äº†å„ç§æ“ä½œçš„å¼€é”€ï¼š</p><p><img src="https://image.mwish.me/blog-image/FG9cf5AaIAAxxUI.png" alt="FG9cf5AaIAAxxUI"></p><p><img src="https://image.mwish.me/blog-image/FGkZD2DVgAAW6Ij.png" alt="FGkZD2DVgAAW6Ij"></p><ol><li>åŒä¸€ä¸ª CPU çš„ CAS å¯ä»¥å‡  ns å†…å®Œæˆï¼Œæµç¨‹åŸºæœ¬ä¸Šç›¸å½“äºåœ¨ cacheline åšæ ‡è®°ã€‚è¿™é‡Œ cas æ˜¯ x86 çš„ <code>lock;cmpxchg</code></li><li>In-core è¡¨ç¤ºåœ¨åŒä¸€ä¸ªæ ¸å¿ƒä¸Šï¼Œå…±äº«åŒä¸€ä¸ª cache hierarchyï¼›blind cas è¡¨ç¤ºã€Œä¸è¯»æ—§å€¼ï¼Œç›´æ¥ CASã€ï¼Œè€Œ CAS æ˜¯ã€Œè¯»æ—§å€¼ + CASã€ã€‚åè€…å¯èƒ½è®¿å­˜ä¸¤æ¬¡</li></ol><p><img src="https://image.mwish.me/blog-image/2D9BD427-C39E-43B2-AA69-C37BF71341B6.png" alt="2D9BD427-C39E-43B2-AA69-C37BF71341B6"></p><p>è¿™é‡Œè¿˜æœ‰äº› dark side ä¼˜åŒ–ï¼š</p><ol><li>large cacheline</li><li>cache prefetching</li><li>store buffer</li><li>speculative execution</li><li>large caches</li><li>read-mostly replicationï¼ˆæƒ³ä¸‹ MESIï¼‰</li></ol><p>ä¸Šé¢è¿™äº›ç­–ç•¥å…¶å®è½¯ä»¶ä¹Ÿæ˜¯å¾ˆå¸¸ç”¨çš„ã€‚</p><h2 id="Tools"><a href="#Tools" class="headerlink" title="Tools"></a>Tools</h2><p>æœ¬èŠ‚å†…å®¹æ¯”è¾ƒéš¾ï¼Œä½†æˆ‘ä¸å¤ªæ‰“ç®—å†™ã€‚è¿™é‡Œç”¨çš„å·¥å…·ä¸å¤ªæ˜¯ user-level çš„ C++11 atomic ä¹‹ç±»çš„ï¼Œæœ¬èŠ‚ä»‹ç»äº† Linux å¸¸ç”¨çš„ <code>WRITE_ONCE</code> <code>READ_ONCE</code>ï¼Œå’Œ <code>volatile</code> çš„è¯­ä¹‰ã€‚ç„¶åä»‹ç»äº†ä¸€ä¸‹å„ç§å¹¶å‘ã€‚</p><p>åœ¨è¿™ä¹‹å‰ï¼Œchap4 ä»‹ç»äº†ä¸€äº›ä¸ç”¨ä¸Šé¢æ–¹å¼çš„å·¥å…·ï¼Œæ¯”å¦‚ bash è„šæœ¬è¿™ä¸€è‘—åã€ç»å…¸çš„å¹¶å‘ç¨‹åºã€‚è¯¦ç»†å†…å®¹æˆ‘è§‰å¾—å¯ä»¥å‚è€ƒ 6.nullã€‚</p><p><code>POSIX</code> æä¾›äº† <code>fork</code> <code>wait</code> ç­‰è¿›ç¨‹æ¥å£ï¼Œä½†è¿™äº›æ¥å£çš„ä½¿ç”¨é€šå¸¸å’Œ shmã€signal ç»“åˆã€‚åœ¨ <code>nptl</code> æ²¡å®ç°çš„æ—¶å€™ï¼ŒPostgreSQL è¿™äº›åªèƒ½ä¾èµ–è¿™å¥—ä¸œè¥¿åšã€‚</p><p>ä¸‹é¢ä»‹ç»äº†ä¸€ä¸‹ POSIX mutexã€GNU çš„ atomic å’Œ<code>__sync_</code>ã€‚ç„¶åç€é‡ä»‹ç»äº† <code>volatile</code> çš„è¯­ä¹‰ã€‚æˆ‘è§‰å¾—åˆ«çš„åœ°æ–¹ä»‹ç»éƒ½æ²¡è¿™é‡Œå¥½ã€‚ä½†æ˜¯æˆ‘æ„Ÿè§‰è¿™æ®µä¸å¦‚ç›´æ¥ atomicï¼Œæ‰€ä»¥æ„Ÿå…´è¶£çš„è‡ªå·±å›å¤´çœ‹å§ã€‚</p><p>è¿™é‡ŒåŸºæœ¬è¿˜å¯ä»¥å‚è€ƒä¸€äº› futex are trickey ä»€ä¹ˆçš„ï¼Œçœ‹çœ‹å¯¹åº”æ¥å£çš„å®ç°ã€‚<code>webkit</code> å®ç°äº†ä¸€å¥—å¹¶å‘åº“ï¼š<a href="https://webkit.org/blog/6161/locking-in-webkit/">https://webkit.org/blog/6161/locking-in-webkit/</a> ï¼Œå¯ä»¥ä½œä¸ºå‚è€ƒï¼ˆä¸å®Œå…¨æ˜¯ futexï¼Œç›¸å½“äºåœ¨ç”¨æˆ·æ€åŒ…è£…äº†ä¸€å±‚ futexï¼‰</p><p>æˆ–è€…ä¹Ÿå¯ä»¥çœ‹æˆ‘ rsy çˆ¹çš„ blog: <a href="https://github.com/rsy56640/triviality/tree/master/content/%E8%B0%88%E8%B0%88%E5%B9%B6%E5%8F%91">https://github.com/rsy56640/triviality/tree/master/content/%E8%B0%88%E8%B0%88%E5%B9%B6%E5%8F%91</a></p><h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><ol><li><a href="https://www.quora.com/What-is-robust-mutex-in-Linux-What-are-some-use-cases-of-robust-mutex">https://www.quora.com/What-is-robust-mutex-in-Linux-What-are-some-use-cases-of-robust-mutex</a></li><li>CMU 15-418</li></ol>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Arch Blog Overviews</title>
      <link href="/2022/05/02/Arch-Blog-Overviews/"/>
      <url>/2022/05/02/Arch-Blog-Overviews/</url>
      
        <content type="html"><![CDATA[<p>è¿™ç¯‡åšå®¢å¹²è„†åšä¸€ä¸ªæ±‡æ€»å¥½äº†ï¼Œåœ¨æ¯•ä¸šé‚£å¹´ç®—æ˜¯åšäº†ä¸€äº› Arch çš„å…¥é—¨. ç°åœ¨å›å¤´ç¿»ä¹Ÿæ¯”è¾ƒå¥½ï¼Œç„¶åæœ€è¿‘ä¹Ÿå¯èƒ½æ·»åŠ ä¸€äº›æ–°å†…å®¹ï¼ˆå› ä¸ºåœ¨çœ‹ perfbookï¼‰ã€‚</p><h2 id="mwishâ€™s-blogs"><a href="#mwishâ€™s-blogs" class="headerlink" title="mwishâ€™s blogs"></a>mwishâ€™s blogs</h2><p>é¦–å…ˆæ˜¯æˆ‘è‡ªå·±å†™çš„ä¸€äº›ï¼š</p><h3 id="Cache"><a href="#Cache" class="headerlink" title="Cache"></a>Cache</h3><ol><li>Cache Consistency in CPU and Distributed System: <a href="https://blog.mwish.me/2020/12/12/Cache-Consistency-in-CPU-and-Distributed-System/">https://blog.mwish.me/2020/12/12/Cache-Consistency-in-CPU-and-Distributed-System/</a> ï¼ˆä»‹ç»äº†ä¸€äº› MOSI ä¹‹ç±»çš„ä¸œè¥¿ï¼ŒåŒ…æ‹¬ Snooping åè®®å’Œ Directory åè®®ï¼‰</li><li>Cache çš„ç»“æ„ï¼Œå’Œç»„ç›¸è”ç¼“å­˜ï¼š<a href="https://blog.mwish.me/2020/10/29/Cache-and-Related-Part1/">https://blog.mwish.me/2020/10/29/Cache-and-Related-Part1/</a></li><li>ç”¨æˆ·ä½¿ç”¨ Cache çš„ä¼˜åŒ–ï¼š<a href="https://blog.mwish.me/2020/10/31/Cache-and-Related-Part2/">https://blog.mwish.me/2020/10/31/Cache-and-Related-Part2/</a></li><li>Cache Coherent å’Œ Memory Order: <a href="https://blog.mwish.me/2020/11/01/Cache-and-Related-Part3-Coherent/">https://blog.mwish.me/2020/11/01/Cache-and-Related-Part3-Coherent/</a></li></ol><p>æ­¤å¤–å› ä¸ºæ˜¯ RVï¼Œæ‰€ä»¥æˆ‘æ”¶é›†äº†ä¸€äº›å†…å­˜æ¨¡å‹ç›¸å…³çš„ææ–™ï¼š</p><ol><li><a href="https://www.cs.utexas.edu/~bornholt/post/memory-models.html">https://www.cs.utexas.edu/~bornholt/post/memory-models.html</a></li><li>A Tutorial Introduction to the ARM and POWER Relaxed Memory Models</li><li><a href="https://www.kernel.org/doc/Documentation/memory-barriers.txt">https://www.kernel.org/doc/Documentation/memory-barriers.txt</a> (å’Œ 2 å¯ä»¥ä¸€èµ·çœ‹ï¼Œå¯¹ç…§å°±æ‡‚å¾ˆå¤šäº†)</li><li><a href="https://riscv.org/wp-content/uploads/2018/05/14.25-15.00-RISCVMemoryModelTutorial.pdf">https://riscv.org/wp-content/uploads/2018/05/14.25-15.00-RISCVMemoryModelTutorial.pdf</a></li><li>A Primer on Memory Consistency and Cache Coherence, Second Edition</li></ol><p>æŒ‰ç…§é¡ºåºè¯»ä¸‹å»åŸºæœ¬ä¸Šä¸ä¼šè¢«ç½‘å‹æ‰¯çŠŠå­éª—äº†ã€‚</p><h3 id="CPU"><a href="#CPU" class="headerlink" title="CPU"></a>CPU</h3><ol><li>flip-flop åˆ°æ‰§è¡Œç”µè·¯ï¼š<a href="https://blog.mwish.me/2020/10/14/SDS-Intro-RISC-V-Datapath/">https://blog.mwish.me/2020/10/14/SDS-Intro-RISC-V-Datapath/</a></li><li>åŸºæœ¬çš„ datapath: <a href="https://blog.mwish.me/2020/10/15/SDS-Intro-RISC-V-Datapath-2-Datapath/">https://blog.mwish.me/2020/10/15/SDS-Intro-RISC-V-Datapath-2-Datapath/</a></li><li>æ§åˆ¶é€»è¾‘ã€Pipelineï¼š<a href="https://blog.mwish.me/2020/10/18/SDS-Intro-RISC-V-Datapath-3-Control-logic-and-metric/">https://blog.mwish.me/2020/10/18/SDS-Intro-RISC-V-Datapath-3-Control-logic-and-metric/</a></li><li>Hazardã€Pipelineã€OoO: <a href="https://blog.mwish.me/2020/10/21/SDS-Intro-RISC-V-Datapath-4-Pipeline/">https://blog.mwish.me/2020/10/21/SDS-Intro-RISC-V-Datapath-4-Pipeline/</a></li></ol><p>çœ‹ perfbook çš„æ—¶å€™è¿½åŠ äº†ä¸€äº›å›¾ç‰‡: <a href="https://blog.mwish.me/2022/05/04/perfbook-notes-hardware/">https://blog.mwish.me/2022/05/04/perfbook-notes-hardware/</a></p><h3 id="Memory"><a href="#Memory" class="headerlink" title="Memory"></a>Memory</h3><ol><li>è™šæ‹Ÿå†…å­˜ï¼š <a href="https://blog.mwish.me/2020/11/08/%E8%BD%AF-%E7%A1%AC%E7%9A%84%E5%88%86%E7%95%8C-%E8%99%9A%E6%8B%9F/">https://blog.mwish.me/2020/11/08/%E8%BD%AF-%E7%A1%AC%E7%9A%84%E5%88%86%E7%95%8C-%E8%99%9A%E6%8B%9F/</a></li></ol><h3 id="å…¶ä»–"><a href="#å…¶ä»–" class="headerlink" title="å…¶ä»–"></a>å…¶ä»–</h3><ol><li>RISC-V åŸºæœ¬æŒ‡ä»¤ï¼š<a href="https://blog.mwish.me/2020/03/28/RISC-V-GetStart/">https://blog.mwish.me/2020/03/28/RISC-V-GetStart/</a></li><li>RISC-V æŒ‡ä»¤æ ¼å¼ï¼š<a href="https://blog.mwish.me/2020/10/04/RISC-V-%E6%8C%87%E4%BB%A4%E6%A0%BC%E5%BC%8F/">https://blog.mwish.me/2020/10/04/RISC-V-%E6%8C%87%E4%BB%A4%E6%A0%BC%E5%BC%8F/</a></li><li>libc å’Œ æ ‡å‡†åº“ï¼š<a href="https://blog.mwish.me/2020/04/04/CALL-libc-%E5%92%8C-C-%E6%A0%87%E5%87%86%E5%BA%93/">https://blog.mwish.me/2020/04/04/CALL-libc-%E5%92%8C-C-%E6%A0%87%E5%87%86%E5%BA%93/</a></li><li>äºŒè¿›åˆ¶è¡¥ç ã€æ•´æ•°ã€æµ®ç‚¹æ•°ã€å¤§å°ç«¯ï¼š<a href="https://blog.mwish.me/2020/09/19/Integer-Endian/">https://blog.mwish.me/2020/09/19/Integer-Endian/</a></li></ol><h2 id="Courses"><a href="#Courses" class="headerlink" title="Courses"></a>Courses</h2><p>ç„¶åæ˜¯ä¸€äº›è¯¾ç¨‹ï¼š</p><ol><li>UCB cs61c: æ¯”è¾ƒå…¥é—¨çš„è¯¾ç¨‹ï¼Œç®—æ˜¯ä½“ç³»ç»“æ„ç‰ˆ CSAPP. æˆ‘ä¸Šé¢å¾ˆå¤šåŸºç¡€æ¦‚å¿µåŸºæœ¬éƒ½æ˜¯è¿™é‡Œ Build çš„</li><li>UCB cs152: cs61c çš„åç»­ï¼Œæ­£ç»ç³»ç»Ÿç»“æ„</li><li>CMU 15-418: CMU çš„ HPCï¼Œå¾ˆå¤šå›¾å’Œåˆ†ææ€è·¯éå¸¸å¥½</li><li>ETHz dphpc 2019: åŒ…æ‹¬äº†ä¸€äº› Lock-free ä¹‹ç±»çš„ä¸œè¥¿ï¼Œå¾ˆ pratical</li></ol><h2 id="Books-and-websites"><a href="#Books-and-websites" class="headerlink" title="Books and websites"></a>Books and websites</h2><p>æœ€åæ˜¯ä¸€äº›å¤–éƒ¨èµ„æºï¼š</p><ol><li>Computer Organization and Design RISC-V Edition : The Hardware Software Interface</li><li><a href="https://www.agner.org/">https://www.agner.org/</a></li><li>Computer Architecture: A Quantitative Approach, 6th</li><li>æ·±å…¥æµ…å‡ºSSD : å›ºæ€å­˜å‚¨æ ¸å¿ƒæŠ€æœ¯ã€åŸç†ä¸å®æˆ˜</li><li>What Every Programmer Should Know About Memory</li></ol>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Delta Lake &amp; Lakehouse</title>
      <link href="/2022/05/01/Delta-Lake-Lakehouse/"/>
      <url>/2022/05/01/Delta-Lake-Lakehouse/</url>
      
        <content type="html"><![CDATA[<p>æˆ‘çš„å‹äºº xzt è€å¸ˆæ›¾ç»å¯¹æˆ‘è¯´è¿‡ä¸€ä¸ªç¬‘è¯ï¼Œå¤§æ¦‚é•¿è¿™æ ·ï¼š</p><blockquote><p>é«˜æƒ…å•†ï¼šâ€æˆ‘ä»¬æœ‰åŸºäºæ•°æ®æ¹–çš„æ•°æ®ç®¡ç†ç³»ç»Ÿâ€<br>ä½æƒ…å•†ï¼šâ€ä½ è¦åœ¨ HDFS ä¸Šæ‰‹å†™ MapReduce ä»»åŠ¡â€</p></blockquote><p>æˆ‘ä¸€ç›´è§‰å¾—è¿™æ˜¯ä¸ªæ²¡æ¯›ç—…çš„è¯´æ³•ï¼Œæ‰€ä»¥å¯¹æœ€è¿‘åˆ›ä¸šçš„å„ç§ä¸œè¥¿æ„Ÿè§‰æ¯”è¾ƒå›°æƒ‘ã€‚å°¤å…¶æ˜¯ä¹‹å‰ä¸Šç½‘æœäº†ä¸€æ³¢æ•°æ®æ¹–æ˜¯ä»€ä¹ˆï¼Œæ„Ÿè§‰ä»–ä»¬è®²çš„éƒ½æ˜¯ä¸€äº›å“²å­¦æ¦‚å¿µè€Œä¸æ˜¯æŠ€æœ¯ã€‚ä»Šå¤©çœ‹äº†çœ‹ Databricks çš„ Delta Lake å’Œ Lakehouseï¼Œæƒ³äº†æƒ³ï¼Œç»ˆäºçŸ¥é“æ•°æ®æ¹–è¿™ä¸ªæ‰¹è¯æŒ‡çš„æ˜¯ä»€ä¹ˆä¸œè¥¿äº†ã€‚</p><p>Delta Lake æä¾›äº†ä¸€ä¸ªç±»ä¼¼è¡¨æ ¼çš„æœåŠ¡ï¼Œåœ¨ S3 ä¸Šæä¾›äº† ACID è¯­ä¹‰ã€‚å®ƒå­˜å‚¨ç±»ä¼¼ Parquet è¿™æ ·æ”¯æŒ nested çš„æ ¼å¼ï¼Œå¹¶ä¸”ç»™æ¯åˆ—æ•°æ®ä¸€äº›æè¿°å…ƒä¿¡æ¯ã€‚åŒæ—¶ï¼Œå®ƒæœ¬èº«çš„ Schema åº”è¯¥æ˜¯æŸ”æ€§çš„ï¼Œå¯¹æ¯”åˆ°è¡Œå­˜ç±»ä¼¼ Protobufã€Avro è¿™ç§è½¯çš„æ ¼å¼ã€‚å¯¹å‰å°å†™å…¥è€Œè¨€ï¼ŒDelta Lake çš„ä¸Šè¿°å†…å®¹æä¾›äº† ACID çš„å†™å…¥ï¼Œè¿™ç‚¹å¯¹ç”¨æˆ·è¿˜æ˜¯æ¯”è¾ƒé‡è¦çš„ï¼Œè¿™é‡Œå¯ä»¥å¯¹æ¯” Hiveï¼Œç”¨æˆ·çå‡ æŠŠæ”¹äº†ä¸€å †æ•°æ®ç„¶åä»»åŠ¡æŒ‚äº†ï¼Œä½ è¿™å †ä¸œè¥¿ä½ çœ‹ä½ ç•™ä¸ç•™ï¼ŸDelta Lake å¾ˆå¥½çš„è§£å†³äº†è¿™ä¸ªé—®é¢˜ã€‚Delta Lake æä¾›äº†åœ¨ OSS ä¸Šå®ç° ACID è¯­ä¹‰çš„é€»è¾‘ï¼Œå¹¶æ”¯æŒäº† Streaming ç­‰æ¥å£ï¼ˆä½†ä¸å¤ªæ˜¯ç»™ Streaming åŸç”Ÿè®¾è®¡çš„ï¼Œæ„Ÿè§‰å†™å…¥æ€§èƒ½è¿˜æ˜¯å—é™çš„ï¼‰ã€‚</p><p>å¯¹æ•°æ®åˆ†æå¸ˆæˆ–è€…å„ç§ç”¨æˆ·è€Œè¨€ï¼Œæ¯”è¾ƒé‡è¦çš„æ˜¯ <code>Optimize</code> æ“ä½œã€‚è¿™ä¸ªæœ‰ç‚¹ç±»ä¼¼ LSM çš„ Compactionï¼Œä¼šæŠŠé›¶æ•£çš„ Parquet æ–‡ä»¶ç»„ç»‡æˆä¾¿äºåˆ†æçš„ Parquet æ–‡ä»¶ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¼¼ä¹è¢«ç§°ä½œ Clustering : æŠŠä½ å†™çš„é‚£äº›ä¹±ä¸ƒå…«ç³Ÿçš„ Schema ç»„ç»‡æˆä¸€äº›æ¯”è¾ƒç»“æ„åŒ–çš„ã€ä¾¿äº AP æŸ¥è¯¢æ‰§è¡Œçš„ Schemaï¼Œç„¶åè¿™äº›æ–‡ä»¶å¯¹äºæ¯åˆ—ä¼šæœ‰ä¸€äº› <code>min-max</code> æç´¢å¼•ä¿¡æ¯ï¼Œå¸®åŠ©ä¸Šå±‚æŸ¥è¯¢è·³è¿‡ã€‚è¿™éƒ¨åˆ†åœ¨ Delta Lake è®ºæ–‡æœ‰ç®€çŸ­æè¿°ã€‚</p><p>å¯¹äºä¸Šå±‚ç³»ç»Ÿè€Œè¨€ï¼ŒLakehouse å¯¹ Delta Lake æä¾›äº†å…ƒæ•°æ®å±‚ã€ç¼“å­˜å’Œä¸€äº›ç«¯åˆ°ç«¯çš„ APIï¼Œåšåˆ°äº†å—¯èˆ”ç”¨æˆ·ã€‚</p><p><img src="https://image.mwish.me/blog-image/C7203105-EDF4-4E9C-92D3-21C031F4E77B.png" alt="C7203105-EDF4-4E9C-92D3-21C031F4E77B"></p><p>å›è¿‡å¤´æ¥è¯´ï¼Œå¦‚æœè¯´ snowflake æ˜¯å‘ç°äº†äº‘ä¸Š â€œä¸è·‘çš„æœºå™¨å¯ä»¥ä¸æ”¶è´¹â€ + â€œAP Workload æ²¡æœ‰é‚£ä¹ˆå»¶æ—¶æ•æ„Ÿâ€ + â€œç®—ä¸æ¥çš„ä¸œè¥¿å¤šè°ƒæœºå™¨å°±è¡Œäº†â€ï¼Œé‚£ä¹ˆ Delta Lake + Lakehouse åˆ™æ˜¯ â€œäº‘ä¸Šä½æ€§èƒ½ Batch ACIDâ€ + â€œCompaction é˜¶æ®µè°ƒæ•´æ ¼å¼â€ã€‚å…³äº Cache å…¶å®å’Œ Snowflake å·®ä¸å¤šã€‚</p><p>æœ¬æ¥æƒ³å†™ç‚¹ä»€ä¹ˆçš„ï¼Œä½†æ˜¯æ„Ÿè§‰çŸ¥é“å®ƒåœ¨åšä»€ä¹ˆå°±ç´¢ç„¶æ— å‘³äº†â€¦æ‰€ä»¥å°±å‘ä¸ªè¿™ä¹ˆçŸ­çš„äº†ã€‚</p><h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><ol><li>æ·±åº¦å¯¹æ¯”deltaã€icebergå’Œhudiä¸‰å¤§å¼€æºæ•°æ®æ¹–æ–¹æ¡ˆ: <a href="https://zhuanlan.zhihu.com/p/110748218">https://zhuanlan.zhihu.com/p/110748218</a></li><li>é€šè¿‡æ•°æ®ç»„ç»‡åŠ é€Ÿå¤§è§„æ¨¡æ•°æ®åˆ†æ: <a href="https://zhuanlan.zhihu.com/p/354334895">https://zhuanlan.zhihu.com/p/354334895</a></li><li>ã€è®ºæ–‡åˆ†äº«ã€‘ä»Lakehouseçœ‹Databrickså¯¹ä¸‹ä¸€ä»£æ•°æ®æ¹–æ¶æ„çš„ç†è§£ - ShallowMindçš„æ–‡ç«  - çŸ¥ä¹ <a href="https://zhuanlan.zhihu.com/p/462094560">https://zhuanlan.zhihu.com/p/462094560</a></li><li>æ•°æ®æ¹–ç«Ÿç„¶èƒ½å’Œæ•°æ®ä»“åº“æ‰“é€šï¼Ÿå¦‚ä½•è¯„ä»·é˜¿é‡Œäº‘æ¨å‡ºçš„æ¹–ä»“ä¸€ä½“è§£å†³æ–¹æ¡ˆï¼Ÿ - è´¾æ‰¬æ¸…çš„å›ç­” - çŸ¥ä¹ <a href="https://www.zhihu.com/question/421711474/answer/1480957849">https://www.zhihu.com/question/421711474/answer/1480957849</a></li></ol>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>ARIES/IM</title>
      <link href="/2022/04/30/ARIES-IM/"/>
      <url>/2022/04/30/ARIES-IM/</url>
      
        <content type="html"><![CDATA[<p><code>&lt;ARIES/IM: An Efficient Management Method and High Concurrency index Using Write-Ahead Logging&gt;</code> æè¿°äº† ARIES æ˜¯å¦‚ä½•ç»´æŠ¤ç´¢å¼•ç›¸å…³çš„ Latch å’Œ Lock çš„ã€‚åœ¨ B+Tree ä¸Šå¯èƒ½ä¼šæ¶‰åŠ IO ã€SMO ç­‰æƒ…å†µï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¯¹ä¸€ä¸ªæ ‘çš„æŸ¥è¯¢è¦ä¿è¯é«˜æ€§èƒ½ã€å¹¶å‘å®‰å…¨ã€‚</p><p>ARIES/IM åœ¨ç´¢å¼•å’Œ Lock ä¸Šçš„æƒ³æ³•æ˜¯ï¼š</p><ol><li>Data Lock, åªåœ¨ Data ä¸Šä¸Šé”ï¼ŒIndex ä¸Šä¸ä¸Šé”</li><li>ä¸ºäº†å¹¶å‘ï¼Œå°½é‡å°‘çš„è·å–è¦ç­‰å¾…åˆ° Commit é˜¶æ®µçš„ Locking</li><li>å…è®¸æŸ¥æ‰¾/åˆ é™¤/æ’å…¥å’Œ SMO ä¸€èµ·æ‰§è¡Œ</li></ol><p>ARIES/IM æœ¬èº«ä½¿ç”¨ ARIES åšæ¢å¤ï¼Œä¼šå¯¹ Page è¿›è¡Œ Redo å’Œ Undoï¼ŒARIES/IM ä¿è¯è¿™äº›éƒ½æ˜¯ Page çº§åˆ«ä¸Šæ‰§è¡Œçš„ã€‚</p><p>2/3 éƒ½æ¯”è¾ƒå¸¸è§ï¼Œ(1) éœ€è¦é¢å¤–è§£é‡Šä¸€ä¸‹ï¼Œæˆ‘ä»¬ä» hedengcheng çš„ slide é‡Œé¢å¼•ä¸€å¼  InnoDB é”çš„å›¾ï¼š</p><p><img src="https://image.mwish.me/blog-image/3243D20E-840B-42F1-9221-1963EAA12616.png" alt="3243D20E-840B-42F1-9221-1963EAA12616"></p><p>è¿™é‡Œçš„é”æ˜¯ Index + Data(Primary Key), ç„¶åæŸ¥è¯¢ä½¿ç”¨çš„ Index ä¹Ÿéœ€è¦ä¸Šé”ã€‚ARIES/IM è¿™é‡Œåªéœ€è¦ç»™ Primary Key æˆ–è€… Heap Tuple ä¸Šé”ã€‚</p><p>ARIES/IM è®ºæ–‡åº”è¯¥ä½¿ç”¨çš„æ˜¯ Heap Tuple æ¨¡å‹ã€‚åœ¨è®ºæ–‡ä¸­ï¼Œç´¢å¼•çš„å¶å­ç»“ç‚¹åŒ…å« <code>&lt;key-value, recordID&gt;</code>, æ¨¡å‹ä¸­ï¼Œå¶å­ç»“ç‚¹è¢«åŒå‘é“¾æ¥ï¼Œéå¶å­ç»“ç‚¹æœ‰æŒ‡å‘ä¸‹å±‚çš„æŒ‡é’ˆå’Œå¯¹åº”çš„ <code>high key</code>ã€‚éå¶å­ç»“ç‚¹çš„ High Key ä¸€å®šæ¯”ä¸‹å±‚çš„ High Key å¤§ã€‚</p><p>ARIES/IM æä¾›äº†ä¸‹åˆ—çš„ç´¢å¼•åŸè¯­ï¼š</p><ol><li><code>Fetch(Key or Partial-key, starting-condition)</code>, <code>starting-condition</code> åŒ…å« <code>Eq</code> ã€<code>GT</code> å’Œ <code>GTE</code>ï¼Œç„¶åæ‹¿åˆ°æ•´ä¸ª Key</li><li><code>FetchNext(stopping-condition)</code>: å¯¹ <code>Fetch</code> çš„ç»“æœï¼Œç„¶æ‹¿åˆ°ä¸‹ä¸€ä¸ª key</li><li><code>Insert(key-value, RID)</code>: æ’å…¥ <code>(key-value, RID)</code> å¯¹. å¯¹äº <code>unique</code> çš„ç´¢å¼•æ¥è¯´ï¼Œè¿™é‡Œéœ€è¦æŸ¥æ‰¾åˆ°è¿™ä¸ª <code>key</code> æ˜¯å¦é‡å¤ï¼Œå„¿å¯¹äº <code>nonunique index</code>, <code>(key-value, RID)</code> å¯¹éœ€è¦æŸ¥æ‰¾æ˜¯å¦é‡å¤</li><li><code>Delete(key)</code> åˆ  <code>key</code> (è¿™ä¸ªæ¥å£æˆ‘è§‰å¾—æ€ªæ€ªçš„ï¼Œæ˜¯ä¸æ˜¯è¿˜å¾—åŠ ä¸ª <code>RID</code>?)</li></ol><p>é‚£ä¹ˆï¼Œè¿™å¥—ä¸œè¥¿è€ƒè™‘å¹¶å‘å’Œ Recoverï¼Œå¯èƒ½æœ‰ä¸‹åˆ—çš„é—®é¢˜ï¼š</p><ol><li>å¯¹ Index éœ€è¦è®°å½•ä»€ä¹ˆæ ·çš„æ—¥å¿—ï¼Œæ¥ä¿è¯å®Œæ•´ï¼ˆä¸ä¸¢æ•°æ®ï¼‰ã€é«˜æ€§èƒ½æ¢å¤</li><li>SMO åœ¨å‘ç”Ÿçš„æ—¶å€™å´©æºƒäº†ï¼Œæ¢å¤çš„æ—¶å€™ä¿è¯æ²¡æœ‰é—®é¢˜</li><li>å¦‚ä½•æå‡ Page ä¸Šè®¿é—®çš„å¹¶å‘åº¦</li><li><strong>å‡å¦‚äº‹åŠ¡åœ¨ Rollback çš„æ—¶å€™ï¼Œå·²ç»å®Œæˆäº†æŸä¸ª SMOï¼Œå®ƒå¯ä»¥ä¸ç”¨ UNDO è¿™ä¸ª SMO</strong></li><li>å¦‚ Figure1ï¼Œå¦‚ä½•ä¿è¯ SMO å‘ç”Ÿçš„æ—¶å€™ï¼ŒPage è¢«ç§»åŠ¨åˆ°äº†åˆ«çš„åœ°æ–¹ï¼Œè¿™ä¸ªæ—¶å€™ï¼Œå¦‚æœè¦ rollback T1ï¼Œè¿™ç§åŸºäº Page çš„ Undo å¯èƒ½ä¼šå•¥éƒ½åˆ ä¸æ‰ï¼Œéœ€è¦ä»ä¸Šå±‚æ¥åšä¸€ä¸ª Logical Undoã€‚éœ€è¦èƒ½å¤Ÿé˜»æ­¢æˆ–è€…æ£€æµ‹å‡ºè¿™ç§ç»“æœ</li><li>(5) è®²è¿°çš„æ˜¯æ’å…¥ - SMO - abort çš„æƒ…å†µï¼ŒåŒæ ·è¿™é‡Œè¿˜æœ‰ åˆ é™¤ - SMO - abort çš„æƒ…å†µï¼Œä¹Ÿè¦èƒ½å¤Ÿæ­£ç¡®æ¢å¤</li><li>æ€ä¹ˆé˜²æ­¢ Rollback çš„æ—¶å€™ï¼Œäº‹åŠ¡å‡ºç° Deadlock</li><li>æ€ä¹ˆè®¾è®¡ä¸åŒçº§åˆ«çš„é”</li><li>RR çš„éš”ç¦»çº§åˆ«ä¸‹ï¼Œæ€ä¹ˆåšè°“è¯é”</li><li>æ€ä¹ˆä¿è¯ä¸€ä¸ª Unique Index ä¸­ï¼ŒA åˆ æ‰äº†ä¸€ä¸ª Keyï¼ŒB éœ€è¦æ’å…¥åŒä¸€ä¸ª Keyï¼Œè€Œ A å¯èƒ½ Abort çš„æƒ…å†µ</li><li>SMO å‘ç”Ÿçš„åŒæ—¶ï¼ŒTree Traversal ä¹Ÿèƒ½æ­£ç¡®æ‰§è¡Œ</li></ol><p><img src="https://image.mwish.me/blog-image/0C7F9D1B-691F-4186-ACA5-5D537870631F.png" alt="0C7F9D1B-691F-4186-ACA5-5D537870631F"></p><p>å…³äº ARIES Recover å¯ä»¥å‚è€ƒæˆ‘ä¹‹å‰çš„ Blog: <a href="https://blog.mwish.me/2021/08/07/Database-Recover-System/">https://blog.mwish.me/2021/08/07/Database-Recover-System/</a></p><h2 id="Concurrency-Control"><a href="#Concurrency-Control" class="headerlink" title="Concurrency Control"></a>Concurrency Control</h2><p>è¿™éƒ¨åˆ†çš„ Concurrency Control ä¸æ¶‰åŠ Recover. æœ‰ä¸€éƒ¨åˆ† <code>Del_Bit</code> å’Œ Recover æœ‰å…³ï¼Œå¯ä»¥ä¸ç”¨ç†è§£ã€‚</p><p>è¿™é‡Œè´´ä¸€ä¸‹ Data-Only Lock ç›¸å…³çš„ä¸Šé”è§„åˆ™ï¼š</p><p><img src="https://image.mwish.me/blog-image/AFE6B33F-70C6-472E-8F22-49A49FAFC5F0.png" alt="AFE6B33F-70C6-472E-8F22-49A49FAFC5F0"></p><p>ç»†å¿ƒçš„ä½ å¯èƒ½å‘ç°äº†ï¼Œè¿™é‡Œè¿˜æœ‰ä¸ª index-specific lockingï¼ŒARIES/IM è®¤ä¸º index-specific locking å¯èƒ½å¯ä»¥æå‡å¹¶å‘èƒ½åŠ›ï¼Œä½†æ˜¯ä¼šå¢åŠ å®ç°çš„å¤æ‚æ€§å’Œç»´æŠ¤é”çš„ä»£ä»·ã€‚</p><p>åœ¨æ”¯æŒ RR / ç»´æŠ¤ Unique Index çš„æ—¶å€™ï¼Œåœ¨åˆ é™¤æˆ–è€…æ’å…¥ä¸€ä¸ª key çš„æ—¶å€™ï¼Œéœ€è¦å¯¹ä¸‹ä¸€ä¸ª key ä¸Šé”ï¼Œè¿™ç§ç­–ç•¥è¢«ç§°ä¸º <code>next-key locking</code>. åœ¨ <code>Fetch</code> å’Œ <code>Fetch Next</code> çš„æ—¶å€™ï¼Œè‹¥ Key ä¸å­˜åœ¨ï¼Œä¹Ÿè¦è€ƒè™‘è¿™ä¸ªé—®é¢˜ã€‚</p><p>Latching: Latching ç»´æŠ¤äº† Page å’Œ B+Tree ç‰©ç†ç»“æ„ä¸Šçš„ä¸€è‡´æ€§ã€‚åœ¨ Index è®¿é—®çš„æ—¶å€™ï¼Œä¸ä¼š Grab æ•°æ®é¡µçš„ Latchã€‚è·å¾— Latch çš„é¡ºåºæ˜¯ä¸‹é™è·å–çš„ï¼Œè¿™ä¸ªæµç¨‹è¦éµå¾ª <strong>Latch Coupling</strong>:</p><ol><li>å…ˆé”å®šæ ¹èŠ‚ç‚¹ï¼Œä»æ ¹èŠ‚ç‚¹ä¸‹é™</li><li>æŒ‰ç…§é”å¶å­ç»“ç‚¹ â€” åˆ‡æ¢ â€” ä¸‹é™ â€” é‡Šæ”¾çˆ¶èŠ‚ç‚¹é”çš„è¿‡ç¨‹è¿›è¡Œä¸‹é™ã€‚ä¸­é—´å…¨éƒ½æ˜¯ S Latchï¼Œåˆ°æ ¹èŠ‚ç‚¹çš„æ—¶å€™ï¼Œæ ¹æ®æ“ä½œç±»å‹æ¥å†³å®šæ˜¯ S è¿˜æ˜¯ X</li></ol><p>è¿™é‡Œè¿˜æœ‰ SMO å¯¹åº”çš„å¤„ç†ï¼Œå½“ä¸€ä¸ª Txn æ‰§è¡Œ Split çš„æ—¶å€™ï¼Œåˆ«çš„äº‹åŠ¡è¦ä¿è¯æ­£ç¡®å¤„ç†ã€‚ARIES/IM ä¼šè¦æ±‚ã€Œå‘å³åˆ†è£‚ã€ï¼Œå³æŠŠ higher key ç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ã€‚ç„¶å Bottom-Up çš„åˆ†è£‚ï¼ŒBottom-Up è¿™ä¸ªé¡ºåºå’ŒæŸ¥æ‰¾çš„æ—¶å€™ä¸‹é™çš„é¡ºåºæ˜¯ç›¸åçš„ï¼Œä¸ºäº†é¿å… Latch çš„æ­»é”ï¼ŒARIES/IM å¼•å…¥äº† <code>SM_Bit</code>ï¼Œç„¶ååœ¨ SMO çš„æ—¶å€™ä¼šåš <code>SM_Bit</code> æ ‡è®°ï¼Œéšä¹‹é‡Šæ”¾é” - ä¸Šå‡ã€‚è€Œä¸‹é™çš„æ—¶å€™ä¼šæ³¨æ„åˆ° <code>SM_Bit</code>, è¿›è¡Œä¸€äº›åˆ«çš„æ“ä½œï¼Œç­‰å¾… SMO å®Œæˆã€‚</p><p>é‚£ã€Œåˆ«çš„æ“ä½œã€ æ˜¯ä»€ä¹ˆå‘¢ï¼ŸARIES/IM å¼•å…¥äº†ä¸€ä¸ª B+Tree çº§åˆ«çš„ <code>RWLatch</code>: <code>TreeLatch</code>ï¼Œä¾› SMO åŒæ­¥ä½¿ç”¨ï¼ŒSMO ä¼š <code>Grab X Latch on TreeLatch</code>ï¼Œç„¶åä¸‹é™çš„æ—¶å€™ï¼Œå¦‚æœæ³¨æ„åˆ°äº† <code>SM_Bit</code>ï¼Œè¿™é‡Œéœ€è¦æ”¾é” -&gt; <code>Grab S Latch on TreeLatch</code>ï¼Œç­‰å¾… SMO å®Œæˆ. ç„¶åå¦‚æœæŸä¸ªèŠ‚ç‚¹æ‹¿åˆ°äº† <code>S Latch</code>ï¼Œè¿™é‡Œå®ƒå°±å¯ä»¥æ¸…æ‰ <code>SM_Bit</code> äº†ï¼Œå› ä¸º SMO å·²ç»å®Œæˆäº†ã€‚è¿™ä¸ª <code>TreeLatch</code> åŒæ—¶ä¹Ÿä¿è¯äº†å†™å…¥çš„ä¸²è¡Œæ€§ã€‚</p><p>ä¸Šé¢çš„éƒ¨åˆ†æ˜¯ç®—æ³•çš„å¤§æ„ï¼Œä¸‹é¢è¿™é‡Œè¦è®²ä¸€è®²å…·ä½“æ€ä¹ˆå®ç°ï¼Œå€¼å¾—ä¸€æçš„æ˜¯ï¼Œä¸‹é¢çš„éƒ¨åˆ†æœ‰ä¸€ä¸ª <code>Del_Bit</code>ï¼Œè¿™ä¸ªå’Œ Recover æœ‰å…³ï¼Œå…ˆä¸ç”¨ç®¡ï¼Œç„¶åè®ºæ–‡ä¼°æ‘¸ç€æ˜¯å‡è®¾ Page å…¨åœ¨å†…å­˜ä¸­ï¼Œæ²¡æœ‰è€ƒè™‘ä¸åœ¨å†…å­˜ä¸­çš„æƒ…å†µã€‚</p><h3 id="Fetch"><a href="#Fetch" class="headerlink" title="Fetch"></a>Fetch</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">/* for simplicity, root = leaf case not specified here */</span><br><span class="line">S latch root and note root&#x27;s page_LSN</span><br><span class="line">Child := Root</span><br><span class="line">Parent := NIL</span><br><span class="line"></span><br><span class="line">// ä¸‹é™</span><br><span class="line">Descend:</span><br><span class="line">  IF child is a leaf AND Op is (insert OR delete) THEN</span><br><span class="line">  X latch child</span><br><span class="line">  ELSE S latch child</span><br><span class="line">  Node child&#x27;s page_LSN</span><br><span class="line">  IF child is a nonleaf page:</span><br><span class="line">  IF nonempty child &amp; ((input key &lt;= highest key in child) OR (input key &gt; highest key in child &amp; SM_Bit == 0)):</span><br><span class="line">  // æ“ä½œæ˜¯å®‰å…¨çš„, å¯ä»¥è¿›è¡Œ</span><br><span class="line">  IF Parent != NIL:</span><br><span class="line">  unlatch parent</span><br><span class="line">  Parent := Child</span><br><span class="line">  Child := Page_Search(Child)</span><br><span class="line">  goto Descent</span><br><span class="line">  ELSE:</span><br><span class="line">  // input key æ¯” highest key å¤§, ä¸” SM_Bit è¢«æ ‡è®°äº†, è¯´æ˜æœ‰ SMO</span><br><span class="line">  Unlatch parent &amp; child</span><br><span class="line">  S latch TreeLatch for instant duration // ä¸»åŠ¨é” TreeLatch, ç­‰å¾… SMO ç»“æŸ</span><br><span class="line">  Unwind recursion based on noted page_LSNs, and Descend // æ ¹æ® page_LSNs å›æ»š</span><br><span class="line">  ELSE:</span><br><span class="line">  Case Op:</span><br><span class="line">  Fetch: // ä¸Š S latch ä»€ä¹ˆçš„</span><br><span class="line">  Insert: // ä¸Š X latch ä»€ä¹ˆçš„</span><br><span class="line">  Delete: // ...</span><br><span class="line">   END</span><br></pre></td></tr></table></figure><p>ä¸Šé¢è¡¨ç°äº†ä¸€ä¸ª <code>Descend</code> çš„æµç¨‹ï¼Œå…·ä½“è¿˜æœ‰ä¸€ä¸ª Fetch çš„æµç¨‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Find requested or next higher key(maybe on NextPage)</span><br><span class="line">Unlatch parent</span><br><span class="line">Request conditional S lock on found key</span><br><span class="line">IF lock granted:</span><br><span class="line">Unlatch child &amp; return found key</span><br><span class="line">ELSE:</span><br><span class="line">Note LSN and key position and unlatch child // æœ‰åˆ«çš„å é”äº†</span><br><span class="line">Request unconditional lock on key</span><br><span class="line">Once lock granted backup &amp; search if needed</span><br></pre></td></tr></table></figure><p>è¿™é‡Œ Lock éœ€è¦æ‹¿åˆ°äº† Latch å†ä¸Š, ä¿è¯æ­£ç¡®æ€§ã€‚è€Œä¸ºäº†ä¿è¯ next-key lockingï¼Œç”šè‡³å¯èƒ½è¦æå³ä¾§çš„ Pageã€‚åœ¨è·å–ä¸‹ä¸€ä¸ªé¡µé¢çš„ Page çš„æ—¶å€™ï¼Œä¸Šä¸€ä¸ªé¡µé¢çš„ Latch ä¸èƒ½è¢«é‡Šæ”¾ã€‚</p><p>è¿™é‡Œè¿˜æœ‰ä¸ªç‰¹ç‚¹å°±æ˜¯æ Page çš„æ—¶å€™ä¼šè®° <code>Page_LSN</code>ï¼Œæ²¡è¢«æ›´æ–°çš„è¯å°±è¯¥å’‹æ ·å’‹æ ·ï¼ŒPage è¢«æ›´æ–°äº†å°±è¦é‡æ¥ï¼Œæ£€æŸ¥ä¸€ä¸‹å‘ç”Ÿä»€ä¹ˆäº‹äº†ã€‚</p><p><code>conditional</code> åº”è¯¥æ˜¯ã€Œæ²¡è·å–åˆ°å°±å¤±è´¥ã€ï¼Œè€Œã€Œunconditionalã€æ˜¯ä¸€ç›´ç­‰å¾…è·å–åˆ°ã€‚è¿™é‡Œçš„ Lock æ˜¯ Commit Duration çš„ã€‚å¦‚æœæ‹¿åˆ°äº†æœ€åéƒ½æ²¡æœ‰ï¼Œåº”è¯¥è¦å¯¹ä¸€ä¸ªæœ€é«˜ Key çš„ç‰¹æ®Š Maximum è®°å½•ä¸Šé”ã€‚</p><h3 id="Fetch-next"><a href="#Fetch-next" class="headerlink" title="Fetch next"></a>Fetch next</h3><p>Fetch nextæµç¨‹é¦–å…ˆå®šä½ä¸€ä¸ªkeyï¼Œç„¶åè®°ä¸‹ <code>Page_LSN</code> å’Œä½ç½®ï¼Œç„¶åä¸æ–­é¡ºåºéå†ç¬¦åˆèŒƒå›´æŸ¥æ‰¾è¦æ±‚çš„keyï¼Œæ¯æ¬¡è¿”å›ä¸€ä¸ªç¬¦åˆè¦æ±‚çš„keyæ—¶éƒ½éœ€è¦è®°å½•ç›¸åº”çš„page_lsnã€‚ä¸‹ä¸€æ¬¡æŸ¥æ‰¾æ—¶éœ€è¦æ¯”è¾ƒpage_lsnï¼Œè‹¥page_lsnå˜æ›´ï¼Œè¯´æ˜é¡µè¢«ä¿®æ”¹ï¼Œæ­¤æ—¶éœ€è¦å†æ¬¡èµ°ä¸€æ¬¡ Fetchï¼Œæ¥é‡æ–°å®šä½ã€‚</p><h3 id="Insert"><a href="#Insert" class="headerlink" title="Insert"></a>Insert</h3><p>å¦‚æœ Leaf Page æœ‰è¶³å¤Ÿç©ºé—´ï¼Œè¿™é‡Œä¼šå®šä½åˆ°ç›¸åŒæˆ–è€…æ¯”è‡ªå·±å¤§çš„ key ä¸Šï¼Œç„¶å Grab X Lockï¼Œè¿›è¡Œæ’å…¥çš„ key çš„ lockingã€‚ä¸Šé”åï¼Œå†è¿›è¡Œ unique checkã€‚è¿™ä¸ªé”æ˜¯ Commit Duration çš„ã€‚</p><p>è¿™é‡Œè¿˜è¦å¯¹ next-key è¿›è¡Œ X lockï¼Œæ¥ä¿è¯é”å®šã€‚è¿™ä¸ªå¯èƒ½è¿˜ä¼šéœ€è¦é”å®šä¸‹ä¸€é¡µã€‚è¿™ä¸ª lock æ˜¯ instant çš„ï¼Œå®ƒåªç”¨æ¥é¿å… RR ä¸Šå‡ºç° Phantom Dataã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">IF SM_BIT | Del_Bit THEN:</span><br><span class="line">Instant S latch tree, set Bits to &#x27;0&#x27;</span><br><span class="line">Unlatch parent</span><br><span class="line">Find key &gt; insert key &amp; X lock it for instant duration</span><br><span class="line"></span><br><span class="line">Insert key, log and update page_LSN</span><br><span class="line">Release child latch</span><br></pre></td></tr></table></figure><p>å¦‚æœéœ€è¦åˆ†è£‚ï¼Œä¸ºäº†ç»´æŠ¤ B+Tree ç»“æ„ï¼Œè¿™ä¸ªéœ€è¦æŠŠé‚»å±…èŠ‚ç‚¹æä¸Šæ¥ï¼ˆç»´æŠ¤åŒå‘é“¾è¡¨ï¼‰ï¼Œç„¶åæŠŠæ¶‰åŠçš„ Page å…¨éƒ¨å¼„åˆ°å†…å­˜ä¸­ï¼Œå† Grab X Lockï¼Œè¿›è¡Œ SMOã€‚è¿™é‡Œæˆ‘ä»¬åªéœ€è¦äº†è§£ SMO ä¼šåˆ›å»ºä¸€ä¸ª sibling pageï¼Œç„¶åå¤„ç†ç»“æ„ï¼Œæ ‡è®° <code>SM_Bit</code>ï¼Œå±‚å±‚å‘ä¸Šã€‚</p><h3 id="Delete"><a href="#Delete" class="headerlink" title="Delete"></a>Delete</h3><p>Delete ä¼šå¯¹ Next-Key ä¸Š Commit Duration X Lockï¼Œç”¨æ¥é˜²æ­¢ä¹‹å‰é—®é¢˜ (10) ç­‰åœºæ™¯ã€‚æ­¤å¤–è¿˜æœ‰ä¸€äº›ç”¨äºæ¢å¤çš„é€»è¾‘ï¼Œæ¯”å¦‚åˆ é™¤è¾¹ç•Œå€¼çš„æ—¶å€™ï¼Œéœ€è¦ç»™æ•´ä¸ª Tree ä¸Šé”ï¼›åŒæ—¶éœ€è¦å¼•å…¥ <code>Del_Bit</code>ã€‚ä¹‹åä¼šåœ¨ Recovery é‡Œé¢è®¨è®ºè¿™äº›ä¸ªç»†èŠ‚</p><p>è¿™é‡Œå®ç°çš„ä¸ä¸€å®šæ˜¯æ ‡å‡†çš„ B+Treeï¼Œåªæœ‰åˆ ç©ºä¸€ä¸ª Page çš„æ—¶å€™ï¼Œæ‰ä¼šæ‰§è¡Œ DeletePage çš„ SMOã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">IF SM_Bit == 1:</span><br><span class="line">Instant S latch TreeNode and set SM_Bit to 0</span><br><span class="line">Set Delete_Bit to 1</span><br><span class="line">Unlatch parent</span><br><span class="line">Find key &gt; delete key &amp; X lock it for commit duration</span><br><span class="line">IF delete key is smallest/largest on page:</span><br><span class="line">S latch tree and set Delete_Bit to 0</span><br><span class="line">Delete key, log and update page_LSN</span><br><span class="line">Release child latch and tree latch, if held.</span><br></pre></td></tr></table></figure><h3 id="SMO"><a href="#SMO" class="headerlink" title="SMO"></a>SMO</h3><p><img src="https://image.mwish.me/blog-image/DCEB073D-03B6-482E-8207-E1ADFF2A70F0.png" alt="DCEB073D-03B6-482E-8207-E1ADFF2A70F0"></p><p>SMO é‡ç‚¹æ˜¯å’Œ Insert/Delete ä¸€èµ·è€ƒè™‘å¹¶å‘ã€‚è¿˜æœ‰ä¸€äº› Del_Bit çš„ hackingã€‚</p><h3 id="è®¨è®º"><a href="#è®¨è®º" class="headerlink" title="è®¨è®º"></a>è®¨è®º</h3><p>ä¸ºä»€ä¹ˆ Delete è¦ Commit Durationï¼›Insert åªè¦ Instant Duration å‘¢ï¼Ÿå®é™…ä¸Šï¼Œæ²¡æœ‰æäº¤çš„ Insert å¯¹å¤–éƒ¨æ˜¯ä¸€æ¡å¯è§è®°å½•ï¼Œè€Œ Delete åˆ™æ˜¯çœ‹ä¸åˆ°äº†ï¼ˆè®°å½•ç›´æ¥æ²¡äº†ï¼‰ã€‚æ‰€ä»¥æ’å…¥çš„æ—¶å€™æ”¾ä¸ª <code>&lt;key, value, RID&gt;</code>è®°å½•åœ¨è¿™ï¼Œçœ‹çœ‹åé¢æ˜¯ä¸æ˜¯æœ‰è®°å½•ï¼Œç„¶åå—¯æ’å°±è¡Œï¼Œåæ­£è‡ªå·±ä¸Šé¢æœ‰æŠŠé”ã€‚åˆ é™¤çš„æ—¶å€™æ¸…æ‰ <code>&lt;Key, value, RID&gt;</code>ï¼Œè‡ªå·± <code>RID</code> åˆ«äººä¹Ÿé”ä¸äº†äº†ï¼Œå°±åªèƒ½å—¯é”ä¸‹ä¸€ä¸ªã€‚</p><h2 id="Recovery-in-ARIES-IM"><a href="#Recovery-in-ARIES-IM" class="headerlink" title="Recovery in ARIES/IM"></a>Recovery in ARIES/IM</h2><p>è®ºæ–‡ä¹‹å‰çš„é—®é¢˜ä¹Ÿæåˆ°äº† Recoveryï¼ŒSMO ç”± Delete/Insert è§¦å‘ã€‚å¦‚æœ SMO åšå®Œäº†ï¼Œè€Œäº‹åŠ¡ Abort äº†ï¼ŒSMO ä¼šç…§å¸¸æ¨è¿›ä¸‹å»ï¼Œå¦‚å›¾ï¼š</p><p><img src="https://image.mwish.me/blog-image/2A164111-9675-4BB3-B8E8-8A14C35A62DF.png" alt="2A164111-9675-4BB3-B8E8-8A14C35A62DF"></p><p><img src="https://image.mwish.me/blog-image/C8A02D69-79C9-45EA-8109-998CB32759D4.png" alt="C8A02D69-79C9-45EA-8109-998CB32759D4"></p><p>åœ¨ Rollback çš„æ—¶å€™ï¼ŒDelete/Insert å¯ä»¥è¢«æ’¤é”€ï¼Œå¯¹äº Deleteï¼ŒRedo çš„æ—¶å€™åæ­£å…ˆ Delete äº†ï¼ŒSMOï¼Œç„¶åå†å¯¹æ•´ä¸ªæ ‘æ’å…¥ï¼›Insert çš„æ—¶å€™ï¼Œæ’å…¥çš„è®°å½•å†è¢«æ»šæ‰ã€‚å¦‚æœ SMO æ²¡æœ‰å†™ <code>Dummy CLR</code>ï¼Œé‚£ä¹ˆ SMO ä¼šè¢«å›æ»šã€‚åœ¨ <code>SMO</code> æœŸé—´ï¼Œæ“ä½œéœ€è¦å¯¹ <code>TreeLatch</code> åŒæ­¥ï¼Œæ‰€ä»¥å¯¹ Page å›æ»šæ˜¯å®‰å…¨çš„ã€‚</p><p>å½“ç„¶ï¼Œä½ ä¼šæ³¨æ„åˆ°ï¼Œ<strong>ä¸æ˜¯æ‰€æœ‰æ“ä½œéƒ½èƒ½åœ¨è¿™ä¸ªæµç¨‹ä¸­åšåˆ°å¯¹ Page å›æ»šçš„</strong>ã€‚å¦‚ Figure 10ï¼Œå½“è¿™ä¸ªäº‹åŠ¡å¤±è´¥ä½† SMO æˆåŠŸçš„æ—¶å€™ï¼ŒPage éƒ½æ²¡äº†ï¼Œæ€ä¹ˆå›æ»šå‘¢ï¼Ÿè¿™ä¸ªæ—¶å€™ï¼ŒARIES/IM ç­–ç•¥æ˜¯ <strong>å°½é‡å¯¹ Page ç‰©ç†å›æ»šï¼Œä¸è¡Œçš„è¯æ•´ä¸ªæ ‘ä¸‹æ¥åšé€»è¾‘åˆ é™¤</strong>ï¼Œå…·ä½“è€Œè¨€ï¼Œå‡è®¾äº‹åŠ¡åœ¨ $t_1$ æ—¶åˆ»è¿›è¡Œï¼Œ$t_2$ æ—¶åˆ» Undoï¼Œéœ€è¦æ‰§è¡Œ Logical Undo çš„è§„åˆ™æ˜¯ï¼š</p><ol><li>Undo Delete çš„æ—¶å€™ï¼ŒPage æ²¡æœ‰è¶³å¤Ÿç©ºé—´è¿›è¡Œæ’å…¥ï¼Œè¯´æ˜ t1-t2 æœŸé—´ï¼Œæœ‰ä¸€ä¸ªäº‹åŠ¡å æœ‰äº†åˆ é™¤çš„ç©ºé—´</li><li>Undo çš„æ—¶å€™ï¼Œkey ä¸å±äºåŸæ¥çš„ Pageï¼Œè¯´æ˜ t1-t2 æœŸé—´ï¼Œæœ‰ä¸€ä¸ªåˆ«çš„ SMO</li><li>ä¸çŸ¥é“ Key æ˜¯å¦å±äºåŸæ¥çš„ Pageï¼šåœ¨ Undo çš„æ—¶å€™ï¼Œå¯èƒ½æ’å…¥äº†ä¸€å †ç›¸åŒçš„è®°å½•ï¼Œå¯¼è‡´ä¸ç¡®å®šå…·ä½“å•¥æƒ…å†µ</li><li>Undo Insert å¯èƒ½å¯¼è‡´åŸæ¥çš„ Page å˜ç©ºã€‚è¿™æ˜¾ç„¶ä¸ç§‘å­¦ï¼Œè¯´æ˜ <strong>t1-t2 ä¹‹é—´æœ‰ä¸€ä¸ªå¯¹è¾¹ç•Œ key çš„åˆ é™¤</strong>ã€‚</li></ol><p>åœ¨ Undo é˜¶æ®µå¯èƒ½ä¹Ÿæœ‰ SMOã€‚ä¸€èˆ¬çš„ Undo çš„ CLR æ˜¯åªæœ‰æœ€ç»ˆé•œåƒçš„ï¼Œä½†æ˜¯ SMO å¯èƒ½å¤±è´¥ï¼Œæ‰€ä»¥ SMO çš„ Undo ä¹Ÿéœ€è¦å®Œæ•´çš„æ—¥å¿—ã€‚</p><p>åœ¨æ‰§è¡Œé˜¶æ®µï¼ŒUndo çš„æ—¶å€™å¦‚æœè¦ SMO ä¹Ÿéœ€è¦ <code>X TreeLatch</code>ï¼Œæ¥ä¸²è¡Œå¤„ç†ã€‚</p><p>å¯¹äºä¸€ä¸ª SMOï¼Œå½“æŒä¹…åŒ– <code>Dummy CLR</code> æ—¥å¿—çš„æ—¶å€™ï¼Œæ‰èƒ½é‡Šæ”¾ <code>X TreeLatch</code> (è¡¨ç¤ºè¿™æ¬¡ SMO å·²ç»å®Œæˆï¼Œå¯ä»¥æ¢å¤ï¼‰ã€‚</p><p>è¿™é‡Œ ARIES/IM è¿˜éœ€è¦ä¿è¯ Undo æ˜¯èƒ½å¤Ÿè¿›è¡Œçš„ï¼Œè¿™ä¸ªç‚¹æœ‰ç‚¹å¥‡æ€ªï¼Œä¸ºä»€ä¹ˆ Undo ä¼šä¸èƒ½è¿›è¡Œå‘¢ï¼Ÿå¯ä»¥å‚è€ƒä¸‹å›¾ï¼š</p><p><img src="https://image.mwish.me/blog-image/9658AEDC-3E91-4745-82C4-6ECFDB454404.png" alt="9658AEDC-3E91-4745-82C4-6ECFDB454404"></p><p>ä¸€ä¸ª SMO å¯èƒ½å¯¼è‡´ Delete çš„ Undo æ˜¯ä¸å¯è¿›è¡Œçš„ï¼è¿™ä¸ªæœªå®Œæˆçš„ SMO ä¼šå¯¼è‡´å¯¹ Delete çš„æ¢å¤æ— æ³•ä»æ ¹èŠ‚ç‚¹æ‰¾åˆ°ã€‚è¿™ä¸ªæ—¶å€™ä½ å¯ä»¥å‘ç° <code>Del_Bit</code> å’Œä¸²è¡ŒåŒ– SMO çš„å¦™å¤„äº†ã€‚</p><p>æˆ‘ä»¬å›åˆ°éœ€è¦æ‰§è¡Œ Logical Undo çš„è§„åˆ™ å’Œ <code>Delete</code> <code>Insert</code> çš„ä»£ç ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œ<code>TreeLatch</code> è¿™é‡Œæ‰¿æ‹…äº†ä¸€ä¸ªå¾ˆé‡è¦çš„åŒæ­¥ç‚¹ï¼Œæ¥ä¿è¯å¹¶å‘çš„å®‰å…¨æ€§ã€‚å½“ä½ éœ€è¦åˆ é™¤ã€åˆ è¾¹ç•Œ keyã€SMO çš„æ—¶å€™ï¼Œéƒ½è¦ä¸»åŠ¨æ‹¿ä¸€ä¸‹ Latch æ¥å¼ºåˆ¶åŒæ­¥ã€‚</p><h2 id="ä¼˜åŒ–å’Œå…¶ä»–åè®®"><a href="#ä¼˜åŒ–å’Œå…¶ä»–åè®®" class="headerlink" title="ä¼˜åŒ–å’Œå…¶ä»–åè®®"></a>ä¼˜åŒ–å’Œå…¶ä»–åè®®</h2><p>å¯ä»¥çœ‹åˆ°ï¼Œä¸Šè¿°ä¸€ä¸ªå¤æ‚ç‚¹æ˜¯ï¼Œåˆ é™¤çš„æ—¶å€™å¦‚æœç‰©ç†åˆ é™¤äº†ï¼Œå¯èƒ½å›æ»šçš„æ—¶å€™æœ‰é¢å¤–çš„åŠŸå¤«ã€‚Graefe Goetz æå‡ºè¿‡ä¸€ä¸ªé€»è¾‘åˆ é™¤ã€‚å³åˆ é™¤ä¸å®é™…ä» Page ä¸ŠæŠ¹é™¤è¿™æ¡è®°å½•ï¼Œè€Œæ˜¯ä¸€ä¸ªæ ‡è®°åˆ é™¤ï¼Œæ¥è§£å†³é—®é¢˜ã€‚ä¸è¿‡æˆ‘ä¸æ˜¯å¾ˆæ¸…æ¥šè¿™æ ·åˆ äº†ä¹‹åï¼Œéœ€è¦ç”¨ä»€ä¹ˆæ¡ä»¶æ¥ GC è¿™äº›æ•°æ®ã€‚</p><p>æ ‡è®°åˆ é™¤éœ€è¦å’Œ Purge çš„æµç¨‹è”åŠ¨èµ·æ¥ï¼Œè¿™é‡Œå¯èƒ½è¿˜ä¼šéœ€è¦ä¸€äº› mtrï¼Œæ¯”æ–¹è¯´æ ‡è®°åˆ é™¤åï¼Œç¡®å®šæŸä¸ªäº‹åŠ¡çš„ Garbage è®°å½•å¯ä»¥è¢«å›æ”¶ï¼Œé‚£å¯ä»¥å†™ä¸ª mtr æŠŠ Page ä¸Šçš„è¿™ä¸ªåƒåœ¾è®°å½•å›æ”¶æ‰ã€‚æ„Ÿè§‰è¿™ä¸ªç¨å¾®æœ‰ç‚¹ç±»ä¼¼ MVCCï¼Ÿ</p><p>è®ºæ–‡é‡Œæ²¡æœ‰æåˆ°æ ¹èŠ‚ç‚¹åˆ†è£‚çš„æƒ…å†µï¼Œä½†å®é™…ä¸Šè¿™æ˜¯ä¸€ä¸ªæ¯”è¾ƒå¤æ‚çš„ caseï¼Œå¯èƒ½ä¹Ÿéœ€è¦ grab ä¸€æŠŠé”æ¥è§£å†³ã€‚</p><p>InnoDB çš„ Btree æ„Ÿè§‰ç›¸å¯¹æ²¡è¿™ä¹ˆç»†ï¼Œä¸è¿‡ä¹Ÿå¯ä»¥çœ‹çš„å‡ºæ¥ä¸ºå•¥ã€‚æ„Ÿè§‰åœ¨é‚£ä¸Šé¢æ”¹å¹¶å‘ç±»ä¼¼ä¸€ä¸ªä¸å¯èƒ½å®Œæˆçš„ä»»åŠ¡äº†â€¦</p><p>å…³äºè¿™äº›ï¼Œå¯ä»¥çœ‹ alibaba çš„æ•°æ®åº“æœˆæŠ¥ï¼š</p><ol><li><a href="http://mysql.taobao.org/monthly/2020/06/02/">http://mysql.taobao.org/monthly/2020/06/02/</a></li><li><a href="http://mysql.taobao.org/monthly/2020/05/02/">http://mysql.taobao.org/monthly/2020/05/02/</a></li><li><a href="http://mysql.taobao.org/monthly/2020/11/02/">http://mysql.taobao.org/monthly/2020/11/02/</a></li><li><a href="http://mysql.taobao.org/monthly/2021/12/04/">http://mysql.taobao.org/monthly/2021/12/04/</a></li></ol><p>å¯ä»¥çœ‹åˆ°ï¼ŒMySQL 5.6 çš„ InnoDB è¿™é‡Œä¼šæœ‰ä¸€ä¸ª Btree Latchï¼Œç„¶ååœ¨ä¸‹é™çš„æ—¶å€™å¯èƒ½è¦ S Latch å®ƒï¼Œç„¶åä¸‹é™ï¼Œä¸‹é™ä¹‹åï¼Œæ ¹æ®æœ‰æ²¡æœ‰ SMOï¼Œæ¥åˆ¤å®šå‰©ä¸‹æ¥çš„æ“ä½œæ˜¯å¦è¦ Latch æ•´ä¸ªæ ‘ã€‚åŒæ—¶ï¼Œè¿™é‡Œåªæœ‰å¶å­ç»“ç‚¹ä¸Šæœ‰ Latchï¼Œnon-leaf page æ˜¯ä¸ä¼šä¸Šé”çš„ã€‚</p><p>InnoDB åœ¨ MySQL 8.0 å¼•å…¥äº† SX Lockï¼ˆç±»ä¼¼ rwlatchï¼Ÿï¼‰ï¼Œä¹Ÿå¼•å…¥äº† non-leaf page lockï¼Œä¸è¿‡ä»ç„¶æ˜¯æ¯”è¾ƒç²—ç²’åº¦çš„é”ã€‚</p><h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul><li>ARIES/IM: An Efficient Management Method and High Concurrency index Using Write-Ahead Logging</li><li>äºŒæ‰‹æ–‡ç«  ARIES/IM: <a href="http://mysql.taobao.org/monthly/2020/05/03/">http://mysql.taobao.org/monthly/2020/05/03/</a></li></ul>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>LLAMA: A Cache/Storage Subsystem for Modern Hardware</title>
      <link href="/2022/04/20/Notes-LLAMA/"/>
      <url>/2022/04/20/Notes-LLAMA/</url>
      
        <content type="html"><![CDATA[<p>Bw-Tree, å³ â€œBuzz Word Treeâ€ï¼Œç”±å¾®è½¯åœ¨ 2013 å¹´æå‡ºï¼ŒåŸºæœ¬æ˜¯ç»™ SQL Server åšå†…å­˜å¼•æ“çš„ã€‚Bw-Tree åŠå…¶åº•åº§ LLAMA çš„ä¸€ä½œ Justin Levandoski æœ€æ—©åœ¨ MSï¼Œåæ¥å»äº† Auroraï¼Œç°åœ¨åœ¨ Google BigQueryã€‚</p><p>Bw-Tree ä¸»è¦å†…å®¹æ˜¯ SSD å‹å¥½çš„æ•°æ®ç»“æ„ï¼Œå®ƒå¸Œæœ›å¯¹ Bw-Tree çš„æ“ä½œéƒ½æ˜¯ Lock-free çš„ï¼Œå®ƒçš„æ•°æ®åŸºäº Page (Inner node + Leaf node) + Log ï¼ˆDelta nodeï¼‰ï¼Œç”¨ Mapping Table å’Œ 64-bit uuid æ¥æ˜ å°„åˆ°å¯¹åº”çš„ node ï¼ˆPage æˆ–è€… Delta nodeï¼‰ï¼Œå®ƒç”¨ Epoch-based Reclaim æ¥å›æ”¶ç©ºé—´ï¼Œå›æ”¶çš„æ—¶å€™ï¼ŒBw-Tree å¹¶æ²¡æœ‰åšåˆ° interval-GCï¼ˆæˆ–è€…æ˜¯å®ƒè®ºæ–‡æ²¡è¯´ï¼‰ï¼Œç›¸å¯¹çš„ï¼Œåœ¨ Consolidation ï¼ˆLog + Page äº§ç”Ÿæ–°çš„ Pageï¼‰ä¹‹åï¼Œä¼šæŠŠæ—§çš„ Node ç»™æ”¾åˆ°å¯ GC çš„åŒºåŸŸä¸­ã€‚</p><p>å®ƒçš„åˆ†è£‚åˆå¹¶æ“ä½œå’Œ Blink-Tree æœ‰ä¸€ç‚¹ç›¸ä¼¼ï¼ŒSplit å’Œ Merge éƒ½åˆ†è£‚æˆå¤šä¸ªé˜¶æ®µï¼Œå¹¶å¼•å…¥äº† Split / Merge èŠ‚ç‚¹ã€‚SMO æœ¬èº«æ˜¯ä¸ªå¤šæ­¥çš„æ“ä½œï¼Œå½“å‘ç°ç³»ç»Ÿä¸­æœ‰ SMO çš„æ—¶å€™ï¼Œåˆ«çš„æ“ä½œä¼šå…ˆå¸®åŠ©æ¨è¿› SMOï¼ˆæœ‰ç‚¹åƒæ˜¯åœ¨è¯´è¿™ä¸ª SMO æ˜¯ wait-free çš„ï¼Ÿï¼‰ã€‚</p><p>Bw-Tree è®ºæ–‡åœ¨å›½å†…å·²ç»æœ‰ä¸å°‘äºŒæ‰‹æ–‡ç« äº†ï¼Œé™¤äº† Bw-Tree æ–‡ç« å¤–ï¼ŒCMU åœ¨ SIGMODâ€™18 å‘è¡¨äº†ä¸€ç¯‡æ–‡ç« ï¼Œæè¿°äº†ä¸€äº› In-memory çš„ Bw-Tree çš„è¡Œä¸ºå’Œå·¥ç¨‹ä¼˜åŒ–ï¼Œæµ‹è¯•(diss)äº†ä¸€ä¸‹å®ƒçš„æ€§èƒ½ã€‚ç¬”è€…è®¤ä¸ºï¼ŒB-Tree æ—çš„ç®—æ³•æ¯”è¾ƒå¤æ‚ï¼Œè€Œä¸”å’Œå®ç°é«˜åº¦ç›¸å…³ï¼Œç§»æ­¥è¿™äº›ä¸“ä¸šäººå£«å†™çš„äºŒæ‰‹æ–‡ç« ç›¸å¯¹æ¥è¯´æ›´é è°±ã€‚ä¸è¿‡ï¼Œå…³äº LLAMAï¼Œä»‹ç»çš„äºŒæ‰‹æ–‡ç« æ¯”è¾ƒå°‘ã€‚</p><p><img src="https://image.mwish.me/blog-image/84102576-8957-4691-92DB-772A07FB6F53.png" alt="84102576-8957-4691-92DB-772A07FB6F53"></p><p>LLAMA æä¾›äº†ä¸€ä¸ªæ‰€è°“  Log Structured â€œPageâ€ Store çš„å¼•æ“ï¼Œå¯¹ä¸Šå±‚æä¾› Page çš„æ¥å£å’Œ æ›´æ–°/è¦†ç›–(æ›¿æ¢) Pageï¼Œä½†åˆæä¾›ä»¥ Delta Log å’Œæ•´ä¸ª Page çš„å½¢å¼å†™å…¥å…·ä½“çš„å­˜å‚¨å±‚çš„æ¥å£ã€‚ä¸‹å±‚ç±»ä¼¼ LFSã€‚åŒæ—¶ï¼ŒLLAMA æä¾› lock-free çš„æ“ä½œæ—ï¼Œå®ƒçš„ flush ç­‰æ“ä½œéƒ½å¯ä»¥æ˜¯å¼‚æ­¥çš„ã€‚</p><h2 id="éœ€æ±‚"><a href="#éœ€æ±‚" class="headerlink" title="éœ€æ±‚"></a>éœ€æ±‚</h2><p>LLAMA æä¾›äº† Cache / Storage ä¸¤å±‚çš„ç®¡ç†ï¼Œä»¥ Page å’Œ Page-Delta çš„å½¢å¼æä¾›æœåŠ¡ã€‚å®ƒä¸éœ€è¦ç†è§£ Page çš„å†…å®¹ã€‚å®ƒåˆ†ä¸ºä¸¤å±‚ï¼šCL å’Œ SLï¼Œå³ç¼“å­˜å±‚å’Œå­˜å‚¨å±‚ã€‚å¯ä»¥ç®€å•æŠŠ LLAMA å½“æˆä¸€ä¸ª BufferPoolï¼š</p><ol><li>Storage + Cache</li><li>Mapping Table + Page + Delta</li><li>lock-free</li></ol><p>é€»è¾‘ä¸Šçš„ç»“æ„å¯ä»¥è§ä¸‹å›¾ï¼ˆä¸è€ƒè™‘æ›´æ–°å’Œ Delta Logï¼‰ï¼š</p><p><img src="https://image.mwish.me/blog-image/33FB84CE-4078-45D9-AC16-DCF1BB31A7A6.png" alt="33FB84CE-4078-45D9-AC16-DCF1BB31A7A6"></p><p>LLAMA å¹¶ä¸ä¼šçŸ¥é“ Page çš„å†…å®¹ï¼Œç›¸å…³çš„ WAL/LSN/Checkpoint éœ€è¦å¤–éƒ¨ç»´æŠ¤ï¼Œå®ƒåªæä¾› Page çš„ Allocate/Update/Overwrite/Flush/Removeã€‚è™½ç„¶è¡¨é¢ä¸Šå­˜å‚¨çš„æ˜¯ Pageï¼Œä½†æ˜¯å…¶å®ç±»ä¼¼ LFSï¼Œè¿™äº›æ•°æ®ä¼šä»¥ Log çš„å½¢å¼å†™åˆ°å­˜å‚¨ç³»ç»Ÿä¸Šï¼Œè¿™ä¸ªå’Œ Delta Log ç³»ç»Ÿä¸€èµ·ï¼Œé™ä½äº†ç³»ç»Ÿçš„å†™å…¥å¼€é”€ã€‚LLAMA è¿˜æä¾›äº†ç³»ç»Ÿäº‹åŠ¡ï¼Œç”¨æ¥æ”¯æŒç±»ä¼¼ Bw-Tree SMO ç­‰å¯¹å¤šä¸ª Page çš„åŸå­æ“ä½œã€‚</p><h2 id="LLAMA-Interface"><a href="#LLAMA-Interface" class="headerlink" title="LLAMA Interface"></a>LLAMA Interface</h2><p>è¿™æ‰¹è®ºæ–‡ä¸€å¼ å›¾éƒ½æ²¡æœ‰ã€‚</p><h3 id="Page-Data-Operations"><a href="#Page-Data-Operations" class="headerlink" title="Page Data Operations"></a>Page Data Operations</h3><p>LLAMA æä¾›äº† Page Data Operations æ“ä½œæ•°æ®ï¼ŒåŒ…æ‹¬ï¼š</p><ol><li><code>Update-D(PID, in-ptr, out-ptr, data)</code>. <code>D</code> æ˜¯ delta çš„æ„æ€ï¼Œ<code>data</code> é€šå¸¸åŒ…å« <code>&lt;lsn, key, data&gt;</code> è¿™æ ·çš„é€»è¾‘æ•°æ®ã€‚<code>in-ptr</code> <code>out-ptr</code> å…¶å®æ˜¯å¡ç»™ mapping table æˆ–è€…å­˜å‚¨é‚£ä¸€å¥—ï¼Œä¼šæŠŠæ›´æ–°åçš„å¥æŸ„ä¸¢å‡ºæ¥</li><li><code>Update-R(PID, in-ptr, out-ptr, data)</code>: <code>R</code> æ˜¯ replace çš„æ„æ€ï¼Œè¿™é‡Œç›¸å½“äºæ•´ä¸ªé¡µé¢çš„çŠ¶æ€ä¸€æŠŠæ›´æ–°</li><li><code>Read(PID, out-ptr)</code>: è¿”å› <code>out-ptr</code> æŒ‡å‘çš„å†…å­˜åœ°å€ï¼Œå¦‚æœ <code>Page</code> åœ¨ç›˜ä¸Šï¼Œä¹Ÿè¦æŠŠè¿™ä¸ªæèµ·æ¥ã€‚</li></ol><h3 id="Page-Management-Operations"><a href="#Page-Management-Operations" class="headerlink" title="Page Management Operations"></a>Page Management Operations</h3><p>LLAMA è¿˜æä¾›äº†ä¸€ç»„æ•°æ®ç®¡ç†æ¥å£ï¼Œæ”¯æŒ flush ç­‰æ¥å£ï¼š</p><ol><li><code>Flush(PID, in-ptr, out-ptr, annotation)</code>: æŠŠ Page çš„çŠ¶æ€æ‹·è´åˆ° log structured store(ä¸‹æ–‡ç§° <strong>LSS</strong> ) çš„ IO-Bufferï¼Œå¹¶ä¸”æ·»åŠ ä¸€ä¸ª <code>Flush</code> çš„ Delta è®°å½•ï¼Œå¦‚åæ–‡çš„å›¾ã€‚<code>Flush</code> å…¶å®æ˜¯ä¸ª async æ¥å£ï¼Œå¹¶ä¸ä»£è¡¨æˆåŠŸå†™åˆ°ç›˜ä¸Šäº†ã€‚è¿™é‡Œè¿˜æœ‰ä¸ªè¦æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œåˆ·çš„æ—¶å€™å¯èƒ½å¤§å°ä¸å›ºå®šï¼Œç„¶å annotation å¯èƒ½æ˜¯ LSN è¿™äº›ä¸šåŠ¡è¯­ä¹‰ï¼Œä¹Ÿä¼šå¸¦ä¸‹å»ã€‚</li><li><code>Mk-Stable(LSS address)</code>:  ä¿è¯åœ¨ <code>LLS address</code> ä¹‹å‰çš„ IO-Buffer ä¸Šçš„è®°å½•éƒ½å·²ç»å†™åˆ°æŒä¹…å­˜å‚¨ä¸Šäº†ã€‚</li><li><code>Hi-Stable(out-LSS address)</code>: è¿”å›åˆ·åˆ°æŒä¹…å­˜å‚¨çš„æœ€é«˜ä½ç‚¹</li><li><code>Allocate(out-PID)</code> æ‡‚å¾—éƒ½æ‡‚ï¼Œç”³è¯·ä¸€ä¸ª Page è¿”å› pid ç„¶ååœ¨ mapping table æ³¨å†Œä¸€ä¸‹. åŒæ—¶è¿™æ ·çš„ Page ä¹Ÿè¦æŒä¹…åŒ–</li><li><code>Free(PID)</code>: å‡†å¤‡ä¼šæ”¶æ‰å¯¹åº”çš„ PageID / Page</li></ol><p>æˆ‘åæ§½ä¸‹ï¼Œè¿™è®ºæ–‡ä¹Ÿæ²¡è¯´ä»€ä¹ˆæ¨¡å‹ï¼Œ<code>data</code> æ˜¯å•¥ï¼Œæˆ‘æ„Ÿè§‰åªèƒ½çŒœæµ‹æ˜¯ä¸€äº› Delta Log å’Œä»€ä¹ˆåˆ«çš„äº†ã€‚LSS æ•°æ®ä¼°è®¡æ˜¯ä¸€ä¸ªæ— çº¿é•¿çš„æ•°æ®æ®µæˆ–è€…ç¯çŠ¶ bufferã€‚è‡³äºåˆ«çš„åŸºæœ¬ä¸Šéƒ½æ˜¯ BufferPool è¯¥æœ‰çš„ï¼Œåªæ˜¯å­˜å‚¨å˜æˆ Delta äº†ã€‚</p><h3 id="System-Transaction-Operations"><a href="#System-Transaction-Operations" class="headerlink" title="System Transaction Operations"></a>System Transaction Operations</h3><p>è¿™é‡Œä¼šäº§ç”Ÿç³»ç»Ÿå†…éƒ¨äº‹åŠ¡ï¼Œè¯»å†™ä¼š buffer åœ¨å†…å­˜ä¸­ï¼Œåœ¨ commit çš„æ—¶å€™æäº¤ã€‚commit é˜¶æ®µçš„æ—¶å€™ï¼Œæ‰€æœ‰çš„ Page ä¼šåŸå­æ€§æ·»åŠ åˆ° LSS çš„ IO-Buffer ä¸­ï¼Œç„¶åè¢«åˆ·ä¸‹å»ã€‚LLAMA è¿™é‡Œå¥½åƒå¹¶æ²¡æœ‰æè¿°ä»»ä½•çš„å¹¶å‘æ§åˆ¶å’Œç­–ç•¥ï¼Œä¼°æ‘¸ç€æ˜¯ä¸Šå±‚æ§åˆ¶äº†ï¼ŒBwTree çš„äº‹ç‰©é ä¸Šå±‚çš„ <strong>Deuteronomy</strong> æ¥æ§åˆ¶ã€‚</p><p>è¿™é‡Œæä¾›äº†å¤§æ¦‚å¦‚ä¸‹çš„æ¥å£ï¼š</p><ol><li><code>TBegin(out-TID)</code>: æ‹¿åˆ°ä¸€ä¸ª TIDï¼Œè¿™éœ€è¦ç»´æŠ¤ä¸€ä¸ª active transaction table (ä¸‹ç§° ATT)</li><li><code>Commit(TID)</code>: ä» ATT ä¸­å–å‡ºæ¥ï¼ŒåŸå­æ€§çš„å†™åˆ°å“ªæ­¥</li><li><code>TAbort(TID)</code>: ä» ATT å‡ºæ¥ abort</li></ol><p>è¿™é‡Œä¸åº”è¯¥ <code>Update-R</code>ï¼Œä¼¼ä¹æ˜¯è§‰å¾— Replace ä¼šå¯¼è‡´è¿™ä¸ªå†…éƒ¨äº‹åŠ¡è¿‡äºå¤æ‚ï¼Œæ‰€ä»¥æ²¡æ”¯æŒã€‚æ€»ä¹‹ä¼šè¢«åˆ·è¿›å»ã€‚</p><h3 id="Bw-Tree-å¦‚ä½•åˆ©ç”¨-LLAMA"><a href="#Bw-Tree-å¦‚ä½•åˆ©ç”¨-LLAMA" class="headerlink" title="Bw-Tree å¦‚ä½•åˆ©ç”¨ LLAMA"></a>Bw-Tree å¦‚ä½•åˆ©ç”¨ LLAMA</h3><p>Bw-Tree æä¾› Key-Value æ¥å£ï¼Œè‡ªå·±ç»´æŠ¤ LSNï¼Œæ ¹æ®äº‹åŠ¡æ¥å£å¹¶å‘æ§åˆ¶å’Œç®¡ç† Ckptã€‚é€šè¿‡ <code>Update-D</code>  å’Œ <code>Update-R</code> æ¥æ›´æ–°/Consolidateã€‚é€šè¿‡ <code>Allocate</code> å’Œ <code>Free</code> æ¥ç”³è¯·/æ”¶ç¼©ã€‚</p><h2 id="Cache-Layer"><a href="#Cache-Layer" class="headerlink" title="Cache Layer"></a>Cache Layer</h2><p>å¯ä»¥è§†ä½œï¼ŒCache Layer å¯¹å¤–æä¾›äº† Mapping Table ç­‰æŠ½è±¡ï¼Œå¹¶èƒ½å¤Ÿæ¢å‡ºå¯¹åº”çš„å†…å®¹ã€‚å¦‚æˆ‘ä»¬åœ¨ Bw-Tree æ‰€æè¿°çš„ä¸€æ ·ï¼Œè¿™é‡Œä¾é  <code>Write Log</code>-&gt; <code>CAS mapping table</code> ä¸€å¯¹æ“ä½œæ¥è¿›è¡ŒåŸå­çš„å†™å…¥ã€‚è¿™é‡Œ Mapping çš„å†…å®¹ä¼šæ— è®ºå¦‚ä½•å­˜å‚¨ä¸€ä¸ªæŒ‡å‘ LSS ä¸­ä½ç½®çš„æŒ‡é’ˆï¼Œæ¥ä½œä¸º CAS çš„ä¸»ä½“ï¼Œç”¨æˆ·çš„æŒ‡é’ˆä¹Ÿä¼šæºå¸¦ä¸€ä¸ªå¯¹åº”çš„ LSSã€‚</p><p>è¿™èŠ‚çš„å†…å®¹å…¶å®æ¯”è¾ƒ hackingï¼Œæˆ‘ä¼°æ‘¸ç€å¾—ç¿»ç¿»å®ç°æ‰èƒ½å¥½ç†è§£ã€‚ä¸Šé¢è¿™æ®µè¯è¯´çš„æ¯”è¾ƒç»•ï¼Œå®é™…é€»è¾‘å¯ä»¥çœ‹ä¸‹é¢ï¼Œå¤§æ¦‚å°±æ˜¯æ— è®ºå¦‚ä½•ä¼šæ”¾ä¸€ä¸ª <code>LogOffset</code>.</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[allow(clippy::module_name_repetitions)]</span></span><br><span class="line"><span class="meta">#[derive(Clone, Copy, PartialOrd, Ord, Eq, PartialEq, Hash)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">HeapId</span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> location: <span class="type">u64</span>,</span><br><span class="line">    <span class="keyword">pub</span> original_lsn: Lsn,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// A pointer to a location on disk or an off-log heap item.</span></span><br><span class="line"><span class="comment">/// </span></span><br><span class="line"><span class="comment">/// (log_offxet, heap_id)</span></span><br><span class="line"><span class="meta">#[derive(Debug, Clone, Copy, PartialEq)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">enum</span> <span class="title class_">DiskPtr</span> &#123;</span><br><span class="line">    <span class="comment">/// Points to a value stored in the single-file log.</span></span><br><span class="line">    <span class="title function_ invoke__">Inline</span>(LogOffset),</span><br><span class="line">    <span class="comment">/// Points to a value stored off-log in the heap.</span></span><br><span class="line">    <span class="title function_ invoke__">Heap</span>(<span class="type">Option</span>&lt;NonZeroU64&gt;, HeapId),</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>LLAMA ä¼šå­˜å‚¨æˆ Delta / Page, å¤§æ¦‚æ˜¯ <code>PID -&gt; Delta LSS -&gt; Delta LSS -&gt; Page</code>, éœ€è¦é ä¸Šå±‚ <code>Update-R</code> ä¹‹ç±»çš„æ¥ consolidate.</p><p><img src="https://image.mwish.me/blog-image/450839E1-75FD-48DC-81E9-BC8E10FE04EE.png" alt="450839E1-75FD-48DC-81E9-BC8E10FE04EE"></p><h3 id="Flush-çš„åŸå­æ€§"><a href="#Flush-çš„åŸå­æ€§" class="headerlink" title="Flush çš„åŸå­æ€§"></a>Flush çš„åŸå­æ€§</h3><p>Flush åŒ…æ‹¬ï¼š</p><ol><li>æ‹·è´åˆ° LSS çš„å†…å®¹ä¸­</li><li>CAS å‘å¸ƒ</li></ol><p>å¦‚æœåŒæ—¶æœ‰æ›´æ–°ï¼Œå¯èƒ½éœ€è¦ä¿è¯æ­£åœ¨ copy çš„å†…å®¹ä¸è¦å’Œ flush çš„æµæ··äº†ã€‚è¿™é‡Œå®ƒçš„ç­–ç•¥å¦‚ä¸‹ï¼š</p><ol><li>åœ¨ LSS Buffer ç»™ Allocate ä¸€æ®µ IO Buffer</li><li>åˆ›å»ºä¸€ä¸ª Flush Delta, å°è¯• CAS è¿™ä¸ª LSS</li><li>(2) æˆåŠŸäº†ï¼Œå°±æ‹·è´åˆ° Buffer ä¸­ï¼›å¦åˆ™åœ¨ Buffer å†™ä¸€ä¸ª <code>FAILED_FLUSH</code> è®°å½•ï¼Œé˜²æ­¢æ¢å¤çš„æ—¶å€™æ•°æ®é”™è¯¯</li></ol><h3 id="Page-æ¢å‡º"><a href="#Page-æ¢å‡º" class="headerlink" title="Page æ¢å‡º"></a>Page æ¢å‡º</h3><p>è¿™é‡Œå…è®¸è®°å½•æˆ–è€… Page æ¢å‡ºï¼Œä¸ºäº†é˜²æ­¢å†…å®¹ç©ºæ‚¬ï¼Œå¯ä»¥ç”¨ä¸€ä¸ª <code>PARTIAL SWAP</code> è®°å½•è¡¨ç¤ºå†…å­˜ä¸­çš„ç»“æ„ Swap å‡ºå»äº†ï¼š</p><p><img src="https://image.mwish.me/blog-image/8B64DF88-DD1E-4107-862A-A276B5313E76.png" alt="8B64DF88-DD1E-4107-862A-A276B5313E76"></p><p>è¿™é‡Œè¿˜ä½¿ç”¨ä½¿ç”¨ Epoch Base Reclaim æ¥å›æ”¶å†…å­˜ï¼Œä¸å†èµ˜è¿°ã€‚</p><p><img src="https://image.mwish.me/blog-image/3E209D4B-B2B4-45F4-A240-C3643AA78B54.png" alt="3E209D4B-B2B4-45F4-A240-C3643AA78B54"></p><h2 id="Storage-Layer"><a href="#Storage-Layer" class="headerlink" title="Storage Layer"></a>Storage Layer</h2><p>è¿™èŠ‚è¯´æ˜¯ Storage Layerï¼Œå…¶å®å°±æ˜¯ä»‹ç»äº†å®ƒçš„ Log å†™å…¥å±‚å’Œä¸€äº› lock-free çš„ WALï¼Œå’Œ LFS/MySQL 8.0 WAL å¾ˆåƒã€‚LLAMA è¿™é‡Œæ²¡è¯´æ€ä¹ˆ GCï¼Œä¸è¿‡æˆ‘æ„Ÿè§‰å› ä¸º Consolidationï¼Œæ—©ç‚¹çš„è®°å½•åŸºæœ¬éƒ½èƒ½è¢«æ¸…é™¤æ‰ã€‚</p><p><img src="https://image.mwish.me/blog-image/7F968374-1EDD-41E9-BB82-683D2F88BECC.png" alt="7F968374-1EDD-41E9-BB82-683D2F88BECC"></p><p>æ¯”è¾ƒå…³é”®çš„æ˜¯ Flushing éƒ¨åˆ†ï¼Œå®ƒå¸Œæœ› Flushing æ˜¯ lock-free çš„ï¼Œæ¯ä¸ª Buffer æœ‰ä¸€ä¸ªå›ºå®šå¤§å°ã€‚è¿™é‡Œæœ‰å‡ ä¸ªæ§åˆ¶å­—æ®µï¼š</p><ol><li>Sealed bit</li><li>Active writers</li><li>Offset</li></ol><p><img src="https://image.mwish.me/blog-image/78BF2138-B283-4EF7-BC9A-FF97521E1749.png" alt="78BF2138-B283-4EF7-BC9A-FF97521E1749"></p><p>é‚£ä¹ˆå®ç°çš„é€»è¾‘å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">WriteOnBuf(buf, data):</span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">  (sealed, active_writers, offset) = buf.ctl.load()</span><br><span class="line">    <span class="keyword">if</span> (sealed):</span><br><span class="line">      å»å†™å¦å¤–çš„ Buf</span><br><span class="line">    offset += data.size()</span><br><span class="line">    <span class="keyword">if</span> offset è¶…è¿‡é™åˆ¶:</span><br><span class="line">      è®¾ç½® sealed = <span class="literal">True</span></span><br><span class="line">    è®¾ç½® writer += <span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span> buf.ctl.cas():</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">  æ‹·è´ data åˆ°ç»™å®šçš„å­—æ®µ</span><br><span class="line">  cas å‡å°‘ writer, å¦‚æœ active writer = <span class="number">0</span> ä¸” Sealed, æ¨è¿›æ‹·è´åˆ°å­˜å‚¨ç©ºé—´</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå…¶å®å’Œ MySQL é‚£ä¸ª Lock-free WAL åè®®å¾ˆåƒã€‚</p><h3 id="LSS-Clean-GC"><a href="#LSS-Clean-GC" class="headerlink" title="LSS Clean (GC)"></a>LSS Clean (GC)</h3><p>è¿™é‡Œå†…å®¹ç±»ä¼¼ LFS æˆ–è€… WiscKeyã€‚LSS å¯ä»¥è§†ä½œæ— é™å¢é•¿çš„ï¼Œç„¶åå†…å®¹å†™åœ¨ä¸€ä¸ªç¯çŠ¶ç¼“å†²åŒºä¸Šã€‚</p><p>InnoDB ä¼šä¸¤ä¸ª log æ–‡ä»¶æ¢ç€å†™ï¼Œæˆ‘è§‰å¾—åŸºæœ¬ä¹Ÿå°±è¿™ä¸ªæ ·å­ã€‚</p><h3 id="æ€§èƒ½"><a href="#æ€§èƒ½" class="headerlink" title="æ€§èƒ½"></a>æ€§èƒ½</h3><p>ä½œä¸ºä¸€ä¸ªç¼åˆæ€ªï¼Œè¿™é‡Œæ€§èƒ½æè¿°å¦‚ä¸‹:</p><blockquote><p>First, there is no empty space in pages that are flushed. They are written as packed variable length strings. On average, traditional B-tree pages are only 69% utilized. Second, because we will frequently flush only deltas since the prior flush, much less space will be consumed per page flush. Finally</p></blockquote><p>æˆ‘è§‰å¾—æ²¡å•¥æ„æ€â€¦</p><h2 id="System-Transaction"><a href="#System-Transaction" class="headerlink" title="System Transaction"></a>System Transaction</h2><p>è¿™é‡Œä¸æä¾›é€šç”¨çš„äº‹åŠ¡ï¼Œå¤šä¸ª Page çš„æ›´æ–°å¯èƒ½ä¼šè¢« Partial çš„è¯»åˆ°ã€‚ä½†æ˜¯è¿™é‡Œé æ¡†æ¶ä¸Šçš„æ›´æ–°æ¥å¤„ç†è¿™ä¸€ç‚¹ã€‚</p><p>æˆ‘ä¸Šé¢è¯´çš„è¯æˆ‘è‡ªå·±è¯»äº†ä¸€ééƒ½æ²¡å¤ªæ‡‚ï¼Œæ‰€ä»¥æˆ‘è´´ä¸ª Cow-Btree:</p><p><img src="https://image.mwish.me/blog-image/updated-btree.png" alt="updated-btree"></p><p>è¿™é‡Œä¸æ˜¯è¯´ Bw-Tree æ˜¯ Cow-Btree, ä¸è¿‡å…¶å®å·®ä¸å¤šï¼Œè¿™é‡Œ Split/Merge æœ¬èº«æ˜¯èƒ½å¤Ÿåšåˆ°åŸå­è¢«çœ‹è§çš„ï¼š</p><p><img src="https://image.mwish.me/blog-image/F06B0563-9E77-407A-85D8-086EF2A10580.png" alt="F06B0563-9E77-407A-85D8-086EF2A10580"></p><h2 id="Recovery"><a href="#Recovery" class="headerlink" title="Recovery"></a>Recovery</h2><p> è¿™é‡Œ Recover å…¶å®æŒºç±»ä¼¼ WiscKey Recover çš„ï¼Œéº»çƒ¦åœ¨äºæ¢å¤ Mapping Tableã€‚è¿™é‡Œä¼šå®šæœŸå†™å¿«ç…§ï¼Œç„¶å Replay log æ¥æ¢å¤ã€‚</p><p><img src="https://image.mwish.me/blog-image/EF1946C6-A748-4289-98A7-8EF5720F92C7.png" alt="EF1946C6-A748-4289-98A7-8EF5720F92C7"></p><h2 id="sled"><a href="#sled" class="headerlink" title="sled"></a>sled</h2><p>sled æ˜¯ä¸€ä¸ª LLAMA çš„å®ç°ã€‚å®ƒä¸Šå±‚å¹¶æ²¡æœ‰ç”¨ Bw-Treeï¼Œç”¨äº†ä¸€ä¸ª Epoch GC çš„å®ç°ã€‚è¿™é‡Œæœ‰å‡ ä¸ªå…³é”®å†…å®¹ï¼š</p><ol><li><code>IoBuf</code> å’Œ <code>IoBufs</code> å¯¹åº”è®ºæ–‡é‡Œé¢çš„æ— é” Bufferï¼Œç”± <code>Log</code> åŒ…è£…ã€‚åŸºæœ¬ä¸Šå®ç°äº†è®ºæ–‡æè¿°çš„å†…å®¹ã€‚</li><li><code>PageTable</code> æ˜¯å¯¹åº”çš„ Mapping Table çš„å®ç°</li><li><code>Node</code> ä»£è¡¨ Page æˆ–è€… Delta, ç”¨ link æ·»åŠ æ–°æ“ä½œã€‚è¿™é‡Œç”±æ›´æ–°çš„æ¬¡æ•°æ¥å†³å®šæ˜¯å¦ consolidation</li><li><code>transaction.rs</code> æœ‰äº‹åŠ¡ç›¸å…³çš„å†…å®¹ã€‚</li><li>GC ä½¿ç”¨ crossbeam çš„ <code>crossbeam-epoch</code> å®ç°</li></ol><h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ol><li>[ICDEâ€™13] <a href="https://15721.courses.cs.cmu.edu/spring2017/papers/08-oltpindexes2/bwtree-icde2013.pdf">The Bw-Tree: A B-tree for New Hardware Platforms</a></li><li>[PVLDBâ€™13] LLAMA: A Cache/Storage Subsystem for Modern Hardware</li><li>[SIGMODâ€™18] Building a Bw-Tree Takes More Than Just Buzz Words</li><li>[PODSâ€™21] ArkDB: A Key-Value Engine for Scalable Cloud Storage Services</li><li>Sled: <a href="https://docs.rs/sled/0.34.1/sled/doc/sled_architectural_outlook/index.html#caching">https://docs.rs/sled/0.34.1/sled/doc/sled_architectural_outlook/index.html#caching</a> (å·²ä¸å†ç»´æŠ¤)</li><li>æ•°æ®åº“æœˆæŠ¥çš„ Bw-Tree æ ç›®ï¼š<a href="http://mysql.taobao.org/monthly/2018/11/01/">http://mysql.taobao.org/monthly/2018/11/01/</a></li><li>Indexing on Modern Hardware: Hekaton and Beyond</li><li><a href="https://github.com/spacejam/sled">https://github.com/spacejam/sled</a></li><li>CMU 15-721</li></ol><h3 id="äºŒæ‰‹ææ–™"><a href="#äºŒæ‰‹ææ–™" class="headerlink" title="äºŒæ‰‹ææ–™"></a>äºŒæ‰‹ææ–™</h3><ul><li>Bw-TreeæŠ€æœ¯è§£è¯» - ç¿°æ˜çš„æ–‡ç«  - çŸ¥ä¹ <a href="https://zhuanlan.zhihu.com/p/29314464">https://zhuanlan.zhihu.com/p/29314464</a></li><li><a href="https://nan01ab.github.io/2019/09/LLAMA.html">https://nan01ab.github.io/2019/09/LLAMA.html</a></li></ul>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Raft Basic Notes</title>
      <link href="/2022/04/15/Raft-Basic-Notes/"/>
      <url>/2022/04/15/Raft-Basic-Notes/</url>
      
        <content type="html"><![CDATA[<p>æœ¬æ¥æ‰“ç®—ä»‹ç» Etcd çš„ Raftï¼Œç„¶åæŠ½ç¦»å¼€è§†çº¿æ¥è®²è®² etcd-raft æ€ä¹ˆç”¨ï¼Œå®ƒæ€ä¹ˆæŠ½è±¡çš„ã€‚ä½†æ˜¯è¯»äº†ä¸€ä¸‹ raftexample å‘ç°ä¸å¤ªç°å®ï¼Œæ„Ÿè§‰ etcd-raft çš„å¤–éƒ¨é€»è¾‘å’Œå®ç°æ˜¯ä¸¥é‡è€¦åˆçš„ï¼Œæ‰€ä»¥æˆ–è®¸æˆ‘ä»¬ä¸å¾—ä¸ä»å®ç°å¼€å§‹ï¼Œäº†è§£ä¸€ä¸‹ etcd-raft å¤§æ¦‚æä¾›äº†ä»€ä¹ˆæ ·çš„æŠ½è±¡, ç„¶åå†ä»‹ç»ä¸€ä¸‹å®˜æ–¹çš„  raftexample çš„å†…å®¹ï¼Œä¾¿äºæˆ‘ä»¬å®ç°ç®€å•çš„ raft æœåŠ¡å™¨ã€‚</p><p>è¿™é‡Œå…ˆå¤ä¹ ä¸€ä¸‹ Basic Raftï¼Œç„¶å Paper æ˜¯ä¸€å›äº‹ï¼Œæ€ä¹ˆå“åº”è¿™ä¸ªå¹¶å‘çš„äº‹ä»¶è¿™äº›ä¹Ÿæ²¡å•¥é—®é¢˜ï¼Œç„¶åçœ‹çœ‹ <a href="https://github.com/Qihoo360/floyd">floyd</a> è¿™ä¸ªé¡¹ç›®æ˜¯æ€ä¹ˆå®ç°çš„ã€‚</p><h2 id="Raft-å¤ä¹ "><a href="#Raft-å¤ä¹ " class="headerlink" title="Raft å¤ä¹ "></a>Raft å¤ä¹ </h2><p>åŸºæœ¬ä¸Šæ¥é¢è¯•çš„å¤§ä½¬éƒ½ä¼š Raftï¼Œä½†æˆ‘å…¶å®å·²ç»å¿˜å…‰äº†ï¼Œè¿™é‡Œå°è¯•ç”¨æœ€å¿«çš„æ–¹å¼å»ºèµ· Raft çš„åŸºæœ¬æ¦‚å¿µã€‚ä»¥åæœ‰æ›´æ–°ä¹Ÿå°½é‡ç›´æ¥åœ¨è¿™ä¸ªåœ°æ–¹è¡¥å……ã€‚</p><p>å¦å¤–ï¼Œè¿™é‡Œåªä»‹ç»å°è®ºæ–‡é‡Œé¢çš„åŸºç¡€éƒ¨åˆ†ï¼Œå°è®ºæ–‡æ²¡æåˆ°çš„æˆ‘éƒ½ä¸å¤ªæƒ³ä»‹ç»ã€‚å·¥ç¨‹ä¼˜åŒ–å¤ªå¤šäº†ï¼Œæœ€å¼€å§‹å…¥é—¨çš„æ—¶å€™è¿˜æ˜¯ä¸è¦æå¤ªå¤æ‚ï¼Œé‚£ä¹ˆå¼€å§‹å§ã€‚</p><p>Raft ä½¿ç”¨ä¸€ä¸ª RSM æ¨¡å‹ï¼š</p><p><img src="https://image.mwish.me/blog-image/170FFACD-191C-474F-833E-06A1A36E1150.png" alt="170FFACD-191C-474F-833E-06A1A36E1150"></p><p>é¢ï¼Œè¿™å›¾å…¶å®åšäº†ä¸€äº›æš—ç¤ºï¼š</p><ol><li>Log å’Œ State Machine æ˜¯åˆ†å¼€æ¥å­˜å‚¨çš„</li><li>é€šè¿‡æŸç§å›è°ƒæ¥å†™ State Machineï¼Œå†™å®Œä¹‹åæ‰èƒ½é€šçŸ¥ client</li></ol><p>é‚£ä¹ˆè¿›å…¥ç®—æ³•éƒ¨åˆ†ï¼ŒRaft é™¤äº†æˆå‘˜å˜æ›´ï¼ŒåŸºç¡€ç®—æ³•åŒ…æ‹¬ï¼š</p><ol><li>Leader Election</li><li>Log Replication</li><li>Safety</li></ol><p>åŒæ—¶ï¼Œè¿™é‡Œæœ‰éœ€è¦æŒä¹…åŒ–çš„å†…å®¹è¡¨ï¼ˆæš‚ä¸åŒ…æ‹¬ snapshotï¼‰ï¼š</p><p><img src="https://image.mwish.me/blog-image/CABFCF9B-9C07-48C1-9718-380E659F5DD7.png" alt="CABFCF9B-9C07-48C1-9718-380E659F5DD7"></p><p>å…¶å®å¯ä»¥å‘ç°è¿™éƒ¨åˆ†éå¸¸éå¸¸ç²¾ç®€ã€‚è€Œ Log åŒ…å«çš„å†…å®¹å¦‚ä¸‹ï¼š</p><ol><li>Command for state machine (ç”¨æˆ·å®šä¹‰)</li><li>Leader Term (æˆ‘æ„Ÿè§‰ä¹Ÿç›¸å½“äºç¡®å®šäº† Leader)</li></ol><p>Raft çš„ Invariant æœ‰ï¼š</p><ol><li>å¯¹äºä¸€ä¸ªç»™å®šçš„ Termï¼Œè‡³å¤šåªæœ‰ä¸€ä¸ª Leader</li><li>Leader ä¸ä¼š Truncate è‡ªå·±çš„æ—¥å¿—ï¼Œå®ƒæ˜¯ Append Only çš„ï¼ˆè¿™é‡Œæ¶‰åŠå®‰å…¨æ€§ä¸€èŠ‚ï¼‰</li><li>å¯¹äºä»»ä½•ä¸¤æ¡æ—¥å¿—ï¼Œå¦‚æœ <code>index</code> å’Œ <code>term</code> ç›¸åŒï¼Œé‚£ä¹ˆå®ƒä»¬ä¹‹å‰çš„å†…å®¹éƒ½ç›¸åŒ</li><li>å¦‚æœæŸä¸ª <code>term</code> çš„ <code>Log</code> è¢« Commit, é‚£ä¹ˆ <code>term</code> æ¯”å®ƒå¤§çš„æ‰€æœ‰ Leader éƒ½åº”è¯¥åŒ…å«å®ƒ</li><li>ä¸€æ¡å·²ç» Apply åˆ°çŠ¶æ€æœºçš„æ—¥å¿—ï¼Œä¸ä¼šè¢«åœ¨åŒä¸€ä¸ªä½ç½®æäº¤ï¼ˆæ„Ÿè§‰æ˜¯ trivial çš„ï¼Œæ¨å‡º Commit äº†æ‰èƒ½ Applyï¼Ÿï¼‰</li></ol><p>RPC åŒ…å«ï¼š</p><ol><li>AppendEntries: ç»´æŠ¤å¿ƒè·³åŒ…ã€åŒæ­¥ Log</li><li>RequestVote: æŠ•ç¥¨</li></ol><h3 id="Leader-Election"><a href="#Leader-Election" class="headerlink" title="Leader Election"></a>Leader Election</h3><ol><li>å¯åŠ¨çš„æ—¶å€™ï¼Œé›†ç¾¤éƒ½æ˜¯ follower</li><li>æ²¡æœ‰æ”¶åˆ° Leader çš„å¿ƒè·³åŒ…æˆ–è€… Candidate çš„é€‰ä¸¾ï¼Œåœ¨ <code>electionTimeout</code> çš„æ—¶é—´åï¼Œ<strong>å‘èµ·é€‰ä¸¾</strong></li></ol><p>è‹¥å‘èµ·é€‰ä¸¾ï¼š</p><ol><li><code>++term</code>, çŠ¶æ€å˜æˆ <code>candidate</code>ï¼Œå¹¿æ’­ requestVoteRPC</li><li>ç»™è‡ªå·±æŠ•ç¥¨</li><li>åœ¨ <code>electionTimeout</code> å†…æ”¶åˆ° <code>1/n</code> ä»¥ä¸Šçš„é€‰ç¥¨ï¼Œæˆä¸º <code>term</code> çš„ leader</li></ol><p>å¯¹äº follower:</p><ol><li>å¯¹åŒä¸€ä¸ª <code>term</code> åªèƒ½ç»™å‡ºä¸€ä¸ªæˆåŠŸçš„ RequestVote</li></ol><p>(ä¸ªäººå¥½å¥‡ï¼ŒæŸä¸ª candidate æ”¶åˆ°äº† term æ›´é«˜çš„ candidate çš„ RequestVote ä¿¡æ¯ï¼Œä¹Ÿä¼šå˜ä¸º follower)</p><h3 id="Log-Replication"><a href="#Log-Replication" class="headerlink" title="Log Replication"></a>Log Replication</h3><p>Leader å¯ä»¥ä¸º client æä¾›æœåŠ¡, æ—¥å¿—å¤åˆ¶æœ‰å‡ ä¸ªä½ç‚¹ï¼š</p><ul><li><code>[snapshot/0, applied, committed, current log]</code></li></ul><p>Commit çš„æ—¥å¿— Apply åˆ°çŠ¶æ€æœºæ˜¯å®‰å…¨çš„ï¼Œå½“:</p><ol><li>Leader å°† Log å¤åˆ¶åˆ° 1/2 ä»¥ä¸Šçš„æœåŠ¡å™¨æ—¶ï¼Œå°±å¯ä»¥ Commit</li><li>åœ¨ Leader å°†è‡ªå·± term çš„æ—¥å¿—å¤åˆ¶åï¼ŒLeader ä¹‹å‰çš„æ—¥å¿— <em>å¯ä»¥ Commit</em> ï¼ˆè¿™é‡Œæœ‰ä¸ªé—®é¢˜ï¼Œæ˜¯è¯´ Leader ä¹‹å‰çš„æ—¥å¿—å¯ä»¥ commitï¼Œä½†ä¸ä»£è¡¨ Leader è‡ªå·±çš„æ—¥å¿—å¯ä»¥ Commitï¼Œç„¶åè¿™æ˜¯å¯ä»¥ Commitï¼‰<ol><li>è¿™é‡Œç»†èŠ‚ä¸Šæœ‰ä¸ª match æ“ä½œï¼Œä¼šåŒ¹é…åˆ°ç›¸åŒçš„æ—¥å¿—ï¼Œæ ¹æ®ä¹‹å‰çš„æ€§è´¨ï¼Œè¿™ä¹‹å‰çš„ä¸œè¥¿éƒ½ç›¸åŒäº†ã€‚ç„¶åå¯ä»¥è¦†ç›–ã€‚è¿™ä¸ªæ—¥å¿—å·å« <code>nextIndex</code>, ä¸éœ€è¦æŒä¹…åŒ–</li><li>å¤§éƒ¨åˆ†æƒ…å†µæ˜¯æ²¡æœ‰é—®é¢˜çš„ï¼Œåªæœ‰ Leader crash çš„æ—¶å€™ï¼Œå¯èƒ½å‡ºç°è¿™ä¸ªé—®é¢˜</li></ol></li></ol><p>Leader ä¼šç»™æ¯ä¸ªæˆå‘˜æä¾› <code>nextIndex</code> å’Œ <code>matchIndex</code>. <code>nextIndex</code> è¡¨ç¤ºä¸‹ä¸€æ¬¡å°è¯•å¯¹é½/åŒæ­¥çš„èµ·å§‹ä½ç½®ï¼Œ<code>matchIndex</code> è¡¨ç¤ºå·²ç»å¯¹é½çš„ä½ç½®ã€‚</p><p>ä¸Šé¢è¯´çš„éƒ¨åˆ†æ˜¯ Leader åšæ—¥å¿—åŒæ­¥å’Œæäº¤çš„éƒ¨åˆ†ï¼Œæ—¥å¿—åŒæ­¥çš„æ—¶å€™ï¼ŒLeader çš„ <code>committed</code> æ°´ä½å¯èƒ½æ¯” follower é«˜ï¼Œéœ€è¦æ¨é«˜ <code>follower</code> çš„ <code>committed</code> æ°´ä½ã€‚Leader Committed çš„æ¨é«˜åº”è¯¥æ˜¯ <code>match</code> æˆåŠŸæ‰èƒ½ä½¿ç”¨çš„ï¼ˆå°±æ˜¯åŒæ­¥æˆåŠŸï¼‰ã€‚</p><h3 id="Safety"><a href="#Safety" class="headerlink" title="Safety"></a>Safety</h3><p>è¿™æ˜¯æœ€éœ€è¦ç†è§£çš„ä¸€èŠ‚ã€‚æˆ‘ä»¬è¦ä¿è¯ <code>Commit</code> è¿‡çš„æ—¥å¿—ä¸ä¼šè¢«è¦†ç›–ã€‚è¿™ä¸€èŠ‚çš„é™åˆ¶åŒ…æ‹¬äº† Leader Election çš„é™åˆ¶ï¼Œå’Œé€‰ä¸Šä¹‹åå¦‚ä½•å¤„ç†ä¹‹å‰æœª <code>Commit</code> çš„æ¡ç›®ï¼ˆå…¶å®æˆ‘çæƒ³çš„æ˜¯é€‰ Commit æœ€å¤§çš„ï¼Œç„¶åæŠŠåˆ«çš„éƒ½ Truncate äº†ï¼Œä¸è¿‡å®é™…ä¸Šè¿™å¯èƒ½å¯¼è‡´ Leader æœ€æ–°æ¨è¿›çš„ <code>Commit</code> æ²¡æœ‰æäº¤ï¼‰</p><p>é€‰ä¸¾é™åˆ¶ï¼šCandidate çš„ RPC åŒ…å«æ—¥å¿—ä¿¡æ¯ï¼Œè¿™é‡Œä¼šç»™ <code>current log</code>, <code>follower</code> åœ¨æŠ•ç¥¨çš„æ—¶å€™ï¼Œä¼šæ‹’ç»æ‰ <code>candidate.current.term &lt; current_log.current.term || (candidate.current.term == current_log.current.term &amp;&amp; candidate.current.index &lt; current_log.current.index)</code> çš„æ—¥å¿—</p><blockquote><p>5.4.3 ä½¿ç”¨äº†åè¯æ³•æ¥è¯æ˜å®ƒçš„æ­£ç¡®æ€§ï¼Œä»»ä½• commit æ—¥å¿—å¿…å®šå¤åˆ¶åˆ°äº† 1/2 ä»¥ä¸Šçš„æœºå™¨ï¼ŒæŠ•ç¥¨ä¹Ÿè¦ 1/2 ä»¥ä¸Šçš„æœºå™¨ã€‚æ–° Leader æ‹¿åˆ°æŠ•ç¥¨ï¼Œå¿…å®šå·²ç»åŒ…å«äº†è¿™æ¡æ—¥å¿—ã€‚</p></blockquote><p>ä¹‹å‰ term æäº¤çš„é™åˆ¶ï¼šæ­¤å¤–ï¼ŒLeader å¿…é¡»é æäº¤ä¸€æ¡è‡ªå·± term çš„æ—¥å¿—ï¼Œæ¥ä¿è¯ä¹‹å‰çš„æ—¥å¿—æäº¤ã€‚</p><blockquote><p>Figure8 æè¿°äº†è¿™ç§åœºæ™¯ï¼Œå¦‚æœ Leader å•ç‹¬æäº¤ä¹‹å‰çš„æ—¥å¿—ï¼Œé‚£å°±ä¼šæŒ‚ï¼š<br><img src="https://image.mwish.me/blog-image/057E9A5F-8EAF-4482-B9C9-47E4BC31BC64.png" alt="057E9A5F-8EAF-4482-B9C9-47E4BC31BC64"></p></blockquote><p>å¯¹äº Follower Crash, è¿™é‡Œä¼šå‘é€ AppendEntities RPC, ç›´åˆ°æ—¥å¿—å¯¹é½ã€‚</p><h4 id="ä¸€ä¸ªè¯¯åŒº"><a href="#ä¸€ä¸ªè¯¯åŒº" class="headerlink" title="ä¸€ä¸ªè¯¯åŒº"></a>ä¸€ä¸ªè¯¯åŒº</h4><p>ä¹‹å‰çœ‹åˆ°ä¸‹å›¾ï¼Œæ„Ÿè§‰å¾ˆ confusingï¼Œä¸çŸ¥é“ <code>1 1 1 3</code> é‚£ä¸ªæ˜¯å’‹å½“é€‰çš„ï¼š</p><p><img src="https://image.mwish.me/blog-image/committed.png" alt="committed"></p><p>åæ¥å‘ç°ï¼Œæˆ‘åŸæ¥çš„æƒ³æ³•æ˜¯æœ‰ä¸€ç‚¹è¯¯åŒºçš„ã€‚Leader çš„ Commit å¿…é¡»è¦æ—¥å¿—è¿‡åŠï¼Œä½†èƒ½å¤Ÿè¢«é€‰ä¸º Leaderï¼Œå®ƒä¸€å®šåŒ…å«å·² Commit çš„æœ€åæ—¥å¿—ï¼Œæ‰€ä»¥ï¼Œè¦†ç›–åˆ«çš„æ—¥å¿—æ˜¯å®‰å…¨çš„ã€‚ç„¶åæˆ‘çš„è¯¯åŒºæ˜¯ï¼Œ<code>AppendEntities RPC</code> å¿…é¡»å’Œ Commit ç±»ä¼¼ï¼Œè¦ä¸€ä¸‹è¡¥é½ç”¨æˆ·ä¸¢å¤±çš„æ‰€æœ‰ Logã€‚ä½† <code>AppendEntities RPC</code> çš„ Logs å®é™…ä¸Šæ˜¯å¯ä»¥ä¸€æ¡ä¸€æ¡å‘çš„ã€‚</p><h4 id="CommitIndex-å’Œ-ApplyIndex-çš„æŒä¹…åŒ–"><a href="#CommitIndex-å’Œ-ApplyIndex-çš„æŒä¹…åŒ–" class="headerlink" title="CommitIndex å’Œ ApplyIndex çš„æŒä¹…åŒ–"></a>CommitIndex å’Œ ApplyIndex çš„æŒä¹…åŒ–</h4><p>æœ¬æ¥è¿™éƒ¨åˆ†åœ¨ä½œè€… PHD è®ºæ–‡é‡Œé¢ä»‹ç»çš„å¾ˆç»†ï¼Œæœ¬è´¨ä¸Š commitIndex å’Œ applyIndex éƒ½æ˜¯å¯ä»¥æ¢å¤å‡ºæ¥çš„ã€‚ä¸è¿‡å·¥ç¨‹ä¸Šï¼Œå¯ä»¥æ ¹æ®å¹‚ç­‰ä¹‹ç±»çš„è¯­ä¹‰ï¼ŒæŒä¹…åŒ–ä»¥ä¼˜åŒ– applyIndex.</p><p>è¯è¯´æˆ‘å‰å¹´åœ¨é€¼ä¹å¥½åƒæè¿‡è¿™ä¸ªé—®é¢˜ï¼š<a href="https://www.zhihu.com/question/382888510">https://www.zhihu.com/question/382888510</a></p><h3 id="æ—¶é—´å’Œå¯ç”¨æ€§"><a href="#æ—¶é—´å’Œå¯ç”¨æ€§" class="headerlink" title="æ—¶é—´å’Œå¯ç”¨æ€§"></a>æ—¶é—´å’Œå¯ç”¨æ€§</h3><p><code>broadcastTime &lt;&lt; electionTimeout &lt;&lt; MTBF</code> ä»¥ TiKV ä¸ºä¾‹ï¼Œè¿™ä¸ª timeout æ˜¯ 10S: <a href="https://asktug.com/t/tikv-raft-election-timeout-10s/999">https://asktug.com/t/tikv-raft-election-timeout-10s/999</a> ã€‚</p><p>broadcastTime ä¹Ÿåº”è¯¥æ¯” electionTimeout å°ä¸€ä¸ªæ•°é‡çº§ã€‚è¿™é‡Œæœ‰ä¸ªé—®é¢˜æ˜¯ï¼Œè¿™ä¸ªæ—¶é—´æ˜¯æ€ä¹ˆå†³å®šçš„å‘¢ï¼Ÿå®é™…ä¸Š <code>broadcastTime</code> ä¸€å¤šï¼Œæœ¬èº«å¿ƒè·³ä¹Ÿä¼šå¤šï¼Œç„¶å TiKV æœ¬èº«æ˜¯ multi-raft ä»€ä¹ˆçš„ï¼Œå¿ƒè·³åŒ…æ•°é‡ä¼šéå¸¸å¤šï¼Œç„¶åè¿™ä¸ªæ—¶é—´çŸ­ä¼šæŠŠé›†ç¾¤æ‰“çˆ†ï¼Œæ‰€ä»¥æ—¶é—´å¯ä»¥è®¾ç½®é•¿ç‚¹ã€‚è®ºæ–‡é‡Œæ¨èçš„æ—¶é—´æ˜¯ï¼š</p><blockquote><p>Raftâ€™s RPCs typically require the recipient to persist information to stable storage, so the broadcast time may range from 0.5ms to 20ms, depending on storage technology. As a result, the election timeout is likely to be somewhere between 10ms and 500ms.</p></blockquote><p>è¿™å‡ ä¸ªæ—¶é—´è¿˜æ˜¯å¾ˆé‡è¦çš„ï¼Œæˆ‘æ„Ÿè§‰å¾ˆå¤šæ˜¯åœ¨ 0-1.5 å€è¿™ä¸ªæ—¶é—´é€‰å‡ºæ¥çš„ï¼Ÿ</p><h3 id="é›†ç¾¤æˆå‘˜å˜æ›´"><a href="#é›†ç¾¤æˆå‘˜å˜æ›´" class="headerlink" title="é›†ç¾¤æˆå‘˜å˜æ›´"></a>é›†ç¾¤æˆå‘˜å˜æ›´</h3><p>Raft Group å¯èƒ½ä¸€èˆ¬å°±æ˜¯ 3ã€5ä¸ªæˆå‘˜ï¼Œä½†æ˜¯å› ä¸ºæœºå™¨å˜æ›´å¯¼è‡´çš„ membership change ä¼šæ˜¯çº¿ä¸Šä½é¢‘ä½†ä¸€ç›´æœ‰çš„è¡Œä¸ºã€‚æˆ‘ä»¬é¦–å…ˆæƒ³çš„æ˜¯ï¼Œé€šè¿‡ä¸€æ¡å†…éƒ¨çš„ Logï¼Œå³ <code>æ—§é…ç½® -&gt; æ–°é…ç½®</code> çš„ Logï¼Œæ¥åˆ‡æ¢åˆ°æ–°é…ç½®çš„çŠ¶æ€ã€‚ä½†æœ‰ä¸ªé—®é¢˜æ˜¯ï¼Œé…ç½®ä» $C<em>{old}$ åˆ‡æˆ $C</em>{new}$ çš„æ—¶å€™ï¼Œå¯èƒ½æœ‰ä¸‹å›¾æ‰€ç¤ºçš„çŠ¶æ€ï¼š</p><p><img src="https://image.mwish.me/blog-image/v2-45dd50e08934f1dfc42dbc83251bfe76_r.jpeg" alt="v2-45dd50e08934f1dfc42dbc83251bfe76_r"></p><p>åœ¨è¿™é‡Œï¼Œ$C<em>{old}$ æ˜¯ <code>&#123;1, 2, 3&#125;</code>ï¼Œ$C</em>{new}$ æ˜¯ <code>&#123;1, 2, 3, 4, 5&#125;</code>ï¼Œæ¯”æ–¹è¯´ Server 3 æ˜¯ Leaderï¼ŒåŒæ­¥äº† membership change çš„æ—¥å¿—ï¼Œç„¶å commit äº†ï¼Œ1å’Œ2æ”¶åˆ°äº†ä¿¡æ¯ï¼Œä½†æ˜¯æ²¡æœ‰ Commitï¼Œè¿™ä¸ªæ—¶å€™ï¼Œ1ã€2 ä¸­çš„é€‰ä¸¾å¯ä»¥ç»™å¯¹æ–¹æŠ•ç¥¨ï¼Œå› ä¸ºæ»¡è¶³å®‰å…¨æ€§ï¼›3ã€4ã€5 åŒç†ï¼Œç»“æœæ˜¯è¿™é‡Œæœ‰ä¸¤ä¸ª Majority äº†ï¼ˆ<code>2/3</code> å’Œ <code>3/5</code>ï¼‰ã€‚</p><p>è¿™ä¸ªæ—¶å€™ï¼ŒRaft ä¼šåˆ‡å…¥åˆ°ä¸€ä¸ªè¿‡æ¸¡æ—¶æœŸï¼Œå« <code>Joint Consensus</code>ï¼Œå®ƒéœ€è¦ç†è§£ä¸¤ç§é…ç½®ï¼š</p><ol><li>$C<em>{new}$ å’Œ $C</em>{old}$ ä»»ä½•ä¸€ä¸ªæœºå™¨éƒ½å¯ä»¥æˆä¸º Leader</li><li>Election å’Œ Commit éƒ½éœ€è¦ $C<em>{new}$ å’Œ $C</em>{old}$ <strong>åŒæ–¹</strong> çš„ Majority</li></ol><p>Joint Consensus å¼•å…¥äº†ä¸€ä¸ª $C_{old, new}$ ä¸­é—´çŠ¶æ€ï¼Œå¦‚ä¸‹å›¾ï¼š</p><p><img src="https://image.mwish.me/blog-image/487347AA-3308-4821-B662-2F8EE3720BFB.png" alt="487347AA-3308-4821-B662-2F8EE3720BFB"></p><p>åŠ å…¥ $C<em>{old, new}$ è¿™æ ·çš„é…ç½®å˜æ›´æ—¥å¿—ä¹‹åï¼Œ**å³ä½¿è¿™æ¡å˜æ›´æ—¥å¿—æ²¡æœ‰ Commit, é›†ç¾¤ä¹Ÿä¼šé‡‡ç”¨å®ƒæŒ‡å®šçš„ Confï¼Œè¿™è¡¨ç¤ºï¼Œå˜æ›´æ—¥å¿—ä¼šåœ¨ $C</em>{old, new}$ è¾¾æˆ Majority åæäº¤**. ä¸€æ—¦ $C<em>{old, new}$ æäº¤äº†ï¼Œé‚£ä¹ˆï¼Œåªæœ‰é‡‡ç”¨è¿™ä¸ªé…ç½®çš„é›†ç¾¤å¯ä»¥æˆä¸º Leaderã€‚è¿™ä¸ªæ—¶å€™ï¼ŒLeader å¯ä»¥å†åˆ›å»ºä¸€æ¡ $C</em>{new}$ çš„æ—¥å¿—ï¼Œæäº¤å®Œæˆä¹‹åï¼Œ$C<em>{new} - C</em>{old}$ é›†åˆä¸­çš„æœåŠ¡å™¨å¯ä»¥å…³æ‰äº†ã€‚</p><blockquote><p>æ­£ç¡®æ€§: $C<em>{old}$ å’Œ $C</em>{new}$ å¦‚ Figure 11ï¼Œä¼šåœ¨ä¸åŒçš„æ—¶é—´å†…ç”Ÿæ•ˆï¼Œç”± $C_{old, new}$ æäº¤ä¸º Barrierã€‚</p></blockquote><p>é—®é¢˜ï¼š</p><ol><li>æ–°åŠ å…¥çš„æœºå™¨ï¼Œæ²¡æœ‰ä»»ä½•æ—¥å¿—ï¼Œå¯èƒ½è¦ <code>InstallSnapshot</code> æˆ–ç»è¿‡é•¿æœŸåŒæ­¥ï¼Ÿ<ol><li>è¿™é‡Œå¼•å…¥äº† Learnerï¼Œä¸éœ€è¦æŠ•ç¥¨ã€åªæ¥æ”¶ Leader æ—¥å¿—çš„é˜¶æ®µã€‚</li></ol></li><li>åœ¨ Propose $C<em>{new}$ çš„æ—¶å€™ï¼ŒLeader å¯èƒ½å¹¶ä¸åœ¨ $C</em>{new}$ ä¸­ã€‚è¿™ä¸ªåè®®è¿˜æ˜¯å¯ä»¥è¿è¡Œçš„ï¼Œä½†æ˜¯ <code>Majority</code> å¹¶ä¸åŒ…æ‹¬ Leaderã€‚åœ¨ $C_{new}$ æäº¤ä¹‹åï¼Œæ‰èƒ½å‘ç”Ÿ Leader è½¬ç§»ã€‚</li><li>é‡‡ç”¨æ–°é…ç½®æ—¶ï¼Œæ—§é…ç½®æ²¡æœ‰æ”¶åˆ° Heartbeatï¼Œå¯èƒ½ <code>++term</code> ç„¶åå˜ candidateï¼Œéšä¹‹ä¼šå½±å“ä¸€äº›æ²¡æ”¶åˆ° $C_{new}$ æ—¥å¿—çš„æœºå™¨ï¼ŒæŠŠå®ƒä»¬ term ä¹Ÿæèµ·æ¥ã€‚è¿™é‡Œçš„æ–¹æ¡ˆæ˜¯ï¼ŒLeader å­˜åœ¨çš„æ—¶å€™ï¼Œä¸ä¼šåˆ‡ Leader é‡æ–°é€‰ä¸¾ï¼›ç„¶å Server åœ¨ä¸€æ¬¡é€‰ä¸¾ä¹‹é—´ï¼Œå¦‚æœæ”¶åˆ°äº†æ›´é«˜ <code>term</code> çš„è¯·æ±‚ï¼Œä¹Ÿè¦ç­‰å¾…ä¸€å®šæ—¶é—´ï¼Œé˜²æ­¢å¿ƒè·³æŠŠè‡ªå·±æ‰“ç‚¸</li></ol><p>é‚£ä¹ˆï¼Œä¸ºä»€ä¹ˆ <code>Conf</code> éœ€è¦ç›´æ¥ç”¨ new çš„å‘¢ï¼Ÿèµ° Committed åœ¨è¿›å…¥ä¸‹ä¸€é˜¶æ®µçš„ç›®çš„æ˜¯åœ¨ç¬¬ä¸€é˜¶æ®µè¾¾æˆä¸¤æ–¹çš„ Majorityï¼Œç¬¬äºŒé˜¶æ®µåªéœ€è¦æ–°çš„ Majorityï¼Œå®ƒä»¬ä¸ç›¸äº¤ã€‚è€Œç›´æ¥ç”¨çš„ç›®çš„æ˜¯ä¸ç”¨è¿½è¸ªå¤§éƒ¨åˆ†æœºå™¨çš„ <code>CommitIndex</code>:</p><blockquote><p>If servers adopted $C<em>{new}$ only when they learned that $C</em>{new}$ was committed, Raft leaders would have a difficult time knowing when a majority of the old cluster had adopted it. They would need to track which servers know of the entryâ€™s commitment, and the servers would need to persist their commit index to disk; neither of these mechanisms is required in Raft. Instead, each server adopts $C<em>{new}$ as soon as that entry exists in its log, and the leader knows itâ€™s safe to allow further conï¬guration changes as soon as the $C</em>{new}$ entry has been committed. Unfortunately, this decision does imply that a log entry for a conï¬guration change can be removed (if leadership changes); in this case, a server must be prepared to fall back to the previous conï¬guration in its log.</p></blockquote><p>æœ‰çš„åœ°æ–¹å®ç°ä¼šé‡‡ç”¨å•æ­¥å˜æ›´ï¼Œä½†æ˜¯å®é™…ä¸Šå•æ­¥å˜æ›´ä¼šå¯¼è‡´ä¸€å®šçš„é›†ç¾¤ä¸å¯ç”¨é—®é¢˜ï¼Œè¯¦è§ï¼šä½œè€…çš„ <a href="https://github.com/ongardie/dissertation#chapter-4-cluster-membership-changes">https://github.com/ongardie/dissertation#chapter-4-cluster-membership-changes</a> å’ŒäºŒæ‰‹æ–‡ç«  <a href="https://zhuanlan.zhihu.com/p/359206808">https://zhuanlan.zhihu.com/p/359206808</a></p><h3 id="Snapshot-å’Œ-Log-Compaction"><a href="#Snapshot-å’Œ-Log-Compaction" class="headerlink" title="Snapshot å’Œ Log Compaction"></a>Snapshot å’Œ Log Compaction</h3><p>Snapshot çš„èŒè´£å½’åŠŸäºçŠ¶æ€æœºï¼Œè€Œé Raftã€‚å®ƒåº”ç”¨äºå·²ç» <code>Applied</code> çš„æ•°æ®ï¼Œç„¶åç”±å„ä¸ªæœºå™¨ <strong>åˆ†åˆ«</strong> è¿›è¡Œï¼Œé€šè¿‡ InstallSnapshot ä¼ è¾“ã€‚ï¼ˆInstallSnapshot è¿˜å¯ä»¥åˆ†å¤šæ¬¡å‘ï¼Œç¥å¿…ï¼‰</p><p>ä½œè€…è®¤ä¸ºï¼ŒLog Compaction æ˜¯é Leader ä¸»å¯¼çš„ï¼Œä½†æ˜¯æ¯•ç«Ÿæ˜¯å·²ç» Applied çš„æ•°æ®äº†ï¼Œæ‰€ä»¥ä¹Ÿæ²¡é‚£ä¹ˆ Careã€‚</p><p>åœ¨æ”¶åˆ° Snapshot ä¹‹åï¼Œå¯ä»¥ Truncate åç»­çš„ Logï¼Œç­‰ AppendEntities æŠŠè‡ªå·±æ•´æ´»äº†ã€‚è¿™ä¸ªæ—¶å€™ä¼°æ‘¸ç€ä¹Ÿå¯ä»¥æ˜¯ä¸ª Learner å•¥çš„ï¼Œä¸ç»™ç³»ç»Ÿç vote æ·»ä¹±ã€‚</p><h3 id="Client-äº¤äº’"><a href="#Client-äº¤äº’" class="headerlink" title="Client äº¤äº’"></a>Client äº¤äº’</h3><h4 id="ä¸€èˆ¬çš„è¯»å†™æ“ä½œ"><a href="#ä¸€èˆ¬çš„è¯»å†™æ“ä½œ" class="headerlink" title="ä¸€èˆ¬çš„è¯»å†™æ“ä½œ"></a>ä¸€èˆ¬çš„è¯»å†™æ“ä½œ</h4><p>Raft æ˜¯ä¸€ä¸ª Leader-Based çš„ä¸€è‡´æ€§åè®®ï¼Œä¸‹é¢çš„å½¢å¼æ˜¯ä¸ºäº†ä¿è¯ Linearizable è€Œè¦æ±‚çš„</p><p>ä¸€èˆ¬çš„å†™æ¶ˆæ¯è¦ä¹ˆä¼šè®© client èµ°åˆ° Leader ä¸Šï¼Œè¦ä¹ˆä»èŠ‚ç‚¹è´Ÿè´£è½¬å‘ç»™ Leaderï¼Œè€Œ Apply ä¹‹åèƒ½å¤Ÿæ”¶åˆ°æ¶ˆæ¯ã€‚å¦‚æœ Leader Crash äº†ï¼Œè¿™äº›æ“ä½œå¯èƒ½å°± Timeoutã€‚è€Œè¯»æ“ä½œå¯ä»¥ä¾é åœ¨è¯»å‘å‡ºåï¼Œå†™ä¸€æ¡ no-op æˆ–è€…ç­‰å¾…å†™æ“ä½œå®Œæˆï¼Œæ¥åšç›¸å…³çš„ä¿è¯ï¼ˆæ€»ä¹‹ï¼Œæ”¶åˆ°è¯»è¯·æ±‚åˆ°è¯»çŠ¶æ€æœºä¹‹é—´ï¼Œä¸€å®šè¦æœ‰ä¸€æ¡æ—¥å¿—ï¼Œæ¥ä¿è¯åŒæ­¥å®Œæˆï¼‰ã€‚è¯»ä¹Ÿå¯ä»¥ä½¿ç”¨å¤§è®ºæ–‡æè¿°çš„ Leaseã€‚</p><p>å½“ç„¶ï¼ŒZookeeper å…è®¸æœ¬åœ°è¯»ï¼Œè¿™ç§æ–¹å¼åªèƒ½ä¿è¯ Serializable (Zookeeper è®ºæ–‡æçš„æ˜¯ A-Linearizable)ã€‚</p><h4 id="å†™é‡è¯•"><a href="#å†™é‡è¯•" class="headerlink" title="å†™é‡è¯•"></a>å†™é‡è¯•</h4><p>å¯¹äºå†™ï¼Œå¯ä»¥ç»™æ¯ä¸ªè¯·æ±‚ä¸€ä¸ª Seqï¼Œé‡è¯•çš„æ—¶å€™ï¼Œè®ºæ–‡æåˆ°ï¼Œå¯ä»¥ç»´æŠ¤ä¸€ä¸ª seqï¼Œå‘ç° FSM é‡Œé¢æœ‰è¿™ä¸ª seqï¼Œå¯ä»¥ç›´æ¥è¿”å›æˆåŠŸã€‚å½“ç„¶è¿™è‚¯å®šæ²¡é—®é¢˜ï¼Œä½†ä¸‡ä¸€æ˜¯æ²¡ commit æˆ–è€… commit äº†çš„æ²¡åŒæ­¥ï¼Œæ€ä¹ˆåŠå‘¢ï¼Ÿè¿™é‡Œå¯ä»¥ï¼š</p><ol><li>Apply çš„é˜¶æ®µï¼Œåš Seq çš„å»é‡</li><li>ç»´æŠ¤ä¸€ä¸ªé›†åˆï¼Œæ¥åŒºåˆ† <code>&#123;Commit ä½†æ²¡æœ‰ Apply&#125;</code> å’Œ <code>&#123;æ²¡æœ‰ Commit&#125;</code> çš„ Seq é›†åˆã€‚</li></ol><h2 id="Some-Quiz"><a href="#Some-Quiz" class="headerlink" title="Some Quiz"></a>Some Quiz</h2><p>Quiz å¯ä»¥è§ï¼š<a href="https://ongardie.net/static/raft/userstudy/quizzes.html">https://ongardie.net/static/raft/userstudy/quizzes.html</a></p><p>è€å®è¯´æˆ‘ 2 é”™äº†ï¼Œå› ä¸ºå®åœ¨ä¸çŸ¥é“é‚£ä¸ªä¸º <code>1 1 1 3</code> çš„æ˜¯æ€ä¹ˆå½“é€‰çš„â€¦è¯¦ç»†åŸå› å¯ä»¥çœ‹æˆ‘ Safety é‚£èŠ‚ä¸‹é¢çš„å‹˜è¯¯ã€‚</p><h2 id="Qihoo360-floyd"><a href="#Qihoo360-floyd" class="headerlink" title="Qihoo360/floyd"></a>Qihoo360/floyd</h2><p>Qihoo360/floyd æ˜¯ä¸€ä¸ªç®€å•çš„ Raft å®ç°ï¼Œå®ƒæä¾›äº† KVã€åˆ†å¸ƒå¼é”çš„åŠŸèƒ½ã€‚ç›¸å¯¹ Etcd æä¾›ä¸€ä¸ªè½»é‡çš„ Raft æ¨¡å—ï¼Œfloyd è€¦åˆçš„æ¯”è¾ƒé‡ï¼Œç”šè‡³æŠŠå­˜å‚¨æ•°æ®ã€Logã€Raft çš„ Index ç­‰ä¿¡æ¯éƒ½ä¸¢åˆ°äº†ä¸€ä¸ª CFï¼Œå¾ˆå¤š C++ ä»£ç æ„Ÿè§‰ä¹Ÿå†™çš„æ¯”è¾ƒä¹±ã€‚ä½†å®ƒå·®ä¸å¤šåªæœ‰æ•°åƒè¡Œï¼Œè€Œä¸”å±•ç¤ºäº†å¦‚ä½•å®ç°ä¸€ä¸ª Basic Raftã€‚è¿™äº›è¿˜æ˜¯æ¯”è¾ƒé‡è¦çš„ï¼Œå› ä¸ºæœ¬èº«å®ç°ä¸€ä¸ªå¹¶å‘çš„çŠ¶æ€æœºå°±è¦æœ‰å„ç§å‘ï¼Œä½ å¯èƒ½è¿˜è¦å¤„ç† RPC çš„å„ç§ corner caseã€‚æ‰€ä»¥æœ‰ä¸ªç®€å•çš„é¡¹ç›®å€Ÿé‰´è¿˜æ˜¯æ±‚ä¹‹ä¸å¾—ã€‚</p><p>å®ƒå¯¹ Raft è®ºæ–‡æ”¯æŒå¦‚ä¸‹ï¼š</p><div class="table-container"><table><thead><tr><th style="text-align:center">åŠŸèƒ½</th><th>æ˜¯å¦æ”¯æŒ</th></tr></thead><tbody><tr><td style="text-align:center">é¢†å¯¼é€‰ä¸¾/æ—¥å¿—åŒæ­¥/å®‰å…¨æ€§</td><td>æ˜¯</td></tr><tr><td style="text-align:center">Client</td><td>æ˜¯</td></tr><tr><td style="text-align:center">Log Compaction</td><td>å¦</td></tr><tr><td style="text-align:center">Membership Change</td><td>æœ‰æ”¯æŒå•æ­¥å˜æ›´çš„æ¥å£ï¼Œä½†æ²¡å®ç°</td></tr><tr><td style="text-align:center">Learner</td><td>æ— </td></tr></tbody></table></div><p><code>floyd/include/floyd.h</code> è¡¨ç¤ºäº†å®ƒå¯¹å¤–çš„æ¥å£ï¼Œç®€å•è¡¨ç¤ºå¦‚ä¸‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Floyd</span>  &#123;</span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="function"><span class="type">static</span> Status <span class="title">Open</span><span class="params">(<span class="type">const</span> Options&amp; options, Floyd** floyd)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">Floyd</span>() &#123; &#125;</span><br><span class="line">  <span class="keyword">virtual</span> ~<span class="built_in">Floyd</span>();</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> Status <span class="title">Write</span><span class="params">(<span class="type">const</span> std::string&amp; key, <span class="type">const</span> std::string&amp; value)</span> </span>= <span class="number">0</span>;</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> Status <span class="title">Delete</span><span class="params">(<span class="type">const</span> std::string&amp; key)</span> </span>= <span class="number">0</span>;</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> Status <span class="title">Read</span><span class="params">(<span class="type">const</span> std::string&amp; key, std::string* value)</span> </span>= <span class="number">0</span>;</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> Status <span class="title">DirtyRead</span><span class="params">(<span class="type">const</span> std::string&amp; key, std::string* value)</span> </span>= <span class="number">0</span>;</span><br><span class="line">  <span class="comment">// ttl is millisecond</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> Status <span class="title">TryLock</span><span class="params">(<span class="type">const</span> std::string&amp; name, <span class="type">const</span> std::string&amp; holder, <span class="type">uint64_t</span> ttl)</span> </span>= <span class="number">0</span>;</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> Status <span class="title">UnLock</span><span class="params">(<span class="type">const</span> std::string&amp; name, <span class="type">const</span> std::string&amp; holder)</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// return true if leader has been elected</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="type">bool</span> <span class="title">GetLeader</span><span class="params">(std::string* ip_port)</span> </span>= <span class="number">0</span>;</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="type">bool</span> <span class="title">GetLeader</span><span class="params">(std::string* ip, <span class="type">int</span>* port)</span> </span>= <span class="number">0</span>;</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="type">bool</span> <span class="title">HasLeader</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="type">bool</span> <span class="title">IsLeader</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> Status <span class="title">GetAllServers</span><span class="params">(std::set&lt;std::string&gt;* nodes)</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// used for debug</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="type">bool</span> <span class="title">GetServerStatus</span><span class="params">(std::string* msg)</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// log level can be modified</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">set_log_level</span><span class="params">(<span class="type">const</span> <span class="type">int</span> log_level)</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span>:</span><br><span class="line">  <span class="comment">// No coping allowed</span></span><br><span class="line">  <span class="built_in">Floyd</span>(<span class="type">const</span> Floyd&amp;);</span><br><span class="line">  <span class="type">void</span> <span class="keyword">operator</span>=(<span class="type">const</span> Floyd&amp;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>è€Œ <code>example/simple/t.cc</code> æè¿°äº†ä¸€ä¸ªç®€å•çš„ä½¿ç”¨ Caseï¼Œéå¸¸ç®€å•æ˜“æ‡‚ï¼š<a href="https://github.com/mapleFU/floyd-notes/blob/mwish-notes/floyd/example/simple/t.cc#L18">https://github.com/mapleFU/floyd-notes/blob/mwish-notes/floyd/example/simple/t.cc#L18</a></p><p>å®ƒå†…éƒ¨å®ç°å¦‚ä¸‹ï¼ˆæˆ‘å›¾ç”»çš„æœ‰ç‚¹ä¹±ï¼Œä»¥è‡ªå·±çœ‹å¾—æ‡‚ä¸ºå‡†ï¼Œæœ‰ä¿®æ”¹æ„è§å¯ä»¥éšä¾¿å–·ï¼‰ï¼š</p><p><img src="https://image.mwish.me/blog-image/DDAC89FE-87C2-4E59-9657-CEC2EB3721B8.png" alt="DDAC89FE-87C2-4E59-9657-CEC2EB3721B8"></p><ul><li>éƒ¨åˆ†æ¶ˆæ¯çš„ç»“æ„ä½“å®šä¹‰åœ¨ <code>proto/floyd.proto</code>ï¼ŒåŒ…æ‹¬ Raft æ—¥å¿—çš„ç»“æ„å’ŒçŠ¶æ€æœºçš„æ—¥å¿—ç»“æ„</li><li>æŒä¹…çŠ¶æ€å­˜å‚¨åœ¨ RocksDB ä¸­ï¼Œæœ‰ä¸‹åˆ—ä¸¤ç±»<ul><li><code>RaftLog</code>: å­˜å‚¨è®ºæ–‡ä¸­çš„ <code>Log[]</code></li><li><code>RaftMeta</code>: å­˜å‚¨ Term, VoteFor, commitIndex, applyIndexï¼Œåä¸¤è€…åœ¨ Raft Paper ä¸­ä¸è¦æ±‚æŒä¹…åŒ–, ä¸è¿‡å·¥ç¨‹ä¸ŠæŒä¹…åŒ–ä¸€ä¸‹ä¹Ÿæ²¡å•¥æ¯›ç—…ã€‚ä»»ä½•ä¸€ä¸ª Get/Set æ¥å£, RaftMeta æœ¬èº«éƒ½ä¸ä¼šèµ°ç¼“å­˜(å¯èƒ½æœ‰ RocksDB çš„ Cache), ç›´æ¥è¿› RocksDB.</li></ul></li><li>å…±äº«çš„çŠ¶æ€è¢«å°è£…åˆ° <code>FloydContext</code> ä¸­ï¼Œå®ƒæŒæœ‰ <code>RaftLog</code> å’Œ <code>RaftMeta</code> çš„çŠ¶æ€ï¼Œåœ¨å„ä¸ªå¯¹è±¡é—´å…±äº«ï¼ŒCommit æ¨é«˜ Commit åï¼Œä¼šæé«˜ <code>FloydContext</code> ä¸­çš„å†…å­˜çŠ¶æ€ï¼Œè€Œè§¦å‘ <code>Apply</code>ï¼ŒåŒæ—¶ï¼ŒApply ä¹Ÿä¼šæ›´æ–°è¿™ä¸ªçŠ¶æ€ã€‚å®ƒè´Ÿè´£é€»è¾‘æ¯”è¾ƒæ··æ‚ï¼š<ul><li>[Persistent] è´Ÿè´£è¯»å– <code>RaftMeta</code>ï¼Œç»´æŠ¤ <code>commitIndex</code>ã€<code>applyIndex</code>ã€<code>voteFor</code>ã€<code>term</code> ç­‰</li><li>[Volatile] è´Ÿè´£é›†ç¾¤çš„ Roleï¼Œä¸€äº›å†…å­˜ <code>BecomeLeader</code> <code>BecomeFollower</code> çš„é€»è¾‘ä¼šèµ°å®ƒã€‚</li></ul></li><li>FloydApply å°† Committed çš„ç”¨æˆ·æ—¥å¿— <code>Apply</code> åˆ°æ•°æ®å­˜å‚¨ä¸­</li><li>Peersä¼šå­˜æ”¾ä¸€äº›é…ç½®çš„ IPï¼Œä»¥åŠä»…å¯¹ Leader æœ‰ç”¨çš„ <code>nextIndex</code> å’Œ <code>matchIndex</code></li></ul><p>åœ¨è¿™é‡Œï¼Œç³»ç»Ÿä¸­ä¹Ÿæœ‰ä¸å°‘çº¿ç¨‹ï¼Œæœ€ä¸»è¦çš„æ˜¯ï¼š</p><ol><li><code>floyd_primary_thread</code>ï¼šåªæœ‰ä¸€ä¸ªçš„çº¿ç¨‹ï¼Œè´Ÿè´£å®šæ—¶å‘èµ· HeartBeatï¼ˆ<code>AppendEntities RPC</code>ï¼‰ã€æ£€æŸ¥ Leader ï¼ˆæŸ¥çœ‹æ˜¯å¦ electionTimeoutï¼‰ã€å¤„ç†ç”¨æˆ·çš„ RPC</li><li><code>floyd_peer_thread</code>ï¼šç†è®ºä¸Šï¼ŒRaft Group æ¯ä¸ªæˆå‘˜ï¼Œè¿™é‡Œéƒ½ä¼šå¤šä¸€ä¸ª <code>floyd_peer_thread</code>ã€‚å®ƒè´Ÿè´£ç»™æ¯ä¸ªæˆå‘˜å‘é€ RPCï¼Œå¹¶é€šè¿‡ <code>FloydContext</code> æ¥å˜æ›´çŠ¶æ€.</li></ol><h3 id="Leader-Election-1"><a href="#Leader-Election-1" class="headerlink" title="Leader Election"></a>Leader Election</h3><h4 id="Sender"><a href="#Sender" class="headerlink" title="Sender"></a>Sender</h4><p>ä¸€ä¸ª <code>FloydImpl</code> å¯åŠ¨åï¼Œ<code>floyd_primary_thread</code> ä¼šæ£€æŸ¥è‡ªå·±çš„çŠ¶æ€ï¼Œå¦‚æœ timeout äº†ï¼Œå¯èƒ½è¦å˜æ›´ä¸º Candidate. æ³¨æ„å˜æˆ Candidate ä¹‹åï¼Œé€’å¢äº† Termï¼Œç„¶åç»™äº†è‡ªå·±ä¸€ç¥¨ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//! å¦‚æœæ²¡æœ‰ Leader, æŠŠè‡ªèº«å˜æˆ Candidate, ç„¶åé€šçŸ¥ Peer çº¿ç¨‹.</span></span><br><span class="line"><span class="comment">//! å†è§¦å‘ä¸€ä¸ª CheckLeader, ç›¸å½“äº ElectionTimeout.</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">FloydPrimary::LaunchCheckLeader</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="function">slash::MutexLock <span class="title">l</span><span class="params">(&amp;context_-&gt;global_mu)</span></span>;</span><br><span class="line">  <span class="keyword">if</span> (context_-&gt;role == Role::kFollower || context_-&gt;role == Role::kCandidate) &#123;</span><br><span class="line">    <span class="keyword">if</span> (options_.single_mode) &#123;</span><br><span class="line">      <span class="comment">// å¿½ç•¥ SingleMode</span></span><br><span class="line">...</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (context_-&gt;last_op_time + options_.check_leader_us &lt; slash::<span class="built_in">NowMicros</span>()) &#123;</span><br><span class="line">      context_-&gt;<span class="built_in">BecomeCandidate</span>();</span><br><span class="line"></span><br><span class="line">      <span class="comment">// åæ§½: å®ç°ä¸Šä¸‹é¢è¿›è¡Œäº† 3æ¬¡ RocksDB Batch å†™, å› ä¸ºæ¯æ¬¡ Set éƒ½ä¼šå†™, è¿™æ˜¯çœŸçš„ç‰›æ‰¹...</span></span><br><span class="line">      raft_meta_-&gt;<span class="built_in">SetCurrentTerm</span>(context_-&gt;current_term);</span><br><span class="line">      raft_meta_-&gt;<span class="built_in">SetVotedForIp</span>(context_-&gt;voted_for_ip);</span><br><span class="line">      raft_meta_-&gt;<span class="built_in">SetVotedForPort</span>(context_-&gt;voted_for_port);</span><br><span class="line">      <span class="built_in">NoticePeerTask</span>(kHeartBeat);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// åœ¨ ElectionTimeout ä¹‹å, å°è¯•å†æ¬¡è°ƒåº¦ checkLeader</span></span><br><span class="line">  <span class="built_in">AddTask</span>(kCheckLeader);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// when adding task to peer thread, we can consider that this job have been in the network</span></span><br><span class="line"><span class="comment">// even it is still in the peer thread&#x27;s queue</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">FloydPrimary::NoticePeerTask</span><span class="params">(TaskType type)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">auto</span>&amp; peer : (*peers_)) &#123;</span><br><span class="line">    <span class="keyword">switch</span> (type) &#123;</span><br><span class="line">    <span class="keyword">case</span> kHeartBeat:</span><br><span class="line">      peer.second-&gt;<span class="built_in">AddRequestVoteTask</span>();</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> kNewCommand:</span><br><span class="line">      peer.second-&gt;<span class="built_in">AddAppendEntriesTask</span>();</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä¼šç”¨ <code>RequestVote</code> æ¥åš kHeartbeatï¼ˆä½ å¯èƒ½ä¼šå¾ˆå¥‡æ€ªï¼ŒHeartbeat ä¸æ˜¯ AppendEntry å—ï¼Ÿä¸è¿‡å®ƒ AppendEntry åˆä¼šèµ°åˆ° <code>kNewCommand</code>ï¼Œæˆ‘è§‰å¾—æœ‰ç‚¹ä¹±ï¼‰ï¼Œç„¶åè§¦å‘æ‰€æœ‰ <code>Peer</code> çº¿ç¨‹çš„ <code>RequestVote</code>ï¼Œè§¦å‘å¦‚ä¸‹å†…å®¹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">Peer::RequestVoteRPC</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="type">uint64_t</span> last_log_term;</span><br><span class="line">  <span class="type">uint64_t</span> last_log_index;</span><br><span class="line">  CmdRequest req;</span><br><span class="line"><span class="comment">// åˆå§‹åŒ– RequestVote RPC</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="function">slash::MutexLock <span class="title">l</span><span class="params">(&amp;context_-&gt;global_mu)</span></span>;</span><br><span class="line">    raft_log_-&gt;<span class="built_in">GetLastLogTermAndIndex</span>(&amp;last_log_term, &amp;last_log_index);</span><br><span class="line"></span><br><span class="line">    req.<span class="built_in">set_type</span>(Type::kRequestVote);</span><br><span class="line">    CmdRequest_RequestVote* request_vote = req.<span class="built_in">mutable_request_vote</span>();</span><br><span class="line">    request_vote-&gt;<span class="built_in">set_ip</span>(options_.local_ip);</span><br><span class="line">    request_vote-&gt;<span class="built_in">set_port</span>(options_.local_port);</span><br><span class="line">    request_vote-&gt;<span class="built_in">set_term</span>(context_-&gt;current_term);</span><br><span class="line">    request_vote-&gt;<span class="built_in">set_last_log_term</span>(last_log_term);</span><br><span class="line">    request_vote-&gt;<span class="built_in">set_last_log_index</span>(last_log_index);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åŒæ­¥å‘é€è¯·æ±‚.</span></span><br><span class="line">  CmdResponse res;</span><br><span class="line">  Status result = pool_-&gt;<span class="built_in">SendAndRecv</span>(peer_addr_, req, &amp;res);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!result.<span class="built_in">ok</span>()) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  &#123;</span><br><span class="line">  <span class="function">slash::MutexLock <span class="title">l</span><span class="params">(&amp;context_-&gt;global_mu)</span></span>;</span><br><span class="line">  <span class="comment">// RequestVote å‘ç”Ÿ RPC é”™è¯¯</span></span><br><span class="line">  <span class="keyword">if</span> (!result.<span class="built_in">ok</span>()) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/***</span></span><br><span class="line"><span class="comment">   * ä¸‹åˆ—ä¸ºæ­£å¸¸çš„ Raft å¤„ç†é€»è¾‘</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¯¹æ–¹çš„ Term æ¯”è‡ªèº«é«˜, è®¾ç½®çŠ¶æ€ä¸º Follower, æ›´æ–° Term.</span></span><br><span class="line">  <span class="keyword">if</span> (res.<span class="built_in">request_vote_res</span>().<span class="built_in">term</span>() &gt; context_-&gt;current_term) &#123;</span><br><span class="line">    <span class="comment">// RequestVote fail, maybe opposite has larger term, or opposite has</span></span><br><span class="line">    <span class="comment">// longer log. if opposite has larger term, this node will become follower</span></span><br><span class="line">    <span class="comment">// otherwise we will do nothing</span></span><br><span class="line">    context_-&gt;<span class="built_in">BecomeFollower</span>(res.<span class="built_in">request_vote_res</span>().<span class="built_in">term</span>());</span><br><span class="line">    raft_meta_-&gt;<span class="built_in">SetCurrentTerm</span>(context_-&gt;current_term);</span><br><span class="line">    <span class="comment">// å®é™…ä¸Šç›¸å½“äºæ¸…ç©º ip/port.</span></span><br><span class="line">    raft_meta_-&gt;<span class="built_in">SetVotedForIp</span>(context_-&gt;voted_for_ip);</span><br><span class="line">    raft_meta_-&gt;<span class="built_in">SetVotedForPort</span>(context_-&gt;voted_for_port);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// å¦‚æœè‡ªèº«çŠ¶æ€è¿˜æ˜¯ Follower, ä¸”å¯¹æ–¹çš„ Term ä¸æ¯”è‡ªå·±é«˜, é‚£ä¹ˆè¦ä¹ˆæŠ•ç»™è‡ªå·±, è¦ä¹ˆæ²¡æŠ•.</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (context_-&gt;role == Role::kCandidate) &#123;</span><br><span class="line">    <span class="comment">// kOk means RequestVote success, opposite vote for me</span></span><br><span class="line">    <span class="keyword">if</span> (res.<span class="built_in">request_vote_res</span>().<span class="built_in">vote_granted</span>() == <span class="literal">true</span>) &#123;    <span class="comment">// granted</span></span><br><span class="line">      <span class="comment">// However, we need check whether this vote is vote for old term</span></span><br><span class="line">      <span class="comment">// we need ignore these type of vote.</span></span><br><span class="line">      <span class="comment">//</span></span><br><span class="line">      <span class="comment">// å¯ä»¥æˆä¸º Leader å•¦!</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">CheckAndVote</span>(res.<span class="built_in">request_vote_res</span>().<span class="built_in">term</span>())) &#123;</span><br><span class="line">        context_-&gt;<span class="built_in">BecomeLeader</span>();</span><br><span class="line">        <span class="built_in">UpdatePeerInfo</span>();</span><br><span class="line">        primary_-&gt;<span class="built_in">AddTask</span>(kHeartBeat, <span class="literal">false</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// Note(mwish): å¯¹æ–¹æ²¡æœ‰æŠ•ç¥¨ç»™è‡ªå·±, æ€ä¹ˆå°±å˜æˆ Follower äº†.</span></span><br><span class="line">      <span class="comment">// è¿™ä¸ªåœ°æ–¹æ²¡æœ‰ Bug(å› ä¸º context_ å˜æ›´ä¸ä¼šå¯¼è‡´é”™è¯¯), ä½†æ˜¯ä¼šå¾ˆå®¹æ˜“å¼•èµ· bug</span></span><br><span class="line">      <span class="comment">// æˆ‘è§‰å¾—å¯ä»¥å…¨éƒ¨ comment æ‰.</span></span><br><span class="line">      context_-&gt;<span class="built_in">BecomeFollower</span>(res.<span class="built_in">request_vote_res</span>().<span class="built_in">term</span>());</span><br><span class="line">      raft_meta_-&gt;<span class="built_in">SetCurrentTerm</span>(context_-&gt;current_term);</span><br><span class="line">      raft_meta_-&gt;<span class="built_in">SetVotedForIp</span>(context_-&gt;voted_for_ip);</span><br><span class="line">      raft_meta_-&gt;<span class="built_in">SetVotedForPort</span>(context_-&gt;voted_for_port);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œåœ¨çŠ¶æ€å˜æ›´çš„æ—¶å€™ï¼ŒæŒæœ‰äº† <code>global_mu_</code>ï¼Œç„¶åæœ‰ä¸ªã€ŒåŠæ•°é€‰ç¥¨ã€çš„é€»è¾‘ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//! å¦‚æœéæœ¬ term, åˆ™æ— æ•ˆ, å¦åˆ™ increment vote_quorum, ç„¶åè¿”å›æœ¬ term æ˜¯å¦è¾¾åˆ° 1/2.</span></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">Peer::CheckAndVote</span><span class="params">(<span class="type">uint64_t</span> vote_term)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// æ£€æµ‹ ABA é—®é¢˜.</span></span><br><span class="line">  <span class="keyword">if</span> (context_-&gt;current_term != vote_term) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// åŠæ•°æ£€æŸ¥</span></span><br><span class="line">  <span class="keyword">return</span> (++context_-&gt;vote_quorum) &gt; (options_.members.<span class="built_in">size</span>() / <span class="number">2</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="Receiver"><a href="#Receiver" class="headerlink" title="Receiver"></a>Receiver</h4><p>æ­¤å¤–ï¼Œå¯¹åº”å¤„ç† <code>RequestVote RPC</code> çš„é€»è¾‘æ¶‰åŠé€‰ä¸¾å’Œå®‰å…¨æ€§, å†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//! å“åº”æŠ•ç¥¨ RPC.</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">FloydImpl::ReplyRequestVote</span><span class="params">(<span class="type">const</span> CmdRequest&amp; request, CmdResponse* response)</span> </span>&#123;</span><br><span class="line">  <span class="function">slash::MutexLock <span class="title">l</span><span class="params">(&amp;context_-&gt;global_mu)</span></span>;</span><br><span class="line">  <span class="type">bool</span> granted = <span class="literal">false</span>;</span><br><span class="line">  CmdRequest_RequestVote request_vote = request.<span class="built_in">request_vote</span>();</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">   * If RPC request or response contains term T &gt; currentTerm: set currentTerm = T, convert to follower (5.1)</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * å˜æˆ follower, ç„¶åè®¾ç½® VoteFor.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">if</span> (request_vote.<span class="built_in">term</span>() &gt; context_-&gt;current_term) &#123;</span><br><span class="line">    context_-&gt;<span class="built_in">BecomeFollower</span>(request_vote.<span class="built_in">term</span>()); <span class="comment">// æ¨é«˜è‡ªå·±çš„ term.</span></span><br><span class="line">    raft_meta_-&gt;<span class="built_in">SetCurrentTerm</span>(context_-&gt;current_term);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// if caller&#x27;s term smaller than my term, then I will notice him</span></span><br><span class="line">  <span class="keyword">if</span> (request_vote.<span class="built_in">term</span>() &lt; context_-&gt;current_term) &#123;</span><br><span class="line">    <span class="built_in">LOGV</span>(INFO_LEVEL, info_log_, <span class="string">&quot;FloydImpl::ReplyRequestVote: Leader %s:%d term %lu is smaller than my %s:%d current term %lu&quot;</span>,</span><br><span class="line">        request_vote.<span class="built_in">ip</span>().<span class="built_in">c_str</span>(), request_vote.<span class="built_in">port</span>(), request_vote.<span class="built_in">term</span>(), options_.local_ip.<span class="built_in">c_str</span>(), options_.local_port,</span><br><span class="line">        context_-&gt;current_term);</span><br><span class="line">    <span class="built_in">BuildRequestVoteResponse</span>(context_-&gt;current_term, granted, response);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è®ºæ–‡: å®‰å…¨æ€§, ä¸èƒ½ç»™ Log æ¯”è‡ªå·±æ—§çš„æŠ•ç¥¨.</span></span><br><span class="line"></span><br><span class="line">  <span class="type">uint64_t</span> my_last_log_term = <span class="number">0</span>;</span><br><span class="line">  <span class="type">uint64_t</span> my_last_log_index = <span class="number">0</span>;</span><br><span class="line">  raft_log_-&gt;<span class="built_in">GetLastLogTermAndIndex</span>(&amp;my_last_log_term, &amp;my_last_log_index);</span><br><span class="line">  <span class="comment">// if votedfor is null or candidateId, and candidated&#x27;s log is at least as up-to-date</span></span><br><span class="line">  <span class="comment">// as receiver&#x27;s log, grant vote</span></span><br><span class="line">  <span class="keyword">if</span> ((request_vote.<span class="built_in">last_log_term</span>() &lt; my_last_log_term) ||</span><br><span class="line">      ((request_vote.<span class="built_in">last_log_term</span>() == my_last_log_term) &amp;&amp; (request_vote.<span class="built_in">last_log_index</span>() &lt; my_last_log_index))) &#123;</span><br><span class="line">    <span class="built_in">BuildRequestVoteResponse</span>(context_-&gt;current_term, granted, response);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// vote_for ä¸èƒ½ç»™è¿™ä¸ª term å·²ç»æŠ•è¿‡ç¥¨çš„åšæ“ä½œ.</span></span><br><span class="line">  <span class="keyword">if</span> (vote_for_.<span class="built_in">find</span>(request_vote.<span class="built_in">term</span>()) != vote_for_.<span class="built_in">end</span>()</span><br><span class="line">      &amp;&amp; vote_for_[request_vote.<span class="built_in">term</span>()] != std::<span class="built_in">make_pair</span>(request_vote.<span class="built_in">ip</span>(), request_vote.<span class="built_in">port</span>())) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ç»™äºˆé€‰ç¥¨.</span></span><br><span class="line">  vote_for_[request_vote.<span class="built_in">term</span>()] = std::<span class="built_in">make_pair</span>(request_vote.<span class="built_in">ip</span>(), request_vote.<span class="built_in">port</span>());</span><br><span class="line">  context_-&gt;<span class="built_in">BecomeFollower</span>(request_vote.<span class="built_in">term</span>());</span><br><span class="line">  <span class="comment">// Note(mwish): -&gt; éš¾é“è¿™ä¸ªåœ°æ–¹ä¸åº”è¯¥åšä¸€ä¸ª Batch Op çš„å—, orz...</span></span><br><span class="line">  raft_meta_-&gt;<span class="built_in">SetCurrentTerm</span>(context_-&gt;current_term);</span><br><span class="line">  raft_meta_-&gt;<span class="built_in">SetVotedForIp</span>(context_-&gt;voted_for_ip);</span><br><span class="line">  raft_meta_-&gt;<span class="built_in">SetVotedForPort</span>(context_-&gt;voted_for_port);</span><br><span class="line">  <span class="comment">// Got my vote</span></span><br><span class="line">  <span class="built_in">GrantVote</span>(request_vote.<span class="built_in">term</span>(), request_vote.<span class="built_in">ip</span>(), request_vote.<span class="built_in">port</span>());</span><br><span class="line">  granted = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">  context_-&gt;last_op_time = slash::<span class="built_in">NowMicros</span>();</span><br><span class="line">  <span class="built_in">BuildRequestVoteResponse</span>(context_-&gt;current_term, granted, response);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="ç«é€‰å¤±è´¥"><a href="#ç«é€‰å¤±è´¥" class="headerlink" title="ç«é€‰å¤±è´¥"></a>ç«é€‰å¤±è´¥</h4><p>å¦‚æœæ²¡æœ‰ Leader, <code>floyd_primary_thread</code> ä¼šä¸åœè°ƒç”¨ <code>CheckLeader</code>ï¼Œè¿™é‡Œçš„æ¡ä»¶æ˜¯ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">context_-&gt;last_op_time + options_.check_leader_us &lt; slash::<span class="built_in">NowMicros</span>()</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä¼šæ ¹æ® <code>last_op_time</code> æ¥ Leader ç›¸å…³çš„æ“ä½œæ—¶é—´ã€‚æ¥æ”¶æˆåŠŸçš„ <code>RequestVote</code> å’Œä»»ä½• <code>AppendEntities</code> éƒ½ä¼šæ›´æ–°è¿™ä¸ªæ—¶é—´ï¼ˆé¢˜å¤–è¯ï¼Œè¿™é‡Œä¸æ˜¯æœ‰æ•ˆ Leader çš„ <code>AppendEntities</code> éƒ½ä¼šæ›´æ–°ï¼Œå¯èƒ½æ˜¯ Leader å¿ƒè·³åŒ…æ˜¯ <code>RequestVote</code>ï¼Œæˆ‘è§‰å¾— tmd å¥½è¯¡å¼‚ï¼‰</p><h3 id="Log-Replication-1"><a href="#Log-Replication-1" class="headerlink" title="Log Replication"></a>Log Replication</h3><p>å¤–éƒ¨çš„è¯·æ±‚ä¼šèµ°åˆ° <code>AppendEntries</code></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">FloydPrimary::NoticePeerTask</span><span class="params">(TaskType type)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">auto</span>&amp; peer : (*peers_)) &#123;</span><br><span class="line">    <span class="keyword">switch</span> (type) &#123;</span><br><span class="line">    <span class="keyword">case</span> kHeartBeat:</span><br><span class="line">...</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> kNewCommand:</span><br><span class="line">      peer.second-&gt;<span class="built_in">AddAppendEntriesTask</span>();</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å›å¿†ä¸€ä¸‹ï¼Œé€‰ä¸Š Leader çš„æ—¶å€™ä¼šåšä¸€äº›åˆå§‹åŒ–ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//! æˆä¸ºäº† Leader, å¯ä»¥æ›´æ–° Peer çš„ä¿¡æ¯äº†.</span></span><br><span class="line"><span class="comment">//! Q: è¿™ä¸ªåœ°æ–¹ä¸ä¼šæœ‰å¹¶å‘å—...</span></span><br><span class="line"><span class="comment">//! A: ä½ æœ¬æœºç†è®ºä¸Šåªæœ‰ Leader çº¿ç¨‹ä¼šæ”¹ï¼Œç›¸å¯¹è®ºä¿è¯ä½ æ²¡æœ‰å¹¶å‘.</span></span><br><span class="line"><span class="comment">//!</span></span><br><span class="line"><span class="comment">//! åˆå§‹åŒ– nextIndex ä¸º Leader çš„ index, matchIndex ä¸º 0.</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Peer::UpdatePeerInfo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">auto</span>&amp; pt : (*peers_)) &#123;</span><br><span class="line">    pt.second-&gt;<span class="built_in">set_next_index</span>(raft_log_-&gt;<span class="built_in">GetLastLogIndex</span>() + <span class="number">1</span>);</span><br><span class="line">    pt.second-&gt;<span class="built_in">set_match_index</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå‡½æ•°æ¯”è¾ƒé•¿ï¼Œæˆ‘ä»¬ä¼šåˆ†å‡ éƒ¨åˆ†è®²ï¼Œå¹¶é¡ºä¾¿ä»‹ç» <code>Peer</code> ã€‚ç¬¬ä¸€éƒ¨åˆ†æ˜¯æ„é€ å’Œå‘é€è¯·æ±‚ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">Peer::AppendEntriesRPC</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="type">uint64_t</span> prev_log_index = <span class="number">0</span>;</span><br><span class="line">  <span class="type">uint64_t</span> num_entries = <span class="number">0</span>;</span><br><span class="line">  <span class="type">uint64_t</span> prev_log_term = <span class="number">0</span>;</span><br><span class="line">  <span class="type">uint64_t</span> last_log_index = <span class="number">0</span>;</span><br><span class="line">  <span class="type">uint64_t</span> current_term = <span class="number">0</span>;</span><br><span class="line">  CmdRequest req;</span><br><span class="line">  CmdRequest_AppendEntries* append_entries = req.<span class="built_in">mutable_append_entries</span>();</span><br><span class="line">  &#123;</span><br><span class="line">  <span class="function">slash::MutexLock <span class="title">l</span><span class="params">(&amp;context_-&gt;global_mu)</span></span>;</span><br><span class="line">  prev_log_index = next_index_ - <span class="number">1</span>;</span><br><span class="line">  last_log_index = raft_log_-&gt;<span class="built_in">GetLastLogIndex</span>();</span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">   * LOGV(INFO_LEVEL, info_log_, &quot;Peer::AppendEntriesRPC: next_index_ %d last_log_index %d peer_last_op_time %lu nowmicros %lu&quot;,</span></span><br><span class="line"><span class="comment">   *     next_index_.load(), last_log_index, peer_last_op_time, slash::NowMicros());</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">if</span> (next_index_ &gt; last_log_index &amp;&amp; peer_last_op_time + options_.heartbeat_us &gt; slash::<span class="built_in">NowMicros</span>()) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  peer_last_op_time = slash::<span class="built_in">NowMicros</span>();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (prev_log_index != <span class="number">0</span>) &#123;</span><br><span class="line">    Entry entry;</span><br><span class="line">    <span class="keyword">if</span> (raft_log_-&gt;<span class="built_in">GetEntry</span>(prev_log_index, &amp;entry) != <span class="number">0</span>) &#123;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      prev_log_term = entry.<span class="built_in">term</span>();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  current_term = context_-&gt;current_term;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ä¸‹é¢è¿™äº›å’Œè®ºæ–‡ä¸€æ ·.</span></span><br><span class="line">  </span><br><span class="line">  req.<span class="built_in">set_type</span>(Type::kAppendEntries);</span><br><span class="line">  append_entries-&gt;<span class="built_in">set_ip</span>(options_.local_ip);</span><br><span class="line">  append_entries-&gt;<span class="built_in">set_port</span>(options_.local_port);</span><br><span class="line">  append_entries-&gt;<span class="built_in">set_term</span>(current_term);</span><br><span class="line">  append_entries-&gt;<span class="built_in">set_prev_log_index</span>(prev_log_index);</span><br><span class="line">  append_entries-&gt;<span class="built_in">set_prev_log_term</span>(prev_log_term);</span><br><span class="line">  append_entries-&gt;<span class="built_in">set_leader_commit</span>(context_-&gt;commit_index);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è·å– [next_index_, last_log_index] ä¹‹é—´çš„ LogEntry.</span></span><br><span class="line">  <span class="comment">// å‘é€å—åˆ° `Options` çš„é™åˆ¶, æœ€å¤šå‘é€ append_entries_count_once ä¸ª</span></span><br><span class="line">  <span class="comment">//  æˆ–è€… `append_entries_size_once` bytes.</span></span><br><span class="line">  Entry *tmp_entry = <span class="keyword">new</span> <span class="built_in">Entry</span>();</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">uint64_t</span> index = next_index_; index &lt;= last_log_index; index++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (raft_log_-&gt;<span class="built_in">GetEntry</span>(index, tmp_entry) == <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="comment">// TODO(ba0tiao) how to avoid memory copy here</span></span><br><span class="line">      Entry *entry = append_entries-&gt;<span class="built_in">add_entries</span>();</span><br><span class="line">      *entry = *tmp_entry;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    num_entries++;</span><br><span class="line">    <span class="keyword">if</span> (num_entries &gt;= options_.append_entries_count_once</span><br><span class="line">        || (<span class="type">uint64_t</span>)append_entries-&gt;<span class="built_in">ByteSize</span>() &gt;= options_.append_entries_size_once) &#123;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">delete</span> tmp_entry;</span><br><span class="line"></span><br><span class="line">  CmdResponse res;</span><br><span class="line">  Status result = pool_-&gt;<span class="built_in">SendAndRecv</span>(peer_addr_, req, &amp;res);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// ... </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„ä¸»è¦å†…å®¹æ˜¯ Raft æ€ä¹ˆæ„é€ ä¸€ä¸ª AppendEntry è¯·æ±‚çš„ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">  &#123;</span><br><span class="line">  <span class="function">slash::MutexLock <span class="title">l</span><span class="params">(&amp;context_-&gt;global_mu)</span></span>;</span><br><span class="line">  <span class="keyword">if</span> (!result.<span class="built_in">ok</span>()) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// here we may get a larger term, and transfer to follower</span></span><br><span class="line">  <span class="comment">// so we need to judge the role here</span></span><br><span class="line">  <span class="keyword">if</span> (context_-&gt;role == Role::kLeader) &#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * receiver has higer term than myself, so turn from candidate to follower</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">if</span> (res.<span class="built_in">append_entries_res</span>().<span class="built_in">term</span>() &gt; context_-&gt;current_term) &#123;</span><br><span class="line">      context_-&gt;<span class="built_in">BecomeFollower</span>(res.<span class="built_in">append_entries_res</span>().<span class="built_in">term</span>());</span><br><span class="line">      raft_meta_-&gt;<span class="built_in">SetCurrentTerm</span>(context_-&gt;current_term);</span><br><span class="line">      raft_meta_-&gt;<span class="built_in">SetVotedForIp</span>(context_-&gt;voted_for_ip);</span><br><span class="line">      raft_meta_-&gt;<span class="built_in">SetVotedForPort</span>(context_-&gt;voted_for_port);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (res.<span class="built_in">append_entries_res</span>().<span class="built_in">success</span>() == <span class="literal">true</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (num_entries &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        match_index_ = prev_log_index + num_entries;</span><br><span class="line">        <span class="comment">// only log entries from the leader&#x27;s current term are committed</span></span><br><span class="line">        <span class="comment">// by counting replicas</span></span><br><span class="line">        <span class="keyword">if</span> (append_entries-&gt;<span class="built_in">entries</span>(num_entries - <span class="number">1</span>).<span class="built_in">term</span>() == context_-&gt;current_term) &#123;</span><br><span class="line">          <span class="built_in">AdvanceLeaderCommitIndex</span>();</span><br><span class="line">          apply_-&gt;<span class="built_in">ScheduleApply</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        next_index_ = prev_log_index + num_entries + <span class="number">1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="type">uint64_t</span> adjust_index = std::<span class="built_in">min</span>(res.<span class="built_in">append_entries_res</span>().<span class="built_in">last_log_index</span>() + <span class="number">1</span>,</span><br><span class="line">                                       next_index_ - <span class="number">1</span>);</span><br><span class="line">      <span class="keyword">if</span> (adjust_index &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// Prev log don&#x27;t match, so we retry with more prev one according to</span></span><br><span class="line">        <span class="comment">// response</span></span><br><span class="line">        next_index_ = adjust_index;</span><br><span class="line">        <span class="built_in">AddAppendEntriesTask</span>();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="Receiver-1"><a href="#Receiver-1" class="headerlink" title="Receiver"></a>Receiver</h4><p><code>Receiver</code> çš„é€»è¾‘ç‰¹åˆ«æ¸…æ™°ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">FloydImpl::ReplyAppendEntries</span><span class="params">(<span class="type">const</span> CmdRequest&amp; request, CmdResponse* response)</span> </span>&#123;</span><br><span class="line">  <span class="type">bool</span> success = <span class="literal">false</span>;</span><br><span class="line">  CmdRequest_AppendEntries append_entries = request.<span class="built_in">append_entries</span>();</span><br><span class="line">  <span class="function">slash::MutexLock <span class="title">l</span><span class="params">(&amp;context_-&gt;global_mu)</span></span>;</span><br><span class="line">  <span class="comment">// update last_op_time to avoid another leader election</span></span><br><span class="line">  context_-&gt;last_op_time = slash::<span class="built_in">NowMicros</span>();</span><br><span class="line">  <span class="comment">// Ignore stale term</span></span><br><span class="line">  <span class="comment">// if the append entries leader&#x27;s term is smaller than my current term, then the caller must an older leader</span></span><br><span class="line">  <span class="keyword">if</span> (append_entries.<span class="built_in">term</span>() &lt; context_-&gt;current_term) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">BuildAppendEntriesResponse</span>(success, context_-&gt;current_term, raft_log_-&gt;<span class="built_in">GetLastLogIndex</span>(), response);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((append_entries.<span class="built_in">term</span>() &gt; context_-&gt;current_term) </span><br><span class="line">      || (append_entries.<span class="built_in">term</span>() == context_-&gt;current_term &amp;&amp; </span><br><span class="line">        (context_-&gt;role == kCandidate || (context_-&gt;role == kFollower &amp;&amp; context_-&gt;leader_ip == <span class="string">&quot;&quot;</span>)))) &#123;</span><br><span class="line"></span><br><span class="line">    context_-&gt;<span class="built_in">BecomeFollower</span>(append_entries.<span class="built_in">term</span>(),</span><br><span class="line">        append_entries.<span class="built_in">ip</span>(), append_entries.<span class="built_in">port</span>());</span><br><span class="line">    raft_meta_-&gt;<span class="built_in">SetCurrentTerm</span>(context_-&gt;current_term);</span><br><span class="line">    raft_meta_-&gt;<span class="built_in">SetVotedForIp</span>(context_-&gt;voted_for_ip);</span><br><span class="line">    raft_meta_-&gt;<span class="built_in">SetVotedForPort</span>(context_-&gt;voted_for_port);</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…ˆè¿‡æ»¤æ‰å‚æ•°ï¼Œå†æ¥ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (append_entries.<span class="built_in">prev_log_index</span>() &gt; raft_log_-&gt;<span class="built_in">GetLastLogIndex</span>()) &#123;</span><br><span class="line">    <span class="built_in">BuildAppendEntriesResponse</span>(success, context_-&gt;current_term, raft_log_-&gt;<span class="built_in">GetLastLogIndex</span>(), response);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Append entry</span></span><br><span class="line">  <span class="keyword">if</span> (append_entries.<span class="built_in">prev_log_index</span>() &lt; raft_log_-&gt;<span class="built_in">GetLastLogIndex</span>()) &#123;</span><br><span class="line">    raft_log_-&gt;<span class="built_in">TruncateSuffix</span>(append_entries.<span class="built_in">prev_log_index</span>() + <span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// we compare peer&#x27;s prev index and term with my last log index and term</span></span><br><span class="line">  <span class="type">uint64_t</span> my_last_log_term = <span class="number">0</span>;</span><br><span class="line">  Entry entry;</span><br><span class="line">  <span class="keyword">if</span> (append_entries.<span class="built_in">prev_log_index</span>() == <span class="number">0</span>) &#123;</span><br><span class="line">    my_last_log_term = <span class="number">0</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (raft_log_-&gt;<span class="built_in">GetEntry</span>(append_entries.<span class="built_in">prev_log_index</span>(), &amp;entry) == <span class="number">0</span>) &#123;</span><br><span class="line">    my_last_log_term = entry.<span class="built_in">term</span>();</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (append_entries.<span class="built_in">prev_log_term</span>() != my_last_log_term) &#123;</span><br><span class="line">    <span class="built_in">BuildAppendEntriesResponse</span>(success, context_-&gt;current_term, raft_log_-&gt;<span class="built_in">GetLastLogIndex</span>(), response);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  std::vector&lt;<span class="type">const</span> Entry*&gt; entries;</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; append_entries.<span class="built_in">entries</span>().<span class="built_in">size</span>(); i++) &#123;</span><br><span class="line">    entries.<span class="built_in">push_back</span>(&amp;append_entries.<span class="built_in">entries</span>(i));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (append_entries.<span class="built_in">entries</span>().<span class="built_in">size</span>() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (raft_log_-&gt;<span class="built_in">Append</span>(entries) &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="built_in">BuildAppendEntriesResponse</span>(success, context_-&gt;current_term, raft_log_-&gt;<span class="built_in">GetLastLogIndex</span>(), response);</span><br><span class="line">      <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (append_entries.<span class="built_in">leader_commit</span>() != context_-&gt;commit_index) &#123;</span><br><span class="line">    <span class="built_in">AdvanceFollowerCommitIndex</span>(append_entries.<span class="built_in">leader_commit</span>());</span><br><span class="line">    apply_-&gt;<span class="built_in">ScheduleApply</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  success = <span class="literal">true</span>;</span><br><span class="line">  <span class="comment">// only when follower successfully do appendentries, we will update commit index</span></span><br><span class="line">  <span class="built_in">BuildAppendEntriesResponse</span>(success, context_-&gt;current_term, raft_log_-&gt;<span class="built_in">GetLastLogIndex</span>(), response);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶å®å°±å¾ˆç®€å•ã€‚</p><h3 id="Client"><a href="#Client" class="headerlink" title="Client"></a>Client</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Status <span class="title">FloydImpl::ExecuteCommand</span><span class="params">(<span class="type">const</span> CmdRequest&amp; request,</span></span></span><br><span class="line"><span class="params"><span class="function">                                 CmdResponse *response)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// Append entry local</span></span><br><span class="line">  std::vector&lt;<span class="type">const</span> Entry*&gt; entries;</span><br><span class="line">  Entry entry;</span><br><span class="line">  <span class="built_in">BuildLogEntry</span>(request, context_-&gt;current_term, &amp;entry);</span><br><span class="line">  entries.<span class="built_in">push_back</span>(&amp;entry);</span><br><span class="line">  response-&gt;<span class="built_in">set_type</span>(request.<span class="built_in">type</span>());</span><br><span class="line">  response-&gt;<span class="built_in">set_code</span>(StatusCode::kError);</span><br><span class="line"></span><br><span class="line">  <span class="type">uint64_t</span> last_log_index = raft_log_-&gt;<span class="built_in">Append</span>(entries);</span><br><span class="line">  <span class="keyword">if</span> (last_log_index &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> Status::<span class="built_in">IOError</span>(<span class="string">&quot;Append Entry failed&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Notify primary then wait for apply</span></span><br><span class="line">  primary_-&gt;<span class="built_in">AddTask</span>(kNewCommand);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  &#123;</span><br><span class="line">  <span class="function">slash::MutexLock <span class="title">l</span><span class="params">(&amp;context_-&gt;apply_mu)</span></span>;</span><br><span class="line">  <span class="keyword">while</span> (context_-&gt;last_applied &lt; last_log_index) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!context_-&gt;apply_cond.<span class="built_in">TimedWait</span>(<span class="number">1000</span>)) &#123;</span><br><span class="line">      <span class="keyword">return</span> Status::<span class="built_in">Timeout</span>(<span class="string">&quot;FloydImpl::ExecuteCommand Timeout&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨è¿™é‡Œï¼Œä¸ç®¡æ˜¯ <code>Get</code> è¿˜æ˜¯ <code>Set</code>ï¼Œéƒ½ä¼šèµ·ä¸€ä¸ª Command, ç„¶åèµ°çŠ¶æ€æœºã€‚è¿™é‡Œä¸ä¼šæ ¹æ® Seq æ¥é‡è¯•ï¼Œæ²¡äº†å°±æ˜¯æ²¡äº†ï¼Œæ²¡é‚£ä¹ˆå¤šèŠ±å¤´ã€‚</p><h3 id="Recall-çº¿ç¨‹æ¨¡å‹"><a href="#Recall-çº¿ç¨‹æ¨¡å‹" class="headerlink" title="Recall: çº¿ç¨‹æ¨¡å‹"></a>Recall: çº¿ç¨‹æ¨¡å‹</h3><p>è¿™é‡Œéœ€è¦æ³¨æ„åˆ°ï¼Œ<code>floyd_primary_thread</code>çº¿ç¨‹ä¼šå•çº¿ç¨‹çš„ç»´æŠ¤ <code>kHeartbeat</code>ã€<code>kNewCommand</code>ï¼Œè¿™äº›æ°´ä½å¯èƒ½ä¼šç”± Master å’Œ Peer å˜æ›´ã€‚<code>Peer</code> çš„ä»»åŠ¡æ˜¯å•çº¿ç¨‹çš„ï¼Œè¿™æ˜¯è¯´ï¼Œå¯¹å•ä¸ª <code>Peer</code>ï¼Œä¸ä¼šæœ‰ä¸¤ä¸ªå¹¶å‘çš„å†™æ“ä½œã€‚</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>xv6 labs 2021 report</title>
      <link href="/2022/04/06/xv6-labs-2021-report/"/>
      <url>/2022/04/06/xv6-labs-2021-report/</url>
      
        <content type="html"><![CDATA[<p>ä¸ºå•¥ä¼šåœ¨è¿™ä¸ªèŠ‚ç‚¹åš xv6 lab å‘¢â€¦å…¶å®æœ€æ—©æ˜¯å»å¹´12æœˆçœ‹ <code>perfbook</code> çš„æ—¶å€™ï¼Œæ„Ÿè§‰æ²¡æœ‰ç®€å•çš„ OS å®ç°çš„çŸ¥è¯†çš„è¯ï¼Œå¾ˆå¤šä¸œè¥¿å•ƒçš„ä¸å¤ªé¡ºï¼Œæ¯”å¦‚ <code>spinlock</code> ä¸ºä»€ä¹ˆè¦å…³ä¸­æ–­ã€ä¸­æ–­çš„ <code>perf</code> é‡‡æ ·ä¹‹ç±»çš„ã€‚1æœˆåšäº† lab1-2ï¼Œä¸­é—´åŸºæœ¬æç½®äº†ï¼Œç„¶åè¶ç€å±…å®¶åŠå…¬è¿™ä¸‰å‘¨æŠŠæ‰€æœ‰çš„å†…å®¹åšå®Œäº†ã€‚æœç„¶è¿˜æ˜¯å¾—æ‰¾ä¸ªä¸é‚£ä¹ˆå¿™çš„å·¥ä½œæ‰èƒ½å¥½å¥½å­¦äº›ä¸œè¥¿â€¦</p><p>è¨€å½’æ­£ä¼ ï¼Œæ¸…æ˜èŠ‚å•¥éƒ½æ²¡åšï¼ŒåŸºæœ¬é™¤äº†å½•ä¸€ä¸ªå…³äºåŠ¨ç”»çš„ podcastã€çœ‹ä¸€æœ¬å•çº¸åŸºæœ¬å°±æŠŠè¿™ä¸ªåä¸‰ä¸ª lab æ¸…æ‰äº†ã€‚</p><h2 id="ä¸€äº›æµæ°´è´¦"><a href="#ä¸€äº›æµæ°´è´¦" class="headerlink" title="ä¸€äº›æµæ°´è´¦"></a>ä¸€äº›æµæ°´è´¦</h2><p>è€—æ—¶ï¼šæ¯ä¸ª lab å¹³å‡è€—æ—¶å¤§æ¦‚ 3-4 å°æ—¶ï¼Œç„¶åçœ‹ä»£ç å’Œ book å¤§æ¦‚è¦èŠ±æ‰æ¯èŠ‚ 1/2 çš„æ—¶é—´ã€‚åŠ ä¸Šæ•ˆç‡ä½çš„æ—¶å€™ï¼Œæˆ‘å¤§æ¦‚ 60-80 å°æ—¶åšå®Œäº†æ‰€æœ‰çš„å†…å®¹ï¼ˆæ²¡æœ‰è®¡æ—¶ï¼Œåªå‡­å›å¿†å’Œ<code>æ¯ä¸ª lab çš„è€—æ—¶ * (1.5 - 2.0)</code> ç®—çš„ï¼‰ã€‚æœ‰äº›éœ€è¦çœ‹çš„è®ºæ–‡æš‚æ—¶è¿˜æ²¡çœ‹ã€‚æ„Ÿè§‰å…¨çœ‹å®Œå¤§æ¦‚ 100hï¼Ÿä¸çŸ¥é“æ˜¯ä¸æ˜¯æˆ‘å†™çš„å¤ªæ…¢è¿˜æ˜¯æ€ä¹ˆå›äº‹ï¼Œå’Œæˆ‘æ‰“ Baldr Sky çš„æ—¶é—´å·®ä¸å¤šäº†â€¦</p><p>æ¯ä¸ª lab ï¼ˆé™¤äº† mmap ï¼‰ä»£ç é‡ä¸å¤šï¼Œé€šå¸¸åœ¨ 150loc å·¦å³ã€‚ä¸è¿‡ä½ è¦è·Ÿç€ hint å»æƒ³æ€ä¹ˆå†™ã€‚è¿™äº› lab åŸºæœ¬ä¸Šæ˜¯ã€Œè®©ä½ ç†Ÿæ‚‰ xv6 ä»£ç ã€ï¼Œè€Œä¸æ˜¯è®©ä½ é€ ä¸€äº›ç›¸å¯¹å¤æ‚çš„æ•°æ®ç»“æ„ï¼ˆå³ä½¿æ˜¯ lock labï¼Œè®©ä½ é€  scalable çš„å¹¶å‘ç»“æ„ï¼Œå…¶å®ç»“æ„ä¸Šä¹Ÿå¾ˆç®€å•ï¼‰ã€‚åå‘ç­–ç•¥è€Œéå®ç°</p><p>æ¨èå¯ä»¥å¯¹ç…§ç€ä¸‹é¢çš„ææ–™çœ‹ï¼š</p><ol><li>é™ˆæµ·æ³¢ ç°ä»£æ“ä½œç³»ç»Ÿ</li><li>rCore-Tutorial</li></ol><p>æˆ‘ä¸ªäººå¯¹ xv6 book çš„ä¸€äº›ç¬”è®°æ”¾åœ¨äº† GitHub ä¸Šï¼š<a href="https://github.com/mapleFU/xv6-riscv">https://github.com/mapleFU/xv6-riscv</a></p><p>debug ä¸»è¦é  lab4 çš„ <code>backtrace</code>ã€‚ä¹‹åæˆ‘æŠŠ <code>backtrace</code> æŠ½æˆäº†ä¸€ä¸ª commit, æŸ¥é—®é¢˜çš„æ—¶å€™ cherry-pick ä¸Šæ¥å°±è¡Œäº†ã€‚è™½è¯´æˆ‘ä¹Ÿä¼šç”¨ gdb æ¥ debugï¼Œä¸è¿‡å®é™…å¸®åŠ©ä¸æ˜¯å¾ˆå¤§ï¼Œå¯èƒ½æ˜¯å› ä¸ºä»£ç éƒ½æ¯”è¾ƒç®€å•å§ï¼Œä¸å¦‚ backtrace ç„¶åæŸ¥åŸå› ã€‚</p><h3 id="Lab1"><a href="#Lab1" class="headerlink" title="Lab1"></a>Lab1</h3><p>å†™ä¸€äº› xv6 çš„ç”¨æˆ·æ€æ¥å£ã€‚å’Œ POSIX æ¥å£ä¸å®Œå…¨ä¸€æ ·ã€‚</p><p>lab1 å®ç°çš„æ—¶å€™æœ‰ä¸ªå‘ï¼Œå°±æ˜¯ fork ä¹‹åä¸€å®šè¦æ­£å¸¸ exitã€‚è¿™é‡ŒæŸ¥çš„æ—¶å€™å‡ºç°äº†å…³é—­çš„æ—¶å€™æ— æ³•æ­£å¸¸å…³é—­çš„ bugï¼Œå¯¼è‡´å¤±è´¥ã€‚</p><p>è¿™ä¸€èŠ‚ä»‹ç»äº† 6.s081 çš„ user-space æ¥å£. åŒ…æ‹¬ï¼š</p><ol><li>è¿›ç¨‹ç›¸å…³çš„ fork/exit/wait/exec</li><li>IO ç›¸å…³çš„ open/read/writeï¼Œç”¨æˆ·è¦ç†è§£ä¸¤å¼ è¡¨çš„æ¦‚å¿µï¼šè¿›ç¨‹æœ‰ä¸ª fd çš„è¡¨ï¼Œfork ä¹‹å fd ä¸å˜ï¼›dup åªæœ‰æœ‰ä¸€ä¸ªæŒ‡å‘ä¸åŒ fdï¼Œä½†æ˜¯åŒä¸€ä¸ªæ–‡ä»¶çš„è¡¨ã€‚è·Ÿ Dup æ— å…³ï¼Œæ–‡ä»¶èµ„æºæœ¬èº«æœ‰ä¸€ä¸ªå¼•ç”¨è¡¨ï¼Œå«åšæ‰“å¼€æ–‡ä»¶è¡¨ï¼Œå…±äº«åç§»é‡ï¼Œæ¥åšå¼•ç”¨è®¡æ•°ã€‚ç„¶åæœ‰ä¸ª v-node è¡¨ï¼Œè®°å½•æ–‡ä»¶ä¿¡æ¯å’Œ ref-cnt</li><li>pipes, æ¯”å¦‚ stdin stdout</li><li><code>cd</code> ä¸æ˜¯ system callï¼Œè€Œæ˜¯ä¸€ä¸ªç›®å½•åˆ‡æ¢</li></ol><h3 id="Lab2"><a href="#Lab2" class="headerlink" title="Lab2"></a>Lab2</h3><p>Lab2 å†…å®¹æ˜¯ç»™ xv6 æ·»åŠ ä¸€äº› syscallï¼Œå±äºæ²¡åµæ„æ€çš„é‚£ç§ã€‚<br>Process æœ¬èº«è®°å½•å•ä¸ªè¿›ç¨‹ï¼Œæœ‰ä¸ª <code>proc.h</code> è®°å½•ç»“æ„ä½“çš„å†…å®¹ï¼Œç„¶å update è¿™ä¸ªæˆ–è€…è¯»è¿™ä¸ªå†…å®¹è¿˜è¦èµ° <code>spinlock</code>ï¼Œç„¶åï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">void syscall(void)</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä¼šä»å¯„å­˜å™¨æ‰¾åˆ°å¯¹åº”çš„ syscall numberã€‚å¤–éƒ¨å‡½æ•°è°ƒç”¨çš„æ—¶å€™ä¹Ÿä¼šè®¾ç½®è¿™ä¸ªå€¼ï¼ˆ<code>user/usys.pl</code> ä¼šç”Ÿæˆ <code>.S</code> æ±‡ç¼–ï¼‰ã€‚</p><h3 id="Lab3"><a href="#Lab3" class="headerlink" title="Lab3"></a>Lab3</h3><p>Lab3 å†…å®¹å’Œ PageTable ç»“åˆï¼Œå…³é”®ç‚¹åœ¨äº Walk å‡½æ•°å’Œé¡µè¡¨çš„æ ‡è®°ï¼š</p><ol><li>Part1 æ˜¯æ·»åŠ ä¸€ä¸ªç±»ä¼¼ vdso çš„ Page, è¿™ä¸ª Page éœ€è¦åœ¨ <code>proc.c</code> é‡Œé¢ç”³è¯·ï¼Œç„¶åæŒ‚åœ¨ <code>struct proc</code> ä¸Šï¼Œç”± <code>freeproc</code> é‡Šæ”¾ã€‚åŒæ—¶ï¼Œè¿™é‡Œ PAGE ä¹Ÿéœ€è¦æ³¨æ„æŒ‚åœ¨é«˜ä½ã€‚ç„¶åå‰©ä¸‹çš„å†…å®¹åŒ…æ‹¬ä½ä½ï¼Œè¿™é‡Œä¼šç”³è¯·å†…å­˜ç»™ <code>sz</code> ï¼ŒåŒ…æ‹¬è¿›ç¨‹çš„å…ƒä¿¡æ¯ï¼ŒGuardPage å’Œå‰©ä¸‹çš„æ ˆ</li><li>Part2 æ²¡å•¥å¥½è¯´çš„ï¼Œå°±æ˜¯ä½¿ç”¨ <code>vmprint</code>, æ¥ visit é¡µè¡¨</li><li>Part3 ä¸»è¦åœ¨ç¡¬ä»¶ + è½¯ä»¶ä¸Šï¼Œè®¾ç½® PTE_A æ¥å¤„ç†é—®é¢˜</li></ol><h3 id="Lab4"><a href="#Lab4" class="headerlink" title="Lab4"></a>Lab4</h3><p>Lab4 å…¶å®ä¸å¤ªéš¾ï¼Œä½†æ˜¯æˆ‘è«åå…¶å¦™è¢«å¡äº†å¾ˆä¹…ï¼Œå› ä¸ºå‡ ä¸ªæˆ‘è‡ªå·±éƒ½æ²¡æƒ³æ˜ç™½çš„å¾ˆå¼±æ™ºçš„é—®é¢˜ã€‚</p><ul><li>Part1 æ˜¯ calling convention ç›¸å…³çš„é—®é¢˜ï¼Œæ¶‰åŠä¸‹é¢å‡ ä¸ªå†…å®¹ <a href="https://blog.mwish.me/2020/09/19/Integer-Endian/">https://blog.mwish.me/2020/09/19/Integer-Endian/</a> ï¼Œ<a href="https://blog.mwish.me/2020/06/07/RISC-V-%E5%85%A5%E9%97%A8-Part2/">https://blog.mwish.me/2020/06/07/RISC-V-%E5%85%A5%E9%97%A8-Part2/</a> . å›ç­”ç›¸å…³çš„é—®é¢˜å°±è¡Œäº†ï¼Œä¸è¿‡æˆ‘æ²¡ç¼–è¯‘è¿‡ <code>.asm</code> æ–‡ä»¶ï¼Œè¿™ä¸ªéå¸¸æœ‰æ„æ€</li><li>Part2 æ˜¯ä¸€ä¸ª backtrace çš„å®éªŒï¼Œè¿™ä¸ªåœ°æ–¹æœ‰å‡ ä¸ªå‘ï¼šæ ˆç›®å‰çš„é¡¶åœ¨ <code>sp</code>, é¡¶æ˜¯åœ°å€æœ€ä½çš„åœ°æ–¹ï¼Œåº•åœ¨ <code>fp</code>ï¼Œ<code>fp</code> å…¶å®ä¸æ˜¯å¿…é¡»çš„ã€‚ç„¶åæœ‰ä¸€ä¸ª <code>ra</code>, æ˜¯è¿”å›çš„æŒ‡ä»¤çš„åœ°å€ï¼Œå®é™…ä¸Šè¿™é‡Œæ‰“å°çš„æ˜¯è¿™ä¸ªåœ°å€ã€‚è¿™ä¸¤åœ°æ–¹æˆ‘ä¸€å¼€å§‹éƒ½æ²¡ææ¸…æ¥š</li><li>Part3 æ˜¯å†…æ ¸æ€è°ƒç”¨æˆ·æ€ä»£ç ï¼Œç»†èŠ‚ä¸å¤ªå¤šï¼Œä¸è¿‡å¾ˆæœ‰æ„æ€ï¼Œå†…æ ¸è¦è®¾ç½®å¯¹åº”çš„ <code>sepc</code> åˆ°åˆ«çš„ä½ç½®ï¼Œç„¶åè®©å®ƒåœ¨æ—§çš„æ ˆä¸Šæ‰§è¡Œæ–°çš„ä»£ç ï¼Œå› ä¸ºæ²¡æœ‰å‚æ•°ï¼Œæ‰€ä»¥æ²¡æœ‰é—®é¢˜ã€‚ç„¶åè¦æ¢å¤32ä¸ªç”¨æˆ·å¯„å­˜å™¨ã€‚ä¸ºä»€ä¹ˆæ˜¯ 32 ä¸ªå‘¢ï¼Ÿå› ä¸ºä»£ç å¯èƒ½åšä»»ä½•äº‹æƒ…ã€‚</li></ul><p><strong>Part2</strong> å¯¹ debug éå¸¸é‡è¦ã€‚</p><h3 id="Lab5"><a href="#Lab5" class="headerlink" title="Lab5"></a>Lab5</h3><p>Lab5 ä¹Ÿä¸å¤ªéš¾ï¼Œä¸è¿‡æŸ¥é—®é¢˜è¿‡ç¨‹è¿˜æ˜¯æ¯”è¾ƒæœ‰æ„æ€çš„ã€‚è¿™ä¸ª lab éœ€è¦è®¾ç½®æˆ cow çš„ï¼Œä¸ºæ­¤éœ€è¦ï¼š</p><ol><li>æˆ‘æŠŠ vm æ¨¡å—æ·»åŠ äº† <code>uint8</code> çš„ ref_cnt çš„ map, ç”±ä¸€ä¸ª spinlock ä¿æŠ¤ï¼Œ<code>kalloc</code> ä¼šé€’å¢å®ƒï¼Œ<code>kref</code> æ·»åŠ å¯¹åº”çš„ <code>refcnt</code>ï¼Œ<code>kfree</code> åªåœ¨ ref_cnt ä¸º 0 çš„æ—¶å€™ä½¿ç”¨</li><li>åœ¨ sv39 ä¸Šï¼Œå€ŸåŠ©äº† RSW ï¼ˆè½¯ä»¶éœ€è¦çš„ä½ï¼‰æ¥ä½¿ç”¨ã€‚å› ä¸ºåœ¨ COW çš„æ—¶å€™ï¼Œåªæœ‰ <code>PTE_X</code> çš„é¡µé¢ï¼Œæˆ‘æ‰ä¼šæ ‡è®°æˆ RSW + å–æ¶ˆ PTE_Wã€‚æˆ‘æœ‰ä¸ªåœ°æ–¹åšçš„ä¸å¤ªå¥½ï¼ŒCow å¦‚æœæ˜¯å†™ä¸¤ééƒ½ä¼šæ ‡è®°æˆè¿™æ ·ã€‚ä¼°è®¡ <code>ref_cnt = 1</code> çš„æ—¶å€™æˆ‘å¯ä»¥ä¸æ‹·è´ï¼Œç›´æ¥æ”¹å†™ã€‚</li><li>æœ‰ä¸€äº›ä»£ç éœ€è¦æ·»åŠ é¢å¤–çš„æ£€æŸ¥ï¼Œè¿™ä¸ªæˆ‘æŸ¥äº†å¥½ä¸€ä¼šå„¿çš„ Bugï¼Œæ¯”å¦‚ä¸€äº› vm è¶Šç•Œè®¿é—®ï¼Œä¸åº”è¯¥å†èµ° walkã€‚å› ä¸ºç”¨æˆ·å·²ç»åœ¨è®¿é—®é”™è¯¯çš„åœ°å€äº†</li><li>ä¸æ˜¯ç±»å‹å®‰å…¨çš„å¸¦æ¥äº†å¾ˆå¤šé—®é¢˜ï¼Œæˆ‘è§‰å¾—ä¸åº”è¯¥çŠ¯ï¼Œæ„Ÿè§‰ç±»å‹è¿˜æ˜¯å¾ˆé‡è¦çš„</li></ol><h3 id="Lab6"><a href="#Lab6" class="headerlink" title="Lab6"></a>Lab6</h3><p>Lab6 è¦ä½ åœ¨ç”¨æˆ·æ€ï¼ˆç”šè‡³æ˜¯æœ¬æœºä¸Šï¼Œè€Œä¸æ˜¯ xv6 ä¸Šï¼‰å†™ä¸€äº›å¹¶å‘å®¹å™¨ã€‚<code>Barrier</code> æœ‰ä¸€ç‚¹ç‚¹å°å°éš¾ã€‚è¿™ä¸ª Lab åº”è¯¥æ˜¯æœ€ç®€å•çš„ lab äº†ï¼Œç†Ÿæ‚‰ POSIX çº¿ç¨‹ã€ä¿¡å·é‚£å¥—åŸºæœ¬2å°æ—¶å†…æå®š</p><h3 id="Lab7"><a href="#Lab7" class="headerlink" title="Lab7"></a>Lab7</h3><p>ä¸éš¾ï¼Œä½†æ˜¯éå¸¸é¬¼ç•œã€‚è¦ä½ æ¨¡ä»¿ä¸€ä¸ªç½‘å¡è®¾å¤‡ï¼Œå¤„ç† DMAã€‚ç»™äº†ä¸€æœ¬æ‰‹å†Œçœ‹ç½‘å¡æ€ä¹ˆå¤„ç†çš„ï¼Œç„¶åä½ è¦åœ¨ä¸Šé¢åšå†…å­˜æ˜ å°„æ–‡ä»¶ã€‚</p><p>è¿™ä¸ªæˆ‘è§‰å¾—æŒ‡å¼•ä¸æ˜¯å¾ˆå¥½ï¼ŒåŸºæœ¬ä¸Šåœ¨å¯¹ç€æ‰‹å†Œå’Œ xv6 çš„ macro ç…§ç€åšï¼Œè€Œä¸”è€å®è¯´æˆ‘è¢«å¡äº†å¾ˆä¹…â€¦æœ€åä¸€çœ‹ä»£ç æ²¡æ”¹å¤šå°‘ã€‚</p><h3 id="Lab8"><a href="#Lab8" class="headerlink" title="Lab8"></a>Lab8</h3><p>Lab8 åŸºæœ¬ä¸Šæ˜¯ scalable data structureã€‚å’Œ perfbook çš„çŸ¥è¯†å¯ä»¥å¯¹ä¸Šï¼Œè¿™é‡Œæœ‰ä¸¤éƒ¨åˆ†ï¼š</p><ol><li>Scalable Allocator</li><li>Scalable Hashtable + LRU</li></ol><p>Lab ä¸€ä¸ªè¦æ±‚æ˜¯æ•°æ®å¿…é¡»æ˜¯ã€Œå‡†ã€çš„ï¼Œå°±æ˜¯ä¸å¤ªå…è®¸å‡ºç°è¿˜æœ‰èµ„æºçš„æ—¶å€™ï¼Œè¿˜è¿”å›åˆ†é…å¤±è´¥ã€‚æ‰€ä»¥å¾ˆå¤šä¸œè¥¿éœ€è¦ Stealã€‚ä¸è¿‡æˆ‘ä¸ªäººå–œæ¬¢ä»ä¸€ä¸ªä¸­å¿ƒåŒ–èŠ‚ç‚¹ä¿å­˜æ•°æ®ï¼Œç„¶åä¸€äº›èŠ‚ç‚¹æ¥è¿™ Batch Stealï¼Œè¿™æ ·å¤„ç†æˆ‘æ„Ÿè§‰ç›¸å¯¹ç®€å•ä¸€äº›ï¼Œé”åè®®ä¹Ÿç›¸å¯¹ç®€å•äº›ã€‚</p><p>Part2 ç›¸å¯¹æœ‰ç‚¹å°éº»çƒ¦ï¼Œéœ€è¦ä½ è¯¦ç»†çš„åšä¸€ä¸‹è¡Œä¸ºçš„å¯¹é½ã€‚</p><h3 id="Lab9"><a href="#Lab9" class="headerlink" title="Lab9"></a>Lab9</h3><p>æ¯”è¾ƒç®€å•ï¼Œå¯¹ç€åšå°±è¡Œâ€¦è¿™é‡Œå†…å®¹æ˜¯ï¼š</p><ol><li>æ·»åŠ ä¸€ä¸ª symlink çš„æ¥å£å¹¶å®ç°</li><li>è®© FS æ”¯æŒä¸¤çº§çš„ç´¢å¼•</li></ol><p>æˆ‘è§‰å¾—å¯ä»¥å¤šçœ‹çœ‹ xv6 book çš„ fs ä¸€èŠ‚ï¼Œçœ‹çœ‹ä» Log åˆ°ä¸Šå±‚ç”¨æˆ·å±‚ <code>struct file</code> æ˜¯æ€ä¹ˆç»„ç»‡çš„ï¼Œçœ‹å®Œäº†å†™è¿™ä¸¤ä¸ª Part åŸºæœ¬å’Œåˆ‡èœä¸€æ ·ã€‚</p><h3 id="Lab10"><a href="#Lab10" class="headerlink" title="Lab10"></a>Lab10</h3><p>ä¸éš¾ï¼Œä¸è¿‡ç®—æ˜¯å·¥ç¨‹é‡æ¯”è¾ƒå¤šçš„ Lab äº†ï¼ŒåŸºæœ¬ä¸Šæ˜¯ Lab3 + Lab5 ç»“åˆã€‚éœ€è¦å®Œæˆæ•´ä¸ª <code>mmap</code> çš„é“¾è·¯ã€‚ä¸è¿‡æœ‰çš„åœ°æ–¹æ¯”è¾ƒç®€å•ï¼Œæ¯”å¦‚ <code>mmap</code> æ²¡è¦æ±‚å’Œ cow ç»“åˆåˆ°ä¸€èµ·ã€‚</p><h2 id="æ”¶è·"><a href="#æ”¶è·" class="headerlink" title="æ”¶è·"></a>æ”¶è·</h2><ol><li>çº¿ç¨‹è°ƒåº¦äº†è§£äº†ä¸€äº›åŸºæœ¬çš„æœºåˆ¶ï¼Œè™½ç„¶ä¸äº†è§£å…·ä½“å®ç°ï¼Œä½†æ˜¯ï¼Œèƒ½å®Œæ•´é˜…è¯» <code>boost::Context</code> ç­‰ä»£ç </li><li>Syscallã€ä¸­æ–­å’Œé”ç³»ç»Ÿèƒ½å¤Ÿè”ç³»åœ¨ä¸€èµ·äº†ï¼Œä¹Ÿå¯¹ç¡¬ä»¶çš„ PMO ç­‰æ¥å£æœ‰äº†åˆæ­¥ç†è§£ï¼Œå¯¹ä¿¡å·çš„æ“ä½œäº†è§£äº†ä¸å°‘</li><li>fs å¯¹ log å±‚æœ‰äº†ä¸€äº›åˆæ­¥äº†è§£</li></ol><p>æ¥ä¸‹æ¥ä¸å‡†å¤‡çœ‹è¿™äº›é™„å¸¦çš„ paper äº†ï¼Œå‡†å¤‡å…ˆçœ‹å®Œ perfbookï¼Œæ„Ÿè§‰æ²¡ä»€ä¹ˆéšœç¢äº†ï¼Œä¹‹åä¼šå†å»çœ‹çœ‹ Linux ç›¸å…³çš„ä¹¦ï¼Œäº†è§£ä¸€äº›å…·ä½“çš„ç»†èŠ‚ã€‚</p><p>é™„ä¸Šè‡ªå·±çš„ä¸€ä¸ªäºŒæ¬¡å…ƒ podcast: <a href="https://www.xiaoyuzhoufm.com/episode/624b2ae7abceb019a955249b">https://www.xiaoyuzhoufm.com/episode/624b2ae7abceb019a955249b</a></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>bthread è°ƒåº¦çš„æœºåˆ¶</title>
      <link href="/2022/03/30/bthread-%E8%B0%83%E5%BA%A6%E7%9A%84%E6%9C%BA%E5%88%B6/"/>
      <url>/2022/03/30/bthread-%E8%B0%83%E5%BA%A6%E7%9A%84%E6%9C%BA%E5%88%B6/</url>
      
        <content type="html"><![CDATA[<p>bthread æ˜¯ä¸€ä¸ªç”¨æˆ·æ€çš„ <code>Fiber</code> åº“ï¼Œå®ƒçš„å…¥å£åœ¨ <code>incubator-brpc/src/bthread</code>ï¼Œå®ƒå¯¹å¤–æä¾›ä¸‹é¢ä¸€ç»„ API:</p><ul><li>ä»¥ä¸åŒä¼˜å…ˆçº§å’Œä¸åŒçš„è°ƒåº¦å‚æ•°åˆ›å»º bthread çº¿ç¨‹</li><li>æä¾›äº† rwlock, barrier, mutex, condvar ä¹‹ç±»çš„ bthread åŒæ­¥åŸè¯­</li><li>bthread local ç›¸å…³çš„é…ç½®</li></ul><p>æˆ‘ä»¬ä»¥ <code>bthread_start_background</code>ä¸ºä¾‹, è¿™é‡Œä»‹ç»ä¸€ä¸‹ bthread è°ƒåº¦ç›¸å…³çš„æœºåˆ¶ã€‚</p><h2 id="TaskControl-TaskGroup-å’Œ-Queue"><a href="#TaskControl-TaskGroup-å’Œ-Queue" class="headerlink" title="TaskControl, TaskGroup å’Œ Queue"></a>TaskControl, TaskGroup å’Œ Queue</h2><p><code>TaskControl</code> æ˜¯ä¸€ä¸ªå…¨å±€å”¯ä¸€çš„ä¸­å¿ƒæ§åˆ¶å™¨ï¼Œç”¨æ¥åš bthread ç›¸å…³çš„è°ƒåº¦ã€‚<code>TaskGroup</code> æ˜¯ç‰©ç†å·¥ä½œçº¿ç¨‹çš„è°ƒåº¦ä¸Šä¸‹æ–‡ã€‚ä»–ä»¬é€šè¿‡ Queue æ¥é€šä¿¡ã€‚</p><p>ä¸‹é¢æ˜¯ä¸€äº›å…¨å±€å…±æœ‰çš„ä¸Šä¸‹æ–‡ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">BAIDU_CASSERT</span>(<span class="built_in">sizeof</span>(TaskControl*) == <span class="built_in">sizeof</span>(butil::atomic&lt;TaskControl*&gt;), atomic_size_match);</span><br><span class="line"></span><br><span class="line"><span class="type">pthread_mutex_t</span> g_task_control_mutex = PTHREAD_MUTEX_INITIALIZER;</span><br><span class="line"><span class="comment">// Referenced in rpc, needs to be extern.</span></span><br><span class="line"><span class="comment">// Notice that we can&#x27;t declare the variable as atomic&lt;TaskControl*&gt; which</span></span><br><span class="line"><span class="comment">// are not constructed before main().</span></span><br><span class="line">TaskControl* g_task_control = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> BAIDU_THREAD_LOCAL TaskGroup* tls_task_group;</span><br><span class="line"><span class="function"><span class="keyword">extern</span> <span class="title">void</span> <span class="params">(*g_worker_startfn)</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬æ™šç‚¹çœ‹çœ‹ <code>TaskControl</code> çš„åˆ›å»ºï¼Œè¿™é‡Œç›´æ¥çœ‹ <code>bthread_start_background</code>:</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">bthread_start_background</span><span class="params">(<span class="type">bthread_t</span>* __restrict tid,</span></span></span><br><span class="line"><span class="params"><span class="function">                             <span class="type">const</span> <span class="type">bthread_attr_t</span>* __restrict attr,</span></span></span><br><span class="line"><span class="params"><span class="function">                             <span class="type">void</span> * (*fn)(<span class="type">void</span>*),</span></span></span><br><span class="line"><span class="params"><span class="function">                             <span class="type">void</span>* __restrict arg)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// æ‹¿åˆ° TaskGroup, è¿™ä¸ªå¯¹åº”çš„ thread æœ¬èº«æ˜¯ worker.</span></span><br><span class="line">  <span class="comment">// å¯èƒ½æ˜¯ bthread åˆ›å»ºå­çº¿ç¨‹.</span></span><br><span class="line">    bthread::TaskGroup* g = bthread::tls_task_group;</span><br><span class="line">    <span class="keyword">if</span> (g) &#123;</span><br><span class="line">        <span class="comment">// start from worker</span></span><br><span class="line">        <span class="keyword">return</span> g-&gt;<span class="built_in">start_background</span>&lt;<span class="literal">false</span>&gt;(tid, attr, fn, arg);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> bthread::<span class="built_in">start_from_non_worker</span>(tid, attr, fn, arg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å…ˆä» <code>start_from_non_worker</code> å¼€å§‹çœ‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä» non_worker å¼€å§‹è¿›è¡Œè°ƒåº¦, å¦‚æœè¿™é‡Œ attr æ ‡è®°äº† `no_signal`, é‡Œé¢ä¼šèµ°åˆ° REMOTE = true.</span></span><br><span class="line"><span class="function">BUTIL_FORCE_INLINE <span class="type">int</span></span></span><br><span class="line"><span class="function"><span class="title">start_from_non_worker</span><span class="params">(<span class="type">bthread_t</span>* __restrict tid,</span></span></span><br><span class="line"><span class="params"><span class="function">                      <span class="type">const</span> <span class="type">bthread_attr_t</span>* __restrict attr,</span></span></span><br><span class="line"><span class="params"><span class="function">                      <span class="type">void</span> * (*fn)(<span class="type">void</span>*),</span></span></span><br><span class="line"><span class="params"><span class="function">                      <span class="type">void</span>* __restrict arg)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// æ‹¿åˆ°å…¨å±€çš„ TaskControl.</span></span><br><span class="line">    TaskControl* c = <span class="built_in">get_or_new_task_control</span>();</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">NULL</span> == c) &#123;</span><br><span class="line">        <span class="keyword">return</span> ENOMEM;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (attr != <span class="literal">NULL</span> &amp;&amp; (attr-&gt;flags &amp; BTHREAD_NOSIGNAL)) &#123;</span><br><span class="line">        <span class="comment">// Remember the TaskGroup to insert NOSIGNAL tasks for 2 reasons:</span></span><br><span class="line">        <span class="comment">// 1. NOSIGNAL is often for creating many bthreads in batch,</span></span><br><span class="line">        <span class="comment">//    inserting into the same TaskGroup maximizes the batch.</span></span><br><span class="line">        <span class="comment">// 2. bthread_flush() needs to know which TaskGroup to flush.</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">// è¿™é‡Œç›¸å½“äºè®°å¿†åŒ–, å¦‚æœæ˜¯ no_signal ä¼šå€¾å‘äºä¸¢åˆ°ä¸€ä¸ª TaskGroup.</span></span><br><span class="line">        TaskGroup* g = tls_task_group_nosignal;</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">NULL</span> == g) &#123;</span><br><span class="line">            g = c-&gt;<span class="built_in">choose_one_group</span>();</span><br><span class="line">            tls_task_group_nosignal = g;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> g-&gt;<span class="built_in">start_background</span>&lt;<span class="literal">true</span>&gt;(tid, attr, fn, arg);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å¦åˆ™ä¼šé€‰ä¸­ä¸€ä¸ª TaskGroup å‘é€.</span></span><br><span class="line">    <span class="keyword">return</span> c-&gt;<span class="built_in">choose_one_group</span>()-&gt;<span class="built_in">start_background</span>&lt;<span class="literal">true</span>&gt;(</span><br><span class="line">        tid, attr, fn, arg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆæˆ‘ä»¬å†çœ‹çœ‹ <code>choose_one_group</code> æ˜¯ä»€ä¹ˆé€»è¾‘ï¼Œå“¦å°±æ˜¯ä¸ª random å•Šï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä½¿ç”¨ fastrand, éšæœºé€‰æ‹©ä¸€ä¸ª Group</span></span><br><span class="line"><span class="function">TaskGroup* <span class="title">TaskControl::choose_one_group</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="type">const</span> <span class="type">size_t</span> ngroup = _ngroup.<span class="built_in">load</span>(butil::memory_order_acquire);</span><br><span class="line">    <span class="keyword">if</span> (ngroup != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> _groups[butil::<span class="built_in">fast_rand_less_than</span>(ngroup)];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">CHECK</span>(<span class="literal">false</span>) &lt;&lt; <span class="string">&quot;Impossible: ngroup is 0&quot;</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥çœ‹çœ‹ <code>start_background</code>:</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è¿™é‡Œåˆ†æˆä¸¤éƒ¨åˆ†, ä¸€éƒ¨åˆ†ä»å¯¹è±¡æ± è·å–å¹¶åˆå§‹åŒ–ä¸€ä¸ª TaskMeta, ç„¶å dispatch ç»™</span></span><br><span class="line"><span class="comment">// ready_to_run ç³»åˆ—çš„å‡½æ•°å®é™…è¿è¡Œ.</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="type">bool</span> REMOTE&gt;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">TaskGroup::start_background</span><span class="params">(<span class="type">bthread_t</span>* __restrict th,</span></span></span><br><span class="line"><span class="params"><span class="function">                                <span class="type">const</span> <span class="type">bthread_attr_t</span>* __restrict attr,</span></span></span><br><span class="line"><span class="params"><span class="function">                                <span class="type">void</span> * (*fn)(<span class="type">void</span>*),</span></span></span><br><span class="line"><span class="params"><span class="function">                                <span class="type">void</span>* __restrict arg)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (__builtin_expect(!fn, <span class="number">0</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> EINVAL;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">const</span> <span class="type">int64_t</span> start_ns = butil::<span class="built_in">cpuwide_time_ns</span>();</span><br><span class="line">  <span class="comment">// å¼ºåˆ¶å¸¦ä¸€ä¸ª attr.</span></span><br><span class="line">    <span class="type">const</span> <span class="type">bthread_attr_t</span> using_attr = (attr ? *attr : BTHREAD_ATTR_NORMAL);</span><br><span class="line">    butil::ResourceId&lt;TaskMeta&gt; slot;</span><br><span class="line">    TaskMeta* m = butil::<span class="built_in">get_resource</span>(&amp;slot);</span><br><span class="line">    <span class="keyword">if</span> (__builtin_expect(!m, <span class="number">0</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> ENOMEM;</span><br><span class="line">    &#125;</span><br><span class="line"> <span class="comment">// åˆå§‹åŒ– bthread çš„çŠ¶æ€.</span></span><br><span class="line">    <span class="built_in">CHECK</span>(m-&gt;current_waiter.<span class="built_in">load</span>(butil::memory_order_relaxed) == <span class="literal">NULL</span>);</span><br><span class="line">    m-&gt;stop = <span class="literal">false</span>;</span><br><span class="line">    m-&gt;interrupted = <span class="literal">false</span>;</span><br><span class="line">    m-&gt;about_to_quit = <span class="literal">false</span>;</span><br><span class="line">    m-&gt;fn = fn;</span><br><span class="line">    m-&gt;arg = arg;</span><br><span class="line">    <span class="built_in">CHECK</span>(m-&gt;stack == <span class="literal">NULL</span>);</span><br><span class="line">    m-&gt;attr = using_attr;</span><br><span class="line">    m-&gt;local_storage = LOCAL_STORAGE_INIT;</span><br><span class="line">    m-&gt;cpuwide_start_ns = start_ns;</span><br><span class="line">    m-&gt;stat = EMPTY_STAT;</span><br><span class="line">    m-&gt;tid = <span class="built_in">make_tid</span>(*m-&gt;version_butex, slot);</span><br><span class="line">    *th = m-&gt;tid;</span><br><span class="line">    <span class="keyword">if</span> (using_attr.flags &amp; BTHREAD_LOG_START_AND_FINISH) &#123;</span><br><span class="line">        <span class="built_in">LOG</span>(INFO) &lt;&lt; <span class="string">&quot;Started bthread &quot;</span> &lt;&lt; m-&gt;tid;</span><br><span class="line">    &#125;</span><br><span class="line">    _control-&gt;_nbthreads &lt;&lt; <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (REMOTE) &#123;</span><br><span class="line">        <span class="built_in">ready_to_run_remote</span>(m-&gt;tid, (using_attr.flags &amp; BTHREAD_NOSIGNAL));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">ready_to_run</span>(m-&gt;tid, (using_attr.flags &amp; BTHREAD_NOSIGNAL));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åæ­£æ²¡æœ‰æ„é€ å‡½æ•°è¿˜æ˜¯è›®ä¸‘çš„ã€‚<code>REMOTE</code> è¡¨ç¤ºæ˜¯å¦è°ƒç”¨çš„å‡½æ•°è‡ªèº«ä¹Ÿè·‘åœ¨è¿™ä¸ª <code>TaskGroup</code> ä¸‹é¢</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å°è¯• push åˆ° rq ä¸­, å¦‚æœé˜Ÿåˆ—æ»¡äº†, è¯´æ˜åˆ›å»ºäº†å¤ªå¤šä»»åŠ¡, ä¼šéœ€è¦ sleep ä¸€ä¸‹.</span></span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">TaskGroup::push_rq</span><span class="params">(<span class="type">bthread_t</span> tid)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (!_rq.<span class="built_in">push</span>(tid)) &#123;</span><br><span class="line">        <span class="comment">// Created too many bthreads: a promising approach is to insert the</span></span><br><span class="line">        <span class="comment">// task into another TaskGroup, but we don&#x27;t use it because:</span></span><br><span class="line">        <span class="comment">// * There&#x27;re already many bthreads to run, inserting the bthread</span></span><br><span class="line">        <span class="comment">//   into other TaskGroup does not help.</span></span><br><span class="line">        <span class="comment">// * Insertions into other TaskGroups perform worse when all workers</span></span><br><span class="line">        <span class="comment">//   are busy at creating bthreads (proved by test_input_messenger in</span></span><br><span class="line">        <span class="comment">//   brpc)</span></span><br><span class="line">        <span class="built_in">flush_nosignal_tasks</span>();</span><br><span class="line">        <span class="built_in">LOG_EVERY_SECOND</span>(ERROR) &lt;&lt; <span class="string">&quot;_rq is full, capacity=&quot;</span> &lt;&lt; _rq.<span class="built_in">capacity</span>();</span><br><span class="line">        <span class="comment">// TODO(gejun): May cause deadlock when all workers are spinning here.</span></span><br><span class="line">        <span class="comment">// A better solution is to pop and run existing bthreads, however which</span></span><br><span class="line">        <span class="comment">// make set_remained()-callbacks do context switches and need extensive</span></span><br><span class="line">        <span class="comment">// reviews on related code.</span></span><br><span class="line">        ::<span class="built_in">usleep</span>(<span class="number">1000</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">TaskGroup::ready_to_run</span><span class="params">(<span class="type">bthread_t</span> tid, <span class="type">bool</span> nosignal)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">push_rq</span>(tid);</span><br><span class="line">    <span class="keyword">if</span> (nosignal) &#123;</span><br><span class="line">        ++_num_nosignal;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// signal åº”è¯¥æ˜¯ batch signal çš„.</span></span><br><span class="line">        <span class="type">const</span> <span class="type">int</span> additional_signal = _num_nosignal;</span><br><span class="line">        _num_nosignal = <span class="number">0</span>;</span><br><span class="line">        _nsignaled += <span class="number">1</span> + additional_signal;</span><br><span class="line">        _control-&gt;<span class="built_in">signal_task</span>(<span class="number">1</span> + additional_signal);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>_rq</code> æ˜¯ä¸€ä¸ª <code>WorkStealingQueue&lt;bthread_t&gt;</code>, è¿™ä¸ª queue æä¾›äº† <code>push</code> <code>pop</code> å’Œ <code>steal</code>, ç‰¹æ®Šçš„, <code>push</code> å’Œ <code>pop</code> ä¸å¯èƒ½å¹¶è¡Œ, ä½†æ˜¯å¯èƒ½æœ‰ä¸€å † <code>steal</code> åœ¨å’Œä»–ä»¬å¹¶è¡Œ.</p><p>è¿™é‡Œ <code>signal_task</code> ä¼šæ ¹æ®ä»»åŠ¡çš„æ•°é‡ï¼Œæ¥å¯¹ <code>ParkingLot</code> è°ƒç”¨å¯¹åº”çš„ signal, è¿™é‡Œä¼šèµ°åˆ° <code>futex</code> é‚£ä¸€å¥—ä¸Šï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">TaskControl::signal_task</span><span class="params">(<span class="type">int</span> num_task)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (num_task &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// TODO(gejun): Current algorithm does not guarantee enough threads will</span></span><br><span class="line">    <span class="comment">// be created to match caller&#x27;s requests. But in another side, there&#x27;s also</span></span><br><span class="line">    <span class="comment">// many useless signalings according to current impl. Capping the concurrency</span></span><br><span class="line">    <span class="comment">// is a good balance between performance and timeliness of scheduling.</span></span><br><span class="line">    <span class="keyword">if</span> (num_task &gt; <span class="number">2</span>) &#123;</span><br><span class="line">        num_task = <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// é€‰ä¸­ä¸€ä¸ª ParkingLot.</span></span><br><span class="line">    <span class="comment">// è¿™é‡Œè¦å¯»æ‰¾ 1-2 ä¸ª worker æ¥å”¤é†’.</span></span><br><span class="line">    <span class="type">int</span> start_index = butil::<span class="built_in">fmix64</span>(<span class="built_in">pthread_numeric_id</span>()) % PARKING_LOT_NUM;</span><br><span class="line">    num_task -= _pl[start_index].<span class="built_in">signal</span>(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (num_task &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">1</span>; i &lt; PARKING_LOT_NUM &amp;&amp; num_task &gt; <span class="number">0</span>; ++i) &#123;</span><br><span class="line">            <span class="keyword">if</span> (++start_index &gt;= PARKING_LOT_NUM) &#123;</span><br><span class="line">                start_index = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            num_task -= _pl[start_index].<span class="built_in">signal</span>(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è¿˜æœ‰ä»»åŠ¡(æ„Ÿè§‰æ¦‚ç‡å¾ˆå°), å¯èƒ½éœ€è¦åŠ¨æ€è°ƒåº¦ worker.</span></span><br><span class="line">    <span class="keyword">if</span> (num_task &gt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">        FLAGS_bthread_min_concurrency &gt; <span class="number">0</span> &amp;&amp;    <span class="comment">// test min_concurrency for performance</span></span><br><span class="line">        _concurrency.<span class="built_in">load</span>(butil::memory_order_relaxed) &lt; FLAGS_bthread_concurrency) &#123;</span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> Reduce this lock</span></span><br><span class="line">        <span class="built_in">BAIDU_SCOPED_LOCK</span>(g_task_control_mutex);</span><br><span class="line">        <span class="keyword">if</span> (_concurrency.<span class="built_in">load</span>(butil::memory_order_acquire) &lt; FLAGS_bthread_concurrency) &#123;</span><br><span class="line">            <span class="built_in">add_workers</span>(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¥½ï¼Œåå°è¿™å—å°±ä¸¢è¿›ä»»åŠ¡æ± å­å°±æ²¡äº‹äº†.</p><p>è¿™é‡Œå†æ³¨æ„ä¸€ä¸‹ <code>ready_to_run_remote</code>:</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">TaskGroup::ready_to_run_remote</span><span class="params">(<span class="type">bthread_t</span> tid, <span class="type">bool</span> nosignal)</span> </span>&#123;</span><br><span class="line">    _remote_rq._mutex.<span class="built_in">lock</span>();</span><br><span class="line">    <span class="keyword">while</span> (!_remote_rq.<span class="built_in">push_locked</span>(tid)) &#123;</span><br><span class="line">        <span class="built_in">flush_nosignal_tasks_remote_locked</span>(_remote_rq._mutex);</span><br><span class="line">        <span class="built_in">LOG_EVERY_SECOND</span>(ERROR) &lt;&lt; <span class="string">&quot;_remote_rq is full, capacity=&quot;</span></span><br><span class="line">                                &lt;&lt; _remote_rq.<span class="built_in">capacity</span>();</span><br><span class="line">        ::<span class="built_in">usleep</span>(<span class="number">1000</span>);</span><br><span class="line">        _remote_rq._mutex.<span class="built_in">lock</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (nosignal) &#123;</span><br><span class="line">        ++_remote_num_nosignal;</span><br><span class="line">        _remote_rq._mutex.<span class="built_in">unlock</span>();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="type">const</span> <span class="type">int</span> additional_signal = _remote_num_nosignal;</span><br><span class="line">        _remote_num_nosignal = <span class="number">0</span>;</span><br><span class="line">        _remote_nsignaled += <span class="number">1</span> + additional_signal;</span><br><span class="line">        _remote_rq._mutex.<span class="built_in">unlock</span>();</span><br><span class="line">        _control-&gt;<span class="built_in">signal_task</span>(<span class="number">1</span> + additional_signal);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä¼šå¡åˆ° <code>_remote_rq</code> ä¸­. é€»è¾‘å’Œä¹‹å‰ <code>_rq</code> å…¶å®å·®ä¸å¤šã€‚</p><h2 id="TaskGroup-æ˜¯æ€ä¹ˆè¿è¡Œ-bthread-çš„"><a href="#TaskGroup-æ˜¯æ€ä¹ˆè¿è¡Œ-bthread-çš„" class="headerlink" title="TaskGroup æ˜¯æ€ä¹ˆè¿è¡Œ bthread çš„"></a>TaskGroup æ˜¯æ€ä¹ˆè¿è¡Œ bthread çš„</h2><p>è¿˜è®°å¾—<code>TaskControl::signal_task</code> è°ƒç”¨äº† <code>add_workers</code> å—ï¼Œè¿™é‡Œå®é™…ä¸Šè·Ÿè¿›å»å°±æ˜¯ <code>TaskGroup</code> å…·ä½“çš„é€»è¾‘äº†ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">pthread_create</span>(&amp;_workers[i + old_concurency], <span class="literal">NULL</span>, worker_thread, <span class="keyword">this</span>);</span><br></pre></td></tr></table></figure><p>æ˜¾ç„¶ï¼Œæˆ‘ä»¬è¦çœ‹ <code>worker_thread</code> äº†ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span>* <span class="title">TaskControl::worker_thread</span><span class="params">(<span class="type">void</span>* arg)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">run_worker_startfn</span>();    </span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> BAIDU_INTERNAL</span></span><br><span class="line">    logging::ComlogInitializer comlog_initializer;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// é‡Œé¢æ‹¿åˆ°äº† task_control, ç„¶åä¼šåˆ›å»ºä¸€ä¸ª TaskGroup æŒ‚åœ¨ç‰©ç†çº¿ç¨‹ TLS ä¸‹.</span></span><br><span class="line">    TaskControl* c = <span class="built_in">static_cast</span>&lt;TaskControl*&gt;(arg);</span><br><span class="line">    TaskGroup* g = c-&gt;<span class="built_in">create_group</span>();</span><br><span class="line">    TaskStatistics stat;</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">NULL</span> == g) &#123;</span><br><span class="line">        <span class="built_in">LOG</span>(ERROR) &lt;&lt; <span class="string">&quot;Fail to create TaskGroup in pthread=&quot;</span> &lt;&lt; <span class="built_in">pthread_self</span>();</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    BT_VLOG &lt;&lt; <span class="string">&quot;Created worker=&quot;</span> &lt;&lt; <span class="built_in">pthread_self</span>()</span><br><span class="line">            &lt;&lt; <span class="string">&quot; bthread=&quot;</span> &lt;&lt; g-&gt;<span class="built_in">main_tid</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç»‘å®šç‰©ç†çº¿ç¨‹çš„ä»»åŠ¡</span></span><br><span class="line">    tls_task_group = g;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// nworkers ç»Ÿè®¡é‡å¢åŠ </span></span><br><span class="line">    c-&gt;_nworkers &lt;&lt; <span class="number">1</span>;</span><br><span class="line">    g-&gt;<span class="built_in">run_main_task</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é”€æ¯è‡ªèº«</span></span><br><span class="line"></span><br><span class="line">    stat = g-&gt;<span class="built_in">main_stat</span>();</span><br><span class="line">    BT_VLOG &lt;&lt; <span class="string">&quot;Destroying worker=&quot;</span> &lt;&lt; <span class="built_in">pthread_self</span>() &lt;&lt; <span class="string">&quot; bthread=&quot;</span></span><br><span class="line">            &lt;&lt; g-&gt;<span class="built_in">main_tid</span>() &lt;&lt; <span class="string">&quot; idle=&quot;</span> &lt;&lt; stat.cputime_ns / <span class="number">1000000.0</span></span><br><span class="line">            &lt;&lt; <span class="string">&quot;ms uptime=&quot;</span> &lt;&lt; g-&gt;<span class="built_in">current_uptime_ns</span>() / <span class="number">1000000.0</span> &lt;&lt; <span class="string">&quot;ms&quot;</span>;</span><br><span class="line">    tls_task_group = <span class="literal">NULL</span>;</span><br><span class="line">    g-&gt;<span class="built_in">destroy_self</span>();</span><br><span class="line">    c-&gt;_nworkers &lt;&lt; <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸‹é¢ <code>TaskGroup::run_main_task</code> äº†ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç‰©ç†çº¿ç¨‹çš„ä¸»è¦å¾ªç¯.</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">TaskGroup::run_main_task</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="function">bvar::PassiveStatus&lt;<span class="type">double</span>&gt; <span class="title">cumulated_cputime</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        get_cumulated_cputime_from_this, <span class="keyword">this</span>)</span></span>;</span><br><span class="line">    std::unique_ptr&lt;bvar::PerSecond&lt;bvar::PassiveStatus&lt;<span class="type">double</span>&gt; &gt; &gt; usage_bvar;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ‹¿åˆ°å¯¹åº”è‡ªèº«å¯¹åº”çš„ TaskGroup å¯¹è±¡, è¿™é‡Œä¸éœ€è¦æ“ä½œå®ƒ</span></span><br><span class="line">    TaskGroup* dummy = <span class="keyword">this</span>;</span><br><span class="line">    <span class="type">bthread_t</span> tid;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// wait_task ä¼šç­‰å¾…ä¸‹ä¸€ä¸ªä»»åŠ¡, å¦‚æœè¿”å›å€¼ä¸º 0, å°±é€€å‡º</span></span><br><span class="line">    <span class="keyword">while</span> (<span class="built_in">wait_task</span>(&amp;tid)) &#123;</span><br><span class="line">        <span class="comment">// è¿è¡Œå®Œä¸‹ä¸€ä¸ªä»»åŠ¡.</span></span><br><span class="line">        TaskGroup::<span class="built_in">sched_to</span>(&amp;dummy, tid);</span><br><span class="line">        <span class="built_in">DCHECK_EQ</span>(<span class="keyword">this</span>, dummy);</span><br><span class="line">        <span class="built_in">DCHECK_EQ</span>(_cur_meta-&gt;stack, _main_stack);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// sched_to åªæ˜¯è¿è¡Œå•ä¸ªä»»åŠ¡,</span></span><br><span class="line">        <span class="keyword">if</span> (_cur_meta-&gt;tid != _main_tid) &#123;</span><br><span class="line">            TaskGroup::<span class="built_in">task_runner</span>(<span class="number">1</span><span class="comment">/*skip remained*/</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// ä¸€äº›ç›¸å…³çš„é…ç½®, è®°å½• CPU-Time</span></span><br><span class="line">        <span class="keyword">if</span> (FLAGS_show_per_worker_usage_in_vars &amp;&amp; !usage_bvar) &#123;</span><br><span class="line">            <span class="type">char</span> name[<span class="number">32</span>];</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(OS_MACOSX)</span></span><br><span class="line">            <span class="built_in">snprintf</span>(name, <span class="built_in">sizeof</span>(name), <span class="string">&quot;bthread_worker_usage_%&quot;</span> PRIu64,</span><br><span class="line">                     <span class="built_in">pthread_numeric_id</span>());</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">            <span class="built_in">snprintf</span>(name, <span class="built_in">sizeof</span>(name), <span class="string">&quot;bthread_worker_usage_%ld&quot;</span>,</span><br><span class="line">                     (<span class="type">long</span>)<span class="built_in">syscall</span>(SYS_gettid));</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">            usage_bvar.<span class="built_in">reset</span>(<span class="keyword">new</span> bvar::PerSecond&lt;bvar::PassiveStatus&lt;<span class="type">double</span>&gt; &gt;</span><br><span class="line">                             (name, &amp;cumulated_cputime, <span class="number">1</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Don&#x27;t forget to add elapse of last wait_task.</span></span><br><span class="line">    <span class="built_in">current_task</span>()-&gt;stat.cputime_ns += butil::<span class="built_in">cpuwide_time_ns</span>() - _last_run_ns;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæœ‰å‡ ä¸ªå…³é”®ç‚¹ï¼š</p><ol><li><code>wait_task</code></li><li><code>TaskGroup::sched_to</code></li><li><code>TaskGroup::task_runner</code></li></ol><p>ç¬¬ä¸€ä¸ª <code>wait_task</code> å¯ä»¥å’Œä¹‹å‰çš„è”åŠ¨ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">TaskGroup::wait_task</span><span class="params">(<span class="type">bthread_t</span>* tid)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> BTHREAD_DONT_SAVE_PARKING_STATE</span></span><br><span class="line">        <span class="comment">// å¦‚æœ stop äº†, å°±æ¶¦èµ°.</span></span><br><span class="line">        <span class="keyword">if</span> (_last_pl_state.<span class="built_in">stopped</span>()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// ç­‰å¾…æœ‰ä»»åŠ¡, éœ€è¦ signal ç­‰æ–¹å¼æ¥è°ƒç”¨.</span></span><br><span class="line">        _pl-&gt;<span class="built_in">wait</span>(_last_pl_state);</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">steal_task</span>(tid)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">        <span class="type">const</span> ParkingLot::State st = _pl-&gt;<span class="built_in">get_state</span>();</span><br><span class="line">        <span class="keyword">if</span> (st.<span class="built_in">stopped</span>()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">steal_task</span>(tid)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        _pl-&gt;<span class="built_in">wait</span>(st);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    &#125; <span class="keyword">while</span> (<span class="literal">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä» remote_rq ä¸­ steal ä»»åŠ¡.</span></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">steal_task</span><span class="params">(<span class="type">bthread_t</span>* tid)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (_remote_rq.<span class="built_in">pop</span>(tid)) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> BTHREAD_DONT_SAVE_PARKING_STATE</span></span><br><span class="line">  _last_pl_state = _pl-&gt;<span class="built_in">get_state</span>();</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">  <span class="keyword">return</span> _control-&gt;<span class="built_in">steal_task</span>(tid, &amp;_steal_seed, _steal_offset);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è€Œ <code>TaskControl::steal_task</code> ä¼šåˆ†åˆ«ä» <code>_rq</code> å’Œ <code>_remote_rq</code> æ‹¿ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">TaskControl::steal_task</span><span class="params">(<span class="type">bthread_t</span>* tid, <span class="type">size_t</span>* seed, <span class="type">size_t</span> offset)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 1: Acquiring fence is paired with releasing fence in _add_group to</span></span><br><span class="line">    <span class="comment">// avoid accessing uninitialized slot of _groups.</span></span><br><span class="line">    <span class="type">const</span> <span class="type">size_t</span> ngroup = _ngroup.<span class="built_in">load</span>(butil::memory_order_acquire<span class="comment">/*1*/</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0</span> == ngroup) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// <span class="doctag">NOTE:</span> Don&#x27;t return inside `for&#x27; iteration since we need to update |seed|</span></span><br><span class="line">    <span class="type">bool</span> stolen = <span class="literal">false</span>;</span><br><span class="line">    <span class="type">size_t</span> s = *seed;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; ngroup; ++i, s += offset) &#123;</span><br><span class="line">        TaskGroup* g = _groups[s % ngroup];</span><br><span class="line">        <span class="comment">// g is possibly NULL because of concurrent _destroy_group</span></span><br><span class="line">        <span class="keyword">if</span> (g) &#123;</span><br><span class="line">            <span class="keyword">if</span> (g-&gt;_rq.<span class="built_in">steal</span>(tid)) &#123;</span><br><span class="line">                stolen = <span class="literal">true</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (g-&gt;_remote_rq.<span class="built_in">pop</span>(tid)) &#123;</span><br><span class="line">                stolen = <span class="literal">true</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    *seed = s;</span><br><span class="line">    <span class="keyword">return</span> stolen;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="sched-to"><a href="#sched-to" class="headerlink" title="sched_to"></a>sched_to</h3><p>è¿™æ˜¯æœ€é‡è¦çš„å‡½æ•°äº†ï¼Œæ¶‰åŠäº†å…·ä½“ Fiber çš„è¿è¡Œã€åˆ‡æ ˆ</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">TaskGroup::sched_to</span><span class="params">(TaskGroup** pg, <span class="type">bthread_t</span> next_tid)</span> </span>&#123;</span><br><span class="line">    TaskMeta* next_meta = <span class="built_in">address_meta</span>(next_tid);</span><br><span class="line">    <span class="keyword">if</span> (next_meta-&gt;stack == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        ContextualStack* stk = <span class="built_in">get_stack</span>(next_meta-&gt;<span class="built_in">stack_type</span>(), task_runner);</span><br><span class="line">        <span class="keyword">if</span> (stk) &#123;</span><br><span class="line">            next_meta-&gt;<span class="built_in">set_stack</span>(stk);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// stack_type is BTHREAD_STACKTYPE_PTHREAD or out of memory,</span></span><br><span class="line">            <span class="comment">// In latter case, attr is forced to be BTHREAD_STACKTYPE_PTHREAD.</span></span><br><span class="line">            <span class="comment">// This basically means that if we can&#x27;t allocate stack, run</span></span><br><span class="line">            <span class="comment">// the task in pthread directly.</span></span><br><span class="line">            next_meta-&gt;attr.stack_type = BTHREAD_STACKTYPE_PTHREAD;</span><br><span class="line">            next_meta-&gt;<span class="built_in">set_stack</span>((*pg)-&gt;_main_stack);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Update now_ns only when wait_task did yield.</span></span><br><span class="line">    <span class="built_in">sched_to</span>(pg, next_meta);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>get_stack</code> ä¼šæ‹¿åˆ°ä¸€ä¸ªæ ˆï¼Œè¿™é‡Œè¿˜æ˜¯ç”±å¯¹è±¡æ± ç”³è¯·çš„å®šé•¿å¯¹è±¡ã€‚è¿™é‡Œ <code>task_runner</code> å‡½æ•°è´Ÿè´£å…·ä½“è¿è¡Œã€‚</p><p>è¿™é‡Œéœ€è¦ç€é‡çœ‹ä¸€ä¸‹ <code>bthread_make_fcontext</code>:</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">StackStorage</span> &#123;</span><br><span class="line">     <span class="type">int</span> stacksize;</span><br><span class="line">     <span class="type">int</span> guardsize;</span><br><span class="line">    <span class="comment">// Assume stack grows upwards.</span></span><br><span class="line">    <span class="comment">// http://www.boost.org/doc/libs/1_55_0/libs/context/doc/html/context/stack.html</span></span><br><span class="line">    <span class="type">void</span>* bottom;</span><br><span class="line">    <span class="type">unsigned</span> valgrind_stack_id;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Clears all members.</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">zeroize</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        stacksize = <span class="number">0</span>;</span><br><span class="line">        guardsize = <span class="number">0</span>;</span><br><span class="line">        bottom = <span class="literal">NULL</span>;</span><br><span class="line">        valgrind_stack_id = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// Allocate a piece of stack.</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">allocate_stack_storage</span><span class="params">(StackStorage* s, <span class="type">int</span> stacksize, <span class="type">int</span> guardsize)</span></span>;</span><br><span class="line"><span class="comment">// Deallocate a piece of stack. Parameters MUST be returned or set by the</span></span><br><span class="line"><span class="comment">// corresponding allocate_stack_storage() otherwise behavior is undefined.</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">deallocate_stack_storage</span><span class="params">(StackStorage* s)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">enum</span> <span class="title class_">StackType</span> &#123;</span><br><span class="line">    STACK_TYPE_MAIN = <span class="number">0</span>,</span><br><span class="line">    STACK_TYPE_PTHREAD = BTHREAD_STACKTYPE_PTHREAD,</span><br><span class="line">    STACK_TYPE_SMALL = BTHREAD_STACKTYPE_SMALL,</span><br><span class="line">    STACK_TYPE_NORMAL = BTHREAD_STACKTYPE_NORMAL,</span><br><span class="line">    STACK_TYPE_LARGE = BTHREAD_STACKTYPE_LARGE</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">ContextualStack</span> &#123;</span><br><span class="line">    <span class="type">bthread_fcontext_t</span> context;</span><br><span class="line">    StackType stacktype;</span><br><span class="line">    StackStorage storage;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> StackClass&gt; <span class="keyword">struct</span> <span class="title class_">StackFactory</span> &#123;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">Wrapper</span> : <span class="keyword">public</span> ContextualStack &#123;</span><br><span class="line">        <span class="function"><span class="keyword">explicit</span> <span class="title">Wrapper</span><span class="params">(<span class="type">void</span> (*entry)(<span class="type">intptr_t</span>))</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">allocate_stack_storage</span>(&amp;storage, *StackClass::stack_size_flag,</span><br><span class="line">                                       FLAGS_guard_page_size) != <span class="number">0</span>) &#123;</span><br><span class="line">                storage.<span class="built_in">zeroize</span>();</span><br><span class="line">                context = <span class="literal">NULL</span>;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// åˆ›å»ºä¸€ä¸ªå¸¦æœ‰ entry çš„ fcontext, åˆ°æ—¶å€™ä¼šå›é€€.</span></span><br><span class="line">            context = <span class="built_in">bthread_make_fcontext</span>(storage.bottom, storage.stacksize, entry);</span><br><span class="line">            stacktype = (StackType)StackClass::stacktype;</span><br><span class="line">        &#125;</span><br><span class="line">        ~<span class="built_in">Wrapper</span>() &#123;</span><br><span class="line">            <span class="keyword">if</span> (context) &#123;</span><br><span class="line">                context = <span class="literal">NULL</span>;</span><br><span class="line">                <span class="built_in">deallocate_stack_storage</span>(&amp;storage);</span><br><span class="line">                storage.<span class="built_in">zeroize</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="type">static</span> ContextualStack* <span class="title">get_stack</span><span class="params">(<span class="type">void</span> (*entry)(<span class="type">intptr_t</span>))</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> butil::<span class="built_in">get_object</span>&lt;Wrapper&gt;(entry);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">return_stack</span><span class="params">(ContextualStack* sc)</span> </span>&#123;</span><br><span class="line">        butil::<span class="built_in">return_object</span>(<span class="built_in">static_cast</span>&lt;Wrapper*&gt;(sc));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>è¯è¯´å›æ¥ï¼Œä¹‹å‰å†™ xv6 lab çš„æ—¶å€™è¸©è¿‡ä¸€ä¸ªæ ˆå¢é•¿çš„å‘ï¼Œx86 æ ˆæ˜¯è‡ªä¸Šè€Œä¸‹å¢é•¿çš„ï¼Œæ ˆçš„ bottom åœ¨ä¸€ä¸ªé«˜åœ°å€ï¼Œæ‰€ä»¥ <code>allocate_stack_storage</code> æ³¨æ„ä¸€ä¸‹è¿™ä¸ª <code>bottom</code> æ˜¯ <code>malloc() + STACK_SIZE</code>.</p><p><code>bthread_make_fcontext</code> åŸºæœ¬ä¸Šæ˜¯ä» <code>boost::Context</code> å·æ¥çš„ï¼Œæˆ‘ä»¬è¿™ç›´æ¥çœ‹çœ‹ boost çš„ RISC-V ä»£ç ï¼š<a href="https://github.com/boostorg/context/blob/develop/src/asm/make_riscv64_sysv_elf_gas.S">https://github.com/boostorg/context/blob/develop/src/asm/make_riscv64_sysv_elf_gas.S</a></p><p>è¿™é‡Œæœ‰ä¸¤ä¸ªè¦æ³¨æ„çš„åœ°æ–¹ï¼š</p><ol><li>åªä¿å­˜äº† callee-saved çš„å¯„å­˜å™¨ï¼Œå› ä¸º caller saved æˆ‘ä»¬ä¹‹åä¼šçœ‹åˆ°</li><li><code>ra</code> è®¾ç½®æˆäº† <code>_exit</code>ï¼Œè¿™ä¸ªæ˜¯åšä¸€ä¸ªå…œåº•ï¼Œå¦‚æœ <code>fiber</code> ç»“å°¾ä¸è°ƒåº¦ç»™åˆ«çš„ fiber æˆ–è€…è¿”å› main, è¿™é‡Œå°±ä¼šç›´æ¥ exit.</li></ol><p>æˆ‘ä»¬å’Œ <code>task_runner</code> è”åŠ¨çœ‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å®é™…è¿è¡Œ task åœ¨ task_runner å†…, TaskMeta ä»»åŠ¡æ‰§è¡Œçš„æ—¶å€™ä¹Ÿä¼šåŒ…è£…è¿™ä¹ˆä¸€å±‚.</span></span><br><span class="line"><span class="comment">// å®ƒæœ‰ä¸¤ä¸ªè°ƒç”¨æº: bthread çš„æ ˆé‡Œè°ƒç”¨, TaskGroup åœ¨ run_main_task é‡Œè°ƒç”¨.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// m-&gt;fn çš„å‡½æ•°å¯èƒ½ä¼šè°ƒ èµ· bthread çš„ä»»åŠ¡ã€bthread_usleep.</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">TaskGroup::task_runner</span><span class="params">(<span class="type">intptr_t</span> skip_remained)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// <span class="doctag">NOTE:</span> tls_task_group is volatile since tasks are moved around</span></span><br><span class="line">    <span class="comment">//       different groups.</span></span><br><span class="line">    TaskGroup* g = tls_task_group;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!skip_remained) &#123;</span><br><span class="line">        <span class="keyword">while</span> (g-&gt;_last_context_remained) &#123;</span><br><span class="line">            RemainedFn fn = g-&gt;_last_context_remained;</span><br><span class="line">            g-&gt;_last_context_remained = <span class="literal">NULL</span>;</span><br><span class="line">            <span class="built_in">fn</span>(g-&gt;_last_context_remained_arg);</span><br><span class="line">            g = tls_task_group;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> NDEBUG</span></span><br><span class="line">        --g-&gt;_sched_recursive_guard;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="comment">// A task can be stopped before it gets running, in which case</span></span><br><span class="line">        <span class="comment">// we may skip user function, but that may confuse user:</span></span><br><span class="line">        <span class="comment">// Most tasks have variables to remember running result of the task,</span></span><br><span class="line">        <span class="comment">// which is often initialized to values indicating success. If an</span></span><br><span class="line">        <span class="comment">// user function is never called, the variables will be unchanged</span></span><br><span class="line">        <span class="comment">// however they&#x27;d better reflect failures because the task is stopped</span></span><br><span class="line">        <span class="comment">// abnormally.</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Meta and identifier of the task is persistent in this run.</span></span><br><span class="line">        TaskMeta* <span class="type">const</span> m = g-&gt;_cur_meta;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (FLAGS_show_bthread_creation_in_vars) &#123;</span><br><span class="line">            <span class="comment">// <span class="doctag">NOTE:</span> the thread triggering exposure of pending time may spend</span></span><br><span class="line">            <span class="comment">// considerable time because a single bvar::LatencyRecorder</span></span><br><span class="line">            <span class="comment">// contains many bvar.</span></span><br><span class="line">            g-&gt;_control-&gt;<span class="built_in">exposed_pending_time</span>() &lt;&lt;</span><br><span class="line">                (butil::<span class="built_in">cpuwide_time_ns</span>() - m-&gt;cpuwide_start_ns) / <span class="number">1000L</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Not catch exceptions except ExitException which is for implementing</span></span><br><span class="line">        <span class="comment">// bthread_exit(). User code is intended to crash when an exception is</span></span><br><span class="line">        <span class="comment">// not caught explicitly. This is consistent with other threading</span></span><br><span class="line">        <span class="comment">// libraries.</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// ç›®å‰è¿™é‡Œåº”è¯¥éƒ½æ˜¯ 0, å˜»å˜».</span></span><br><span class="line">        <span class="type">void</span>* thread_return;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è¿è¡Œ m-&gt;fn().</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            thread_return = m-&gt;<span class="built_in">fn</span>(m-&gt;arg);</span><br><span class="line">        &#125; <span class="built_in">catch</span> (ExitException&amp; e) &#123;</span><br><span class="line">            thread_return = e.<span class="built_in">value</span>();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Group is probably changed</span></span><br><span class="line">        g = tls_task_group;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> Save thread_return</span></span><br><span class="line">        (<span class="type">void</span>)thread_return;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Logging must be done before returning the keytable, since the logging lib</span></span><br><span class="line">        <span class="comment">// use bthread local storage internally, or will cause memory leak.</span></span><br><span class="line">        <span class="comment">// <span class="doctag">FIXME:</span> the time from quiting fn to here is not counted into cputime</span></span><br><span class="line">        <span class="keyword">if</span> (m-&gt;attr.flags &amp; BTHREAD_LOG_START_AND_FINISH) &#123;</span><br><span class="line">            <span class="built_in">LOG</span>(INFO) &lt;&lt; <span class="string">&quot;Finished bthread &quot;</span> &lt;&lt; m-&gt;tid &lt;&lt; <span class="string">&quot;, cputime=&quot;</span></span><br><span class="line">                      &lt;&lt; m-&gt;stat.cputime_ns / <span class="number">1000000.0</span> &lt;&lt; <span class="string">&quot;ms&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Clean tls variables, must be done before changing version_butex</span></span><br><span class="line">        <span class="comment">// otherwise another thread just joined this thread may not see side</span></span><br><span class="line">        <span class="comment">// effects of destructing tls variables.</span></span><br><span class="line">        KeyTable* kt = tls_bls.keytable;</span><br><span class="line">        <span class="keyword">if</span> (kt != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="built_in">return_keytable</span>(m-&gt;attr.keytable_pool, kt);</span><br><span class="line">            <span class="comment">// After deletion: tls may be set during deletion.</span></span><br><span class="line">            tls_bls.keytable = <span class="literal">NULL</span>;</span><br><span class="line">            m-&gt;local_storage.keytable = <span class="literal">NULL</span>; <span class="comment">// optional</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Increase the version and wake up all joiners, if resulting version</span></span><br><span class="line">        <span class="comment">// is 0, change it to 1 to make bthread_t never be 0. Any access</span></span><br><span class="line">        <span class="comment">// or join to the bthread after changing version will be rejected.</span></span><br><span class="line">        <span class="comment">// The spinlock is for visibility of TaskGroup::get_attr.</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">BAIDU_SCOPED_LOCK</span>(m-&gt;version_lock);</span><br><span class="line">            <span class="keyword">if</span> (<span class="number">0</span> == ++*m-&gt;version_butex) &#123;</span><br><span class="line">                ++*m-&gt;version_butex;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">butex_wake_except</span>(m-&gt;version_butex, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        g-&gt;_control-&gt;_nbthreads &lt;&lt; <span class="number">-1</span>;</span><br><span class="line">        <span class="comment">// è¿™ä¸ªè®¾ç½®ä¸€ä¸ªå›æ”¶æ‰ m çš„ callback.</span></span><br><span class="line">        g-&gt;<span class="built_in">set_remained</span>(TaskGroup::_release_last_context, m);</span><br><span class="line">        <span class="comment">// task_group å®Œæˆä¸€æ¬¡è°ƒåº¦.</span></span><br><span class="line">        <span class="built_in">ending_sched</span>(&amp;g);</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">while</span> (g-&gt;_cur_meta-&gt;tid != g-&gt;_main_tid);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Was called from a pthread and we don&#x27;t have BTHREAD_STACKTYPE_PTHREAD</span></span><br><span class="line">    <span class="comment">// tasks to run, quit for more tasks.</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå‡½æ•°æ˜¯æ•´ä¸ª bthread è°ƒåº¦çš„æ ¸ä¸­æ ¸ï¼Œæˆ‘ä»¬ç†ä¸€ä¸‹ï¼š</p><ol><li>æ‹¿åˆ°ç°æœ‰ <code>TaskGroup</code> ï¼Œå³ç°æœ‰ worker </li><li>æ‰§è¡Œ <code>_last_context_remained</code>ï¼Œæ¸…ç†æ‰ <code>TaskGroup</code> ä¸Šä¸€æ¬¡æ‰§è¡Œå¯¹åº”çš„èµ„æº</li><li>åœ¨å¾ªç¯ä¸­ï¼Œæ‹¿åˆ° bthread æ ˆå¯¹åº”çš„ metaï¼Œè¿™æ˜¯éœ€è¦æ‰§è¡Œçš„å¯¹è±¡</li><li>è¿è¡Œ <code>m-&gt;fn()</code>ï¼Œè¿™é‡Œæ˜¯çœŸæ­£çš„é€»è¾‘<ol><li>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ<code>m-&gt;fn()</code> è¿è¡Œçš„æ—¶å€™ï¼Œå¯èƒ½å‘ç”Ÿä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œæ¯”å¦‚ <code>m-&gt;fn()</code> é‡Œé¢è°ƒç”¨äº† <code>bthread_usleep</code>.</li></ol></li><li>æ¸…ç†ä¸Šä¸‹æ–‡</li><li>è°ƒç”¨ <code>ending_sched</code></li></ol><p><code>(3)</code> è¿™å°±æ˜¯ç”¨æˆ·ç»™ <code>bthread_start_background</code> ä»»åŠ¡å…·ä½“è¢«æ‰§è¡Œçš„ point äº†ï¼</p><h4 id="sched-to-å…·ä½“é€»è¾‘"><a href="#sched-to-å…·ä½“é€»è¾‘" class="headerlink" title="sched_to å…·ä½“é€»è¾‘"></a>sched_to å…·ä½“é€»è¾‘</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">TaskGroup::sched_to</span><span class="params">(TaskGroup** pg, TaskMeta* next_meta)</span> </span>&#123;</span><br><span class="line">    TaskGroup* g = *pg;</span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> NDEBUG</span></span><br><span class="line">    <span class="keyword">if</span> ((++g-&gt;_sched_recursive_guard) &gt; <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="built_in">LOG</span>(FATAL) &lt;&lt; <span class="string">&quot;Recursively(&quot;</span> &lt;&lt; g-&gt;_sched_recursive_guard - <span class="number">1</span></span><br><span class="line">                   &lt;&lt; <span class="string">&quot;) call sched_to(&quot;</span> &lt;&lt; g &lt;&lt; <span class="string">&quot;)&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    <span class="comment">// Save errno so that errno is bthread-specific.</span></span><br><span class="line">    <span class="type">const</span> <span class="type">int</span> saved_errno = errno;</span><br><span class="line">    <span class="type">void</span>* saved_unique_user_ptr = tls_unique_user_ptr;</span><br><span class="line"></span><br><span class="line">    TaskMeta* <span class="type">const</span> cur_meta = g-&gt;_cur_meta;</span><br><span class="line">    <span class="type">const</span> <span class="type">int64_t</span> now = butil::<span class="built_in">cpuwide_time_ns</span>();</span><br><span class="line">    <span class="type">const</span> <span class="type">int64_t</span> elp_ns = now - g-&gt;_last_run_ns;</span><br><span class="line">    g-&gt;_last_run_ns = now;</span><br><span class="line">    cur_meta-&gt;stat.cputime_ns += elp_ns;</span><br><span class="line">    <span class="keyword">if</span> (cur_meta-&gt;tid != g-&gt;<span class="built_in">main_tid</span>()) &#123;</span><br><span class="line">        g-&gt;_cumulated_cputime_ns += elp_ns;</span><br><span class="line">    &#125;</span><br><span class="line">    ++cur_meta-&gt;stat.nswitch;</span><br><span class="line">    ++ g-&gt;_nswitch;</span><br><span class="line">    <span class="comment">// Switch to the task</span></span><br><span class="line">    <span class="keyword">if</span> (__builtin_expect(next_meta != cur_meta, <span class="number">1</span>)) &#123;</span><br><span class="line">        <span class="comment">// è¿™é‡ŒæŠŠ _cur_meta è®¾ç½®æˆè¦æ‰§è¡Œçš„ cur_meta.</span></span><br><span class="line">        g-&gt;_cur_meta = next_meta;</span><br><span class="line">        <span class="comment">// Switch tls_bls</span></span><br><span class="line">        cur_meta-&gt;local_storage = tls_bls;</span><br><span class="line">        tls_bls = next_meta-&gt;local_storage;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Logging must be done after switching the local storage, since the logging lib</span></span><br><span class="line">        <span class="comment">// use bthread local storage internally, or will cause memory leak.</span></span><br><span class="line">        <span class="keyword">if</span> ((cur_meta-&gt;attr.flags &amp; BTHREAD_LOG_CONTEXT_SWITCH) ||</span><br><span class="line">            (next_meta-&gt;attr.flags &amp; BTHREAD_LOG_CONTEXT_SWITCH)) &#123;</span><br><span class="line">            <span class="built_in">LOG</span>(INFO) &lt;&lt; <span class="string">&quot;Switch bthread: &quot;</span> &lt;&lt; cur_meta-&gt;tid &lt;&lt; <span class="string">&quot; -&gt; &quot;</span></span><br><span class="line">                      &lt;&lt; next_meta-&gt;tid;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (cur_meta-&gt;stack != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (next_meta-&gt;stack != cur_meta-&gt;stack) &#123;</span><br><span class="line">                <span class="built_in">jump_stack</span>(cur_meta-&gt;stack, next_meta-&gt;stack);</span><br><span class="line">                <span class="comment">// probably went to another group, need to assign g again.</span></span><br><span class="line">                g = tls_task_group;</span><br><span class="line">            &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> NDEBUG</span></span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// else pthread_task is switching to another pthread_task, sc</span></span><br><span class="line">                <span class="comment">// can only equal when they&#x27;re both _main_stack</span></span><br><span class="line">                <span class="built_in">CHECK</span>(cur_meta-&gt;stack == g-&gt;_main_stack);</span><br><span class="line">            &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// else because of ending_sched(including pthread_task-&gt;pthread_task)</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">LOG</span>(FATAL) &lt;&lt; <span class="string">&quot;bthread=&quot;</span> &lt;&lt; g-&gt;<span class="built_in">current_tid</span>() &lt;&lt; <span class="string">&quot; sched_to itself!&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (g-&gt;_last_context_remained) &#123;</span><br><span class="line">        RemainedFn fn = g-&gt;_last_context_remained;</span><br><span class="line">        g-&gt;_last_context_remained = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="built_in">fn</span>(g-&gt;_last_context_remained_arg);</span><br><span class="line">        g = tls_task_group;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Restore errno</span></span><br><span class="line">    errno = saved_errno;</span><br><span class="line">    tls_unique_user_ptr = saved_unique_user_ptr;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> NDEBUG</span></span><br><span class="line">    --g-&gt;_sched_recursive_guard;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    *pg = g;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ <code>sched_to</code> ä¸­ï¼Œæˆ‘ä»¬è¦å…ˆç†è§£ <code>jump_stack</code> æ‰èƒ½ç†è§£ <code>sched_to</code>, <code>jump_stack</code> ä¹Ÿæ˜¯ <code>boost::Context</code> æŠ„æ¥çš„ï¼š<a href="https://github.com/boostorg/context/blob/develop/src/asm/jump_riscv64_sysv_elf_gas.S">https://github.com/boostorg/context/blob/develop/src/asm/jump_riscv64_sysv_elf_gas.S</a></p><ol><li>ä¿å­˜æ‰€æœ‰ callee-saved registers</li><li>æŠŠ ra è®¾ç½®æˆéœ€è¦ jump åˆ°çš„ç›®æ ‡</li><li>æ¢å¤æ‰€æœ‰æ–°çš„ called-saved registers</li></ol><p>é‚£ä¹ˆï¼Œæˆ‘ä»¬å‡è®¾æœ‰å¤šä¸ª <code>bthread</code>,  <code>TaskGroup</code> çš„ worker è°ƒç”¨äº† <code>sched_to</code>, ç„¶åç³»ç»Ÿä¼šæŒ‘é€‰ç¬¬ä¸€ä¸ª bthread æ¥æ‰§è¡Œã€‚å‡è®¾æ‰§è¡Œå®Œäº†ï¼Œè¿™é‡Œåˆå›å›åˆ°è¿™ä¸ªè°ƒåº¦ç‚¹ã€‚åŒæ—¶ï¼Œ<code>TaskGroup::sched_to</code> è¿™ä¸ªå‡½æ•°åœ¨ <code>jump_stack</code> å‰åå¯èƒ½è¢«ä¸åŒçš„çº¿ç¨‹æ‰§è¡Œï¼</p><p>çŸ¥é“è¿™ä¸ªï¼Œå†çœ‹ä¸€äº›ä¸Šä¸‹æ–‡ä»£ç å°±ä¼šæ¸…æ™°å¾ˆå¤šäº†ã€‚</p><h3 id="ending-sched"><a href="#ending-sched" class="headerlink" title="ending_sched"></a>ending_sched</h3><p>bthread è°ƒåº¦çš„æ—¶å€™ï¼Œå®é™…ä¸Šå¦‚æœ <code>task_runner</code> åœ¨ bthread ä¸­è°ƒç”¨ï¼Œé‚£ä¹ˆå®ƒä¸ä¼šé€€å‡ºï¼Œåªä¼šéšç€ <code>ending_sched</code> åˆ‡åˆ°åˆ«çš„ä¸Šä¸‹æ–‡ã€‚<code>ending_sched</code> åœ¨è¿™é‡Œåšäº† bthread çš„è°ƒåº¦å’Œå›æ”¶å·¥ä½œã€‚å¯èƒ½åœ¨ <code>ending_sched</code> ç»“æŸåï¼Œbthread å°±è¿è¡Œä¸€ä¸ªæ–°çš„æ ˆäº†ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä¸€ä¸ªè°ƒåº¦å®Œæˆäº†, å°è¯•è°ƒåº¦è¿è¡Œåˆ°ä¸‹ä¸€ç»„ task.</span></span><br><span class="line"><span class="comment">// è¿™é‡Œé€šè¿‡ TaskGroup::task_runner æ¥åŒ…è£…äº†ä¸€å±‚ Task, å®ƒå¯èƒ½åˆåœ¨ task_runner è¢«è°ƒç”¨.</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">TaskGroup::ending_sched</span><span class="params">(TaskGroup** pg)</span> </span>&#123;</span><br><span class="line">    TaskGroup* g = *pg;</span><br><span class="line">    <span class="type">bthread_t</span> next_tid = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// Find next task to run, if none, switch to idle thread of the group.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//    BTHREAD_FAIR_WSQ ä¼šæœ‰å¸®åŠ©å—?</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> BTHREAD_FAIR_WSQ</span></span><br><span class="line">    <span class="comment">// When BTHREAD_FAIR_WSQ is defined, profiling shows that cpu cost of</span></span><br><span class="line">    <span class="comment">// WSQ::steal() in example/multi_threaded_echo_c++ changes from 1.9%</span></span><br><span class="line">    <span class="comment">// to 2.9%</span></span><br><span class="line">    <span class="type">const</span> <span class="type">bool</span> popped = g-&gt;_rq.<span class="built_in">pop</span>(&amp;next_tid);</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">    <span class="type">const</span> <span class="type">bool</span> popped = g-&gt;_rq.<span class="built_in">steal</span>(&amp;next_tid);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç®€å•æ§åˆ¶ä¸€ä¸‹, å¦‚æœ rq æ²¡æœ‰, remote ä¹Ÿæ²¡æœ‰, æ‰ä¼šè®¾ç½®æˆ main_tid.</span></span><br><span class="line">    <span class="comment">// è¿™å°±è¦ç­‰å¾…å”¤é†’äº†.</span></span><br><span class="line">    <span class="keyword">if</span> (!popped &amp;&amp; !g-&gt;<span class="built_in">steal_task</span>(&amp;next_tid)) &#123;</span><br><span class="line">        <span class="comment">// Jump to main task if there&#x27;s no task to run.</span></span><br><span class="line">        next_tid = g-&gt;_main_tid;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ‹¿åˆ°ç°æœ‰çš„ meta, å¯èƒ½ä¹‹åè¦è¢«å›æ”¶äº†.</span></span><br><span class="line">    TaskMeta* <span class="type">const</span> cur_meta = g-&gt;_cur_meta;</span><br><span class="line">    <span class="comment">// å®šä¸‹ä¸‹ä¸€ä¸ªéœ€è¦è·³è½¬çš„æ ˆ</span></span><br><span class="line">    TaskMeta* next_meta = <span class="built_in">address_meta</span>(next_tid);</span><br><span class="line">    <span class="comment">// éœ€è¦åˆ›å»ºæ ˆ.</span></span><br><span class="line">    <span class="keyword">if</span> (next_meta-&gt;stack == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (next_meta-&gt;<span class="built_in">stack_type</span>() == cur_meta-&gt;<span class="built_in">stack_type</span>()) &#123;</span><br><span class="line">            <span class="comment">// also works with pthread_task scheduling to pthread_task, the</span></span><br><span class="line">            <span class="comment">// transferred stack is just _main_stack.</span></span><br><span class="line">            next_meta-&gt;<span class="built_in">set_stack</span>(cur_meta-&gt;<span class="built_in">release_stack</span>());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// åˆ›å»º Stack,</span></span><br><span class="line">            ContextualStack* stk = <span class="built_in">get_stack</span>(next_meta-&gt;<span class="built_in">stack_type</span>(), task_runner);</span><br><span class="line">            <span class="keyword">if</span> (stk) &#123;</span><br><span class="line">                next_meta-&gt;<span class="built_in">set_stack</span>(stk);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// stack_type is BTHREAD_STACKTYPE_PTHREAD or out of memory,</span></span><br><span class="line">                <span class="comment">// In latter case, attr is forced to be BTHREAD_STACKTYPE_PTHREAD.</span></span><br><span class="line">                <span class="comment">// This basically means that if we can&#x27;t allocate stack, run</span></span><br><span class="line">                <span class="comment">// the task in pthread directly.</span></span><br><span class="line">                next_meta-&gt;attr.stack_type = BTHREAD_STACKTYPE_PTHREAD;</span><br><span class="line">                next_meta-&gt;<span class="built_in">set_stack</span>(g-&gt;_main_stack);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">sched_to</span>(pg, next_meta);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ‰ä¸€ä¸ªé—®é¢˜æ˜¯ï¼Œ<code>fcontext</code> çš„ <code>ra</code> æ˜¯ <code>_exit</code>ï¼Œè¿™é‡Œä¸ä¼šå‡ºç°ç¢°åˆ°ç»“å°¾ç›´æ¥é€€å‡ºçš„é—®é¢˜å—ï¼Ÿç­”æ¡ˆæ˜¯ <code>ending_sched</code> çš„æ—¶å€™ï¼Œç›´æ¥æŠŠä½ è¿™ä¸ªæ ˆç»™å‡†å¤‡ç­äº†ï¼Œç­‰ä¸‹ä¸€æ¬¡è°ƒåº¦åˆ°åˆ«çš„åœ°æ–¹çš„æ—¶å€™ï¼Œç›´æ¥æŠŠä½ è¿™ä¸ªæ•´ä¸ªæ ˆæ¢äº†ã€‚è¿™æ ·å°±ä¸ä¼šèµ°åˆ° <code>_exit</code> å•¦~</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Notes: BigTable</title>
      <link href="/2022/03/21/Notes-BigTable/"/>
      <url>/2022/03/21/Notes-BigTable/</url>
      
        <content type="html"><![CDATA[<p>æœ¬æ–‡å¾ˆçŸ­è®°å½•ä¸€ä¸‹ BigTable è®ºæ–‡çš„ä¸€äº›å†…å®¹ã€‚å› ä¸ºè®ºæ–‡æ¯”è¾ƒè€äº†ï¼Œè€Œä¸”æ„Ÿè§‰æ›´åŠ æ³¨é‡åˆ†å¸ƒå¼ï¼Œå•æœºéƒ¨åˆ†å…¶å® SSTable å½±å“æ¯”è¾ƒå¤§ï¼Œä½†æ˜¯åœ¨ä»Šå¹´å·²ç»éåœ° RocksDB äº†ï¼Œçœ‹ç€å¤šå°‘æœ‰ç‚¹è€è°ƒé‡å¼¹ã€‚</p><p>BigTable æä¾›äº†é«˜ååé‡çš„æ‰¹å¤„ç†å’ŒåŠæ—¶å“åº”çš„è¯»ï¼Œå®ƒä¼¼ä¹å¯¹éæ‰¹çš„æ›´æ–°ä¹Ÿæœ‰ä¸€å®šæ”¯æŒï¼Œæ¯”å¦‚åœ¨ Google Percolator é‚£é‡Œçœ‹åˆ°çš„ã€‚</p><p>BigTable æœ€æ—©è®ºæ–‡è¿˜æ˜¯é›¶å‡ å¹´ï¼Œç³»ç»ŸæŠ½è±¡å’Œç°åœ¨å¾ˆå¤šè°ƒè°ƒå…¶å®æ˜¯åç€æ¥çš„ï¼ˆä¹Ÿå¯ä»¥è¯´ç°åœ¨çš„è°ƒè°ƒæ˜¯åä»–çš„ï¼‰ï¼š</p><ol><li>ä¸æ”¯æŒå…³ç³»æ¨¡å‹</li><li>å°†åº•å±‚ä½ç½®ã€åˆ†å¸ƒã€æ ¼å¼ä¹‹ç±»çš„æš´éœ²ç»™ç”¨æˆ·</li><li>value éƒ½æ˜¯ string</li><li>ä¸æ”¯æŒå¤šè¡Œäº‹åŠ¡</li></ol><p>å®ƒåœ¨ chapter 3 æè¿°äº†è‡ªå·±çš„æ•°æ®æ¨¡å‹ï¼Œæ˜¯ä¸€ä¸ªä¸€è¡Œå¤šåˆ—å¤š ts çš„å®½è¡¨ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(row: string, column: string, time: i64) -&gt; string</span><br></pre></td></tr></table></figure><p>ç„¶åå¸ƒå±€æ•°æ®å¤§æ¦‚å¦‚ä¸‹ï¼š</p><p><img src="https://image.mwish.me/blog-image/4154B725-09D7-4ED7-ACA8-AFCEC0C03C5B.png" alt="4154B725-09D7-4ED7-ACA8-AFCEC0C03C5B"></p><p><code>reverse(www.cnn.com)</code> æœ‰ä¸‰ä¸ª CFï¼Œæ¯ä¸ª CF å¦‚ä¸Šæ‰€ç¤ºã€‚å…³äºåŸå­æ€§ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p><blockquote><p>å¯¹åŒä¸€ä¸ªè¡Œå…³é”®å­—çš„è¯»æˆ–è€…å†™æ“ä½œéƒ½æ˜¯åŸå­çš„ï¼ˆä¸ç®¡è¯»æˆ–è€…å†™è¿™ä¸€è¡Œé‡Œå¤šå°‘ä¸ªä¸åŒåˆ—ï¼‰ï¼Œè¿™ä¸ª è®¾è®¡å†³ç­–èƒ½å¤Ÿä½¿ç”¨æˆ·å¾ˆå®¹æ˜“çš„ç†è§£ç¨‹åºåœ¨å¯¹åŒä¸€ä¸ªè¡Œè¿›è¡Œå¹¶å‘æ›´æ–°æ“ä½œæ—¶çš„è¡Œä¸ºã€‚</p></blockquote><p>BigTable ä¼šæŒ‰ç…§è¡Œæ¥åˆ†åŒºï¼Œåˆ†åŒºå•ä½æ˜¯ <code>Tablet</code>, åˆ—é‡Œå®šä¹‰åˆ†ä¸º<code>family:qualifier</code>, å¦‚ä¸Šå›¾ï¼Œ<code>anchor</code> æ˜¯åˆ—æ—ï¼Œ<code>anchor:qualifier</code> æ‰èƒ½å…·ä½“çš„ç¡®å®šä¸€ä¸ªåˆ—ã€‚è¿™é‡Œè¿˜å¯ä»¥åœ¨ CF ä¸ŠæŒ‡å®šä¸€äº›æƒé™ã€access æ–¹å¼ï¼Œæ¯”å¦‚åªè¯»ç­‰ã€‚</p><p>BigTable çš„å®šä¹‰ä¸­è¿˜æœ‰ä¸ª tsã€‚è¯»ä¼šä¼˜å…ˆè¯»å–æœ€æ–°çš„ tsï¼Œç„¶å ts æœ¬èº«å¯ä»¥ç”¨æˆ·æŒ‡å®šï¼Œè¿™é‡Œå¯ä»¥è®¾ç½®ä¸€äº›æ–°çš„ ts GC ç­–ç•¥ï¼Œæ¯”å¦‚ä¿ç•™ n ä¸ªç‰ˆæœ¬çš„æˆ–è€… n å¤©çš„ tsï¼ŒBigTable ä¼šå¸®åŠ©ä½ åš GCã€‚</p><p>å›é¡¾ä¸€ä¸‹ï¼Œè¿™é‡Œå¯ä»¥æŠŠå®ƒçš„æ¨¡å‹å½“ä½œä¸€ä¸ªå¤šå±‚çš„ã€å¤šè¡Œå¤šåˆ—çš„æ¨¡å‹ã€‚è¡Œä¸­çš„åˆ—å¯ä»¥æ˜¯ç¨€ç–çš„ã€‚</p><h2 id="ç»„ä»¶"><a href="#ç»„ä»¶" class="headerlink" title="ç»„ä»¶"></a>ç»„ä»¶</h2><p><img src="https://image.mwish.me/blog-image/4CA43388-1439-4668-BC05-F355BCD57407.png" alt="4CA43388-1439-4668-BC05-F355BCD57407"></p><ul><li>BigTable è¿è¡Œåœ¨ä¸€ä¸ªå¤šç§Ÿæˆ·çš„ç³»ç»Ÿä¸Šï¼Œå¯èƒ½å’Œ HDFSã€MR ç­‰æ··éƒ¨ï¼ˆè®ºæ–‡æ²¡æœ‰æå†™ï¼Œä½†æ˜¯æˆ‘éå¸¸å¥½å¥‡è¿™ä¸ªæ˜¯æ€ä¹ˆéš”ç¦»çš„ orz..ï¼‰</li><li>BigTable å†…éƒ¨æ–‡ä»¶æ˜¯ SSTable æ ¼å¼çš„ï¼Œè¿™ä¸ªæ ¼å¼æˆ‘ä¸ä¼šç»†å†™ï¼Œçœ‹ Google çš„ LevelDB å°±å·®ä¸å¤šäº†</li><li>BigTable ä¾èµ– <strong>Chubby</strong> åšåˆ†å¸ƒå¼é”æœåŠ¡ï¼Œè¿™ä¸ªå¯ä»¥ç±»ä¼¼ Zookeeper. å®ƒéœ€è¦ Chubby æ¥ä¿è¯è‡³å¤šåªæœ‰ä¸€ä¸ª Masterã€å­˜å‚¨ BigTable çš„ Metadataï¼›ç”¨æ¥ç»™ Tablet Server æ¢æ´»ç­‰</li></ul><p>é™¤äº†ä¸Šé¢è¿™äº› Building Blockï¼ŒBigTable è¿˜æœ‰ä¸‹åˆ—åŠŸèƒ½ï¼š</p><ol><li>æä¾›ç»™ç”¨æˆ·çš„ SDK</li><li>Master Serverï¼šç»™ Tablet Server åˆ†é… Tabletsã€è´Ÿè´£ Tablet Server çš„æˆå‘˜å˜æ›´å’Œè´Ÿè½½å‡è¡¡ã€å¯¹ GFS æ¥ GCã€è´Ÿè´£å»ºç«‹è¡¨å’Œ CF çš„ Schema æ“ä½œ</li><li>Tablet Serverï¼šç®¡ç†ä¸€ç»„ tablets. å­˜å‚¨ä¼šä¸‹æ”¾åˆ°å…±äº«å­˜å‚¨ GFS ä¸­ï¼Œæ‰€ä»¥å­˜å‚¨ä¸å¤ªéœ€è¦ replica. ï¼ˆä¸è¿‡è¿™é‡Œæ„Ÿè§‰æ²¡æœ‰è€ƒè™‘é‚£ç§ä¸å¤ªå‡è¡¡çš„è¯»è´Ÿè½½å¸¦æ¥çš„é—®é¢˜ï¼Œæ¯”æ–¹è¯´ç‰¹åˆ«çƒ­ç‚¹çš„è¯»ï¼Œå†™æ„Ÿè§‰ä¼°æ‘¸ç€å¯ä»¥é åˆ›å»º Bucket æ¥è§£å†³ï¼‰ã€‚</li></ol><p>å®é™…ä¸Šï¼Œå¯¹äº BigTableï¼Œå®ƒçš„ TabletServer å¯ä»¥å½“æˆä¸€ä¸ªã€Œæ— çŠ¶æ€çš„å­˜å‚¨å±‚ã€ï¼Œæ§åˆ¶ä¿¡æ¯å­˜å‚¨åœ¨ Chubby ç­‰åœ°æ–¹ï¼Œæ•°æ®å®é™…è½åœ¨ä¸€ä¸ªå­˜å‚¨å±‚ä¸Šã€‚æ­¤å¤–ï¼Œè¿™é‡Œçš„æ•°æ®è¿˜æ˜¯æŒ‰ç…§ Key æ¥è¿›è¡Œ Range Partition çš„ã€‚è¿™é‡Œçš„ Key å¯ä»¥ç±»ä¼¼çš„å½“ä½œ <code>RowKey:CF</code>ï¼Œä¸ºäº†ä¿è¯å•è¡Œäº‹åŠ¡ï¼Œæ„Ÿè§‰åŒä¸€ä¸ª Row åº”è¯¥æ˜¯è¦åœ¨åŒä¸€ä¸ªæœºå™¨ä¸Šçš„ã€‚</p><h3 id="Tablet-çš„å®šä½"><a href="#Tablet-çš„å®šä½" class="headerlink" title="Tablet çš„å®šä½"></a>Tablet çš„å®šä½</h3><p><img src="https://image.mwish.me/blog-image/3FDB7ADA-8801-4D11-B072-7944082FE226.png" alt="3FDB7ADA-8801-4D11-B072-7944082FE226"></p><p>è¿™é‡Œä½¿ç”¨ä¸€ä¸ªä¸‰å±‚ Btree çš„æ¨¡å‹æ¥å®šä½åˆ°å…·ä½“ Tablet çš„åˆ†é…ï¼Œè¿™äº›æ•°æ®åœ¨ BigTable æœ¬èº«æ˜¯ä¼šå­˜æ”¾åœ¨ TabletServer ä¸Šçš„ï¼ˆå…¶å®æˆ‘æ„Ÿè§‰è¿™äº›ä¸œè¥¿æœ¬èº«ä¹Ÿå¯ä»¥åˆ†å¼€å­˜ï¼Œæ¯”å¦‚è¿™äº›è·¯ç”±ä¿¡æ¯å­˜æ”¾åœ¨ä¸€äº›ç›¸å¯¹ç¨³å®šä¸ä¼šè¢«ä¹±è¿ç§»çš„æœºå™¨ï¼Ÿï¼‰ã€‚å®¢æˆ·ç«¯å¯ä»¥ç¼“å­˜è¿™äº›è·¯ç”±ä¿¡æ¯ï¼Œæ‰€ä»¥å®é™…ä¸Šè®¿é—®è¿™ä¸ªè¡¨æµé‡ä¸å¤ªå¤§ï¼Œå¤§éƒ¨åˆ†éƒ½è¢« client ç»™ç¼“å­˜ä¸‹æ¥äº†ã€‚</p><h3 id="Tablet-çš„åˆ†é…"><a href="#Tablet-çš„åˆ†é…" class="headerlink" title="Tablet çš„åˆ†é…"></a>Tablet çš„åˆ†é…</h3><p>è®ºæ–‡æ²¡æœ‰ä»‹ç» TabletServer çš„è´Ÿè½½æ˜¯æ€ä¹ˆæ ·åšè´Ÿè½½å‡è¡¡çš„ï¼Œæˆ‘ä»¬ä¹Ÿæ— ä»å¾—çŸ¥ã€‚</p><p>ç³»ç»Ÿä¾é  Chubby æ¥ä¿è¯æ•´ä¸ªç³»ç»Ÿåªæœ‰ä¸€ä¸ª Master è¿›ç¨‹ã€‚Master è¿›ç¨‹è¦ç»´æŠ¤ Tablet åœ¨ TabletServer ä¸­çš„åˆ†é…ï¼ŒåŒæ—¶è¦ä¿è¯è¿™ä¸ªåˆ†é…å’Œä¸Šé¢çš„ Figure 4 çš„ Tablet ä½ç½®ä¿¡æ¯æ˜¯ä¸€è‡´çš„ã€‚Master å¯åŠ¨çš„æ—¶å€™ï¼Œå¤§è‡´æµç¨‹å¦‚ä¸‹ï¼š</p><h4 id="Master"><a href="#Master" class="headerlink" title="Master"></a>Master</h4><p><strong>å¯åŠ¨</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1. åœ¨ Chubby æŠ¢åˆ° Master å¯¹åº”çš„åˆ†å¸ƒå¼é”, è¡¨ç¤º Master æ˜¯ç‹¬å çš„ã€‚</span><br><span class="line">2. æ‰«æ Chubby çš„ TabletServer, çŸ¥é“æŒ‚äº†å“ªäº› TabletServer</span><br><span class="line">3. å’Œ TabletServer é€šä¿¡, æ¥æŒ‡å¯¼æŒ‚äº†å“ªäº› Tablets</span><br><span class="line">4. æ‰«æ METADATA, æ¥åˆ†é…æœªåˆ†é…çš„ Tablets. å¦‚æœ METADATA è¿˜æ²¡æœ‰åˆ†é…, é‚£å°±ä¿è¯å®ƒå…ˆè¾ˆåˆ†é….</span><br></pre></td></tr></table></figure><p><strong>è¿è¡ŒæœŸé—´</strong></p><blockquote><p>åœ¨ä»»ä½•ä¸€ä¸ªæ—¶åˆ»ï¼Œä¸€ä¸ª Tablet åªèƒ½åˆ†é…ç»™ä¸€ä¸ª Tablet æœåŠ¡å™¨ã€‚Master æœåŠ¡å™¨è®°å½•äº†å½“å‰æœ‰å“ªäº›æ´»è·ƒçš„ Tablet æœåŠ¡å™¨ã€å“ªäº› Tablet åˆ†é…ç»™äº†å“ªäº› Tablet æœåŠ¡å™¨ã€å“ªäº› Tablet è¿˜æ²¡æœ‰è¢«åˆ†é…ã€‚å½“ä¸€ä¸ª Tablet è¿˜æ²¡æœ‰è¢«åˆ†é…ã€ å¹¶ä¸”åˆšå¥½æœ‰ä¸€ä¸ª Tablet æœåŠ¡å™¨æœ‰è¶³å¤Ÿçš„ç©ºé—²ç©ºé—´è£…è½½è¯¥ Tablet æ—¶ï¼ŒMaster æœåŠ¡å™¨ä¼šç»™è¿™ä¸ª Tablet æœåŠ¡å™¨å‘é€ ä¸€ä¸ªè¯·æ±‚ï¼ŒæŠŠ Tablet åˆ†é…ç»™è¿™ä¸ªæœåŠ¡å™¨ã€‚</p></blockquote><p><strong>å‡ºç°å˜æ›´çš„æ—¶å€™</strong></p><p>Master æœ¬èº«ä¼šç®¡ç† Tablet åœ¨ TabletServer ä¸Šçš„åˆ†é…æƒ…å†µã€‚åŒæ—¶ï¼Œä¹Ÿå€ŸåŠ© Chubby ç»´æŠ¤ TabletServer æ˜¯å¦æ´»è·ƒã€Tablet çš„å…·ä½“åˆ†é…æƒ…å†µã€‚</p><p>TabletServer æœ¬èº«å¯åŠ¨çš„æ—¶å€™ï¼Œä¹Ÿä¼šåœ¨ Chubby ä¸‹é¢åˆ›å»ºä¸€ä¸ªä¸´æ—¶çš„æ–‡ä»¶ï¼ŒMaster è¿™æ ·å°±å¯ä»¥ç›‘å¬ TabletServer çš„ä¸Šçº¿å’Œå¼‚å¸¸ä¸‹çº¿ã€‚TabletServer ä¹Ÿå¯ä»¥è®°å½•</p><p><strong>Split å’Œ Merge</strong></p><p>æŸä¸ª Tablet æˆ–è€… Region å¯èƒ½ä¼šå¤ªå¤§/å¤ªå°äº†ï¼Œéœ€è¦ Split/Merge äº†ã€‚è¿™ä¸ªæ—¶å€™ TabletServer ä¼šå’Œ Master è”åŠ¨æ¥åš Merge/Splitï¼Œæ¥å®Œæˆ Tablet çš„é‡æ–°åˆ†é…</p><h3 id="Tablet-æœåŠ¡"><a href="#Tablet-æœåŠ¡" class="headerlink" title="Tablet æœåŠ¡"></a>Tablet æœåŠ¡</h3><p><img src="https://image.mwish.me/blog-image/A8B964E6-6E0F-4624-832F-E62D49F5AB10.png" alt="A8B964E6-6E0F-4624-832F-E62D49F5AB10"></p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œå­˜å‚¨éƒ½å¹¶é LevelDB çš„ Diskï¼Œè€Œæ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿã€‚è¿™é€ æˆå„ç§æ“ä½œçš„ GAP è¿œæ¯”ç®€å•çš„ LSM-Tree å¤§ã€‚</p><p>SSTable è¿™é‡Œä¹Ÿè¦æ³¨æ„ç²’åº¦é—®é¢˜ã€‚</p><h2 id="ä¼˜åŒ–"><a href="#ä¼˜åŒ–" class="headerlink" title="ä¼˜åŒ–"></a>ä¼˜åŒ–</h2><ol><li><p>å¯ä»¥è¿›è¡Œä¸€äº›åˆ†å‰²ï¼Œå°†ä¸€äº› CF å­˜å‚¨åœ¨åŒä¸€ä¸ª SSTableã€‚æ¥æå‡å±€éƒ¨æ€§ã€‚METADATA çš„æ•°æ®ä»¥è¿™ç§æ–¹å¼è¢«ä¼˜åŒ–</p></li><li><p>SSTable æŒ‡å®šä¸€äº›ç‰¹å®šçš„å‹ç¼©æ–¹å¼ï¼š</p><blockquote><p>å¾ˆå¤šå®¢æˆ·ç¨‹åºä½¿ç”¨äº†â€œä¸¤éâ€çš„ã€å¯å®šåˆ¶çš„å‹ç¼©æ–¹å¼ã€‚ç¬¬ä¸€éé‡‡ç”¨ Bentley and McIlroyâ€™s æ–¹å¼[6]ï¼Œè¿™ç§æ–¹å¼åœ¨ä¸€ä¸ª å¾ˆå¤§çš„æ‰«æçª—å£é‡Œå¯¹å¸¸è§çš„é•¿å­—ç¬¦ä¸²è¿›è¡Œå‹ç¼©ï¼›ç¬¬äºŒéæ˜¯é‡‡ç”¨å¿«é€Ÿå‹ç¼©ç®—æ³•ï¼Œå³åœ¨ä¸€ä¸ª 16KB çš„å°æ‰«æçª—å£ ä¸­å¯»æ‰¾é‡å¤æ•°æ®ã€‚ä¸¤ä¸ªå‹ç¼©çš„ç®—æ³•éƒ½å¾ˆå¿«ï¼Œåœ¨ç°åœ¨çš„æœºå™¨ä¸Šï¼Œå‹ç¼©çš„é€Ÿç‡è¾¾åˆ° 100-200MB/sï¼Œè§£å‹çš„é€Ÿç‡è¾¾ åˆ° 400-1000MB/sã€‚</p></blockquote></li><li><p>ä½¿ç”¨ BlockCache / BloomFilter</p></li></ol><h3 id="Log-å’Œæ¢å¤æµ"><a href="#Log-å’Œæ¢å¤æµ" class="headerlink" title="Log å’Œæ¢å¤æµ"></a>Log å’Œæ¢å¤æµ</h3><p>ä¸Šé¢å‡ ä¸ªéƒ½æ¯”è¾ƒå¥½æ¨ï¼Œä¸‹é¢ä¸€ä¸ªç›¸å¯¹æ¥è¯´ç‰¹æ®Šä¸€äº›ã€‚ä¸€å° TabletServer å¯èƒ½æœ‰æˆç™¾ä¸Šåƒçš„ Tabletsï¼Œæ¯ä¸ª Tablet ä¼šæœ‰è‡ªå·±çš„ Redo log æµå’Œ SSTableã€‚ä½†æ˜¯éƒ½æœ‰å†™å…¥çš„æ—¶å€™ï¼Œå¦‚æœå¾€è¿™ä¹ˆå¤š Redo Log æµå†™çš„è¯ï¼Œå¯¹ä¸‹å±‚å‹åŠ›ä¼šå¾ˆå¤§ã€‚è¿™é‡Œ BigTable ä¼šæŠŠæ—¥å¿—æµèšåˆï¼Œå†™åˆ° <code>TabletServer</code> ä¸ºç²’åº¦çš„æ—¥å¿—æ–‡ä»¶ã€‚è¿™è®©å†™æ—¥å¿—å¿«äº†å¾ˆå¤šã€‚</p><p>è¿™ç»™æ¢å¤å’Œè¿ç§»å¸¦æ¥äº†ä¸€äº›éº»çƒ¦ã€‚å› ä¸ºåŸæœ¬æ¢å¤é€»è¾‘å¤§æ¦‚æ˜¯ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1. æ‰¾åˆ°è‡ªå·± Region å¯¹åº”çš„ Redo Log</span><br><span class="line">2. Redo</span><br></pre></td></tr></table></figure><p>ç°åœ¨å˜æˆäº†ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1. æ‰¾åˆ°ä¹‹å‰çš„ Log æµ</span><br><span class="line">2. æŠŠæ—¥å¿—æŒ‰ç…§ (tableï¼Œrow nameï¼Œlog sequence number) æ’åº</span><br><span class="line">2.1. Master æ‰¾åˆ°æ—¥å¿—, å…ˆå°†æ—¥å¿—åˆ†å‰²æˆ 64MB çš„æ®µï¼Œä¹‹ååœ¨ä¸åŒçš„ Tablet æœåŠ¡å™¨å¯¹æ®µè¿›è¡Œå¹¶è¡Œæ’åº</span><br><span class="line">3. æŒ‰ç…§ä¹‹å‰é€»è¾‘æ¢å¤</span><br></pre></td></tr></table></figure><h3 id="Tablet-åŠ é€Ÿæ¢å¤"><a href="#Tablet-åŠ é€Ÿæ¢å¤" class="headerlink" title="Tablet åŠ é€Ÿæ¢å¤"></a>Tablet åŠ é€Ÿæ¢å¤</h3><p>åœ¨è°ƒåº¦çš„æ—¶å€™ï¼ŒTablet åš minor compactionï¼ŒæŠŠæœª Flush çš„ Redo Log åˆ·åˆ° SSTï¼Œè¿™ä¸ªä¼šæ¢å¤æˆ–è€…è°ƒåº¦æœŸå¸¦æ¥ä¸€äº›å°å°çš„åœå†™ï¼Œä½†æ˜¯èƒ½å‡å°‘è°ƒåº¦/æ¢å¤æœŸé—´çš„æ—¶é—´ã€‚</p><h2 id="HBase-å¯¹-BigTable-çš„å®ç°"><a href="#HBase-å¯¹-BigTable-çš„å®ç°" class="headerlink" title="HBase å¯¹ BigTable çš„å®ç°"></a>HBase å¯¹ BigTable çš„å®ç°</h2><p>BigTable è®ºæ–‡åœ¨ OSDIâ€™06 å‘å¸ƒã€‚è€Œ Apache HBase ä¹Ÿåœ¨ 06 å¹´å†™ä¸‹ç¬¬ä¸€è¡Œä»£ç ã€‚</p><p>HBase è¢«æè¿°ä¸ºä¸€ä¸ªæŒä¹…çš„ã€åˆ†å¸ƒå¼çš„ã€ç¨€ç–çš„ã€å¤šç»´çš„è¡¨ã€‚æŒ‰ç…§ Column Family è¢«å­˜å‚¨åœ¨ä¸åŒçš„åœ°æ–¹ã€‚å®ƒçš„ä½“ç³»ç»“æ„ç±»ä¼¼ BigTable:</p><p><img src="https://image.mwish.me/blog-image/36142E10-C8AB-401E-B5E9-BC67A8C5ECD2.png" alt="36142E10-C8AB-401E-B5E9-BC67A8C5ECD2"></p><p>æˆ‘ä»¬æœ‰ä¸‹é¢çš„æ˜ å°„å…³ç³»ï¼š</p><ol><li>åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿ -&gt; HDFS</li><li>Chubby -&gt; ZooKeeper</li><li>Tablet -&gt; Region</li><li>TabletServer -&gt; RegionServer</li></ol><p>å¯¹äºå…ƒä¿¡æ¯ï¼Œå®ƒå­˜å‚¨åœ¨äº†ç‰¹æ®Šçš„è¡¨ä¸­: <a href="https://hbase.apache.org/book.html#arch.catalog">https://hbase.apache.org/book.html#arch.catalog</a> ã€‚è¿™ä¸ªè¡¨ä¹Ÿä¼šéšç€ Region è°ƒåº¦è¢«è°ƒåº¦ã€‚</p><p>è€Œå¯¹äº WALï¼ŒHBase ä¼šå­˜æ”¾ WALï¼Œè¡Œçº§åˆ«çš„äº‹åŠ¡åªä¼šå†™ä¸€æ¡ WALï¼Œæ¥ä¿è¯è¡Œæ“ä½œåŸå­æ€§ï¼š<a href="https://hbase.apache.org/book.html#wal">https://hbase.apache.org/book.html#wal</a> ã€‚åœ¨ä¸Šé¢çš„è®ºæ–‡é‡Œï¼ŒGoogle BigTable æ”¯æŒå•ä¸ª WAL æµï¼Œè€Œå°ç±³çš„ä¼˜åŒ–æä¾›äº†å¤šä¸ª WALï¼Œæ¥æ‰“æ•£ HDFS ä¸²è¡Œå†™ï¼Œä¼˜åŒ–å†™ã€‚å¯¹äºè¯»ï¼Œè¿™é‡Œä¼šæŠŠ Block ç¼“å­˜åœ¨å†…å­˜çš„ BlockCache ä¸­ã€‚</p><p>æ¯”è¾ƒç»†çš„åœ°æ–¹åœ¨äº Region è¿ç§»/Merge/Split ç›¸å…³çš„ï¼ŒMerge å’Œ Split éƒ½ä¾èµ–è¿ç§»æ“ä½œï¼Œè¿™é‡Œå¯èƒ½ä¼šå°†è¦æ“ä½œçš„å¤šä¸ª Region ç§»åŠ¨åˆ°åŒä¸€ä¸ª RegionServer æ¥æ“ä½œã€‚</p><p>å¯¹äº Load Balanceï¼ŒåŸè®ºæ–‡ä¸­æ²¡æœ‰æåˆ°ï¼Œè¿™é‡Œæä¾›äº†ä¸€äº›ç›¸å¯¹å¤æ‚çš„ç­–ç•¥ï¼ŒåŒ…æ‹¬æ ¹æ®è´Ÿè½½æ¥è¿ç§»ï¼š<a href="https://hbase.apache.org/book.html#regions.arch.assignment">https://hbase.apache.org/book.html#regions.arch.assignment</a></p><p>HBase çš„ç›®å½•åœ¨ï¼š<a href="https://github.com/apache/hbase">https://github.com/apache/hbase</a> ï¼ŒæœåŠ¡å™¨ä¸»è¦è·¯å¾„åœ¨ <code>hbase-server</code> ä¸‹çš„ master å’Œ region-server çš„ç›®å½•åˆ†åˆ«æ˜¯</p><p>HBase å®•æœºæ¢å¤å’ŒåŸè®ºæ–‡å·®ä¸å¤šï¼Œå€¼å¾—ä¸€æçš„æ˜¯è¿ç§»ç›¸å…³çš„éƒ¨åˆ†ã€‚è¿™é‡Œå¯èƒ½å—åˆ° Region è°ƒåº¦å’Œåˆ†è£‚çš„å½±å“ï¼Œæ‰€ä»¥åšçš„ç›¸å¯¹ç»†è‡´å¾ˆå¤šã€‚æˆ‘ä»¬è¿™é‡Œä¼šä»‹ç»ä¸€ä¸‹ HBase ç®¡æ§ç›¸å…³çš„ä¸€äº›ä¿¡æ¯</p><p>HBase çš„ ZooKeeper ä¸­ï¼Œä¼šç¼“å­˜å¦‚ä¸‹çš„ä¿¡æ¯ï¼Œå…·ä½“æˆ‘æ‘˜å½•ä¸€äº›è°ƒåº¦æœ‰å…³çš„ä¿¡æ¯ï¼š</p><ul><li><code>meta-region-server</code>: å­˜å‚¨ <code>hbase:meta</code> è¿™å¼ å…ƒæ•°æ®è¡¨çš„ RegionServer çš„è®¿é—®åœ°å€</li><li><code>region-in-transition</code>: åœ¨ Region çš„è¿ç§»è¿‡ç¨‹ä¸­ï¼Œè¿™é‡Œ RegionServer ä¼šåœ¨è¿™é‡Œå˜æ›´ Region çš„çŠ¶æ€ï¼ŒMaster ä¼š watch å¯¹åº”çš„èŠ‚ç‚¹ï¼Œè§¦å‘æ›´æ–° <code>hbase:meta</code> è¡¨çš„æ˜ å°„ã€‚</li></ul><h3 id="å®¢æˆ·ç«¯è¡Œä¸º"><a href="#å®¢æˆ·ç«¯è¡Œä¸º" class="headerlink" title="å®¢æˆ·ç«¯è¡Œä¸º"></a>å®¢æˆ·ç«¯è¡Œä¸º</h3><p>client ä¼šè®¿é—® <code>zk</code> æä¾›çš„ <code>hbase:meta</code> è¡¨ï¼Œè¿™ä¸ªè¡¨å¤§æ¦‚å†…å®¹å¦‚ä¸‹ï¼š</p><p><img src="https://image.mwish.me/blog-image/B7A7AB65-C139-4269-9740-645059300C4F.png" alt="B7A7AB65-C139-4269-9740-645059300C4F"></p><p>Client ä¼šè¯»å– <code>meta-region-server</code> è¿™ä¸ª ZNodeï¼Œç„¶åè®¿é—® <code>hbase</code> çš„å…ƒä¿¡æ¯ï¼Œä½ç½®ä¿¡æ¯ã€‚è®¿é—®åˆ°ä¹‹åï¼Œå…·ä½“çš„è·¯ç”±ä¼šè¢«ç¼“å­˜åœ¨ client ä¸Šã€‚è¿™ä¸ªå†…å®¹å…¶å®æ˜¯ <code>&lt;æŸä¸ªå¯¹åº”çš„ StartKey, EndKey, åˆ†é…åœ¨ä»€ä¹ˆ RegionServer çš„ä»€ä¹ˆ Region&gt;</code>.</p><p>å…³é”®æ˜¯è®¿é—®å¤±æ•ˆï¼ŒRegionServer èƒ½å¤Ÿå‘ç°å¯¹åº” Region ä¸åœ¨è‡ªå·±ä¸Šé¢ï¼ŒClient ä¼šæ¸…ç¼“å­˜ç„¶åé‡æ–°è®¿é—® <code>meta-region-server</code>ï¼Œç„¶åæ›´æ–°ç¼“å­˜ã€‚</p><h3 id="RegionServer"><a href="#RegionServer" class="headerlink" title="RegionServer"></a>RegionServer</h3><p><img src="https://image.mwish.me/blog-image/C9D9DD35-CDE3-4A06-A932-BBADEEF336C2.png" alt="C9D9DD35-CDE3-4A06-A932-BBADEEF336C2"></p><p>HBase çš„å†™å…¥ä¼šæœ‰ä¸€ä¸ª <code>sequenceid</code>, æ ¹æ® <code>sequenceid</code> åšä¸€äº›æ—¥å¿—æ¨è¿›ã€‚HLog æœ¬èº«æ˜¯æŒ‰ç…§æ—¶é—´ä¹‹ç±»çš„æ»šçš„ï¼Œç„¶åå¯èƒ½æœ‰å¤åˆ¶èŠ‚ç‚¹åœ¨è¯»å–è¿™äº›æ•°æ®ã€‚å½“ä¿è¯æ²¡æœ‰ Flush çš„æœ€åä¸€ä¸ª MemStore ä¹Ÿå¤§äºæŸä¸ª WAL çš„ sequence ä¹‹åï¼Œè¿™ä¸ª WAL å¯ä»¥è¢«æ”¾åˆ°åˆ«çš„åœ°æ–¹ã€‚</p><p>è¿™é‡Œçš„ WAL (HLog) ä¼šå†™ <code>WAL</code> æ–‡ä»¶ï¼Œ<code>WAL</code> å†™å…¥ä¹‹åæŒ‰ç…§ä¸€å®šæ¡ä»¶ä¼šåˆ‡æ¢åˆ°å†™æ–°çš„æ–‡ä»¶ï¼Œå½“ MemTable Flush æˆä¸º HFile ä¹‹åï¼Œè¿™é‡Œä¼šæŠŠ <code>WAL</code> ç§»åŠ¨åˆ° <code>oldWALS</code>ï¼Œç­‰æ”¹è¢«è¿™ä¸ª <code>WAL</code> æ–‡ä»¶æ²¡æœ‰è¢« replica è¯»ï¼Œå¹¶ GCã€‚</p><p>ä¸Šè¿°æè¿°äº† Minor Compaction çš„æµç¨‹ã€‚Major Compaction è¿™é‡Œæ˜¯ Tiered Compactionï¼Œå› ä¸º HBase æœ¬èº«é€‚åˆè¯»å¤šå†™å°‘çš„åœºæ™¯. HBase å¯¹ Compaction æä¾›äº†ä¸“é—¨çš„çº¿ç¨‹æ± åšä»»åŠ¡éš”ç¦»ï¼ˆæˆ‘è„‘æ´ä¸€ä¸‹ï¼Œæ„Ÿè§‰ Compaction ä»»åŠ¡æœ¬èº«ä¹Ÿå¯ä»¥ä¸‹å‘åˆ°åˆ«çš„æœºå™¨ä¸Šï¼‰ã€‚</p><h3 id="Region-è¿ç§»-åˆ†è£‚-åˆå¹¶"><a href="#Region-è¿ç§»-åˆ†è£‚-åˆå¹¶" class="headerlink" title="Region è¿ç§»/åˆ†è£‚/åˆå¹¶"></a>Region è¿ç§»/åˆ†è£‚/åˆå¹¶</h3><h4 id="åŸºç¡€-Procedure-V2"><a href="#åŸºç¡€-Procedure-V2" class="headerlink" title="åŸºç¡€: Procedure V2"></a>åŸºç¡€: Procedure V2</h4><p>è¿™ä¸ªå¥½åƒæ˜¯ç”±å›½äºº Committer å¼ é“è€å¸ˆå®Œæˆçš„ã€‚è¿™ä¸€éƒ¨åˆ†æˆ‘æ„Ÿè§‰ç›¸å½“å¤æ‚ï¼Œä¼šæ¶‰åŠ Masterã€Zkã€RegionServer ä¸‰æ–¹çš„çŠ¶æ€ï¼Œæ‰€ä»¥æ¯”è¾ƒå¤æ‚. </p><p>åœ¨è¿™é‡Œï¼Œæ¯ä¸ª Task ä¼šè¢«åˆ†æˆå¤šä¸ªå­ä»»åŠ¡ï¼Œè¿™é‡Œå¢åŠ äº†ä¸€ä¸ª Procedure V2 çš„æ¨¡å—ï¼Œç„¶åä¼šæŠŠä»»åŠ¡å†™æˆä¸€ä¸ª Taskï¼Œåˆ†æˆå¤šæ­¥æ¥æ‰§è¡Œã€‚è¿™é‡Œå¯ä»¥çœ‹ï¼š</p><ol><li><a href="https://www.slidestalk.com/HBaseGroup/HBaseProcedureV236713">https://www.slidestalk.com/HBaseGroup/HBaseProcedureV236713</a></li><li><a href="http://www.nosqlnotes.com/technotes/hbase/procedure-v2/">http://www.nosqlnotes.com/technotes/hbase/procedure-v2/</a></li></ol><p>å¯¹äº Region çŠ¶æ€è¿ç§»ï¼Œè¿™é‡Œåˆ‡åˆ†æˆäº†ä¸‹é¢çš„çŠ¶æ€ï¼Œä»¥å†™ <code>MasterRegion</code> ä¸ºåˆ†å¸ƒå¼çš„ Coordinatorï¼Œæ¥æ¨å®šæœ€ç»ˆçš„çŠ¶æ€ã€‚å½“ç„¶å®é™…ä¸Šè¿™ä¸ªæ˜¯å¾ˆéš¾çš„ï¼Œæˆ‘ä»¬å¯ä»¥å¯¹æ¯”ä¸€ä¸‹ TiKV + PD ï¼ˆå³åŸºäº Multi-Raft çš„æ–¹æ¡ˆï¼‰:</p><ol><li>TiKV åˆ†æˆäº†å¤šä¸ª Raft Groupï¼Œæ¯ä¸ª Raft Group æ˜¯ä¸€ä¸ªè‡ªæ´½çš„å°åœˆå­</li><li>Raft Group ä¼šç»™ PD ä¸ŠæŠ¥å¿ƒè·³ï¼Œæ ¹æ®å¿ƒè·³æ¥å†³è®®æœ€ç»ˆçš„çŠ¶æ€</li><li>Region æœ¬èº«ï¼Œä¼šæœ‰ä¸€ä¸ª Epochï¼Œæ ¹æ® Epoch æ¥å†³å®šæœ€ç»ˆçš„çŠ¶æ€ã€‚PD åœ¨åšåˆ†è£‚çš„æ—¶å€™ä¼šå‘é€ä¸€ä¸ª Taskï¼Œç„¶åå‘é€ Region åˆ†è£‚çš„ä»»åŠ¡ï¼Œè¿™ä¸ªä»»åŠ¡ä¸Šè°ƒåº¦ä¼šæ˜¯å¹‚ç­‰çš„</li></ol><p>é‚£ä¹ˆï¼ŒTiKV è¿™ä¸ªå¯ä»¥å‚è€ƒï¼š<a href="https://pingcap.com/zh/blog/tikv-source-code-reading-20">https://pingcap.com/zh/blog/tikv-source-code-reading-20</a></p><p>é‚£ä¸ºä»€ä¹ˆ Procedure V2 è¿™äº›è¿™ä¹ˆå¤æ‚å‘¢ï¼Œå› ä¸ºå®ƒè°ƒåº¦æœ‰å¥½å‡ éƒ¨åˆ†ï¼š</p><ol><li>Master çš„å†…å­˜</li><li>å­˜å‚¨çš„è·¯ç”±è¡¨ï¼Œå³ <code>hbase:meta</code></li><li>RegionServer çš„çŠ¶æ€</li></ol><p>è¿™ä¸ªå¯èƒ½ Master Assign äº†ä¸€ä¸ªä»»åŠ¡ï¼Œç„¶å RegionServer æ‰§è¡Œäº†ä¸€éƒ¨åˆ†ï¼Œç„¶åæŒ‚åˆ° zk ä¸Šï¼Œè¿™ä¸ªæ—¶å€™ Master Crash äº†ï¼Œç„¶å Master æ‹‰èµ·æ¥ä¹‹åï¼Œå¯èƒ½è¦æ ¹æ® Heartbeat æˆ–è€…ä»€ä¹ˆé‡å»ºã€‚è¿™ä¸ªæ—¶å€™ï¼Œä¸è¿‡ä¸ä¸€è‡´ï¼Œå¯èƒ½ä¼šè¿”å› RIT é”™è¯¯ã€‚</p><p>Procedure V2 æ¡†æ¶ä¼šåšä»€ä¹ˆå‘¢ï¼Ÿå®ƒä¼šæŠŠ <code>MasterRegion</code> å½“ä½œ <code>Coordinator</code>, å†³å®šæœ€ç»ˆçš„äº‹åŠ¡çŠ¶æ€ã€‚ç„¶åå¦‚æœçŠ¶æ€ä¸ä¸€è‡´ï¼Œå®ƒä¼šå°è¯•æ¨è¿›æˆ–è€…å°è¯• Abortï¼Œåšäº†ä¸€ä¸ªåˆ†å¸ƒå¼çš„çŠ¶æ€æœºã€‚ï¼ˆæ„Ÿè§‰æœ‰ç‚¹åƒ saga æˆ–è€… tccï¼Ÿå…¶å®æŒº Hack çš„ï¼‰</p><p><img src="https://image.mwish.me/blog-image/82A72356-3129-4F8E-AB38-36B898FF3CB9.png" alt="82A72356-3129-4F8E-AB38-36B898FF3CB9"></p><p>è¿™ä¸ªåœ°æ–¹å¯ä»¥åˆ†æˆå¤šç»„çŠ¶æ€ï¼Œç„¶åå®ç°äº† <code>rollback</code> ç­‰æ“ä½œï¼Œæ¥æ¨è¿›æˆ–è€…å›é€€ã€‚</p><h4 id="Region-Split-Merge-è¿ç§»"><a href="#Region-Split-Merge-è¿ç§»" class="headerlink" title="Region Split/Merge/è¿ç§»"></a>Region Split/Merge/è¿ç§»</h4><p>è¿™é‡Œå¯ä»¥çœ‹çœ‹ï¼š<a href="https://blog.cloudera.com/apache-hbase-region-splitting-and-merging/">https://blog.cloudera.com/apache-hbase-region-splitting-and-merging/</a>  å’Œ <a href="https://popesaga.github.io/2020/11/13/HBase%20%E5%AD%A6%E4%B9%A0%EF%BC%9ARegion%20%E8%BF%81%E7%A7%BB%E3%80%81%E5%90%88%E5%B9%B6%E3%80%81%E5%88%86%E8%A3%82%E5%92%8C%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/#Assignment-Manager-V2">https://popesaga.github.io/2020/11/13/HBase%20%E5%AD%A6%E4%B9%A0%EF%BC%9ARegion%20%E8%BF%81%E7%A7%BB%E3%80%81%E5%90%88%E5%B9%B6%E3%80%81%E5%88%86%E8%A3%82%E5%92%8C%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/#Assignment-Manager-V2</a></p><p>è¿˜æ˜¯æŒºå¤æ‚çš„ï¼Œè¦è€ƒè™‘ï¼š</p><ol><li>Procedure V2 çš„æ¢å¤</li><li>åˆ†è£‚ã€åˆå¹¶çš„ç­–ç•¥ï¼ŒåŒ…æ‹¬è§¦å‘æ¡ä»¶ï¼ˆè´Ÿè½½å‡è¡¡ã€æŸ¥æ‰¾åˆ°å…·ä½“åˆ†è£‚çš„ç‚¹ï¼‰ï¼Œå¯ä»¥å‚è€ƒ <code>StochasticLoadBalancer</code> ç­–ç•¥</li><li>åˆ†è£‚ã€åˆå¹¶çš„è¿‡ç¨‹ä¸­ï¼Œä¼šä»ä¸€å° WAL æ¶‰åŠåˆ°2å° WALï¼Œå¯¹åº”çš„ HFile ä¹Ÿéœ€è¦è¿ç§»æˆ–è€… GCã€‚</li></ol><h1 id="æœ€åçš„è¯"><a href="#æœ€åçš„è¯" class="headerlink" title="æœ€åçš„è¯"></a>æœ€åçš„è¯</h1><p>è¿™é‡Œçš„ lessons ä¸€èŠ‚ç›¸å½“æœ‰æ„æ€ï¼Œæˆ‘è§‰å¾—å¥å¥é‡‘å¥ã€‚è¿™é‡Œè¯´çš„å¤§è‡´å†…å®¹è¿˜æ˜¯è¯´ï¼Œåˆ†å¸ƒå¼ç³»ç»Ÿçš„è®¾è®¡è¦ä¾èµ–ç®€å•çš„æ¥å£ï¼Œåœ¨åŠ å…¥æ¥å£ä¹‹å‰è¦æƒ³åˆ°ç”¨æˆ·æ€ä¹ˆç”¨ï¼Œç„¶åå°½é‡æŠŠä¾èµ–å’Œè‡ªå·±éƒ½æç®€å•ä¸€äº›ï¼Œå› ä¸ºåè¿‡æ¥è¯´ï¼Œå¾ˆå¤šè½¯ä»¶æœ¬èº«å¾ˆå¤§ï¼Œä½†æ˜¯å®ƒçš„ä¸€äº›è¾¹è§’åŠŸèƒ½å¯èƒ½ç›¸å¯¹æ²¡é‚£ä¹ˆé è°±ï¼›åŒæ—¶ï¼Œè¦æ·»åŠ åŠŸèƒ½çš„æ—¶å€™ï¼Œè¦æƒ³åˆ°ç”¨æˆ·å¯èƒ½æ€ä¹ˆç”¨ï¼Œè¿‡å¤šçš„åŠŸèƒ½å’Œé…ç½®ä¼šæŠŠä½ çš„ç³»ç»Ÿæå¾—å¾ˆæ¶å¿ƒï¼Œæ‰€ä»¥å¾ˆå¤šæ—¶å€™æä¾›ä¸€ä¸ªç®€å•çš„ kernel ä¹ŸæŒºå¥½çš„ï¼ˆå½“ç„¶ï¼Œåœ¨ç°ä»Šå†…å·å’Œç»†åŒ–çš„ç¯å¢ƒä¸‹ï¼Œå¤§å®¶ä¹Ÿä¼šåšå„ç§æ…å±æ£åŠŸèƒ½ï¼‰ã€‚</p><p>è®ºæ–‡çš„ lessons è¿˜è®²åˆ°ä¸€äº› checksum ä¹‹ç±»çš„é—®é¢˜ï¼Œæˆ‘è§‰å¾—éƒ­å®½åœ¨çŸ¥ä¹çš„ç­”æ¡ˆå…¶å®æ˜¯ç›¸å¯¹é è°±çš„ï¼š<a href="https://zhuanlan.zhihu.com/p/338893564">https://zhuanlan.zhihu.com/p/338893564</a> ã€‚</p><p>å½“åˆçœ‹ BigTable ä¹‹å‰ï¼Œæ„Ÿè§‰é‡Œé¢çš„ä¸œè¥¿å¯èƒ½æ¯”è¾ƒæ—§äº†ï¼Œè€Œä¸”å•è¡Œäº‹åŠ¡çš„æ¨¡å‹å¯èƒ½ç›¸å¯¹ TiKV æˆ–è€… Spanner é‚£å¥—å·²ç»æ¯”è¾ƒ Naive äº†ï¼Œä¸è¿‡ BigTable ä»ç„¶å¾ˆæ¸…æ™°çš„æè¿°äº†æ€ä¹ˆåœ¨å…±äº«å­˜å‚¨ä¸Šæ„å»ºç³»ç»Ÿã€‚ä¸€äº›æ¯”è¾ƒç»†èŠ‚çš„é—®é¢˜æ˜¯ï¼šRegion æˆå‘˜å˜æ›´ã€Region çš„ HLog æµã€HLog åˆ‡åˆ†ã€å¤‡ä»½çš„æ—¶å€™å‡ºç°æ–° Region å’Œæ—§ Region ä¸åœ¨åŒä¸€æ¡ HLog ä¸Šã€‚è¿™äº›é—®é¢˜ç°åœ¨åšäº‘ä¸Šä¸€äº›å…±äº«å­˜å‚¨çš„ç³»ç»Ÿè¿˜æ˜¯ä¼šç¢°åˆ°çš„ï¼Œä¹Ÿæ˜¯å¯ä»¥å‚è€ƒçš„ã€‚</p><p>åƒä¸€äº›æ–°çš„ç³»ç»Ÿå¯èƒ½ä¼šæŠŠ Log æ¥åˆ°ä¸€äº›å¼‚æ„çš„ç³»ç»Ÿï¼Œæ¯”å¦‚ BookKeeper ä¹‹ç±»çš„ç³»ç»Ÿä¸Šã€‚ä¸è¿‡æˆ‘æ„Ÿè§‰å¾ˆå¤šå®ç°è¿˜æ˜¯è·Ÿè®ºæ–‡è®¨è®ºçš„å·®ä¸å¤šçš„ã€‚</p><h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><ol><li>OSDIâ€™06 BigTable: <a href="https://research.google.com/archive/bigtable-osdi06.pdf">https://research.google.com/archive/bigtable-osdi06.pdf</a></li><li>BigTable çš„ç¿»è¯‘ï¼š<a href="https://arthurchiao.art/blog/google-bigtable-zh/">https://arthurchiao.art/blog/google-bigtable-zh/</a></li><li>HBase Book: <a href="https://hbase.apache.org/book.html">https://hbase.apache.org/book.html</a></li><li>ã€ŠHBaseåŸç†ä¸å®è·µã€‹ èƒ¡äº‰ã€èŒƒæ¬£æ¬£è‘—ã€‚</li><li>HBase Compaction: <a href="http://hbasefly.com/2016/07/13/hbase-compaction-1/">http://hbasefly.com/2016/07/13/hbase-compaction-1/</a></li><li></li></ol>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>InfluxDB æ¨¡å‹å’Œå­˜å‚¨å¼•æ“å…¥é—¨</title>
      <link href="/2022/03/17/InfluxDB-%E7%9B%B8%E5%85%B3%E6%9D%90%E6%96%99/"/>
      <url>/2022/03/17/InfluxDB-%E7%9B%B8%E5%85%B3%E6%9D%90%E6%96%99/</url>
      
        <content type="html"><![CDATA[<p>InfluxDB åˆ†ä¸ºè¿™é‡Œæ‰€åˆ—çš„ç‰ˆæœ¬ï¼š<a href="https://www.influxdata.com/products/editions/">https://www.influxdata.com/products/editions/</a> </p><h2 id="æ•°æ®æ¨¡å‹å’ŒæŸ¥è¯¢"><a href="#æ•°æ®æ¨¡å‹å’ŒæŸ¥è¯¢" class="headerlink" title="æ•°æ®æ¨¡å‹å’ŒæŸ¥è¯¢"></a>æ•°æ®æ¨¡å‹å’ŒæŸ¥è¯¢</h2><p>å‚è€ƒï¼š<a href="https://docs.influxdata.com/influxdb/v2.1/reference/key-concepts/data-elements/">https://docs.influxdata.com/influxdb/v2.1/reference/key-concepts/data-elements/</a> å’Œ <a href="https://docs.influxdata.com/enterprise_influxdb/v1.9/concepts/glossary/">https://docs.influxdata.com/enterprise_influxdb/v1.9/concepts/glossary/</a></p><p><img src="https://image.mwish.me/blog-image/DBBF4749-218C-493E-A56E-4A6060E21AC7.png" alt="DBBF4749-218C-493E-A56E-4A6060E21AC7"></p><ul><li>Database: æ•°æ®åº“</li><li>Timestamp: æ—¶é—´æˆ³ï¼Œ</li><li>Measurement: A measurement acts as a container for tags, fields, and timestamps.</li><li>Field: åˆ†ä¸º <code>&lt;Field Key, Field Value&gt;</code>ï¼ŒField Key æ˜¯åç§°å­—ç¬¦ä¸²ï¼ŒField Value æ˜¯åªæ”¯æŒåŸºæœ¬ç±»å‹çš„å€¼ã€‚æ‰€æœ‰çš„ Field ç»„æˆäº†ä¸€ä¸ª <strong>Field Set</strong>ï¼Œ<strong>Field ä¸Šçš„å€¼æ˜¯ä¸ä¼šå»ºç´¢å¼•çš„</strong>ã€‚</li><li>Tags æ˜¯æä¾› <code>Point</code> çš„å…ƒæ•°æ®ï¼Œæœ‰ç‚¹ç±»ä¼¼ indexï¼Œtags æŒ‰ç…§ <code>string</code> çš„æ–¹å¼å­˜å‚¨. æ‰€æœ‰çš„ tags ç»„æˆäº† tag setã€‚å•ä¸ª Tag åŒ…å« <code>Tag Key</code> å’Œ <code>Tag Value</code>. å¯¹äºæ¯ä¸ª tag key, tag value å¯ä»¥æ„æˆä¸€ä¸ªç±»ä¼¼ Card çš„æ¦‚å¿µ<ul><li>å¯ä»¥ç†è§£æˆï¼Œtag æœ¬èº«éƒ½æ˜¯ string ç±»å‹</li><li>tag å¯ä»¥æ„å»ºç´¢å¼•</li></ul></li></ul><p>é‚£ä¹ˆï¼Œå¦‚ä¸Šæ‰€è¿°ï¼ŒInfluxDB çš„ Schema å¦‚ä¸‹è¡¨ç¤ºï¼š</p><p><img src="https://image.mwish.me/blog-image/31928802-5350-4AE7-844F-AF8F1049115A.png" alt="31928802-5350-4AE7-844F-AF8F1049115A"></p><p>ç†è§£äº†ä¸Šé¢çš„ä¸œè¥¿ä¹‹åï¼Œéœ€è¦ç†è§£ <strong>Series</strong> å’Œ <strong>Series Key</strong> è¿™ä¸¤ä¸ªæ¦‚å¿µï¼š</p><p><img src="https://image.mwish.me/blog-image/A06BB0EF-D68C-491A-85C1-574E0DFCAC6F.png" alt="A06BB0EF-D68C-491A-85C1-574E0DFCAC6F"></p><p>å’Œ <strong>Series</strong>: åŒ…å« <strong>timestamp</strong> å’Œ</p><p><img src="https://image.mwish.me/blog-image/5F759A4F-F31C-4855-9FAF-4F1A691E36D8.png" alt="5F759A4F-F31C-4855-9FAF-4F1A691E36D8"></p><p>çœ‹åˆ°æ²¡æœ‰ï¼Œè¿™é‡Œç›¸å½“äºç»Ÿè®¡ä¿¡æ¯ç»™æŠ½å‡ºæ¥äº†ï¼Œä¸€ä¸ª <code>Series Key</code> å¯¹åº”ä¸€ä¸ª <code>Series</code>ï¼Œè€Œè¿™ä¸ª <code>Series</code> æœ‰ç€å¤šä¸ª <code>&lt;Timestamp, Field Value&gt;</code> ç»„ä¸‹é¢æ‰å®šä¹‰åˆ°å…·ä½“çš„ä¿¡æ¯ï¼š</p><p>Point: å¯¹åº”çš„å•ä¸ª <code>Series Key</code> + <code>&lt;Timestamp + Field Value&gt;</code>, å¯ä»¥ç†è§£æˆæ•°æ®åº“çš„ã€Œè¡Œã€ã€‚</p><p>æœ€åï¼Œmeasurement ç±»ä¼¼ RDBMS çš„ <strong>è¡¨</strong>ï¼Œè€Œè¿™é‡Œç»™å‡ºä¸€ä¸ª <code>Bucket</code> çš„æ¦‚å¿µï¼Œå¯ä»¥è®¾ç½®å¤šä¸ª <strong>measurement</strong>ï¼Œå¹¶ä¸”è®¾ç½®ä¸€äº› expire time ä¹‹ç±»çš„æ¡ä»¶ã€‚</p><p>ä»¥ä¸Šå°±æ˜¯ InfluxDB çš„åŸºæœ¬æ¦‚å¿µï¼Œå…·ä½“ä¸€äº› Schema å®šä¹‰å¯ä»¥çœ‹ï¼š<a href="https://docs.influxdata.com/influxdb/v2.1/reference/key-concepts/data-schema/">https://docs.influxdata.com/influxdb/v2.1/reference/key-concepts/data-schema/</a></p><h3 id="Line-Protocol"><a href="#Line-Protocol" class="headerlink" title="Line Protocol"></a>Line Protocol</h3><p>InfluxDB å¯ä»¥ä½¿ç”¨ Line Protocol: <a href="https://github.com/influxdata/influxdb/tree/master/tsdb#line-protocol">https://github.com/influxdata/influxdb/tree/master/tsdb#line-protocol</a></p><h3 id="query-amp-latency"><a href="#query-amp-latency" class="headerlink" title="query &amp; latency"></a>query &amp; latency</h3><p>Timescale ç»™å‡ºäº†ä¸€ä¸ª benchmarkï¼Œæˆ‘è§‰å¾—è¿™ç§ benchmark è‚¯å®šéƒ½æ˜¯è‡ªå·±åŠæ‰“åˆ«äººï¼Œä½†æ˜¯å¯¹è¡¡é‡æ•°é‡çº§æ¥è¯´å¸®åŠ©å¾ˆå¤§ï¼Œå¦‚ä¸‹å›¾ï¼š</p><p><a href="https://www.timescale.com/blog/content/images/2022/01/20200716_Timescale_Blog_InfluxBenchmarks.jpg">https://www.timescale.com/blog/content/images/2022/01/20200716_Timescale_Blog_InfluxBenchmarks.jpg</a></p><p><img src="https://image.mwish.me/blog-image/20200716_Timescale_Blog_InfluxBenchmarks.jpeg" alt="20200716_Timescale_Blog_InfluxBenchmarks"></p><p>å¯ä»¥çœ‹åˆ°ï¼Œå¯¹è¿™ä¸ªçš„æŸ¥è¯¢åŒ…å«ä¸€äº›è¿‘å®æ—¶çš„æŸ¥è¯¢ï¼Œè€Œæ•°æ®å¯èƒ½èƒ½åœ¨ ~100ms å·¦å³çš„æ—¶é—´å®Œæˆä¸€äº›ç®€å•çš„ GroupByã€‚</p><h2 id="Shard"><a href="#Shard" class="headerlink" title="Shard"></a>Shard</h2><blockquote><p>Sharding is the horizontal partitioning of data in a database. Each partition is called shard. InfluxDB stores data in shard groups, which are organized by retention policy and store data with timestamps that fall within a specific time interval. </p></blockquote><p>å› ä¸ºæ—¶åºæ•°æ®åº“æ˜¯ä¸€ä¸ªååˆ†æçš„åœºæ™¯ï¼Œæ‰€ä»¥æŒ‰ç…§æ—¶é—´åˆ†ç‰‡æ˜¯ä¸€ä¸ªç›¸å¯¹è‡ªç„¶çš„ç­–ç•¥ã€‚è¿™ä¸ªåˆ†ç‰‡æœ‰ä¸€ä¸ª RP(Retention Policy)ï¼Œæ˜¯è¯´ä¿ç•™å…·ä½“å†…å®¹çš„æ—¶é—´ã€‚æˆ‘ä»¬éƒ½çŸ¥é“ï¼ŒBucket æœ¬èº«æœ‰ä¸€ä¸ªè¿‡æœŸæ—¶é—´é…ç½®ï¼ŒShard Group ä¼šæŒ‰ç…§ Bucket çš„æ—¶é—´å†åˆ‡ç»†ä¸€ç‚¹ï¼Œåšè¿‡æœŸæ—¶é—´é…ç½®ï¼š</p><p><img src="https://image.mwish.me/blog-image/F0977952-F7E5-464A-9002-58D8C328A9CB.png" alt="F0977952-F7E5-464A-9002-58D8C328A9CB"></p><p>å†å¼€æº InfluxDB ä¸Šï¼Œä¸€ä¸ª Shard Group åªæœ‰ä¸€ä¸ª Shardï¼Œæ„Ÿè§‰å¾ˆæ— åŠ›ï¼š</p><p><img src="https://image.mwish.me/blog-image/A9DA7AAC-234A-4AEE-BA33-85EE761211A9.png" alt="A9DA7AAC-234A-4AEE-BA33-85EE761211A9"></p><p><strong>InfluxDB Enterprise</strong>  åˆ™ä¸ä¸€æ ·ï¼Œå®ƒå¯ä»¥é…ç½® Shard çš„å¤åˆ¶ç­‰åŠŸèƒ½ï¼š<a href="https://docs.influxdata.com/enterprise_influxdb/v1.9/features/clustering-features/#shard-movement">https://docs.influxdata.com/enterprise_influxdb/v1.9/features/clustering-features/#shard-movement</a> ã€‚</p><p>InfluxDB çš„ Cluster ç‰ˆæœ¬ç°åœ¨è®¾è®¡å¦‚ä¸‹ï¼š<a href="https://docs.influxdata.com/enterprise_influxdb/v1.8/concepts/clustering/">https://docs.influxdata.com/enterprise_influxdb/v1.8/concepts/clustering/</a></p><p>replication factor å¦‚æœè®¾ç½®ä¸º <code>X</code>ï¼Œé‚£ä¹ˆä¸€ä¸ª <code>N</code> ä¸ª Data Node çš„é›†ç¾¤ä¼šé…ç½® <code>floor(N/X)</code> ä¸ª <code>Shard</code>ï¼Œç„¶åè¿™é‡Œä¼šä¿è¯æ¯ä¸ªå‡ ä¹æœºå™¨éƒ½ä¼šè¢«å¤åˆ¶è¿™äº›ä¸œè¥¿ï¼š</p><blockquote><p>For example we have a shard group for <code>2016-09-19</code> that has two shards <code>1</code> and <code>2</code>. Shard <code>1</code> is replicated to servers <code>A</code> and <code>B</code> while shard <code>2</code> is copied to servers <code>C</code> and <code>D</code>.</p></blockquote><p>(æˆ‘ä¹Ÿä¸çŸ¥é“ä¸ºä»€ä¹ˆè¿™ä¹ˆè®¾è®¡ï¼Œæœ‰äººå¯ä»¥å‘Šè¯‰æˆ‘å—ï¼Ÿ)</p><p>è¿™é‡Œä¼šæ ¹æ® <code>hash</code> æŒ‘é€‰å†™å…¥çš„ shardï¼Œæ¥åšçƒ­ç‚¹å†™æ‰“æ•£ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// key is measurement + tagset</span></span><br><span class="line"><span class="comment">// shardGroup is the group for the values based on timestamp</span></span><br><span class="line"><span class="comment">// hash with fnv and then bucket</span></span><br><span class="line">shard := shardGroup.shards[fnv.New64a(key) % <span class="built_in">len</span>(shardGroup.Shards)]</span><br></pre></td></tr></table></figure><p>å†™å…¥çš„æ—¶å€™ï¼Œå¯ä»¥é…ç½® write-consistencyï¼Œä¸è¿‡æˆ‘æ„Ÿè§‰åŸºæœ¬éƒ½æ˜¯ RWN éƒ½ä¸ç®—çš„ç®€å•åŒæ­¥å¤åˆ¶çš„å˜ç§ï¼š<a href="https://docs.influxdata.com/enterprise_influxdb/v1.8/concepts/clustering/#write-consistency">https://docs.influxdata.com/enterprise_influxdb/v1.8/concepts/clustering/#write-consistency</a></p><p>è¿™é‡Œè¿˜æœ‰ä¸ª hinted handoffï¼Œå’Œ Dynamo é‚£å¥—ä¸€æ ·ï¼Œéƒ½æ˜¯æ•…éšœæ—¶å†™é¡ºå»¶ã€‚</p><h3 id="Compaction-amp-Deletion"><a href="#Compaction-amp-Deletion" class="headerlink" title="Compaction &amp; Deletion"></a>Compaction &amp; Deletion</h3><p>å› ä¸ºçƒ­ç‚¹æ˜¯å†™ä¼˜åŒ–çš„ï¼Œæ‰€ä»¥æŸä¸ª ShardGroup å†ä¸ä¼šå†™ä¹‹åï¼Œç›¸å¯¹æ¥è¯´ä¼šå˜æˆå†·çš„ï¼Œå¯ä»¥åˆ‡æˆä¸€äº›è¯»ä¼˜åŒ–ã€çœç©ºé—´çš„ç»“æ„ã€‚è€Œ Shard Group æœ¬èº«ä¹Ÿä¼šè¿‡æœŸï¼Œæ‰€ä»¥æ˜¯éœ€è¦åˆ é™¤çš„ã€‚</p><h2 id="ä¸€äº›-Schema-ç›¸å…³çš„è®¨è®º"><a href="#ä¸€äº›-Schema-ç›¸å…³çš„è®¨è®º" class="headerlink" title="ä¸€äº› Schema ç›¸å…³çš„è®¨è®º"></a>ä¸€äº› Schema ç›¸å…³çš„è®¨è®º</h2><p><a href="https://docs.influxdata.com/enterprise_influxdb/v1.9/concepts/schema_and_data_layout/">https://docs.influxdata.com/enterprise_influxdb/v1.9/concepts/schema_and_data_layout/</a></p><p>åŸºæœ¬ä¸Šæ˜¯åœ¨æ•™ä½ ã€Œæ€ä¹ˆç”¨æˆ‘ä»¬çš„æ•°æ®åº“ã€ã€‚</p><h2 id="å­˜å‚¨å¼•æ“-TSM-Time-Structured-Merge-Tree"><a href="#å­˜å‚¨å¼•æ“-TSM-Time-Structured-Merge-Tree" class="headerlink" title="å­˜å‚¨å¼•æ“: TSM(Time-Structured Merge Tree)"></a>å­˜å‚¨å¼•æ“: TSM(Time-Structured Merge Tree)</h2><p>æ¯ä¸€ä¸ª Shard éƒ½åŒ…å«ç€ WAL å’Œ TSM æ–‡ä»¶ï¼Œè¿™ç±»ä¼¼ LSM çš„ WSL å’Œ SSTableã€‚TSM å­˜å‚¨å¼•æ“åŒ…å«ï¼š</p><ol><li>å†…å­˜ç´¢å¼•ï¼š<strong>è·¨ Shards å…±äº«</strong>ï¼Œæä¾›å¯¹ <code>measurements</code>ã€<code>tags</code> å’Œ <code>series</code> çš„å¿«é€Ÿè®¿é—®ã€‚<em>è¿™ä¸ªå¯èƒ½ä¼šæŒä¹…åŒ–æˆä¸‹é¢çš„ TSIã€‚</em></li><li>WALï¼šShard çš„å†™å…¥ä¼˜åŒ–æ ¼å¼</li><li>Cacheï¼šå¯¹ TSM çš„ WAL ç¼“å­˜ï¼Œç±»ä¼¼ LevelDB/RocksDB çš„ MemTableï¼ˆæˆ‘ä¸€çœ¼ä»¥ä¸ºæ˜¯ BlockCacheï¼‰</li><li>TSM Files: ç±»ä¼¼ SSTableï¼Œä½†ç€é‡äºåˆ—å¼ã€å‹ç¼©çš„æ ¼å¼</li><li>FileStore: TSM Files çš„ Managerï¼Œæ§åˆ¶æ–‡ä»¶å±‚é¢çš„å¢åˆ è®¿</li><li>Compactor/Compactor Planner: å‹ç¼©ç›¸å…³ã€‚è¿™é‡Œæ˜¯å¸Œæœ›æŠŠæ•°æ®è½¬æˆæ›´è¯»å‹å¥½çš„å½¢å¼</li><li>Compression: å› ä¸ºæ˜¯åˆ—å¼æ•°æ®ï¼Œæ‰€ä»¥éœ€è¦ç‰¹å®šçš„å‹ç¼©ã€‚æœ‰çš„ Pattern æ˜¯å›ºå®šçš„å‹ç¼©æ–¹å¼ï¼Œæœ‰çš„ Pattern åˆ™æ˜¯æ ¹æ®æ•°æ®åˆ†å¸ƒæ¥å‹ç¼©çš„ã€‚</li></ol><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¯¹å¼•æ“çš„å†™å…¥æ˜¯ Batch å†™å…¥çš„ï¼Œå¯èƒ½ç”¨æˆ·çš„å®¢æˆ·ç«¯/agentä¼š Batch é‡‡æ ·æ•°æ®è¿‡æ¥ï¼Œç„¶åå¾€çƒ­çš„ <code>Shard Group</code> å†™æ•°æ®ã€‚</p><h3 id="WAL"><a href="#WAL" class="headerlink" title="WAL"></a>WAL</h3><p>å½“å†™å…¥è¯·æ±‚è¿‡æ¥çš„æ—¶å€™ï¼Œä¼šå…ˆå¾€ WAL é‡Œé¢å†™å…¥ã€‚WAL ä»¥ 10MB ä¸ºä¸€ä¸ª <code>Segment</code>ï¼Œç„¶åæ‰¹é‡å‹ç¼©å†™å…¥ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š<a href="https://github.com/influxdata/influxdb/blob/master/tsdb/engine/tsm1/wal.go#L705-L722">https://github.com/influxdata/influxdb/blob/master/tsdb/engine/tsm1/wal.go#L705-L722</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">// The entries values are encode as follows:</span><br><span class="line">//</span><br><span class="line">// For each key and slice of values, first a 1 byte type for the []Values</span><br><span class="line">// slice is written.  Following the type, the length and key bytes are written.</span><br><span class="line">// Following the key, a 4 byte count followed by each value as a 8 byte time</span><br><span class="line">// and N byte value.  The value is dependent on the type being encoded.  float64,</span><br><span class="line">// int64, use 8 bytes, boolean uses 1 byte, and string is similar to the key encoding,</span><br><span class="line">// except that string values have a 4-byte length, and keys only use 2 bytes.</span><br><span class="line">//</span><br><span class="line">// This structure is then repeated for each key an value slices.</span><br><span class="line">//</span><br><span class="line">// â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">// â”‚                           WriteWALEntry                            â”‚</span><br><span class="line">// â”œâ”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”¤</span><br><span class="line">// â”‚ Type â”‚ Key Len â”‚   Key  â”‚ Count â”‚  Time   â”‚  Value  â”‚...â”‚ Type â”‚...â”‚</span><br><span class="line">// â”‚1 byteâ”‚ 2 bytes â”‚ N bytesâ”‚4 bytesâ”‚ 8 bytes â”‚ N bytes â”‚   â”‚1 byteâ”‚   â”‚</span><br><span class="line">// â””â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”˜</span><br></pre></td></tr></table></figure><p>æ•´ä¸ª Batch åœ¨ç»„ç»‡æˆå¦‚ä¸Šæ ¼å¼ä¹‹åï¼Œåœ¨å†™å…¥çš„æ—¶å€™è¿˜ä¼šè¢« snappy å‹ç¼©ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">b, err := entry.Encode(bytes)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">bytesPool.Put(bytes)</span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span>, err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">encBuf := bytesPool.Get(snappy.MaxEncodedLen(<span class="built_in">len</span>(b)))</span><br><span class="line"></span><br><span class="line">compressed := snappy.Encode(encBuf, b)</span><br></pre></td></tr></table></figure><p>æ–‡æ¡£ä¸Šæ˜¾ç¤ºï¼Œå•å°æœºå™¨ä¸Šï¼Œæ¯ä¸ª <code>Shard</code> éƒ½ä¼šæœ‰ä¸€ä¸ª WAL æµï¼ŒInfluxDB è‡´åŠ›äºå°†å…¶æ”¹æˆåŒä¸€ä¸ª WAL æµã€‚</p><h3 id="Cache"><a href="#Cache" class="headerlink" title="Cache"></a>Cache</h3><blockquote><p>The Cache is an in-memory copy of all data points current stored in the WAL. The points are organized by the key, which is the measurement, <a href="https://docs.influxdata.com/enterprise_influxdb/v1.9/concepts/glossary/#tag-set">tag set</a>, and unique <a href="https://docs.influxdata.com/enterprise_influxdb/v1.9/concepts/glossary/#field">field</a>. Each field is kept as its own time-ordered range. The Cache data is not compressed while in memory.</p></blockquote><p>è¿™é‡Œæä¾›åŒä¸€ç§ç±»å‹çš„å¿«é€Ÿè®¿é—®. çœ‹å®é™…ä»£ç ï¼Œ<code>Cache</code> ä¼šæŠŠå®é™…å­˜å‚¨ dispatch åˆ°ä¸€ä¸ªå« <code>ring</code> çš„ç»“æ„ä½“ä¸Šã€‚è¿™æ˜¯ä¸€ä¸ª Bucket + Concurrency Hash Mapï¼Œé€»è¾‘å¤§æ¦‚å¦‚ä¸‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ring is a structure that maps series keys to entries.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// ring is implemented as a crude hash ring, in so much that you can have</span></span><br><span class="line"><span class="comment">// variable numbers of members in the ring, and the appropriate member for a</span></span><br><span class="line"><span class="comment">// given series key can always consistently be found. Unlike a true hash ring</span></span><br><span class="line"><span class="comment">// though, this ring is not resizeableâ€”there must be at most 16 members in the</span></span><br><span class="line"><span class="comment">// ring, and the number of members must always be a power of 2.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// ring works as follows: Each member of the ring contains a single store, which</span></span><br><span class="line"><span class="comment">// contains a map of series keys to entries. A ring always has 16 partitions,</span></span><br><span class="line"><span class="comment">// and a member takes up one or more of these partitions (depending on how many</span></span><br><span class="line"><span class="comment">// members are specified to be in the ring)</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// To determine the partition that a series key should be added to, the series</span></span><br><span class="line"><span class="comment">// key is hashed and the first 8 bits are used as an index to the ring.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="keyword">type</span> ring <span class="keyword">struct</span> &#123;</span><br><span class="line"><span class="comment">// The unique set of partitions in the ring.</span></span><br><span class="line"><span class="comment">// len(partitions) &lt;= len(continuum)</span></span><br><span class="line">partitions []*partition</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *ring)</span></span> split(n <span class="type">int</span>) []storer &#123;</span><br><span class="line">storers := <span class="built_in">make</span>([]storer, n)</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; n; i++ &#123;</span><br><span class="line">storers[i], _ = newring(<span class="built_in">len</span>(r.partitions))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i, p := <span class="keyword">range</span> r.partitions &#123;</span><br><span class="line">r := storers[i%n].(*ring)</span><br><span class="line">r.partitions[i] = p</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> storers</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// partition provides safe access to a map of series keys to entries.</span></span><br><span class="line"><span class="keyword">type</span> partition <span class="keyword">struct</span> &#123;</span><br><span class="line">mu    sync.RWMutex</span><br><span class="line">store <span class="keyword">map</span>[<span class="type">string</span>]*entry</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ³¨æ„ <code>store</code> å­˜å‚¨çš„ <code>map[string]*entry</code>ï¼Œè¿™é‡Œå®é™…ä¸Šæ˜¯ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// entry is a set of values and some metadata.</span></span><br><span class="line"><span class="keyword">type</span> entry <span class="keyword">struct</span> &#123;</span><br><span class="line">mu     sync.RWMutex</span><br><span class="line">values Values <span class="comment">// All stored values.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// The type of values stored. Read only so doesn&#x27;t need to be protected by</span></span><br><span class="line"><span class="comment">// mu.</span></span><br><span class="line">vtype <span class="type">byte</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ª <code>Values</code> å°±æ˜¯å‰é¢ WAL å†™çš„æ—¶å€™é‚£ä¸ªï¼Œæ˜¯ä¸æ˜¯ä¸€åˆ‡éƒ½è¿èµ·æ¥äº†ï¼</p><h3 id="TSM-æ–‡ä»¶"><a href="#TSM-æ–‡ä»¶" class="headerlink" title="TSM æ–‡ä»¶"></a>TSM æ–‡ä»¶</h3><p>TSM æ–‡ä»¶ç±»ä¼¼ LSM çš„ SSTableï¼ŒåŒ…å«ä¸‹é¢å‡ ä¸ªåŒºåŸŸï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">+--------+------------------------------------+-------------+--------------+</span><br><span class="line">| Header |               Blocks               |    Index    |    Footer    |</span><br><span class="line">|5 bytes |              N bytes               |   N bytes   |   4 bytes    |</span><br><span class="line">+--------+------------------------------------+-------------+--------------+</span><br><span class="line"></span><br><span class="line">+--------------------------------------------------------------------+</span><br><span class="line">â”‚                           Blocks                                   â”‚</span><br><span class="line">+---------------------+-----------------------+----------------------+</span><br><span class="line">|       Block 1       |        Block 2        |       Block N        |</span><br><span class="line">+---------------------+-----------------------+----------------------+</span><br><span class="line">|   CRC    |  Data    |    CRC    |   Data    |   CRC    |   Data    |</span><br><span class="line">| 4 bytes  | N bytes  |  4 bytes  | N bytes   | 4 bytes  |  N bytes  |</span><br><span class="line">+---------------------+-----------------------+----------------------+</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">+-----------------------------------------------------------------------------+</span><br><span class="line">â”‚                                   Index                                     â”‚</span><br><span class="line">+-----------------------------------------------------------------------------+</span><br><span class="line">â”‚ Key Len â”‚   Key   â”‚ Type â”‚ Count â”‚Min Time â”‚Max Time â”‚ Offset â”‚  Size  â”‚...â”‚</span><br><span class="line">â”‚ 2 bytes â”‚ N bytes â”‚1 byteâ”‚2 bytesâ”‚ 8 bytes â”‚ 8 bytes â”‚8 bytes â”‚4 bytes â”‚   â”‚</span><br><span class="line">+-----------------------------------------------------------------------------+</span><br><span class="line"></span><br><span class="line">+--------------------------------------------------+</span><br><span class="line">| Type  |  Len  |   Timestamps    |      Values    |</span><br><span class="line">|1 Byte | VByte |     N Bytes     |    N Bytes     â”‚</span><br><span class="line">+--------------------------------------------------+</span><br></pre></td></tr></table></figure><p>è¯¦ç»†è§ï¼š<a href="https://docs.influxdata.com/influxdb/v1.8/concepts/storage_engine/">https://docs.influxdata.com/influxdb/v1.8/concepts/storage_engine/</a></p><p>éœ€è¦æ³¨æ„ TSM å’Œ SSTable çš„åŒºåˆ«ï¼š</p><ol><li>å•ä¸ª Block é‡Œé¢åªæœ‰åŒä¸€ä¸ª Series Keyï¼Œé‡Œé¢çš„ç±»å‹æ˜¯ç›¸åŒçš„ï¼Œå¯ä»¥ç”¨ Column Compression æ¥å¤„ç†ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œå®ƒè¿˜æœ‰ Timestamps åŒºæ®µã€‚</li><li>ä¸åŒçš„ Block å¯èƒ½æ‹¥æœ‰ç›¸åŒçš„ Series Key</li><li>Series Key æŒ‰é¡ºåºæ’æ”¾</li></ol><h3 id="Compaction"><a href="#Compaction" class="headerlink" title="Compaction"></a>Compaction</h3><ol><li>å†…å­˜æ‹¿åˆ° Snapshotï¼Œç„¶å Compact åˆ°æ–‡ä»¶ä¸Š</li><li>Level Compaction: ç±»ä¼¼ LevelDB</li><li>Index Optimization: engine å±‚å¥½åƒä¸åšè¿™ä¸ªï¼Œæ–‡æ¡£ä¸Šå†™çš„æ˜¯ Level4 å¤§é‡å †ç§¯ä¹‹åï¼Œæ‹†åˆ†åˆ°ä¸€ä¸ªå­˜å‚¨/è¯»å‡ä¼˜åŒ–çš„ç»“æ„ã€‚</li><li>Full Compaction</li></ol><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œå¾ˆé¸¡è´¼ï¼Œè¯´æ˜¯ Level Compactionï¼Œå®é™…ä¸Šæ˜¯ Tiered Compaction. çƒ­æ–‡ä»¶æ˜¯å¤šå†™å°‘è¯»çš„ï¼Œå¯ä»¥ç†è§£ï¼Œæœ€åæ•°æ®å†·äº†åº”è¯¥å¯ä»¥ Full Compaction æˆ–è€… Index Optimizationï¼Œåšæˆè¯»ä¼˜åŒ–çš„ç»“æ„ã€‚</p><h3 id="Write-Update-Delete-Query"><a href="#Write-Update-Delete-Query" class="headerlink" title="Write / Update / Delete / Query"></a>Write / Update / Delete / Query</h3><p>è¿™é‡Œç€é‡éœ€è¦ç†è§£ Deleteã€‚Write è¿™è¾¹ä¼šå…ˆè¿› Cacheï¼Œç„¶åç­‰å¾… <code>WriteSnapshot</code> è¿›è¡Œã€‚Update å°±ç›´æ¥æ›´æ–°ï¼Œç­‰ Compaction æ“ä½œï¼Œå› ä¸ºè¿™è¾¹ä¼šå…ˆè¯»ä¸Šé¢å†è¯»ä¸‹é¢ã€‚Delete çš„æµç¨‹å¾ˆè¯¡å¼‚ï¼Œè¿™é‡Œä¼šç»™å†…å­˜åˆ é™¤ï¼Œç„¶åç»™æ¯ä¸ªæœ‰è¿™ä¸ª key çš„æ–‡ä»¶å†™ä¸€ä¸ª Tombstone æ–‡ä»¶ã€‚è¯»çš„æ—¶å€™åš Mergeï¼Œæ„Ÿè§‰ä»–è¿™ä¸ªå¯¹æ›´æ–°å’Œåˆ é™¤å°±ä¸æ˜¯å¾ˆå‹å¥½ã€‚</p><p>æŸ¥è¯¢è¿™è¾¹å…¶å®å°±ç±»ä¼¼ LevelDB æŸ¥è¯¢äº†ã€‚ä¸è¿‡æˆ‘å¥½åƒæ²¡å¤ªçœ‹åˆ°ä¸€äº›ç®—å­ä¸‹æ¨çš„æ“ä½œï¼Œæ„Ÿè§‰å¯¹ AP Workload æ”¯æŒä¸€èˆ¬èˆ¬ï¼Ÿ</p><h3 id="å…³é”®è·¯å¾„ä»£ç "><a href="#å…³é”®è·¯å¾„ä»£ç " class="headerlink" title="å…³é”®è·¯å¾„ä»£ç "></a>å…³é”®è·¯å¾„ä»£ç </h3><p>å†™å…¥å…¥å£, ä¼šæŠŠè¯·æ±‚åˆ†å‘åˆ° <code>Cache</code> å’Œ <code>WAL</code></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// WritePoints writes metadata and point data into the engine.</span></span><br><span class="line"><span class="comment">// It returns an error if new points are added to an existing key.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e *Engine)</span></span> WritePoints(ctx context.Context, points []models.Point) <span class="type">error</span></span><br></pre></td></tr></table></figure><p><code>CompactCache</code> ä¼šå®Œæˆ WAL -&gt; TSM, è¿™é‡Œè°ƒç”¨ <code>WriteSnapshot</code> åš ç±»ä¼¼ Major Compaction çš„æ“ä½œï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// compactCache continually checks if the WAL cache should be written to disk.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e *Engine)</span></span> compactCache()</span><br><span class="line"></span><br><span class="line"><span class="comment">// WriteSnapshot writes a Cache snapshot to one or more new TSM files.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Compactor)</span></span> WriteSnapshot(cache *Cache, logger *zap.Logger) ([]<span class="type">string</span>, <span class="type">error</span>) </span><br></pre></td></tr></table></figure><p>è€Œä¸‹åˆ—ä¼šæ„å»º TSM å…·ä½“çš„ Blocks, ä¹ŸåŒ…å«äº†ç›¸åŒç±»å‹åˆ—çš„ Compressionã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *cacheKeyIterator)</span></span> encode()</span><br></pre></td></tr></table></figure><p>Compact å…³æ³¨ï¼š</p><p>æœ€ä¸Šå±‚è§¦å‘åœ¨ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e *Engine)</span></span> compact(wg *sync.WaitGroup)</span><br></pre></td></tr></table></figure><p>ä¸‹é¢é€»è¾‘ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CompactFull writes multiple smaller TSM files into 1 or more larger files.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Compactor)</span></span> CompactFull(tsmFiles []<span class="type">string</span>, logger *zap.Logger) ([]<span class="type">string</span>, <span class="type">error</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// CompactFast writes multiple smaller TSM files into 1 or more larger files.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Compactor)</span></span> CompactFast(tsmFiles []<span class="type">string</span>, logger *zap.Logger) ([]<span class="type">string</span>, <span class="type">error</span>) </span><br><span class="line"></span><br><span class="line"><span class="comment">// writeNewFiles writes from the iterator into new TSM files, rotating</span></span><br><span class="line"><span class="comment">// to a new file once it has reached the max TSM file size.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Compactor)</span></span> writeNewFiles(generation, sequence <span class="type">int</span>, src []<span class="type">string</span>, iter KeyIterator, throttle <span class="type">bool</span>, logger *zap.Logger) ([]<span class="type">string</span>, <span class="type">error</span>)</span><br></pre></td></tr></table></figure><h2 id="ç´¢å¼•-TSI-Time-Series-Index"><a href="#ç´¢å¼•-TSI-Time-Series-Index" class="headerlink" title="ç´¢å¼•: TSI (Time Series Index)"></a>ç´¢å¼•: TSI (Time Series Index)</h2><p>InfluxDB æœ‰ä¸€ä¸ª <code>Series Cardinality</code> çš„æ¦‚å¿µï¼Œå…¶å®å¾ˆå¥½ç†è§£ã€‚å›é¡¾ä¸€ä¸‹ï¼Œ<code>Series Key</code> ç»„æˆæ˜¯ï¼š</p><p><img src="https://image.mwish.me/blog-image/A5A862C7-9674-4364-82D2-E122BF5F644A.png" alt="A5A862C7-9674-4364-82D2-E122BF5F644A"></p><p>è¿™é‡Œæˆ‘ä»¬ä¼šå‘ç°ï¼Œå¯¹äº <code>email</code> å’Œ <code>status</code> è¿™ä¸¤ä¸ª tagï¼Œè¿™ä¸ª tag æˆ‘ä»¬è™½ç„¶æ”¯æŒä¸€å † string å½¢å¼çš„ keyï¼Œä½†æ˜¯å®ƒçš„é€‰æ‹©ç©ºé—´å¯èƒ½ä¸æ˜¯å¾ˆå¤§ï¼Œè¿™é‡Œæä¾›äº†ä¸€å®šçš„ä¼˜åŒ–ç©ºé—´ã€‚åŒæ—¶ï¼Œå¦‚æœ <code>Series Key</code> æ•°é‡å¾ˆå¤šï¼Œé‚£è¿™ä¸ªå¯èƒ½ä¼šç”Ÿæˆè¿‡å¤šéœ€è¦æŸ¥è¯¢çš„ Indexï¼Œè¿™ç»™ç³»ç»Ÿå¸¦æ¥äº†å¾ˆå¤§å¼€é”€ã€‚</p><p>è¿˜æœ‰ä¸€ç§åœºæ™¯ï¼Œå¦‚ä¸Šï¼ŒæŒ‡å®š <code>status = start</code>ï¼Œä¸æŒ‡å®š emailï¼Œä¹Ÿæ€»å¾— AP å§ï¼Œè¿™é‡Œå¤„ç†å°±å¾—æ‰«ä¸€å † TSM çš„ Index äº†ã€‚</p><p>è¿™ä¸ªåœ°æ–¹ï¼Œè¿™é‡Œæä¾›äº†åå‘ç´¢å¼•ï¼Œå®ƒå¯¹ <code>&lt;measurement, tag set&gt;</code> ä¸­ <code>measurement</code> å’Œ Tag çš„ä»»æ„ä¸€é¡¹åˆ° Series Key æä¾›äº†æ˜ å°„ã€‚å®ƒä¹Ÿæ˜¯ä¸€ä¸ªæœ‰åºç»“æ„ã€‚å®ƒçš„ç›®çš„å¦‚ä¸‹ï¼š</p><blockquote><p>The goal is that the number of series should be unbounded by the amount of memory on the server hardware. Importantly, the number of series that exist in the database will have a negligible impact on database startup time.</p></blockquote><p>å¯ä»¥çœ‹åˆ°ï¼ŒTSI å¤§æ¦‚æœ‰è¿™å‡ ç§ç±»å‹ï¼š</p><ul><li><strong>Index</strong>: TSI instanceï¼Œå•ä¸ª Shard ä¼šæœ‰ä¸€ä¸ª Index</li><li><strong>Partition</strong>: Index å†…éƒ¨ä¼šåˆ†æˆå¤šä¸ª <strong>Partition</strong>ï¼Œæ¥åš IO å’Œå¹¶å‘ã€‚æ¯ä¸ª Partition ä¼šå¯¹åº”ä¸åŒçš„å­˜å‚¨æ–‡ä»¶ã€‚</li><li><strong>LogFile</strong>: TSI çš„æ—¥å¿—æ–‡ä»¶</li><li><strong>IndexFile</strong>: TSI æœ€é‡è¦çš„éƒ¨åˆ†ä¹‹ä¸€ï¼Œè¡¨ç¤ºå¯¹åº”çš„å®é™…ç´¢å¼•</li></ul><p>Partition è¿™ä¸ªæ¦‚å¿µå¾ˆè®©äººå›°æƒ‘ã€‚å®é™…ä¸Šè¿™æ˜¯ä¸ªå†™å…¥ä¼˜åŒ–çš„æªæ–½ã€‚å†™å…¥çš„æ—¶å€™ï¼Œåˆ©ç”¨ Partition æ¥åšå¹¶è¡ŒåŒ–ï¼Œè¯»å–çš„æ—¶å€™ï¼Œéœ€è¦ä»æ¯ä¸ª Partition æ¥ PointGetï¼Œæˆ–è€… Merge Partition çš„ç»“æœã€‚æˆ‘ä¸ªäººæ„Ÿè§‰è¿™ä¸œè¥¿ç¨å¾®æœ‰ç‚¹è¿‡åº¦è®¾è®¡äº†â€¦</p><p>å¯ä»¥çœ‹åˆ°ï¼Œå®ƒå¯¹å¤–æä¾›äº†ä¸‹åˆ—æ¥å£ï¼ˆå®é™…ä¸Šæ˜¯ <code>tsdb/index.go</code> çš„ <code>Index</code> è¿™ä¸ª interfaceï¼ŒTSM å†…å­˜é‚£èŠ‚æœ‰ä¸ªç±»ä¼¼çš„ï¼‰ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ForEachMeasurementName iterates over all measurement names in the index,</span></span><br><span class="line"><span class="comment">// applying fn. It returns the first error encountered, if any.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// ForEachMeasurementName does not call fn on each partition concurrently so the</span></span><br><span class="line"><span class="comment">// call may provide a non-goroutine safe fn.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(i *Index)</span></span> ForEachMeasurementName(fn <span class="function"><span class="keyword">func</span><span class="params">(name []<span class="type">byte</span>)</span></span> <span class="type">error</span>) <span class="type">error</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// MeasurementExists returns true if a measurement exists.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(i *Index)</span></span> MeasurementExists(name []<span class="type">byte</span>) (<span class="type">bool</span>, <span class="type">error</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// MeasurementHasSeries returns true if a measurement has non-tombstoned series.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(i *Index)</span></span> MeasurementHasSeries(name []<span class="type">byte</span>) (<span class="type">bool</span>, <span class="type">error</span>)</span><br><span class="line"></span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>å’Œå†™å…¥ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CreateSeriesIfNotExists creates a series if it doesn&#x27;t exist or is deleted.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(i *Index)</span></span> CreateSeriesIfNotExists(key, name []<span class="type">byte</span>, tags models.Tags) <span class="type">error</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// CreateSeriesListIfNotExists creates a list of series if they doesn&#x27;t exist in bulk.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(i *Index)</span></span> CreateSeriesListIfNotExists(keys [][]<span class="type">byte</span>, names [][]<span class="type">byte</span>, tagsSlice []models.Tags) <span class="type">error</span></span><br></pre></td></tr></table></figure><p>å¯¹äºä»»ä½•å†™å…¥ï¼Œè¿™è¾¹ä¼šå†…å­˜æœ‰å„ç§ mappingï¼Œå†™ WALã€‚æœ€åæ„å»ºæˆ TSI Fileï¼Œæ ¼å¼å‚ç…§ï¼š<a href="https://github.com/influxdata/influxdb/blob/master/tsdb/index/tsi1/doc.go#L65">https://github.com/influxdata/influxdb/blob/master/tsdb/index/tsi1/doc.go#L65</a> ï¼Œåˆ†ä¸ºï¼š</p><ul><li>Series Block: å­˜æ”¾äº†æ‰€æœ‰ Series Keyï¼Œç”¨ Hash Index æ¥åŠ é€Ÿ</li><li>Tag Block: å­˜æ”¾äº† Tag Key, Tag Value åˆ° Series Key çš„æ˜ å°„ï¼Œå¯èƒ½æœ‰å¤šä¸ª Block</li><li>Measurement Block: å­˜æ”¾ Measurement çš„æ˜ å°„</li></ul><p>æ³¨æ„ï¼Œè¿™ä¸­é—´è¿˜æœ‰ key çš„ HashMapï¼Œæ¥åŠ é€ŸæŸ¥æ‰¾ã€‚åŒæ—¶ï¼Œè¿™é‡Œæœ‰åˆå¹¶å¤šä¸ª TSI çš„éœ€æ±‚ï¼Œè¿™é‡Œä¼šå†™å…¥ HLL++ï¼Œå¹¶è®°å½• key å’Œåˆ é™¤çš„ keyï¼Œå½“åˆå¹¶çš„æ—¶å€™ï¼Œå¯ä»¥æ ¹æ® HLL è®¡ç®—å‡ºå¤§æ¦‚çš„ç»“æœå’Œç©ºé—´æ”¾å¤§ï¼Œæ¥è°ƒåº¦ Compactionã€‚</p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://github.com/influxdata/influxdb/tree/master/tsdb">https://github.com/influxdata/influxdb/tree/master/tsdb</a></p><ul><li>TSIï¼š <a href="https://github.com/influxdata/influxdb/tree/master/tsdb/index">https://github.com/influxdata/influxdb/tree/master/tsdb/index</a> <ul><li>æ–‡æ¡£ï¼š<a href="https://github.com/influxdata/influxdb/blob/master/tsdb/index/tsi1/doc.go">https://github.com/influxdata/influxdb/blob/master/tsdb/index/tsi1/doc.go</a></li></ul></li><li>TSMï¼š<a href="https://github.com/influxdata/influxdb/tree/master/tsdb/engine">https://github.com/influxdata/influxdb/tree/master/tsdb/engine</a><ul><li>æ–‡æ¡£ï¼š<a href="https://github.com/influxdata/influxdb/blob/master/tsdb/engine/tsm1/DESIGN.md">https://github.com/influxdata/influxdb/blob/master/tsdb/engine/tsm1/DESIGN.md</a></li></ul></li><li>ä¸€äº›åè®®ï¼š<a href="https://github.com/influxdata/influxdb/blob/master/tsdb/internal/fieldsindex.proto">https://github.com/influxdata/influxdb/blob/master/tsdb/internal/fieldsindex.proto</a></li><li>å®˜æ–¹ä¸€äº› detail æ–‡æ¡£ï¼š<a href="https://docs.influxdata.com/enterprise_influxdb/v1.9/concepts/time-series-index/">https://docs.influxdata.com/enterprise_influxdb/v1.9/concepts/time-series-index/</a></li></ul><p>åšå®¢ï¼š</p><ul><li>è¿™é‡Œæœ‰ä¸€ç³»åˆ—åšå®¢ï¼Œç®€ä¸­å¤§éƒ¨åˆ† InfluxDB çš„äºŒæ‰‹æ–‡æ¡£åŸºæœ¬éƒ½å‚è€ƒäº†è¿™ä¸ªï¼š <a href="http://hbasefly.com/2017/12/08/influxdb-1/">http://hbasefly.com/2017/12/08/influxdb-1/</a> </li><li>Compaction çœ‹ä»£ç çœ‹çš„æˆ‘æœ‰ç‚¹ç‚¹æ™•ï¼Œå‚è€ƒäº†ï¼š<a href="https://www.jianshu.com/p/601d97507c0f">https://www.jianshu.com/p/601d97507c0f</a></li></ul>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Dapper and Tracing</title>
      <link href="/2022/03/02/Dapper-and-Tracing/"/>
      <url>/2022/03/02/Dapper-and-Tracing/</url>
      
        <content type="html"><![CDATA[<h1 id="Dapper"><a href="#Dapper" class="headerlink" title="Dapper"></a>Dapper</h1><p>Dapper æ„Ÿè§‰æœ€æ—©æ˜¯ Google çš„è¿½è¸ªç³»ç»Ÿã€‚å®é™…ç³»ç»Ÿçš„é“¾è·¯ä¼šéå¸¸é•¿ï¼Œä»ä¸Šæ¸¸å‘èµ·ä¸€ä¸ªæœç´¢ï¼Œåˆ°ä¸‹æ¸¸è¿è¡Œï¼Œä¸‹æ¸¸å¯èƒ½åˆæ˜¯ä¸ªåˆ†å¸ƒå¼è¯·æ±‚ã€‚å¦‚æœæœ€ç»ˆç»“æœæ˜¯ä¸Šæ¸¸å‡ºç°æ»¡è¯·æ±‚/é—®é¢˜ï¼Œéœ€è¦èƒ½å¤Ÿæ‰¾åˆ°å¯¹åº”çš„é€‰é¡¹ã€‚æœ¬èº«è¯·æ±‚çš„ç›‘æ§æ˜¯æœ‰ç”¨çš„ï¼Œé€šè¿‡ç›‘æ§ï¼Œå¼€å‘è€…èƒ½å¤ŸçŸ¥é“æ¯ä¸ªé˜¶æ®µå¤§æ¦‚çš„è€—æ—¶ã€‚ä½†å¯¹äºå¶ç°çš„æŸ¥è¯¢ï¼Œå¯èƒ½æ— æ³•æ‰¾åˆ°å¯¹åº”çš„è€—æ—¶æ¥æºï¼Œéœ€è¦å…·ä½“çš„è¯·æ±‚-é˜¶æ®µè€—æ—¶ã€‚</p><p>è¿™é‡Œè¿˜æœ‰ä¸ªé—®é¢˜ï¼Œå°±æ˜¯å®šä½åˆ°çš„ç»“æœä¹Ÿè¦åˆ†é”…ä»€ä¹ˆçš„ï¼Œæ…¢åªæ˜¯ä¸€ä¸ªç»“æœã€‚å¯èƒ½æŸä¸ªç³»ç»Ÿå¤šç§Ÿæˆ·æ²¡åšå¥½ï¼Œç„¶åæ¥ä¸ªå‚»é€¼ç”¨æˆ·æ‰“ä¸€å † AP è¯·æ±‚è¿‡æ¥ï¼ŒæŠŠåˆ«çš„åœ°æ–¹çš„è¯·æ±‚ææ…¢äº†ã€‚è¿™äº›åœ°æ–¹ä¹Ÿè¦æ ¹æ® tracing ä¹‹ç±»çš„æ¥åˆ†é”…ã€‚</p><p>ç«Ÿç„¶è¦åˆ†é”…ï¼Œè¿™é‡Œæš—å«äº†å‡ ä»¶äº‹ï¼š</p><ol><li>è¿™ä¸ªç³»ç»Ÿå¯¹æ€§èƒ½çš„å½±å“ï¼Œåº”è¯¥è¦åœ¨é¢„æœŸä¹‹å†…ï¼Œä¸èƒ½å¤ªå¤§</li><li>å¯èƒ½å¯ä»¥å…¨æ‰“ï¼Œæˆ–è€…ç²¾ç»†çš„æŒ‰ç…§ä¸€äº›é…ç½®æ¥è¾“å‡º</li><li>å¯èƒ½å¯ä»¥ hack è¿›ä¸€äº›åŸºæœ¬çš„å·¥å…·ï¼ŒåŒ…æ‹¬ rpcã€runtime ç­‰ï¼ˆä½œè€…è¯´ä¸éœ€è¦æ‰‹å·¥ç¼–ç çš„éƒ¨åˆ†ï¼Œå¼ºè°ƒäº†å¯¹åº”ç”¨çš„é€æ˜ï¼Œä½†æˆ‘æ„Ÿè§‰ä¸ºäº†ä¸€äº›ç»†ç²’åº¦çš„æ’æŸ¥ï¼Œè¿˜æ˜¯éœ€è¦çš„å§ï¼‰</li></ol><h2 id="æ•°æ®æ¨¡å‹"><a href="#æ•°æ®æ¨¡å‹" class="headerlink" title="æ•°æ®æ¨¡å‹"></a>æ•°æ®æ¨¡å‹</h2><p>ä¸€ä¸ªè°ƒç”¨çš„é“¾è·¯å¦‚ä¸‹æ–‡æ‰€ç¤ºï¼š</p><p><img src="https://image.mwish.me/blog-image/img1.png" alt="img1"></p><p>åŸºæœ¬çš„æ€è·¯æ˜¯ï¼Œè¿™é‡Œéœ€è¦æœ‰ä¸€äº› context ï¼ˆå¤§æ¦‚å¯ä»¥ç”¨ç±»ä¼¼ snowflake ä¹‹ç±»çš„æ–¹å¼ç”Ÿæˆï¼‰:</p><ol><li>è·Ÿè¸ªæ ‡è¯†ç¬¦(message identifiers)</li><li>æ—¶é—´æˆ³(timestamped events)ã€‚</li></ol><p>è¿™é‡Œæ˜¯å•ä¸ªçš„è·Ÿè¸ªå…³ç³»ï¼Œdapper è¿™é‡Œéå¸¸æœ‰æ„æ€ï¼Œè€ƒè™‘äº†å±‚æ¬¡çš„/å¹¶å‘çš„è·Ÿè¸ªå…³ç³»ï¼š</p><p><img src="https://image.mwish.me/blog-image/img2.png" alt="img2"></p><p>å¦‚ä¸Šï¼Œè¿™é‡Œå…¶å®æ˜¯æœ‰ä¸€ä¸ªï¼ˆå¤šä¸ªï¼‰ <code>Span</code> å¯¹è±¡çš„ï¼ŒRoot æœ¬èº«æ„å»ºäº†ä¸€ä¸ª Span å¯¹è±¡ï¼Œç„¶åè°ƒç”¨ä¸‹å±‚çš„æ—¶å€™ä¹Ÿä¼šèµ· Spanã€‚è¿™é‡Œå¯ä»¥æœ‰ä¸€ä¸ªå¾ˆæ˜¾è‘—çš„äº‹å®ï¼šSpan æ˜¯å¯ä»¥è·¨æœºå™¨çš„ã€‚</p><p>è¿˜æœ‰ä¸ªå¾ˆå¥‡æ€ªçš„é—®é¢˜æ˜¯æ—¶é—´æˆ³çš„åç§»ï¼Œè¿™é‡Œæœ¬èº«é è¯·æ±‚å‘å‡ºçš„æ—¶é—´ &gt; è¯·æ±‚æ”¶åˆ°çš„æ—¶é—´ä¿è¯ã€‚ï¼ˆTODOï¼šä¸è¿‡æ„Ÿè§‰è¿™ä¸ªæ˜¯ä¸ªç‰¹åˆ«å·¥ç¨‹çš„é—®é¢˜äº†ï¼Œå¯ä»¥çœ‹çœ‹è¿™äº›ç³»ç»Ÿæ˜¯å…·ä½“æ€ä¹ˆå®ç°çš„äº†ï¼‰ã€‚</p><p>Dapper åœ¨ä½¿ç”¨çš„æ—¶å€™ï¼Œå¯èƒ½ä¼šè¢«ä¸¢åˆ° Thread Local Storage ç³»ç»Ÿé‡Œï¼Œæˆ–è€…å’ŒæŸä¸ª Context å¯¹è±¡ç»‘å®šï¼Œå…·ä½“è€Œè¨€ï¼š</p><ol><li>è¿™ä¸ª context å¼€é”€å°½é‡å°ï¼Œç„¶åå¯èƒ½å¯ä»¥ä¸¢åˆ° TLS æˆ–è€…æŸä¸ª <code>context</code> å‚æ•°é‡Œ</li><li>åœ¨å¼‚æ­¥è°ƒç”¨ã€èµ·åˆ«çš„çº¿ç¨‹çš„æ—¶å€™ï¼Œèƒ½å¤Ÿæ­£ç¡®å¤„ç†å®ƒä»¬çš„æ‰€æœ‰æƒ</li></ol><p>è¿™ä¸ªæ—¶å€™è¿˜è¦æ³¨æ„åˆ°ä¸€ç‚¹ï¼Œè¿™äº›å¤§å…¬å¸å¯èƒ½ç”¨çš„æ˜¯ä¸€å¥— RPCï¼ŒRPC å¯èƒ½åˆä¼šå®šä¹‰ä¸€äº› runtime ä¹‹ç±»çš„ï¼Œtrace å¾—å¾ˆå¥½çš„å’Œä»–ä»¬åšåˆ°ä¸€èµ·ã€‚è¿™é‡Œè¿˜å¯ä»¥åŠ å…¥ä¸€äº› annotationï¼Œæ³¨å…¥ä¸€äº›æ ‡è®°ï¼š</p><p><img src="https://image.mwish.me/blog-image/img4.png" alt="img4"></p><p>è¿™ä¸ªæˆ‘æ„Ÿè§‰å°±ä¾èµ–ä¸€äº›å¥‡æ€ªçš„å†…å­˜ç”³è¯·äº†ã€‚è®ºæ–‡é‡Œè¿˜æåˆ°å¯ä»¥å­˜ key-value, counterï¼Œä¸è¿‡æˆ‘è§‰å¾—å°±æ˜¯ä¸€ä¸ªå¤šæ¨¡/è¯­ä¹‰çš„é—®é¢˜äº†ã€‚</p><h2 id="æ•°æ®æ”¶é›†"><a href="#æ•°æ®æ”¶é›†" class="headerlink" title="æ•°æ®æ”¶é›†"></a>æ•°æ®æ”¶é›†</h2><p><img src="https://image.mwish.me/blog-image/img5.png" alt="img5"></p><p>è¿™é‡Œåˆ†ä¸ºä¸‰ä¸ªé˜¶æ®µï¼š</p><ol><li>log åˆ°æœ¬åœ°æ–‡ä»¶</li><li>Dapper çš„ deamon æŠŠå®ƒå¼„åˆ°æŸä¸ª collector é‡Œé¢</li><li>æœ€åå†™åˆ° BigTable é‡Œé¢ï¼Œå¯¹ æ¨¡å‹ä¸º trace_id/span/span_cnt</li></ol><p>åŒæ—¶ï¼Œè¿™é‡Œ latency ä» 15s - 2minï¼Œä¸ç®—å¾ˆå»¶è¿Ÿæ•æ„Ÿã€‚è¿™é‡Œè¿˜æœ‰ä¸€äº›é‡è¦æ•°æ®è¦èµ° OOBï¼Œæˆ‘ä¸ªäººæ„Ÿè§‰è¿™é‡Œæš—ç¤ºäº†æœ‰ä¸€äº› tracing å¯ä»¥æ˜¯ã€Œé‡è¦çš„ã€ã€‚</p><p>ä¸Šå›¾ä¹Ÿè¡¨æ˜ï¼Œtracing å¤§æ¦‚åŒ…æ‹¬ï¼š</p><ol><li>å®¢æˆ·ç«¯å’Œå¯¹åº”çš„ Dapper daemon</li><li>Collectors</li><li>ä¸€ä¸ªæ—¶åºçš„åº“ï¼Œç”¨æ¥å­˜å‚¨è¿™æ ·çš„æ•°æ®</li></ol><h2 id="Tracing-çš„å¼€é”€å’Œåº”å¯¹"><a href="#Tracing-çš„å¼€é”€å’Œåº”å¯¹" class="headerlink" title="Tracing çš„å¼€é”€å’Œåº”å¯¹"></a>Tracing çš„å¼€é”€å’Œåº”å¯¹</h2><p>æ¯•ç«Ÿè¦åœ¨çº¿ä¸Šç³»ç»Ÿè·‘ï¼Œè‚¯å®šè¦è€ƒè™‘æ€§èƒ½é—®é¢˜ï¼Œè€ƒè™‘ Root Span éœ€è¦åˆ†é… unique id ï¼Œè®ºæ–‡æè¿°ï¼š</p><blockquote><p>æ ¹spançš„åˆ›å»ºå’Œé”€æ¯éœ€è¦æŸè€—å¹³å‡204çº³ç§’çš„æ—¶é—´ï¼Œè€ŒåŒæ ·çš„æ“ä½œåœ¨å…¶ä»–spanä¸Šéœ€è¦æ¶ˆè€—176çº³ç§’</p><p>å¦‚æœä¸€ä¸ªspanæ²¡æœ‰è¢«é‡‡æ ·çš„è¯ï¼Œé‚£ä¹ˆè¿™ä¸ªé¢å¤–çš„spanä¸‹åˆ›å»ºannotationçš„æˆæœ¬å‡ ä¹å¯ä»¥å¿½ç•¥ä¸è®¡ï¼Œä»–ç”±åœ¨Dapperè¿è¡ŒæœŸå¯¹ThreadLocalæŸ¥æ‰¾æ“ä½œæ„æˆï¼Œè¿™å¹³å‡åªæ¶ˆè€—9çº³ç§’ã€‚å¦‚æœè¿™ä¸ªspanè¢«è®¡å…¥é‡‡æ ·çš„è¯ï¼Œä¼šç”¨ä¸€ä¸ªç”¨å­—ç¬¦ä¸²è¿›è¡Œæ ‡æ³¨â€”åœ¨å›¾4ä¸­æœ‰å±•ç°â€”å¹³å‡éœ€è¦æ¶ˆè€—40çº³ç§’ã€‚è¿™äº›æ•°æ®éƒ½æ˜¯åœ¨2.2GHzçš„x86æœåŠ¡å™¨ä¸Šé‡‡é›†çš„ã€‚</p><p>åœ¨Dapperè¿è¡ŒæœŸå†™å…¥åˆ°æœ¬åœ°ç£ç›˜æ˜¯æœ€æ˜‚è´µçš„æ“ä½œï¼Œä½†æ˜¯ä»–ä»¬çš„å¯è§æŸè€—å¤§å¤§å‡å°‘ï¼Œå› ä¸ºå†™å…¥æ—¥å¿—æ–‡ä»¶å’Œæ“ä½œç›¸å¯¹äºè¢«è·Ÿè¸ªçš„åº”ç”¨ç³»ç»Ÿæ¥è¯´éƒ½æ˜¯å¼‚æ­¥çš„ã€‚</p></blockquote><p>Dapper å°†è‡ªå·±çš„è¿›ç¨‹è®¾ç½®ä¸º Linux è°ƒåº¦æœ€ä½çš„ä¼˜å…ˆçº§ï¼Œç„¶ååœ¨å®è·µä¸­ï¼Œå ç”¨èµ„æºä¸€èˆ¬éå¸¸éå¸¸ä½ã€‚</p><p>åŒæ—¶ï¼Œé‡‡æ ·ç‡å¯¹æ€§èƒ½ä¼šäº§ç”Ÿå½±å“ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p><p><img src="https://image.mwish.me/blog-image/table2.png" alt="table2"></p><p>Dapper èƒ½å¤Ÿå¯å˜çš„ã€è‡ªé€‚åº”çš„ã€aggressive çš„é‡‡æ ·ã€‚ä¸Šå±‚è¿˜æ”¯æŒäº†ä¸€äº›äºŒçº§é‡‡æ ·ï¼Œç»§ç»­ discard ä¸€äº›æ•°æ®ã€‚</p><h1 id="ç™¾åº¦å¤§æœçš„ä¸€äº›æ–¹æ¡ˆ"><a href="#ç™¾åº¦å¤§æœçš„ä¸€äº›æ–¹æ¡ˆ" class="headerlink" title="ç™¾åº¦å¤§æœçš„ä¸€äº›æ–¹æ¡ˆ"></a>ç™¾åº¦å¤§æœçš„ä¸€äº›æ–¹æ¡ˆ</h1><p>å¦‚æœä½ çœŸçš„æŸ¥è¿‡ä¸€äº›é—®é¢˜ï¼Œä½ å°±ä¼šçŸ¥é“ï¼ŒDapper å¾ˆå¥½ï¼Œä½†æ˜¯å¾ˆå¤šä¸œè¥¿ä½ ä¼šå¸Œæœ›æ›´å¤šçš„æ—¥å¿—ã€æ›´é«˜çš„è‡ªç”±åº¦ã€å¿…è¦çš„æ—¶å€™æœ‰ä¸€äº›å®šåˆ¶çš„ä¿¡æ¯ï¼Œè¿™é‡Œå¯ä»¥å‚è€ƒç™¾åº¦å¤§æœçš„æ–¹æ¡ˆï¼š</p><ol><li><a href="https://mp.weixin.qq.com/s/BMbdk5RviLG1Ftlo-qRsDQ">https://mp.weixin.qq.com/s/BMbdk5RviLG1Ftlo-qRsDQ</a></li><li><a href="https://mp.weixin.qq.com/s/IHVUnyhJr4fhiopMLOJqjA">https://mp.weixin.qq.com/s/IHVUnyhJr4fhiopMLOJqjA</a></li></ol><p>è¿™ä¸ªæ–¹æ¡ˆç›¸å¯¹æ¥è¯´å¯èƒ½å’Œå¼€æ”¾æ–¹æ¡ˆä¸æ˜¯ 100% å¯¹é½ã€‚é‡Œé¢å¯¹æ•°æ®çš„å¯è¿½è¸ªæ€§åšäº†è€ƒé‡ï¼Œæˆ‘è®¤ä¸ºï¼Œæœ‰æ„æ€çš„åœ°æ–¹åœ¨äºï¼š</p><ol><li>å¸Œæœ›å¼€å¯æ ¹æ®æŸäº›ç‰¹å¾é‡‡æ ·çš„æ—¶å€™ï¼Œä¸€å®šèƒ½å¼€å¯</li><li>æ”¯æŒå…¨é‡çš„é‡‡æ ·</li></ol><p>æˆ‘è§‰å¾—è¿™ä¸¤ç‚¹è¿˜æ˜¯æ¯”è¾ƒé‡è¦çš„</p><h2 id="é‡‡æ ·çš„ä¸€äº›è®¨è®º"><a href="#é‡‡æ ·çš„ä¸€äº›è®¨è®º" class="headerlink" title="é‡‡æ ·çš„ä¸€äº›è®¨è®º"></a>é‡‡æ ·çš„ä¸€äº›è®¨è®º</h2><p>ä¸Šè¿° baidu çš„ç³»ç»Ÿé€šè¿‡ä¸€äº›èµ„æºå¼€é”€å®Œæˆäº†å®Œå…¨çš„é‡‡æ ·. å…³äº Dapper æœ¬èº«çš„é‡‡æ ·ï¼Œå¯ä»¥çœ‹ <code>&lt;Uncertainty in Aggregate Estimates from Sampled Distributed Traces&gt;</code>ï¼ŒGoogle åœ¨è¿™ç¯‡è®ºæ–‡å¯¹é‡‡æ ·å’Œæ¦‚ç‡åšäº†é‡åŒ–æè¿°ã€‚</p><h2 id="Trace-å·¥ä¸šç•Œå®è·µ"><a href="#Trace-å·¥ä¸šç•Œå®è·µ" class="headerlink" title="Trace: å·¥ä¸šç•Œå®è·µ"></a>Trace: å·¥ä¸šç•Œå®è·µ</h2><p>å·¥ä¸šç•Œæœ‰ç€ä¸å°‘çš„å®è·µï¼Œæˆ–è®¸æœ€å€¼å¾—ç…ä¸€çœ¼çš„å…¥é—¨æ˜¯ Opentracingã€‚æœ‰çš„ä½“ç³»è¿‡äºåºå¤§ï¼Œæˆ‘ä»¬ä¼šä¸€æ­¥ä¸€æ­¥ä»‹ç»è¿™ä¸ªç³»ç»Ÿæ˜¯æ€ä¹ˆæ„å»ºçš„ã€‚</p><h3 id="brpc-tracing-å®¢æˆ·ç«¯å®ç°çš„ä¸€ä¸ªç®€å•ä¾‹å­"><a href="#brpc-tracing-å®¢æˆ·ç«¯å®ç°çš„ä¸€ä¸ªç®€å•ä¾‹å­" class="headerlink" title="brpc tracing: å®¢æˆ·ç«¯å®ç°çš„ä¸€ä¸ªç®€å•ä¾‹å­"></a>brpc tracing: å®¢æˆ·ç«¯å®ç°çš„ä¸€ä¸ªç®€å•ä¾‹å­</h3><p>ä»‹ç»è¿™ç©æ„ä¸€æ–¹é¢æ˜¯å®ƒæ˜¯ Dapper æè¿°çš„å®¢æˆ·ç«¯çš„ä¸€ä¸ªå¾ˆå¥½çš„å®ç°ï¼Œå¦ä¸€æ–¹é¢æˆ‘ä¸Šç­ç”¨çš„æ˜¯ brpcâ€¦ å‡ºäºç§å¿ƒç…ä¸€çœ¼ã€‚</p><p>å…¥å£å¯ä»¥çœ‹åˆ° <code>Collector</code> å’Œ <code>Span</code>:</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// described in http://static.googleusercontent.com/media/research.google.com/en//pubs/archive/36356.pdf</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Span</span> : <span class="keyword">public</span> bvar::Collected &#123;</span><br><span class="line"><span class="keyword">friend</span> <span class="keyword">class</span> <span class="title class_">SpanDB</span>;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">Forbidden</span> &#123;&#125;;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// Call CreateServerSpan/CreateClientSpan instead.</span></span><br><span class="line">    <span class="built_in">Span</span>(Forbidden) &#123;&#125;</span><br><span class="line">    ~<span class="built_in">Span</span>() &#123;&#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">  <span class="comment">// ç”Ÿæˆçš„ TraceID, æ¯ä¸ªé“¾è·¯æ˜¯å”¯ä¸€çš„.</span></span><br><span class="line">    <span class="type">uint64_t</span> _trace_id;</span><br><span class="line">  <span class="comment">// ç”Ÿæˆçš„ SpanID, ä¼šè¢«ä¸²è”åˆ°ä¸€èµ·.</span></span><br><span class="line">    <span class="type">uint64_t</span> _span_id;</span><br><span class="line">    <span class="type">uint64_t</span> _parent_span_id;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// </span></span><br><span class="line">    <span class="type">uint64_t</span> _log_id;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">/* ä¸‹é¢è¿™å‡ ä¸ªå­—æ®µå¯ä»¥æ”¾åˆ°ä¸€èµ·ç†è§£, æœ‰ç‚¹åƒ brpc é€»è¾‘, ç¡®å®šè°æ˜¯ server</span></span><br><span class="line"><span class="comment">  è°æ˜¯ client, å’Œä¸€äº›å¯¹åº”çš„å¤„ç† */</span></span><br><span class="line">  <span class="comment">// ClientID</span></span><br><span class="line">    <span class="type">bthread_id_t</span> _base_cid;</span><br><span class="line">    <span class="type">bthread_id_t</span> _ending_cid;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// svc å¯¹åº”çš„ ip å’Œ port</span></span><br><span class="line">    butil::EndPoint _remote_side;</span><br><span class="line">  <span class="comment">// SpanType å¯ä»¥æ˜¯ Server å’Œ Client</span></span><br><span class="line">    SpanType _type;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// TODO(mwish): è¿™æ˜¯ä»€ä¹ˆå‡ æŠŠ</span></span><br><span class="line">    <span class="type">bool</span> _async;</span><br><span class="line">    ProtocolType _protocol;</span><br><span class="line">    <span class="type">int</span> _error_code;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">/* </span></span><br><span class="line"><span class="comment">  ä¸€äº› brpc internal çš„è®°å½•, æƒ³çœ‹çš„è¯å¯ä»¥è®¤çœŸçœ‹çš„è¯å€’æ˜¯å¯ä»¥çœ‹çœ‹</span></span><br><span class="line"><span class="comment">  è¿™ä¸ªå°±å’Œæˆ‘ä»¬çš„å†…å®¹æ— å…³äº†</span></span><br><span class="line"><span class="comment">  </span></span><br><span class="line"><span class="comment">    int  _request_size;</span></span><br><span class="line"><span class="comment">    int  _response_size;</span></span><br><span class="line"><span class="comment">    int64_t _base_real_us;</span></span><br><span class="line"><span class="comment">    int64_t _received_real_us;</span></span><br><span class="line"><span class="comment">    int64_t _start_parse_real_us;</span></span><br><span class="line"><span class="comment">    int64_t _start_callback_real_us;</span></span><br><span class="line"><span class="comment">    int64_t _start_send_real_us;</span></span><br><span class="line"><span class="comment">    int64_t _sent_real_us;</span></span><br><span class="line"><span class="comment">    std::string _full_method_name;</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"> </span><br><span class="line">    <span class="comment">// Format: </span></span><br><span class="line">    <span class="comment">//   time1_us \s annotation1 &lt;SEP&gt;</span></span><br><span class="line">    <span class="comment">//   time2_us \s annotation2 &lt;SEP&gt;</span></span><br><span class="line">    <span class="comment">//   ...</span></span><br><span class="line">  <span class="comment">// Annotation ä¼šæŒ‰ç…§ä¸Šè¿°çš„</span></span><br><span class="line">    std::string _info;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å’Œ SpanID ä¸€æ ·çš„ä¸€äº›æœ¬åœ° ctx æ ‡è®°</span></span><br><span class="line">    Span* _local_parent;</span><br><span class="line">    Span* _next_client;</span><br><span class="line">    Span* _tls_next;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬é¦–å…ˆå…³æ³¨ä¸€ä¸‹è¿™ä¸ªç±»å‹çš„æˆå‘˜.</p><p><code>Channel::CallMethod</code> é‡Œé¢ï¼Œæè¿°äº†ä½œä¸º client å‘é€è¯·æ±‚çš„å¯¹åº” Span å’Œè¡Œä¸ºï¼Œè°ƒç”¨äº† <code>Span::CreateClientSpan</code>ã€‚</p><p>è¿™é‡Œæ¥æ”¶ä¸€ä¸ªè¯·æ±‚çš„æ—¶å€™ï¼Œä¼šåˆå§‹åŒ–å®ƒï¼ˆä»¥ HTTP Server ä¸ºä¾‹ï¼‰ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">Span* span = <span class="literal">NULL</span>;</span><br><span class="line"><span class="type">const</span> std::string&amp; path = req_header.<span class="built_in">uri</span>().<span class="built_in">path</span>();</span><br><span class="line"><span class="type">const</span> std::string* trace_id_str = req_header.<span class="built_in">GetHeader</span>(<span class="string">&quot;x-bd-trace-id&quot;</span>);</span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">IsTraceable</span>(trace_id_str)) &#123;</span><br><span class="line">  <span class="comment">// ä» rpc è¯·æ±‚æ‹¿åˆ° id, æ²¡æœ‰çš„è¯</span></span><br><span class="line">  <span class="type">uint64_t</span> trace_id = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> (trace_id_str) &#123;</span><br><span class="line">    trace_id = <span class="built_in">strtoull</span>(trace_id_str-&gt;<span class="built_in">c_str</span>(), <span class="literal">NULL</span>, <span class="number">10</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// æ‹¿åˆ° SpanID(æœåŠ¡å™¨).</span></span><br><span class="line">  <span class="type">uint64_t</span> span_id = <span class="number">0</span>;</span><br><span class="line">  <span class="type">const</span> std::string* span_id_str = req_header.<span class="built_in">GetHeader</span>(<span class="string">&quot;x-bd-span-id&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (span_id_str) &#123;</span><br><span class="line">    span_id = <span class="built_in">strtoull</span>(span_id_str-&gt;<span class="built_in">c_str</span>(), <span class="literal">NULL</span>, <span class="number">10</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// æ‹¿åˆ° parent span id.</span></span><br><span class="line">  <span class="type">uint64_t</span> parent_span_id = <span class="number">0</span>;</span><br><span class="line">  <span class="type">const</span> std::string* parent_span_id_str =</span><br><span class="line">    req_header.<span class="built_in">GetHeader</span>(<span class="string">&quot;x-bd-parent-span-id&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (parent_span_id_str) &#123;</span><br><span class="line">    parent_span_id = <span class="built_in">strtoull</span>(parent_span_id_str-&gt;<span class="built_in">c_str</span>(), <span class="literal">NULL</span>, <span class="number">10</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  span = Span::<span class="built_in">CreateServerSpan</span>(</span><br><span class="line">    path, trace_id, span_id, parent_span_id, msg-&gt;<span class="built_in">base_real_us</span>());</span><br><span class="line">  </span><br><span class="line">  <span class="comment">/* ä¸€äº› RPC çš„ä¸Šä¸‹æ–‡è®¾ç½®, ä¸æ„Ÿå…´è¶£å°±åˆ«çœ‹äº†å˜»å˜» */</span></span><br><span class="line">  accessor.<span class="built_in">set_span</span>(span);</span><br><span class="line">  span-&gt;<span class="built_in">set_log_id</span>(cntl-&gt;<span class="built_in">log_id</span>());</span><br><span class="line">  span-&gt;<span class="built_in">set_remote_side</span>(user_addr);</span><br><span class="line">  span-&gt;<span class="built_in">set_received_us</span>(msg-&gt;<span class="built_in">received_us</span>());</span><br><span class="line">  span-&gt;<span class="built_in">set_start_parse_us</span>(start_parse_us);</span><br><span class="line">  span-&gt;<span class="built_in">set_protocol</span>(is_http2 ? PROTOCOL_H2 : PROTOCOL_HTTP);</span><br><span class="line">  span-&gt;<span class="built_in">set_request_size</span>(imsg_guard-&gt;<span class="built_in">parsed_length</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œè¿™ä¸ªåœ°æ–¹ï¼Œå¦‚æœæ²¡æœ‰ç»™ <code>trace_id</code> , <code>log_id</code> çš„è¯ï¼Œè¿™ä¸¤ä¸ªä¼šæ˜¯ <code>0</code>ï¼Œé‚£æˆ‘ä»¬ç»†çœ‹ä¸€ä¸‹å¯¹åº”çš„é€»è¾‘ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Span* <span class="title">Span::CreateServerSpan</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> std::string&amp; full_method_name,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">uint64_t</span> trace_id, <span class="type">uint64_t</span> span_id, <span class="type">uint64_t</span> parent_span_id,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">int64_t</span> base_real_us)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// ä»å†…å­˜æ± è·å– Span å¯¹è±¡.</span></span><br><span class="line">    Span* span = butil::<span class="built_in">get_object</span>&lt;Span&gt;(<span class="built_in">Forbidden</span>());</span><br><span class="line">    <span class="keyword">if</span> (__builtin_expect(span == <span class="literal">NULL</span>, <span class="number">0</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    span-&gt;_trace_id = (trace_id ? trace_id : <span class="built_in">GenerateTraceId</span>());</span><br><span class="line">    span-&gt;_span_id = (span_id ? span_id : <span class="built_in">GenerateSpanId</span>());</span><br><span class="line">    span-&gt;_parent_span_id = parent_span_id;</span><br><span class="line">    span-&gt;_log_id = <span class="number">0</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">/* ä¸€äº›å†…éƒ¨é€»è¾‘ */</span></span><br><span class="line">    span-&gt;_base_cid = INVALID_BTHREAD_ID;</span><br><span class="line">    span-&gt;_ending_cid = INVALID_BTHREAD_ID;</span><br><span class="line">    span-&gt;_type = SPAN_TYPE_SERVER;</span><br><span class="line">    span-&gt;_async = <span class="literal">false</span>;</span><br><span class="line">    span-&gt;_protocol = PROTOCOL_UNKNOWN;</span><br><span class="line">    span-&gt;_error_code = <span class="number">0</span>;</span><br><span class="line">    span-&gt;_request_size = <span class="number">0</span>;</span><br><span class="line">    span-&gt;_response_size = <span class="number">0</span>;</span><br><span class="line">    span-&gt;_base_real_us = base_real_us;</span><br><span class="line">    span-&gt;_received_real_us = <span class="number">0</span>;</span><br><span class="line">    span-&gt;_start_parse_real_us = <span class="number">0</span>;</span><br><span class="line">    span-&gt;_start_callback_real_us = <span class="number">0</span>;</span><br><span class="line">    span-&gt;_start_send_real_us = <span class="number">0</span>;</span><br><span class="line">    span-&gt;_sent_real_us = <span class="number">0</span>;</span><br><span class="line">    span-&gt;_next_client = <span class="literal">NULL</span>;</span><br><span class="line">    span-&gt;_tls_next = <span class="literal">NULL</span>;</span><br><span class="line">    span-&gt;_full_method_name = (!full_method_name.<span class="built_in">empty</span>() ?</span><br><span class="line">                               full_method_name : <span class="built_in">unknown_span_name</span>());</span><br><span class="line">    span-&gt;_info.<span class="built_in">clear</span>();</span><br><span class="line">    span-&gt;_local_parent = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">return</span> span;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæœ‰ç”Ÿæˆ Span çš„é€»è¾‘ï¼ŒåŒæ—¶æ³¨æ„åˆ°ï¼Œè¿™ä¸ªé€»è¾‘ç»‘å®šåœ¨äº† Runtime çš„ bthread ä¸Šï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">EndAsParent</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">this</span> == (Span*)bthread::tls_bls.rpcz_parent_span) &#123;</span><br><span class="line">  bthread::tls_bls.rpcz_parent_span = <span class="literal">NULL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Set tls parent.</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">AsParent</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  bthread::tls_bls.rpcz_parent_span = <span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œï¼Œå®ƒæŠŠ trace ä¸Šä¸‹æ–‡æŒ‚åœ¨äº† thread local çš„åœ°æ–¹ã€‚é‚£æ€ä¹ˆåˆ›å»ºå­ Span å‘¢ï¼Ÿå†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (parent) &#123;</span><br><span class="line">  span-&gt;_trace_id = parent-&gt;<span class="built_in">trace_id</span>();</span><br><span class="line">  span-&gt;_parent_span_id = parent-&gt;<span class="built_in">span_id</span>();</span><br><span class="line">  span-&gt;_local_parent = parent;</span><br><span class="line">  span-&gt;_next_client = parent-&gt;_next_client;</span><br><span class="line">  parent-&gt;_next_client = span;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡ŒæŒ‚äº†ä¸€ä¸ª Span çš„å•é“¾è¡¨ã€‚</p><p>é‚£ Annotation å‘¢ï¼Ÿå…¶å®å¾ˆç®€å•ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">Span::Annotate</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* fmt, va_list args)</span> </span>&#123;</span><br><span class="line">    <span class="type">const</span> <span class="type">int64_t</span> anno_time = butil::<span class="built_in">cpuwide_time_us</span>() + _base_real_us;</span><br><span class="line">    butil::<span class="built_in">string_appendf</span>(&amp;_info, BRPC_SPAN_INFO_SEP <span class="string">&quot;%lld &quot;</span>,</span><br><span class="line">                         (<span class="type">long</span> <span class="type">long</span>)anno_time);</span><br><span class="line">    butil::<span class="built_in">string_vappendf</span>(&amp;_info, fmt, args);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä¼šæ›´æ–°æ ¼å¼ï¼Œç„¶åä¸¢åˆ° <code>_info</code> å¯¹è±¡é‡Œã€‚</p><p>æˆ‘ä»¬å†çœ‹çœ‹å®ƒæ˜¯æ€ä¹ˆå¼‚æ­¥ææ„çš„ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">Span::destroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">EndAsParent</span>();</span><br><span class="line">    Span* p = _next_client;</span><br><span class="line">    <span class="keyword">while</span> (p) &#123;</span><br><span class="line">        Span* p_next = p-&gt;_next_client;</span><br><span class="line">        p-&gt;_info.<span class="built_in">clear</span>();</span><br><span class="line">        butil::<span class="built_in">return_object</span>(p);</span><br><span class="line">        p = p_next;</span><br><span class="line">    &#125;</span><br><span class="line">    _info.<span class="built_in">clear</span>();</span><br><span class="line">    butil::<span class="built_in">return_object</span>(<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>okï¼Œæ­¤å¤–ï¼Œè¿™é‡Œå¯èƒ½ä¼šé€ ä¸€ä¸ª LevelDB å¯¹è±¡ï¼Œç„¶åæœ‰ä¸€ä¸ª <code>Collector</code> å®šæœŸæŠŠè¿™äº›æ•°æ®æ”¶é›†åˆ° LevelDB.</p><p>é‚£é‡‡æ ·çš„é€»è¾‘å‘¢ï¼Ÿçœ‹çœ‹è¿™é‡Œï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Check this function first before creating a span.</span></span><br><span class="line"><span class="comment">// If rpcz of upstream is enabled, local rpcz is enabled automatically.</span></span><br><span class="line"><span class="comment">// å¦‚æœä¸Šé¢å¼€äº† trace å°±ä¸æ£€æŸ¥äº†, å¦åˆ™çœ‹æ˜¯å¦å¼€äº† `rpcz å’Œæœ‰æ²¡æœ‰é™æµ`</span></span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">bool</span> <span class="title">IsTraceable</span><span class="params">(<span class="type">bool</span> is_upstream_traced)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">extern</span> bvar::CollectorSpeedLimit g_span_sl;</span><br><span class="line">    <span class="keyword">return</span> is_upstream_traced ||</span><br><span class="line">        (FLAGS_enable_rpcz &amp;&amp; bvar::<span class="built_in">is_collectable</span>(&amp;g_span_sl));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œé€šè¿‡ <code>CollectorSpeedLimit</code> è¿™ä¸ªé™æµå™¨ï¼Œå®Œæˆäº†ã€Œä½è®¿é—®ä¸é‡‡æ ·ï¼Œé«˜è®¿é—®é‡‡æ ·ã€è¿™æ ·çš„é€»è¾‘ã€‚</p><h3 id="tokio-tracing"><a href="#tokio-tracing" class="headerlink" title="tokio tracing"></a>tokio tracing</h3><p>Tokio Tracing çš„æ–‡æ¡£è§ï¼š<a href="https://tracing.rs/tracing/">https://tracing.rs/tracing/</a> . å…¶å®å®ƒå¤„ç†çš„ä¹Ÿæ˜¯ä¸€ä¸ª runtime çš„é—®é¢˜ã€‚å› ä¸º</p><blockquote><p>The span in which a thread is currently executing is referred to as that threadâ€™s <em>current</em> span.</p></blockquote><p>åŒæ—¶å®ƒä¹Ÿå¤„ç†äº†ä¸€äº› <code>field</code> <code>tag</code> ä»€ä¹ˆçš„ï¼ŒåŸè®ºæ–‡é‡Œé¢è¯´è‡ªå·±èƒ½å¤„ç† kv pair å†™åˆ° BigTable ä»€ä¹ˆçš„ï¼Œæˆ‘è§‰å¾—è¿™é‡Œå·®ä¸å¤šã€‚</p><p><code>tracing-core</code> å®ç°äº†ä¸€äº›åŸºç¡€çš„è¯­ä¹‰ï¼ŒåŒ…æ‹¬ <code>Span</code> å…ƒä¿¡æ¯ <code>MetaData</code>ï¼Œå’Œ <code>event</code> (è®°å½•æ¶ˆæ¯ï¼Œå¼€ Span é€€å‡º Span åœ¨ tokio-tracing é‡Œé¢éƒ½å«åš <code>event</code>)ï¼Œå¤§è‡´å†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[derive(Debug)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">Event</span>&lt;<span class="symbol">&#x27;a</span>&gt; &#123;</span><br><span class="line">    fields: &amp;<span class="symbol">&#x27;a</span> field::ValueSet&lt;<span class="symbol">&#x27;a</span>&gt;,</span><br><span class="line">    metadata: &amp;<span class="symbol">&#x27;static</span> Metadata&lt;<span class="symbol">&#x27;static</span>&gt;,</span><br><span class="line">    parent: Parent,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Clone, Debug, PartialEq, Eq, Hash)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">Id</span>(NonZeroU64);</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Debug)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">Current</span> &#123;</span><br><span class="line">    inner: CurrentInner,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Debug)]</span></span><br><span class="line"><span class="keyword">enum</span> <span class="title class_">CurrentInner</span> &#123;</span><br><span class="line">    Current &#123;</span><br><span class="line">        id: Id,</span><br><span class="line">        metadata: &amp;<span class="symbol">&#x27;static</span> Metadata&lt;<span class="symbol">&#x27;static</span>&gt;,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="literal">None</span>,</span><br><span class="line">    Unknown,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Debug)]</span></span><br><span class="line"><span class="title function_ invoke__">pub</span>(<span class="keyword">crate</span>) <span class="keyword">enum</span> <span class="title class_">Parent</span> &#123;</span><br><span class="line">    <span class="comment">/// The new span will be a root span.</span></span><br><span class="line">    Root,</span><br><span class="line">    <span class="comment">/// The new span will be rooted in the current span.</span></span><br><span class="line">    Current,</span><br><span class="line">    <span class="comment">/// The new span has an explicitly-specified parent.</span></span><br><span class="line">    <span class="title function_ invoke__">Explicit</span>(Id),</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢æ˜¯éœ€è¦çš„å…ƒæ•°æ®ï¼ŒåŒ…æ‹¬ <code>Parent</code>ï¼Œ<code>Current</code> . è¿˜æœ‰ä¸€éƒ¨åˆ†é‡è¦å†…å®¹æ˜¯ <code>Dispatch</code>ï¼Œæ–‡æ¡£å¯è§: <a href="https://tracing.rs/tracing_core/struct.dispatch">https://tracing.rs/tracing_core/struct.dispatch</a></p><blockquote><p>Every thread in a program using <code>tracing</code> has a <em>default collector</em>. When events occur, or spans are created, they are dispatched to the threadâ€™s current collector.</p></blockquote><p>dispatch å†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// `Dispatch` trace data to a [`Collect`].</span></span><br><span class="line"><span class="meta">#[derive(Clone)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">Dispatch</span> &#123;</span><br><span class="line">    <span class="meta">#[cfg(feature = <span class="string">&quot;alloc&quot;</span>)]</span></span><br><span class="line">    collector: Kind&lt;Arc&lt;<span class="keyword">dyn</span> Collect + <span class="built_in">Send</span> + <span class="built_in">Sync</span>&gt;&gt;,</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[cfg(not(feature = <span class="string">&quot;alloc&quot;</span>))]</span></span><br><span class="line">    collector: &amp;<span class="symbol">&#x27;static</span> (<span class="keyword">dyn</span> Collect + <span class="built_in">Send</span> + <span class="built_in">Sync</span>),</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[cfg(feature = <span class="string">&quot;alloc&quot;</span>)]</span></span><br><span class="line"><span class="meta">#[derive(Clone)]</span></span><br><span class="line"><span class="keyword">enum</span> <span class="title class_">Kind</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="title function_ invoke__">Global</span>(&amp;<span class="symbol">&#x27;static</span> (<span class="keyword">dyn</span> Collect + <span class="built_in">Send</span> + <span class="built_in">Sync</span>)),</span><br><span class="line">    <span class="title function_ invoke__">Scoped</span>(T),</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[cfg(feature = <span class="string">&quot;std&quot;</span>)]</span></span><br><span class="line">thread_local! &#123;</span><br><span class="line">    <span class="keyword">static</span> CURRENT_STATE: State = State &#123;</span><br><span class="line">        default: RefCell::<span class="title function_ invoke__">new</span>(Dispatch::<span class="title function_ invoke__">none</span>()),</span><br><span class="line">        can_enter: Cell::<span class="title function_ invoke__">new</span>(<span class="literal">true</span>),</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™éƒ¨åˆ†æœ‰ä¸ª <code>thread_local</code> çš„ <code>State</code> å†…å®¹ï¼Œè¡¨ç¤ºæœ¬çº¿ç¨‹å¯¹åº”çš„ tracing ä¸Šä¸‹æ–‡ã€‚</p><p>ä¸‹é¢æˆ‘ä»¬çœ‹çœ‹ Span å…·ä½“æ˜¯æ€ä¹ˆå®ç°çš„ï¼Œè¿™éƒ¨åˆ†åœ¨ <code>tracing</code> ä¸­ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// A handle representing a span, with the capability to enter the span if it</span></span><br><span class="line"><span class="comment">/// exists.</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// If the span was rejected by the current `Collector`&#x27;s filter, entering the</span></span><br><span class="line"><span class="comment">/// span will silently do nothing. Thus, the handle can be used in the same</span></span><br><span class="line"><span class="comment">/// manner regardless of whether or not the trace is currently being collected.</span></span><br><span class="line"><span class="meta">#[derive(Clone)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">Span</span> &#123;</span><br><span class="line">    <span class="comment">/// A handle used to enter the span when it is not executing.</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// If this is `None`, then the span has either closed or was never enabled.</span></span><br><span class="line">    inner: <span class="type">Option</span>&lt;Inner&gt;,</span><br><span class="line">    <span class="comment">/// Metadata describing the span.</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// This might be `Some` even if `inner` is `None`, in the case that the</span></span><br><span class="line">    <span class="comment">/// span is disabled but the metadata is needed for `log` support.</span></span><br><span class="line">    meta: <span class="type">Option</span>&lt;&amp;<span class="symbol">&#x27;static</span> Metadata&lt;<span class="symbol">&#x27;static</span>&gt;&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// A handle representing the capacity to enter a span which is known to exist.</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// Unlike `Span`, this type is only constructed for spans which _have_ been</span></span><br><span class="line"><span class="comment">/// enabled by the current filter. This type is primarily used for implementing</span></span><br><span class="line"><span class="comment">/// span handles; users should typically not need to interact with it directly.</span></span><br><span class="line"><span class="meta">#[derive(Debug)]</span></span><br><span class="line"><span class="title function_ invoke__">pub</span>(<span class="keyword">crate</span>) <span class="keyword">struct</span> <span class="title class_">Inner</span> &#123;</span><br><span class="line">    <span class="comment">/// The span&#x27;s ID, as provided by `collector`.</span></span><br><span class="line">    id: Id,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// The collector that will receive events relating to this span.</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// This should be the same collector that provided this span with its</span></span><br><span class="line">    <span class="comment">/// `id`.</span></span><br><span class="line">    collector: Dispatch,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œç”¨ <code>DefaultGuard</code> ç­‰å†…å®¹ï¼Œå¾ˆ RAII çš„åšäº†ä¸€ä¸‹å®ƒä»¬ç”Ÿå‘½å‘¨æœŸçš„å˜åŒ–</p><p>è®©æˆ‘ä»¬æ¥çœ‹çœ‹ Span çš„ Enter å’Œ Exit</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[inline]</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">do_enter</span>(&amp;<span class="keyword">self</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> <span class="variable">Some</span>(inner) = <span class="keyword">self</span>.inner.<span class="title function_ invoke__">as_ref</span>() &#123;</span><br><span class="line">        inner.collector.<span class="title function_ invoke__">enter</span>(&amp;inner.id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if_log_enabled! &#123; crate::Level::TRACE, &#123;</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> <span class="variable">Some</span>(_meta) = <span class="keyword">self</span>.meta &#123;</span><br><span class="line">            <span class="keyword">self</span>.<span class="title function_ invoke__">log</span>(ACTIVITY_LOG_TARGET, log::Level::Trace, <span class="built_in">format_args!</span>(<span class="string">&quot;-&gt; &#123;&#125;&quot;</span>, _meta.<span class="title function_ invoke__">name</span>()));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[inline]</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">do_exit</span>(&amp;<span class="keyword">self</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> <span class="variable">Some</span>(inner) = <span class="keyword">self</span>.inner.<span class="title function_ invoke__">as_ref</span>() &#123;</span><br><span class="line">        inner.collector.<span class="title function_ invoke__">exit</span>(&amp;inner.id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if_log_enabled! &#123; crate::Level::TRACE, &#123;</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> <span class="variable">Some</span>(_meta) = <span class="keyword">self</span>.meta &#123;</span><br><span class="line">            <span class="keyword">self</span>.<span class="title function_ invoke__">log</span>(ACTIVITY_LOG_TARGET, log::Level::Trace, <span class="built_in">format_args!</span>(<span class="string">&quot;&lt;- &#123;&#125;&quot;</span>, _meta.<span class="title function_ invoke__">name</span>()));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>çœ‹ï¼Œè¿™é‡Œè°ƒç”¨äº† tracing-core çš„å†…å®¹ã€‚OKï¼Œé‚£æœ€åä¸€ä¸ªé—®é¢˜ï¼Œè¿™é‡Œéƒ½æ˜¯ thread-localï¼Œé‚£ä¹ˆ tokio å‘¢ï¼Ÿè¿™é‡Œå¯ä»¥çœ‹ span çš„ <code>enter</code> æ³¨é‡Šï¼Œ<code>instrument</code> å’Œ <code>Span::in_scope</code></p><h3 id="minitrace"><a href="#minitrace" class="headerlink" title="minitrace"></a>minitrace</h3><p><a href="https://github.com/tikv/minitrace-rust">https://github.com/tikv/minitrace-rust</a></p><p>è¿™ä¸ªé¡¹ç›®ä¸åŠ›å›¾å®Œå–„ï¼Œè€Œæ˜¯åŠ›å›¾å¿«ï¼Œç”¨ <code>tsc</code> å¯„å­˜å™¨ç­‰æ–¹å¼å¤§å¹…åº¦ä¼˜åŒ–äº† trace çš„æ€§èƒ½ã€‚æ¯”è¾ƒå€¼å¾—å†æçš„æ˜¯ ministant: <a href="https://github.com/tikv/minstant">https://github.com/tikv/minstant</a></p><h3 id="Jaeger-amp-OpenTelemetry-OpenTracing"><a href="#Jaeger-amp-OpenTelemetry-OpenTracing" class="headerlink" title="Jaeger &amp; OpenTelemetry(OpenTracing)"></a>Jaeger &amp; OpenTelemetry(OpenTracing)</h3><p>OpenTracing é€šè¿‡æä¾›äº† API æ ‡å‡†ï¼ŒåŸºæœ¬ä¸Šç®—æ˜¯åšäº†å¾ˆä¸é”™çš„äº‹æƒ…ï¼š<a href="https://github.com/opentracing/specification/blob/master/specification.md">https://github.com/opentracing/specification/blob/master/specification.md</a></p><p>Jaeger æä¾›äº†ä¸‹é¢ çš„æ¶æ„ï¼ˆä½¿ç”¨ Kakfa or Direct-to-storageï¼‰ï¼š</p><p><img src="https://image.mwish.me/blog-image/architecture-v2.png" alt="architecture-v2"></p><p><img src="https://image.mwish.me/blog-image/architecture-v1.png" alt="architecture-v1"></p><p>è¿™é‡Œçš„ DB å¯èƒ½è¿˜éœ€è¦ä¸€äº›æ—¶åº/å¤šæ¨¡ä¹‹ç±»çš„éœ€æ±‚: æœ¬è´¨ä¸Šè¿™ä¸ªå’Œå­˜å‚¨æ—¥å¿—å·®ä¸å¤šï¼ŒåŠç»“æ„åŒ–çš„æ•°æ®ã€æœ€è¿‘çš„æ•°æ®éœ€è¦é«˜æ•ˆæŸ¥è¯¢ etcâ€¦</p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p>[1] <a href="https://bigbully.github.io/Dapper-translation/">https://bigbully.github.io/Dapper-translation/</a></p><p>[2] <a href="https://mp.weixin.qq.com/s/BMbdk5RviLG1Ftlo-qRsDQ">https://mp.weixin.qq.com/s/BMbdk5RviLG1Ftlo-qRsDQ</a></p><p>[3] <a href="https://mp.weixin.qq.com/s/IHVUnyhJr4fhiopMLOJqjA">https://mp.weixin.qq.com/s/IHVUnyhJr4fhiopMLOJqjA</a></p><p>[4] <a href="https://zhuanlan.zhihu.com/p/34318538">https://zhuanlan.zhihu.com/p/34318538</a></p><p>[5] <a href="https://www.jaegertracing.io/docs/1.31/architecture/">https://www.jaegertracing.io/docs/1.31/architecture/</a></p><p>[6] <a href="https://tracing.rs/tracing/">https://tracing.rs/tracing/</a></p><p>[7] Dapper, a Large-Scale Distributed Systems Tracing Infrastructure</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>2021 æ‚ä¹¦è®°</title>
      <link href="/2022/02/27/2021-%E6%9D%82%E4%B9%A6%E8%AE%B0/"/>
      <url>/2022/02/27/2021-%E6%9D%82%E4%B9%A6%E8%AE%B0/</url>
      
        <content type="html"><![CDATA[<p>ç«Ÿç„¶å˜´ä¸ŠæŒ‚ç€ä¸ªæƒ³è€ƒç ”ç¤¾ä¼šå­¦çš„åå·ï¼Œæ°´å¹³æœ‰å¤šå°‘å¦è¯´ï¼Œä¹¦è¿˜æ˜¯å¾—å•ƒçš„å§ã€‚2021 å¹´ç®—æ˜¯å¼€å§‹å…¥é—¨çš„ä¸€å¹´ï¼Œå½“ç„¶ç°åœ¨å¯èƒ½é—¨è¿˜æ²¡å…¥ã€‚</p><h2 id="åˆ˜æ“è¥¿æ–¹ç°ä»£æ€æƒ³è®²ä¹‰"><a href="#åˆ˜æ“è¥¿æ–¹ç°ä»£æ€æƒ³è®²ä¹‰" class="headerlink" title="åˆ˜æ“è¥¿æ–¹ç°ä»£æ€æƒ³è®²ä¹‰"></a>åˆ˜æ“è¥¿æ–¹ç°ä»£æ€æƒ³è®²ä¹‰</h2><p>[7/10] ç½‘çº¢ä¹¦ã€‚æµ…æ˜¾çš„ä»‹ç»ã€‚å¯¹ç°ä»£æ€§/éŸ¦ä¼¯çš„ä¸€äº›ç®€å•ä»‹ç»ï¼Œèƒœåœ¨æè¿°çš„å¾ˆç°å®ï¼Œæ²¡è®²å¤ªå¤šç†è®ºï¼Œå¯ä»¥è¯´æ˜¯ç½‘çº¢å…¥é—¨ä¹¦çš„å…¸èŒƒäº†ã€‚å†…å®¹ä¸æ˜¯å¾ˆä½“ç³»ï¼Œä½†æ˜¯ä¹Ÿç®—æµ®å…‰æ å½±è¿‡äº†ä¸€ä¸‹ã€‚</p><p>ä¸­é—´è¿˜æ··æ‚äº†ä¸€äº›å…«å¦ã€‚ä¸è¿‡å¯¹é˜…è¯»ç›¸å½“å‹å¥½ã€‚å™è¿°çš„æ¡†æ¶åœ¨ã€Šå¤ä»Šä¹‹å˜ã€‹ä¸‹è¿›è¡Œï¼Œå‰ä¸¤ç« åœ¨è¿™ä¸ªæ¡†æ¶ä¸‹èµ°å¾—ç›¸å½“å¥½ï¼Œä»å°¼é‡‡åˆ°è¨ç‰¹ï¼›ä½†æ˜¯ç¬¬å››ç« å…³äºè‡ªç”±ä¸»ä¹‰çš„è®¨è®ºè¿˜æ˜¯å¤ªæµ…äº†ï¼Œæ²¡æœ‰æ²¿ç€ä»€ä¹ˆä¸»çº¿è®¨è®ºã€‚åé¢çš„ Q&amp;A å¥½è¯„ã€‚</p><h2 id="è°ˆç¾"><a href="#è°ˆç¾" class="headerlink" title="è°ˆç¾"></a>è°ˆç¾</h2><p>[6/10] åœ¨åˆé€‚çš„æ—¶é—´å†™å‡ºæ¥çš„å°å†Œå­ã€‚ä½œè€…æŠŠç¾è§†ä½œä¸€ç§è¶…ç„¶äºä¿—ç”Ÿæ´»çš„å´‡é«˜ä½“éªŒï¼ŒåŒæ—¶æŠŠç¾æ„Ÿå’Œå¿«æ„Ÿåˆ†å‰²å¼€æ¥ï¼Œå°†ç¾è§†ä½œæ¥æºè‡ªç„¶ã€ä¸æƒ…æ„Ÿäº¤èçš„æƒ…æ„Ÿä½“éªŒã€‚åŒæ—¶ï¼Œå†å¾€å‰ä¸€æ­¥ï¼Œç»™å‡ºäº†æƒ…æ„Ÿé©±ä½¿ç†æ™ºã€ç»éªŒã€çµæ„Ÿç­‰æ¥åˆ›ä½œã€‚å—é™äºæ—¶ä»£ï¼Œå½¼æ—¶æ–‡è®ºå’Œç²¾ç¥åˆ†æè¿˜æ–¹å…´æœªè‰¾ï¼Œè€Œä½œè€…ä¼¼ä¹å¯¹ç°ä»£ä¸€äº›çš„æ–‡å­¦ä½œå“äº†è§£ä¸å¤šï¼ŒåŒæ—¶ä¹Ÿä¸æ˜¯å¾ˆç³»ç»Ÿçš„åˆ†æã€‚ä½†ä»ç„¶è„‰ç»œæ¸…æ™°çš„ç»™å‡ºäº†è‡ªå·±çš„æ„è§ã€‚</p><p>å°±æ„Ÿè§‰â€¦ä¹Ÿæ˜¯å¾ˆå…¥é—¨æ€§è´¨çš„å°å†Œå­ï¼Œåæ‰¯æ·¡è€Œä¸æ˜¯åè®ºè¯ï¼Œçœ‹çœ‹å°±å¾—äº†ã€‚</p><h2 id="ç¤¾ä¼šå­¦çš„é‚€è¯·"><a href="#ç¤¾ä¼šå­¦çš„é‚€è¯·" class="headerlink" title="ç¤¾ä¼šå­¦çš„é‚€è¯·"></a>ç¤¾ä¼šå­¦çš„é‚€è¯·</h2><p>[9/10] ä»ä¸‰åœ£çš„å®å¤§çš„å™è¿°ï¼Œåˆ°ä¸ªäººæ„å»ºç¤¾ä¼šã€åç°ä»£ã€‚å†ä»‹ç»ç¤¾ä¼šå­¦è§†è§’ä¸‹çš„å®¶åº­ æ•™è‚² å®—æ•™ã€‚å‰å‡ ç« çš„å•°é‡Œå…«å—¦è®©æˆ‘æƒ³æ‰£ä¸€åˆ†ï¼Œä¸­é—´å™è¿°çš„ä¸é”™ï¼Œä¸è¿‡åç°ä»£é‚£èŠ‚è®²çš„ä¸å¤ªè¡Œã€‚æœ€åä¸€ç« ç»™æˆ‘æŠŠè¿™ä¸€åˆ†æ‹‰å›æ¥äº†ã€‚ç¤¾ä¼šå­¦åº”è¯¥æ˜¯ä¸€ç§å®è·µã€‚å¯¹äºç å†œæ¥è¯´ï¼Œè¿™ç§å®è·µåº”è¯¥æ˜¯å¼€æºçš„ã€ä¸æ–­è¿›è¡Œçš„ã€‚å¾ˆæ„Ÿè°¢åœ¨è¿™ä¸ªæ—¶å€™è¯»åˆ°è¿™æœ¬ä¹¦ã€‚</p><h2 id="æƒŠå‘†äº†ï¼åŸæ¥è¿™å°±æ˜¯ç¤¾ä¼šå­¦"><a href="#æƒŠå‘†äº†ï¼åŸæ¥è¿™å°±æ˜¯ç¤¾ä¼šå­¦" class="headerlink" title="æƒŠå‘†äº†ï¼åŸæ¥è¿™å°±æ˜¯ç¤¾ä¼šå­¦"></a>æƒŠå‘†äº†ï¼åŸæ¥è¿™å°±æ˜¯ç¤¾ä¼šå­¦</h2><p>[8/10] æ—¥è¯­åã€Œç¤¾ä¼šå­¦ç”¨è¯­å›¾é‰´ã€ï¼Œå…¶å®å¯¹å…¥é—¨ä¹¦å†™å¾—è¿˜ç®—è›®çœŸè¯šçš„ã€‚ç®€å•ä»‹ç»äº†ä¸€ä¸‹ç¤¾ä¼šå­¦å®¶çš„å¤§æ¦‚æƒ³æ³•ã€‚å½“ç„¶ï¼Œçœ‹è¿™æœ¬ä¹¦è‚¯å®šæ˜¯ä¸å¤Ÿçš„ï¼Œå¯¼è®ºå¤šå°‘æ˜¯éš”ç€é´å­æŒ ç—’ï¼Œåªçœ‹å¯¼è®ºä¹Ÿæ˜¯è¯¯å…¥æ­§é€”ã€‚ä½†å¤šå°‘ç»™äº†è¶³å¤Ÿçš„ä»‹ç»ï¼Œæ–¹ä¾¿æˆ‘æŒ‰å›¾ç´¢éª¥ã€‚</p><h2 id="24-7-æ™šæœŸèµ„æœ¬ä¸»ä¹‰ä¸ç¡çœ çš„ç»ˆç»“-æ™šæœŸèµ„æœ¬ä¸»ä¹‰ä¸ç¡çœ çš„ç»ˆç»“"><a href="#24-7-æ™šæœŸèµ„æœ¬ä¸»ä¹‰ä¸ç¡çœ çš„ç»ˆç»“-æ™šæœŸèµ„æœ¬ä¸»ä¹‰ä¸ç¡çœ çš„ç»ˆç»“" class="headerlink" title="24/7:æ™šæœŸèµ„æœ¬ä¸»ä¹‰ä¸ç¡çœ çš„ç»ˆç»“ : æ™šæœŸèµ„æœ¬ä¸»ä¹‰ä¸ç¡çœ çš„ç»ˆç»“"></a>24/7:æ™šæœŸèµ„æœ¬ä¸»ä¹‰ä¸ç¡çœ çš„ç»ˆç»“ : æ™šæœŸèµ„æœ¬ä¸»ä¹‰ä¸ç¡çœ çš„ç»ˆç»“</h2><p>[8/10] å°å†Œå­ã€‚æ²¡å•¥æ–°ä¸œè¥¿ï¼Œä½†æ˜¯è¶³å¤Ÿæœ‰å¯å‘æ€§ã€‚è¿™æœ¬ä¹¦è®²çš„ä¸æ˜¯ç¡çœ ï¼Œä½†æ˜¯æè¿°äº†ä¸€ç§æ™šæœŸèµ„æœ¬ä¸»ä¹‰çš„æ–‡åŒ–é€»è¾‘ï¼Œè¿™ç§é€»è¾‘æ—¢å¸¦æœ‰ä¸€éƒ¨åˆ†æ—©æœŸèµ„æœ¬ä¸»ä¹‰çš„æ¸…æ•™æ„å‘³ï¼Œåˆæœ‰æ¶ˆè´¹çš„æºåŠ¨åŠ›ã€‚ç¡çœ å’Œæ­»äº¡æ˜¯å±é™©çš„åˆåšå†³çš„ç¦»å¼€è¿™ä¸ªè™šå¹»ä¸–ç•Œçš„æ–¹æ³•ã€‚</p><h2 id="æˆä¸ºåŠ¨ç”»åˆ¶ä½œäººå§ï¼-åšè„šè¸å®åœ°çš„æ¢¦"><a href="#æˆä¸ºåŠ¨ç”»åˆ¶ä½œäººå§ï¼-åšè„šè¸å®åœ°çš„æ¢¦" class="headerlink" title="æˆä¸ºåŠ¨ç”»åˆ¶ä½œäººå§ï¼ : åšè„šè¸å®åœ°çš„æ¢¦"></a>æˆä¸ºåŠ¨ç”»åˆ¶ä½œäººå§ï¼ : åšè„šè¸å®åœ°çš„æ¢¦</h2><p>[9/10] å£å§å¿«ä¹ä¹¦ã€‚æŠŠåŠ¨ç”»å·¥ä¸šæ•´ä¸ªä½“ç³»è®²çš„æ¸…æ¥šæ˜ç™½ï¼ŒåŒ…æ‹¬å¹¶ä¸é™äºåˆ¶ä½œäººè§†è§’ä¸­çš„æ—¥æœ¬åŠ¨ç”»åˆ¶ä½œæµç¨‹ã€æ—¥æœ¬åŠ¨ç”»å…¬å¸ä¸ºä»€ä¹ˆæ‰‹å¤´æ²¡é’±ã€åŸå¸‚çš„å½±å“ã€åŠ¨ç”»äººçš„æ”¶å…¥ã€ä¸ºä»€ä¹ˆåŠ¨ç”»é‡è¦ã€‚å¯ä»¥çœ‹åˆ°é‡Œé¢æ´‹æº¢çš„çƒ­æƒ…ã€‚</p><h2 id="æœ‰æ‰€ä¸ä¸ºçš„åå›è€…-æ‰¹åˆ¤ã€æ€€ç–‘ä¸æƒ³è±¡åŠ›"><a href="#æœ‰æ‰€ä¸ä¸ºçš„åå›è€…-æ‰¹åˆ¤ã€æ€€ç–‘ä¸æƒ³è±¡åŠ›" class="headerlink" title="æœ‰æ‰€ä¸ä¸ºçš„åå›è€… : æ‰¹åˆ¤ã€æ€€ç–‘ä¸æƒ³è±¡åŠ›"></a>æœ‰æ‰€ä¸ä¸ºçš„åå›è€… : æ‰¹åˆ¤ã€æ€€ç–‘ä¸æƒ³è±¡åŠ›</h2><p>[8/10] å†å²å­¦ã€‚</p><p>åŒˆå¥´è¿™èŠ‚çœ‹çš„æ¯”è¾ƒå¤´å¤§ï¼Œæœ‰çš„è®¨è®ºè™½ç„¶æ˜¯éšç¬”ï¼Œä½†æ˜¯è¿˜æ˜¯è¦æ¯”è¾ƒå¤šçš„ä¸“ä¸šçŸ¥è¯†çš„ã€‚ä½†æ˜¯éå¸¸å¥½çš„ä¸€ç‚¹æ˜¯ï¼Œä½œè€…åœ¨è®ºè¿°ä¸­ï¼ŒæˆåŠŸæŠŠåŸºæœ¬çš„é€»è¾‘â€œè€ƒå¯Ÿå†å²æ€ä¹ˆè¢«å¡‘é€ çš„â€â€œæ–‡åŒ–çš„æµå˜â€ä»¥åŠâ€œç°ä»£å¯¹å†å²çš„å‘¼å”¤â€è¿™å‡ ä¸ªå¾ˆå…³é”®çš„åœ°æ–¹ä¼ è¾¾ç»™äº†è¯»è€…ï¼Œç„¶ååœ¨åæ–‡ä¸“ä¸šçš„è®ºè¿°ä¸­ï¼Œåˆ©ç”¨è¿™å‡ ä¸ªæ­¦å™¨æ¥è¿›è¡Œè®ºè¿°ã€‚å¯èƒ½å†å²ç»†èŠ‚æˆ‘ä¸€ä¼šå„¿å°±å¿˜äº†ï¼Œä¸è¿‡è¿™ä¸ªæ„é€ è¿‡ç¨‹æˆ‘å¤§æ¦‚æ˜¯ä¼šé“­è®°çš„</p><h2 id="è§„è®­ä¸æƒ©ç½š-ç›‘ç‹±çš„è¯ç”Ÿ"><a href="#è§„è®­ä¸æƒ©ç½š-ç›‘ç‹±çš„è¯ç”Ÿ" class="headerlink" title="è§„è®­ä¸æƒ©ç½š : ç›‘ç‹±çš„è¯ç”Ÿ"></a>è§„è®­ä¸æƒ©ç½š : ç›‘ç‹±çš„è¯ç”Ÿ</h2><p>[10/10] å¦™æï¼å…¼é¡¾æ•´ä½“ä¹‹ç¾ã€åˆ†æä¹‹å·§å¦™ä¸å­¦ç§‘è·¨åº¦ä¹‹å¤§ã€‚å…¨ä¹¦å±•ç°çš„æ˜¯æƒåŠ›è¿ä½œçš„è½¨è¿¹å’ŒçŸ¥è¯†çš„åˆ›é€ ã€‚ç¦æŸ¯ä»¥ä¸€ç§è°±ç³»å­¦çš„è§†è§’ï¼Œä»æ—§æ—¶ä»£çš„å®¡åˆ¤å…¥æ‰‹ï¼Œè¿™æ˜¯æ—§æ—¶ä»£å›½ç‹æƒåŠ›çš„ä½“ç°ã€‚å¹¶æè¿°äº†ä»–çš„å­˜åœ¨ä¸æ°‘ä¸»é˜¶å±‚çš„æ€åº¦ã€å„é˜¶å±‚çš„æ™®éçŠ¯ç½ªã€æƒåŠ›çš„å¤±è¡¡å’Œæ–­è£‚ã€‚åœ¨è¿‡æ¸¡åˆ°æ–°æ—¶ä»£çš„æ—¶å€™ï¼Œç¦æŸ¯æè¿°äº†ç†æƒ³çš„â€œæ•™æ”¹â€å½¢å¼ï¼Œå¹¶åœ¨ç»æµèƒŒæ™¯ä¸‹ï¼Œå€ŸåŠ©ä¿®é“é™¢ç­‰åŒä¸€æ—¶æ®µçŸ¥è¯†ç”Ÿäº§çš„è¿›ç¨‹ï¼Œåˆ»ç”»äº†çŸ¥è¯†â€”æƒåŠ›â€”è§„è®­è¿™ä¸€æ€ç»´è·¯çº¿ã€‚å¹¶æç»˜äº†â€œå…¨æ™¯æ•è§†ç›‘ç‹±â€è¿™ä¸€ä¸ªæ°‘ä¸»çš„åœºæ™¯ã€‚å†å›åˆ°ç°å®ä¸­ï¼Œä½œè€…å¯¹ç°ä»£ç›‘ç‹±å’Œå…¶ä¸å°½äººæ„ä¹‹å¤„å†åº¦è¿›è¡Œäº†åˆ»ç”»ï¼ŒæŠŠè¿™ä¸ªç³»ç»Ÿåç›´è§‰çš„åœ°æ–¹å†åº¦çº³å…¥åˆ°è¿™ä¸ªç³»ç»Ÿä¸­ã€‚</p><h2 id="æ•°æ®å¯†é›†å‹åº”ç”¨ç³»ç»Ÿè®¾è®¡"><a href="#æ•°æ®å¯†é›†å‹åº”ç”¨ç³»ç»Ÿè®¾è®¡" class="headerlink" title="æ•°æ®å¯†é›†å‹åº”ç”¨ç³»ç»Ÿè®¾è®¡"></a>æ•°æ®å¯†é›†å‹åº”ç”¨ç³»ç»Ÿè®¾è®¡</h2><p>ä¿—è¯è¯´å¾—å¥½ï¼Œæ„æ·«å¥èº«â€¦å“¦ä¸å¯¹â€¦</p><p>è¿™ä¹¦æ˜¯å¥½ä¹¦ï¼Œè‘—åçš„ ddiaï¼Œä½œè€…å¯¹ä¸€åˆ‡éƒ½ä¿¡æ‰‹æ‹ˆæ¥ã€‚å¥½çš„ä¸ç”¨è¯´äº†ã€‚ä½†æ˜¯æˆ‘å·²ç»ä¸æ˜¯å…¥é—¨è€…äº†ï¼Œå¿…é¡»è¦æé†’ä¸€ä¸‹ï¼Œå¯¹äºè¯»è€…æ¥è¯´ï¼Œè¿™æ ·çš„ä¹¦æ˜¯å±é™©çš„ã€‚æˆ‘å½“åˆè¯»äº†ä¸€éï¼Œç„¶ååŸºæœ¬éƒ½å¿˜äº† orzã€‚ç°åœ¨åé¢å‡ èŠ‚ Streaming çš„ä¹Ÿè®°å¾—ä¸å¤ªæ¸…æ¥šäº†ï¼Œè¿˜æ˜¯è¦è‡ªå·±å¤šçœ‹è®ºæ–‡ï¼Œå¤šè®°å½•ã€‚ä¸èƒ½æ²‰æµ¸åœ¨å¯¼è®ºå¸¦æ¥çš„æ¬¢æ„‰ä¸­ã€‚</p><h2 id="System-Design-Interview-An-insiderâ€™s-guide-Second-Edition"><a href="#System-Design-Interview-An-insiderâ€™s-guide-Second-Edition" class="headerlink" title="System Design Interview : An insiderâ€™s guide, Second Edition"></a>System Design Interview : An insiderâ€™s guide, Second Edition</h2><p>å¾ˆå¥½ç©çš„ä¹¦ï¼Œä¸€ç‚¹éƒ½ä¸éš¾ã€‚å„ç§å·¥ä¸šç³»ç»Ÿæ‰«ç›²ã€‚</p>]]></content>
      
      
      
        <tags>
            
            <tag> acing </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2021 acgn</title>
      <link href="/2022/02/11/2021-acgn/"/>
      <url>/2022/02/11/2021-acgn/</url>
      
        <content type="html"><![CDATA[<p>2021 å¹´å¯¹æˆ‘æ¥è¯´æ˜¯å¾ˆç³Ÿç³•çš„ä¸€å¹´ï¼Œå› ä¸ºçœ‹çš„åŠ¨ç”»å°‘äº†ä¸å°‘ã€‚åŸå› æˆ‘ä¹Ÿä¸çŸ¥é“ï¼Œå¯èƒ½ä¸Šç­ä¸Šæˆè„‘ç˜«äº†ã€‚</p><p><img src="https://image.mwish.me/blog-image/704AE81B-0BCF-4437-B509-64684BE6F6B7.png" alt="704AE81B-0BCF-4437-B509-64684BE6F6B7"></p><p>çœ‹çš„å•çº¸å€’æ˜¯å¤šäº†äº›ï¼Œæ¯•ç«Ÿåœ¨é©¬æ¡¶ä¸Šå°±èƒ½çœ‹ã€‚</p><p>å†å’‹éš¾å ªä¹Ÿå¾—åšæ€»ç»“çš„ï¼Œç±»ä¼¼æœ‰é’±æ²¡é’±å›å®¶è¿‡å¹´ã€‚å¸Œæœ› 22 å¹´èƒ½å¤šçœ‹äº›ï¼Œåˆ«è·Ÿ 21 å¹´ä¸€æ ·è·Ÿæ­»äººæ²¡åŒºåˆ«ã€‚</p><h2 id="Anime"><a href="#Anime" class="headerlink" title="Anime"></a>Anime</h2><h3 id="å››å¶æ¸¸æˆ-ã‚¯ãƒ­ã‚¹ã‚²ãƒ¼ãƒ "><a href="#å››å¶æ¸¸æˆ-ã‚¯ãƒ­ã‚¹ã‚²ãƒ¼ãƒ " class="headerlink" title="å››å¶æ¸¸æˆ(ã‚¯ãƒ­ã‚¹ã‚²ãƒ¼ãƒ )"></a>å››å¶æ¸¸æˆ(ã‚¯ãƒ­ã‚¹ã‚²ãƒ¼ãƒ )</h3><p>å¹´è½»äººçš„ç¬¬ä¸€éƒ¨å®‰è¾¾å……ã€‚æ€»æ„Ÿè§‰æ˜¯ä¼šåœ¨ tv é»„é‡‘æ¡£æ—¶é—´è½®æ’­çš„é‚£ç§åŠ¨ç”»ã€‚è™½è¯´å¶å°”æ¥å†™å–œé—»ä¹è§çš„å‰§æƒ…ï¼Œå¶å°”æ’ç§‘æ‰“è¯¨ï¼Œä¸»çº¿äººç‰©å¤¸å¼ çš„èƒ½åŠ›å’Œä¸ç”šä¸¥è°¨çš„æ£’çƒã€‚ä½†è¿™ä¸æ¯«ä¸å½±å“æœ¬ä½œçš„æ„Ÿæƒ…çº¿å’Œä¸»çº¿çš„ä¼˜ç§€ï¼šä»ç¬¬ä¸€é›†çš„å…‰ä¸çŸ¥é“è¯¥ä¸è¯¥å“­æ³£ï¼Œåˆ°æœ€åçš„ã€Œå¯ä»¥è¯´è°å—ã€ã€Œå»ç”²å­å›­ï¼ŒæŠ•å‡º160KMçš„çƒã€ã€‚å®‰è¾¾å……å†™å‡ºäº†è¶³å¤Ÿç²¾å½©çš„æ¯”èµ›ï¼Œä¹Ÿæç»˜å‡ºäº†æœªæˆç†Ÿçš„å°‘å¹´é¢å¯¹æ­»äº¡ã€ä¸çŸ¥é“æ€ä¹ˆè¡¨è¾¾è‡ªå·±æƒ…æ„Ÿçš„äººæ…¢æ…¢å‰è¿›ï¼Œå¹¶åœ¨çƒåœºä¸Šå°†é™é™æµæ·Œçš„æƒ…æ„Ÿè¡¨è¾¾å‡ºæ¥ã€‚</p><p>æ„Ÿå…´è¶£çš„å¯ä»¥çœ‹çœ‹ç¬¬ä¸€é›†å…ˆï¼Œè¾¾åˆ°äº†æ•™ç§‘ä¹¦ä¸€èˆ¬çš„æ•ˆæœã€‚</p><h3 id="ç„¡è·è»¢ç”Ÿ-ï½ç•°ä¸–ç•Œè¡Œã£ãŸã‚‰æœ¬æ°—ã ã™"><a href="#ç„¡è·è»¢ç”Ÿ-ï½ç•°ä¸–ç•Œè¡Œã£ãŸã‚‰æœ¬æ°—ã ã™" class="headerlink" title="ç„¡è·è»¢ç”Ÿ ï½ç•°ä¸–ç•Œè¡Œã£ãŸã‚‰æœ¬æ°—ã ã™"></a>ç„¡è·è»¢ç”Ÿ ï½ç•°ä¸–ç•Œè¡Œã£ãŸã‚‰æœ¬æ°—ã ã™</h3><p>2021 å¹´èŠ‚å¥è«åå…¶å¦™å¤šçš„åŠ¨ç”»ã€‚å…¶å®æ²¡å•¥è¯´çš„ï¼Œæœ‰çš„æ¯’ç”µæ³¢å°±çœŸçš„å¾ˆæ¯’ç”µæ³¢ï¼Œæ¯”ä¸–çºªåŠ¨ç”»åˆå·çœ‹äººæ´—æ¾¡ç”µæ³¢å¤šäº†ã€‚å†ˆæœ¬å­¦å¾ˆå¼ºï¼Œåˆ¶ä½œä¹Ÿå¥½ã€‚åœ¨ Part1 çš„æ—¶å€™ï¼Œå›å½’æœ¬çœŸçš„â€œå¼‚ä¸–ç•Œâ€å’Œâ€œæˆé•¿â€æ„Ÿå¾ˆå¼ºã€‚ä¸»è§’ä¸€æ­¥æ­¥èµ°å‡ºæ–°æ‰‹æ‘ï¼Œç„¶åä¸€æ­¥æ­¥çŠ¯é”™ â€” ä¿®æ­£ã€‚Part2 çš„ã€Œæ—…è¡Œã€æ„Ÿå¤ªæ£’äº†ï¼Œæœ‰ä¸€ç§åˆ‡å®çš„ã€Œå¼‚ä¸–ç•Œã€çš„æ¼‚æ³Šå’Œæ¸©é¦¨ï¼Œä¹Ÿæœ‰æ„Ÿæƒ…çš„çœŸæŒšæµéœ²å’Œå®¶åº­ä¸çˆ±ï¼Œå’Œæ’‘èµ·è¿™ä¸€åˆ‡çš„æ¼”å‡ºã€‚</p><p>æŠ›å¼€åˆ¶ä½œä¸è®ºï¼Œç¬¬äºŒå­£çš„ã€Œäººæ˜¯ä¼šæ”¹å˜çš„ã€å’Œ Ep 23 åº”è¯¥æ˜¯æœ€é‡è¦çš„åœ°æ–¹ï¼Œè¿™å¾ˆå¤§ç¨‹åº¦ä¸Šä¹Ÿæ˜¯å¯¹è¿™éƒ¨åŠ¨ç”»äº‰è®®çš„å›åº”äº†ã€‚</p><p>P.S. é­”ç•Œå¤§å¸å¯çˆ±</p><h3 id="To-Heart"><a href="#To-Heart" class="headerlink" title="To Heart"></a>To Heart</h3><p>ä¼ è¯´ä¸­çš„ Gal æ”¹å·…å³°ä¹‹ä¸€ï¼ŒAQUAPLUS çš„åŸä½œï¼Œå½¢å¼åå‘å•å…ƒå‰§ã€‚ç›‘ç£é«˜æ¡¥ç›´äººæ˜¯å‡ºå´é«˜å¾’ï¼Œç¼–æ’è¡¨ç°èƒ½åŠ›å¾ˆå¼ºã€‚æˆ‘ä¸ªäººæ¯”è¾ƒå–œæ¬¢çš„å›æ•°æ˜¯ 2/4/6/11/13 ã€‚ç›¸å¯¹å¸¸é ä¸€äº›æ‰­æ›²çš„æƒ…æ„Ÿã€éå¸¸å¼ºçƒˆçš„å†²çªã€å®Œå…¨æ­éœ²è§’è‰²å†…å¿ƒçš„è¡¨è¾¾æ¥å¡‘é€ è§’è‰²çš„æ ¡å›­/æ‹çˆ±åŠ¨ç”»ï¼ŒTo Heart æ˜¯æ›´æ¸©å’Œã€å«è“„çš„ï¼Œåœ¨é£æ ¼ä¸Šå¹³æ·¡å¦‚æ°´ã€åœ¨æ‹çˆ±å’Œæƒ…æ„Ÿä¸Šç‚¹åˆ°ä¸ºæ­¢ï¼Œç”šè‡³èƒ½è®©ä½ æƒ³åˆ°è‡ªå·±çš„æ ¡å›­ç”Ÿæ´»ã€‚</p><p>æœ¬ç‰‡çš„ Op æ˜¯è¿™ä»½æ¸©é¦¨çš„ç¼©å½±ä¹‹ä¸€ï¼Œä»å¤æœ´çš„æ ¡å›­è§’è½åˆ°é’æ˜¥çš„è§’è‰²ï¼Œåˆ°è¿™ç§å…‹åˆ¶çš„è¡¨ç°ï¼Œæ·‹æ¼“å°½è‡´ã€‚</p><p>å®é™…ä¸Šåœ¨è§‚çœ‹ \<To Heart\> çš„æ—¶å€™ï¼Œæœ¬èº«ä¹Ÿæ˜¯å¹³æ·¡è€Œç¾å¥½çš„ã€‚è¿™è®©æœ¬ç‰‡å’Œã€Šç¥æ˜¯ä¸­å­¦ç”Ÿã€‹ä¸€èµ·æˆä¸ºæˆ‘æœ¬ç±»å‹æœ€å–œæ¬¢çš„ä½œå“ä¹‹ä¸€ã€‚</p><h3 id="ç”œæ¢¦çŒ«-ãƒŸãƒ¥ãƒ¼ã‚¯ãƒ«ãƒ‰ãƒªãƒ¼ãƒŸãƒ¼"><a href="#ç”œæ¢¦çŒ«-ãƒŸãƒ¥ãƒ¼ã‚¯ãƒ«ãƒ‰ãƒªãƒ¼ãƒŸãƒ¼" class="headerlink" title="ç”œæ¢¦çŒ« (ãƒŸãƒ¥ãƒ¼ã‚¯ãƒ«ãƒ‰ãƒªãƒ¼ãƒŸãƒ¼)"></a>ç”œæ¢¦çŒ« (ãƒŸãƒ¥ãƒ¼ã‚¯ãƒ«ãƒ‰ãƒªãƒ¼ãƒŸãƒ¼)</h3><p>å…¶å®è¿™åº”è¯¥ç®— 2020 çš„ç‰‡ï¼Ÿä½†æ˜¯æ˜¯ 2021 æ’­å®Œçš„ï¼Œç‰‡æ²¡çœ‹å®Œç­‰äºæ²¡çœ‹å¯¹å§ï½</p><p>å¯¼æ¼”æ¨±äº•å¼˜æ˜ï¼Œä¸‰ä¸½é¸¥çš„ç‰‡å„¿ï¼Œå½¢å¼å¾ˆå•å…ƒå‰§ï¼Œå±äºå­ä¾›åŠ¨ç”»ã€‚ä½†æ˜¯è«åå…¶å¦™é€‚åˆç¤¾ç•œçœ‹ã€‚æœ¬ç‰‡çš„æ¼”å‡ºé£æ ¼éå¸¸ç±»ä¼¼æ¼«ç”»ï¼Œè¯­é€Ÿå¿«å¤šè¯è¯­èŠ‚å¥ç´§å‡‘ï¼Œæœ‰ç€å……è¶³çš„ä¹å­ã€‚æœ‰çš„æ—¶å€™æˆ‘æ€€ç–‘è¿™ç‰‡æ˜¯ä¸æ˜¯å­ä¾›åŠ¨ç”»ï¼Œå› ä¸ºé‡Œé¢è§’è‰²æ—¶å¸¸æš´éœ²å‡ºä¸€è‚¡ç¤¾ç•œæ‘†çƒ‚å‘³ï¼Œè€Œä¸æ˜¯å°‘å¹´å°‘å¥³çš„æ­£é¢å‹‡æ•¢ã€åšæŒï¼›è´Ÿé¢çš„æ»¡åœ°æ‰“æ»šå’Œå¯¹äº²äººä¸ç†è§£ï¼ˆå’Œå…‰ç¾æŠ“å¿ƒå¯¹æ¯”å…¶å®æŒºæ˜æ˜¾çš„ï¼‰ï¼Œä½†ç”¨è¿™ç§æ–¹å¼ï¼Œä¹Ÿèƒ½å¾ˆå–œå‰§çš„é¢å¯¹äº†è¿™äº›é—®é¢˜ï¼Œè€Œæ²¡æœ‰é€ƒé¿å®ƒä»¬ã€‚</p><p>èˆè‰¯å›å’Œå¥³è£…å›æ˜¯æˆ‘æœ€å–œæ¬¢çš„ä¸¤é›†ï¼Œå°¤å…¶æ˜¯èˆè‰¯å›ï¼Œé¢å¯¹é€å»çš„äº²äººä¿æŒå¾®ç¬‘ã€ä¹è§‚ã€å–„è‰¯å’Œçˆ±ï¼Œè¿™å°±æ˜¯å­ä¾›åŠ¨ç”»çš„é†é†å‘³å§ã€‚</p><h3 id="é£è·ƒå·…å³°2-ãƒˆãƒƒãƒ—ã‚’ã­ã‚‰ãˆ2"><a href="#é£è·ƒå·…å³°2-ãƒˆãƒƒãƒ—ã‚’ã­ã‚‰ãˆ2" class="headerlink" title="é£è·ƒå·…å³°2 (ãƒˆãƒƒãƒ—ã‚’ã­ã‚‰ãˆ2!)"></a>é£è·ƒå·…å³°2 (ãƒˆãƒƒãƒ—ã‚’ã­ã‚‰ãˆ2!)</h3><p>å¦‚æœè¯´ï¼Œé£è·ƒå·…å³°1 æ˜¯åºµé‡ç§€æ˜å’Œä¸»è§’ä¸€èµ·é£é€Ÿè¿›åŒ–ï¼Œé£è·ƒå·…å³°2 å°±æ˜¯é¹¤å·çš„å°‘å¹´æ•…äº‹ï¼šåœ¨æ•…äº‹å’Œå™äº‹ä¸Šçš„ä¸¥è°¨å’Œå®å¤§æ„Ÿå°‘äº†å‡ åˆ†ï¼Œæ²¡æœ‰äº†åœ¨å­¦æ ¡åŠªåŠ›é”»ç‚¼ã€è½¬ç¬å³é€çš„åˆæ‹æˆ–è€…æˆé•¿åˆ°é¡¶å¤©ç«‹åœ°ï¼Œæ›´å¤šçš„æ˜¯å¥‡æ€ªçš„è®¾å®šã€å‘¼å”¤äººç±»ä¸çˆ±çš„å°‘å¥³å’Œæœºå™¨ã€å°‘å¥³æ‹¯æ•‘è‡ªå·±ã€‚è¿™æä¾›äº†ä¸€ç§ä¸åŒç»´åº¦çš„æµªæ¼«ï¼šåœ¨å¤ªç©ºçœ‹æ—¥å‡ºã€ä¸ä¸æ˜¯å°‘å¹´çš„äººçš„å¯¹å³™ã€æ—¶ç©ºæ£€å¯Ÿå®˜çš„æˆ¿é—´ä»¥åŠæµªæ¼«çš„åƒçº¸é¹¤ã€‚ç›¸å¯¹ top1ï¼Œè¿™äº›æ„è±¡å’Œè¯ºè¯ºè‰è‰åè€Œæ›´èƒ½ä»£è¡¨è¿™æ ·ä¸€éƒ¨å¾ˆå°‘å¹´çš„ä½œå“ã€‚è€Œç›¸åŒçš„æ˜¯ï¼Œç»“å°¾é‚£ä»½æ¨ªè·¨ä¸‡å¹´çš„æµªæ¼«ï¼Œä¸æœªçŸ¥çš„äººç±»è¿›åŒ–ã€‚</p><h3 id="THE-BIG-O-THE-ãƒ“ãƒƒã‚°ã‚ªãƒ¼"><a href="#THE-BIG-O-THE-ãƒ“ãƒƒã‚°ã‚ªãƒ¼" class="headerlink" title="THE BIG-O (THE ãƒ“ãƒƒã‚°ã‚ªãƒ¼)"></a>THE BIG-O (THE ãƒ“ãƒƒã‚°ã‚ªãƒ¼)</h3><p>æ—¥å‡çš„ç‰‡ï¼Œå•å…ƒå‰§ã€‚ç¬¬ä¸€å­£åœ¨ 1999 å¹´æ’­å‡ºï¼Œç¬¬äºŒå­£åˆ™åœ¨ 2003 å¹´ã€‚å…ƒç´ æœ‰ç‚¹åƒè™è ä¾ /æ¥šé—¨çš„ä¸–ç•Œã€‚èƒŒæ™¯æ˜¯æ•…äº‹é‡Œçš„æ‰€æœ‰äººéƒ½å¤±å»äº†è®°å¿†ï¼Œä¾é æœ¦èƒ§çš„çˆ±ã€é“å¾·å’Œç–¯ç‹‚æ´»ä¸‹å»ã€‚ç›¸å¯¹äºä¸¥è°¨çš„ä¸–ç•Œè§‚æˆ–è€…ç»†è‡´çš„äººç‰©æç»˜ï¼Œæœ¬ç‰‡å¡‘é€ çš„æ›´æ¥è¿‘ä¸€ç§æ°›å›´ï¼šæ¥æºæœªçŸ¥çš„èåœã€å¤±å»è®°å¿†çš„åŸå¸‚ã€æœ¦èƒ§çš„æ—¶é’Ÿã€ä¸çŸ¥é“åœ¨æƒ³ä»€ä¹ˆçš„å¤§äººã€‚è¿™äº›æ•…äº‹å¯¹äººç‰©å’Œä¸–ç•Œè§‚æç»˜éƒ½æ˜¯ä¸å……è¶³çš„ï¼Œä½†æ˜¯è¿™ç§æœ¦èƒ§è€Œè™šå¹»çš„æ°›å›´å´æœ‰ä¸€è‚¡å­ç¾æ„Ÿå’Œå¥‡å¦™çš„ PKD å‘³ã€‚</p><p>é¡ºå£æä¸€å˜´ï¼Œè¿™ç‰‡å¥³ä¸»æœ‰æœºå™¨äºº+æ— å£ä¸¤å±æ€§ï¼Œcv é…çš„ä¹Ÿå¾ˆå‡ºå½©ï¼Œç›´æ¥åŠ åˆ†äº†ã€‚</p><h3 id="æ–°ãƒ»ç¦éŸ³æˆ˜å£«å‰§åœºç‰ˆï¼šç»ˆ-ã‚·ãƒ³ãƒ»ã‚¨ãƒ´ã‚¡ãƒ³ã‚²ãƒªã‚ªãƒ³åŠ‡å ´ç‰ˆ-â”‚â–Œ"><a href="#æ–°ãƒ»ç¦éŸ³æˆ˜å£«å‰§åœºç‰ˆï¼šç»ˆ-ã‚·ãƒ³ãƒ»ã‚¨ãƒ´ã‚¡ãƒ³ã‚²ãƒªã‚ªãƒ³åŠ‡å ´ç‰ˆ-â”‚â–Œ" class="headerlink" title="æ–°ãƒ»ç¦éŸ³æˆ˜å£«å‰§åœºç‰ˆï¼šç»ˆ(ã‚·ãƒ³ãƒ»ã‚¨ãƒ´ã‚¡ãƒ³ã‚²ãƒªã‚ªãƒ³åŠ‡å ´ç‰ˆ:â”‚â–Œ)"></a>æ–°ãƒ»ç¦éŸ³æˆ˜å£«å‰§åœºç‰ˆï¼šç»ˆ(ã‚·ãƒ³ãƒ»ã‚¨ãƒ´ã‚¡ãƒ³ã‚²ãƒªã‚ªãƒ³åŠ‡å ´ç‰ˆ:â”‚â–Œ)</h3><p>è¿™ç‰‡åˆšä¸Šæ˜ çš„æ—¶å€™ï¼Œå› ä¸ºå‘†å‘†å…½é¢åŒ…åœ¨ s1 ä¸Šé—¹è…¾ï¼Œå‡ºäº†ä¸€äº›å¥‡æ€ªçš„èŠ‚å¥ã€‚æ”¾æºä¹‹ååˆåœ¨ s1 å¤©å¤©å¤§æˆ˜ã€‚å¯è§ s1 çœŸå® eva è®ºå›äº†ã€‚</p><p>å°½ç®¡æœ‰ç€å¸¦ä¸€å®šé‡çš„è®¾å®šé›†ï¼Œä½†æ˜¯ Eva å¹¶ä¸ç®—æ˜¯é‚£ä¹ˆä¸¥è°¨çš„ä½œå“ï¼Œæˆ–è®¸ä»è§’è‰²ä¸Šç†è§£æ•…äº‹æ¯”ä»ä¸–ç•Œè§‚ä¸Šç†è§£è¦å¦¥å¸–çš„å¤šã€‚å…¶å®åœ¨ Q é‚£ä¸ªä¸çŸ¥æ‰€äº‘ï¼ˆä½†æ˜¯å¾ˆæ—¶é«¦ï¼‰çš„å†…å®¹ä¸‹ï¼Œèƒ½èµ°åˆ°ç»ˆï¼Œç»™ä¸€ä¸ªå®Œæ•´çš„ç»“å±€ï¼Œæ˜¯å¾ˆäº†ä¸èµ·çš„ã€‚Eva å®Œå…¨æ˜¯åºµé‡ç§€æ˜ä¸ªäººçš„è¡¨è¾¾å’Œæ•‘èµï¼Œåœ¨ fin ä¸­ï¼ŒçœŸå—£ç•…å¿«çš„å’Œæ‰€æœ‰äººå’Œè§£ï¼Œç„¶åå‘æ—§çš„ä¸–ç•Œåšäº†ä¸€ä¸ªç•…å¿«çš„å‘Šåˆ«ï¼Œç„¶åè·Ÿä¸€ç›´ç›¸ä¿¡è‡ªå·±çš„å¤§èƒ¸çœ¼é•œå¦¹èµ°åˆ°äº†ä¸€èµ·ã€‚ä»åŠ¨ç”»çš„è§’åº¦è¯´ï¼ŒçœŸçš„å¾ˆç•…å¿«ï¼Œ20å¤šå¹´çš„æ•…äº‹å¹²è„†çš„å®Œç»“äº†ã€‚éšç€ã€Œå†è§äº†ï¼Œæ‰€æœ‰çš„ Evaã€ï¼Œå†åˆ°æ²™æ»©ä¸Šå†ä¸€æ¬¡è§é¢ï¼Œå†åˆ°è·‘å‡ºè½¦ç«™ï¼Œè¿™ä¸ªæ•…äº‹ç»“æŸçš„å¾ˆç•…å¿«ã€‚</p><p>æœ¬è´¨ä¸Šï¼ŒEva çš„æ•…äº‹ä¼˜ç§€ï¼Œå¾ˆå¤§ä¸€éƒ¨åˆ†è¦å½’åŠŸäºè§’è‰²ã€Staff åŠŸåº•ã€‚æŒ‡è´£TVç‰ˆæ—§æœ¬èº«å°±æ˜¯ä¸åˆç†çš„ï¼Œä½ çœ‹ç£¨ç ‚é›ªç”»çš„ç»«æ³¢å¾®ç¬‘å¤šå¥½çœ‹ã€‚ä½†å›å¤´æ¥è¯´ï¼Œä½†è¿™æ›´å¤šï¼ˆTV åæœŸå’Œ EOEï¼‰æ˜¯å¾ˆç§äººçš„ä½œå“ï¼Œç±»ä¼¼åŸå ¡è¿™æ ·ï¼ŒæŒ‡è´£ä¸–ç•Œã€æŒ‡è´£å¤§äººã€æƒ³è¦é€ƒé¿åˆæƒ³æ‹¥æŠ±ï¼Œæ›´å¤šæ˜¯ä¸€ç§ç—›è‹¦çš„è‡ªæˆ‘è¡¨è¾¾å’Œä¸€äº›æ¯’ç”µæ³¢ï¼Œè¿™äº›æ°å¥½æ˜¯å‘½ä¸­æ—¶ä»£å‘½è„‰çš„ã€‚åºµé‡ç§€æ˜è¡¨è¾¾å®Œä¹‹åï¼Œè¿‡äº†è¿™ä¹ˆå¤šå¹´ï¼Œç»ˆäºæƒ³æ˜ç™½äº†ï¼Œä½†æ˜¯å’Œ eoe ä¸åŒï¼Œæˆ‘ä»¬è¢«ç”©åœ¨èº«åäº†ï¼ŒèŒ«ç„¶çš„çœ‹ç€è¿™ä¸ªåç°ä»£çš„ä¸–ç•Œã€‚ä»è¿™ä¸ªè§’åº¦ä¸Šæ¥è¯´ï¼Œç»ˆæ˜¯å¾ˆä¸é”™çš„å®Œç»“ä½œå“ï¼Œè€Œ EOEæ˜¯ä¼Ÿå¤§çš„ä½œå“ã€‚</p><h3 id="DARKER-THAN-BLACK-é»’ã®å¥‘ç´„è€…"><a href="#DARKER-THAN-BLACK-é»’ã®å¥‘ç´„è€…" class="headerlink" title="DARKER THAN BLACK -é»’ã®å¥‘ç´„è€…-"></a>DARKER THAN BLACK -é»’ã®å¥‘ç´„è€…-</h3><p>BONESï¼Œå¥‡å¹» + å•å…ƒå‰§ã€‚ç‰¹ç‚¹æ˜¯é€¼æ ¼ã€ä¸é”™çš„æ°›å›´ã€è‰¯å¥½çš„è§’è‰²å¡‘é€ ã€å°šå¯çš„ä¸–ç•Œè§‚å’Œå¿§ä¼¤çš„æ‚²å‰§å•å…ƒå‰§ä»¬ã€‚Bones æ„Ÿè§‰ç»å¸¸æ‹ä¸€äº›è‡ªå·±ä¹Ÿè®²ä¸æ¸…å‰§æƒ…çš„ç‰‡ï¼Œé å•å…ƒå‰§å’Œä¼˜ç§€çš„æ¼”å‡ºã€é€¼æ ¼å’Œè§’è‰²é¡¶ä¸Šå»ã€‚</p><h3 id="æ­Œå‰§å°‘å¥³ï¼ï¼-ã‹ã’ãã—ã‚‡ã†ã˜ã‚‡"><a href="#æ­Œå‰§å°‘å¥³ï¼ï¼-ã‹ã’ãã—ã‚‡ã†ã˜ã‚‡" class="headerlink" title="æ­Œå‰§å°‘å¥³ï¼ï¼(ã‹ã’ãã—ã‚‡ã†ã˜ã‚‡!!)"></a>æ­Œå‰§å°‘å¥³ï¼ï¼(ã‹ã’ãã—ã‚‡ã†ã˜ã‚‡!!)</h3><p>æ¼«æ”¹ï¼Œè¢«åˆ¶ä½œé™åˆ¶çš„éå¸¸å¤šçš„åŠ¨ç”»ï¼Œ11-12 å¤–åŒ…å›ä¸ç¦è®©äººå¹æ¯ã€‚ç›¸å¯¹äºä¸­æ–‡åç§°ç±»ä¼¼çš„ã€Šå°‘å¥³â˜†æ­ŒåŠ‡ã€‹ï¼Œæœ¬ç‰‡æœ‰ç€è¿¥ç„¶ç›¸å¼‚çš„é£æ ¼ï¼šæœ‰ç€å¹¶ä¸ç®±åº­è€Œå°é—­çš„ä¸–ç•Œã€ç€é‡èˆå°ä¸‹çš„ä¸ªäººï¼ˆå’Œæ›´è´«ç©·çš„å¤šçš„åˆ¶ä½œï¼‰ã€‚å—ç¯‡å¹…é™åˆ¶ï¼Œå‰æœŸçš„é£æ ¼å®¹æ˜“è®©è§‚ä¼—æŠŠé‡å¿ƒæ”¾åœ¨å¥‡æ€ªçš„åœ°æ–¹ï¼Œè€ŒåŠ¨ç”»åˆåœåœ¨äº†ä¸€ä¸ªå°´å°¬çš„ä½ç½®ã€‚ä½†æœ¬ç‰‡çš„è§’è‰²å¡‘é€ ç›¸åæ˜¯å‡ºå½©çš„ï¼Œä¸åŒå®¶å¢ƒã€ä¸åŒå¿ƒæ€çš„å°‘å¥³ï¼Œä¸ºäº†ç¾ä¸è¿½æ±‚å‡ºç°åœ¨äº†èˆå°ä¸‹ï¼Œçº¯ç²¹çš„ä¸ºäº†ç›®æ ‡åŠªåŠ›ã€‚å¹¶ä»¥æ­¤ä¸ºåŸºçº¿ï¼Œè´¡çŒ®äº†å‡ ä¸ªä¼˜ç§€çš„è§’è‰²å›ï¼ˆæˆ‘ä¸ªäººç›¸å½“å–œæ¬¢ Ep 8ï¼‰ã€‚æœ¬ç‰‡è´¡çŒ®äº†æˆ‘çš„å¹´åº¦æœ€å¼º EDï¼ˆå…¶å®æœ‰ä¸‰ä¸ª edï¼ŒåŒèƒèƒå”±çš„æ²¡åœ¨æ­£ç‰‡æ”¾å‡ºæ¥ï¼‰ï¼Œè¿™ä¸ª ED ä¹Ÿæ˜¯ä½œå“ä¸»é¢˜çš„ä½“ç°ï¼šè§’è‰²åœ¨åŒæ ·èˆå°ã€èº«ç©¿åŒæ ·åˆ¶æœï¼Œå´èƒ½ä»¥ä¸åŒæ–¹å¼ï¼Œå±•ç°ä¸åŒçš„ã€å±äºå¥¹ä»¬çš„é­…åŠ›ã€‚</p><h3 id="åºŸå¼ƒå…¬ä¸»"><a href="#åºŸå¼ƒå…¬ä¸»" class="headerlink" title="åºŸå¼ƒå…¬ä¸»"></a>åºŸå¼ƒå…¬ä¸»</h3><p>æ¦Šä¸€éƒ + Bones + å‰ç”°ç²å­ã€‚åœ¨ä¸­å¤çš„æ—¶ä»£ä¸­æ—…è¡Œï¼Œå·§å¦™è€Œå«è“„çš„æƒ…æ„Ÿåœ¨æ•…äº‹ä¸­æ…¢æ…¢æ±‡èšã€‚åŒæ—¶ï¼Œæ„Ÿè§‰æ•´ä¸ªæ•…äº‹ç»“æ„ç®—æ˜¯æ‹¼å‡‘åœ¨ä¸€èµ·çš„ï¼Œæ¯æ®µå•ç‹¬æ‹†å¼€æ¥çœ‹éƒ½æœ‰å¾ˆä¸é”™ï¼Œåˆåœ¨ä¸€èµ·æ„Ÿè§‰å‘³é“æ€ªæ€ªçš„â€¦å‰ç”°ç²å­è„šæœ¬ä¸æ˜¯ä¸è¡Œï¼ŒåŸä½œä¹Ÿéå¸¸æœ‰æƒ³æ³•ï¼Œä½†æ˜¯èŠ‚å¥å¤ªå¿«å¯¼è‡´æ¯ä¸€æ®µçœ‹èµ·æ¥éƒ½å¾ˆå‰²è£‚ï¼›äººç‰©å…¶å®éƒ½æœ‰ç‰¹è‰²ï¼Œä½†æ˜¯ä»å¤´åˆ°å°¾å¥³ä¸»éƒ½åˆ»æ„ä¿æŒè¿™ç§å¿«ä¹çš„çŠ¶æ€ï¼Œï¼Œæƒ³ç”¨ JRPG çš„ç®€å•æ€ç»´æ¥è§£å†³å®å¤§çš„é—®é¢˜ï¼Œç”¨æ¸©æŸ”è€Œæ²¡æœ‰è®°å¿†çš„æ€åº¦å¯¹äººï¼Œæ„Ÿè§‰æˆ‘èƒ½ç†è§£ç”¨æ„ï¼Œä½†æ˜¯ä»ç„¶è§‰å¾—å¾ˆæ€ªå¼‚ã€‚ä½†è¿™ä»ç„¶æ˜¯ä¸€éƒ¨å€¼å¾—çœ‹çš„ä½œå“ï¼ŒåæœŸæœ‰å‡ å›ç»™æˆ‘çš„æ„Ÿè§‰éå¸¸ä¹‹å¥½ã€‚</p><h3 id="å‰§å¶åƒ-ã‚²ã‚­ãƒ‰ãƒ«"><a href="#å‰§å¶åƒ-ã‚²ã‚­ãƒ‰ãƒ«" class="headerlink" title="å‰§å¶åƒ (ã‚²ã‚­ãƒ‰ãƒ«)"></a>å‰§å¶åƒ (ã‚²ã‚­ãƒ‰ãƒ«)</h3><p>2021 å¹´æœ€å¤§çš„ç¥ç»ç—…åŠ¨ç”»ã€‚æœ‰ç—…çš„ä¼åˆ’ã€æœ‰ç—…çš„å‰§ä¸­å‰§ã€æœ‰ç—…çš„å‰§æƒ…ã€è¯å‘³çš„å±•å¼€ã€‚è¿™ç‰‡ä¸ç®—å¥½çœ‹ï¼Œä¸è¿‡ç®—å¾ˆä¹å­çš„ä½œå“ï¼Œå€¼å¾—çœ‹ä¸€çœ¼ã€‚é¢‡æœ‰è‚¡å­å°å…”å­æš—é»‘æ— é™ç ´çš„å‘³é“ã€‚</p><h3 id="èµ›é©¬å¨˜-Pretty-Derby-ç¬¬äºŒå­£"><a href="#èµ›é©¬å¨˜-Pretty-Derby-ç¬¬äºŒå­£" class="headerlink" title="èµ›é©¬å¨˜ Pretty Derby ç¬¬äºŒå­£"></a>èµ›é©¬å¨˜ Pretty Derby ç¬¬äºŒå­£</h3><p>2021 å¹´æœ€çƒ­çš„ä½œå“ä¹‹ä¸€ï¼Ÿå¾ˆæ£’ï¼Œéå¸¸æ£’ï¼Œå…¶å®ç›‘ç£æ¼”å‡ºæ°´å¹³æ²¡æœ‰æ¯”å‰åº§é«˜å‡ºä¸€ç­¹ï¼Œä½†æ˜¯è„šæœ¬å’ŒèŠ‚å¥å®åœ¨æ˜¯å¥½äº†ä¸å°‘ã€‚ç›¸å¯¹äºå‰ä½œä¸çŸ¥é“å“ªæ¥çš„ä¾¿å®œè€å¦ˆå’Œä¾¿å®œå¯¹æ‰‹ï¼Œè¿™ä¸€ä½œä»¥ä¼¤ç—…ã€ç†æƒ³å’Œç¾ç»Šä½œä¸ºä¸»è½´ï¼Œåœ¨èµ›åœºä¸Šå’Œèµ›åœºä¸‹åšæŒè¿™ä¸€åˆ‡ï¼ŒåŠ ä¸Š cy çœŸçš„æœ‰é’±ï¼Œæ‰€ä»¥æ•ˆæœçœŸçš„ä¸é”™ã€‚ä½†æ˜¯å®é™…ä¸Šæ„Ÿæƒ…çš„çˆ†å‘é€šå¸¸ä»…ä»…ä»¥ä¸€é›†ä¸ºç•Œï¼Œå°‘äº†é‚£ç§ä¸€é¼“ä½œæ°”çš„ç•…å¿«ï¼Œâ€œä¸ºä»€ä¹ˆè¦è·‘æ­¥â€ä¹Ÿæ˜¯ä½œä¸ºä¸€ç§èƒŒæ™¯æ¿ï¼Œè€Œä¸æ˜¯ä½¿å‘½ã€è´£ä»»ã€æ›´å¿«æ›´é«˜æ›´å¼ºçš„ç²¾ç¥â€”â€”è¿™æœ‰ç‚¹è‹›è´£äº†ï¼Œä½†æ˜¯æˆ‘æ²¡æœ‰åœ¨ä¸Šé¢çœ‹åˆ°æ›´é­‚çš„ä¸œè¥¿ï¼Œè¿˜æ˜¯å¾ˆé—æ†¾çš„ï¼ŒçœŸçš„å¾ˆé—æ†¾ã€‚</p><h3 id="é›„ç‹®å°‘å¹´"><a href="#é›„ç‹®å°‘å¹´" class="headerlink" title="é›„ç‹®å°‘å¹´"></a>é›„ç‹®å°‘å¹´</h3><p>å¾ˆæœ‰æ¸©æƒ…çš„ç‰‡å­ã€‚åˆ†é•œåˆæ ¼ï¼Œå±•ç°äº†å†œæ‘åŸå¸‚é£é‡‡ï¼Œä½†åªä½œä¸ºèƒŒæ™¯æ¿ã€‚äººç‰©é™¤äº†ä¸»è§’å¤–æ¯”è¾ƒå¹³é¢ï¼Œä½†æ˜¯èƒ½ç«‹å¾—ä½ã€‚â€œèˆç‹®â€ä½œä¸ºçº¿ç´¢ï¼Œå¹¶æ²¡æœ‰é‚£ä¹ˆå¤šâ€œæ€ä¹¡â€çš„æˆåˆ†ï¼Œç›¸ååœ¨å½±ç‰‡ä¸­ï¼Œè¿™æ˜¯ä¸€ç§å¯¹æ—¥å¸¸çš„è¶…è¶Šå’Œå¯¹è‡ªæˆ‘çš„ç£¨ç ºã€‚åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œä¸»è§’å¾—ä»¥æœ‰æœºä¼šæ”¹å˜å¹¶è¶…è¶Šè‡ªæˆ‘ã€‚è€Œé‡è¦çš„æ˜¯ï¼Œè¿™ä»½è¶…è¶Šå¹¶ä¸èƒ½ç›´æ¥å½±å“ç°å®ï¼Œè¿™è®©å®ƒå®Œå…¨ä¸åŠŸåˆ©ä¸–ç•Œè„±é’©ï¼Œæˆä¸ºäº†ç²¾ç¥ä¸Šçš„â€œç‹®å­â€çš„è¯æ˜ï¼Œä¹Ÿè§è¯äº†â€œå°¼é‡‡ä¸‰å˜â€ï¼Œè¿™æ°æ°æ˜¯æœ€å·§å¦™çš„ä¸€ç‚¹ã€‚åœ¨å¹¿å·é‚£æ®µè’™å¤ªå¥‡ç›¸å½“æ£’ï¼Œåœ¨æ¥¼ä¸Šè·³èˆå¾ˆåƒå‘¨æ˜Ÿé©°çš„ç”µå½±ï¼Œè€Œèˆç‹®å¼€å§‹åˆå¾ˆåƒç¬¬ä¸‰æ–°ä¸œäº¬å¸‚ä¸Šç­çš„åœºæ™¯ï¼Œä»è§‚ä¼—åˆ°å°ä¸Šä¹Ÿè®©æˆ‘æƒ³èµ·äº†å°‘æ­Œep1ã€‚ä¸è¿‡è¯´åˆ°åº•è¿™ç‰‡èˆç‹®å°±æ˜¯ä¸€ä¸ªç²¾ç¥ä¸–ç•Œè±¡å¾ï¼Œè€Œä¸æ˜¯ä¸€é¡¹æŠ€è‰ºï¼Œè«åæŒºä¸å›½äº§ç‰‡çš„ã€‚</p><h3 id="æ‚é¡¹"><a href="#æ‚é¡¹" class="headerlink" title="æ‚é¡¹"></a>æ‚é¡¹</h3><ul><li>SSSS.DYNAZENON ï¼šå¾ˆé’æ˜¥çš„ç‰‡å­ã€‚åˆšçœ‹çš„æ—¶å€™é¢„æœŸå¾ˆä½ï¼Œä½†æ„å¤–è¿˜å¯ä»¥ã€‚æ²¡ä»€ä¹ˆå¤§äº‹çš„å¿§ä¼¤å›å¿†ã€å¹¶ä¸å®åœ¨çš„æˆ˜æ–—å’Œä¼¤å®³ã€æ°åˆ°å¥½å¤„çš„å¾®å¦™æ°›å›´ä»¥åŠå¸¦æ¥è¿™ä¸€åˆ‡çš„æ¼”å‡ºã€‚ç»ç”±æ€ªå…½ä»æ—¥å¸¸åˆ°éæ—¥å¸¸ï¼Œåœ¨è¿™ä¹‹ä¸­å»ºç«‹å…³ç³»ï¼Œæœ€ååˆå›åˆ°æ—¥å¸¸ã€‚Ep10 çš„æ¼”å‡ºéå¸¸å€¼å¾—ä¸€çœ‹ã€‚</li><li>STAR DRIVER è¼ãã®ã‚¿ã‚¯ãƒˆï¼šä¸‰ä¸€è€å¸ˆå’Œæ˜´æ˜Ÿå›¢ä¸€èµ·æ¨èç»™æˆ‘çš„ç‰‡å­ã€‚æˆ‘æˆåŠŸæ„Ÿå—åˆ°äº†æ¥è‡ªæ˜´æ˜Ÿå›¢çš„æ„ŸåŠ¨ï¼Œå¹¶ä¸”æ„Ÿå—åˆ°äº†æœ¬ç‰‡ä¸­æµ“æµ“çš„é’æ˜¥æ„Ÿï¼Œä½†çœŸæ²¡ Get åˆ°è¿™ç‰‡ã€‚å‰§ä¸­å‰§å¾ˆä¸é”™ã€‚</li><li>86: æ²¡æ’­å®Œæ‰€ä»¥ä¸å†™äº†â€¦è¿™ç‰‡éå¸¸åŠ¨ç‰©å›­ç§æ—ä¸»ä¹‰ï¼Œæƒ…æ„Ÿè¡¨è¾¾ä¹Ÿå¾ˆç›´æ¥ï¼Œå°±ç›´æ¥å¿ƒç†æå†™çš„é‚£ç§ã€‚å…¶å®æˆ‘æ›´å–œæ¬¢å¡æ—æ ¼è¿™ç§å«è“„ä¸€ç‚¹çš„é€¼é€¼å¨å¨ã€‚ä½†è¿™ç‰‡ç¬¬ä¸€å­£ç»“å°¾åˆ°ç¬¬äºŒå­£çš„æ¼”å‡ºçœŸçš„éƒ½å¾ˆä¸é”™ï¼Œè€Œæˆ‘æ°å¥½è¿˜ä¸­äºŒï¼Œä¹Ÿèƒ½æ¥å—è¿™ç§è¡¨è¾¾ï¼ˆå¯èƒ½ä¸åŒäººæ¥å—ç‚¹ä¸ä¸€æ ·ï¼Œæˆ‘èƒ½æ¥å—è¿™ç§åŠ¨ç‰©å›­ç§æ—ä¸»ä¹‰ã€å¥‡æ€ªè¡¨è¾¾ï¼Œå´æ¥å—ä¸æ¥å¤æ—¥å¤§ä½œæˆ˜é‚£ç§åœŸå‰§æƒ…â€¦ï¼‰ã€‚æ–°äººç›‘ç£æ²¡å®‰æ’å¥½å·¥æœŸæ„Ÿè§‰ä¹Ÿèƒ½æ¥å—å§ã€‚ç•™æ˜å¹´å†™å§ã€‚</li></ul><h2 id="Game"><a href="#Game" class="headerlink" title="Game"></a>Game</h2><h3 id="ãƒãƒ«ã‚³ã¨éŠ€æ²³ç«œ"><a href="#ãƒãƒ«ã‚³ã¨éŠ€æ²³ç«œ" class="headerlink" title="ãƒãƒ«ã‚³ã¨éŠ€æ²³ç«œ"></a>ãƒãƒ«ã‚³ã¨éŠ€æ²³ç«œ</h3><p>TOKYOTOON ä½œå“ï¼Œç”µæ³¢ç³»å–œå‰§ï¼Œ4-5å°æ—¶å°±èƒ½æ¨å®Œï¼Œå±äºçŸ­å¹³å¿«ã€‚CG é‡å¤§å……è¶³ã€åŠ¨ç”»ä¹Ÿåšçš„å¾ˆä¸é”™ï¼ˆè¿˜ä¸Šè¿‡ä½œç”» madï¼Ÿï¼‰ã€‚å‰§æœ¬å±äºä¸èƒ½æ·±ç©¶å°±çœ‹çš„å¾ˆæ„‰å¿«çš„ã€‚è™½ç„¶äººç‰©åœŸã€æ•…äº‹åœŸè€Œä¸”å³è§†æ„Ÿå¾ˆå¼ºã€å‰§æƒ…é—´å‰²è£‚æ„Ÿä¹Ÿæ¯”è¾ƒå¼ºï¼Œä½†æ˜¯å› ä¸ºä½œå“åŸºè°ƒæœ‰ç‚¹æ— å˜å¤´ç”µæ³¢ï¼Œæ‰€ä»¥ç©çš„æ—¶å€™ä¹Ÿä¸ä¼šå¤ª Careã€‚å››äº”ä¸ªå°æ—¶æ¸¸æˆæ—¶é—´é‡Œå…¨ç¨‹éƒ½èƒ½æè¿™ä¹ˆæ¬¢å¿«ä¹Ÿä¸å¤šè§ã€‚è®©æˆ‘ä»¬äº«å—è¿™ä¸€åˆ‡å§ï¼</p><h3 id="è“å®çŸ³èˆ¬çš„è¢«å®³å¦„æƒ³å°‘å¥³"><a href="#è“å®çŸ³èˆ¬çš„è¢«å®³å¦„æƒ³å°‘å¥³" class="headerlink" title="è“å®çŸ³èˆ¬çš„è¢«å®³å¦„æƒ³å°‘å¥³"></a>è“å®çŸ³èˆ¬çš„è¢«å®³å¦„æƒ³å°‘å¥³</h3><p>åŸæ©™å…‰ä½œå“ï¼Œç° Steam ä¸Šæœ‰å”®ï¼Œå¸¦ç‚¹ç¤¾ä¼šæ´¾æ¨ç†å‘³é“çš„ä½œå“ã€‚å°æ¸¸æˆéå¸¸è›‹ç–¼ã€‚æ¸¸æˆè™½ç„¶åˆ¶ä½œæ¯”è¾ƒç®€é™‹ï¼Œä½†æ˜¯çœŸåˆ‡å±•ç°äº† 80-00 å¹´ä»£çš„é£è²Œï¼Œåœ¨è§†è§’è½¬æ¢ã€è§’è‰²å¡‘é€ ã€æ‚¬ç–‘æ–¹é¢éƒ½æ¯”è¾ƒåˆ°ä½ï¼Œä»é¥è¿œè®°å¿†ä¸­çš„ä¹¦ä¿¡ï¼Œåˆ°ä¸€ä»¶ä»¶æ¡ˆå­ï¼Œæœ€ååˆ°æ³•ä¸æƒ…ã€‚åœ¨å¦„æƒ³ä¸ç°å®ä¸­åˆ‡æ¢ï¼Œè·¨è¶Šæ¼«é•¿çš„æ—¶é—´ï¼Œè€Œåœ¨è¿™æœŸé—´æˆ‘ç¡®å®æ„Ÿå—åˆ°äº†è¶³å¤Ÿçš„é­…åŠ›ã€‚</p><h3 id="è‹±é›„ä¼èª¬VI-ç©ºã®è»Œè·¡FC"><a href="#è‹±é›„ä¼èª¬VI-ç©ºã®è»Œè·¡FC" class="headerlink" title="è‹±é›„ä¼èª¬VI ç©ºã®è»Œè·¡FC"></a>è‹±é›„ä¼èª¬VI ç©ºã®è»Œè·¡FC</h3><p>éå¸¸è‘—åçš„ JRPGï¼Œåœ¨å¡å¡å¸ƒä¸‰éƒ¨æ›²ä¹‹åçš„è‹±é›„ä¼ è¯´ï¼Œä¹Ÿæ˜¯è½¨è¿¹ç³»åˆ—çš„å¼€å§‹ã€‚ä½œä¸ºåˆ†å‰²å•†æ³•çš„ä¸€éƒ¨åˆ†ï¼ŒFC/SC åˆ†å‰²çš„åº”è¯¥æ˜¯éå¸¸è‡ªç„¶çš„ã€‚ç§ä»¥ä¸ºç©ºä¹‹è½¨è¿¹çš„ç³»ç»Ÿæœ‰ç‚¹æ—§ï¼Œåˆ·æ€ªä½“éªŒä¹Ÿæ€ªæ€ªçš„ï¼Œæˆ˜æ–—å’Œæ¼”å‡ºç»“åˆçš„ä¸€èˆ¬èˆ¬ã€‚ä½†æ˜¯è¿™ä½œæ»¡è¶³äº† Falcom çš„ç†å¿µï¼Œä¸åŒè§’è‰²æä¾›äº†è¶³é‡çš„å¯¹è¯ï¼Œè®©è¿™ä¸ªå°å°çš„ç‹å›½ï¼ˆä¼°è®¡è¿˜æ²¡æ±Ÿè¥¿çœå¤§ï¼‰çš„ä¸åŒåœ°åŒºå……æ»¡äº†é­…åŠ›å’Œå……ç›ˆçš„ä½“éªŒã€‚ç©å®¶å’Œè§’è‰²ä¸€èµ·ï¼Œåœ¨è¿™ä¸ªæ¸©æŸ”çš„ä¸–ç•Œä¸­ï¼Œç”¨è„šæ­¥ä¸ˆé‡å›½åœŸã€ç»“è¯†ä¼™ä¼´ã€ä¸€èµ·è§£å†³é‡å¤§çš„é—®é¢˜ã€‚æœ‰çš„è§‚ç‚¹å¹¶ä¸å®Œç¾ï¼Œæœ‰ç‚¹ JRPG çš„æ‹§å·´å‘³ï¼Œä½†è¿™ç§è¿‡äºç¾å¥½çš„ä½“éªŒã€å°‘å¹´å†’é™©çš„æ•…äº‹è¿˜æ˜¯å¾ˆ JRPG é†é†å‘³çš„ã€‚</p><p>FC æ‰“äº†æˆ‘å›½åº†å‰ä¸€ä¸ªæœˆå’ŒåŠä¸ªå›½åº†ï¼Œå¯¼è‡´æˆ‘æ— åŠ›æ‰“ SC äº†ï¼Œåé¢æ˜¯äº‘çš„ã€‚</p><h3 id="It-Takes-Two"><a href="#It-Takes-Two" class="headerlink" title="It Takes Two"></a>It Takes Two</h3><p>åŒäººæ¸¸æˆçš„ä¸€ä¸ªæ–°è§†è§’ï¼Œ2021 çš„ TGA å¹´åº¦æ¸¸æˆï¼Œå’Œç½‘å‹ Rsygg(å¾å©šä¸­) ä¸€èµ·æ‰“çš„ã€‚å‰ä¸­æœŸè™½ç„¶ç¼åˆï¼Œä½†æ˜¯è§†è§‰ä½“éªŒå’Œæ¸¸ç©ä½“éªŒçœŸçš„ä¸é”™ï¼Œæ¯ä¸€èŠ‚éƒ½æœ‰æ–°çš„ä½“éªŒå’Œç•…çˆ½çš„æ–¹å¼ï¼Œå¯ä»¥è¯´æ˜¯å¾ˆæè‡´çš„â€œæ¸¸æˆâ€äº†ï¼ˆä¸è¿‡æœ‰çš„åœ°æ–¹æœ‰ç‚¹è«åæ¯’ç”µæ³¢ï¼Œä½ è¯´ä½ ä¸ºå•¥è¦æ€å°è±¡å‘¢ï¼Œæœ‰ç—…å§ï¼‰ï¼ŒåæœŸå…³å¡æ¶‰åŠæœ‰ç‚¹ä¸‹é™ï¼Œä½“éªŒä¹Ÿå·®äº†ç‚¹ï¼Œä½†æ˜¯è§†è§‰æ•ˆæœè¿˜æ˜¯åˆ°ä½çš„ã€‚æœ€åï¼Œç¡®å®æ˜¯ä¸€ä¸ªå¾ˆæ£’çš„åŒäººæ¸¸æˆã€‚</p><h3 id="é‡‘è‰²ãƒ©ãƒ–ãƒªãƒƒãƒã‚§"><a href="#é‡‘è‰²ãƒ©ãƒ–ãƒªãƒƒãƒã‚§" class="headerlink" title="é‡‘è‰²ãƒ©ãƒ–ãƒªãƒƒãƒã‚§"></a>é‡‘è‰²ãƒ©ãƒ–ãƒªãƒƒãƒã‚§</h3><p>SAGA PLANET è¿™å‡ å¹´æ··çš„å¥½åƒæŒºå¥½çš„ã€‚æˆ‘ Galgame æ¨çš„æ¯”è¾ƒå°‘ï¼Œå…¶ä¸­å¾ˆå¤§ä¸€éƒ¨åˆ†æ¸¸æˆåè€Œæ›´ä¾§é‡äºç”·ä¸»çš„æç»˜ï¼Œè¯´æ¥ Galgame è¿™ä¸ªè¯ä¸æ˜¯ã€Œç¾å°‘å¥³æ¸¸æˆã€çš„æ„æ€å—ï¼æœ¬ä½œåˆ™æ˜¯å½»å¤´å½»å°¾çš„ã€Œç¾å°‘å¥³æ¸¸æˆã€ï¼Œå±•ç°å¥³ä¸»è§’é­…åŠ›çš„ä½œå“ï¼Œè¿™ä¹Ÿå¯¼è‡´å¾ˆéš¾ç»™ç”·ä¸»å®šä½ã€‚æ—¥å¸¸ neta å¾ˆå¤šå¾ˆæ£’ï¼Œæ­£ç»è®¨è®ºæ˜¯æºæ°´çš„ï¼šä¸Šæµç¤¾ä¼šçš„èƒŒæ™¯ç»ˆç©¶åªæ˜¯ä¸ªå¹Œå­ï¼Œè€Œä¸æ˜¯å‰è¿›çš„å¿…è¦æ¨åŠ¨åŠ›ã€‚å…¶å®è¿™ä¹ˆå¤šçº¿å¤šå°‘å°±ä¸»é¢˜å°±æ˜¯ã€Œè‡ªå·±ã€çš„å¯¹ç«‹ä¸ç»Ÿä¸€ï¼Œå’ŒåŠªåŠ›å¥‹æ–—å„¿ã€‚ä½œä¸ºæ­£ç»è¯„ä»·æ¥è¯´ï¼Œå¾ˆéš¾å®šè®ºè¡¨è¿°çœŸçš„åˆæ ¼äº†ã€‚å½“ç„¶ï¼Œè¯´äº†è¿™ä¹ˆå¤šï¼Œä¹Ÿå°½ç®¡çŸ¥é“æ˜¯æ”¾åˆ€å­ï¼Œå¥³ä¸»çš„é­…åŠ›ä¾ç„¶æ— ä¸ä¼¦æ¯”ã€‚</p><h2 id="Novel"><a href="#Novel" class="headerlink" title="Novel"></a>Novel</h2><p>æ€»ç»“çš„æ—¶å€™æ‰çŸ¥é“ï¼Œ2021 å¹´çœ‹çš„å¤ªå°‘äº†â€¦ äº‰å– 2022 å¹´å¤šçœ‹ç‚¹</p><h3 id="BEATLESS"><a href="#BEATLESS" class="headerlink" title="BEATLESS"></a>BEATLESS</h3><p>æœºå™¨äºº/bmg/é•¿è°·æ•å¸ã€‚æ¯”è¾ƒå‡ºä¹æˆ‘æ„æ–™çš„ä½œå“ã€‚è‡ªå¼—å…°è‚¯æ–¯å¦ä»¥é™ï¼ŒSF ä¸­çš„ã€Œæœºå™¨äººã€ä»¥äººç±»çš„ä»–è€…ã€æŠ€æœ¯ï¼ˆä¸ä¸€å®šæ˜¯æ­£é¢çš„ï¼‰çš„ä»£è¡¨ã€å·¥å…·ç†æ€§çš„å®ç°è€…ã€äººç±»è‡ªå·±å¡‘é€ çš„ç¥æ˜ã€‚é˜¿è¥¿è«å¤«æœ‰æœºå™¨äººå­¦ï¼Œç¼”é€ äº†æœºå™¨äººçš„ä¸‰æ³•åˆ™ï¼Œè¯•å›¾å’Œå–„æ„çš„æœºå™¨äººèµ°ä¸‹å»ï¼›ã€Šå¤ªç©ºæ¼«æ¸¸2001ã€‹åˆ™ç²—æš´è€Œéœ‡æ’¼ï¼Œäººç±»ææ­»äº†æœºå™¨äººâ€”â€”è‡ªå·±çš„é€ ç‰©â€”â€”æ¥èµ°å‘æ›´é«˜çš„ä¸€æ­¥ã€‚Beatless æè¿°çš„æ˜¯æœºå™¨äººæœ‰éå‡¡æ™ºæ…§ã€ä½†åªæœ‰å·¥å…·ç†æ€§ã€ä¹Ÿå—åˆ°äººç±»é™åˆ¶çš„ä¸–ç•Œã€‚è¿™ä¸ªä¸–ç•Œä¸­ï¼Œä¸»è§’é€‰æ‹©äº†å°†ä¸€åˆ‡å¤æ‚çš„è¿ä½œäº¤ç»™æœºå™¨äººã€‚é¢å¯¹è™šå¹»çš„ç¤¾ä¼šå’Œæ—©å·²åº¦è¿‡çš„å¥‡ç‚¹ï¼Œäººç±»åœ¨æ¼«é•¿çš„å¦è®¤ä¹‹åé‡æ–°è®¤å¯äº†è‡ªå·±çš„èƒ½åŠ¨æ€§ï¼Œç„¶åä¸å®‰çš„æœºå™¨äººä¹Ÿè·å¾—äº†äººç±»çš„ä¿¡ä»»ã€‚æˆ–è®¸è¿™æœ¬ä¹¦é˜…è¯»ä½“éªŒå¹¶ä¸å‹å¥½ï¼Œä¸è¿‡å¾ˆä¹…æ²¡çœ‹åˆ°è¿™ä¹ˆæµªæ¼«çš„ä½œå“äº†ã€‚</p><h3 id="ç››å¤ä¹‹é—¨"><a href="#ç››å¤ä¹‹é—¨" class="headerlink" title="ç››å¤ä¹‹é—¨"></a>ç››å¤ä¹‹é—¨</h3><p>æµ·å› è±å› è‘—åçš„ã€ŒçŒ«ã€ï¼Œå›½å†…å‡ºç‰ˆçš„å°é¢éƒ½æ²¡æœ‰çŒ«çš„ï¼ŒçœŸçš„åƒåœ¾ã€‚ä¸å…¶è¯´æœ¬ä¹¦æ˜¯ä¸ªç§‘å¹»ï¼Œä¸å¦‚è¯´æ˜¯ä¸ªæµ·å› è±å› çš„ã€Œå·¥ç¨‹å¸ˆæµªæ¼«ã€è¡¨è¿°å’Œå–œå‰§å°å“ã€‚è¯´å¥é¢˜å¤–è¯ï¼Œé˜¿è¥¿è«å¤«å†·æˆ˜é‚£ä¼šå„¿ä¸å†™ SF äº†ï¼Œå»å†™äº†ä¸å°‘ç§‘æ™®ä½œå“ï¼Œæ¥é¼“åŠ±ç¾å›½äººå‚ä¸ç§‘æŠ€ã€‚è€Œã€Šç››å¤ä¹‹é—¨ã€‹æ— ç–‘æ˜¯ä¸€éƒ¨ã€Œå·¥ç¨‹å¸ˆè¿·ã€ä½œå“ï¼Œä½ èƒ½æ„Ÿå—åˆ°åœ¨å…¶ä¸­åˆ›é€ çš„çƒ­æƒ…ã€‚ä½•å†µè¿˜æœ‰ä¸€åªçŒ«ï¼ä¸€åªçŒ«ï¼ä¸€åªçŒ«ï¼è‡³äºæ•…äº‹æœ¬èº«å€’æ˜¯æ„Ÿè§‰è¢«å€Ÿé‰´å¤ªå¤šäº†ï¼Œå¤šå°‘æœ‰ç‚¹ä¹å–„å¯é™ˆã€‚</p><h3 id="ç›²è§†"><a href="#ç›²è§†" class="headerlink" title="ç›²è§†"></a>ç›²è§†</h3><p>éå¸¸ç¡¬çš„ç§‘å¹»ï¼Œæœ‰ç§æŠŠ SF å†™æˆå­¦æœ¯ç ”è®¨çš„æ„Ÿè§‰ï¼Œä½œè€…ç¬”åŠ›å…¶å®ä¸å¤ªè¡Œï¼Œå¾ˆå¤šå¤æ‚çš„æå†™ç»™è¯»è€…çš„æ„Ÿè§‰æ˜¯ã€Œå¾ˆå¤æ‚ã€ï¼Œæˆ‘å¿ƒæƒ³ä½ å†™ä¸å‡ºå­—å¯ä»¥æ‰¾äººç”»ä¸ªè‰ºæœ¯ç”»å˜›ã€‚æœ¬ä½œè®¾å®šç›¸å¯¹è¾ƒå¤šä¸”æ¯”è¾ƒæœ‰æ„æ€ï¼Œæœ‰ç€ã€Œå¤©å ‚ã€ã€Œå¸è¡€é¬¼ã€ã€Œç½—å¤ã€ã€Œæ„Ÿæƒ…æ“ä½œã€ã€Œç²¾ç¥åˆ†è£‚ã€ç­‰è¿‡å¤šçš„ç§‘å¹»å…ƒç´ ï¼Œä½†æ•…äº‹æ€§å…¶å®ç›¸å¯¹å¼±ä¸€äº›ï¼Œè€Œä¸”éƒ¨åˆ†æ•…äº‹å’Œè®¾å®šç»“åˆçš„ä¸æ˜¯å¾ˆå¥½ï¼Œå¸è¡€é¬¼çš„è®¾å®šæ˜¯å¾ˆè‡ªç„¶çš„æ¨å¯¼å‡ºæ¥çš„ï¼Œè€äººå¯»å‘³çš„æ˜¯å¸è¡€é¬¼æœ€åçš„ç»“æœã€‚ç½—å¤/æ”€çˆ¬è€…å’Œç›²è§†çš„è®¾å®šç»™è¶³äº†ï¼Œä½†æ˜¯è¯»èµ·æ¥å´å¾ˆä¸è‡ªç„¶å¾ˆç—›è‹¦ã€‚æœ€åï¼Œçœ‹ä¼¼ç¡¬æ ¸çš„ SFï¼Œåè€Œè¡¨ç°äº†ç§‘å¹»é‡Œé¢æµ“æµ“çš„çˆ±ã€‚SF å°±æ˜¯çˆ±ï¼Œçˆ±å°±æ˜¯ SFï¼</p><p>å¸Œæœ›ä½œè€…èƒ½æˆé•¿ä¸ºè¿™ä¸€ä»£çš„å¼—è¯ºæ–‡å¥‡ã€‚</p><h3 id="ä»˜å–ªå ‚éª¨è‘£åº—"><a href="#ä»˜å–ªå ‚éª¨è‘£åº—" class="headerlink" title="ä»˜å–ªå ‚éª¨è‘£åº—"></a>ä»˜å–ªå ‚éª¨è‘£åº—</h3><p>è½»å°è¯´ï¼Œå‰é¢è¯»èµ·æ¥æ„Ÿè§‰åƒä½é…æ•…äº‹ä¼š+å¥‡å¹»ï¼Œåå•å…ƒå‰§çš„å½¢å¼ï¼Œé€‚åˆåœ¨é©¬æ¡¶ä¸Šçœ‹ï¼ˆè¯·ä¸è¦çœŸçš„è¿™æ ·åšï¼Œä¸ºäº†ä½ çš„è‚ å­å’Œå±è‚¡ï¼‰ã€‚å•å…ƒå›è´¨é‡å‚å·®ä¸é½ã€‚ä½†æ˜¯ä½œè€…å¤§çº²æŠŠæ§åº”è¯¥æ˜¯ä¸€ç›´åœ¨çº¿çš„ï¼ŒæŸäº›ä¼ç¬”ç«Ÿç„¶çœŸçš„éƒ½ç”¨ä¸Šäº†ã€‚5/6/7 å·è´¨é‡ç¨³æ­¥ä¸Šå‡ï¼Œå‰é¢æ‰€æœ‰çš„æ•…äº‹éƒ½æ˜¯ä¸ºäº†è¿™ä¸ªç››å¤§çš„èˆå°å±•å¼€çš„ï¼ŒæŠŠå‰é¢çš„ã€Œbugã€éƒ½å±•å¼€çš„åŒæ—¶ï¼Œä¹Ÿåœ¨æ„Ÿæƒ…ä¸Šè·Ÿè¯»è€…è¾¾æˆäº†ä¸€ç§åŒæ­¥ï¼Œç»™äº†ä¸€ä¸ªæ— æ¯”ç››å¤§çš„ Boy Meets Girl æ•…äº‹ã€‚ä½œä¸ºå°è¯´è´¨é‡å€¼å¾—è®¨è®ºï¼Œä½†æ˜¯ç¡®å®æ˜¯æœ€é€‚åˆã€Œè½»å°è¯´ã€è¿™æ ·é¢˜æçš„æµªæ¼«ä½œå“ã€‚</p><h2 id="Comic"><a href="#Comic" class="headerlink" title="Comic"></a>Comic</h2><p>æˆ‘æ¼«ç”»å‘æ¥çœ‹çš„å¾ˆå°‘ï¼Œç›¸å¯¹ 2020 å¹´åŸºæœ¬ä¸Šåªçœ‹äº†ã€Šç¾ä¼¦Xã€‹ï¼Œä»Šå¹´è¿˜ç®—å¤šäº›ï¼Ÿ</p><h3 id="æˆæƒ çš„ä¸–ç•Œ-æˆæµã®ä¸–ç•Œ"><a href="#æˆæƒ çš„ä¸–ç•Œ-æˆæµã®ä¸–ç•Œ" class="headerlink" title="æˆæƒ çš„ä¸–ç•Œ(æˆæµã®ä¸–ç•Œ)"></a>æˆæƒ çš„ä¸–ç•Œ(æˆæµã®ä¸–ç•Œ)</h3><p>è‚Œè‚¤å¦‚é›ªè€å¸ˆæ¨èã€‚è¿è½½æ—¶é—´æ¯”è¾ƒé•¿çš„ä½œå“ï¼Œåä½™å¹´åªæœ‰åæ¥å·ï¼Œç¿»è¯‘ä¹Ÿä¸å¤ªè¡Œï¼Œæœ‰è¿‡åŠ¨ç”»æ”¹ç¼–ï¼Œä½†è´¨é‡ä¹Ÿä¸€èˆ¬ã€‚ä¹Ÿæ˜¯æ—¥æœ¬æ˜Ÿäº‘èµå¾—ä¸»ã€‚æœ¬ä½œæœ‰å­¤åƒ»çš„å¤–æ˜Ÿäººã€æ²¡ä»€ä¹ˆç‰¹ç‚¹çš„å­¦ç”Ÿã€å¹¶ä¸ä¼˜ç§€çš„æœºå™¨äººï¼Œåœ¨è¿™ä¸ªæ—¥å¸¸å¤¹æ‚ç§‘å¹»çš„æ¼«ç”»ä¸­ï¼Œè§’è‰²å®Œç¾å±•ç°äº†ã€Œå°å°çš„æˆ‘è¢«è¢«äººæ‰€çˆ±ï¼Œæ‰€ä»¥è¦å›é¦ˆè¿™ä»½çˆ±ã€çš„ä¸»é¢˜ã€‚è€Œå¸¦æœ‰å¥‡å¹»ç”šè‡³æ°‘ä¿—æ€§è´¨çš„ã€ŒçŒ«/é¼ /è›‡ã€çš„è®¾å®šè´¯ç©¿å…¨ç¯‡ï¼Œä¹Ÿç»™äº†ä½œå“æ‚ é•¿å´åºå¤§çš„å¼ åŠ›ã€‚</p><h3 id="å³ä½¿å¦‚æ­¤å°é•‡è¿˜æ˜¯è½¬ä¸ªä¸åœ-ãã‚Œã§ã‚‚ç”ºã¯å»»ã£ã¦ã„ã‚‹"><a href="#å³ä½¿å¦‚æ­¤å°é•‡è¿˜æ˜¯è½¬ä¸ªä¸åœ-ãã‚Œã§ã‚‚ç”ºã¯å»»ã£ã¦ã„ã‚‹" class="headerlink" title="å³ä½¿å¦‚æ­¤å°é•‡è¿˜æ˜¯è½¬ä¸ªä¸åœ(ãã‚Œã§ã‚‚ç”ºã¯å»»ã£ã¦ã„ã‚‹)"></a>å³ä½¿å¦‚æ­¤å°é•‡è¿˜æ˜¯è½¬ä¸ªä¸åœ(ãã‚Œã§ã‚‚ç”ºã¯å»»ã£ã¦ã„ã‚‹)</h3><p>æˆ‘çš„å¹´åº¦æœ€ä½³æ¼«ç”»ï¼Œå¸¦ä¸€ç‚¹ SF çš„æ—¥å¸¸ç³»ä½œå“ï¼Œé•¿é¸¿æœ‰ç¿»è¯‘ä¸ºã€Šå¥³ä»†å’–å•¡å…ã€‹ï¼Œä½†è¿™æ ‡é¢˜å…¶å®è›®ä¸æ°å½“çš„ã€‚Shaft æ›¾ç»åŠ¨ç”»åŒ–è¿‡ä¸€ç‰ˆï¼Œä½†æˆ‘æ„Ÿè§‰åŠ¨ç”»åŒ–çš„æ°å¥½æ²¡æœ‰ä½“ç°å‡ºæœ¬ä½œçš„é†é†å‘³ã€‚</p><p>çŸ³é»‘æ­£æ•°æ˜¯ä¸€ä¸ªéå¸¸ã€éå¸¸æœ‰æƒ³æ³•çš„ä½œè€…ï¼Œèƒ½å°† SFã€æ¨ç†ç­‰å¤æ‚çš„å…ƒç´ ç³…åˆåˆ°æ—¥å¸¸æ¼«ç”»ä¸­ï¼Œå¹¶æ„é€ å‡ºæˆ–æ¸©é¦¨ã€æˆ–é«˜æ•ˆã€æˆ–æƒŠæ‚šçš„æ•…äº‹ã€‚æœ¬ä½œçš„æ—¶é—´é¡ºåºæ˜¯ä¹±åºçš„ï¼ŒçŸ³é»‘æ­£æ•°æç»˜è¿™äº›æ•…äº‹çš„æ—¶å€™ï¼Œæˆ–ä»å¹³å‡¡çš„æ•…äº‹ä¸­å¯»æ‰¾åˆ°æ„ä¹‰ï¼Œæ¯”å¦‚å¼Ÿå¼Ÿç¬¬ä¸€æ¬¡åº¦è¿‡åˆå¤œå‘ç°ä¸€å¤©å°±åœ¨çœ¼å‰åº¦è¿‡äº†ã€å§å§å»å°å­¦çš„æ—¶å€™ï¼Œå‘ç°æ›¾ç»çš„æ•´ä¸ªä¸–ç•Œå˜å¾—å¦‚æ­¤æ¸ºå°ï¼›æœ‰ä¾§é‡äºç»“æ„çš„æ•…äº‹ï¼Œæ¯”å¦‚ç¬¬äº”å·çš„ç»“å°¾ï¼›ä¹Ÿæœ‰å•çº¯ç¬¦åˆäººç‰©å’Œå¹´é¾„çš„æƒ…æ„Ÿä¸äº’åŠ¨ã€‚åœ¨çœ‹ç¬¬ä¸€å·çš„æ—¶å€™å’Œæœ€åä¸€å·çš„æ—¶å€™ï¼Œå‰§ä¸­çš„äººç‰©å’Œæˆ‘è‡ªå·±éƒ½æœ‰äº†ä¸åŒã€‚é˜…è¯»çš„æ—¶å€™ï¼Œä»ç¬¬ä¸€å·çš„åªæœ‰å‡ ä¸ªä¸»è¦äººç‰©çš„åˆ»æ¿å°è±¡ä¸ä¸è€çƒ¦ï¼Œåˆ°æœ€åçš„æ¼«é•¿çš„å‘Šåˆ«å’Œç•™å¿µã€‚æˆ‘å·²ç»çˆ±ä¸Šäº†è¿™ä¸ªå°é•‡çš„ä¸€åˆ‡ã€‚</p><h3 id="é£ä¹‹è°·çš„å¨œä¹Œè¥¿å¡-é¢¨ã®è°·ã®ãƒŠã‚¦ã‚·ã‚«"><a href="#é£ä¹‹è°·çš„å¨œä¹Œè¥¿å¡-é¢¨ã®è°·ã®ãƒŠã‚¦ã‚·ã‚«" class="headerlink" title="é£ä¹‹è°·çš„å¨œä¹Œè¥¿å¡(é¢¨ã®è°·ã®ãƒŠã‚¦ã‚·ã‚«)"></a>é£ä¹‹è°·çš„å¨œä¹Œè¥¿å¡(é¢¨ã®è°·ã®ãƒŠã‚¦ã‚·ã‚«)</h3><p>é£ä¹‹è°·çš„åŠ¨ç”»åªæ‹äº†ä¸€ä¸ªå¼€å¤´ï¼Œæ¼«ç”»éƒ¨åˆ†æ˜¯ä¸€ä¸ªæ¼«é•¿çš„å²è¯—ï¼Œåˆšå¼€å§‹è¯»çš„æ—¶å€™æœ‰ç‚¹æ²¡é€‚åº”ï¼ˆå¯èƒ½æˆ‘çœ‹çš„æ¼«ç”»å¤ªå°‘äº†ï¼‰ï¼Œåˆ†é•œå¤šå°‘å’Œå¸¸è§çš„æ¼«ç”»é£æ ¼ä¸å¤ªä¸€æ ·ã€‚æ¼«ç”»æç»˜äº†å¸¦æœ‰ç¥æ€§çš„å¨œä¹Œè¥¿å¡åœ¨ä¸¤å›½çš„äº‰æ–—èƒŒæ™¯ä¸­ï¼Œæ¢ç´¢ä¸–ç•Œå¹¶å¸¦ç€ä¸–ç•Œèµ°å‘æ˜å¤©çš„æ–¹å¼ã€‚</p><p>å®«å´éªè€å¸ˆæ˜¯å¾ˆçŸ›ç›¾çš„ï¼Œä½ çœ‹ä»–å–œæ¬¢é£æœºè’¸æ±½æœºé’Ÿè¡¨æœºæ¢°ï¼Œä½†æ˜¯åˆçƒ­çˆ±ç¯å¢ƒï¼Œå–œæ¬¢ç”°å›­ç‰§æ­Œä¸€æ ·çš„ç”Ÿæ´»ï¼Œå¯¹ç§‘æŠ€æŠ±ç€å¥‡æ€ªçš„æ€åº¦ã€‚æœ‰çš„æ—¶å€™æˆ‘è§‰å¾—å»ç¿»ç¿»åœ°æµ·ä¹‹ç±»çš„ä½œå“ï¼Œåè€Œæ›´èƒ½æ„Ÿå—åˆ°ä¸€äº›ä»–å—çš„å½±å“ä¹‹ç±»çš„ã€‚é£ä¹‹è°·çš„ä¸»é¢˜æˆ‘æ„Ÿè§‰å¤šå°‘æ˜¯æœ‰è¿‡ä¸€äº›å˜åŒ–çš„ï¼Œä»è™«å¯¹ç¯å¢ƒçš„å˜åŒ–ï¼Œåˆ°æœ€åã€Œç”Ÿå‘½æ˜¯é»‘æš—ä¸­çš„å…‰ã€ï¼Œè¿™ç§è±¹å˜çš„ä¸»é¢˜æœ¬èº«å°±å±•ç°äº†ä¸€ç§ç”Ÿå‘½çš„åŠ›é‡ã€‚ï¼ˆå°½ç®¡ä»–æœ¬äººè§‚ç‚¹æˆ‘å¤šå°‘è§‰å¾—ä¸è®¤å¯ï¼Ÿï¼‰</p>]]></content>
      
      
      
        <tags>
            
            <tag> acgn </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>mwish 2021 summary</title>
      <link href="/2022/01/31/mwish-2021-summary/"/>
      <url>/2022/01/31/mwish-2021-summary/</url>
      
        <content type="html"><![CDATA[<h1 id="2021-æ—¥å¸¸ç”Ÿæ´»ã€æ•´ä½“ä¹‹ç¾ä¸æˆ‘"><a href="#2021-æ—¥å¸¸ç”Ÿæ´»ã€æ•´ä½“ä¹‹ç¾ä¸æˆ‘" class="headerlink" title="2021: æ—¥å¸¸ç”Ÿæ´»ã€æ•´ä½“ä¹‹ç¾ä¸æˆ‘"></a>2021: æ—¥å¸¸ç”Ÿæ´»ã€æ•´ä½“ä¹‹ç¾ä¸æˆ‘</h1><p>éšç€ä¸­å›½æ–°å¹´çš„åˆ°æ¥ï¼Œ2021 è¿™ä¸€å¹´æœ€ç»ˆè¿˜æ˜¯èµ°åˆ°äº†å°¾å£°ï¼Œæˆ‘ä»¬åº”è¯¥æ€ä¹ˆæ ·çœ‹å¾…è¿™ä¸€å¹´ï¼Œä¼šä¸ä¼šæœ‰ä»€ä¹ˆåæ‚”ï¼Œä»¥åŠå¯¹æœªæ¥æœ‰ä»€ä¹ˆæ†§æ†¬å‘¢ï¼Ÿæˆ‘ä»¬åˆèƒ½åœ¨è¿™ä¸‰ç™¾å¤šå¤©é‡Œé¢ï¼Œå­¦ä¹ åˆ°ä»€ä¹ˆç‰¹æ®Šçš„ç»éªŒï¼Œå¯ä»¥åœ¨è¿™æ ·çš„æ™šä¸Šï¼Œé—²æš‡çš„æ—¶å…‰ä¸­å›é¡¾åˆ°è¿™ä¹ˆä¸€ç‚¹ç‚¹å°å°çš„ç»éªŒå‘¢ï¼Ÿ</p><h2 id="å·¥ä½œå’Œç”Ÿæ´»"><a href="#å·¥ä½œå’Œç”Ÿæ´»" class="headerlink" title="å·¥ä½œå’Œç”Ÿæ´»"></a>å·¥ä½œå’Œç”Ÿæ´»</h2><p>å·¥ä½œæˆ–è€…è¯´æ¯•ä¸šå·²ç»ä¸€å¹´åŠäº†ã€‚å…¶å®å‘æ¥è§‰å¾—å·¥ä½œæ²¡å•¥å¥½è¯´çš„ï¼Œä¸è¿‡ä»Šå¹´åšçš„äº‹æƒ…ä¹Ÿä¸å°‘äº†ï¼š</p><ol><li>è‡ªå·±åšçš„åˆ†å¸ƒå¼äº‹åŠ¡ä¸Šçº¿äº†ï¼ŒåŸºæœ¬ä¸Šåªæœ‰åˆ†å¸ƒå¼äº‹åŠ¡çš„éƒ¨åˆ†ï¼Œå•æœºéƒ¨åˆ†ç®—æ˜¯ä¸ªæ²¡æ€ä¹ˆæ‰“ç£¨çš„ç³»ç»Ÿï¼Œä¸è¿‡ç°åœ¨å·²ç»åœ¨30%ä»¥ä¸Šçš„é›†ç¾¤ä¸Šè·‘ç€è¿™ä¸ªåŠŸèƒ½äº†</li><li>è¡Œåˆ—æ··åˆå­˜å‚¨ä¸Šçº¿äº†ï¼Œå…¶å®åšçš„åƒä¸€ä¸ªç‰¹åˆ«ç®€å•çš„ PAXï¼Œç„¶åä¸æ”¯æŒå»¶è¿Ÿç‰©åŒ–é‚£äº›ï¼Œç®—æ˜¯çœäº† 50% ä»¥ä¸Šçš„å­˜å‚¨ç©ºé—´ï¼Ÿ</li><li>ï¼ˆä»Šå¹´æœ€é‡è¦çš„éƒ¨åˆ†ï¼Ÿåšäº†å°åŠå¹´ï¼‰Page ç£ç›˜æ ¼å¼åˆ°å†…å­˜æ ¼å¼çš„é‡æ„ï¼ŒåŸå…ˆçš„ Page åœ¨ç£ç›˜ä¸Šæ˜¯ä¸ª Thrift æ ¼å¼ï¼Œå†…å­˜ä¸­ä¼šè§£ææˆä¸€ä¸ªæœ‰åºçš„ <code>std::vector&lt;Row&gt;</code>ã€‚æˆ‘ç‹¬ç«‹æŠŠç£ç›˜æ ¼å¼æ”¹æˆäº†ä¸€ä¸ªä¸éœ€è¦è§£æçš„äºŒè¿›åˆ¶æ ¼å¼ï¼Œç„¶åå°†å†…å­˜æ ¼å¼ä¹Ÿåšäº†è¿ç»­å†…å­˜ + Delta çš„é‡æ„ã€‚ç„¶å row format ä¹Ÿæ”¹æˆäº†ç±»ä¼¼ MySQL InnoDB Compact çš„æ ¼å¼ï¼Œåœ¨å„ç§æµ‹è¯•ç¯å¢ƒä¸‹æœ‰ 30%-ä¸€å€çš„æ€§èƒ½æå‡å’Œå ç”¨ç©ºé—´çš„å‡å°ã€‚</li></ol><p>è¿™ä¹ˆä¸€çœ‹å…¶å®ä»Šå¹´å‹æ ¹æ²¡åšå¤šå°‘äº‹ï¼Œå½“7æœˆä»½ï¼Œæˆ‘å¹²æ´»æˆ‘ä»¬ç»„æ–°äººæ¥é—®æˆ‘ã€Œä¸€å¹´ä»¥æ¥åšäº†ä»€ä¹ˆã€ï¼Œæˆ‘é™¡ç„¶å‘è§‰ï¼Œå¯¹ç€å·¥ä½œçš„ä¸€å¹´æ²¡æœ‰ä»€ä¹ˆè®°å¿†ã€‚</p><p>æˆ‘èƒ½æœ‰ä»€ä¹ˆè®°å¿†å‘¢ï¼Ÿæ—¥å¸¸ç”Ÿæ´»æ€»æ˜¯ä¸€æˆä¸å˜çš„ï¼Œä»é¥æœ›ç€ä¸­å…³æ‘é¥è¿œè€Œè™šæ— çš„å¹»æ™¯ï¼Œåˆ°æ¯å¤©åœ¨é½¿è½®ä¸Šå’Œå¹»æ™¯ä¸€æ ·çš„å·¥ä½œã€‚æ›´æœ‰ç”šè€…ï¼Œä½ çš„ç”Ÿæ´»æœ¬èº«ä¹Ÿå°±æˆäº†è¿™ä¸ªæ´»åŠ¨çš„ä¸€éƒ¨åˆ†ï¼š</p><ol><li>æ—©ä¸Šï¼Œèµ·åºŠï¼Œç„¶åèµ¶å»ä¸Šç­</li><li>åœ¨å…¬å¸æ—©ä¸Šçœ‹ç‚¹åšå®¢ï¼Œå¤„ç†ç‚¹ç´§æ€¥äº‹æƒ…</li><li>ä¸­åˆåƒä¸ªé¥­ï¼Œé€›é€› s1ï¼Œreview ä¸€ä¸‹ä»£ç ï¼Œä¸‹å»èµ°ä¸€åœˆå›æ¥å®‰é™å¤„ç†ä¸€ä¸‹å·¥ä½œ</li><li>ä¸‹åˆå¯èƒ½å¼€å¼€ä¼šï¼Œè·Ÿä¸šåŠ¡æ‰¯æ‰¯çš®ï¼Œç„¶åå®‰é™å†™ä»£ç æˆ–è€…å†™ RFCï¼›æˆ–è€…å¯¹æ¥å„ç§éœ€æ±‚çš„çš„ç”¨æˆ·</li><li>æ™šä¸Šåƒä¸ªé¥­å›æ¥ï¼Œè¦ä¹ˆå¼€ä¼šè®¨è®ºæ–¹æ¡ˆï¼ˆå…¶å®å¾ˆæ°´çš„ï¼Œä¸€èˆ¬æ²¡å•¥é‡è¦çš„ï¼‰ï¼Œè¦ä¹ˆæ¥ç€è‚ä»£ç </li><li>æ™šä¸Šæ»šå›å®¶ï¼Œæœ‰çš„æ—¶å€™åœ¨å®¶é‡Œè¿˜å¾—å¤„ç†å…¬å¸çš„äº‹æƒ…ï¼›é—²çš„æ—¶å€™å°±åœ¨å®¶çœ‹ä¹¦çœ‹çœ‹ä»£ç äº†</li></ol><p>ä»£ç å’Œ RFC éƒ¨åˆ†ä¸­ï¼Œ20% çš„éƒ¨åˆ†æ˜¯æœ‰æ„æ€çš„ã€æœ‰åˆ›é€ åŠ›çš„éƒ¨åˆ†ï¼Œéœ€è¦ä½ ç»“åˆä¸šç•Œçš„æ–¹æ¡ˆæˆ–è€…ä¸€äº› paperï¼Œæ¥ä»”ç»†æ€è€ƒå®ƒæ€ä¹ˆ work åœ¨ä½ çš„æ¥å£ä¸Šï¼Œå’Œå·²æœ‰çš„å†…å®¹å…¼å®¹ã€‚å…¶å®ƒçš„éƒ¨åˆ†æ— éæ˜¯ï¼š</p><ul><li>çç¢ï¼ˆä½†é‡è¦ï¼‰çš„å·¥ä½œï¼Œæ¯”å¦‚ Log çš„ä¿®æ”¹ï¼Œè¯­ä¹‰çš„å¯¹é½ï¼Œè¯¦ç»†è€Œå¤æ‚çš„æµ‹è¯•</li><li>å®¹æ˜“è®¾è®¡ã€å®¹æ˜“å®ç°çš„éƒ¨åˆ†</li><li>æ€¥ç€ä¸Šçº¿ï¼Œæ²¡æ³•ä»”ç»†æ‰“ç£¨çš„éƒ¨åˆ†</li><li>è·Ÿå®¢æˆ·å¯¹æ¥</li><li>æµ‹è¯•ä¸€äº›å„ç§ç‰ˆæœ¬ tools çš„æ€§èƒ½</li></ul><p><img src="https://image.mwish.me/blog-image/image-20220201031034442.png" alt="image-20220201031034442"></p><p>é‚£ä¹ˆï¼Œå…¶å®ä½ ä¼šå‘ç°ï¼Œæœ‰çš„æ—¶å€™å¤§å®¶è‡ªå·±ä¹Ÿä¸çŸ¥é“å‘å±•æ–¹å‘æ˜¯ä»€ä¹ˆæ ·å­çš„ï¼Œå¾ˆå¤šæ—¶å€™åœ¨ spin æˆ–è€…æ‘¸é±¼ï¼Œè¿™æœ¬èº«ä¹Ÿå’Œ team å‘å±•æœ‰å…³ã€‚è€Œåœ¨æ—¥å¸¸ç”Ÿæ´»ä¸­ï¼Œä½ ä¸èƒ½ä¸åšè¿™äº›äº‹æƒ…ï¼Œè€Œä¸”è¿™äº›ä¸œè¥¿ç¡®å®æ˜¯ã€Œé‡è¦çš„ã€ï¼Œå¾ˆå¤šæ—¶å€™ä½ è¦é è¿™äº›ä¸œè¥¿æ¥æ‰¾åˆ°å‰è¿›æ–¹å‘ã€‚è¦æ€ä¹ˆæ‰èƒ½åœ¨æ¥é—®ä½ ã€Œbool ä¸Šå»ºç´¢å¼•ä¸ºä»€ä¹ˆä¸è¡Œã€æˆ–è€…ã€Œqps åŠ¨æ€å¢åŠ ã€çš„ç”¨æˆ·ä¸­ï¼Œå¯»æ‰¾åˆ°å®ç‰©å‘¢ï¼Ÿ</p><p>æœ‰ä¸€ä¼šå„¿æˆ‘ç‰¹åˆ«æœŸæœ›ç»„é‡Œæœ‰å‡ ä¸ªé è°±çš„å“¥ä»¬èƒ½å‡ºä¸»æ„ï¼Œå‘Šè¯‰æˆ‘ä»¬æ¥ä¸‹æ¥åšä»€ä¹ˆã€‚è¿™ç§æƒ³æ³•æ˜¯å¯¹çš„å—ï¼Ÿå¯ä»¥è¯´æˆ‘æ˜¯ä¸€ä½åˆæ ¼çš„å®ç°è€…ï¼Œèƒ½å¤Ÿåˆ¨ä»£ç ã€å¯¹æ¯”æ–¹æ¡ˆï¼›ä½†æ˜¯å¯èƒ½å¹¶ä¸æ˜¯ä¸€ä¸ªåˆæ ¼çš„ç»™å‡ºæ–¹å‘çš„äººã€‚è¿™æ ·çš„äººéš¾å…è¿·å¤±åœ¨æ—¥å¸¸çš„æµ·æ´‹ä¸­ã€‚æ®æˆ‘è§‚å¯Ÿï¼Œè¾¹ä¸Šè¿™æ ·çš„äººè¿˜æ˜¯ä¸å°‘çš„ã€‚åè¿‡æ¥è¯´ï¼Œç å†œæœ€å¼€å¿ƒçš„æˆ–è®¸æ˜¯åˆ°ä¸€ä¸ªåœ°æ–¹é€ ä¸€ä¸ªåœ°æ–¹çš„è½®å­ï¼Œå½“ä¸€ä¸ªè½®å­é›‡ä½£å…µï¼Œéšæ—¶éƒ½èƒ½æ„å»ºæ–°çš„ä¸œè¥¿ï¼ˆå¿½ç•¥æ¼«é•¿è€Œç—›è‹¦çš„ä¸Šçº¿æœŸï¼‰ã€‚</p><p>ç”Ÿæ´»æ˜¯å¦ä¸€ä¸ªéƒ¨åˆ†ï¼Œåœ¨é¸£äººçš„å‚å­è¾¹ä¸Šï¼Œå¤§æ¦‚åªèƒ½æ‰¾åˆ° 4000+ ä¸€ä¸ªæœˆçš„åæ¥å¹³ç±³çš„å•é—´ã€‚å½“ä½ å›åˆ°è¿™ä¸ªã€Œå®¿èˆã€ï¼Œæˆ–è€…å‘¨æœ«çš„æ—¶å€™ï¼Œè¦ç”¨ä»€ä¹ˆæ ·çš„ä»ªå¼æ„Ÿï¼Œå’Œä»€ä¹ˆæ ·çš„æ–¹å¼ï¼Œæ¥æ‰“é€ è‡ªå·±çš„ç”Ÿæ´»å‘¢ï¼Ÿåœ¨æ˜æš—ã€å¯’å†·è€Œæ£®ä¸¥çš„è¿™ç‰‡å¤©ç©ºä¸‹ï¼Œå¦‚ä½•å¡‘é€ ç¾å¥½çš„è®°å¿†å’Œæ—¥å¸¸ï¼Ÿ</p><h3 id="åŠ³åŠ¨ä¼¦ç†ä¸è¶…è¶Šæ—¥å¸¸"><a href="#åŠ³åŠ¨ä¼¦ç†ä¸è¶…è¶Šæ—¥å¸¸" class="headerlink" title="åŠ³åŠ¨ä¼¦ç†ä¸è¶…è¶Šæ—¥å¸¸"></a>åŠ³åŠ¨ä¼¦ç†ä¸è¶…è¶Šæ—¥å¸¸</h3><p>ã€ŒåŠªåŠ›å·¥ä½œï¼ŒåŠªåŠ›ç©ã€å¯èƒ½æ˜¯æœ€è®©æˆ‘è®¨åŒçš„è¯ä¹‹ä¸€ï¼Œå’Œã€Œå‘¨æœ«å¥½å¥½ä¼‘æ¯ï¼Œå·¥ä½œæ—¥å¥½å¥½ä¸Šç­ã€å·®ä¸å¤šè®¨åŒã€‚å®ƒæš—ç¤ºäº†ä¸€ç§åŠ³åŠ¨ä¼¦ç†çš„å­˜åœ¨ï¼Œå³ä¼‘æ¯å¥½åƒæ˜¯ä¸ºäº†å·¥ä½œä¸€æ ·ã€‚</p><p>çƒ­çˆ±å·¥ä½œçš„äººæ˜¯ä»€ä¹ˆæ ·å­ï¼Œéš¾é“ä»–ä»¬ä¸åº”è¯¥ä»¥å¹¿åšçš„è§è¯†ã€å¼ºå¤§çš„æ‰§è¡ŒåŠ›ã€å®Œå–„çš„æ¶æ„èƒ½åŠ›è®©æˆ‘ä»¬å°Šé‡ï¼Ÿåªæœ‰å·¥ä½œçš„äººæ˜¯ä»€ä¹ˆæ ·å­ï¼Œéš¾é“æˆ‘ä»¬ä¸åº”è¯¥æ˜¯ä¸°å¯Œçš„ï¼Œè€Œåº”è¯¥æ˜¯è´«ä¹çš„ï¼Ÿéš¾é“ã€Œç©ã€ä¸åº”è¯¥æ˜¯ã€Œæˆ‘æƒ³è¦è¿™ä¹ˆåšã€ã€Œæˆ‘ä¸€å®šè¦è¿™ä¹ˆåšã€ã€Œè¿™æ˜¯æˆ‘ç”Ÿæ´»çš„ä¸€éƒ¨åˆ†ã€ï¼Ÿ</p><p>å›åˆ°ç”Ÿæ´»ä¸­ï¼Œè¿™äº›å‰©ä½™çš„éƒ¨åˆ†å¯ä»¥ç»™æˆ‘ä»¬å¸¦æ¥ä¸Šç­çš„æ—¶å€™çš„ä½™è£•ï¼Œä¹Ÿå¯ä»¥å¸¦æ¥ä¸€äº›æ–°çš„æŠ€èƒ½ã€ä¸€äº›è¶…ç„¶çš„ä½“éªŒã€‚å®ƒä»¬å¯ä»¥æ˜¯ã€Œåº¸ä¿—çš„ã€ã€å¯ä»¥æ˜¯ã€Œç—›è‹¦çš„ã€ï¼Œä¹Ÿå¯ä»¥æ˜¯å¿«ä¹è€Œè¶…ç„¶çš„ã€‚ä½†æ˜¯ï¼ŒçŒå¥‡ä¹Ÿå¥½ã€å¥‹æ–—ä¹Ÿå¥½ï¼Œè¿™äº›ä¸œè¥¿åº”è¯¥èƒ½å¤Ÿã€Œå¸¦æ¥ç¾å¥½çš„è®°å¿†ã€ã€‚</p><p>äºæˆ‘è€Œè¨€ï¼ŒACGN å·²ç»æˆäº†ç”Ÿæ´»çš„ä¸€éƒ¨åˆ†ï¼Œå‘¨æœ«æ‹‰äººçœ‹ç‰‡ï¼Œç¿»ç¿» staff çœ‹æ¼”å‡ºæˆ–è€…æ‰¾ä¸€äº›å¾ˆé­‚çš„ SF æ˜¯å¿«ä¹çš„æºæ³‰ã€‚å›ºç„¶è¿™æœ¬èº«ä¹Ÿæ˜¯åº¸ä¿—çš„ï¼Œä½†æˆ‘ç›¸ä¿¡è¿™æ ·çš„è¿½æ±‚æœ¬èº«æ˜¯å­˜ç²¹çš„ï¼Œæˆ‘èƒ½å¤Ÿåœ¨å…¶ä¸­è·å–åŠ›é‡ã€‚æ¥æ„æˆæˆ‘ç¾å¥½çš„è®°å¿†ã€‚</p><p><img src="https://image.mwish.me/blog-image/A95D3E44-7D8A-46AA-B456-AA71BE00F115.png" alt="A95D3E44-7D8A-46AA-B456-AA71BE00F115"></p><p>åœ¨è¿™å…¶ä¸­ï¼Œæˆ‘è§‰å¾—é‡è¦çš„æ˜¯ï¼š</p><ol><li>å³ä½¿åœ¨æ—¥å¸¸å’Œçç¢çš„ç»†èŠ‚ä¸­ï¼Œä¹Ÿä¸è¦æ”¾å¼ƒæ€è€ƒã€‚è¿™æœ‰ç‚¹åƒé‚£ä»€ä¹ˆé˜¿é‡Œæ‰“ä½æ˜Ÿçš„ puaï¼Œä½†æ˜¯ä½ æ€ä¹ˆçœ‹å¾…è‡ªå·±è¾¹ä¸Šçš„ç¯å¢ƒå¯¹ä½ æ˜¯å¾ˆé‡è¦çš„ã€‚ä½ å¯ä»¥çœ‹åˆ°å¤§æœºæ¢°ä¸‹é¢å„ä¸ªéƒ¨ä»¶æ˜¯æ€ä¹ˆè¿è½¬çš„ï¼Œä½ åœ¨å¤§æœºå™¨é‡Œé¢åœ¨åšä»€ä¹ˆï¼Œä»€ä¹ˆæ˜¯ä½ æƒ³è¦çš„ï¼Œä¸‹ä¸€æ­¥è¦åšä»€ä¹ˆï¼Œä½ å¦‚æœä¸è·‘è·¯å¯ä»¥åšä»€ä¹ˆ</li><li>æœ‰ä¸€å®šçš„æ‰§è¡ŒåŠ›å’ŒåšæŒçš„èƒ½åŠ›ï¼Œèƒ½å¤Ÿåœ¨çç¢çš„æ—¥å¸¸ä¸­ä¿æŒè‡ªæˆ‘ã€‚è¿™ç‚¹çœ‹ä¸Šå»å’Œä¹‹å‰æ˜¯çŸ›ç›¾çš„ï¼Œä½†æ˜¯æˆ‘è®¤ä¸ºï¼Œå¯¹è‡ªå·±æƒ³åšçš„äº‹æƒ…è¿˜æ˜¯å¾—åšæŒä¸€ä¸‹ã€‚</li></ol><p><img src="https://image.mwish.me/blog-image/83D363D6-F6D3-4E38-82FD-0C54946AFA6F.png" alt="83D363D6-F6D3-4E38-82FD-0C54946AFA6F"></p><ol><li>ä¸ä¸€å®šè¦æœ‰é‚£ä¹ˆè¯¦ç»†çš„è®¡åˆ’ï¼Œä½†è¦ä¿è¯äº‹æƒ…åœ¨å‰è¿›ã€‚æœ¬äººå»å¹´å®é™…ä¸Šåœ¨è¿™ç‚¹ä¸Šæ˜¯æœ‰ä¸å°‘ç¼ºé™·çš„ï¼Œå‡ ä¸ªæƒ³åšçš„é¡¹ç›®å’Œä¸€äº›å·¥ä½œä¸Šçš„äº‹æƒ…éƒ½æ²¡æœ‰è¶³å¤Ÿçš„ä¿è¯è¿è¡Œè‰¯å¥½ã€‚</li><li>æŠ½ç‚¹æ—¶é—´å‡ºæ¥å­¦ç‚¹æƒ³è¦çš„ä¸œè¥¿å§ï½</li></ol><p>æ—¥å¸¸ç”Ÿæ´»å’ŒåŠ³åŠ¨ä¼¦ç†æ˜¯è¢«å æœ‰ã€ä¾µå çš„ã€‚ç¡çœ æ˜¯æˆ‘ä»¬çš„é˜²çº¿ï¼Œè€Œçˆ±å¥½å’Œå‘å¾€èƒ½å¤Ÿç»™æˆ‘ä»¬ç”»å‡ºä¸€ä¸ªæ–¹å‘ï¼›æ‰§è¡ŒåŠ›åˆ™èƒ½å¤Ÿä¿è¯è¿™äº›æ–¹å‘èƒ½å¤Ÿå‘å‰ã€‚</p><p>å½“ç„¶ï¼Œå›å¤´æ¥çœ‹ï¼Œä¹Ÿæœ‰èƒ½åŠ›èƒ½å¤Ÿå¸¦æ¥çš„ä¸€äº›ä½™è£•ã€‚æˆ‘çš„ä¸€äº›å¥½å‹èƒ½æŠŠå·¥ä½œã€æƒ³åšçš„äº‹æƒ…å’Œæ¢ç´¢æ€§è´¨çš„ä¸œè¥¿å¾ˆæœ‰æœºçš„ç»“åˆåœ¨ä¸€èµ·ï¼Œåœ¨æ—¥å¸¸ä¸­æŠŠå¤§éƒ¨åˆ†æ—¶é—´å˜æˆäº†è¿™ç§ã€Œéæ—¥å¸¸ã€çš„å·¥ä½œã€‚è¿™æ˜¯éå¸¸ä»¤äººç¾¡æ…•çš„ã€‚</p><h2 id="æ•´ä½“ä¹‹ç¾"><a href="#æ•´ä½“ä¹‹ç¾" class="headerlink" title="æ•´ä½“ä¹‹ç¾"></a>æ•´ä½“ä¹‹ç¾</h2><p>ä¸€ä¸ªå¤§å­¦ç”Ÿå‡ºå­¦ç³»ç»Ÿç»“æ„ã€æµæ°´çº¿ä¼šæ˜¯ä»€ä¹ˆçœ‹æ³•ï¼Ÿçœ‹åˆ°æ±‡ç¼–ä¼šæ˜¯ä»€ä¹ˆæƒ³æ³•ï¼Ÿå¦‚æœä»–èƒ½å¤ŸçŸ¥é“ä¸€äº›ä¸Šå±‚çš„è¡Œä¸ºï¼Œæ¯”å¦‚çœ‹è¿‡ <code>&lt;MonetDB/X100&gt;</code> çš„è®ºæ–‡ï¼Œå†é«˜å±‹å»ºç“´çš„ä» code åˆ°æŒ‡ä»¤çš„æ€§èƒ½æœ‰ä¸€å±‚æŠŠæ¡ï¼Œä»–çš„å…´è¶£ã€çœ‹åˆ°çš„ä¸œè¥¿ä¼šä¸ä¼šä¸ä¸€æ ·ï¼Ÿè€Œæˆ‘çš„å¥½æœ‹å‹æœ€è¿‘ç”šè‡³å¾ˆå°‘çœ‹ db çš„æ–‡ç« ï¼Œè€Œæ˜¯çœ‹äº†å¾ˆå¤š Arch æœ‰å…³çš„ä¸œè¥¿ï¼Œæ¥åŠ æ·±è‡ªå·±å¯¹ç³»ç»Ÿçš„äº†è§£ã€‚æˆ‘ä¹Ÿæ¸æ¸æ„Ÿå—åˆ°ï¼Œå¾ˆå¤šæ—¶å€™ä¸€äº›æ•´ä½“æ€§çš„ã€æ•´ä¸ªé“¾è·¯çš„ç†è§£çœ‹ä¸Šå»å¾ˆåƒèƒ¡å¹ï¼Œä½†æ˜¯å½“ä½ æŠŠå®ƒä»¬è”ç³»èµ·æ¥çš„æ—¶å€™ï¼Œä½ ä¼šè¯ç”Ÿéå¸¸å¤šçš„è‡ªå·±çš„åˆ†æä¸çœ‹æ³•ã€‚è¿™å°±æ˜¯æ•´ä½“ä¹‹ç¾ã€‚</p><p>2021 å¹´æˆ‘è¶Šæ¥è¶Šå¸Œæœ›èƒ½å¤Ÿçœ‹åˆ°ä¸€äº›æ•´ä½“ä¹‹ç¾ï¼š</p><ol><li>ä¸€äº›æ•´ä¸ªé“¾è·¯ä¸Šè€ƒè™‘å…¨é¢çš„è®¡ç®—æœºè®¾è®¡ï¼Œæ¯”å¦‚ MonetX100, Morsel è°ƒåº¦, InnoDB çš„ MVCC + GC ç­‰ã€‚</li><li>ä¸€äº›å­¦ç§‘æ€§è´¨çš„è·¨å­¦ç§‘å¸¦æ¥çš„å®½é˜”è§†è§’ï¼Œæ¯”å¦‚ã€Šè§„è®­ä¸æƒ©ç½šã€‹å’Œã€Šç¤¾ä¼šä¸æ”¿æ²»è¿åŠ¨è®²ä¹‰ã€‹ã€‚ä½œè€…çš„å†™ä½œèƒ½åŠ›é€šå¸¸æ¥è‡ªäºå¯¹æ•´ä¸ªç³»ç»Ÿã€å¯¹å†å²çš„æ·±åˆ»äº†è§£ï¼Œå·²ç»å¹¿é˜”çš„çŸ¥è¯†ã€‚</li></ol><p>è¿™ä»½å¯¹åŸºç¡€çš„é‡è§†å’Œç†è§£è®©ä»Šå¹´é˜…è¯»çš„è®ºæ–‡å’Œç†è§£èƒ½åŠ›æé«˜ä¸å°‘ï¼Œæˆ‘å¸Œæœ›åœ¨ SFã€ACGNã€å­¦ä¹ ä¹‹ç±»çš„è¯¸å¤šé¢†åŸŸï¼Œéƒ½èƒ½æŠŠæ¡åˆ°è¿™æ ·çš„æ•´ä½“ä¹‹ç¾ã€‚</p><h2 id="é—²è¯"><a href="#é—²è¯" class="headerlink" title="é—²è¯"></a>é—²è¯</h2><p>2022 å¹´å·²ç»åˆ°äº†ï¼Œè™½ç„¶ä»Šå¹´æ²¡å¤šå°‘å‡æœŸï¼Œä½†æ˜¯æˆ‘è¿˜æ˜¯å¸Œæœ›èƒ½æ‹¥æŠ±ä¸€äº›å˜åŒ–ï¼Œæœ€å¥½èƒ½æ¶¦å»ä¸Šæµ·ä¸Šç­ã€‚èƒ½æŠŠé«˜è¾¾ã€å°é­”å¥³ Doremi è¿™å‡ éƒ¨çœ‹å®Œï¼Œè‹±è¯­æ•´å¥½ç‚¹ã€‚</p><p>ç¥å¤§å®¶æ–°å¹´å¿«ä¹ï¼</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Database System Concepts 7th</title>
      <link href="/2022/01/30/Database-System-Concepts-7th/"/>
      <url>/2022/01/30/Database-System-Concepts-7th/</url>
      
        <content type="html"><![CDATA[<p>å‰é¢ä½¿ç”¨éƒ¨åˆ†ä¸å¤ªæ„Ÿå…´è¶£ï¼Œç›´æ¥ä»ç¬¬åç« å¼€å§‹çœ‹</p><h2 id="Ep10-å¤§æ•°æ®åˆ†æ"><a href="#Ep10-å¤§æ•°æ®åˆ†æ" class="headerlink" title="Ep10 å¤§æ•°æ®åˆ†æ"></a>Ep10 å¤§æ•°æ®åˆ†æ</h2><p>åå‘å¤§æ•°æ®ä¸€äº›çš„åŸºç¡€æ¶æ„ã€‚å›å¤´å†™ã€‚</p><h2 id="Ep-11-æ•°æ®åˆ†æ"><a href="#Ep-11-æ•°æ®åˆ†æ" class="headerlink" title="Ep 11 æ•°æ®åˆ†æ"></a>Ep 11 æ•°æ®åˆ†æ</h2><p>åå‘åˆ©ç”¨ Ep10 æ‹¿åˆ°çš„ç»“æœå†åšä¸€äº›åˆ†æã€‚å›å¤´å†™ã€‚</p><h2 id="Ep12-ç‰©ç†å­˜å‚¨ç³»ç»Ÿ"><a href="#Ep12-ç‰©ç†å­˜å‚¨ç³»ç»Ÿ" class="headerlink" title="Ep12 ç‰©ç†å­˜å‚¨ç³»ç»Ÿ"></a>Ep12 ç‰©ç†å­˜å‚¨ç³»ç»Ÿ</h2><p>é¦–å…ˆå­˜å‚¨æ˜¯åˆ†å±‚çš„ï¼Œå…·ä½“è€Œè¨€æ˜¯ï¼š</p><ol><li>cache</li><li>main memory</li><li>flash memory(SSD)</li><li>ç£ç›˜å­˜å‚¨ï¼ˆæ„Ÿè§‰ç»å¸¸åœ¨å•†ä¸šç³»ç»Ÿå­˜ä¸€äº›å†·æ•°æ®ï¼‰</li><li>å…‰å­¦å­˜å‚¨å™¨ï¼ˆç±»ä¼¼ DVDï¼‰</li><li>ç£å¸¦å­˜å‚¨å™¨</li></ol><p>æ­¤å¤–å­˜å‚¨å™¨è¿˜æœ‰æ¥å£ï¼Œå¯¹åº”ç‰©ç†æ¥å£å’Œä¸€äº›åè®®æ ˆï¼š</p><ol><li>SATA æ€»çº¿</li><li>PCIe æ€»çº¿</li></ol><p>åœ¨åè®®ä¸Šä¹Ÿæœ‰åŒºåˆ«</p><ol><li>NVMe åè®®</li><li>SCSI åè®®</li></ol><p>æ­¤å¤–ï¼Œç¡¬ä»¶æ¥å£ä¹Ÿæœ‰åŒºåˆ«ï¼Œæœ€å¸¸è§çš„æ˜¯ mSATA å’Œ M.2. è¿™ä¸ªå¯ä»¥å» jd æœæœï¼Œä¸€çœ‹å°±æ‡‚ã€‚</p><p>å…·ä½“å¯çœ‹ï¼š<a href="https://sjtu-sjtug.feishu.cn/docs/doccnfdnoqmgt6qqko5GM0tAKkh#">https://sjtu-sjtug.feishu.cn/docs/doccnfdnoqmgt6qqko5GM0tAKkh#</a> å’Œ ã€Šæ·±å…¥æµ…å‡º SSDã€‹è¿™ä¸¤ä¸ªææ–™ã€‚</p><p>å­˜å‚¨è®¾å¤‡åœ¨äº’è”ç½‘ä¸Šå¯èƒ½ä»¥ SAN çš„å½¢å¼ç»„ç»‡ï¼Œè¿™ç§å½¢å¼æä¾›äº†ç›˜ä¸€æ ·çš„è®¿é—®æ¥å£ï¼Œç°åœ¨ä¹Ÿæœ‰ ifiniBand ä¹‹ç±»çš„æ–¹å¼ã€‚æ­¤å¤–è¿˜æœ‰ NAS ä¹‹ç±»çš„ï¼Œæä¾›ç½‘ç»œæ–‡ä»¶ç³»ç»Ÿçš„å½¢å¼ï¼ˆæˆ‘åœ¨å®¶ç»„äº†ä¸ª NAS æ”¾ç‰‡ï¼Œçˆ½çš„ï¼‰ã€‚</p><h3 id="ç£ç›˜"><a href="#ç£ç›˜" class="headerlink" title="ç£ç›˜"></a>ç£ç›˜</h3><p>ä»¥ sector ä¸ºå½¢å¼ç»„ç»‡ï¼Œå—é™äºç‰©ç†çš„è®¿é—®ï¼Œç£ç›˜ç”Ÿå‘½å–å†³äºä¿å­˜å’Œè®¿é—®ã€‚å¯¹å¤–æä¾›çš„æ€§èƒ½å¤§æ¦‚æ˜¯ï¼š</p><ol><li>2-20ms çš„ seek time</li><li>æ—‹è½¬æ—¶é—´: å¯èƒ½åˆæ˜¯ä¸ªä½æ•° ms</li><li>ä¼ è¾“ï¼š50-200MB/s</li><li>sector: å¯èƒ½æ˜¯ 512B</li></ol><h3 id="é—ªå­˜"><a href="#é—ªå­˜" class="headerlink" title="é—ªå­˜"></a>é—ªå­˜</h3><p>SSD æ€§è´¨çœ‹çœ‹æˆ‘ä¹‹å‰ä»‹ç»å°±è¡Œï¼Œin shortï¼Œé•¿ä¸€ç‚¹çš„å¯ä»¥çœ‹ä¹‹å‰é‚£ä¸ªï¼š </p><ol><li>æˆ‘ä¹‹å‰æŠ„çš„ï¼š<a href="https://zhuanlan.zhihu.com/p/430451374">https://zhuanlan.zhihu.com/p/430451374</a></li><li>é•¿ä¸€ç‚¹çš„ï¼Œæ„Ÿè°¢ SJTUï¼š<a href="https://sjtu-sjtug.feishu.cn/docs/doccnfdnoqmgt6qqko5GM0tAKkh#">https://sjtu-sjtug.feishu.cn/docs/doccnfdnoqmgt6qqko5GM0tAKkh#</a> </li></ol><p>å…³äºæ€§èƒ½ï¼Œå¯ä»¥åˆ°æ•°åƒ MB/s, åŒæ—¶æœ‰ä¸€å®šçš„å¹¶è¡Œè¯»å†™èƒ½åŠ›ã€‚æˆ‘æ„Ÿè§‰ç°åœ¨ä¸€èˆ¬å¤§å…¬å¸å†…éƒ¨éƒ½ä¸€å † SSD æ¥ Handle ç”¨æˆ·çš„å†™å…¥</p><h3 id="RAID"><a href="#RAID" class="headerlink" title="RAID"></a>RAID</h3><p>ä¸Šå¤§å­¦çš„æ—¶å€™èƒŒè¿‡ RAID0-RAID5 åº”ä»˜è€ƒè¯•ï¼Œç°åœ¨å…¨å¿˜å…‰äº†ï¼Œæ„Ÿè§‰å†èƒŒä¸€éä¹Ÿæ²¡ä»€ä¹ˆæ„æ€ï¼Œå°±ä¸»è¦è®²è®²æ€è·¯å§ã€‚</p><ol><li>å†—ä½™ä»¥æé«˜å¯é æ€§<ol><li>è¿™ç‚¹å¯¹ç°åœ¨çš„äººå…¶å®æœ‰ç‚¹ confusingï¼Œä¸ºä»€ä¹ˆå‘¢ï¼Œç°åœ¨çš„æ—¶ä»£å¾ˆå¤šæ—¶å€™å¯èƒ½å•æœºéƒ½ä¸éœ€è¦è€ƒè™‘æ•°æ®çš„é è°±ï¼Œé  GFS Style çš„å¤‡ä»½ä¹‹ç±»çš„æ˜¯æ›´å¸¸è§çš„ idiom. è·Ÿç¾¤å‹è®¨è®ºäº†ä¸‹ï¼Œebs/GFS è¿™ç§æ„Ÿè§‰ç›®å‰è¿˜æ˜¯é¢†å…ˆåœ°ä½çš„ï¼ŒRAID0 RAID1 æ˜¯å¯ä»¥ç”¨çš„</li></ol></li><li>å¹¶è¡Œä»¥æé«˜æ€§èƒ½<ol><li>æ„Ÿè§‰è¿™ä¸ªåœ¨ SSD ä¸Šç”¨å¤„æœ‰é™ï¼ŒHDD ä¸Šå€’æ˜¯å¥½ä¸€äº›ï¼Ÿ</li></ol></li></ol><h2 id="EP13-æ•°æ®å­˜å‚¨ç»“æ„"><a href="#EP13-æ•°æ®å­˜å‚¨ç»“æ„" class="headerlink" title="EP13 æ•°æ®å­˜å‚¨ç»“æ„"></a>EP13 æ•°æ®å­˜å‚¨ç»“æ„</h2><p>è¿™ç« æ„Ÿè§‰ä¹Ÿå¾ˆ trivialï¼Œå°±è®¨è®ºäº†å„ç§å­˜å‚¨çš„ç»“æ„ï¼š</p><ol><li>æ¶è®¾åœ¨è¡Œå­˜ä¸­çš„æ•°æ®åº“</li><li>æ¶è®¾åœ¨åˆ—å­˜ä¸­çš„æ•°æ®åº“</li><li>å†…å­˜æ•°æ®åº“/NVM æ•°æ®åº“</li></ol><h3 id="è¡Œå­˜çš„æ•°æ®ç»„ç»‡"><a href="#è¡Œå­˜çš„æ•°æ®ç»„ç»‡" class="headerlink" title="è¡Œå­˜çš„æ•°æ®ç»„ç»‡"></a>è¡Œå­˜çš„æ•°æ®ç»„ç»‡</h3><p>ä¼ ç»Ÿçš„ RDBMS ä¼šä»¥ Block/Page ä¸ºç²’åº¦ç»„ç»‡ç³»ç»Ÿï¼Œæœ¬èº« HDD/SDD éƒ½æ˜¯åŸºäºå—çš„å­˜å‚¨è®¾å¤‡ã€‚å®ƒä»¬çš„å¤§å°é€šå¸¸ä¸º 4kB/8kB/16kBã€‚</p><p>å‡è®¾ Page å¤§å°æ˜¯å›ºå®šçš„ã€‚å®šé•¿è®°å½•å¯ä»¥ä» Catalog é‡Œé¢çŸ¥é“é•¿åº¦ï¼Œç›´æ¥é¡ºåºå­˜å°±è¡Œï¼Œå˜é•¿è®°å½•å¯èƒ½éœ€è¦ä¸€äº›ç‰¹æ®Šæ–¹å¼ï¼š</p><p><img src="https://image.mwish.me/blog-image/E4DE3EA7-EA78-4FE0-9A54-1F6459096D96.png" alt="E4DE3EA7-EA78-4FE0-9A54-1F6459096D96"></p><p>ä¸Šå›¾æ˜¯ PG ä¸­çš„å¤„ç†å½¢å¼ï¼ŒPG çš„ HeapPage å•ä¸ª Page å†…ä¼šè¿™æ ·ç»„ç»‡æ•°æ®ã€‚è¿™é‡Œæœ‰ä¸ªå¾ˆæ¸…æ™°çš„é—®é¢˜æ˜¯ï¼Œåœ¨æ•°æ®åˆ é™¤æ¯”è¾ƒå¤šçš„æ—¶å€™ä¼šæ€ä¹ˆé‡æ–°ç»„ç»‡ï¼Œè¿™ä¸ªæ—¶å€™å®ƒä¼šåœ¨ Vacuum é˜¶æ®µå¤„ç†è¿™äº›æ•°æ®ã€‚</p><p>æ­¤å¤–ï¼ŒMySQL çš„ InnoDB Page å†…éƒ¨è®°å½•ç»„ç»‡ä¼šæ›´å¤æ‚ä¸€äº›ã€‚é‡‡ç”¨äº†é“¾è¡¨+minmax+ç¨€ç–ç´¢å¼•çš„å½¢å¼ã€‚ç©¶å…¶åŸå› ï¼ŒInnoDB å¯¹å†™æ“ä½œæ”¯æŒè¦å¥½å¾ˆå¤šï¼Œè¿™äº›éƒ½å¯ä»¥ç®—åœ¨å†™æ“ä½œçš„æ”¯æŒé‡Œé¢ã€‚</p><h4 id="å¤§å¯¹è±¡å­˜å‚¨"><a href="#å¤§å¯¹è±¡å­˜å‚¨" class="headerlink" title="å¤§å¯¹è±¡å­˜å‚¨"></a>å¤§å¯¹è±¡å­˜å‚¨</h4><p>MySQL çš„ Page è¦æ±‚ Btr çš„ Page ä¼šè‡³å°‘å­˜å‚¨ä¸¤ä¸ª record, å¤šçš„çºªå½•ä¼šæ”¾åˆ° BLOB å¯¹è±¡å’Œ Page ä¸­ã€‚</p><p>PostgreSQL æœ‰ TOAST å¯¹è±¡ï¼Œå…·ä½“å¦‚ä¸‹ï¼š<a href="https://cch1996.github.io/2020/09/22/postgres-04/">https://cch1996.github.io/2020/09/22/postgres-04/</a></p><p>ç®€å•æ¥è¯´ï¼ŒTOAST è®°å½•ä¼šæ”¾åœ¨ TOAST è¡¨ä¸­ã€‚</p><h3 id="æ–‡ä»¶è®°å½•çš„ç»„ç»‡"><a href="#æ–‡ä»¶è®°å½•çš„ç»„ç»‡" class="headerlink" title="æ–‡ä»¶è®°å½•çš„ç»„ç»‡"></a>æ–‡ä»¶è®°å½•çš„ç»„ç»‡</h3><ol><li>HeapFile ç»„ç»‡ï¼Œè®°å½•æ”¾åœ¨æ–‡ä»¶çš„äººå’Œåœ°æ–¹</li><li>é¡ºåºæ–‡ä»¶ç»„ç»‡</li><li>B+Tree æ–‡ä»¶ç»„ç»‡</li><li>Hashing æ–‡ä»¶ç»„ç»‡</li></ol><p>Record çš„ç»„ç»‡å¯ä»¥çœ‹æˆ‘ä¹‹å‰å†™çš„å†…å®¹çš„ Tuple éƒ¨åˆ†ï¼š<a href="https://zhuanlan.zhihu.com/p/457605514">https://zhuanlan.zhihu.com/p/457605514</a></p><p>å¯¹äºä¼ ç»Ÿçš„ RDBMSï¼Œåœ¨ Stonebraker çš„<a href="https://book.douban.com/subject/17665384/">æ–‡ç« </a> ä¸­ï¼Œè¡¨ç¤ºè™½ç„¶æ–‡ä»¶ç³»ç»Ÿå¯èƒ½ä¼šæœ‰ä¸€äº›ç‰¹æ®Šçš„ç»„ç»‡æ–¹å¼ï¼Œä¸ä¼šæŒ‰æ–‡ä»¶çš„æ ¼å¼é¡ºåºå­˜æ”¾æ‰€æœ‰å—ï¼Œä½†æ˜¯ç›´æ¥ç”¨æ–‡ä»¶ç»„ç»‡çš„è¯ï¼Œå¼€é”€æ˜¯æ¯”è¾ƒå°çš„ã€‚æ–°æ—¶ä»£éšç€ SPDK ç­‰æŠ€æœ¯çš„å‘å±•ï¼Œè¿™ä¸ªå¯èƒ½ä¼šæœ‰ä¸€ç‚¹å˜åŒ–ï¼Œä½†æ˜¯ç¨‹åºå‘˜æˆ‘æ„Ÿè§‰ä¹Ÿä¸ç”¨å¤ªå…³æ³¨ã€‚</p><p>å¯¹äº Page çš„ç»„ç»‡ï¼ŒPostgreSQL åšçš„ç®€å•ä¸€äº›ï¼Œä¼šæ”¾åœ¨ Database Cluster çš„ç©ºé—´ä¸­ï¼ŒPG é™¤äº†è¡¨æ–‡ä»¶ï¼Œè¿˜æœ‰å¯¹åº”çš„ <code>_fsm</code> ï¼ˆç©ºé—´ç©ºé—´æ˜ å°„ï¼‰å’Œ <code>_vm</code> ï¼ˆå¯è§æ€§æ˜ å°„ï¼‰ï¼Œé€šè¿‡åœ¨ fsm çš„æ ‡è®°æ‰¾åˆ°å¯ç”¨çš„ Pageï¼Œç„¶åæ‰¾åˆ°å†™å…¥çš„ Pageã€‚</p><p>InnoDB è¿™ä¸ªè¦å¤æ‚ä¸€äº›ï¼š</p><ol><li>Extent ï¼ˆåŒºï¼‰ï¼šè¿ç»­å­˜æ”¾ 64 ä¸ª Pageï¼Œå¸Œæœ›æé«˜ Page åˆ†é…çš„å±€éƒ¨æ€§</li><li>Segmentï¼ˆæ®µï¼‰ï¼šå­˜æ”¾ä¸åŒç±»å‹çš„æ•°æ®ï¼Œæ¯”å¦‚å¶å­ç»“ç‚¹æ®µã€éå¶å­ç»“ç‚¹æ®µã€‚Segment ä¼šå‘ OS ç”³è¯· Extent å¤§å°çš„å­˜å‚¨ç©ºé—´ã€‚</li></ol><p>å›æ”¶çš„æ—¶å€™ï¼ŒPG æ ¹æ® Freeze/Vacuum å’Œ <code>_vm</code> çš„æ ‡è®°æ¥å›æ”¶ï¼ŒInnoDB åˆ™ä¼šæ ¹æ® Extent çš„é“¾è¡¨ï¼ˆXDESï¼‰æ¥åšå›æ”¶</p><h4 id="Partition"><a href="#Partition" class="headerlink" title="Partition"></a>Partition</h4><p>æ•°æ®æ ¹æ®æŸä¸ª key åˆ’åˆ†æˆå¤šä¸ªæ–‡ä»¶/ç©ºé—´ã€‚è¿™ç§æ–¹å¼èƒ½å¤Ÿå°†å•ä¸ªåº“æ‹†åˆ†ã€åšå†·çƒ­åˆ†ç¦»ï¼Œä½†ä¹Ÿä¼šå½±å“è·Ÿè¿™ä¸ª key æ— å…³çš„è¯·æ±‚ã€‚</p><h4 id="Catalog"><a href="#Catalog" class="headerlink" title="Catalog"></a>Catalog</h4><p>ä¸€èˆ¬ Catalog å¯ä»¥å…¨éƒ¨ä¿æŒåœ¨å†…å­˜ä¸­ï¼Œå­˜å‚¨çš„æ—¶å€™è¦æŒä¹…åŒ–ã€‚</p><h3 id="Buffer-Pool-Manager"><a href="#Buffer-Pool-Manager" class="headerlink" title="Buffer Pool Manager"></a>Buffer Pool Manager</h3><p>æ è¿‡ä¸è°ˆï¼Œåæ­£å°±ç»å…¸ Pin, Cache Replacement, Dirty ä¹‹ç±»çš„ã€‚çœ‹ InnoDB ç­–ç•¥ã€ARC åŸºæœ¬å°±è¡Œäº†ã€‚</p><p>è¿™é‡Œè¿˜æœ‰ä¸ªå†™é¡ºåºå’Œ WAL çš„é—®é¢˜ï¼Œç•¥è¿‡ä¸è°ˆï¼Œåæ­£ recovery system å¯ä»¥è®²ã€‚</p><p>æœ¬è´¨ä¸Šå°±æ˜¯é¢„æµ‹ç”¨æˆ·è¡Œä¸ºï¼Œç„¶åä¸¢ç¼“å­˜ä¹‹ç±»çš„ã€‚</p><h3 id="é¢å‘åˆ—çš„å­˜å‚¨"><a href="#é¢å‘åˆ—çš„å­˜å‚¨" class="headerlink" title="é¢å‘åˆ—çš„å­˜å‚¨"></a>é¢å‘åˆ—çš„å­˜å‚¨</h3><p>æ²¡å•¥è¯´çš„ï¼ŒåŸºæœ¬å‚è€ƒ abadi çš„ Columnar DBMSï¼Œå­˜å‚¨çœ‹æˆ‘è¿™ç¯‡ï¼š<a href="https://zhuanlan.zhihu.com/p/457889634">https://zhuanlan.zhihu.com/p/457889634</a></p><h3 id="Main-Memory-DB"><a href="#Main-Memory-DB" class="headerlink" title="Main-Memory DB"></a>Main-Memory DB</h3><p>æ„Ÿè§‰è¿™éƒ¨åˆ†è®²çš„è¿˜æ˜¯å†…å­˜ä¸Šçš„ï¼Œè¡Œåˆ—éƒ½è®²ï¼Œå°±å†™çš„ä¸æ˜¯å¾ˆæ¸…æ™°ï¼Œæ²¡å•¥æ„æ€ã€‚</p><h2 id="Ep14-ç´¢å¼•ç»“æ„"><a href="#Ep14-ç´¢å¼•ç»“æ„" class="headerlink" title="Ep14 ç´¢å¼•ç»“æ„"></a>Ep14 ç´¢å¼•ç»“æ„</h2><p>B+Tree éƒ½çœ‹åäº†ï¼Œæˆ‘ä¸€ä¸ªå­—éƒ½ä¸æƒ³å†™ã€‚å°±è·Ÿ Btree æ¯”ä¸€ä¸‹ç®€å•ä¸€äº›ï¼ŒBtree çœç©ºé—´ä¸€ç‚¹ï¼Œä½†æ˜¯æ²¡å•¥æ„ä¹‰ï¼Œå¾ˆå®¹æ˜“è¢«æŠ¹å¹³ã€‚</p><p>SSD ä¸Šçš„ Btree Style ç´¢å¼•ï¼š</p><ol><li>BwTree</li><li>FDTree</li><li>MassTree</li></ol><p>æˆ‘ä¸ªäººåæ­£æ„Ÿè§‰è¿™äº›ä¸œè¥¿åè€Œå¾ˆå¤šéƒ½æ²¡ç”¨ä¸Šï¼Œé™¤äº† ms çš„è®ºæ–‡ï¼Œå°± Ark ç”¨äº†ä¸‹ BwTreeã€‚ä¸çŸ¥é“æ˜¯è¿™äº›ç»“æ„æœ¬èº«ä¸é è°±ï¼Œè¿˜æ˜¯ TP ç³»ç»Ÿå’Œ Btree å·²ç»æ˜¯æ—¶ä»£çš„çœ¼æ³ªäº†ã€‚</p><p>Btree æœ¬èº«æ˜¯ä¸º HDD é‚£æ ·çš„ç»“æ„è®¾è®¡çš„ï¼Œåœ¨ SSD ä¸Šï¼ŒBtree è¿˜æ˜¯æœ‰ä¼˜åŠ¿çš„ï¼Œå› ä¸ºå†…å­˜å’Œ SSD è¿˜æ˜¯æœ‰ gap çš„ï¼Œè€Œä¸” Btr æœ¬èº«ä¼šæœ‰ä¸€äº›å¾ˆç»†çš„ä¼˜åŒ–ï¼Œæ¯”å¦‚ trxn ä¹‹ç±»çš„ï¼Œä½†æ˜¯è¿™å¥—ä¸œè¥¿ä¹Ÿè¿˜æ˜¯å¾ˆéš¾å®ç°çš„ã€‚ä»¥ BwTree ä¸ºä¾‹ï¼š</p><p>BwTree åšäº†ï¼š</p><ol><li>Mapping Table: å¯¹ Node æˆ–è€…å†™å…¥çš„æ˜ å°„</li><li>å†™å…¥ç±»ä¼¼ Log çš„å½¢å¼å­˜æ”¾ï¼ŒBtree ä¹Ÿé¢„ç•™äº†ç©ºé—´</li><li>æ— é”</li></ol><p>ä¸»å­˜ä¸Šçš„ç´¢å¼•ç±»ä¼¼ ART.</p><p>è¿˜æœ‰ hashing ç´¢å¼•ä»€ä¹ˆçš„ï¼Œæˆ‘æ„Ÿè§‰è¿™äº›å›½å†…ææ–™æ¯”è¾ƒå°‘ï¼Œæˆ‘è‡ªå·±ä¹Ÿæ²¡å†™è¿‡ï¼Œå°±ä¸è°ˆäº†ã€‚</p><p>LSM æ˜¯æ–°æ—¶ä»£çš„å® å„¿ï¼Œå› ä¸ºå®ç°æ¯” Btr ç®€å•ï¼Œæ€§èƒ½ä¸é”™ï¼Œå†™æ€§èƒ½å¾ˆå¥½ï¼ˆè®¾è®¡è€…è®¤ä¸ºï¼Œè¯»æ˜¯å¾ˆå¥½ä¼˜åŒ–çš„ï¼‰å¯è°ƒæ•´å¯é¢„æµ‹ï¼Œè¿˜æœ‰ RocksDB ä»€ä¹ˆçš„ã€‚è¿™é‡Œè¿˜æœ‰äº› WiscKey ä¹‹ç±»çš„ SSD å‹å¥½ç»“æ„ï¼Œä¸è¿‡ WiscKey è®¾è®¡ä¹Ÿæœ‰ä¸€äº›é—®é¢˜ï¼Œæ¯”å¦‚: <a href="https://www.skyzh.dev/posts/articles/2021-08-07-lsm-kv-separation-overview/">https://www.skyzh.dev/posts/articles/2021-08-07-lsm-kv-separation-overview/</a> ã€‚æ­¤å¤– LSM è™½ç„¶æœ¬èº«æ˜¯ä¸€ä¸ªå†™ä¼˜åŒ–çš„ç»“æ„ï¼Œä½†æ˜¯å®ƒçš„æ€è·¯è¢«æ”¾åˆ°äº†å¾ˆå¤š HTAP ç±»ä¼¼çš„è¯»å†™æ··åˆç³»ç»Ÿé‡Œé¢ã€‚</p><p>è¿™é‡Œè¿˜æåˆ°äº† Buffer Treeï¼Œæˆ‘è§‰å¾—æœ‰ç‚¹ç±»ä¼¼ FD-Tree, æŠŠæ›´æ–°æåˆ°ä¸€ä¸ªç¼“å†²åŒºï¼ˆDeltaï¼‰ï¼Œç„¶åå…ˆæ‰¾ Delta å†æ‰¾ä¸‹é¢ï¼ŒBuffer æ»¡äº†ä¹‹åæŒ‰ä¸€å®šç­–ç•¥æ¥ä¸‹æ¨ã€‚</p><p>ä½å›¾ç´¢å¼•ï¼ˆæˆ‘è®°å¾— PG æœ‰è¿™ä¸ªï¼‰ï¼Œæœ¬èº«å’Œåˆ—å­˜é‚£å¥—å·®ä¸å¤šï¼Œå½“ç„¶è¿™å¥—ä¸œè¥¿ä¹Ÿå¯ä»¥åšåˆ° Btree ä¸Š(é˜²æ­¢ä¸€ä¸ª Page æ”¾ä¸ä¸‹ï¼Ÿ)ã€‚åˆ é™¤è®°å½•å¯èƒ½åœ¨å®šä½çš„åœ°æ–¹äº§ç”Ÿæ´ï¼Œè¿™é‡Œå¯ä»¥ç”¨ä¸€ä¸ª exist çš„ä½å›¾è¡¨ç¤ºï¼Œä¸è¿‡æˆ‘è§‰å¾— TUM çš„ PDT æ€è·¯å¥½ä¸€äº›ï¼Œå®ƒç”¨äº†ä¸€ä¸ªåç§»é‡çš„ Bæ ‘ï¼ˆPosition Delta Treeï¼‰æ¥è¡¨è¿°ã€‚æ­¤å¤–ï¼š</p><ol><li>å¦‚æœåªæœ‰æŸä¸ªå€¼å‡ºç°çš„æ¯”è¾ƒå¤šï¼Œå¯ä»¥å•ç‹¬ç»™å®ƒä¸€ä¸ªç´¢å¼•</li><li>å¦‚æœå¶å­ç»“ç‚¹å‘ç°å¯ä»¥ä½å›¾å‹ç¼©ï¼Œé‚£å°±ç”¨</li></ol><p>ä¸Šé¢è¿™äº›ä¼˜åŒ–æˆ‘æ„Ÿè§‰éƒ½æ˜¯çœ‹ä¸Šå»èƒ½çœç©ºé—´ï¼Œä½†æ˜¯å®é™…æƒ…å†µæœ‰ç‚¹ confusing çš„ï¼Œæš‚ä¸”ä¸è¡¨å§ã€‚</p><p>ç©ºé—´ç»“æ„ï¼šk-d-B æ ‘ã€‚è¿™åå­—æœ‰ç‚¹å¤æ‚ï¼Œå¯ä»¥å…ˆçœ‹ k-d æ ‘ï¼š<a href="https://oi-wiki.org/ds/kdt/#_3">https://oi-wiki.org/ds/kdt/#_3</a> ã€‚k-d æ ‘å½¢æ€ä¸Šæ˜¯ä¸€ä¸ª Binary Search Treeï¼Œè¿™é‡Œç›¸å½“äºæä¾›äº†ä¸€ä¸ª Btree çš„å½¢å¼ã€‚</p><h2 id="Ep15-æŸ¥è¯¢æ‰§è¡Œ"><a href="#Ep15-æŸ¥è¯¢æ‰§è¡Œ" class="headerlink" title="Ep15 æŸ¥è¯¢æ‰§è¡Œ"></a>Ep15 æŸ¥è¯¢æ‰§è¡Œ</h2><p>ç›´æ¥çœ‹è¿™ä¸ªå°±è¡Œï¼Œå¯¹åº”æœ¬ç« çš„ç¬”è®°ï¼š<a href="https://zhuanlan.zhihu.com/p/349943902">https://zhuanlan.zhihu.com/p/349943902</a></p><h2 id="Ep16-æŸ¥è¯¢ä¼˜åŒ–"><a href="#Ep16-æŸ¥è¯¢ä¼˜åŒ–" class="headerlink" title="Ep16 æŸ¥è¯¢ä¼˜åŒ–"></a>Ep16 æŸ¥è¯¢ä¼˜åŒ–</h2><p>ç»Ÿè®¡ä¿¡æ¯å‚è§ï¼š<a href="https://zhuanlan.zhihu.com/p/350255430">https://zhuanlan.zhihu.com/p/350255430</a></p><p>æ‰§è¡Œè®¡åˆ’çš„ä¼°è®¡å¯ä»¥å‚è€ƒï¼š</p><ol><li>Selinger çš„ System R ä¼˜åŒ–å™¨</li><li>Graefe Goetz çš„ Cascades/Volcano Planner</li></ol><p>æˆ‘æ„Ÿè§‰ä¸Šé¢ 15-721 çš„ slide å†™çš„å¾ˆè¯¦ç»†ï¼Œç›®æµ‹ noisepage å‚è€ƒ Columbia æŠ„äº†ä¸ª Cascade Plannerã€‚</p><p>å…³äºè¿æ¥é¡ºåºçš„ï¼ŒåŸºæœ¬æ˜¯ä¸ª DPã€‚ä¸è¿‡å¤æ‚åº¦å¾ˆé«˜ï¼ŒåŸºæœ¬æ˜¯ $O(3^n)$, Selinger é‚£ç¯‡é‡‡ç”¨äº† <strong>å¯å‘å¼</strong> åšä¸€äº›ä¼˜åŒ–ï¼Œæ¯”å¦‚ï¼š</p><ol><li>outer join æœ€å Plan</li><li>Selection å…ˆä¸‹æ¨ ï¼ˆè¿™ä¸ªåœ¨ä¸€äº› caseï¼Œæ¯”å¦‚ A Join B, é€‰æ‹©åœ¨ B çš„å­—æ®µï¼Œä¸” JOIN å¯ä»¥èµ°ç´¢å¼•çš„åœºæ™¯ä¸‹ï¼Œå·¥ä½œçš„ä¸æ˜¯å¾ˆå¥½ï¼‰</li><li>Projection å…ˆä¸‹æ¨</li></ol><p>ç„¶åæœ‰ä¸€äº› interesting order æˆ–è€… physical properties çš„æ–¹å¼æ¥æ–½åŠ ä¸€äº›é™åˆ¶ã€‚</p><p>Cascades/Volcano æ¡†æ¶åˆ™æœ‰ä¸‹åˆ—çš„æ€æƒ³ï¼š</p><ol><li>æœ‰ä¸€äº›è¢«ç§°ä¸ºç‰©ç†ç­‰ä»·è§„åˆ™(physical equivalence rule) çš„è§„åˆ™ï¼Œæ¥å®Œæˆ transformã€‚é€šå¸¸è¿™äº›è§„åˆ™ä¸€èˆ¬éƒ½æ˜¯åŸå­çš„ï¼Œå³ä¸èƒ½è¢«åˆ«çš„è§„åˆ™ç»„åˆå‡ºæ¥</li><li>è¿™äº›è§„åˆ™æ˜¯å’Œä»£ä»·ä¼°è®¡ç»“åˆåœ¨ä¸€èµ·çš„</li><li>memorization æ¥å­˜å‚¨æœ€ä¼˜çš„å½¢å¼</li><li>ä¿å­˜ä¸€äº›å­ç»“æ„</li></ol><p>æœ‰ä¸€ä¸ªå¾ˆé‡è¦çš„ä¸œè¥¿æ˜¯ Join Order çš„é€‰æ‹©ï¼Œå…¶å®æ˜¯è¿™æ ·çš„ï¼š</p><ol><li>è¡¨å¤šç›´æ¥é—ä¼ ç®—æ³•äº†ï¼Œæ¯”å¦‚ PG é‚£ç§ï¼Œè¶…è¿‡ 12ä¸ªè¡¨ç›´æ¥é—ä¼ ç®—æ³•</li><li>ä¼ ç»Ÿçš„ Selinger é‚£ç¯‡æ–‡ç« ï¼Œåªè€ƒè™‘äº† left deep treeã€‚æœ‰ä¸€äº›å¤æ‚çš„ç®—æ³•ä¼šè€ƒè™‘ bushy treeï¼Œæ¯”å¦‚ dpccp</li></ol><p>æœ‰ä¸€ä¸ªé‡è¦çš„è¯é¢˜æ˜¯å­æŸ¥è¯¢çš„ä¼˜åŒ–ï¼Œå¯ä»¥æŠŠä¸€äº› EXIST ä¹‹ç±»çš„æ”¹æˆ Semijoinï¼Œä¸è¿‡è¿™ä¸ªè§„åˆ™æœ‰ç‚¹å•°å—¦ï¼ŒPG æœ‰ä¸€å—å°±æ˜¯å¤„ç†å­æŸ¥è¯¢ï¼Œæˆ‘çœ‹çš„äººä¸€æ„£ä¸€æ„£çš„â€¦TUM æœ‰ä¸€ç¯‡å¤„ç†ä»»æ„å­æŸ¥è¯¢çš„è®ºæ–‡ï¼Œè¿™é‡Œæœ‰ä¸ªäºŒæ‰‹åšå®¢ï¼š<a href="https://zhuanlan.zhihu.com/p/60380557">https://zhuanlan.zhihu.com/p/60380557</a></p><p>æœ‰ä¸€ä¸ªæ¯”è¾ƒé‡è¦çš„éƒ¨åˆ†æ˜¯ç‰©åŒ–è§†å›¾ï¼Œéšç€æœ€è¿‘ OLAP ç³»ç»Ÿçš„ç«çƒ­ï¼Œç‰©åŒ–è§†å›¾è¶Šæ¥è¶Šçƒ­é—¨ã€‚ä¸è¿‡è€å¤§éš¾çš„é—®é¢˜æ˜¯ç‰©åŒ–è§†å›¾çš„æ›´æ–°ï¼Œæœ€æ–°çš„å‚è€ƒ Google çš„ Napa ç³»ç»Ÿã€‚è€å¤§éš¾çš„é—®é¢˜æ˜¯ç‰©åŒ–è§†å›¾çš„é€‰æ‹©ï¼ˆç±»ä¼¼ç´¢å¼•é€‰æ‹©ï¼‰å’Œæ›´æ–°ï¼ˆå®æ—¶æ€§ â€” å†™æ€§èƒ½ â€” æˆæœ¬ï¼‰ï¼ŒNapa ç”¨ä¸€ä¸ª ts æ¥è®©ä½ è‡ªå·±é€‰ã€‚æˆ‘ä»¬è€ƒè™‘ä¸‹é¢çš„æ›´æ–°ï¼š</p><ol><li>JOIN: ç›¸å½“äºå•æ¡è®°å½• Join å¦ä¸€å¼ è¡¨ï¼Œç„¶åå¢åŠ /åˆ é™¤è®°å½•</li><li>Selection/Projection: Selection å¯èƒ½å¥½å¤„ç†ä¸€äº›ï¼Œç›´æ¥åŒºé—´æ“ä½œå°±è¡Œï¼›Projection å¯èƒ½è¦è®°å½•æ•°æ®çš„æ¥æº/countingï¼Œåœ¨å…¶ä¸Šæ“ä½œ</li><li>Agg: count/sum/avg è¿™äº›æ¯”è¾ƒå¥½å¤„ç†ï¼Œmin/max å¯èƒ½éœ€è¦åœ¨æœ‰åºé›†åˆä¸Šå¤„ç†ã€‚ç»´æŠ¤ min/max çš„æ’å…¥å¾ˆç®€å•ï¼Œä½†æ˜¯è¦åœ¨ä¸Šé¢å¤„ç†åˆ é™¤æ˜¯å¾ˆéš¾å¾—ã€‚</li></ol><p>è¿˜æœ‰ä¸€äº› advance çš„å†…å®¹ï¼Œ15-721 ä¹Ÿæœ‰åˆ—ï¼ŒåŒ…æ‹¬ï¼š</p><ol><li>top-K ä¼˜åŒ–</li><li>adaptive çš„æŸ¥è¯¢å¤„ç†</li><li>å‚æ•°åŒ–çš„æŸ¥è¯¢ä¼˜åŒ–</li><li>å…±äº«æ‰«æã€å¤šæŸ¥è¯¢ä¼˜åŒ–</li></ol><h2 id="Ep17-äº‹åŠ¡"><a href="#Ep17-äº‹åŠ¡" class="headerlink" title="Ep17 äº‹åŠ¡"></a>Ep17 äº‹åŠ¡</h2><p>äº‹åŠ¡æœ‰ç€ ACID çš„æ¦‚å¿µï¼Œè¿™é‡Œæˆ‘çœ‹åˆ°è¿‡ä»‹ç»çš„æœ€å¥½çš„æ˜¯ DDIA é‚£æœ¬ä¹¦ï¼š</p><ol><li>A: äº‹åŠ¡æœ¬èº«å¤šä¸ªæ“ä½œæ˜¯å¯ä»¥åŸå­æ€§ abort çš„</li><li>C: å¯¹å¤–çš„çŠ¶æ€æ»¡è¶³æŸäº›ä¸€è‡´æ€§çº¦æŸ</li><li>I: å¯è§æ€§ä¹‹ç±»çš„ä¸œè¥¿å—åˆ°çº¦æŸ</li><li>D: æäº¤ã€æ‰ç”µä¹‹åè¿˜åœ¨</li></ol><p>ä¸²è¡ŒåŒ–æ˜¯å‡è®¾äº‹åŠ¡ä¸€ä¸ªæ¥ä¸€ä¸ªæ‰§è¡Œçš„æƒ…å†µï¼Œè¿™ç§æƒ…å†µå«ã€Œä¸²è¡ŒåŒ–ã€ã€‚è€Œå¹¶å‘æ§åˆ¶ç»„ä»¶ï¼ˆconcurrency-controlï¼‰ä¼šæ§åˆ¶äº‹åŠ¡çš„è®¿é—®ã€‚å¯¹äºé€»è¾‘ä¸Šç­‰åŒäºä¸²è¡ŒåŒ–çš„è°ƒåº¦ï¼Œæˆä¸ºã€Œå†²çªå¯ä¸²è¡ŒåŒ–ã€ã€‚åŒæ—¶ï¼Œé€šè¿‡äº‹åŠ¡çš„è¯»å†™å…³ç³»ï¼Œèƒ½å®šä¹‰äº‹åŠ¡ä¹‹é—´çš„<em>ååº</em>å…³ç³»ã€‚</p><p>è¿™é‡Œï¼ˆ <a href="https://zhuanlan.zhihu.com/p/293533311ï¼‰ä»‹ç»äº†ä¸€ç§ç”¨å›¾æç»˜å†²çªçš„æ–¹å¼ï¼Œæˆ‘è§‰å¾—æ˜¯ä¸€ç§ç›¸å½“å¥½çš„å®šä¹‰æ–¹å¼ã€‚">https://zhuanlan.zhihu.com/p/293533311ï¼‰ä»‹ç»äº†ä¸€ç§ç”¨å›¾æç»˜å†²çªçš„æ–¹å¼ï¼Œæˆ‘è§‰å¾—æ˜¯ä¸€ç§ç›¸å½“å¥½çš„å®šä¹‰æ–¹å¼ã€‚</a></p><p>è¿™é‡Œè°ƒåº¦è¿˜è¦è€ƒè™‘ã€Œå¯æ¢å¤ï¼ˆreconverableï¼‰ã€å’Œã€Œæ— çº§è”è°ƒåº¦ï¼ˆcascadelessï¼‰ã€:</p><ol><li>å¯æ¢å¤è°ƒåº¦æŒ‡çš„æ˜¯ï¼ŒA depends on B,  A commit äº†, B æ²¡æœ‰ commit, é‚£ä¹ˆå¯èƒ½ B abort äº†ï¼ŒA å°±æ²¡æ³•æ¢å¤äº†ã€‚</li><li>A-&gt;B-&gt;Cï¼ŒC abort äº†ï¼Œé‚£ B/A éœ€è¦çº§è” abortã€‚OCC ä¸­å¯èƒ½é‡åˆ°è¿™ç§æƒ…å†µï¼ŒS2PL åº”è¯¥ä¸ä¼šã€‚</li></ol><p>ç„¶åè¿™é‡Œä»‹ç»äº†ä¸€ä¸‹éš”ç¦»çº§åˆ«ï¼Œå¯ä»¥å‚è€ƒæˆ‘ä¹‹å‰å‘çš„é‚£ç©æ„ã€‚éš”ç¦»çº§åˆ«å¯ä»¥ç”¨ é”ã€tsã€MVCC æˆ–è€…ç»„åˆæ¥å®ç°ï¼Œè¿™äº›æ¦‚å¿µå…¶å®æ˜¯å¯ä»¥æ‚ç³…åœ¨ä¸€èµ·çš„ï¼Œå…·ä½“è¿˜æ˜¯çœ‹å…·ä½“å®ç°ã€‚</p><h2 id="Ep18-å¹¶å‘æ§åˆ¶"><a href="#Ep18-å¹¶å‘æ§åˆ¶" class="headerlink" title="Ep18 å¹¶å‘æ§åˆ¶"></a>Ep18 å¹¶å‘æ§åˆ¶</h2><p>è¿™èŠ‚æ„Ÿè§‰æ˜¯æœ‰ç‚¹éš¾åº¦çš„ï¼Œè®¨è®ºäº†ä¼ ç»Ÿçš„å„ç§å¹¶å‘æ§åˆ¶ï¼Œå’Œä¸€äº›æ‚é¡¹ã€‚ç„¶åè®¨è®ºäº†ä¸€ä¸‹ Online DDL ä¹‹ç±»çš„ã€‚</p><p>åè®®éƒ¨åˆ†è§ï¼š</p><ol><li><a href="https://zhuanlan.zhihu.com/p/294657612">https://zhuanlan.zhihu.com/p/294657612</a></li><li><a href="https://zhuanlan.zhihu.com/p/298576970">https://zhuanlan.zhihu.com/p/298576970</a></li></ol><p>ç„¶å Online DDL åŸºæœ¬æ˜¯ å¿«ç…§è¯» + æ’åº + è¿½å¢é‡ã€‚Percolator + F1 æ˜¯åœ¨å†™çš„æ—¶å€™åšäº†çŠ¶æ€å…¼å®¹ï¼ŒæŠŠè¿½å¢é‡è¿™éƒ¨æ›¿æ¢æ‰äº†ï¼Œå…¶å®æ˜¯å·®ä¸å¤šçš„ã€‚</p><h2 id="Ep19-æ¢å¤ç³»ç»Ÿ"><a href="#Ep19-æ¢å¤ç³»ç»Ÿ" class="headerlink" title="Ep19 æ¢å¤ç³»ç»Ÿ"></a>Ep19 æ¢å¤ç³»ç»Ÿ</h2><p>è§ï¼š<a href="https://zhuanlan.zhihu.com/p/397469987">https://zhuanlan.zhihu.com/p/397469987</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> database, reading </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Transaction, OCC and modern hardware</title>
      <link href="/2022/01/28/Transaction-OCC-and-modern-hardware/"/>
      <url>/2022/01/28/Transaction-OCC-and-modern-hardware/</url>
      
        <content type="html"><![CDATA[<p>äº‹åŠ¡å¤„ç†å¾ˆå¤šæˆæœæ˜¯åœ¨ä¸Šä¸–çºªå®Œæˆçš„ï¼Œåœ¨æœ¬ä¸–çºªåˆï¼Œå…³äºäº‹åŠ¡çš„ç ”ç©¶æ˜¯ç›¸å¯¹è¾ƒå°‘çš„ã€‚å ä¸»å¯¼åœ°ä½çš„æ˜¯ 2PL åè®®ï¼Œä½œä¸ºæœ€æ ‡å‡†çš„å¹¶å‘æ§åˆ¶å®ç°ã€‚ä½†æ˜¯ï¼Œæœ¬ä¸–çºªå…³äºäº‹åŠ¡æœ‰ç€ä¸åŒå˜åŒ–ï¼š</p><ol><li><p>ç”±äºåº”ç”¨ä¸Šçš„ä¸åŒéœ€æ±‚ï¼Œç›¸å¯¹ä¸Šä¸–çºªï¼Œæœ¬ä¸–çºªçš„åº”ç”¨æœ‰äº†æ˜¾è‘—çš„å˜åŒ–ï¼šæ˜¾ç„¶ï¼Œä¸Šä¸–çºªæ²¡æœ‰è¿™ä¹ˆå¤§è§„æ¨¡çš„ã€é«˜äº‹åŠ¡æäº¤çš„äº’è”ç½‘åº”ç”¨ï¼Œç°åœ¨çš„åº”ç”¨å¯èƒ½æœ‰æ•° Mç”šè‡³æ•°ç™¾M çš„ qpsï¼Œå¸Œæœ› ~10ms çš„æ—¶é—´å†…å®Œæˆä¸€ä¸ªäº‹åŠ¡ã€‚</p></li><li><p>åŒæ—¶ï¼Œæ–°æ—¶ä»£ä¹Ÿæœ‰ç¡¬ä»¶æ€§èƒ½çš„é£é€Ÿå˜åŒ–ï¼Œè¿™ç‚¹ä¸»è¦ä½“ç°åœ¨ï¼š</p><ol><li>CPU å•æ ¸æ’ä¸Šäº†åŠŸè€—å¢™ï¼Œä½†ä¹Ÿæ‹¥æœ‰äº†æ›´å¤šçš„æ ¸å¿ƒï¼›</li><li>ç¼“å­˜å¤§é‡æå‡ï¼ŒL3/L2/L1 Cache å˜å¾—å¤§äº†å¾ˆå¤šï¼›</li><li>å­˜å‚¨ä¹Ÿæœ‰åŒæ ·çš„æå‡ï¼ŒSSD å–ä»£äº† HDD æˆä¸ºäº†ç¡¬ä»¶çš„å® å„¿ï¼ŒNVMe ç­‰åè®®æä¾›äº†åŠ©åŠ›ï¼ŒåŒæ—¶ä¹Ÿæœ‰ SPDK ç­‰ Bypass çš„æŠ€æœ¯ï¼›</li><li>åŒæ—¶ï¼Œåˆ†å¸ƒå¼äº‹åŠ¡çš„å®ç°å˜å¾—æ›´åŠ é‡è¦äº†ã€‚</li></ol></li></ol><p>åº”ç”¨ä¾§çš„éœ€æ±‚ã€ç¡¬ä»¶çš„æå‡ç”šè‡³è½¯ä»¶æ ˆå˜è–„ï¼Œç»™äº‹åŠ¡å¤„ç†å¸¦æ¥äº†ä¸€äº›å˜åŒ–ã€‚ç„¶è€Œï¼Œæœ€è‘—åçš„é è°±å¼€æºæ•°æ®åº“ MySQLã€PostgreSQL ä½¿ç”¨çš„è¿˜æ˜¯ä¸Šä¸–çºªä¹åå¹´ä»£çš„æ¨¡å‹ï¼›æ¯”è¾ƒå¸¸è§çš„ Google Percolator ç­‰æ¨¡å‹åœ¨å•æœºäº‹åŠ¡ä¸Šè¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ï¼›H-Store/VoltDB çš„æ–¹å¼ä¼¼ä¹æ²¡æœ‰å¾ˆä¸»æµçš„è¢«é‡‡çº³ã€‚</p><p><img src="https://image.mwish.me/blog-image/C5C7DF9D-3E2E-4319-B086-FE4190228FB8.png" alt="C5C7DF9D-3E2E-4319-B086-FE4190228FB8"></p><p>æˆ‘ä»¬å¯ä»¥å¥—ç”¨åˆ° MySQL è¿™æ ·ä¼ ç»Ÿçš„ RDBMS ä¸­ï¼š</p><ol><li>ARIES é‚£æ ·çš„ Undo Redo Log</li><li>MV2PL, é‡‡ç”¨ Delta Space å­˜å‚¨å˜æ›´çš„ç‰ˆæœ¬</li><li>é‡‡ç”¨ Btree ç´¢å¼•</li><li>å¹¶å‘æœ¬èº«å’Œ 2PL æœ‰å…³ï¼Œæ¨¡å‹æ˜¯çº¿ç¨‹ï¼ˆPG ç”šè‡³æ˜¯è¿›ç¨‹ï¼‰ï¼Œç„¶åæœ¬èº« Btree ä¹‹ç±»çš„ä¹Ÿä¼šæœ‰ä¸€äº› Latch Protocol</li></ol><p>å®ƒå¯ä»¥å¾ˆæ–¹ä¾¿çš„åšä¸€äº›å†…éƒ¨çš„ä¼˜åŒ–ï¼Œæ¯”å¦‚è¯´ï¼šå¯¹äº counterï¼Œå®ƒå¯ä»¥ç»´æŠ¤è®¡æ•°å™¨é”ï¼Œä½¿ç”¨ Page ç›¸å…³çš„é€»è¾‘ç‰©ç†æ—¥å¿—ï¼Œæ¥è¾¾åˆ°ç»†ç²’åº¦çš„æ›´æ”¹ã€‚</p><p>åŒæ—¶ï¼Œå¹¶å‘æ§åˆ¶å¯ä»¥åˆ†ä¸ºä¹è§‚çš„/æ‚²è§‚çš„ï¼Œå¤§æ¦‚åˆ’åˆ†å¦‚ä¸‹ï¼š</p><p><img src="https://image.mwish.me/blog-image/F3F65886-E3F4-4F68-B301-92A7CEC90B55.png" alt="F3F65886-E3F4-4F68-B301-92A7CEC90B55"></p><p>OCC æœ¬èº«æ˜¯ä¸€ç§ä¹è§‚å¹¶å‘åè®®ï¼Œ1981 å¹´ <code>&lt;On Optimistic Methods for Concurrency Control&gt;</code> ä¸­è¢«æå‡ºã€‚åœ¨è¿‘åå¹´ä¸­ï¼Œå› ä¸ºæ¨¡å‹çš„å˜åŒ–ï¼Œä½¿ç”¨è€…è®¤ä¸ºï¼Œå®ƒåœ¨ä½æ•°æ® contention çš„æƒ…å†µä¸‹ä¼šæœ‰è‰¯å¥½çš„æ€§èƒ½ã€‚</p><p>æœ¬æ–‡ä¸»è¦å…³æ³¨å¹¶å‘æ§åˆ¶éƒ¨åˆ†ï¼Œå¹¶ä¸»è¦å…³æ³¨å•æœºäº‹åŠ¡ã€‚</p><h2 id="On-Optimistic-Methods-for-Concurrency-Control"><a href="#On-Optimistic-Methods-for-Concurrency-Control" class="headerlink" title="On Optimistic Methods for Concurrency Control"></a>On Optimistic Methods for Concurrency Control</h2><p>æœ¬è®ºæ–‡æ˜¯ OCC çš„æå‡ºï¼Œåœ¨ 1982 å¹´å‘è¡¨åœ¨ TODS (Transactions on Database Systems) ä¸Š, æœ¬è®ºæ–‡æå‡ºçš„æ–¹æ³•æ˜¯åŸºäºæ—¶é—´æˆ³çš„æ–¹æ³•ï¼Œå¹¶ä¸”æå‡ºäº†åŸºæœ¬çš„æ¨¡å‹ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç±»ä¼¼ T-Treeï¼Œå½“æ—¶ Memory/Cache ä¹‹ç±»çš„æ¨¡å‹å’Œç°åœ¨ä¹Ÿç•¥æœ‰ä¸åŒã€‚</p><p>Optimistic è¡¨ç¤ºï¼š</p><blockquote><p>Most current approaches to concurrency control in database systems rely on locking of data objects as a control mechanism. In this paper, two families of nonlocking concurrency controls are presented. The methods used are â€œoptimisticâ€ in the sense that they rely mainly on transaction backup as a control mechanism, â€œhopingâ€ that conflicts between transactions will not occur. Applications for which these methods should be more efficient than locking are discussed.</p></blockquote><p>ä½œè€…è®¤ä¸ºï¼Œäº‹åŠ¡æœ¬èº«å› ä¸ºè®¿é—®ç›˜çš„ latency gap å’Œ å¤šæ ¸å¿ƒç­‰åŸå› ä¼šéœ€è¦å¹¶å‘æ‰§è¡Œï¼Œè€Œ 2PL æœ‰å‡ ä¸ªé—®é¢˜ï¼š</p><ol><li>Lock ä¼šç»™è¯»æˆ–è€…ä¸äº§ç”Ÿå†²çªçš„äº‹åŠ¡ä¹Ÿå¸¦æ¥å¼€é”€</li><li>Deadlock</li><li>Lock éœ€è¦ç­‰å¾…äº‹åŠ¡æ‰§è¡Œå®Œæ¯•æ‰èƒ½é‡Šæ”¾</li><li>Lock åªæœ‰åœ¨ worst case æ‰æœ‰ç”¨</li></ol><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œå¯ä»¥æ‰‹åŠ¨æ¨å¯¼å‡ºä¸‹åˆ—çš„å‰æï¼š</p><ol><li>æ­£åœ¨æ‰§è¡Œçš„äº‹åŠ¡æœ¬èº«éœ€è¦çš„æ•°æ®æ•°é‡å æ•°æ®æ€»é‡è¾ƒå°</li><li>ä¿®æ”¹çƒ­ç‚¹æ¦‚ç‡è¾ƒå°</li></ol><p>åœ¨è¿™ä¸ªå‰æä¸‹ï¼Œå¯ä»¥ä½¿ç”¨ OCC çš„æ–¹å¼ï¼Œæ¥é«˜æ•ˆæ‰§è¡Œï¼Œå¹¶ä¸”é¿å…æ­»é”ã€‚å½“ç„¶ï¼Œæ­»ç½ªå¯å…ï¼Œæ´»ç½ªéš¾é€ƒï¼Œé‡åˆ°æ´»é”çš„æƒ…å†µä¸‹ï¼Œå¯èƒ½å¯ä»¥é€€åŒ–ä¸ºæ‚²è§‚çš„äº‹åŠ¡ç­‰æ–¹æ³•æ¥å¤„ç†ï¼ˆDoug Lea åœ¨è®¾è®¡ä¸€äº›æ•°æ®ç»“æ„æåˆ°è¿‡ç±»ä¼¼çš„æ–¹æ³•ï¼Œæä¾› global lockï¼Œå¦‚æœé‡è¯•å¤±è´¥é›†é‡‡ï¼Œé‚£ä¹ˆä½¿ç”¨ Global lockï¼‰ã€‚åŒæ—¶ï¼Œè¿™é‡Œè¯»äº‹åŠ¡ä¼šå‡ ä¹ä¸å¸¦æ¥å¼€é”€ã€‚ï¼ˆWhat about MVCC?ï¼‰</p><p><img src="https://image.mwish.me/blog-image/3BABC5DC-0A29-4463-84DE-37BE2845A7A6.png" alt="3BABC5DC-0A29-4463-84DE-37BE2845A7A6"></p><p>è¿™é‡Œåˆ‡åˆ†ä¸ºäº† read/validation/write ä¸‰ä¸ªé˜¶æ®µï¼Œå€¼å¾—ä¸€æçš„æ˜¯ï¼Œè¿™é‡Œå¤§éƒ¨åˆ†è¿˜æ˜¯ read åœ¨å†…å­˜æ“ä½œï¼Œwrite é˜¶æ®µåˆ‡æ¢ä¸€ä¸‹ read çš„æ—¶å€™çš„æŒ‡é’ˆï¼Œç„¶å read æœ¬èº«è¯»éƒ½æ˜¯åŸå­çš„ã€‚å› æ­¤ä½œè€…è®¤ä¸ºï¼Œwrite æœ¬èº«æ˜¯éå¸¸å¿«èƒ½å®Œæˆçš„ã€‚<strong>æ–‡ä¸­è¡¨ç¤ºäº† Write é˜¶æ®µå¾ˆå¿«è€Œä¸”æ˜¯ä¸²è¡Œçš„ã€‚</strong></p><h3 id="Read-Write-é˜¶æ®µ"><a href="#Read-Write-é˜¶æ®µ" class="headerlink" title="Read/Write é˜¶æ®µ"></a>Read/Write é˜¶æ®µ</h3><p>è¿™é‡Œéœ€è¦æä¾›ä¸‹åˆ—çš„åŸè¯­</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">create --  åˆ›å»ºå¯¹è±¡, è¿”å› handler</span><br><span class="line">delete(handler) -- åˆ é™¤å¯¹è±¡ handler</span><br><span class="line">read(handler, i) -- è¯»å–å¯¹è±¡ handler çš„å­—æ®µ i</span><br><span class="line">write(handler, i, v) -- ç»™å¯¹è±¡ handler çš„ i èµ‹å€¼ v</span><br><span class="line"></span><br><span class="line">copy(n) -- æ‹·è´å¯¹è±¡ n, è¿”å›ä¸€ä¸ªæ–°çš„ handler</span><br><span class="line">exchange(handler1, handler2) -- äº¤æ¢ </span><br></pre></td></tr></table></figure><p>ç„¶åï¼Œéœ€è¦åœ¨ read é˜¶æ®µæä¾› <code>tcreate</code> , <code>tdelete</code>, <code>tread</code>, <code>twrite</code> ç­‰æ–¹æ³•ï¼Œä½¿ç”¨ä¸Šé¢çš„åŸè¯­æ¥æ“ä½œã€‚åŒæ—¶ï¼Œäº‹åŠ¡å¼€å§‹å’Œç»“æŸåˆ†åˆ«ä½¿ç”¨ <code>tbegin</code> å’Œ <code>tend</code> æ“ä½œã€‚äº‹åŠ¡çš„å†…éƒ¨ç»“æ„é‡Œä¿å­˜äº† <code>WriteSet</code> è¿˜æœ‰ <code>DeleteSet</code>ã€<code>ReadSet</code>ï¼ŒåŒæ—¶æœ‰ä¸€ä¸ª <code>copy</code> æ•°ç»„ã€‚å…·ä½“æ“ä½œå°±è¯»çš„æ—¶å€™æ‹·è´åˆ° <code>copy</code> æ•°ç»„ï¼Œåˆ›å»ºåˆ é™¤ä¹‹ç±»çš„å¤„ç†å¥½å¯¹åº”é›†åˆï¼ŒæŠŠ handler ä¸¢åˆ° <code>Set</code> ä¸­ã€‚</p><p>å½“ Validation å®Œæˆä¹‹åï¼Œè¿™é‡Œé€»è¾‘å°±åŸºæœ¬ä¸Šæ˜¯æŠŠ <code>WriteSet</code> å’Œ <code>DeleteSet</code> å» applyã€‚ç„¶åæˆ‘è¿™è¾¹æˆªå–ä¸€æ®µå‡è®¾ï¼Œè¿™é‡Œè®ºæ–‡ä½¿ç”¨äº†ä¸²è¡Œ writeï¼Œå› ä¸ºï¼š</p><blockquote><p>Note that since objects are virtual (objects are referred to by name, not by physical address), the exchange operation, and hence the write phase, can be made quite fast: essentially, all that is necessary is to exchange the physical address parts of the two object descriptors.</p></blockquote><h3 id="Validation-Phase"><a href="#Validation-Phase" class="headerlink" title="Validation Phase"></a>Validation Phase</h3><p>è¿™é‡Œåªæè¿°äº† Serializable çš„éªŒè¯ï¼Œè®ºæ–‡ä½¿ç”¨äº†æ—¶é—´æˆ³æœ‰å…³çš„åè®®ã€‚å¯¹äºä¸€ä¸ªç»™å®šçš„äº‹åŠ¡ <code>T(i)</code>, éƒ½èƒ½æ‰¾åˆ°ä¸€ä¸ª <code>t(i)</code> æ¥è¡¨è¾¾äº‹åŠ¡æ‰§è¡Œçš„æ—¶é—´ã€‚äº‹åŠ¡è¯»å†™çš„æ—¶å€™ï¼Œéœ€è¦ä¿è¯ <code>t</code> çš„é¡ºåºï¼Œå³æ˜¯äº‹åŠ¡çš„é¡ºåºã€‚é‚£ä¹ˆï¼Œè¿™é‡Œå¯ä»¥ç»™åˆ°ä¸€äº›æ¡ä»¶ï¼Œå¯¹äº <code>t(i) &lt; t(j)</code></p><p>ä¸€: <code>T(i)</code> åœ¨ <code>T(j)</code> è¯»é˜¶æ®µä¹‹å‰å®Œæˆäº†å†™é˜¶æ®µ</p><p>åº”è¯¥ä¸éœ€è¦æ€ä¹ˆç†è§£ï¼Œå¾ˆ trivial</p><p>äºŒï¼š<code>T(j)</code> åœ¨è¿›å…¥ Write Phase ä¹‹å‰, <code>T(i)</code> å®Œæˆäº† Write Phase ï¼Œä¸” <code>WriteSet(i)</code> å’Œ <code>ReadSet(j)</code> æ— äº¤é›†</p><p>è¿™é‡Œåæ¥æ€ä¹ˆæ”¹éƒ½è¡Œï¼Œä½†æ˜¯ä¸èƒ½è¯»åˆ°ä¹‹å‰æ”¹çš„åœ°æ–¹</p><p>ä¸‰ï¼š<code>T(i)</code> çš„ WriteSet å’Œ <code>T(j)</code> çš„ <code>ReadSet</code> / <code>WriteSet</code> éƒ½æ²¡æœ‰äº¤é›†ã€‚ä¸” <code>T(i)</code> åœ¨ <code>T(j)</code> ä¹‹å‰å®Œæˆ Read Phase</p><p>è¿™é‡Œæœ‰ç‚¹ç‚¹å¤æ‚ï¼Œæ˜¯è¯´ <code>T(i)</code> çš„æ²¡æœ‰å½±å“åˆ° <code>T(j)</code> çš„äº‹åŠ¡ã€‚</p><p>ä¸‹å›¾ä¹ŸåŒæ ·è¯´æ˜äº†è¿™ä¸‰æ¡è§„åˆ™å¯¹åº”çš„æ—¶é—´èŒƒå›´ï¼š</p><p><img src="https://image.mwish.me/blog-image/57BC7AB9-C874-4F0C-BD3E-07F1C5E69FE4.png" alt="57BC7AB9-C874-4F0C-BD3E-07F1C5E69FE4"></p><p>Rule3 è¿˜æ˜¯ç›¸å¯¹å¤æ‚ä¸€äº›ï¼Œå…³äºè¿™ç‚¹å¯ä»¥ä» CMU çš„ slide é‡Œé¢å·ä¸€ä¸‹å›¾ï¼š</p><p><img src="https://image.mwish.me/blog-image/FAF180FF-6C3F-42EF-BAEF-BE41229EDD86.png" alt="FAF180FF-6C3F-42EF-BAEF-BE41229EDD86"></p><h4 id="Transaction-Number"><a href="#Transaction-Number" class="headerlink" title="Transaction Number"></a>Transaction Number</h4><p>å¯¹äº‹åŠ¡ T, éœ€è¦æ‰¾åˆ°å¯¹åº”çš„æ—¶é—´æˆ³ï¼Œè¿™é‡Œé€‰ç”¨çš„æ˜¯ Validation çš„æ—¶é—´æˆ³ã€‚</p><blockquote><p>Here we use the simple solution of maintaining a global integer counter tnc (transaction number counter); when a transaction number is needed, the counter is incremented, and the resulting value returned. Also, transaction numbers must be assigned somewhere before validation, since the validation conditions above require knowledge of the transaction number of the transaction being validated.</p></blockquote><p>è¿™é‡Œä¹Ÿè®²äº†ä¸ºå•¥ä¸åœ¨ Read æˆ–è€… Begin çš„æ—¶å€™æ‹¿æ—¶é—´æˆ³ã€‚å¦‚æœ <code>t(i) &lt; t(j)</code>, ä½† <code>T(j)</code> æ›´æ—©è¿›å…¥ Validationï¼Œé‚£å°±éœ€è¦ç­‰å¾… <code>T(i)</code> äº†ã€‚åœ¨ Validation Phase æ‹¿åˆ° TS èƒ½è‡ªç„¶æ»¡è¶³è¿™ä¸ªæ¡ä»¶</p><h4 id="ä¸€äº›å·¥ç¨‹è€ƒé‡"><a href="#ä¸€äº›å·¥ç¨‹è€ƒé‡" class="headerlink" title="ä¸€äº›å·¥ç¨‹è€ƒé‡"></a>ä¸€äº›å·¥ç¨‹è€ƒé‡</h4><p>å¦‚æœè¯»äº‹åŠ¡å¾ˆé•¿ï¼Œé‚£ä¹ˆï¼Œå®ƒå¾ˆæœ‰å¯èƒ½ Starveï¼Œè¿™é‡Œè§£å†³æ–¹å¼æ˜¯ç•™ä¸€äº›äº‹åŠ¡çš„ WriteSet åˆ°å†…å­˜ä¸­ï¼ˆç±»ä¼¼ MVCC äº†ï¼‰ï¼š</p><blockquote><p>We solve this problem by only requiring the concurrency control to maintain some finite number of the most recent write sets where the number is large enough to validate almost all transactions (we say write set a is more recent than write set b if the transaction number associated with a is greater than that associated with 6). In the case of transactions like T, if old write sets are unavailable, validation fails, and the transaction is backed up (probably to the beginning). </p></blockquote><p>æ­¤å¤–ï¼Œè¿™é‡Œæ´»é”å¯¼è‡´é—®é¢˜çš„æ—¶å€™ï¼Œå¯ä»¥ç”¨å…¨å±€é”æˆ–è€…é™çº§åˆ°æ‚²è§‚çš„æ–¹å¼æ¥å¤„ç†ã€‚</p><h3 id="Serial-Validation"><a href="#Serial-Validation" class="headerlink" title="Serial Validation"></a>Serial Validation</h3><p>è®ºæ–‡ä¸­ï¼ŒValidation Phase å’Œ Write Phase éƒ½æ˜¯ä¸²è¡Œæ‰§è¡Œçš„ï¼ŒRead Phase æ˜¯å¹¶è¡Œæ‰§è¡Œçš„ï¼Œä½†æ˜¯åç»­ä¼šä¸²è¡Œ Validation ç„¶åå†™ï¼ˆæˆ‘æ„Ÿè§‰è¿™ä¸ªä¹Ÿå¤ªæ€ªäº†â€¦ï¼‰ã€‚è®° <code>tnc</code> ä¸º å…¨å±€äº‹åŠ¡counterï¼Œé‚£ä¹ˆæœ‰ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">tbegin() &#123;</span><br><span class="line">åˆå§‹åŒ– CreateSet, ReadSet, WriteSet, DeleteSet</span><br><span class="line">StartTn := tnc</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">tend() &#123;</span><br><span class="line">  ä¸´ç•ŒåŒºå¼€å§‹</span><br><span class="line">FinishTn := tnc</span><br><span class="line">valid := true</span><br><span class="line">for t from start tn + 1 to finish tn do</span><br><span class="line">if (write set of transaction with transaction number t intersects read set)</span><br><span class="line">then valid := false</span><br><span class="line">  if valid</span><br><span class="line">    # å®Œæˆå†™é˜¶æ®µå inc tnc.</span><br><span class="line">then ((write phase); tnc := tnc + 1; tn := tnc))</span><br><span class="line">if valid</span><br><span class="line">then ( cleanup )</span><br><span class="line">else ( backup )</span><br><span class="line">  ä¸´ç•ŒåŒºç»“æŸ</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šè¿°æƒ…å†µå¾ˆå®¹æ˜“éªŒè¯æ˜¯åˆæ³•çš„ï¼Œå› ä¸º <code>tend</code> æ•´ä¸ªå°±æ˜¯ä¸²è¡Œçš„ï¼Œ<code>(3)</code> ä¹‹æ‰€ä»¥ä¸éœ€è¦æ˜¯å› ä¸ºè¿›è¿™ä¸ªé˜¶æ®µå°±è¯»å†™å®Œäº†ã€‚</p><p>å¯¹äºå•æ ¸ç³»ç»Ÿ+éªŒè¯/å†™å…¥æœ¬èº«ä¼šéå¸¸å¿«çš„åœºæ™¯ï¼Œä¸Šé¢å·®ä¸å¤šå°±å¤Ÿç”¨äº†ï¼Œä½†æ˜¯å¤šæ ¸ç³»ç»Ÿæˆ–è€…è¦ I/O çš„è¯ï¼Œå¯èƒ½æˆ‘ä»¬å°±å¸Œæœ›å¹¶è¡Œå¤„ç†äº†ã€‚</p><p>æœ‰ä¸€ç§ä¼˜åŒ–çš„æ–¹å¼æ˜¯ï¼Œè¿›å…¥ä¸´ç•ŒåŒºä¹‹å‰ï¼Œè¯»ä¸€ä¸‹ <code>tnc</code>, ä½œä¸º <code>midTn</code>ï¼Œç„¶åå…ˆåšä¸€æ¬¡éªŒè¯ã€‚è¯»å– tnc ä¹‹åï¼Œåç»­çš„æäº¤äº‹åŠ¡ ts éƒ½æ˜¯å¤§äº <code>tnc</code> çš„ã€‚è¿™é‡Œå…ˆæ¨¡ç³Šåšä¸€æ¬¡ <code>[StartTn + 1, midTn]</code> å†…çš„æ£€æŸ¥ï¼ˆæ˜¯å¼€å§‹åˆ°ç°åœ¨å·²ç»æäº¤çš„äº‹åŠ¡ï¼‰ï¼Œå†è¿›ä¸´ç•ŒåŒºçš„æ—¶å€™ï¼Œå†æ‹¿åˆ°ä¸€ä¸ªå…·ä½“çš„ <code>FinishTn</code>ï¼ŒåšéªŒè¯ã€‚</p><p>è¿™é‡Œçš„æ ¸å¿ƒé€»è¾‘å°±æ˜¯æ£€æµ‹ <code>[StartTn, FinishTn]</code> è¿™ä¸ª Window ä¸­çš„å†™æ²¡æœ‰å’Œæœ¬äº‹åŠ¡çš„è¯»å†²çªã€‚</p><p>å› ä¸ºæŸ¥è¯¢æ²¡æœ‰ç¼–å·ï¼Œæ‰€ä»¥è¿™é‡Œä¸éœ€è¦ç»™æŸ¥è¯¢ä½œ tnc increment.</p><p>å†å›é¡¾ä¸€ä¸‹è¿™ä¸€æ®µï¼Œè¿™é‡Œæœ¬èº«æŠŠ Validation ä¸²è¡Œæ“ä½œäº†ï¼Œå…¶ä¸­å…³é”®çš„éƒ¨åˆ†åœ¨äº <code>tnc</code> çš„è¯»å–å’Œå¢åŠ ï¼Œå†ä¹‹å‰çš„ Rules ä¸­ï¼ŒRule1/Rule2 æ˜¯æ˜¾è€Œæ˜“è§çš„ï¼Œè¿™é‡Œé€šè¿‡ tnc é€’å¢å’ŒéªŒè¯åŒºé—´æ¥ä¿è¯ï¼›æ‹¿åˆ°è¿™ä¸ª id ä¹‹åï¼Œå†å»æ£€æŸ¥è¯»å†™ã€‚</p><h3 id="Parallel-Validation"><a href="#Parallel-Validation" class="headerlink" title="Parallel Validation"></a>Parallel Validation</h3><p>åœ¨è¿™é‡Œï¼Œvalidation é˜¶æ®µå°†ä¼šå˜æˆå¹¶è¡Œçš„ã€‚è¿™é‡Œå°†ä¼šä½¿ç”¨æ‰€æœ‰çš„ä¸‰æ¡è§„åˆ™ã€‚</p><p>å…³äº Rule2, éªŒè¯è§„åˆ™å’Œä¹‹å‰æ˜¯ç›¸åŒçš„ï¼Œå¯¹ Rule 3ï¼Œè¿™é‡Œéœ€è¦ç»´æŠ¤ä¸€ä¸ª <code>active</code> äº‹åŠ¡é›†åˆã€‚é‚£ä¹ˆï¼Œvalidation å¦‚ä¸‹(è¿™é‡Œåˆ†åˆ«è®° <code>&lt;</code> å’Œ <code>&gt;</code> ä¸ºä¸´ç•ŒåŒºçš„å¼€å§‹å’Œç»“æŸ)</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">tend() &#123;</span><br><span class="line">&lt;</span><br><span class="line">    FinishTn := tnc</span><br><span class="line">    FinishActive := &#123;æ‹·è´ä¸€ä»½ active&#125;</span><br><span class="line">    active.Append(&#123;æœ¬äº‹åŠ¡ id&#125;)</span><br><span class="line">&gt;</span><br><span class="line"></span><br><span class="line">æ£€æŸ¥ [StartTn + 1, FinishTn] ä¸­, è¯»é›†åˆæ˜¯å¦å’Œå®ƒä»¬çš„å†™é›†åˆå†²çª</span><br><span class="line">æ£€æŸ¥ FinishActive ä¸­ï¼Œå®ƒçš„å†™æ˜¯å¦ä¸è‡ªèº«çš„è¯»å†²çª</span><br><span class="line"></span><br><span class="line">if valid:</span><br><span class="line">then (</span><br><span class="line">(write phase)</span><br><span class="line">&lt;</span><br><span class="line">tnc := tnc + 1</span><br><span class="line">tn := tnc</span><br><span class="line">active.erase(&#123;æœ¬äº‹åŠ¡ id&#125;)</span><br><span class="line">&gt;</span><br><span class="line">)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ˜¾ç„¶ï¼Œè¿™é‡Œæ˜¯æ²¡é—®é¢˜çš„ï½</p><h2 id="æ¦‚å¿µè¡¥å……"><a href="#æ¦‚å¿µè¡¥å……" class="headerlink" title="æ¦‚å¿µè¡¥å……"></a>æ¦‚å¿µè¡¥å……</h2><p>è¿™é‡Œæœ‰ä¸€ä¸ª Validation é¡ºåºçš„é—®é¢˜ï¼Œå®é™…ä¸Šï¼ŒåŸè®ºæ–‡æè¿°çš„å°±æ˜¯ä¸€ç§ BOCC(Backward OCC) çš„ç®—æ³•ï¼Œå½“äº‹åŠ¡è¿›å…¥ validation é˜¶æ®µçš„æ—¶å€™ï¼Œå®ƒä¼šä¸ä¹‹å‰è¿› Validation çš„äº‹åŠ¡éªŒè¯ã€‚</p><blockquote><p>Backward Validation: Check whether the committing txn intersects its read/write sets with those of any txns that have already committed.</p></blockquote><p><img src="https://image.mwish.me/blog-image/DB4555BD-7807-478C-81FD-316C74FEDD2B.png" alt="DB4555BD-7807-478C-81FD-316C74FEDD2B"></p><p>Forward Validation åœ¨æäº¤çš„æ—¶å€™å¹¿æ’­è‡ªå·±çš„ WriteSetï¼Œè®©è¯»å–çš„äº‹åŠ¡æ¥åšä¸€äº›åˆ¤æ–­ã€‚è¯»å–äº‹åŠ¡å¯ä»¥å½“å³åˆ¤æ–­ï¼Œä¹Ÿå¯ä»¥ Buffer ä¸€äº›ï¼Œæœ€åä¸€èµ·åˆ¤æ–­ã€‚</p><blockquote><p>Forward Validation: Check whether the committing txn intersects its read/write sets with any active txns that have not yet committed.</p></blockquote><p><img src="https://image.mwish.me/blog-image/4957A2A6-1267-4612-9C76-6DA6FF12EF93.png" alt="4957A2A6-1267-4612-9C76-6DA6FF12EF93"></p><p>æ­¤å¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥è€ƒè™‘åŸºäºç‰ˆæœ¬çš„ OCCï¼Œæ¯ä¸ªæ•°æ®é¡¹å’Œä¸€ä¸ªå†™å…¥ç‰ˆæœ¬ç›¸å…³è”ï¼Œè¯»å–çš„æ—¶å€™æ‹¿åˆ°ä¸€ä¸ªæ—¶é—´æˆ³ï¼ŒæˆåŠŸæäº¤çš„äº‹åŠ¡ä¼šå¸¦ä¸€ä¸ªå”¯ä¸€çš„æ—¶é—´æˆ³å†™å…¥ã€‚éªŒè¯çš„æ—¶å€™é€šè¿‡ ts æ¯”å¯¹æ¥è¿›è¡ŒéªŒè¯ï¼šè¯»å–çš„ w-ts å’Œç°æœ‰çš„ w-ts ä¸€æ ·ï¼Œå°±æ²¡å•¥é—®é¢˜ï¼Œè¿™é‡Œ 15-445 slide æ¼”ç¤ºäº†ç›¸å…³çš„ä¾‹å­ã€‚</p><p>å…·ä½“ä¸€äº›ç»†èŠ‚å¯ä»¥åœ¨ï¼š <a href="https://wangziqi2013.github.io/article/2018/03/21/Analyzing-OCC-Anomalies-and-Solutions.html">https://wangziqi2013.github.io/article/2018/03/21/Analyzing-OCC-Anomalies-and-Solutions.html</a> è¿™é‡Œçœ‹çœ‹ã€‚</p><h2 id="OCC-è¯„ä¼°"><a href="#OCC-è¯„ä¼°" class="headerlink" title="OCC è¯„ä¼°"></a>OCC è¯„ä¼°</h2><p><code>&lt;Main Memory Database Systems&gt;</code> é‡Œé¢æè¿°äº†ä¸€ç§ç°çŠ¶ï¼šå…³äºæ€§èƒ½ï¼Œå®é™…ä¸Šå¤§å®¶å„æ‰§ä¸€è¯ï¼Œæœ‰çš„æ—¶å€™ Benchmark çš„ç»“æœç”šè‡³æ˜¯ç›¸åçš„ã€‚æˆ‘ä»¬å¯ä»¥å¤§æ¦‚çŸ¥é“ OCC åœ¨ä½å†²çªçš„æƒ…å†µä¸‹ï¼Œæœ‰ç›¸å¯¹å¥½ä¸€äº›çš„æ€§èƒ½ã€‚æˆ‘å¯ä»¥å¤§æ¦‚å¤è¿°ä¸€æ®µè¿™ä¸ªè½¦è½±è¾˜è¯ï¼š</p><blockquote><p>æœ‰çš„æ¯”è¾ƒè®¤ä¸ºï¼Œæ‚²è§‚äº‹åŠ¡ Blocking (wound-wait?) ä¼˜äº æ‚²è§‚äº‹åŠ¡é‡å¯ (wait-die?)ï¼Œä½†ä¸€äº›ç ”ç©¶æœ‰ç›¸åçš„ç»“è®ºã€‚åœ¨å¦ä¸€äº›å¯¹æ¯”ä¸­ï¼Œä¹è§‚å¹¶å‘æ¨¡å¼æ¯” åŸºäºé”çš„å¹¶å‘æ¨¡å¼æ›´ä¼˜ï¼Œæœ‰çš„åˆ™ç›¸åã€‚æœ‰ä¸€ä¸ªæ¯”è¾ƒä»¤äººä¿¡æœçš„ç»“è®ºç”± Agrawal ç­‰äººçš„å‡ºï¼Œä»–ä»¬è¡¨ç¤ºï¼Œåœ¨ä½æ•°æ®ç«äº‰çš„åœºæ™¯ä¸‹ï¼Œä¹è§‚å¹¶å‘æ€§èƒ½æ›´ä¼˜ï¼Œä½†å†²çªå¢åŠ çš„æ—¶å€™ï¼Œç”±äº rollback å’Œ restartï¼Œå‡ºç°äº†æ›´é«˜çš„å†²çªç‡ã€‚</p></blockquote><p><code>&lt;Staring into the Abyss: An Evaluation of Concurrency Control with One Thousand Cores&gt;</code> è¿™ç¯‡è®ºæ–‡å‘è¡¨äº VLDBâ€™14. æœ¬èº«æ˜¯æè¿° OCC/2PL/TS/MVCC/H-Store ç­‰åè®®åœ¨ 1000æ ¸å¿ƒçš„æ¨¡æ‹Ÿå™¨ä¸‹å¹¶å‘çš„ã€‚é‡‡ç”¨ç¡¬ä»¶å¯„å­˜å™¨æ¥å¹¶å‘æœ‰æ¯”è¾ƒä¼˜çš„æ•ˆç‡:</p><p><img src="https://image.mwish.me/blog-image/CE64E7F2-9568-4A42-AD43-EAA8131EB290.png" alt="CE64E7F2-9568-4A42-AD43-EAA8131EB290"></p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œçš„ counter è‚¯å®šä¸æ˜¯çº¿æ€§å¢é•¿çš„ï¼Œatomic counter å¯ä»¥å‚è€ƒä¸‹åˆ—æ€§èƒ½è¡¨ï¼š</p><p><img src="https://image.mwish.me/blog-image/WechatIMG82.jpeg" alt="WechatIMG82"></p><p>è¿™ç¯‡æ–‡ç« æ˜¾ç¤ºï¼ŒOCC çš„æ‹·è´æ•°æ®ã€ts ç”³è¯·ç­‰æ–¹å¼ä¼šå¸¦æ¥ä¸å°çš„ç“¶é¢ˆã€‚è¿™é‡Œçš„é—®é¢˜æ˜¯èƒ½å¦ Partitionï¼ˆcounter å±‚æ¬¡çš„ Partitionï¼‰ï¼Œæ›´é«˜çš„æ€§èƒ½å¯èƒ½å¯¼è‡´ä¸€äº›è¯­ä¹‰ä¸Šçš„å˜åŒ–ï¼Œæ¯”å¦‚ä¸åŸå­é€’å¢çš„ counterï¼Œç”šè‡³ç±»ä¼¼ snowflake é‚£æ ·å¸¦æœ‰ id çš„ counterã€‚</p><p>æœ¬æ–‡ä¸­ï¼ŒOCC æ€§èƒ½å—åˆ¶äºæ—¶é—´æˆ³åˆ†é…ã€æ‹·è´åˆ° private spaceã€é«˜å†²çªä¸‹çš„ abortã€‚</p><p>æˆ‘è§‰å¾—è¿™ç¯‡æ–‡ç« æœ‰ä¸€å®šçš„å‚è€ƒä»·å€¼ï¼Œä½†æ˜¯æ„ä¹‰æ²¡é‚£ä¹ˆå¤§ï¼Œå› ä¸ºå¾ˆå¤šä¸œè¥¿å’Œå®ç°ç»†èŠ‚å…³ç³»å¾ˆå¤§ï¼Œæœ¬èº«æ˜¯æœ‰å¾ˆå¤šä¼˜åŒ–å’Œå•†æ¦·ç©ºé—´çš„ï¼Œæ–‡ç« ä¸­ç“¶é¢ˆåœ¨ timestamp åˆ†é…ä¸Šä¹Ÿæ˜¯å¯ä»¥ç†è§£çš„ã€‚</p><h2 id="MVOCC"><a href="#MVOCC" class="headerlink" title="MVOCC"></a>MVOCC</h2><p><img src="https://image.mwish.me/blog-image/D4A2FD3F-B881-421D-B11C-458EA5A9AD0C.png" alt="D4A2FD3F-B881-421D-B11C-458EA5A9AD0C"></p><p>å¯¹äº MVOCC è€Œè¨€ï¼Œå¯ä»¥ç»™æ¯ä¸ªæ•°æ®å¸¦ä¸Šä¸€ä¸ª begin-ts å’Œ end-tsï¼Œè¿™é‡Œå°±ä¸ç”¨æ‹·è´äº‹åŠ¡çš„ private space äº†ï¼Œå–è€Œä»£ä¹‹çš„æ˜¯ GC é—®é¢˜ã€‚</p><p>è¿˜éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒMVCC å¹¶ä¸æ˜¯ä¸‡çµè¯ï¼Œå®ƒä¸ä¼šåœ¨ä»»ä½•åœºæ™¯éƒ½èƒ½æä¾›ä¼˜åŒ–ã€‚å®ƒæä¾›çš„æ›´åƒæ˜¯ä¸€ç§å¯¹æŠ— è¯»/å†™æ··åˆçš„é˜²é¢ ç°¸ã€‚</p><p>åœ¨ benchmark ä¸­ï¼Œè®ºæ–‡æµ‹è¯•äº†ä¸‹åˆ—ä¸‰ç§è´Ÿè½½ï¼š</p><ol><li>read-only (100% reads)</li><li>read-intensive (80% reads, 20% updates)</li><li>update-intensive (20% reads, 80% updates).</li></ol><p>è®ºæ–‡é‡Œè®°å·å¦‚ä¸‹ï¼š</p><p><img src="https://image.mwish.me/blog-image/D6E37BA2-6115-4E2A-8540-C02C6AFC725B.png" alt="D6E37BA2-6115-4E2A-8540-C02C6AFC725B"></p><p>åœ¨ä½ç«äº‰çš„æµ‹è¯•ä¸‹ï¼ŒMVOCC æœ‰ç€å°šå¯çš„æ€§èƒ½ï¼ŒæŠ¥å‘Šå¦‚ä¸‹ï¼š</p><p><img src="https://image.mwish.me/blog-image/EAD56C87-EDB8-452D-80B0-5F14C2909524.png" alt="EAD56C87-EDB8-452D-80B0-5F14C2909524"></p><p>å¾ˆç¬¦åˆç›´è§‰çš„ï¼Œåœ¨é«˜æ•°æ®ç«äº‰çš„æƒ…å†µä¸‹ï¼Œæœ‰å¦‚ä¸‹ case:</p><p><img src="https://image.mwish.me/blog-image/90BDE6B4-B17D-40BE-8E5E-849EBC623311.png" alt="90BDE6B4-B17D-40BE-8E5E-849EBC623311"></p><p>å†æ··åˆè´Ÿè½½ä¸‹ï¼Œç»™å‡ºä¸€å®šå†™ï¼Œå¢åŠ è¯»ï¼ŒMVOCC æœ¬èº«å—è¯»äº‹åŠ¡å¹²æ‰°è¾ƒå°ï¼Œè€Œéšç€å†™å†²çªå¢åŠ ï¼Œå®ƒå¯ä»¥ç«‹é©¬æ€§èƒ½ä¸‹é™ç»™ä½ çœ‹ï¼š</p><p><img src="https://image.mwish.me/blog-image/08ACD15D-C2A3-47EA-A380-CB814782A18E.png" alt="08ACD15D-C2A3-47EA-A380-CB814782A18E"></p><p>è®ºæ–‡è¿˜æœ‰ TPC-C æµ‹è¯•ç­‰ï¼Œå¦‚ä¸‹å›¾ï¼š</p><p><img src="https://image.mwish.me/blog-image/1723F877-F9AD-43CE-A01A-88874F6C94BC.png" alt="1723F877-F9AD-43CE-A01A-88874F6C94BC"></p><p>ç¬”è€…è®¤ä¸ºï¼Œæœ¬æ–‡ç»™çš„ç­–ç•¥è¿˜æ˜¯ç›¸å¯¹é è°±çš„ï¼Œæ„Ÿè§‰æ¯”è¾ƒé è°±çš„æ˜¯ç±»ä¼¼ Hekaton é‚£æ ·ï¼Œåœ¨åŒä¸€å¥—æ¨¡å‹ä¸Šæ”¯æŒä¹è§‚ + æ‚²è§‚çš„å½¢å¼ï¼Œæ–¹ä¾¿é€‚åˆå„ç§ä½•æ ·çš„è´Ÿè½½ã€‚</p><h2 id="Hekaton"><a href="#Hekaton" class="headerlink" title="Hekaton"></a>Hekaton</h2><p>æœ¬åè®®æ˜¯ä¸€ä¸ªåŸºäºéªŒè¯çš„åè®®ï¼Œæœ¬èº«æ˜¯ MVCC çš„. è®ºæ–‡ä¹è§‚çš„å‡è®¾äº†ç¢°åˆ°çš„å†²çªçš„äº‹åŠ¡éƒ½ä¼šæˆåŠŸï¼Œå¹¶ä¸”ç”¨æ— é”å¹¶å‘æ¥å®ç°è¿™æ ·ä¸€ä¸ªæ¨¡å‹ï¼š</p><p><img src="https://image.mwish.me/blog-image/DDC124F9-1D35-420E-B0E8-651E37EB7AE4.png" alt="DDC124F9-1D35-420E-B0E8-651E37EB7AE4"></p><h2 id="HyPer"><a href="#HyPer" class="headerlink" title="HyPer"></a>HyPer</h2><p>æœ¬åè®®æ˜¯ä¸€ä¸ªåŸºäºéªŒè¯çš„åè®®ï¼Œæœ¬èº«æ˜¯ MVCC çš„. æœ‰è¶£çš„åœ°æ–¹æ˜¯è°“è¯é”çš„å®ç°ã€‚</p><p>è¿™é‡Œç”¨å†æ¬¡ Scan çš„æ–¹å¼æ¥éªŒè¯ï¼ŒåŒæ—¶ï¼Œå®ƒä¼šä¿ç•™è°“è¯é”ï¼Œè€Œä¸æ˜¯æ•°æ®çš„é”ï¼Œæ¥å‡è½»å¼€é”€ã€‚</p><p><img src="https://image.mwish.me/blog-image/2F6E5D66-44A7-4FAB-B5D5-62045A6FF2A0.png" alt="2F6E5D66-44A7-4FAB-B5D5-62045A6FF2A0"></p><h2 id="Silo-Speedy-Transactions-in-Multicore-In-Memory-Databases"><a href="#Silo-Speedy-Transactions-in-Multicore-In-Memory-Databases" class="headerlink" title="Silo: Speedy Transactions in Multicore In-Memory Databases"></a>Silo: Speedy Transactions in Multicore In-Memory Databases</h2><p>æœ¬åè®®æ˜¯ä¸€ä¸ªåŸºäº TS çš„åè®®. Silo æœ¬èº«æ˜¯è®¾è®¡åœ¨æ–°ç¡¬ä»¶ä¸Šçš„ï¼Œç‰¹ç‚¹æ˜¯ Batch æ¥å– Ts</p><p><img src="https://image.mwish.me/blog-image/2B014146-E822-4198-9DE2-085512A9271C.png" alt="2B014146-E822-4198-9DE2-085512A9271C"></p><h2 id="TicToc"><a href="#TicToc" class="headerlink" title="TicToc"></a>TicToc</h2><p>æœ¬åè®®æ˜¯ä¸€ä¸ªåŸºäº TS çš„åè®®. ä¹‹å‰çš„åè®®å¯èƒ½éƒ½è¦æ‹¿åˆ°ä¸€ä¸ªå…·ä½“çš„ ts, TicToc åšå‡ºçš„ä¼˜åŒ–æ˜¯ï¼Œæ‹¿åˆ°ä¸€ä¸ªå¤§æ¦‚çš„ ts èŒƒå›´ï¼Œè€Œä¸å–å…·ä½“çš„æ—¶é—´æˆ³ã€‚</p><p><img src="https://image.mwish.me/blog-image/27916230-345F-43AC-996F-AF4F539D29C8.png" alt="27916230-345F-43AC-996F-AF4F539D29C8"></p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p>[1] On Optimistic Methods for Concurrency Control</p><p>[2] Transaction Processing on Modern Hardware</p><p>[3] <a href="https://wangziqi2013.github.io/article/2018/03/21/Analyzing-OCC-Anomalies-and-Solutions.html">https://wangziqi2013.github.io/article/2018/03/21/Analyzing-OCC-Anomalies-and-Solutions.html</a></p><p>[4] An Empirical Evaluation of In-Memory Multi-Version Concurrency Control</p><p>[5] Staring into the Abyss: An Evaluation of Concurrency Control with One Thousand Cores</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>è°ˆè°ˆæ ¼å¼: åˆ—å­˜</title>
      <link href="/2022/01/15/format-thinking-2/"/>
      <url>/2022/01/15/format-thinking-2/</url>
      
        <content type="html"><![CDATA[<h2 id="åˆ—å¼å­˜å‚¨"><a href="#åˆ—å¼å­˜å‚¨" class="headerlink" title="åˆ—å¼å­˜å‚¨"></a>åˆ—å¼å­˜å‚¨</h2><p>è‡ª GFS/Hadoop æ—¶ä»£ä»¥æ¥ï¼Œåœ¨ä¸€ä¸ªæ—  Schema çš„å­˜å‚¨ä¸Šå­˜å‚¨ç”¨æˆ·æƒ³è¦çš„æ•°æ®ä¹Ÿæˆä¸ºäº†ç”¨æˆ·çš„é‡è¦éœ€æ±‚ã€‚Stonebraker æ‰¹åˆ¤äº†è¿™ç§æƒ…å†µï¼Œåœ¨ Redbook 4th ä¸Šï¼ŒåšæŒç”¨æˆ·è¿˜æ˜¯éœ€è¦ Schema çš„ã€‚äº‹å®è¯æ˜è¿™äº› Schema ç¡®å®æ˜¯å¾ˆå¥½çš„ä¸œè¥¿ã€‚å°½ç®¡æœ‰ç±»ä¼¼ Apache Hudi è¿™æ ·çš„ç³»ç»Ÿå’Œéƒ¨åˆ†ç³»ç»Ÿç”¨æˆ·å­˜å‚¨è¡Œå¼çš„æ•°æ®ã€‚ä½†æ•°æ®ä»“åº“éƒ½å€¾å‘äºå°†æ•°æ®å­˜å‚¨æˆåˆ—/è¡Œåˆ—æ··åˆçš„æ ¼å¼ã€‚</p><p>ç®€å•æ¥è¯´ï¼Œè¿™æ ·çš„å­˜å‚¨æ–¹å¼æœ‰å‡ ç§å¥½å¤„ï¼š</p><ol><li>å¯¹æŸå‡ åˆ—æ•°æ®çš„è®¿é—®ï¼Œèƒ½å¤Ÿæœ‰ä¸é”™çš„å±€éƒ¨æ€§å’Œæ›´ä½çš„ä¿¡æ¯ç†µ</li><li>ç›¸åŒçš„ type å¯ä»¥ç”¨ä¸€äº›éé€šç”¨ï¼ˆsnappyï¼Œzstd ç­‰ï¼‰æ–¹å¼æ¥å‹ç¼©ã€å»¶è¿Ÿç‰©åŒ–ã€‚åŒæ—¶èƒ½å‡å°å ç”¨çš„ç©ºé—´. é€šå¸¸å ç”¨ç©ºé—´è¿™ç‚¹æ˜¯ä¼šè¢«å¿½ç•¥çš„ï¼Œä½†æ˜¯å®ƒèƒ½èµ·åˆ°å¾ˆå¤šæ„æƒ³ä¸åˆ°çš„æ”¶ç›Š</li><li>æ›´å¥½çš„ IPCã€å¯¹ SIMD çš„åˆ©ç”¨</li></ol><p>å¯¹äºåˆ—çš„å­˜å‚¨æ¥è¯´ï¼Œæˆ‘ä»¬ä»ç„¶æœ‰å¾ˆå¤šé€šç”¨çš„æ ¼å¼ï¼Œä¾‹å¦‚ Parquetã€ORCã€‚éƒ¨åˆ† shared-nothing çš„æ•°æ®ä»“åº“è‡ªå·±ä¼šå®ç°ä¸€äº›æ ¼å¼ï¼ŒClickHouseï¼›ä¹Ÿæœ‰æ•°æ®ä»“åº“ç”¨è¿™äº›å¼€æ”¾çš„ Parquet æ ¼å¼æ¥æä¾›æ”¯æŒï¼Œæ¯”å¦‚ databendã€‚è¿™äº›æ ¼å¼æœ‰å…±æ€§ã€ä¹Ÿæœ‰ä¸åŒçš„åœ°æ–¹ã€‚</p><p>åŒæ—¶ï¼Œä¹Ÿéœ€è¦æ³¨æ„ï¼ŒæŠŠä¸€è¡Œå­˜æˆåˆ—å¼ä¸ä¸€å®šä»£è¡¨æ¯åˆ—éƒ½åˆ†å¼€å­˜ï¼Œå¯èƒ½æœ‰ä¸€å®šçš„æŠ˜è¡·æ–¹æ¡ˆï¼Œæ¯”å¦‚æ•°ä¸ª column ä¸€èµ·å­˜ã€‚</p><p>æ­¤å¤–ï¼Œæœ‰ä¸€äº›é¡¹ç›®ä¹Ÿåœ¨ä¸ºåˆ—å¼è®¡ç®—æä¾›å¸®åŠ©ã€‚Apache Arrow æ˜¯ä¸€ä¸ªå¤„ç†è®¡ç®—å’Œäº¤æ¢æ ¼å¼çš„é¡¹ç›®ï¼Œç”¨ SIMD ç­‰å½¢å¼å®Œæˆè®¡ç®—ã€‚</p><p>æˆ‘ä»¬å°†ç®€å•ä»‹ç»ä¸€äº›åˆ—å¼å­˜å‚¨å’Œå‹ç¼©çš„æƒ³æ³•ï¼Œç„¶åä»‹ç»ä¸€äº›é€šç”¨çš„æ€è·¯ã€‚ç¼–ç æœ¬èº«æ˜¯ä¸€ç§ speed å’Œ compression ratio çš„ trade-offï¼Œè€Œè®¡ç®—ç³»ç»Ÿå¯èƒ½èƒ½åˆ©ç”¨å‹ç¼©çš„ä¼˜åŠ¿ï¼Œæ¥å‡å°å®ƒå¸¦æ¥çš„å¼€é”€ï¼Œå¤§å¤§æé«˜æŸ¥è¯¢æ€§èƒ½ã€‚</p><h2 id="ç¼–ç çš„å•ä½-clusters-skipping"><a href="#ç¼–ç çš„å•ä½-clusters-skipping" class="headerlink" title="ç¼–ç çš„å•ä½/clusters/skipping"></a>ç¼–ç çš„å•ä½/clusters/skipping</h2><p><img src="https://image.mwish.me/blog-image/BC69D6D1-43EA-4991-9191-D215CAADD766.png" alt="BC69D6D1-43EA-4991-9191-D215CAADD766"></p><p>Zone Maps æä¾›äº†ä¸€ç§ä¾¿äº skipping çš„æŠ½è±¡ã€‚</p><p>å…·ä½“å¯ä»¥å‚è€ƒï¼š<a href="https://zhuanlan.zhihu.com/p/354334895">https://zhuanlan.zhihu.com/p/354334895</a></p><h2 id="ç¼–ç "><a href="#ç¼–ç " class="headerlink" title="ç¼–ç "></a>ç¼–ç </h2><h3 id="C-Store-æåˆ°çš„æ–¹æ³•"><a href="#C-Store-æåˆ°çš„æ–¹æ³•" class="headerlink" title="C-Store æåˆ°çš„æ–¹æ³•"></a>C-Store æåˆ°çš„æ–¹æ³•</h3><p>C-Store è®ºæ–‡æåˆ°è¿‡ä¸€äº›ç¼–ç çš„å½¢å¼ï¼Œè¿™éƒ¨åˆ†æ ‡è®°åœ¨è®ºæ–‡çš„ RS éƒ¨åˆ†ï¼š</p><p><strong>Type 1</strong>:æœ‰åºçš„ä¸”å¤§éƒ¨åˆ†å€¼ç›¸åŒçš„åºåˆ—</p><p>è¿™ç§åºåˆ—ç”¨ <code>(v, f, n)</code> æ¥è¡¨ç¤º</p><blockquote><p><em>f</em> is the position in the column where <em>v</em> first appears, and <em>n</em> is the number of times <em>v</em> appears in the column.</p></blockquote><p>ä¸ºäº†æ”¯æŒ query, c-store å¯¹è¿™ä¸ªç»“æ„æ”¯æŒäº† Bæ ‘ç´¢å¼•ï¼ŒåŠ å¿«äº†å¯¹è¿™ä¸ªå†…å®¹çš„æŸ¥æ‰¾ã€‚</p><p><strong>Type 2:</strong> æ— åºä¸”å¤§éƒ¨åˆ†å€¼ç›¸åŒçš„åºåˆ—</p><p>è¿™ç§åºåˆ—ç”¨ <em>(v, b)</em> æ¥ç¼–ç ï¼Œ<strong>v</strong> æ˜¯å¯èƒ½çš„å€¼ï¼Œ<strong>b</strong> æ˜¯æ˜¯è¿™ä¸ªå€¼çš„æ•°çš„ bitset:</p><blockquote><p>For example, given a column of integers 0,0,1,1,2,1,0,2,1, we can Type 2-encode this as three pairs: (0, 110000100), (1, 001101001), and (2,000010010).</p></blockquote><p>è¿™é‡Œä¹Ÿå®ç°äº† <code>&lt;position, value&gt;</code> çš„ B+Tree æŸ¥æ‰¾ç»“æ„ã€‚</p><p><strong>Type 3</strong>: æœ‰åºä¸”å€¼è¾ƒå°‘ç›¸åŒçš„åºåˆ—</p><p>é‡‡ç”¨ Delta çš„å½¢å¼è¿›è¡Œç¼–ç ï¼ˆæˆ‘æ„Ÿè§‰è¿™é‡Œæœ‰ç‚¹æ€ªï¼Œå› ä¸º delta æœ¬èº«åº”è¯¥å’Œå‹ç¼©æ²¡å…³ç³»ï¼Œæ„Ÿè§‰åƒæ˜¯ç”¨äº† delta + varint å•¥çš„â€¦ï¼‰</p><p><strong>Type 4</strong>: æ— åºï¼Œä¸”å€¼è¾ƒå°‘ç›¸åŒçš„åºåˆ—ï¼Œç›¸å¯¹æ¯”è¾ƒéš¾ç¼–ç ã€‚</p><h3 id="The-Design-and-Implementation-of-Modern-Column-Oriented-Database-Systems"><a href="#The-Design-and-Implementation-of-Modern-Column-Oriented-Database-Systems" class="headerlink" title="The Design and Implementation of Modern Column-Oriented Database Systems"></a>The Design and Implementation of Modern Column-Oriented Database Systems</h3><p>è¿™é‡Œæåˆ°äº†å‡ ç§ç¼–ç æ–¹å¼</p><h4 id="RLE-Run-Length-Encoding"><a href="#RLE-Run-Length-Encoding" class="headerlink" title="RLE: Run Length Encoding"></a>RLE: Run Length Encoding</h4><p>åŒä¸Šè¿°çš„ <strong>type 1</strong>ã€‚</p><h4 id="Bit-Vec-Encoding"><a href="#Bit-Vec-Encoding" class="headerlink" title="Bit-Vec Encoding"></a>Bit-Vec Encoding</h4><p>åŒä¸Šè¿°çš„ <strong>type 2</strong></p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œbit-vec encoding è¿˜èƒ½å¤Ÿè¿›ä¸€æ­¥å‹ç¼©ï¼Œå¦‚æœ bitmap å¾ˆå¤š 0 æˆ–è€… å¾ˆå¤š 1ï¼Œå¯ä»¥ç”¨æ ‡å‡†çš„å‹ç¼©ç®—æ³•å‹ç¼©ï¼›ä¹Ÿå¯ä»¥ç”¨ RLE çš„æ–¹å¼æ¥å‹ç¼©ã€‚Oracle Byte-Aligned Bitmap (Oracleâ€™s BBC) å’Œ WAH(word-aligned hybrid)æä¾›äº†ä¸€ç§æ–¹æ¡ˆã€‚å½“ç„¶ï¼Œè¿™ç§æ–¹æ¡ˆåªæœ‰æ•°æ®éå¸¸ç¨€ç–çš„æ—¶å€™ï¼Œæ‰å€¼å¾—ä½¿ç”¨ã€‚</p><h4 id="Dictionary"><a href="#Dictionary" class="headerlink" title="Dictionary"></a>Dictionary</h4><p>Dictionary æŸç§æ„ä¹‰ä¸Šå’Œ Bit-Vec Encoding å¾ˆåƒï¼Œæˆ‘ä¸ªäººç†è§£å¯ä»¥æ”¾åœ¨ä¸åŒåœºæ™¯ä½¿ç”¨ã€‚å®ƒå¯¹æŸä¸€åˆ—çš„æ•°æ®æ„å»ºäº†ä¸€ä¸ªå­—å…¸è¡¨ï¼Œç„¶åé‡Œé¢çš„æ•°æ®è¡¨ç¤ºåœ¨å­—å…¸çš„å“ªä¸€é¡¹ã€‚å½“ç„¶ï¼Œå¦‚æœæ•°æ®åˆ†å¸ƒå¾ˆå¤šçš„è¯ï¼Œè¿™ä¸ªå­—å…¸ä¼šè†¨èƒ€çš„éå¸¸å¤§ã€‚</p><p>ä¸€èˆ¬çš„æƒ…å†µä¸‹ï¼Œæ•°æ®å¯èƒ½ä¼šä»¥ã€Œæ¯ä¸ª Block/File/ â€¦ã€ ä¸åŒç²’åº¦çš„å¤§å°æ¥æ„å»ºå­—å…¸ã€‚ä¿è¯å­—å…¸æœ¬èº«ä¸ä¼šè†¨èƒ€å¾ˆå¤§ã€‚</p><p>å¯¹äºä¸€äº›ç›¸åŒæ¨¡å¼çš„å­—ç¬¦ä¸²ï¼Œå­—å…¸ç¼–ç å¯ä»¥è®©ä»–ä»¬æ¯ä¸€é¡¹æœ‰ç›¸åŒçš„é•¿åº¦ï¼Œè¿™ä¹Ÿèƒ½å¤§å¤§åŠ é€ŸæŸ¥è¯¢ã€é™ä½å­˜å‚¨ç©ºé—´ã€‚</p><p>æ­¤å¤–ï¼Œè€ƒè™‘åˆ°å¯¹ä¸Šå±‚æ‰§è¡Œçš„ä¼˜åŒ–ï¼Œè€Œä¸ä»…ä»…æ˜¯å‹ç¼©çš„è¯ï¼Œå­—å…¸å‹ç¼©å¯èƒ½è¦è€ƒè™‘ä¸€äº›å¥‡æ€ªçš„ä¸œè¥¿ï¼š</p><ol><li>åœ¨æ„å»ºçš„æ—¶å€™æ˜¯ä¸€æ¬¡æ€§æ„å»ºï¼Œè¿˜æ˜¯ç¢°åˆ°æ–°çš„å€¼ï¼Œå°±ç»™ä¸€ä¸ªæ–°çš„</li><li>å­—å…¸çš„ order å’ŒåŸæœ¬çš„ order æ˜¯å¦ä¸€æ ·å‘¢ï¼Ÿæ¯”å¦‚æˆ‘ä»¬æŠŠå‡ ä¸ªå­—ç¬¦ä¸²å­—å…¸å‹ç¼©äº†ï¼Œç„¶åéœ€è¦æ’åºæˆ–è€…å– top ä¹‹ç±»çš„ï¼Œå¯èƒ½å¸Œæœ›è¿™ä¸ªåºå·å’ŒåŸæ¥æœ‰ä¸€æ ·çš„é¡ºåºï¼ˆOrder-preserving encodingï¼‰</li></ol><p>åœ¨ Dictionary Encoding æ„å»ºçš„æ—¶å€™ï¼Œå¯èƒ½è¦è€ƒè™‘ï¼š</p><ol><li>å€¼çš„ <strong>cardinal number</strong> æœ‰å¤šå°‘ç§</li><li>åŒ…æ‹¬è¿™äº›æ•°æ®ï¼Œå¤„ç†çš„æ—¶å€™ï¼Œæ˜¯å¦èƒ½ Fit åœ¨ L1/L2 Cache ä¸­</li><li>æ˜¯å¦éœ€è¦è®©æ•°æ® byte-aligned. æŒ‰ä½å¯¹é½çš„æ•°æ®é€šå¸¸æ¥è¯´å¤„ç†ä¼šå¿«å¾ˆå¤šï¼Œä¸è¿‡å‹ç¼©/è§£å‹ç¼© CPU å¼€é”€ä¹Ÿæ›´å¤§</li></ol><p>åœ¨è§£æçš„æ—¶å€™ï¼Œå•çº¯ Dictionary Encoding ä¹Ÿèƒ½å¤Ÿå¾ˆå¥½çš„è§£æåˆ°å•ä¸ªå€¼ä¸Šã€‚æ­¤å¤–è¿˜æœ‰ä¸€äº›ä¿åºçš„å‹ç¼©ç®—æ³•ï¼Œæ¯”å¦‚ ALM æˆ–è€… ZILã€‚</p><h4 id="Frame-Of-Reference-FOR"><a href="#Frame-Of-Reference-FOR" class="headerlink" title="Frame Of Reference (FOR)"></a>Frame Of Reference (FOR)</h4><p>å½“æ•°æ®æœ‰ä¸€å®šå±€éƒ¨æ€§çš„æ—¶å€™ï¼Œå¯èƒ½å¯ä»¥ç»„ç»‡æˆ frame çš„å½¢å¼ï¼Œä¾‹å¦‚ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1003, 1001, 1007, 1006, 1004</span><br></pre></td></tr></table></figure><p>å¯ä»¥ç»„ç»‡æˆï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1000, 3, 1, 7, 6, 4</span><br></pre></td></tr></table></figure><p>çš„å½¢å¼ã€‚è¿™é‡Œå¯ä»¥æ³¨æ„ï¼Œ<code>3, 1, 7, 6, 4</code> æ˜¯ä»¥ Delta çš„å½¢å¼å­˜å‚¨çš„ï¼Œæ›´å¤šçš„æ—¶å€™å¯èƒ½ä¼šè®©å®ƒä»¬å å°½é‡å°‘çš„ä½ï¼Œä¾‹å¦‚ä»¥ varint çš„æ–¹å¼å­˜å‚¨ã€‚</p><h4 id="Increment-Encoding"><a href="#Increment-Encoding" class="headerlink" title="Increment Encoding"></a>Increment Encoding</h4><p>Increment Encoding å¸¸è§äº Key çš„å‹ç¼©ç¼–ç ã€‚å¯¹äº key/value çš„ä¸Šå±‚è¾“å…¥ï¼Œå¸¸å¸¸ä¼šæœ‰ç›¸åŒå‰ç¼€/åç¼€çš„ stringï¼Œå¯ä»¥é‡‡ç”¨å¢é‡ç¼–ç ã€‚LevelDB ä½¿ç”¨äº†å‰ç¼€å‹ç¼© + Restartã€‚</p><p>å…·ä½“å¯è§ wikiã€‚</p><h4 id="The-Patching-Technique-Mostly-Encoding"><a href="#The-Patching-Technique-Mostly-Encoding" class="headerlink" title="The Patching Technique / Mostly Encoding"></a>The Patching Technique / Mostly Encoding</h4><p>ä¸Šè¿°æœ‰çš„æ–¹æ³•ä¸­ï¼Œä¸ä¸€å®šé€‚åˆå®Œæ•´çš„é›†åˆï¼Œæ¯”æ–¹è¯´ï¼Œåªåœ¨æŸä¸€æ®µä¸­ï¼Œæ•°æ®æ˜¯æœ‰å±€éƒ¨æ€§çš„ã€‚Patching ç›¸å½“äºï¼š</p><ol><li>æœ‰ä¸€äº›æ§åˆ¶æ®µï¼Œè¡¨ç¤ºæŸå‡ æ®µæ˜¯ä»¥ç‰¹æ®Šç¼–ç æ–¹å¼å­˜å‚¨æ•°æ®çš„</li><li>åœ¨æ§åˆ¶æ®µå¤–ï¼Œä¸å‹ç¼©ã€‚</li></ol><p>æ­¤å¤–ï¼Œå¦‚æœæœ‰æé™çš„å€¼çš„è¯ï¼Œå¯ä»¥æ ‡æ³¨å‡ºæ¥ï¼Œåšç‰¹æ®Šå¤„ç†ï¼š</p><p><img src="https://image.mwish.me/blog-image/30D10CA5-E03F-480A-9FE2-E907512FB0DD.png" alt="30D10CA5-E03F-480A-9FE2-E907512FB0DD"></p><h3 id="æ‚è°ˆ"><a href="#æ‚è°ˆ" class="headerlink" title="æ‚è°ˆ"></a>æ‚è°ˆ</h3><p>å¯¹äºç¼–ç çš„é€‰æ‹©ï¼Œæœ‰ä¸€äº›è®ºæ–‡è¡¨ç¤ºäº†å¦‚ä½•è‡ªåŠ¨åˆ‡æ¢ï¼Œä»¥è¾¾åˆ°å¾ˆå¥½çš„æ•ˆæœã€‚ä¾‹å¦‚ SIGMOD 2021 çš„ CodecDBã€‚</p><p>æœ‰å¾ˆå¤šå¯ä¾›å‚è€ƒçš„ä»£ç ï¼Œæ¯”å¦‚ ORC/Parquet çš„å‹ç¼©æ ¼å¼ï¼Œå’Œ Facebook çš„æ—¶åºæ•°æ®åº“ Gorillaï¼ˆæå‡ºäº†æ—¶é—´å‹ç¼©çš„ delta-of-deltaï¼Œdouble ç±»å‹çš„å‹ç¼©æ–¹å¼ï¼‰ã€‚</p><p>å…³äº int çš„å‹ç¼©ï¼Œå¯ä»¥çœ‹ï¼š<a href="https://kkc.github.io/2021/01/30/integer-compression-note/">https://kkc.github.io/2021/01/30/integer-compression-note/</a> å’Œ <a href="https://arxiv.org/pdf/1908.10598.pdf">https://arxiv.org/pdf/1908.10598.pdf</a></p><h2 id="ORC-Parquet"><a href="#ORC-Parquet" class="headerlink" title="ORC/Parquet"></a>ORC/Parquet</h2><p>Apache ORC å’Œ Apache Parquet å¯ä»¥è¯´æ˜¯åˆ—å¼å­˜å‚¨è¿™äº›å¼€æ”¾æ ¼å¼çš„äº‹å®æ ‡å‡†äº†ã€‚å®ƒä»¬æœ‰å¾ˆå¤šç›¸åŒçš„éƒ¨åˆ†ï¼Œä¹Ÿæœ‰éƒ¨åˆ†åŒºåˆ«</p><h3 id="åŸºæœ¬åŸç†"><a href="#åŸºæœ¬åŸç†" class="headerlink" title="åŸºæœ¬åŸç†"></a>åŸºæœ¬åŸç†</h3><p>ORC å…¨ç§°æ˜¯ï¼šOptimized Row Columnarã€‚è¿™ä¸ªæ ¼å¼æœ¬èº«ä¼¼ä¹æ˜¯ä¸º Hadoop é¡¹ç›®è®¾è®¡çš„ã€‚</p><p><img src="https://image.mwish.me/blog-image/OrcFileLayout.png" alt="OrcFileLayout"></p><p>æˆ‘ä»¬ä»¥ ORC v3 ä¸ºä¾‹ä»‹ç»ä¸€ä¸‹è¿™é‡Œçš„åŸºæœ¬åŸç†ã€‚å¿½ç•¥ Index Data éƒ¨åˆ†ã€‚å¤šä¸ªè¡Œä¼šè¢«ç»„ç»‡æˆ RowGroup/Stripe ï¼ˆåè¯å¾ˆå¤šï¼Œæ‡‚æ„æ€å°±è¡Œï¼‰ï¼Œç„¶åé‡Œé¢åˆ‡åˆ†ä¸º Columnã€‚</p><p>ORC æ–‡ä»¶è§£ææ˜¯ä»åå¾€å‰çš„ï¼Œåœ¨ HDFS ä¸­ï¼Œæ–‡ä»¶å†…å®¹æœ¬èº«æ˜¯ä¸ä¼šç›´æ¥è¢«ä¿®æ”¹çš„ï¼Œæ‰€ä»¥ä¸€äº›å…ƒä¿¡æ¯ä¼šè¢«å­˜åœ¨æ–‡ä»¶çš„å°¾éƒ¨ã€‚ä¸ºä¾¿äºæ›´æ–°ï¼Œå…ƒä¿¡æ¯å¯èƒ½ç”¨ PB æè¿°ã€‚Postscript éƒ¨åˆ†åŒ…å«æ•´ä¸ªæ–‡ä»¶çš„å…ƒä¿¡æ¯ï¼Œè€Œ File Footer éƒ¨åˆ†å¯èƒ½åŒ…å«å„ä¸ª Stripe çš„ä¿¡æ¯ï¼Œä¾¿äºè·è‡´æ›´å…·ä½“çš„æ–‡ä»¶ä¿¡æ¯ã€‚</p><figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">message </span><span class="title class_">Footer</span> &#123;</span><br><span class="line"> <span class="comment">// the length of the file header in bytes (always 3)</span></span><br><span class="line"> <span class="keyword">optional</span> <span class="type">uint64</span> headerLength = <span class="number">1</span>;</span><br><span class="line"> <span class="comment">// the length of the file header and body in bytes</span></span><br><span class="line"> <span class="keyword">optional</span> <span class="type">uint64</span> contentLength = <span class="number">2</span>;</span><br><span class="line"> <span class="comment">// the information about the stripes</span></span><br><span class="line"> <span class="keyword">repeated</span> StripeInformation stripes = <span class="number">3</span>;</span><br><span class="line"> <span class="comment">// the schema information</span></span><br><span class="line"> <span class="keyword">repeated</span> Type types = <span class="number">4</span>;</span><br><span class="line"> <span class="comment">// the user metadata that was added</span></span><br><span class="line"> <span class="keyword">repeated</span> UserMetadataItem metadata = <span class="number">5</span>;</span><br><span class="line"> <span class="comment">// the total number of rows in the file</span></span><br><span class="line"> <span class="keyword">optional</span> <span class="type">uint64</span> numberOfRows = <span class="number">6</span>;</span><br><span class="line"> <span class="comment">// the statistics of each column across the file</span></span><br><span class="line"> <span class="keyword">repeated</span> ColumnStatistics statistics = <span class="number">7</span>;</span><br><span class="line"> <span class="comment">// the maximum number of rows in each index entry</span></span><br><span class="line"> <span class="keyword">optional</span> <span class="type">uint32</span> rowIndexStride = <span class="number">8</span>;</span><br><span class="line"> <span class="comment">// Each implementation that writes ORC files should register for a code</span></span><br><span class="line"> <span class="comment">// 0 = ORC Java</span></span><br><span class="line"> <span class="comment">// 1 = ORC C++</span></span><br><span class="line"> <span class="comment">// 2 = Presto</span></span><br><span class="line"> <span class="comment">// 3 = Scritchley Go from https://github.com/scritchley/orc</span></span><br><span class="line"> <span class="comment">// 4 = Trino</span></span><br><span class="line"> <span class="keyword">optional</span> <span class="type">uint32</span> writer = <span class="number">9</span>;</span><br><span class="line"> <span class="comment">// information about the encryption in this file</span></span><br><span class="line"> <span class="keyword">optional</span> Encryption encryption = <span class="number">10</span>;</span><br><span class="line"> <span class="comment">// the number of bytes in the encrypted stripe statistics</span></span><br><span class="line"> <span class="keyword">optional</span> <span class="type">uint64</span> stripeStatisticsLength = <span class="number">11</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ–‡ä»¶çš„ä¸»ä½“éƒ¨åˆ†è¢«åˆ†ä¸ºå¤šä¸ª Stripeï¼Œåœ¨åˆ«çš„æ ¼å¼ä¸­ï¼Œå®ƒå¯èƒ½è¢«ç§°ä¸º RowGroupã€‚å®ƒåŒ…å«ï¼š</p><ol><li>æ•°æ®çš„ç´¢å¼•</li><li>å„åˆ—çš„æ•°æ®</li><li>Stripe çš„ Footer</li></ol><p>Stripe æ”¯æŒä¸‹åˆ—æ ¼å¼çš„å„ç§æ•°æ®ï¼š</p><p><img src="https://image.mwish.me/blog-image/TreeWriters.png" alt="TreeWriters"></p><p>åœ¨ Stripe çš„æŒ‡ç¤ºä¸‹ï¼Œå¯ä»¥æŠŠ Column åšå¦‚ä¸‹çš„å‹ç¼©ï¼š</p><ol><li>RLE</li><li>Dictionary</li><li>Delta</li></ol><p>å¯¹äº Columnï¼ŒORCFile å®šä¹‰ <code>Stream</code> ä¸ºä¸€ä¸²å­—èŠ‚æµã€‚è¿™é‡Œæœ‰å¦‚ä¸‹åˆ†ç±»ï¼š</p><figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">message </span><span class="title class_">Stream</span> &#123;</span><br><span class="line"> <span class="keyword">enum </span><span class="title class_">Kind</span> &#123;</span><br><span class="line">   <span class="comment">// boolean stream of whether the next value is non-null</span></span><br><span class="line">   PRESENT = <span class="number">0</span>;</span><br><span class="line">   <span class="comment">// the primary data stream</span></span><br><span class="line">   DATA = <span class="number">1</span>;</span><br><span class="line">   <span class="comment">// the length of each value for variable length data</span></span><br><span class="line">   LENGTH = <span class="number">2</span>;</span><br><span class="line">   <span class="comment">// the dictionary blob</span></span><br><span class="line">   DICTIONARY_DATA = <span class="number">3</span>;</span><br><span class="line">   <span class="comment">// deprecated prior to Hive 0.11</span></span><br><span class="line">   <span class="comment">// It was used to store the number of instances of each value in the</span></span><br><span class="line">   <span class="comment">// dictionary</span></span><br><span class="line">   DICTIONARY_COUNT = <span class="number">4</span>;</span><br><span class="line">   <span class="comment">// a secondary data stream</span></span><br><span class="line">   SECONDARY = <span class="number">5</span>;</span><br><span class="line">   <span class="comment">// the index for seeking to particular row groups</span></span><br><span class="line">   ROW_INDEX = <span class="number">6</span>;</span><br><span class="line">   <span class="comment">// original bloom filters used before ORC-101</span></span><br><span class="line">   BLOOM_FILTER = <span class="number">7</span>;</span><br><span class="line">   <span class="comment">// bloom filters that consistently use utf8</span></span><br><span class="line">   BLOOM_FILTER_UTF8 = <span class="number">8</span>;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Virtual stream kinds to allocate space for encrypted index and data.</span></span><br><span class="line">   ENCRYPTED_INDEX = <span class="number">9</span>;</span><br><span class="line">   ENCRYPTED_DATA = <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// stripe statistics streams</span></span><br><span class="line">   STRIPE_STATISTICS = <span class="number">100</span>;</span><br><span class="line">   <span class="comment">// A virtual stream kind that is used for setting the encryption IV.</span></span><br><span class="line">   FILE_STATISTICS = <span class="number">101</span>;</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">required</span> Kind kind = <span class="number">1</span>;</span><br><span class="line"> <span class="comment">// the column id</span></span><br><span class="line"> <span class="keyword">optional</span> <span class="type">uint32</span> column = <span class="number">2</span>;</span><br><span class="line"> <span class="comment">// the number of bytes in the file</span></span><br><span class="line"> <span class="keyword">optional</span> <span class="type">uint64</span> length = <span class="number">3</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ä¸‹é¢çš„æ®µï¼Œæè¿°äº†å®ƒä»¬æ˜¯æ€ä¹ˆè¢«æ”¯æŒçš„ï¼š<a href="https://orc.apache.org/specification/ORCv2/">https://orc.apache.org/specification/ORCv2/</a> çš„ Column Encodings ä¸€èŠ‚ã€‚</p><h4 id="å˜é•¿å­—æ®µå’Œ-Null"><a href="#å˜é•¿å­—æ®µå’Œ-Null" class="headerlink" title="å˜é•¿å­—æ®µå’Œ Null"></a>å˜é•¿å­—æ®µå’Œ Null</h4><p><img src="https://image.mwish.me/blog-image/541FB4E7-28A0-4029-B88B-23AC48B38B5D.png" alt="541FB4E7-28A0-4029-B88B-23AC48B38B5D"></p><p>è¿™é‡Œæœ‰ä¸åŒçš„æ¨¡å¼ï¼Œæ¯”æ–¹è¯´ï¼Œdirect å­˜æ”¾ï¼š</p><ol><li>Null çš„é›†åˆï¼Œä»¥ RLE çš„å½¢å¼å­˜æ”¾</li><li>Dataï¼Œè¿ç»­çš„é Null å†…å®¹</li><li>Length å…·ä½“çš„é•¿åº¦</li></ol><p>è€Œ dictionary åˆ™ç”¨å­—å…¸æ¥å­˜å‚¨ã€‚</p><h3 id="Parquet-å’Œ-Dremel"><a href="#Parquet-å’Œ-Dremel" class="headerlink" title="Parquet å’Œ Dremel"></a>Parquet å’Œ Dremel</h3><p>ï¼ˆéœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒParquet è¿™ä¸ªè¯å¾ˆå®¹æ˜“è¯»é”™ï¼Œå¯ä»¥å»æœæœçœ‹ä½ è¯»é”™äº†å—ï¼‰</p><p>Parquet çš„ä¸»è¦æ€è·¯æ¥æºäº Google çš„ Dremelã€‚Google å¤§é‡æ•°æ®ç”¨ Protobuf å­˜å‚¨ï¼Œæ‰€ä»¥å½“æ—¶æåˆ—å­˜ï¼Œä¹Ÿè¦å…¼å®¹å®ƒã€‚æ¨è¿‡å†…éƒ¨ç³»ç»Ÿçš„è¯å°±çŸ¥é“å…¼å®¹æ˜¯ä¸€ä¸ªå¼ºéœ€æ±‚äº†ã€‚</p><p><img src="https://image.mwish.me/blog-image/FileLayout.gif" alt="FileLayout"></p><p>æˆ‘ä»¬ä¸å…³æ³¨è¿™ä¸ªæ ¼å¼å’Œ ORC çš„ç»†å¾®åŒºåˆ«ï¼Œæ¯”å¦‚ RowGroup æˆ–è€… Stripe çš„å‘½åã€‚Dremel å…³æ³¨ä¸€ä¸ªåŒ…å« <code>optional</code>, <code>repeated</code> ä¸”å¯èƒ½åµŒå¥—çš„ç»“æ„æ˜¯æ€ä¹ˆå®ç°çš„ï¼š</p><p><img src="https://image.mwish.me/blog-image/9F45A74A-9E03-4731-A00F-3758C8C9E81B.png" alt="9F45A74A-9E03-4731-A00F-3758C8C9E81B"></p><p><img src="https://image.mwish.me/blog-image/F541F4F8-D061-4C2B-98BB-9EFC5F07AA0E.png" alt="F541F4F8-D061-4C2B-98BB-9EFC5F07AA0E"></p><p>å¦‚ Schema æ‰€ç¤ºï¼Œè¿™é‡Œæœ‰åµŒå¥—çš„æ•°æ®ç»“æ„ï¼Œè¿˜æœ‰ repeated å’Œ optionalï¼Œè¿™æ„å‘³ç€ï¼Œéœ€è¦ä¸€äº›é¢å¤–çš„æ ‡å¿—æ¥è§£ææ•°æ®åœ¨å“ªä¸€è¡Œã€‚Dremel å¼•å…¥äº† <code>repetition levels</code> å’Œ <code>Deï¬nition Levels</code> ä¸¤ä¸ªå‘é‡ï¼Œæ¥åšä¸€äº›è¿™æ ·çš„ Resolveã€‚</p><h3 id="ACID-Indexes"><a href="#ACID-Indexes" class="headerlink" title="ACID / Indexes"></a>ACID / Indexes</h3><p>å®é™…ä¸Šï¼ŒORC çš„æ–°ç‰ˆæœ¬æœ‰å¯¹ ACID çš„æ”¯æŒï¼Œä¹Ÿæœ‰ Index ç›¸å…³çš„ä¿¡æ¯ï¼Œå¯ä»¥å­˜æ”¾ä¸€äº› Bloom Filter ä¹‹ç±»çš„ç´¢å¼•ã€‚</p><p>å¯¹äºåˆ—å¼æ•°æ®æ¥è¯´ï¼Œå®é™…ä¸Šå¯ä»¥æœ‰ä¸€äº›ç¨€ç–ç´¢å¼•ä¹‹ç±»çš„ä¼˜åŒ–ï¼Œèƒ½ç»™åˆ° field å¤§æ¦‚çš„ä½ç½®ã€‚åœ¨ ClickHouse çš„ MergeTree é‡Œé¢ï¼Œæœ‰å¤§æ¦‚çš„å®ç°ã€‚åŒæ—¶ï¼Œå¦‚æœä»¥è¡Œçš„æ–¹å¼ï¼Œè¿›è¡Œå¢é‡æ›´æ–°çš„è¯ï¼Œè¿™é‡Œå†™æ”¾å¤§ä¼šæ¯”è¾ƒå¤§ã€‚Kuduã€SAP HANA ä¹‹ç±»çš„äº§å“ä¸ºæ›´æ–°æä¾›äº†æ–¹æ¡ˆã€‚</p><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œæ ¹æ®æˆ‘ä¸ªäººçš„çœ‹æ³•ï¼ŒACID/Indexes æ›´åƒä¸€ä¸ªä¸Šå±‚çš„éœ€æ±‚ã€‚ORC å¯¹è¿™äº›æœ‰åŸç”Ÿæ”¯æŒï¼Œä½†æ˜¯ä½ å¯ä»¥æ‰‹åŠ¨åœ¨ Parquet é‡Œé¢å¢åŠ æ”¯æŒï¼Œä¾‹å¦‚ <a href="https://github.com/datafuselabs/databend#design-overview">databend æ¶æ„</a> ç»´æŠ¤äº† sparse index å’Œ min max ä¿¡æ¯ã€‚è¿™äº›é€šç”¨çš„æ ¼å¼åœ¨è¿™äº›æ–¹é¢ä¹Ÿæœ‰ç€ä¸é”™çš„é€»è¾‘ã€‚</p><h2 id="DB-ç›´æ¥åœ¨å‹ç¼©çš„æ•°æ®ä¸Šè¿›è¡Œè®¡ç®—"><a href="#DB-ç›´æ¥åœ¨å‹ç¼©çš„æ•°æ®ä¸Šè¿›è¡Œè®¡ç®—" class="headerlink" title="DB: ç›´æ¥åœ¨å‹ç¼©çš„æ•°æ®ä¸Šè¿›è¡Œè®¡ç®—"></a>DB: ç›´æ¥åœ¨å‹ç¼©çš„æ•°æ®ä¸Šè¿›è¡Œè®¡ç®—</h2><p>SIGMOD 2006 çš„ <em>Integrating Compression and Execution in Column-Oriented Database Systems</em> è®ºæ–‡ï¼Œæè¿°äº†æ€ä¹ˆèƒ½å¤Ÿåœ¨å‹ç¼©çš„æ•°æ®ä¸Šè¿›è¡Œè®¡ç®—ã€‚å®ƒæè¿°çš„æ˜¯ä¸€ç§ç±»ä¼¼å»¶è¿Ÿç‰©åŒ–çš„æ€è·¯ï¼Œåœ¨å‹ç¼©çš„æ•°æ®ä¸Šè¿›è¡Œè®¡ç®—ï¼Œå®ƒå¯¹æ•°æ®è¿›è¡Œäº†ä¸‹åˆ—æŠ½è±¡ï¼š</p><p><img src="https://image.mwish.me/blog-image/59A466B0-BFA7-4FF6-8789-D999BE5502FD.png" alt="59A466B0-BFA7-4FF6-8789-D999BE5502FD"></p><p><code>Block</code> åœ¨ RLE ä¸­æŒ‡çš„æ˜¯å•ä¸ªæ¡ç›®å’Œå¯¹åº”å†…å®¹ï¼Œåœ¨ Bit-Vector/å­—å…¸ ä¸­æŒ‡çš„æ˜¯å•ä¸ªå€¼ã€éè¿ç»­çš„ä¸€ç»„ä¿¡æ¯ï¼ˆæ¯”å¦‚å…¨0 æˆ–è€…å…¨1ï¼‰ã€‚å®ƒæä¾›äº†ä¸€ä¸ª <code>DataSource</code> operatorï¼Œå…è®¸æŠŠå„ç§æ¡ä»¶ä¸‹æ¨ä¸‹å»ã€‚æ¯”æ–¹è¯´ï¼Œbit-vectorã€å­—å…¸éƒ½å¯ä»¥å¤„ç†ä¸€äº› Eq ä¹‹ç±»çš„ Exprã€‚</p><p>å¯¹äº JOIN æ¥è¯´ï¼Œå®ƒå¯ä»¥ç›´æ¥åœ¨ RLE ä¸Šè¿è¡Œã€‚å¯¹äº Bit-vectorï¼Œæ‰§è¡Œ Nested Loop Join ä¸”é‡Œä¾§ä¸º bit-vector çš„æ—¶å€™ï¼Œå¯ä»¥æ‰§è¡Œä¸€äº›ä¼˜åŒ–ï¼š</p><p><img src="https://image.mwish.me/blog-image/49439B4B-D687-4F2D-9357-4BDD83C7709C.png" alt="49439B4B-D687-4F2D-9357-4BDD83C7709C"></p><p>å®ƒè¿˜æŠ½äº†ä¸€ä¸‹ä¸‹é¢çš„ APIï¼š</p><blockquote><p><code>isOneValue()</code> returns whether or not the block contains just one value (and many positions for that value). <code>isValueSorted()</code> returns whether or not the blockâ€™s values are sorted (blocks with one value are trivially sorted). <code>isPosContig()</code> returns whether the block contains a consecutive subset of a column (i.e. for a given position range within a column, the block contains all values located in that range).</p></blockquote><p>ç„¶åæœ‰å¯¹åº”çš„ä¼˜åŒ–èŒƒå›´ï¼š</p><p><img src="https://image.mwish.me/blog-image/188A1F7D-D245-4EAD-9F37-CFF44FD341CA.png" alt="188A1F7D-D245-4EAD-9F37-CFF44FD341CA"></p><p>æ€»ä¹‹ï¼Œè¿™é‡Œæä¾›äº†ä¸€äº› domain-specific çš„ä¼˜åŒ–æ–¹å¼ã€‚</p><h2 id="Apache-Arrow"><a href="#Apache-Arrow" class="headerlink" title="Apache Arrow"></a>Apache Arrow</h2><p>ä¸åŒäºä¸Šè¿°çš„å­˜å‚¨æ ¼å¼ï¼ŒArrow æ›´å¤šçš„æ˜¯ä¸€ä¸ªäº¤æ¢æ ¼å¼å’Œè®¡ç®—æ ¼å¼ã€‚åˆ©ç”¨ SIMDã€Vectorize ç­‰æ–¹å¼ï¼Œå®Œæˆè·¨è¯­è¨€çš„ã€é«˜æ•ˆçš„å†…å­˜è®¡ç®—ï¼ŒåŒæ—¶ä¹Ÿæ”¯æŒå’Œ Parquet çš„è½¬åŒ–å’Œ nested structureã€‚</p><p>Apache Arrow ç›®å‰æ˜¯æ²¡æœ‰å»¶è¿Ÿç‰©åŒ–æ”¯æŒçš„ã€‚</p><h2 id="ç»“è¯­"><a href="#ç»“è¯­" class="headerlink" title="ç»“è¯­"></a>ç»“è¯­</h2><p>ä¸åŒçš„æ ¼å¼ã€ä¸åŒçš„æ•°æ®æœ‰ä¸åŒçš„ç‰¹å¾ã€‚è¿™é‡Œæ–‡ç« æ²¡æœ‰æ¶‰åŠä¸€äº›å¤æ‚ä¸œè¥¿ï¼Œæ¯”å¦‚ Streaming Parsing ç­‰éœ€æ±‚ã€‚ç¬”è€…æè¿°äº†åˆ—å­˜ã€è¡Œå­˜ã€RPC ç­‰ä¸åŒæ ¼å¼çš„éœ€æ±‚å’Œç‰¹å¾ï¼ŒåŠè‡ªå·±å¯¹ä¸€äº›ç‰¹æ€§çš„çœ‹æ³•ã€‚æ„Ÿæ€§çš„ä¹Ÿå¯ä»¥åœ¨ä¸‹æ–¹è¯„è®ºäº¤æµã€‚é‰´äºç¬”è€…æ°´å¹³ä¸è¡Œï¼Œè¡Œæ–‡å¯èƒ½å­˜åœ¨è¯¸å¤šçº°æ¼ã€‚æ•¬è¯·è°…è§£ã€‚</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>è°ˆè°ˆæ ¼å¼</title>
      <link href="/2022/01/14/format-thinking/"/>
      <url>/2022/01/14/format-thinking/</url>
      
        <content type="html"><![CDATA[<p>ä¸€ä¸ªç¨‹åºå‘˜çš„å·¥ä½œå¯èƒ½åŒ…æ‹¬ï¼šæœåŠ¡å™¨å®ç°äº† HTTP æˆ–è€… Rpc åè®®ï¼Œæ¥å—ç”¨æˆ·å‘é€æ¥çš„ JSON/æ–‡æœ¬/RPC Idlï¼Œç„¶åç”¨ JSON/æ–‡æœ¬/RPC idlï¼Œç»™ä¸€äº›å…¶ä»–æœåŠ¡å‘é€è¯·æ±‚ï¼Œæ‹¿åˆ°æƒ³è¦æ‹¿åˆ°çš„ä¸œè¥¿ã€‚ä¸Šè¿°å¤„ç†å®Œä¹‹åï¼Œå¯èƒ½å¯¹æ•°æ®åº“ CRUDï¼Œåœ¨ RDBMS ä¸­ï¼Œç¨‹åºå‘˜å¯èƒ½å®šä¹‰äº†è¡¨ï¼Œè¡¨ä¸­çš„ä¸€è¡Œæœ‰å¤šä¸ªåˆ—ã€‚ç”¨æˆ·å¯èƒ½ä¼šæ›´æ–°æŸå‡ è¡Œæ•°æ®çš„æŸå‡ åˆ—ï¼Œç„¶åæŠŠè¯·æ±‚è¿”å›ç»™ç”¨æˆ·ã€‚å†™å®Œæ•°æ®åº“åï¼Œå¯èƒ½ä¼šæœ‰ binlog æµ/CDC æµï¼Œå»å¼‚æ­¥çš„æŠŠä½ çš„å†™å…¥å¯¼å‡ºåˆ°æŸä¸ªæ•°æ®ä»“åº“é‡Œå¤´ï¼Œè¿™é‡Œå¯èƒ½ä¼šæŠŠè¡Œç»„ç»‡æˆç±»ä¼¼ Apache ORC æˆ–è€… Apache Parquet  çš„å½¢å¼ï¼Œä¾¿äºå¿«é€Ÿåšåˆ†æã€‚</p><p>åœ¨è¿™ä¸ªæµç¨‹ä¸­ï¼Œç”¨æˆ·å¯èƒ½å’Œ JSONã€Protobufã€æ•°æ®åº“çš„è¡Œç­‰ä¸œè¥¿æ‰“äº†äº¤é“ï¼Œè€Œè®¡ç®—æœºå¯èƒ½æœ€ç»ˆåªçŸ¥é“ 0å’Œ1ï¼Œbit å’Œ byteã€‚è¿™é‡Œé¢éšè—äº†æ— æ•°çš„ç¼–ç ï¼š</p><ol><li>æ¥å£è¯·æ±‚/è¿”å›å€¼çš„ç¼–ç ï¼šå¯èƒ½æ˜¯ JSONã€Protobufã€Thriftã€Avro ç­‰æ ¼å¼ã€‚åœ¨è¿™é‡Œï¼Œç”¨æˆ·é¢„æœŸ debug æ–¹ä¾¿ï¼Œèƒ½å¤Ÿå¯¹æ¥å£è¿›è¡Œä¸€å®šçš„ä¿®æ”¹ã€æ‰©å±•ã€‚</li><li>æ•°æ®åº“çš„è¡Œ Schemaï¼Œæœ¬èº«å¯èƒ½è¦æ±‚è¯»/å†™æ€§èƒ½å’Œå­˜å‚¨ç©ºé—´çš„é«˜æ•ˆã€èŠ‚çº¦ï¼Œä¾¿äºCPU é«˜æ•ˆåœ¨å†…å­˜è®¿é—®è¡Œä¸Šçš„æ•°æ®ï¼Œè¿™é‡Œè¿˜æœ‰ä¸€äº›å°å°çš„åŒºåˆ†ï¼š<ol><li>Schema-on-read/Schemaless: ä¸ä¸€å®šè¦æ±‚ç³»ç»Ÿå­˜å‚¨åŒä¸€ä¸ªæ¨¡å¼ï¼Œå¯èƒ½åŒæ—¶å­˜åœ¨å¤šä¸ªç‰ˆæœ¬çš„æ•°æ®</li><li>æŸä¸ªè¡Œé›†åˆçš„æ•°æ®ï¼Œæ‹¥æœ‰ç›¸åŒçš„ Schema</li></ol></li><li>ORC / Parquet çš„ Schemaï¼Œå’Œè¡Œçš„ Schema ç›¸æ¯”ï¼Œå¯èƒ½è¿˜ä¼šæŠŠåˆ—å­˜åœ¨ä¸€èµ·ã€‚</li></ol><p>ç¨‹åºå‘˜å¯èƒ½æ¯å¤©æˆ–å¤šæˆ–å°‘è¦å’Œå®ƒä»¬æ‰“äº¤é“ã€‚è¿™äº›æ•°æ®æ ¼å¼éœ€æ±‚æ˜¯ä¸ä¸€æ ·çš„ã€‚å°½ç®¡æœ‰ä¸€äº›å­¦æœ¯ä¸Šå¤šç»´çš„åŒºåˆ†ï¼Œæ¯”å¦‚è¯´ï¼š</p><ol><li>æ•°æ®æ˜¯å¦æœ‰ Schema</li><li>æ˜¯å¦æ”¯æŒ nested</li><li>å­˜å‚¨çš„è¡Œåˆ—</li><li>æ˜¯å¦æ”¯æŒ Streaming</li><li>æ˜¯å¦ human-readable</li><li>æ˜¯å¦æ˜¯å’ŒæŸä¸ªè¯­è¨€ç»‘å®šçš„ï¼ˆä¾‹å¦‚ Python pickle, Java Serialize ç­‰ï¼Œddia è®¤ä¸ºè¿™äº›ç¼–ç çš„å…¼å®¹æ€§ä¸æ˜¯å¾ˆå¥½ï¼ŒåŒæ—¶å¯èƒ½æœ‰äº›å®‰å…¨éšæ‚£ã€æ€§èƒ½ç¼ºé™·ï¼‰</li></ol><p>ä½†æˆ‘ä»¬è¿™è¾¹è¿˜æ˜¯æ¾æ•£çš„éšä¾¿æ‰¯æ‰¯ï¼Œè€Œä¸”å°½é‡ä¸è®¨è®ºè¯­è¨€ç»‘å®šçš„ä¸œè¥¿ã€‚ä¸‹é¢æœ‰ä¸€å¼ æ‰¯å›¾ï¼Œå›¾ä¸€ä¹ï¼Ÿæˆ‘ä»¬è¿™é‡Œä¹Ÿä¸ä¼šæ¶‰åŠæ¶ˆæ¯è¾¹ç•Œç­‰å†…å®¹ã€‚</p><p><img src="https://image.mwish.me/blog-image/2B9240B1-E512-4373-8666-775B6051EB91.png" alt="2B9240B1-E512-4373-8666-775B6051EB91"></p><p>å¦å¤–ï¼Œæœ¬æ–‡åªä»£è¡¨æœ¬äººä¸ªäººç†è§£å’Œä¸€äº›è®°å½•ã€‚å¦‚æœ‰é”™è¯¯è¿˜çƒ¦è¯·å„ä½è¯»è€…çŸ«æ­£ã€‚</p><h2 id="æ¥å£çš„ç¼–ç æ•°æ®"><a href="#æ¥å£çš„ç¼–ç æ•°æ®" class="headerlink" title="æ¥å£çš„ç¼–ç æ•°æ®"></a>æ¥å£çš„ç¼–ç æ•°æ®</h2><h3 id="JSON"><a href="#JSON" class="headerlink" title="JSON"></a>JSON</h3><p>ä¸€ä¸ªå¸¸ç”¨çš„é€‰é¡¹æ˜¯ HTTP + REST + JSON.  æŒ‰ç…§åˆ†ç±»ï¼ŒJSON å¯ä»¥è§†ä½œ å¼±schema + human-readable çš„æ•°æ®ã€‚è¿™æ ·çš„æ•°æ®ä¹ŸåŒ…æ‹¬ XMLã€‚JSON è¢«è¯Ÿç—…çš„åœ°æ–¹å¦‚ä¸‹ï¼š</p><ol><li>æ ¼å¼ä¸Šæ€§èƒ½ä¸ä¸€å®šå¾ˆå¥½ï¼ŒåŒ…æ‹¬æœ¬èº«ç©ºé—´å¤§å°è¾ƒå¤§</li><li>å¯¹äºŒè¿›åˆ¶æ•°æ®ä¸ä¸€å®šæœ‰å¾ˆå¥½çš„æ”¯æŒ</li><li>â€¦</li></ol><p>ä¸Šé¢è¿™äº›å†…å®¹è®©å®ƒå¯èƒ½ä¼šå—åˆ°ä¸€å®šçš„è¯Ÿç—…ï¼Œä½†æ˜¯å¯¹äºæ¥å£è€Œè¨€ï¼Œå®ƒæœ‰ç€å¼€å‘æ–¹ä¾¿ã€ç¨‹åºå‘˜å¯è¯»ã€è·¨è¯­è¨€ç­‰è¯¸å¤šä¼˜ç‚¹ï¼Œæ­¤å¤–ï¼Œå®ƒçš„å·¥å…·é“¾ç›¸å½“é½å…¨ï¼ˆå½“ç„¶ï¼Œè¿™ä¹Ÿæœ‰ fast-JSON ç­‰é—®é¢˜ï¼Ÿï¼‰ã€‚JSON å·²ç»æ”¯æŒäº†å¤§è§„æ¨¡çš„ web ç³»ç»Ÿï¼Œç›¸ä¿¡å®ƒè¿˜ä¼šèµ·åˆ°å¾ˆå¤šçš„ä½œç”¨ã€‚</p><p>å…³äºç©ºé—´æ”¾å¤§å°±ä¸è°ˆäº†ï¼Œéƒ½ JSON äº†ï¼Œä¹Ÿåˆ«è€ƒè™‘è¿™ä¸ªäº†ã€‚</p><h3 id="Thrift-amp-amp-Protocol-Buffer-å¸¸è§çš„-rpc-æ¶ˆæ¯æ ¼å¼"><a href="#Thrift-amp-amp-Protocol-Buffer-å¸¸è§çš„-rpc-æ¶ˆæ¯æ ¼å¼" class="headerlink" title="Thrift &amp;&amp; Protocol Buffer: å¸¸è§çš„ rpc æ¶ˆæ¯æ ¼å¼"></a>Thrift &amp;&amp; Protocol Buffer: å¸¸è§çš„ rpc æ¶ˆæ¯æ ¼å¼</h3><p>å°½ç®¡ pb æœ‰ä¸åŒç‰ˆæœ¬ï¼Œthrift ä¹Ÿæ˜¯ä¸åŒæ ¼å¼ï¼Œä½†æ˜¯å®ƒä»¬åŸç†æ˜¯ç±»ä¼¼çš„ã€‚å¯ä»¥çœ‹ï¼š<a href="https://thrift.apache.org/static/files/thrift-20070401.pdf">https://thrift.apache.org/static/files/thrift-20070401.pdf</a></p><p>åè®®ä¸Šï¼Œthrift æœ¬èº«æ˜¯äºŒè¿›åˆ¶çš„åè®®ï¼Œå¯¹äºç»™å®šçš„æ ¼å¼æè¿°æ–‡ä»¶ï¼Œå®ƒèƒ½å¤Ÿç”Ÿæˆå‡ºå¯¹åº”è¯­è¨€çš„ åºåˆ—åŒ–/ååºåˆ—åŒ– ä»£ç ã€‚ç”¨äºå¤„ç†è¿™æ ·çš„æ ¼å¼ã€‚ï¼ˆå½“ç„¶ï¼Œä¸åŒè¯­è¨€å¤„ç†å¯èƒ½æœ‰ä¸€å®šçš„é—®é¢˜ï¼Œæ¯”å¦‚ thrift-0.9.2 ç”Ÿæˆçš„ C++ ä»£ç ä¸­ï¼Œç”Ÿæˆäº† <code>virtual dtor</code> å’Œ copy ctorï¼Œä½†æ˜¯æ²¡æœ‰ç”Ÿæˆ <code>move ctor</code> ï¼‰ã€‚</p><ul><li><a href="https://github.com/apache/thrift/blob/master/doc/specs/thrift-binary-protocol.md">https://github.com/apache/thrift/blob/master/doc/specs/thrift-binary-protocol.md</a></li><li><a href="https://github.com/apache/thrift/blob/master/doc/specs/thrift-compact-protocol.md">https://github.com/apache/thrift/blob/master/doc/specs/thrift-compact-protocol.md</a></li></ul><p>Thrift æœ¬èº«å¯¹äºæ¯ä¸ªå­—æ®µéœ€è¦åšä¸€äº›å®šä¹‰ï¼Œæ¯”å¦‚ï¼š</p><figure class="highlight thrift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">TweetType</span> </span>&#123;</span><br><span class="line">    TWEET,       <span class="comment">// 1</span></span><br><span class="line">    RETWEET = <span class="number">2</span>, <span class="comment">// 2</span></span><br><span class="line">    DM = <span class="number">0</span>xa,    <span class="comment">// 3</span></span><br><span class="line">    REPLY</span><br><span class="line">&#125;                <span class="comment">// 4</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Tweet</span> </span>&#123;</span><br><span class="line">    <span class="number">1</span>: <span class="keyword">required</span> <span class="type">i32</span> userId;</span><br><span class="line">    <span class="number">2</span>: <span class="keyword">required</span> <span class="type">string</span> userName;</span><br><span class="line">    <span class="number">3</span>: <span class="keyword">required</span> <span class="type">string</span> text;</span><br><span class="line">    <span class="number">4</span>: <span class="keyword">optional</span> Location loc;</span><br><span class="line">    <span class="number">5</span>: <span class="keyword">optional</span> TweetType tweetType = TweetType.TWEET <span class="comment">// 5</span></span><br><span class="line">    <span class="number">16</span>: <span class="keyword">optional</span> <span class="type">string</span> language = <span class="string">&quot;english&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬ä¸è®¨è®ºç¼–ç ç»†èŠ‚ï¼Œå®ƒå¤§è‡´ä¼šå°†æ¯ä¸ªå­—æ®µåšç¼–ç ï¼Œè¡¨ç¤ºæˆï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Binary protocol field header and field value:</span><br><span class="line">+--------+--------+--------+--------+...+--------+</span><br><span class="line">|tttttttt| field id        | field value         |</span><br><span class="line">+--------+--------+--------+--------+...+--------+</span><br><span class="line"></span><br><span class="line">Binary protocol stop field:</span><br><span class="line">+--------+</span><br><span class="line">|00000000|</span><br><span class="line">+--------+</span><br></pre></td></tr></table></figure><ol><li>å­—æ®µç±»å‹</li><li><strong>å­—æ®µ id</strong></li><li>å­—æ®µå€¼</li><li>Stop field</li></ol><p>Compact æ ¼å¼ä¸ä¸Šè¿°ç±»ä¼¼ï¼Œä¸è¿‡é‡‡å–äº†æ›´ç´§å‡‘çš„æ ¼å¼ï¼Œä¸å½±å“æˆ‘ä»¬å‰é¢ä»‹ç»çš„é€»è¾‘ï¼š<a href="https://github.com/apache/thrift/blob/master/doc/specs/thrift-compact-protocol.md#struct-encoding">https://github.com/apache/thrift/blob/master/doc/specs/thrift-compact-protocol.md#struct-encoding</a></p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™æ ·çš„æ ¼å¼èŠ±äº†ä¸å°‘éƒ¨åˆ†åœ¨å¤„ç†å…¼å®¹æ€§ä¸Šã€‚å¯ä»¥å½“ä½œè¿™æ˜¯å­—æ®µ id å‚ä¸å®ç°çš„ã€‚å‡è®¾ä¼ æ¥çš„å­—æ®µæ²¡æœ‰æŸä¸ªå­—æ®µ idï¼Œè¿™é‡Œä¼šåœ¨è§£æåçš„ç»“æœåšå¯¹åº”çš„æ ‡è®°ï¼›å¦‚æœä¼ æ¥çš„åŒ…å«è‡ªå·±çš„ idl æ²¡æœ‰å®šä¹‰çš„ field idï¼Œè¿™é‡Œä¹Ÿä¼šè·³è¿‡å»ã€‚é€šè¿‡è¿™ç§æ–¹å¼ï¼Œthrift å®Œæˆäº†ä¸€äº›æ‰©å±•æ€§çš„æ”¯æŒã€‚</p><p>å½“ç„¶ï¼Œè¿™ä¹Ÿè¡ç”Ÿäº†ä¸€äº›éªšæ“ä½œã€‚å¦‚æœä½ çš„ thrift ç»“æ„æœ‰ 10ä¸ªå­—æ®µï¼Œä½†ä½ åˆçš„åœ°æ–¹åªå…³å¿ƒä¸¤ä¸ªå­—æ®µï¼Œä½ å¯ä»¥å†™ä¸ªåªæœ‰å¯¹åº”ä¸¤ä¸ªå­—æ®µçš„ idlï¼Œè®©å®ƒç”Ÿæˆç»“æ„æ¥è§£æã€‚é‚£é—®é¢˜æ¥äº†ï¼Œè¿™ä¸ªåœæ­¢æ˜¯ä»€ä¹ˆæƒ…å†µå‘¢ï¼Ÿå‡è®¾åŸæœ¬æœ‰ 0-10 ä¸ªå­—æ®µï¼Œç„¶åè¿™ä¸ªè§£ææ£€æµ‹åˆ° stop field å°±ä¼šåœæ­¢ï¼Œæ‰€ä»¥ä¸ä¼šæœ‰é—®é¢˜</p><p>é‚£ä¹ˆï¼Œè¿™ä¸ªç»“æ„ä¸€äº›æ”¾å¤§åœ¨ä»€ä¹ˆåœ°æ–¹å‘¢ï¼Ÿæœ¬èº« å­—æ®µç±»å‹ã€å­—æ®µ id ä¼šæœ‰ä¸€éƒ¨åˆ†ç©ºé—´æ”¾å¤§ï¼Œç„¶åå˜é•¿å­—æ®µå­˜å‚¨ä¹Ÿæœ‰éƒ¨åˆ†æ”¾å¤§ã€‚</p><p>thrift å’Œ pb ç»å¸¸ç”¨äºä½œä¸ºä¸€äº› Rpc å¯¹åº”çš„æ ¼å¼ï¼Œå› ä¸ºä¾¿äºå¢å’Œæ”¹ï¼Œè¿™ä½¿å¾—å®ƒä»¬åœ¨å¼€å‘ä¸Šæœ‰ç€ä¸€å®šçš„ä¼˜åŠ¿ã€‚åŒæ—¶ï¼Œè™½ç„¶å®ƒä»¬æœ¬èº«ä¸æ˜¯ human-readable çš„ï¼Œä½†æ˜¯ thrift ä¼šç”Ÿæˆä¸€äº›è½¬åŒ–æˆ <code>DebugString</code> æˆ–è€… JSON çš„æ–¹å¼ã€‚</p><h4 id="ä»£ç ç”Ÿæˆå’Œæ•ˆç‡"><a href="#ä»£ç ç”Ÿæˆå’Œæ•ˆç‡" class="headerlink" title="ä»£ç ç”Ÿæˆå’Œæ•ˆç‡"></a>ä»£ç ç”Ÿæˆå’Œæ•ˆç‡</h4><p>é»˜è®¤ç”Ÿæˆçš„ cpp ä»£ç å…¶å®æ¯”è¾ƒè‰å°ï¼Œå¯¹äº cpp ä»£ç è€Œè¨€ï¼Œå¯ä»¥æŒ‡å®šç”Ÿæˆæ¨¡ç‰ˆä»£ç ã€ç”Ÿæˆå¸¦ move çš„ä»£ç ã€å¼€å¯ä¸€äº›ç¼–è¯‘ç›¸å…³çš„ä¼˜åŒ–æ¥æå‡æ€§èƒ½ã€‚</p><h3 id="Avro"><a href="#Avro" class="headerlink" title="Avro"></a>Avro</h3><p>Avro çš„ç¼–ç æ¨¡å¼å¯ä»¥è§ï¼š <a href="https://avro.apache.org/docs/current/spec.html">https://avro.apache.org/docs/current/spec.html</a> ã€‚è¿™é‡Œä¸è®¨è®º Avro çš„ JSON æ¨¡å¼ã€‚ç›¸å¯¹äº Pb/Thriftï¼ŒAvro çš„äºŒè¿›åˆ¶æ ¼å¼ä¸ä¼šæºå¸¦ <code>type</code> å’Œ <code>field id</code>. ç›¸å¯¹çš„ï¼Œå®ƒåº”è¯¥æ ‡ç¤ºå‡ºå†™å…¥è‡ªå·±çš„åº”è¯¥æ˜¯ä»€ä¹ˆ Schemaã€‚</p><p>è¿™é‡Œ Avro çš„äº¤äº’å¯èƒ½åŒ…å«åŒæ–¹çš„ Schema äº¤æ¢ï¼Œå› ä¸ºè¯»è€…éœ€è¦çŸ¥é“å†™è€…çš„ç¼–ç ï¼Œä¾‹å¦‚ï¼š<a href="https://avro.apache.org/docs/current/spec.html#Handshake">https://avro.apache.org/docs/current/spec.html#Handshake</a></p><p>å¦‚ä¸Šæ‰€è¿°ï¼ŒAvro çš„ç©ºé—´å°‘å»äº† å­—æ®µç±»å‹ã€å­—æ®µ id çš„ç©ºé—´æ”¾å¤§ï¼Œ<strong>æ˜¯ä¸€ä¸ªè¿˜ç®—ç´§å‡‘çš„æ ¼å¼</strong>ï¼Œä½†æœ¬èº«å®ƒéœ€è¦çŸ¥é“æ•°æ®æ˜¯ä»€ä¹ˆç‰ˆæœ¬çš„ã€‚å½“ç„¶ï¼Œæˆ‘ä»¬æœ€å¥½ä¸éœ€è¦æ¯æ¡ Avro æ•°æ®éƒ½å¸¦ä¸€ä¸ª JSON çš„æ ¼å¼æè¿°æ–‡ä»¶ï¼Œè¿™é‡Œå¯èƒ½æœ‰ä¸åŒçš„æ–¹å¼ï¼Œæ¥ä½¿è¿™ä¸ªå¼€é”€å˜å¾—æ›´å°ï¼š</p><ol><li>é€šè¿‡ Handshake äº¤æ¢ç‰ˆæœ¬</li><li>æœ‰ä¸€ä¸ªç‰ˆæœ¬å· <code>[0, 1, 2, 3]</code>. ç„¶åè‡ªå·±äºŒè¿›åˆ¶æ•°æ®å¸¦ä¸Šè¿™ä¸ªç‰ˆæœ¬å·ï¼Œè®©è¯»è€…èƒ½å¤ŸæˆåŠŸè§£æ</li><li>å¯¹äºä¸€äº›å¤§æ–‡ä»¶ï¼Œå¯èƒ½å¯ä»¥åœ¨æ–‡ä»¶å¤´å¸¦ä¸Š Avro æ ¼å¼æè¿°ï¼Œç„¶ååé¢å­˜æ”¾åŒä¸€ä¸ªç‰ˆæœ¬çš„å†™å…¥å†…å®¹ã€‚</li></ol><p>Avro å¯ä»¥ç”¨äº RPCï¼Œä½†ç¬”è€…åœ¨ç”Ÿäº§ä¸­å°‘æœ‰è§åˆ°ç”¨ Avro åšäº¤æ¢æ ¼å¼çš„åœ°æ–¹ã€‚ä¼¼ä¹å®ƒçš„ä½¿ç”¨åœºæ™¯æ›´å¤šè¿˜æ˜¯åœ¨å­˜å‚¨æ•°æ®çš„æ—¶å€™ä½¿ç”¨ã€‚å¦‚æœæœ‰è¯»è€…çŸ¥é“å¯¹åº”çš„åœºæ™¯ä¸å¦¨è”ç³»ç¬”è€…ã€‚</p><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>å¤§éƒ¨åˆ† RPC æ ¼å¼ä¸­ï¼Œç”¨æˆ·å¸Œæœ›æœ‰ä¸€å®šçš„ Schemaï¼ŒåŒæ—¶ä¹Ÿæ”¯æŒå¯¹ç»“æ„è¿›è¡Œä¸€äº›å˜æ›´ã€‚ç”¨æˆ·é€šè¿‡ Rpc å‘é€çš„ä¿¡æ¯é€šå¸¸ä¸ä¼šå¾ˆå¤§ï¼Œè€Œä¸”å¤§éƒ¨åˆ†æ—¶å€™ä¹Ÿå¹¶ä¸åº”è¯¥å¾ˆå¤§ï¼Œä¾‹å¦‚ pb åœ¨å®˜æ–¹æ–‡æ¡£ä¸­<a href="https://developers.google.com/protocol-buffers/docs/techniques">è¡¨ç¤º</a>ï¼Œå®ƒä¸åº”è¯¥å¤„ç† Large Data Setsã€‚å¦‚æœä½ æœ‰æ•° kB ç”šè‡³æ•° MB çš„æ•°æ®ï¼Œé‚£ä¹ˆä½ å¯èƒ½è¦è€ƒè™‘ä¸€ä¸‹ä¸€äº›å…¶ä»–çš„æ–¹å¼ã€‚æ¯•ç«Ÿï¼Œå¯¹è¿™äº› RPC æ¶ˆæ¯çš„è§£æä¸€èˆ¬åŒ…å«è¿ç»­æˆ–è€…ä¸è¿ç»­å†…å­˜çš„ memcpyã€‚</p><h2 id="è¡Œæ ¼å¼"><a href="#è¡Œæ ¼å¼" class="headerlink" title="è¡Œæ ¼å¼"></a>è¡Œæ ¼å¼</h2><h3 id="éœ€æ±‚å’Œå¤§æ¦‚çš„è®¾è®¡"><a href="#éœ€æ±‚å’Œå¤§æ¦‚çš„è®¾è®¡" class="headerlink" title="éœ€æ±‚å’Œå¤§æ¦‚çš„è®¾è®¡"></a>éœ€æ±‚å’Œå¤§æ¦‚çš„è®¾è®¡</h3><p>åœ¨å…³ç³»å‹æ•°æ®åº“ä¸­ï¼Œæˆ‘ä»¬æœ‰è¡Œ (Row/Tuple) å’Œ åˆ— (Column/Attribute) ï¼Œç›´è§‚çš„æè¿°å¦‚ä¸‹æ‰€è¿°ï¼š</p><p><img src="https://image.mwish.me/blog-image/700px-Relational_database_terms.svg.png" alt="700px-Relational_database_terms.svg"></p><p>è¿™æ ·çš„æ ¼å¼æœ¬èº«æ˜¯ç”¨æˆ·å®šä¹‰çš„ï¼Œåˆ—å¯ä»¥æ˜¯å˜é•¿/å®šé•¿çš„ï¼ˆè¡Œä¹Ÿæ˜¾ç„¶å¯ä»¥ï¼‰ã€‚æˆ‘ä»¬å¿½ç•¥ BLOB ç­‰å¯¹è±¡ã€‚ç”¨æˆ·é€šå¸¸ä¼šæœ‰ä¸‹åˆ—çš„è¯·æ±‚ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> table.col1, table.col5 <span class="keyword">FROM</span> <span class="keyword">table</span> <span class="keyword">WHERE</span> table.col3 <span class="operator">&lt;</span> <span class="number">100</span>;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬ä¸è€ƒè™‘ç´¢å¼•ç­‰ä¼˜åŒ–ï¼Œä¹Ÿä¸è€ƒè™‘ Row æ˜¯ä»¥ k-v è¿˜æ˜¯ Page çš„å½¢å¼ç»„ç»‡ï¼Œä»…ä»è¡Œçš„æ–¹é¢è€ƒè™‘ï¼Œè¿™é‡Œéœ€è¦è¯»åˆ°å¯¹åº”æ¯ä¸ªè¡Œçš„ <code>col1</code> <code>col5</code> å’Œ <code>col3</code> å­—æ®µã€‚</p><p>é€šå¸¸ï¼ŒRPC åè®®è¦æ±‚çš„æ˜¯å¯¹å˜æ›´æ•æ„Ÿï¼Œä¸”èƒ½å¤Ÿå®Œæ•´è§£æã€‚è€Œè¡Œæ ¼å¼æ›´å¤šä¸ä¼šå®Œå…¨è§£æï¼Œè€Œæ˜¯è¦æ±‚èƒ½åœ¨å†…å­˜ä¸­å¿«é€Ÿå¯»æ‰¾åˆ°æ¯è¡Œä¸­ç”¨æˆ·æŒ‡å®šçš„åˆ—ã€‚åŒæ—¶ï¼Œè¡Œçš„å¤§å°ä¼šå ç”¨ç›˜/å†…å­˜çš„ç©ºé—´ï¼Œæ•…å…¶å¤§å°ä¹Ÿåº”å—é™åˆ¶ã€‚</p><p>ä¸€èˆ¬çš„æ•°æ®åº“å½“ä¸­ï¼Œä¼šæœ‰ <code>Catalog System</code>ã€‚å¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼Œå¯ä»¥è®¤ä¸ºï¼Œåœ¨æŸå¼ è¡¨ä¸­ï¼Œæ¯è¡Œçš„ Schema éƒ½æ˜¯ç›¸åŒçš„ã€‚è¿™ç»™æˆ‘ä»¬æä¾›äº†å¾ˆå¤§çš„ä¾¿åˆ©ã€‚å½“ç„¶ï¼Œè¿™é‡Œå¯èƒ½åŠ ä¸€åˆ—ä¹‹ç±»çš„ DDL æ‰§è¡Œçš„æ—¶å€™ï¼Œç³»ç»Ÿéœ€è¦åšæ¯”è¾ƒå¤šçš„äº‹æƒ…ï¼Œæ¥ç»™åŸæ¥çš„æ¯è¡Œæ·»åŠ ä¸€åˆ—ã€‚ä¹‹å‰ä¹Ÿçœ‹åˆ°é˜¿é‡Œçš„æ•°æ®åº“å›¢é˜Ÿå¯¹è¿™ç‚¹è¿›è¡Œçš„ä¼˜åŒ–: <a href="http://mysql.taobao.org/monthly/2020/03/01/">http://mysql.taobao.org/monthly/2020/03/01/</a></p><p>æ­¤å¤–ï¼Œè¿™é‡Œè¿˜è¦å…³æ³¨æŸåˆ—æ•°æ®ä¸º <code>null</code> çš„æƒ…å†µã€‚è¿™ä¸€ç‚¹ä¹Ÿä¼šå½±å“æ ¼å¼çš„å®ç°ã€‚å¦å¤–ä¸€ä¸ªå½±å“å®ç°çš„å†…å®¹æ˜¯å˜é•¿å­—æ®µï¼ˆç”šè‡³ nested å­—æ®µï¼‰çš„å­˜å‚¨ã€‚</p><p>æœ€åä¸€ç‚¹éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæˆ‘ä»¬åˆšæ‰è°ˆåŠ RPC åè®®ç­‰ï¼Œå®ƒä»¬å¤§éƒ¨åˆ†éƒ½æ˜¯éå¸¸é€šç”¨çš„åè®®ã€‚ä½†æ˜¯å¯¹äºè¡Œæ•°æ®æ¥è¯´ï¼Œå®ƒä»¬é€šå¸¸å’Œæ•°æ®åº“ç³»ç»Ÿåˆ«çš„åœ°æ–¹å®ç°æœ‰å¾ˆå¼ºçš„ç›¸å…³åº¦ï¼š</p><ol><li>æ˜¯å¦ä½¿ç”¨è¯»æ—¶æ¨¡å¼ï¼Ÿ</li><li>è¡Œæ˜¯æ€ä¹ˆè¢«ç»„ç»‡çš„ï¼Ÿæ˜¯è¢«å­˜å‚¨åˆ° kv ä¸­ï¼Œè¿˜æ˜¯è¢«å­˜å‚¨åˆ° Page ä¸­ï¼Ÿ</li><li>æœ‰æ²¡æœ‰ä»€ä¹ˆç‰¹æ®Šçš„è®°å½•å’Œæ ‡è®°ï¼Œä¾‹å¦‚è¡Œåˆ é™¤ã€äº‹åŠ¡æ ‡è®°ç­‰ï¼Ÿ</li><li>æœ‰æ²¡æœ‰ä»€ä¹ˆ hidden columnã€‚</li></ol><p>ä¸ºäº†ç®€åŒ–æè¿°ï¼Œæˆ‘ä»¬å°†é›†ä¸­äº <code>Tuple</code> å’Œ <code>Attribute</code> ç›¸å…³çš„å†…å®¹ï¼Œå¹¶å¿½ç•¥é‚£äº›ä¸Šå±‚çš„éƒ¨åˆ†ï¼ˆå°½ç®¡å®ƒä»¬å¯¹å®ç°è€…æˆ–è€…æŸäº›ç”¨æˆ·æ¥è¯´å¯èƒ½æ›´åŠ é‡è¦ï¼‰</p><h3 id="PostgreSQL"><a href="#PostgreSQL" class="headerlink" title="PostgreSQL"></a>PostgreSQL</h3><p><img src="https://image.mwish.me/blog-image/0A3074B3-A1EA-4CAE-80DC-BA37D2C40CC0.png" alt="0A3074B3-A1EA-4CAE-80DC-BA37D2C40CC0"></p><p>PG çš„ Page æ ¼å¼å¦‚ä¸Šæ‰€è¿°ã€‚æˆ‘ä»¬å…³æ³¨ï¼š</p><ol><li>Tuple Header é‡Œé¢åŒ…å«äº†ä¸‹é¢çš„ä¿¡æ¯ï¼š<ol><li>Tuple ä¸­æ˜¯å¦æœ‰å€¼ä¸º Null çš„ Attribute</li><li>å¦‚æœæœ‰å€¼ä¸º Null çš„ Attributeï¼Œé‚£ä¹ˆåé¢ä¼šå­˜æ”¾ä¸€ä¸ª BitSetï¼Œæ¥è¡¨ç¤ºç¬¬ <code>i</code> ä¸ªå­—æ®µçš„æ•°æ®æ˜¯å¦æ˜¯ Null</li></ol></li><li>Tuple é‡Œé¢ä¼šå­˜å‚¨æ‰€æœ‰çš„æ•°æ®<ol><li>å¯¹äº Null çš„ Attributeï¼Œä¸ä¼šå­˜å‚¨å¯¹åº”çš„å€¼</li><li>å¯¹äºé Null çš„æ•°æ®<ol><li>å¦‚æœæ˜¯å®šé•¿çš„æ•°æ®ï¼Œé‚£ä¹ˆï¼Œè¿™é‡Œç›´æ¥ä¼šå­˜å‚¨å¯¹åº”çš„å†…å®¹ï¼Œæ¯”å¦‚å¦‚æœæ˜¯ i32ï¼Œé‚£å°±å­˜å‚¨ 4bytesã€‚</li><li>å¦‚æœæ˜¯å˜é•¿çš„æ•°æ®ï¼Œé‚£ä¹ˆï¼Œè¿™é‡Œä¼šå­˜å‚¨ 1b æˆ–è€… 4b çš„é•¿åº¦ï¼Œå†å­˜å‚¨å¯¹åº”çš„å†…å®¹ã€‚</li></ol></li></ol></li></ol><p>æˆ‘ä»¬å‡è®¾æŸä¸ªè¡¨æ ¼å¼æ˜¯ <code>(i32, i64, bytes, i32)</code>ï¼Œé‚£ä¹ˆï¼Œå¯èƒ½å­˜å‚¨çš„æ ¼å¼å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">-- å¯¹äºæ•°æ® (1, 2, &quot;abc&quot;, 4), å¯èƒ½æ˜¯:</span><br><span class="line">[Header: æ²¡æœ‰æœ‰ Null çš„å­—æ®µ] [1(4bytes), 2(8bytes), [3(1bytes), &quot;abc&quot;(3bytes)], 4(4bytes)]</span><br><span class="line"></span><br><span class="line">-- å¯¹äºæ•°æ® (1, 2, ä¸€ä¸ªå¾ˆé•¿çš„å­—ç¬¦ä¸², 4), å¯èƒ½æ˜¯:</span><br><span class="line">[Header: æ²¡æœ‰æœ‰ Null çš„å­—æ®µ] [1(4bytes), 2(8bytes), [é•¿åº¦(4bytes), å¾ˆé•¿çš„å­—ç¬¦ä¸²], 4(4bytes)]</span><br><span class="line"></span><br><span class="line">-- å¯¹äºæ•°æ® (1, 2, Null, 4), å¯èƒ½æ˜¯:</span><br><span class="line">[Header: æœ‰ Null çš„å­—æ®µ] [1byte, è¡¨ç¤ºç¬¬ä¸‰ä¸ªå­—æ®µæ˜¯ Null] [1(4bytes), 2(8bytes), 4(4bytes)]</span><br></pre></td></tr></table></figure><p>å½“ç„¶ï¼Œå¯¹äºè®¡ç®—æœºæ¥è¯´ï¼Œè®¿é—®æœªå¯¹é½çš„æ•°æ®å¯èƒ½æ˜¯æœ‰é¢å¤–å¼€é”€çš„ã€‚PostgreSQL è¿˜æŒ‡å®šäº†è®©æ•°æ®å¯¹é½çš„é€‰é¡¹ã€‚</p><p>æ¯”å¦‚å¯¹ <code>(i32, i64, i32)</code>ï¼Œå¦‚æœéƒ½ä¸ä¸º Nullï¼Œ<em>å¯èƒ½</em>æœ‰ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">i32 å­˜æ”¾çš„: 4bytes</span><br><span class="line">padding: 4bytes &lt;-- æ³¨æ„è¿™ä¸ª</span><br><span class="line">i64: 8bytes</span><br><span class="line">i32: 4bytes</span><br></pre></td></tr></table></figure><p>ï¼ˆæ³¨ï¼šä»¥ä¸Šä¾‹å­åªä½œä¸º padding çš„æ¼”ç¤ºï¼Œå®é™…ä¸Šæ•°æ®å¯èƒ½è¢«ç¼–æ’ä¸º <code>(i32, i32, i64)</code> ï¼‰</p><p>ä¸‹é¢æˆ‘ä»¬æ¥çœ‹çœ‹</p><p>å¦‚æœæœ‰å˜é•¿å­—æ®µã€Null å­—æ®µçš„è¯ï¼Œéœ€è¦è¯»å–ç¬¬ <code>k</code> åˆ—ï¼Œå¯èƒ½è¦æ¯åˆ—è¯»è¿‡æ¥ï¼Œæ‰¾åˆ°ç¬¬ä¸€åˆ—ï¼š</p><ol><li>åˆ¤æ–­å®ƒæ˜¯å¦æ˜¯ Nullï¼Œå¦‚æœæ˜¯ï¼Œé‚£ä¹ˆåç§»é‡ä¸å˜</li><li>å¦‚æœä¸æ˜¯ Nullï¼š<ol><li>æ˜¯å®šé•¿çš„è¯ï¼Œè·³è¿‡å¯¹åº”é•¿åº¦å³å¯</li><li>æ˜¯å˜é•¿æ•°æ®çš„è¯ï¼Œå¯èƒ½è¦è¯»å–å®ƒçš„é•¿åº¦ï¼Œå†è·³è¿‡å¯¹åº”çš„é•¿åº¦</li></ol></li></ol><p>æ¯”æ–¹è¯´ï¼Œå‡è®¾åƒ <code>(i32, i64, i32)</code> çš„ Tuple ä¸­ï¼Œ<strong>ä¿è¯æ²¡æœ‰æ•°æ®æ˜¯ Null</strong>ã€‚é‚£æˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼ˆè€ƒè™‘ paddingï¼Œå‡è®¾å’Œä¹‹å‰æè¿°çš„æ ¼å¼ä¸€æ ·ï¼‰ï¼š</p><ol><li>ç¬¬ä¸€åˆ—åç§»é‡è‚¯å®šæ˜¯ <code>0</code></li><li>ç¬¬äºŒåˆ—åç§»é‡è‚¯å®šæ˜¯ <code>8</code></li><li>ç¬¬ä¸‰åˆ—åç§»é‡è‚¯å®šæ˜¯ <code>16</code></li></ol><p>å…·ä½“ä¸€äº›ç»†èŠ‚ä¼˜åŒ–å†…å®¹å¯ä»¥åœ¨ PostgreSQL çš„ <code>src/include/access/htup_details.h</code> ç­‰æ–‡ä»¶é‡Œæ‰¾åˆ°ã€‚PG ä¹Ÿå¯ä»¥ç”¨ schema cache åŠ é€Ÿå­—æ®µå¯»å€ã€‚</p><h4 id="è®¨è®º"><a href="#è®¨è®º" class="headerlink" title="è®¨è®º"></a>è®¨è®º</h4><p>PG çš„æ ¼å¼æœ¬èº«åº”è¯¥æ˜¯æ¯”è¾ƒçœç©ºé—´çš„ã€‚ç©ºé—´æ”¾å¤§æ¥è‡ªäºï¼š</p><ol><li>Null BitSet</li><li>å­˜æ”¾å­—ç¬¦ä¸²é•¿åº¦çš„åŒºåŸŸ</li></ol><p>åŒæ—¶ï¼Œè¯»å– PG ååçš„å­—æ®µï¼Œå¯èƒ½ä¼šå¯¼è‡´è¾ƒä½çš„æ€§èƒ½ï¼Œæ‰€ä»¥ PG å¯èƒ½ä¼šè¿™æ ·å¤„ç†æ ¼å¼ï¼š</p><ol><li>å…ˆå­˜æ”¾ <strong>é Null</strong> ä¸”<strong>å®šé•¿</strong>çš„åˆ—</li><li>åœ¨å­˜æ”¾ <strong>å®šé•¿</strong> ä¸” <strong>å¯èƒ½ä¸º Null</strong> çš„åˆ—</li><li>å­˜æ”¾å˜é•¿çš„åˆ—</li></ol><p>æ­¤å¤–ï¼Œæœ‰ä¸€äº›åˆ«çš„æ ¼å¼ï¼ˆé PGï¼‰å¯èƒ½ä¼šè€ƒè™‘ä¸‹é¢å‡ ç§å˜ä½“ï¼š</p><ol><li>æ¯éš”å‡ åˆ—æ·»åŠ ä¸€ä¸ªç´¢å¼•ï¼Œæ¯”æ–¹è¯´ï¼Œæ¯éš”8åˆ—æ’å…¥ä¸€ä¸ªåç§»é‡ï¼Œå¯»æ‰¾ç¬¬ <code>(8n + k)</code> åˆ—çš„æ—¶å€™ï¼Œå¯ä»¥é€šè¿‡è¿™ä¸ªåç§»é‡ï¼Œå…ˆå¯»æ‰¾åˆ° <code>8n</code> åˆ—çš„åç§»é‡ï¼Œå†å¤„ç†ã€‚ç¬”è€…è®¤ä¸ºï¼Œè¿™ç§æ–¹æ³•ç›¸å½“äºç©ºé—´æ¢ CPU æ—¶é—´ã€‚è™½ç„¶ç¬”è€…æœ¬äººæ²¡æœ‰è¯•éªŒè¿‡ï¼Œä½†æ˜¯è¿™ç§æ–¹æ³•å¯èƒ½å¯¹åˆ—å¾ˆå¤šçš„æ•°æ®æœ‰ä¸€å®šçš„æ•ˆæœã€‚</li><li>æŠŠæ ¼å¼åšæˆåç§»é‡å›ºå®šçš„æ ¼å¼ã€‚æ¯”æ–¹è¯´ï¼Œå¦‚æœ  <code>(i32, i64, i32)</code> ä¸­ç¬¬äºŒåˆ—æ˜¯ Nullï¼Œä¹Ÿå†™å¯¹åº”çš„ 8byteã€‚è¿™ç§æ–¹å¼è®©æ¯ä¸ªå­—æ®µæœ‰ä¸€ä¸ªå›ºå®šçš„åç§»é‡ï¼Œèƒ½å¤Ÿå¿«é€Ÿå®Œæˆå¯»å€ã€‚ç¬”è€…ä¸ªäººä¸æ˜¯å¾ˆå–œæ¬¢è¿™ç§æ–¹æ³•ï¼Œå› ä¸ºå¯¹äºç¨€ç–æ ¼å¼ï¼Œå®ƒå¯èƒ½å¸¦æ¥æå¤§çš„ç©ºé—´æ”¾å¤§ã€‚</li></ol><h3 id="InnoDB-Compact"><a href="#InnoDB-Compact" class="headerlink" title="InnoDB Compact"></a>InnoDB Compact</h3><ol><li><a href="https://mariadb.com/kb/en/innodb-compact-row-format/">https://mariadb.com/kb/en/innodb-compact-row-format/</a></li><li><a href="https://dev.mysql.com/doc/refman/5.7/en/innodb-row-format.html">https://dev.mysql.com/doc/refman/5.7/en/innodb-row-format.html</a></li></ol><p>InnoDB æ˜¯ç¬”è€…å¿ƒä¸­çš„å¼€æºçš„åœ°è¡¨æœ€å¼ºå­˜å‚¨å¼•æ“ï¼ŒCompact æ ¼å¼åœ¨ MySQL 5.7 ä¹‹åï¼Œä½œä¸º MySQL çš„é»˜è®¤å­˜å‚¨æ ¼å¼è€Œå­˜åœ¨ã€‚è¿™ç§æ ¼å¼æœ‰ç€æ›´å°çš„ç©ºé—´å¤§å°ï¼Œç›¸å¯¹æ¥è¯´æ¯” DYNAMIC æ ¼å¼æ›´è€—è´¹ CPU ä¸€äº›ã€‚</p><p><img src="https://image.mwish.me/blog-image/21_619_e2fcf037b107485.jpeg" alt="21_619_e2fcf037b107485"></p><p>ï¼ˆå›¾ç‰‡æ¥è‡ªï¼š<a href="https://www.alibabacloud.com/forum/read-446ï¼‰">https://www.alibabacloud.com/forum/read-446ï¼‰</a></p><p>æˆ‘ä»¬å¿½ç•¥ä¸€äº›ç‰¹æ®Šå­—æ®µï¼Œå¯ä»¥çœ‹åˆ°ï¼Œè¿™ä¸ªæ ¼å¼é™¤äº†ä¸€äº›æ ‡å¿—ä½ï¼Œä¼šæœ‰ï¼š</p><ol><li>Nullable Bitmap ï¼ˆåŒæˆ‘ä»¬ä¹‹å‰ä»‹ç»çš„ Null BitSetï¼‰</li><li>Column Length Fieldsï¼šå˜é•¿å­—æ®µçš„å†…å®¹</li><li>å…·ä½“çš„æ•°æ®</li></ol><p>è¿™é‡Œç›¸å½“äºæŠŠä¹‹å‰ PG å­˜æ”¾çš„å˜é•¿å­—æ®µé•¿åº¦æ”¾åˆ°äº†ä¸€ä¸ªç‹¬ç«‹çš„åŒºåŸŸä¸­ã€‚</p><h3 id="æ‚é¡¹-Google-FlatBuffers"><a href="#æ‚é¡¹-Google-FlatBuffers" class="headerlink" title="æ‚é¡¹: Google FlatBuffers"></a>æ‚é¡¹: Google FlatBuffers</h3><p>FlatBuffers æ˜¯ Google çš„ä¸€ç§åºåˆ—åŒ–æ ¼å¼ï¼Œç›¸å¯¹è€Œè¨€ï¼Œå®ƒæ˜¯æ›´é€šç”¨çš„ä¸€ç§æ ¼å¼ï¼Œå¼ºè°ƒäº†å¿«é€Ÿçš„è§£æï¼ˆç”šè‡³ä¸éœ€è¦è§£æï¼‰ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å®ƒå’Œè¡Œæ ¼å¼æœ‰ä¸€äº›å¼‚æ›²åŒå·¥ä¹‹å¦™ã€‚å®ƒçš„å®šä¹‰å¦‚ï¼š<a href="https://google.github.io/flatbuffers/flatbuffers_internals.html">https://google.github.io/flatbuffers/flatbuffers_internals.html</a></p><p><img src="https://image.mwish.me/blog-image/GD4XrgCFBDro_c0FAGwOzSsAAAAAbj0JAAAB.jpeg" alt="GD4XrgCFBDro_c0FAGwOzSsAAAAAbj0JAAAB"></p><p>è¿™é‡Œï¼Œå®ƒä¼šæœ‰ä¸€äº›æ•°æ®æ¥æŒ‡å‘æ•°æ®å…·ä½“å­˜æ”¾çš„åœ°æ–¹ï¼Œä»¥ä¿è¯ä¸éœ€è¦è§£æå³å¯è®¿é—®ã€‚åŒæ—¶ï¼Œè¿™ä¸ªç»“æ„è¿˜æ”¯æŒ nested å’Œä¸€å®šç¨‹åº¦ä¸Šçš„æ›´æ–°ï¼š</p><p><img src="https://image.mwish.me/blog-image/GI9ytQBfig2BZtYCAAZUtV0AAAAAbj0JAAAB.jpeg" alt="GI9ytQBfig2BZtYCAAZUtV0AAAAAbj0JAAAB"></p><p>è¯¦ç»†å†…å®¹å¯ä»¥å‚è€ƒï¼š<a href="https://engineering.fb.com/2015/07/31/android/improving-facebook-s-performance-on-android-with-flatbuffers/">https://engineering.fb.com/2015/07/31/android/improving-facebook-s-performance-on-android-with-flatbuffers/</a> </p><h3 id="Order-Preserving-Row-Encoding"><a href="#Order-Preserving-Row-Encoding" class="headerlink" title="Order Preserving Row Encoding"></a>Order Preserving Row Encoding</h3><p>å¦‚æœè¦æŠŠè¡Œæ ¼å¼å­˜å‚¨åˆ° key-value çš„ key ä¸­ï¼Œå¯¹äº ordered key-valueï¼Œæ˜¾ç„¶ä¼šå¸Œæœ›è¿™äº› key æ˜¯å¯ä»¥ scan</p><ul><li><a href="https://activesphere.com/blog/2018/08/17/order-preserving-serialization">https://activesphere.com/blog/2018/08/17/order-preserving-serialization</a></li><li><a href="https://github.com/facebook/mysql-5.6/wiki/MyRocks-record-format">https://github.com/facebook/mysql-5.6/wiki/MyRocks-record-format</a></li></ul><p>ä¸Šé¢æ˜¯é€šç”¨æ ¼å¼ï¼Œå€¼å¾—ä¸€æçš„æ˜¯ï¼Œå¯¹å­—ç¬¦ä¸²ç¼–ç ï¼Œä¸¤ç§æ ¼å¼å¤„ç†æ–¹å¼ä¸ä¸€æ ·ï¼š</p><ul><li>FoundationDB ä¼šä½¿ç”¨ <code>0x00 0xff</code> è½¬æ¢ <code>0x00</code>ï¼Œç„¶åæ¯ä¸ªç±»å‹çš„å­—æ®µéƒ½æœ‰è‡ªå·±çš„å¼€å¤´ï¼ˆä¸€ä¸ªå›ºå®šçš„ byteï¼‰å’Œç»“å°¾ï¼ˆ0x00ï¼‰ç­‰æ ‡å¿—ã€‚è§£æçš„æ—¶å€™ï¼Œé‡åˆ° 0x00ï¼Œéœ€è¦å‰ç»ä¸€ä¸ª byteï¼ŒæŸ¥çœ‹ä¸‹ä¸€ä¸ª byte æ˜¯ä»€ä¹ˆã€‚ç”¨ <code>0x00 0xff</code> æ˜¯å› ä¸ºä¸€ä¸ªæ€§è´¨ï¼šå¦‚æœä¸€ä¸ªå­—ç¬¦ä¸²åŒ…å«å†…å®¹ <code>0x00</code>, é‚£ä¹ˆå®ƒå°äºæ‰€æœ‰çœŸå®çš„å†…å®¹ï¼Œå¤§äºç»“æŸåœ¨è¿™é‡Œçš„å­—ç¬¦ä¸²ï¼ˆå³ <code>0x00</code> è¡¨ç¤ºå­—ç¬¦ä¸²å®Œäº†çš„å†…å®¹ï¼‰ï¼Œåœ¨è¿™é‡Œå®Œç»“çš„å­—ç¬¦ä¸²è¦ä¹ˆå°±ç»ˆæ­¢äº†ï¼Œè¦ä¹ˆå¼€å¯ä¸‹ä¸€ä¸ª type æ ‡è®°ï¼Œä¸‹ä¸€ä¸ª type æ ‡è®°å¿…å®šä¸ä¼šç”¨ <code>0xFF</code> ä½œä¸ºå¼€å¤´</li><li>MyRocks è¿™å¥—æŠŠå­—ç¬¦ä¸²åˆ†æˆ Groupï¼Œæ¯”å¦‚ 8 ä¸ªä¸ºä¸€ç»„ï¼Œæ¯ä¸€ç»„é™„èµ ä¸€ä¸ª byte æ¥æè¿°è¿™ä¸ª Group çš„çŠ¶æ€ï¼Œè¿™ä¸ªæ¯”è¾ƒ trickey çš„æ˜¯ç©ºå­—ç¬¦ä¸²çš„å¤„ç†ï¼Œæˆ‘æ›¾ç»ç©ºå­—ç¬¦ä¸²ä¸ç•™å†…å®¹ï¼Œæ˜¾ç„¶è¿™æ˜¯ä¸ª bugã€‚</li></ul><h3 id="æ€»ç»“-1"><a href="#æ€»ç»“-1" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>å…³äºè¡Œæ ¼å¼ï¼Œå¤§éƒ¨åˆ†æ—¶å€™æˆ‘ä»¬ä¸ä¼šå’Œ pb ä¸€æ ·ï¼Œå…¨éƒ¨è¯»å–/ååºåˆ—åŒ–ï¼Œé€šå¸¸ï¼Œè®¿é—®ä¼šåªè®¿é—®å¯¹åº”çš„ columnï¼Œè¿™è¦æ±‚æˆ‘ä»¬å¿«é€Ÿè¯»å– columnã€‚å½“ç„¶ï¼Œæœ‰çš„ç”¨æˆ·ä¹Ÿä¼šå®šä¹‰ä¸€äº›å˜é•¿å­—æ®µï¼Œç„¶ååœ¨é‡Œé¢å­˜æ”¾ pb æ•°æ®ã€‚</p><p>è¡Œæ ¼å¼çš„é€»è¾‘é€šå¸¸å’Œæ•°æ®åº“çš„å…¶ä»–ç»„ç»‡æŒ‚é’©ï¼Œä½†æˆ‘ä»¬ä»ç„¶èƒ½çœ‹åˆ°ä¸€äº›ç›¸åŒçš„å·¥ç¨‹è®¾è®¡ã€‚é™¤äº†ä¸Šé¢æˆ‘æåˆ°çš„ï¼Œè¿˜å¯ä»¥çœ‹çœ‹ TiDB / OB çš„è¡Œæ ¼å¼ï¼Œå¹¶è€ƒé‡å®ƒä»¬æ˜¯å¦‚ä½•æƒè¡¡ CPUå¼€é”€å’Œæ ¼å¼ç©ºé—´çš„å¼€é”€çš„ã€‚</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>An Overview of Query Optimization in Relational Systems</title>
      <link href="/2021/11/05/An-Overview-of-Query-Optimization-in-Relational-Systems/"/>
      <url>/2021/11/05/An-Overview-of-Query-Optimization-in-Relational-Systems/</url>
      
        <content type="html"><![CDATA[<p>è¿™æ˜¯ 1998 å¹´çš„å…³äº RDBMS ä¼˜åŒ–å™¨çš„è®ºæ–‡ï¼Œæ—¨åœ¨æŒ‡å‡º 70 å¹´ä»£åˆ°å½“æ—¶çš„ä¼˜åŒ–å™¨çš„å˜åŒ–ã€‚SQL çš„ä¼˜åŒ–å™¨å¯ä»¥è¯´æ˜¯ä¸€ä¸ªå¹¶ä¸æ–°é¢–çš„é¢†åŸŸäº†ï¼Œè™½ç„¶æ–°æŠ€æœ¯å¸¸æœ‰æå‡ºï¼Œä½†æ˜¯å¾ˆå¤šè¿˜æ˜¯åœ¨ Selinger ä¼˜åŒ–å™¨å’Œ Cascades ä¼˜åŒ–å™¨çš„æ¡†æ¶ä¸‹ã€‚</p><h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>DB çš„ä¸Šå±‚å¯ä»¥åˆ†ä¸º Query Optimizer å’Œ Query Execution Engineï¼Œ15-721 ç»™å‡ºè¿‡ä¸€ä¸ªæ¯”è¾ƒåˆé€‚çš„å›¾ï¼š</p><p><img src="https://image.mwish.me/blog-image/9D7B6B21-4DFC-4768-B508-E1D6B3C3B5AE.png" alt="9D7B6B21-4DFC-4768-B508-E1D6B3C3B5AE"></p><p>è¿™é‡ŒåŒºåˆ†äº† Physical Operators å’Œ Logical Operators. è¿™ä¸¤ä¸ªå¹¶ä¸æ˜¯ä¸€å¯¹ä¸€å…³ç³»ã€‚Physical çš„æ„æ€å¤§æ¦‚æ˜¯æ›´æ¥è¿‘å…·ä½“æ‰§è¡Œçš„æ­¥éª¤ï¼Œå®ƒä¼šè¢«ä¸¢ç»™ Execution Engine æ‰§è¡Œã€‚</p><p>äº§ç”Ÿä¸€ä¸ª Optimal çš„ Plan æ˜¯ä¸€ä¸ª NP-Hard çš„é—®é¢˜ï¼Œè€Œä¼˜åŒ–å™¨æœ¬èº«ä¹Ÿæœ‰è®¸å¤šæŠ€å·§æ¥è¿›è¡Œä¼˜åŒ–ï¼Œä¸è¿‡è¯è¯´å›æ¥ï¼Œä¼˜åŒ–å™¨åœ¨æœ‰çš„æ—¶å€™ä¹Ÿæ²¡æœ‰æ‰¿æ‹…é‚£ä¹ˆå¤æ‚çš„é€»è¾‘ï¼Œæ¯”å¦‚åœ¨ TP ç³»ç»Ÿä¸­ï¼Œæ‰€æœ‰ä¼˜åŒ–éƒ½ä¾èµ–â€œç´¢å¼•â€ï¼Œç®€å•çš„ä¼˜åŒ–å™¨ç›´æ¥åšå¾ˆå¤šåŸºäºè§„åˆ™çš„ä¼˜åŒ–å’Œç´¢å¼•æ¨æ–­å°±è¡Œã€‚</p><p>è¨€å½’æ­£ä¼ ï¼Œè®ºæ–‡è®¤ä¸º Query Optimization éœ€è¦ï¼š</p><ol><li>Search Space: Plan çš„ç”Ÿæˆç©ºé—´</li><li>Cost Estimation: ä¼°ç®—ä¸€ä¸ª Plan æ˜¯ä¸æ˜¯å¥½</li><li>Enumeration algorithm: æšä¸¾å‡ºå¯¹åº”çš„ Plan</li></ol><p>ä¸Šé¢æ„Ÿè§‰å…¶å®åœ¨è¯´åºŸè¯ï¼Œä½†æ˜¯æŒºé‡è¦çš„ï¼Œå› ä¸º (1) è¦åŒ…å«æœ€å¥½çš„ç»“æœï¼Œ(2) è¦åˆå¿«åˆå‡†ï¼Œ(3) è¦é«˜æ•ˆã€‚</p><h3 id="System-R-Optimizer"><a href="#System-R-Optimizer" class="headerlink" title="System-R Optimizer"></a>System-R Optimizer</h3><p>è¿™ç¯‡è®ºæ–‡ç®€çŸ­ä»‹ç»äº† System-R ä¼˜åŒ–å™¨çš„ Select-Project-Join (SPJ) éƒ¨åˆ†</p><p><img src="https://image.mwish.me/blog-image/465761AC-C4FA-472A-8CE4-88AF87E57A59.png" alt="465761AC-C4FA-472A-8CE4-88AF87E57A59"></p><p>System-R ä¼˜åŒ–å™¨è®¤è¯†åˆ°äº† Join çš„ associative å’Œ commutativeï¼ŒåŒæ—¶ Join æœ‰ä¸¤ç§å®ç°ï¼šNested Loop Join å’Œ Sort-Merge Join. Scan å¯ä»¥æ˜¯ Index Scan (å¯ä»¥åœ¨ cluster index æˆ–è€…æ˜¯ secondary index ä¸Š)ï¼Œæˆ–è€… Sequential Scanã€‚</p><p>è¿™é‡Œæœ‰ä¸€äº›å¯å‘å¼çš„éƒ¨åˆ†ï¼šPredict åº”è¯¥å°½æ—©è¢«æ‰§è¡Œã€‚</p><p>System-R ä¼˜åŒ–å™¨ä¾èµ–ç»Ÿè®¡ä¿¡æ¯ã€å¯¹ Selection Selectivity çš„åˆ†æï¼ˆäº‹åçœ‹è™½ç„¶æœ´ç´ ï¼Œä¸è¿‡ä¹Ÿæ¯”è¾ƒæœ‰å¯å‘æ€§äº†ï¼‰ã€å…·ä½“åˆ†æ io-cost å’Œ cpu-cost çš„å…¬å¼ï¼ˆå…¶å®æˆ‘ä¹Ÿä¸å¤ªæ¸…æ¥šè¿™ä¸ª 2020 å¹´æœ‰æ²¡æœ‰å¾ˆå¥½çš„é‡åŒ–å…¬å¼ï¼‰ã€‚é€šè¿‡ä¸Šé¢çš„ä¿¡æ¯ï¼ŒSystem-R Optimizer èƒ½å¤Ÿæ‹¿åˆ°ä¼°è®¡ä¸­çš„ï¼š</p><ol><li>ç‰©ç†çš„ Operation Node è¾“å‡ºçš„å¤§æ¦‚æ•°ç›®</li><li>è¾“å‡ºçš„ Tuples çš„é¡ºåº</li><li>Operator å¤§æ¦‚çš„ cost</li></ol><p>System-R ç”¨ DP æ¥æ‰¾åˆ° best planï¼Œåªå¤„ç†å·¦æ·±æ ‘æ¥å‡å°‘ search spaceï¼Œé€šè¿‡ interesting order æ¥å¤„ç†é¡ºåºã€‚</p><p>æ‰¾ best plan çš„æ—¶å€™ï¼Œç®—æ³•å¤§æ¦‚å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">1. j = set of join nodes</span><br><span class="line">2. for (i in 1...|j|):</span><br><span class="line">3.     for s in &#123;all length i subsets of j&#125;</span><br><span class="line">4.       bestPlan = &#123;&#125;</span><br><span class="line">5.       for s&#x27; in &#123;all length d-1 subsets of s&#125;</span><br><span class="line">6.            subplan = optjoin(s&#x27;)</span><br><span class="line">7.            plan = best way to join (s-s&#x27;) to subplan</span><br><span class="line">8.            if (cost(plan) &lt; cost(bestPlan))</span><br><span class="line">9.               bestPlan = plan</span><br><span class="line">10.      optjoin(s) = bestPlan</span><br><span class="line">11. return optjoin(j)</span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„ best way to join å®é™…ä¸Šè¿˜è¦è€ƒè™‘åˆ°åªæœ‰å·¦æ·±æ ‘ã€‚åŸºæœ¬ä¸Šå°±æ˜¯ Join(subOptimal, {remain}). ç„¶åæ‰¾åˆ°æœ€ä¼˜çš„å­ plan.</p><p>å¦å¤–ï¼Œè¿™é‡Œæœ‰ä¸ª interesting order çš„å†…å®¹ï¼Œç®€å•çš„è¯´ï¼Œåœ¨ä¸Šé¢çš„ subOptimal ä¸­ï¼Œä¸èƒ½åªè€ƒè™‘â€œä¸‹é¢å‡ å¼ è¡¨ join çš„æ—¶å€™æœ€ä¼˜çš„æ˜¯å“ªæ£µæ ‘â€œï¼Œè¿˜è¦è€ƒè™‘è¡¨ Operator è¾“å‡ºçš„å±æ€§çš„é¡ºåºã€‚è¿™ä¸ª interesting order çš„å†…å®¹ä¸ºåç»­ä¸€äº› â€œphysical propertiesâ€ çš„è®¾è®¡æä¾›äº†åŸºç¡€ã€‚</p><blockquote><p>Intuitively, a physical property is any characteristic of a plan that is not sharedby all plans for the samelogical expression,but can impact the cost of subscqucntoperations</p></blockquote><p>è™½ç„¶ä¸Šè¿°çš„è®¾è®¡å¾ˆä¼˜é›…ä¹Ÿå¾ˆæœ‰å¯å‘æ€§ï¼Œä½†æ˜¯è¿™äº›æ²¡æœ‰è®²è¿°ä»€ä¹ˆ logical transformations å’Œæ‰©å±• search space çš„éƒ¨åˆ†ã€‚</p><h2 id="Search-Space"><a href="#Search-Space" class="headerlink" title="Search Space"></a>Search Space</h2><p>SQL ä¼šæœ‰å¾ˆå¤š transformation çš„éƒ¨åˆ†ï¼Œæœ‰çš„æ—¶å€™æˆ‘ä»¬å¯ä»¥å½“ä½œè¿™äº›ä¸€å®šèƒ½èµ·åˆ°ä½œç”¨ï¼Œåšé€»è¾‘ä¸Šçš„ä¼˜åŒ–ï¼Œæ¯”å¦‚ System-R å¾ˆå¤šæ—¶å€™å°±æ˜¯è¿™ä¹ˆæ‰§è¡Œçš„ã€‚ä½†æ˜¯ä¹Ÿæœ‰ä¸€äº›å¾ˆå¯èƒ½èƒ½èµ·åˆ°ä½œç”¨çš„ transformationã€‚</p><p>è¿™é‡Œè¯´çš„æ¯”è¾ƒç»•ï¼Œè´´ä¸€ä¸‹åŸæ–‡ï¼š</p><blockquote><p>It should be noted that trunsfonnations do not necessarily reduce cost and therefore must be applied in a cost-based manner by the enum algorirhm to ensure a positive benejit.</p></blockquote><p>åœ¨è¿™é‡Œé¢ï¼ŒOptimizer å¯èƒ½ä¼šæŠŠ Plan æ ¼å¼å˜æ›´è‹¥å¹²æ¬¡ã€‚ä¿è¯å¼€å§‹æ˜¯ä¸€ä¸ªé€»è¾‘è®¡åˆ’ï¼Œæœ€åæ˜¯ä¸€ä¸ªå¯ä»¥ä¸¢ç»™ Execution Engine çš„ä¸œè¥¿å°±è¡Œäº†ã€‚</p><p>å…³äºè¿™ä¸ªæˆ‘æ‰¾äº†æ‰¾ Starburst æœ‰å…³çš„è®ºæ–‡ï¼š<a href="https://zhuanlan.zhihu.com/p/369771981">https://zhuanlan.zhihu.com/p/369771981</a> ï¼ŒStarburst ä¼šç”Ÿæˆä¸€ä¸ªä¾¿äºä¼˜åŒ–çš„ QGMï¼Œä¾¿äºå¯¹æ•´ä¸ªæ ‘åšä¸€äº›é€»è¾‘ä¼˜åŒ–ã€‚ä¸è¿‡æ‰¹è¯„è€…è®¤ä¸ºè¿™äº›ä¼˜åŒ–ä¸ä¸€å®šè€ƒè™‘åˆ°äº† Page/Block ç›¸å…³çš„ä¿¡æ¯ã€‚</p><h3 id="Commuting-Between-Operators"><a href="#Commuting-Between-Operators" class="headerlink" title="Commuting Between Operators"></a>Commuting Between Operators</h3><p>å¾ˆå¤š transformation ç”¨åˆ°äº†ç®—å­çš„äº¤æ¢å¾‹ã€‚</p><h4 id="Generalizing-Join-Sequencing"><a href="#Generalizing-Join-Sequencing" class="headerlink" title="Generalizing Join Sequencing"></a>Generalizing Join Sequencing</h4><p>åœ¨ System-R ä¼˜åŒ–å™¨ä¸­ï¼Œåªä¼šè€ƒè™‘ left-deep treeã€‚ä½†å®é™…ä¸Šï¼ŒåŸåˆ™ä¸Šæˆ‘ä»¬å¯ä»¥è€ƒè™‘ bushy treeï¼Œè¿‘æ—¥çš„ DPCCP å¼€å§‹è®¡å…¥ç›¸å…³çš„å†…å®¹ï¼Œæ­£é¢é¢å¯¹ bushy treeã€‚åŒæ—¶ï¼ŒSystem-R ä¼˜åŒ–å™¨å°†ç¬›å¡å°”ç§¯ä¸¢åˆ°æœ€åå¤„ç†ï¼Œä½†æ˜¯å®é™…ä¸Šè¿™ä¸ªä¹Ÿå¯èƒ½è¢«æ˜¾è‘—ä¼˜åŒ–ï¼Œæ¯”æ–¹è¯´åœ¨ BI ç³»ç»Ÿä¸­ï¼Œå¯¹ç¬›å¡å°”ç§¯çš„ä¼˜åŒ–æ˜¯å¾ˆé‡è¦çš„ã€‚</p><p>åœ¨ä¸€ä¸ªå¯æ‰©å±•çš„ç³»ç»Ÿä¸­ï¼Œå¯èƒ½ä¼šå…è®¸æœç´¢ bushy tree ï¼ˆè¿™ä¸ªéœ€è¦ç‰©åŒ– Join ç»“æœï¼‰æˆ–è€…ç¬›å¡å°”ç§¯ã€‚ï¼ˆå½“ç„¶è¿™ä¸ªä¹Ÿæ˜¯æ¯”è¾ƒéš¾æ¨æ–­ä¸‹æ¥å…·ä½“è¯¥ä¸è¯¥è¿™ä¹ˆåšçš„ï¼‰ã€‚</p><h4 id="Outerjoin-and-Join"><a href="#Outerjoin-and-Join" class="headerlink" title="Outerjoin and Join"></a>Outerjoin and Join</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Join(R, S LOJ T) = Join(R, s) LOJ T</span><br></pre></td></tr></table></figure><p>è¿™äº›æ“ä½œèƒ½è®© Joins åœ¨ <code>Join + outerjoins</code> ä¹‹å‰æ‰§è¡Œ</p><h4 id="Group-By-and-Join"><a href="#Group-By-and-Join" class="headerlink" title="Group-By and Join"></a>Group-By and Join</h4><p><img src="https://image.mwish.me/blog-image/58149849-AF28-49B6-9210-8C69D0A0DFC7.png" alt="58149849-AF28-49B6-9210-8C69D0A0DFC7"></p><p>æ—©æœŸçš„ä¸€äº›ä¼˜åŒ–å™¨ä¸­ï¼ŒSPJ ä¼šåœ¨ Group By ä¹‹å‰æ‰§è¡Œ. Figure 4 çš„ Transformation åœ¨ Join ä¹‹å‰å³å¯å¤„ç† Group By. æ¯”å¦‚åœ¨ <code>Select DISTINCT</code> çš„æ—¶å€™ï¼Œè¿™é‡Œå¯èƒ½ä¼šæŠŠéƒ¨åˆ† Group By ä¸‹æ¨ï¼Œè¿™ä¸€å®šæƒ…å†µä¸‹å¯ä»¥å‡å°‘ Join çš„æ•°é‡ã€‚æ­¤å¤–ï¼Œå¦‚æœ Group By å¯ä»¥åˆ©ç”¨ R1 çš„ orderï¼Œé‚£ä¹ˆæ˜¾ç„¶æ˜¯å¥½çš„ã€‚</p><p>è¿™é‡ŒæŠŠ Group By ä¸‹æ¨ç»™ G1ï¼Œä¸€å®šç¨‹åº¦ä¸Šï¼Œè¿™å¯ä»¥å‡å°‘ Join çš„æ•°é‡ã€‚ä¸è¿‡è¿™ä¹Ÿè¦æ±‚èƒ½æŠŠ Group By åšä¸€å®šçš„æ‹†åˆ†ã€‚</p><h3 id="Reducing-Multi-Block-Queries-to-Single-Block"><a href="#Reducing-Multi-Block-Queries-to-Single-Block" class="headerlink" title="Reducing Multi-Block Queries to Single-Block"></a>Reducing Multi-Block Queries to Single-Block</h3><h4 id="Merging-Views"><a href="#Merging-Views" class="headerlink" title="Merging Views"></a>Merging Views</h4><p>å¯¹äºç®€å•çš„ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Q = Join(R, V)</span><br><span class="line">V = View of Join(S, T)</span><br></pre></td></tr></table></figure><p>Q æ˜¯å¯ä»¥æ‹†å¼€æ¥ç„¶åè¿›è¡Œ join order optimize çš„ï¼Œä¸è¿‡è¯åˆè¯´å›æ¥ï¼Œä¸Šä¸€èŠ‚é™åˆ°äº† Group By å’Œ DISTINCT ä¸‹æ¨ï¼Œè¿™é‡Œçš„å±•å¼€å¯èƒ½æ˜¯åç€ä¸¤ä¸ªä¸‹æ¨çš„ã€‚æˆ‘ä»¬å¯èƒ½è¦é‡æ–°æ‰§è¡Œ Figure 4 çš„æµç¨‹</p><h4 id="Merging-Nested-Subqueries"><a href="#Merging-Nested-Subqueries" class="headerlink" title="Merging Nested Subqueries"></a>Merging Nested Subqueries</h4><p>å­æŸ¥è¯¢ç›¸å½“ç›¸å½“é‡è¦ã€‚</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> Emp.Name</span><br><span class="line"><span class="keyword">FROM</span> Emp</span><br><span class="line"><span class="keyword">WHERE</span> Emp.Dept <span class="keyword">IN</span></span><br><span class="line">(</span><br><span class="line"><span class="keyword">SELECT</span> Dept.Dept <span class="keyword">FROM</span> Dept</span><br><span class="line"><span class="keyword">WHERE</span> Dept.Loc <span class="operator">=</span> <span class="string">&#x27;xxx&#x27;</span></span><br><span class="line"><span class="keyword">AND</span> Emp.Emp <span class="operator">=</span> Dept.Mgr</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>(1) å½“å†…éƒ¨æŸ¥è¯¢éƒ¨ä¸å¸¦æœ‰å¤–éƒ¨æŸ¥è¯¢( uncorrelated ) çš„æƒ…å†µä¸‹ï¼Œå†…éƒ¨æŸ¥è¯¢åªéœ€è¦æ‰§è¡Œä¸€æ¬¡ã€‚</p><p>å¦‚æœå†…éƒ¨æŸ¥è¯¢å’Œå¤–éƒ¨æŸ¥è¯¢ç›¸å…³ï¼Œéœ€è¦å¤–éƒ¨æŸ¥è¯¢ä¸­çš„å˜é‡ï¼Œé‚£å°±éº»çƒ¦äº†ã€‚ä¾‹å¦‚ä¸Šé¢çš„ SELECT å¯ä»¥ cast æˆï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> Emp E, Dept D</span><br><span class="line"><span class="keyword">WHERE</span> E.Dept <span class="operator">=</span> D.Dept</span><br><span class="line"><span class="keyword">AND</span> D.Loc <span class="operator">=</span> <span class="string">&#x27;xxx&#x27;</span> <span class="keyword">AND</span> E.Emp <span class="operator">=</span> D.Mgr</span><br></pre></td></tr></table></figure><p>è½¬åŒ–çš„æµç¨‹å–å†³äºå†…éƒ¨è¡¨è¾¾å¼çš„å¤æ‚åº¦ï¼Œå³æœ‰æ—  quantifiers (ä¾‹å¦‚ ALL, EXIST)ã€aggregates æˆ–è€…éƒ½æ²¡æœ‰ã€‚(2) åœ¨æœ€ç®€å•çš„åœºæ™¯ä¸‹ï¼Œå¦‚ä¸Šé¢ï¼ŒTable å¯ä»¥æ”¹æˆä¸€ä¸ª Semijoin:</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Semijoin(Emp, Dept, Emp.Dept <span class="operator">=</span> Dept.Dept) <span class="operator">=</span> Project(<span class="keyword">Join</span>(Emp, Dept), Emp.<span class="operator">*</span>)</span><br></pre></td></tr></table></figure><p>å½“å­æŸ¥è¯¢æœ‰ subquery çš„æ—¶å€™ï¼Œæƒ…å†µå¯èƒ½éœ€è¦è½¬åŒ–æˆ LOJ æˆ–è€… ROJ:</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> Dept.name</span><br><span class="line"><span class="keyword">FROM</span> Dept</span><br><span class="line"><span class="keyword">WHERE</span> Dept.num<span class="operator">-</span><span class="keyword">of</span><span class="operator">-</span>machines <span class="operator">&gt;=</span></span><br><span class="line">(</span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(Emp.<span class="operator">*</span>)</span><br><span class="line"><span class="keyword">FROM</span> Emp</span><br><span class="line"><span class="keyword">WHERE</span> Dept.name <span class="operator">=</span> Emp.Dept_name</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p><code>SELECT Count(Emp.*)</code> æ˜¯ä¸ª aggï¼Œè¿™é‡Œéº»çƒ¦çš„åœ°æ–¹æ˜¯ï¼Œå¦‚æœ <code>Dept.name</code> ç›¸ç­‰çš„ <code>Emp</code> æ˜¯ä¸å­˜åœ¨çš„ï¼Œé‚£ä¹ˆè¿™ä¸ªæ¡ä»¶æ˜¾ç„¶æ˜¯æ»¡è¶³çš„ã€‚æ‰€ä»¥è¿™é‡Œçš„é€»è¾‘æ˜¯ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Select</span> Dept.name <span class="keyword">FROM</span> Dept <span class="keyword">LEFT</span> <span class="keyword">OUTER</span> <span class="keyword">JOIN</span> Emp <span class="keyword">ON</span> Dept.name <span class="operator">=</span> Emp.Dept_name <span class="keyword">Group</span> <span class="keyword">BY</span> Dept.name </span><br><span class="line"><span class="keyword">HAVING</span> Dept.num<span class="operator">-</span><span class="keyword">of</span><span class="operator">-</span>machines <span class="operator">&lt;</span> <span class="built_in">COUNT</span>(Emp.<span class="operator">*</span>)</span><br></pre></td></tr></table></figure><p>è¿™é‡Œç›¸å½“äº Dept LOJ å†…éƒ¨ agg çš„è¡¨ã€‚è¿™ä¸ªçš„ä¼˜åŒ–å¯ä»¥ä¾èµ–ä¹‹å‰æçš„ï¼Œåå¤„ç† LOJ</p><h3 id="Using-Semijoin-Like-Techniques-for-Optimizing-Multi-Block-Queries"><a href="#Using-Semijoin-Like-Techniques-for-Optimizing-Multi-Block-Queries" class="headerlink" title="Using Semijoin Like Techniques for Optimizing Multi-Block Queries"></a>Using Semijoin Like Techniques for Optimizing Multi-Block Queries</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">VIEW</span> DepAvgSal <span class="keyword">As</span> (</span><br><span class="line"><span class="keyword">SELECT</span> E.did, <span class="built_in">Avg</span>(E.Sal) <span class="keyword">AS</span> avgsal</span><br><span class="line"><span class="keyword">FROM</span> Emp E</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> E.did</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> E.eid, E.sal</span><br><span class="line"><span class="keyword">FROM</span> Emp E, Dept D, DepAvgSal v</span><br><span class="line"><span class="keyword">WHERE</span> E.did <span class="operator">=</span> D.did <span class="keyword">AND</span> E.did <span class="operator">=</span> V.did</span><br><span class="line"><span class="keyword">AND</span> E.age <span class="operator">&lt;</span> <span class="number">30</span> <span class="keyword">AND</span> D.budget <span class="operator">&gt;</span> <span class="number">100</span>k</span><br><span class="line"><span class="keyword">AND</span> E.sal <span class="operator">&gt;</span> V.avgsal</span><br></pre></td></tr></table></figure><p>è¿™é‡Œé¢ï¼ŒSQL å¯ä»¥è¢«ä¼˜åŒ–ä¸º <code>E.did</code> ç›¸å…³çš„ view</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">VIEW</span> partialresult <span class="keyword">AS</span></span><br><span class="line">(</span><br><span class="line"><span class="keyword">SELECT</span> E.id, E.sal, E.did</span><br><span class="line"><span class="keyword">FROM</span> Emp E, Dept D</span><br><span class="line"><span class="keyword">WHERE</span> E.did <span class="operator">=</span> D.did <span class="keyword">AND</span> E.age <span class="operator">&lt;</span> <span class="number">30</span></span><br><span class="line"><span class="keyword">AND</span> D.budget <span class="operator">&gt;</span> <span class="number">100</span>k</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">View</span> <span class="keyword">Filter</span> <span class="keyword">AS</span> </span><br><span class="line">(</span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">DISTINCT</span> P.did <span class="keyword">FROM</span> partialresult P</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">VIEW</span> LimitedAvgSal <span class="keyword">AS</span> (</span><br><span class="line"><span class="keyword">SELECT</span> E.did, <span class="built_in">Avg</span>(E.sal) <span class="keyword">AS</span> avgsal</span><br><span class="line"><span class="keyword">FROM</span> Emp E, <span class="keyword">Filter</span> F</span><br><span class="line"><span class="keyword">WHERE</span> E.did <span class="operator">=</span> F.did <span class="keyword">GROUP</span> <span class="keyword">BY</span> E.did</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>è¿™ç§æ“ä½œå°†å­æŸ¥è¯¢å˜æ›´ä¸ºä¸é‡å¤è®¿é—®çš„æŸ¥è¯¢ã€‚</p><h2 id="Statistics-And-Cost-Estimation"><a href="#Statistics-And-Cost-Estimation" class="headerlink" title="Statistics And Cost Estimation"></a>Statistics And Cost Estimation</h2><p>ä¸Šé¢çš„éƒ¨åˆ†ä»‹ç»äº†ä¸€äº› Logical çš„ Transformationã€‚å¯¹äºä¸€ä¸ªè¡¨è¾¾å¼æ ‘ï¼Œæˆ‘ä»¬è¦è€ƒé‡çš„èµ„æºå¯èƒ½æœ‰ï¼š</p><ul><li>CPU time</li><li>IO cost</li><li>memory</li><li>bandwidth</li></ul><p>Cost Estimation æ˜¯å¸Œæœ›å¿«æ·åˆå‡†ç¡®çš„è®¡ç®—è¿™äº›å€¼ã€‚System-R ç»™å‡ºäº†ä¸€ä¸ªåŸºæœ¬çš„æ¡†æ¶ï¼š</p><ol><li>å¯¹å­˜å‚¨çš„æ•°æ®åšä¸€äº›åˆ†æ</li><li>å¯¹æ¯ä¸ª Operatorï¼Œç»™å‡ºä¸€ä¸ªè¯„ä¼°ç­–ç•¥ï¼š<ol><li>è¾“å‡ºæ•°æ®çš„ä¸€äº›ç»Ÿè®¡å€¼</li><li>æ“ä½œçš„ cost</li></ol></li></ol><p>å…³äº (1), è¿™é‡Œæœ‰ä¸¤ä¸ªé—®é¢˜ï¼š</p><ul><li>æˆ‘ä»¬éœ€è¦ä»€ä¹ˆæ•°æ®</li><li>æˆ‘ä»¬ä»€ä¹ˆæ—¶å€™è·å–/æ›´æ–°è¿™äº›ç»Ÿè®¡æ•°æ®</li></ul><h3 id="Statistical-Summaries-of-Data"><a href="#Statistical-Summaries-of-Data" class="headerlink" title="Statistical Summaries of Data"></a>Statistical Summaries of Data</h3><h4 id="Base-Data"><a href="#Base-Data" class="headerlink" title="Base Data"></a>Base Data</h4><p>ä¸€ä¸ªå…³é”®ç‚¹æ˜¯ï¼Œæˆ‘ä»¬éœ€è¦çŸ¥é“ tuples å’Œç›¸å…³çš„ pages çš„å¤§æ¦‚æ•°ç›®ã€‚è¿™äº›ä¿¡æ¯æ˜¯ç‰©ç†çš„æ•°æ®ï¼Œç‹¬ç«‹äº expression çš„ selectivity è¿™æ ·çš„é€»è¾‘æ•°æ®ï¼Œå¹¶ä¸”å’Œåè€…ä¸€èµ·åšå‡ºå†³ç­–ã€‚æˆ‘ä»¬éœ€è¦çŸ¥é“å„ä¸ªåˆ—ç›¸å…³çš„ä¸€äº›ååŠ©é¢„æµ‹çš„ä¿¡æ¯ã€‚</p><p>åœ¨å¾ˆå¤š RDBMS ä¸­ï¼Œç­‰æ·±ï¼ˆequi-depthï¼‰ç›´æ–¹å›¾å¯ä»¥ç”¨æ¥ç»Ÿè®¡ä¿¡æ¯ã€‚åœ¨ç›´æ–¹å›¾çš„å•ä¸ª Bucket é‡Œï¼Œå¯ä»¥å½“ä½œæ•°æ®æ˜¯ uniform distribution çš„ã€‚å¦‚æœç¼ºå°‘ç›´æ–¹å›¾ï¼Œå¯ä»¥ä¿å­˜æ•°å€¼çš„ min/maxï¼ˆéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå®è·µä¸­ï¼Œè¿™é‡Œä¹Ÿä¼šå¤„ç†ä¸€äº›æå¤§æå°å€¼ï¼Œä¿ç•™æ¬¡å¤§å€¼ä¹‹ç±»çš„ï¼‰ã€‚</p><p>æˆ‘ä»¬å¯èƒ½è¦ä¸ºæ‰€æœ‰çš„ Column éƒ½æ„å»ºå¯¹åº”çš„ Histogramï¼Œå½“ç„¶ï¼Œä¸€ä¸ªæŸ¥è¯¢å¯èƒ½ä¼šæœ‰å¤šåˆ—çš„ conditionã€‚ä¸€èˆ¬æˆ‘ä»¬ä¸ä¼šä¸ºåˆ—çš„ pairs ç»´æŠ¤ histogramï¼Œè¿™æ ·ä¼šé€ æˆå·¨å¤§çš„ç©ºé—´æ”¾å¤§ï¼Œä½†æˆ‘ä»¬å¯èƒ½ç»´æŠ¤ç›¸å…³çš„ distinct valueï¼ˆä¸åŒçš„å€¼ï¼‰ã€‚</p><h4 id="Propagation-of-Statistical-Information"><a href="#Propagation-of-Statistical-Information" class="headerlink" title="Propagation of Statistical Information"></a>Propagation of Statistical Information</h4><p>histogram å¯ä»¥æ”¯æŒåœ¨æ’å…¥åæ›´æ–°æ•°æ®ï¼Œä¹Ÿå¯ä»¥åœ¨æŸä¸ªç»Ÿè®¡ä¿¡æ¯ä¸æ˜¯å¾ˆå‡†çš„ SELECT ä¹‹åï¼Œæ ¹æ® SELECT çš„ç»“æœï¼Œæ›´æ–°æ•°æ®ï¼Œä¸è¿‡ä¸å¤ªå¥½çš„ä¸€ç‚¹æ˜¯ï¼Œå¦‚æœæœ‰çš„åˆ—è¢«é¢‘ç¹æ›´æ–°ï¼Œä½†æ˜¯å¾ˆå°‘è¯»å–ï¼Œè¿™äº›æ•°æ®å¯èƒ½ä¼šå¤±çœŸã€‚å½“æˆ‘ä»¬æœ‰å¤šä¸ªæ¡ä»¶çš„æ—¶å€™ï¼Œå¯èƒ½ä¼šå–å„ä¸ª Column çš„ Selectivity çš„ç§¯ï¼Œè¿™å¯èƒ½å¯¼è‡´é—®é¢˜å˜ä¸¥é‡ã€‚</p><p>ä¸è¿‡æœ‰çš„ç³»ç»Ÿå¯èƒ½åªä¼šç”¨ä¸€äº› Column çš„ç»Ÿè®¡ä¿¡æ¯ã€‚ä¸€äº›ç³»ç»Ÿåœ¨ Join çš„æ—¶å€™ä¹Ÿå¯ä»¥ç»™ Histogram åš â€œJoinâ€ï¼Œä¸è¿‡è¿™æ¶‰åŠ Histogram çš„å¯¹é½å·¥ä½œã€‚</p><h4 id="Cost-Computation"><a href="#Cost-Computation" class="headerlink" title="Cost Computation"></a>Cost Computation</h4><p>è¿™é‡Œè¦æ±‚æŠŠ CPUï¼ŒIO ç­‰è€ƒè™‘ä¸Šï¼Œä¹Ÿæåˆ°äº†åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œä¹Ÿè¦è€ƒè™‘ IO å¼€é”€ï¼ˆä¸çŸ¥é“ snowflake å’Œ ClickHouse åšäº†å—ï¼‰ã€‚è¿™é‡Œè¿˜æåˆ°å¯¹ RDBMSï¼ŒBuffer Pool  ç›¸å…³çš„ç­–ç•¥å¯¹é¢„æµ‹å½±å“ä¹Ÿå¾ˆé«˜ã€‚</p><h2 id="Enumeration-Architectures"><a href="#Enumeration-Architectures" class="headerlink" title="Enumeration Architectures"></a>Enumeration Architectures</h2><p>System-R ä¼˜åŒ–å™¨ä¼šæ ¹æ®è¡¨è®¿é—®æ–¹æ³•ã€Join æ–¹æ³•æ„å»ºæœç´¢ç­–ç•¥ã€‚å½“æ·»åŠ æ–°çš„ transformation å’Œæ–°çš„ physical operator çš„æ—¶å€™ï¼Œå¸Œæœ›æœ‰ä¸€ä¸ªå¯æ‰©å±•ï¼ˆextensibleï¼‰çš„ optimizerã€‚è¿™é‡Œå…³æ³¨äº†è‡ªåº•å‘ä¸Šçš„ Starburst å’Œè‡ªé¡¶å‘ä¸‹çš„ Volcano/Cascadesï¼Œä»–ä»¬çš„å…±åŒç‚¹æ˜¯ï¼š</p><ol><li>ä½¿ç”¨ generalized cost functions + physical properties + operator nodes</li><li>ä½¿ç”¨è§„åˆ™å¼•æ“ï¼Œè®© transformation èƒ½å¤Ÿæ›´æ–° query expression / operator trees</li></ol><h3 id="Starburst"><a href="#Starburst" class="headerlink" title="Starburst"></a>Starburst</h3><p>Starburst è¢«æ„å»ºåœ¨ DB2 ä¸­ï¼Œæœ‰ Query Rewrite å’Œ Plan Optimization ä¸¤ä¸ªé˜¶æ®µã€‚å®ƒè¢«è¯æ˜æœ‰ä¸é”™çš„æ€§èƒ½ï¼Œä½†æ˜¯ä¹Ÿæœ‰ä¸€å®šçš„é—®é¢˜ã€‚</p><p>Starburst ä¼šæŠŠæŸ¥è¯¢æ„å»ºæˆ QGMï¼Œå…¶ä¸­ <code>box</code> ä»£è¡¨ table ç›¸å…³çš„ query blockï¼Œæ¯ä¸ª box ä¼šæè¿°æ•°æ®æ˜¯å¦æœ‰åºã€predicate ç›¸å…³çš„ç­–ç•¥ã€‚</p><p>åœ¨ rewrite é˜¶æ®µï¼Œç³»ç»Ÿæœ‰å¾ˆå¤šçš„ rulesï¼Œæ¯ä¸ª rule åŒ…å«<code>&lt;åˆ¤æ–­ apply çš„æ¡ä»¶, apply çš„æµç¨‹&gt;</code> .è¿™äº› rules æŒ‰é¡ºåºæ’å¸ƒã€‚</p><p>åœ¨ plan optimization é˜¶æ®µï¼ŒQGM ä¼šäº§ç”Ÿå¯¹åº”çš„ physical operatorsï¼Œè¿™ä¸ªäº§ç”Ÿæ–¹æ³•å¯èƒ½æœ‰æŸç§ dsl æ¥æè¿°ã€‚æ¯ä¸ª Plan æœ‰è‡ªå·±çš„ selectivity, physical propertiesï¼Œcostã€‚</p><h3 id="Volcano-Cascades"><a href="#Volcano-Cascades" class="headerlink" title="Volcano/Cascades"></a>Volcano/Cascades</h3><p>starburst ä¼šå…ˆç”Ÿæˆä¸€ç»„ QGMï¼ŒVolcano/Cascades ä¼šæœ‰é€»è¾‘åˆ°ç‰©ç†çš„å˜åŒ–ã€‚å€ŸåŠ© memo æ¥åšå…·ä½“çš„å®ç°ã€‚</p>]]></content>
      
      
      
        <tags>
            
            <tag> database, optimizer </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SSD as Cache and CacheLib</title>
      <link href="/2021/11/01/SSD-as-Cache-and-CacheLib/"/>
      <url>/2021/11/01/SSD-as-Cache-and-CacheLib/</url>
      
        <content type="html"><![CDATA[<h2 id="SSD-ç‰¹æ€§å›é¡¾"><a href="#SSD-ç‰¹æ€§å›é¡¾" class="headerlink" title="SSD ç‰¹æ€§å›é¡¾"></a>SSD ç‰¹æ€§å›é¡¾</h2><p>SSD çš„é‡è¦ç»„æˆéƒ¨åˆ†æ˜¯ NAND Flashï¼Œåœ¨ä»‹ç» SSD çš„æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦ç†è§£ NAND Flash çš„ä¸€äº›åŸºæœ¬æ€§è´¨ã€‚</p><p>Flash åŒ…å«å¾ˆå¤š Blockï¼Œè€Œ Block é€šå¸¸ç”±å¾ˆå¤š Page ç»„æˆã€‚è¯»å– (read) çš„å•ä½é€šå¸¸æ˜¯ Pageï¼ŒProgram ä¹Ÿæ˜¯é’ˆå¯¹å•ä¸ª Page è¿›è¡Œå†™å…¥çš„ã€‚è€Œé‡è¦çš„æ“¦å†™ï¼ˆEraseï¼‰æ„å‘³ç€ï¼Œæˆ‘ä»¬éœ€è¦é‡å†™æŸä¸ª Page çš„è¯ï¼Œæˆ‘ä»¬å¯èƒ½éœ€è¦ç»™æ•´ä¸ª Block å†…å®¹ç§»é™¤ï¼š</p><p><img src="https://image.mwish.me/blog-image/470B0E46-53DD-49A3-AC29-E8AD71AA3834.png" alt="470B0E46-53DD-49A3-AC29-E8AD71AA3834"></p><p>é€šå¸¸ï¼ŒFlash çš„æ“¦å†™æ¬¡æ•°æ˜¯æœ‰ä¸Šé™çš„ï¼Œè€Œ SSD ä¼šåŒ…å« FTL å±‚ï¼Œæ¥åè°ƒå¯¹ SSD çš„å†™å…¥ã€‚</p><p><img src="https://image.mwish.me/blog-image/9A5BDBB7-CDD3-4FDB-BACC-5AC2F30234AA.png" alt="9A5BDBB7-CDD3-4FDB-BACC-5AC2F30234AA"></p><p>å¯¹ SSD çš„å†™å…¥å¯èƒ½è¿˜ä¼šéœ€è¦ GCï¼Œå› ä¸º Erase/Program æ˜¯ä¸åŒç²’åº¦çš„ï¼Œæ‰€ä»¥ SSD å¯èƒ½æ˜¯éœ€è¦ GC çš„ã€‚å‡è®¾ï¼š</p><ol><li>å‰å°æ²¡æœ‰ç©ºé—´ä¾› SSD å†™å…¥</li><li>åå°å¸Œæœ›æ•´ç†ç¢ç‰‡ï¼Œåœ¨æœ‰çš„ Block ä¸­ï¼Œå¯ç”¨çš„é€»è¾‘å—å¾ˆå°‘äº†</li></ol><p>é‚£ä¹ˆæˆ‘ä»¬å¸Œæœ›æœ‰ä¸€ä¸ª GC æ¥æ¸…ç†è¿™äº›èµ„æº</p><p><img src="https://image.mwish.me/blog-image/D0E621E1-838A-4ADE-BB9D-88BD124EF3FD.png" alt="D0E621E1-838A-4ADE-BB9D-88BD124EF3FD"></p><p>ä¸Šè¿°å›¾ç‰‡æ¼”ç¤ºäº† GC çš„è¿‡ç¨‹ã€‚è¿™ä¸­é—´éœ€è¦æœ‰ä¸€éƒ¨åˆ†é¢å¤–ç©ºé—´æ¥åš GCï¼Œæ¯”æ–¹è¯´ SSD æä¾› 1TB çš„ç©ºé—´ï¼Œé‚£ä¹ˆå®ƒéœ€è¦æœ‰ä¸€å®šçš„å†…å­˜æ¥å¤„ç† NAND Flash ç‰©ç†ç©ºé—´å’Œé€»è¾‘ç©ºé—´çš„æ˜ å°„ï¼ŒåŒæ—¶ï¼Œéœ€è¦æœ‰ä¸€å®šç©ºé—´æ¥ååŠ© GCï¼Œè¿™éƒ¨åˆ†ç©ºé—´å«åš over-provisioning (OP).</p><p>SSD ä¹Ÿå¯ä»¥åœ¨ç”¨æˆ·å±‚é…ç½®æ›´å¤šçš„ç©ºé—´ç»™ OPï¼Œè¿™ç§é…ç½®èƒ½å¤Ÿè®© SSD æœ‰æ›´å¤šçš„ç©ºé—´åš GCï¼Œå¯¹äº random write æ¯”è¾ƒå¤šçš„ SSDï¼Œå®é™…ä¸Šå¯ä»¥æä¾›ä¸€å®šçš„æ€§èƒ½ä¼˜åŒ–ï¼Œå¦‚ä¸‹å›¾ï¼š</p><p><img src="https://image.mwish.me/blog-image/5E1FF6C5E870DA80BB49B23B57F0A416.png" alt="5E1FF6C5E870DA80BB49B23B57F0A416"></p><p><img src="https://image.mwish.me/blog-image/BA93F665-D143-4773-98C9-35218854FEF1.png" alt="BA93F665-D143-4773-98C9-35218854FEF1"></p><p>ä»¥ä¸Šæ˜¯é˜…è¯»åæ–‡ä¹‹å‰éœ€è¦ç†è§£çš„ SSD çŸ¥è¯†ã€‚</p><h3 id="ä¸ºä»€ä¹ˆä¸º-SSD-è®¾è®¡ç¼“å­˜éœ€è¦é¢å¤–çš„æ•°æ®ç»“æ„"><a href="#ä¸ºä»€ä¹ˆä¸º-SSD-è®¾è®¡ç¼“å­˜éœ€è¦é¢å¤–çš„æ•°æ®ç»“æ„" class="headerlink" title="ä¸ºä»€ä¹ˆä¸º SSD è®¾è®¡ç¼“å­˜éœ€è¦é¢å¤–çš„æ•°æ®ç»“æ„"></a>ä¸ºä»€ä¹ˆä¸º SSD è®¾è®¡ç¼“å­˜éœ€è¦é¢å¤–çš„æ•°æ®ç»“æ„</h3><p>å®é™…ä¸Šï¼Œç°æœ‰å·²ç»æœ‰æ¯”è¾ƒå¤šçš„ kv-store äº†ï¼ŒåŒ…æ‹¬è‘—åçš„ RocksDBã€‚ä¸»è¦çš„é—®é¢˜åœ¨äºï¼ŒCache ä¸­ï¼Œå¦‚æœä¸å†å¼•ç”¨æŸä»½æ•°æ®ï¼Œé‚£ä¹ˆåˆ é™¤æ‰å®ƒæ˜¯å®‰å…¨çš„ã€‚è€Œ KV å­˜å‚¨å¼•æ“å³ä½¿ä¸ä¿ç•™å¤šä¸ªç‰ˆæœ¬ï¼Œä¹Ÿä¸€å®šä¼šä¿ç•™å®ƒã€‚drop ä¸€ä»½æ•°æ®çš„æ—¶å€™ï¼Œç”šè‡³ä¼š log ä¸€ä¸ª tombstoneï¼Œå†æ…¢æ…¢æ¸…é™¤å­˜å‚¨çš„æ•°æ®ã€‚</p><p>Netflix ä½¿ç”¨ RocksDB åšå°æ–‡ä»¶ç¼“å­˜ï¼Œè¿™ä½¿å¾—å®ƒæœ‰å¤§é‡çš„ç©ºé—´æµªè´¹ï¼Œå¹¶ä¸”è¦å¼€å¯è¾ƒé«˜çš„ OPã€‚</p><h2 id="CacheLib"><a href="#CacheLib" class="headerlink" title="CacheLib"></a>CacheLib</h2><p>CacheLib æœ¬èº«æ˜¯ Facebook ä»¥åº“çš„å½¢å¼æä¾›çš„ç¼“å­˜åº“ã€‚å¼€å‘è¿™ä¸ªåº“ä¸»è¦æ˜¯å› ä¸º Facebook å†…éƒ¨æœ‰å¾ˆå¤šéœ€è¦ç”¨ç¼“å­˜çš„åœ°æ–¹ï¼ŒåŒ…æ‹¬ CDNã€åº”ç”¨çš„ Look-Aside Cacheã€å¯¹ Storage System ï¼ˆæ¯”å¦‚å›¾ç‰‡å’Œå°å¯¹è±¡ï¼‰çš„ Cacheã€‚å¦‚ä¸‹å›¾ï¼š</p><p><img src="https://image.mwish.me/blog-image/DAD9DF7D-B6ED-48CE-AC8E-E5A806E381CE.png" alt="DAD9DF7D-B6ED-48CE-AC8E-E5A806E381CE"></p><p>è¿‡å»è¿™äº›å›¢é˜Ÿéƒ½éœ€è¦ç‹¬ç«‹ç»´æŠ¤ Cacheï¼Œä¹Ÿå¼€æºäº†åƒ memcached ä¸€æ ·çš„äº§å“ã€‚ä½†å®é™…ä¸Šè¿™äº›å›¢é˜Ÿç›¸å½“äºè¦é€ ä¸€å¥—é€‚ç”¨äºè‡ªå·±çš„ç¼“å­˜ã€‚ä¸åŒå›¢é˜Ÿçš„ç¼“å­˜æ˜¯ä¸å¤ªä¸€æ ·çš„ï¼Œè®ºæ–‡é‡Œé¢å±•ç°äº†ä¸åŒåœ°æ–¹çš„ä½¿ç”¨åœºæ™¯ï¼š</p><ul><li>CDNï¼Œä½¿ç”¨ DRAM å’Œ Flash åš Cache</li><li>åº”ç”¨çš„ Look-Aside Cacheï¼Œå¯èƒ½ä¼šè¿è¡Œä¸€ä¸ªæ¯”è¾ƒå¤§çš„ Memcache é›†ç¾¤ï¼Œå¹¶ä¸”é€šè¿‡ RPC æ¥è®¿é—®è¿™äº›æ•°æ®ã€‚</li><li>åº”ç”¨çš„ In-Process Cacahe. è¿™ä¸ªå’Œä¸Šé¢çš„ Look-Aside Cache æ˜¯ä¸€ä¸ªç›¸å¯¹çš„æ¦‚å¿µï¼Œå› ä¸ºå¯¹ä¸€äº› app æ¥è¯´ï¼Œå®ƒè‡ªå·±éœ€è¦ç¼“å­˜éƒ¨åˆ†æ•°æ®ï¼Œæ¯”å¦‚ client sessionã€‚</li><li>æœºå™¨å­¦ä¹ æ¨¡å‹ç¼“å­˜</li><li>å­˜å‚¨é›†ç¾¤ç¼“å­˜ã€‚Facebook ä½¿ç”¨å¤§é‡çš„ HDD ä½œä¸ºç¼“å­˜ï¼Œéƒ¨åˆ†æ—¶å€™å¯èƒ½å¸Œæœ›å‰å°èƒ½å¤Ÿç¼“å­˜åœ¨æœºå™¨çš„ SSD ä¸­ã€‚</li><li>æ•°æ®åº“çš„é¡µç¼“å­˜ã€‚è¿™ä¸ªéœ€è¦å’Œ DB çš„é€»è¾‘å¼ºç›¸å…³ã€‚</li></ul><p>åœ¨æ•°æ®ç‰¹å¾ä¸Šï¼Œè¿™äº›ä¹Ÿå‘ˆç°å‡ºå¾ˆå¤šä¸åŒï¼š</p><ol><li>æ•°æ®çš„å†·/çƒ­æ˜¯ä¸åŒçš„ï¼Œå°éƒ¨åˆ†æ•°æ®<em>å¯èƒ½</em>æ‰¿æ‹…äº†å¤§éƒ¨åˆ†æµé‡ã€‚</li><li>æ•°æ®çš„å†·/çƒ­å˜æ›´çš„å¾ˆå¿«</li><li>æš´è¯»çš„æƒ…å†µå¾ˆå¤š</li><li>éœ€è¦ç¼“å­˜çš„å¯¹è±¡æ¶µç›–äº†ä¸åŒçš„å¤§å°èŒƒå›´</li></ol><p>å…³äºå†·çƒ­æ•°æ®æƒ³å¿…ä¸ç”¨èµ˜è¿°ã€‚å†·çƒ­å˜åŒ–å¯ä»¥è§ä¸‹å›¾ï¼š</p><p><img src="https://image.mwish.me/blog-image/1A05F9DE-7B74-491C-816A-81F3A1A37635.png" alt="1A05F9DE-7B74-491C-816A-81F3A1A37635"></p><p>å¯ä»¥çœ‹åˆ°ç³»ç»Ÿçš„å†·çƒ­å˜åŒ–è¶‹åŠ¿ã€‚å¯¹è±¡å¤§å°å’Œæš´è¯»æƒ…å†µä¹Ÿå¦‚å›¾ï¼š</p><p><img src="https://image.mwish.me/blog-image/0DFC5D36-0D63-4149-8CD4-332E3B0A2F79.png" alt="0DFC5D36-0D63-4149-8CD4-332E3B0A2F79"></p><p><img src="https://image.mwish.me/blog-image/D4234985-A56F-45BF-AE1B-931D56D2C999.png" alt="D4234985-A56F-45BF-AE1B-931D56D2C999"></p><p>ç›¸å¯¹æ¥è¯´è¿™äº›ä¸œè¥¿éœ€è¦å†™å¾ˆå¤šç›¸åŒçš„ç¼“å­˜é€»è¾‘ï¼šæ¢å‡ºç­–ç•¥ï¼Œå†…å­˜ä½¿ç”¨ï¼Œå¤„ç† empty cache ç­‰ï¼Œæ‰€ä»¥ Facebook é€ äº†ä¸€å¥—é€šç”¨çš„ CacheLibï¼Œç”¨æ¥èŠ‚çœå›¢é˜Ÿé€ è½®å­çš„åŠŸå¤«ã€‚</p><p>åŒæ—¶ï¼Œå¾ˆé‡è¦çš„ä¸€ç‚¹æ˜¯å¯¹äº Flash çš„ä½¿ç”¨ã€‚ç”¨ SSD/Flash å½“ç¼“å­˜ï¼Œç›¸å¯¹æ¥è¯´èƒ½å¤Ÿæä¾›è¾ƒä½çš„æˆæœ¬ï¼Œå’Œå¯ä»¥æ¥å—çš„æ€§èƒ½ã€‚ç›¸å¯¹ DRAMï¼Œæœºå™¨ä¸€èˆ¬ä¼šæä¾›æ›´å¤§çš„ç›˜ï¼ŒåŒæ—¶ï¼ŒSSD ä¹Ÿä¼šæä¾›æ›´ä½çš„æˆæœ¬å’Œæ›´å¯æ¥å—çš„æ€§èƒ½ã€‚è¿™å¥—åŠŸèƒ½åœ¨ CacheLib ä¸­å«åš HybridCacheï¼ŒCacheLib å…è®¸æŒ‡å®šå­˜å‚¨è®¾å¤‡ã€‚</p><p>ç›®å‰ Facebook çš„ CacheLib ä½¿ç”¨ç‡ï¼š</p><p><img src="https://image.mwish.me/blog-image/3ED5DCBC-9E46-4FA0-83D4-48BA6397DE57.png" alt="3ED5DCBC-9E46-4FA0-83D4-48BA6397DE57"></p><h3 id="Cache-Interface"><a href="#Cache-Interface" class="headerlink" title="Cache Interface"></a>Cache Interface</h3><p>CacheLib å¯¹å¤–æä¾›çš„æ˜¯ byte-addressable çš„å¯¹è±¡å’Œ cacheã€‚å®ƒæä¾›äº†ä¸€å¥—çº¿ç¨‹å®‰å…¨çš„ apiï¼Œæ¥å¤„ç†å¯¹åº”çš„é€»è¾‘ï¼š</p><p><img src="https://image.mwish.me/blog-image/25B03CAE-7B60-404A-B074-05D202590977.png" alt="25B03CAE-7B60-404A-B074-05D202590977"></p><p>æ­¤å¤–ï¼ŒCacheLib è¿˜ç»™è‡ªå®šä¹‰çš„ Serialize/Deserialize å®šä¹‰äº†æ¥å£ï¼Œä»¥ä¾¿ç”¨æˆ·å¡ä¸€äº›è‡ªå®šä¹‰ç»“æ„ä½“ã€‚</p><h3 id="Cache-Storage"><a href="#Cache-Storage" class="headerlink" title="Cache Storage"></a>Cache Storage</h3><p>CacheLib å°†ç¼“å­˜åˆ†ä¸ºäº†å‡ éƒ¨åˆ†ï¼š</p><ol><li>DRAM Cache</li><li>LOC (Large Object Cache)</li><li>SOC (Small Object Cache)</li></ol><p><img src="https://image.mwish.me/blog-image/7185D48C-6C32-4445-B318-E9117C0C5763.png" alt="7185D48C-6C32-4445-B318-E9117C0C5763"></p><p>ç”³è¯·çš„å†…å­˜ä¼šå‡ºç°åœ¨ DRAM cache ä¸­ï¼Œè®ºæ–‡ä½¿ç”¨ chained hash æ¥å­˜æ”¾ DRAM Cacheï¼ŒåŒæ—¶å¯ä»¥è‡ªå·±é…ç½®æ¢å‡ºçš„ç­–ç•¥ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œç»™å†…å­˜ä¸­çš„ç¼“å­˜å¯ä»¥é…ç½® Poolï¼Œæ¯ä¸ª Pool å¯ä»¥è‡ªå·±è®¾ç½®æ¢å‡ºç­–ç•¥ç­‰ã€‚æ„Ÿè§‰è¿™ç›¸å½“äºäº¤ç»™ç”¨æˆ·è‡ªå·±ç®¡ç†å†…å­˜ä½¿ç”¨æ–¹å¼äº†ã€‚</p><p>è¿™é‡Œä½¿ç”¨äº† slab classes ç®¡ç†å†…å­˜ï¼Œè¿™é‡Œ CacheLib è‡ªå·±å®ç°äº†ä¸€å¥—èŠ‚çœç©ºé—´çš„ slab allocatorï¼Œç„¶åå¯¹é‡Œé¢çš„å¹¶å‘è¿›è¡Œäº†ä¼˜åŒ–ã€‚</p><p><img src="https://image.mwish.me/blog-image/7B6C9AB9-0FE1-46EF-95AF-3BDF9DCB6EC5.png" alt="7B6C9AB9-0FE1-46EF-95AF-3BDF9DCB6EC5"></p><p>å½“å¯¹è±¡ä» DRAM ç¼“å­˜ä¸­ evict çš„æ—¶å€™ï¼Œä¼šæŒ‰ç…§ä¸€å®šçš„ç­–ç•¥å†³å®šæ˜¯æ¢åˆ° Flash ä¸­è¿˜æ˜¯ Expireã€‚ä½œä¸ºé»˜è®¤ç­–ç•¥ï¼ŒCacheLib ä¼šå›ºå®šæŒ‰ç…§æ¦‚ç‡ $p$ æ¥å†³å®šæ˜¯å¦ä» DRAM ä¸­æ¥æ”¶æ•°æ®ã€‚</p><p>Flash ä¸Šçš„å­˜å‚¨åŒºåˆ†äº†å¤§å°å¯¹è±¡çš„å­˜å‚¨ï¼Œå¤§å¯¹è±¡æ˜¯æŒ‡ä¸å°äº 2kB çš„å¯¹è±¡ï¼Œå°å¯¹è±¡åˆ™è‡ªç„¶æŒ‡çš„æ˜¯å°äº 2kB çš„å¯¹è±¡ã€‚å› ä¸º SSD çš„ç‰¹æ€§ï¼Œè¿™ä¸¤ç§å¯¹è±¡éœ€è¦æœ‰ä¸åŒçš„å¤„ç†æ–¹å¼ã€‚</p><h3 id="LOC-å†…å­˜ç´¢å¼•-SSD"><a href="#LOC-å†…å­˜ç´¢å¼•-SSD" class="headerlink" title="LOC: å†…å­˜ç´¢å¼• + SSD"></a>LOC: å†…å­˜ç´¢å¼• + SSD</h3><p>LOC å­˜å‚¨çš„éƒ½æ˜¯ 2kB ä»¥ä¸Šçš„å¯¹è±¡. ä½œè€…è®¤ä¸ºï¼Œè¿™äº›å¤§å¯¹è±¡è®©ç”¨æˆ·èƒ½å¤Ÿåœ¨å†…å­˜ä¸­æ”¾ç½®è¿™äº›å¯¹è±¡çš„ Indexã€‚å…·ä½“çš„å¯¹è±¡æŒ‰ç…§ 4kb çš„å¤§å°å¯¹é½ã€‚è®ºæ–‡ç”¨äº† 4Bytes çš„å¤§å°å®šä½è¿™éƒ¨åˆ†çš„æ•°æ®ï¼š4bytes æœ€å¤§èƒ½è¡¨ç¤º $2^{32}$  ä¸ªæ•°æ®ï¼Œå¯ä»¥æ”¾ 16T çš„æ•°æ®äº†ã€‚</p><p>LOC çš„å†…å­˜ç´¢å¼•å­˜å‚¨ <code>&lt;Key, Location&gt;</code>ï¼ŒLOC ä¼šä¸»åŠ¨æŠŠ SSD åˆ’åˆ†æˆä¸åŒçš„åŒºåŸŸï¼Œæ ¹æ®è¿™ä¸ªæ¥åˆ¤æ–­å¤§å°ã€‚ç„¶å LOC å¯¹è±¡çš„åœ°å€ä¼šå¯¹é½ 4kBï¼Œè¿™å¤§æ¦‚æ˜¯ä¸€ä¸ª SSD Page çš„å¤§å°ï¼Œè¿™æ ·èƒ½å¤Ÿä¿è¯ï¼š</p><ol><li>ä¸€ä¸ª SSD Page ä¸ä¼šå­˜å‚¨è¿‡å¤šçš„å¯¹è±¡</li><li>åœ°å€å¯¹é½ 4kBï¼Œå‡å°åœ°å€å¯¹è±¡çš„å¼€é”€ã€‚</li></ol><p>åŒæ—¶ï¼Œå¦‚æœå¯¹è±¡å¾ˆå¤§ï¼Œé‚£ä¹ˆå®ƒä¼šè¿ç»­è·¨å¤šä¸ªé¡µã€‚éœ€è¦æŠŠä»–ä»¬éƒ½è¯»èµ·æ¥ã€‚</p><p>å¦‚æœä¸€ä¸ª cache read è¯»å–æœ‰ä¸€ä¸ªç›¸åŒçš„ hash keyï¼Œè¿™é‡Œä¼šæŠŠ Flash ä¸­çš„å…ƒæ•°æ®è¯»èµ·æ¥ã€‚è¿™é‡Œåœ¨å…ƒæ•°æ®ä¸Šéœ€è¦å­˜å‚¨å¯¹åº”çš„ keyã€‚ç„¶åæŠŠè¿™ä¸ª key è·Ÿç”¨æˆ·è¯·æ±‚çš„çœŸå® key æ¯”è¾ƒï¼Œåˆ¤æ–­å…·ä½“æ˜¯å¦å‘½ä¸­ç¼“å­˜ã€‚</p><p>è¿™é‡Œè¿˜æœ‰ä¸€ä¸ª Erase ç›¸å…³çš„ä¼˜åŒ–ã€‚LOC çš„ Erase æ˜¯ä»¥ Block ä¸ºå•ä½çš„ï¼Œå®ƒé»˜è®¤ 16MBï¼Œä½†æ˜¯æ˜¯å¯é…ç½®çš„ã€‚è¿™å®é™…ä¸Šç›¸å½“äº æŠ¹å» SSD çš„ Blockï¼Œé€šè¿‡è¿™ç§æ–¹å¼æ¥å¢åŠ å†™çš„é¡ºåºå†™ã€‚å¦‚æœæ·˜æ±°å‡ºçš„å¯¹è±¡æ˜¯ä¸€ä¸ªæ¯”è¾ƒçƒ­çš„å¯¹è±¡ï¼Œå¯èƒ½ä¼šé‡æ–°åŠ å…¥ cache ä¸­ã€‚</p><h3 id="SOC-Page-å­˜å‚¨"><a href="#SOC-Page-å­˜å‚¨" class="headerlink" title="SOC: Page å­˜å‚¨"></a>SOC: Page å­˜å‚¨</h3><p>SOC å­˜å‚¨å¾ˆå¤šå°å¯¹è±¡ï¼Œå¦‚æœåƒ LOC ä¸€æ ·å­˜å‚¨å®ƒä»¬çš„ç´¢å¼•ï¼Œç³»ç»Ÿæ•´ä¸ª DRAM å¼€é”€ä¼šéå¸¸å¤§ã€‚æ‰€ä»¥ SOC ä½¿ç”¨äº†ä¸€ä¸ªè¿‘ä¼¼çš„ç´¢å¼•æ¥å®ç°å¯¹åº”çš„é€»è¾‘ã€‚</p><p>SOC æŠŠå°å¯¹è±¡åˆ’åˆ†æˆå¾ˆå¤š setsï¼Œæ¯ä¸ªåŒ…å«ä¸€ä¸ª 4kB pageï¼ŒæŒ‰ç…§ FIFO å­˜å‚¨å¯¹è±¡ã€‚æ¯ç»„æœ‰ä¸€ä¸ª 8Bytes çš„ bloom filterã€‚è¿™é‡ŒæŠŠ key æŸ¥ä¸€ä¸‹ Bloom Filterï¼Œå¦‚æœä¸å­˜åœ¨åˆ™è¿”å›ä¸å­˜åœ¨ï¼Œå¦åˆ™è¯»å–æ•´ä¸ª Page å¹¶é¡ºåºæ‰«æã€‚</p><p><img src="https://image.mwish.me/blog-image/1C5A507951DF45CBC6DCF62B6D5A2AC4.png" alt="1C5A507951DF45CBC6DCF62B6D5A2AC4"></p><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>CacheLib è®ºæ–‡æ„Ÿè§‰ä¸»è¦è¿˜æ˜¯è¯´è¿™ç©æ„çš„å¿…è¦æ€§ï¼Œå…³äºç»†èŠ‚è®²çš„æ¯”è¾ƒå°‘ï¼Œå†…å­˜éƒ¨åˆ†æå†™æ¯”è¾ƒç»†ï¼ˆä½†æ˜¯è¿™åº”è¯¥æ˜¯ä¸€ä¸ªå¾ˆè€çš„ä¸»é¢˜ï¼‰ï¼ŒFlash éƒ¨åˆ† LOC æ„Ÿè§‰å†™çš„ç»†ä¸€ç‚¹ï¼ŒSOC æ ¹æœ¬ä¸èƒ½ç»†æƒ³ã€‚ä¸è¿‡è¿™ç¯‡æ–‡ç« ç¡®å®ä»‹ç»äº†ï¼Œç›¸å¯¹äº RocksDBï¼Œä¸ºä»€ä¹ˆéœ€è¦ SSD ç¼“å­˜ã€‚</p><p>è®ºæ–‡ç»å¤§éƒ¨åˆ†ç¯‡å¹…è®²çš„æ˜¯å¿…è¦æ€§å’Œå·¥ç¨‹ä¼˜åŒ–ï¼Œå¯ä»¥çœ‹åˆ° Facebook ç¡®å®æŠ çš„å¾ˆç»†ï¼Œä½†æ˜¯æˆ‘çœ‹äº†çœ¼ä»£ç ï¼Œæ„Ÿè§‰ Slab è¿™äº›ä¼˜åŒ–éƒ½å®ç°äº†ï¼ŒFlash éƒ¨åˆ†æ²¡çœ‹åˆ°è¿™äº›ä¸œè¥¿å­˜åœ¨â€¦</p><h2 id="Kangaroo-Caching-Billions-of-Tiny-Objects-on-Flash"><a href="#Kangaroo-Caching-Billions-of-Tiny-Objects-on-Flash" class="headerlink" title="Kangaroo: Caching Billions of Tiny Objects on Flash"></a>Kangaroo: Caching Billions of Tiny Objects on Flash</h2><p>è¿™ç¯‡æ˜¯ CMU + Facebook + MSR/UW ä¸€èµ·å†™çš„ï¼Œä¸çŸ¥é“æ˜¯ä¸æ˜¯å› ä¸º Cache SSD åƒä¸€ä¸ªé¦™é¥½é¥½ã€‚ä½†æ˜¯è¿™ç¯‡æ–‡ç« æ„Ÿè§‰æ¯” CacheLib è¿™ç¯‡è¯¦å®äº†å¾ˆå¤šï¼Œç¡®å®åƒä¸ªæ­£ç»ç ”ç©¶äº†ã€‚</p><p>Kangaroo çš„è½è„šç‚¹åœ¨å°å¯¹è±¡ä¼˜åŒ–ä¸Šï¼Œè®ºæ–‡è€ƒå¯Ÿäº† SSD çš„ä¸‹é¢å‡ ä¸ªç»´åº¦ï¼š</p><ul><li>å†™æ”¾å¤§<ul><li>æ¥è‡ª SSD çš„å†™æ”¾å¤§</li><li>æ¥è‡ªåº”ç”¨çš„å†™æ”¾å¤§</li></ul></li><li>å†…å­˜å¼€é”€</li><li>SSD ç©ºé—´å¼€é”€</li></ul><p>ç„¶åé‡‡ç”¨äº†æƒè¡¡çš„ç­–ç•¥ï¼Œå¹¶ç»“åˆ SSD çš„ç‰¹ç‚¹æ¥é€‰å‡ºäº†ä¸€ä¸ªå¾ˆä¼˜çš„ç»“æ„ã€‚</p><p>è®ºæ–‡è®¤ä¸ºï¼ŒæŠŠ SSD ä½œä¸ºç¼“å­˜æœ‰ä¸‹åˆ—å‡ ç§ Pattern:</p><ol><li>Log Structure + Index</li><li>Set-associative</li></ol><p>Log + Index é€šå¸¸æ˜¯ï¼Œæ”¶åˆ°ä¸€ä¸ªå°å¯¹è±¡çš„æ—¶å€™ç¼“å­˜ä¸‹æ¥ï¼Œç›´åˆ°è¾¾åˆ°ä¸€ä¸ª Pageï¼ˆæˆ–è€…æ•°ä¸ª Pageï¼‰ çš„å¤§å°ï¼Œç„¶åé¡ºåºçš„ Log è¿™ä¸ª Pageã€‚è€ƒå¯Ÿè¿™ç§æ–¹å¼çš„æ—¶å€™ï¼Œæˆ‘ä»¬ä¼šå‘ç°ï¼Œå®ƒæœ‰ç€ä¸é”™çš„å‰å°å†™æ€§èƒ½ï¼Œä½†æ˜¯ (1) ä¼šéœ€è¦æ¯”è¾ƒå¤§çš„å†…å­˜ç´¢å¼• (2) æœ‰å¯èƒ½éœ€è¦ GC ç­‰æ–¹å¼å›æ”¶ç©ºé—´ã€‚è®ºæ–‡ä½œè€…ç€é‡å¼ºè°ƒäº†ç´¢å¼•æ–¹é¢çš„é—®é¢˜ã€‚</p><p>Set-associative ä»¥ç±»ä¼¼ CPU-Cache çš„ç»„ç›¸è”çš„æ–¹å¼ç»„ç»‡ï¼Œè¿™ç§æ–¹å¼å°† SSD åˆ†ä¸ºå‡ ä¸ªéƒ¨åˆ†ï¼Œç„¶å <code>hash(key)</code> æ‰¾åˆ°å¯¹åº”çš„éƒ¨åˆ†ï¼ŒæŸ¥çœ‹ key æ˜¯å¦å­˜åœ¨äºå…¶ä¸­ã€‚è¿™ç§æ–¹å¼ä¼šæœ‰éå¸¸ä¸¥é‡çš„å†™æ”¾å¤§ï¼Œå› ä¸ºå¯ä»¥çœ‹åˆ°ï¼Œå¾ˆå¤šæƒ…å†µä¸‹ï¼Œå¯¹å®ƒçš„å†™å…¥éƒ½ä¼šå˜æˆéšæœºå†™ã€‚</p><p><img src="https://image.mwish.me/blog-image/0F046C8B-4D21-4D87-907F-4F943CF45656.png" alt="0F046C8B-4D21-4D87-907F-4F943CF45656"></p><p>Kangaroo é€‰ç”¨äº†å¤§éƒ¨åˆ† cache ç©ºé—´ç”¨ä½œ set-associative cache ï¼Œå¹¶ç§°å…¶ä¸º <strong>KSet</strong>ï¼Œç„¶åæ‹¿ä¸€ä¸ªå°éƒ¨åˆ†çš„ç¼“å­˜ä½œä¸º Log + Index çš„ç¼“å­˜ <strong>KLog</strong>ï¼Œä½œä¸º KSet çš„å†™å…¥å‰å°ã€‚KLog æ¯æ¬¡æŠŠåŒä¸€ç»„çš„æ•°æ®ä¸€èµ·ä¸¢åˆ° KSet é‡Œï¼Œç”¨ batch çš„æ–¹å¼ä¼˜åŒ–äº† KSet çš„å†™æ”¾å¤§ã€‚</p><p>Kangaroo çš„è®¾è®¡æœ‰å‡ ä¸ª Key-Point:</p><ol><li>ä½¿ç”¨ <em>partitioned index</em>ï¼Œæ¥ä½¿ KLog-&gt;KSet çš„æ•°æ®å¤„äºåŒä¸€ä¸ª KSet çš„ Set</li><li>Kangaroo å¯ä»¥ drop æ‰ valueï¼Œ<strong>å®ƒä¸æ˜¯ kv</strong>ï¼Œåªæ˜¯ä¸€ä¸ªç¼“å­˜ï¼ŒKLog é‡Œé¢çš„å†…å®¹ç”šè‡³å¯ä»¥ä¸å†™å…¥ KSetï¼Œè¿™å¯ä»¥ç”±æŸä¸ªç­–ç•¥æ¥å†³å®šã€‚Kangaroo å®ç°äº† threshold admissionï¼Œæ¥å†³å®šæ˜¯å¦è¦æ¥çº³ KLog æ·˜æ±°ä¸‹æ¥çš„å€¼ã€‚</li><li>Kangaroo æå‡ºäº†æ–°çš„é’ˆå¯¹ KSet çš„æ¢å‡ºç­–ç•¥æ¥è¿›è¡Œä¼˜åŒ–</li></ol><h3 id="SSD-çš„å†™æ”¾å¤§"><a href="#SSD-çš„å†™æ”¾å¤§" class="headerlink" title="SSD çš„å†™æ”¾å¤§"></a>SSD çš„å†™æ”¾å¤§</h3><p>è®ºæ–‡é‡Œå°† SSD çš„å†™æ”¾å¤§åˆ†ä¸ºäº†ä¸‹é¢ä¸¤ç§ï¼š</p><ul><li>Device-level write amplification (DLWA)ï¼šSSD Erase/GC ç­‰å¸¦æ¥çš„å†™æ”¾å¤§ã€‚éšæœºå†™ä¼šä½¿ DLWA æ¶åŒ–ï¼Œä»è€Œéœ€è¦é…ç½®æ›´å¤šçš„ OPã€‚</li><li>Application-level write amplification (ALWA)ï¼šå½“åº”ç”¨é‡å†™è‡ªå·±çš„ Page ç­‰å†…å®¹çš„æ—¶å€™ï¼Œä¾‹å¦‚ LSM-Tree Compactionã€‚ </li></ul><p>å®é™…ä¸Šï¼ŒCacheLib çš„ç­–ç•¥åœ¨ DLWA å’Œ ALWA ä¸Šéƒ½æ˜¯å¾ˆå·®åŠ²çš„ï¼Œå› ä¸ºå®ƒä¼šé€ æˆéå¸¸å¤šçš„éšæœºå†™ï¼Œå’Œåå¤é‡å†™ Pageã€‚Kangaroo å¯ä»¥é  Grouping/Batching æ¥ä¼˜åŒ–å®ƒã€‚</p><h3 id="Log-structuredcaches-amp-Set-associative-flash-caches"><a href="#Log-structuredcaches-amp-Set-associative-flash-caches" class="headerlink" title="Log-structuredcaches &amp; Set-associative flash caches"></a>Log-structuredcaches &amp; Set-associative flash caches</h3><h3 id="Kangaroo-æµç¨‹"><a href="#Kangaroo-æµç¨‹" class="headerlink" title="Kangaroo æµç¨‹"></a>Kangaroo æµç¨‹</h3><p><img src="https://image.mwish.me/blog-image/D8DAFE57-3708-4971-8E01-CE5F57D41163.png" alt="D8DAFE57-3708-4971-8E01-CE5F57D41163"></p><h4 id="å†™å…¥"><a href="#å†™å…¥" class="headerlink" title="å†™å…¥"></a>å†™å…¥</h4><p>è¿™é‡Œçš„å†…å®¹é¦–å…ˆä¼šè½åˆ° DRAM cache ä¸­ï¼Œéšç€ DRAM cache evictï¼Œå®ƒä¼šæŒ‰ç…§ä¸€å®šæ¦‚ç‡è¿›å…¥ KLogã€‚å†™å…¥ KLog çš„æ—¶å€™ï¼Œè¿™é‡Œä¼šå¾€ KLog ä¸­æ’å…¥å¯¹åº”çš„å¯¹è±¡ï¼Œç„¶ååœ¨ KLog Index ä¸­æ’å…¥å¯¹åº”çš„æ¡ç›®ã€‚KLog å¤§æ¦‚å æ•´ä¸ª Flash å­˜å‚¨ç©ºé—´çš„ 5%ã€‚éšç€å†™å…¥ï¼Œè®°å½•å¯èƒ½ä¼šè¢« batch æ·˜æ±°åˆ° KSet ä¸­ï¼Œç„¶åå†™å…¥å¯¹åº”çš„ Bloom Filterã€‚</p><h4 id="è¯»å–"><a href="#è¯»å–" class="headerlink" title="è¯»å–"></a>è¯»å–</h4><ol><li>å…ˆä» DRAM Cache ä¸­æŸ¥è¯¢å†…å®¹ï¼Œå¦‚æœå­˜åœ¨åˆ™è¿”å›</li><li>ä» KLog Index ä¸­æŸ¥è¯¢å†…å®¹ï¼Œå¦‚æœæŸ¥è¯¢åˆ°åˆ™è¿›å…¥ KLog æŸ¥æ‰¾</li><li>å¦‚æœä¸å­˜åœ¨ï¼Œåˆ™è¿›å…¥ KSetï¼Œä» Bloom Filter æ‰¾åˆ°å¯¹åº”çš„å†…å®¹ï¼Œå¦‚æœå­˜åœ¨åˆ™è¿›å…¥ KSet å¯»æ‰¾</li></ol><h3 id="KLog"><a href="#KLog" class="headerlink" title="KLog"></a>KLog</h3><p>KLog æœ‰ä¸€ä¸ªæ¦‚ç‡ $p$ï¼Œå‰æ¥çš„å¯¹è±¡åªæœ‰è¿™ä¸ªæ¦‚ç‡èƒ½è¿›å…¥ kangarooã€‚ç›¸æ¯”ä¹‹å‰ CacheLib çš„è®¾è®¡ï¼Œç”±äº Batching å†™å…¥çš„ä¼˜åŒ–ï¼ŒKangaroo å¤§éƒ¨åˆ†æ—¶å€™ä¸ä¼š discard æ‰å¯¹è±¡ã€‚</p><p>KLog çš„ç›®æ ‡æ˜¯ï¼Œé™ä½æ•´ä½“çš„ ALWAï¼ŒåŒæ—¶ä¸å¢å¤§å†…å­˜çš„å¼€é”€ã€‚å®ƒéœ€è¦æ”¯æŒä¸‹é¢çš„æ“ä½œï¼š</p><ul><li><code>LOOKUP</code></li><li><code>INSERT</code></li><li><code>Enumerate-Set</code>: ä½¿ KLog å¯»æ‰¾å‡ºæ‰€æœ‰æ˜ å°„åˆ°åŒä¸€ä¸ª KSet çš„å¯¹è±¡ã€‚</li></ul><p><img src="https://image.mwish.me/blog-image/649629DA-4FBE-4ABE-9CE2-39BD17584712.png" alt="649629DA-4FBE-4ABE-9CE2-39BD17584712"></p><p>ä¸ºäº†é«˜æ•ˆæ”¯æŒ <code>Enumerate-Set</code>ï¼ŒKLog çš„å†…å­˜ Index è¢«è®¾è®¡ä¸º Bucket + Chain hashingã€‚è¿™é‡Œä¼šè®©åœ¨åŒä¸€ä¸ª KSet çš„é›†åˆçš„å¯¹è±¡è½åˆ°åŒä¸€ä¸ªå†…å­˜ä¸­çš„ Bucketã€‚</p><p>è¿™é‡Œ KLog Index çš„ç»“æ„å¯è§äºä¸‹é¢çš„ Table1ï¼Œæ¯ä¸ª Item éœ€è¦ï¼š</p><ol><li>offset, æ ‡ç¤ºåœ¨ KLog çš„ Log ç¯ä¸Šå­˜å‚¨çš„ä½ç½®</li><li>Tagï¼Œkey hash æœ‰å…³çš„å€¼ï¼Œå®é™…ä¸Šå¸®åŠ©æˆ‘ä»¬æ¨æ–­æœ€ç»ˆè¿™ä¸ªæ¡ç›®ä¼šæ˜ å°„åˆ°å“ªä¸€ä¸ª KSet çš„ Page ä¸Š</li><li>Next-pointer: æŒ‡å‘ bucket å†…çš„ä¸‹ä¸€ä¸ª Item</li></ol><p><img src="https://image.mwish.me/blog-image/8B23F7BC-4387-4F5E-A8EB-63933FE258A7.png" alt="8B23F7BC-4387-4F5E-A8EB-63933FE258A7"></p><p>å¯ä»¥çœ‹åˆ°ï¼Œåœ¨ size ä¸Šï¼Œè®ºæ–‡å¯¹è¿™å‡ ä¸ªå¿…é¡»çš„ç»“æ„çš„å¤§å°åšå‡ºäº†ä¼˜åŒ–ï¼Œä½¿å¾—å®ƒä»¬å ç”¨äº†æ›´å°çš„å†…å­˜ç©ºé—´ã€‚ä¸è¿‡å¤§æ¦‚çš„æ€è·¯è¿˜æ˜¯ä¸€è‡´çš„ï¼š</p><ol><li>Lookup: æ‰¾åˆ°å¯¹åº”çš„ bucketï¼Œç„¶åå¿½ç•¥æ‰ invalid itemï¼Œæ ¹æ® <code>tag</code> æ‰¾åˆ°å¯¹åº”çš„ keyã€‚å¦‚æœæ²¡æ‰¾åˆ°ï¼Œè¿”å› Missï¼Œå¦åˆ™æ ¹æ® offsetï¼Œåœ¨ Log ä¸Šå¯»æ‰¾ï¼Œç„¶åéªŒè¯æ•´ä¸ª key ä¸‹ç›˜ä¸Šçš„ log æ˜¯ä¸€è‡´çš„ã€‚KLog åœ¨ Index ä¸Šæ›´æ–° evict ç›¸å…³çš„å…ƒæ•°æ®ã€‚</li><li>Insert: æ’å…¥ Indexï¼Œç„¶åæŠŠå¯¹è±¡æ’å…¥ DRAM Bufferã€‚Buffer ä»¥å•ä¸ª/å¤šä¸ª Page çš„ä¸€ä¸ª Segment ä¸ºç²’åº¦ï¼Œä¿è¯å®ƒæ˜¯è¿ç»­çš„ã€‚ç­‰åˆ°å†™æ»¡ Buffer çš„æ—¶å€™ï¼ŒLog åˆ°å­˜å‚¨ä¸Šã€‚</li><li>Enumerate-Set: åœ¨åŒä¸€ä¸ª bucket é‡Œé¢ï¼Œæ‰¾åˆ°åœ¨åŒä¸€ä¸ª Set ä¸­çš„å¯¹è±¡ã€‚</li></ol><p>æ­¤å¤–ï¼Œå¦‚å›¾æ‰€ç¤ºï¼Œè¿™é‡ŒæŒ‰ç…§ KSet çš„å¸ƒå±€ï¼Œåˆ†æˆäº†ä¸åŒçš„ <em>partition index</em>ï¼Œæ¯ä¸ª <em>partition index</em> æœ‰ç‹¬ç«‹çš„ DRAM å’Œ Flash ç©ºé—´ã€‚è¿™ç§ç»“æ„å¸Œæœ›èƒ½å¤Ÿå°† KLog å’Œ KSet ç»“æ„æ•´åˆæ›´åŠ ç´§å¯†ï¼ŒåŒæ—¶ï¼Œåœ¨ç»“æ„è®¾è®¡ä¸Šï¼Œä½œè€…å¯ä»¥ç”¨ä¸€å®šçš„ Hack å‡å°‘å†…å­˜å¼€é”€ï¼ˆè§è®ºæ–‡ 4.2ï¼‰ã€‚è®ºæ–‡æŠŠå•ä¸ª Item å‹ç¼©åˆ°äº† 48bitsï¼Œç»™ Index çœäº†å¾ˆå¤§çš„ DRAM ç©ºé—´ã€‚</p><h3 id="KLog-â†’-KSet"><a href="#KLog-â†’-KSet" class="headerlink" title="KLog â†’ KSet"></a>KLog â†’ KSet</h3><p>KLog çš„å†™æ”¾å¤§ä¸æ˜¯ä»€ä¹ˆé—®é¢˜ï¼Œæˆ‘ä»¬å›é¡¾ä¸€ä¸‹ï¼Œå®ƒçš„å‰å°å‡ ä¹æ²¡æœ‰ä»€ä¹ˆå†™æ”¾å¤§ï¼Œå†™çš„è¯å°å¯¹è±¡ä¼šå¡«å……å®Œ Page å†å†™ã€‚ALWA å’Œ DLWA éƒ½ä¼šå¾ˆå°ã€‚ä¸ºäº†å‡å°  KSet çš„å†™æ”¾å¤§ï¼Œè¿™é‡Œéœ€è¦ batching å¯¼å…¥ KSetã€‚åŒæ—¶ï¼Œè¿™é‡Œéœ€è¦äº†è§£ï¼ŒKSet æ˜¯å¯ä»¥ Reject å†™å…¥çš„ã€‚</p><p>Kangaroo æœ‰ä¸€ä¸ªåå°çº¿ç¨‹ä¼šä¿è¯æ¯ä¸ª <em>partition index</em> æœ‰ä¸€ä¸ªç©ºä½™çš„ç©ºé—´ï¼Œä¾› Buffer Log å†™å…¥ã€‚KLog ä¼šä»¥ Segment çš„å½¢å¼æ¥ evictï¼Œè¿™é‡Œæµç¨‹å¦‚ä¸‹ï¼š</p><ol><li>å¯¹ Segment ä¸­çš„æ¯ä¸ªå¯¹è±¡ï¼Œä¼šè°ƒç”¨ <code>Enumerate-Set</code> æ¥æšä¸¾å‡ºåŒä¸€ä¸ª Set çš„æ‰€æœ‰å¯¹è±¡ï¼Œå¹¶å°è¯•å†™å…¥ KSetã€‚</li><li>å¦‚æœ <code>Enumerate-Set</code> å¯¹è±¡æ²¡æœ‰åˆ°è¾¾ batching å†™å…¥é˜ˆå€¼ï¼Œé‚£ä¹ˆ discard æ‰è¿™ä¸ª Segment ä¸Šçš„è¿™äº›å¯¹è±¡ã€‚å¦‚æœæŸä¸ª discard çš„å¯¹è±¡æ˜¯æ¯”è¾ƒçƒ­çš„å¯¹è±¡ï¼Œé‚£ä¹ˆä¼šé‡æ–°æ’å…¥ KLog ã€‚</li></ol><p>ç³»ç»Ÿåœ¨ (2) ä¸Šæœ‰ä¸€ä¸ªé˜ˆå€¼ã€‚è¿™ä¸ªé˜ˆå€¼ä¼šå½±å“ KSet çš„ ALWAã€‚ç³»ç»Ÿè®¤ä¸ºï¼Œè¿™ä¸ªå€¼åº”è¯¥ä¿è¯ï¼Œåœ¨å¤§å°ä¸Šï¼ŒKLog æ˜¯ KSet çš„ 5% å·¦å³å³å¯ã€‚é˜ˆå€¼å¢å¤§ä¼šé™ä½ ALWAï¼Œä½†æ˜¯ä¼šå¢åŠ  cache-missã€‚</p><h3 id="KSet"><a href="#KSet" class="headerlink" title="KSet"></a>KSet</h3><p><img src="https://image.mwish.me/blog-image/7667364F-F381-4DAB-919F-2157A23B002F.png" alt="7667364F-F381-4DAB-919F-2157A23B002F"></p><p>KSet çš„é€»è¾‘å’Œ CacheLib çš„é€»è¾‘æ˜¯ç›¸åŒçš„ï¼Œä¸åŒçš„æ˜¯ï¼Œè¿™é‡Œé¢å¤–åœ¨å†…å­˜ä¸­ç»´æŠ¤äº†ä¸€ä¸ª RRIP bitsã€‚è¿™ä¸ª RRIP bits ç›¸å½“äºç”¨å¾ˆå°‘çš„ bits ç»´æŠ¤äº†æ’å…¥çš„ä¼˜å…ˆçº§ã€‚</p><p>è¿™é‡Œçš„é€»è¾‘æ¯”è¾ƒåƒ MySQL çš„ç¼“å­˜ replacement ruleï¼Œå®ƒä¼šåœ¨ä¸­é—´ä¸€ä¸ªä½ç½®æ’å…¥ã€‚ç›¸å¯¹äºåŸæœ¬ CacheLib çš„ LOCï¼Œè¿™é‡Œç›¸å½“äºç”¨ batching å†™å…¥ + Cache Replacementï¼Œä¼˜åŒ–äº†å†™æ”¾å¤§å’Œç¼“å­˜å‘½ä¸­ç‡ã€‚</p><p>è¿™ä¸€æ®µä¼˜åŒ–ä¸»è¦åœ¨ RRIP ç®—æ³•ä¸Šï¼Œè¯¦ç»†å¯ä»¥çœ‹è®ºæ–‡çš„ 4.4ã€‚</p><h2 id="æ€»ç»“-1"><a href="#æ€»ç»“-1" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>Kangaroo è¿™ç¯‡è®ºæ–‡çœ‹ä¸Šå»ç§‘å­¦äº†å¾ˆå¤šï¼Œç”¨ Log-Struct å’Œ Set-associate ä¸¤ç§ç»“æ„è®²äº†ä¸€ä¸ªæ¯”è¾ƒåˆç†çš„æ•…äº‹ï¼Œå¹¶ä¸”æ—¢æœ‰ä¸€äº›é‡åŒ–çš„è®¡ç®—ï¼Œä¹Ÿæœ‰ä¸€äº›å®é™…çš„å·¥ç¨‹ä¼˜åŒ–ã€‚ç›¸å¯¹æ¥è¯´ï¼ŒCacheLib çš„è®ºæ–‡è¿˜æ˜¯å¤§éƒ¨åˆ†åœ¨å¹è‡ªå·±çš„åœºæ™¯ï¼Œåªæœ‰ä¸€èŠ‚å«ç³Šè®²äº†ä¸‹å…·ä½“å®ç°ï¼Œè¿™ç¯‡è¿˜æ˜¯åšäº†å¾ˆæ‰å®çš„è®¨è®ºçš„ã€‚</p><p>CacheLib ä¸»åˆ†æ”¯å¹¶æ²¡æœ‰åˆå¹¶ kangaroo æœ‰å…³çš„ä»£ç ï¼Œå…·ä½“çš„çº¿ä¸Šå¯é æ€§è¿˜æœ‰å¾…éªŒè¯ã€‚</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Database Recover System</title>
      <link href="/2021/08/07/Database-Recover-System/"/>
      <url>/2021/08/07/Database-Recover-System/</url>
      
        <content type="html"><![CDATA[<p>å¯¹äºä¸€ä¸ª DB ç³»ç»Ÿè€Œè¨€ï¼Œå¤§æ¦‚è¦è€ƒè™‘è¿™äº›é”™è¯¯ï¼š</p><ol><li>transaction failure<ol><li>Logical error: ä¾‹å¦‚ db çš„èµ„æºä¸å¤Ÿï¼Œè¾“å…¥é”™è¯¯ç­‰é—®é¢˜</li><li>System error:  æ•°æ®åº“ç³»ç»Ÿè¿›å…¥äº†è¯¸å¦‚æ­»é”ä¹‹ç±»çš„çŠ¶æ€</li></ol></li><li>System Crash: ç¡¬ä»¶æ•…éšœæˆ–è€…ç³»ç»Ÿæ•…éšœï¼Œå¯èƒ½å¯¼è‡´æŒä¹…å­˜å‚¨ä¸Šçš„æ•°æ®æŸåã€‚ï¼ˆä¸è¿™ä¸ªç›¸åï¼Œç¨‹åºå´©æºƒä¹‹åï¼Œä¸ä¼šå½±å“æŒä¹…æ•°æ®çš„å‡è®¾ï¼Œæˆä¸º fail-stop assumptionï¼‰ã€‚ç²¾å¿ƒè®¾è®¡çš„ç³»ç»Ÿå³ä½¿å‡ºç°é€»è¾‘ bugï¼Œä¹Ÿä¼šæœ‰ä¸€äº› <code>assert</code> ç­‰æ–¹å¼ï¼Œè®©ç³»ç»Ÿä¸è‡³äºå‡ºç°æ•°æ®æŸåï¼Œæ‰€ä»¥è¿™ä¸ªæ¨¡å‹è¿˜æ˜¯å¯ä¿¡çš„ã€‚</li><li>Disk failure: ç®€å•è¯´å°±æ˜¯ç›˜åäº†ã€‚</li></ol><p>ä»Šå¤©è¿™é‡Œä¸ä¼šä»‹ç» HA å’Œ replica ç›¸å…³çš„å†…å®¹ï¼Œå› æ­¤ï¼Œå¯¹äºç£ç›˜ä¸¢å¤±æ•°æ®æˆ‘ä»¬ç•¥è¿‡ä¸è¡¨ã€‚ç³»ç»Ÿå¸Œæœ›ä»å´©æºƒçš„çŠ¶æ€æ¢å¤çš„è¯ï¼Œåº”è¯¥å¯ä»¥å¾ˆç²—ç³™çš„è¢«åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼š</p><ol><li>ç³»ç»Ÿæ­£å¸¸è¿è¡Œçš„æ—¶å€™éœ€è¦åšçš„äº‹æƒ…ï¼Œç”¨äºåœ¨å‡ºç°æ•…éšœçš„æ—¶å€™ï¼Œæ¢å¤ç³»ç»Ÿçš„çŠ¶æ€</li><li>ç³»ç»Ÿå‡ºç°æ•…éšœåï¼Œæ¢å¤ç³»ç»Ÿçš„çŠ¶æ€ã€‚</li></ol><p>ï¼ˆç³»ç»Ÿçš„çŠ¶æ€å¯ä»¥ç®€å•ç†è§£æˆ ACID æˆ–è€…ç»™ç”¨æˆ·æä¾›çš„è¯­ä¹‰ã€‚ï¼‰</p><h3 id="å­˜å‚¨æ¨¡å‹"><a href="#å­˜å‚¨æ¨¡å‹" class="headerlink" title="å­˜å‚¨æ¨¡å‹"></a>å­˜å‚¨æ¨¡å‹</h3><p>è¿™ä¸ªæ ‡é¢˜åç§°ä¼¼ä¹æœ‰äº›è®©äººå›°æƒ‘ï¼Œä½†å®é™…ä¸Šï¼Œåç»­å¾ˆå¤šç®—æ³•éƒ½éœ€è¦ä¾èµ–ä¸€ä¸ªé è°±çš„å­˜å‚¨å±‚ã€‚å¯¹äºå•æœº RDBMS è€Œè¨€ï¼Œå®ƒæä¾›çš„è¯­ä¹‰å¯èƒ½ç±»ä¼¼ block. å¹¶ä¸”ï¼Œå¯ä»¥ç®€å•æ‹†åˆ†æˆä¸‹é¢å‡ é¡¹ï¼š</p><ol><li>volatile storage</li><li>non-volatile storage</li><li>stable storage</li></ol><p>(1) ç±»ä¼¼äºæˆ‘ä»¬çš„ memory system, (2) å¯ä»¥è§†ä½œç®€å•çš„ç›˜ã€‚(3) æä¾›äº†ä¸€ç§æ•°æ®å¾ˆéš¾ä¸¢å¤±ã€æŸåçš„è¯­ä¹‰ã€‚é€šå¸¸æ¥è¯´ï¼Œéœ€è¦é  RAID/å¤‡ä»½ç­‰æ–¹å¼æ¥å®ç° (3) è¿™æ ·ç¨³å®šçš„å­˜å‚¨/å—å­˜å‚¨è¯­ä¹‰ã€‚åŒæ—¶ï¼Œå†™ç›˜ä¹Ÿå¯èƒ½å‡ºç°é—®é¢˜ï¼Œåœ¨å†™å…¥å­˜å‚¨çš„æ—¶å€™ï¼Œå¯èƒ½æœ‰ä¸‹åˆ—çš„ case:</p><ol><li>sucessful completion</li><li>total failure</li><li>partial failure</li></ol><p>(3) å®é™…ä¸Šæ˜¯å¾ˆå¤šé—®é¢˜çš„æ¥æºï¼Œä¸ºäº†è§£å†³è¿™ç§ caseï¼Œéœ€è¦ CRC/double write ç­‰ä¸åŒæ–¹å¼ã€‚</p><p>ä¸‹é¢è¿™é‡ŒæŠ½è±¡äº†ä¸€ä¸‹å†™ç›˜çš„è¯­ä¹‰ã€‚</p><p><img src="https://image.mwish.me/blog-image/B7CC2AA7-1F2E-4AF0-A477-C69B4143FE4D.png" alt="B7CC2AA7-1F2E-4AF0-A477-C69B4143FE4D"></p><h3 id="Recover-and-Atomicity"><a href="#Recover-and-Atomicity" class="headerlink" title="Recover and Atomicity"></a>Recover and Atomicity</h3><ul><li>Force: äº‹åŠ¡å®Œæˆä¹‹åï¼Œä¿®æ”¹çš„ page æ˜¯å¦å¼ºåˆ¶è¦æ±‚åˆ·ç›˜</li><li>Steal: äº‹åŠ¡å®Œæˆä¹‹å‰ï¼Œèƒ½å¦æŠŠ Page åˆ·ç›˜</li></ul><p><img src="https://image.mwish.me/blog-image/3237a0f02b383bd05a61a0f21696d722119.jpg" alt="3237a0f02b383bd05a61a0f21696d722119"></p><p>ä¸å¦¨çœ‹çœ‹ä¸Šé¢çš„å›¾ï¼Œå®é™…ä¸Šåšäº†ä¸€ä¸ªå¾ˆæ¸…æ™°çš„å®šé‡åˆ†æã€‚ç­‰ç­‰ï¼Œè¿™æ˜¯ä¸æ˜¯è¯´ï¼Œæ²¡æœ‰ log ä¹Ÿè¡Œå‘¢ï¼Ÿ</p><p>å®é™…ä¸Š BoltDB(è™½ç„¶åªæ˜¯ä¸ª kv) å°±æä¾›äº†è¿™æ ·çš„èƒ½åŠ›ï¼Œå®ƒä¸éœ€è¦å†™ walã€‚æœ¬èº«ä¾é  cow æ¥å®ç°è¿™äº›é€»è¾‘ï¼š</p><ol><li>ç³»ç»Ÿé™åˆ¶åªæœ‰ä¸€ä¸ªå†™äº‹åŠ¡</li><li>æ¯æ¬¡ä¿®æ”¹åï¼Œä¼šåœ¨æ–°çš„å­˜å‚¨ç©ºé—´ä¸Šåšå†™å…¥ Page</li><li>commit çš„æ—¶å€™ï¼Œå¼ºåˆ¶åˆ·ç›˜ï¼Œå¹¶ä¸”æ›´æ–° metaï¼Œä¿è¯ä¸‹æ¬¡è¯»åˆ°å¯¹åº”çš„å†…å®¹</li></ol><p>å®é™…ä¸Šï¼Œå®ƒçš„ Recover ä¹Ÿç®€å•ï¼Œçœ‹ä¸€ä¸‹ 2ä¸ªå…ƒæ•°æ®å—æ˜¯å¦æ­£å¸¸ï¼Œä¸¤ä¸ªéƒ½ä¸æ­£å¸¸å°±èŠ‚å“€äº†ï¼Œä¸€ä¸ªä¸æ­£å¸¸æŒ‘æ­£å¸¸çš„ï¼Œä¸¤ä¸ªéƒ½æ­£å¸¸æŒ‘äº‹åŠ¡ id å¤§çš„ã€‚</p><p>å¦‚æœå…è®¸å¹¶å‘å†™çš„è¯ï¼Œé—®é¢˜éœ€è¦éº»çƒ¦å¾ˆå¤šï¼Œæ—©æœŸçš„ sqlite å¯¹è¿™ç§æ¨¡å¼æä¾›äº†æ”¯æŒï¼š</p><ol><li>äº‹åŠ¡ä¼šæŠŠä¿®æ”¹å‰çš„ Page å†™åˆ° Journal File ç©ºé—´ä¸Š</li><li>æ¢å¤çš„æ—¶å€™ï¼Œä¼šç”¨ Journal File ä¸Šçš„ Page æ¥æä¾›æ¢å¤</li></ol><p>ä»¥ä¸Šç±»ä¼¼ cow æˆ–è€… shadow paging çš„æ–¹å¼å¯ä»¥æ¯”è¾ƒç®€å•çš„å®ç°ä¸€äº›äº‹ç‰©çš„è¯­ä¹‰ï¼ŒåŒæ—¶ï¼Œå®ƒä»¬ç›¸å¯¹äº logging protocol æ¥è¯´å¯èƒ½å¼€é”€æ˜¯æ›´å¤§çš„ã€‚å®ƒç›¸å½“äº force + no stealï¼š</p><p><img src="https://image.mwish.me/blog-image/B9C1A5D0-F0ED-40FF-9241-D0217C9E0F3D.png" alt="B9C1A5D0-F0ED-40FF-9241-D0217C9E0F3D"></p><h4 id="WAL-Protocol"><a href="#WAL-Protocol" class="headerlink" title="WAL Protocol"></a>WAL Protocol</h4><p>è¿™é‡Œæä¾›äº†ç‰©ç†æ—¥å¿—å’Œ wal åè®®ï¼Œè¿™é‡Œï¼Œæ—¥å¿—åŒ…å«: <code>&lt; txn id, object id, Before Value (for undo), after value( for redo)&gt;</code>, è¿™é‡Œå¯ä»¥è®°ä½œ <code>&lt;T_i, X_j, V_1, V_2&gt;</code> ï¼ˆæˆ‘æ„Ÿè§‰è¿™ä¸ªæ˜¯ä¸€ä¸ªå¾ˆç®€åŒ–çš„æ¨¡å‹äº†ï¼Œæ˜¯ä¸æ˜¯è¿˜è¦å¤„ç† delete/insert ä¹‹ç±»çš„ï¼‰. åŒæ—¶ï¼Œè¿™é‡Œéœ€è¦å’Œäº‹åŠ¡æœ‰å…³çš„ä¿¡æ¯, æ¯”å¦‚: <code>&lt;Txn i begin&gt;</code> <code>&lt;Txn i Commit&gt;</code> <code>&lt;Txn i Abort&gt;</code>ã€‚ log éœ€è¦è¢«å†™åˆ° stable storage ä¸­ã€‚</p><p>å¦ä¸€ç‚¹è¦è¯´çš„å°±æ˜¯å¯¹ block çš„å†™å…¥ï¼Œæˆ‘ä»¬å›åˆ° steal/force çš„ case:</p><ol><li>å¯èƒ½äº‹åŠ¡å®Œæˆå‰å°±åˆ·äº†å†™å…¥è¿‡çš„ç›˜ï¼Œè¿™ä¸ªæ—¶å€™ï¼Œå‡è®¾äº‹åŠ¡ abort äº†ï¼Œæ˜¾ç„¶ï¼Œæˆ‘ä»¬éœ€è¦ <code>undo</code> è¿™äº›å˜æ›´</li><li>å¯èƒ½äº‹åŠ¡å®Œæˆåï¼Œæ²¡æœ‰å†™å…¥ blockï¼Œè¿™ä¸ªæ—¶å€™ï¼Œå‡è®¾äº‹åŠ¡ commit äº†ï¼Œæ˜¾ç„¶ï¼Œæˆ‘ä»¬éœ€è¦ redo è¿™äº›å˜æ›´</li></ol><p>åŒæ—¶ï¼Œéœ€è¦è€ƒè™‘çš„è¿˜æœ‰ concurrency control çš„è¯­ä¹‰ï¼šåŒä¸€ä¸ª <code>object</code>, è¢« txn1 å†™å…¥ä¹‹åï¼Œåœ¨ txn1 commit/abort ä¹‹å‰è¢« txn2 å†™å…¥äº†åº”è¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿå¹¸è¿çš„æ˜¯ï¼Œå¦‚æœæˆ‘ä»¬é‡‡ç”¨çš„æ˜¯ strict 2PL åè®®ï¼Œè¿™é‡Œå¹¶ä¸ä¼šæœ‰è¿™ç§æƒ…å†µã€‚è€Œ ts åè®®å¤§éƒ¨åˆ†æ—¶å€™ä¹Ÿé¿å…äº†è¿™ç§æƒ…å†µã€‚å½“ç„¶ï¼Œåé¢æˆ‘ä»¬ä¼šæåˆ°ï¼Œå¦‚æœå¸Œæœ›æå‰ release lock, æœ‰ä»€ä¹ˆæ–¹æ³•èƒ½è¡¥æ•‘è¿™ä¸ª caseã€‚</p><p><img src="https://image.mwish.me/blog-image/8F0DB468-C10C-494F-94EA-B07F6CB31D27.png" alt="8F0DB468-C10C-494F-94EA-B07F6CB31D27"></p><p>ä¸Šè¿°æ˜¯ä¸€ä¸ªå¯¹åº”çš„åºåˆ—ï¼Œé‚£ä¹ˆï¼Œèƒ½å¤Ÿçœ‹åˆ°å¯¹åº”çš„ log:</p><p><img src="https://image.mwish.me/blog-image/7A403DB0-0619-47BE-B172-3A6CF821350C.png" alt="7A403DB0-0619-47BE-B172-3A6CF821350C"></p><p>å‡è®¾åœ¨ä¸Šè¿°ä»»ä½•ä¸€ä¸ªèŠ‚ç‚¹ system crash äº†ï¼Œæˆ‘ä»¬éƒ½è¦èµ°ä¸‹é¢ä¸¤ä¸ªçŠ¶æ€ï¼š</p><ol><li><code>redo(T_i)</code>: è¿™ä¸ªè¿‡ç¨‹åœ¨ä»å‰å¾€åæ‰« wal çš„æ—¶å€™å‘ç”Ÿï¼Œå¯¹äºä»»ä½•ä¸€ä¸ª start çš„è®°å½•ï¼Œå®ƒä¼šæŠŠæ—¥å¿—ä¸­çš„æ“ä½œ replay ä¸€éã€‚</li><li><code>undo(T_i)</code>: è¿™é‡Œä¸ä»…è¦ <code>undo</code> å¯¹åº”çš„è®°å½•ï¼Œä¹Ÿè¦å†™ä¸‹å¯¹åº”çš„ undo ç›¸å…³çš„æ¢å¤æ—¥å¿— (æ¯”å¦‚ <code>&lt;T_i, record, before value&gt;</code>ï¼Œå®Œæˆçš„æ—¶å€™ä¹Ÿéœ€è¦å†™ <code>&lt;T_i, abort&gt;</code>, é˜²æ­¢ä¸‹æ¬¡ recover çš„æ—¶å€™ï¼Œè¿˜éœ€è¦æ¢å¤è¿™æ ·çš„çŠ¶æ€ã€‚</li></ol><p>æ‰€ä»¥ï¼Œè¿™é‡Œæœ‰ä¸ªç®€å•çš„ recover åè®®ï¼š</p><ol><li>T_i åœ¨æœ‰ <code>start</code>, ä½†æ˜¯æ²¡æœ‰ <code>commit</code>, ä¹Ÿæ²¡æœ‰ <code>abort</code> çš„æ—¶å€™ï¼Œéœ€è¦è¢« undo</li><li>åœ¨äº‹åŠ¡æœ‰å¯¹åº” <code>commit</code> æˆ–è€… <code>abort</code> çš„æ—¶å€™éœ€è¦ redoã€‚<code>abort</code> çš„æ—¶å€™ä¸ºä»€ä¹ˆè¦ redo å‘¢ï¼Ÿå› ä¸ºæˆ‘ä»¬åˆšçœ‹åˆ°ï¼Œabort çš„æ—¶å€™éœ€è¦æŠŠæ¢å¤å¯¹åº”çš„æ—¥å¿—å†™ä¸‹æ¥ï¼Œå† abortã€‚</li></ol><h3 id="Checkpoints-ckpt"><a href="#Checkpoints-ckpt" class="headerlink" title="Checkpoints (ckpt)"></a>Checkpoints (ckpt)</h3><p>ä¸Šé¢çš„å†…å®¹æš—ç¤ºäº†æ—¥å¿—çš„å…¨é‡ scan, å®é™…ä¸Šæ—¥å¿—è‚¯å®šè¦ GC çš„ï¼Œè¿™é‡Œç»™å‡ºäº†ä¸€ç§æ–¹æ³•ï¼šckpt, å®ƒæš—ç¤ºä¹‹å‰çš„ wal éƒ½ä¸é‡è¦äº†ï¼š</p><ol><li>æŠŠæ‰€æœ‰ç•™åœ¨å†…å­˜ä¸­çš„æ—¥å¿—å†™åˆ° storage ä¸Š</li><li>æŠŠæ‰€æœ‰çš„ dirty block å†™åˆ° storage ä¸Š</li><li>å†™ä¸‹ <code>&lt;checkpoint &#123;active Txn1, active Txn2, ...&#125;&gt;</code> æ—¥å¿—ï¼Œè¡¨ç¤ºè¿˜æ´»è·ƒçš„ txn æœ‰å“ªäº›ã€‚</li></ol><p>è¿™äº›æ´»è·ƒäº‹åŠ¡ä¹‹å‰çš„ txn éƒ½å·²ç»åœ¨ block ä¸­äº†ã€‚é‚£ä¹ˆï¼Œæ¢å¤çš„æ—¶å€™ï¼Œåªè¦æ‰¾åˆ°æœ€è¿‘çš„ä¸€æ¡ ckpt æ—¥å¿—ï¼Œç„¶åå¼€å§‹æ¢å¤å³å¯ã€‚</p><p>å½“ç„¶ï¼Œè¿™åœ¨æ€§èƒ½ä¸Šå¸¦æ¥äº†ä¸€äº›é—®é¢˜ï¼šæŠŠæ‰€æœ‰ dirty block å†™åˆ° storage ä¸Šï¼Œå†å†™ ckpt æ—¥å¿—çš„æ—¶å€™ï¼Œäº‹åŠ¡å¦‚æœå†è¿›è¡Œæ›´æ–°å¹¶å†™ logï¼Œå°±ä¼šå¯¼è‡´ ckpt ä¹‹å‰ä¼šæœ‰ä¸€äº›ä¸åœ¨ disk ä¸Šçš„ log, å¯¼è‡´ ckpt å¹¶æ²¡æœ‰è¿™ä¹ˆæœ‰ç”¨ã€‚è¿™é‡Œå¯ä»¥ç”¨ fuzzy checkpoint æ¥å°è¯•è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p><h3 id="Recover-Processing"><a href="#Recover-Processing" class="headerlink" title="Recover Processing"></a>Recover Processing</h3><p>ä¸Šè¿°å‡ ä¸ªéƒ¨åˆ†ä¸»è¦æè¿°çš„æ˜¯â€œç³»ç»Ÿæ­£å¸¸å·¥ä½œçš„æ—¶å€™ï¼Œå¦‚æœå¸Œæœ›åæ¥ç³»ç»Ÿæ˜¯å¯ä»¥ Recover çš„ï¼Œéœ€è¦åšä»€ä¹ˆ</p><h4 id="æ­£å¸¸äº‹åŠ¡-abort-çš„å›æ»š"><a href="#æ­£å¸¸äº‹åŠ¡-abort-çš„å›æ»š" class="headerlink" title="æ­£å¸¸äº‹åŠ¡ abort çš„å›æ»š"></a>æ­£å¸¸äº‹åŠ¡ abort çš„å›æ»š</h4><p>å¦‚æœ <code>Ti</code> éœ€è¦è¢« rollback, é‚£ä¹ˆå®ƒä¼šåå‘ scan æ—¥å¿—ï¼Œå¯¹äºæ¯ä¸€æ¡ <code>&lt;Ti, Xj, V1, V2&gt;</code> çš„æ—¥å¿—ã€‚é€»è¾‘å¤§æ¦‚æ˜¯ï¼š</p><ol><li>Xj è¢«è¿˜åŸåˆ° V1</li><li>å†™ä¸‹ä¸€æ¡ <code>&lt;Ti, Xj, V1&gt;</code> çš„æ¢å¤æ—¥å¿—ã€‚è¿™æ¡æ—¥å¿—æ˜¯ä¸éœ€è¦è¢« undo çš„ã€‚è¿™äº›æ—¥å¿—è¢«ç§°ä¸º compensation log records (CLRs).</li><li>ä¸€æ—¦ <code>&lt;Ti, start&gt;</code> çš„å¼€å§‹æ—¥å¿—è¢«åå‘ scan æ‰¾åˆ°ï¼Œæ—¥å¿—æ¢å¤ç»“æŸï¼Œå†™ä¸€æ¡ <code>&lt;Ti abort&gt;</code> çš„æ—¥å¿—ã€‚</li></ol><h4 id="System-Crash-åçš„æ¢å¤"><a href="#System-Crash-åçš„æ¢å¤" class="headerlink" title="System Crash åçš„æ¢å¤"></a>System Crash åçš„æ¢å¤</h4><ol><li>redo é˜¶æ®µä¸­ï¼Œå…ˆéœ€è¦æ‰¾åˆ°æœ€è¿‘çš„ä¸€ä¸ª ckptï¼Œç„¶å replay redo logs</li><li>åŒæ—¶ï¼Œè¿™é‡Œåº”è¯¥éœ€è¦ç»´æŠ¤ä¸€ä¸ªéœ€è¦è¢«è¡¥å…… abort çš„äº‹åŠ¡çŠ¶æ€è¡¨ undo-listã€‚ckpt æœ‰ä¸€ä¸ªæ´»è·ƒçŠ¶æ€åˆ—è¡¨ï¼ŒåŒæ—¶ï¼Œäº‹åŠ¡ start çš„æ—¶å€™ï¼Œä¼šè¢«åŠ åˆ°è¿™ä¸ªåˆ—è¡¨é‡Œï¼Œæœ‰äº‹åŠ¡å¯¹åº”çš„ commit å’Œ abort çš„æ—¥å¿—æ—¶ï¼Œå¯ä»¥ä»è¿™ä¸ªåˆ—è¡¨ä¸­æ’å‡ºã€‚</li><li>è¿™ä¸ªæ—¶å€™æœ‰ä¸€ä¸ª undo-list, å¯¹ç€è¿™ä¸ª undo-list åå‘ scan, è¿›è¡Œæ­£å¸¸äº‹åŠ¡ abort çš„å›æ»šæ“ä½œï¼Œç›´åˆ° undo-list ä¸ºç©ºï¼Œå³æ‰¾åˆ° undo-list ä¸­æœ€æ—© start çš„äº‹åŠ¡çš„ log (æ„Ÿè§‰è¿™è¡¨ç¤ºè¿™ä¹‹å‰çš„ log éƒ½å¯ä»¥ GC æ‰)</li></ol><p><img src="https://image.mwish.me/blog-image/5730DEF8-A0F4-4034-8ADC-FCCD841C7709.png" alt="5730DEF8-A0F4-4034-8ADC-FCCD841C7709"></p><h3 id="Buffer-Pool-amp-GroupCommit-amp-WAL"><a href="#Buffer-Pool-amp-GroupCommit-amp-WAL" class="headerlink" title="Buffer Pool &amp; GroupCommit &amp; WAL"></a>Buffer Pool &amp; GroupCommit &amp; WAL</h3><p>ä¸‹é¢æ˜¯ä¸€äº›ä¼˜åŒ–ã€‚å†™å…¥çš„æ—¶å€™ï¼Œå¯ä»¥å†™åˆ° Buffer Pool é‡Œé¢ï¼Œç„¶åæŠŠ Page Mark æˆ dirty çš„ï¼ŒæŒ‰éœ€æ±‚å¼‚æ­¥å»å†™ç›˜ã€‚æŸç§æ„ä¹‰ä¸Šï¼Œè¿™é™ä½äº†å†™æ”¾å¤§ï¼Œä½†æ˜¯ä¹Ÿå¯¼è‡´ BTree æœ‰äº›é€»è¾‘æ¯”è¾ƒéš¾ tunning.</p><p>åŒæ—¶ï¼Œwal ä¹Ÿå¯ä»¥ buffering, ä½†æ˜¯è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœ wal éƒ½åšäº† buffer, éœ€è¦æœ‰ä¸‹é¢çš„çº¦æŸï¼š</p><ol><li>å½“ä¸”ä»…å½“ <code>&lt;Ti, Commit&gt;</code> æ—¥å¿—å†™è¿›æŒä¹…å­˜å‚¨ä¹‹åï¼ŒTi æ‰å¯è¢«è§†ä½œæäº¤</li><li><code>&lt;Ti, Commit&gt;</code> å†™è¿›å­˜å‚¨çš„æ—¶å€™ï¼Œ<code>Ti</code> ç›¸å…³çš„æ‰€æœ‰æ—¥å¿—å¿…é¡»å·²ç»é¡ºåºè½ç›˜</li><li>Block åœ¨å†™å…¥çš„æ—¶å€™ï¼Œéœ€è¦ä¿è¯ï¼Œè¿™ä¸ª Block/Page æœ‰å…³çš„æ—¥å¿—å…¨éƒ¨è¢« flush äº†ã€‚</li></ol><p>åŒæ—¶ï¼Œæ˜¾è€Œæ˜“è§ï¼ŒCommit çš„æ—¶å€™ï¼Œéœ€è¦æœ‰è½ç›˜çš„å¼€é”€ã€‚å¯¹äº SSDï¼Œè¿™å¯èƒ½æ˜¯ ~100us çš„çº§åˆ«ï¼Œå¯¹äº HDDï¼Œå¯èƒ½æ˜¯ ~ms çš„çº§åˆ«ã€‚è¿™ä¸ªæ—¶å€™ï¼Œå¯ä»¥é  Group Commit æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚è¿™å¯èƒ½æ˜¯å¢å¤§å•æ¬¡å†™çš„ latency ï¼Œä½†æ˜¯æŠŠå†™å…¥çš„ IO æ•°é‡å‡å°‘äº†ï¼Œå¹¶å‡æ‘Šäº†å†™å…¥çš„æ—¶é—´ï¼Œä¼˜åŒ–äº†å†™å…¥ã€‚</p><p>æ­¤å¤–ï¼Œäº‹åŠ¡å¯ä»¥ Batch çš„æ¥å¤„ç† insert/delete/update è¯·æ±‚ï¼Œæ¥ä½œä¸ºä¼˜åŒ–ã€‚</p><h3 id="Lock-Release-and-Logical-Undo"><a href="#Lock-Release-and-Logical-Undo" class="headerlink" title="Lock Release and Logical Undo"></a>Lock Release and Logical Undo</h3><p>ä½œä¸ºå®ç°æ¥è¯´ï¼Œå¯¹äº inc/dec ç±»çš„æ“ä½œï¼Œç®€å•åšæˆ: read + setï¼Œç„¶åå†™ç‰©ç†æ—¥å¿—æ˜¯æ²¡é—®é¢˜çš„ã€‚ä½†æ˜¯ï¼Œå¦‚æœå¸Œæœ›åœ¨è¿™é‡Œå¢å¤§å¹¶å‘çš„è¯ï¼Œå°±ä¼šæœ‰ä¸€äº›å¥‡æ€ªçš„é—®é¢˜äº†ã€‚2PL æåˆ°è¿‡ï¼Œè¿™é‡Œå¯èƒ½ä¼šæœ‰ cascading abort çš„æ¦‚å¿µã€‚</p><p>ä½†æ˜¯å®é™…ä¸Šï¼Œè¿™é‡Œä¹Ÿå¯ä»¥ç”¨ logicial undo log records æ¥åšä¸€äº›ä¼˜åŒ–ã€‚</p><p><img src="https://image.mwish.me/blog-image/680871EA-B3FF-4A6B-AA3F-27AD38EFE3B9.png" alt="680871EA-B3FF-4A6B-AA3F-27AD38EFE3B9"></p><p>å¦‚ä¸Šå›¾ï¼Œè¿™é‡ŒæŠŠ inc/dec åšåˆ°äº† log é‡Œï¼Œç”¨é€»è¾‘æ—¥å¿—æ¥åšå¯¹åº”çš„æ“ä½œã€‚</p><p>åœ¨æ—¥å¿—ä¿®æ”¹ç´¢å¼•ä¹‹å‰ï¼Œtxn ä¼šåˆ›å»º <code>&lt;Ti, Oj, operation-begin&gt;</code> çš„æ—¥å¿—è®°å½•ã€‚<code>Oj</code> æ˜¯å¯¹è±¡çš„æ ‡ç¤ºã€‚</p><p>è¿™é‡Œå†™çš„æ—¶å€™ï¼Œå®é™…ä¸Šä¹Ÿéœ€è¦å†™ç‰©ç†æ—¥å¿—ï¼Œæ ‡å¿— prev å’Œ new valueã€‚å†™å®Œä¹‹åï¼Œéœ€è¦å†™ä¸€æ¡é€»è¾‘æ—¥å¿—ï¼Œè¡¨ç¤ºæ›´æ–°çš„æ“ä½œã€‚</p><p><img src="https://image.mwish.me/blog-image/DDBA46660D2612F7B7B0E79ACA89B8C3.png" alt="DDBA46660D2612F7B7B0E79ACA89B8C3"></p><p>è¿™é‡Œï¼Œrollback å’Œ recover çš„æ—¶å€™ï¼Œå¯ä»¥éµç…§é€»è¾‘æ—¥å¿—çš„è¯­ä¹‰ï¼š</p><ol><li>ä¸å®Œæ•´çš„ï¼ˆæ²¡æœ‰ operation-end çš„é€»è¾‘æ—¥å¿—ï¼‰ä¼šè¢«ç‰©ç†æ—¥å¿— resolveã€‚<ol><li>æ²¡æœ‰ operation-end å¯èƒ½è¡¨ç¤ºå¯¹è¿™ä¸ª tuple/å¯¹è±¡ çš„é”å®šè¿˜æ²¡æœ‰é‡Šæ”¾ï¼Œé»˜è®¤è¿™ç§è¡Œä¸ºæ˜¯ä¸²è¡Œçš„</li></ol></li><li>æœ‰ operation-end çš„é€»è¾‘æ—¥å¿—ä¼šç”¨é€»è¾‘æ—¥å¿—çš„ä¿¡æ¯å›æ»šï¼Œå¹¶ç”Ÿæˆä¸€ä¸ª operation-abort çš„æ—¥å¿—</li><li>è·³è¿‡è¿™ä¸ªäº‹åŠ¡çš„æ—¥å¿—ï¼Œç›´åˆ°æ‰¾åˆ°å¯¹åº”çš„ operation-begin</li><li>å¦‚æœå¾€å‰æ‰«çš„é€”ä¸­ï¼Œæ‰¾åˆ°äº†ä¸€ä¸ª operation-abort, é‚£ä¹ˆä»–ä¼šè·³è¿‡è¿™ä¸ª Ti å¯¹è¿™ä¸ª object æ‰€æœ‰çš„æ“ä½œ</li><li>ç›´åˆ°ç»“æŸ</li></ol><h2 id="ARIES"><a href="#ARIES" class="headerlink" title="ARIES"></a>ARIES</h2><p>æˆ‘ä»¬ä¹‹å‰çš„æè¿°ä¸­ï¼Œrecover ä¼š scan ckpt ä»¥æ¥æ‰€æœ‰çš„æ—¥å¿—ï¼Œç„¶åç»™ block/page æ¥ replay è¿™äº› redo æ—¥å¿—ï¼Œå†åå‘å» undo. è¿™äº›æµç¨‹å®é™…ä¸Šå¯èƒ½è¿˜ä¼šæŠŠå†…å­˜ä¸­æ‰€æœ‰ page å˜æˆ dirty çš„ï¼ŒåŒæ—¶ï¼Œä¹Ÿå¸¦æ¥äº†å¾ˆä½çš„æ•ˆç‡ã€‚åŒæ—¶ï¼Œckpt çš„è¿‡ç¨‹ç›¸å¯¹æ¥è¯´ä¹Ÿæ˜¯ä½æ•ˆçš„ã€‚</p><p>ARIES: A Transaction Recovery Method Supporting Fine-Granularity Locking and Partial Rollbacks Using Write-Ahead Logging æå‡ºäº† ARIES, å®ƒç›¸å¯¹æ¥è¯´æä¾›äº†å¾ˆå¿«çš„ Recoverï¼Œå…è®¸ä¸Šå±‚ä½¿ç”¨ç»†ç²’åº¦çš„é”ç­‰æ–¹å¼ã€‚</p><p>ä¸‹é¢ï¼Œå‡å®šè¿™é‡Œç”¨ Strict 2PL çš„æ¨¡å¼è¿›è¡Œå¹¶å‘æ§åˆ¶ï¼Œå¹¶ä½¿ç”¨ steal + no-force çš„æ–¹å¼æ§åˆ¶å¹¶å‘ã€‚</p><p>ä¸‹é¢æ˜¯ä¸€äº›æ¦‚å¿µï¼š</p><ol><li>LSN(log sequence number): æ¯ä¸ªæ—¥å¿—å¸¦æœ‰çš„åºåˆ—å·</li></ol><p>ç„¶åç³»ç»Ÿå¾ˆå¤šåœ°æ–¹éƒ½ä¼šå¸¦æœ‰è¿™ä¸ª LSN:</p><div class="table-container"><table><thead><tr><th style="text-align:center">name</th><th>where</th><th>definition</th></tr></thead><tbody><tr><td style="text-align:center">flushedLSN</td><td>Memory</td><td>ç£ç›˜ä¸Šçš„æ—¥å¿—ä¸­ï¼Œæœ€å¤§çš„ log id (å³ flush è¿‡çš„æœ€å¤§æ—¥å¿—çš„ id)</td></tr><tr><td style="text-align:center">pageLSN</td><td>per page (memory)</td><td>å¯¹è¿™ä¸ª Page æœ€è¿‘çš„å†™å…¥çš„ log id, åœ¨å†…å­˜ä¸­</td></tr><tr><td style="text-align:center">recLSN</td><td>per page (memory / disk)</td><td>è¿™ä¸ª Page ä¸Šæ¬¡ flush çš„æ—¶å€™ï¼Œæœ€å¤§çš„ log id, åœ¨å†…å­˜å’Œç›˜ä¸Šéƒ½æœ‰</td></tr><tr><td style="text-align:center">lastLSN</td><td>per transaction</td><td>äº‹åŠ¡æœ€åå†™å…¥çš„ LSN</td></tr><tr><td style="text-align:center">MasterRecord</td><td>disk</td><td>ä¸Šä¸ª ckpt çš„ LSN</td></tr></tbody></table></div><p>ç„¶ååŒç†ï¼Œæ ¹æ®ä¹‹å‰çš„ wal åè®®ï¼Œæˆ‘ä»¬è¦ä¿è¯ï¼šä»»ä½•æ—¶å€™ï¼Œä»»ä½• <code>pageLSN</code>  å°äº <code>flushedLSN</code>ã€‚</p><h4 id="Commit"><a href="#Commit" class="headerlink" title="Commit"></a>Commit</h4><ol><li>å†™ Commit æ—¥å¿—</li><li>ç­‰å¾… Commit å’Œä¹‹å‰çš„æ‰€æœ‰æ—¥å¿—è¢« flush åˆ°ç›˜ä¸Šï¼Œå¹¶æ›´æ–° flushedLSN. å†…å­˜ä¸­å°äº flushedLSN çš„è®°å½•å¯ä»¥è¢«æ¸…é™¤ã€‚</li><li>å†™ä¸€æ¡ <code>TXN-END</code> è®°å½•, ä¸è¦æ±‚ç«‹åˆ» flush</li></ol><h4 id="Abort"><a href="#Abort" class="headerlink" title="Abort"></a>Abort</h4><p>ç›¸å¯¹äºæˆ‘ä»¬ä¹‹å‰çš„ç‰©ç†æ—¥å¿—ï¼Œè¿™é‡Œè¦åŠ ä¸Šä¸€äº›é¢å¤–çš„å­—æ®µï¼š</p><ul><li><code>prevLSN</code> åŒä¸€ä¸ªäº‹åŠ¡çš„ä¸Šä¸€æ¡ LSNï¼Œè¿™å¯ä»¥æŠŠä¸€ä¸ªäº‹åŠ¡çš„æ—¥å¿—ç©¿æˆä¸€ä¸ªå•å‘é“¾è¡¨</li></ul><p>abort çš„æ—¶å€™ï¼Œè¿™é‡Œä¹Ÿè¦å†™ CLRï¼Œç›¸å¯¹æˆ‘ä»¬ä¹‹å‰è®°å½•çš„ CLRï¼Œè¿™é‡Œä¹Ÿå¢åŠ äº†å†…å®¹ï¼š</p><ul><li><code>undoNext</code> æŒ‡é’ˆï¼Œå°±æ˜¯ undo ä¸€æ¡ CLR åªæœ‰ï¼Œæ ¹æ® <code>prevLSN</code> çš„è®°å½•ï¼Œæ‰¾åˆ°çš„ä¸‹ä¸€æ¡è¦æ¢å¤çš„ redo æ—¥å¿—</li></ul><p><img src="https://image.mwish.me/blog-image/48E33312-9C7C-489B-986E-DE0726829AEC.png" alt="48E33312-9C7C-489B-986E-DE0726829AEC"></p><p>ç›¸å¯¹æ¥è¯´ï¼Œè¿™äº›è®°å½•èƒ½åœ¨ crash çš„æ—¶å€™ï¼Œæé«˜æ¢å¤çš„é€Ÿåº¦ã€‚</p><p>crash çš„æ—¶å€™ï¼Œè¿™é‡Œä¼šï¼š</p><ol><li>å†™ä¸€å¥— abort çš„è®°å½•</li><li>å†™å¯¹åº”çš„ CLR, ç„¶åæ²¿ç€ç‰ˆæœ¬é“¾ undo</li><li>å†™ <code>TXN-END</code></li></ol><h3 id="Fuzzy-Checkpoint"><a href="#Fuzzy-Checkpoint" class="headerlink" title="Fuzzy Checkpoint"></a>Fuzzy Checkpoint</h3><p>checkpoint éœ€è¦æŠŠæ‰€æœ‰çš„ dirty page åˆ·åˆ°å­˜å‚¨ä¸­ï¼Œè¿™æ®µæ—¶é—´éƒ½è¦ stop-all-txns, ç„¶åè¦ flush the bufferã€‚fuzzy checkpoint  å¯ä»¥æä¾›ä¸€ä¸ªæ¨¡ç³Šçš„ ckptï¼Œè¿™é‡Œéœ€è¦è®°å½•äº‹åŠ¡å’Œ Page ç›¸å…³çš„å†…éƒ¨çŠ¶æ€ï¼Œæ‰€ä»¥éœ€è¦ä¸¤ä¸ª Table:</p><ul><li>Active Transaction Table (ATT)<ul><li>txnId: txn id</li><li>status: ç°åœ¨äº‹åŠ¡çš„çŠ¶æ€ï¼Œåˆ†ä¸º <code>Running</code>, <code>Committing</code>, <code>Candidate for undo</code></li><li><code>lastLSN</code>: äº‹åŠ¡ä¸Šä¸€æ¬¡ä¿®æ”¹çš„ <code>LSN</code></li></ul></li><li>Dirty Page Table (DPT)<ul><li>è®°å½•äº† page å’Œ <code>recLSN</code></li></ul></li></ul><p>è¿™é‡Œç›¸å¯¹æ¥è¯´ï¼Œå°±ä¸ç”¨ flush all, è€Œæ˜¯è¯´è®°å½•äº†å“ªäº› Page æ˜¯ dirty çš„ã€‚</p><p><img src="https://image.mwish.me/blog-image/E922642E-C55C-446D-824D-55CE92802225.png" alt="E922642E-C55C-446D-824D-55CE92802225"></p><p>è¿™é‡Œ flush çš„æ—¶å€™ï¼ŒçŸ¥é“ Page æ˜¯ dirty çš„ã€‚å¯èƒ½éœ€è¦å‰é¢ä¸€äº›çš„æ—¥å¿—ï¼Œæ¥æ¢å¤è¿™äº› Txn, å½“ç„¶è¿™é‡Œ att ä¹Ÿèƒ½æ‹¿åˆ° <code>lastLSN</code>, æ¥æ¯”è¾ƒå¿«çš„å®šä½ã€‚</p><p>å½“ç„¶ï¼Œè¿™é‡Œä¹Ÿè¦æ±‚ï¼Œå†™ä¸€æ¡ <code>CHECKPOINT</code> æ—¥å¿—çš„æ—¶å€™ï¼Œè¿™ä¸­é—´æŠŠè¿™æ¡æ—¥å¿—åˆ·ä¸‹å»ä¹‹å‰ï¼Œè¿˜éœ€è¦ä¸Šé”å’ŒçŸ­æš‚çš„ stopï¼Œè¿™é‡Œæ˜¯æƒ³ä¿è¯å†™å…¥ <code>CHECKPOINT</code> çš„æ—¶å€™ï¼Œä¹‹å‰ä¸ä¼šå‡ºç°åˆ«çš„å˜æ›´æ—¥å¿—ï¼Œè®© <code>ATT</code> å’Œ <code>DPT</code> çš„è¿™é‡Œè¿˜æœ‰ä¸€ç§ä¼˜åŒ–ï¼Œè®©è¿™ä¸ªæ—¥å¿—å†™ä¸¤æ¡ï¼š</p><ol><li><code>CHECKPOINT-BEGIN</code> : é€»è¾‘ä¸Šçš„ ckpt å®è·µ</li><li><code>CHECKPOINT-END</code>: åŒ…å« ATT + DPT</li></ol><p>è¿™å®é™…ä¸Šå°±æ˜¯æŠŠæ—¥å¿—æ‹†æˆäº†ä¸¤æ¡ï¼Œç„¶åå»¶ç¼“äº†è¿™ä¸ªçŠ¶æ€ã€‚è™½ç„¶è¿™é‡Œä¹Ÿè¦æœ‰å°å°çš„ stallã€‚</p><p><img src="https://image.mwish.me/blog-image/0FCE87D0-00D0-4ABE-824D-D917EFCD47B8.png" alt="0FCE87D0-00D0-4ABE-824D-D917EFCD47B8"></p><p>åŒæ—¶ï¼Œå½“ <code>checkpoint</code> å†™å…¥å®Œæˆçš„æ—¶å€™ <code>checkpoint-begin</code> éœ€è¦æ›´æ–°åˆ° <code>MasterRecord</code>ã€‚è¿™é‡Œç›¸å½“äºï¼Œ<code>checkpoint-begin</code> åˆ° <code>checkpoint-end</code> ä¹‹é—´çš„äº‹åŠ¡ï¼Œä¸ä¼šçºªå½•åˆ° ATT ä¸­ã€‚</p><h4 id="Big-Picture"><a href="#Big-Picture" class="headerlink" title="Big Picture"></a>Big Picture</h4><p>åœ¨è¿›å…¥ Recover ä¹‹å‰ï¼Œè®©æˆ‘ä»¬å¯¹è¿™äº›ç»“æ„éƒ½æœ‰ä¸€ä¸ªå…¨å±€å°è±¡å§ï¼š</p><p><img src="https://image.mwish.me/blog-image/BEC1863C-DDBE-4E43-9C58-B8998B652C4D.png" alt="BEC1863C-DDBE-4E43-9C58-B8998B652C4D"></p><h4 id="Recover"><a href="#Recover" class="headerlink" title="Recover"></a>Recover</h4><p>è¿™é‡Œ recover åˆ†ä¸ºä¸‰ä¸ªé˜¶æ®µï¼ˆè¿˜è®°å¾—ä¹‹å‰çš„ redo/undo å—ï¼‰ï¼š</p><ol><li>analysis</li><li>redo</li><li>undo</li></ol><p>analysis é˜¶æ®µä¸­ï¼š</p><ol><li>å…ˆæ‰¾åˆ° MasterRecord, è¿™é‡Œå¯¹åº”äº†ä¸€ä¸ªå­˜å‚¨é‡Œæœ€æ–°çš„ <code>BEGIN-CHECKPOINT</code>.</li><li>æ„å»º ATT å’Œ DPTï¼Œè¿™é‡Œ <code>CHECKPOINT-END</code> å¯ä»¥å¸®åŠ©æ„å»º ATTï¼Œåˆ«çš„çŠ¶æ€åˆšè¿›æ¥æ˜¯ UNDO</li><li>ATT è€Œè¨€ï¼Œå¯¹äºå‰©ä¸‹çš„æ—¥å¿—ï¼š<ol><li>å¦‚æœæ¥äº†ä¸€ä¸ªäº‹åŠ¡ï¼ŒæŠŠå®ƒçŠ¶æ€è®¾ç½®æˆUNDO</li><li>å¦‚æœäº‹åŠ¡æäº¤äº†ï¼Œè®¾ç½®æˆ COMMIT</li><li>å¦‚æœæ‰¾åˆ°äº† <code>TXN-END</code>, ä¹Ÿè¦ä» ATT ä¸­ç§»é™¤ã€‚</li></ol></li><li>DPT è€Œè¨€ï¼Œå¯¹äºå‰©ä¸‹çš„å†™å…¥ï¼š<ol><li>å¦‚æœ Page ä¸å† DPT ä¸­ï¼ŒæŠŠ P å¢åŠ åˆ° DPT ä¸­ï¼Œç„¶ååˆå§‹åŒ–å®ƒçš„ <code>recLSN</code></li></ol></li></ol><p>åœ¨ analysis é˜¶æ®µä¸­ï¼Œæ„å»ºäº†å®Œæ•´çš„  ATT/DPT.</p><p>åœ¨ DPT ä¸­ï¼Œè¿™é‡Œè®°å½•äº† Page çš„ recLSN, è¿™é‡Œæ‰¾åˆ°æœ€å°çš„ recLSN, ç„¶åå¼€å§‹å¯¹å¯¹åº”çš„ Page æ¥ replay:</p><ol><li>å¦‚æœ Page ä¸åœ¨ DPT ä¸­ï¼Œè·³è¿‡è¿™æ¡æ—¥å¿—</li><li>å¦‚æœ Page çš„ LSN ä¸å°äºæ—¥å¿— LSNï¼Œè·³è¿‡</li><li>å¦åˆ™ï¼Œapply log, å¹¶ä¸”è®¾ç½®å†…å­˜ä¸­çš„  <code>pageLSN</code></li><li>redo å®Œä¹‹åï¼Œç»™å¯¹åº”çš„äº‹åŠ¡å†™ä¸Š TXN-END è®°å½•ï¼Œå¹¶ä¸”ä» ATT ä¸­ç§»é™¤</li></ol><p>UNDO é˜¶æ®µä¸­ï¼Œè¿™é‡Œå¯ä»¥ç”¨ lastLSN æ¥åŠ é€ŸæŸ¥æ‰¾ï¼Œå¹¶ä¸”å†™å…¥ <code>CLR</code></p><p>ARIES è¿™è¾¹æ”¯æŒçš„ redo æ˜¯ Physiological REDO logging + Logical UNDOï¼Œç”¨æ¥æä¾›ç›¸å…³çš„æ€§èƒ½æ”¯æŒã€‚Physiological REDO å¯ä»¥è¿›è¡Œï¼Œå› ä¸ºæœ¬èº«é€šè¿‡ Page æ¥å®šä½ï¼Œç”¨ LSN æ¥è®©æ“ä½œæ˜¯å¹‚ç­‰çš„ã€‚</p>]]></content>
      
      
      
        <tags>
            
            <tag> database </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>FAST&#39;16 WiscKey</title>
      <link href="/2021/08/01/FAST-16-WiscKey/"/>
      <url>/2021/08/01/FAST-16-WiscKey/</url>
      
        <content type="html"><![CDATA[<h1 id="FASTâ€™16-WiscKey"><a href="#FASTâ€™16-WiscKey" class="headerlink" title="FASTâ€™16: WiscKey"></a>FASTâ€™16: WiscKey</h1><p>WiscKey æ˜¯ LSM-Tree ä¸Šåˆ†ç¦» Key-Value çš„ä¸€ç§æ–¹æ¡ˆã€‚ä½œè€…çš„æ€è·¯æ˜¯ï¼š</p><ol><li>LSMTree çš„ Compaction æœ‰å¾ˆå¤§çš„å†™æ”¾å¤§ï¼Œå®é™…ä¸Šï¼ŒCompaction çš„æ—¶å€™ï¼Œvalue ä¸é‚£ä¹ˆä¼šè¢«ç”¨ä¸Šï¼ŒåŒæ—¶ï¼Œç”±äºå†™æ”¾å¤§ï¼Œå®ƒä¹Ÿæ²¡æœ‰åŠæ³•å¾ˆå¥½åˆ©ç”¨ SSD çš„æ€§èƒ½ã€‚</li><li>è§£å†³æ–¹æ¡ˆæ˜¯å°† Value ä» LSM-Tree ä¸­åˆ†ç¦»å‡ºæ¥ï¼ŒåŒæ—¶ï¼Œå®é™…çš„åœºæ™¯ä¸­ï¼Œkey çš„å¤§å°å¹¶ä¸ä¼šå¾ˆå¤§ã€‚ä¸ºäº†åšåˆ°ç¬¬äºŒç‚¹ï¼Œéœ€è¦åšçš„äº‹æƒ…æœ‰ï¼š<ol><li>æ‹†åˆ†å‡ºä¸€ä¸ª vLog (value log) ç»„ä»¶ï¼Œå¹¶å°† value è½åˆ° vLog é‡Œé¢</li><li>éœ€è¦ä¸€ä¸ª GCï¼Œæ¥å›æ”¶æ‰æ—§çš„ vLog</li><li>ä¸å†éœ€è¦ walï¼Œä¸€åˆ‡ç”¨ vLog æ¥ trade off</li><li>ç»´æŒ consistency</li></ol></li></ol><p>å½“ç„¶ï¼Œè®ºæ–‡å¯¹ value log çš„å†…å®¹æå‡ºäº†æŒ‡å¯¼æ€§çš„è®¾è®¡ï¼Œä½†æ˜¯ Consistency æœ‰å…³çš„éƒ¨åˆ†å…¶å®æ˜¯å†™å¾—æ¯”è¾ƒå«ç³Šçš„ï¼Œæ„Ÿè§‰å¾ˆå¤šå…·ä½“å†…å®¹è¿˜æ˜¯è¦çœ‹ badger æˆ–è€… Titan ä¹‹ç±»çš„å®ç°ï¼Œæ‰èƒ½äº†è§£çš„æ¯”è¾ƒé€å½»ã€‚</p><h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>è®ºæ–‡çš„å‡ºå‘ç‚¹æ˜¯æœ‰ä¸¤ç‚¹ï¼š</p><ol><li>Compaction å¯èƒ½ä¼šå¸¦æ¥éå¸¸å¤§çš„å†™æ”¾å¤§å’Œæ€§èƒ½æŸè€—ã€‚å…¶ä¸­ï¼Œvalue çš„ Compaction ä¼šå¸¦æ¥å¾ˆå¤§çš„å†™æ”¾å¤§ã€‚å†™æ”¾å¤§æ¯”ä¾‹å¯èƒ½å’Œ Compaction æ¨¡å¼æœ‰å…³ã€‚Tiered Compaction æ¯å±‚ä¼šå†™æ”¾å¤§ä¸€æ¬¡ï¼ŒLeveled Compaction å¯èƒ½ä¼šæ”¾å¤§æ•°æ¬¡ã€‚è¿™å¯¼è‡´äº†å¯¹ SSD çš„ç‹‚å†™æ”¾å¤§ï¼Œå¸¦æ¥äº†æ€§èƒ½æŸè€—ã€‚</li><li>LSMTree è®ºæ–‡æå‡ºäº 90 å¹´ä»£ï¼Œé‚£æ˜¯ä¸€ä¸ª HDD å ä¸»è¦åœ°ä½çš„å¹´ä»£ã€‚HDD çš„é¡ºåºå†™æ€§èƒ½å¯èƒ½æ˜¯éšæœºå†™æ€§èƒ½çš„ç™¾å€ã€‚LSM-Tree ç›¸å¯¹æ¥è¯´ï¼Œæ‰€æœ‰å†™å…¥éƒ½æ˜¯é¡ºåºå†™ï¼Œè¿™å¯¼è‡´äº†å¾ˆé«˜çš„å†™æ€§èƒ½ã€‚ä½†æ˜¯ SSD æ²¡æœ‰å¿…è¦è¿™æ ·å»å†™ valueï¼Œè¿™å›é€ æˆå¾ˆé«˜çš„å†™æ”¾å¤§ã€‚åŒæ—¶ï¼ŒSSD æœ‰å¾ˆå¤§çš„å¹¶è¡Œåº¦ï¼Œç›¸å¯¹æ¥è¯´éœ€è¦è‰¯å¥½çš„è®¾è®¡æ¥åˆ©ç”¨è¿™äº›å¹¶è¡Œåº¦ã€‚åŒæ—¶ï¼ŒSSD æš´å†™æ˜¯æœ‰æŸè€—çš„ï¼Œå¾ˆå®¹æ˜“å†™åè®¾å¤‡ã€‚è¿˜æœ‰é—®é¢˜å°±æ˜¯è¯´ï¼ŒSSD éšæœºè¯»/é¡ºåºè¯»è™½ç„¶è¿˜æ˜¯æœ‰å·®è·ï¼Œä½†æ˜¯ç›¸å¯¹ HDD æ¥å·®è·ä¼šå°å¾ˆå¤šã€‚</li></ol><p>æ‰€ä»¥è®ºæ–‡æä¾›äº†æœ€åˆçš„ idea:</p><blockquote><p>The central idea behind WiscKey is the separation of keys and values [42]; only keys are kept sorted in the LSM-tree, while values are stored separately in a log. In other words, we decou- ple key sorting and garbage collection in WiscKey while LevelDB bundles them together.</p></blockquote><p>è¿™ç§ idea å¸¦æ¥äº†ä¸€äº› challenge:</p><ol><li>Scan çš„æ—¶å€™å¯èƒ½ä¼šæœ‰ä¸€äº›æ€§èƒ½ lossï¼Œå› ä¸º value æ²¡æœ‰ä»»ä½• localityï¼Œå¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜ã€‚ï¼ˆGet çš„æ—¶å€™ä¹Ÿä¼šæœ‰ä¸€ç‚¹ï¼Œä¸è¿‡è¿™ä¸ªç›¸å½“äºæ˜¯ä¸€ç§ trade off äº†ï¼Œå¯ä»¥åæ–‡ä»‹ç»ï¼‰ã€‚WiscKey é  prefetch å’Œåˆ©ç”¨ SSD å¹¶è¡Œåº¦æ¥è§£å†³è¿™ä¸ªé—®é¢˜</li><li>GC: WiscKey çš„ GC åˆ©ç”¨ vLog ä¸Šçš„é¡ºåºè¯»å†™æ¥ä¼˜åŒ–æ€§èƒ½ï¼Œå¹¶å¸Œæœ›è‡ªå·±çš„ GC æ˜¯è½»é‡çº§çš„</li><li>Consistency: WiscKey åˆ©ç”¨ vLog å’Œ vLog è®°å½•çš„è®¾è®¡æ¥åš consistency.</li></ol><p>ä¸‹é¢æ˜¯ benchmark éƒ¨åˆ†ï¼Œè¿™ä¸ªå°±ï¼Œå¬ä»–å¹ä¸€å¹å°±è¡Œï¼š</p><blockquote><p>With LevelDBâ€™s own microbenchmark, WiscKey is 2.5Ã—â€“111Ã— faster than LevelDB for loading a database, depending on the size of the key-value pairs; for random lookups, WiscKey is 1.6Ã—â€“14Ã— faster than LevelDB. </p></blockquote><p>WiscKey æ€§èƒ½ä¸æ€»æ˜¯æ¯” LSM-Tree å¥½ï¼Œåœ¨å° key å å¤šæ•°çš„çš„ point getã€range query ä¸­ï¼Œæ€§èƒ½æ˜¯ä¸‹é™çš„ï¼ˆå½“ç„¶ï¼Œå¦‚æœ vLog å€¼æ˜¯é¡ºåºçš„ï¼Œå¯èƒ½æœ‰å¥½äº›çš„ locality, ä½†æ˜¯ä¸ç°å®ï¼‰ï¼Œä¸è¿‡ï¼Œè®ºæ–‡ä½œè€…è®¤ä¸ºè¿™äº›æƒ…å†µæ¯”è¾ƒå°‘å‘ç”Ÿï¼š</p><blockquote><p>However, this workload does not reflect real-world use cases (which primarily use shorter range queries) and can be improved by log reorganization. </p></blockquote><h2 id="LevelDB-çš„è¯»å†™æ”¾å¤§å’Œç¡¬ä»¶åˆ©ç”¨"><a href="#LevelDB-çš„è¯»å†™æ”¾å¤§å’Œç¡¬ä»¶åˆ©ç”¨" class="headerlink" title="LevelDB çš„è¯»å†™æ”¾å¤§å’Œç¡¬ä»¶åˆ©ç”¨"></a>LevelDB çš„è¯»å†™æ”¾å¤§å’Œç¡¬ä»¶åˆ©ç”¨</h2><p><img src="https://image.mwish.me/blog-image/A0BE8E5C-F832-4E04-AAA5-695DE7CB1309.png" alt="A0BE8E5C-F832-4E04-AAA5-695DE7CB1309"></p><p>LevelDB å°±ä¸è®²äº†ï¼Œå†™æ”¾å¤§å’Œ LevelDB Compaction æœ‰å…³ã€‚è¯»æ”¾å¤§å…¶å®ç›¸å¯¹æ¥è¯´ trick ä¸€äº›ï¼Œè¿™é‡Œçš„åˆ†ææ–¹å¼å¦‚ä¸‹ï¼š</p><blockquote><p>In the worst case, LevelDB needs to check eight files in L0, and one file for each of the remaining six levels: a total of 14 files. Sec- ond, to find a key-value pair within a SSTable file, LevelDB needs to read multiple metadata blocks within the file. Specifically, the amount of data actually read is given by (index block + bloom-filter blocks + data block). For example, to lookup a 1-KB key-value pair, LevelDB needs to read a 16-KB index block, a 4- KB bloom-filter block, and a 4-KB data block; in total, 24 KB. Therefore, considering the 14 SSTable files in the worst case, the read amplification of LevelDB is 24 Ã— 14 = 336. Smaller key-value pairs will lead to an even higher read amplification.</p></blockquote><p>è¿™é‡Œæ˜¯ç®—ä¸Šäº† index block å’Œ bloom fliter çš„æƒ…å†µï¼Œæœ€åè¯»äº†ä¸€æ¬¡ data blockã€‚è¿™é‡Œæä¾›äº†ä¸€ä¸ª 1KB çš„ key-value çš„ pair, ç„¶åç‚¹æŸ¥ 100000 æ¬¡ã€‚</p><p><img src="https://image.mwish.me/blog-image/DA2A69DF-BC32-4112-B862-9E59B8893ADE.png" alt="DA2A69DF-BC32-4112-B862-9E59B8893ADE"></p><p>ä¸Šé¢çš„å›¾æœ‰ç‚¹åç›´è§‰ï¼Œä¸è¿‡å®é™…ä¸ŠåŸå› æ˜¯è¯´ï¼Œéšç€æ•°æ®é›†å¢å¤§ï¼ŒLevelDB çš„å±‚æ•°å˜æ·±ã€SST å˜å¤šï¼Œè¯»å¯èƒ½ä¼šéœ€è¦è®¿é—®è¶Šæ¥è¶Šå¤šçš„ SST çš„ index blocks, åŒæ—¶ï¼Œè¿™äº› blocks ä¸ä¸€å®šéƒ½èƒ½ fit åœ¨æ–‡ä»¶å…ƒä¿¡æ¯çš„ cache ä¸­ï¼Œå¯¼è‡´è¯»æ€§èƒ½çš„ä¸‹é™ï¼Œè¯»æ”¾å¤§å¢å¤§ã€‚å†™å…¥å¾ˆå¥½ç†è§£ï¼Œå°±ä¸è§£é‡Šäº†ã€‚</p><p>ï¼ˆè®ºæ–‡éšåå’Œ B+Tree å¯¹æ¯”äº†ä¸€ä¸‹ï¼Œä¸è¿‡æˆ‘æ„Ÿè§‰ç”±äº BTree çš„åˆ·è„ä¹‹ç±»çš„é€»è¾‘ï¼Œæ„Ÿè§‰è¯»å†™æ”¾å¤§éƒ½æ²¡è¿™ä¹ˆå¥½æ¯”è¾ƒï¼Œå°±ä¸è´´äº†ï¼‰</p><p>ä¸‹é¢æ˜¯ç¡¬ä»¶ç›¸å…³çš„å†…å®¹ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œsequential ç›¸å¯¹æ¥è¯´å¾ˆå®¹æ˜“æ‰“æ»¡è¯»å¸¦å®½ã€‚è€Œ rand access éœ€è¦å¹¶è¡Œ + æ¯æ¬¡ issue è¾ƒå¤§çš„å—çš„è¯ï¼Œç›¸å¯¹æ¥è¯´ä¹Ÿèƒ½æŠŠå¸¦å®½æ‰“æ»¡ã€‚</p><p><img src="https://image.mwish.me/blog-image/07644C64-EB05-4306-AABE-09589B8D3066.png" alt="07644C64-EB05-4306-AABE-09589B8D3066"></p><p>ä½œè€…è®¤ä¸ºï¼Œç»¼ä¸Šæ‰€è¿°ï¼Œcompaction å’Œ random access æµªè´¹äº†å¾ˆå¤šè¯»ç›¸å…³çš„å¸¦å®½ï¼Œè¿™ç‚¹å¯ä»¥è¢«å¥½å¥½åˆ©ç”¨ã€‚åŒæ—¶ï¼Œå³ä½¿ä¸æ˜¯ sequential access, å¸¦å®½ä¹Ÿæ˜¯èƒ½è¢«æ‰“æ»¡çš„ã€‚è¿™ä»£è¡¨äº†åæ–‡çš„ä¼˜åŒ–æ–¹å‘ã€‚</p><h2 id="WiscKey"><a href="#WiscKey" class="headerlink" title="WiscKey"></a>WiscKey</h2><p>WiscKey æå‡ºäº†å‡ ä¸ªåŸºæœ¬çš„è®¾è®¡æ€æƒ³å’Œè®¾è®¡ç›®æ ‡ï¼š</p><ol><li>WiscKey åˆ†ç¦»äº† key-value</li><li>ä¸ºäº†é«˜æ•ˆ range-query, WiscKey ç”¨å¹¶è¡Œéšæœºè¯»æ¥æœ€å¤§åŒ–åˆ©ç”¨ SSD çš„å¸¦å®½ã€‚</li><li>WiscKey åˆ©ç”¨ GC ç­‰äº‹åŠ¡æ¥ä¼˜åŒ– vLog</li><li>WiscKey å¯èƒ½é€šè¿‡ç‰ºç‰²ä¸€è‡´æ€§çš„æ–¹å¼æ¥ä¼˜åŒ–å†™æ€§èƒ½</li></ol><p>Design Goals:</p><ol><li>ä½å†™æ”¾å¤§</li><li>ä½è¯»æ”¾å¤§</li><li>SSD ä¼˜åŒ–</li><li>å…¼å®¹ç±»ä¼¼ LevelDB è¿™äº›è¯­ä¹‰ï¼Œæä¾›ä¸°å¯Œçš„ api</li></ol><h3 id="Key-Value-åˆ†ç¦»"><a href="#Key-Value-åˆ†ç¦»" class="headerlink" title="Key-Value åˆ†ç¦»"></a>Key-Value åˆ†ç¦»</h3><p><img src="https://image.mwish.me/blog-image/052475CD-D553-457B-B931-552B6F1DB0D5.png" alt="052475CD-D553-457B-B931-552B6F1DB0D5"></p><blockquote><p>WiscKey is motivated by a simple revelation. Compaction only needs to sort keys, while values can be managed separately [42].</p></blockquote><p>å®é™…ä¸Šï¼Œè¿™é‡Œçš„ sorting åªéœ€è¦ keyï¼Œä¸éœ€è¦ valueã€‚ç”±äºå¤§éƒ¨åˆ† workload ä¸­ï¼Œvalue å¯èƒ½å çš„åœ°ä½å¤šä¸€äº›ï¼Œè¿™æ ·èƒ½è®© SST ä¸­ï¼Œä¿å­˜æ›´å¤šçš„å¯¹è±¡ï¼Œå‹ç¼©æ›´å°‘çš„æ¬¡æ•°ã€‚Compaction çš„æ—¶å€™ï¼Œèƒ½å‡å°‘ Compaction ç›¸å…³çš„å†™æ”¾å¤§ã€‚</p><p>è¿™ç§æ¨¡å¼ä¹Ÿå‡å°äº†è¯»ç›¸å…³çš„æ”¾å¤§ã€‚è™½ç„¶åœ¨ WiscKey ä¸­ï¼Œè¯»ä¹Ÿä¼šèµ°åˆ° vLog ä¸Šï¼Œä¸èƒ½åˆ©ç”¨ <code>&lt;key, value&gt;</code> ä¸€èµ·çš„å±€éƒ¨æ€§ï¼Œä½†æ˜¯èƒ½ä¿è¯è¾ƒå°çš„ LSMTree Levelï¼Œç”¨è¿™ä¸ªæ¥èŠ‚çœèµ°ä¸€å † index block çš„è¯»æ”¾å¤§ã€‚è¿™é‡Œå¯ä»¥æœ‰ï¼š</p><blockquote><p>For example, assuming 16-B keys and 1-KB values, if the size of the entire key-value dataset is 100 GB, then the size of the LSM-tree is only around 2 GB (assuming a 12-B cost for a valueâ€™s location and size), which can be easily cached in modern servers which have over 100-GB of memory.</p></blockquote><p>Figure4 ç»™å‡ºäº† WiscKey çš„åŸºæœ¬è®¾è®¡ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™ä¸ªè®¾è®¡æ˜¯æ²¡æœ‰è€ƒè™‘ GC çš„ï¼Œåé¢è¿˜å¾—æ”¹å‘¢=ã€‚=</p><p>LSM-tree çš„ <code>addr</code> å·®ä¸å¤šæ˜¯ <code>(&lt;vLog-offset, value-size&gt;)</code> è¿™ä¸ªæ ¼å¼ã€‚é‚£ä¹ˆè¿™ä¸ªæ—¶å€™ï¼Œé€»è¾‘å¤§æ¦‚å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">delete:</span><br><span class="line">delete in LSM-tree</span><br><span class="line"></span><br><span class="line">Insert:</span><br><span class="line">insert value log</span><br><span class="line">insert in LSM-tree</span><br><span class="line"></span><br><span class="line">get:</span><br><span class="line">get in LSM-tree</span><br><span class="line">get in value log by offset if key exists.</span><br></pre></td></tr></table></figure><h3 id="ä¼˜åŒ–-Range-Query"><a href="#ä¼˜åŒ–-Range-Query" class="headerlink" title="ä¼˜åŒ– Range Query"></a>ä¼˜åŒ– Range Query</h3><p>LevelDB æä¾›äº† <code>iterator</code> ï¼Œè¿™æœ‰ä¸€äº›å¯¹åº”çš„ api:</p><ol><li><code>Seek(key)</code></li><li><code>Next</code></li><li><code>Prev</code></li><li><code>Key</code></li><li><code>Value</code></li></ol><p>åœ¨ LevelDB é‡Œé¢ï¼Œè¿™å‡ ä¸ªæ“ä½œéƒ½æ˜¯æ¯”è¾ƒæœ´ç´ çš„ï¼ŒKey Value æ‹¿åˆ° iterator ç°æœ‰çš„ä¸œè¥¿ï¼Œè¿”å› Slice. Next è¦ä¹ˆç›´æ¥ä¸‹ä¸€ä¸ªï¼Œç„¶åèµ°ä¸‹å‰ç¼€å‹ç¼©ç›¸å…³çš„é€»è¾‘ï¼Œè¦ä¹ˆè·³åˆ° Index ä¸Šå†æ‰¾ä¸ª data block. è¿™é‡Œæœ‰ä¸ªå¥½å¤„å°±æ˜¯ï¼Œrange scan å†å•ä¸ª SST ä¸Šè¿˜æ˜¯æœ‰ä¸€å®šå±€éƒ¨æ€§çš„ã€‚åæ­£ value éƒ½å­˜åœ¨ä¸€èµ·ã€‚</p><p>WiscKey è¿™é‡Œé™ä½äº†å±€éƒ¨æ€§ã€‚è§£å†³æ–¹æ¡ˆæ˜¯ï¼Œå¦‚æœå‘ç°æŸ¥è¯¢æ˜¯ä¸€ä¸ª range ç›¸å…³çš„æŸ¥è¯¢ï¼Œè¿™é‡Œä¼šæå‰æ‹‰å‡ºä¸€å † key å¯¹åº”çš„ addr, ç„¶å issue å¹¶è¡Œè¯»ã€‚è¿™é‡Œä¼šæœ‰ä¸€æ‰¹ç›¸å…³çš„çº¿ç¨‹æ¥å®Œæˆè¿™äº›è¯»ç›¸å…³çš„æ“ä½œï¼š</p><blockquote><p>The corresponding value addresses retrieved from the LSM-tree are inserted into a queue; multiple threads will fetch these addresses from the vLog concurrently in the background.</p></blockquote><h3 id="GC"><a href="#GC" class="headerlink" title="GC"></a>GC</h3><p><img src="https://image.mwish.me/blog-image/62A40683-41CB-4012-A3AD-5C0D272659CA.png" alt="62A40683-41CB-4012-A3AD-5C0D272659CA"></p><p>LevelDB æ˜¯æ€ä¹ˆ GC çš„å‘¢ï¼Ÿç­”æ¡ˆæ˜¯ Compaction çš„æ—¶å€™æŠŠä¸å†éœ€è¦çš„æ•°æ®å¹²æ‰ã€‚å› ä¸ºå®ƒçš„ key-value æ˜¯åœ¨ä¸€èµ·çš„ï¼Œæ‰€ä»¥è¿™é‡Œæ˜¯ç›¸å¯¹è½»æ¾çš„ã€‚</p><p>WiscKey Compaction çš„æ—¶å€™æ²¡æœ‰åŠ¨ vLog, å®ƒéœ€è¦æ ¹æ® vLog æ¥åš GCã€‚è¿™ä¸ªæ—¶å€™ï¼Œå®ƒè‚¯å®šéœ€è¦èµ° LSM-tree æ¥æŸ¥çœ‹ key æ˜¯ä¸æ˜¯ä¸å†éœ€è¦çš„äº†ï¼Œæ‰€ä»¥ vLog è¦èƒ½å¤Ÿç´¢å¼•åˆ° key. å¦‚ Figure 5, è¿™é‡Œåœ¨ vLog ä¸­ç¼–ç äº† key, ç°åœ¨æ ¼å¼æ˜¯ï¼š<code>(key size, value size, key, value)</code>.</p><p>vLog è¿™é‡Œæä¾›äº† <code>tail</code> å’Œ <code>head</code>. å½“ GC çš„æ—¶å€™ï¼Œè¿™é‡Œä» <code>tail</code> æ‹¿å‡  MB çš„ kv pair, ç„¶åèµ° LSM-tree æŸ¥çœ‹æ•°æ®å¯ä¸å¯ä»¥è¢« GCã€‚è¿™é‡Œä¼šæŠŠè¿˜éœ€è¦ç”¨çš„æ•°æ®æ”¾åˆ° head å¤„ï¼Œç„¶åè°ƒæ•´ tail çš„ä½ç½®ã€‚è¿™é‡Œä¸ºäº†ä¿è¯æ­£ç¡®æ€§ï¼Œéœ€è¦æœ‰è¿™æ ·çš„é¡ºåºï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1. å°†æœ‰æ•ˆçš„å€¼ append åˆ° head ä¸Š</span><br><span class="line">2. fsync vLog file</span><br><span class="line">3. æŠŠæ›´æ–°çš„å€¼çš„åœ°å€åŠ å…¥åˆ° LSM-tree</span><br><span class="line">4. å†™å…¥ tail å˜æ›´çš„ä¿¡æ¯</span><br><span class="line">5. å›æ”¶ tail</span><br></pre></td></tr></table></figure><p>å…¶å® (3) è¿™ä¸ªåœ°æ–¹æ˜¯æœ‰ä¸€è‡´æ€§é—®é¢˜çš„ï¼šæœ‰æ•ˆæ•°æ®ä½ æƒ³æ€ä¹ˆæ›´æ–°å‘¢ï¼Ÿæ„Ÿè§‰è¿™é‡Œè¿˜æŒºéº»çƒ¦çš„ï¼Œæ²¡æœ‰ snapshot çš„è¯å€’æ˜¯è¿˜å¥½ï¼Œå¦‚æœè€ƒè™‘ LevelDB çš„ multi-version çš„è¯ï¼Œæ„Ÿè§‰é—®é¢˜è¿˜ä¸å°â€¦</p><p>WiscKey å¯ä»¥é…ç½® GC è§¦å‘çš„ patternï¼Œæ¯”å¦‚å®šæœŸè§¦å‘ä¹‹ç±»çš„ã€‚åŒæ—¶ï¼Œåˆ é™¤å°‘çš„è´Ÿè½½ä¼šå¾ˆå°‘è§¦å‘ GCã€‚</p><h3 id="Crash-Consistency"><a href="#Crash-Consistency" class="headerlink" title="Crash Consistency"></a>Crash Consistency</h3><p>è¿˜è®°å¾— vLog æ˜¯ä»€ä¹ˆæ ·å­å—ï¼Ÿ<code>(key size, value size, key, value)</code>ã€‚æœ‰äº†è¿™ä¸ªï¼Œå®é™…ä¸Šå°±ç›¸å½“äº wal äº†ã€‚ï¼ˆé‚£è¿™ä¸ªå’Œ LevelDB åŒºåˆ«æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿå®é™…ä¸Š LevelDB ä¸€ä¸ª memtable å¯¹åº”ä¸€ä¸ª Log fileï¼Œè€Œ WiscKey æŠŠè¿™ä¸ªç©æ„æŠ½å¼€äº†ï¼‰ã€‚è¿™å®é™…ä¸Šå°±èƒ½ä¿è¯ consistencyã€‚</p><p>å½“ç„¶ï¼Œæ•°æ®æ˜¯å¯èƒ½æœ‰ corrupt çš„ã€‚WiscKey å‘ç° log corrupt çš„æ—¶å€™ï¼Œå¯ä»¥åœ¨ LSMTree ä¸­è¡¨ç¤ºæ— è¯¥è®°å½•ã€‚</p><h3 id="ä¼˜åŒ–"><a href="#ä¼˜åŒ–" class="headerlink" title="ä¼˜åŒ–"></a>ä¼˜åŒ–</h3><h4 id="Value-Log-Buffer"><a href="#Value-Log-Buffer" class="headerlink" title="Value-Log Buffer"></a>Value-Log Buffer</h4><p>è¿™ä¸ªå°±å¾ˆç®€å•ï¼ŒæŠŠ vLog å†™åˆ° buffer é‡Œï¼Œå†™æ»¡äº†å†åˆ·ï¼Œè¿™ä¸ªå°±ï¼Œä¸€è‡´æ€§/æ€§èƒ½ trade-off äº†ã€‚</p><h4 id="Optimizing-the-LSM-tree-Log"><a href="#Optimizing-the-LSM-tree-Log" class="headerlink" title="Optimizing the LSM-tree Log"></a>Optimizing the LSM-tree Log</h4><p>è¿™é‡Œï¼Œæˆ‘ä»¬åˆšåˆšè¯´åˆ°ï¼Œ<code>tail</code> ä¼šåœ¨ GC çš„æ—¶å€™è°ƒæ•´ã€‚è¿™é‡Œçš„ head æ˜¯æŒä¹…åŒ–çš„ï¼Œé‚£ä¹ˆæˆ‘ä»¬è€ƒè™‘ï¼Œrecover çš„æ—¶å€™ï¼Œå®é™…ä¸Šåªè¦ä» <code>head</code> å¼€å§‹ï¼ŒæŠŠå®ƒå½“ ckptï¼Œå¾€åæ‰« log æ¥æ¢å¤ã€‚</p><h3 id="Implemention"><a href="#Implemention" class="headerlink" title="Implemention"></a>Implemention</h3><p>vLog å¯èƒ½æœ‰ä¸åŒçš„è®¿é—®æ¨¡å¼ï¼Œè¿™é‡Œç”¨ <code>posix_fadvise()</code> æ¥äº¤ç»™æ–‡ä»¶ç³»ç»Ÿå¤„ç†</p><p>åŒæ—¶ï¼Œå¯¹äº Scanï¼ŒWiscKey ç»´æŠ¤äº† 32 ä¸ªçº¿ç¨‹æ¥å¤„ç†ã€‚</p><blockquote><p>These threads sleep on a thread-safe queue, waiting for new value addresses to arrive. When prefetching is triggered, WiscKey inserts a fixed number of value addresses to the worker queue, and then wakes up all the sleeping threads. These threads will start reading values in parallel, caching them in the buffer cache automatically.</p></blockquote><p>è¿™é‡Œç”¨ <code>fallocate(2)</code> æ¥å¤„ç† disk ä¸Šçš„ç©ºé—´ï¼š <a href="https://man7.org/linux/man-pages/man2/fallocate.2.html">https://man7.org/linux/man-pages/man2/fallocate.2.html</a></p><h2 id="Evaluation"><a href="#Evaluation" class="headerlink" title="Evaluation"></a>Evaluation</h2><p><img src="https://image.mwish.me/blog-image/AEE04BBB-1802-414A-8EF5-C8B9B17D6D78.png" alt="AEE04BBB-1802-414A-8EF5-C8B9B17D6D78"></p><p><img src="https://image.mwish.me/blog-image/25B3417B-F9AA-4B0F-BF21-706C3DFE2E3B.png" alt="25B3417B-F9AA-4B0F-BF21-706C3DFE2E3B"></p><p>å¯ä»¥çœ‹åˆ°ï¼Œä¸çŸ¥é“å‡ºäºä»€ä¹ˆåŸå› ï¼Œä½œè€…å¾ˆé€†å¤©çš„æŠŠ WiscKey å†™æˆäº† WhisKey, æˆ‘æœäº†ä¸‹ï¼Œæ²¡æ‰¾åˆ°åŸå› ã€‚å€¼å¾—å…³æ³¨çš„å…¶å®è¿˜æ˜¯ Figure 8 ç­‰ä¸€äº› LevelDB æ€§èƒ½ç“¶é¢ˆå‡ºç°çš„åœ°æ–¹äº†ã€‚</p><h2 id="æˆ‘çš„ä¸€äº›é—®é¢˜"><a href="#æˆ‘çš„ä¸€äº›é—®é¢˜" class="headerlink" title="æˆ‘çš„ä¸€äº›é—®é¢˜"></a>æˆ‘çš„ä¸€äº›é—®é¢˜</h2><ol><li>GC ç›¸å…³çš„å†™æ”¾å¤§æ„Ÿè§‰æ˜¯æ²¡æœ‰å¾ˆå¥½çš„è¡¡é‡çš„ï¼ŒvLog GC å¯èƒ½æ¯”è¾ƒçœå†™æ”¾å¤§ï¼Œä½†æ˜¯èƒ½çœå¤šå°‘è¯»å†™æ”¾å¤§å‘¢ï¼Œè¿™ä¸ªæœ‰å¾ˆå¥½çš„ tunning å—ï¼Ÿ</li><li>Consistency æ€ä¹ˆèƒ½å¾ˆå¥½çš„ä¿è¯å‘¢ï¼Ÿå‡å¦‚ GC çš„æ—¶å€™ï¼Œé‚£æˆ‘ä»¬è¦æ›´æ–°æ‰€æœ‰çš„ LSMTree çš„ indexï¼Œè¿™å¯èƒ½æš—ç¤º</li></ol>]]></content>
      
      
      
        <tags>
            
            <tag> database, storage </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>VLDB&#39;17 Fast Scans on Key-Value Stores</title>
      <link href="/2021/07/27/VLDB-17-Fast-Scans-on-Key-Value-Stores/"/>
      <url>/2021/07/27/VLDB-17-Fast-Scans-on-Key-Value-Stores/</url>
      
        <content type="html"><![CDATA[<h1 id="VLDBâ€™17-Fast-Scans-on-Key-Value-Stores"><a href="#VLDBâ€™17-Fast-Scans-on-Key-Value-Stores" class="headerlink" title="VLDBâ€™17 Fast Scans on Key-Value Stores"></a>VLDBâ€™17 Fast Scans on Key-Value Stores</h1><p>å°½ç®¡ KV æ¨¡å‹ä¸­ï¼ŒScan æ˜¯ä¸€ä¸ªéå¸¸å¸¸è§çš„éœ€æ±‚ï¼Œä½†æ˜¯å¤§éƒ¨åˆ†æ—¶å€™ï¼ŒScan å…¶å®æ•ˆç‡æ˜¯å¾ˆä¸å°½äººæ„çš„ã€‚ä»¥ LevelDB ä¸ºä¾‹ï¼Œå®ƒçš„ Scan éœ€è¦æ„å»º <code>Iterator</code>, ç„¶åæŠŠ Memtable, L0 å±‚ï¼Œå…¶ä½™å±‚çš„ overlap éƒ½å¯èƒ½è¯»åˆ°å¯¹åº”çš„å†…å®¹ï¼Œå¹¶ä¸”å¯èƒ½éœ€è¦åˆå¹¶ç›¸åŒ User Key çš„æ•°æ®ã€‚æ­¤å¤–å¯èƒ½è¿˜éœ€è¦ Manual Compaction æ¥ç»´æŠ¤ Scan çš„æ•ˆç‡ã€‚</p><p><em>Fast Scans on Key-Value Stores</em> è®ºæ–‡ä»‹ç»äº†ä¸€ä¸ª kv-server çš„æ¨¡å‹, å®ƒåœ¨å°½é‡å°‘é™ä½ get/put çš„æ•ˆç‡çš„æƒ…å†µä¸‹ï¼Œæ”¯æŒäº†é«˜æ•ˆçš„ Scan æŸ¥è¯¢ã€‚è®ºæ–‡æ¯”è¾ƒæ¸…æ™°åœ°ä»‹ç»äº†ä¸€ä¸‹ kv-engine çš„å„ç§è®¾è®¡å–èˆï¼Œæ¨å¯¼å‡ºäº†æ–‡ç« ä»‹ç»çš„ TellStore çš„ç³»ç»Ÿå®ç°ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œ <code>Scan</code> ç»å¸¸æ˜¯ä¸€ä¸ªå…¨è¡¨æ‰«çš„æ¨¡å‹ï¼Œè€Œä¸Šå±‚é€šè¿‡ range partition æ¥é™åˆ¶ scan çš„èŒƒå›´ã€‚</p><h2 id="Abstract-and-Introduction"><a href="#Abstract-and-Introduction" class="headerlink" title="Abstract and Introduction"></a>Abstract and Introduction</h2><p>KV æ¨¡å‹å’Œ KV-Server ï¼ˆä¸‹ç®€ç§° KVSï¼‰ åœ¨ä»Šå¤©å¸‚åœºæ­£åœ¨æ‰©æ•£ï¼ŒåŸå› å½’åŠŸäºç®€å•çš„æ¨¡å‹å’Œåœ¨è¿™ç§æ¨¡å‹ä¸‹é¢ä¸ä¿—çš„æ€§èƒ½ï¼šå¤§éƒ¨åˆ†æ—¶å€™ï¼ŒGet/Put çš„æ€§èƒ½æ˜¯å¯é¢„æµ‹ä¸”é«˜æ•ˆçš„ï¼Œå¯ä»¥åœ¨å¸¸æ•°æ—¶é—´å†…å®Œæˆã€‚ä½†æ˜¯å¤§éƒ¨åˆ†æ—¶å€™ï¼ŒKVS çš„ Scanè¦ä¹ˆ æ²¡æœ‰å¯¹åº”æ¥å£ï¼Œè¦ä¹ˆæ€§èƒ½ä¸ä½³ï¼š</p><p><img src="https://image.mwish.me/blog-image/F62997F2-3FF4-4582-A60F-FA4E9FA71F30.png" alt="F62997F2-3FF4-4582-A60F-FA4E9FA71F30"></p><p>è®ºæ–‡å®ç°äº† TellStore, å³ benchmark çœ‹ä¸Šå»å¾ˆç‰›çš„é‚£äº›ã€‚</p><p>è®ºæ–‡è®¤ä¸ºï¼Œæœ¬è´¨ä¸Šï¼ŒScan çš„é«˜æ€§èƒ½å’Œ Get/Put æ“ä½œçš„é«˜æ€§èƒ½æ˜¯å†²çªçš„ï¼ŒScan éœ€è¦æ‰«ä¸€å®šéƒ¨åˆ†çš„æ•°æ®ï¼š</p><ol><li>Scan å¦‚æœéœ€è¦æ¯”è¾ƒå¥½çš„æ€§èƒ½ï¼Œéœ€è¦å¾ˆé«˜çš„ spatial locality</li><li>Get/Put å¦‚æœéœ€è¦å¾ˆé«˜çš„æ€§èƒ½ï¼Œéœ€è¦ sparse index æ¥å®šä½ã€‚</li><li>Version / GC å¯èƒ½å½±å“æ•ˆç‡ã€‚è€Œå¤š Version çš„å¤„ç†å¯èƒ½ä¹Ÿä¼šå¯¹ Scan æˆ–è€… Get/Put æ€§èƒ½é€ æˆå½±å“ã€‚</li></ol><p>è®ºæ–‡æå‡ºäº† SQL-over-NoSQL çš„æ¶æ„ï¼Œå¹¶ä¸”è¯´æ˜äº†è¿™ç§æ¶æ„ä¸‹ï¼Œå¦‚ä½•é«˜æ•ˆåŒæ—¶æ”¯æŒ Get/Put/Scanã€‚æœ€åï¼Œè®ºæ–‡ä»‹ç»äº†å®ƒä»¬å®ç°çš„ TellStoreã€‚</p><h2 id="Architecture"><a href="#Architecture" class="headerlink" title="Architecture"></a>Architecture</h2><p><img src="https://image.mwish.me/blog-image/B78A7731-9C01-4BF1-9851-CBDE2029BD65.png" alt="B78A7731-9C01-4BF1-9851-CBDE2029BD65"></p><p>è®ºæ–‡æä¾›äº†ä¸€ä¸ª SQL-over-NoSQL çš„æ¶æ„ï¼Œç„¶ååˆ†ä¸ºäº†å‡ å±‚ï¼Œä½œè€…è®¤ä¸ºï¼Œè¿™æ ·çš„æ¶æ„æ˜¯å¼¹æ€§çš„ï¼Œæ¯ä¸€å±‚å¯ä»¥å•ç‹¬çš„å»æ‰©å±•ï¼š</p><ol><li>Storage Layer: å­˜æ”¾åˆ†å¸ƒå¼çš„ KV Storeï¼Œè¿™ç¯‡è®ºæ–‡çš„é‡ç‚¹</li><li>Processing Layer: è´Ÿè´£å¤„ç†è´Ÿè½½ã€‚è¿™é‡Œå¤„ç†äº‹åŠ¡å’ŒæŸ¥è¯¢ã€‚åŒæ—¶å®ç°äº† MVCC å’Œ SI çš„éš”ç¦»çº§åˆ«ã€‚äº‹åŠ¡ç›¸å…³çš„å†…å®¹ç”± Commit Manager å±‚å¤„ç†ã€‚</li><li>Commit Manager: ç»´æŠ¤ SI/MVCCã€‚è¿™é‡Œå®ƒåªè¦ç»™äº‹åŠ¡ Txn Timestamp, å¹¶ä¸”ç®¡ç†äº‹åŠ¡çš„çŠ¶æ€(active/committed/aborted), ä½œè€…è®¤ä¸ºï¼Œå› ä¸ºå®ƒåŠŸèƒ½æ¯”è¾ƒç®€å•ï¼Œæ‰€ä»¥å¾ˆå°‘æˆä¸ºç³»ç»Ÿçš„ç“¶é¢ˆã€‚</li></ol><p>è€Œä¸ºäº†æ”¯æŒ SQLï¼ŒStorage Layer éœ€è¦æä¾›ä¸‹åˆ—çš„è¯­ä¹‰ï¼š</p><ol><li>Scans: æ•°æ®å¯èƒ½ä¼šä»¥ KV çš„å½¢å¼è¢«ç»„ç»‡åœ¨ Storage Layer ä¸Šã€‚SQL è¯·æ±‚é€šå¸¸ä¼šæ‰¹é‡ Scan ä¸€ä¸ªèŒƒå›´çš„ KV æ¥å®ŒæˆæŸ¥è¯¢ã€‚åŒæ—¶ Storage Layer ä¹Ÿè¦èƒ½ä¸‹æ¨ä¸€äº› Selections/Projections/Aggregate ä¹‹ç±»çš„è¯·æ±‚ï¼Œæ¥å‡å°‘ç½‘ç»œå¸¦å®½å¼€é”€å’Œç½‘ç»œè¯·æ±‚å»¶æ—¶ã€‚</li><li>Versioning: æœ¬èº«ä¸Šå±‚æ˜¯ MVCC çš„ï¼Œè¿™é‡Œéœ€è¦ Storage Layer æ”¯æŒå¤šç‰ˆæœ¬ã€‚ä¸éœ€è¦çš„ç‰ˆæœ¬éœ€è¦è¢« GC æ‰ã€‚</li><li>Batching &amp; Asynchronous Communication: æ„Ÿè§‰è¿™ä¸ªå°±æ˜¯å¾ˆå·¥ç¨‹ä¸Šå’Œå¹¶å‘è®¾è®¡çš„é—®é¢˜äº†ã€‚OLTP çš„ç®€å•æŸ¥è¯¢åº”è¯¥è¢« Batch å‘é€åˆ° Storage Layerã€‚<em>è¿™æ ·æ¥å‡æ‘Šå¤šä¸ªå¹¶å‘äº‹åŠ¡çš„é€šä¿¡å¼€é”€ã€‚</em> åŒæ—¶ï¼Œè¿™äº›è¯·æ±‚éœ€è¦èƒ½å¤Ÿè¢«å¼‚æ­¥å¤„ç†ï¼Œä»¥ä¸é˜»å¡ä¸‹ä¸ª Batch çš„è¯·æ±‚ã€‚</li></ol><p>ä¸‹é¢éœ€è¦ä»‹ç» KV è®¾è®¡çš„ trade-off:</p><ol><li>format: å¾ˆå¤šçš„åˆ†æå‹ç³»ç»Ÿä½¿ç”¨ columnar storage æ¥å­˜å‚¨å†…å®¹ã€‚Scan å¦‚æœå½¢å¼ä¸Šæ˜¯ <code>sum(a)</code> ä¹‹ç±»çš„è¯·æ±‚ï¼Œä¼šåœ¨è¿™ä¸Šé¢å¤§å¤§å—ç›Šã€‚ä½†æ˜¯å¯¹äº Get/Put è€Œè¨€ï¼Œè¿™æ ·ä¼šå¯¼è‡´ <code>Get(key)</code> éœ€è¦ materialize, <code>Set(key)</code> åˆ™ä¼šå†™æ”¾å¤§</li><li>versioning: ä¸€å †ç‰ˆæœ¬ï¼ŒScan èµ·æ¥ï¼Œå¦‚æœå®ƒä»¬è´´ä¸€èµ·ï¼Œå°±å¾—è·³è¿‡ä¸€äº›ä¸éœ€è¦çš„ç‰ˆæœ¬çš„æ•°æ®äº†ï¼Œä¸è´´ä¸€èµ·å°±æ›´éº»çƒ¦äº†ã€‚</li><li>batching: è¿™ä¸ªé—®é¢˜å°±å¾ˆå·¥ç¨‹åŒ–äº†ï¼Œæ˜¯ä¸€ä¸ªè´Ÿè½½ç›¸å…³çš„é—®é¢˜ã€‚Scan é€šå¸¸ CPU å¼€é”€æ¯”è¾ƒé‡ï¼Œè€Œ Put/Get å±äºæ¯”è¾ƒè½»çš„æ“ä½œã€‚æ”¾åœ¨ä¸€èµ·å¹¶ä¸æ˜æ™ºã€‚</li></ol><h2 id="Design-Space"><a href="#Design-Space" class="headerlink" title="Design Space"></a>Design Space</h2><h3 id="Where-to-Put-Updates"><a href="#Where-to-Put-Updates" class="headerlink" title="Where to Put Updates?"></a>Where to Put Updates?</h3><p>è®ºæ–‡æŠŠæ›´æ–°çš„åœ°æ–¹åˆ†æˆäº†ä¸‰ç§ï¼š Update-in-place ï¼Œlog-structureï¼Œdelta-main.</p><ul><li>Update-in-place å³ å°±åœ°æ›´æ–°ï¼Œè¿™ä¸ªå¯ä»¥æƒ³åˆ°æˆ‘ä»¬è„‘æµ·ä¸­æ¯”è¾ƒåŸå§‹çš„ B-Tree. è¿™æ ·çš„ç»“æ„å¯¹å®šé•¿çš„æ•°æ®æœ‰ç€å¾ˆå¥½çš„æ€§èƒ½ï¼Œä½†æ˜¯å¯¹å˜é•¿/å¤šç‰ˆæœ¬æ•°æ®è€Œè¨€é€šå¸¸æ„å‘³ç€ç›¸å¯¹å¤æ‚ä¸€äº›çš„å¤„ç†æ–¹æ³•ï¼ŒåŒæ—¶ï¼Œè¿™é‡Œè¿˜æœ‰ä¸€å®šçš„å¹¶å‘é—®é¢˜ï¼Œä¾‹å¦‚ B-Tree çš„å¹¶å‘æ§åˆ¶ã€‚</li><li>Log-structure Storage. æ¯”è¾ƒæç«¯çš„ï¼Œè¿™é‡Œç”¨ append log æ¥å½“ä½œå†™æ•°æ®ã€‚è¿™ä¸ªæ—¶å€™èƒ½å¤Ÿä¿è¯é«˜æ•ˆå’Œæ²¡æœ‰ç©ºé—´ä¸Šçš„ç¢ç‰‡ã€‚çº¯æ—¥å¿—ç»“æ„çš„ put æ˜¯éå¸¸é«˜æ•ˆçš„ï¼Œè€ƒè™‘ç±»ä¼¼ Bitcask çš„ case, <code>Get</code> çš„æ€§èƒ½ä¹Ÿå¯ä»¥åšåˆ°å¾ˆå¥½ï¼Œä½†æ˜¯  <code>Scan</code> å¯èƒ½ç›¸å½“å¤æ‚ã€‚LSM-Tree æ˜¯ä¸€ç§å¾ˆå¥½çš„å¸¸è§å¦¥åæ–¹æ¡ˆã€‚</li><li>Delta-main: æ•°æ®å†™å…¥çš„æ—¶å€™è¢«ç»„ç»‡åœ¨ä¸€ä¸ªå†™ä¼˜åŒ–çš„ç»“æ„ä¸­ï¼Œå®šæœŸè¢«åˆå…¥ä¸€ä¸ªè¯»ä¼˜åŒ–çš„ç»“æ„ã€‚è®ºæ–‡è®¤ä¸ºï¼Œè¿™æ˜¯å°±åœ°æ›´æ–°å’Œæ—¥å¿—æ›´æ–°çš„ trade-off: èƒ½å°½é‡ä¿è¯ä¸¤è€…çš„ä¼˜ç‚¹ã€‚ï¼ˆæˆ‘ä¸ªäººæ„Ÿè§‰è¿™ä¸ªåº”è¯¥ä¼šé¢ä¸´æ¯”è¾ƒå¤§çš„å†™æ”¾å¤§ï¼Ÿï¼‰</li></ul><h3 id="How-to-arrange-records"><a href="#How-to-arrange-records" class="headerlink" title="How to arrange records?"></a>How to arrange records?</h3><p>è¿™å°±æ˜¯ç»å…¸çš„è¡Œå­˜åˆ—å­˜çš„é—®é¢˜äº†ã€‚ç®€å•æ¥è¯´æ–¹æ¡ˆå¤§æ¦‚æœ‰ï¼š</p><ol><li>Row-major: Get/Set èƒ½å¤Ÿç›¸å¯¹æ¥è¯´ç›´æ¥çš„å®Œæˆç›®æ ‡ï¼ŒScan éƒ¨åˆ†è´Ÿè½½ä¼šæœ‰è¾ƒå·®çš„å±€éƒ¨æ€§ã€‚</li><li>Column-major: Get/Set å¯èƒ½éœ€è¦ç‰©åŒ–/å†™æ”¾å¤§ï¼Œä½†æ˜¯ Scan å¯èƒ½å—ç›Šã€‚</li><li>PAX ç±»çš„è¡Œåˆ—æ··å­˜: è¯•å›¾åœ¨ 1/2 ä¸­ trade-offã€‚</li></ol><h3 id="How-to-handle-versions"><a href="#How-to-handle-versions" class="headerlink" title="How to handle versions?"></a>How to handle versions?</h3><p>MVCC æ— è®ºå¦‚ä½•å¤šç‰ˆæœ¬ï¼Œä¸åŒç‰ˆæœ¬è‚¯å®šæ˜¯è¦ç‰©ç†å­˜å‚¨çš„ï¼š</p><ol><li>ä¸åŒç‰ˆæœ¬ç‰©ç†ä¸Šç°‡èšåœ¨ä¸€èµ·ã€‚é€šå¸¸å’Œå°±åœ°æ›´æ–°ä¸€èµ·ç”¨ã€‚</li><li>ä¸åŒç‰ˆæœ¬ç‰©ç†ä¸Šä¸åœ¨ä¸€èµ·ï¼Œä»¥é“¾å¼æ¥å¯»æ‰¾ç‰ˆæœ¬ã€‚é€šå¸¸å’Œ log-structure ä¸€èµ·ç”¨ã€‚å®ƒçš„å±€éƒ¨æ€§ä¸å¥½ï¼Œä½†æ˜¯è¿™èƒ½ç®€åŒ– GC</li></ol><h3 id="When-to-do-Garbage-Collection"><a href="#When-to-do-Garbage-Collection" class="headerlink" title="When to do Garbage Collection?"></a>When to do Garbage Collection?</h3><ol><li>æœ‰çº¿ç¨‹/è¿›ç¨‹å®šæœŸè§¦å‘ GC</li><li>Scan çš„æ—¶å€™ï¼Œè§¦å‘ GC</li></ol><p>2å¯èƒ½ä¼šå¢åŠ  Scan çš„æ—¶é—´ï¼Œä½†æ˜¯å¯èƒ½è¢« Scan æ¯”è¾ƒå¤šçš„åœ°æ–¹æ›´å®¹æ˜“è¢« GCã€‚åŒæ—¶ï¼Œå®ƒåœ¨ Scan çš„æ—¶å€™ GCï¼Œä¹Ÿé¿å…äº† GC ä¹‹åï¼Œå¯èƒ½ä¼šå‡ºç°é¢å¤–çš„ cache miss.</p><h3 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h3><p>ä½œè€…æ¨å‡ºäº†ä»¥ä¸‹çš„å›¾ï¼š</p><p><img src="https://image.mwish.me/blog-image/14B27788-9A82-4099-A238-1AA2A9335142.png" alt="14B27788-9A82-4099-A238-1AA2A9335142"></p><p><img src="https://image.mwish.me/blog-image/115FA5B8-DCEF-4B74-AF70-1C505FC509F5.png" alt="115FA5B8-DCEF-4B74-AF70-1C505FC509F5"></p><p>ä»¥ä¸Šå°±æ˜¯ä¸Šé¢è¿™å‡ ä¸ªç»´åº¦çš„ KV è®¾è®¡æ–¹æ¡ˆäº†ï¼Œä½†æ˜¯å®é™…ä¸Šå¯é€‰çš„æ–¹æ¡ˆæ²¡æœ‰é‚£ä¹ˆå¤šï¼Œæ¯”æ–¹è¯´ update-in-place é€šå¸¸å’Œ row-major åœ¨ä¸€èµ·ï¼Œæœ‰å¾ˆå¤šæ–¹æ¡ˆå®é™…ä¸Šæƒ³æƒ³å°±ä¸å¤ªåˆç†ã€‚æ‰€ä»¥æ–‡ç« ä½œè€…ç›´æ¥è·³åˆ°ç»“æœäº†ï¼š</p><blockquote><p>The two most extreme variants are the variant based on log- structured with chained-versions in a row-major format and the variant using a delta-main structure with clustered-versions in a column-major format. The next two sections describe our imple- mentation of these variants in TellStore, called TellStore-Log and TellStore-Col. Section 6 gives implementation details of TellStore that are important for all TellStore variants.</p></blockquote><p>å—¯ï¼Œå¾ˆåˆç†â€¦</p><p>ä¸‹é¢å°†ä»‹ç» TellStore çš„ç»“æ„ï¼Œè¿™é‡Œä»‹ç»æ¯ä¸ªç»“æ„çš„æ—¶å€™ï¼Œå°†ä¼šå›ç­”ä¸Šé¢æ‰€æœ‰çš„é—®é¢˜ã€‚</p><h2 id="TellStore-Log"><a href="#TellStore-Log" class="headerlink" title="TellStore-Log"></a>TellStore-Log</h2><p><img src="https://image.mwish.me/blog-image/3E9D1EB8-CA83-41BD-898F-9F85B2B7F58F.png" alt="3E9D1EB8-CA83-41BD-898F-9F85B2B7F58F"></p><h3 id="Where-to-Put-Updates-1"><a href="#Where-to-Put-Updates-1" class="headerlink" title="Where to Put Updates?"></a>Where to Put Updates?</h3><p>è¿™é‡Œä¸ºäº†å†™å…¥å¿«é€Ÿï¼Œæ˜¾ç„¶è¦å†™åˆ° log buffer é‡Œé¢ï¼Œè¿™é‡Œå†™å…¥å¤§è‡´é€»è¾‘å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1. æ‹¿åˆ°è®°å½•ï¼Œå†™ log buffer</span><br><span class="line">2. å†™ hash table</span><br><span class="line">3. å¦‚æœæˆåŠŸï¼Œå½“ä½œå†™å…¥æˆåŠŸï¼Œæ›´æ–° log buffer header. å¦åˆ™å†™å…¥å¤±è´¥. è¿™å›å½±å“å…¶ä¸­çš„ valid</span><br></pre></td></tr></table></figure><p>ä¸€æ—¦ä¸Šè¿° 3 æˆåŠŸï¼Œæ—¥å¿—å°±æ˜¯ immutable çš„ã€‚è¿™ä½¿å¾— copy å’Œ recover ç›¸å¯¹æ¥è¯´æ²¡æœ‰é‚£ä¹ˆå¤æ‚ã€‚è¿™é‡Œ 1 å¯ä»¥æ˜¯å¹¶å‘çš„ï¼Œè€Œ 2 ç”¨æ¥åŒæ­¥ï¼šå¯¹äºå†²çªçš„å†™ï¼Œå†™ hashtable æˆåŠŸçš„æ•°æ®.</p><p>åŒæ—¶ï¼Œè¿™é‡Œ hash table å®ç°æ˜¯é¢„å…ˆåˆ†é…å›ºå®šå¤§å°å†…å­˜çš„ã€‚åŒæ—¶ä½¿ç”¨äº†å¼€æ”¾å¯»å€ + çº¿æ€§æ¢æµ‹çš„æ–¹å¼ï¼Œä»¥åˆ©ç”¨ç³»ç»Ÿçš„å±€éƒ¨æ€§ã€‚</p><p>å­˜å‚¨çš„ value è¿™é‡Œå¸Œæœ›å°½å¯èƒ½å°ï¼Œæ‰€ä»¥è®ºæ–‡è¯´å°± 24bytes: </p><blockquote><p>To keep memory usage small while allowing for a sufficiently sized table, the hash buckets only store the table ID, record key and pointer to the record (24 bytes).</p></blockquote><p>(æ‰€ä»¥è¿™ç”¨çš„æ˜¯ gcc4 çš„ cow string å—ï¼Œè¿˜æ˜¯è‡ªå·±å†™äº†ï¼Œå›§â€¦)</p><h3 id="How-to-Arrange-Records"><a href="#How-to-Arrange-Records" class="headerlink" title="How to Arrange Records?"></a>How to Arrange Records?</h3><p>è¡Œ/åˆ—ï¼Ÿæ˜¾ç„¶æ˜¯è¡Œå­˜ã€‚</p><p>æ­¤å¤–ï¼Œä½œè€…ä¸å¸Œæœ› Scan çš„æ—¶å€™è¿˜éœ€è¦æŸ¥ hashtable, æ‰€ä»¥æ•°æ®è‡ªå·±èƒ½è¯´æ˜è‡ªå·±æ˜¯å¦æ˜¯ valid çš„ã€‚æ­¤å¤–ï¼Œè¿™é‡Œä¸ºæ¯ä¸ª table åˆ†é…äº†ä¸€ä¸ª log ç»“æ„ï¼Œè¿™é‡ŒåŠ å¿«äº†å¯¹ table scan çš„æ•ˆç‡ã€‚ï¼ˆå¯æ˜¯æ²¡æœ‰æ‰€ä»¥ç»“æ„å’‹æŸ¥å•Šâ€¦ï¼‰</p><h3 id="How-to-Handle-Versions"><a href="#How-to-Handle-Versions" class="headerlink" title="How to Handle Versions?"></a>How to Handle Versions?</h3><p>è¿™é‡Œçš„ç‰ˆæœ¬å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œé‡‡å–é“¾å¼æ–¹æ³•ä¸²èµ·æ¥ã€‚æ–°çºªå½•éœ€è¦æŒ‡å‘æ—§çºªå½•ï¼ŒåŒæ—¶ <code>validFrom</code> <code>validTo</code> æä¾›äº†å¯¹ç»™å®šæ—¶é—´æˆ³ï¼Œå…è®¸çš„è¯»èŒƒå›´ã€‚é‚£ä¹ˆæˆ‘ä»¬å¯ä»¥åœ¨æ›´æ–°ä¸€ä¸‹ update</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1. æ‹¿åˆ°è®°å½•ï¼Œå†™ log buffer</span><br><span class="line">2. å†™ hash table</span><br><span class="line">3.1 å¦‚æœå†™å…¥å¤±è´¥. è¿™å›å½±å“å…¶ä¸­çš„ valid = false</span><br><span class="line">3.2 æˆåŠŸï¼Œå½“ä½œå†™å…¥æˆåŠŸï¼Œæ›´æ–° log buffer header. å¦‚æœæœ‰ä¸Šä¸€æ¡è®°å½•ï¼Œæ›´æ–° validFrom å’Œä¸Šä¸ªè®°å½•çš„ validTo</span><br></pre></td></tr></table></figure><h3 id="When-to-do-Garbage-Collection-1"><a href="#When-to-do-Garbage-Collection-1" class="headerlink" title="When to do Garbage Collection?"></a>When to do Garbage Collection?</h3><p>è¿™é‡Œæ¯ä¸ª table ä¸€ä¸ª log ç»“æ„çš„è¯ï¼ŒScan çš„æ—¶å€™ï¼Œ <code>validTo</code> å°äºç³»ç»Ÿæœ€å°å¯èƒ½è®¿é—®çš„ tsï¼Œå°±è¯´æ˜è¿™æ¡è®°å½•å¯ä»¥è¢« GC. åœ¨ Scan çš„æ—¶å€™ï¼Œå¦‚æœå‘ç°æŸä¸ª Page (è¿™é‡Œæˆ‘æƒ³äº†ä¸‹ï¼Œæ„Ÿè§‰ log å¯èƒ½æ˜¯åœ¨ Page é‡Œé¢å­˜å‚¨çš„ï¼Œæœ‰ç‚¹ç±»ä¼¼ InnoDB?) çš„å¯ä»¥è¢« GC çš„ record æ¯”ä¾‹è¶…è¿‡ä¸€å®šé˜ˆå€¼ï¼ŒPage å°±å¯ä»¥è¢«æ ‡è®°ä¸ºå¯ GC çš„ã€‚è¿™é‡Œéœ€è¦æŠŠ Page å†… GCï¼Œç„¶åè°ƒæ•´ MVCC å…³ç³»çš„æŒ‡é’ˆï¼Œè¿™ä¸ªæ“ä½œä»£ä»·å¾ˆé«˜ï¼Œä¸” cache locality å¾ˆä½ã€‚</p><h2 id="TellStore-Col"><a href="#TellStore-Col" class="headerlink" title="TellStore-Col"></a>TellStore-Col</h2><p>TellStore-Log æ˜¯ä¸€ä¸ªé«˜æ€§èƒ½æ›´æ–°çš„ç»“æ„ã€‚è€Œè®ºæ–‡å®é™…ä¸Šå¸Œæœ›è®¾è®¡ä¸€ä¸ª Delta-main ç»“æ„ï¼Œå°† TellStore-Log å®šæœŸåˆå¹¶åˆ°ä¸€ä¸ªé«˜æ•ˆ Scan çš„ç»“æ„ä¸­ã€‚</p><p><img src="https://image.mwish.me/blog-image/2F352388-C65C-42EE-8BD6-669142A4BE62.png" alt="2F352388-C65C-42EE-8BD6-669142A4BE62"></p><p>è¿™é‡Œçš„é€»è¾‘å¤§æ¦‚æ˜¯ï¼š</p><ol><li>ä¸€ç³»åˆ—çš„ Main Page ä½œä¸ºç³»ç»Ÿçš„ main å­˜å‚¨</li><li>ä¸¤ä¸ªé€»è¾‘ä¸Šçš„ log list ä½œä¸ºç³»ç»Ÿçš„ delta, åˆ†åˆ«ä¸º insert log å’Œ update log</li></ol><h3 id="Where-to-Put-Updates-2"><a href="#Where-to-Put-Updates-2" class="headerlink" title="Where to Put Updates?"></a>Where to Put Updates?</h3><ol><li>å¦‚æœè¿™ä¸ª key ä¸å­˜åœ¨ï¼Œé‚£ä¹ˆä¸¢åˆ° insert-log é‡Œé¢</li><li>å¦‚æœè¿™ä¸ª key å­˜åœ¨ï¼ˆåœ¨ insert-log æˆ–è€… main ä¸­ï¼‰ï¼Œä¸¢åˆ° update-log é‡Œé¢ã€‚</li></ol><p>æ­¤å¤–ï¼Œè¿˜æœ‰ä¸ª <code>newest</code> å­—æ®µï¼š</p><blockquote><p>Records in the main and insert-log both contain a mutable <em>newest</em> field containing a pointer to the most-recently written element with the same key. </p></blockquote><p>å†™å…¥çš„æ—¶å€™ï¼Œç±»ä¼¼ TellStore-Log çš„ newest ä¼šä½œä¸ºåŒæ­¥å¤„æ¥å¤„ç†ã€‚</p><h3 id="How-to-Arrange-Records-1"><a href="#How-to-Arrange-Records-1" class="headerlink" title="How to Arrange Records?"></a>How to Arrange Records?</h3><p>ä¸¤ä¸ª delta æ—¥å¿—è‚¯å®šè¡Œå­˜ï¼Œmain æ—¥å¿—æ—¢å¯ä»¥è¡Œå­˜ä¹Ÿå¯ä»¥åˆ—å­˜ã€‚TellStore-Col æ˜¯ä¸€ä¸ªåˆ—å­˜å®ç°ï¼Œç„¶åç”¨ç±»ä¼¼ PAX çš„ç»“æ„ <code>ColumnMap</code> æ¥å­˜å‚¨ä¿¡æ¯ï¼š</p><p><img src="https://image.mwish.me/blog-image/368DD607-56BB-4AE3-B48D-2D37DA3F87D5.png" alt="368DD607-56BB-4AE3-B48D-2D37DA3F87D5"></p><ol><li>Meta Data å­˜å‚¨äº†ä¸€äº›å¿…è¦çš„å…ƒä¿¡æ¯</li><li>Fixed-Size Columns å¯èƒ½æ ¹æ® MetaData ç¡®å®šæœ‰å“ªäº›å†…å®¹ï¼Œè¿™é‡ŒçŸ¥é“ç¬¬ä¸€åˆ—åœ¨å“ªå°±å¯ä»¥å¾ˆå¿«å®šä½â€œå“ªä¸€ä¸ªå…ƒç´ åœ¨å“ªâ€ï¼ˆä¼¼ä¹è¿™é‡Œæ²¡æœ‰å‹ç¼©é€»è¾‘ï¼Ÿï¼‰</li><li>Var-size heap å’Œ var-size + meta columns æ˜¯æä¾›ç»™å˜é•¿å­—æ®µï¼Œä¾‹å¦‚ <code>string</code>  <code>BLOB</code> çš„ã€‚â€œThis heap is indexed by fixed-size metadata storing the 4-byte offset into the heap and its 4-byte prefix.â€</li></ol><h3 id="How-to-Handle-Versions-1"><a href="#How-to-Handle-Versions-1" class="headerlink" title="How to Handle Versions?"></a>How to Handle Versions?</h3><p>main page ä¸­çš„ç‰ˆæœ¬ç°‡èšå½¢å¼å­˜å‚¨ï¼Œä» lastest åˆ°æœ€æ—§çš„ç‰ˆæœ¬ã€‚è¿™æ ·ï¼Œå‡è®¾å¸¦ç€ä¸€ä¸ªæ—¶é—´æˆ³æ¥è¯»ï¼Œé‚£å°±éœ€è¦ä¸€ä¸ªæ‰¾åˆ°å¯¹åº”çš„æ—¶é—´ã€‚ä¸è¿‡å› ä¸ºæ˜¯é åœ¨ä¸€èµ·çš„ï¼Œæ‰€ä»¥å±€éƒ¨æ€§å¥½ä¸€äº›ã€‚åŒæ—¶ï¼Œå®ƒä¹Ÿæœ‰ <code>previous</code> æŒ‡é’ˆï¼ŒæŒ‡å‘ Update-Log ä¸­çš„æ•°æ®ã€‚</p><h3 id="When-to-do-Garbage-Collection-2"><a href="#When-to-do-Garbage-Collection-2" class="headerlink" title="When to do Garbage Collection?"></a>When to do Garbage Collection?</h3><p>è¿™é‡Œ GC åŠŸèƒ½è¦å¤æ‚äº›ï¼šå®ƒéœ€è¦æŠŠ update-log å’Œ insert-log åˆå¹¶åˆ° main é‡Œé¢ï¼ˆå¯èƒ½æ˜¯ä»¥è¡Œå­˜ â€”&gt; åˆ—å­˜çš„å½¢å¼ï¼‰ã€‚åŒæ—¶ï¼Œè¿™é‡Œå½¢å¼ç±»ä¼¼ cow, ä¸ä¼šåœ¨ main page åŸåœ°æ›´æ–°ï¼Œè€Œæ˜¯äº§ç”Ÿæ–°çš„ page / reuse page.</p><p>è¿™é‡Œ GC ç”±å•ç‹¬çš„çº¿ç¨‹å¤„ç†ï¼ˆä¸ºä»€ä¹ˆä¸åœ¨ Scan çš„æ—¶å€™å¤„ç†å‘¢ï¼Ÿè®ºæ–‡è§£é‡Šæ˜¯è¿™ä¸ªå·¥ä½œé‡è¾ƒå¤§ã€‚TellStore-Log Scan çš„æ—¶å€™éœ€è¦æ‰«å…¨éƒ¨è®°å½•ï¼Œç„¶åæŠŠæ²¡ç”¨çš„æ”¾å‰é¢å³å¯ã€‚TellStore-Col éœ€è¦ææ–° page + åˆå¹¶ + è¡Œè½¬åˆ—ï¼Œè´Ÿè½½æ¯”è¾ƒå¤§ï¼‰ã€‚</p><p>GC å‘ç°æŸä¸ªè®°å½•éœ€è¦è¢«æ¸…é™¤çš„æ—¶å€™ä¼šè¢«è§¦å‘ã€‚å¯¹äº main page ä¸­çš„ key, ä¸åŒçš„ç‰ˆæœ¬å¯ä»¥ä»è‡ªå·±çš„ä¸´è¿‘æ•°æ®å’Œ update-log ä¸­æ‰¾åˆ°ã€‚ç„¶åå¯ä»¥ä» insert-log ä¸­æ‰¾åˆ°æ–°æ’å…¥çš„æ•°æ®ï¼Œæ‰« update-log æ‹¿åˆ°è¿™äº›æ–°çš„ç‰ˆæœ¬ã€‚<code>validTo</code> è¿‡å°çš„è®°å½•ä¼šè¢« discard æ‰ã€‚å®Œæˆåï¼Œlog è®°å½•ã€è¢« gc çš„ main page å¯ä»¥æ”¾å…¥ç©ºé—² page åˆ—è¡¨ã€‚</p><p>è¿™é‡Œé‡ç”³äº†ä¸€ä¸‹ä¸ºä»€ä¹ˆè¦ update-log:</p><ol><li>åªè¦ scan insert-log, å°±å¯ä»¥æ‰¾åˆ°ä¸åœ¨ main ä¸­çš„æ•°æ®ã€‚</li><li>åŒæ—¶è¿™å¯èƒ½é™ä½äº† locality: åŸæœ¬ scan çš„æ—¶å€™ï¼Œinsert-update ä¸€èµ·ï¼Œå¯èƒ½æ‰¾åˆ°ä¸€ä¸ªè®°å½•ï¼Œå°±å¯ä»¥å‘ç°å®ƒæ˜¯æœ€æ–°çš„ã€‚è€Œæ–°çš„ case ä¸‹ update è¿™é‡Œå¯èƒ½è¦å›æº¯åˆ° insert ä¸Šè¿›è¡Œ random access. è¿™è¦æ±‚ update-log è¢« GC/åˆå¹¶åˆ° main æ˜¯éå¸¸é¢‘ç¹ã€èƒ½å¤Ÿä¿è¯ update-log è¶³å¤ŸçŸ­ã€‚</li></ol><h2 id="Implemention"><a href="#Implemention" class="headerlink" title="Implemention"></a>Implemention</h2><p>è¿™éƒ¨åˆ†ä¸»è¦å°±æ˜¯å·¥ç¨‹å®ç°äº†ã€‚</p><p>ç½‘ç»œä¸Šï¼Œè¿™é‡Œå®ç°é‡‡å–äº† boost.asio çš„å¼‚æ­¥ç­–ç•¥ã€‚åŒæ—¶ï¼Œå¯¹ get/put å’Œ scan çš„çº¿ç¨‹æ± åšäº†åˆ‡åˆ†ï¼šè¿™é‡Œåº”è¯¥è§‰å¾— Scan ç›¸å¯¹é‡ä¸€äº›ï¼Œä¸èƒ½å½±å“è¾ƒè½»çš„ Get/Put æŸ¥è¯¢ã€‚åŒæ—¶ï¼Œè¿˜æœ‰çº¿ç¨‹è´Ÿè´£ GCã€‚</p><p>Scan è¿™é‡Œå†™çš„æœ‰ç‚¹ hack, æœ‰ä¸€ä¸ª scan thread ä½œä¸º coordinatorï¼Œå®ƒä¼šæœé›†æ‰€æœ‰ scan requestï¼Œç„¶åç»‘å®šåˆ°ä¸€ä¸ª shared scan ä¸Šï¼Œç„¶åç”±ä¸€äº›çº¿ç¨‹å»åˆ† part æ‰«ã€‚æ„Ÿè§‰è¿™é‡Œ Scan Request å¤šä¸€äº›æ€§èƒ½ä¼šæ¯”è¾ƒå¥½ã€‚</p><p>è¿™é‡Œè¿˜ç”¨ç±»ä¼¼ Chord çš„å½¢å¼å®ç°äº†ä¸ª DHT ã€‚åŒæ—¶å¦‚æœå¸Œæœ›æ”¯æŒ Rangeï¼Œ<code>Tell</code> è®ºæ–‡ä¸­æåˆ°äº† Lock-Free Btreeï¼Œå®ƒæ˜¯åœ¨ processing layer å®ç°çš„ï¼Œæ„Ÿè§‰åˆ° storage layer éƒ½æ˜¯å‚»å‚»çš„å…¨éƒ¨ scan ç„¶å shared scan.</p><p>æ­¤å¤–ï¼Œè¿™é‡Œå› ä¸º scan çš„ç‰¹æ€§ï¼Œè¿˜åšäº† codegenï¼Œè¿™å—æˆ‘ä¸æ˜¯å¾ˆäº†è§£ï¼Œæ²¡ç»†çœ‹ã€‚</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>[CIDR 05] MonetDB/X100: Hyper-Pipelining Query Execution</title>
      <link href="/2021/07/05/MonetDB-X100-Hyper-Pipelining-Query-Execution/"/>
      <url>/2021/07/05/MonetDB-X100-Hyper-Pipelining-Query-Execution/</url>
      
        <content type="html"><![CDATA[<p>MonetDB/X100 æ˜¯ä¸€ç¯‡ 05 å¹´çš„è®ºæ–‡ï¼Œä¹Ÿæ˜¯åˆ†æå‹æ•°æ®åº“ä¸­å¼•ç”¨è¾ƒå¤šçš„ä¸€ç¯‡è®ºæ–‡ã€‚å®ƒç»™ MonetDB æä¾›äº†ä¸€ä¸ªé«˜æ•ˆçš„æŸ¥è¯¢å±‚ï¼Œå‡å°äº† MonetDB ä¹‹å‰è®¸å¤šæ“ä½œçš„å¼€é”€ã€‚åŒæ—¶ï¼Œè´´åˆäº†å½“æ—¶çš„ç¡¬ä»¶çš„å‘å±•ã€‚ç›®å‰ï¼Œè¿™ç¯‡è®ºæ–‡çš„ Batch ç­‰æ€è·¯å·²ç»è¢«æ¯”è¾ƒå¤§è§„æ¨¡çš„ä½¿ç”¨äº†ï¼ŒåŒæ—¶ï¼Œæ–‡ç« ç»™å‡ºçš„æ‰‹å·¥ç¼–ç ä»£ç çš„ baseline ä¹Ÿç»™ Hyper ç­‰ Codegen æä¾›äº†å¯å‘ã€‚</p><p>åŒæ—¶ï¼Œå³ä½¿ä¸äº†è§£æ•°æ®åº“ï¼Œå­¦ä¹ è¿‡ä½“ç³»ç»“æ„çš„æœ‹å‹ä»¬ä¹Ÿå¯ä»¥çœ‹çœ‹è¿™ç¯‡è®ºæ–‡çš„å‰å‡ ç« ã€‚è™½ç„¶è®ºæ–‡å†™å¾—æ¯”è¾ƒæ—©ï¼Œä½†æ˜¯å¯¹CPU æ€§èƒ½è¿˜æ˜¯æä¾›äº†ä¸€ä¸ªæ¯”è¾ƒå¥½çš„è§†è§’ã€‚</p><p>é™¤å¼€ MonetDB/X100 ä¹‹å¤–ï¼Œæœ¬ç¬”è®°åœ¨ç¬¬ä¸€æ®µä¼šä»‹ç»æ¯”è¾ƒå¤š MonetDB åœ¨æå‡º X100 ä¹‹å‰çš„é€»è¾‘ã€‚</p><h2 id="MonetDB"><a href="#MonetDB" class="headerlink" title="MonetDB"></a>MonetDB</h2><p>MonetDB æœ€æ—©åŸºäº <em>å†…å­˜æ˜ å°„æ–‡ä»¶</em> æ¥é¿å…ä½¿ç”¨æ¯”è¾ƒå¤æ‚çš„ buffer pool, ä¸ä¼ ç»Ÿçš„ RDBMS ä¸åŒ:</p><ol><li>ç”¨ column at-a-time-algebra å–ä»£ volcano é‚£ç±»çš„ row at a time</li><li>minimize CPU cache misses rather than IOs</li><li>ç”¨ç±»ä¼¼ database cracking çš„æŠ€æœ¯ï¼Œæ¥åˆç†çš„ç”Ÿæˆ index</li><li>è¿è¡Œæ—¶å»ä¼˜åŒ–æŸ¥è¯¢</li></ol><p>ä¼ ç»Ÿçš„æ•°æ®åº“ä½¿ç”¨ tuple-at-a-time (æ¯”å¦‚ä¸€æ¬¡ <code>Next</code> æ‹‰ä¸€ä¸ª tuple), pull-based (ä¸Šæ¸¸æœ‰éœ€è¦å°±èµ° <code>Next</code>), iterator ç±»ä¼¼çš„ <code>next()</code> æ‹¿ä¸‹ä¸€æ¡æ•°æ®çš„å½¢å¼ã€‚</p><p>MonetDB æœ€æ—©æ”¯æŒå¯¹ä¸€æ‰¹ column è¿›è¡ŒåŒæ ·çš„æ“ä½œï¼Œé€šè¿‡ç¼–è¯‘å™¨/æ‰‹åŠ¨å®ç°ä¼˜åŒ–ï¼Œæ¥å¢åŠ å¯¹æµæ°´çº¿çš„å‹å¥½æ€§ï¼Œæé«˜ä»£ç çš„ CPI.</p><p>Column-at-at-time åœ¨æœ€åˆæ˜¯ä»¥ <strong>BAT</strong>(Binary Association Table) Algebra çš„å½¢å¼å®ç°çš„ï¼ŒBAT ç±»ä¼¼ <code>&lt;surrogate,value&gt;</code> ï¼Œå‰ä¸€ä¸ªåœ°å€æ˜¯è™šæ‹Ÿçš„ã€‚è¯»å‡ºæ¥çš„æ•°æ®ã€è¿ç®—è¿‡ç¨‹ä¸­çš„æ•°æ®å’Œç»“æœéƒ½æ˜¯ä»¥ BAT çš„å½¢å¼å­˜å‚¨çš„ã€‚</p><p>BAT è¿ç®—ä¹Ÿç±»ä¼¼ä¸€ç§ IRï¼Œå‰ç«¯ä¼šæŠŠè¯·æ±‚ç¼–è¯‘æˆ BAT Algebra, ç»™ backendï¼Œå³æ‰§è¡Œ BAT Algebra çš„éƒ¨åˆ†æ‰§è¡Œã€‚</p><p><img src="https://image.mwish.me/blog-image/D080EC21-89D4-4AF6-9494-2548832E6843.png" alt="D080EC21-89D4-4AF6-9494-2548832E6843"></p><p>BAT algebra é’ˆå¯¹ä¸€ä¸ª column çš„æ‰€æœ‰æ•°æ®æ‰§è¡Œç®€å•é«˜æ•ˆçš„æ“ä½œã€‚å®ƒçš„æ€è·¯æ˜¯ï¼š</p><blockquote><p>by making the algebra simple, the opportunities are created for implementations that execute the common case very fast.</p></blockquote><p>ä¸ºäº†å¤„ç†æ›´æ–°ï¼ŒMonetDB è¦ç»™æ¯ä¸ª column å‡†å¤‡ä¸€ä¸ª pending updates set. è¯»å–çš„æ—¶å€™ï¼Œè¦ merge ä¸¤è¾¹çš„è¯·æ±‚ã€‚</p><h2 id="CPU-amp-amp-DB"><a href="#CPU-amp-amp-DB" class="headerlink" title="CPU &amp;&amp; DB"></a>CPU &amp;&amp; DB</h2><p>åœ¨ MySQL ç­‰ RDBMS ä¸­ï¼Œä»£ç çš„ CPI æ¯”è¾ƒä½ã€‚è€Œ 05 å¹´çš„æ—¶å€™ï¼ŒCPU ä¹Ÿåœ¨è¿›è¡Œç€å‘å±•ï¼Œå¯ä»¥çœ‹ä¸‹é¢ä¸¤å¼ å›¾ï¼š</p><p><img src="https://image.mwish.me/blog-image/00CB7129-27B1-45E4-BFEC-37320EBCF2DB.png" alt="00CB7129-27B1-45E4-BFEC-37320EBCF2DB"></p><p>ä¸Šé¢è¿™å¼ å›¾ä»‹ç»äº†å•æ ¸çš„é¢‘ç‡å½±å“</p><p><img src="https://image.mwish.me/blog-image/1C9DB6BB-314C-4831-AD23-0FD34C247A49.png" alt="1C9DB6BB-314C-4831-AD23-0FD34C247A49"></p><p>ä¸‹é¢æ˜¯ CPU çš„æ€§èƒ½ã€‚æ–‡ç« å†™äº 05 å¹´ï¼Œå¯ä»¥çœ‹åˆ°å½“æ—¶çš„è¶‹åŠ¿ã€‚è¿™ç¯‡æ–‡ç« èšç„¦åœ¨ Hyper-pipeline CPU ä¸Šï¼Œæˆ‘çœ‹äº†ä¸‹ï¼Œæ„Ÿè§‰è¿™ä¸ªæœ¯è¯­ç±»ä¼¼ superscalarã€‚</p><p>æ–‡ç« è®¤ä¸ºï¼ŒAP å‹æ•°æ®äº§å“éœ€è¦æå‡æŸ¥è¯¢çš„æ€§èƒ½ï¼Œé¿å… CPI ä½çš„æƒ…å†µã€‚MonetDB ä¸€å®šç¨‹åº¦ä¸Šä¼˜åŒ–äº†è¿™ä¸€ç‚¹ï¼Œä½†æ˜¯ï¼š</p><blockquote><p>However, its policy of full column materialization causes it to generate large data streams during query execution. </p></blockquote><p>ä¸Šè¿°å†…å®¹ä¸­ï¼Œæˆ‘ä»¬è¿˜è®°å¾—æ¯æ¬¡å®ƒæ‰«ä¸€åˆ—ï¼Œç„¶åç”Ÿæˆä¸€ä¸ª BAT, é€ æˆäº†å¾ˆå¤šé¢å¤–å¼€é”€ã€‚</p><p>æ‰€ä»¥è¿™ç¯‡æ–‡ç« ä¸»è¦å†…å®¹æ˜¯ï¼š</p><blockquote><p>Therefore, we argue to combine the column-wise execution of MonetDB with the incremental materialization offered by Volcano-style pipelining.</p></blockquote><p>å®ƒæä¾›äº†ä¸€ä¸ª X100 çš„ Query Engineã€‚æä¾›äº† vectorized query processing model.</p><h3 id="å¯ä»¥æä¾›çš„ä¼˜åŒ–"><a href="#å¯ä»¥æä¾›çš„ä¼˜åŒ–" class="headerlink" title="å¯ä»¥æä¾›çš„ä¼˜åŒ–"></a>å¯ä»¥æä¾›çš„ä¼˜åŒ–</h3><p>ç°ä»£ CPU é  Pipeline æ¥ä¼˜åŒ–æ€§èƒ½ï¼Œè€Œ Pipeline å¯èƒ½ä¼šæœ‰å„ç§ hazardã€‚æ­¤å¤–ï¼Œif-else-then condition å¯èƒ½ä¼šåœ¨åˆ†æ”¯é¢„æµ‹ä¸Šå½±å“æ€§èƒ½ã€‚2020 å¹´ï¼Œbranch mispredict å¤§æ¦‚éœ€è¦ 3ns. è¿™éœ€è¦ flush pipeline. æ­¤å¤–ï¼Œç°ä»£ CPU ä¾é å¤šçº§æµæ°´çº¿æ¥ä¼˜åŒ–ååé‡ã€‚</p><blockquote><p>Translated to database systems, branches that are data-dependent, such as those found in a selection operator on data with a selectivity that is neither very high or very low, are impossible to predict and can significantly slow down query execution</p></blockquote><p>æ­¤å¤–ï¼Œè¿™é‡Œè¿˜æœ‰ hyper-pipeline ç­‰æŠ€æœ¯ï¼Œèƒ½å¤Ÿä½¿ç”¨å¤šä¸ª pipeline, ä½¿ CPU &gt;= 1. æˆ‘ä¸ªäººæ„Ÿè§‰è¿™ç¯‡æ–‡ç« çš„ <em>hyper-pipeline</em> æ„æ€åº”è¯¥å’Œç°åœ¨ superscalar å·®ä¸å¤šã€‚</p><p>ç¼–è¯‘å™¨ä¸€èˆ¬ä¼šæŠŠèƒ½ä¼˜åŒ–çš„ä»£ç å°½é‡ä¼˜åŒ–ï¼Œä¸€ç§æœ‰ç”¨çš„æŠ€æœ¯å« <em>loop pipelining</em>:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">F(A[0]),G(A[0]), F(A[1]),G(A[1]),.. F(A[n]),G(A[n])</span><br><span class="line">into:</span><br><span class="line">F(A[0]),F(A[1]),F(A[2]), G(A[0]),G(A[1]),G(A[2]), F(A[3]),..</span><br></pre></td></tr></table></figure><p>ä¸Šè¿°å†…å®¹å¯ä»¥å¸®åŠ© CPU ç”¨ OoO å’Œ SIMD ç­‰æ–¹å¼æ‰§è¡Œï¼Œæé«˜å¹¶è¡Œåº¦ã€‚æ­¤å¤–ï¼Œç¼–è¯‘å™¨è¿˜èƒ½è¯•å›¾ä¼˜åŒ– branch prediction:</p><p><img src="https://image.mwish.me/blog-image/E7C4ABDA-AFB3-4AD6-A7C6-78688BFFDA66.png" alt="E7C4ABDA-AFB3-4AD6-A7C6-78688BFFDA66"></p><p>è¿˜å¯ä»¥çœ‹åˆ°ï¼š<a href="https://stackoverflow.com/questions/11227809/why-is-processing-a-sorted-array-faster-than-processing-an-unsorted-array">https://stackoverflow.com/questions/11227809/why-is-processing-a-sorted-array-faster-than-processing-an-unsorted-array</a></p><p>æœ€åä¸€ç‚¹ä¸æ€§èƒ½çš„æœ€å¥½çš„æœ‹å‹å’Œæœ€å¤§çš„æ•Œäºº cache æœ‰å…³:</p><blockquote><p>and can significantly improve if cache-conscious data structures are used, such as cache-aligned B-trees [15, 7] or column-wise data layouts such as PAX [2] and DSM [8] (as in MonetDB).</p></blockquote><h3 id="TPC-H-æµ‹è¯•"><a href="#TPC-H-æµ‹è¯•" class="headerlink" title="TPC-H æµ‹è¯•"></a>TPC-H æµ‹è¯•</h3><p>åœ¨æµ‹è¯•ä¸­ï¼Œä¼ ç»Ÿ DMBS çš„ CPU IPC åªæœ‰ 0.7 ã€‚è€Œç§‘å­¦è®¡ç®—çš„ IPC æœ‰ 2. è®ºæ–‡é€‰å»äº† TPC-H Query 1 ä½œä¸ºäº†æµ‹è¯•çš„ case.</p><p>TPC-H æ•°æ®åŸºäº 1GB çš„æ•°æ®ä»“åº“ï¼Œå¯ä»¥æ ¹æ® Scaling Factor (SF) æ¥æ›´æ–°è¿™ä¸ªå¤§å°ã€‚</p><p>ä¼ ç»Ÿ RDBMS é€šå¸¸ä½¿ç”¨ç«å±±æ¨¡å‹ï¼ŒåŒæ—¶è¦æ”¯æŒå¾ˆå¤š flexible çš„æŸ¥è¯¢ï¼Œè¿™ä¸€ç‚¹ä¼šå¤§å¤§å½±å“æ€§èƒ½ï¼š</p><blockquote><p>For instance, even a simple ScanSelect(R,b,P) only at query-time receives full knowledge of the format of the input relation R (number of columns, their types, and record offsets), the boolean selection expression b (which may be of any form), and a list of projection expressions P (each of arbitrary complexity) that define the output relation. In order to deal with all possible R,b, and P, DBMS implementors must in fact implement an expression interpreter that can handle expressions of arbitrary complexity.</p></blockquote><p><img src="https://image.mwish.me/blog-image/CC55337B-7F22-4CC3-9820-A8B1BF3CC58F.png" alt="CC55337B-7F22-4CC3-9820-A8B1BF3CC58F"></p><p>è®ºæ–‡åˆ†æäº† MySQL:</p><p><img src="https://image.mwish.me/blog-image/92B8BC80-EF8B-45F0-96AA-88E3CE62796C.png" alt="92B8BC80-EF8B-45F0-96AA-88E3CE62796C"></p><p>æµ‹è¯•å‘ç°ï¼Œå¤§æ¦‚å¾ˆå°‘é‡çš„å·¥ä½œåœ¨åšå®é™…çš„è®¡ç®—, å¤§éƒ¨åˆ† workload éƒ½åœ¨ <code>rec_get_nth_field</code> è¿™ç§ä¼ æ¥ä¼ å»çš„ä¸œè¥¿ä¸Šï¼Œè¿˜æœ‰ agg çš„ hashset.</p><p>å¦å¤–ä¸€é¡¹æ“ä½œæ˜¯ <code>::val</code> , è¿™ä¸ªä»å…·ä½“çš„å†…å­˜ä¸­æå‡ºéœ€è¦è®¡ç®—çš„ <code>int</code> æˆ–è€… <code>float</code>, è¿™ä¸ªåœ°æ–¹ç›¸å¯¹æ¥è¯´ä¹Ÿæ¯”è¾ƒè´¹ï¼š</p><p>A simple arithmetic operation <code>+(double src1, double src2) : double</code> in RISC instructions would look like:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">LOAD src1,reg1</span><br><span class="line">LOAD src2,reg2</span><br><span class="line">ADD reg1,reg2,reg3</span><br><span class="line">STOR dst,reg3</span><br></pre></td></tr></table></figure><p>MySQL è¿™ä¸ªæ•ˆç‡éå¸¸ä½ã€‚å€’ä¸æ˜¯æ‰§è¡Œè¿™å‡ æ¡æŒ‡ä»¤ä¼šå¾ˆç—›ï¼Œè€Œæ˜¯è¯´ï¼Œè¿™é‡Œæ˜¯å¯ä»¥æ›´å¿«çš„ï¼š</p><blockquote><p>The limiting factor in this code are the three load/store instructions, thus a MIPS processor can do one *(double,double) per 3 cycles. This is in sharp contrast to the MySQL cost of #ins/Instruction-Per- Cycle (IPC) = 38/0.8 = 49 cycles!</p></blockquote><p>åˆ©ç”¨ä¸Š loop-pipelining, SIMD ç­‰æŠ€æœ¯ï¼Œä¸€èµ·å¤„ç†ï¼Œèƒ½è®©è¿™å—æ€§èƒ½å¤§å¤§æé«˜ã€‚è¿™ä¸€å—çš„ç»“è®ºæ˜¯ï¼š</p><ol><li><code>Item_func_plus::val</code> åº”è¯¥è¢« loop-pipelining çš„å¤„ç†ï¼Œå’Œæˆ‘ä»¬ä¹‹å‰è¯´çš„ä¸€æ ·ï¼Œè¿™é‡Œå¯ä»¥åˆ©ç”¨ä¸Š SIMD, å¾ªç¯å±•å¼€ç­‰ä¼˜åŒ–ã€‚</li><li>å‡½æ•°è°ƒç”¨çš„å¼€é”€åº”è¯¥è¢«å‡æ‘Šã€‚</li></ol><h4 id="TPC-H-æµ‹è¯•-MonetDB-MIL"><a href="#TPC-H-æµ‹è¯•-MonetDB-MIL" class="headerlink" title="TPC-H æµ‹è¯• MonetDB/MIL"></a>TPC-H æµ‹è¯• MonetDB/MIL</h4><p>MIL å°±æ˜¯æˆ‘ä»¬ä¹‹å‰æåˆ°çš„ BAT è¿ç®—ã€‚ä»–æå–å›ºå®šå½¢çŠ¶çš„å‚æ•°ï¼Œäº§ç”Ÿå›ºå®šå½¢çŠ¶çš„ç»“æœï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">join(BAT[tl,te] A, BAT[te,tr] B) : BAT[tl,tr]</span><br></pre></td></tr></table></figure><p>MIL çš„ Join å¯èƒ½éœ€è¦ reverse ç­‰æ“ä½œï¼Œè¿™ä¸ªå¯ä»¥è§å›¾ï¼š</p><p><img src="https://image.mwish.me/blog-image/D6A29DE1-7ADF-4C86-B16F-8DB98E4303D1.png" alt="D6A29DE1-7ADF-4C86-B16F-8DB98E4303D1"></p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒJoin éœ€è¦çš„ <code>reverse</code> ä¸ä¼šå®é™…æ‹·è´ã€‚ï¼ˆè‚¯å®šæ²¡é‚£ä¹ˆå‚»ï¼‰</p><p><img src="https://image.mwish.me/blog-image/4EA0C11E-0B7A-4A2A-BB98-30757A34F1DD.png" alt="4EA0C11E-0B7A-4A2A-BB98-30757A34F1DD"></p><p>MonetDB ä¹‹å‰çš„è®¡ç®— CPU æ•ˆæœå¾ˆå¥½ï¼Œä½†æ˜¯ memory bandwidth å¤ªå¤§ï¼ˆå› ä¸ºå…¨éƒ¨ä¸€æ‰¹å¤„ç† + äº§ç”Ÿä¸­é—´ç»“æœä¹Ÿæ˜¯ BAT + mmapï¼‰ã€‚å½“æ•°æ®è§„æ¨¡å¾ˆå°çš„æ—¶å€™ï¼ˆSF = 0.001ï¼‰ï¼Œbandwidth å¯ä»¥å¾ˆå¤§ï¼Œå› ä¸ºæ•°æ®éƒ½å¯ä»¥ fit åœ¨ cache é‡Œã€‚ä½†æ˜¯æ•°æ®è§„æ¨¡å¤§çš„æ—¶å€™ï¼ŒBandwidth å°±å—é™äºå†…å­˜è®¾å¤‡äº†ï¼Œè¿™ä¼šå½±å“æŸ¥è¯¢çš„æ•ˆç‡ã€‚</p><p>å½“ç„¶ï¼Œlate materialization å¯ä»¥ä¸€å®šç¨‹åº¦ä¸Šå‡å°‘è¿™ä¸ªé—®é¢˜ã€‚ç”¨æ¯”è¾ƒèŠ‚çœå†…å­˜çš„è¡¨ç°å½¢å¼ï¼Œç±»ä¼¼ c-store ä¸­çš„ type 1-4, åªæœ‰éœ€è¦çš„æ—¶å€™æ‰ deserializeï¼Œèƒ½å¤Ÿæé«˜è¿™æ–¹é¢çš„æ€§èƒ½ã€‚</p><p>æ­¤å¤–ï¼Œè¿™é‡Œæœ‰å¾ˆå¤šä¸ª <code>join</code>, è¿™äº› <code>join</code> æ˜¯åˆ—çš„ <code>join</code>, ç”¨æ¥ç»„æˆå¿…è¦çš„è¡Œï¼Œå¯ä»¥çœ‹ä¸Šé¢ figure 4.1ã€‚volcano + è¡Œå­˜ï¼Œæ ¹æœ¬ä¸éœ€è¦æ‰§è¡Œè¿™äº› <code>join</code></p><blockquote><p>While in this paper we concentrate on CPU efficiency in main-memory scenarios, we point out that the â€œartificiallyâ€ high bandwidths generated by MonetDB/MIL make it harder to scale the system to disk- based problems efficiently, simply because memory bandwidths tends to be much greater (and cheaper) than I/O bandwidth. </p></blockquote><p>è¿™é‡Œæä¾›äº†ä¸€ä¸ª ç¡¬ç¼–ç çš„é«˜æ•ˆ UDFï¼Œä½œä¸ºç¨‹åºçš„baselineï¼Œè¿™é‡Œå¯å‘äº† codegen ç­‰æ–¹æ³•ï¼š</p><p><img src="https://image.mwish.me/blog-image/39B4EAF7-A994-4E83-B920-4093A688BEA5.png" alt="39B4EAF7-A994-4E83-B920-4093A688BEA5"></p><h2 id="X100-A-Vectorized-Query-Processor"><a href="#X100-A-Vectorized-Query-Processor" class="headerlink" title="X100: A Vectorized Query Processor"></a>X100: A Vectorized Query Processor</h2><p><img src="https://image.mwish.me/blog-image/E871803A-131F-4472-9F0C-4FB849C33BD6.png" alt="E871803A-131F-4472-9F0C-4FB849C33BD6"></p><p>å¦‚ä¸Šé¢çš„å±‚æ¬¡ï¼ŒX100 çš„ç›®çš„æ˜¯ï¼š</p><ol><li>é«˜æ•ˆ é«˜ IPC å¤„ç†å¤§é‡çš„æ•°æ®ã€‚</li><li>èƒ½å¤Ÿæ‰©å±•ï¼Œæ”¯æŒ SQL frontend</li><li>æ”¯æŒæ›´å¤§è§„æ¨¡çš„å­˜å‚¨</li></ol><p>ä¸‹é¢æ˜¯ç›¸å…³çš„å‡ ä¸ª partï¼š</p><ol><li>Disk: åŠ å…¥äº† ColumnBM I/O å­ç³»ç»Ÿï¼Œæä¾›äº†ä¸€ä¸ªæ°´å¹³åˆ†ç‰‡çš„ I Oè®¿é—®æ¥å£å’Œè½»é‡çš„å‹ç¼©ã€‚</li><li>RAM: è¿™é‡Œå¼•å…¥äº† memory to cache ç­‰é€»è¾‘ï¼Œåœ¨ memory é‡Œé¢ï¼Œå¾ˆå¤šä¸œè¥¿éƒ½ç”¨å‹ç¼©çš„æ ¼å¼å­˜å‚¨ï¼Œæ¥èŠ‚çœç©ºé—´å’Œ bandwidth</li><li>Cache: è¿™é‡Œç”¨ vectorized processing model. æ‰¹é‡çš„å¤„ç†æ•°æ®ï¼Œå°½é‡èƒ½æŠŠè¿™äº›ä¸œè¥¿ä¸¢åœ¨ cache é‡Œã€‚X100 ä¼šå°†å¤§å—çš„ BAT å†…å­˜åˆ‡æˆè¿™äº› cache chunk, åœ¨é‡Œé¢å³ä½¿ random access ç›¸å¯¹æ¥è¯´ä¹Ÿæ¯”è¾ƒå‹å¥½ã€‚</li><li>X100 è¯•å›¾ batch å¤„ç†æ•°æ®ï¼Œå³ä½¿æ˜¯ agg è¿™æ ·çš„ç®—å­ï¼Œä¹Ÿå°è¯•åšæˆ vectorized çš„ï¼Œè¿™é‡Œå¯èƒ½ä¾èµ–ç®€å•çš„ codegen. ï¼ˆagg å›°éš¾çš„åœ°æ–¹æ˜¯è¾“å‡ºå½¢çŠ¶å’Œè¾“å…¥ä¸ä¸€æ ·ã€‚ï¼‰</li></ol><p>æœ€åçš„å›¾å¯ä»¥è·Ÿä¸Šé¢çš„ figure5 çœ‹çœ‹ã€‚</p><h3 id="Query-Language"><a href="#Query-Language" class="headerlink" title="Query Language"></a>Query Language</h3><p>ä¸‹é¢æ¥çœ‹çœ‹å…·ä½“çš„æŸ¥è¯¢çš„æ‰§è¡Œï¼š</p><p><img src="https://image.mwish.me/blog-image/5FA4A79B-BC44-482C-BDEC-662C76EE81DB.png" alt="5FA4A79B-BC44-482C-BDEC-662C76EE81DB"></p><p>è¿™é‡Œä¼šè¢«æ¨åˆ°ï¼š</p><p><img src="https://image.mwish.me/blog-image/096228AA-9952-4FCE-A634-A10B3376157A.png" alt="096228AA-9952-4FCE-A634-A10B3376157A"></p><ol><li>Scan æ¯æ¬¡çªå‡ºä¸€ä¸ª vectorize batch çš„æ•°æ®</li><li>Select ç­›é€‰çš„æ—¶å€™ï¼Œä¼šäº§ç”Ÿä¸€ä¸ª <em>selection-vector</em>ï¼ŒæŠŠè¿‡æ»¤æˆåŠŸçš„å¡«è¿›åŒº</li><li>Project ç”¨æ¥æŠ•å½±ã€‚è¿™é‡Œä¸ä¼šä¿®æ”¹ vectorize çš„æ•°æ®ï¼Œè€Œæ˜¯ä»¥ <code>map</code> åŸè¯­ç±»ä¼¼çš„å½¢å¼ï¼Œæ‹·åˆ°ç›¸åŒçš„ä½ç½®ä¸­ã€‚</li><li>ä½¿ç”¨ Aggregateï¼Œè¿™é‡Œå› ä¸º <code>(3)</code> å’Œ <code>(2)</code> çš„ç­›é€‰ï¼Œ<em>selection-vector</em> ä¹Ÿéœ€è¦ä¼ ä¸Šå»ã€‚</li></ol><h3 id="X100-Algebra"><a href="#X100-Algebra" class="headerlink" title="X100 Algebra"></a>X100 Algebra</h3><p><img src="https://image.mwish.me/blog-image/D56A5DFE-98B6-468D-BDB8-9E7C74BA3301.png" alt="D56A5DFE-98B6-468D-BDB8-9E7C74BA3301"></p><p>è¿™é‡Œ Dataflow æ˜¯ä¸æ–­äº§ç”Ÿ vectorize items çš„å¯¹è±¡ï¼Œ<code>Scan</code>  <code>Order</code> <code>TopN</code> ä¼šäº§ç”Ÿä¸€ä¸ª Dataflow,Project ä¼šåšè½¬å‹ï¼ŒAggr ä¼šå¯¹ Group By çš„å¯¹è±¡å»é‡ï¼ŒArray ä¼šæ ¹æ®è¡¨è¾¾å¼äº§ç”Ÿä¸€å † N-dim arrayï¼Œç”¨æ¥æŠŠç»“æœä¸¢ç»™ frontend systemã€‚</p><p>Aggr å’Œ Join è®ºæ–‡ä¸­æåˆ°äº†ä¸€ç‚¹ï¼Œä¸è¿‡æœ‰ç‚¹è€ç”Ÿå¸¸è°ˆã€‚å°±æ˜¯æ€ä¹ˆé€‰ç®—å­çš„é—®é¢˜ã€‚</p><h3 id="Vectorized-Primitives"><a href="#Vectorized-Primitives" class="headerlink" title="Vectorized Primitives"></a>Vectorized Primitives</h3><p>è¿‡å»ï¼Œå®ç°å¯èƒ½ä¼šæ¯”è¾ƒ flexible, æ¯”å¦‚ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * AbstractExecutor implements the Volcano tuple-at-a-time iterator model.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AbstractExecutor</span> &#123;</span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Constructs a new AbstractExecutor.</span></span><br><span class="line"><span class="comment">   * @param exec_ctx the executor context that the executor runs with</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">explicit</span> <span class="title">AbstractExecutor</span><span class="params">(ExecutorContext *exec_ctx)</span> : exec_ctx_&#123;</span>exec_ctx&#125; &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** Virtual destructor. */</span></span><br><span class="line">  <span class="keyword">virtual</span> ~<span class="built_in">AbstractExecutor</span>() = <span class="keyword">default</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Initializes this executor.</span></span><br><span class="line"><span class="comment">   * @warning This function must be called before Next() is called!</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">Init</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Produces the next tuple from this executor.</span></span><br><span class="line"><span class="comment">   * @param[out] tuple the next tuple produced by this executor</span></span><br><span class="line"><span class="comment">   * @param[out] rid the next tuple rid produced by this executor</span></span><br><span class="line"><span class="comment">   * @return true if a tuple was produced, false if there are no more tuples</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="type">bool</span> <span class="title">Next</span><span class="params">(Tuple *tuple, RID *rid)</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** @return the schema of the tuples that this executor produces */</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="type">const</span> Schema *<span class="title">GetOutputSchema</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** @return the executor context in which this executor runs */</span></span><br><span class="line">  <span class="function">ExecutorContext *<span class="title">GetExecutorContext</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> exec_ctx_; &#125;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">protected</span>:</span><br><span class="line">  ExecutorContext *exec_ctx_;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ˜¯ä» 15-445 lab æŠ„å‡ºæ¥çš„. å°±æ¯”è¾ƒ flexible. MonetDB ç›¸åï¼Œä½¿ç”¨ç›¸å¯¹å®šåˆ¶çš„æ¥å£ï¼š</p><blockquote><p>In a vertically fragmented data model, the execution primitives only know about the columns they operate on without having to know about the overall table layout (e.g. record offsets). When compiling X100, the C compiler sees that the X100 vectorized primitives operate on restricted (independent) arrays of fixed shape. </p></blockquote><p>MonetDB éœ€è¦æ‰‹åŠ¨ç¼–ç å¾ˆå¤šæ¥å£ï¼Œæ¥ä¿è¯å®ç°çš„é«˜æ•ˆï¼Œæ¯”å¦‚ï¼š</p><p><img src="https://image.mwish.me/blog-image/EFB64D40-4E1C-44E6-8F06-27F13520317C.png" alt="EFB64D40-4E1C-44E6-8F06-27F13520317C"></p><p>ï¼ˆä¸Šé¢ <code>*</code> è¡¨ç¤ºä¸€ä¸ª sequenceï¼‰</p><p><img src="https://image.mwish.me/blog-image/CB2CEB26-698F-4F7A-95F7-7FD07BFA2069.png" alt="CB2CEB26-698F-4F7A-95F7-7FD07BFA2069"></p><p>ï¼ˆä½ çœ‹ä¸€ä¸ªåŠ æ³•å†™å››éï¼Œè¿™å¾—æ¨¡ç‰ˆå¤§å¸ˆæ¥å†™ä¸€å¥—äº†ï¼‰</p><p>æ­¤å¤–ï¼Œè¿™é‡Œè¿˜æ”¯æŒ <em>compound primitive signature</em> :</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(square(-(double*, double*)), double*)</span><br></pre></td></tr></table></figure><p>è¿™ç§ç»„åˆçš„ primitives èƒ½å¤Ÿæä¾›ä¸¤å€çš„æ€§èƒ½ä¼˜åŒ–ï¼ŒåŸå› åº”è¯¥å’Œè®¿å­˜æœ‰å…³ï¼š</p><blockquote><p>The reason why compound primitives are more efficient is a better instruction mix. Like in the example with addition on the MIPS processor in Section 3.1, vectorized execution often becomes load/store bound, because for simple 2-ary calculations, each vectorized instruction requires loading two parameters and storing one result (1 work instruction, 3 memory instructions). Modern CPUs can typically only perform 1 or 2 load/store operations per cycle. In compound primitives, the results from one calculation are passed via a CPU register to the next calculation, with load/stores only occurring at the edges of the expression graph.</p></blockquote><h3 id="Storage"><a href="#Storage" class="headerlink" title="Storage"></a>Storage</h3><p><img src="https://image.mwish.me/blog-image/0334E642-F1AD-400F-97ED-BF59F09E1007.png" alt="0334E642-F1AD-400F-97ED-BF59F09E1007"></p><p>MonetDB çš„ BAT æŠŠç›¸åŒçš„ column å­˜ä¸€èµ·ï¼Œè€Œ ColumnBM æƒè¡¡äº†è¯»å†™ï¼ŒæŠŠåˆ—å­˜ä¸ºå¤§äº 1MB çš„ chunks.</p><p>å®ƒçš„æ›´æ–°æ“ä½œå¦‚ä¸Šå›¾æ‰€å±ï¼ŒæŠŠåŸæœ¬çš„è§†ä½œä¸å¯å˜çš„å¯¹è±¡ï¼Œç„¶åColumnBM å®é™…ä¸Šå°†æ‰€æœ‰ delta åˆ—å­˜å‚¨åœ¨ä¸€ä¸ªå—ä¸­ï¼Œè¿™ç­‰åŒäº PAX [2]ã€‚å› æ­¤ï¼Œè¿™ä¸¤ç§æ“ä½œéƒ½åªäº§ç”Ÿä¸€ä¸ª I/Oã€‚æ›´æ–°åªæ˜¯åˆ é™¤åæ’å…¥ã€‚æ›´æ–°ä½¿ delta åˆ—å¢é•¿ï¼Œå› æ­¤åªè¦å®ƒä»¬çš„å¤§å°è¶…è¿‡æ€»è¡¨å¤§å°çš„ä¸€ä¸ªæ¯”è¾ƒå°çš„ç™¾åˆ†æ¯”ï¼Œå°±åº”è¯¥é‡æ–°ç»„ç»‡æ•°æ®å­˜å‚¨ï¼ˆcompaction?)ï¼Œä»¥ä¾¿å‚ç›´å­˜å‚¨å†æ¬¡æ›´æ–°å¹¶ä¸”æ¸…ç©º deltaã€‚</p><h2 id="TPC-H"><a href="#TPC-H" class="headerlink" title="TPC-H"></a>TPC-H</h2><p>å†æ¬¡è·‘ TPC-H ä¹‹åï¼ŒX100 è·å¾—äº†æ²¡é‚£ä¹ˆå¤§çš„å†…å­˜å¸¦å®½å’Œå¾ˆå¥½çš„æ€§èƒ½ï¼Œå³ä½¿ SF=100ï¼Œè¿™é‡Œ RAM å¼€é”€ä¹Ÿæ²¡é‚£ä¹ˆå¤§ã€‚Query 1 çš„ IPC æå‡äº†å¾ˆå¤šï¼š</p><blockquote><p>A first observation is that X100 manages to run all primitives at a very low number of CPU cycles per tuple even relatively complex primitives like aggregation run in 6 cycles per tuple. Notice that a multiplication (map mul *) is handled in 2.2 cycles per tuple, which is way better than the 49 cycles per tuple achieved by MySQL (see Section 3.1).</p></blockquote><p>æµ‹è¯•è¿˜ç»™å‡ºäº† vector size çš„å½±å“ï¼š</p><p><img src="https://image.mwish.me/blog-image/F409BB1E-BA05-44B0-BBC8-B60C234EC993.png" alt="F409BB1E-BA05-44B0-BBC8-B60C234EC993"></p><p>è¿™é‡Œï¼Œæ¯”è¾ƒæ˜æ˜¾çš„äº‹ï¼Œvector size èƒ½åœ¨ cache é‡Œé¢æ”¾ä¸‹çš„æ—¶å€™ï¼Œæ€§èƒ½æ˜¯æå‡çš„ï¼Œå½“æ”¾ä¸ä¸‹çš„æ—¶å€™ï¼Œå¼€å§‹è®¿å­˜ï¼Œæ€§èƒ½è£‚åŒ–ã€‚æ¯”è¾ƒæç«¯çš„æƒ…å†µå°±æ˜¯å›åˆ° MonetDB/MIL çš„æƒ…æ™¯ã€‚</p><h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul><li>CIDRâ€™05: MonetDB/X100: Hyper-Pipelining Query Execution</li><li><strong>The Design and Implementation of Modern Column-Oriented Database Systems</strong></li><li><strong>Computer Organization and Design</strong></li></ul>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>VLDB05: C-Store: A Column-oriented DBMS</title>
      <link href="/2021/07/02/C-Store-A-Column-oriented-DBMS/"/>
      <url>/2021/07/02/C-Store-A-Column-oriented-DBMS/</url>
      
        <content type="html"><![CDATA[<p>è¿™ç¯‡æ–‡ç« æ˜¯ C-Store çš„ä¸€ç‰‡é˜…è¯»ç¬”è®°ï¼Œé‡ç‚¹ä»‹ç»çš„è¿˜æ˜¯å®ƒå­˜å‚¨æ•°æ®çš„ schema. å¹¶å‘è¿™æ®µæˆ‘æ²¡çœ‹å¾ˆç»†ï¼Œå°±æ¯”è¾ƒç®€çŸ­åŠ›å›¾ä¸å‡ºé”™çš„ä»‹ç»äº†ä¸€ä¸‹ã€‚å†™ç¬”è®°è¿™å‘¨åœ¨ oncall, æœ‰ç‚¹ç¥æ™ºä¸æ¸…ã€‚å¦‚æœå“ªæœ‰é—®é¢˜å¯ä»¥ è¯„è®ºæˆ–è€… mail anmmscs_maple@qq.com ä»¥æŒ‡æ­£ã€‚</p><hr><p>C-Store æ˜¯ä¸€ç¯‡æ¯”è¾ƒæ—©çš„è®ºæ–‡ã€‚å®ƒæè¿°äº†ä¸€ä¸ªè¯»ä¼˜åŒ–çš„ RDBMSï¼Œæ”¯æŒ SQLã€‚å®ƒçš„è®¾è®¡ç›®æ ‡æ˜¯ï¼š</p><ol><li>åŸºäº columnï¼Œè€Œä¸æ˜¯ rowï¼Œæ¥å­˜å‚¨æ•°æ®ã€‚</li><li>å¯¹æ•°æ®åœ¨å­˜å‚¨ä¸Šï¼Œç”šè‡³åœ¨å†…å­˜ä¸Šåšåˆç†çš„ encodingï¼Œæé«˜å­˜å‚¨å’ŒæŸ¥è¯¢çš„æ•ˆç‡ã€‚</li><li>å¹¶éæŒ‰ç…§ <code>&lt;table, [Indexes]&gt;</code> è¿™ç§æ¨¡å‹æ¥å­˜å‚¨ï¼Œè€Œæ˜¯æŒ‰ç…§åˆ—çš„ Projections æ¥å­˜å‚¨</li><li>å®ç°äº† Transactionã€é«˜å¯ç”¨ã€Snapshot Isolation</li><li>ç”¨ bitmap ç´¢å¼•æ¥ä¼˜åŒ–äº† C-Store åœºæ™¯ä¸‹çš„ B+Treeã€‚</li></ol><p>ä¼ ç»Ÿçš„ DBMSï¼Œå› ä¸ºå¸Œæœ›æœ‰ç€è‰¯å¥½çš„å†™å…¥æ€§èƒ½ï¼Œé€šå¸¸ä¼šä»¥è¡Œå­˜çš„å½¢å¼å­˜å‚¨é€»è¾‘ä¸Šçš„è¡Œã€‚è€Œæ•°æ®ä»“åº“ç­‰ç³»ç»Ÿï¼Œåˆ™é€šå¸¸ä¼šè¿›è¡Œ bulk load å¯¼å…¥ä¸€æ‰¹æ•°æ®ï¼Œç„¶åè¿›è¡Œé•¿æœŸçš„è¯»ã€‚åœ¨è¿™äº›åœºæ™¯ä¸­ï¼Œå°†å•åˆ—å­˜å‚¨åœ¨ä¸€èµ·ï¼Œæœ‰æœºä¼šè·å¾—æ›´å¥½çš„æŸ¥è¯¢æ€§èƒ½ã€‚</p><p>å‘è¡¨è®ºæ–‡çš„æ—¶å€™ï¼Œä¼ ç»Ÿçš„ DBMS ä¼šå°†åˆ—æŒ‰åŸæœ¬çš„æ ¼å¼ä¹–ä¹–ä¸€ä¸ªä¸ªå­˜å‚¨ï¼Œå¹¶ padding åˆ° byte/word çš„ç²’åº¦ã€‚è¿™ä¸€ç‚¹è®© CPU ä¸ç”¨åš codecã€‚ä½†å½“æ—¶ CPU æ­£åœ¨å˜å¾—è¶Šæ¥è¶Šå¿«ï¼Œè€Œå­˜å‚¨ bandwidth ä¸Šå‡é‡æ²¡æœ‰è¿™ä¹ˆå¿«ï¼Œæ‰€ä»¥éœ€è¦æƒè¡¡è¿™ç§å¼€é”€ã€‚è®ºæ–‡æå‡ºå­˜å‚¨çš„æ—¶å€™å‡å°‘ bandwitdh çš„æ–¹å¼ï¼š</p><ol><li>æŠŠæ•°æ®ä»¥ä¸€ç§æ›´ç´§å‡‘çš„æ ¼å¼å­˜å‚¨ï¼Œä¸ç”¨ padding åˆ° bitsã€‚ä¾‹å¦‚ varint/åªå­˜éœ€è¦çš„bitsç­‰å½¢å¼ã€‚</li><li><code>densepack</code> æŠŠä¸Šè¿°æ ¼å¼åœ¨å†…å­˜ä¸­è¿ç»­å­˜å‚¨ <code>(?) è¿™é‡Œæˆ‘æ€€ç–‘æ²¡è¯»æ‡‚å®ƒæ„æ€</code></li></ol><p>åŒæ—¶ï¼Œè¿™ä¹Ÿè¦æ±‚æˆ‘ä»¬å°½é‡èƒ½å¤Ÿè®© query executor æ”¯æŒå¤„ç†è¿™ç§å‹ç¼©è¿‡çš„æ•°æ®ã€‚</p><p>DBMS å¯èƒ½ä¼šæœ‰ table heap, primary index, secondary index. è¿™äº›ç»“æ„å¹¶é read-optimized çš„ã€‚åœ¨åè€…çš„åœºæ™¯ä¸‹ï¼Œbitmap indexes, cross table indexes, materialized views æœ‰æ›´å¥½çš„æ€§èƒ½ã€‚åŸºäºä»¥ä¸ŠåŸå› ï¼ŒC-Store å­˜å‚¨ <code>set&#123;[ä¸€äº›columns]&#125;</code>, å…¶ä¸­ï¼Œæ¯ä¸ªé›†åˆè¢«ç§°ä½œ <code>projections</code>ï¼Œç»„å†…æŒ‰ç…§åŒæ ·çš„ attribute æ’åˆ—ã€‚åŒä¸€ä¸ªåˆ—å¯èƒ½è¢«å­˜å‚¨åœ¨å¤šä¸ª projections ä¸­ï¼Œä¸ºäº†é˜²æ­¢é‡å¤å­˜å‚¨å¯¼è‡´çš„ç©ºé—´è¿‡åº¦æ”¾å¤§ï¼Œè¿™é‡Œä¼šé‡‡ç”¨å¤šç§ä¸Šè¿°è¯´çš„å­˜å‚¨æ ¼å¼çš„ä¼˜åŒ–ã€‚</p><p>C-Store çš„è¿è¡Œç¯å¢ƒåœ¨è®¾æƒ³ä¸­ç±»ä¼¼ MapReduce è®ºæ–‡ä¸­çš„ç¯å¢ƒï¼Œéƒ¨ç½²åœ¨ä¸€ä¸ªå·¨å¤§çš„åˆ€ç‰‡æœºé›†ç¾¤ä¸Šï¼ŒåŒæ—¶ä¸ä¼šå…±äº«å­˜å‚¨ã€‚C-Store å¹¶ä¸é  <code>Walmart</code> ä¸€æ ·çš„ replica æ¥ä¿è¯ HAã€‚å®ƒåˆ©ç”¨ <code>projections</code> å±‚é¢çš„åˆ—é‡å¤æ€§æ¥ä¿è¯ HAã€‚å¯ä»¥ç»™ C-Store ä¸€å®šçš„é…ç½®ï¼Œæ¥ä¿è¯èƒ½å®¹å¿ <code>k</code> å°æœºå™¨æ•…éšœï¼ˆå³ <em>K-safe</em>ï¼‰.</p><p><img src="https://image.mwish.me/blog-image/3E942EE4-E2D5-4815-95F3-32F88EC14E1D.png" alt="3E942EE4-E2D5-4815-95F3-32F88EC14E1D"></p><p>å³ä½¿æ˜¯ datawarehouse ç±»çš„ç³»ç»Ÿï¼Œæˆ–è€… CRMï¼Œä¹Ÿéœ€è¦äº‹åŠ¡å’Œç®€å•çš„æ›´æ–°ï¼Œæ¥ä¿®æ­£ä¸æ­£ç¡®çš„è®°å½•ã€‚ï¼ˆæ¯”å¦‚å¯¹è´¦ï¼Ÿï¼‰. å¯¹äº column store è€Œè¨€ï¼Œæ‰€æœ‰ column éƒ½æŒ‰ç…§æŸä¸ªé€»è¾‘é¡ºåºæ’åºï¼ŒåŒæ—¶æ’å…¥æŒ‰ç…§æŸç§æƒ…å†µå•å‘æ’å…¥ï¼Œå¯ä»¥è·å¾—å¾ˆå¥½çš„å†™å…¥æ€§èƒ½ï¼Œä½†æ˜¯è¯»å–æ€§èƒ½åˆä¸ä¼šå¥½ã€‚æ‰€ä»¥è¿™é‡Œæœ‰ä¸Šè¿°çš„ WS å’Œ RSï¼Œå’Œå¯ä»¥ Tuple Moverã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œ WS ä¹Ÿæ˜¯ column oriented çš„ã€‚</p><p>åœ¨è¿™é‡Œï¼Œå†™å…¥ä¼šè¢«å†™åˆ° WS ä¸­ï¼Œåˆ é™¤éœ€è¦ mark åœ¨ RS ä¸­ã€‚Tuple Mover ç±»ä¼¼ LSM-Treeï¼Œå®šæœŸæŠŠæ•°æ® bulk load åˆ° RS ä¸­ã€‚è¯»å–çš„æ—¶å€™ï¼Œç³»ç»Ÿä¼šé€‰æ‹©ä¸€ä¸ªå°äºæœ€è¿‘ä¸€ä¸ª commit çš„æ—¶é—´æˆ³ <code>T</code>ï¼Œç”¨å®ƒæ¥æ„é€  snapshotã€‚é€šè¿‡è¿™ç§æ¨¡å¼æ¥ historical mode readã€‚</p><p>æœ€åï¼Œè¿™é‡Œéœ€è¦æ„å»ºä¸€ä¸ª column oriented ç›¸å…³çš„ query optimizer å’Œ query executorã€‚</p><p>è®ºæ–‡è®¤ä¸ºè‡ªå·±çš„åˆ›æ–°åœ¨äºï¼š</p><ol><li>WS/RS</li><li>å¤šä¸ªä¸åŒæ’åºçš„ projections</li><li>é«˜åº¦å‹ç¼©/æä¾›å¤šç§ç¼–ç æ–¹å¼çš„çš„ columns</li><li>åˆ—å­˜ä¼˜åŒ–çš„ query optimizer å’Œ query executorã€‚</li><li>åŸºäº projections çš„ HA å’Œ <em>K-safety</em></li><li>ç”¨ SI æ¥é¿å…è¯»å–çš„æ—¶å€™èµ° 2PC</li></ol><h2 id="æ•°æ®æ¨¡å‹"><a href="#æ•°æ®æ¨¡å‹" class="headerlink" title="æ•°æ®æ¨¡å‹"></a>æ•°æ®æ¨¡å‹</h2><p>C-Store æ”¯æŒæ ‡å‡†çš„å…³ç³»æ¨¡å‹ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå®ƒåœ¨ <em>é€»è¾‘ä¸Š</em> å­˜å‚¨çš„æ•°æ®å’Œ MySQL, PostgreSQL è¿™äº›å¹¶æ²¡æœ‰ä»€ä¹ˆåŒºåˆ«ã€‚ä½†æ˜¯å®é™…ä¸Šï¼Œå®ƒéœ€è¦æ”¯æŒè½¬åŒ–ä¸ºå¯¹åº”çš„ projections </p><p>ä¸¾ä¾‹è¯´ï¼Œä¸‹é¢ä¸€å¼  RDBMS çš„è¡¨ï¼Œå’Œ DEPT çš„è¡¨å…³è”ç€ï¼š</p><p><img src="https://image.mwish.me/blog-image/AA9BF703-1BF7-4475-9927-9E5A8F8BE77E.png" alt="AA9BF703-1BF7-4475-9927-9E5A8F8BE77E"></p><p>åœ¨ C-Store ä¸­ï¼Œå­˜å‚¨é€»è¾‘ç±»ä¼¼ï¼š</p><p><img src="https://image.mwish.me/blog-image/66F6751C-D06B-454E-8A37-0FEB4A267053.png" alt="66F6751C-D06B-454E-8A37-0FEB4A267053"></p><p>åœ¨æ¯ä¸ª projection ä¸­ï¼Œå¦‚æœæœ‰ k åˆ—ï¼Œé‚£ä¹ˆä¼šæœ‰ <code>k</code> ä¸ªå­˜å‚¨å•åˆ—çš„æ•°æ®ç»“æ„ã€‚å®ƒä»¬æŒ‰ç…§å…¶ä¸­çš„ä¸€åˆ— <code>sort key</code> æ¥æ’åºã€‚</p><p>æ¯ä¸ª <em>projection</em> éƒ½ä¼šæ°´å¹³åˆ†ç‰‡åˆ°è‡³å°‘ä¸€ä¸ª <code>segments</code> é‡Œé¢ã€‚C-Store çš„ partition æ˜¯åŸºäº sort key æ¥è¿›è¡Œ partitionçš„ã€‚æ¯ä¸ª segment éƒ½ä¼šæœ‰ä¸ª  <em>segment identifier</em>, Sid. è¿™ä¸ªæ•°å­—è¦æ±‚å¤§äº0.</p><p>å½“éœ€è¦å¤„ç† SQL çš„æ—¶å€™ï¼Œè¯·æ±‚ä¼šå¤„ç†ç›¸å…³çš„ projections. ä½†åŒæ—¶ï¼Œc-store éœ€è¦æŠŠå‡ ä¸ª sort key ä¸åŒçš„ projections ç»„åˆæˆè¦è¿”å›çš„æ•°æ®ï¼Œè¿™å®é™…ä¸Šä¾èµ–ä¸€ä¸ªç±»ä¼¼ join çš„åŠŸèƒ½ã€‚c-store ä¾é  storage keys å’Œ join indices æ¥æ”¯æŒè¿™äº›æ“ä½œï¼š</p><ol><li>storage keys æ˜¯é’ˆå¯¹ segment è€Œè¨€çš„ï¼Œè¿™ä¸ªè¢«ç§°ä½œ SK. åœ¨ RS çš„åŒä¸ª segment ä¸­ï¼Œä¸ä¼šå®é™…å­˜å‚¨ SK, ä»–ä»¬å°±æ˜¯ 1, 2, 3â€¦ è¿™æ ·æŒ‰é¡ºåºæ’åˆ—ã€‚ï¼ˆç„¶åä½ ä¹Ÿåˆ«é—®æˆ‘ä¸ºå•¥ä¸æ˜¯0å¼€å§‹çš„ï¼‰ã€‚åœ¨ WS ä¸­ï¼Œä»–ä»¬éœ€è¦ç»´æŠ¤è¿™ä¸ªï¼Œè¿™å’Œ WS çš„ç»“æ„å’Œé€»è¾‘æœ‰å…³ã€‚</li><li>Join Indices æ˜¯ä¸€ä¸ªé¢å¤–çš„ç´¢å¼•ï¼Œç”¨äºæŠŠ projection X çš„ <code>&lt;SegmentID, SortKey&gt;</code> æŒ‰é¡ºåºæ˜ å°„åˆ°å¦ä¸€ä¸ª projections ä¸­ï¼Œè¿™ä¸ªç»“æ„ç»´æŠ¤æ˜¯æ¯”è¾ƒæ˜‚è´µçš„ã€‚</li></ol><p><img src="https://image.mwish.me/blog-image/B0B9222B-14B2-4942-B6E7-8A5AB111D108.png" alt="B0B9222B-14B2-4942-B6E7-8A5AB111D108"></p><blockquote><p>In practice, we expect to store each column in several projections, thereby allowing us to maintain relatively few join indices. This is because join indexes are very expensive to store and maintain in the presence of updates, since each modification to a projection requires every join index that points into or out of it to be updated as well.</p></blockquote><p>C-Store é€šè¿‡ä¸Šè¿°çš„æŠŠä¸€åˆ—å­˜å‚¨å¤šä»½ï¼Œç„¶åå®ç°äº†æ¢å¤æœºåˆ¶ï¼Œæ¥åšåˆ° <em>k-safety</em>. è¿™ä¹Ÿéœ€è¦å®šä¹‰çš„ schema çš„æ”¯æŒã€‚</p><h2 id="RS"><a href="#RS" class="headerlink" title="RS"></a>RS</h2><p>RS éƒ¨åˆ†æ˜¯ä¸€ä¸ªè¯»ä¼˜åŒ–çš„åˆ—å­˜å‚¨ï¼Œè®ºæ–‡ä¸»è¦ä»‹ç»äº†å®ƒçš„å­˜å‚¨ä¼˜åŒ–å’Œ Join Indexes, è®ºæ–‡åˆ†æˆäº†å‡ éƒ¨åˆ†è®¨è®ºæ•°æ®çš„ codec, å®é™…ä¸Šæœªæ¥è¿˜æœ‰ä¸€äº›æ›´å¥½çš„æ–¹æ³•ï¼Œä½†æ˜¯æ–‡ç« ç»™å‡ºçš„æ–¹æ³•è¿˜æ˜¯æ¯”è¾ƒæœ‰ä»£è¡¨æ€§çš„ï¼š</p><p><strong>Type 1</strong>:æœ‰åºçš„ä¸”å¤§éƒ¨åˆ†å€¼ç›¸åŒçš„åºåˆ—</p><p>è¿™ç§åºåˆ—ç”¨ <code>(v, f, n)</code> æ¥è¡¨ç¤º</p><blockquote><p><em>f</em> is the position in the column where <em>v</em> first appears, and <em>n</em> is the number of times <em>v</em> appears in the column.</p></blockquote><p>ä¸ºäº†æ”¯æŒ query, c-store å¯¹è¿™ä¸ªç»“æ„æ”¯æŒäº† Bæ ‘ç´¢å¼•ï¼ŒåŠ å¿«äº†å¯¹è¿™ä¸ªå†…å®¹çš„æŸ¥æ‰¾ã€‚</p><p><strong>Type 2:</strong> æ— åºä¸”å¤§éƒ¨åˆ†å€¼ç›¸åŒçš„åºåˆ—</p><p>è¿™ç§åºåˆ—ç”¨ <em>(v, b)</em> æ¥ç¼–ç ï¼Œ<strong>v</strong> æ˜¯å¯èƒ½çš„å€¼ï¼Œ<strong>b</strong> æ˜¯æ˜¯è¿™ä¸ªå€¼çš„æ•°çš„ bitset:</p><blockquote><p>For example, given a column of integers 0,0,1,1,2,1,0,2,1, we can Type 2-encode this as three pairs: (0, 110000100), (1, 001101001), and (2,000010010).</p></blockquote><p>è¿™é‡Œä¹Ÿå®ç°äº† <code>&lt;position, value&gt;</code> çš„ B+Tree æŸ¥æ‰¾ç»“æ„ã€‚</p><p><strong>Type 3</strong>: æœ‰åºä¸”å€¼è¾ƒå°‘ç›¸åŒçš„åºåˆ—</p><p>é‡‡ç”¨ Delta çš„å½¢å¼è¿›è¡Œç¼–ç ï¼ˆæˆ‘æ„Ÿè§‰è¿™é‡Œæœ‰ç‚¹æ€ªï¼Œå› ä¸º delta æœ¬èº«åº”è¯¥å’Œå‹ç¼©æ²¡å…³ç³»ï¼Œæ„Ÿè§‰åƒæ˜¯ç”¨äº† delta + varint å•¥çš„â€¦ï¼‰</p><p><strong>Type 4</strong>: æ— åºï¼Œä¸”å€¼è¾ƒå°‘ç›¸åŒçš„åºåˆ—</p><p>è¿™é‡Œæ²¡æå…·ä½“æ€ä¹ˆåšï¼Œå°±æäº†ä¸€ä¸‹ç›®å‰æ˜¯å•¥éƒ½ä¸åšï¼Œä½†æ˜¯åœ¨æ¢ç´¢äº†ï¼š</p><blockquote><p>If there are a large number of values, then it probably makes sense to leave the values unencoded. However, we are still investigating possible compression techniques for this situation. A densepack B-tree can still be used for the indexing.</p></blockquote><h3 id="Join-Indexes"><a href="#Join-Indexes" class="headerlink" title="Join Indexes"></a>Join Indexes</h3><blockquote><p>As noted earlier, a join index is a collection of (sid, storage_key) pairs. Each of these two fields can be stored as normal columns.</p></blockquote><p>è¿™ä¸ªå°±å’Œä¹‹å‰æçš„å·®ä¸å¤šï¼Œçœ‹ä¸Šé¢é‚£ä¸ªfigure åº”è¯¥å°±æ˜ç™½äº†</p><h2 id="WS"><a href="#WS" class="headerlink" title="WS"></a>WS</h2><p>ä¸ºäº†é¿å…æŠŠä¼˜åŒ–å™¨æå¾—å¤ªå¤æ‚ï¼Œè¿™é‡Œ WS ä¹Ÿç”¨äº† projection å’Œåˆ—å­˜çš„æ¨¡å¼ï¼Œå’Œ RS æœ‰ç›¸åŒçš„ projections å’Œ join indexes.</p><p>è¿™é‡Œçš„ SK å’Œ RS ä¸­çš„ SK ä¸åŒï¼Œæ¯ä¸ªé€»è¾‘ tuple éƒ½æœ‰ç›¸åŒçš„ SK, ç„¶åéœ€è¦å­˜å‚¨è¿™ä¸ªå­—æ®µã€‚SK è¦æ¯” RS ä¸­æ‰€æœ‰çš„ SK éƒ½å¤§ã€‚ï¼ˆå®é™…ä¸Šè¿™ä¸ªåœ°æ–¹éœ€è¦ tuple mover çš„ååŠ©ï¼‰ã€‚</p><p>RS ä»¥ <code>(segment id, SK)</code> æ ‡å¿—ä¸€ä¸ªå¯¹è±¡ï¼Œå®é™…ä¸Š WS äº RS æœ‰ç›¸åŒçš„é€»è¾‘ segment. è¿™é‡Œè®¤ä¸º WS çš„å¤§å°ç›¸å¯¹ RS æ¥è¯´éå¸¸å°ï¼Œæ‰€ä»¥æ²¡æœ‰å¯¹å†…å®¹æ¥è¿›è¡Œå‹ç¼©ä¼˜åŒ–ã€‚</p><p>ä¸‹é¢å°±æ˜¯ WS å®é™…çš„ç»“æ„ï¼ŒWS æ¯ä¸ªåˆ—éƒ½è¢«è¡¨ç¤ºä¸º <code>(v, sk)</code> ã€‚æ­¤å¤–ï¼Œè¿˜æœ‰ä¸€ä¸ª <code>(s, sk)</code> çš„ B-Tree ç»“æ„ï¼Œs æ˜¯ sortkey, sk æ˜¯ WS åˆ—çš„ä½ç½®ã€‚å®é™…ä¸Šè¿™ç›¸å½“äº append only çš„ heap tuple åŠ ä¸€ä¸ª index.</p><p>ç„¶åå†å›åˆ° Join Indexes, æ¯ä¸ª Projection åˆ†ä¸º segment in RS + segment in WS. Join Index å­˜å‚¨äº†é©±åŠ¨è¡¨(sender) åˆ°ç›®æ ‡è¡¨ (receiver )çš„è®°å½•ã€‚</p><h2 id="Storage-Management"><a href="#Storage-Management" class="headerlink" title="Storage Management"></a>Storage Management</h2><p>C-Store åˆä¸€ä¸ª storage allocator, å®ƒä¼šåŠ¨æ€è°ƒæ•´ Segment çš„åˆ†åŒºï¼Œæˆ–è€…ç”³è¯· Segment. è¿™é‡Œï¼Œå‡è®¾ RS è¦è°ƒæ•´åˆ†åŒºï¼Œé‚£å®é™…ä¸Šå¯¹åº”çš„ WS å’Œä¸ RS ç›¸å…³çš„ Join Indexes ä¹Ÿéœ€è¦å¯¹åº”çš„è°ƒæ•´ã€‚</p><h2 id="Update-and-Transactions"><a href="#Update-and-Transactions" class="headerlink" title="Update and Transactions"></a>Update and Transactions</h2><p>è¿™ä¸€éƒ¨åˆ†æ„Ÿè§‰é€»è¾‘è¿˜æ˜¯æ¯”è¾ƒéš¾çš„ï¼ŒC-Store æå‡ºäº†ä¸€ä¸ªä¿®æ”¹è¿‡çš„ 2PCï¼Œç„¶åç”¨ epoch ç›¸å…³çš„åè®®ï¼Œæ¥å®ç° Snapshot Isolation. </p><p>Update æ›´æ–°çš„æ—¶å€™ï¼Œéœ€è¦åˆ›å»º Storage Key, è¿™é‡Œ Tuple Mover å’Œ WS ç»´æŠ¤ï¼Œä¿è¯è¿™ä¸ª Storage Key ä¸€å®šå¤§äº RS ä¸­çš„ä»»æ„ keyã€‚è¿™é‡Œåœ¨ BerkeleyDB ä¸Šæ„å»ºäº† WSï¼Œå¹¶è¦æ±‚ä½¿ç”¨ä¸€ä¸ªæ¯”è¾ƒå¤§çš„ Buffer Pool, æ¥ä¿è¯è¾ƒé«˜çš„å†™æ€§èƒ½ã€‚è¿™é‡Œï¼ŒC-Store åªå¸Œæœ›æœ‰å†™ç›¸å…³çš„äº‹åŠ¡ï¼Œå®ƒé€šå¸¸ç”¨ snapshot isolation çš„æ¨¡å¼æ¥è¯»å–ï¼Œæ‰€ä»¥ç³»ç»Ÿä¸éœ€è¦è®¾ç½® read lock.</p><p>ç³»ç»ŸæŠŠ Snapshot Isolation å¯ä»¥è¯»çš„ï¼Œå³ä¸ä¼šå’Œå†™å…¥å¹²æ¶‰çš„æ—¶é—´æˆ³ç§°ä¸º <em>high water mark</em> (HWM). åŒæ—¶ï¼Œç³»ç»Ÿä¸å¸Œæœ›æ”¯æŒ time-traverse, æ‰€ä»¥ç³»ç»Ÿè®¾ç½®äº†ä¸€ä¸ª <em>low water mark</em> (LWM) æ¥åšä¸€ä¸ªæ—¶é—´çš„ä½æ°´ä½ã€‚åœ¨ LWM - HWM ä¸­çš„ä¸œè¥¿æ˜¯å¯è¯»çš„ã€‚LWN ä¹‹å‰çš„åˆ é™¤å¯ä»¥å°è¯•è¢« GC æ‰ã€‚</p><p><img src="https://image.mwish.me/blog-image/DCDDC52E-CE55-4C3B-8589-7885222CC63A.png" alt="DCDDC52E-CE55-4C3B-8589-7885222CC63A"></p><p>è¿™ä¸€æ®µçš„é€»è¾‘æ„Ÿè§‰æ˜¯æ¯”è¾ƒæ‚çš„ï¼Œå†™å…¥çš„æ—¶å€™ï¼Œè¿™é‡Œæœ‰ä¸ªä¸­å¤®æ—¶é—´ç®¡ç†å™¨ TAï¼Œå®ƒä¼šå®šæœŸå‰è¿›ï¼Œå½“äº‹åŠ¡éƒ½å®Œæˆçš„æ—¶å€™ï¼Œå®ƒä¼šåšä¸€ä¸ªå‘å·ï¼Œç„¶åè®©ç³»ç»Ÿèµ°åˆ°ä¸‹ä¸€ä¸ª epochï¼Œç„¶åæ¨é«˜ HWMï¼ˆæˆ‘æ„Ÿè§‰ LWM ä¹Ÿå¯ä»¥ç”±è¯»äº‹åŠ¡ç»“æŸå’Œ lastmove æ¥æ¨é«˜ï¼‰. ä¸ºäº†å¤„ç†æ—¶é—´å›å·çš„é€»è¾‘ï¼Œè¿™é‡Œè®¾ç½®äº†ä¸€ä¸ª Wrapping: ä¿ç•™æœ€ä½æ—¶é—´æˆ³ï¼Œé˜²æ­¢ä¸æ­£ç¡®çš„å›å·ã€‚</p><p>å¯¹äºå¹¶å‘æ¥è¯´ï¼Œåªè¯»äº‹åŠ¡ä¼šèµ° LWM-HWM é—´çš„ SIï¼Œè¯»å†™äº‹åŠ¡èµ° 2PLï¼Œéµå¾ª NO-FORCE + Steal è¯­ä¹‰ã€‚ç³»ç»Ÿä¸ä¼šåš REDO, ä¸€æ—¦ä¸¢å¤±æ•°æ®ï¼Œä¼šèµ°ä» Projections ä¸­ Recover çš„é€»è¾‘ã€‚åŒæ ·çš„ï¼Œç³»ç»Ÿçš„ 2PC ä¹Ÿæ²¡æœ‰ Prepare.</p><p><img src="https://image.mwish.me/blog-image/86FCE6D9-D08E-46E9-8D26-68A0AF1102AE.png" alt="86FCE6D9-D08E-46E9-8D26-68A0AF1102AE"></p><p>ç³»ç»Ÿçš„ Recover å¦‚ä¸Šæ‰€è¿°ã€‚</p><h2 id="Tuple-Mover"><a href="#Tuple-Mover" class="headerlink" title="Tuple Mover"></a>Tuple Mover</h2><p>Tuple Mover éœ€è¦åšçš„æ˜¯é€»è¾‘ä¸Šçš„åˆå¹¶æ“ä½œã€‚æ ¹æ® LWM HWM æ¥å†³å®šä¿ç•™ä»€ä¹ˆæ ·çš„æ•°æ®ï¼Œç„¶ååšåˆå¹¶ï¼Œå†æ›´æ–°ã€‚</p>]]></content>
      
      
      
        <tags>
            
            <tag> database </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>LevelDB: Write Path</title>
      <link href="/2021/06/18/LevelDB-Write-Path/"/>
      <url>/2021/06/18/LevelDB-Write-Path/</url>
      
        <content type="html"><![CDATA[<h1 id="LevelDB-WriteBatch"><a href="#LevelDB-WriteBatch" class="headerlink" title="LevelDB WriteBatch"></a>LevelDB WriteBatch</h1><p>è¿™ç¯‡æ–‡ç« æ„æ–™ä¹‹å†…çš„å†™å¾—å¾ˆä¹±ã€‚æ„Ÿè§‰ä¸å¤ªé€‚åˆåˆšçœ‹ä»£ç çš„æ¥è¯»ï¼Œçœ‹ä»£ç æœ‰å›°æƒ‘çš„åœ°æ–¹å¯ä»¥æ¥è¿™é‡Œäº’ç›¸å°è¯ä¸€ä¸‹ã€‚</p><h2 id="æœ€ç®€å•çš„å†™è·¯å¾„-å†™-Memtable"><a href="#æœ€ç®€å•çš„å†™è·¯å¾„-å†™-Memtable" class="headerlink" title="æœ€ç®€å•çš„å†™è·¯å¾„: å†™ Memtable"></a>æœ€ç®€å•çš„å†™è·¯å¾„: å†™ Memtable</h2><p><a href="https://zhuanlan.zhihu.com/p/143309915">https://zhuanlan.zhihu.com/p/143309915</a></p><p>å¯ä»¥å‚è€ƒä¸Šé¢è¿™ç¯‡ blog. LevelDB ä¼šå°è¯•å†™å…¥ memtable. è¿™é‡Œæ¯”è¾ƒé‡è¦çš„é“¾è·¯æ˜¯ï¼š</p><ol><li><code>DBImpl::Put</code> / <code>DBImpl::Delete</code> å®ç°äº† <code>DB</code> å¯¹å¤–çš„æ¥å£, å®ƒä»¬ä¼šæŠŠè¯·æ±‚æ•´ç†åˆ°ä¸€ä¸ª <code>leveldb::WriteBatch</code> å¯¹è±¡ä¸­. <code>batch</code> å¯ä»¥ <code>Put</code>, <code>Delete</code>, æ“ä½œä¼šè¢«æ”¾åˆ° <code>batch</code> ä¸­çš„ä¸€ä¸ª <code>std::string</code> ä¸­.  WriteBatch å¼€å¤´æ˜¯ä¸€ä¸ª <code>kHeader</code> é•¿åº¦çš„ header, åŒ…å« 8-byte çš„ seq-number å’Œ 4-byte çš„ count. éšåæ˜¯è®°å½•åˆ—è¡¨, æ¯æ¡è®°å½•åŒ…å«ä¸€ä¸ª <code>char</code> å’Œ <code>length</code> + <code>content</code> çš„å†…å®¹ã€‚</li><li><code>DBImpl::Write</code>  çš„æ—¶å€™, ä¼šç¡®å®šä¸€ä¸‹æ˜¯ä¸æ˜¯ <code>sync</code> å†™ã€‚ä¸€ä¸ª batch å†…å…¨æ˜¯ sync, è¿™ä¸ª batch ä¼šé€‰å‡ºä¸€ä¸ª leader æ¥å†™å…¥æ•°æ®ã€‚<ol><li>å†™å…¥æ•°æ®æ˜¯å•çº¿ç¨‹å†™çš„ï¼Œä¸€èˆ¬é“¾è·¯ä¸Šä¼šæ‹¿åˆ° <code>DBImpl::mutex_</code> . </li><li>è°ƒç”¨ <code>MakeRoomForWrite</code>, ç¡®ä¿å†™å…¥ç©ºé—´æ˜¯å……è¶³çš„ã€‚<ol><li>å¦‚æœ L0 æ–‡ä»¶è¶…è¿‡ 8 ä¸ªæ–‡ä»¶ï¼Œåˆ°è¾¾äº† soft limit, å®ƒä¼šé‡Šæ”¾ mutex_ å¹¶ sleep 1ms. ç­‰å¾… Compaction æˆåŠŸ</li><li>åœ¨å¯èƒ½çš„ sleep åï¼Œå¦‚æœ <code>mem_</code> å†…å­˜å……è¶³ (åˆ¤å®šçš„æ–¹å¼æ˜¯ Arena çš„å†…å­˜å ç”¨å°äºæŸä¸ªé˜ˆå€¼)ï¼Œå®ƒä¼šç›´æ¥è¿”å›ï¼Œå¼€å¯åç»­æµç¨‹ã€‚</li><li><code>imm_</code> ä¸æ˜¯ null çš„ï¼ŒåŸºæœ¬ä¸Šå°±è¯´æ˜åå°æœ‰ compactionï¼Œéœ€è¦ç­‰å¾… <code>imm_</code> è¢«å‹ç¼©</li><li>çœ‹çœ‹æ˜¯å¦æ˜¯ L0 æ–‡ä»¶åˆ°è¾¾ä¸Šé™ï¼Œåˆ°è¾¾äº†å°±åœæ­¢å†™</li><li>èµ°åˆ°è¿™é‡Œè¯´æ˜ï¼Œimm<em> is nullptr, æ–‡ä»¶å¯èƒ½å¤§äº soft_limit, ä¸€å®šå°äº hard limitï¼ŒåŒæ—¶, mem</em> å†…å­˜æ˜¯ä¸å¤Ÿçš„ï¼Œéœ€è¦åˆ‡æ–°çš„æ–‡ä»¶ï¼Œç„¶åæŠŠæ—§çš„æ–‡ä»¶æ”¾åˆ° <code>imm_</code> ä¸­ã€‚è¿™é‡Œæ“ä½œæ¯”è¾ƒç»†ï¼Œéœ€è¦ï¼š<ol><li><code>Versions::NextNewFileId</code> æ‹¿åˆ°ç³»ç»Ÿçš„ä¸‹ä¸€ä¸ªæ–‡ä»¶ id, ä½œä¸º log æ–‡ä»¶çš„ id, è®©ç³»ç»Ÿåˆ›å»ºä¸€ä¸ªæ–°çš„æ–‡ä»¶ä½œä¸ºæ–°çš„ log æ–‡ä»¶.</li><li><code>imm_</code> æŒ‡å‘ <code>mem_</code>, è¿™é‡Œä¸ä¼šæ›´æ–° <code>ref_count</code>.</li><li>åˆ›å»ºä¸€ä¸ªæ–° <code>mem_</code>, å¹¶æŠŠæ—¥å¿—æŒ‡å‘æ–°åˆ›å»ºçš„æ–‡ä»¶ï¼Œå¯¹ä»– <code>Ref()</code> ä¸€ä¸‹ï¼Œå¢åŠ  ref count</li><li>è°ƒåº¦ <code>MaybeScheduleCompaction</code> , æ­£å¸¸æƒ…å†µä¼šåœ¨ 2.2.2 é‡Œé¢æˆåŠŸé€€å‡º.</li></ol></li></ol></li><li>æ‹¿åˆ° <code>Versions::LastSequence</code> ï¼Œä½œä¸ºè¿™æ¬¡çš„ log_id. å› ä¸ºå†™ log çš„çº¿ç¨‹åªæœ‰ä¸€ä¸ªï¼Œæ‰€ä»¥è¿™ä¸ªæ˜¯å†™å…¥å®‰å…¨çš„ã€‚è¿™é‡Œä¼šæ”¾é”ç„¶åå°è¯•é¡ºåºå†™ log.</li><li>å†™å…¥æˆåŠŸåï¼Œæ’å…¥ mem. è¿™é‡Œæ²¡æœ‰å¸¦ <code>mutex_</code>, ä½†æ˜¯åªæœ‰å•ä¸ªçº¿ç¨‹å»æ’å…¥ã€‚<code>!w.done</code> çš„æ—¶å€™ï¼Œå†™è€…ä¼š <code>Wait</code>ï¼Œæ‰€ä»¥ä¸ä¼šæœ‰åˆ«çš„çº¿ç¨‹æ¥å†™å…¥ï¼Œä½†æ˜¯è¿™é‡Œå¯ä»¥æ’å…¥åˆ°å†™å…¥çš„é˜Ÿåˆ—ä¸­ã€‚å†™å®Œä¹‹åæ”¾é”ã€‚</li><li>å†™å®Œä¹‹å notify waiting çš„è®°å½•ã€‚</li></ol></li></ol><p>å†™å…¥å°±è¿™æ ·è½»æ¾å¿«ä¹çš„å®Œæˆäº†ã€‚</p><h3 id="å†…å­˜æ“ä½œï¼šå’Œè¯»å–çš„å…³ç³»"><a href="#å†…å­˜æ“ä½œï¼šå’Œè¯»å–çš„å…³ç³»" class="headerlink" title="å†…å­˜æ“ä½œï¼šå’Œè¯»å–çš„å…³ç³»"></a>å†…å­˜æ“ä½œï¼šå’Œè¯»å–çš„å…³ç³»</h3><p>æˆ‘ä»¬ä¹‹å‰è¯´äº† <code>LastSequence</code> ï¼Œè¯»å–çš„æ—¶å€™ï¼Œå¦‚æœæ²¡æœ‰å¿«ç…§ï¼Œä¼š grab lockï¼Œç„¶åæ‹¿åˆ° <code>VersionSet::LastSequence</code>. è¿™ä¸ªæ—¶å€™ï¼Œåªæœ‰å†™æ—¥å¿—ä¼šæ¨é«˜è¿™ä¸ª Sequence, ç”¨è¿™ä¸ªæ¥è¯»å–æ˜¯å®‰å…¨çš„ï¼Œä¸ä¼šè¯»åˆ°æ–°å†™å…¥çš„æ•°æ®ã€‚</p><p>åŒæ—¶ï¼Œè¿™ä¸ªåœ°æ–¹è¯»ä¼šç»™ <code>mem_</code> å’Œ <code>imm_</code> æ¥åš <code>Ref</code>, è¿™ä¸ªæ—¶å€™ï¼Œå†…å­˜æ˜¯æœ€åä¸€ä¸ªè¯»è€…å¸¦ç€ <code>mutex_</code> æ¥é‡Šæ”¾çš„ã€‚</p><h2 id="Memtable-Compaction"><a href="#Memtable-Compaction" class="headerlink" title="Memtable Compaction"></a>Memtable Compaction</h2><p><code>DBImpl::MaybeScheduleCompaction</code> æ˜¯å¯èƒ½è°ƒåº¦ Compaction çš„å‡½æ•°ï¼Œåœ¨å¿…è¦çš„æ—¶å€™ï¼Œå¤„ç† Compaction.</p><p>è°ƒç”¨å®ƒçš„åœ°æ–¹æœ‰ï¼š</p><ol><li>æ‰‹åŠ¨ <code>CompactRange</code> çš„æ—¶å€™ï¼Œåœ¨ <code>TEST_CompactRange</code></li><li><code>Get</code> / ReadSample çš„æ—¶å€™ï¼Œçœ‹çœ‹æœ‰æ²¡æœ‰è§¦å‘ Seek Compaction</li><li>å†™å…¥äº§ç”Ÿ <code>imm_</code> çš„æ—¶å€™</li><li>æ¯æ¬¡ Compaction å®Œåï¼Œå†æ¬¡å°è¯•çœ‹çœ‹æœ‰æ²¡æœ‰ Compaction</li></ol><p>Compaction çš„æ¡ä»¶æœ‰ï¼š</p><ol><li><code>imm_</code> ä¸ä¸º nullptr</li><li>æœ‰ ManualCompaction</li><li><code>VersionSet::NeedsCompaction</code></li></ol><p>Compaction æœ‰ä¸‹é¢å‡ ç§ç±»å‹å’Œä¼˜å…ˆçº§:</p><ol><li>CompactMemTable: ä¼˜å…ˆçº§æœ€é«˜</li><li>ManualCompaction: ä¼˜å…ˆçº§æ¬¡é«˜</li><li>Size Compaction: ä¼˜å…ˆçº§æ¯” SeekCompaction é«˜</li><li>SeekCompaction</li></ol><p>æˆ‘ä»¬ç®€å•ä»‹ç»ä¸€ä¸‹ Compaction çš„å¤§æ¦‚çš„é€»è¾‘ï¼š</p><h3 id="Memtable-Compaction-1"><a href="#Memtable-Compaction-1" class="headerlink" title="Memtable Compaction"></a>Memtable Compaction</h3><ol><li><code>DBImpl::MaybeScheduleCompaction</code>: <code>env_-&gt;Schedule(&amp;DBImpl::BGWork, this);</code> , è§¦å‘ Compaction</li><li><code>BackgroundCall()</code> , æŒæœ‰ <code>mutex_</code></li></ol><p>ä»¥ <code>CompactMemTable</code> ä¸ºä¾‹ï¼Œè®²ä¸€ä¸‹åŸºæœ¬çš„ Compaction æµç¨‹ï¼š</p><ol><li>æ‹¿åˆ° <code>VersionSet::current</code>, ä½œä¸º Compaction çš„ base. åœ¨ Compaction æœŸé—´ï¼Œä¸ä¼šæœ‰åˆ«çš„ Compaction è¿›æ¥ã€‚ç„¶å <code>Ref()</code> å®ƒä¸€ä¸‹ï¼ˆæˆ‘æ„Ÿè§‰å…¶å®æ²¡å•¥æ„æ€â€¦ï¼‰</li><li>è¿›å…¥ <code>DBImpl::WriteLevel0Table</code> åˆ›å»ºä¸€ä¸ª <code>FileMeta</code> ç„¶å <code>VersionSet::NewFileNumber()</code>, æ‹¿åˆ°æ–° SST çš„æ–‡ä»¶ id, æŠŠå®ƒæ”¾åˆ° <code>pending_outputs_</code> é‡Œé¢ã€‚<ol><li>é‡Šæ”¾é”</li><li>åˆ›å»º <code>TableBuilder</code>ï¼Œç„¶åä» iterator ä¸­è¯»å–æ•°æ®</li><li>å¦‚æœæˆåŠŸï¼ŒSync å¹¶å…³é—­æ–‡ä»¶ï¼Œå¦åˆ™ï¼Œåˆ é™¤ SST ç„¶åè¿”å›</li><li>æŠŠæ–°æ–‡ä»¶ä¸¢åˆ° table cache ä¸­ã€‚</li><li>é‡æ–°æŒæœ‰é”</li></ol></li><li><code>pending_outputs_</code> ç§»é™¤æ–° SST</li><li>è°ƒç”¨ <code>Version::PickLevelForMemTableOutput</code> è·å¾—æ–‡ä»¶å†™å…¥çš„å±‚æ•°ã€‚è¿™é‡Œæ³¨æ„ï¼Œmemtable compaction ä¸ä¸€å®šä¼šç›´æ¥ä¸‹åˆ° L0 å±‚ï¼Œå¯èƒ½ç›´æ¥ç¬¬äºŒå±‚äº†ã€‚</li><li>VersionEdit è®°å½•æ–°åˆ›å»ºæ–‡ä»¶çš„ä¿¡æ¯ï¼ŒåŒ…æ‹¬ key èŒƒå›´å’Œåœ¨å“ªå±‚ã€‚</li><li>Unref base (æˆ‘ä¸€ä¸‹æ²¡çœ‹å‡ºæœ‰å•¥ç”¨)</li><li>edit å†è®°å½•ä¸€ä¸‹ log file number, è¿™é‡Œæ³¨æ„ï¼Œåªæœ‰ memory compaction ä¼šæ¨é«˜å®ƒï¼ŒåŸå› åé¢ä»‹ç»ã€‚</li><li>å‡†å¤‡å†™å…ƒæ•°æ®ï¼Œæ³¨æ„<code>VersionSet::Finalize</code> çš„æ—¶å€™ï¼Œè¿™é‡Œä¼šæ›´æ–° compaction score, ç”¨æ¥å¤„ç†å¯èƒ½çš„ size compaction.</li><li>LogAndApply ä¼šæ›´æ–°ä¸€äº›åˆ«çš„ä¿¡æ¯ï¼Œç„¶åå†™ MANIFEST, æ›´æ–° Version å’Œå…ƒä¿¡æ¯ã€‚è¿™é‡Œè¿˜ä¼šå¤„ç† Version é“¾è¡¨é‡Œ Ref ä¹‹ç±»çš„ä¸œè¥¿</li><li>Compaction å®Œåï¼ŒUnref <code>imm_</code> (è¿˜è®°å¾—ä¸ï¼Œå‰é¢å†™å†…å­˜çš„æ—¶å€™ï¼Œæˆ‘ä»¬æåˆ°äº†ï¼ŒCompaction çš„æ—¶å€™ï¼Œ<code>mem_</code> ä¼šè¢« <code>Ref</code> ä¸€ä¸‹ï¼Œ<code>mem_</code> å˜ <code>imm_</code> çš„æ—¶å€™æ²¡æœ‰ <code>Unref</code>, è¿™ä¸ªæ—¶å€™ <code>Unref</code> å•¦)ã€‚</li><li>è°ƒç”¨ <code>RemoveObsoleteFiles</code>, è¿™ä¸ªå‡½æ•° åœ¨ db åˆå§‹åŒ–å’Œæ–‡ä»¶æ‰“å¼€çš„æ—¶å€™è°ƒç”¨ï¼Œæ¸…æ¥šæ‰æ—§çš„æ–‡ä»¶ã€‚<ol><li>æ—¥å¿—æ–‡ä»¶: prev_log_number æ˜¯ä¸€ä¸ªåºŸå¼ƒçš„å­—æ®µ. log_number ä¼šè¢«å†…å­˜ compaction æ¨é«˜ï¼Œå¤§äºå®ƒæ‰ä¼šè¢«å›æ”¶.</li><li>SST(.sst, .ldb) æ–‡ä»¶: ä¸æ˜¯ pending<em>outputs</em> ä¸”ä¸å­˜åœ¨äº VersionSet æ‰€æœ‰ç‰ˆæœ¬å¼•ç”¨çš„æ–‡ä»¶ä¸­çš„æ–‡ä»¶ã€‚. (è¿˜è®°å¾—æˆ‘ä»¬çš„ <code>pending_outputs_</code> å—ï¼Œåˆšåˆšå‡ è¡Œæåˆ°çš„)</li></ol></li><li>éƒ½å†™å®Œå°±ç»“æŸå•¦</li></ol><h3 id="Compaction"><a href="#Compaction" class="headerlink" title="Compaction"></a>Compaction</h3><p>Memtable Compaction åº”è¯¥æ˜¯æœ€ç®€å•çš„ Compaction äº†ã€‚ä¸‹é¢è®²è®²å‰©ä¸‹çš„ã€‚è¿™äº› Compaction å¾€å¾€æ¶‰åŠä»æŸå±‚çš„æŸä¸ª memtable å¼€å§‹ï¼Œç„¶åæ‰©å¤§èŒƒå›´ï¼Œæœ€å Compaction.</p><p>å†å›åˆ° <code>DBImpl::BackgroundCompaction</code>:</p><ol><li><code>VersionSet::PickCompaction</code> æ¥æŒ‘é€‰ Compactionï¼Œå®ƒä¼šé€‰å‡ºå¯¹åº”çš„ Seek Compaction å’Œ Range Compaction. è¿˜è®°å¾—æˆ‘ä»¬åœ¨ä¸Šé¢ <code>8</code> æåˆ°çš„ Compaction Score å—ï¼ŸSize Compaction å°±æ˜¯é è¿™ä¸ª Score æ¥é€‰å‡º Compaction çš„ <strong>level</strong> å’Œ <strong>èµ·ç‚¹ SST</strong> çš„ã€‚<ol><li>Compaction ä¼šè®¡ç®—å‡ºä¸€ä¸ª Compaction Score, score æœ€å¤§çš„æ˜¯ä¸‹ä¸€ä¸ª size compaction çš„ç›®æ ‡ã€‚</li><li>è¿™é‡Œè¿˜æœ‰ä¸ª <code>compaction_pointer_</code> è¿™ä¸ªæ˜¯è½®è½¬çš„ã€‚ä¸Šæ¬¡è¿™ä¸€å±‚ Compaction åˆ°å“ªï¼Œä¸‹æ¬¡å°±ä»è¿™ä¸ª <code>pointer</code> å¼€å§‹äº†</li></ol></li><li>å¦‚æœæ˜¯ Level0 åˆ°ä¸‹å±‚çš„ Compactionï¼Œè¿™é‡Œéœ€è¦æŠŠ L0 ä¸­ï¼Œkey é‡å¤çš„ä¸€èµ· Compaction æ‰ã€‚<ol><li>è¿™é‡Œè°ƒç”¨äº† <code>Version::GetOverlappingInputs</code>, è¿™ä¸ªå‡½æ•°åšçš„å¾ˆç²—ç³™ï¼Œå¯¹ L0 å°±ä¸åœæ‰©å¤§ L0 èŒƒå›´ã€‚æ„Ÿè§‰å¾ˆä¸ä¼˜é›…</li></ol></li><li><code>VersionSet::SetupOtherInputs</code> å¤„ç†æœ¬å±‚å’Œä¸‹ä¸€å±‚çš„å…¶ä½™è¾“å…¥ SSTï¼š<ol><li><code>AddBoundaryInputs</code> å†æ¬¡æ·»åŠ <strong>æ¥æºå±‚</strong>çš„ inputsã€‚è¿™æ˜¯è¯´ï¼Œå¯¹äº SST (å®é™…ä¸Š L0 å±‚åº”è¯¥ä¸ä¼šå‡ºç°è¿™ä¸ªé—®é¢˜ï¼‰ï¼Œå†™å…¥æ¯” <strong>èµ·ç‚¹ SST</strong> æ—©çš„æ–‡ä»¶æå‡ºæ¥ä¸€èµ· Compaction æ‰ï¼Œå¦åˆ™å°±ä¼šå‡ºç°åŒä¸€ä¸ª keyï¼Œä¸Šå±‚æ¯”ä¸‹å±‚æ–°çš„ case.</li><li>æ ¹æ®ç›®æ ‡å±‚çš„æ‰€æœ‰ SSTï¼Œæ‹¿åˆ°å®ƒæœ€å°çš„ã€æœ€å¤§çš„ <code>InternalKey</code>. ç„¶åå†è°ƒç”¨ <code>Version::GetOverlappingInputs</code> å» <strong>ä¸‹ä¸€å±‚</strong> (å¯èƒ½ä¸æ˜¯ç›®æ ‡å±‚å“¦)ï¼Œæ‰¾åˆ°èŒƒå›´å¯¹åº”çš„ SSTã€‚ç„¶åå†å’Œ 3.1 ä¸€æ ·èµ°ä¸€æ¬¡ <code>AddBoundaryInputs</code>.</li><li>ç°åœ¨ï¼Œ<strong>æ¥æºå±‚</strong> å’Œ <strong>æ¥æºå±‚ + 1</strong> çš„ SST æ–‡ä»¶æ•°é‡æ²¡æœ‰è¶…è¿‡ <code>ExpandedCompactionByteSizeLimit(options_)</code> çš„è¯ï¼Œè¿˜å¯ä»¥ä»æ¥æºå±‚å†æä¸€æŠŠå’Œä¸‹å±‚çš„è¾¹ç•Œæœ‰äº¤é›†çš„æ•°æ®â€¦</li><li>æŠŠ <strong>æ¥æºå±‚ + 2</strong> èŒƒå›´é‡åˆçš„æ–‡ä»¶ä¹Ÿè®¡ç®—ä¸€éã€‚</li><li>ç»™ <strong>æ¥æºå±‚</strong> å’Œ <strong>æ¥æºå±‚ + 1</strong> è®¾ç½® Compaction Pointer ï¼ˆè®°å¾— 1.2 ä¸ï¼‰</li></ol></li><li>å¦‚æœæ¥æºå±‚ + 1 æ²¡æœ‰é‡å ï¼Œæ¥æºå±‚åªæœ‰ä¸€ä¸ªæ–‡ä»¶ï¼Œå¯ä»¥ <code>Compaction::IsTrivialMove</code> çœ‹å‡ºæ¥, ç„¶åç›´æ¥æ¨åˆ°ä¸‹å±‚ã€‚</li><li>(4) ä¸æˆåŠŸçš„æƒ…å†µä¸‹ï¼Œè°ƒç”¨ <code>DBImpl::DoCompactionWork</code> æ¥ Compaction. ä»–å¯èƒ½è¾“å‡ºå¤šä¸ª SSTï¼Œæ‰€ä»¥æäº†ä¸ª <code>DBImpl::CompactionState</code> æ¥ç»´æŠ¤çŠ¶æ€ã€‚<ol><li>æ‰¾åˆ° <code>DBImpl::snapshots_</code>, æ‹¿åˆ°æœ€è€è¯»è€…çš„ seq id. è¿™ä¸ª seq id ä¹‹å‰çš„è®°å½•æ˜¯ä¸èƒ½åˆ é™¤çš„ã€‚</li><li>å¦‚æœæœ‰ <code>imm_</code> ï¼Œæ”¾é”ï¼Œç„¶åä¼˜å…ˆ Compact Memtable. è¿™æ˜¯ä¸ºäº†ä¸å½±å“æ­£å¸¸å†™å…¥</li><li>å¦‚æœè¿™æ¬¡å†™çš„ SST å¤ªå¤§äº†ï¼Œå…ˆè¾“å‡ºï¼Œç„¶åæ¢ä¸ª SST å†™</li><li>ä¸‹é¢æ˜¯æ­£å¼å†™æ•°æ®çš„æµç¨‹ï¼Œè¿™é‡Œè¦å†³å®šæ•°æ®æ˜¯ä¸æ˜¯è¦ä¿ç•™ã€‚å¤§è‡´é€»è¾‘æ˜¯ï¼Œéœ€è¦ä¸å½±å“ Compaction çš„æ­£ç¡®æ€§ã€‚æ€»çš„æ¥è¯´ï¼Œè¿™ä¸ªåˆ é™¤çš„ç­–ç•¥æ„Ÿè§‰æ˜¯éå¸¸ä¿å®ˆçš„ã€‚</li></ol></li></ol><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Handle key/value, add to state, etc.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// æ¯æ¬¡ä¿ç•™ä¸€ä¸ª current_user_key. é‡åˆ°ç¬¬äºŒæ¬¡</span></span><br><span class="line"><span class="type">bool</span> drop = <span class="literal">false</span>;</span><br><span class="line"><span class="keyword">if</span> (!<span class="built_in">ParseInternalKey</span>(key, &amp;ikey)) &#123;</span><br><span class="line">  <span class="comment">// Do not hide error keys</span></span><br><span class="line">  current_user_key.<span class="built_in">clear</span>();</span><br><span class="line">  has_current_user_key = <span class="literal">false</span>;</span><br><span class="line">  last_sequence_for_key = kMaxSequenceNumber;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (!has_current_user_key ||</span><br><span class="line">      <span class="built_in">user_comparator</span>()-&gt;<span class="built_in">Compare</span>(ikey.user_key, <span class="built_in">Slice</span>(current_user_key)) !=</span><br><span class="line">          <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">// First occurrence of this user key</span></span><br><span class="line">    current_user_key.<span class="built_in">assign</span>(ikey.user_key.<span class="built_in">data</span>(), ikey.user_key.<span class="built_in">size</span>());</span><br><span class="line">    has_current_user_key = <span class="literal">true</span>;</span><br><span class="line">    last_sequence_for_key = kMaxSequenceNumber;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// key ä¿ç•™æƒ…å†µå¤„ç†.</span></span><br><span class="line">  <span class="keyword">if</span> (last_sequence_for_key &lt;= compact-&gt;smallest_snapshot) &#123;</span><br><span class="line">    <span class="comment">// Hidden by an newer entry for same user key</span></span><br><span class="line">    drop = <span class="literal">true</span>;  <span class="comment">// (A)</span></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ikey.type == kTypeDeletion &amp;&amp;</span><br><span class="line">             ikey.sequence &lt;= compact-&gt;smallest_snapshot &amp;&amp;</span><br><span class="line">             compact-&gt;compaction-&gt;<span class="built_in">IsBaseLevelForKey</span>(ikey.user_key)) &#123;</span><br><span class="line">    <span class="comment">// Note(mwish): `IsBaseLevelForKey` è¿™ä¸ªå‡½æ•°ä¹Ÿå¤ªè®¨å·§äº†ï¼Œæ„Ÿè§‰ä¸å¤ªå¥½ç”¨...</span></span><br><span class="line">    <span class="comment">// ç»ˆäºçŸ¥é“ä¸ºä»€ä¹ˆè¦ Seek Compaction äº†.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// For this user key:</span></span><br><span class="line">    <span class="comment">// (1) there is no data in higher levels</span></span><br><span class="line">    <span class="comment">// (2) data in lower levels will have larger sequence numbers</span></span><br><span class="line">    <span class="comment">// (3) data in layers that are being compacted here and have</span></span><br><span class="line">    <span class="comment">//     smaller sequence numbers will be dropped in the next</span></span><br><span class="line">    <span class="comment">//     few iterations of this loop (by rule (A) above).</span></span><br><span class="line">    <span class="comment">// Therefore this deletion marker is obsolete and can be dropped.</span></span><br><span class="line">    drop = <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  last_sequence_for_key = ikey.sequence;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Compaction-å’Œè¯»"><a href="#Compaction-å’Œè¯»" class="headerlink" title="Compaction å’Œè¯»"></a>Compaction å’Œè¯»</h3><p>è¯»å–çš„é€»è¾‘åœ¨ï¼š<a href="https://zhuanlan.zhihu.com/p/372152739">https://zhuanlan.zhihu.com/p/372152739</a> è¿™é‡Œä»‹ç»è¿‡ä¸€äº›ã€‚</p><p>Memtable å’Œ LogSequence å·²ç»ä»‹ç»è¿‡äº†ï¼Œè¿™é‡Œä»‹ç» SST ç›¸å…³çš„ã€‚Compaction ä¸ä¼šç›´æ¥åˆ é™¤æ–‡ä»¶ï¼Œä½†æ˜¯ä¼š <code>RemoveObsoleteFiles</code>ã€‚å¯¹äºè¯»è€Œè¨€ï¼Œå¦‚æœå“ªä¸ª snapshot å’Œ version æ­£åœ¨è¢«è¯»å–ï¼Œæ˜¯ä¸ä¼šè¢«åˆ æ‰çš„ã€‚</p><p>é‚£æˆ‘ä»¬è€ƒè™‘ä¸€ä¸ªé—®é¢˜ã€‚æœ‰ä¸€ä¸ªå·¨æ—©æ‹¿åˆ°çš„ Snapshot, è¿‡äº†å¾ˆä¹…ä¹‹åè¢«è¯»å–ã€‚è¿™ä¸ªæ—¶å€™æ‹¿åˆ°çš„ <code>Version</code> æ˜¯ <code>current</code>. è¿™ä¸ªåœ°æ–¹ï¼Œæ€ä¹ˆä¿è¯è¢«åˆ æ‰çš„æ–‡ä»¶æ•°æ®è¿˜èƒ½è¯»å‘¢ï¼Ÿè¿™ä¸ªæ˜¯é  Compaction çš„æ—¶å€™ï¼Œè¯»åˆ°çš„ log_id ä¿è¯çš„ã€‚å‡å¦‚æˆ‘ä»¬æœ‰ä¸€ä¸ªå¾ˆæ—©çš„ snapshot, å®ƒçš„ SST ä¼šè¢«åˆ é™¤ï¼Œä½†æ˜¯ç›¸å…³çš„è®°å½•æ˜¯ä¸ä¼šè¢«åˆ é™¤çš„ã€‚</p><hr><ul><li>LevelDB Log: WAL of LSMTree C0  <a href="https://zhuanlan.zhihu.com/p/145178907">https://zhuanlan.zhihu.com/p/145178907</a></li><li>LevelDB Put: How it Batch <a href="https://zhuanlan.zhihu.com/p/143309915">https://zhuanlan.zhihu.com/p/143309915</a></li><li>LevelDB Memtable <a href="https://zhuanlan.zhihu.com/p/145403978">https://zhuanlan.zhihu.com/p/145403978</a></li></ul>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Note on System Design Interview: Part2</title>
      <link href="/2021/05/24/Note-on-System-Design-Interview-Part2/"/>
      <url>/2021/05/24/Note-on-System-Design-Interview-Part2/</url>
      
        <content type="html"><![CDATA[<h3 id="Notification-System"><a href="#Notification-System" class="headerlink" title="Notification System"></a>Notification System</h3><p>è¿™é‡Œåº”è¯¥è¿˜å¯ä»¥åŒ…æ‹¬ chrome notification:</p><p><img src="https://image.mwish.me/blog-image/A7653474-34AE-4C7E-8E99-3638D3995E23.png" alt="A7653474-34AE-4C7E-8E99-3638D3995E23"></p><p>è¿™é‡Œçš„è¦ç‚¹æ˜¯ï¼š</p><ol><li>æœ‰ä¸€ä¸ªè½¯å®æ—¶æ›´æ–°çš„ç³»ç»Ÿï¼Œä¸è¦æ±‚å®æ—¶å‘é€ï¼Œä¸è¿‡ä¹Ÿæœ€å¥½ä¸è¦æŠŠæ¨é€ç»™ç”¨æˆ·çš„å†…å®¹æ™šäº†å¤ªå¤š</li><li>èƒ½å¤Ÿ scale, å¹¶æ¨ç»™ä¸åŒç±»å‹çš„ç«¯ï¼Œæ¯”å¦‚ iOS, iPad ç­‰</li></ol><p>è¿™é‡Œåº”è¯¥è¦è®¾ç½®ä¸€å¯¹å¤šçš„ user: device è¡¨ï¼Œä½œä¸ºç”¨æˆ·å­˜å‚¨ä¿¡æ¯çš„è¡¨ï¼Œç„¶åå¯ä»¥å‡†å¤‡ä¸€ä¸ª cache.</p><p>æœ‰è¿™ä¸ªä¿¡æ¯åï¼Œå¦‚æœæ”¶åˆ°ä¸€æ¡æ¶ˆæ¯ï¼Œå¯èƒ½è¦æ…¢æ…¢æŠŠæ¶ˆæ¯ä¸¢ç»™ user çš„å„ä¸ª device æˆ–è€…ä¸€äº› device, è¿™é‡Œå¯ä»¥ç”¨ mq æ¥è§£è€¦è¿™ä¸ªè¿‡ç¨‹ï¼š</p><p><img src="https://image.mwish.me/blog-image/FADB51E3-4EC9-42B0-8B4F-BADE93037F33.png" alt="FADB51E3-4EC9-42B0-8B4F-BADE93037F33"></p><p>è¿™é‡Œ worker group éœ€è¦ talk from queue, ç„¶åå¼€å§‹æ¶ˆè´¹ã€‚è¿™é‡Œå› ä¸ºæ¶ˆæ¯ä¸èƒ½ä¸¢ï¼Œæ‰€ä»¥ä¹Ÿè¦æŒä¹…åŒ–å¤„ç†æƒ…å†µï¼š</p><p><img src="https://image.mwish.me/blog-image/07544A0D-700E-4A9D-9CA3-77AADD3D70F4.png" alt="07544A0D-700E-4A9D-9CA3-77AADD3D70F4"></p><p>å½“ç„¶ï¼Œè¿™é‡Œè¿˜è¦æ³¨æ„ rate limit, retry å’Œ queue çŠ¶æ€çš„ç›‘æ§ã€‚</p><h3 id="News-Feed-System"><a href="#News-Feed-System" class="headerlink" title="News Feed System"></a>News Feed System</h3><blockquote><p>News feed is the constantly updating list of stories in the middle of your home page. News Feed includes status updates, photos, videos, links, app activity, and likes from people, pages, and groups that you follow on Facebook</p></blockquote><p>åˆå«å–‚çŒªç³»ç»Ÿã€‚</p><p>è¿™é‡Œæä¾›äº†å‡ ä¸ª api:</p><ol><li>Post service (åŒ…å« post cache): æ­£å¸¸å‘æ–‡/è¯»æ–‡ç« çš„æœåŠ¡ã€‚</li><li>Fanout service: push new content to friendsâ€™ news feed. Newsfeed data is stored in the cache for fast retrieval. (æ„Ÿè§‰è¿˜æ˜¯è¦å†™åˆ° SQL/NoSQL é‡Œé¢çš„ï¼Œå¾—é˜²æ­¢ä¸¢æ•°æ®)</li><li>Notification service: æˆ‘ä»¬ä¸Šä¸€èŠ‚å¹é€¼åšçš„é‚£ä¸ª</li></ol><p>ç”¨æˆ·å‘æ–‡çš„æ—¶å€™ï¼Œå¯èƒ½è¦è¯»æ‰©æ•£å†™æ‰©æ•£æåˆ° feed system é‡Œé¢ã€‚ç»™å…³æ³¨è‡ªå·±çš„äººæ¨æ¶ˆæ¯ã€‚è¯è¯´è¿™ä¸ª ddia åº”è¯¥è®²äº†ã€‚è¿™é‡Œå¯ä»¥åªå­˜ <code>&lt;post_id, user_id &gt;</code>, ç„¶åæ‰¾åˆ° db é‡Œå¤´ã€‚</p><p><img src="https://image.mwish.me/blog-image/6F30A791-DB86-4267-A099-C0A3134C3158.png" alt="6F30A791-DB86-4267-A099-C0A3134C3158"></p><p>ä¸Šè¿°æ˜¯å†™å…¥çš„ pipeline. æŸ¥è¯¢çš„è¯å°±æ˜¯æŠŠå¤§ v çš„æ–‡ç« å’Œè‡ªå·± feed é‡Œé¢çš„ merge ä¸€ä¸‹å°±è¡Œï¼š</p><p><img src="https://image.mwish.me/blog-image/9AE9A19F-6B93-442D-B83E-7CABE3FD9028.png" alt="9AE9A19F-6B93-442D-B83E-7CABE3FD9028"></p><p>è¯è¯´è¿™é‡Œè¿˜åˆ—äº† cache type, å…¶å®æŒºæœ‰æ„ä¹‰çš„ï¼š</p><p><img src="https://image.mwish.me/blog-image/50343781-12BD-409F-ACAB-9100CBC61263.png" alt="50343781-12BD-409F-ACAB-9100CBC61263"></p><p>è¿˜å¯ä»¥å‚è€ƒï¼š</p><ol><li><a href="https://www.zhihu.com/question/20690652">https://www.zhihu.com/question/20690652</a></li><li><a href="https://developer.aliyun.com/article/224132">https://developer.aliyun.com/article/224132</a></li><li><a href="https://www.facebook.com/help/327131014036297/">https://www.facebook.com/help/327131014036297/</a></li></ol><h3 id="Chat-System"><a href="#Chat-System" class="headerlink" title="Chat System"></a>Chat System</h3><p>Chat System çš„è¦ç‚¹æ˜¯ï¼š</p><ol><li>å¯èƒ½éœ€è¦ä¿æŒçŠ¶æ€ã€é•¿è¿æ¥ï¼ˆè¿™é‡Œä½¿ç”¨äº† ws å®ç°ï¼‰</li><li>ç½‘ç»œä¸å¥½çš„æ—¶å€™ï¼Œé¿å…é¢‘ç¹çš„çŠ¶æ€å˜åŒ–</li><li>å¯¹è¯è‚¯å®šè¦æŒä¹…åŒ–ï¼Œä½†æ˜¯ä¸åŒçš„ç”¨æˆ·å¯ä»¥è¿æ¥åœ¨ä¸åŒçš„æœºå™¨ä¸Š</li><li>ä¹Ÿæœ‰äº›ä¸œè¥¿ä¸éœ€è¦é•¿è¿æ¥</li></ol><p>è¿™é‡Œç™»é™†ä¹‹ç±»çš„ä½¿ç”¨äº†æ— çŠ¶æ€çš„ api, ç„¶åç”¨ ws ç»´æŠ¤è¿æ¥ã€‚ç™»å½•çŠ¶æ€ç”¨å¿ƒè·³åŒ…ç»´æŠ¤ï¼Œé¿å…è¿‡åº¦ resetã€‚</p><p>äººä¸äººèŠå¤©ï¼Œäººä¸ç»„èŠå¤©ä½¿ç”¨åºåˆ—çš„ id, è¿™ä¸ªå› ä¸ºå¯ä»¥ sharding æ‰€ä»¥ä»£ä»·ä¸é«˜ã€‚ä¸€æ¡æ¶ˆæ¯ï¼Œå…ˆæŒä¹…åŒ–å­˜å‚¨ï¼Œç„¶å fanout ç»™å¯¹è¯å¯¹è±¡ï¼ˆæˆ–è€… notification systemï¼‰</p><p><img src="https://image.mwish.me/blog-image/8C0B2A00-B661-4CF9-9C37-F633AE934756.png" alt="8C0B2A00-B661-4CF9-9C37-F633AE934756"></p><p>è¿™é‡Œç«¯éœ€è¦ç»´æŠ¤è‡ªå·±çš„ <code>max_seq_id</code>, ç„¶åé‡æ–°ç™»å½•çš„æ—¶å€™ï¼Œèƒ½å¤Ÿæ‹‰å‡ºä¸€æ‰¹æ•°æ®ã€‚</p><p>è€Œç¾¤èŠå¯ä»¥ç”¨æ¨æ¨¡å¼æˆ–è€…æ‹‰æ¨¡å¼æ¥å®ç°ã€‚å¯¹äºå°ç¾¤æ¨å°±æ¨äº†ï¼Œå¦åˆ™ä¹Ÿå¯ä»¥æ‹‰ã€‚</p><p>ç™»å½•æ¨é€(QQ å¾®ä¿¡æ²¡æœ‰ï¼Œsteam æœ‰)å¯ä»¥ fanout ç±»ä¼¼çš„é€»è¾‘æ¥ç»´æŠ¤</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Note on System Design Interview</title>
      <link href="/2021/05/22/Note-on-System-Design-Interview/"/>
      <url>/2021/05/22/Note-on-System-Design-Interview/</url>
      
        <content type="html"><![CDATA[<p>System Design Interview ä»‹ç»äº† system design çš„ä¸€äº›é¢è¯•é¢˜ï¼Œä¹Ÿä»‹ç»äº†åˆ†å¸ƒå¼ç³»ç»Ÿä¸Šçš„ä¸€äº› building blocks. è¿™æœ¬ä¹¦ä»‹ç»äº†ä¸€ä¸‹è¿™äº›å†…å®¹ã€‚</p><p>è¿™æœ¬ä¹¦é€»è¾‘ä¸Šå¤§æ¦‚åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼š</p><ol><li>ä»‹ç»åˆ†å¸ƒå¼åº”ç”¨çš„ building blocks</li><li>ä»‹ç»ä¸€äº›åˆ†å¸ƒå¼ç³»ç»Ÿå¸¸ç”¨ç»„ä»¶çš„å®ç°æ–¹å¼ã€‚</li><li>ä»‹ç»ä¸€äº›å¤§å‹ web åº”ç”¨çš„æ¶æ„ã€‚</li></ol><h2 id="Part1-building-blocks"><a href="#Part1-building-blocks" class="headerlink" title="Part1 building blocks"></a>Part1 building blocks</h2><p>è¿™é‡Œçš„å®¢æˆ·ç«¯/user ä¸€èˆ¬æŒ‡çš„æ˜¯ web æˆ–è€…æ˜¯ç§»åŠ¨ç«¯çš„ app. è¿™äº›é€šè¿‡ dns æ¥æ‹¿åˆ°æœåŠ¡å™¨çš„ ip, ç„¶åè®¿é—®æœåŠ¡å™¨ã€‚</p><p>åŒæ—¶ï¼Œæ•°æ®å­˜å‚¨é€šå¸¸ä¼šä¸¢åˆ°æŸä¸ª db ä¸Šã€‚æŒ‰éœ€æ±‚é€‰æ‹© MySQL MongoDB è¿™äº›é€‰å‹ã€‚</p><p>è¯´å¥å®è¯ä¸€èˆ¬ç½‘ç»œ app è¿™äº›ä¸œè¥¿å°±å¤Ÿäº†ã€‚ä½†æ˜¯å¤§å‹åº”ç”¨è¿™æ ·å°±ç­‰æ­»å§ã€‚</p><h3 id="Load-balancer"><a href="#Load-balancer" class="headerlink" title="Load balancer"></a>Load balancer</h3><p>ä¸€èˆ¬éœ€è¦è´Ÿè½½å‡è¡¡æ¥å¤„ç†ä¸€äº›é—®é¢˜ï¼Œnginx, haproxy, envoy éƒ½æœ‰è¿™äº›åŠŸèƒ½ã€‚</p><p>ï¼ˆè¿™é‡Œæ³¨æ„ä¸€ä¸‹æœ‰ä¸ª L4/L7 è´Ÿè½½å‡è¡¡çš„åŒºåˆ«ï¼‰</p><h3 id="Database-application"><a href="#Database-application" class="headerlink" title="Database application"></a>Database application</h3><p>æ— è®ºæ˜¯ master/slave ç„¶åæŒ‚ä¸ªä»€ä¹ˆæ–¹å¼ï¼Œå¯ä»¥åš db çš„ä¸»ä»å¤‡ä»½ã€åœ¨ä¸šåŠ¡æµ‹åˆ‡åˆ† dbã€‚</p><p>å½“ç„¶ä¹Ÿå¯ä»¥ç”¨åˆ†å¸ƒå¼çš„ db, ä¸è¿‡æœ‰çš„æ—¶å€™ä½ è¿˜æ˜¯è¦ manage ä¸€äº›æ•°æ®åˆ†å¸ƒä¹‹ç±»çš„é—®é¢˜çš„ï¼š</p><p><img src="https://image.mwish.me/blog-image/223BD7B0-1EE7-402E-9F6C-EDD9EA0A8C7B.png" alt="223BD7B0-1EE7-402E-9F6C-EDD9EA0A8C7B"></p><h3 id="cache"><a href="#cache" class="headerlink" title="cache"></a>cache</h3><p>æ²¡æœ‰éœ€æ±‚ä¸Šç¼“å­˜å±äºæŠ˜ç£¨è‡ªå·±ï¼š<a href="https://www.zhihu.com/question/383926405">https://www.zhihu.com/question/383926405</a></p><p>ä½†æ˜¯æœ‰éœ€æ±‚çš„è¯ï¼Œç¼“å­˜èƒ½å¤Ÿèµ·é£ã€‚</p><p>ç¼“å­˜çš„æ¶æ„ä¹Ÿå¾ˆå¤æ‚ï¼Œæˆ‘ä¹‹å‰è¯»è¿‡ä¸€ç¯‡ fb çš„è®ºæ–‡ï¼š</p><ol><li><a href="https://zhuanlan.zhihu.com/p/194347153">https://zhuanlan.zhihu.com/p/194347153</a></li><li><a href="https://zhuanlan.zhihu.com/p/310697650">https://zhuanlan.zhihu.com/p/310697650</a></li></ol><p>ç„¶åè¿˜è¦åŒºåˆ†ä¸‹ write through cache/write aside cache.</p><p>è¿™æœ¬ä¹¦æäº†ä¸€ä¸‹ä½¿ç”¨ cache éœ€è¦æå‰è®¾è®¡çš„å‡ ä»¶äº‹ï¼š</p><ol><li>Eviction policy</li><li>mitigating failure</li><li>consistency</li><li>Expiration policy</li><li>Decide when to use cache</li></ol><h3 id="CDN"><a href="#CDN" class="headerlink" title="CDN"></a>CDN</h3><p>CDN ä»ä¸€ä¸ªç±»ä¼¼ amazon s3 çš„æœåŠ¡æ‹‰å†…å®¹ï¼ˆå½“ç„¶ï¼Œç›´æ’­çš„è¯ä¼šæ›´å¤æ‚ï¼‰</p><ol><li>cost (çœŸå®â€¦)</li><li>cache expiry</li><li>CDN fallback: CDN æŒ‚äº†æ€ä¹ˆåŠ</li><li>Invalidating files</li></ol><h3 id="Stateful-Stateless"><a href="#Stateful-Stateless" class="headerlink" title="Stateful/Stateless"></a>Stateful/Stateless</h3><p>Stateless çš„é€šå¸¸å¯ä»¥ç›´æ¥èµ·é£ï¼Œå¿«ä¹æ‰©å®¹ï¼Œä½†æ˜¯å¾ˆå¤šæ—¶å€™ä¹Ÿéœ€è¦è®¿é—® stateful çš„ db è¿™ç±»çš„èµ„æºï¼Œè®¿é—® shared storage è¿™ç±»ã€‚</p><h3 id="Data-Centers"><a href="#Data-Centers" class="headerlink" title="Data Centers"></a>Data Centers</h3><p>å¾ˆå¤šæ—¶å€™ï¼Œä¸šåŠ¡éƒ¨ç½²éƒ½éœ€è¦å¤šä¸ª DCï¼Œä¸€ä¸ªåœ°æ–¹æœºæˆ¿è¿‡çƒ­ï¼Œå¯èƒ½å—ç¾å°±æœ‰å¤šæœºå™¨å…¨æŒ‚äº†ã€‚</p><p>DC éœ€è¦è€ƒè™‘æµé‡è°ƒåº¦ã€æ•°æ®åŒæ­¥ã€æµ‹è¯•ï¼Œä½†ä¹Ÿç»™äº†ç³»ç»Ÿæ›´å¥½çš„ç¨³å®šæ€§ã€‚</p><p>å¯¹äºåŸºç¡€ç»„å»ºè€Œè¨€ï¼Œå¤šæ•°æ®ä¸­å¿ƒåŒæ­¥è¿˜æ˜¯ä¸€ä¸ªå¾ˆéº»çƒ¦çš„é—®é¢˜ï¼Œå› ä¸º latency é«˜ï¼Œæµé‡è´µã€‚</p><h3 id="Message-queue"><a href="#Message-queue" class="headerlink" title="Message queue"></a>Message queue</h3><p>å¯¹ä¸šåŠ¡è€Œè¨€ï¼Œmq æ„å‘³ç€æŸç§å½¢å¼çš„è§£è€¦ã€‚ç”¨æˆ·å¯èƒ½å¸Œæœ›å¸Œæœ›ï¼š</p><ol><li>ä¸¢å°±ä¸¢äº†ï¼Œéšä¾¿ä½ æ€ä¹ˆå¤„ç†</li><li>å¸Œæœ› exactly once ä¹‹ç±»çš„è¯­ä¹‰ã€‚</li></ol><h3 id="Logging-metrics-automation"><a href="#Logging-metrics-automation" class="headerlink" title="Logging, metrics, automation"></a>Logging, metrics, automation</h3><p>æŸ¥è¿‡é—®é¢˜æ‡‚å¾—éƒ½æ‡‚ã€‚è™½ç„¶æˆ‘ä¸æ˜¯å¾ˆæ‡‚ loggingâ€¦</p><h3 id="wrap-up"><a href="#wrap-up" class="headerlink" title="wrap up"></a>wrap up</h3><p><img src="https://image.mwish.me/blog-image/38114998F5B912A9F3097D35DCCBDC4A.png" alt="38114998F5B912A9F3097D35DCCBDC4A"></p><h3 id="é‡çº§ä¼°è®¡"><a href="#é‡çº§ä¼°è®¡" class="headerlink" title="é‡çº§ä¼°è®¡"></a>é‡çº§ä¼°è®¡</h3><p>è¿™ä¸ªå¯ä»¥å‚è€ƒ every number programmers should know, åˆä¸€ä¸ªæ¯å¹´éƒ½ä¼šæ›´æ–°çš„ç½‘ç«™ï¼Œå¯ä»¥æ‰¾æ‰¾çœ‹ã€‚</p><p>ç„¶åçŸ¥é“ MB GB PB æœ‰å¤šå¤§ï¼ˆæˆ‘éœ€è¦å¤©å¤©ç®—è¿™ä¸ªå“ˆå“ˆå“ˆï¼‰</p><p><img src="https://image.mwish.me/blog-image/9C0CB68D373EF6E629488FD1969F8809.png" alt="9C0CB68D373EF6E629488FD1969F8809"></p><p>è¿™é‡Œè¿˜æœ‰å¯¹ QPS å’Œ Peek QPS çš„ä¼°ç®—ï¼ˆå®é™…ä¸Šæˆ‘æ„Ÿè§‰çœŸå®æƒ…å†µè¿˜æ˜¯è¦çœ‹ç»Ÿè®¡æ•°æ®ä»€ä¹ˆçš„ï¼‰</p><h2 id="Part2-ç»„ä»¶å’Œå®ç°"><a href="#Part2-ç»„ä»¶å’Œå®ç°" class="headerlink" title="Part2 ç»„ä»¶å’Œå®ç°"></a>Part2 ç»„ä»¶å’Œå®ç°</h2><h3 id="Rate-Limiter"><a href="#Rate-Limiter" class="headerlink" title="Rate Limiter"></a>Rate Limiter</h3><p>ä¸ºäº†ä¸å‘ç°æš´å†™å°±ç­‰æ­»ï¼Œå¯ä»¥åšä¸€äº›ç»„ä»¶ä¸Šçš„é™æµã€‚</p><p>æ­¤å¤–ï¼Œä¸šåŠ¡æœ¬èº«ä¹Ÿä¼šè‡ªå·±ä¼°ä¸€ä¸ª QPSï¼Œè¿™ä¸ªè™½ç„¶æ¯”è¾ƒç²—ç•¥ï¼Œä½†æ˜¯ä¹Ÿèƒ½åšä¸€ä¸ªåŸºæœ¬çš„é™åˆ¶ã€‚é™æµåœ¨è¿™æ–¹é¢å¯ä»¥ç»™è‡ªå·±ç³»ç»Ÿä¸€ä¸ªå¾ˆå¥½çš„ä¿éšœã€‚</p><p>è¿™ä¸ªå¯ä»¥ä»¥å®¢æˆ·ç«¯çš„å½¢å¼æä¾›ï¼Œä¹Ÿå¯ä»¥åšæˆä¸€ä¸ª api gatewayï¼Œåœ¨ QPS è¿‡é«˜çš„æ—¶å€™è¿”å›ä¸€ä¸ª HTTP 429ã€‚</p><p>RateLimit æœ‰ä¸‹é¢çš„ç®—æ³•</p><ul><li>Token bucket</li><li>Leaking bucket</li><li>Fixed window counter</li><li>Sliding window log</li><li>Sliding window counter</li></ul><p>æˆ‘è¿™é‡Œæ“äº†ä¸€ä¸ªç®€å•çš„å•æœº <code>leaky_bucket.rs</code> : <a href="https://github.com/mapleFU/md-snippets/blob/master/components/ratelimiter/src/leaky_bucket.rs#L36">https://github.com/mapleFU/md-snippets/blob/master/components/ratelimiter/src/leaky_bucket.rs#L36</a></p><p>å‚è€ƒäº†ï¼š<a href="https://github.com/uber-go/ratelimit/blob/main/limiter_atomic.go">https://github.com/uber-go/ratelimit/blob/main/limiter_atomic.go</a></p><p>å®é™…çš„æ•°æ®å¯ä»¥å­˜å‚¨åœ¨ Redis è¿™æ ·çš„åœ°æ–¹ï¼Œè®©è¿™ä¸ªç»„ä»¶èƒ½å¤Ÿ scale. åŒæ—¶ï¼Œä¸ºäº†å¤„ç† Redis è¿™æ–¹é¢çš„å¹¶å‘æ“ä½œï¼Œå¯ä»¥ä½¿ç”¨ lua script æˆ–è€… sorted sets data structureã€‚</p><h3 id="Consisteny-Hashing"><a href="#Consisteny-Hashing" class="headerlink" title="Consisteny Hashing"></a>Consisteny Hashing</h3><p>è¿™èŠ‚å†…å®¹æ²¡å•¥è®²çš„ï¼ŒåŸºæœ¬å’Œ Dynamo é‚£ç¯‡è®ºæ–‡å·®ä¸å¤šã€‚å’Œ Chord è¿™ç¯‡è®ºæ–‡çš„ä¸ä¸€æ ·. è¿™ä¸ªæ˜¯åº”è¯¥å‡å®šæœ‰ proxy çš„</p><p>consistent hashing æˆ‘æ¨èå†çœ‹çœ‹ Jump Consistent Hashing, MagLev. è¿™ä¸¤ä¸ªéƒ½æ˜¯ Google æå‡ºæ¥çš„ã€‚</p><p><a href="https://writings.sh/post/consistent-hashing-algorithms-part-2-consistent-hash-ring">https://writings.sh/post/consistent-hashing-algorithms-part-2-consistent-hash-ring</a></p><p>ä¸Šé¢è¿™ç¯‡åšå®¢æ˜¯æˆ‘æ‰¾åˆ°çš„æœ€å¥½çš„ç›¸å…³åšå®¢ã€‚</p><h3 id="Key-Value-Storage"><a href="#Key-Value-Storage" class="headerlink" title="Key-Value Storage"></a>Key-Value Storage</h3><p>è¿™ç¯‡ä¹ŸåŸºæœ¬æ˜¯ Dynamo. æˆ‘è§‰å¾—æœ‰å…´è¶£å¯ä»¥çœ‹çœ‹ Spanner </p><p><img src="https://image.mwish.me/blog-image/B6E41610-821B-41E0-BE81-092E3179B667.png" alt="B6E41610-821B-41E0-BE81-092E3179B667"></p><p>è¿™ä¸ª cheatsheet å€’æ˜¯æŒºæœ‰æ„æ€çš„ï¼Œçœ‹å®Œ dynamo è®ºæ–‡å¯ä»¥å›å¤´çœ‹ä¸€çœ¼ã€‚</p><h3 id="Unique-ID-Generator"><a href="#Unique-ID-Generator" class="headerlink" title="Unique ID Generator"></a>Unique ID Generator</h3><p>è¿™ä¸ªå…¶å®ä¹Ÿçœ‹å¯¹ Unique ID çš„éœ€æ±‚çš„ï¼š</p><ol><li>æ˜¯å¦è¦å¼ºæœ‰åºï¼Ÿæˆ–è€…æ¯”è¾ƒå¼±çš„æœ‰åºï¼Ÿ</li><li>ä½ çš„ id éœ€è¦å¤šå°‘ä½ï¼Ÿ</li></ol><p>ä¸‹é¢æœ‰å‡ ç§æ–¹å¼ï¼š</p><p>ä¸€ï¼šèµ° DB, ç„¶å db å¯èƒ½å¯ä»¥å¤šä¸ª master. æ¯”æ–¹è¯´æœ‰ k å°æœºå™¨ï¼Œç„¶åæ¯å°æœºå™¨é€’å¢ï¼Œç„¶åå¯¹å¤–æä¾›å°±æ˜¯ï¼šå¦‚æœæ¥è‡ªç¬¬ä¸€å°å°±æ˜¯ 1, 1+k, 1 + 2kâ€¦ å¦‚æ­¤ç±»æ¨ã€‚</p><p>è¿™ç§æ–¹å¼åœ¨å¤š DC çš„ç¯å¢ƒä¸‹ä¸å¤ªå¥½å¤„ç†ï¼ŒåŒæ—¶æœåŠ¡å™¨å¢åŠ çš„æ—¶å€™ï¼Œä¸æ˜¯å¾ˆå¥½å¤„ç†ã€‚</p><p>ç„¶åå…¶å®ä¹Ÿå¯ä»¥å‚è€ƒç¾å›¢çš„ leaf: <a href="https://tech.meituan.com/2019/03/07/open-source-project-leaf.html">https://tech.meituan.com/2019/03/07/open-source-project-leaf.html</a></p><p>äºŒï¼šUUID</p><blockquote><p>A UUID is another easy way to obtain unique IDs. UUID is a 128-bit number used to identify information in computer systems. </p></blockquote><p>UUID æœ‰å‡ ç§ä¸åŒçš„ç”Ÿæˆæ–¹æ³•ï¼Œæ¯”å¦‚ UUID V1 V2 V3 V4. é€šå¸¸æˆ‘ä»¬å¯ä»¥ç”¨ v4 æ¥é«˜ä¸€äº›éšæœºç”Ÿæˆ</p><p>å½“ç„¶ï¼Œuuid ä¹Ÿå¯ä»¥æ ¹æ®åˆ«çš„ä¸€äº›ä¿¡æ¯æ¥ç”Ÿæˆã€‚</p><p>ä¸‰ï¼šTicket Server</p><p>ç”¨ Etcd ä¹‹ç±»çš„æ–¹å¼æ¥å‘å·ï¼Œè¿™ä¸ªæ¯”è¾ƒç±»ä¼¼ PingCAP çš„ PD äº†ã€‚</p><p>å››ï¼štwitter snowflake</p><p>è¿™ä¸ªæ˜¯æ ¹æ®æœºå™¨ ID å’Œæ—¶é—´æ¥å‘å·çš„ã€‚æ³¨æ„è¿™ä¸ªæ—¶é—´åº”è¯¥é‡‡ç”¨é€’å¢çš„æ—¶é—´ï¼Œè€Œä¸å…è®¸å›é€€ã€‚</p><p>æˆ‘å†™äº†ä¸ªç®€å•çš„å®ç°ï¼š<a href="https://github.com/mapleFU/md-snippets/tree/master/components/snowflake">https://github.com/mapleFU/md-snippets/tree/master/components/snowflake</a></p><h3 id="URL-Shortener"><a href="#URL-Shortener" class="headerlink" title="URL Shortener"></a>URL Shortener</h3><p>URL Shortener é€šå¸¸æœ‰è¦æ±‚æ˜¯ï¼š</p><ol><li>ä¸èƒ½é‡å¤ã€‚</li><li>human readable</li></ol><p>è¿™ä¸ªå†…å®¹ä¹Ÿå¯ä»¥ç”ŸæˆéªŒè¯ç ã€‚ç„¶åå­˜åˆ° db é‡Œé¢ï¼Œå› ä¸ºè¦åšå»é‡ã€‚è¿™é‡Œ db å¯ä»¥ç³Šä¸€å±‚ cacheï¼Œä½†æ˜¯æ„Ÿè§‰ bloom ä¸å¤ªå¥½æï¼Œå› ä¸º down æ‰äº†æ„Ÿè§‰æ¢å¤èµ·æ¥ä¸æ™“å¾—å’‹æã€‚</p><p>è¿™é‡Œæˆ‘ä¹Ÿæ“äº†ä¸€éï¼ˆä¸è¿‡å°±åªæœ‰ç®—æ³•ï¼ŒDB äº¤äº’åªå†™äº†ä¸ªæ¥å£ï¼‰ï¼š<a href="https://github.com/mapleFU/md-snippets/tree/master/components/url_shortener">https://github.com/mapleFU/md-snippets/tree/master/components/url_shortener</a></p><h2 id="Part3-Systems"><a href="#Part3-Systems" class="headerlink" title="Part3: Systems"></a>Part3: Systems</h2><h3 id="Web-Crawler"><a href="#Web-Crawler" class="headerlink" title="Web Crawler"></a>Web Crawler</h3><p>Web crawler éœ€è¦ï¼š</p><ol><li>ç»™å®šä¸€äº› Seed, ç„¶åä»è¿™äº›ç½‘é¡µå¼€å§‹æ‹‰</li><li>èƒ½å¤Ÿæ‹‰å– robot.txt éµçºªå®ˆæ³•ï¼›ç„¶åè¦æœ‰ä¸€å®šåçˆ¬èƒ½åŠ›</li><li>éœ€è¦èƒ½å¤Ÿè§£æç½‘é¡µï¼Œæ‰¾åˆ°å¯¹åº”çš„ä¿¡æ¯</li><li>æŒ‰ç…§ BFS/DFS çš„ç­–ç•¥ï¼Œä»å·²ç»çˆ¬åˆ°çš„é“¾æ¥é‡Œæ‹¿åˆ°åé¢çš„ç›®æ ‡</li><li>é˜²æ­¢æ— é™é€’å½’çš„ç½‘å€/åçˆ¬ç­–ç•¥æŠŠè‡ªå·±æå‚»äº†</li><li>å¯¹ç½‘ç»œçš„è®¿é—®ä¸è¦è¿‡äºé¢‘ç¹ï¼Œè¦é™æµ</li><li>è¦èƒ½å¤Ÿåˆç†å¤„ç† timeout</li><li>ä½†åŒæ—¶ï¼Œéœ€è¦æœ‰åˆ†å¸ƒå¼çš„çˆ¬å–èƒ½åŠ›</li></ol><p><img src="https://image.mwish.me/blog-image/806C279E-1089-4799-A21F-BA71B70FC7F6.png" alt="806C279E-1089-4799-A21F-BA71B70FC7F6"><img src="/Users/bytedance/Downloads/0624F981-1F6A-4549-A007-81CACA2D4AEE.png" alt="0624F981-1F6A-4549-A007-81CACA2D4AEE"></p><p>è¿™é‡Œæˆ‘è§‰å¾—è¿™ä¸ªæ¶æ„è¿˜æ˜¯æœ‰ç‚¹åƒ Scrapy çš„ï¼Œçœ‹äº†ä¸€ä¸‹ scrapyï¼š</p><p><img src="https://image.mwish.me/blog-image/scrapy_architecture_02.png" alt="scrapy_architecture_02"></p><p>è¿™é‡Œæœ‰ä¸€äº›ä¸­é—´ä»¶ï¼Œå°±æ˜¯ä¸Šå›¾çš„ extension model. </p><p>Scheduler å¯èƒ½å¯ä»¥æœ‰ä¸€ä¸ª Redis åç«¯ï¼Œç”¨æ¥è°ƒåº¦ä¸‹ä¸€ä¸ªåº”è¯¥æŠ“çš„ URL, ç„¶åè¿™ä¸ªå‘ç»™ downloader, èµ°é€»è¾‘ä¸‹è½½ï¼Œå†å›åˆ° engine, ä¸¢ç»™ spiders çš„ä¸­é—´ä»¶åšä¸€äº›æ‰©å±•å¤„ç†ï¼Œæœ€åæŠŠå†…å®¹ä¸¢ç»™ item pipeline.</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>LevelDB: Read path</title>
      <link href="/2021/05/13/LevelDB-Read-path/"/>
      <url>/2021/05/13/LevelDB-Read-path/</url>
      
        <content type="html"><![CDATA[<p>é‰´äºç½‘ä¸Šè®² LevelDB ä»£ç çš„æ–‡ç« æ²¡æœ‰ä¸€ä¸‡ä¹Ÿæœ‰ä¸€åƒäº†ï¼Œæœ¬æ–‡è‚¯å®šæ¯”ä»–ä»¬è¿˜çƒ‚ã€‚æ‰€ä»¥è¿™ç¯‡æ–‡ç« å°±ç®€å•è®²è®² LevelDB çš„è¯»æµç¨‹ã€‚</p><p>æˆ‘ä»¬å¯¹è¿™ä¸ªçš„äº‹å…ˆå°è±¡æ˜¯ï¼š</p><ol><li>ç”¨æˆ· <code>Get</code> ä¸€ä¸ª key</li><li>ä» memtable é‡Œé¢æ‰¾è¿™ä¸ª <code>key</code> . memtable é‡Œé¢ï¼Œkey åœ¨å†™å…¥çš„æ—¶å€™ï¼Œè¢« <code>WriteBatch::Put</code> å˜æˆäº† <code>&lt;å†™ç±»å‹, key é•¿åº¦, key å†…å®¹, value é•¿åº¦, value å†…å®¹&gt;</code> çš„å­—ç¬¦ä¸²ï¼Œç„¶ååœ¨ <code>MemTableInserter::Put</code> å’Œ <code>Memtable::Add</code> é‡Œé¢å˜æˆäº† <code>&lt;sequence, type, key é•¿åº¦, key å†…å®¹&gt;</code> <code>&lt;value é•¿åº¦, value å†…å®¹&gt;</code> çš„ <code>InternalKey</code> å’Œ <code>value</code></li><li>å¦‚æœåœ¨æ­£åœ¨å†™å…¥çš„ memtable å’Œ immutable memtable éƒ½æ²¡æœ‰ï¼Œé‚£ä¹ˆå®ƒå›åˆ° SST é‡Œé¢å»æŸ¥æ‰¾ã€‚</li></ol><p>æ­¤å¤–ï¼Œè¯»å¯ä»¥æ‹¿åˆ° iterator å’Œ snapshot, å¹¶ä¸”ç”¨ iterator å’Œ snapshot æ¥è¯»ï¼š</p><p>leveldb å¯ä»¥æ‹¿åˆ° iterator è¯»ï¼Œä¹Ÿå¯ä»¥æ‹¿åˆ° snapshot å»è¯»ï¼Œæ³¨æ„è¿™é‡Œè¿˜æ˜¯æœ‰ç”Ÿå‘½å‘¨æœŸï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">leveldb::Iterator* it = db-&gt;<span class="built_in">NewIterator</span>(leveldb::<span class="built_in">ReadOptions</span>());</span><br><span class="line"><span class="keyword">for</span> (it-&gt;<span class="built_in">SeekToFirst</span>(); it-&gt;<span class="built_in">Valid</span>(); it-&gt;<span class="built_in">Next</span>()) &#123;</span><br><span class="line">  cout &lt;&lt; it-&gt;<span class="built_in">key</span>().<span class="built_in">ToString</span>() &lt;&lt; <span class="string">&quot;: &quot;</span>  &lt;&lt; it-&gt;<span class="built_in">value</span>().<span class="built_in">ToString</span>() &lt;&lt; endl;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">assert</span>(it-&gt;<span class="built_in">status</span>().<span class="built_in">ok</span>());  <span class="comment">// Check for any errors found during the scan</span></span><br><span class="line"><span class="keyword">delete</span> it;</span><br></pre></td></tr></table></figure><p>å’Œ snapshot</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">leveldb::ReadOptions options;</span><br><span class="line">options.snapshot = db-&gt;<span class="built_in">GetSnapshot</span>();</span><br><span class="line">... apply some updates to db ...</span><br><span class="line">leveldb::Iterator* iter = db-&gt;<span class="built_in">NewIterator</span>(options);</span><br><span class="line">... read <span class="keyword">using</span> iter to view the state when the snapshot was created ...</span><br><span class="line"><span class="keyword">delete</span> iter;</span><br><span class="line">db-&gt;<span class="built_in">ReleaseSnapshot</span>(options.snapshot);</span><br></pre></td></tr></table></figure><p>LevelDB å†…éƒ¨å¤§é‡ä½¿ç”¨ <code>slice</code> ç±»å‹ï¼Œè¡¨ç¤ºâ€œæ²¡æœ‰æ‰€æœ‰æƒçš„å­—ç¬¦ä¸²â€ã€‚è¿™ä¸ªæœ‰ç‚¹ç±»ä¼¼ <code>std::string_view</code>, ä¸è¿‡åŠŸèƒ½å¼±ä¸å°‘ã€‚</p><p>é‚£ä¹ˆï¼Œæˆ‘ä»¬ä»Šå¤©è¦ç»™ä¸Šé¢çš„æµç¨‹å¡«å……ä¸€äº›ç»†èŠ‚ï¼š</p><ol><li>è¯»æ–‡ä»¶ç›¸å…³çš„ system api</li><li>LevelDB å¯¹ SST ç›¸å…³çš„è¯»å¤„ç†ï¼š<ol><li>SST æ–‡ä»¶çš„è¯»å–</li><li>Block Cache / mmap</li><li>Iterator ç±»å‹</li></ol></li><li>LevelDB è¯»ç›¸å…³çš„å†…å®¹å›æ”¶</li></ol><h3 id="System-API-amp-amp-env"><a href="#System-API-amp-amp-env" class="headerlink" title="System API &amp;&amp; env"></a>System API &amp;&amp; env</h3><p>env å®šä¹‰åœ¨æ–‡ä»¶çš„ <code>util/env.h</code> å’Œ <code>util/env_&#123;å¹³å°&#125;.cc</code> ä¸‹é¢, å®šä¹‰äº†è¿™ä¸ªå¹³å°é»˜è®¤çš„è¡Œä¸ºã€‚å’Œæ–‡ä»¶ç›¸å…³çš„å†…å®¹å…¨éƒ¨å°è£…åœ¨è¿™ä¸ªæ¥å£é‡Œã€‚</p><p>è¿™é‡Œå®šä¹‰äº†ï¼š</p><p> <code>RandomAccessFile</code> éšæœºè¯»çš„æ–‡ä»¶ï¼Œç”¨ <code>pread</code> æˆ–è€… <code>mmap</code> æ¥å®ç°ã€‚æä¾›ä¸€ä¸ªå¸¦ <code>offset</code> å’Œ <code>size</code> çš„ read æ¥å£ï¼›éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œä½¿ç”¨äº† Limit, é™åˆ¶æ•°é‡ä¸º 1000 çš„ <code>mmap</code> çš„ <code>RandomAccessFile</code> ï¼ˆè¿™ä¸ªé…ç½®å‚æ•°æ˜¯å¯ä»¥ä¿®æ”¹çš„ï¼‰ã€‚ä½œè€…è®¤ä¸ºï¼š</p><ol><li>mmap æœ¬èº«å¯ä»¥åœ¨ random access çš„æƒ…å†µä¸‹ä¼˜åŒ–è¯»ï¼ˆæ„Ÿè§‰è¿™æ˜¯å› ä¸º LevelDB æœ¬èº« Block Cache ä½¿ç”¨çš„ LRU ç­–ç•¥æ¯”è¾ƒç®€å•ï¼‰</li><li>Mmap æœ¬èº«é™åˆ¶åœ¨äº† 1000 ä¸ªï¼šä½œè€…è®¤ä¸ºè¿™æ ·å¯ä»¥ä¼˜åŒ–æ€§èƒ½ã€‚æˆ‘çœ‹äº†ä¸€ä¸‹ç›¸å…³çš„è®¨è®ºï¼Œä½œè€…è®¤ä¸º leveldb æœ¬èº«å­˜å‚¨çš„æ˜¯å°æ–‡ä»¶ï¼Œè€Œ compaction è¿‡å¤šå¯¼è‡´ç³»ç»Ÿ <code>RSS</code> ä¼šå˜å¾—å·¨å¤§ã€‚æ‰€ä»¥ä½œè€…æŠŠè¿™ä¸ªé‡é™åˆ¶åœ¨äº† 1000 ä¸ª</li></ol><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// A file abstraction for randomly reading the contents of a file.</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">LEVELDB_EXPORT</span> RandomAccessFile &#123;</span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="built_in">RandomAccessFile</span>() = <span class="keyword">default</span>;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">RandomAccessFile</span>(<span class="type">const</span> RandomAccessFile&amp;) = <span class="keyword">delete</span>;</span><br><span class="line">  RandomAccessFile&amp; <span class="keyword">operator</span>=(<span class="type">const</span> RandomAccessFile&amp;) = <span class="keyword">delete</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">virtual</span> ~<span class="built_in">RandomAccessFile</span>();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Read up to &quot;n&quot; bytes from the file starting at &quot;offset&quot;.</span></span><br><span class="line">  <span class="comment">// &quot;scratch[0..n-1]&quot; may be written by this routine.  Sets &quot;*result&quot;</span></span><br><span class="line">  <span class="comment">// to the data that was read (including if fewer than &quot;n&quot; bytes were</span></span><br><span class="line">  <span class="comment">// successfully read).  May set &quot;*result&quot; to point at data in</span></span><br><span class="line">  <span class="comment">// &quot;scratch[0..n-1]&quot;, so &quot;scratch[0..n-1]&quot; must be live when</span></span><br><span class="line">  <span class="comment">// &quot;*result&quot; is used.  If an error was encountered, returns a non-OK</span></span><br><span class="line">  <span class="comment">// status.</span></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  <span class="comment">// Safe for concurrent use by multiple threads.</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> Status <span class="title">Read</span><span class="params">(<span class="type">uint64_t</span> offset, <span class="type">size_t</span> n, Slice* result,</span></span></span><br><span class="line"><span class="params"><span class="function">                      <span class="type">char</span>* scratch)</span> <span class="type">const</span> </span>= <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>LevelDB è°ƒç”¨ <code>NewRandomAccessFile</code> çš„æ—¶å€™ï¼Œä¼šå…ˆå°è¯•èµ° <code>PosixMmapReadableFile</code> ï¼Œæ²¡æœ‰å°± fallback åˆ° <code>PosixRandomAccessFile</code>.</p><p>LevelDB ç»™æ•´ä¸ªéœ€è¦çš„é“¾è·¯éƒ½åŠ å…¥äº† <code>Env*</code>, æ¥æ”¯æŒå„ä¸ªå¹³å°ç³»ç»Ÿæ–¹é¢çš„è°ƒç”¨</p><h3 id="Block-Read"><a href="#Block-Read" class="headerlink" title="Block Read"></a>Block Read</h3><p>LevelDB çš„æ•°æ®æ˜¯ä»¥ SST ç»„ç»‡çš„ï¼ŒSST å†…åˆ‡åˆ†æˆäº†ä¸åŒçš„ block, ä»¥ä¾¿æä¾› Index/CRC/ç¼“å­˜ã€‚Block Size å’Œæ€§èƒ½æœ‰æ¯”è¾ƒå¤§çš„å…³ç³»ã€‚LevelDB æ–‡æ¡£é‡Œé¢æç¤ºï¼š</p><ol><li>Scan å±…å¤šçš„è¯ï¼Œé‚£ä¹ˆ Block Size å¯ä»¥è®¾ç½®å°ä¸€ç‚¹ã€‚</li><li>Point Get å±…å¤šçš„è¯ï¼ŒBlock Size å¯ä»¥è®¾å¤§ä¸€ç‚¹ã€‚</li></ol><p>RocksDB æ–‡æ¡£ä¹Ÿæœ‰å¯¹åº”å†…å®¹ã€‚</p><p>LevelDB ç”¨æˆ·å¯ä»¥é…ç½® BlockCache, è€Œä¸”ä¸€å®šæœ‰(ä¸ç”¨é…ç½®) TableCache. å…³äº LevelDB çš„ Cache, å¯ä»¥ç®€å•çœ‹çœ‹ï¼š</p><p><a href="https://zhuanlan.zhihu.com/p/363382898">https://zhuanlan.zhihu.com/p/363382898</a></p><p>å‰è€…æ˜¯ Block å†…å®¹çš„ç¼“å­˜ï¼Œåè€…æ˜¯ SST çš„å…ƒä¿¡æ¯çš„ç¼“å­˜ã€‚ç®€å•çš„è¯´ï¼Œå¯ä»¥é€šè¿‡åè€…ç´¢å¼•åˆ°å‰è€…ã€‚</p><p>Block cache: <code>options.block_cache</code> è®¾ç½®è¯»æ–‡ä»¶çš„æ—¶å€™ç”¨çš„ block cache, å½“æ‰§è¡Œä¸€äº›ä¸å¸Œæœ›ç”¨åˆ° block cache çš„æ“ä½œçš„æ—¶å€™ï¼Œå¯ä»¥ä½¿ç”¨ <code>options.fill_cache = false</code> çš„é…ç½®ã€‚</p><p>é‚£ä¹ˆå›åˆ°ç¨‹åºä¸­ï¼Œå…·ä½“è¯»å–æ–‡ä»¶çš„æ—¶å€™ï¼Œç¨‹åºä¼šä» <code>TableCache::Get</code> æ¥ä»å…ƒä¿¡æ¯å®šä½åˆ° Block ç›¸å…³çš„å†…å®¹ã€‚ç„¶åè°ƒç”¨ <code>Table::BlockReader</code> å’Œ <code>ReadBlock</code>. åœ¨ ReadBlock çš„æ—¶å€™ï¼Œç¨‹åºå¯¹ä¸Šè¿°çš„ <code>mmap</code> å’Œ ç”¨<code>pread</code>çš„æ–‡ä»¶ä½œå‡ºäº†åŒºåˆ†ï¼š</p><ol><li>å¦‚æœæ²¡æœ‰æä¾› <code>block_cache</code>, é‚£ä¹ˆä¸ä¼šå­˜ block cache, ä½†æ˜¯ <code>mmap</code> ä»ç„¶å¯èƒ½ä½¿ç”¨</li><li>å¦‚æœæä¾›äº† <code>block_cache</code>:<ol><li>å¦‚æœæ˜¯ <code>mmap</code> çš„æ–‡ä»¶ï¼Œä¸ä¼šèµ° Block cache</li><li>å¦åˆ™æŠŠå†…å®¹ç¼“å­˜åˆ° block cache é‡Œï¼Œä½¿ç”¨çš„ charge æ˜¯ compression ä¹‹å‰çš„ size.</li></ol></li></ol><h3 id="Iterators"><a href="#Iterators" class="headerlink" title="Iterators"></a>Iterators</h3><p><code>Iterator</code> æ¥å£å®šä¹‰åœ¨ <code>include/leveldb/iterator.h</code>, æ˜¯ LevelDB é‡Œé¢ä¸€ä¸ªå¾ˆåŒ…ç½—ä¸‡è±¡çš„ç±»å‹ã€‚è·Ÿ Iterator ç›¸å…³çš„ç±»å‹æœ‰ï¼š</p><ol><li><code>DBIter</code>, è¿™ä¸ªæ¥å£æä¾›çš„ <code>key()</code> <code>value()</code> éƒ½æ˜¯ user çš„ key, value, æä¾›ç»™ä¸Šå±‚ç”¨æˆ·ä½¿ç”¨ã€‚</li><li><code>MemTableIterator</code>: ç»™ <code>MemTable::Table::Iterator</code> å°è£…äº†ä¸€å±‚ï¼Œåè€…çš„ <code>key()</code> åŒ…å«äº† <code>InternalKey</code> å’Œ <code>value</code> , è¿™ä¸ª <code>MemTableIterator</code> å¯¹å¤–æä¾› <code>InternalKey</code> å’Œ <code>value</code></li><li><code>Block::Iter</code>: è¿™ä¸ªç±»å‹æ˜¯ç»™å•ä¸ª <code>data block</code>  å’Œ <code>index block</code>å‡†å¤‡çš„ï¼ˆleveldb è¿˜æœ‰ä¸€äº›å­˜æ”¾åˆ«çš„å…ƒä¿¡æ¯çš„ blockï¼‰: ä¼šèµ°ä¸Šä¸€èŠ‚æˆ‘ä»¬æåˆ°çš„ <code>ReadBlock</code> ç›¸å…³çš„æ¥å£ï¼Œä» Block é‡Œé¢è¯»å– <code>InternalKey</code> å’Œ <code>value</code><ol><li>è¿™é‡Œ Data Block å­˜æ”¾æ•°æ®ï¼Œindex block å­˜æ”¾å¯¹ data block çš„ç´¢å¼•ã€‚</li></ol></li></ol><p><img src="static/2021-05-14/C32EA624-79EA-43BD-8E24-1D018E3212A3.png" alt="C32EA624-79EA-43BD-8E24-1D018E3212A3"></p><p>å¦‚æœè¯´ä¸Šé¢ä¸‰ä¸ª <code>Iterator</code> è¿˜æ¯”è¾ƒæ¸…æ™°ï¼Œé‚£æˆ‘ä»¬å¯ä»¥çœ‹çœ‹ä¸‹é¢çš„ä¸€ä¸ªå¥‡æ€ªçš„ Iterator:</p><ol><li><code>Version::LevelFileNumIterator</code>: è¿™ä¸ªè¿­ä»£å™¨å¾ˆå¥‡æ€ªï¼ˆä½ é©¬ä¸Šå°±çŸ¥é“ä¸ºä»€ä¹ˆäº†ï¼‰ï¼Œå®ƒä¸¢å‡ºçš„ä¿¡æ¯æ˜¯ Iterator çš„å…ƒä¿¡æ¯(ä¸æ˜¯ç”¨æˆ·çš„ <code>key</code>, <code>value</code>, è€Œæ˜¯ â€œæ–‡ä»¶çš„ &lt;æœ€å¤§key&gt;â€ å’Œ <code>&lt;(æ–‡ä»¶å·, æ–‡ä»¶å¤§å°)&gt;</code></li></ol><p>ä¸‹é¢ï¼Œæ˜¯æ—¶å€™ç»„ç»‡èµ·è¿™äº› Iterator äº†ï¼š</p><p><code>TwoLevelIterator</code> : é‡ç‚¹æ¥äº†ï¼Œéš¾å¾—æ¥äº†ï¼<code>TwoLevelIterator</code> æä¾›äº†ä¸€ç§â€œä¸¤çº§â€ çš„æŠ½è±¡ï¼šä¸€ä¸ªæä¾›ç´¢å¼•ï¼Œä¸€ä¸ªæä¾›æ•°æ®ã€‚æä¾›æ•°æ®çš„ç»“æŸä¹‹åï¼Œæä¾›ç´¢å¼•çš„å»æ‰¾ä¸‹ä¸€é¡¹ï¼Œå…·ä½“ä½¿ç”¨çš„åœ°æ–¹æœ‰ä¸¤ä¸ªï¼š</p><ol><li><code>Table::NewIterator</code>: Table åˆ›å»ºçš„æ˜¯ TwoLevelIterator, é¦–å…ˆæ˜¯ IndexBlock çš„ iterator, ç„¶åæ˜¯å¯¹åº”çš„ block reader. å®é™…ä¸Šè¿™é‡Œå°±æ˜¯æ‹¿åˆ° index ä¿¡æ¯ï¼Œç„¶åèƒ½å¤Ÿè¯»åˆ° block çš„ä¿¡æ¯ã€‚</li><li>è¯»æŸä¸€å±‚çš„æ•°æ®ã€‚index_iter æ˜¯å•å±‚æ–‡ä»¶å…ƒä¿¡æ¯çš„è¿­ä»£å™¨ <code>Version::LevelFileNumIterator</code>ï¼ŒBlockFunction æ˜¯ (1) ä¸­çš„æ•´åˆã€‚è§ <code>Version::NewConcatenatingIterator</code>.</li></ol><p>æ€ä¹ˆæ ·ï¼Œæ˜¯ä¸æ˜¯è¿èµ·æ¥äº†ï½</p><p>å†æ¥ä¸€ä¸ªï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Iterator* <span class="title">NewMergingIterator</span><span class="params">(<span class="type">const</span> Comparator* comparator, Iterator** children,</span></span></span><br><span class="line"><span class="params"><span class="function">                             <span class="type">int</span> n)</span></span>;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªåœ°æ–¹ä¼šåˆ›å»ºä¸€ä¸ª <code>MergingIterator</code>, åˆå¹¶æ‰€æœ‰çš„ Iterator, æ‰¾åˆ° <code>key</code> æœ€å°çš„ä¸€ä¸ªã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç›®å‰ä½¿ç”¨çš„æ—¶å€™ï¼Œè¿™é‡Œ <code>key</code> æœ€å°æŒ‡çš„è¿˜æ˜¯ <code>InternalKey</code>.</p><p>æ­¤å¤–ï¼Œè¿˜è¦æ³¨æ„ <code>RegisterCleanup</code>, è¿™ä¸ªå‡½æ•°æ˜¯ <code>Iterator</code> æ¸…ç†è‡ªèº«èµ„æºç”¨çš„ã€‚</p><h3 id="Version-amp-amp-snapshot"><a href="#Version-amp-amp-snapshot" class="headerlink" title="Version &amp;&amp; snapshot"></a>Version &amp;&amp; snapshot</h3><p>æˆ‘ä»¬ä¸Šé¢æä¾›äº†å„ç§å„æ ·çš„ <code>Iterator</code>, è¿™ä¸‹æˆ‘ä»¬è¯»çš„æ—¶å€™å¯æœ‰å·¥å…·äº†ã€‚ä½†æ˜¯è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¯»çš„æ—¶å€™è¿˜å¯ä»¥é€‰æ‹©ä¸€ä¸ª snapshot, ç„¶åï¼Œè¿˜éœ€è¦è€ƒè™‘è¯»çš„æ—¶å€™ï¼Œä¸­é€”å‘ç”Ÿäº† compaction è¦æ€ä¹ˆå¤„ç†ã€‚</p><p>LevelDB æä¾›äº†ä¸€ä¸ª <code>sequence_id</code> æ¥æŒ‡å®šé¡ºåºã€‚å®ƒå®šä¹‰çš„æ˜¯è¯»ç›¸å¯¹äºå†™çš„ååº, ä»–å­˜å‚¨åœ¨ <code>VersionSet</code> é‡Œï¼š</p><ol><li>å†™ä¼šæ¨é«˜ <code>last_sequence_</code>, è€Œä¸”æ˜¯ä¸€æ¬¡æ€§æ¨é«˜å¾ˆå¤šï¼Œç­‰åŒäºå†™å…¥çš„ batch</li><li>è¯»ä¼šæ‹¿åˆ° <code>last_sequence_</code> , å¹¶æ ¹æ®è¿™ä¸ªå€¼æ¥å†³å®šè‡ªå·±è¯»åˆ°ä»€ä¹ˆã€‚</li></ol><p>å®é™…ä¸Šï¼Œå³ä½¿ä¸å¤–éƒ¨åˆ›å»º Snapshot, å†…éƒ¨ä¹Ÿä¼šæ‹¿åˆ°ä¸€ä¸ªæœ€è¿‘çš„ sequence id, æ¥å†³å®šè¿™ä¸ªæ—¶å€™çš„è¡Œä¸ºã€‚</p><p>LevelDB æ‹¿åˆ°äº†è¿™ä¸ª <code>sequence_id</code> ä¹‹å, éœ€è¦æ¥ä¸‹æ¥å†³å®šè‡ªå·±è¦è¯»ä»€ä¹ˆã€‚ç„¶åå®ƒä¼šæ‰¾åˆ°æœ€æ–°çš„ <code>Version</code>. <code>Version</code> æ˜¯ LevelDB ä¸­ SST æ–‡ä»¶å¸ƒå±€çš„ä¸€ä¸ªç‰ˆæœ¬ï¼Œæœ‰ä»»ä½•çš„ compaction å‘ç”Ÿï¼Œéƒ½ä¼šç”Ÿæˆæ–°çš„ Versionã€‚é‚£ä¹ˆä¸ºä»€ä¹ˆå®ƒæ¯æ¬¡éƒ½ä¼šæ‰¾åˆ°æ–°çš„ Version, è€Œä¸æ˜¯æ ¹æ® snapshot æ¥æ‰¾ç‰ˆæœ¬é“¾å‘¢ï¼Ÿï¼ˆå…¶å®è¿™ä¸ªåœ°æ–¹æˆ‘è¿˜æ²¡ä»”ç»†è€ƒè™‘è¿‡ï¼Œè®°ä¸ª TODOâ€¦.ï¼‰</p><p>æ‹¿åˆ° Version ä¹‹åï¼Œå•ä¸ª Version é‡Œé¢ï¼Œå†…å®¹æ˜¯ä¸å˜çš„ã€‚Version å¯ä»¥æä¾›æ¯å±‚çš„ <code>Iterator</code>, æ‹¿åˆ°è¿™äº›å°±å¯ä»¥æ„å»º <code>MergingIterator</code> å»è¯»å•¦~</p><h3 id="èµ„æºå›æ”¶"><a href="#èµ„æºå›æ”¶" class="headerlink" title="èµ„æºå›æ”¶"></a>èµ„æºå›æ”¶</h3><p>å®é™…ä¸Šï¼ŒLevelDB å¤§éƒ¨åˆ†é‡‡ç”¨äº†è¯»è€…æ¥å›æ”¶å†…å­˜çš„æ¨¡å¼ï¼ŒåŒæ—¶ä½¿ç”¨äº†å¾ˆå¤šå¼•ç”¨è®¡æ•°ã€‚è¿™äº›å¼•ç”¨è®¡æ•°é€šå¸¸éƒ½ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚</p><p>å¾ˆå¤šç±»æä¾›äº† <code>Ref()</code> <code>Unref()</code> çš„æ–¹æ³•ã€‚æ„Ÿè§‰ LevelDB æœ€å¥½æä¾›ä¸ªä¾µå…¥å¼æ™ºèƒ½æŒ‡é’ˆï¼ˆè™½ç„¶å®ƒæ²¡æœ‰ï¼‰ã€‚</p><p>é‚£ä¹ˆåœ¨è¯»çš„æ—¶å€™ï¼Œ<code>Version</code>, <code>Memtable</code> å¯¹è±¡ä¼šè¢« <code>Ref()</code> ä¸€ä¸‹ã€‚ç„¶åï¼Œæœ‰çš„æ—¶å€™æ˜¯æ‰‹åŠ¨<code>Unref</code>, æœ‰çš„æ—¶å€™ï¼Œæ˜¯ç»™ <code>Iterator</code> ä½¿ç”¨äº† <code>RegisterCleanup</code>ï¼Œè®©å®ƒä»¬åœ¨æ­£ç¡®çš„æ—¶é—´ <code>Unref</code>. </p><h3 id="å¯¹-Compaction-çš„å½±å“"><a href="#å¯¹-Compaction-çš„å½±å“" class="headerlink" title="å¯¹ Compaction çš„å½±å“"></a>å¯¹ Compaction çš„å½±å“</h3><p>è¯»è¡Œä¸ºä¼šå¯å‘å¼çš„å¯¼è‡´ seek compaction. è¿™ä¸ªå¯ä»¥çœ‹åˆ° <code>DBIter</code> å’Œ  <code>Stats</code>ç›¸å…³çš„ä»£ç ï¼Œæœ‰ä¸¤ç§æ›´æ–°æ–¹å¼ï¼š</p><ol><li>ç‚¹æŸ¥çš„æ—¶å€™ï¼Œå¦‚æœè¿™å±‚ SST æ²¡æ‰¾åˆ°å¯¹åº”çš„å†…å®¹ï¼ˆåŒæ—¶ bloom filter ä¹Ÿæ²¡æœ‰å›é¿è¿™æ¬¡è¯»ï¼‰ï¼Œè€Œä¸‹å±‚æœ‰ï¼Œåˆ™è®°å½•</li><li>seek çš„æ—¶å€™ï¼Œä¼šæœ‰ä¸€ä¸ªé‡‡æ ·ç®—æ³•ï¼Œè®°å½•</li></ol><p>å½“è®°å½•åˆ°è¾¾ä¸€å®šå€¼çš„æ—¶å€™ï¼Œleveldb è®¤ä¸ºåº”è¯¥é”™å³°çš„å» compactionï¼Œè¿™ä¸ªå« Seek Compaction.</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Notes on &lt;LSM-based Storage Techniques: A Survey&gt;: Part 2</title>
      <link href="/2021/04/23/Notes-on-LSM-based-Storage-Techniques-A-Survey-Part-2/"/>
      <url>/2021/04/23/Notes-on-LSM-based-Storage-Techniques-A-Survey-Part-2/</url>
      
        <content type="html"><![CDATA[<h2 id="LSM-Tree-improvements"><a href="#LSM-Tree-improvements" class="headerlink" title="LSM-Tree improvements"></a>LSM-Tree improvements</h2><p>å°½ç®¡ç°åœ¨ LSM-Tree è¢«ç”¨åˆ°äº†å¤šç§ NoSQL ä¸­ï¼Œä½†æ˜¯åŸå§‹çš„ LSM-Tree ä»ç„¶æœ‰ä¸‹é¢çš„ç¼ºç‚¹ï¼š</p><ol><li>å†™æ”¾å¤§ï¼šLSM-Tree èƒ½æ¯” in-place update æä¾›æ›´å¥½çš„å†™æ€§èƒ½ï¼Œä½†æ˜¯ LSM-Tree çš„ compaction ä¼šé€ æˆä¸å°çš„å†™æ”¾å¤§ã€‚å¦‚æˆ‘ä»¬ä¹‹å‰åˆ†æçš„, Leveled Compaction æ¯å±‚æ¯ä¸ª key éœ€è¦å†™ T æ¬¡ã€‚è€Œå¤šå±‚åˆä¼šä¹˜ä»¥å¦ä¸€ä¸ªç³»æ•°ã€‚è¿™ç§å†™æ”¾å¤§ä¸ä»…ä¼šé™åˆ¶å†™æ€§èƒ½ï¼Œä¹Ÿä¼šå¾ˆå¿«é€Ÿçš„æŠŠ SSD ç›˜å†™å</li><li>Compaction æ“ä½œï¼šLSM-Tree æœ‰å¾ˆé‡çš„é€»è¾‘éƒ½å’Œ compaction æœ‰å…³ï¼Œæ‰€ä»¥è¦éå¸¸è°¨æ…çš„å®ç° compaction æ“ä½œã€‚æ­¤å¤–ï¼Œcompaction å¯èƒ½ä¼šé€ æˆ Write Stallï¼Œæˆ–è€…æ˜¯æŸ¥è¯¢çš„æ—¶å€™ï¼Œå› ä¸ºäº§ç”Ÿäº†ä¸åœ¨ cache ä¸­çš„æ–°æ–‡ä»¶ï¼Œå¯¹æ–°æ–‡ä»¶æœ‰ cache miss.</li><li>ç¡¬ä»¶ï¼šåŸå§‹çš„ LSM-Tree æ˜¯ä»¥ HDD ä¸º C0 å¤–å…¶ä»–ç»„ä»¶å­˜å‚¨æ¥å®ç°çš„ï¼Œå®ƒçš„é¡ºåºå†™å…¥æ¯”éšæœºå†™å…¥å¿«å¾ˆå¤šã€‚ç°åœ¨æˆ‘ä»¬è¿›å…¥äº†å¤§å†…å­˜ã€SSD/NVMEã€NVM çš„æ—¶ä»£ã€‚ä¸ºäº†é€‚åº”è¿™äº›æ–°çš„å­˜å‚¨ï¼ŒLSM-Tree éœ€è¦å¯¹åº”çš„æ”¹è¿›</li><li>ç‰¹æ®Šçš„ workloads: å¯èƒ½æœ‰ä¸€äº›ç‰¹æ®Šçš„è´Ÿè½½ï¼Œå¯ä»¥éœ€è¦ç‰¹æ®Šçš„ LSM-Treeï¼Œæä¾›èƒ½å¥½çš„æ€§èƒ½ï¼Œæ¯”å¦‚ append å ç»å¤§å¤šæ•°çš„ ï¼ˆmq ä¸­ï¼‰ï¼Œæˆ–è€… key-value å°çš„ï¼Œèƒ½å…¨éƒ¨è£…åœ¨ memory ä¸­çš„â€¦ å¯¹äºè¿™äº›å¯ä»¥è®¾ç½®ç‰¹æ®Šçš„ç»“æ„</li><li>secondary indexing: å¯¹äº LSM-Treeï¼Œå¤§éƒ¨åˆ†åŸºæœ¬å®ç°æä¾›äº†ä¸€ä¸ªç®€å•çš„ k/v æ¥å£. å¦‚æœæˆ‘ä»¬æŠŠè¿™ä¸ª æ¨¡å‹è§†ä½œ <code>&lt;key, Tuple&gt;</code>ï¼Œé‚£ä¹ˆè®¿é—®çš„æ—¶å€™ï¼Œå¦‚æœæŸ¥è¯¢é key çš„æŸä¸ª tuple ä¸­çš„å…ƒç´ ï¼Œåˆ™éœ€è¦é¢å¤–æ”¯æŒã€‚ä¸€äº› LSM-Tree å˜ç§å¯¹è¿™ç§è´Ÿè½½æä¾›äº†å¾ˆå¥½çš„æ”¯æŒã€‚</li></ol><p><img src="https://image.mwish.me/blog-image/96B112B9-F87D-4394-B9DA-2DCEE57FA832.png" alt="96B112B9-F87D-4394-B9DA-2DCEE57FA832"></p><p>ä»¥ä¸Šä¸€å¼ å›¾æ˜¯è®ºæ–‡å¯¹è¿™ä¸ªä¼˜åŒ–ç³»è°±çš„æè¿°ï¼Œè¿™é‡Œåªä»‹ç» 1-3ã€‚ä¸‹é¢æˆ‘ä»¬å°†ä¸€ä¸ªä¸ªä»‹ç»è¿™äº›ä¼˜åŒ–ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç”±äºç¬”è€…èƒ½åŠ›æ‰€é™ï¼Œè¿™äº›ä»‹ç»å¯èƒ½ä¼šæœ‰çº°æ¼æˆ–è€…é”™è¯¯ã€‚æ¬¢è¿è¯»è€…æŒ‡æ­£ã€‚</p><h2 id="å‡å°å†™æ”¾å¤§"><a href="#å‡å°å†™æ”¾å¤§" class="headerlink" title="å‡å°å†™æ”¾å¤§"></a>å‡å°å†™æ”¾å¤§</h2><p>å¤§å¤šæ•°å‡å°å†™æ”¾å¤§çš„å†…å®¹å’Œ tiered compaction ç›¸å…³ã€‚éœ€è¦ç”¨åˆ°æˆ‘ä»¬ä¹‹å‰ä»‹ç»çš„ vertical grouping æˆ–è€… horizontal grouping:</p><p><img src="https://image.mwish.me/blog-image/1EF1AB80-7796-489F-966C-B25AA382E4B0.png" alt="1EF1AB80-7796-489F-966C-B25AA382E4B0"></p><p>åˆ©ç”¨è¿™ç§ groupingï¼Œæƒè¡¡ä¸€å®šçš„è¯»å†™æ”¾å¤§ã€‚</p><h4 id="WriteBuffer-Tree"><a href="#WriteBuffer-Tree" class="headerlink" title="WriteBuffer Tree"></a>WriteBuffer Tree</h4><p>[1] WriteBuffer Tree å¯ä»¥è¢«å½“æˆ vertical grouping + tiered compaction çš„å˜ç§ã€‚å®ƒå‡ºè‡ª <strong>Design of a Write-Optimized Data Store</strong> ã€‚</p><p>çœ‹çœ‹ WB-Tree è®ºæ–‡çš„ä»‹ç»ï¼š</p><blockquote><p>WB Tree, an <em>unordered</em> key-value store optimized for high insert performance while maintaining fast random read access.</p></blockquote><p>æ‰€ä»¥éœ€è¦æ³¨æ„ï¼Œå®ƒæ˜¯ä¸æ”¯æŒ range çš„ã€‚</p><p><img src="https://image.mwish.me/blog-image/F6DB6302-6E3D-46F1-AB11-88FB775CE17B.png" alt="F6DB6302-6E3D-46F1-AB11-88FB775CE17B"></p><p>å¦‚ä¸Šå›¾æ‰€æè¿°ï¼Œå®ƒåˆ©ç”¨ hash-partition, è®©æ¯ä¸ª group å­˜å‚¨å·®ä¸å¤šçš„æ•°æ®é‡ï¼Œç„¶åç”¨ B-Tree ç±»ä¼¼çš„ç»“æ„ï¼Œç»„ç»‡è¿™ä¸ªæ ‘ã€‚</p><p>å½“ä¸€ä¸ª non-leaf node æ»¡çš„æ—¶å€™ï¼Œå®ƒä¼šæ‰§è¡Œ spill: compaction ç„¶åå†™åˆ° children é‡Œã€‚è¿™é‡Œæ˜¯ append è¿›å»çš„ï¼Œæ‰€ä»¥å†™å¼€é”€ç›¸å¯¹å°ã€‚</p><p>å½“ä¸€ä¸ª Leaf node æ»¡çš„æ—¶å€™ï¼Œå®ƒä¼šæ‰§è¡Œ split, åˆ†è£‚åˆ°ä¸¤ä¸ªå¶å­ç»“ç‚¹ä¸­ã€‚</p><h4 id="LWC-Tree"><a href="#LWC-Tree" class="headerlink" title="LWC-Tree"></a>LWC-Tree</h4><p>LWC-Tree å¯ä»¥å‚è€ƒè¿™ä¸ª slide : <a href="https://www.storageconference.us/2017/Presentations/CompactionTreeToReduceIOamplification-slides.pdf">https://www.storageconference.us/2017/Presentations/CompactionTreeToReduceIOamplification-slides.pdf</a></p><p><img src="https://image.mwish.me/blog-image/D6068B0F-81E4-4B4B-8FCF-5A889C0C9DFD.png" alt="D6068B0F-81E4-4B4B-8FCF-5A889C0C9DFD"></p><p>è¿™é‡Œï¼ŒæŠŠ compaction å˜æˆäº† light-weight compactionã€‚ä½œä¸ºæ·»åŠ åˆ° sstable ä¸­ã€‚</p><p>è¿™ç§æ–¹æ³•çš„å›°éš¾æ˜¯ï¼Œéœ€è¦èƒ½å¤Ÿå¤„ç† metadata. å› ä¸º SSTable çš„ index block å¯æ²¡é‚£ä¹ˆèªæ˜ã€‚æ‰€ä»¥è¿™é‡Œè®¾è®¡äº†ä¸€ä¸ªå¯¹åº”çš„ DTable.</p><h4 id="PebblesDB"><a href="#PebblesDB" class="headerlink" title="PebblesDB"></a>PebblesDB</h4><p>PebblesDB è®¤ä¸ºå†™æ”¾å¤§çš„æ ¹æœ¬åŸå› æ˜¯ï¼Œå¤šæ¬¡ rewrite data to the same level. æ‰€ä»¥ä»–è®¤ä¸ºï¼Œéœ€è¦ç»´æŠ¤æ¯ä¸ª level çš„æ²¡æœ‰äº¤é›†çš„æ–‡ä»¶ã€‚</p><p><img src="https://image.mwish.me/blog-image/CB1BCC0F-B0CE-4A2E-88EF-7547A45D9626.png" alt="CB1BCC0F-B0CE-4A2E-88EF-7547A45D9626"></p><p>å®ƒä½¿ç”¨ Guard æ¥åˆ‡åˆ†è¿™äº›æ–‡ä»¶ã€‚</p><h4 id="dCompaction"><a href="#dCompaction" class="headerlink" title="dCompaction"></a>dCompaction</h4><p>dCompaction ç»´æŠ¤äº†è™šæ‹Ÿçš„ SSTable:</p><blockquote><p>A virtual merge operation produces a virtual SSTable that sim- ply points to the input SSTables without performing actual merges. However, since a virtual SSTable points to multiple SSTables with overlapping ranges, query performance will degrade.</p></blockquote><p>å®é™…ä¸Šæˆ‘è§‰å¾—è¿™ç›¸å½“äºä¸€ä¸ªæ‡’æƒ°çš„ merge ï¼Œè¿™æ ·ä¼šé™ä½ query çš„æ•ˆç‡ã€‚æ‰€ä»¥æ ¹æ® query çš„æ¬¡æ•°è§¦å‘ compactionã€‚</p><p>ä¸Šé¢è¿™äº›æ–¹æ³•éƒ½éƒ¨ä»½ç±»ä¼¼ tiered compaction + vertical groupingã€‚</p><h4 id="merge-skiping"><a href="#merge-skiping" class="headerlink" title="merge skiping"></a>merge skiping</h4><p>skip-tree çš„è®¾æƒ³æ˜¯ï¼Œä¸€ä¸ª level 0 åœ¨ compaction çš„æ—¶å€™ï¼Œç›´æ¥åˆ°è¾¾æ²¡æœ‰ overlapping çš„æœ€å¤§å±‚ã€‚</p><p><img src="https://image.mwish.me/blog-image/A68631B2-AA26-4161-A2E3-15E02FB81A8A.png" alt="A68631B2-AA26-4161-A2E3-15E02FB81A8A"></p><p>å¦‚æœ merge çš„æ—¶å€™ï¼ŒæŸä¸ª key åœ¨ä¸‹é¢å±‚éƒ½æ²¡æœ‰ï¼Œé‚£ä¹ˆä¹… skip åˆ°æœ€ä¸‹å±‚ï¼Œæ¯å±‚æœ‰ä¸ª mutable buffer. ä¼šå†™åˆ°è¿™ä¸ª mutable buffer é‡Œé¢ã€‚ä¸ºäº†å‡å°æ—¥å¿—å¼€é”€ï¼Œè¿™é‡Œåªä¼š log merge çš„ key, è®© replay wal çš„æ—¶å€™ï¼Œèƒ½å¤Ÿæ‰¾åˆ°åŸæ¥ SSTable ä¸­çš„ key, valueã€‚</p><p>è¿™ç§æ–¹æ³•ç›®å‰å¹¶æ²¡æœ‰æ€ä¹ˆé‡‡ç”¨ï¼Œå› ä¸ºç®¡ç† mutable buffer å’Œ merge è¿‡äºå¤æ‚ã€‚åŒæ—¶ï¼Œç›¸å…³çš„æ€§èƒ½å¾ˆéš¾åˆ†æã€‚</p><h4 id="Exploiting-Data-Skew"><a href="#Exploiting-Data-Skew" class="headerlink" title="Exploiting Data Skew"></a>Exploiting Data Skew</h4><p>TRIAD åœ¨æœ‰ hot key è¢«é¢‘ç¹æ›´æ–°çš„æ—¶å€™ï¼Œå¯ä»¥å‡å°ç›¸å…³çš„å†™å¼€é”€ã€‚å®ƒçš„åŸºæœ¬ idea æ˜¯æŠŠ hot-key åšæˆæŸç§ in-memory db çš„ç»“æ„ã€‚</p><h4 id="å‡å°å†™æ”¾å¤§ï¼šæ€»ç»“"><a href="#å‡å°å†™æ”¾å¤§ï¼šæ€»ç»“" class="headerlink" title="å‡å°å†™æ”¾å¤§ï¼šæ€»ç»“"></a>å‡å°å†™æ”¾å¤§ï¼šæ€»ç»“</h4><p>ä»¥ä¸Šçš„å†™æ”¾å¤§ä¼˜åŒ–ï¼Œå¤§éƒ¨åˆ†ç”Ÿæˆè‡ªå·±èƒ½å¤Ÿæ˜¾è‘—æå‡ LSM-T çš„å†™æ€§èƒ½ã€‚ä½†æ˜¯è¿™äº›ç»“æœé€šå¸¸æ¯”è¾ƒéš¾è¯„ä¼°ï¼ŒåŒæ—¶ RocksDB/LevelDB é»˜è®¤è¿˜æ˜¯é‡‡ç”¨äº†æ¯”è¾ƒæœ´ç´ çš„ç­–ç•¥ã€‚æ­¤å¤–ï¼Œä»–ä»¬å¯¹ç©ºé—´æ”¾å¤§ä»æ¥ä¹Ÿæ²¡æœ‰é‚£ä¹ˆåœ¨æ„ã€‚</p><h2 id="ä¼˜åŒ–-merge"><a href="#ä¼˜åŒ–-merge" class="headerlink" title="ä¼˜åŒ– merge"></a>ä¼˜åŒ– merge</h2><p>merge ç›¸å…³çš„ä¼˜åŒ–åŒ…æ‹¬æ”¹å–„ merge æ€§èƒ½ã€å‡å° buffer cache missã€é¿å… write stall</p><h3 id="æ”¹å–„-merge-æ€§èƒ½"><a href="#æ”¹å–„-merge-æ€§èƒ½" class="headerlink" title="æ”¹å–„ merge æ€§èƒ½"></a>æ”¹å–„ merge æ€§èƒ½</h3><p>VT-Tree åšäº†ä¸€ç§ä¼˜åŒ–ï¼šmerge çš„æ—¶å€™ï¼Œå¦‚æœä¸€ä¸ª sstable å’Œåˆ«çš„ merge ç›®æ ‡æ²¡æœ‰é‡å¤ç©ºé—´ï¼Œé‚£ä¹ˆä¸‹å±‚ç›´æ¥æŒ‡å‘ä¸Šå±‚å¯¹åº”çš„å†…å®¹ã€‚</p><p><img src="https://image.mwish.me/blog-image/3CDAF69E-CF33-4ACA-9BDE-272976222B84.png" alt="3CDAF69E-CF33-4ACA-9BDE-272976222B84"></p><p>è¿™é‡Œä¼˜åŒ–äº† compaction çš„æ€§èƒ½ï¼Œä½†æ˜¯é€ æˆäº†ç¢ç‰‡åŒ–ã€‚VT-Tree æ·»åŠ äº†ä¸€ä¸ª stitching é˜ˆå€¼ K, è¶…è¿‡è¿™ä¸ªé˜ˆå€¼çš„æ—¶å€™ï¼Œç›¸å…³çš„å†…å®¹ä¼šè¢«é»åˆåˆ°ä¸€èµ·ã€‚</p><p>æ­¤å¤–ï¼Œè¿™é‡Œ merge çš„æ—¶å€™ï¼Œå› ä¸º bloom filter ä¸èƒ½åˆèµ·æ¥ï¼Œæ‰€ä»¥é‡‡ç”¨äº† quotient filtersã€‚è¿™ç§ç±»å‹æ¯”è¾ƒéš¾å®ç°ï¼Œä½†æ˜¯åŠŸèƒ½å¼ºå¤§ï¼Œèƒ½å¤Ÿåˆå¹¶èµ·æ¥ã€‚</p><p>æ­¤å¤–ï¼Œè¿˜æœ‰å°† compaction çš„è¿‡ç¨‹ pipeline çš„è®¾è®¡ï¼š</p><p><img src="https://image.mwish.me/blog-image/48930BF5-699D-4828-8EE3-166508520720.png" alt="48930BF5-699D-4828-8EE3-166508520720"></p><p>è¿™é‡ŒæŠŠ compaction åˆ†æˆä¸‰ä¸ªéƒ¨åˆ†ï¼šread â€” write â€” sort. è¿™é‡Œè®¤ä¸º read/write æ˜¯ é‡IO çš„ï¼Œä½œè€…è®¤ä¸ºå¯ä»¥å°†è¿™å‡ éƒ¨åˆ†æµæ°´çº¿å¤„ç†ã€‚</p><h3 id="å‡å°-cache-miss"><a href="#å‡å°-cache-miss" class="headerlink" title="å‡å° cache miss"></a>å‡å° cache miss</h3><p>äº§ç”Ÿæ–°çš„ component çš„æ—¶å€™ï¼Œç›¸å…³çš„å†…å®¹å¯èƒ½å› ä¸ºæ²¡åœ¨å†…å­˜é‡Œï¼Œäº§ç”Ÿå¤§é‡ cache miss.</p><p>æœ‰ä¸€ç§æ–¹æ³•æ˜¯ï¼Œäº§ç”Ÿæ–°çš„ component çš„æ—¶å€™ï¼Œå¯ä»¥ warmup ç›¸å…³çš„å†…å®¹ã€‚æ…¢æ…¢ä»æ—§çš„ component ç°åº¦åˆ°æ–°çš„å†…å®¹ä¸­ã€‚ç”¨è¿™ç§æ–¹å¼å‡æ‘Šæš´æ¶¨çš„ cache missã€‚</p><p>LSbM-Tree æä¾›äº†å¦ä¸€ç§æ–¹æ³•ï¼Œä¸Šå±‚ merge çš„æ—¶å€™ï¼Œç›´æ¥æŠŠå¯¹åº”ç¼“å­˜çš„å†…å®¹æ¨åˆ°ä¸‹ä¸€å±‚ï¼Œç­‰å®ƒä»¬è¢« LRU ä¹‹ç±»çš„ç®—æ³•æ¢å‡ºã€‚ä¸è¿‡ï¼š</p><blockquote><p>However, this approach is mainly effective for skewed workloads where only a small range of keys are frequently accessed. It can in- troduce extra overhead for queries accessing cold data that are not cached, especially for range queries since they can- not benefit from Bloom filters.</p></blockquote><p><img src="https://image.mwish.me/blog-image/A2A366A4-FF93-4081-8D98-BF398A9B84F4.png" alt="A2A366A4-FF93-4081-8D98-BF398A9B84F4"></p><h3 id="minimize-write-stalls"><a href="#minimize-write-stalls" class="headerlink" title="minimize write stalls"></a>minimize write stalls</h3><p>bLSM ä¸ºäº† unpartioned Leveled compaction è€Œè®¾è®¡ï¼Œå®ƒç»™ LSM-Tree æ¯å±‚æ·»åŠ äº†é¢å¤–çš„è°ƒåº¦ç»„ä»¶ã€‚å½“éœ€è¦ compaction çš„æ—¶å€™ï¼Œå®ƒç­‰å¾…ä¸Šä¸€å±‚å¾€è‡ªå·±è¿™å±‚ compaction å®Œï¼Œåœ¨è¿›è¡Œæ“ä½œã€‚è¿™æœ€ç»ˆé™åˆ¶äº†å†™å…¥çš„é€Ÿåº¦å’Œ SSD å†™å…¥çš„æ•°é‡ã€‚</p><p>å½“ç„¶ï¼Œä½œè€…æ‰¹è¯„ bLSM-Tree æ²¡æœ‰è€ƒè™‘è¿™ä¸ªç­‰å¾…ç›¸å…³çš„ queuing latency.</p><h2 id="ç¡¬ä»¶"><a href="#ç¡¬ä»¶" class="headerlink" title="ç¡¬ä»¶"></a>ç¡¬ä»¶</h2><p>åŸå§‹çš„ LSM-Tree æ˜¯ä»¥ HDD ä¸º C0 å¤–å…¶ä»–ç»„ä»¶å­˜å‚¨æ¥å®ç°çš„ï¼Œå®ƒçš„é¡ºåºå†™å…¥æ¯”éšæœºå†™å…¥å¿«å¾ˆå¤šã€‚ç°åœ¨æˆ‘ä»¬è¿›å…¥äº†å¤§å†…å­˜ã€SSD/NVMEã€NVM çš„æ—¶ä»£ã€‚ä¸ºäº†é€‚åº”è¿™äº›æ–°çš„å­˜å‚¨ï¼ŒLSM-Tree éœ€è¦å¯¹åº”çš„æ”¹è¿›ï¼Œæ¥é’ˆå¯¹ä¸Šè¿°è¿™äº›ä»‹è´¨æä¾›å¥½çš„æ€§èƒ½ã€é«˜æ•ˆçš„æ“ä½œã€‚</p><h3 id="big-memory"><a href="#big-memory" class="headerlink" title="big-memory"></a>big-memory</h3><p><em>FloDB: Unlocking Memory inPersistent Key-Value Stores</em> è¿™ç¯‡è®ºæ–‡æå‡ºäº† FloDB.</p><p>ä½œè€…è®¤ä¸ºï¼Œå¯¹äºå¤§çš„å†…å­˜ components, LevelDB/RocksDB è¿™äº›æ•ˆæœå¹¶ä¸å¥½ï¼Œäºæ˜¯å®ƒä½¿ç”¨äº† HashTable æ¥åšä¸€ä¸ªå†™å…¥å±‚ã€‚</p><p><img src="https://image.mwish.me/blog-image/B26ED72F-FEF4-4C9A-AC39-4F2C0B79BF67.png" alt="B26ED72F-FEF4-4C9A-AC39-4F2C0B79BF67"></p><p><img src="https://image.mwish.me/blog-image/A98B25C8-6411-4AB0-AC12-3E65AE287120.png" alt="A98B25C8-6411-4AB0-AC12-3E65AE287120"></p><p>ä½œè€…è®¤ä¸ºè¿™æ ·èƒ½æé«˜ å¤§ memory components çš„å†™å…¥æ€§èƒ½ã€‚</p><h3 id="Multi-Core"><a href="#Multi-Core" class="headerlink" title="Multi-Core"></a>Multi-Core</h3><p>Scaling  Concurrent  Log-Structured  Data  Stores æå‡ºäº† cLSM:</p><p><img src="https://image.mwish.me/blog-image/AC15DF930A30DEDD727688E0EA0A71EF.png" alt="AC15DF930A30DEDD727688E0EA0A71EF"></p><p>cLSM æä¾›äº†ä¸€ç§ Non-blocking synchronizationï¼Œä¸è¿‡æˆ‘ç®€å•çœ‹äº†ä¸‹ï¼Œæ„Ÿè§‰ç°åœ¨ LevelDB, RocksDB éƒ½å·®ä¸å¤šæ˜¯è¿™æ ·â€¦å¦‚æœæˆ‘æ„Ÿè§‰ä¸å¯¹å¯ä»¥æé†’æˆ‘ã€‚</p><h3 id="SSD"><a href="#SSD" class="headerlink" title="SSD"></a>SSD</h3><p>ä¸ä¼ ç»Ÿçš„ç›˜ä¸åŒï¼ŒSSDçš„éšæœºè¯»å†™ç›¸å¯¹æ¥è¯´é€Ÿåº¦ä¸ä¿—ã€‚</p><p>FD-Tree ç”¨ç±»ä¼¼ LSM-Tree çš„æ–¹å¼æ¥å‡å° SSD çš„ random write. å®ƒæ’å…¥äº†ä¸å°‘ fence pointer</p><p><img src="https://image.mwish.me/blog-image/57B0315D-C919-43C8-9D09-19C22D415D35.png" alt="57B0315D-C919-43C8-9D09-19C22D415D35"></p><p><img src="https://image.mwish.me/blog-image/fdtree-arch.png" alt="fdtree-arch"></p><p>FD-Tree ç®—æ˜¯ BTree LSMTree çš„ç¼åˆæ€ªï¼Œè®ºæ–‡è¿™é‡Œæåˆ°ä»–æ˜¯å› ä¸ºè¿™é‡Œç”¨ fence pointer ä»£æ›¿ BFã€‚</p><p>å½“ç„¶ï¼Œè¿™é‡Œæå‡äº†æŸ¥è¯¢æ•ˆç‡ï¼Œä½†æ˜¯å·®ä¸åˆ°çš„ä¸œè¥¿è¿˜æ˜¯è¦ä»å¤´æŸ¥åˆ°å°¾ã€‚æ‰€ä»¥ç°åœ¨çš„å¾ˆå¤šç»“æ„è¿˜æ˜¯ç”¨ Bloom Filter.</p><hr><p>MaSM: Efficient Online Updates in Data Warehouses æå‡ºäº† warehouse ç›¸å…³çš„ WaSM</p><p><img src="https://image.mwish.me/blog-image/DDA34F12-12AA-4A5B-A61A-D6F7FF7463A4.png" alt="DDA34F12-12AA-4A5B-A61A-D6F7FF7463A4"></p><p>è¿™é‡Œç›¸å½“äºç»´æŠ¤ä¸€ä¸ªå†™ç»“æ„ï¼Œç„¶å main data æ”¾åœ¨æ»¡çš„ HDD ä¸Šï¼Œåšè¯»ç»“æ„ã€‚Buffer åš tiered compactionï¼Œæœ€åä¸¢åˆ°  main ä¸Šã€‚</p><hr><p>SSD æ”¯æŒå¾ˆå¿«çš„ random read, æ‰€ä»¥ï¼Œåˆ†ç¦» key-value æˆäº†æ”¹å–„å†™æ€§èƒ½çš„å¥½åŠæ³•ã€‚WiscKey å°±æ˜¯è¿™ä¹ˆåšçš„ã€‚</p><p><img src="https://image.mwish.me/blog-image/9A4D85C2-28F8-4D8E-81DD-F796644282C1.png" alt="9A4D85C2-28F8-4D8E-81DD-F796644282C1"></p><p>åœ¨ WiscKey ä¸­ï¼ŒLSM-Tree åªç»´æŠ¤äº† <code>&lt;key, ç´¢å¼•&gt;</code>, value è¢« append åˆ°å¦å¤–çš„åœ°æ–¹ã€‚</p><p>WiscKey ä¼šæœ‰ä¸“é—¨çš„ä»»åŠ¡æ¥ GC, å®ƒä¼šèµ°ä¸‰æ­¥ï¼š</p><ol><li>ä» WAL å°¾éƒ¨å¼€å§‹ï¼ŒæŸ¥çœ‹è¿™ä¸ª entry å­˜ä¸å­˜åœ¨</li><li>å†™ valid entries</li><li>ç§»é™¤æ‰å°¾éƒ¨çš„æ•°æ®</li></ol><blockquote><p>In WiscKey, garbage-collection is performed in three steps. First, WiscKey scans the log tail and validates each entry by performing point lookups against the LSM-tree to find out whether the location of each key has changed or not. Second, valid entries, whose locations have not changed, are then appended to the log and their locations are updated in the LSM-tree as well. Finally, the log tail is truncated to reclaim the storage space.</p></blockquote><p>è¿™ä¸ª GC å·²ç»æˆä¸ºäº†æ–°çš„ç“¶é¢ˆã€‚è€Œ HashKV é€šè¿‡æ·»åŠ äº†ä¸€å±‚ hash partition, æ¥å‡å°äº†è¿™æ ·çš„å¼€é”€ã€‚</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>LSM-based Storage Techniques: A Survey</title>
      <link href="/2021/04/21/LSM-based-Storage-Techniques-A-Survey-Part1/"/>
      <url>/2021/04/21/LSM-based-Storage-Techniques-A-Survey-Part1/</url>
      
        <content type="html"><![CDATA[<p>å¦‚ä»Šï¼ŒLSM-Tree æ­£åœ¨æ¸æ¸è¢«å¤§ä¼—æ‰€æ¥å—ã€‚æˆ–è®¸æ˜¯ä» BigTable å¼€å§‹ï¼ŒNoSQL çš„å­˜å‚¨å¼•æ“ä» DB æ•™ç§‘ä¹¦ä¸Šå ä¸€å¤§èŠ‚çš„ B+Treeï¼Œæ…¢æ…¢è½¬å‘äº† LSM-Treeã€‚BigTable, Dynamo, HBase, Cassandra, LevelDB, RocksDB å’Œ AsterixDB éƒ½ä½¿ç”¨äº† LSMTree ä½œä¸ºå­˜å‚¨å¼•æ“ã€‚</p><p>è¿™ç¯‡è®ºæ–‡ç®€å•ä»‹ç»äº† LSM-Treeï¼Œç„¶åå¯¹ è¯»/å†™/ç©ºé—´ç›¸å…³çš„å†…å®¹ï¼Œå¯¹åŸå§‹è®ºæ–‡çš„ LSMTree åšäº†åˆ†æã€‚åŒæ—¶ä»‹ç»äº† LSM-Tree ç›¸å…³çš„çš„ä¼˜åŒ–ã€‚</p><p>LSM-Tree è®¾æƒ³æ˜¯ï¼ŒæŠŠæ‰€æœ‰çš„ã€å¾ˆå¯èƒ½æ˜¯ <em>éšæœºå†™</em> çš„å†™å…¥å˜æ›´å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼Œç„¶åè½¬åŒ–æˆé¡ºåºå†™ flush åˆ°ç£ç›˜ä¸Šã€‚LSM-Tree æœ‰ä¸‹åˆ—ä¼˜ç‚¹ï¼š</p><ol><li>ä¼˜ç§€çš„å†™æ€§èƒ½</li><li>ä¸ä¿—çš„ç©ºé—´åˆ©ç”¨ç‡</li><li>æ¯”è¾ƒå®¹æ˜“å®ç°çš„ concurrency control å’Œ recovery ï¼ˆè¿™åœ¨ B-Tree ä¸­æ¯”è¾ƒå¤æ‚ï¼Œè®¾è®¡ btree concurrency controlï¼Œç”šè‡³å¯èƒ½æŠŠäº‹åŠ¡ç›¸å…³çš„ä¿¡æ¯åµŒå…¥æ•´ä¸ª Btreeï¼‰</li></ol><p>LSM-Tree ç›®å‰æœ‰å„ç§ä¿®æ”¹ï¼Œå¯ä»¥é€‚åº”å„ç§ workloadï¼Œæ¯”å¦‚ RocksDBï¼Œåœ¨å®ƒçš„ FAST21 è®ºæ–‡ä¸­æ¶‰åŠï¼š</p><blockquote><p> real-time data processing , graph processing, stream processing, and OLTP workloads.</p></blockquote><h2 id="LSM-Tree-Basics"><a href="#LSM-Tree-Basics" class="headerlink" title="LSM-Tree Basics"></a>LSM-Tree Basics</h2><p><img src="https://image.mwish.me/blog-image/C272EA0D-4077-4696-BE9D-F09734F2C5A3.png" alt="C272EA0D-4077-4696-BE9D-F09734F2C5A3"></p><p>ç´¢å¼•ç»“æ„æœ‰ä¸¤ç§æ›´æ–°æ–¹å¼ï¼š</p><ol><li>In-place update: å°±åœ°æ›´æ–°ï¼Œå¯¹å†™å…¥ä¸æ˜¯å¾ˆå‹å¥½ï¼Œé€šå¸¸å¯èƒ½åªä¿æŒéœ€è¦çš„ç‰ˆæœ¬(è®ºæ–‡é‡Œè¯´æœ€æ–°çš„ç‰ˆæœ¬ï¼Œä¸è¿‡æˆ‘æ„Ÿè§‰å®é™…ä¸Šæ›´å¤šæ˜¯â€œéœ€è¦çš„ç‰ˆæœ¬â€)ï¼Œå¯¹è¯»å’Œé€šå¸¸æ¯”è¾ƒå‹å¥½ã€‚</li><li>Out-of-place update: å¯¹å†™å…¥æ¯”è¾ƒå‹å¥½ã€‚</li></ol><p>1976 å¹´æå‡ºçš„ <code>Different files</code> æ˜¯ä¸€ä¸ªæ¯”è¾ƒæ—©æœŸçš„ out-of-space æ›´æ–°ï¼Œç»´æŠ¤äº†ä¸€ä¸ª <code>diff file</code> å’Œä¸€ä¸ª <code>main file</code>ï¼Œè€Œ pg ä¹Ÿä¼šæŠŠå†™éƒ½è®°å½•åˆ°ä¸€ä¸ª sequnce-log é‡Œé¢ï¼Œç”± <code>vacuum cleaner</code> è¿›è¡Œ GCã€‚ç±»ä¼¼çš„æ€è·¯ä¹Ÿè¢«åˆ©ç”¨åˆ°äº† LFS æ–‡ä»¶ç³»ç»Ÿä¸Šã€‚</p><p>ä»¥ä¸Šç»“æ„å¤§æ¦‚æ˜¯ç»´æŠ¤ log/ç»´æŠ¤ delta å’Œ main, ä»–ä»¬çš„é—®é¢˜æ˜¯ï¼š</p><ol><li>low query performance: query éœ€è¦æ ¹æ®ä¹‹å‰æ‰€æœ‰çš„ log æ¥åšå‡ºå†³ç­–</li><li>low space utilization: ä¸éœ€è¦çš„å†…å®¹ (obsolete records) æ²¡æœ‰è¢«åˆ é™¤ï¼Œå¯¼è‡´ä¸å°çš„ç©ºé—´æ”¾å¤§ã€‚</li></ol><p><img src="https://image.mwish.me/blog-image/A5D820DF-48C2-40D1-AD32-15FE3C6B228E.png" alt="A5D820DF-48C2-40D1-AD32-15FE3C6B228E"></p><p>æœ€æ—©çš„ LSM-Tree åœ¨ 1996 å¹´æå‡ºï¼Œå¦‚ä¸Šå›¾ã€‚å®ƒæä¾›äº†å¾ˆé«˜çš„å†™æ€§èƒ½ä¸ä¸å·®çš„è¯»æ€§èƒ½ã€‚</p><p>LSM-Tree æœ‰å¤šä¸ª componentsï¼Œ$C<em>0$ é©»ç•™åœ¨å†…å­˜ä¸­ï¼Œå…¶ä½™éƒ¨åˆ†åœ¨ç£ç›˜ä¸Šã€‚$C_i$ çŠ¶æ€æ˜¯ full çš„æ—¶å€™ï¼Œä¼šæœ‰ä¸€ä¸ª rolling merge è¿›ç¨‹ï¼ŒæŠŠ $C_i$ çš„ leaf åˆ·åˆ° $C</em>{i + 1}$ ä¸­ ã€‚è¿™ä¸ªæœ‰ä¸€ç‚¹ç‚¹ç±»ä¼¼ LevelDB çš„ leveling mergeï¼Œä¸è¿‡ï¼š</p><blockquote><p>However, as we shall see later, the originally proposed rolling merge process is not used by to- dayâ€™s LSM-based storage systems due to its implementation complexity. </p></blockquote><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¯¹äº $T<em>i = | C</em>{i + 1} | / | C_i|$ è€Œè¨€ï¼Œä¿æŒä¸€æ ·çš„æ¯”ä¾‹ï¼Œä¼šä½¿å¾— LSM-Tree å†™æ€§èƒ½æœ‰æ‰€ä¼˜åŒ–ã€‚</p><p>å·®ä¸å¤šåŒä¸€ä¸ªæ—¶å€™ï¼Œ<em>Jagadish et al.</em> æå‡ºäº†ä¸€ä¸ªå¤šå±‚çš„ç»“æ„ï¼Œå½“ L å±‚æ»¡çš„æ—¶å€™ï¼Œä¼šæŠŠæœ¬å±‚å…¨éƒ¨å†…å®¹ä¸‹åˆ·åˆ° L + 1 å±‚ã€‚åœ¨å¦‚ä»Šçš„ LSM-Tree ä¸­ï¼Œè¿™ç§è¡Œä¸ºè¢«ç§°ä¸º tiering merge policyï¼Œå³ tiered compactionã€‚</p><h3 id="ä»Šæ—¥çš„-LSM-Tree"><a href="#ä»Šæ—¥çš„-LSM-Tree" class="headerlink" title="ä»Šæ—¥çš„ LSM-Tree"></a>ä»Šæ—¥çš„ LSM-Tree</h3><p>ç›®å‰çš„ LSM-Tree å†™å…¥çš„æ—¶å€™ï¼Œä¼šå†™ä¸€æ¡è®°å½•ï¼Œåˆ é™¤çš„æ—¶å€™ï¼Œæ ‡å¿—ä¸€ä¸ª tombstone ï¼ˆç±»ä¼¼ leveldb çš„ typeï¼‰ã€‚ä»Šå¤©çš„ LSM-Treee ä¼šåˆ©ç”¨ä¸å¯å˜çš„ç»“æ„ï¼Œæ¥ç®€åŒ– concurrency control å’Œ recoveryï¼šmerge çš„æ—¶å€™ï¼ŒåŸæ¥çš„å†…å®¹ä¸ä¼šå˜æ›´ï¼Œè¿™ä¸ä¹‹å‰æè¿‡çš„ rolling merge æ˜¯ä¸åŒçš„ã€‚</p><p>åœ¨å½“ä»Š LSM-Tree å®ç°ä¸­ï¼Œå†…å­˜ç»“æ„é€šå¸¸ä½¿ç”¨å¹¶å‘çš„æ•°æ®ç»“æ„ï¼Œæ¯”å¦‚ SkipList(è¿™ç§ç»“æ„æ¯”è¾ƒå®¹æ˜“å®ç° concurrency ordered map) æˆ–è€… B+Tree. åœ¨ç£ç›˜çš„ç»“æ„åˆ™ä½¿ç”¨ SSTable æˆ–è€… B+Treeã€‚è¿™é‡Œä»‹ç»ä¸€ä¸‹ SSTableï¼Œå®ƒåŒ…å«å¤šä¸ª data block å’Œä¸€ä¸ª index block, index block åŒ…å«äº† range çš„å…ƒä¿¡æ¯å’Œ data block çš„ä¿¡æ¯ã€‚(å¯è§ BigTable è®ºæ–‡)ã€‚</p><p>å¯¹äº LSM-Tree çš„æŸ¥è¯¢æœ‰ä¸¤ç§ï¼š<em>point lookup query</em> å’Œ <em>range query</em> ï¼Œå‰è€…ä»å†™å…¥æ—¶é—´çš„ æ–°-æ—§ï¼Œä¸€ä¸ªä¸ªç»“æ„æ‰¾ï¼Œç›´åˆ°æ‰¾åˆ°å¯¹åº”çš„å†…å®¹æˆ–è€… miss, range query åˆ™éœ€è¦ä¸€ä¸ªç±»ä¼¼ priority queue çš„å†…å®¹ï¼Œæ¥åå‡ºå¯¹åº”çš„ keyã€‚ä»¥ä¸Šå¯è§ï¼Œå¯¹äºå†™å…¥å¢åŠ  â€”&gt; ç£ç›˜ç»“æ„å˜å¤§ã€å±‚æ•°å˜å¤šï¼Œè¿™é‡ŒæŸ¥æ‰¾çš„æ€§èƒ½æ˜¯ä¼šä¸‹é™çš„ã€‚Compaction ä¼šä»¥å†™æ¥ä¼˜åŒ–è¯»å’Œç©ºé—´æ”¾å¤§ï¼Œç›®å‰æœ‰ä¸¤ç§å¸¸è§çš„ Compaction:</p><ol><li>tiered compaction</li><li>leveled compaction</li></ol><p><img src="https://image.mwish.me/blog-image/39BF2B48-BCF3-4DD1-9A39-C0FB3D042FEF.png" alt="39BF2B48-BCF3-4DD1-9A39-C0FB3D042FEF"></p><p>åœ¨ä»‹ç» compaction ä¹‹å‰ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆä»‹ç»ä¸€ä¸‹ sorted run: æ¯ä¸€å±‚ä¸­ï¼Œå•ä¸ªé€»è¾‘æœ‰åºä¸”ä¸ä¸å…¶ä»–é‡å¤çš„ç»“æ„ï¼Œæ¯”å¦‚ <code>0-100</code>, ä¼šè¢«è§†ä½œä¸€ä¸ª sorted runï¼Œè¿™ç¯‡è®ºæ–‡çš„ç”¨è¯æ˜¯ componentã€‚</p><p>Leveling merge policy ä¼šä» <code>i</code> å±‚å•ä¸ª sorted run ä¸­å‘ <code>i + 1</code> å±‚åˆå¹¶ï¼Œæˆä¸º 1 ä¸ª sorted run. åœ¨ i å±‚çš„ key å¹³å‡è¦è¢« compaction å¤šæ¬¡ï¼Œæ‰ä¼š compaction åˆ°ä¸‹ä¸€å±‚ã€‚</p><p>tiered compaction åˆ™å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œæ¯ä¸€å±‚ä¼šæœ‰å¯èƒ½ä¸æ­¢ä¸€ä¸ª sorted run, ä½†åªä¼šåˆå¹¶ä¸€æ¬¡ï¼š</p><p><img src="https://image.mwish.me/blog-image/compaction-1.png" alt="compaction-1"></p><p>ç®€å•çš„è¯´ï¼Œleveled compaction å¯¹è¯»å’Œç©ºé—´æ”¾å¤§æœ‰å¥½å¤„ï¼Œtiered compaction å†™æ”¾å¤§æ¯”è¾ƒå°‘</p><h3 id="å¸¸è§ä¼˜åŒ–"><a href="#å¸¸è§ä¼˜åŒ–" class="headerlink" title="å¸¸è§ä¼˜åŒ–"></a>å¸¸è§ä¼˜åŒ–</h3><h4 id="ç”¨-bloom-filter-ä¼˜åŒ–è¯»"><a href="#ç”¨-bloom-filter-ä¼˜åŒ–è¯»" class="headerlink" title="ç”¨ bloom filter ä¼˜åŒ–è¯»"></a>ç”¨ bloom filter ä¼˜åŒ–è¯»</h4><p>BF ä¼˜åŒ–è¯»æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„ç­–ç•¥ï¼Œè¿™é‡Œå°±ä¸å†ä»‹ç» BF äº†ï¼Œä½†åŒæ—¶ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåˆå¹¶çš„æ—¶å€™å¯èƒ½è¦é‡æ–°è®¡ç®— BFï¼Œå› ä¸ºå¯èƒ½æœ‰äº› tombstone çš„æ•°æ®ï¼Œåˆå¹¶å°±ç»™ä½ ä¸è¦äº†ï¼Œæ‰€ä»¥ BF è¿™é‡Œæœ‰é—®é¢˜ã€‚</p><p>è¿™é‡Œ Bloom Filter å¾ˆå¤šæ—¶å€™åªéœ€è¦å¯¹åº”åˆ°ç£ç›˜ä¸Šï¼Œæ‰€ä»¥ç»å¸¸æ˜¯é™æ€çš„ï¼ˆå³ä¸éœ€è¦é¢„å…ˆçŸ¥é“ key çš„æ•°é‡ï¼Œæ¥å¢æ’åˆ æ”¹ï¼‰ã€‚</p><p>æ­¤å¤–ï¼Œä¹Ÿæœ‰ç”¨ Cuckoo Filter ä¹‹ç±»çš„æ–¹å¼ï¼Œæ¥åœ¨å¯¹åº”çš„éœ€æ±‚ä¸‹æ›¿æ¢ BF.</p><h3 id="partition"><a href="#partition" class="headerlink" title="partition"></a>partition</h3><p>ä¸Šé¢çš„ $C_i$ ä¸ä»…æ˜¯é€»è¾‘çš„ä¸€å±‚ï¼Œä¹Ÿæ˜¯ç‰©ç†çš„ä¸€æ•´å—ç»“æ„ã€‚åŸå§‹çš„ LSM-Tree rolling merge åªä¼šæŠŠä¸€éƒ¨åˆ†å¶å­ç»“ç‚¹ merge åˆ°ä¸€å±‚ã€‚</p><p><img src="https://image.mwish.me/blog-image/4ED4867F-2630-407D-9753-555D24D0D5C2.png" alt="4ED4867F-2630-407D-9753-555D24D0D5C2"></p><p>è¿™é‡Œï¼ŒLSM-Tree å¯ä»¥æŠŠæ¯ä¸€å±‚ sorted run åˆ†ä¸ºå¤šä¸ª SSTable, ä¾‹å¦‚ LevelDB é»˜è®¤ä½¿ç”¨ 2M å·¦å³çš„ SSTable.</p><p>è¿™æ ·çš„æ“ä½œæœ‰ä¸‹åˆ—çš„å¥½å¤„ï¼š</p><blockquote><p>First, partitioning breaks a large com- ponent merge operation into multiple smaller ones, bound- ing the processing time of each merge operation as well as the temporary disk space needed to create new components. Moreover, partitioning can optimize for workloads with se- quentially created keys or skewed updates by only merging components with overlapping key ranges</p></blockquote><p>ä¸Šè¿°æ˜¯ Leveled compaction çš„ partitionï¼Œtiered compaction éœ€è¦ä¸€åˆ«çš„æ–¹å¼è®¾è®¡ï¼š</p><p>è¿™é‡Œæä¾›äº†ä¸€äº›æ–¹æ¡ˆï¼š</p><p><img src="https://image.mwish.me/blog-image/F3B0E1FA-89CD-4FFF-8D3A-0A33D1E0A811.png" alt="F3B0E1FA-89CD-4FFF-8D3A-0A33D1E0A811"></p><p>ï¼ˆæˆ‘æ€»è§‰å¾—å¾ˆç¼åˆï¼‰</p><h3 id="Concurrency-Control-and-Recovery"><a href="#Concurrency-Control-and-Recovery" class="headerlink" title="Concurrency Control and Recovery"></a>Concurrency Control and Recovery</h3><p>è™½ç„¶æœ‰å¾ˆå¤šä¸å¯å˜ç»“æ„ï¼Œä½†æ˜¯å¤„ç†ä¸Šè¿°é—®é¢˜ï¼Œä¹Ÿè¦ä¸ compaction çš„æµäº¤äº’åœ¨ä¸€èµ·ã€‚</p><p>å†…å­˜ä¸­çš„ç»“æ„å¯ä»¥å†™åˆ°ä¸€ä¸ª no-steal çš„ buffer é‡Œï¼Œç„¶ååªéœ€è¦å†™ WAL (å½“ä½œ redo log), å°±å¯ä»¥ä¿è¯æ¢å¤ã€‚</p><p><img src="https://image.mwish.me/blog-image/922cb3ed1d64d4f5e3a12b95cdf5d25ff24.jpg" alt="922cb3ed1d64d4f5e3a12b95cdf5d25ff24"></p><p>å¯¹äºç£ç›˜ç»“æ„è€Œè¨€ï¼Œå¯ä»¥å®ç°æˆ Multi-version çš„ï¼Œè¿™é‡Œå¯¹åº”çš„ componentï¼ˆåŒ…æ‹¬å†…å­˜ç»“æ„å’Œ SSTï¼‰å¯ä»¥å®ç°ä¸€ä¸ª rc, å½“å¯ä»¥åˆ é™¤ä¸”æ²¡æœ‰è¯»è€…çš„æ—¶å€™ï¼Œå¯ä»¥æŠŠæ•°æ®æ¸…é™¤ã€‚</p><p>ä¸Šè¿°å†…å®¹æ˜¯ concurrency control. å¯¹äº recover è€Œè¨€ï¼Œæœ‰ä¸¤ç§æ–¹å¼ï¼š</p><ul><li>ç±»ä¼¼ boltdb, å¦‚æœæ¯å±‚åªæœ‰ä¸€ä¸ª partition, æ¯å±‚é€‰å– id æœ€å¤§çš„ç‰ˆæœ¬æˆ–è€… wall-clock æœ€å¤§çš„æ•°æ®</li><li>ç±»ä¼¼ leveldb, ç»´æŠ¤ä¸€ä¸ª manifest å…ƒä¿¡æ¯åˆ—è¡¨ã€‚</li></ul><h3 id="Cost-analysis-and-RUM-conjecture"><a href="#Cost-analysis-and-RUM-conjecture" class="headerlink" title="Cost analysis and RUM conjecture"></a>Cost analysis and RUM conjecture</h3><p><img src="https://image.mwish.me/blog-image/AB77AD96-5AB8-4C6B-BA76-5D5015E949B2.png" alt="AB77AD96-5AB8-4C6B-BA76-5D5015E949B2"></p><p>LSM-Tree æœ‰ç€å¦‚ä¸Šçš„åŸºæœ¬çš„å¤æ‚åº¦ï¼Œæ³¨æ„ï¼š</p><ol><li>å†™å…¥æ˜¯è€ƒè™‘æ¯å±‚çš„ compaction æ¬¡æ•°ï¼Œæ¥è®¡ç®—å‡ºæ¥çš„</li><li>ç‚¹æŸ¥è¿™é‡Œæ˜¯è€ƒè™‘äº† Bloom filter</li></ol><p>è¿™é‡Œæ„Ÿå…´è¶£è¿˜å¯ä»¥çœ‹çœ‹ RUMï¼š</p><p><img src="https://image.mwish.me/blog-image/3-Figure1-1.png" alt="3-Figure1-1"></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Notes on C++ Copy Elision</title>
      <link href="/2021/04/12/Notes-on-C-Copy-Elision/"/>
      <url>/2021/04/12/Notes-on-C-Copy-Elision/</url>
      
        <content type="html"><![CDATA[<blockquote><p>Omits copy and move (since C++11) constructors, resulting in zero-copy pass-by-value semantics.</p></blockquote><p>ä»¥ä¸Šæ˜¯ copy elision çš„è§£é‡Šã€‚</p><p>ä¸‹é¢åˆ—ä¸¾ä¸€äº›ä»£ç ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">get_F1</span><span class="params">(S&amp; s)</span> </span>&#123;</span><br><span class="line">    s.i = <span class="number">8</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">S* <span class="title">get_F2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    S* ps = <span class="keyword">new</span> S; <span class="comment">// 2. default ctor 2</span></span><br><span class="line">    ps-&gt;i = <span class="number">8</span>;</span><br><span class="line">    <span class="keyword">return</span> ps;     <span class="comment">// should be freed later</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å’Œ</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">T <span class="title">get_object</span><span class="params">(args...)</span> </span>&#123;</span><br><span class="line">T t;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="keyword">return</span> std::<span class="built_in">move</span>(t);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è‡³å°‘ä¸€èˆ¬æˆ‘ä»¬è¢«æ•™è‚²è¿‡ï¼Œä¸è¦ <code>return std::move(t)</code>, åŒæ—¶æˆ‘ä»¬çŸ¥é“ï¼Œè¿”å›æŸä¸ª <code>S</code> ç±»å‹çš„é‡ï¼Œå¯èƒ½ä¼šæœ‰ Copy Elision çš„ä¼˜åŒ–ï¼Œå¸®åŠ©æˆ‘ä»¬å°±åœ°åœ¨å¤–éƒ¨æ„é€ è¿™ä¸ªå€¼ (<code>constructing the automatic object directly into the exception object.</code>)</p><h3 id="Value-Category-and-Guaranteed-Copy-Elision"><a href="#Value-Category-and-Guaranteed-Copy-Elision" class="headerlink" title="Value Category and Guaranteed Copy Elision"></a>Value Category and Guaranteed Copy Elision</h3><p>C++11 å®šä¹‰äº† Value Categories. C++ ä¸­ï¼Œæ¯ä¸ª expression éƒ½æœ‰ä¸€ä¸ª value category</p><p>æˆ‘ä»¬è€ƒè™‘ä»…å®šä¹‰ <code>lvalue</code> å’Œ <code>rvalue</code>. å­—é¢é‡ <code>2</code> è‚¯å®šæ˜¯ <code>rvalue</code>, è€Œ <code>lvalue</code> è¢«è§†ä½œ <code>localizable value</code>, é‚£ä¹ˆï¼Œç®€å•å¥å‡ ä¸ªä¾‹å­:</p><ul><li><code>v</code> æ˜¯ä¸€ä¸ª <code>std::vector</code>, <code>v.front()</code> æ˜¯ä¸€ä¸ª lvalue</li><li><code>*p</code> æ˜¯ä¸€ä¸ª lvalue</li><li>ç”šè‡³ä¸€ä¸ªå­—ç¬¦ä¸²å­—é¢é‡éƒ½æ˜¯ä¸€ä¸ªä¸å¯æ›´æ”¹å€¼çš„ lvalue.</li></ul><p>è€Œ <code>nullptr</code>, <code>&#39;a&#39;</code>, <code>7</code>  è¿™äº›è¢«è§†ä½œ <code>rvalue</code>. </p><p><code>lvalue</code> å¯ä»¥è¢«è½¬æˆ <code>rvalue</code> ï¼Œæ‰€ä»¥ <code>y = x</code> æ˜¯å¯ä»¥çš„ï¼Œå½“ç„¶ <code>7 = 8</code> å°±ä¸è¡Œå•¦ã€‚</p><p>ä¸Šé¢åªæ˜¯ä¸€ä¸ªéå¸¸æ¨¡ç³Šçš„è¯´æ˜ï¼ŒC++11 å®šä¹‰äº†ä¸‹é¢çš„å†…å®¹ï¼š</p><p><img src="https://image.mwish.me/blog-image/BE725B3AB0EF7D38B52D06B194606D7D.png" alt="BE725B3AB0EF7D38B52D06B194606D7D"></p><p>è€Œ <a href="http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2015/p0135r0.html">Guaranteed copy elision through simplified value categories</a> å®šä¹‰äº†æ–°çš„ value category, éšååˆäº†å¦‚ä¸‹å˜æ›´ï¼š<a href="http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2016/p0135r1.html">http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2016/p0135r1.html</a></p><p>è¿™æ„å‘³ç€ï¼Œå¦‚æœä½ æœ‰ä¸€ä¸ª</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">T <span class="title">f</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">T</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">T x = <span class="built_in">f</span>(); <span class="comment">// 1</span></span><br><span class="line">T x2 = <span class="built_in">T</span>(<span class="built_in">T</span>(<span class="built_in">f</span>())); <span class="comment">// 2</span></span><br></pre></td></tr></table></figure><p>è¿™é‡Œéœ€è¦æ ¹æ® <code>f()</code> çš„ä¸Šä¸‹æ–‡æ¨æ–­ï¼Œ<code>T()</code> æ˜¯ä¸ª prvalue, é‚£ä¹ˆ C++ 17 ä¼šå¼ºåˆ¶ 1 ä»…è°ƒç”¨ä¸€æ¬¡  T çš„æ„é€ å‡½æ•°</p><p>ç„¶åï¼Œå†çœ‹ 2:</p><blockquote><p><strong>If the initializer expression is a prvalue and the cv-unqualified version of the source type is the same class as the class of the destination, the initializer expression is used to initialize the destination object. [</strong> <em>Example**</em>:<strong> <code>T x = T(T(T()));</code> </strong>calls the<strong> <code>T</code> </strong>default constructor to initialize<strong> <code>x</code></strong>. ]**</p></blockquote><p>æ‰€ä»¥è¿™é‡Œæ„é€ å‡½æ•°ä¹Ÿåªä¼šèµ°ä¸€æ¬¡ã€‚</p><p><em>ä»¥ä¸Šå†…å®¹åœ¨ C++17 ä¹‹åæ˜¯å¼ºåˆ¶çš„ã€‚</em></p><h3 id="NRVO"><a href="#NRVO" class="headerlink" title="NRVO"></a>NRVO</h3><p>æˆ‘ä»¬å†è€ƒè™‘ NRVOï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">T <span class="title">get_object</span><span class="params">(args...)</span> </span>&#123;</span><br><span class="line">T t;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="keyword">return</span> std::<span class="built_in">move</span>(t);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬è´´ä¸¤ä¸ªå›¾ï¼š</p><p><img src="https://image.mwish.me/blog-image/CFF34BB9BC32A9B1EA0A3C8660C537B0.png" alt="CFF34BB9BC32A9B1EA0A3C8660C537B0"></p><p><img src="https://image.mwish.me/blog-image/628BAC04ED66DC742323A690115292E2.png" alt="628BAC04ED66DC742323A690115292E2"></p><p>è¿™é‡Œæè¿°äº† NRVO å’Œ NRVO å¤±è´¥çš„æƒ…å†µã€‚å¯ä»¥çœ‹åˆ°ï¼Œå¯¹äºä¸€ä¸ª <code>HardToCopyAndEasyToMove</code> çš„ç»“æ„ï¼Œå³ä½¿ä¸ <code>return std::move(..)</code>, ç¼–è¯‘å™¨ä¹Ÿèƒ½æ­£ç¡®çš„ä¼˜åŒ–</p><h3 id="é‡ä¸Š-scoped-guard"><a href="#é‡ä¸Š-scoped-guard" class="headerlink" title="é‡ä¸Š scoped_guard"></a>é‡ä¸Š scoped_guard</h3><p>å¦‚æœä½ æƒ³åœ¨å‚æ•°è¿”å›ä¹‹å‰ï¼Œåšä¸€äº›æ£€æŸ¥ï¼Œåœ¨ <code>go</code> é‡Œé¢ï¼Œä½ æ²¡å‡†è¿™ä¹ˆå†™äº†ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> s Status <span class="comment">// when init s.ok() == true</span></span><br><span class="line"><span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">  <span class="keyword">if</span> s.ok() &#123;</span><br><span class="line">    ...</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="keyword">return</span> s</span><br></pre></td></tr></table></figure><p>ä¸è°ˆä»£ç å¥½ä¸å¥½ï¼Œè¿™é‡Œé€»è¾‘ä¸Šæ˜¯å¯ä»¥çš„ï¼Œå› ä¸º Go ä¸‡ç‰©éƒ½æ˜¯ Copyã€‚</p><p>å½“ä½ æƒ³åœ¨ C++ é‡Œé¢å®ç°è¿™äº›ä¸œè¥¿çš„æ—¶å€™ï¼Œæ¯”å¦‚ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Status s; <span class="comment">// when moved, it will be ok</span></span><br><span class="line">std::scoped_guard defer_fn; <span class="comment">// check s</span></span><br><span class="line">...</span><br><span class="line">  </span><br><span class="line"><span class="keyword">return</span> s;</span><br></pre></td></tr></table></figure><p>å¦‚æœè¿™é‡Œèµ°äº† move, é‚£æˆ‘ä»¬æœ‰ evaluation order: <a href="https://en.cppreference.com/w/cpp/language/eval_order">https://en.cppreference.com/w/cpp/language/eval_order</a></p><p><img src="https://image.mwish.me/blog-image/BA42F5DB-AE8A-49C9-8FF4-946D1A2BCB2B.png" alt="BA42F5DB-AE8A-49C9-8FF4-946D1A2BCB2B"></p><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œå¯èƒ½å…ˆå‘ç”Ÿ move, å†æ¥ check s, move ä¹‹å s å¯èƒ½å°±ä¸èƒ½æ»¡è¶³ç”¨æˆ·çš„é¢„æœŸäº†ã€‚</p><h3 id="æ„Ÿæƒ³"><a href="#æ„Ÿæƒ³" class="headerlink" title="æ„Ÿæƒ³"></a>æ„Ÿæƒ³</h3><p>å…¶å®æˆ‘ä¹Ÿä¸æ‡‚ C++ï¼Œæœ‰ä»€ä¹ˆåœ°æ–¹å†™é”™äº†ï¼Œè¯·ç«‹åˆ»é€šçŸ¥æˆ‘ï¼Œæˆ‘ä¼šç¬¬ä¸€æ—¶é—´æŸ¥è¯å’Œæ”¹æ­£ã€‚</p><p>æŸ¥é˜…çš„æ—¶å€™ï¼Œè™½ç„¶æ„Ÿè§‰ C++ è§„åˆ™å¾ˆå¤æ‚ï¼Œä½†æ˜¯å¤§éƒ¨åˆ†æ—¶å€™ï¼Œå³ä½¿ä¸ç†Ÿæ‚‰è¿™äº›ç»†èŠ‚ï¼Œæ­£å¸¸å†™ä»£ç ä¹Ÿèƒ½ä¿è¯é«˜æ•ˆç‡ã€‚æ­£å¦‚æ²¡æœ‰å—è¿‡æ³•å¾‹çš„æ­£å¸¸äººï¼Œä¹Ÿå¾ˆå°‘ä¼šçŠ¯æ³•ã€‚</p><p>å¥½äº†ï¼Œæå®Œäº†ï¼Œæ¥ç€æ‰“é€†è½¬è£åˆ¤äº†ã€‚</p><h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><ul><li><a href="https://zh.cppreference.com/w/cpp/language/value_category">value category</a></li><li><a href="https://en.cppreference.com/w/cpp/language/copy_elision">copy elision</a></li><li>Guaranteed copy elision through simplified value categories  <a href="http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2015/p0135r0.html">http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2015/p0135r0.html</a></li><li>C++ Templates 2nd</li></ul>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>LRU, æ›´å¤šçš„ LRU</title>
      <link href="/2021/04/08/LevelDB-utils-LRU/"/>
      <url>/2021/04/08/LevelDB-utils-LRU/</url>
      
        <content type="html"><![CDATA[<p>é¢è¯•çš„æ—¶å€™é¢è¯•å®˜ç»å¸¸ä¼šè®©ä½ æ“ä¸ª LRUï¼Œboost è¿™é‡Œæœ‰ä¸ª case:</p><p><a href="https://www.boost.org/doc/libs/1_67_0/boost/compute/detail/lru_cache.hpp">https://www.boost.org/doc/libs/1_67_0/boost/compute/detail/lru_cache.hpp</a></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// a cache which evicts the least recently used item when it is full</span></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">Key</span>, <span class="keyword">class</span> <span class="title class_">Value</span>&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">lru_cache</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">typedef</span> Key key_type;</span><br><span class="line">    <span class="keyword">typedef</span> Value value_type;</span><br><span class="line">    <span class="keyword">typedef</span> std::list&lt;key_type&gt; list_type;</span><br><span class="line">    <span class="keyword">typedef</span> std::map&lt;</span><br><span class="line">                key_type,</span><br><span class="line">                std::pair&lt;value_type, <span class="keyword">typename</span> list_type::iterator&gt;</span><br><span class="line">            &gt; map_type;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">lru_cache</span>(<span class="type">size_t</span> capacity)</span><br><span class="line">        : <span class="built_in">m_capacity</span>(capacity)</span><br><span class="line">    &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ~<span class="built_in">lru_cache</span>()</span><br><span class="line">    &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">size_t</span> <span class="title">size</span><span class="params">()</span> <span class="type">const</span>ï¼›</span></span><br><span class="line"><span class="function">    <span class="type">size_t</span> <span class="title">capacity</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">empty</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">contains</span><span class="params">(<span class="type">const</span> key_type &amp;key)</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">insert</span><span class="params">(<span class="type">const</span> key_type &amp;key, <span class="type">const</span> value_type &amp;value)</span></span>;</span><br><span class="line">    <span class="function">boost::optional&lt;value_type&gt; <span class="title">get</span><span class="params">(<span class="type">const</span> key_type &amp;key)</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">clear</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">evict</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    map_type m_map;</span><br><span class="line">    list_type m_list;</span><br><span class="line">    <span class="type">size_t</span> m_capacity;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>è¿™ç©æ„çŸ­å°åˆç²¾æ‚:</p><ol><li><code>list_type</code> å­˜å‚¨äº† <code>key</code> çš„ LRU é“¾è¡¨ï¼Œæ’å…¥åœ¨æœ€å‰æ–¹æ’å…¥/æŠŠä¸­é—´æŸä¸ª key ä¸¢åˆ°æœ€å‰é¢</li><li><code>m_map</code> å­˜å‚¨äº† <code>map[key -&gt; (list_iter, value)]</code></li></ol><p>è¿™ä¸ªç›¸å¯¹æ¥è¯´åº”è¯¥æ˜¯å¾ˆå¥½ç†è§£çš„ã€‚ä½†æ˜¯è¿™ç©æ„ä¹Ÿæ©ç›–äº† LRU çš„å¤æ‚æ€§:</p><ol><li>å‡è®¾æˆ‘ä»¬ evict, é‚£ä¹ˆæˆ‘ä»¬è¦é€å‡ºä¸€ä¸ªå…ƒç´ ï¼Œç„¶åæ ¹æ® key æŸ¥ä¸€ä¸‹ <code>m_map</code>ï¼Œcomplexity æ˜¯ O(1) çš„ï¼Œä½†æ˜¯ä»ç„¶éœ€è¦è®¿é—® <code>m_map</code></li><li>å¦‚æœå¹¶å‘çš„è¯ï¼Œhash è‚¯å®šè¦ä¸Šä¸€æŠŠå¤§é”</li></ol><p>å®é™…ä¸Šä¸Šé¢ä¸¤ç‚¹éƒ½æœ‰ä¸€å®šçš„é—®é¢˜ã€‚ç„¶åå¯¹äº LRU çš„è°ƒç”¨è€…ï¼Œè¿˜æœ‰ä¸ªâ€œå†…éƒ¨â€ï¼Œâ€œå¤–éƒ¨â€çš„é—®é¢˜ï¼Œå¯ä»¥å‚è€ƒä¸€ä¸‹ CMU 15-445 Lab-1 çš„æ¥å£ï¼š</p><ul><li>ä½¿ç”¨çš„æ—¶å€™å¯èƒ½ä¼šæŠŠ LRU æŸä¸ªå–å‡ºæ¥ï¼Œä½œä¸ºæ´»è·ƒçš„ã€æ­£åœ¨ä½¿ç”¨çš„å¯¹è±¡ï¼Œä½¿ç”¨å®Œä¹‹åå†ä¸¢è¿› LRU é‡Œå¤´</li></ul><h2 id="LevelDB-LRU"><a href="#LevelDB-LRU" class="headerlink" title="LevelDB LRU"></a>LevelDB LRU</h2><p>LevelDB å®ç°äº†ä¾µå…¥å¼çš„ LRU, åŒæ—¶åˆ†ä¸ºäº†å¤šä¸ª shardã€‚è¿™åˆ†åˆ«é’ˆå¯¹äº†æˆ‘ä»¬ä¸Šé¢è¯´çš„å¤æ‚æ€§ (1) å’Œ (2), å…ˆçœ‹çœ‹æ¥å£ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">LEVELDB_EXPORT Cache* <span class="title">NewLRUCache</span><span class="params">(<span class="type">size_t</span> capacity)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">LEVELDB_EXPORT</span> Cache &#123;</span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="built_in">Cache</span>() = <span class="keyword">default</span>;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">Cache</span>(<span class="type">const</span> Cache&amp;) = <span class="keyword">delete</span>;</span><br><span class="line">  Cache&amp; <span class="keyword">operator</span>=(<span class="type">const</span> Cache&amp;) = <span class="keyword">delete</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Destroys all existing entries by calling the &quot;deleter&quot;</span></span><br><span class="line">  <span class="comment">// function that was passed to the constructor.</span></span><br><span class="line">  <span class="keyword">virtual</span> ~<span class="built_in">Cache</span>();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Opaque handle to an entry stored in the cache.</span></span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">Handle</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Insert a mapping from key-&gt;value into the cache and assign it</span></span><br><span class="line">  <span class="comment">// the specified charge against the total cache capacity.</span></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  <span class="comment">// Returns a handle that corresponds to the mapping.  The caller</span></span><br><span class="line">  <span class="comment">// must call this-&gt;Release(handle) when the returned mapping is no</span></span><br><span class="line">  <span class="comment">// longer needed.</span></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  <span class="comment">// When the inserted entry is no longer needed, the key and</span></span><br><span class="line">  <span class="comment">// value will be passed to &quot;deleter&quot;.</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> Handle* <span class="title">Insert</span><span class="params">(<span class="type">const</span> Slice&amp; key, <span class="type">void</span>* value, <span class="type">size_t</span> charge,</span></span></span><br><span class="line"><span class="params"><span class="function">                         <span class="type">void</span> (*deleter)(<span class="type">const</span> Slice&amp; key, <span class="type">void</span>* value))</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// If the cache has no mapping for &quot;key&quot;, returns nullptr.</span></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  <span class="comment">// Else return a handle that corresponds to the mapping.  The caller</span></span><br><span class="line">  <span class="comment">// must call this-&gt;Release(handle) when the returned mapping is no</span></span><br><span class="line">  <span class="comment">// longer needed.</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> Handle* <span class="title">Lookup</span><span class="params">(<span class="type">const</span> Slice&amp; key)</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Release a mapping returned by a previous Lookup().</span></span><br><span class="line">  <span class="comment">// REQUIRES: handle must not have been released yet.</span></span><br><span class="line">  <span class="comment">// REQUIRES: handle must have been returned by a method on *this.</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">Release</span><span class="params">(Handle* handle)</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Return the value encapsulated in a handle returned by a</span></span><br><span class="line">  <span class="comment">// successful Lookup().</span></span><br><span class="line">  <span class="comment">// REQUIRES: handle must not have been released yet.</span></span><br><span class="line">  <span class="comment">// REQUIRES: handle must have been returned by a method on *this.</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="type">void</span>* <span class="title">Value</span><span class="params">(Handle* handle)</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// If the cache contains entry for key, erase it.  Note that the</span></span><br><span class="line">  <span class="comment">// underlying entry will be kept around until all existing handles</span></span><br><span class="line">  <span class="comment">// to it have been released.</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">Erase</span><span class="params">(<span class="type">const</span> Slice&amp; key)</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Return a new numeric id.  May be used by multiple clients who are</span></span><br><span class="line">  <span class="comment">// sharing the same cache to partition the key space.  Typically the</span></span><br><span class="line">  <span class="comment">// client will allocate a new id at startup and prepend the id to</span></span><br><span class="line">  <span class="comment">// its cache keys.</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="type">uint64_t</span> <span class="title">NewId</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Remove all cache entries that are not actively in use.  Memory-constrained</span></span><br><span class="line">  <span class="comment">// applications may wish to call this method to reduce memory usage.</span></span><br><span class="line">  <span class="comment">// Default implementation of Prune() does nothing.  Subclasses are strongly</span></span><br><span class="line">  <span class="comment">// encouraged to override the default implementation.  A future release of</span></span><br><span class="line">  <span class="comment">// leveldb may change Prune() to a pure abstract method.</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">Prune</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Return an estimate of the combined charges of all elements stored in the</span></span><br><span class="line">  <span class="comment">// cache.</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="type">size_t</span> <span class="title">TotalCharge</span><span class="params">()</span> <span class="type">const</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span>:</span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">LRU_Remove</span><span class="params">(Handle* e)</span></span>;</span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">LRU_Append</span><span class="params">(Handle* e)</span></span>;</span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">Unref</span><span class="params">(Handle* e)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">Rep</span>;</span><br><span class="line">  Rep* rep_;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å…ˆåšä¸ªé˜…è¯»ç†è§£ï¼š</p><ol><li><code>struct Handle</code>  æ˜¯ä¸€ä¸ªæ²¡æœ‰å®šä¹‰ä»»ä½•æˆå‘˜çš„ç±»å‹ï¼Œ<code>Cache::Handle*</code> å…¶å®è¢«æˆ‘ä»¬å½“æˆä¸€ä¸ªç‰¹æ®Šçš„åœ°å€å¤„ç†ï¼Œå¯ä»¥å‚è€ƒ <code>LRUHandle</code> çš„å®šä¹‰. å¯ä»¥çœ‹åˆ°ï¼Œç¬¬ä¸€ä¸ªæˆå‘˜æ˜¯ value. æˆ‘ä»¬åœ¨ <code>LRUCache</code> è¿”å›çš„æ—¶å€™ç”¨ <code>reinterpret_cast&lt;Cache::Handle&gt;(lru_hanle_ptr)</code>, ç„¶åå¯¹åº”åœ°å€æœ€å‰é¢å°±æ˜¯ <code>value</code>ã€‚å½“ç„¶è¿™ä¸ªä¹Ÿå¯ä»¥é€šè¿‡ <code>Cache::Value</code> è®¿é—®</li><li><code>Lookup</code> å‘ç”Ÿçš„æ—¶å€™ï¼ŒLRUCache çš„å…ƒç´ ä¼šè¢«æ ‡è®° <code>ref</code>, <code>Release</code> çš„æ—¶å€™ï¼Œä¼šè¢«æ ‡è®°ä¸º <code>Unref</code>. </li><li><code>Insert</code> å¸¦ Deleter è¿™ä¸ªæ¯”è¾ƒæ­£å¸¸ï¼Œcharge ç›¸å¯¹æ¥è¯´ä¸å¥½ç†è§£ä¸€äº›ï¼Œå¯ä»¥å’Œ Shard ä¸€èµ·ç†è§£ï¼Œæ¯ä¸ª shard ä¸æ˜¯æŒ‰<code>Handle</code> ä¸ªæ•°ç®—çš„ï¼Œè€Œæ˜¯æŒ‰ <code>charge</code> ç®—çš„ã€‚ç„¶å block cache (<code>options.block_cache</code> é…ç½®ï¼Œå­˜å‚¨ table ç›¸å…³çš„ content ) é‡Œé¢ï¼Œæ¯ä¸ª <code>block</code> å•ä½æ˜¯ä¸€ä¸ª block çš„ size, TableCache ï¼ˆå¯¹ SST æ–‡ä»¶çš„å¥æŸ„ cacheï¼‰é‡Œé¢ï¼Œcharge å¯¹åº”æ˜¯ 1.</li><li><code>NewID</code> è¿™ä¸ªç©æ„å®é™…ä¸Šå’Œå®ç°çš„é€»è¾‘æœ‰å…³ï¼Œåœ¨ block cache é‡Œï¼Œ<code>key</code> è¢«ç¼–ç æˆ 64bit çš„ cache id (per table) å’Œ 64bit çš„ block åç§»é‡ï¼Œæ‰€ä»¥éœ€è¦æ¯ä¸ª block cache èƒ½ç”Ÿæˆå‡º ä¸€ä¸ª unique id.</li></ol><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">LRUHandle</span> &#123;</span><br><span class="line">  <span class="type">void</span>* value;</span><br><span class="line">  <span class="built_in">void</span> (*deleter)(<span class="type">const</span> Slice&amp;, <span class="type">void</span>* value);</span><br><span class="line">  LRUHandle* next_hash;</span><br><span class="line">  LRUHandle* next;</span><br><span class="line">  LRUHandle* prev;</span><br><span class="line">  <span class="comment">// charge æ˜¯ä¸€ä¸ªç»Ÿè®¡é‡ï¼Œåœ¨ block_cache ä¸­ï¼Œè¿™ä¸ªç»Ÿè®¡é‡æ˜¯ size().</span></span><br><span class="line">  <span class="comment">// åœ¨ TableCache ä¸­ï¼Œè¿™ä¸ªç»Ÿè®¡é‡æ˜¯1.</span></span><br><span class="line">  <span class="comment">// æ³¨ï¼šTableCache å’Œ block ä¸æ˜¯åŒä¸€ä¸ªå¯¹è±¡ã€‚</span></span><br><span class="line">  <span class="type">size_t</span> charge;  <span class="comment">// TODO(opt): Only allow uint32_t?</span></span><br><span class="line">  <span class="type">size_t</span> key_length;</span><br><span class="line">  <span class="type">bool</span> in_cache;     <span class="comment">// Whether entry is in the cache.</span></span><br><span class="line">  <span class="type">uint32_t</span> refs;     <span class="comment">// References, including cache reference, if present.</span></span><br><span class="line">  <span class="type">uint32_t</span> hash;     <span class="comment">// Hash of key(); used for fast sharding and comparisons</span></span><br><span class="line">  <span class="type">char</span> key_data[<span class="number">1</span>];  <span class="comment">// Beginning of key</span></span><br><span class="line"></span><br><span class="line">  <span class="function">Slice <span class="title">key</span><span class="params">()</span> <span class="type">const</span> </span>&#123;</span><br><span class="line">    <span class="comment">// next_ is only equal to this if the LRU handle is the list head of an</span></span><br><span class="line">    <span class="comment">// empty list. List heads never have meaningful keys.</span></span><br><span class="line">    <span class="built_in">assert</span>(next != <span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Slice</span>(key_data, key_length);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬æ¥ç…ç…å…·ä½“çš„ LRUCache ç»“æ„ä½“ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">LRUCache</span> &#123;</span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="built_in">LRUCache</span>();</span><br><span class="line">  ~<span class="built_in">LRUCache</span>();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Separate from constructor so caller can easily make an array of LRUCache</span></span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">SetCapacity</span><span class="params">(<span class="type">size_t</span> capacity)</span> </span>&#123; capacity_ = capacity; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Like Cache methods, but with an extra &quot;hash&quot; parameter.</span></span><br><span class="line">  <span class="function">Cache::Handle* <span class="title">Insert</span><span class="params">(<span class="type">const</span> Slice&amp; key, <span class="type">uint32_t</span> hash, <span class="type">void</span>* value,</span></span></span><br><span class="line"><span class="params"><span class="function">                        <span class="type">size_t</span> charge,</span></span></span><br><span class="line"><span class="params"><span class="function">                        <span class="type">void</span> (*deleter)(<span class="type">const</span> Slice&amp; key, <span class="type">void</span>* value))</span></span>;</span><br><span class="line">  <span class="function">Cache::Handle* <span class="title">Lookup</span><span class="params">(<span class="type">const</span> Slice&amp; key, <span class="type">uint32_t</span> hash)</span></span>;</span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">Release</span><span class="params">(Cache::Handle* handle)</span></span>;</span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">Erase</span><span class="params">(<span class="type">const</span> Slice&amp; key, <span class="type">uint32_t</span> hash)</span></span>;</span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">Prune</span><span class="params">()</span></span>;</span><br><span class="line">  <span class="comment">// charge å±äºç”¨æˆ·é€»è¾‘äº†ã€‚</span></span><br><span class="line">  <span class="function"><span class="type">size_t</span> <span class="title">TotalCharge</span><span class="params">()</span> <span class="type">const</span> </span>&#123;</span><br><span class="line">    <span class="function">MutexLock <span class="title">l</span><span class="params">(&amp;mutex_)</span></span>;</span><br><span class="line">    <span class="keyword">return</span> usage_;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span>:</span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">LRU_Remove</span><span class="params">(LRUHandle* e)</span></span>;</span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">LRU_Append</span><span class="params">(LRUHandle* list, LRUHandle* e)</span></span>;</span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">Ref</span><span class="params">(LRUHandle* e)</span></span>;</span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">Unref</span><span class="params">(LRUHandle* e)</span></span>;</span><br><span class="line">  <span class="function"><span class="type">bool</span> <span class="title">FinishErase</span><span class="params">(LRUHandle* e)</span> <span class="title">EXCLUSIVE_LOCKS_REQUIRED</span><span class="params">(mutex_)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Initialized before use.</span></span><br><span class="line">  <span class="type">size_t</span> capacity_;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// mutex_ protects the following state.</span></span><br><span class="line">  <span class="keyword">mutable</span> port::Mutex mutex_;</span><br><span class="line">  <span class="function"><span class="type">size_t</span> usage_ <span class="title">GUARDED_BY</span><span class="params">(mutex_)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Dummy head of LRU list.</span></span><br><span class="line">  <span class="comment">// lru.prev is newest entry, lru.next is oldest entry.</span></span><br><span class="line">  <span class="comment">// Entries have refs==1 and in_cache==true.</span></span><br><span class="line">  <span class="function">LRUHandle lru_ <span class="title">GUARDED_BY</span><span class="params">(mutex_)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Dummy head of in-use list.</span></span><br><span class="line">  <span class="comment">// Entries are in use by clients, and have refs &gt;= 2 and in_cache==true.</span></span><br><span class="line">  <span class="function">LRUHandle in_use_ <span class="title">GUARDED_BY</span><span class="params">(mutex_)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="function">HandleTable table_ <span class="title">GUARDED_BY</span><span class="params">(mutex_)</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">LRUCache::<span class="built_in">LRUCache</span>() : <span class="built_in">capacity_</span>(<span class="number">0</span>), <span class="built_in">usage_</span>(<span class="number">0</span>) &#123;</span><br><span class="line">  <span class="comment">// Make empty circular linked lists.</span></span><br><span class="line">  lru_.next = &amp;lru_;</span><br><span class="line">  lru_.prev = &amp;lru_;</span><br><span class="line">  in_use_.next = &amp;in_use_;</span><br><span class="line">  in_use_.prev = &amp;in_use_;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li><code>LRUCache</code> åŒ…å«ä¸¤å¤§éƒ¨åˆ†ï¼Œ<code>in_use_</code> ï¼ˆå®¢æˆ·ç«¯æ­£åœ¨ä½¿ç”¨çš„åŒå‘é“¾è¡¨ï¼‰å’Œ <code>lru_</code> ï¼ˆ LRU é€»è¾‘ï¼‰ï¼Œè¿™é‡Œå’Œ LRUHandle çš„é€»è¾‘æœ‰ç›¸å…³ï¼ŒLRUHandle ä¸Šæœ‰ <code>ref_</code>, è¡¨ç¤ºå¼•ç”¨è®¡æ•°ã€‚<code>lru_</code> ä¹Ÿç›¸å½“äºæˆ‘ä»¬ä¹‹å‰ boost é‚£é‡Œçš„ <code>m_list_</code></li></ol><p>ä¸è¿‡ <code>LRUHandle</code> ä¸Šè¿˜æœ‰ä¸ªè¿·ä¹‹å­—æ®µ <code>next_hash</code>, ç„¶å HandleTable åˆæ˜¯ä»€ä¹ˆæ ·çš„å‘¢ï¼Ÿè¿™å°±æ˜¯ä»Šå¤©çš„å‘ç‚¹äº†ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">HandleTable</span> &#123;</span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="built_in">HandleTable</span>() : <span class="built_in">length_</span>(<span class="number">0</span>), <span class="built_in">elems_</span>(<span class="number">0</span>), <span class="built_in">list_</span>(<span class="literal">nullptr</span>) &#123; <span class="built_in">Resize</span>(); &#125;</span><br><span class="line">  ~<span class="built_in">HandleTable</span>() &#123; <span class="keyword">delete</span>[] list_; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function">LRUHandle* <span class="title">Lookup</span><span class="params">(<span class="type">const</span> Slice&amp; key, <span class="type">uint32_t</span> hash)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> *<span class="built_in">FindPointer</span>(key, hash);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function">LRUHandle* <span class="title">Insert</span><span class="params">(LRUHandle* h)</span> </span>&#123;</span><br><span class="line">    LRUHandle** ptr = <span class="built_in">FindPointer</span>(h-&gt;<span class="built_in">key</span>(), h-&gt;hash);</span><br><span class="line">    LRUHandle* old = *ptr;</span><br><span class="line">    h-&gt;next_hash = (old == <span class="literal">nullptr</span> ? <span class="literal">nullptr</span> : old-&gt;next_hash);</span><br><span class="line">    *ptr = h;</span><br><span class="line">    <span class="keyword">if</span> (old == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">      ++elems_;</span><br><span class="line">      <span class="keyword">if</span> (elems_ &gt; length_) &#123;</span><br><span class="line">        <span class="comment">// Since each cache entry is fairly large, we aim for a small</span></span><br><span class="line">        <span class="comment">// average linked list length (&lt;= 1).</span></span><br><span class="line">        <span class="built_in">Resize</span>();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> old;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function">LRUHandle* <span class="title">Remove</span><span class="params">(<span class="type">const</span> Slice&amp; key, <span class="type">uint32_t</span> hash)</span> </span>&#123;</span><br><span class="line">    LRUHandle** ptr = <span class="built_in">FindPointer</span>(key, hash);</span><br><span class="line">    LRUHandle* result = *ptr;</span><br><span class="line">    <span class="keyword">if</span> (result != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">      *ptr = result-&gt;next_hash;</span><br><span class="line">      --elems_;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span>:</span><br><span class="line">  <span class="comment">// The table consists of an array of buckets where each bucket is</span></span><br><span class="line">  <span class="comment">// a linked list of cache entries that hash into the bucket.</span></span><br><span class="line">  <span class="type">uint32_t</span> length_;</span><br><span class="line">  <span class="type">uint32_t</span> elems_;</span><br><span class="line">  LRUHandle** list_;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Return a pointer to slot that points to a cache entry that</span></span><br><span class="line">  <span class="comment">// matches key/hash.  If there is no such cache entry, return a</span></span><br><span class="line">  <span class="comment">// pointer to the trailing slot in the corresponding linked list.</span></span><br><span class="line">  <span class="function">LRUHandle** <span class="title">FindPointer</span><span class="params">(<span class="type">const</span> Slice&amp; key, <span class="type">uint32_t</span> hash)</span> </span>&#123;</span><br><span class="line">    LRUHandle** ptr = &amp;list_[hash &amp; (length_ - <span class="number">1</span>)];</span><br><span class="line">    <span class="keyword">while</span> (*ptr != <span class="literal">nullptr</span> &amp;&amp; ((*ptr)-&gt;hash != hash || key != (*ptr)-&gt;<span class="built_in">key</span>())) &#123;</span><br><span class="line">      ptr = &amp;(*ptr)-&gt;next_hash;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ptr;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">Resize</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="type">uint32_t</span> new_length = <span class="number">4</span>;</span><br><span class="line">    <span class="keyword">while</span> (new_length &lt; elems_) &#123;</span><br><span class="line">      new_length *= <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    LRUHandle** new_list = <span class="keyword">new</span> LRUHandle*[new_length];</span><br><span class="line">    <span class="built_in">memset</span>(new_list, <span class="number">0</span>, <span class="built_in">sizeof</span>(new_list[<span class="number">0</span>]) * new_length);</span><br><span class="line">    <span class="type">uint32_t</span> count = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">uint32_t</span> i = <span class="number">0</span>; i &lt; length_; i++) &#123;</span><br><span class="line">      LRUHandle* h = list_[i];</span><br><span class="line">      <span class="keyword">while</span> (h != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">        LRUHandle* next = h-&gt;next_hash;</span><br><span class="line">        <span class="type">uint32_t</span> hash = h-&gt;hash;</span><br><span class="line">        LRUHandle** ptr = &amp;new_list[hash &amp; (new_length - <span class="number">1</span>)];</span><br><span class="line">        h-&gt;next_hash = *ptr;</span><br><span class="line">        *ptr = h;</span><br><span class="line">        h = next;</span><br><span class="line">        count++;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">assert</span>(elems_ == count);</span><br><span class="line">    <span class="keyword">delete</span>[] list_;</span><br><span class="line">    list_ = new_list;</span><br><span class="line">    length_ = new_length;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>åˆ«çœ‹è¿™ä¸ªç»“æ„å¾ˆå¤æ‚ï¼Œå®é™…ä¸Šå°±æ˜¯ä¸ªé“¾å¼ hash. å¼€è¾Ÿäº†ä¸€ä¸ªæ•°ç»„ï¼Œç„¶åç”¨ <code>next_hash</code> è¡¨ç¤ºé“¾ï¼Œè¿™ä¸ªç±»ä¼¼ absl çš„ <code>flat_hash_set</code>, è€Œ set çš„æˆå‘˜åˆ™æ˜¯ <code>LRUHandle</code>, é‚£ä¹ˆè¿™ä¸ªæ—¶å€™ï¼Œevict çš„æ—¶å€™ï¼Œå¯ä»¥ç›´æ¥é€šè¿‡ <code>hash</code> å’ŒæŸ¥è¡¨æ¥å®šä½ã€‚</p><p>ç›¸å¯¹ boost çš„å®ç°æ¥è¯´ï¼Œè¿™é‡Œå¯ä»¥ç®—ç»•äº†ä¸ªå¤§åœˆå­ï¼Œä½†æ˜¯ Google è¡¨ç¤ºè¿™é‡Œæœ‰ 5% çš„æ€§èƒ½æ”¶ç›Šï¼ˆboost å¯èƒ½å—é™äº hash table çš„ç»“æ„, æœ‰ç©ºé—´ä¸Šçš„å¼€é”€å’Œå±€éƒ¨æ€§ä¸Šçš„å¼€é”€ï¼‰ã€‚</p><p>é‚£ä¹ˆï¼Œè¿˜æœ‰ä¸€ä¸ªé—®é¢˜æ˜¯ï¼Œä¸ºä»€ä¹ˆ <code>LRUHandle</code> åªå­˜æœ‰ <code>next_hash</code>, æ²¡æœ‰ <code>prev_hash</code>? å¦‚æœæœ‰ <code>prev_hash</code>, é‚£ä¹ˆ Erase çš„æ—¶å€™ç”šè‡³ä¸éœ€è¦æŸ¥è¡¨ã€‚è¿™é‡Œå¯ä»¥çœ‹çœ‹ <code>Insert</code> ä»£ç ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">LRUHandle* <span class="title">Insert</span><span class="params">(LRUHandle* h)</span> </span>&#123;</span><br><span class="line">  LRUHandle** ptr = <span class="built_in">FindPointer</span>(h-&gt;<span class="built_in">key</span>(), h-&gt;hash);</span><br><span class="line">  LRUHandle* old = *ptr;</span><br><span class="line">  h-&gt;next_hash = (old == <span class="literal">nullptr</span> ? <span class="literal">nullptr</span> : old-&gt;next_hash);</span><br><span class="line">  *ptr = h;</span><br><span class="line">  <span class="keyword">if</span> (old == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">    ++elems_;</span><br><span class="line">    <span class="keyword">if</span> (elems_ &gt; length_) &#123;</span><br><span class="line">      <span class="comment">// Since each cache entry is fairly large, we aim for a small</span></span><br><span class="line">      <span class="comment">// average linked list length (&lt;= 1).</span></span><br><span class="line">      <span class="built_in">Resize</span>();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> old;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p> è¿™é‡Œå¤§æ¦‚è¦æ±‚ <code>next_hash</code> é“¾è¡¨ä¸ä¼šå¾ˆé•¿, ç„¶åä¸åŠ ä¸Šè¿™ä¸ªæ¥èŠ‚çœç©ºé—´ã€‚</p><h2 id="RocksDB-LRU"><a href="#RocksDB-LRU" class="headerlink" title="RocksDB LRU"></a>RocksDB LRU</h2><p>RocksDB çš„ LRU å¤§è‡´æ”¯æŒç±»ä¼¼ LevelDB çš„ LRU, ä½†æ˜¯å®ƒæ”¯æŒç±»ä¼¼ 2-LRUï¼Œä¼šåœ¨ä¸€å®šæ¡ä»¶ä¸‹ï¼ŒæŠŠ LRU ä¸¢åˆ°é«˜ä¼˜é˜Ÿåˆ—ä¸­ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">enum</span> <span class="title class_">Flags</span> : <span class="type">uint8_t</span> &#123;</span><br><span class="line">    <span class="comment">// Whether this entry is referenced by the hash table.</span></span><br><span class="line">    IN_CACHE = (<span class="number">1</span> &lt;&lt; <span class="number">0</span>),</span><br><span class="line">    <span class="comment">// Whether this entry is high priority entry.</span></span><br><span class="line">    IS_HIGH_PRI = (<span class="number">1</span> &lt;&lt; <span class="number">1</span>),</span><br><span class="line">    <span class="comment">// Whether this entry is in high-pri pool.</span></span><br><span class="line">    IN_HIGH_PRI_POOL = (<span class="number">1</span> &lt;&lt; <span class="number">2</span>),</span><br><span class="line">    <span class="comment">// Whether this entry has had any lookups (hits).</span></span><br><span class="line">    HAS_HIT = (<span class="number">1</span> &lt;&lt; <span class="number">3</span>),</span><br><span class="line">  &#125;;</span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">LRUCacheShard::LRU_Insert</span><span class="params">(LRUHandle* e)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">assert</span>(e-&gt;next == <span class="literal">nullptr</span>);</span><br><span class="line">  <span class="built_in">assert</span>(e-&gt;prev == <span class="literal">nullptr</span>);</span><br><span class="line">  <span class="type">size_t</span> total_charge = e-&gt;<span class="built_in">CalcTotalCharge</span>(metadata_charge_policy_);</span><br><span class="line">  <span class="keyword">if</span> (high_pri_pool_ratio_ &gt; <span class="number">0</span> &amp;&amp; (e-&gt;<span class="built_in">IsHighPri</span>() || e-&gt;<span class="built_in">HasHit</span>())) &#123;</span><br><span class="line">    <span class="comment">// Inset &quot;e&quot; to head of LRU list.</span></span><br><span class="line">    e-&gt;next = &amp;lru_;</span><br><span class="line">    e-&gt;prev = lru_.prev;</span><br><span class="line">    e-&gt;prev-&gt;next = e;</span><br><span class="line">    e-&gt;next-&gt;prev = e;</span><br><span class="line">    e-&gt;<span class="built_in">SetInHighPriPool</span>(<span class="literal">true</span>);</span><br><span class="line">    high_pri_pool_usage_ += total_charge;</span><br><span class="line">    <span class="built_in">MaintainPoolSize</span>();</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// Insert &quot;e&quot; to the head of low-pri pool. Note that when</span></span><br><span class="line">    <span class="comment">// high_pri_pool_ratio is 0, head of low-pri pool is also head of LRU list.</span></span><br><span class="line">    e-&gt;next = lru_low_pri_-&gt;next;</span><br><span class="line">    e-&gt;prev = lru_low_pri_;</span><br><span class="line">    e-&gt;prev-&gt;next = e;</span><br><span class="line">    e-&gt;next-&gt;prev = e;</span><br><span class="line">    e-&gt;<span class="built_in">SetInHighPriPool</span>(<span class="literal">false</span>);</span><br><span class="line">    lru_low_pri_ = e;</span><br><span class="line">  &#125;</span><br><span class="line">  lru_usage_ += total_charge;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="è¿‘ä¼¼-LRU-å’Œå…¶ä»–æ–¹æ³•"><a href="#è¿‘ä¼¼-LRU-å’Œå…¶ä»–æ–¹æ³•" class="headerlink" title="è¿‘ä¼¼ LRU å’Œå…¶ä»–æ–¹æ³•"></a>è¿‘ä¼¼ LRU å’Œå…¶ä»–æ–¹æ³•</h2><p>å¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œçš„ LRU æ˜¯å¸¦é”å®ç°çš„ã€‚HashTable + doubly linked list è®©å®ƒçš„å¹¶å‘å˜å¾—æ¯”è¾ƒéº»çƒ¦ã€‚è¿™é‡Œå¯ä»¥å‚è€ƒä¸€ä¸‹ä¸€äº›è¿‘ä¼¼çš„ LRU ç®—æ³•ï¼Œåœ¨ç®—æ³•æœ¬èº«çš„æ€§èƒ½ä¸Šæœ‰ç›¸å¯¹å¥½ä¸€äº›çš„å¼€é”€ï¼š</p><ol><li>redis çš„ LRU<ol><li>è¿™é‡Œçš„ LRU æ„Ÿè§‰ä¸€ç‚¹éƒ½ä¸ LRUï¼Œåªæ˜¯äº§ç”Ÿä¸€ä¸ª LRU æ—¶é—´ï¼Œé‡‡æ · key, ç„¶åå¤„ç†æ‰â€œ Least Recent Usedâ€ çš„æ•°æ®ï¼Œæ˜¯ä¸€ä¸ªä¸æ¦‚ç‡çš„ç»“åˆï¼Œæœ¬èº«é é‡‡æ · + éšæœºæ€§å®ç°</li></ol></li><li>RocksDB çš„ clock ç®—æ³•<ol><li>è¿™é‡Œ clock æœ¬èº«ç›¸å¯¹ LRU æ¥è¯´å¥½å¹¶è¡Œå¾ˆå¤šï¼ŒRocksDB è¿™é‡Œç”¨äº† <code>tbb</code> ä¸­çš„åº“æ¥å®ç°ã€‚</li></ol></li></ol><p>æ­¤å¤–ï¼Œä¹Ÿæœ‰ <a href="https://en.wikipedia.org/wiki/Adaptive_replacement_cache">Adaptive replacement cache</a> è¿™æ ·çš„ç­–ç•¥ï¼Œæˆ–è€… LFU è¿™æ ·çš„ç­–ç•¥ã€‚å¯ä»¥é…åˆ bench å’Œ pprof ï¼Œé…åˆè‡ªå·±çš„éœ€æ±‚ä½¿ç”¨ã€‚</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Linux-API:mmap&amp;flock</title>
      <link href="/2021/03/10/Linux-API-mmap-flock/"/>
      <url>/2021/03/10/Linux-API-mmap-flock/</url>
      
        <content type="html"><![CDATA[<h2 id="Linux-API-introduction-to-mmap-2-and-flock-2"><a href="#Linux-API-introduction-to-mmap-2-and-flock-2" class="headerlink" title="Linux API: introduction to mmap(2) and flock(2)"></a>Linux API: introduction to mmap(2) and flock(2)</h2><h2 id="mmap"><a href="#mmap" class="headerlink" title="mmap"></a>mmap</h2><p><code>mmap(2)</code> æ¯”è¾ƒæŠ˜ç£¨äººï¼Œå®ƒçš„æ¥å£å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;sys/mman.h&gt;</span><br><span class="line"></span><br><span class="line">void *mmap(void *addr, size_t length, int prot, int flags,</span><br><span class="line">           int fd, off_t offset);</span><br><span class="line">int munmap(void *addr, size_t length);</span><br></pre></td></tr></table></figure><p>mmap æœ‰ä¸¤ç§ mapping:</p><ol><li>file mapping</li><li>anonymous mapping</li></ol><p>å¯¹äº 1ï¼Œ<code>fd</code> åœ¨ <code>mmap</code> åå¯ä»¥ <code>close</code>:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">After the mmap() call has returned, the file descriptor, fd, can</span><br><span class="line">be closed immediately without invalidating the mapping.</span><br></pre></td></tr></table></figure><p><code>mmap</code> çš„ <code>prot</code> æœ‰ä¸‹åˆ—çš„è¯­ä¹‰ï¼š</p><ol><li><code>PROT_EXEC</code>: Pages may be executed.</li><li><code>PROT_READ</code>: Pages may be read.</li><li><code>PROT_WRITE</code>: Pages may be written.</li><li><code>PROT_NONE</code>:Pages may not be accessed.</li></ol><p>mmap çš„é€»è¾‘å’Œ os çš„ <code>page cache</code> å¼ºç›¸å…³ï¼Œä¸Šè¿°è¯­ä¹‰å¯èƒ½ä½œç”¨åœ¨ page ä¸Šï¼Œå¿…è¦çš„æ—¶å€™ç»™ä½ ä¸ª <code>SIGSEGV</code></p><p><code>rwx</code> ä¸‰ä¸ªé€‰é¡¹éƒ½ç†è§£ï¼Œ<code>PROT_NONE</code> å¯èƒ½ç”¨äºåš Guard Page: <a href="https://stackoverflow.com/questions/12916603/what-s-the-purpose-of-mmap-memory-protection-prot-none">https://stackoverflow.com/questions/12916603/what-s-the-purpose-of-mmap-memory-protection-prot-none</a></p><p>åŒæ—¶ï¼Œ<code>flags</code> ä¹Ÿæœ‰è®¸å¤šé€‰é¡¹ï¼Œé™¤äº† <code>MAP_NONBLOCK</code> <code>MAP_LOCKED</code> è¿™äº›ï¼Œéœ€è¦ç•™æ„ <code>MAP_SHARED</code> å’Œ <code>MAP_PRIVATE</code> , ä½¿ç”¨å¯ä»¥è§ä¸‹è¡¨ã€‚</p><p><img src="https://image.mwish.me/blog-image/0E0F6E12-FAB6-434A-8177-68F7CFE39FB2.png" alt="0E0F6E12-FAB6-434A-8177-68F7CFE39FB2"></p><p>ä¸Šè¿°ä¹Ÿä¼šå½±å“ <code>fork</code> çš„æ—¶å€™çˆ¶å­è¿›ç¨‹çš„ <code>mmap</code> è¡Œä¸ºï¼ˆå¯ä»¥å›åˆ°ä¸€ä¸‹ä¹‹å‰å¯¹ <code>fork</code> çš„åæ§½ï¼‰</p><h3 id="æ–‡ä»¶æ˜ å°„"><a href="#æ–‡ä»¶æ˜ å°„" class="headerlink" title="æ–‡ä»¶æ˜ å°„"></a>æ–‡ä»¶æ˜ å°„</h3><p><code>mmap</code> çš„æ—¶å€™ï¼Œæ–‡ä»¶ä¼šè¢«æŒ‰ç…§ <code>offset</code> å’Œ <code>length</code> æ˜ å°„åˆ°å†…å­˜ä¸­ï¼Œå¦‚å›¾ï¼š</p><p><img src="https://image.mwish.me/blog-image/0FCE129310878CAB48CB0E6D47DC8169.png" alt="0FCE129310878CAB48CB0E6D47DC8169"></p><p>è¿™ç§ mapping å¯èƒ½æ˜¯ on-demand çš„ï¼Œå³ <code>mmap</code> ä¹‹åä¸æŠŠ page åŠ è½½ï¼Œéœ€è¦çš„æ—¶å€™å†è®¿é—®ã€‚</p><p>å¯¹äº <code>MAP_PRIVATE</code>, å®ƒå¯ä»¥ï¼š</p><ul><li>è¢«ç”¨åœ¨ <code>PROT_READ | PROT_EXEC</code> , è¿è¡Œç¨‹åºï¼Œè¿™æ ·ä¸ä¼šä¿®æ”¹ç¨‹åºçš„æ•°æ®</li><li>å…±äº«ä¸€ä¸ªåªè¯»çš„ <code>.text</code></li></ul><p>è€Œå…±äº«çš„æ–‡ä»¶åˆ™å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://image.mwish.me/blog-image/6CFC2E40-CF95-4C33-B6F9-D6836D857F80.png" alt="6CFC2E40-CF95-4C33-B6F9-D6836D857F80"></p><p>è¿™ç§ memory mapping IO ä¼šæœ‰ç‰¹ç‚¹ï¼šæ–‡ä»¶å’Œ kernel çš„ buffer æ˜¯ç”± os è‡ªåŠ¨ manage çš„ï¼ŒåŒæ—¶ï¼Œå†…æ ¸å’Œç”¨æˆ·è¿›ç¨‹ä¸å†å’Œ write ä¸€æ ·ï¼Œå…ˆå†™ç”¨æˆ· buffer, å†å†™ kernel buffer.</p><p>å½“éœ€è¦å¼ºåˆ¶ flush çš„æ—¶å€™ï¼Œå¯ä»¥èµ° <code>msync(2)</code> æ¥å¼ºåˆ¶åˆ·ç›˜</p><p>mmap çš„æ˜ å°„å¯èƒ½æ¯”æ–‡ä»¶æœ¬èº«è¿˜å¤§ï¼Œæœªæ¥çš„å†…å­˜å¯èƒ½éœ€è¦ <code>ftruncate</code> å¤„ç†ï¼š</p><p><img src="https://image.mwish.me/blog-image/D3EA25A8-9FBE-4215-8CCF-408BAF69183C.png" alt="D3EA25A8-9FBE-4215-8CCF-408BAF69183C"></p><h3 id="åŒ¿åæ˜ å°„"><a href="#åŒ¿åæ˜ å°„" class="headerlink" title="åŒ¿åæ˜ å°„"></a>åŒ¿åæ˜ å°„</h3><p>æ•°æ®ä¼šè¢«åˆå§‹åŒ–ä¸º 0</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">MAP_ANONYMOUS</span><br><span class="line">       The mapping is not backed by any file; its contents are</span><br><span class="line">       initialized to zero.  The fd argument is ignored; however,</span><br><span class="line">       some implementations require fd to be -1 if MAP_ANONYMOUS</span><br><span class="line">       (or MAP_ANON) is specified, and portable applications</span><br><span class="line">       should ensure this.  The offset argument should be zero.</span><br><span class="line">       The use of MAP_ANONYMOUS in conjunction with MAP_SHARED is</span><br><span class="line">       supported on Linux only since kernel 2.4.</span><br></pre></td></tr></table></figure><h3 id="æ‚é¡¹"><a href="#æ‚é¡¹" class="headerlink" title="æ‚é¡¹"></a>æ‚é¡¹</h3><p><code>mprotect(2)</code> åˆ‡æ¢è¿›ç¨‹é¡µçš„è®¿é—®æƒé™</p><p><code>mlock</code> ä¼šè®²å†…å­˜ Page é©»ç•™åœ¨ç‰©ç†å†…å­˜ä¸­ï¼Œä¸ä¼šswap å‡ºå»</p><h3 id="madvise-2"><a href="#madvise-2" class="headerlink" title="madvise(2)"></a>madvise(2)</h3><p>ç”¨æˆ·æ”¹å†…æ ¸çš„ä»£ç å’Œè°ƒåº¦æ˜¯ä¸ç°å®çš„ï¼Œä½†æ˜¯å¾ˆå¤šæ—¶å€™ç”¨æˆ·æ¯”å†…æ ¸è‡ªå·±æ¸…æ¥šéœ€è¦è°ƒåº¦æˆå•¥æ ·ã€‚</p><p><code>madvise(2)</code> ç›¸å½“äºæä¾›ä¸Šè¿°ç›¸å…³çš„ä¿¡æ¯ï¼Œâ€œå»ºè®®â€å†…æ ¸åšç›¸å…³çš„æ“ä½œã€‚è¯¦è§ï¼š<a href="https://www.man7.org/linux/man-pages/man2/madvise.2.html">https://www.man7.org/linux/man-pages/man2/madvise.2.html</a></p><h3 id="Usage"><a href="#Usage" class="headerlink" title="Usage"></a>Usage</h3><p>BoltDB çš„è¯»å–ä½¿ç”¨äº† <code>mmap</code>. å†…å­˜ç©ºé—´æ˜¯å°äºç£ç›˜çš„ï¼Œè€Œ bolt æ²¡æœ‰è‡ªå·±å†™ BufferPool, è€Œæ˜¯ç”¨äº† mmap, å¯ä»¥çœ‹çœ‹ä»£ç ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// mmap memory maps a DB&#x27;s data file.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">mmap</span><span class="params">(db *DB, sz <span class="type">int</span>)</span></span> <span class="type">error</span> &#123;</span><br><span class="line"><span class="comment">// Map the data file to memory.</span></span><br><span class="line">b, err := syscall.Mmap(<span class="type">int</span>(db.file.Fd()), <span class="number">0</span>, sz, syscall.PROT_READ, syscall.MAP_SHARED|db.MmapFlags)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Advise the kernel that the mmap is accessed randomly.</span></span><br><span class="line"><span class="keyword">if</span> err := madvise(b, syscall.MADV_RANDOM); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;madvise: %s&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Save the original byte slice and convert to a byte array pointer.</span></span><br><span class="line">db.dataref = b</span><br><span class="line">db.data = (*[maxMapSize]<span class="type">byte</span>)(unsafe.Pointer(&amp;b[<span class="number">0</span>]))</span><br><span class="line">db.datasz = sz</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>DB::mmap</code> å…·ä½“èµ°åˆ° <code>bolt_unix.go</code> ä¸‹çš„ <code>mmap</code>, è¿™é‡Œç”¨ <code>madvise</code> + <code>MADV_RANDOM</code> æ¥è¡¨è¾¾è®¿é—®çš„æ¨¡å¼ï¼ŒåŒæ—¶æŠŠè¿™æ¬¡æ•°æ®å­˜å‚¨åˆ° <code>db</code> ä¸Š</p><p><code>dataref</code> é˜²æ­¢ <code>syscall.Mmap</code> çš„ç»“æœè¢«å›æ”¶ï¼Œå…·ä½“è®¿é—®çš„æ•°æ®è¢«ä¸¢åˆ° <code>data</code> ä¸Šã€‚</p><p><code>munmap</code> æ˜¯ä¸€ä¸ªåå‘æ“ä½œï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// munmap unmaps a DB&#x27;s data file from memory.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">munmap</span><span class="params">(db *DB)</span></span> <span class="type">error</span> &#123;</span><br><span class="line"><span class="comment">// Ignore the unmap if we have no mapped data.</span></span><br><span class="line"><span class="keyword">if</span> db.dataref == <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Unmap using the original byte slice.</span></span><br><span class="line">err := syscall.Munmap(db.dataref)</span><br><span class="line">db.dataref = <span class="literal">nil</span></span><br><span class="line">db.data = <span class="literal">nil</span></span><br><span class="line">db.datasz = <span class="number">0</span></span><br><span class="line"><span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="flock"><a href="#flock" class="headerlink" title="flock"></a>flock</h2><p><a href="https://man7.org/linux/man-pages//man2/flock.2.html">https://man7.org/linux/man-pages//man2/flock.2.html</a></p><p><code>flock(2)</code> æºè‡ª BSDï¼Œ<code>flock</code> å¯ä»¥æŒ‡å®š <code>LOCK_SH</code> å’Œ <code>LOCK_EX</code>, è¡¨ç¤ºå…±äº«/äº’æ–¥ï¼Œä¹Ÿå¯ä»¥ <code>LOCK_UN</code> è§£é”</p><p>æœ¬èº«è°ƒç”¨ <code>flock</code> ä¼šé˜»å¡è¿›ç¨‹ï¼Œä¸å¸Œæœ›é˜»å¡å¯ä»¥å¸¦ä¸Š <code>LOCK_UB</code> flag</p><p><code>flock</code> æœ¬èº«å’Œ <code>fd</code> æ˜¯ç»‘å®šçš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œ<code>dup</code> äº§ç”Ÿçš„ fd å’Œ <code>fork</code> å­è¿›ç¨‹ äº§ç”Ÿçš„ fd æ˜¯åŒä¸€æŠŠé”ï¼Œè¿™æ„å‘³ç€ï¼Œå¯¹å®ƒä»¬çš„ <code>LOCK_UN</code> å¤„ç†éœ€è¦é¢å¤–æ³¨æ„ã€‚</p><p><img src="https://image.mwish.me/blog-image/46EDACEC-B756-477A-877C-302378852132.png" alt="46EDACEC-B756-477A-877C-302378852132"></p><p>å¯ä»¥å‚è€ƒä¸€ä¸‹ä»£ç çš„ <code>flock</code> å’Œ <code>funlock</code>, å†…å®¹åœ¨ <code>bolt_unix.go</code>:</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">flock</span><span class="params">(db *DB, mode os.FileMode, exclusive <span class="type">bool</span>, timeout time.Duration)</span></span> <span class="type">error</span> &#123;</span><br><span class="line"><span class="keyword">var</span> t time.Time</span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line"><span class="comment">// If we&#x27;re beyond our timeout then return an error.</span></span><br><span class="line"><span class="comment">// This can only occur after we&#x27;ve attempted a flock once.</span></span><br><span class="line"><span class="keyword">if</span> t.IsZero() &#123;</span><br><span class="line">t = time.Now()</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> timeout &gt; <span class="number">0</span> &amp;&amp; time.Since(t) &gt; timeout &#123;</span><br><span class="line"><span class="keyword">return</span> ErrTimeout</span><br><span class="line">&#125;</span><br><span class="line">flag := syscall.LOCK_SH</span><br><span class="line"><span class="keyword">if</span> exclusive &#123;</span><br><span class="line">flag = syscall.LOCK_EX</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Otherwise attempt to obtain an exclusive lock.</span></span><br><span class="line">err := syscall.Flock(<span class="type">int</span>(db.file.Fd()), flag|syscall.LOCK_NB)</span><br><span class="line"><span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> err != syscall.EWOULDBLOCK &#123;</span><br><span class="line"><span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Wait for a bit and try again.</span></span><br><span class="line">time.Sleep(<span class="number">50</span> * time.Millisecond)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// funlock releases an advisory lock on a file descriptor.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">funlock</span><span class="params">(db *DB)</span></span> <span class="type">error</span> &#123;</span><br><span class="line"><span class="keyword">return</span> syscall.Flock(<span class="type">int</span>(db.file.Fd()), syscall.LOCK_UN)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„ <code>funlock</code> æ¯”è¾ƒæœ´ç´ ï¼Œ<code>flock</code> é‡‡å–äº† <code>LOCK_NB</code> å’Œä¸€ä¸ª retry å°è¯•ç»“åˆï¼Œè¶…è¿‡ timeout åï¼Œç¨‹åºä¼šè‡ªåŠ¨é€€å‡ºã€‚</p><p><code>flock</code> åªèƒ½ä»¥æ–‡ä»¶ä¸ºç²’åº¦ä¸Šé”ï¼Œéœ€è¦æ›´ç»†çš„æ§åˆ¶éœ€è¦ä½¿ç”¨ <code>fcntl</code> ã€‚</p><h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><ul><li><a href="https://zhuanlan.zhihu.com/p/71517406">https://zhuanlan.zhihu.com/p/71517406</a></li><li><a href="https://man7.org/linux/man-pages/man2/mmap.2.html">https://man7.org/linux/man-pages/man2/mmap.2.html</a></li><li>BoltDB: <a href="https://github.com/boltdb/bolt">https://github.com/boltdb/bolt</a></li></ul>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Notes on Query Optimization</title>
      <link href="/2021/02/08/Notes-on-Query-Cost-Estimation/"/>
      <url>/2021/02/08/Notes-on-Query-Cost-Estimation/</url>
      
        <content type="html"><![CDATA[<p>ä¸Šä¸€èŠ‚æˆ‘ä»¬ä»‹ç»äº† executor, è¿™èŠ‚æ˜¯ä¼˜åŒ–å™¨çš„å…¥é—¨ã€‚ç”¨æˆ·çš„ SQL å¯ä»¥ç”¨æŸç§å…³ç³»ä»£æ•°çš„è¡¨è¾¾å¼è¡¨ç¤ºã€‚åŒæ—¶ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨å…³ç³»ä»£æ•°æ¨å‡ºæŸç§ç­‰ä»·æ€§ï¼Œä¸¤ä¸ªå…³ç³»è¡¨è¾¾å¼åœ¨æ‰€æœ‰å¯èƒ½çš„ db é›†åˆéƒ½ä¼šäº§ç”Ÿç›¸åŒå…ƒç´ é›†ï¼Œé‚£ä¹ˆè¿™ä¸¤ä¸ªè¡¨è¾¾å¼æ˜¯ ç­‰ä»·(equivalent) çš„ã€‚</p><p>ä¸Šé¢æˆ‘ç¿»è¯‘çš„æœ‰ç‚¹åƒåœ¾ï¼Œè´´ä¸‹åŸæ–‡ï¼š</p><blockquote><p>Two relational-algebra expressions are said to be <strong>equivalent</strong> if, on every legal data- base instance, the two expressions generate the same set of tuples. (Recall that a legal database instance is one that satisfies all the integrity constraints specified in the data- base schema.) </p><p>Note that the order of the tuples is irrelevant; the two expressions may generate the tuples in different orders, but would be considered equivalent as long as the set of tuples is the same.</p></blockquote><p>DB ä¼˜åŒ–çš„è¿‡ç¨‹éœ€è¦ï¼š</p><ol><li>ç”Ÿæˆä¸ç»™å®š expression é€»è¾‘ç­‰ä»·çš„è¡¨è¾¾å¼</li><li>äº§ç”Ÿä¸åŒçš„æŸ¥è¯¢è®¡åˆ’</li><li>ä¼°è®¡æ¯ä¸ª Plan çš„å¼€é”€ï¼Œé€‰æ‹©ä»£ä»·æœ€å°çš„</li></ol><p>å®Œæˆ (1) éœ€è¦æœ‰ä¸€äº›ç­‰ä»·è§„åˆ™ï¼š</p><blockquote><p>To implement the first step, the query optimizer must generate expressions equiv- alent to a given expression. It does so by means of <em>equivalence rules</em> that specify how to transform an expression into a logically equivalent one.</p></blockquote><p>éšå³æˆ‘ä»¬è·å¾—2ï¼Œç„¶åæ ¹æ®ä¸€äº›å›ºå®šè§„åˆ™æˆ–è€…ç»Ÿè®¡ä¿¡æ¯æ¥è¿›è¡Œä¼˜åŒ–ã€‚</p><p>Equivalent Rules å»ºè®®é˜…è¯»åŸä¹¦ï¼Œæ„Ÿè§‰æˆ‘æ€ä¹ˆè®²éƒ½æ˜¯æŠŠå®ƒä»¬å›¾è´´ä¸€éâ€¦æ€»çš„æ¥è¯´ï¼Œè¿™äº› rules æœ‰ä¸‹åˆ—çš„å«ä¹‰ï¼š</p><ul><li>å…³ç³»ä»£æ•°æœ‰ä¸€äº›ç­‰ä»·è§„åˆ™ï¼Œæˆ‘ä»¬å¸Œæœ›ï¼Œéƒ¨åˆ†è§„åˆ™é€‚ç”¨ä»¥åï¼Œäº§ç”Ÿç­‰ä»·äºåŸå§‹å…³ç³»çš„ç»“æœï¼Œä½†äº§ç”Ÿè¾ƒå°‘ä¸­é—´å…³ç³»</li><li>A set of equivalence rules is said to be <strong>minimal</strong> if no rule can be derived from any combination of the others. </li></ul><p>æ­¤å¤–ï¼Œä¸€äº› Join ç›¸å…³çš„ï¼Œä¹Ÿèƒ½æ ¹æ®ç´¢å¼•ã€å…¬å…±å±æ€§ç­‰ Rules æ¥å¤„ç†ã€‚</p><p><img src="https://image.mwish.me/blog-image/F86C9C0C-6F5F-4EB7-ACC7-9DD1DFA17AF9.png" alt="F86C9C0C-6F5F-4EB7-ACC7-9DD1DFA17AF9"></p><p>ä¸Šé¢çš„ <code>genAllEquivalent(E)</code> , å¯¹äºç»™å®šçš„ Expression <code>E</code> , ç”Ÿæˆæ‰€æœ‰çš„ç­‰ä»·è¡¨è¾¾å¼, ä¸­é—´çš„éƒ¨åˆ†é˜¶æ®µå¯ä»¥è¢«ç§°ä¸º transformationã€‚</p><p>ç­‰ç­‰ï¼Œä¸Šé¢ä½ è‚¯å®šè§‰å¾—å¤ªåºŸäº†ï¼Œå®é™…ä¸Šï¼Œæˆ‘ä»¬å¯ä»¥å‡å°‘å¼€é”€ï¼š</p><ul><li>E å’Œ Eâ€™ å¯ä»¥åœ¨å†…å­˜ä¸­å…±äº«ä¸€äº›è¡¨è¾¾å¼ï¼Œæ„Ÿè§‰ç±»ä¼¼ COW-Tree é‚£æ ·</li><li>å¦‚æœ Optimizer åœ¨è¿™ä¸ªé˜¶æ®µåˆ†æ cost, é‚£ä¹ˆå®ƒèƒ½å¤Ÿå‡å°‘å¾ˆå¤šä¸å¿…è¦çš„ç”Ÿæˆã€‚</li></ul><blockquote><p>Some query optimizers use equivalence rules in a heuristic manner. With such an approach, if the left-hand side of an equivalence rule matches a subtree in a query plan, the subtree is rewritten to match the right-hand side of the rule. This process is repeated till the query plan cannot be further rewritten. Rules must be carefully chosen such that the cost decreases when a rule is applied, and rewriting must eventually terminate. Although this approach can be implemented to execute quite fast, there is no guarantee that it will find the optimal plan.</p></blockquote><p>ä¸Šè¿°æè¿°çš„æ˜¯ RBO çš„æ¦‚å¿µï¼Œ</p><blockquote><p>Yet other query optimizers focus on join order selection, which is often a key factor in query cost. We discuss algorithms for join-order optimization in Section 16.4.1.</p></blockquote><h2 id="Estimating-Statictics"><a href="#Estimating-Statictics" class="headerlink" title="Estimating Statictics"></a>Estimating Statictics</h2><p>ä¸€ä¸ªæ“ä½œçš„ä»£ä»·ä¾èµ–äºç»Ÿè®¡ä¿¡æ¯ï¼Œä¾‹å¦‚ï¼š</p><ul><li>èµ°ä¸èµ°æŸä¸ªç´¢å¼•ï¼Ÿå¦‚æœä½ è¦æŸ¥çš„æ•°æ®å°‘çš„è¯ï¼Œèµ°ç´¢å¼•èƒ½å¤§å¤§ä¼˜åŒ–æ€§èƒ½ï¼Œä½†æ˜¯ä½ æœ¬èº«æŸ¥è¯¢æ•°æ®å¤§ï¼Œåˆè¦å›è¡¨ï¼Œé‚£ä½ å°±ç›¸å½“äºç™½èµ°ä¸€è¶Ÿã€‚</li><li>èµ°å“ªä¸ªç´¢å¼•ï¼Ÿæˆ‘ä»¬ç°åœ¨æœ‰å¾ˆå¤šç´¢å¼•ï¼Œä½ è¦æŒ‘é€‰å¯èƒ½æ¯”è¾ƒå°‘çš„ä¸€ä¸ªæ¥èµ°ã€‚</li><li>Join çš„é¡ºåºï¼Œæˆ‘ä»¬æ€ä¹ˆ Join æ‰èƒ½ä»£ä»·æ¯”è¾ƒå°</li></ul><p>åŒæ—¶ï¼Œæˆ‘ä»¬ä¸èƒ½å…ˆéªŒçŸ¥é“æ‰€æœ‰æ•°æ®ï¼Œæ¯”å¦‚ç”¨æˆ·ä¼ äº†ä¸€ä¸ª <code>a &gt; 5 &amp;&amp; a &lt; 10</code>, é‚£å¯¹åº”çš„è¡Œåº”è¯¥æœ‰å¤šå°‘å‘¢ï¼Ÿè¿™ä¸ªé—®é¢˜å¯èƒ½å½±å“ä¸Šè¿°çš„å†³ç­–ã€‚</p><p>æ•°æ®åº“ç³»ç»Ÿçš„ Catalog å¯èƒ½åŒ…å«ä¸‹åˆ—ä¿¡æ¯ï¼š</p><ul><li>$n_r$ , åŒ…å« r çš„ tuple æ•°ç›®</li><li>$b_r$, r ç›¸å…³çš„ tuple æ•°ç›®</li><li>$l_r$ ï¼Œå…³ç³» r ä¸­æ¯ä¸ª tuple åŒ…å«çš„ bytes</li><li>$f_r$, ä¸€ä¸ªç£ç›˜å—èƒ½å®¹çº³ r ä¸­ tuple çš„ä¸ªæ•°</li><li>$V(A, r)$, å…³ç³» r ä¸­å±æ€§ A çš„éé‡å¤å€¼ä¸ªæ•°ã€‚</li></ul><p>ç´¢å¼•ç›¸å…³çš„ï¼Œæ¯”å¦‚ B+Tree çš„ä¿¡æ¯ï¼Œæˆ–è€…æœ‰æ²¡æœ‰ç´¢å¼•ï¼Œå¯èƒ½ä¹Ÿå¯ä»¥ç»´æŠ¤åœ¨ Catalog ä¸­ã€‚</p><p>æ­¤å¤–ï¼Œdb å¯ä»¥ç»´æŠ¤ä¸€ä¸ª histogram:</p><p><img src="https://image.mwish.me/blog-image/3CDD7A79-37C8-4B1E-8CA5-2B55F8E8587B.png" alt="3CDD7A79-37C8-4B1E-8CA5-2B55F8E8587B"></p><p>é€šè¿‡ç›´æ–¹å›¾ï¼Œæ¥è¡¨ç¤ºç»†ç²’åº¦åŒºé—´çš„å–å€¼ã€‚å¦åˆ™ï¼Œdb å¯èƒ½ä¼šåªä¿å­˜æœ€å¤§å€¼å’Œæœ€å°å€¼ï¼Œç„¶åå‡è®¾æ•°æ®åˆ†å¸ƒæ˜¯å‡åŒ€çš„ã€‚</p><p>é‚£ä¹ˆï¼Œæˆ‘ä»¬æœ‰ä»¥ä¸Šä¿¡æ¯ä¹‹åï¼Œå¯ä»¥åšä¸€äº›åŸºæœ¬çš„ä¼°è®¡ï¼š</p><ul><li>$\sigma_{A=v}(r)$  å‡åŒ€åˆ†å¸ƒçš„æƒ…å†µä¸‹ï¼Œå¯é€‰æœ‰ $n_r / V(A, r)$ ä¸ª tuple, å¦‚æœæœ‰ç›´æ–¹å›¾çš„è¯ï¼Œå¯ä»¥åœ¨ç›´æ–¹å›¾å¯¹åº”å–å€¼å®šä½ã€‚</li><li>$\sigma_{A&lt;v}(r)$ ç­‰åŒç†</li><li>Conjunction/Disjunction ä¸­ï¼Œå‡è®¾ä¸ªæ¡ä»¶ç‹¬ç«‹ï¼Œæœ‰ä¸‹åˆ—è®¡ç®—æ–¹å¼ï¼š<br><img src="https://image.mwish.me/blog-image/513E6593-9478-41F7-A551-5315F009DA2F.png" alt="513E6593-9478-41F7-A551-5315F009DA2F"><br><img src="https://image.mwish.me/blog-image/304D1058-66C2-45B4-8A84-5AE5AF25CFA5.png" alt="304D1058-66C2-45B4-8A84-5AE5AF25CFA5"></li></ul><p>ç‰¹åˆ«åœ°æŒ‡å‡ºï¼Œæœ‰ä¸€äº›ç‰¹æ®Šçš„é«˜é¢‘å€¼ï¼Œå¯ä»¥è¢«ç‰¹æ®Šçš„å•ç‹¬è®°å½•åˆ°ä¸€ä¸ªé«˜é¢‘å€¼é›†åˆä¸­ã€‚ç„¶åè¿™äº›å€¼çš„ä¼°è®¡å¯ä»¥èµ°è¿™ä¸ªå•ç‹¬çš„å‡ ä½•ï¼Œæ¥é˜²æ­¢è¿™äº›ç‰¹æ®Šå€¼å½±å“ç»Ÿè®¡ã€‚</p><h3 id="Join-size-Estimation"><a href="#Join-size-Estimation" class="headerlink" title="Join size Estimation"></a>Join size Estimation</h3><ul><li>ç¬›å¡å°”ç§¯å¤§å°å°±æ˜¯ * ä¸€ä¸‹å¾—äº†ï¼Œåè€Œæœ€ç®€å•ï¼Œ$r \times s$ å°±å¯ä»¥äº†ï¼Œäº§ç”Ÿç»“æœæ¯ä¸ª tuple å¤§å° $l_r + l_s$</li></ul><p>ä¼°è®¡è‡ªç„¶è¿æ¥çš„å¤§å°ä¼šå¤æ‚å¾ˆå¤šï¼š</p><ul><li>$R \cap S = \emptyset $ ï¼Œé€€åŒ–ä¸ºç¬›å¡å°”ç§¯çš„è®¡ç®—æ–¹å¼</li><li>å¦‚æœ join çš„æ˜¯ R çš„ key, é‚£å…ƒç´ è‡³å¤šä¸ä¼šå¤šäº Sã€‚è¿™ä¸ªå¯ä»¥ç”¨ $V(A, s)$ æ¥åšä¸€ä¸ªä¼°è®¡ï¼š<ul><li>å¯¹ä¸€ä¸ª R ä¸­çš„ tuple tï¼Œå¯èƒ½ä¼šä¸ $n_s / V(A, s)$ çš„äº§ç”Ÿè¿æ¥</li><li>æ‰€ä»¥æ€»å…± $(n_r * n_s) / V(A, s)$ ç»„</li><li>ä½†æ˜¯ä¸Šé¢æ˜¯åœ¨å„ä¸ªæ¦‚ç‡ç›¸ç­‰çš„æƒ…å†µä¸‹å‡ºç°çš„ï¼Œå®é™…ä¸Šå¯èƒ½éœ€è¦æ›´å¤æ‚çš„åŒºé—´ç»Ÿè®¡ã€‚åŒæ—¶å¦ä¸€ç§ç®—æ³•ä¼šç»™å‡º  $(n_r * n_s) / V(A, r)$, ä¸€èˆ¬å–å°çš„</li></ul></li></ul><h3 id="å…¶ä»–ä¼°è®¡"><a href="#å…¶ä»–ä¼°è®¡" class="headerlink" title="å…¶ä»–ä¼°è®¡"></a>å…¶ä»–ä¼°è®¡</h3><p><img src="https://image.mwish.me/blog-image/FCC0B444-CCC3-4E26-9767-2A887566FBBB.png" alt="FCC0B444-CCC3-4E26-9767-2A887566FBBB"></p><h3 id="æŸ¥è¯¢ç»“æœçš„åˆ†æ"><a href="#æŸ¥è¯¢ç»“æœçš„åˆ†æ" class="headerlink" title="æŸ¥è¯¢ç»“æœçš„åˆ†æ"></a>æŸ¥è¯¢ç»“æœçš„åˆ†æ</h3><p>å‡å¦‚æˆ‘ä»¬éœ€è¦ $V(A, \sigma_{\theta}(r))$, é‚£æˆ‘ä»¬è¦å¯¹ä»–å†…éƒ¨åˆ†æï¼š</p><ol><li>å¯ä»¥å–å®ƒä¸º A ç­‰äºå•ä¸ªå€¼ï¼Œæˆ–è€… A ç­‰äºä¸€ä¸ªé›†åˆ</li><li>å¯ä»¥ä¹˜ä»¥ä¸€ä¸ªç³»æ•° $V(A, r) * s$, s ä¸ºç³»æ•°</li><li>å¯ä»¥ç”¨ä¸€äº›æ›´ç²¾ç¡®çš„æ¦‚ç‡æ¥åˆ†æ</li></ol><p>å‡å¦‚æˆ‘ä»¬è¦ä¼°è®¡ Join çš„ç»“æœï¼š</p><p><img src="https://image.mwish.me/blog-image/68AFA23D-75CC-4247-9468-5E944A08F7CF.png" alt="68AFA23D-75CC-4247-9468-5E944A08F7CF"></p><p>ç®€å•æ¥è¯´ï¼Œçœ‹ Join æ¡ä»¶æ˜¯ç‹¬ç«‹çš„ï¼Œè·ŸAæœ‰å…³ï¼Œè·ŸBæœ‰å…³ï¼Œè¿˜æ˜¯éƒ½æœ‰å…³ï¼Œç„¶åæ ¹æ®æ¦‚ç‡æ¥ä¼°è®¡</p><h2 id="ä¿¡æ¯æ”¶é›†"><a href="#ä¿¡æ¯æ”¶é›†" class="headerlink" title="ä¿¡æ¯æ”¶é›†"></a>ä¿¡æ¯æ”¶é›†</h2><p>å¦‚æœæ¯ä¸ª Update éƒ½æ”¶é›†ç»Ÿè®¡ä¿¡æ¯å°±å¤ªåºŸäº†ã€‚ä¸€æ¥ç³»ç»Ÿæœ‰ HLL è¿™äº›æ¨¡ç³Šæ–¹å¼ï¼Œå’Œé‡‡æ ·ï¼ŒäºŒæ¥ç³»ç»Ÿå¯ä»¥åœ¨ä¸€æ®µæ—¶é—´åæ‰‹åŠ¨ analyze æˆ–è€…è‡ªåŠ¨é‡å»ºç»Ÿè®¡ä¿¡æ¯ã€‚</p><p>MySQL çš„ InnoDB ä¸­ï¼Œæœ‰ä¸€ä¸ª <code>innodb_table_stats</code> è¡¨ï¼Œå¤§æ¦‚å†…å®¹å¦‚ä¸‹ï¼š</p><p>å®ƒçš„é…ç½®å¯ä»¥å‚è€ƒï¼š<a href="https://dev.mysql.com/doc/refman/5.7/en/innodb-performance-optimizer-statistics.html">https://dev.mysql.com/doc/refman/5.7/en/innodb-performance-optimizer-statistics.html</a></p><p>å¤§æ¦‚ä¿¡æ¯å¦‚ï¼š</p><div class="table-container"><table><thead><tr><th style="text-align:left">Field</th><th style="text-align:left">Type</th><th style="text-align:left">Null</th><th style="text-align:left">Key</th><th style="text-align:left">Default</th><th style="text-align:left">Description</th></tr></thead><tbody><tr><td style="text-align:left"><code>database_name</code></td><td style="text-align:left"><code>varchar(64)</code></td><td style="text-align:left">NO</td><td style="text-align:left">PRI</td><td style="text-align:left"><code>NULL</code></td><td style="text-align:left">Database name.</td></tr><tr><td style="text-align:left"><code>table_name</code></td><td style="text-align:left"><code>varchar(64)</code></td><td style="text-align:left">NO</td><td style="text-align:left">PRI</td><td style="text-align:left"><code>NULL</code></td><td style="text-align:left">Table, partition or subpartition name.</td></tr><tr><td style="text-align:left"><code>last_update</code></td><td style="text-align:left"><code>timestamp</code></td><td style="text-align:left">NO</td><td style="text-align:left"></td><td style="text-align:left"><code>current_timestamp()</code></td><td style="text-align:left">Time that this row was last updated.</td></tr><tr><td style="text-align:left"><code>n_rows</code></td><td style="text-align:left"><code>bigint(20) unsigned</code></td><td style="text-align:left">NO</td><td style="text-align:left"></td><td style="text-align:left"><code>NULL</code></td><td style="text-align:left">Number of rows in the table.</td></tr><tr><td style="text-align:left"><code>clustered_index_size</code></td><td style="text-align:left"><code>bigint(20) unsigned</code></td><td style="text-align:left">NO</td><td style="text-align:left"></td><td style="text-align:left"><code>NULL</code></td><td style="text-align:left">Size, in pages, of the primary index.</td></tr><tr><td style="text-align:left"><code>sum_of_other_index_sizes</code></td><td style="text-align:left"><code>bigint(20) unsigned</code></td><td style="text-align:left">NO</td><td style="text-align:left"></td><td style="text-align:left"><code>NULL</code></td><td style="text-align:left">Size, in pages, of non-primary indexes.</td></tr></tbody></table></div>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Notes-on-Query-Execution:part1</title>
      <link href="/2021/02/08/Notes-on-Query-Execution/"/>
      <url>/2021/02/08/Notes-on-Query-Execution/</url>
      
        <content type="html"><![CDATA[<p>SQL æ˜¯ç”¨æˆ·ä½¿ç”¨çš„ï¼Œæ•°æ®åº“ä¼šæŠŠ SQL è½¬æ¢æˆæŸç§å†…éƒ¨è¡¨ç¤ºï¼Œç±»ä¼¼äºæ‰©å±•çš„å…³ç³»ä»£æ•°ã€‚</p><p>å…³äºè¯æ³•ã€è¯­æ³•è§£æçš„éƒ¨åˆ†ï¼Œæ¯”è¾ƒå¹¸è¿çš„æ˜¯ï¼Œå¾ˆå¤šä¹¦éƒ½ä»‹ç»äº†æ€ä¹ˆå¤„ç† SQL:</p><ul><li><a href="https://book.douban.com/subject/6109479/">https://book.douban.com/subject/6109479/</a></li><li><a href="https://book.douban.com/subject/27082372/">https://book.douban.com/subject/27082372/</a></li></ul><p><img src="https://image.mwish.me/blog-image/A23D3A76-BC84-4873-A2C1-74DA42F1F795.png" alt="A23D3A76-BC84-4873-A2C1-74DA42F1F795"></p><p>Query-evaluation Engine å¤„ç†ç»™å®šçš„ Plan, æ‰§è¡Œè¿™ä¸ª Plan, ç„¶åæŠŠç»“æœè¿”å›ç»™æŸ¥è¯¢ã€‚</p><h2 id="æŸ¥è¯¢çš„ä»£ä»·"><a href="#æŸ¥è¯¢çš„ä»£ä»·" class="headerlink" title="æŸ¥è¯¢çš„ä»£ä»·"></a>æŸ¥è¯¢çš„ä»£ä»·</h2><p><a href="https://colin-scott.github.io/personal_website/research/interactive_latency.html">https://colin-scott.github.io/personal_website/research/interactive_latency.html</a></p><p>ä¸Šé¢æ˜¯æ¯å¹´çš„ Latency Numbers Every Programmer Should Know</p><p>2020 å¹´ï¼š</p><ol><li>Main memory reference: 100ns</li><li>SSD random read: 16000ns</li><li>1,000,000 bytes sequentially from SSD: 49, 000ns</li><li>Disk seek: 2ms</li><li>1,000,000 bytes sequentially from dosl: 825, 000 ns</li></ol><p>ä¹¦ä¸Šä½œè€…ä¸¾çš„æ˜¯2018å¹´çš„ä¾‹å­ï¼ŒHDD Seek + ä¼ é€æ•°æ®å¯ä»¥ä»¥10msä¸ºå•ä½ï¼ŒSSDåˆ™å¿«å¾—å¤šï¼Œç»å¸¸å¤„åœ¨äºš0.1 ms çº§ã€‚ï¼ˆç»“åˆæˆ‘è¿™è¾¹ç”Ÿäº§ï¼Œæ„Ÿè§‰åŸºæœ¬æ²¡æœ‰ç”¨ HDD çš„äº†â€¦ä¸æ™“å¾—å­˜å‚¨ä¼šä¸ä¼šè¿™ä¹ˆæï¼‰</p><p>æ­¤å¤–ï¼Œæœ‰äº›ä¸œè¥¿ä¼šè®©è¿™äº›ç»Ÿè®¡å˜å¾—æ›´å¤æ‚ï¼š</p><ol><li>æ— è®ºç”¨ <code>mmap</code> è¿˜æ˜¯æ‰‹å†™ buffer poolï¼Œè¯»å†™çš„å¾ˆå¤§ä¸€éƒ¨åˆ†åŠ¿å¿…åœ¨å†…å­˜ä¸­</li><li>å¦‚æœç³»ç»Ÿæœ‰å¤šä¸ª disk, é‚£ä¹ˆå¹¶è¡Œè®¿é—®å¤šä¸ª disk å¯èƒ½èƒ½æ¯”åœ¨ä¸€ä¸ª disk ä¸Š IO å¿«å¾ˆå¤š</li></ol><p>ä¸‹é¢ä»‹ç»äº† Postgres çš„ç­–ç•¥ï¼š</p><blockquote><p>In addition, although we assume that data must be read from disk initially, it is possible that a block that is accessed is already present in the in-memory buffer. Again, for simplicity, we ignore this effect; as a result, the actual disk-access cost during the execution of a plan may be less than the estimated cost. To account (at least partially) for buffer residence, PostgreSQL uses the following â€œhackâ€: the cost of a random page read is assumed to be 1/10th of the actual random page read cost, to model the situation that 90% of reads are found to be resident in cache.</p></blockquote><h2 id="Selection"><a href="#Selection" class="headerlink" title="Selection"></a>Selection</h2><p>ä¸‹é¢ä»‹ç»ä¸€ä¸‹ B+Tree çš„ä¸€äº›å‚æ•°ï¼š</p><ol><li>$h_i$ B+Tree çš„é«˜åº¦ã€‚</li><li>$t_s$ : block-access time (disk seek time plus rotational latency) ï¼Œ å¯¹äº SSDï¼Œ2018 å¹´å¤§çº¦æ˜¯ 90 microsecondsï¼›å¯¹äº HDD,2018 å¹´å¤§æ¦‚æ˜¯ 4ms</li><li>$t_T$ å•ä¸ª block æ•°æ®ä¼ è¾“çš„æ—¶é—´ï¼Œå¯¹äº SSDï¼Œæœ‰ 10 microseconds for a 4-kilobyte block. å¯¹äº HDDï¼Œè¿™ä¸ªé€Ÿåº¦æ…¢å¾—å¤š</li></ol><p>ï¼ˆ2021å¹´è¿˜æœ‰äººç”¨ HDD åš DB å—ï¼Ÿè¿™ä¹Ÿå¤ªæ…¢äº†ï¼Œæ°ªé‡‘å°±æ˜¯åŠ›é‡è¯¶ï¼‰</p><p>é‚£ä¹ˆï¼Œå¼€é”€å¤§æ¦‚æ˜¯ï¼š</p><p><img src="https://image.mwish.me/blog-image/CC050B3A-1569-42B4-9924-18A91D72DAD9.png" alt="CC050B3A-1569-42B4-9924-18A91D72DAD9"></p><p>ç»™å‡ºä¸€ä¸ª A2 çš„å‚è€ƒ Cluster Index Equality on Key: $(h_i + 1) * (t_T + t_s)$ . åœ¨ cluster indexæ‰¾åˆ°å°±å¯ä»¥ï¼Œè·¯å¾„éƒ½éœ€è¦è¯»åˆ°ã€‚</p><p>A3 åˆ™æ˜¯å› ä¸ºå¤§æ¦‚è¦æ‰¾åˆ° left-most pageï¼Œç„¶åæ‰§è¡Œ A1 ç±»ä¼¼çš„é€»è¾‘ã€‚ä»¥æ­¤ç±»æ¨ã€‚</p><p>æœ‰ä¸Šè¿°å†…å®¹ï¼Œæˆ‘ä»¬å¤§æ¦‚å¯ä»¥çŸ¥é“ MySQL é‡Œé¢æŸ¥è¯¢ã€å›è¡¨ä¹‹ç±»çš„ä»£ä»·ä¼°è®¡äº†ã€‚</p><p>ä¸è¿‡ä¸Šè¿° cluster index å’Œ secondary index å°±æ¶‰åŠåˆ°äº†ç´¢å¼•é€‰æ‹©çš„é—®é¢˜ã€‚å¦‚æœæ»¡è¶³è¦æ±‚çš„æ•°æ®å¾ˆå¤šï¼Œé‚£å°±ç›´æ¥èµ° cluster index äº†ï¼Œå¦åˆ™æ•°æ®å°‘çš„è¯èµ° secondary index ä¼˜åŒ–ï¼Œå²‚ä¸ç¾å“‰ã€‚</p><p>Postgres å®ç°äº† bitmap index scan, èµ° index æŒ‘å‡ºéœ€è¦ scan çš„ block, å†å†³å®šå…·ä½“çš„è¡Œä¸ºã€‚å¯ä»¥çœ‹ï¼š<a href="https://dba.stackexchange.com/questions/119386/understanding-bitmap-heap-scan-and-bitmap-index-scan">https://dba.stackexchange.com/questions/119386/understanding-bitmap-heap-scan-and-bitmap-index-scan</a></p><h3 id="Conjunction-Disjunction-Negation"><a href="#Conjunction-Disjunction-Negation" class="headerlink" title="Conjunction/Disjunction/Negation"></a>Conjunction/Disjunction/Negation</h3><p>è¿™â€¦è¡¨é¢ä¸Šæ‡‚çš„éƒ½æ‡‚ï¼Œä½†è¿™é‡Œæ¶‰åŠä¸€ä¸ªé—®é¢˜ï¼šå‡å¦‚æœ‰å¤šäºä¸€ä¸ªç´¢å¼•ï¼Œç´¢å¼•é€‰æ‹©æ€ä¹ˆåŠ</p><blockquote><p>To reduce the cost, we choose a Î¸<em>i</em> and one of algorithms A1 through A6 for which the combination results in the least cost for ÏƒÎ¸<em>i</em> (<em>r</em>). The cost of algorithm A7 is given by the cost of the chosen algorithm.</p></blockquote><p>ä¸€ç§æ–¹å¼å¦‚ä¸Šè¿° A7ï¼Œæ ¹æ® cost é€‰æ‹©ä¸€ä¸ªä»£ä»·æœ€ä½çš„ç´¢å¼•</p><p>å¦ä¸€ç§æ–¹å¼ A8 æ˜¯èµ° <strong>composite index</strong>ï¼ˆä¸­æ–‡ä¼¼ä¹å«è”åˆç´¢å¼•ï¼‰ã€‚</p><p>A9 éœ€è¦æœ‰å¯¹åº”çš„ UID æ¥åš tuple æ ‡ç¤ºï¼Œå®ƒä¼šèµ°å¤šä¸ªç´¢å¼•ï¼Œç„¶åå–ç›¸åŒçš„ uidã€‚</p><p>Disjunction éœ€è¦æ‰€æœ‰çš„è·¯å¾„éƒ½å¯ä»¥èµ° index, å¦åˆ™é€€åŒ–æˆ Linear Scan.</p><h2 id="Sorting"><a href="#Sorting" class="headerlink" title="Sorting"></a>Sorting</h2><p>(æˆ‘æ„Ÿè§‰æ’åºè¿™ç§åœ¨é¢è¯•é‡Œé¢å‡ºç°è¿‡ä¸€ä¸‡éäº†ï¼Œç„¶åæ•°æ®ç»“æ„ä¹¦ä¸€èˆ¬éƒ½è®²äº†å¤–æ’åºå§â€¦)</p><p>$M$ ç³»ç»Ÿå¯ä»¥æä¾›ç»™ sort çš„ block æ•°ç›®</p><p>$b_b$ è¢«å®šä¹‰ä¸º N-way Merge é˜¶æ®µå¯ä»¥å¤„ç†çš„ block æ•°ç›®</p><p>$b_r$ ä¸ºè¿™ä¸ª relation çš„ block æ•°é‡</p><p><img src="https://image.mwish.me/blog-image/2B0B9940-9714-42AD-989A-5CAE288F3F97.png" alt="2B0B9940-9714-42AD-989A-5CAE288F3F97"></p><ol><li>ç¬¬ä¸€æ¬¡äº§ç”Ÿäº† $b_r$ çš„ block è¾“å‡ºï¼ŒIO å¤§è‡´ä¸º $b_r / M$</li><li>æ¯ä¸€æ¬¡èƒ½å¤Ÿå¤„ç† $M / b_b$ æ¬¡</li><li>äº§ç”Ÿäº†ä¸Šè¿°ç»“æœ</li></ol><p>å¯ä»¥çœ‹çœ‹ TiDB çš„å¤–éƒ¨æ’åºï¼š<a href="https://github.com/pingcap/tidb/issues/12431">https://github.com/pingcap/tidb/issues/12431</a></p><h2 id="Join"><a href="#Join" class="headerlink" title="Join"></a>Join</h2><p>é¦–å…ˆè´´ä¸€ä¸‹ä¹¦ä¸Šç»™çš„æ¨¡å‹å§ï¼š</p><p><img src="https://image.mwish.me/blog-image/BE84D5FA-B143-4EA3-9AE8-5EE764779368.png" alt="BE84D5FA-B143-4EA3-9AE8-5EE764779368"></p><p>ï¼ˆæƒ³èµ·äº†æˆ‘ä»¬è¯´å”±å¤§å­¦ï¼Œå› ä¸ºæ•°æ®åº“æ²¡ä»€ä¹ˆè€ƒçš„ï¼Œæ‰€ä»¥è¦æŠŠä¹¦ä¸Šç»™çš„ Schema èƒŒä¸‹æ¥ï¼Œç„¶åé»˜å†™ SQLï¼ŒçœŸçš„å‚»é€¼ï¼‰</p><h3 id="Nested-loop-join-Block-Nested-loop-join"><a href="#Nested-loop-join-Block-Nested-loop-join" class="headerlink" title="Nested-loop join / Block Nested-loop join"></a>Nested-loop join / Block Nested-loop join</h3><p>çœŸçš„æœ‰äººåœ¨ç”¨å—â€¦</p><p>ç®€å•è¯´ï¼šNest-loop Join å°±æ˜¯æä¸¤ä¸ªå¾ªç¯æ¥ Join; Block Nest-loop Join å°±æ˜¯é’ˆå¯¹å…³ç³»çš„ block æä¸¤ä¸ªå¾ªç¯ï¼Œå†…å±‚èµ° nest-loop join.</p><p>ä¸è¿‡å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œå¤–å±‚çš„ tuple åªä¼š Scan ä¸€éï¼Œå†…å±‚çš„ä¼š Scan å¾ˆå¤šéã€‚ç†æ™ºå‘Šè¯‰æˆ‘ä»¬åº”è¯¥æŠŠå†…å±‚çš„æ”¾å°ä¸€ç‚¹ã€‚</p><p>å®é™…ä¸Šï¼Œè€ƒè™‘åˆ°ç±»ä¼¼çš„åœºæ™¯ï¼Œä¾‹å¦‚ broadcast join: <a href="https://jaceklaskowski.gitbooks.io/mastering-spark-sql/content/spark-sql-joins-broadcast.html">https://jaceklaskowski.gitbooks.io/mastering-spark-sql/content/spark-sql-joins-broadcast.html</a> å…¶å®æ€è·¯ä¹Ÿå·®ä¸å¤š</p><p><img src="https://image.mwish.me/blog-image/65D7BD6A-CD41-4656-8A08-A0C4A33FDBA4.png" alt="65D7BD6A-CD41-4656-8A08-A0C4A33FDBA4"></p><p>ä¸Šè¿°æ–¹æ³•èƒ½å¤Ÿå‡å°‘å†…å±‚ IO ï¼Œå› ä¸ºæˆ‘ä»¬ä¸€æ¬¡æ€§è¯»å–äº†å¤šä¸ªå¤–å±‚ block, å‡å°‘äº†å¾ªç¯çš„æ¬¡æ•°ã€‚</p><h3 id="Indexed-Nested-loop-Join"><a href="#Indexed-Nested-loop-Join" class="headerlink" title="Indexed Nested-loop Join"></a>Indexed Nested-loop Join</h3><p><img src="https://image.mwish.me/blog-image/B4BF6308-9A34-43D2-9B7E-6133055B1E96.png" alt="B4BF6308-9A34-43D2-9B7E-6133055B1E96"></p><blockquote><p>Although the number of block transfers has been reduced, the seek cost has actually increased, increasing the total cost since a seek is considerably more expensive than a block transfer. However, if we had a selection on the <em>student</em> relation that reduces the number of rows significantly, indexed nested-loop join could be significantly faster than block nested-loop join.</p></blockquote><p>å…¶å®çœ‹ä¸Šå»æœ‰ä¼˜åŠ¿ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰å¥½å¤šå°‘ã€‚</p><h3 id="Sort-Merge-Join"><a href="#Sort-Merge-Join" class="headerlink" title="Sort-Merge Join"></a>Sort-Merge Join</h3><p>è¿™ä¸ªå»æ‰äº† loop çš„å½¢å¼ï¼Œé‡‡å– sort ï¼Œç„¶ååœ¨æœ‰åºçš„åŒºé—´å†…ä½œ equal çš„æ“ä½œã€‚</p><p>Merge çš„æ“ä½œæ˜¯ $M + N$, sort çš„æ“ä½œå¦‚ä¹‹å‰æ‰€å™è¿°ã€‚æ­¤å¤–ï¼Œåœ¨ worst case ä¸­ï¼Œå¦‚æœä¸¤ä¸ªå…³ç³»ä¸­æ‰€æœ‰çš„ join key éƒ½ä¸€æ ·ï¼Œé‚£ä¹ˆ Merge çš„æ“ä½œä¼šé€€åŒ–åˆ° $M * N$</p><p>æ­¤å¤–ï¼Œæœ‰ä¸€ç§ <strong>Hybrid merge-join</strong> çš„ç®—æ³•, å¦‚æœå…³ç³» A èµ°åœ¨ cluster index æˆ–è€…å·²ç»æœ‰æ’åºï¼Œå…³ç³» B å¯ä»¥èµ° secondary indexã€‚é‚£ä¹ˆå¯ä»¥ A å’Œ B merge, å†å» B åšç±»ä¼¼ index bitmap scan çš„æ“ä½œã€‚ä¸ºä»€ä¹ˆéœ€è¦è¿™æ ·å‘¢ï¼Ÿå¦‚æœä¸¤è¾¹éƒ½æ˜¯ secondary index æ‰èƒ½ Join çš„è¯ï¼Œå¯èƒ½ä¼šæœ‰è«åå…¶å¦™çš„ IO ä»£ä»·æ”¾å¤§ã€‚</p><h3 id="Hash-Join"><a href="#Hash-Join" class="headerlink" title="Hash Join"></a>Hash Join</h3><p>å…ˆçœ‹çœ‹ä¹¦ä¸Šçš„å½¢å¼åŒ–å®šä¹‰ï¼š</p><p><img src="https://image.mwish.me/blog-image/467B05FF-55E6-4952-8DBA-B7B9006131AD.png" alt="467B05FF-55E6-4952-8DBA-B7B9006131AD"></p><p>(å®é™…ä¸Šè¿™é‡Œç”¨çš„æ˜¯ grace hash join)</p><p><img src="https://image.mwish.me/blog-image/B37A2209-60C4-455D-8C49-9E3E1051290A.png" alt="B37A2209-60C4-455D-8C49-9E3E1051290A"></p><p>è¿™é‡Œåˆ†ä¸º build phase å’Œ probe phaseã€‚å¦‚æœ s èƒ½è£…åœ¨å†…å­˜ä¸­ï¼Œé‚£å°±ç›´æ¥åœ¨å†…å­˜ä¸­å“ˆå¸Œï¼Œç„¶åæ‰« rã€‚</p><p>å¦åˆ™ç»™ s å’Œ r æ„å»º hash index, ç„¶åæ¯ä¸ªç›¸åŒçš„ hash åš nested loop join çš„æ“ä½œã€‚</p><p>è¿™é‡Œé—®é¢˜æ˜¯ï¼š</p><p>Skew/Overflow: æ•°æ®å¯èƒ½å€¾æ–œï¼Œè¿™é‡Œå¯ä»¥é¿å…äº§ç”Ÿè¿‡å¤§çš„ block, æˆ–è€…é€’å½’èµ° hash build</p><p>å…³äº hash join, è¿™é‡Œæœ‰ä¸€äº›æ€§èƒ½åˆ†æï¼š</p><p>å¯¹äº grace hash join, æ¯ä¸ª block è¦ï¼š</p><ol><li>è¯»å–ä¸€éï¼Œç„¶åå“ˆå¸Œå†™å…¥ä¸€éï¼Œè¿™æ˜¯ä¸€ä¸ª pass</li><li>å†è¯»å–ä¸€éï¼Œåš nested loop join, è¿™æ˜¯ä¸€ä¸ª pass</li></ol><p>æ­¤å¤–ï¼Œå“ˆå¸Œä¼šé€ æˆ $n_h$ çš„å†—ä½™ block å¼€é”€ï¼Œæ‰€ä»¥ï¼Œè¿™é‡Œçš„å¼€é”€æ˜¯ï¼š</p><p>$3(b_r + b_s) + 4n_h$</p><p>åœ¨é€’å½’çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬è¦åˆ©ç”¨åˆ°å› å­ $M$ å¾—åˆ°ï¼š</p><p><img src="https://image.mwish.me/blog-image/7CF38D96-CEAE-4BAC-9F35-811B82023EBA.png" alt="7CF38D96-CEAE-4BAC-9F35-811B82023EBA"></p><p>15-445 æŒ‡å‡ºï¼Œä¸€èˆ¬æ¥è¯´ hash join æœ‰ç€æ¯”è¾ƒå¥½çš„æ•ˆç‡ï¼Œä¸è¿‡å·²æ’åº/è¦æ’åºçš„æ•°æ®ï¼Œå¯ä»¥ä½¿ç”¨ sort join</p><p>å¦‚æœå†…å±‚å…³ç³»å¾ˆå°ï¼Œä¸”å¤–å±‚å¯ä»¥èµ°ç´¢å¼•ï¼Œé‚£ Index Nested Loop Join ä¼šä¸é”™ï¼Œå¦åˆ™å¯ä»¥è¯•è¯• Hash Joinï¼Œè¿™ä¸ªåº”è¯¥éœ€è¦æ ¹æ®ç»Ÿè®¡ä¿¡æ¯æ¥åˆ¤å®šã€‚</p><h4 id="Hybrid-Hash-Join"><a href="#Hybrid-Hash-Join" class="headerlink" title="Hybrid Hash Join"></a>Hybrid Hash Join</h4><p>hybrid hash join åšäº†å†…å­˜è¶³å¤Ÿçš„æ—¶å€™ï¼Œæ‰§è¡Œä¸Šçš„ä¼˜åŒ–ï¼Œè¿™é‡Œè€ƒè™‘çš„åœºæ™¯æ˜¯ã€Œå†…å­˜æ¯”è¾ƒå¤§ï¼Œä½†æ˜¯æ•´ä¸ª Hash Join ä¹Ÿä¸æ˜¯å®Œå…¨æ”¾å¾—ä¸‹ã€çš„åœºæ™¯ã€‚ä¹‹å‰è€ƒè™‘è¿‡ s å…¨éƒ¨æ„ä»¶åœ¨å†…å­˜æˆ–è€…å†™åˆ°ç›˜ä¸Šçš„æƒ…å†µçš„æƒ…å†µï¼Œæ„Ÿè§‰ hybrid hash join æ„å»ºäº†ä¸€ä¸ªåŠ on-disk hashï¼Œæ¥ä¼˜åŒ–è¿™ä¸ªæ“ä½œã€‚æˆ‘ä»¬æ„é€ ä¸€ä¸ª $s_0$, å®ƒåŒ…å«:</p><ul><li>å…ˆå°†ä¸€ä¸ªå…³ç³»åˆ‡åˆ†æˆ t åœ¨å†…å­˜ä¸­ï¼Œk - t åœ¨ç›˜ä¸Šï¼Œç„¶åå“ˆå¸Œ</li><li>å¦ä¸€ä¸ªå…³ç³» load èµ·æ¥ t ä»½å’Œä¹‹å‰çš„å…³ç³»ç›´æ¥å¤„ç†ï¼Œå‰©ä¸‹çš„éƒ¨åˆ†å†èµ°ç›˜ä¸Šå“ˆå¸Œçš„æµç¨‹ã€‚</li></ul><p>ä»¥æ­¤æ¥ä¼˜åŒ–ã€‚</p><h3 id="æ‚é¡¹ï¼šä¼˜åŒ–"><a href="#æ‚é¡¹ï¼šä¼˜åŒ–" class="headerlink" title="æ‚é¡¹ï¼šä¼˜åŒ–"></a>æ‚é¡¹ï¼šä¼˜åŒ–</h3><p>ä½¿ç”¨ bloom filter æ¥ä¼˜åŒ– Join</p><h2 id="å…¶ä»–è¿ç®—"><a href="#å…¶ä»–è¿ç®—" class="headerlink" title="å…¶ä»–è¿ç®—"></a>å…¶ä»–è¿ç®—</h2><h3 id="Duplicate-Elimination"><a href="#Duplicate-Elimination" class="headerlink" title="Duplicate Elimination"></a>Duplicate Elimination</h3><ul><li>ä½¿ç”¨ hashing æˆ–è€… sorting å»é‡</li><li>æœ‰äº› DB æœ‰ HLL ä¹‹ç±»çš„æ¨¡ç³Šæ‰‹æ®µ</li></ul><h3 id="Set"><a href="#Set" class="headerlink" title="Set"></a>Set</h3><p>å¤§ä½“æ˜¯æ„å»º hash map ç”šè‡³ on-disk hash, ç„¶å probe.</p><h3 id="Aggregation"><a href="#Aggregation" class="headerlink" title="Aggregation"></a>Aggregation</h3><p>æ„Ÿè§‰æ˜¯ä¸€ä¸ªå¦ç±»çš„ç»Ÿè®¡ï¼Œæˆ‘å®ç°çš„æ—¶å€™æ„å»ºè¿‡ä¸€ä¸ªç»Ÿè®¡çš„ hash, ç»Ÿè®¡å®Œä¹‹åéå†å–ä¿¡æ¯ã€‚è¿™é‡Œæœ‰ä¸åŒçš„æ–¹æ¡ˆï¼š</p><ol><li>åœ¨æ„é€ è¿‡ç¨‹ä¸­ï¼ˆç±»ä¼¼æµå¼çš„ï¼‰å–ä¿¡æ¯</li><li>èµ° Hashing æ¥æ„é€ </li></ol><p>æ­£å¸¸æƒ…å†µä¸‹ï¼Œèƒ½ä¸ swap åˆ°ç›˜ä¸Šè¿˜æ˜¯ä¸ swap åˆ°ç›˜ä¸Šå§ï¼Œä½†æ˜¯ç®—å­ä¹‹é—´è‚¯å®šè¿˜æ˜¯æœ‰åŒºåˆ«çš„ã€‚</p><h2 id="æŸ¥è¯¢æ‰§è¡Œ"><a href="#æŸ¥è¯¢æ‰§è¡Œ" class="headerlink" title="æŸ¥è¯¢æ‰§è¡Œ"></a>æŸ¥è¯¢æ‰§è¡Œ</h2><p>15-445 åº”è¯¥ä»‹ç»è¿‡ DB çš„æŸ¥è¯¢æ‰§è¡Œã€‚æ¯”è¾ƒä¼ ç»Ÿçš„æ‰§è¡Œæ–¹å¼æ˜¯ volcano æ¨¡å‹ï¼Œè¿™ä¸ªæ¨¡å‹å’Œå½“æ—¶çš„ç¡¬ä»¶ç»“æ„æ˜¯æœ‰å…³çš„ã€‚åŒæ—¶ï¼Œæˆ‘ä»¬ä¹ŸçŸ¥é“ vectorize å’Œ codegen ç­‰æ¨¡å‹ã€‚æˆ‘ä»¬å¯ä»¥åœ¨ <code>MonetDB/X100</code> å’Œ  Efficiently Compiling Efficient Query Plans for Modern Hardware è¿™ä¸¤ç¯‡è®ºæ–‡æ‰¾åˆ°å¯¹åº”çš„ç­”æ¡ˆã€‚</p><p>è¿™é‡Œè¡¨è¾¾å¼æ‰§è¡Œå¯ä»¥åˆ†ä¸ºï¼š</p><ol><li>ç‰©åŒ–æ‰§è¡Œï¼ˆmaterialized evaluationï¼‰ï¼šä¸­é—´å…³ç³»çš„ç»“æœéœ€è¦è¢«ç‰©åŒ–</li><li>æµæ°´çº¿æ‰§è¡Œï¼ˆpipeline evaluationï¼‰ï¼šå¯ä»¥å‡å°‘ä¸´æ—¶æ–‡ä»¶ï¼ˆç‰©åŒ–è¾“å‡ºï¼‰çš„æ•°é‡ï¼Œå°†ç»“æœèƒ½ç›´æ¥è¾“å‡ºç»™ä¸‹ä¸€ä¸ªè¡¨è¾¾å¼ã€‚è¿™ç§æ–¹å¼èƒ½å¤Ÿæ¶ˆé™¤è¯»å†™ä¸­é—´è¾“å‡ºçš„ä»£ä»·ã€‚å…¶ä¸­ï¼Œä¹Ÿèƒ½å¤Ÿè¿™æ ·åŒºåˆ†å¯¹åº”çš„è¾“å‡ºæ–¹å¼<ol><li>éœ€æ±‚é©±åŠ¨ï¼šç”± top çš„ç®—å­æ¥å‘é€ <code>next</code> æˆ–è€… <code>next_batch</code> è¿™æ ·çš„è¯·æ±‚ï¼Œé©±åŠ¨ä¸‹å±‚çš„ç®—å­æ¥å–å¯¹åº”çš„æ•°æ®ã€‚å¯ä»¥çœ‹ä½œæ˜¯ pull çš„æ¨¡å‹</li><li>ç”Ÿäº§è€…é©±åŠ¨ï¼šåº•å±‚çš„ç®—å­äº§ç”Ÿ tupleï¼Œç„¶åè¾“å‡ºç»™ä¸Šå±‚çš„ç®—å­ã€‚å¯ä»¥çœ‹ä½œæ˜¯ push çš„æ¨¡å‹</li></ol></li></ol><p>åœ¨æŸ¥è¯¢ä¸­ï¼Œå¯ä»¥æµæ°´åŒ–çš„è¾¹è¢«ç§°ä¸º pipelined edge, éœ€è¦ç‰©åŒ–çš„ï¼ˆæ¯”å¦‚ Hash Joinï¼‰è¢«ç§°ä¸º blocking edge. ä¸€èˆ¬æ¥è¯´ï¼Œä¸åŒçš„ pipeline edge ç»„æˆçš„å­æ ‘å¯ä»¥å¹¶å‘æ‰§è¡Œï¼Œblocking çš„å¯èƒ½éœ€è¦ç‰©åŒ–ã€‚</p><p>è¿™é‡Œè¿˜ä»‹ç»äº†ä¸€ä¸‹ streaming ä¸Šçš„æŸ¥è¯¢æ‰§è¡Œï¼Œæ„Ÿè§‰å¯ä»¥çœ‹ï¼š<a href="https://www.skyzh.dev/posts/articles/2022-01-15-store-of-streaming-states/">https://www.skyzh.dev/posts/articles/2022-01-15-store-of-streaming-states/</a></p><p>æ­¤å¤–ï¼Œæœ‰äº› cache äº²å’Œçš„æŸ¥è¯¢æ‰§è¡Œç­–ç•¥ï¼Œè¿™é‡Œæ˜¯è®©åˆ’åˆ†çš„ block èƒ½ fit åœ¨ L1/L2/L3 cache ä¸­ï¼Œä»è€ŒåŠ é€ŸæŸ¥è¯¢ã€‚</p><p>è¿™é‡Œè¿˜ä»‹ç»äº†æŸ¥è¯¢ç¼–è¯‘å’Œ columnar æ‰§è¡Œï¼Œä¸è¿‡å°±æäº†ä¸¤è¡Œã€‚</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Distributed System: Master</title>
      <link href="/2020/12/29/Distributed-System-Master/"/>
      <url>/2020/12/29/Distributed-System-Master/</url>
      
        <content type="html"><![CDATA[<p>ä¸Šä¸€ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬ä»‹ç»äº† CPU çš„ cache coherent æœºåˆ¶å’Œä¸¤ç§å®ç°æ–¹å¼çš„åŸºç¡€å†…å®¹ï¼ŒåŒæ—¶ä»‹ç»äº†åˆ†å¸ƒå¼ç³»ç»Ÿçš„ Lease æœºåˆ¶ã€‚è¿™ç¯‡æ–‡ç« æˆ‘ä»¬å°†å›é¡¾ä¸€ä¸‹ç”¨åˆ° Lease çš„ç³»ç»Ÿï¼ŒåŒæ—¶ä»‹ç»ä¸€ä¸‹åˆ†å¸ƒå¼ç³»ç»Ÿçš„ä¸»èŠ‚ç‚¹æ“ä½œï¼šè¿™ä¹ŸåŒæ—¶ä¼šæ¶‰åŠ ZooKeeper, Redis å’Œåˆ†å¸ƒå¼é”ç›¸å…³çš„å†…å®¹ã€‚</p><h2 id="Problems"><a href="#Problems" class="headerlink" title="Problems"></a>Problems</h2><p>æˆ‘ä»¬åœ¨ä»‹ç» Lease çš„æ—¶å€™ï¼Œå¼•å…¥äº†å‡è®¾ï¼šClock Drift åœ¨ä¸€å®šèŒƒå›´å†…ã€‚æˆ‘ä»¬ä¼šçœ‹åˆ°ä»Šå¤©ä»‹ç»çš„å†…å®¹ä¸­ï¼Œä»ç„¶æœ‰ä¸€éƒ¨åˆ†ç³»ç»Ÿæ˜¯ä¾èµ–è¿™ä¸ªå‡è®¾çš„ã€‚</p><p>å°½ç®¡ <code>gettimeofday</code> è°ƒç”¨æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œä½†æ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿçš„æ—¶é—´æ°¸è¿œæœ‰ç§ç§é—®é¢˜ã€‚</p><p>å¯ä»¥ç®€å•é˜…è¯»ï¼š <a href="https://tldp.org/LDP/sag/html/keeping-time.html">https://tldp.org/LDP/sag/html/keeping-time.html</a></p><p>ä¸ºäº†ç†è§£è¿™ä¸ªé—®é¢˜ï¼Œä¸å¦¨çœ‹ä¸€çœ‹ rCore äº§ç”Ÿ timer interrupt çš„ä»£ç ï¼ˆè¿™ä¸ªæ˜¯æ•™å­¦ç”¨çš„ï¼Œå¯èƒ½å®é™…çš„ä¼šå¤æ‚ä¸€äº›ï¼‰ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// è®¾ç½®ä¸‹ä¸€æ¬¡æ—¶é’Ÿä¸­æ–­çš„æ—¶é—´</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">set_timer</span>(time: <span class="type">usize</span>) &#123;</span><br><span class="line">    <span class="title function_ invoke__">sbi_call</span>(SBI_SET_TIMER, time, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// æ—¶é’Ÿä¸­æ–­çš„é—´éš”ï¼Œå•ä½æ˜¯ CPU æŒ‡ä»¤</span></span><br><span class="line"><span class="keyword">static</span> INTERVAL: <span class="type">usize</span> = <span class="number">100000</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// è®¾ç½®ä¸‹ä¸€æ¬¡æ—¶é’Ÿä¸­æ–­</span></span><br><span class="line"><span class="comment">/// </span></span><br><span class="line"><span class="comment">/// è·å–å½“å‰æ—¶é—´ï¼ŒåŠ ä¸Šä¸­æ–­é—´éš”ï¼Œé€šè¿‡ SBI è°ƒç”¨é¢„çº¦ä¸‹ä¸€æ¬¡ä¸­æ–­</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">set_next_timeout</span>() &#123;</span><br><span class="line">    <span class="title function_ invoke__">set_timer</span>(time::<span class="title function_ invoke__">read</span>() + INTERVAL);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// è§¦å‘æ—¶é’Ÿä¸­æ–­è®¡æ•°</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">static</span> <span class="keyword">mut</span> TICKS: <span class="type">usize</span> = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// æ¯ä¸€æ¬¡æ—¶é’Ÿä¸­æ–­æ—¶è°ƒç”¨</span></span><br><span class="line"><span class="comment">/// </span></span><br><span class="line"><span class="comment">/// è®¾ç½®ä¸‹ä¸€æ¬¡æ—¶é’Ÿä¸­æ–­ï¼ŒåŒæ—¶è®¡æ•° +1</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">tick</span>() &#123;</span><br><span class="line">    <span class="title function_ invoke__">set_next_timeout</span>();</span><br><span class="line">    <span class="keyword">unsafe</span> &#123;</span><br><span class="line">        TICKS += <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span> TICKS % <span class="number">100</span> == <span class="number">0</span> &#123;</span><br><span class="line">            <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125; tick&quot;</span>, TICKS);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>ç¡¬ä»¶æœ‰ä¸€ä¸ª Monotonic çš„æ—¶é’Ÿï¼Œåœ¨å¯åŠ¨ä¹‹åèƒ½å¤Ÿæ‹¿åˆ°è‡ªå·±çš„ <code>tick</code> ã€‚ä½†æ˜¯ï¼Œå¯èƒ½æ˜¯æ²¡æœ‰ä»€ä¹ˆè¡¨æ„çš„ã€‚</li><li>æˆ‘ä»¬ä¹Ÿæœ‰ <code>gettimeofday</code> è¿™æ ·çš„è°ƒç”¨ï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“æ—¶åŒºä¹‹ç±»çš„ä¿¡æ¯ï¼Œä½†æ˜¯ç”±äºç§ç§åŸå› ï¼Œæˆ‘ä»¬çš„æ—¶é—´å¾ˆå¯èƒ½æ˜¯ä¸å‡†çš„ã€‚å‡è®¾å¼€å¯äº† NTP, æˆ‘ä»¬ç”šè‡³æœ‰å¯èƒ½è¿›è¡ŒçŸ­æš‚çš„å›é€€ã€‚</li></ul><p>ä¸Šé¢çš„å†…å®¹åœ¨è¯­è¨€çš„åº“å±‚é¢ä¹Ÿæœ‰æ”¯æŒï¼Œæ¯”å¦‚ C++ çš„ <code>chrono</code> , ä½ å¯ä»¥ç®€ç•¥é˜…è¯» cppreferenceï¼Œæˆ–è€…é˜…è¯»è¿™é‡Œï¼š<a href="https://www.modernescpp.com/index.php/the-three-clocks">https://www.modernescpp.com/index.php/the-three-clocks</a></p><p>æ‰€ä»¥ï¼Œç®€å•æ¥è¯´ï¼Œä¾èµ–ä»€ä¹ˆæ—¶é’Ÿï¼Œæ€ä¹ˆä¾èµ–æ—¶é’Ÿï¼Œéƒ½æ˜¯ä¸€ä¸ªé—®é¢˜ã€‚</p><h2 id="Lease-å’Œ-ä¸»æ“ä½œ"><a href="#Lease-å’Œ-ä¸»æ“ä½œ" class="headerlink" title="Lease å’Œ ä¸»æ“ä½œ"></a>Lease å’Œ ä¸»æ“ä½œ</h2><p>å›åˆ° Lease, è™½ç„¶è¿™ä¸ªè¯è¯­ä¹‰å¯èƒ½ä¸ä¸€æ ·ï¼Œæ¯”å¦‚åœ¨ memcache é‡Œé¢ï¼Œå¯¹ Read Miss å®ƒä¼šå‘æ”¾ Leaseï¼Œä»¥ä¾¿åˆç†çš„è®¿é—® DB, ä¿è¯ (1) ä¸€è‡´æ€§ (2) é˜²æ­¢æš´è¯»æ‰“æŒ‚ DBã€‚æ‹œ sharding æ‰€èµï¼Œè¿™ä¸ª Lease ç»´æŠ¤çš„æ—¶é—´åºç®€å•ä¸€äº›ã€‚åŒæ—¶ï¼Œå› ä¸ºæ˜¯ cacheï¼Œæ‰€ä»¥ä¸¢å¤±ä¹Ÿæ— å…³ç´§è¦ã€‚</p><p>è€Œæˆ‘ä»¬ä¸Šä¸€ç¯‡æ–‡ç« ä»‹ç»çš„ Leaseï¼Œå¤§è‡´æµç¨‹å¦‚ä¸‹ï¼š</p><blockquote><ul><li>å†™å…¥ï¼šclient éœ€è¦å‘ä¸€ä¸ªé€»è¾‘ä¸Šçš„å•ç‚¹ï¼ˆæˆ‘ä»¬åœ¨ Redis é‡Œé¢ä¼šçœ‹åˆ°è¿™ä¸ªï¼‰å‘é€ Lease Request, æ‹¿åˆ°å¯¹åº”çš„ lease ä¹‹åï¼Œæ‰èƒ½åœ¨ lease æœŸé—´å†™èµ„æº</li><li>å¦å¤–ä¸€ä¸ªå†™å…¥éœ€è¦å†™æ—¶ï¼Œserver ä¼šå°è¯• invalid ä¹‹å‰ grant çš„ leaseï¼Œç„¶åå† grant lease</li><li>å¦‚æœ invalid è”ç³»ä¸ä¸Šï¼ˆæ¯”å¦‚å‘ç”Ÿç½‘ç»œåˆ†åŒºï¼‰ï¼Œè¿™é‡Œä¼šç­‰å¾…åˆ° grant çš„ lease æ—¶é—´ç»“æŸã€‚</li></ul></blockquote><p>åœ¨ä¸Šè¿°è¿™æ®µä¸­ï¼Œå¦‚æœä½ æ„Ÿå—ä¸åˆ°ä»€ä¹ˆé—®é¢˜çš„è¯ï¼Œå…¶å®æ‰æ˜¯é—®é¢˜æ‰€åœ¨ï¼š</p><ol><li>ä½ ä¾èµ–äº†ä¸€ä¸ªé¢å¤–çš„åŒæ­¥ Serverï¼Œä½ åšçš„æ“ä½œå’Œå®ƒä¸ä¸€å®šæœ‰å…³ç³»ã€‚åŒæ—¶å®ƒæ˜¯ä¸€ä¸ªç‰©ç†å•ç‚¹çš„è¯ï¼ŒæŒ‚æ‰å°±ä¸å¥½äº†ã€‚</li><li>å†™å…¥æ“ä½œéœ€è¦ä¿è¯æ˜¯â€œåªæœ‰ä¸€ä¸ªæ‹¿åˆ° Lease çš„åœ¨æ“ä½œâ€œï¼Œè¿™å¹¶ä¸è‡ªç„¶ã€‚</li></ol><h3 id="åŸºç¡€çš„-Raft-å’Œ-term"><a href="#åŸºç¡€çš„-Raft-å’Œ-term" class="headerlink" title="åŸºç¡€çš„ Raft å’Œ term"></a>åŸºç¡€çš„ Raft å’Œ term</h3><p>å½“æˆ‘ä»¬éœ€è¦ HA çš„æ—¶å€™ï¼Œè¿™æ–¹é¢æˆ‘ä»¬å¯èƒ½éœ€è¦ Paxos è¿™æ ·çš„ Consensusã€‚è¿™æ ·ï¼ŒæŸç§ç¨‹åº¦ä¸Šï¼Œæˆ‘ä»¬å¯ä»¥æŠŠä¸€ä¸ªå•ç‚¹å˜æˆé€»è¾‘ä¸Šçš„ HA çš„é›†åˆã€‚æˆ‘ä»¬æ¥ç®€å•å›åˆ° Raftï¼Œæ¥çœ‹çœ‹<strong>æœ€ç®€å•çš„</strong> Raft æ˜¯æ€ä¹ˆåšä¸»èŠ‚ç‚¹çš„æ“ä½œçš„ï¼š</p><ol><li>åŠæ•°ä»¥ä¸Šï¼ˆåŒ…æ‹¬è‡ªå·±ï¼‰æŠ•ç¥¨äº§ç”Ÿ Leader, è€ŒLeader å¯¹åº”ä¸€ä¸ª <code>term</code></li><li>å¦‚æœæ–° Leader é€‰ä¸¾å‡ºæ¥äº†ï¼ŒåŒæ—¶æ—§ Leader è¿˜å­˜åœ¨ã€‚é‚£ä¹ˆå®ƒåœ¨é›†ç¾¤å†…éƒ¨çš„è¯·æ±‚æ˜¯æ— æ³•ç”Ÿæ•ˆçš„ï¼Œå› ä¸ºå®ƒçš„ <code>term</code> å°äºç°æœ‰åŠæ•°æœºå™¨çš„ <code>term</code></li></ol><p>è¿™é‡Œæ²¡æœ‰ä¾èµ–ç‰©ç†æ—¶é’Ÿï¼Œè€Œæ˜¯ä¾èµ–äº†å•è°ƒé€’å¢çš„ä¸€ä¸ªé€»è¾‘å€¼ <code>term</code>ï¼Œæ¥è¿›è¡Œæ“ä½œã€‚</p><h3 id="Session-amp-amp-Lease"><a href="#Session-amp-amp-Lease" class="headerlink" title="Session &amp;&amp; Lease"></a>Session &amp;&amp; Lease</h3><p>å›åˆ°æˆ‘ä»¬çš„ Lease, æ¯”å¦‚ ZooKeeper ç»´æŠ¤äº†ä¸€ä¸ª Session Timeout, åœ¨è¿™é‡Œï¼Œå¯ä»¥å‚è€ƒä¸€ä¸‹ ZooKeeper çš„è®ºæ–‡ 4.4 èŠ‚ï¼š</p><blockquote><p>åœ¨æˆ‘ä»¬çš„å®ç°ä¸­ï¼Œè®¾ç½® timeout æ˜¯ä¸ºäº†ä½¿ leader åœ¨ follower æ”¾å¼ƒä»–ä»¬ä¹‹å‰æ„è¯†åˆ°ä»–ä»¬ä¸å†æ˜¯ leaderï¼Œå› æ­¤å®ƒä»¬å°±ä¸ä¼šå‘å¸ƒç©ºäº‹åŠ¡ã€‚</p><p>ä¸ºäº†æ£€æµ‹å®¢æˆ·ç«¯ session çš„ failure, ZooKeeper ä½¿ç”¨äº† timeoutã€‚å¦‚æœåœ¨ timeout æ—¶é—´å†…ï¼Œæ²¡æœ‰å…¶ä»–æœåŠ¡å™¨æ”¶åˆ°ä¸€ä¸ª client session å¯¹åº”çš„æ¶ˆæ¯ï¼Œå³åˆ¤å®šä¸º failureã€‚å¦‚æœå®¢æˆ·ç«¯è¶³å¤Ÿé¢‘ç¹åœ°å‘é€è¯·æ±‚ï¼Œåˆ™æ— éœ€å‘é€ä»»ä½•å…¶ä»–æ¶ˆæ¯ã€‚ å¦åˆ™ï¼Œå®¢æˆ·ç«¯ä¼šåœ¨æ´»åŠ¨ä¸è¶³æ—¶å‘é€å¿ƒè·³æ¶ˆæ¯ã€‚ å¦‚æœå®¢æˆ·ç«¯æ— æ³•ä¸æœåŠ¡å™¨é€šä¿¡ä»¥å‘é€è¯·æ±‚æˆ–å¿ƒè·³ï¼Œåˆ™å®ƒå°†è¿æ¥åˆ°å…¶ä»–ZooKeeperæœåŠ¡å™¨ä»¥é‡æ–°å»ºç«‹å…¶ä¼šè¯ã€‚ ä¸ºäº†é˜²æ­¢ä¼šè¯è¶…æ—¶ï¼ŒZooKeeperå®¢æˆ·ç«¯åº“åœ¨ä¼šè¯é—²ç½®äº†<code>s/3</code> msåå‘é€äº†å¿ƒè·³ä¿¡å·ï¼Œå¦‚æœåœ¨<em><code>2s/3</code></em> mså†…æœªæ”¶åˆ°æœåŠ¡å™¨çš„æ¶ˆæ¯ï¼Œåˆ™åˆ‡æ¢åˆ°æ–°æœåŠ¡å™¨ï¼Œå…¶ä¸­<em>s</em>æ˜¯ session timeoutï¼ˆä»¥æ¯«ç§’ä¸ºå•ä½ï¼‰ã€‚</p></blockquote><p>ï¼ˆé¡ºä¾¿å®‰åˆ©ä¸€ä¸‹æˆ‘ç¿»è¯‘çš„ï¼š<a href="https://github.com/mapleFU/zookeeper_paper_cn#44-client-server-interactions">https://github.com/mapleFU/zookeeper_paper_cn#44-client-server-interactions</a> ï¼Œå¯èƒ½æœ‰çš„åœ°æ–¹ç¿»è¯‘çš„ä¸å¤ªå¥½ï¼Œæ¬¢è¿ PRï¼‰</p><p>ä¸Šè¿°ä¿è¯å…è®¸ ZooKeeper çš„ client èƒ½å¤Ÿæ¯”è¾ƒå¥½çš„ä½¿ç”¨ã€‚ç”¨ <code>s</code> çš„ <code>1/3</code> å’Œ <code>2/3</code> éšå¼ä¾èµ– clock drift ä¸ä¼šå¤ªå¤§ã€‚</p><p>Raft çš„ Lease Read ä¹Ÿåšäº† Lease ç›¸å…³çš„ä¼˜åŒ–ã€‚ç®€å•çš„ Raft è¯»ä¸€èˆ¬éœ€è¦ Leader è¯æ˜ â€œè‡ªå·±ä»ç„¶æ˜¯ Leaderâ€ï¼Œè·å–ä¸€ä¸ª Read Indexï¼Œç­‰æäº¤è¶Šè¿‡è¿™ä¸ª Read Index ä¹‹åè¿”å›ã€‚è€Œ Lease Read åˆ™æ˜¯ä¸€ä¸ªç®€å•çš„æ¨ç†ï¼šåœ¨ä¸€æ¬¡ heartbeat å’Œ election timeout ç›¸å…³çš„ä¸€æ®µæ—¶é—´å†…ï¼Œè‡ªå·±ä»ç„¶æ˜¯ Leader ã€‚è¿™ä¸ªåœ¨åšå£«è®ºæ–‡ä¸­æœ‰ä»‹ç»ï¼š</p><p><img src="https://image.mwish.me/blog-image/A436F352-391E-4CEB-8DC6-415AFF87FDE7.png" alt="A436F352-391E-4CEB-8DC6-415AFF87FDE7"></p><p>è¿™ä¸ªä¹Ÿå¯ä»¥å‚è€ƒ TiKV çš„å®ç°ç›¸å…³çš„è®¨è®ºï¼š<a href="https://zhuanlan.zhihu.com/p/25367435">https://zhuanlan.zhihu.com/p/25367435</a></p><h3 id="Corner-Case-ä¸ä¸»èŠ‚ç‚¹æ“ä½œ"><a href="#Corner-Case-ä¸ä¸»èŠ‚ç‚¹æ“ä½œ" class="headerlink" title="Corner Case ä¸ä¸»èŠ‚ç‚¹æ“ä½œ"></a>Corner Case ä¸ä¸»èŠ‚ç‚¹æ“ä½œ</h3><p>åœ¨ä¸Šé¢å·¥å…·çš„å¸®åŠ©ä¸‹ï¼Œä½ å¯èƒ½è®¤ä¸ºæ²¡æœ‰é—®é¢˜äº†ï¼Œå½“ç„¶ï¼Œè¿™æ˜¯ä¸ç°å®çš„ï½</p><p>DDIA çš„ä½œè€…åœ¨å®ƒçš„åšå®¢ä¸Šå†™è¿‡ä¸€ç¯‡ how to do distributed locking <a href="https://martin.kleppmann.com/2016/02/08/how-to-do-distributed-locking.html">https://martin.kleppmann.com/2016/02/08/how-to-do-distributed-locking.html</a> ï¼Œæåˆ°äº†ä¸‹é¢çš„æ—¶åºé—®é¢˜ï¼š</p><p><img src="https://image.mwish.me/blog-image/unsafe-lock.png" alt="unsafe-lock"></p><p>æœ¬è´¨ä¸Šï¼Œè¿™æ˜¯å› ä¸º Storage å¹¶é lock service, è¿™å¯¼è‡´æ“ä½œå‡ºç°ä¸ä¸€è‡´ï¼šåœ¨ Lock Service é‡Œï¼Œæˆ‘ä»¬æœ‰ç‹¬ç«‹çš„ Lock, ä½†æ˜¯åœ¨å¤–éƒ¨æ“ä½œè§†è§’ï¼Œè¿™å¹¶ä¸æ˜¯ç‹¬ç«‹çš„ã€‚è¿™å¯¼è‡´æˆ‘ä»¬ä¹‹å‰çš„çº¦æŸå†æ¬¡å‡ºç°é—®é¢˜ï¼</p><p>è¿™ä¸¤ç¯‡æ–‡ç« æåˆ°äº† ZooKeeper ç›¸å…³çš„è§£å†³æ–¹æ¡ˆï¼š</p><ol><li><a href="https://fpj.systems/2016/02/10/note-on-fencing-and-distributed-locks/">https://fpj.systems/2016/02/10/note-on-fencing-and-distributed-locks/</a></li><li><a href="https://zhuanlan.zhihu.com/p/299272034">https://zhuanlan.zhihu.com/p/299272034</a></li></ol><p>ï¼ˆæˆ‘æ›´æ¨èä½ é˜…è¯»åè€…ï¼Œè™½ç„¶å…¶å®ä¸æ­¢è¦è¯»ä¸€éï¼‰</p><p>è¿™é‡Œæ˜¯åœ¨è¯´ï¼Œå‘é€æ“ä½œçš„æ—¶å€™ï¼Œå¦‚æœè·å–åˆ°ä¸»çš„æƒé™ï¼Œå¯ä»¥äº§ç”Ÿä¸€ä¸ª Termï¼Œå‘é€æ“ä½œçš„æ—¶å€™å¸¦ä¸Šè¿™ä¸ª Termï¼Œå¦‚æœ Term ä¸åˆç†çš„è¯ï¼Œä¸‹å±‚å…è®¸æ‹’ç»æ‰è¿™ä¸ªæ“ä½œã€‚</p><p>æ­¤å¤–ï¼ŒHDFS ä¸­ï¼Œå…è®¸ä½ ä½¿ç”¨ IO Fencing: å½“ä¸€ä¸ªæ–°çš„èŠ‚ç‚¹æˆä¸º Leader çš„æ—¶å€™ï¼Œä½ èƒ½å¤Ÿ ssh åˆ°æ—§çš„ leader ä¸Šï¼Œæ¥ kill æ‰å®ƒï¼Œé˜²æ­¢å‡ºç°æ—¶åºé—®é¢˜ã€‚</p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ol><li>Hardware/Software Clocks <a href="https://tldp.org/LDP/sag/html/hw-sw-clocks.html">https://tldp.org/LDP/sag/html/hw-sw-clocks.html</a></li><li>Modern Cpp: The There Clocks <a href="https://www.modernescpp.com/index.php/the-three-clocks">https://www.modernescpp.com/index.php/the-three-clocks</a></li><li>TiKV è¯»ä¼˜åŒ–ï¼š<a href="https://zhuanlan.zhihu.com/p/25367435">https://zhuanlan.zhihu.com/p/25367435</a></li><li><a href="https://fpj.systems/2016/02/10/note-on-fencing-and-distributed-locks/">https://fpj.systems/2016/02/10/note-on-fencing-and-distributed-locks/</a></li><li><a href="https://zhuanlan.zhihu.com/p/299272034">https://zhuanlan.zhihu.com/p/299272034</a></li></ol>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Cache Consistency in CPU and Distributed System: Part2</title>
      <link href="/2020/12/12/Cache-Consistency-in-CPU-and-Distributed-Sysem-Part2/"/>
      <url>/2020/12/12/Cache-Consistency-in-CPU-and-Distributed-Sysem-Part2/</url>
      
        <content type="html"><![CDATA[<h3 id="Redlock"><a href="#Redlock" class="headerlink" title="Redlock"></a>Redlock</h3><p>Redlock çš„æœ€ä½³äº†è§£é“¾æ¥åœ¨ï¼š<a href="https://redis.io/topics/distlock">https://redis.io/topics/distlock</a></p><p>è¿™é‡Œæ¯”è¾ƒè¯¦ç»†çš„æå†™äº† Redis çš„ Redlock çš„ç®—æ³•æµç¨‹ã€‚ä½†æ˜¯é¡ºä¾¿ä¸€æï¼Œçœ‹å®Œå»ºè®®çœ‹çœ‹è¿™ä¸ª: <a href="https://martin.kleppmann.com/2016/02/08/how-to-do-distributed-locking.html">https://martin.kleppmann.com/2016/02/08/how-to-do-distributed-locking.html</a></p><h3 id="Raft-Lease"><a href="#Raft-Lease" class="headerlink" title="Raft Lease"></a>Raft Lease</h3><h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul><li><a href="https://martin.kleppmann.com/2016/02/08/how-to-do-distributed-locking.html">https://martin.kleppmann.com/2016/02/08/how-to-do-distributed-locking.html</a></li><li><a href="https://redis.io/topics/distlock">https://redis.io/topics/distlock</a></li><li></li><li><a href="https://zhuanlan.zhihu.com/p/299272034">https://zhuanlan.zhihu.com/p/299272034</a></li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> system, distributed </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Cache Consistency in CPU and Distributed System</title>
      <link href="/2020/12/12/Cache-Consistency-in-CPU-and-Distributed-System/"/>
      <url>/2020/12/12/Cache-Consistency-in-CPU-and-Distributed-System/</url>
      
        <content type="html"><![CDATA[<p>CPU å’Œå†…å­˜ä¹‹é—´ï¼Œæˆ‘ä»¬æœ‰ä¸¤ç§ä¸œè¥¿ï¼š</p><ul><li>memory consistency: ä»€ä¹ˆåº”è¯¥è¯»åˆ°å†™å…¥çš„ä»€ä¹ˆä¸œè¥¿ã€‚</li><li>cache coherence: <a href="https://zhuanlan.zhihu.com/p/272348686">https://zhuanlan.zhihu.com/p/272348686</a></li></ul><p>è¿™ä¸€èŠ‚çš„å†…å®¹ä¼šæ¯”è¾ƒé•¿ï¼Œæˆ‘ä»¬ä¼šä»‹ç»ï¼š</p><ul><li>å¦‚ä½•åœ¨ CPU ä¸­ç»´æŠ¤ä¸Šé¢çš„ä¸€è‡´æ€§ï¼šæˆ‘ä»¬å°†ä»‹ç» snooping-based ï¼ˆå›½å†…ç¿»è¯‘ç±»ä¼¼åŸºäºç›‘å¬çš„åè®®ï¼‰å’Œ directoryï¼ˆåŸºäºç›®å½•çš„åè®®ï¼‰ã€‚</li><li>å¦‚ä½•åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ç»´æŠ¤ä¸€è‡´æ€§ï¼šæˆ‘ä»¬å°†ä»‹ç»è¿™ä¸è®¡ç®—æœºç³»ç»Ÿä¸­æœ‰ä»€ä¹ˆä¸åŒï¼Œç„¶åä»‹ç» Lease æœºåˆ¶ã€‚</li></ul><h2 id="Preview"><a href="#Preview" class="headerlink" title="Preview"></a>Preview</h2><p>æˆ‘ä»¬åœ¨ä¹‹å‰å†…å®¹èŠåˆ°è¿‡ cacheline/cacheblock çš„åŸºæœ¬æ¦‚å¿µï¼š</p><p><a href="https://zhuanlan.zhihu.com/p/271020814">https://zhuanlan.zhihu.com/p/271020814</a></p><p><img src="https://image.mwish.me/blog-image/D0BB5BAB-3486-4EC9-BF8E-D470DAF87BE3.png" alt="D0BB5BAB-3486-4EC9-BF8E-D470DAF87BE3"></p><p>æˆ‘ä»¬è¿˜æœ‰ä¸€äº› design ä¸Šçš„åŒºåˆ«ï¼š</p><blockquote><ol><li><p>Write-throughï¼šå†™å…¥çš„æ—¶å€™éœ€è¦æ›´æ–°cache å’Œ memory</p></li><li><p>Write-back:</p></li><li><ol><li>å†™å…¥çš„æ—¶å€™æ›´æ–° cache block</li><li>æ·»åŠ ä¸€ä¸ª dirty flag</li><li>OS åœ¨ IO ä¹‹å‰ flush cache</li></ol></li></ol><p>write-through ä¹Ÿæœ‰ write allocate ç­‰ç­–ç•¥ã€‚write allocate æ˜¯æŒ‡ï¼šå¦‚æœç›®æ ‡å†…å­˜ä¸åœ¨ cache ä¸­ï¼Œæ˜¯å¦è¦æŠŠå®ƒæä¸Šæ¥ã€‚</p></blockquote><h2 id="Snooping-cache-coherence"><a href="#Snooping-cache-coherence" class="headerlink" title="Snooping cache-coherence"></a>Snooping cache-coherence</h2><p>Idea: æ‰€æœ‰ä¸ coherence ç›¸å…³çš„æ´»åŠ¨ï¼Œä¼šè¢«å¹¿æ’­ç»™å„ä¸ª cache-controller. Cache controller èˆ°è‰‡è¿™äº›æ“ä½œï¼Œæ¥ç»´æŒ memory coherenceã€‚</p><p>é‚£ä¹ˆæˆ‘ä»¬å¯ä»¥æƒ³åˆ°ä¸€ä¸ªæœ€æœ´ç´ çš„å®ç°ï¼š</p><blockquote><p>åœ¨ write-through + cache line ä¸ºç²’åº¦çš„åœºæ™¯ä¸‹</p><p>ä»»ä½•ä¸€æ¬¡å†™ï¼Œåœ¨å®Œæˆçš„æ—¶å€™ï¼Œéƒ½ä¼š Invalid æ‰æ‰€æœ‰çš„ cacheã€‚æ‰€ä»¥åˆ«çš„ P ä¸‹ä¸€æ¬¡è¯»éƒ½ä¼š cache miss</p></blockquote><p>é‚£ä¹ˆï¼Œæˆ‘ä»¬å¯ä»¥ç»´æŠ¤ä¸€ä¸ªå¦‚ä¸‹å›¾çš„çŠ¶æ€æœºå™¨ï¼Œcache æœ‰ä¸¤ç§é€»è¾‘çŠ¶æ€ï¼š</p><p><img src="https://image.mwish.me/blog-image/7350CB1E-748C-42CC-9803-D26D06523C98.png" alt="7350CB1E-748C-42CC-9803-D26D06523C98"></p><p>è¿™é‡Œå¯¹ bus æœ‰éœ€æ±‚ï¼š</p><ul><li>æ‰€æœ‰çš„ write txn è¢«æ‰€æœ‰çš„ cache controller ä»¥åŒç§é¡ºåºè§‚å¯Ÿåˆ°ã€‚</li></ul><p>åŒæ—¶å¯ä»¥æœ‰ä¸‹é¢çš„å‡è®¾ï¼š</p><p><img src="https://image.mwish.me/blog-image/DA90A8BF-2444-4257-B217-74A0025DFC6A.png" alt="DA90A8BF-2444-4257-B217-74A0025DFC6A"></p><p>å½“ç„¶ï¼Œä»¥ä¸Šæ˜¯ write-through çš„åœºæ™¯ã€‚ç›¸å¯¹ write-back æ¥è¯´ï¼Œwrite-through åªæ˜¯ä¼˜åŒ–äº†è¯»ï¼ŒåŒæ—¶ï¼Œè¿™æ ·çš„ç¼ºç‚¹æ˜¯ï¼šæ¯æ¬¡å†™éƒ½è¦å†™å†…å­˜ï¼Œéœ€è¦å¾ˆé«˜çš„ bandwidth. write-back å¤§å¤§å‡å°‘äº†è¿™ç§åœºæ™¯ï¼Œä½†æ˜¯ï¼Œåœ¨ write-back çš„æƒ…å†µä¸‹ï¼Œå®ç° cache coherence ä¼šå¤æ‚å¾—å¤šã€‚</p><p>ç°åœ¨ï¼Œæˆ‘ä»¬éœ€è¦åŒºåˆ† dirty/clean, exclusive å’Œ shared. è¿™ä¸ªéœ€è¦é  cacheline çš„ <code>valid</code> æ ‡è®°æ¥åŒºåˆ†ã€‚</p><ul><li>Exclusive: è¢«å†™å…¥ä¹‹åï¼Œå˜æˆç‹¬å çš„ï¼Œåªæœ‰å†™å…¥è€…çš„æ˜¯æœ‰æ•ˆçš„</li><li>Owner: åˆ«çš„ cache éœ€è¦ load çš„æ—¶å€™ï¼Œä¸èƒ½ä» memory è¯»ï¼Œå› ä¸º memory çš„æ•°æ®æ˜¯ stale çš„ã€‚éœ€è¦ä»å†™å…¥çš„å”¯ä¸€ä¸€ä»½ cache ä¸­è¯»ã€‚</li></ul><p>é‚£ä¹ˆï¼Œæˆ‘ä»¬æœ‰ä¸‹é¢çš„ ideasï¼š</p><blockquote><ul><li>exclusive çŠ¶æ€çš„ cache å¯ä»¥ä¸é€šçŸ¥åˆ«çš„è¿›ç¨‹ï¼Œå°±å¯ä»¥å®Œæˆä¿®æ”¹</li><li>P åªèƒ½å†™ exclusive çš„ cache, æ‰€ä»¥å®ƒå†™ä¹‹å‰éœ€è¦å¹¿æ’­</li><li>å½“ P æ”¶åˆ°åˆ«çš„ P çš„å†™è¯·æ±‚æ—¶ï¼Œä»–å¿…é¡» Invalid è‡ªå·±çš„ cache</li></ul></blockquote><h4 id="MSI"><a href="#MSI" class="headerlink" title="MSI"></a>MSI</h4><p>Key tasks:</p><ul><li>ç¡®ä¿åœ¨å†™å…¥æ—¶æ˜¯ Exclusive çš„</li><li>èƒ½å¤Ÿè¯»åˆ°æœ€è¿‘å†™å…¥çš„ cacheline, å³ä½¿ä¸åœ¨å†…å­˜ä¸­</li></ul><p>åŒæ—¶ï¼Œæœ‰ä¸‰ä¸ª cache line çŠ¶æ€ï¼š</p><ul><li>M: Modified</li><li>I: Invalid</li><li>S: Shared</li></ul><p>æœ‰ä¸¤ç§æ¥è‡ª local P çš„æ“ä½œï¼š</p><ul><li>PrRd: å¤„ç†å™¨è¯»</li><li>PrWr: å¤„ç†å™¨å†™</li></ul><p>ä¸‰ç§æ¥è‡ª remote cache çš„æ“ä½œï¼š</p><ul><li>BusRdï¼šå½“æŸä¸ªå¤„ç†å™¨çš„é«˜é€Ÿç¼“å­˜çš„è¯»æ“ä½œå‡ºç°æœªå‘½ä¸­ï¼Œå®ƒä¼šå‘æ€»çº¿å‘é€ä¸€ä¸ªBusRdè¯·æ±‚ï¼Œå¹¶é¢„æœŸèƒ½å¤Ÿæ”¶åˆ°è¯¥ç¼“å­˜å—çš„æ•°æ®ã€‚</li><li>BusRdXï¼šå½“æŸä¸ªå¤„ç†å™¨çš„é«˜é€Ÿç¼“å­˜çš„å†™æ“ä½œå‡ºç°æœªå‘½ä¸­ï¼Œå®ƒä¼šå‘æ€»çº¿å‘é€ä¸€ä¸ªBusRdXè¯·æ±‚ï¼Œé¢„æœŸèƒ½å¤Ÿæ”¶åˆ°è¯¥ç¼“å­˜å—çš„æ•°æ®ï¼Œå¹¶ä¸”ä½¿å…¶ä»–å¤„ç†å™¨ä¸­å¯¹åº”ç›¸åŒåœ°å€çš„ç¼“å­˜å—æ— æ•ˆã€‚</li><li>Flushï¼šè¯¥è¯·æ±‚è¡¨æ˜ä¸€ä¸ªç¼“å­˜å—æ­£åœ¨è¢«å†™å›å†…å­˜ã€‚</li></ul><p><img src="https://image.mwish.me/blog-image/4487FEFE-0B95-49B4-B54A-FA49AB0D8836.png" alt="4487FEFE-0B95-49B4-B54A-FA49AB0D8836"></p><p>MSI å¯¹äº coherence çš„æ»¡è¶³æ€§ï¼š</p><ul><li>å†™æ˜¯ total order çš„ï¼Œå¦‚æœçŠ¶æ€ä¸æ˜¯ M æœ¬å¤„ç†å™¨çš„å†™ä¼š Invalid æ‰€æœ‰çš„ cacheï¼›å¦‚æœæœ¬èº«æ˜¯ M, æ²¡æœ‰è¢«è¯»å æœ‰ï¼Œé‚£ä¹ˆæœ¬èº«å†™æŒ‰ç…§ order è¿›è¡Œã€‚ä»»ä½•ä¸€ä¸ªè¯»éœ€è¦æŠŠ M å˜æˆ Sã€‚</li></ul><p>ç°ä»£åŒ–çš„ç³»ç»Ÿä½¿ç”¨çš„MSIåè®®çš„å˜ç§ä»¥å‡å°‘ä¿æŒç¼“å­˜ä¸€è‡´æ€§æ‰€éœ€è¦çš„é€šä¿¡é‡ã€‚MESIåè®®å¢åŠ äº†ä¸€ä¸ªExclusiveï¼ˆç‹¬å ï¼‰çŠ¶æ€ï¼Œä»¥å‡å°‘å¯¹äºåªå­˜åœ¨äºä¸€ä¸ªé«˜é€Ÿç¼“å­˜çš„å—çš„å†™æ“ä½œé€ æˆçš„é€šä¿¡ã€‚MOSIåè®®å¢åŠ äº†ä¸€ä¸ªOwnedï¼ˆæŒæœ‰ï¼‰çŠ¶æ€ï¼Œä»¥å‡å°‘å¯¹äºè¢«å…¶ä»–ç¼“å­˜è¯»å–è¿‡çš„é«˜é€Ÿç¼“å­˜çš„å—çš„å†™å›æ“ä½œé€ æˆçš„é€šä¿¡ã€‚MOESIåè®®åŒæ—¶åšäº†è¿™ä¸¤ä»¶äº‹æƒ…ã€‚</p><p><img src="https://image.mwish.me/blog-image/B914D377-13F5-4E3B-BE58-089149C98CA6.png" alt="B914D377-13F5-4E3B-BE58-089149C98CA6"></p><h4 id="Multi-level-Cache"><a href="#Multi-level-Cache" class="headerlink" title="Multi-level Cache"></a>Multi-level Cache</h4><p>ç°åœ¨çš„å¤„ç†å™¨éƒ½æ˜¯æœ‰å¤šçº§ç¼“å­˜çš„ï¼Œè¿™æš—ç¤ºè¦å¼•å…¥é¢å¤–çš„å¤æ‚åº¦ï¼šåŒ…å«å…³ç³»ã€‚</p><p>å› ä¸º L1 æŸç§æ„ä¹‰ä¸Šæ˜¯ L2 çš„å­é›†ï¼Œæ‰€ä»¥å³ä½¿ L1 ä¸ä¿®æ”¹ L2ï¼Œåè®®ä¸Šä»ç„¶è¦åœ¨ L2 ä¸Šä½œä¿®æ”¹ã€‚</p><p><img src="https://image.mwish.me/blog-image/2C8CC59F-687A-4AA7-8FF9-5EA96DBD152E.png" alt="2C8CC59F-687A-4AA7-8FF9-5EA96DBD152E"></p><h2 id="Directory-Based-cache-coherence"><a href="#Directory-Based-cache-coherence" class="headerlink" title="Directory-Based cache-coherence"></a>Directory-Based cache-coherence</h2><p>åœ¨ SMP ä¸­ï¼Œæˆ‘ä»¬æœ‰å¦‚ä¸Šçš„è§†å›¾ã€‚ä½†æ˜¯ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šä¸ºäº†é™ä½ latency, å¢å¤§å†…å­˜è®¿é—®çš„å¸¦å®½è€Œä½¿ç”¨ NUMA æ¶æ„ï¼š</p><p><img src="https://image.mwish.me/blog-image/FA197163-9E91-427B-9D4B-4F99632A2157.png" alt="FA197163-9E91-427B-9D4B-4F99632A2157"></p><p>Snoop åè®®è‚¯å®šè¿˜èƒ½ç”¨ï¼Œä½†æ˜¯è¦æŠŠä¿®æ”¹é€šè¿‡ interconnect å‘Šè¯‰åˆ«çš„ P å’Œ cache controllerâ€¦</p><p>ä¸€ç§å¯é€‰çš„æ–¹æ¡ˆæ˜¯ï¼Œä½¿ç”¨ directory æ¥å­˜æ”¾ cacheline å¯¹åº”çš„çŠ¶æ€ã€‚è€Œ cacheline ä¹Ÿä¼šä» directory ä¸­å¯»æ‰¾éœ€è¦çš„ä¿¡æ¯ã€‚</p><p><img src="https://image.mwish.me/blog-image/0C173BDB-774B-4CDB-BBC5-224246586921.png" alt="0C173BDB-774B-4CDB-BBC5-224246586921"></p><p>directory åè®®ç»´æŠ¤äº†ä¸€ä¸ª directory, æ¥è¡¨ç¤ºæ¯ä¸€ä¸ª Line çš„çŠ¶æ€ã€‚è¯·æ±‚ä¸éœ€è¦è¿‡æ¯ä¸€ä¸ª Processor, è€Œæ˜¯é€šè¿‡ memory æ‰€å¯¹åº”çš„ directory, æ¥å®Œæˆä¸€è‡´æ€§çš„ç»´æŠ¤ã€‚</p><h2 id="æ²¡æœ‰-interconnect-çš„ç³»ç»Ÿ"><a href="#æ²¡æœ‰-interconnect-çš„ç³»ç»Ÿ" class="headerlink" title="æ²¡æœ‰ interconnect çš„ç³»ç»Ÿ"></a>æ²¡æœ‰ interconnect çš„ç³»ç»Ÿ</h2><h3 id="Lease-Basics"><a href="#Lease-Basics" class="headerlink" title="Lease: Basics"></a>Lease: Basics</h3><p>æˆ‘ä»¬ä¸Šè¿°å†…å®¹ä¸­çœ‹åˆ°ï¼Œä¸ºäº†ç»´æŠ¤ write serialization ä»¥åŠæ›´å¤§çš„ cache coherence, éœ€è¦ä¾èµ–ä¸€ç‚¹ï¼š</p><ul><li>interconnect æ˜¯å¯é çš„</li><li>å®ƒèƒ½å¤Ÿå¸®æˆ‘ä»¬ total order çš„å¹¿æ’­å†™</li></ul><p>åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œæˆ‘ä»¬å¾ˆéš¾ä¾èµ–ç¬¬ä¸€ç‚¹å‡è®¾ï¼Œå®é™…ä¸Šï¼Œå¼‚æ­¥ç³»ç»Ÿçš„å…±è¯†ç”šè‡³æ˜¯æ²¡æœ‰ä¸‹é™çš„ï¼Œè¯¦è§ FLPã€‚å¯¹äºç¬¬äºŒç‚¹ï¼Œå®ç°å…¨åºå¹¿æ’­æ˜¯ç›¸å½“æ˜‚è´µçš„ï¼Œæˆ‘ä»¬å¯èƒ½ç†Ÿæ‚‰ä¸€äº›åŸºäºå¤åˆ¶çŠ¶æ€æœºçš„åè®®ã€‚</p><p>89 å¹´çš„ Leases: An Efficient Fault-Tolerant Mechanism for Distributed File Cache Consistency æå‡ºäº† Lease æœºåˆ¶ï¼Œè¿™æ˜¯æˆ‘ä»¬åœ¨ä»Šå¤©çš„åˆ†å¸ƒå¼ç³»ç»Ÿé‡Œé¢éå¸¸å¸¸è§çš„åè®®ã€‚å½“ç„¶ï¼Œè¿™ä¸ªåŸ paper åªä»‹ç»äº† write-through çš„åœºæ™¯ã€‚æˆ‘ä»¬è¯•å›¾ä»‹ç»åŸºæœ¬ä¹‹åï¼Œä¹‹åä¼šè®²è®²å„ç§åœ°æ–¹çš„ Lease ä½¿ç”¨å’Œé—®é¢˜ã€‚</p><blockquote><ul><li>â€œA lease is a contract that gives its holder specified rights over property for a limited period of time.â€</li><li>â€œ A lease grants to its holder <strong>control over writes</strong> to the covered datum <strong>during the term of the lease</strong>, such that the server must obtain the approval of the leaseholder before the datum may be written.â€ </li></ul></blockquote><p><img src="https://image.mwish.me/blog-image/25A8DE4A-BD8F-46B3-BA18-34A15C4D21D8.png" alt="25A8DE4A-BD8F-46B3-BA18-34A15C4D21D8"></p><ul><li>å†™å…¥ï¼šclient éœ€è¦å‘ä¸€ä¸ªé€»è¾‘ä¸Šçš„å•ç‚¹ï¼ˆæˆ‘ä»¬åœ¨ Redis é‡Œé¢ä¼šçœ‹åˆ°è¿™ä¸ªï¼‰å‘é€ Lease Request, æ‹¿åˆ°å¯¹åº”çš„ lease ä¹‹åï¼Œæ‰èƒ½åœ¨ lease æœŸé—´å†™èµ„æº</li><li>å¦å¤–ä¸€ä¸ªå†™å…¥éœ€è¦å†™æ—¶ï¼Œserver ä¼šå°è¯• invalid ä¹‹å‰ grant çš„ leaseï¼Œç„¶åå† grant lease</li><li>å¦‚æœ invalid è”ç³»ä¸ä¸Šï¼ˆæ¯”å¦‚å‘ç”Ÿç½‘ç»œåˆ†åŒºï¼‰ï¼Œè¿™é‡Œä¼šç­‰å¾…åˆ° grant çš„ lease æ—¶é—´ç»“æŸã€‚</li></ul><p>è¿™é‡Œéšå«äº†æ—¶é—´è¿™ä¸ªè¦æ±‚ã€‚å®é™…ä¸Šåˆ†å¸ƒå¼ç³»ç»Ÿçš„æ—¶é—´åªæ˜¯ä¸€ä¸ªååºæ¦‚å¿µã€‚è¿™é‡Œåªèƒ½å‡å®šå¤§å®¶ system clock çš„è¿è¡Œåå·®åœ¨ä¸€å®šèŒƒå›´å†…ã€‚</p>]]></content>
      
      
      
        <tags>
            
            <tag> system, distributed </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ¥å¾—å¤ªæ—©çš„ 2020 å¹´å¹´é‰´</title>
      <link href="/2020/12/05/%E6%9D%A5%E5%BE%97%E5%A4%AA%E6%97%A9%E7%9A%84-2020-%E5%B9%B4%E5%B9%B4%E9%89%B4/"/>
      <url>/2020/12/05/%E6%9D%A5%E5%BE%97%E5%A4%AA%E6%97%A9%E7%9A%84-2020-%E5%B9%B4%E5%B9%B4%E9%89%B4/</url>
      
        <content type="html"><![CDATA[<p>ä¸»è¦è¿˜æ˜¯æƒ³è®²è®²è‡ªå·± 2020 å¹´çœ‹è¿‡çš„åŠ¨ç”»ã€‚</p><p>å¹´åˆåœ¨å…¬å¸å®ä¹ ï¼Œå‘¨æœ«å’Œæ™šä¸Šå¯ä»¥çœ‹çœ‹åŠ¨ç”»ç‰‡ã€‚åœ¨å¹´ä¼šä¹‹å‰ï¼Œè¡¥å®Œäº†ã€Šç”µæ³¢å¥³ä¸é’æ˜¥ç”·ã€‹çš„åŠ¨ç”»ã€‚è¿™éƒ¨æˆ‘é«˜ä¸­çœ‹äº†2é›†å°±æ²¡çœ‹ä¸‹å»äº†ï¼Œå¹´åˆçœ‹çš„æ—¶å€™å´è§‰å¾—æ„å¤–çš„å¾ˆé’æ˜¥ã€‚</p><p>éšåå‘¨æœ«å’Œbgmçš„ä¸Šæµ·ç½‘å‹ä¸€èµ·å»çœ‹äº†äº¬ç´«çš„åŠ¨ç”»ï¼Œç„¶åé¡ºæ‰‹æ‹¿äº†è‰²çº¸ã€‚å…¶å®æˆ‘ä¸æŒ‡æœ›äº¬ç´«æœ‰å¤šå¥½çœ‹ã€‚ä½†æ˜¯å‡ºäºå¯¹äº¬éƒ½åŠ¨ç”»çš„å°Šæ•¬ï¼Œè¿˜æ˜¯å¸¦ç€æœŸå¾…å»çœ‹äº†ï¼Œç»“æœè§‰å¾—ç«Ÿç„¶è¿˜ä¸é”™ã€‚çœ‹å®Œç”µå½±èŠå¤©çš„æ—¶å€™å¬ uks é»‘å±äº†åŠå¤©ç»†ç”°å®ˆã€‚</p><p><img src="https://image.mwish.me/blog-image/817D0680-4E78-4122-86AC-3995A978271C.png" alt="817D0680-4E78-4122-86AC-3995A978271C"></p><p>å¹´ä¼šçš„æ—¶å€™å…¶å®è›®ç—›è‹¦çš„ï¼Œæ„Ÿè§‰æ°›å›´èå…¥ä¸è¿›å»ï¼ŒåŒ—äº¬çš„èœåˆå·¨å‡ æŠŠéš¾åƒã€‚ä¸è¿‡åº†å¹¸çš„æ˜¯ï¼Œæˆ‘ä¸€ä¸ªäººå¾ˆå®‰é™åœ°çœ‹å®Œäº†ã€Šåœ¨ç»†é›¨ä¸­å‘¼å–Šã€‹ã€‚æˆ‘å¤ªå–œæ¬¢è¿™æœ¬ä¹¦çš„æ—¶é—´çº¿äº†ã€‚å¹´ä¼šå…¬å¸æœ‹å‹éƒ½åœ¨åº†ç¥çš„æ—¶å€™ï¼Œå°±æˆ‘ä»–å¦ˆåœ¨çœ‹ä¹¦ï¼Œè¿˜æ˜¯æŒºå¾®å¦™çš„ã€‚</p><p><img src="https://image.mwish.me/blog-image/AFEBDB31-641B-44F9-9F1B-069881E23EC7.png" alt="AFEBDB31-641B-44F9-9F1B-069881E23EC7"></p><p>ç„¶åï¼Œæœ¬æ¥æƒ³å¼€å®Œå¹´ä¼šå°±å›å®¶çš„ï¼Œä¸è¿‡å› ä¸ºæ²¡æœ‰èµ¶ä¸Šè‡ªå·±ä¹°çš„é«˜é“ï¼Œå¾€å delay äº†ä¸‰ä¸ªå°æ—¶ï¼Œæ„å¤–è·å¾—æœºä¼šå»åŒ—äº¬åƒäº†åƒè¡—å¤´å¤ç…®ï¼Œé€›äº†é€›åŒ—äº¬å…µå™¨åšç‰©é¦†ï¼Œä¹°äº†ä¸ªç…é¥¼æœå­ã€‚æ„Ÿè§‰æœ‰ç‚¹å¾®å¦™çš„ç•…çˆ½ã€‚</p><p>é‚£ä¸ªæ—¶å€™ï¼Œæˆ‘æ²¡æœ‰æ–™åˆ°è‡ªå·±ä¸‹åŠå¹´ä¼šåœ¨åŒ—äº¬åº¦è¿‡ï¼ŒçœŸçš„æ²¡æœ‰ã€‚æˆ‘ä¹Ÿæ²¡æœ‰æƒ³åˆ°ä¼šæœ‰ç–«æƒ…ã€‚è¿™ä¸å¯é¢„æ–™çš„ä¸€å¹´ä»¥å­™å®¶ä¸å¯é¢„æµ‹çš„å‘½è¿ä¸€èµ·ï¼Œåœ¨æˆ‘çš„é¢å‰å±•å¼€äº†ã€‚</p><p>å‡æœŸå¤§æ¦‚æœ‰14å¤©ï¼Ÿå…¶å®æ”¾å‡ä¹‹å‰å°±ä¸å’‹å¿™äº†ï¼Œåœ¨å®¶é‡Œå¸®å®¶é‡Œäººåšäº‹å•¥çš„ã€‚ç„¶åè¡¥å®Œäº†ç©ºå¢ƒçš„å‰§åœºç‰ˆå•ƒå®Œäº†ï¼Œå‡†ç¡®è¯´æœªæ¥ç¦éŸ³æˆ‘æ²¡çœ‹ã€‚æœ€å–œæ¬¢çš„æ˜¯çŸ›ç›¾èºæ—‹ã€‚</p><p>é‚£ä¼šå„¿åœ¨å®¶é‡ŒæŠŠã€ŠHeart Catch Precureã€‹ å•ƒå®Œäº†ã€‚ç®—æ˜¯è‡ªå·±ç¬¬ä¸€éƒ¨æœ‰æ„è¯†å»è¡¥çš„å­ä¾›åŠ¨ç”»ã€‚è™½ç„¶æˆ‘è¢«å˜èº«bankæå¾—è¿˜æŒºçƒ¦çš„ï¼Œä½†æ˜¯å½“ä¸¤æ¬¡ \<Heart goes on\> å“èµ·çš„æ—¶å€™ï¼Œæˆ‘è¿˜æ˜¯æµæ³ªäº†ã€‚</p><p><img src="https://image.mwish.me/blog-image/A9CB8180-97DE-4334-9626-A1E33308910E.png" alt="A9CB8180-97DE-4334-9626-A1E33308910E"></p><p>è¿‡å¹´çš„æ—¶å€™å› ä¸ºç–«æƒ…åŸå› ï¼Œå¤§å®¶ä¸€åˆ‡ä»ç®€ã€‚æˆ‘æ‰¾æˆ‘è¡¨å“¥ä¸€èµ·çœ‹ç¾¤å‹æ¨èçš„åŠ¨ç”»ï¼Œã€Šæ˜Ÿç•Œçš„çº¹ç« ã€‹ã€‚ç¡®å®æ˜¯å¾ˆæ‚ é—²æµªæ¼«çš„åŠ¨ç”»ï¼Œå¦‚æœä¸æ˜¯æˆ‘å½“æ—¶æ¯”è¾ƒç„¦èºï¼Œå¯èƒ½å¯¹å®ƒä¼šæœ‰æ›´é«˜çš„è¯„ä»·ã€‚ä¸è¿‡è¿™ç‰‡å­çœ‹å®Œå¾—åœ¨ä¸¤æ˜ŸæœŸåäº†ã€‚2æœˆ9å·å·¦å³ï¼Œä¿ºå°±å¼€å§‹æ¥ç€ä¸Šç­äº†ã€‚</p><p><img src="https://image.mwish.me/blog-image/A4E3A564-83FE-4C81-B837-DB0AE22DA108.png" alt="A4E3A564-83FE-4C81-B837-DB0AE22DA108"></p><p>ç„¶åä¿ºå‡†å¤‡å†çœ‹ä¸€éå¡å¤«å¡çš„åŸå ¡ï¼Œä¹‹å‰æŠŠå´æ™“ä¸œçš„ã€Šä»å¡å¤«å¡åˆ°æ˜†å¾·æ‹‰ã€‹é‡Œé¢å¡å¤«å¡é‚£å‡ èŠ‚çœ‹äº†ä¸€ä¸‹ï¼Œå†çœ‹çš„æ—¶å€™ï¼Œæ„Ÿè§¦æ·±äº†ä¸€äº›ï¼Œä½†æ˜¯è¿˜æ˜¯æ„Ÿè§‰å¾ˆé”™ä¹±ã€‚</p><p>å¿™å…¬å¸çš„äº‹æƒ…å’Œæ¯•è®¾æŠŠæˆ‘æçš„ç„¦å¤´çƒ‚é¢ï¼Œ2æœˆåº•åˆ°3æœˆåªæœ‰å‘¨æœ«çš„æ—¶é—´æœ‰ç©ºäº†ï¼Œå¼€å§‹çš„æ—¶å€™ä¸å¿™ï¼Œçœ‹å®Œäº†ã€Š<a href="http://bgm.tv/subject/40003">ç¦æ˜Ÿå°å­2 ç»®ä¸½æ¢¦ä¸­äºº</a> ã€‹ï¼Œåæ¥å¿™èµ·æ¥äº†ï¼Œä¿ºå°±åªæŠŠã€Šå°‘æˆ˜ã€‹è¡¥å®Œäº†ã€‚æœŸé—´è¿˜è¿½äº†ä¸‹ã€ŠID:INVADEDã€‹å’Œæ˜ åƒç ”ï¼Œä¸è¿‡éƒ½æå¾—æˆ‘æœ‰ç‚¹å¤±æœ›ã€‚</p><p>å››æœˆä»½äº”æœˆä»½éƒ½åœ¨å¿™æ‰¾å·¥ä½œå’Œå·¥ä½œã€‚ç„¦è™‘ä¹‹ä½™ï¼ŒæŠŠã€ŠHello Worldã€‹å•ƒäº†ï¼Œå°±æ„Ÿè§‰é‡å´éº»è±†çœŸçš„ä¸è¡Œâ€¦æƒ³èµ·ä¹‹å‰é©¬å°è¤‚ç¿»è¯‘çš„ä½œç”»è®²åº§ï¼ŒæŠŠã€Šç¥æ˜¯ä¸­å­¦ç”Ÿã€‹è¡¥äº†ã€‚è¿™åº”è¯¥æ˜¯æˆ‘ä»Šå¹´ä¸ªäººæœ€å–œæ¬¢çš„åŠ¨ç”»äº†ã€‚</p><p><img src="https://image.mwish.me/blog-image/2795599D-417F-4B7A-912D-23CBA4C96612.png" alt="2795599D-417F-4B7A-912D-23CBA4C96612"></p><p><img src="https://image.mwish.me/blog-image/1C29D5C2-30D4-4042-BB80-DF59DC8C9996.png" alt="1C29D5C2-30D4-4042-BB80-DF59DC8C9996"></p><p>4æœˆåº•ï¼Œæ‰¾åˆ°äº†å‡ ä¸ªä¿åº•çš„å·¥ä½œï¼Œç„¶åèƒ½å›å­¦æ ¡äº†ã€‚å¿ƒæƒ…å¥½èµ·æ¥äº†ï¼Œè·Ÿå®¶é‡Œäººå…³ç³»ä¹Ÿèæ´½äº†ã€‚ç»™æˆ‘å¦ˆä¸‹äº†ä¸€æ•´å¥—ã€Šè¯·å›ç­” 1988ã€‹ï¼Œå‘ç°æˆ‘çˆ¸å¦ˆéƒ½æ˜¯ç‰‡å­ä¸»è§’é‚£ä¸ªæ—¶ä»£çš„äººï¼Œè™½ç„¶å½¼æ—¶éŸ©å›½æ¯”å›½å†…æ±Ÿè¥¿å¯Œè£•ä¸å°‘ï¼Œä½†æ˜¯ä¹åå¹´ä»£çš„å…±åŒè®°å¿†è¿˜æ˜¯æœ‰çš„ã€‚æˆ‘ä¹Ÿçœ‹å¾—æ¯”è¾ƒå¼€å¿ƒã€‚æ­¤å¤–è¿˜å’Œå®¶é‡Œäººä¸€èµ·çœ‹äº†å®«å´éªçš„ã€Šå¡é‡Œå¥¥æ–¯ç‰¹ç½—åŸã€‹ã€‚æ„Ÿè§‰è™½ç„¶è¿™éƒ¨å¾ˆä¸é²é‚¦ï¼Œä½†æ˜¯æ˜¯çœŸçš„å¾ˆæµªæ¼«ã€‚æ­¤å¤–è¿˜æŠŠ \<Flip Flappers\> è¡¥äº†ã€‚Cp æ´»åŠ¨ä¸Šæˆ‘å‘æŠ¼å±±æ¸…é«˜è¦ç­¾åçš„æ—¶å€™è¯´æˆ‘å¾ˆå–œæ¬¢ä¸«ä¸«å¡ï¼Œä½†å®é™…ä¸Šæˆ‘è¿˜æ²¡çœ‹å®Œâ€”â€”äº‹å®è¯æ˜ï¼Œçœ‹å®Œäº†æˆ‘è¿˜æ˜¯å¾ˆå–œæ¬¢ã€‚</p><p>æ‰¾åˆ°ä¿åº•å·¥ä½œä¹‹åï¼Œä¹ŸæŠŠã€Šç½ªä¸ç½šã€‹å•ƒäº†ã€‚ä¸€å¼€å§‹è¿˜ä¸ä¹ æƒ¯ä¿„å›½äººçš„å‡ ä¸ªåç§°ï¼Œæ‰€ä»¥ä¹°äº†æœ¬å®ä½“ä¹¦çœ‹åç§°è¡¨ã€‚æœ€è¿‘å‘ç°å¯¹ç€è¡¨çœ‹å¡æ‹‰é©¬ä½å¤«å…„å¼Ÿå·²ç»æ²¡å•¥å‹åŠ›äº†ï¼Œæœç„¶ï¼Œçœ‹å°è¯´ä¹Ÿæ˜¯è¦å­¦ä¹ çš„å•Šâ€¦</p><p>5æœˆåº•ï¼Œå›åˆ°åŒæµï¼Œåœ¨å»ä¸Šæµ·çš„é«˜é“ä¸Šçœ‹å®Œäº†ã€Šè®¸ä¸‰è§‚å–è¡€è®°ã€‹ã€‚è¿™å¤§æ¦‚æ˜¯æˆ‘ä»Šå¹´æœ€å¿«ä¹çš„ä¸€ä¸ªæœˆäº†ã€‚æ¯å¤©éª‘è½¦å»é™„è¿‘å®¶ä¹ç¦ä¹°ç‚¹ç”Ÿæ´»ç”¨å“ï¼Œå»ä¸Šæµ·åŠ¨ç‰©å›­ä¹‹ç±»çš„åœ°æ–¹é€›é€›ï¼Œæ‘¸é±¼åšåšæ¯•è®¾ã€‚è¿™æ®µæ—¶é—´ä¹ŸæŠŠå·¥ä½œå®šä¸‹æ¥äº†ã€‚ä¹Ÿæ„Ÿè°¢ç»™æˆ‘æ”¯æŒçš„ç½‘å‹ï¼Œæˆ‘æ°¸è¿œæ„Ÿè°¢ä½ ã€‚</p><p>å›å­¦æ ¡è¿™æ®µæ—¶é—´ï¼Œå› ä¸ºå·¥ä½œå®šä¸‹æ¥äº†ï¼Œæ‰€ä»¥ç„¦è™‘å°‘äº†ä¸å°‘ï¼Œåœ¨å­¦æ ¡ä¸€éå‡è‚¥ï¼Œä¸€è¾¹è¡¥å®Œäº†ã€Šç´¢æ‹‰é‡Œæ–¯æ˜Ÿã€‹ã€ã€Šä¼Šé‡Œé‡çš„å¤©ç©ºã€UFOä¹‹å¤ã€‹ã€ã€Šæ‚‰è¾¾å¤šã€‹å’Œã€Šé“¶æ²³é“é“ä¹‹å¤œã€‹ã€‚åŠ¨ç”»ä¹Ÿçœ‹äº†ä¸å°‘ï¼ŒæŠŠã€Šå¹½çµå…¬ä¸»ã€‹è¡¥å®Œäº†ï¼ˆåº”è¯¥æ˜¯æˆ‘ä¸ªäººæœ€å–œæ¬¢çš„å®«å´éªç”µå½±äº†ï¼‰ï¼Œç„¶åè¡¥å®Œäº† CLANNAD After Storyï¼ˆè¿™éƒ¨æˆ‘è§‰å¾—çœ‹å¾—è¶Šæ—©è¶Šå¥½ï¼Œè¡¥äº†å¾ˆå¤šç°å®ä¸»ä¹‰ä½œå“å†æ¥çœ‹éº»æå‡†çš„æµªæ¼«ï¼Œæˆ‘èƒ½æ„Ÿå—åˆ°ä»–ä¼ è¾¾çš„æƒ…æ„Ÿï¼Œä½†æ˜¯æ€»æ„Ÿè§‰æ€ªæ€ªçš„ï¼‰ã€‚</p><p><img src="https://image.mwish.me/blog-image/A10054C1-F3A2-41A4-A885-A97A74129C36.png" alt="A10054C1-F3A2-41A4-A885-A97A74129C36"></p><p>åœ¨å­¦æ ¡æœ€åå‡ å¤©ï¼ŒæŠŠã€Šç« åŒ—æµ·ä¼ ã€‹çœ‹å®Œäº†ï¼Œç„¶åé”™è¿‡äº†å­¦é™¢çš„å…¸ç¤¼ï¼Œæœ€åå»å­¦æ ¡çš„æ¯•ä¸šå…¸ç¤¼ï¼Œçªç„¶å¾ˆä¼¤æ„Ÿï¼Œæ€ä¹ˆå°±è¿™ä¹ˆç»“æŸäº†ï¼Œä¸€ç‚¹å®æ„Ÿéƒ½æ²¡æœ‰å•Šâ€¦</p><p><img src="https://image.mwish.me/blog-image/E78C22E6-5372-45CB-B72D-DDDA89FD5AC1.png" alt="E78C22E6-5372-45CB-B72D-DDDA89FD5AC1"></p><p>åœ¨æ¼«é•¿çš„å‘Šåˆ«ï¼Œå†å›å®¶ä¼‘æ•´å‡ å¤©åï¼Œå‰å¾€åŒ—äº¬ã€‚åœ¨ä¸Šç­ä¹‹å‰çœ‹å®Œäº† Macross Deltaã€‚ç„¶åå¼€å§‹åŒ—äº¬çš„æ­£å¼å·¥ç”Ÿæ´»ã€‚åœ¨åŒ—äº¬è¿™å‡ å¤©ï¼ŒæŠŠåƒæœ¬æ¨±æ–‡åº“çš„æ–©é¦–å¾ªç¯å•ƒå®Œäº†ï¼Œä¸ƒæœˆåº• æŠŠå“ˆä½›çš„ã€Šå…¬æ­£ï¼šè¯¥å¦‚ä½•åšæ˜¯å¥½ã€‹çœ‹å®Œäº†ï¼Œç„¶å8æœˆè¡¥äº†å¡æ—æ ¼çš„ã€Šå¼—å…°å¦®å’Œç¥–ä¼Šã€‹ï¼ˆå¡æ—æ ¼ç®—æ˜¯æœ€å¯¹æˆ‘èƒƒå£çš„ä½œå®¶äº†ï¼‰å’Œä¸€æ— æ‰€æœ‰ã€‚åŠ¨ç”»å°±æŠŠã€Šé£ä¹‹è°·ã€‹ç»™è¡¥äº†ã€‚</p><p>ç„¶åä»8æœˆä¸€ç›´å¿™åˆ°å›½åº†ï¼ŒæœŸé—´åªæœ‰ä¸€æ®µæ”¾æ¾çš„ï¼Œå°±æ˜¯å¤§å­¦èˆå‹æ¥åŒ—äº¬å‡ºå·®ï¼Œé‚£ä¼šå„¿å’Œä»–ä¸€èµ·çœ‹äº†ä¿¡æ¡ï¼š</p><p><img src="https://image.mwish.me/blog-image/633F9F50-FB96-437D-9119-969259B7E5AC.png" alt="633F9F50-FB96-437D-9119-969259B7E5AC"></p><p>å›½åº†ç¬¬ä¸€å¤©çœ‹å®Œäº†ã€Šæ”¾å­¦åçš„æ˜´æ˜Ÿå›¢ã€‹ï¼Œè™½ç„¶è¿™éƒ¨ä½œå“æ˜¯ä¸ªå¹¿å‘Šç‰‡ï¼Œæ¼”å‡ºå®Œå…¨è·Ÿä¸ä¸Šï¼Œä½†æ˜¯ç»“å°¾é‚£ç§æµªæ¼«ç»å¯¹æ˜¯æœ‰Gç¤¾é­‚çš„ï¼Œé‚£ç§å›åˆ°åŸç‚¹ï¼Œç„¶åæ¼«æ¼«é•¿çœ çš„æµªæ¼«ã€‚è¿™ä¸æ˜¯ä¸æ‡‚SFçš„äººèƒ½å¤Ÿæ‹å‡ºæ¥çš„ï¼š</p><p><img src="https://image.mwish.me/blog-image/303EB6C3-7CA6-46E9-8301-77A0898529F8.png" alt="303EB6C3-7CA6-46E9-8301-77A0898529F8"></p><p>å›ä¸Šæµ·å’Œå¤§å­¦åŒå­¦çº¦é¥­ï¼Œå»ä»–ä»¬å®¶çç©ï¼Œç„¶åæŠŠå§œå­ç‰™çœ‹äº†ï¼Œè¯´å®è¯æˆ‘è§‰å¾—è¿™ç‰‡å­è¿˜ä¸é”™ï¼Œè™½ç„¶ç½‘ä¸Šéª‚å£°ä¸å°ï¼Œä½†æ˜¯æˆ‘è§‰å¾—è¿˜è¡Œâ€¦</p><p><img src="https://image.mwish.me/blog-image/CECAA6C8-A458-4D67-9606-1B86976DDD2A.png" alt="CECAA6C8-A458-4D67-9606-1B86976DDD2A"></p><p>ç„¶åå» WF ç©äº†ä¸€è¶Ÿçˆ½ï¼Œå›å®¶è‚äº†4å¤©ï¼ŒæŠŠ Xenoblade é‡åˆ¶ç‰ˆæ‰“é€šäº†ï¼Œå·²ç»æŠŠã€Šæ•µã¨ã®å¯¾å³™ã€‹è¿™é¦–æ­Œåˆ»åœ¨çµé­‚é‡Œäº†ã€‚å…³äºè¿™éƒ¨ä½œå“æ²¡å•¥è¯´çš„ï¼ŒçŸ¥ä¹ä¸Šæœ‰ä¸ªå¾ˆæ£’çš„å›ç­”ï¼ŒæŠŠæˆ‘æƒ³è¯´çš„éƒ½è¯´äº†ã€‚é¡ºä¾¿æŠŠ Re0 å°è¯´çœ‹åˆ°æœ€è¿‘æ›´æ–°ã€‚ï¼ˆå½“æ—¶è§‰å¾—è¿˜èƒ½å†™å¾ˆä¹…ï¼Œæ²¡æƒ³åˆ°ä¸€ä¸‹ç¬¬å…­ç« å°±å®Œç»“äº†ï¼‰ã€‚</p><p>10æœˆç…§æ ·å¿™ç¢Œï¼Œæ¯å¤©å†™å®Œä»£ç å›æ¥çœ‹çœ‹ã€Šä¸–ç•Œå°½å¤´ä¸å†·é…·ä»™å¢ƒã€‹ã€‚é¡ºä¾¿æŠŠã€ŠSoma Bringerã€‹é€šå…³äº†ï¼Œç»ˆäºçŸ¥é“ DC å“¥å“¥å¤´åƒæ˜¯ä»€ä¹ˆäº†â€¦</p><p>11æœˆä¸€ç›´å¿™åˆ°ç°åœ¨ï¼Œçœ‹äº†ä¸€åŠã€Š<a href="https://book.douban.com/subject/3438303/">æŠ¬é«˜æˆ¿æ¢ï¼Œæœ¨åŒ ä»¬ï¼›è¥¿æ‘©ï¼šå°ä¼ </a>ã€‹ï¼Œç„¶åçœ‹äº†ä¸€åŠã€Šæ¬§æ´²ç°ä»£å²ã€‹ï¼Œèµ·å› æ˜¯å‘ç°å¾ˆå¤šæ¬§æ´²çš„ä¹¦éƒ½çœ‹ä¸æ‡‚â€¦11æœˆåº•çœ‹å®Œäº†ã€ŠèŠ±ä¸çˆ±ä¸½ä¸æ€äººäº‹ä»¶ã€‹ï¼ŒçœŸçš„çœ‹å¾—å¾ˆå¼€å¿ƒã€‚ç„¶åè¿™ä¸ªæœˆè¿˜è¡¥å®Œäº†ã€Šç¾ä¼¦Xã€‹çš„æ¼«ç”»ï¼Œç®—æ˜¯ã€Šç«¥å¹´çš„ç»ˆç»“ã€‹ç‡ƒå‘è‡´æ•¬äº†ã€‚è™½ç„¶æˆ‘ä¸å–œæ¬¢å…‹æ‹‰å…‹ï¼Œä½†æ˜¯æˆ‘è¿˜æ˜¯è›®å–œæ¬¢è¿™éƒ¨çš„â€¦</p><p>12æœˆäº†ï¼Œ2020å°±è¦ç»“æŸäº†ï¼Œä¸è¿‡æƒ³æƒ³ï¼Œä»Šå¹´åˆ°å¹´åº•çš„ç›®æ ‡å°±åªæœ‰ã€Šåœ¨è¿™ä¸ªä¸–ç•Œçš„è§’è½ã€‹å’Œã€Šå¤§äººå¸å›½ã€‹äº†ã€‚æˆ–è®¸ç›®æ ‡è¿˜ä¼šå˜å‘¢â€¦</p><p>è®°åŠ¨è¡çš„ä¸€å¹´ã€‚</p>]]></content>
      
      
      
        <tags>
            
            <tag> acgn </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Notes: brpc DoublyBufferedData</title>
      <link href="/2020/12/05/Notes-brpc-DoublyBuffer/"/>
      <url>/2020/12/05/Notes-brpc-DoublyBuffer/</url>
      
        <content type="html"><![CDATA[<p><code>DoublyBufferedData</code> é€»è¾‘ä¸Šæ˜¯ä¸€ä¸ªè¿™æ ·çš„æ•°æ®ç»“æ„ï¼š</p><ol><li>æŒæœ‰ä¸¤ä»½æ•°æ®ï¼Œè¯»åŒæ—¶è¯»ä¸€ä»½ï¼Œå†™çš„è¯å†™å¦ä¸€ä»½. å®ƒè‡ªå·±åˆ†ä¸º</li><li>å¹¶å‘è¯»å‡ ä¹æ˜¯æ²¡æœ‰ä»€ä¹ˆå¼€é”€çš„ï¼Œå†™/æ›´æ–°ä¼šæœ‰å¼€é”€ã€‚</li></ol><p>çœ‹ä»£ç æ³¨é‡Šå§ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">// This data structure makes Read() almost lock-free by making Modify()</span><br><span class="line">// *much* slower. It&#x27;s very suitable for implementing LoadBalancers which</span><br><span class="line">// have a lot of concurrent read-only ops from many threads and occasional</span><br><span class="line">// modifications of data. As a side effect, this data structure can store</span><br><span class="line">// a thread-local data for user.</span><br><span class="line">//</span><br><span class="line">// Read(): begin with a thread-local mutex locked then read the foreground</span><br><span class="line">// instance which will not be changed before the mutex is unlocked. Since the</span><br><span class="line">// mutex is only locked by Modify() with an empty critical section, the</span><br><span class="line">// function is almost lock-free.</span><br><span class="line">//</span><br><span class="line">// Modify(): Modify background instance which is not used by any Read(), flip</span><br><span class="line">// foreground and background, lock thread-local mutexes one by one to make</span><br><span class="line">// sure all existing Read() finish and later Read() see new foreground,</span><br><span class="line">// then modify background(foreground before flip) again.</span><br></pre></td></tr></table></figure><p>åŒæ—¶ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™ä¸ª <code>class</code> å®ç°çš„æ—¶å€™åˆ©ç”¨äº† TLSï¼Œæ‰€ä»¥ä½¿ç”¨çš„æ—¶å€™å®é™…ä¸Šå¯ä»¥è‡ªå®šä¹‰ TLSã€‚</p><p>å…ˆçœ‹è¿™ä¸ª <code>class</code> å¯¹å¤–æä¾›çš„æ¥å£ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T, <span class="keyword">typename</span> TLS = Void&gt;</span><br><span class="line"><span class="keyword">class</span> DoublyBufferedData &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">class</span> ScopedPtr &#123;</span><br><span class="line">    <span class="keyword">friend</span> <span class="keyword">class</span> DoublyBufferedData;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        <span class="built_in">ScopedPtr</span>() : _data(<span class="literal">NULL</span>), _w(<span class="literal">NULL</span>) &#123;&#125;</span><br><span class="line">        ~<span class="built_in">ScopedPtr</span>() &#123;</span><br><span class="line">            <span class="keyword">if</span> (_w) &#123;</span><br><span class="line">                _w-&gt;<span class="built_in">EndRead</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="type">const</span> T* <span class="title">get</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> _data; &#125;</span><br><span class="line">        <span class="type">const</span> T&amp; <span class="keyword">operator</span>*() <span class="type">const</span> &#123; <span class="keyword">return</span> *_data; &#125;</span><br><span class="line">        <span class="type">const</span> T* <span class="keyword">operator</span>-&gt;() <span class="type">const</span> &#123; <span class="keyword">return</span> _data; &#125;</span><br><span class="line">        <span class="function">TLS&amp; <span class="title">tls</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> _w-&gt;<span class="built_in">user_tls</span>(); &#125;</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">private</span>:</span><br><span class="line">        <span class="built_in">DISALLOW_COPY_AND_ASSIGN</span>(ScopedPtr);</span><br><span class="line">        <span class="type">const</span> T* _data;</span><br><span class="line">        Wrapper* _w;</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">DoublyBufferedData</span>();</span><br><span class="line">    ~<span class="built_in">DoublyBufferedData</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Put foreground instance into ptr. The instance will not be changed until</span></span><br><span class="line">    <span class="comment">// ptr is destructed.</span></span><br><span class="line">    <span class="comment">// This function is not blocked by Read() and Modify() in other threads.</span></span><br><span class="line">    <span class="comment">// Returns 0 on success, -1 otherwise.</span></span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">Read</span><span class="params">(ScopedPtr* ptr)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Modify background and foreground instances. fn(T&amp;, ...) will be called</span></span><br><span class="line">    <span class="comment">// twice. Modify() from different threads are exclusive from each other.</span></span><br><span class="line">    <span class="comment">// <span class="doctag">NOTE:</span> Call same series of fn to different equivalent instances should</span></span><br><span class="line">    <span class="comment">// result in equivalent instances, otherwise foreground and background</span></span><br><span class="line">    <span class="comment">// instance will be inconsistent.</span></span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">typename</span> Fn&gt; <span class="function"><span class="type">size_t</span> <span class="title">Modify</span><span class="params">(Fn&amp; fn)</span></span>;</span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">typename</span> Fn, <span class="keyword">typename</span> Arg1&gt; <span class="function"><span class="type">size_t</span> <span class="title">Modify</span><span class="params">(Fn&amp; fn, <span class="type">const</span> Arg1&amp;)</span></span>;</span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">typename</span> Fn, <span class="keyword">typename</span> Arg1, <span class="keyword">typename</span> Arg2&gt;</span><br><span class="line">    <span class="function"><span class="type">size_t</span> <span class="title">Modify</span><span class="params">(Fn&amp; fn, <span class="type">const</span> Arg1&amp;, <span class="type">const</span> Arg2&amp;)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// fn(T&amp; background, const T&amp; foreground, ...) will be called to background</span></span><br><span class="line">    <span class="comment">// and foreground instances respectively.</span></span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">typename</span> Fn&gt; <span class="function"><span class="type">size_t</span> <span class="title">ModifyWithForeground</span><span class="params">(Fn&amp; fn)</span></span>;</span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">typename</span> Fn, <span class="keyword">typename</span> Arg1&gt;</span><br><span class="line">    <span class="function"><span class="type">size_t</span> <span class="title">ModifyWithForeground</span><span class="params">(Fn&amp; fn, <span class="type">const</span> Arg1&amp;)</span></span>;</span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">typename</span> Fn, <span class="keyword">typename</span> Arg1, <span class="keyword">typename</span> Arg2&gt;</span><br><span class="line">    <span class="function"><span class="type">size_t</span> <span class="title">ModifyWithForeground</span><span class="params">(Fn&amp; fn, <span class="type">const</span> Arg1&amp;, <span class="type">const</span> Arg2&amp;)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ <code>Fn</code> æ˜¯æ›´æ–°å‡½æ•°ï¼Œè¿™ä¸ªæˆ‘ä»¬æš‚ä¸”ä¸è¡¨ã€‚å¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œæä¾›äº† <code>Read</code> å’Œ <code>Modify</code></p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ<code>Read</code> æ˜¯ä¾µå…¥å¼çš„ï¼Œéœ€è¦ä¸€ä¸ª <code>ScopedPtr</code> æ¥ç®¡ç†è¯»ç›¸å…³çš„ Ownershipã€‚<code>ScopedPtr</code> åŒæ—¶æ”¯æŒ <code>tls</code>, è¿™æ˜¯ thread local ç›¸å…³çš„è‡ªå®šä¹‰è¯­ä¹‰ã€‚</p><h3 id="å®ç°"><a href="#å®ç°" class="headerlink" title="å®ç°"></a>å®ç°</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T, <span class="keyword">typename</span> TLS = Void&gt;</span><br><span class="line"><span class="keyword">class</span> DoublyBufferedData &#123;</span><br><span class="line">    <span class="keyword">class</span> Wrapper;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">ScopedPtr</span> &#123;</span><br><span class="line">    <span class="keyword">friend</span> <span class="keyword">class</span> <span class="title class_">DoublyBufferedData</span>;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        <span class="built_in">ScopedPtr</span>() : _data(<span class="literal">NULL</span>), _w(<span class="literal">NULL</span>) &#123;&#125;</span><br><span class="line">        ~<span class="built_in">ScopedPtr</span>() &#123;</span><br><span class="line">            <span class="keyword">if</span> (_w) &#123;</span><br><span class="line">                _w-&gt;<span class="built_in">EndRead</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="type">const</span> T* <span class="title">get</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> _data; &#125;</span><br><span class="line">        <span class="type">const</span> T&amp; <span class="keyword">operator</span>*() <span class="type">const</span> &#123; <span class="keyword">return</span> *_data; &#125;</span><br><span class="line">        <span class="type">const</span> T* <span class="keyword">operator</span>-&gt;() <span class="type">const</span> &#123; <span class="keyword">return</span> _data; &#125;</span><br><span class="line">        <span class="function">TLS&amp; <span class="title">tls</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> _w-&gt;<span class="built_in">user_tls</span>(); &#125;</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">private</span>:</span><br><span class="line">        <span class="built_in">DISALLOW_COPY_AND_ASSIGN</span>(ScopedPtr);</span><br><span class="line">        <span class="type">const</span> T* _data;</span><br><span class="line">        Wrapper* _w;</span><br><span class="line">    &#125;;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="function"><span class="type">const</span> T* <span class="title">UnsafeRead</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function">    </span>&#123; <span class="keyword">return</span> _data + _index.<span class="built_in">load</span>(butil::memory_order_acquire); &#125;</span><br><span class="line">    <span class="function">Wrapper* <span class="title">AddWrapper</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">RemoveWrapper</span><span class="params">(Wrapper*)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Foreground and background void.</span></span><br><span class="line">    T _data[<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Index of foreground instance.</span></span><br><span class="line">    butil::atomic&lt;<span class="type">int</span>&gt; _index;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Key to access thread-local wrappers.</span></span><br><span class="line">    <span class="type">bool</span> _created_key;</span><br><span class="line">    <span class="type">pthread_key_t</span> _wrapper_key;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// All thread-local instances.</span></span><br><span class="line">    std::vector&lt;Wrapper*&gt; _wrappers;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Sequence access to _wrappers.</span></span><br><span class="line">    <span class="type">pthread_mutex_t</span> _wrappers_mutex;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Sequence modifications.</span></span><br><span class="line">    <span class="type">pthread_mutex_t</span> _modify_mutex;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å…³äº <code>pthread_key_t</code> å’Œç›¸å…³çš„ï¼Œå¯ä»¥çœ‹çœ‹ Linux ç³»ç»Ÿç¼–ç¨‹æ‰‹å†Œ 31èŠ‚ã€‚å®ƒåŒ…å«ä¸€äº›ç®€å•çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†çš„ç­–ç•¥ï¼Œçº¿ç¨‹ä¼šè‡ªåŠ¨ destruct æ•°æ®ã€‚</p><p><img src="https://image.mwish.me/blog-image/E38A4C61-DEEF-4C87-ADDF-9961485FC7BB.png" alt="E38A4C61-DEEF-4C87-ADDF-9961485FC7BB"></p><p>ç„¶åå¯ä»¥æ³¨æ„åˆ°è¿™ä¸ª wrapper ç±»å‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T, <span class="keyword">typename</span> TLS&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DoublyBufferedDataWrapperBase</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">TLS&amp; <span class="title">user_tls</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> _user_tls; &#125;</span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    TLS _user_tls;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DoublyBufferedDataWrapperBase</span>&lt;T, Void&gt; &#123;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// å•ä¸ªçº¿ç¨‹ä» Wrapper é‡Œé¢è¯»æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T, <span class="keyword">typename</span> TLS&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DoublyBufferedData</span>&lt;T, TLS&gt;::Wrapper</span><br><span class="line">    : <span class="keyword">public</span> DoublyBufferedDataWrapperBase&lt;T, TLS&gt; &#123;</span><br><span class="line"><span class="keyword">friend</span> <span class="keyword">class</span> <span class="title class_">DoublyBufferedData</span>;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">explicit</span> <span class="title">Wrapper</span><span class="params">(DoublyBufferedData* c)</span> : _control(c) &#123;</span></span><br><span class="line">        <span class="built_in">pthread_mutex_init</span>(&amp;_mutex, <span class="literal">NULL</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ~<span class="built_in">Wrapper</span>() &#123;</span><br><span class="line">        <span class="keyword">if</span> (_control != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            _control-&gt;<span class="built_in">RemoveWrapper</span>(<span class="keyword">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">pthread_mutex_destroy</span>(&amp;_mutex);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// _mutex will be locked by the calling pthread and DoublyBufferedData.</span></span><br><span class="line">    <span class="comment">// Most of the time, no modifications are done, so the mutex is</span></span><br><span class="line">    <span class="comment">// uncontended and fast.</span></span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">BeginRead</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="built_in">pthread_mutex_lock</span>(&amp;_mutex);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">EndRead</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="built_in">pthread_mutex_unlock</span>(&amp;_mutex);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">WaitReadDone</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="built_in">BAIDU_SCOPED_LOCK</span>(_mutex);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    DoublyBufferedData* _control;</span><br><span class="line">    <span class="type">pthread_mutex_t</span> _mutex;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ª wrapper æ˜¯ä¸€ä¸ª TLS ç›¸å…³çš„ç»“æ„ï¼Œå®ƒæœ¬èº«æ˜¯ä¼šè¢«å­˜æ”¾åœ¨ <code>DoublyBufferedData</code> çš„ TLS ç›¸å…³å†…å®¹ä¸­ã€‚è€Œä¸”å®ƒåªæœ‰è¯»ç›¸å…³çš„æƒé™ã€‚ä»–åœ¨å†…éƒ¨æœ‰ä¸€ä¸ª <code>_control</code>, æ§åˆ¶çš„æ˜¯å…·ä½“è¯»å– <code>DoublyBufferedData</code> çš„æ•°æ®ã€‚ä¸è¿‡è¯è¯´å›æ¥ï¼Œ<code>BeginRead</code> <code>EndRead</code> ç”šè‡³ææ„å‡½æ•°éƒ½æ¯”è¾ƒå¥½ç†è§£(<code>RemoveWrapper</code> ä¸€ä¼šå„¿è®²)ï¼Œä½†æ˜¯è¿™ä¸ª <code>WaitReadDone()</code> è®©äººæœ‰äº›è´¹è§£: æˆ‘ä»¬å…ˆçœ‹çœ‹å®ƒä»£ç å§</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// NOTE(gejun): c++11 deduces additional reference to the type.</span></span><br><span class="line"><span class="keyword">namespace</span> butil &#123;</span><br><span class="line"><span class="keyword">namespace</span> detail &#123;</span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">std::lock_guard&lt;<span class="keyword">typename</span> std::remove_reference&lt;T&gt;::type&gt; <span class="built_in">get_lock_guard</span>();</span><br><span class="line">&#125;  <span class="comment">// namespace detail</span></span><br><span class="line">&#125;  <span class="comment">// namespace butil</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BAIDU_SCOPED_LOCK(ref_of_lock)                                  \</span></span><br><span class="line"><span class="meta">    decltype(::butil::detail::get_lock_guard<span class="string">&lt;decltype(ref_of_lock)&gt;</span>()) \</span></span><br><span class="line"><span class="meta">    BAIDU_CONCAT(scoped_locker_dummy_at_line_, __LINE__)(ref_of_lock)</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;&gt; <span class="keyword">class</span> <span class="title class_">lock_guard</span>&lt;<span class="type">pthread_mutex_t</span>&gt; &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">explicit</span> <span class="title">lock_guard</span><span class="params">(<span class="type">pthread_mutex_t</span> &amp; mutex)</span> : _pmutex(&amp;mutex) &#123;</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> !defined(NDEBUG)</span></span><br><span class="line">        <span class="type">const</span> <span class="type">int</span> rc = <span class="built_in">pthread_mutex_lock</span>(_pmutex);</span><br><span class="line">        <span class="keyword">if</span> (rc) &#123;</span><br><span class="line">            <span class="built_in">LOG</span>(FATAL) &lt;&lt; <span class="string">&quot;Fail to lock pthread_mutex_t=&quot;</span> &lt;&lt; _pmutex &lt;&lt; <span class="string">&quot;, &quot;</span> &lt;&lt; <span class="built_in">berror</span>(rc);</span><br><span class="line">            _pmutex = <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">        <span class="built_in">pthread_mutex_lock</span>(_pmutex);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span>  <span class="comment">// NDEBUG</span></span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ~<span class="built_in">lock_guard</span>() &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> NDEBUG</span></span><br><span class="line">        <span class="keyword">if</span> (_pmutex) &#123;</span><br><span class="line">            <span class="built_in">pthread_mutex_unlock</span>(_pmutex);</span><br><span class="line">        &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">        <span class="built_in">pthread_mutex_unlock</span>(_pmutex);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="built_in">DISALLOW_COPY_AND_ASSIGN</span>(lock_guard);</span><br><span class="line">    <span class="type">pthread_mutex_t</span>* _pmutex;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå®ƒè‡ªå·±å®ç°äº†ä¸€å¥— <code>lock_guard</code>, ç„¶åå±€éƒ¨ lock äº†â€¦ç­‰ç­‰ï¼Œè¿™ä¸ªå°±æ˜¯ä¸€ä¸ª <code>scoped_lock</code>, é‚£å®ƒæ€ä¹ˆæ · fence å‘¢ï¼Ÿæˆ‘ä»¬å¾—çœ‹çœ‹ <code>Read</code> å’Œ <code>Modify</code> äº†ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T, <span class="keyword">typename</span> TLS&gt;</span><br><span class="line"><span class="type">int</span> DoublyBufferedData&lt;T, TLS&gt;::<span class="built_in">Read</span>(</span><br><span class="line">    <span class="keyword">typename</span> DoublyBufferedData&lt;T, TLS&gt;::ScopedPtr* ptr) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">BAIDU_UNLIKELY</span>(!_created_key)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    Wrapper* w = <span class="built_in">static_cast</span>&lt;Wrapper*&gt;(<span class="built_in">pthread_getspecific</span>(_wrapper_key));</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">BAIDU_LIKELY</span>(w != <span class="literal">NULL</span>)) &#123;</span><br><span class="line">        w-&gt;<span class="built_in">BeginRead</span>();</span><br><span class="line">        ptr-&gt;_data = <span class="built_in">UnsafeRead</span>();</span><br><span class="line">        ptr-&gt;_w = w;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    w = <span class="built_in">AddWrapper</span>();</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">BAIDU_LIKELY</span>(w != <span class="literal">NULL</span>)) &#123;</span><br><span class="line">        <span class="type">const</span> <span class="type">int</span> rc = <span class="built_in">pthread_setspecific</span>(_wrapper_key, w);</span><br><span class="line">        <span class="keyword">if</span> (rc == <span class="number">0</span>) &#123;</span><br><span class="line">            w-&gt;<span class="built_in">BeginRead</span>();</span><br><span class="line">            ptr-&gt;_data = <span class="built_in">UnsafeRead</span>();</span><br><span class="line">            ptr-&gt;_w = w;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>è·å¾— TLS çš„ Wrapper, å¦åˆ™å°è¯•æ·»åŠ ä¸€ä¸ªå¯¹åº”çš„ Wrapper</li><li>è¯»çš„æ—¶å€™ï¼Œå¼€å¯ <code>w-&gt;BeginRead</code> ï¼Œç„¶åæ„é€ ä¸€ä¸ª <code>ScopedPtr</code> å¯¹è±¡ï¼Œå®ƒåœ¨å¤–éƒ¨ææ„çš„æ—¶å€™ä¼šè°ƒç”¨ <code>EndRead</code></li></ul><p><code>UnsafeRead</code> é€»è¾‘å¦‚ä¸‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">const</span> T* <span class="title">UnsafeRead</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123; <span class="keyword">return</span> _data + _index.<span class="built_in">load</span>(butil::memory_order_acquire); &#125;</span><br></pre></td></tr></table></figure><p>æ³¨æ„è¿™é‡Œæ˜¯ <code>acquire</code>ï¼Œæˆ‘ä»¬ä¸‹æ–‡ä¼šæåˆ°ã€‚</p><p>è€Œ <code>AddWrapper</code> çš„é€»è¾‘ä¹Ÿå¾ˆæ¸…æ™°ï¼Œå®ƒçš„é€»è¾‘å—åˆ° <code>_wrappers_mutex</code> ä¿æŠ¤ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Called when thread initializes thread-local wrapper.</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T, <span class="keyword">typename</span> TLS&gt;</span><br><span class="line"><span class="keyword">typename</span> DoublyBufferedData&lt;T, TLS&gt;::Wrapper*</span><br><span class="line">DoublyBufferedData&lt;T, TLS&gt;::<span class="built_in">AddWrapper</span>() &#123;</span><br><span class="line">    <span class="function">std::unique_ptr&lt;Wrapper&gt; <span class="title">w</span><span class="params">(<span class="keyword">new</span> (std::nothrow) Wrapper(<span class="keyword">this</span>))</span></span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">NULL</span> == w) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="built_in">BAIDU_SCOPED_LOCK</span>(_wrappers_mutex);</span><br><span class="line">        _wrappers.<span class="built_in">push_back</span>(w.<span class="built_in">get</span>());</span><br><span class="line">    &#125; <span class="built_in">catch</span> (std::exception&amp; e) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> w.<span class="built_in">release</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Called when thread quits.</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T, <span class="keyword">typename</span> TLS&gt;</span><br><span class="line"><span class="type">void</span> DoublyBufferedData&lt;T, TLS&gt;::<span class="built_in">RemoveWrapper</span>(</span><br><span class="line">    <span class="keyword">typename</span> DoublyBufferedData&lt;T, TLS&gt;::Wrapper* w) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">NULL</span> == w) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">BAIDU_SCOPED_LOCK</span>(_wrappers_mutex);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; _wrappers.<span class="built_in">size</span>(); ++i) &#123;</span><br><span class="line">        <span class="keyword">if</span> (_wrappers[i] == w) &#123;</span><br><span class="line">            _wrappers[i] = _wrappers.<span class="built_in">back</span>();</span><br><span class="line">            _wrappers.<span class="built_in">pop_back</span>();</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç›®å‰éƒ½æ²¡ä»€ä¹ˆé—®é¢˜ï¼Œä½†æ˜¯æˆ‘ä»¬å¾—çœ‹çœ‹å†™æ˜¯æ€ä¹ˆå®ç°çš„ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T, <span class="keyword">typename</span> TLS&gt;</span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> Fn&gt;</span><br><span class="line"><span class="type">size_t</span> DoublyBufferedData&lt;T, TLS&gt;::<span class="built_in">Modify</span>(Fn&amp; fn) &#123;</span><br><span class="line">    <span class="comment">// _modify_mutex sequences modifications. Using a separate mutex rather</span></span><br><span class="line">    <span class="comment">// than _wrappers_mutex is to avoid blocking threads calling</span></span><br><span class="line">    <span class="comment">// AddWrapper() or RemoveWrapper() too long. Most of the time, modifications</span></span><br><span class="line">    <span class="comment">// are done by one thread, contention should be negligible.</span></span><br><span class="line">    <span class="built_in">BAIDU_SCOPED_LOCK</span>(_modify_mutex);</span><br><span class="line">    <span class="type">int</span> bg_index = !_index.<span class="built_in">load</span>(butil::memory_order_relaxed);</span><br><span class="line">    <span class="comment">// background instance is not accessed by other threads, being safe to</span></span><br><span class="line">    <span class="comment">// modify.</span></span><br><span class="line">    <span class="type">const</span> <span class="type">size_t</span> ret = <span class="built_in">fn</span>(_data[bg_index]);</span><br><span class="line">    <span class="keyword">if</span> (!ret) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Publish, flip background and foreground.</span></span><br><span class="line">    <span class="comment">// The release fence matches with the acquire fence in UnsafeRead() to</span></span><br><span class="line">    <span class="comment">// make readers which just begin to read the new foreground instance see</span></span><br><span class="line">    <span class="comment">// all changes made in fn.</span></span><br><span class="line">    _index.<span class="built_in">store</span>(bg_index, butil::memory_order_release);</span><br><span class="line">    bg_index = !bg_index;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Wait until all threads finishes current reading. When they begin next</span></span><br><span class="line">    <span class="comment">// read, they should see updated _index.</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">BAIDU_SCOPED_LOCK</span>(_wrappers_mutex);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; _wrappers.<span class="built_in">size</span>(); ++i) &#123;</span><br><span class="line">            _wrappers[i]-&gt;<span class="built_in">WaitReadDone</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">const</span> <span class="type">size_t</span> ret2 = <span class="built_in">fn</span>(_data[bg_index]);</span><br><span class="line">    <span class="built_in">CHECK_EQ</span>(ret2, ret) &lt;&lt; <span class="string">&quot;index=&quot;</span> &lt;&lt; _index.<span class="built_in">load</span>(butil::memory_order_relaxed);</span><br><span class="line">    <span class="keyword">return</span> ret2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li><p>å†™ä¼š grab <code>_modify_mutex</code></p></li><li><p>æ‹¿åˆ°éœ€è¦ä¿®æ”¹çš„ <code>index</code>, å› ä¸º <code>_index</code> åªæœ‰ <code>0</code> <code>1</code></p></li><li><p><code>fn(_data[bg_index])</code> ä¿®æ”¹ã€‚è¿™ä¸ªæ—¶å€™</p><ol><li>åªæœ‰ä¸€ä¸ª modifyï¼Œè¿™æ˜¯ <code>_modify_mutex</code> ä¿è¯çš„</li><li>è¯»ä¸ä¼šè¯»åˆ° <code>_data[bg_index]</code> .è¿™ä¸ªä¿è¯å¾—æ•´ä½“é€»è¾‘ä¸€èµ·çœ‹</li></ol></li><li><p>å†™å…¥ <code>_index</code>, è¿™ä¸ªæ—¶å€™è¯»ä¹‹å‰æ”¹è¿‡çš„æ˜¯å®‰å…¨çš„</p><ol><li>Q: ä¸ºä»€ä¹ˆéœ€è¦ release ?</li><li>A: seq_cst è‚¯å®šæ˜¯å¯ä»¥çš„ï¼Œå¦‚æœæ˜¯ <code>relaxed</code> çš„è¯ï¼Œæ²¡æœ‰ <code>fence</code> çš„è¯ï¼Œ<code>UnsafeRead</code> ä¼šè¯»åˆ°æ··å†™çš„æ•°æ®ã€‚è¿™é‡ŒæœŸæœ›å†™ä¸é˜»å¡è¯»ã€‚</li></ol></li><li><p><code>BAIDU_SCOPED_LOCK</code> æ¥ grab <code>_wrappers_mutex</code>, è¿™é‡Œä¿è¯ä¸ä¼š <code>AddWrappers</code> æˆ–è€… <code>RemoveWrappers</code>, æ¯ä¸ªåˆ†é…å‡ºå»çš„ <code>Wrappers</code> å‡ºå»ä¸‹é¢ä¸¤ç§çŠ¶æ€ä¹‹ä¸€ï¼š</p><ol><li>åˆ†é…å‡ºå»äº†ï¼ŒæŒæœ‰äº†è‡ªå·±çš„ <code>mutex_</code>ï¼Œå†è¿›è¡Œ <code>UnsafeRead</code></li><li>ä¹ˆæœ‰åˆ†é…å‡ºå»ï¼Œä¹Ÿæ²¡æœ‰ <code>UnsafeRead</code></li></ol><p>æ‰€ä»¥ä¸Š <code>_wrappers_mutex</code> åå† <code>WaitReadDone</code> ä¹‹åï¼ŒçŠ¶æ€æ˜¯å®‰å…¨çš„. </p></li><li><p>ä¿®æ”¹åŸæ¥çš„æ•°æ®ï¼Œè¿”å›ã€‚</p></li></ol><p>ä¸Šè¿°æ„Ÿè§‰ <code>5</code> é‡Œé¢æœ‰ä¸€äº›éšå«çš„é£é™©ï¼Œå‡è®¾ä¸€ä¸ªçº¿ç¨‹æ‹¿äº†ä¸¤ä¸ª <code>ScopedPtr</code>, ç„¶å Block åœ¨ç¬¬äºŒä¸ªä¸Šï¼Œç¬¬ä¸€ä¸ªæ­»éƒ½ä¸é‡Šæ”¾ï¼Œé‚£ä¹ˆç¨‹åºå°±â€¦æ„Ÿè§‰è¿™ä¸ªæ˜¯ä¸æ˜¯å…¶å®æ”¹æˆå¯é‡å…¥é”å®‰å…¨ä¸€äº›ï¼Ÿ</p><h2 id="æ„Ÿæƒ³"><a href="#æ„Ÿæƒ³" class="headerlink" title="æ„Ÿæƒ³"></a>æ„Ÿæƒ³</h2><p>è¯»äº†ä¸€éï¼Œç»ˆäºçŸ¥é“è¿™ä¸ªç©æ„æ€ä¹ˆ work äº†ã€‚ä½†æ˜¯æˆ‘æ„Ÿè§‰æˆ‘è®¾è®¡ä¸å‡ºè¿™ä¹ˆå·§å¦™çš„ä¸œè¥¿ï¼Œæœ‰ä»€ä¹ˆå‚è€ƒææ–™å—ï¼Œå›§â€¦</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Thrift IDL</title>
      <link href="/2020/12/04/Thrift-IDL/"/>
      <url>/2020/12/04/Thrift-IDL/</url>
      
        <content type="html"><![CDATA[<p>æœ€è¿‘åœ¨å¤ä¹  DDIA, æœ¬æ¥æ‰“ç®—æŠŠä¸€äº›åºåˆ—åŒ–ç›¸å…³çš„å†…å®¹å†™ä¸€ç¯‡å¾ˆé•¿çš„æ–‡ç« ï¼Œé¢„æœŸå†…å®¹ä»å¯è¯»çš„ json åˆ° thrift/pb åˆ° avro, å†åˆ° MySQL çš„ Row formatï¼Œåˆ° Apache Arrowã€‚ç»“æœæœ€è¿‘è¢«è‡ªå·±å†™çš„ bug å‘åˆ°æƒ³æ­»ï¼Œç„¶åä»Šå¤©13æœºå…µåˆåˆ°äº†â€¦é‚£æˆ‘ä»¬ä»ç®€å§ï¼Œå†™å®Œäº†èµ¶ç´§æ‰“æ¸¸æˆã€‚</p><p>Thrift æ˜¯ä¸€ä¸ªæä¾›äº†ä»£ç ç”Ÿæˆã€æœåŠ¡ç«¯çš„åº“ï¼Œå…è®¸ä½ åœ¨ä¸Šé¢ç¼–ç¨‹ï¼š</p><p><img src="https://image.mwish.me/blog-image/Apache_Thrift_architecture.png" alt="Apache_Thrift_architecture"></p><p>Facebook å†…éƒ¨æœ‰å„ç§è¯­è¨€ç¼–å†™çš„ç³»ç»Ÿï¼Œè€Œ thrift éœ€è¦ä¸ºæ‰€æœ‰çš„è¯­è¨€è¿›è¡ŒæœåŠ¡ã€‚ä»–éœ€è¦å®ç° C/S åè®®ï¼Œå®ç°å¯¹åº”çš„åº”ç”¨å±‚çš„ä¼ è¾“ï¼Œç„¶åç»™ç”¨æˆ·ä¸€å±‚é€æ˜çš„ç¼–å†™çš„æŠ½è±¡ã€‚</p><p>æŠ½è±¡å¾ˆé‡è¦çš„ä¸€éƒ¨åˆ†æ˜¯ IDL. ç›¸å¯¹äº JSON æ¥è¯´ï¼Œthrift ç»™æˆ‘ä»¬æä¾›äº†ç¼–å†™ idl çš„èƒ½åŠ›ï¼Œæˆ‘ä»¬å¯ä»¥ä»¥æ­¤æ¥ç”Ÿæˆç‰¹å®šè¯­è¨€çš„ stub ä»£ç ã€‚ä½†æ˜¯ä¸€ä¸ªå¾ˆé‡è¦çš„äº‹æƒ…æ˜¯ï¼š</p><ul><li>å‡è®¾æˆ‘ä½¿ç”¨çš„æ˜¯ JSON + REST æˆ‘å¯ä»¥é€šè¿‡ REST çš„ <code>/v</code> æ¥æ ‡æ³¨å¯¹åº”çš„ç‰ˆæœ¬ï¼ŒåŒæ—¶å°çš„ç‰ˆæœ¬ä¿®æ”¹ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨æœåŠ¡ç«¯åµŒå…¥å¯¹åº”çš„é€»è¾‘ï¼Œæ¯”å¦‚æˆ‘ä»¬å˜æ›´äº†ä¸€ä¸ªå­—æ®µçš„ç±»å‹ï¼Œæˆ–è€…æ·»åŠ äº†ä¸€ä¸ªå­—æ®µï¼Œæˆ‘ä»¬åªè¦åœ¨æœåŠ¡ç«¯å¤„ç†äº†å¯¹åº”çš„é€»è¾‘å³å¯ã€‚</li></ul><p>è€Œ Thrift ç›¸å¯¹æ¥è¯´æ˜¯ä¸å¯è¯»çš„ï¼šæˆ‘ä»¬ç¼–å†™å¯è¯»çš„ idl, ç”Ÿæˆæˆ‘ä»¬è‡ªå·±éƒ½æ‡’å¾—çœ‹çš„é™æ€çš„ idl ä»£ç ï¼Œç„¶åæˆ‘ä»¬åœ¨ idl ä»£ç ä¸Šçæã€‚ç›¸å¯¹äº Json é‚£ç§è°çœ‹äº†éƒ½æ˜ç™½çš„ç»“æ„ï¼Œthrift å¯èƒ½ä¼˜åŒ–äº†ç©ºé—´ï¼Œä½†æ˜¯æˆ‘ä»¬è¦é¢å¯¹ä¸€äº›é—®é¢˜ï¼š</p><ul><li>ä»–ç”Ÿæˆçš„ binary æ˜¯æ€ä¹ˆæ ·çš„ï¼ˆå…¶å®ä¸é‚£ä¹ˆé‡è¦ï¼Œä½†æ˜¯ç†è§£è¿™ä¸ªæ‰èƒ½ç†è§£ä¸‹é¢é‡è¦çš„ä¸œè¥¿ï¼‰</li><li><strong>å˜æ›´çš„æ—¶å€™ï¼Œæ€ä¹ˆæ ·ä¿®æ”¹ idl æ˜¯åˆç†çš„</strong></li></ul><p>ç¬¬ä¸€ä¸ªé—®é¢˜æœ¬èº«æ²¡é‚£ä¹ˆé‡è¦ï¼Œä½†æ˜¯ä»–å¯¹ç†è§£â€œæ€ä¹ˆæ ·ä¿®æ”¹ idl æ˜¯åˆç†çš„â€å¾ˆé‡è¦ã€‚å®é™…ä¸Šï¼Œå¯¹äºè¿™ç‚¹ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œthrift ä¼šæ”¯æŒï¼š</p><ol><li><em>Types</em></li><li><em>Versioning</em></li></ol><h2 id="Types-in-Thrift"><a href="#Types-in-Thrift" class="headerlink" title="Types in Thrift"></a>Types in Thrift</h2><p><a href="https://thrift.apache.org/docs/types.html">https://thrift.apache.org/docs/types.html</a></p><h3 id="Base-types"><a href="#Base-types" class="headerlink" title="Base types"></a>Base types</h3><p>Thrift æ”¯æŒï¼š</p><ul><li><code>bool</code>A boolean value, true or false</li><li><code>byte</code> A signed byte</li><li><code>i16</code> A 16-bit signed integer</li><li><code>i32</code> A 32-bit signed integer</li><li><code>i64</code> A 64-bit signed integer</li><li><code>double</code> A 64-bit floating point number</li><li><code>string</code> An encoding-agnostic text or binary string</li></ul><p>è¿™é‡Œéœ€è¦æ³¨æ„ï¼š</p><ol><li>ä¸æ”¯æŒ <code>float</code>, å› ä¸ºéƒ¨åˆ†è¯­è¨€æ²¡æœ‰ã€‚</li><li>ä¸æ”¯æŒ <code>unsigned</code>, å¦‚æœéœ€è¦ <code>unsigned</code>, ä½ å¾— cast äº†ã€‚</li></ol><p>éœ€è¦è¯´æ˜çš„æ—¶å€™ï¼Œåœ¨ä¼ è¾“çš„æ—¶å€™ï¼Œä»–æ˜¯æŒ‰ç½‘ç»œåºä¼ è¾“çš„ã€‚åŒæ—¶ï¼Œæˆ‘ä»¬ä¹‹å‰è°ˆå¤§å°ç«¯çš„æ—¶å€™è¯´åˆ° <code>double</code> çš„é—®é¢˜ã€‚è¿™é‡Œåœ¨ä¼ è¾“çš„æ—¶å€™ï¼Œä¼šæŠŠ <code>double</code> ç»™ <code>reinterpret_cast</code> æˆ <code>i64</code>, ç„¶åæŒ‰ç½‘ç»œåºå‘é€ã€‚</p><p>è€Œ <code>bool</code> ä¼šè¢«æŒ‰ <code>i8</code> ä¼ è¾“ã€‚<code>string</code> ä¼šè¢«ç»„ç»‡æˆ <code>prefix_length</code> + <code>data</code> çš„å½¢å¼ã€‚</p><h4 id="containers"><a href="#containers" class="headerlink" title="containers"></a>containers</h4><p>åŒæ—¶ï¼Œé™¤äº†ä¸Šé¢çš„åŸºç¡€ç±»å‹, å®ƒè¿˜æ”¯æŒå®¹å™¨ï¼Œå¯¹åº” <code>list</code>  <code>set</code> å’Œ <code>map</code> . è¿™äº›ç±»å‹è¦æ±‚æ˜¯ iterable çš„ã€‚</p><h4 id="structs"><a href="#structs" class="headerlink" title="structs"></a>structs</h4><p>è¡¨ç¤ºç»“æ„ï¼Œéœ€è¦</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Example</span> &#123;</span> </span><br><span class="line"><span class="number">1</span>:i32 number=<span class="number">10</span>, </span><br><span class="line"><span class="number">2</span>:i64 bigNumber,  </span><br><span class="line"><span class="number">3</span>:<span class="type">double</span> decimals,</span><br><span class="line"><span class="number">4</span>:<span class="built_in">string</span> name=<span class="string">&quot;thrifty&quot;</span> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½ ç”šè‡³å¯ä»¥è®¾ç½® default å€¼ï¼ŒåŒæ—¶ï¼Œå¯ä»¥æ˜¾å¼è®¾ç½® tagã€‚</p><p>Thrift è¿˜æ”¯æŒäº† message å’Œ serviceï¼Œä½†æ˜¯ä»Šå¤©ç•¥è¿‡ä¸è¡¨ã€‚</p><h2 id="Interface"><a href="#Interface" class="headerlink" title="Interface"></a>Interface</h2><p>å†…å­˜ç»“æ„å’ŒäºŒè¿›åˆ¶è¡¨ç¤ºæ˜¯åˆ†å¼€çš„ï¼Œå®é™…ä¸Šï¼Œthrift ç”šè‡³å¯ä»¥æŒ‡å®š JSONï¼Œxmlã€‚ä¸è¿‡æˆ‘ä»¬ä»Šå¤©å°±ä»‹ç»ä»–çš„ IDLï¼Œæ‰€ä»¥åˆ«çš„ä¸è¡¨ã€‚</p><p>åœ¨ç”Ÿæˆçš„æ—¶å€™æˆ‘ä»¬æœ‰å¦‚ä¸‹æ¥å£ï¼š</p><p><img src="https://image.mwish.me/blog-image/F7DF206F-44D2-4486-AF34-71DFB47E8821.png" alt="F7DF206F-44D2-4486-AF34-71DFB47E8821"></p><p>æˆ‘ç›¸ä¿¡æ²¡è€å¿ƒçœ‹å®Œâ€¦æœ‰å‡ ä¸ªé‡è¦çš„æ˜¯ï¼š</p><ol><li><code>read</code> å¯¹åº”çš„å¤åˆç±»å‹çš„ <code>readBegin</code> + <code>readEnd</code></li><li><code>write</code>å¯¹åº”çš„å¤åˆç±»å‹çš„ <code>readBegin</code> + <code>readEnd</code></li><li><code>write</code> å¯¹åº”çš„ <code>writeFieldStop</code> </li></ol><blockquote><p>The procedure for reading a struct is to readFieldBegin() until the stop field is encountered, and then to readStructEnd(). The generated code relies upon this call sequence to ensure that everything written by a protocol encoder can be read by a matching protocol decoder.</p></blockquote><p>ä¸Šè¿°çš„å†…å®¹ä¼šåœ¨ä»£ç ä¸­è¢«ç”Ÿæˆï¼Œç„¶åæŒ‰ç…§ç±»å‹è¢«å†™å…¥ã€‚</p><p>è¿™ä¸ªåŒæ—¶è·Ÿ idl ä¸­çš„ <code>optional</code>  <code>required</code> å’Œ default æ˜¯æŒ‚é’©çš„ï¼Œå¯ä»¥çœ‹çœ‹è¿™ä¸ª SOï¼š</p><p><a href="https://stackoverflow.com/questions/34100425/apache-thrift-when-use-optional-before-a-list-c-server-seems-not-to-return">https://stackoverflow.com/questions/34100425/apache-thrift-when-use-optional-before-a-list-c-server-seems-not-to-return</a></p><p>è¿™é‡Œæ˜¾ç¤ºï¼Œidl ç”Ÿæˆçš„ä»£ç ï¼Œå†™å…¥çš„æ—¶å€™ã€è¯»å–çš„æ—¶å€™ä¼šç”Ÿæˆå­—æ®µï¼Œè€Œ<code>optional</code> ä¼šå½±å“å¯¹åº”çš„å†™å…¥ã€‚</p><h3 id="Binary"><a href="#Binary" class="headerlink" title="Binary"></a>Binary</h3><p>binary å¯ä»¥è¯¦è§ Compact å’Œ Binary çš„æ–‡æ¡£ï¼š</p><ul><li><a href="https://github.com/apache/thrift/blob/master/doc/specs/thrift-binary-protocol.md">https://github.com/apache/thrift/blob/master/doc/specs/thrift-binary-protocol.md</a></li><li><a href="https://github.com/apache/thrift/blob/master/doc/specs/thrift-compact-protocol.md">https://github.com/apache/thrift/blob/master/doc/specs/thrift-compact-protocol.md</a></li></ul><p>æˆ‘ä»¬ä»‹ç» binary:</p><p><img src="https://image.mwish.me/blog-image/2B9FDC8D-470E-4F5E-8E55-F1B7FE54BCC2.png" alt="2B9FDC8D-470E-4F5E-8E55-F1B7FE54BCC2"></p><p><img src="https://image.mwish.me/blog-image/50C3BFC4-24E5-4C9B-9466-69A9981B1E62.png" alt="50C3BFC4-24E5-4C9B-9466-69A9981B1E62"></p><p>å®é™…ä¸Šï¼Œä½ ä¼šçŸ¥é“ä¸€ç‚¹ï¼š</p><ol><li>Stop field èƒ½ explicit çš„è¡¨ç¤ºç»“æŸï¼Œè€Œä¸”åˆ«çš„ç¼–ç ä¸ä¼šå½±å“ä»–çš„æ­£ç¡®æ€§</li><li>è¿™é‡Œæ²¡æœ‰ nameï¼Œåªæœ‰ field id</li><li>field å¯èƒ½æ˜¯ä¹±åºçš„</li></ol><p>é‚£ä¹ˆæˆ‘ä»¬å®é™…ä¸ŠçŸ¥é“ï¼Œfield id æ˜¯ä¸èƒ½ä¹±è®¾çš„ï¼æˆ‘ä»¬ä¹Ÿå¯ä»¥è¯»è¯» spec é‡Œé¢çš„: <a href="https://github.com/apache/thrift/blob/master/doc/specs/SequenceNumbers.md">https://github.com/apache/thrift/blob/master/doc/specs/SequenceNumbers.md</a></p><h2 id="ç¼–ç¨‹-amp-Version"><a href="#ç¼–ç¨‹-amp-Version" class="headerlink" title="ç¼–ç¨‹ &amp; Version"></a>ç¼–ç¨‹ &amp; Version</h2><p><img src="https://image.mwish.me/blog-image/88075741-4060-4010-B4EF-0B9F9CDD53F8.png" alt="88075741-4060-4010-B4EF-0B9F9CDD53F8"></p><p>ä»¥ C++ ä¸ºä¾‹ï¼Œç”¨æˆ·å®é™…ä¸Šé™¤äº†æ•°æ®ï¼Œè¿˜èƒ½çœ‹åˆ°ä¸€ä¸ª <code>__isset</code> ï¼Œè¿™ä¸ªå­—æ®µæ˜¯ <code>public</code> çš„ã€‚è¿™ä¸ªè¢«ç”¨æ¥è¯†åˆ«ç‰ˆæœ¬ï¼š</p><ul><li>ä¸è®¤è¯†çš„ tag å­—æ®µè¢«ä¸¢å¼ƒ</li><li>æœ‰çš„å­—æ®µè®¾ç½® <code>__isset</code></li></ul><p>ä¸Šè¿°åŠŸèƒ½å¯ä»¥å®ç°ç‰ˆæœ¬ã€‚å…·ä½“å¯ä»¥çœ‹ whitepaper 5.3 çš„ case analysis:</p><p><img src="https://image.mwish.me/blog-image/0CB17CF3-7E2C-4DA2-A825-BAF31A220D10.png" alt="0CB17CF3-7E2C-4DA2-A825-BAF31A220D10"></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Long Tail Key &amp;&amp; Memcache in FB</title>
      <link href="/2020/11/23/Long-Tail-Key-Memcache-in-FB/"/>
      <url>/2020/11/23/Long-Tail-Key-Memcache-in-FB/</url>
      
        <content type="html"><![CDATA[<p>ä¹‹å‰è¿™ç¯‡æ–‡ç« å¤§ä½“ä»‹ç»äº†ä¸€ä¸‹ memcache çš„æ¶æ„ï¼š <a href="https://zhuanlan.zhihu.com/p/194347153">https://zhuanlan.zhihu.com/p/194347153</a></p><p>ä¸Šè¿°ä¸€äº›åœ¨è¿™ç¯‡æ–‡ç« ä¸­ä¼šç”¨åˆ°çš„æ¦‚å¿µæœ‰ï¼š</p><ul><li>Memcache Pool: æŒ‰ç…§ key åˆ‡åˆ†æˆä¸ºä¸åŒçš„ Pool, é€‚é…ä¸åŒçš„ key å’Œ key ä¸åŒçš„è¯»å†™é¢‘ç‡ã€‚åŒæ—¶ï¼ŒæŠŠå†·çƒ­-é«˜ä½ä»£ä»·çš„æ•°æ®æ”¾åœ¨ä¸åŒçš„æ± å­é‡Œï¼Œç„¶å tunning, æ¥ä¿è¯ç³»ç»Ÿæ•ˆç‡ã€‚</li><li>Lease æœºåˆ¶ï¼šç”¨ Lease æ¥æ§åˆ¶ä¸€è‡´æ€§</li><li>In a Region: Replication<ul><li><code>frontend cluster</code> å³ä¸€ç»„ æœåŠ¡å™¨å’Œmemcachedã€‚å¤šç»„ frontend cluster å­˜å‚¨åˆ°åº•å±‚çš„ storage ä¸Šã€‚</li><li>åœ¨ Region å±‚é¢ï¼Œä¹Ÿæœ‰ Region Pool, è¿™æ˜¯ä¸€ç§èµ„æºå…±äº«ã€‚Region ä¸­ frontend è¯·æ±‚ä¸ä¸€ï¼Œä½†å¯¹åº”å­˜å‚¨å±‚æ˜¯ä¸€æ ·çš„ã€‚å¯¹äºæŸç±»æ•°æ®ï¼šå³æ•°é‡å°‘è®¿é—®è´µçš„ï¼Œå¯ä»¥è¢«ç§»åˆ°ä¸€ä¸ªå…±äº«çš„æ± å­ä¸­ã€‚</li></ul></li></ul><p>é˜…è¯» FB åˆ†å‰²çš„æ—¶å€™æœ€å¥½ç†è§£ä¸Šè¿°æ–‡ç« çš„å¯¹åº”å†…å®¹ã€‚åŒæ—¶ï¼Œè¿™ç¯‡æ–‡ç« å»ºæ¨¡çš„æ—¶å€™å¤§é‡ä½¿ç”¨äº† <code>user</code> è¿™ä¸ªè¯ï¼Œå¯èƒ½æŸç§ç¨‹åº¦ä¸Šï¼Œfb èµ„æºæ˜¯ä»¥ user åšæŸäº›æ–¹å¼ sharding çš„ï¼Œä¸è¿‡æ–‡ç« ä¹Ÿè§£é‡Šäº†ï¼Œå¯¹èµ„æºçš„è¯·æ±‚æœ‰å’Œç”¨æˆ·ç«çƒ­ç¨‹åº¦ç›¸ä¼¼çš„åˆ†å¸ƒã€‚</p><p>äº†è§£äº†æ¶æ„ä¹‹åï¼Œå®é™…ä¸Šæ•°æ®ä¼šæœ‰ä¸Šé¢è¯´çš„ï¼Œåˆ†å¸ƒçš„é—®é¢˜ï¼š</p><p><img src="https://image.mwish.me/blog-image/7EC471A1-D7FF-4F7A-B46E-36AD9005BDD4.png" alt="7EC471A1-D7FF-4F7A-B46E-36AD9005BDD4"></p><ul><li>90% çš„è¯·æ±‚æ˜¯å°‘äºè®¿é—®32æ¬¡çš„ï¼Œå¾ˆå¤šäººè‡³å¤šæœ‰ 100 ä¸ªæœ‹å‹ï¼Œå¹¶ä¸”åªå’Œä»–ä»¬å‘æ¶ˆæ¯/çœ‹ä»–ä»¬ç›¸å…³çš„å†…å®¹ã€‚</li><li>éƒ¨åˆ†ç«çƒ­çš„ç”¨æˆ·/èµ„æºè®¿é—®é¢‘ç‡å¾ˆé«˜ã€‚</li></ul><p>FB å¸Œæœ›ï¼š</p><ul><li>ä¸€ä¸ª region pool å†…çš„çƒ­æ•°æ®èƒ½å°½é‡åœ¨å¤šä¸ªå¯¹åº” <code>frontend cluster</code> ç¼“å­˜ä¸­</li><li>å†·æ•°æ®å…¨éƒ¨å ç”¨ RAM çš„è¯ä¼šæ˜¯ä¸€ç¬”å·¨å¤§çš„å¼€é”€ï¼Œå¯ä»¥æŠŠä»–ä»¬åˆ†é…åœ¨ä¸å¸¸è®¿é—®/è®¿é—®ä»£ä»·ç¨é«˜çš„åœ°æ–¹ã€‚</li></ul><p>è®ºæ–‡æŠŠ memcache é›†ç¾¤åˆ†ä¸ºäº† frontend cluster ç‹¬ç«‹çš„ L1 cache å’Œå…±äº«çš„ L2 cacheï¼Œè¿™ç±»ä¼¼ CPU çš„æ¶æ„ï¼Œä¸åŒäº CPUï¼Œç”±äºè®¿é—®æ—¶é—´/penalty çš„å¢åŠ ï¼Œå¯ä»¥ç”¨ä¸€äº›åˆ«çš„å¯èƒ½å¤æ‚ä¸€äº›ã€æ›´å¥½é¢„æµ‹çš„ç¼“å­˜ç®—æ³•ï¼Œå–ä»£ä¸€äº›å¯ä»¥åšåˆ°ç¡¬ä»¶é‡Œçš„ LRU/ç±»LRU ç­–ç•¥ï¼Œæ¥å‡å° penaltyã€‚</p><p>å½“ç„¶ï¼Œå°±æˆ‘ä¸ªäººæ„Ÿå—æ¥çœ‹ï¼Œmemcache åº”è¯¥æ˜¯ fb ä¸€ä¸ªé€šç”¨ç³»ç»Ÿï¼Œæ‰€ä»¥æ„Ÿè§‰å®ƒçš„ç®—æ³•ä¼šåšçš„ common ä¸€äº›ï¼Œè€Œä¸æ˜¯æ ¹æ®æŸäº›ä¸šåŠ¡çš„è¯·æ±‚åšä¸€äº›æ¿€è¿›çš„ä¼˜åŒ–ã€‚</p><h2 id="Concepts"><a href="#Concepts" class="headerlink" title="Concepts"></a>Concepts</h2><blockquote><p>Each key-value pair has a key ID, which is a string. A normalized version of key-id is defined as a normalized key. For example, key ID <code>photos:foobar:&#123;12345&#125;:c&#123;1&#125;</code> has <code>photos:foobar:&#123;N&#125;:c&#123;N&#125;</code> as its normalized key where N stands for an integer value. For this particular example, â€˜12345â€™ is a user ID and the second N = 1 is for version number. A key family is a set for all cache key-value pairs which have the same normalized key.</p></blockquote><p>åŒæ—¶ï¼Œkey è¢«ç»„ç»‡ç§° key family, æ¥ï¼š</p><ul><li>åˆ†é…ç»™ä¸“ç”¨çš„ memcached pool</li><li>æ·»åŠ  TTL</li><li>æ•´ä¸ª key family è¿ç§»</li></ul><blockquote><p>The prefix of normalized key is used to detect which pool the key belongs to. For example, all keys starting with prefix â€˜photoâ€™ go to the photo tier which has its dedicated Memcached machines.</p></blockquote><p>è®ºæ–‡å®šä¹‰äº† <em>work set size</em>ï¼ŒæŒ‡çš„æ˜¯åœ¨ç»™å®šçš„æ—¶é—´çª—å£å†…æ¯ä¸ªå•ç‹¬çš„ <code>&lt;key, value&gt;</code>  è¢«è®¿é—®è¿‡çš„ bytes å’Œã€‚</p><p><img src="https://image.mwish.me/blog-image/1A0F8742-DA4A-4553-BD23-4DE00ABE8677.png" alt="1A0F8742-DA4A-4553-BD23-4DE00ABE8677"></p><p>åŒæ—¶ï¼Œè¿™é‡Œå¼•å…¥äº†ä¸€ä¸ªè®¡ç®—æ”¾å¤§çš„é‡ï¼Œduplicate factor:</p><p><img src="https://image.mwish.me/blog-image/9D3D2F2D-714D-4094-9200-C11FB4209073.png" alt="9D3D2F2D-714D-4094-9200-C11FB4209073"></p><p>å¯¹äºä¸€ä¸ª key familyï¼Œå®ƒå¯èƒ½è¢«åˆ†é…åˆ°ä¸€ä¸ª region poolï¼Œå¯¹åº”åˆ°ä¸€ä¸ªåˆ°å¤šä¸ª frontend clusterã€‚<code>wss</code> è¡¨ç¤ºå•ä¸ª cluster çš„è®¿é—®çš„ size, duplication factor åæ˜ åœ¨æ•´ä¸ªé›†ç¾¤ä¸­çš„æ”¾å¤§æ¯”ä¾‹ã€‚region åœ¨è¿™ä¸€å±‚é€»è¾‘ä¸­ï¼Œå¯ä»¥è¢«çœ‹ä½œåœ¨ L2 çš„ç©ºé—´å†…å­˜é‡Œã€‚</p><p>è¿™ä¸ªå€¼åœ¨é€»è¾‘ä¸Šä¸ key family å¯¹åº”çš„ user, å³ key family å®é™…ä¸Šå¯¹åº”çš„è¯·æ±‚è€…æ•°é‡æ˜¯ç›¸å…³çš„ï¼š</p><blockquote><p>When a key family is shared across more unique users, it has a higher probability of being accessed from more frontend clusters.</p></blockquote><p>ç°åœ¨ç›®æ ‡æ˜¯ï¼Œå¯¹äºæŸä¸ªç»™å®šçš„ key family, èƒ½å¤ŸæŠŠçƒ­ç‚¹è¯·æ±‚åœ¨ frontend é›†ç¾¤ä¸­ï¼Œä½œä¸ºå¯¹åº”çš„ L1 cacheï¼Œä¸é‚£ä¹ˆçƒ­çš„å°±ä¸è¦åœ¨ frontend é›†ç¾¤ï¼Œä¸¢åœ¨ L2 Cache ç”šè‡³æ•°æ®åº“é‡Œã€‚</p><h3 id="Key-based-Sampling"><a href="#Key-based-Sampling" class="headerlink" title="Key-based Sampling"></a>Key-based Sampling</h3><p>é€šè¿‡æ§åˆ¶é‡‡æ ·ç‡æ¥æ§åˆ¶é‡‡æ ·ã€‚</p><blockquote><p>Because keys are not sampled by user requests, key-based sampling can capture all cache accesses including ones not associated with user activities. </p></blockquote><p>è¿™é‡Œä»¥ key ä¸ºå•ä½ï¼Œé€šè¿‡ä»¥ä¸‹æ–¹å¼å®Œæˆé‡‡æ ·ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hash(key_id) % sample_rate == 0</span><br></pre></td></tr></table></figure><blockquote><p> Because keys are not sampled by user requests, key-based sampling can capture all cache accesses including ones not associated with user activities. </p></blockquote><p>è¿™é‡Œè¦è¯´æ˜çš„æ˜¯ï¼Œfb è¯·æ±‚é€»è¾‘å¯èƒ½ä¼šè¿™æ ·ï¼Œæ¯”å¦‚åŠ è½½é¡µé¢ï¼Œè¦ä¸€ä¸ªè¯·æ±‚åŠ è½½å‡ ç™¾å¼ å›¾ç‰‡ã€‚è¿™é‡Œé‡‡å–çš„æ¨¡å¼æ˜¯åº”ç”¨ç®€å•çš„ k-v æŠ½è±¡ã€‚</p><p>å®ƒçš„é‡‡æ ·ç®—æ³•å¾ˆç®€å•ï¼Œ<code>hash(key_id) % sample_rate == 0</code> å°±ç®—å‘½ä¸­â€¦ç®€å•å§ï¼</p><p>ï¼ˆæˆ‘å½“æ—¶çœ‹çš„æ—¶å€™å¤§éª‚ï¼šå°±è¿™ï¼ŸLRUä¸æ¥ä¸ªï¼ŸLFUä¸æ¥ä¸ªï¼Ÿï¼‰</p><h3 id="Promotion-Algorithm"><a href="#Promotion-Algorithm" class="headerlink" title="Promotion Algorithm"></a>Promotion Algorithm</h3><p><img src="https://image.mwish.me/blog-image/E39FD911-059D-4E34-9557-96EFA756E441.png" alt="E39FD911-059D-4E34-9557-96EFA756E441"></p><p><img src="https://image.mwish.me/blog-image/639562CE-3D6E-4DF8-BDF5-1106D46DB6A2.png" alt="639562CE-3D6E-4DF8-BDF5-1106D46DB6A2"></p><p>è¿™å°±çœŸçš„å¦‚ä¸Šå›¾æ‰€è¿°äº†â€¦æˆ‘æ„Ÿè§‰åè€Œæ²¡ä»€ä¹ˆå¥½è¯´çš„ã€‚ä¸è¿‡ç°åœ¨è¦åœ¨ä¸¤å±‚ cache ç»´æŠ¤ lease, æ„Ÿè§‰ä¸ŠåŸæœ¬æ˜¯ä¸€ä¸ª miss è¯·æ±‚å‘ä¸€ä¸ª lease, ç°åœ¨æ„Ÿè§‰ä¸¤å±‚åˆ†åˆ«åš lease åº”è¯¥ä¹Ÿå¯ä»¥ï¼Ÿç„¶å promote ç‹¬ç«‹è¿›è¡Œã€‚ä¸çŸ¥é“æ˜¯ä¸æ˜¯ã€‚</p><p>è¿™é‡Œé‡ç‚¹æ˜¯ <code>5</code> çš„é‡‡æ ·æ–¹æ³•ï¼Œå’Œç¬¬ä¸€æ¬¡ miss åŠ è½½åˆ° L2 çš„ä¸ä¼šå°è¯•è¢« promote åˆ° L1ã€‚</p><h3 id="æ¦‚ç‡æ¨¡å‹"><a href="#æ¦‚ç‡æ¨¡å‹" class="headerlink" title="æ¦‚ç‡æ¨¡å‹"></a>æ¦‚ç‡æ¨¡å‹</h3><p><img src="https://image.mwish.me/blog-image/8BCEF769-8A07-4B65-AF7B-8129D14903AA.png" alt="8BCEF769-8A07-4B65-AF7B-8129D14903AA"></p><p>ç»“è®ºï¼š</p><p><img src="https://image.mwish.me/blog-image/46485508-C9A4-4DFB-BB25-F2E19D8499BC.png" alt="46485508-C9A4-4DFB-BB25-F2E19D8499BC"></p><p>æ–‡ç«  4-5 èŠ‚ä»‹ç»äº†è¿™ä¸ªç®—æ³•çš„ä¼˜åŒ–æ•ˆæœï¼Œçœ‹ä¸Šå»è¿˜æ˜¯ä¸é”™çš„ã€‚åŸç†æ„Ÿè§‰å’Œ CPU Cache å¤šçº§åŸç†æ˜¯ä¸€æ ·çš„ï¼ˆä¸è¿‡å†·çƒ­åˆ†å‰²å’Œ cache ç»“åˆèµ·æ¥å€’æ˜¯å¾ˆæœ‰æ„æ€ï¼‰</p><h2 id="Redis-HotKey"><a href="#Redis-HotKey" class="headerlink" title="Redis HotKey"></a>Redis HotKey</h2><p>æˆ‘ä»¬ä»‹ç»äº† FB çš„é‡‡æ ·æ–¹æ³•ï¼Œç°åœ¨æˆ‘ä»¬è®²è®²å›½å†…ç”¨çš„å¤šçš„ Redisã€‚</p><p>é˜¿é‡Œäº‘ Redis å®ç°äº† <code>hotkeys</code> ï¼Œå¯ä»¥å¸®æˆ‘ä»¬å®ç°çƒ­ key æŸ¥æ‰¾ï¼š <a href="https://www.alibabacloud.com/help/doc-detail/101108.htm">https://www.alibabacloud.com/help/doc-detail/101108.htm</a></p><p>ç›¸å…³çš„ issue å¯ä»¥æ‰¾åˆ°ï¼š</p><ul><li><a href="https://github.com/redis/redis/issues/4473">https://github.com/redis/redis/issues/4473</a></li></ul><p>ï¼ˆè¿˜æ˜¯æ­å·é˜¿é‡Œçš„å¤§ä½¬åšçš„ï¼Œorzï¼‰</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Logarithmically increment a counter. The greater is the current counter value</span></span><br><span class="line"><span class="comment"> * the less likely is that it gets really implemented. Saturate it at 255. */</span></span><br><span class="line"><span class="type">uint8_t</span> <span class="title function_">LFULogIncr</span><span class="params">(<span class="type">uint8_t</span> counter)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (counter == <span class="number">255</span>) <span class="keyword">return</span> <span class="number">255</span>;</span><br><span class="line">    <span class="type">double</span> r = (<span class="type">double</span>)rand()/RAND_MAX;</span><br><span class="line">    <span class="type">double</span> baseval = counter - LFU_INIT_VAL;</span><br><span class="line">    <span class="keyword">if</span> (baseval &lt; <span class="number">0</span>) baseval = <span class="number">0</span>;</span><br><span class="line">    <span class="type">double</span> p = <span class="number">1.0</span>/(baseval*server.lfu_log_factor+<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> (r &lt; p) counter++;</span><br><span class="line">    <span class="keyword">return</span> counter;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®ƒä¾èµ–æ¦‚ç‡å¢åŠ  <code>counter</code>, åŒæ—¶æœ‰ä¸€ä¸ª <code>baseval</code>. ä¹‹å‰ä½¿ç”¨çš„æ˜¯ <code>hash(key_id) % sample_rate == 0</code> æ¥å†³å®šæ˜¯ä¸æ˜¯ï¼Œç°åœ¨ç”¨ <code>double p = 1.0/(baseval*server.lfu_log_factor+1)</code> æ¥ä»£æ›¿<code>sample_rate</code>, ä»¥å¢åŠ  counter æ¥å¢åŠ é‡‡æ ·ã€‚</p><p>åœ¨ issue é‡Œä¹Ÿæåˆ°äº†ï¼Œå› ä¸ºæ˜¯ä¸€ä¸ª counter, æ‰€ä»¥è¦é¢å¯¹ key ä¹‹å‰å¸¸è®¿é—®ï¼Œç°åœ¨å°‘è®¿é—®çš„æƒ…å†µï¼Œæ‰€ä»¥è¦æœ‰ä¸€ä¸ª <code>last_access_time</code> å’Œ counter:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* If the object decrement time is reached decrement the LFU counter but</span></span><br><span class="line"><span class="comment"> * do not update LFU fields of the object, we update the access time</span></span><br><span class="line"><span class="comment"> * and counter in an explicit way when the object is really accessed.</span></span><br><span class="line"><span class="comment"> * And we will times halve the counter according to the times of</span></span><br><span class="line"><span class="comment"> * elapsed time than server.lfu_decay_time.</span></span><br><span class="line"><span class="comment"> * Return the object frequency counter.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * This function is used in order to scan the dataset for the best object</span></span><br><span class="line"><span class="comment"> * to fit: as we check for the candidate, we incrementally decrement the</span></span><br><span class="line"><span class="comment"> * counter of the scanned objects if needed. */</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> <span class="title function_">LFUDecrAndReturn</span><span class="params">(robj *o)</span> &#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> ldt = o-&gt;lru &gt;&gt; <span class="number">8</span>;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> counter = o-&gt;lru &amp; <span class="number">255</span>;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> num_periods = server.lfu_decay_time ? LFUTimeElapsed(ldt) / server.lfu_decay_time : <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (num_periods)</span><br><span class="line">        counter = (num_periods &gt; counter) ? <span class="number">0</span> : counter - num_periods;</span><br><span class="line">    <span class="keyword">return</span> counter;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>MVCC &amp; SI: åè®®</title>
      <link href="/2020/11/17/MVCC-SI/"/>
      <url>/2020/11/17/MVCC-SI/</url>
      
        <content type="html"><![CDATA[<p><img src="https://image.mwish.me/blog-image/98F9A3FE-E697-417F-8A84-0987DDEEEFF0.png" alt="98F9A3FE-E697-417F-8A84-0987DDEEEFF0"></p><p>MVCC æ˜¯ç°ä»£å•†ä¸šæ•°æ®åº“éå¸¸å¸¸ç”¨çš„æœºåˆ¶ï¼ŒMySQL InnoDB, Postgres, WiredTiger éƒ½ä½¿ç”¨äº† MVCCï¼Œé€‚ç”¨èŒƒå›´å¯è§ä¸Šå›¾ï¼Œä½†æ˜¯ MVCC æœ¬èº«ä¹Ÿå¼•å…¥äº†é—®é¢˜ï¼š</p><ol><li>MVCC å¦‚ä½•å®ç°åè®®ï¼Ÿ</li><li>åœ¨å­˜å‚¨ã€GC ç­‰æ–¹é¢ï¼ŒMVCC éœ€è¦ä¸€äº› trade off</li></ol><p>Snapshot Isolation æ˜¯ä¸ªæ›´ä»¤äººè„‘å£³ç—›çš„ä¸œè¥¿ï¼Œä½ ä¼šå‘ç°å¾ˆå¤š DB å®ç°çš„å°±æ˜¯ SIï¼Œä½†æ˜¯è¿™äº› DB æœ¬èº«å…¶å®æ²¡æœ‰å®ç° Generalized SQL definition é‡Œé¢çš„ SIï¼Œå®ç°çš„å¯èƒ½åªæ˜¯ <code>monotonic atomic view</code>ã€‚</p><p>è¿™ä¸¤ä¸ªäº‹æƒ…åœ¨ä¸€èµ·æ¯”è¾ƒè®©äººå¤´æ™•ï¼Œä¸‹é¢ä¼šè®² MVTSï¼ŒMV2PL å’Œ SIã€‚</p><p>è¿™é‡Œä»…ä»…ä»‹ç»åè®®ï¼Œæš‚æ—¶ä¸ä»‹ç» MVCC çš„å­˜å‚¨å’Œ GCï¼Œè¿™å‡ ä¸ªå‘è¿˜æŒºå¤§çš„ã€‚</p><h2 id="MVCC-åè®®"><a href="#MVCC-åè®®" class="headerlink" title="MVCC: åè®®"></a>MVCC: åè®®</h2><p>MVCC çš„ç›®çš„æ˜¯ï¼š</p><p><strong>Writers do not block readers. Readers do not block writers.</strong></p><p>ï¼ˆå½“ç„¶ï¼Œå®é™…ä¸Šæˆ‘æ„Ÿè§‰è¿˜æ˜¯å–å†³äºå®ç°ã€‚TS åè®®å…¶å®éƒ½å¯ä»¥ block å‘¢ï¼‰</p><p>MVCC éœ€è¦å¤§é‡å¼•å…¥ timestamp çš„æ¦‚å¿µï¼Œreader ä»¥ timestamp æ¥è¯»ï¼Œå¹¶å†³å®šè‡ªå·±èƒ½è¯»åˆ°ä»€ä¹ˆã€‚</p><p>åœ¨é€»è¾‘è§†å›¾ä¸Šï¼ŒMVCC record éœ€è¦å¼•å…¥é¢å¤–çš„è®°å½•ï¼š</p><ol><li>begin</li><li>end</li></ol><p>è¿™ä¸¤ä¸ªè¡¨ç¤ºå¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸï¼Œä¹Ÿå†³å®šäº†è¯»è€…æ¥è¯»ä»€ä¹ˆã€‚å†™å…¥çš„æ—¶å€™ï¼Œå†™è€…ä¼šåˆ›å»ºä¸€æ¡è®°å½•ï¼Œç»™ end æ ‡è®°ä¸Šè‡ªå·±çš„å¯¹åº”çš„ tsã€‚è¯»è€…æ ¹æ®è‡ªå·±çš„ ts æ¥å†³å®šâ€œåº”è¯¥è¯»åˆ°ä»€ä¹ˆâ€ã€‚</p><p>å®é™…ä¸Š MVCC å’Œ SI å¯èƒ½å…³ç³»æ¯”è¾ƒå¤§ï¼Œç»å¸¸ç”¨äºå®ç° SIï¼Œä½†æ˜¯ ts ç”¨æ¥å†³å®šè¯»å¹¶ä¸ä»£è¡¨åªèƒ½ SIã€‚å®ƒå¯ä»¥å®ç° RC å’Œ Serializableã€‚ä½†åŒæ—¶ï¼Œè¿™ä¸ªåè®®ä¹Ÿä¼šå½±å“å…·ä½“å®ç°åéš”ç¦»çš„è¡¨ç°ã€‚</p><p>MVCC æœ‰ä¸‹é¢ä¸€äº› trade-off:</p><ul><li>Concurrency Control Protocol </li><li>Version Storage</li><li>Garbage Collection</li><li>Index Management</li><li>Foreign Key</li></ul><h3 id="MVTS"><a href="#MVTS" class="headerlink" title="MVTS"></a>MVTS</h3><p>MVTS åè®®æºäº 1979 å¹´ï¼Œæ˜¯æœ€æ—©çš„ MVCC åè®®ã€‚</p><p>TS åè®®ä¸­ï¼Œæ¯ä¸ªäº‹åŠ¡åœ¨å¼€å§‹çš„æ—¶å€™éƒ½ä¼šå®šä¸‹ä¸€ä¸ª commit-ts. è®°ä½œ $TS(T_i)$, åŒæ—¶, ä»¥ commit-ts ä¸ºæ ‡å‡†ï¼Œæ¥é™åˆ¶ Tuple è¯»å†™ï¼Œå¦‚æœä¸èƒ½æ»¡è¶³éœ€æ±‚ï¼Œå°±ä¼šè¢« abort. åŒæ—¶ï¼Œtuple æœ‰ read-ts å’Œ write-ts, è¡¨ç¤ºå•æ¡è®°å½•è¯»å†™ã€‚</p><p><img src="https://image.mwish.me/blog-image/6EC5DFC5-AC8C-4565-A9DA-59AA31CF6BD3.png" alt="6EC5DFC5-AC8C-4565-A9DA-59AA31CF6BD3"></p><p>MVTS ä¸­ï¼š</p><p>end-ts ç›¸å½“äºä¹‹å‰çš„ write-ts, read-ts ç›¸å½“äºè¿™ä¸ªç‰ˆæœ¬å¯¹åº”çš„æœ€å¤§ read-ts</p><h4 id="å†™å…¥"><a href="#å†™å…¥" class="headerlink" title="å†™å…¥"></a>å†™å…¥</h4><p>ä¸€ä¸ªäº‹åŠ¡å†™å…¥æ—¶ï¼Œå¦‚æœï¼š</p><ol><li>å¦ä¸€ä¸ªäº‹åŠ¡åœ¨æ›´æ–°è¿™æ¡è®°å½•ï¼Œæœ‰ä¸€ä¸ªæœ€æ–°çš„æ­£åœ¨å†™å…¥çš„ç‰ˆæœ¬</li><li>å·²å­˜åœ¨çš„æœ€é«˜ç‰ˆæœ¬çš„ record begin_ts å¤§äºè‡ªèº«</li><li>å·²å­˜åœ¨çš„æœ€é«˜ç‰ˆæœ¬çš„ record begin_ts å°äºè‡ªèº«ï¼Œä½† read-ts å¤§äºè‡ªèº«</li></ol><p>å®ƒéƒ½ä¼š abortã€‚</p><p>äº‹åŠ¡å†™å…¥ tuple çš„æ—¶å€™ï¼Œä¼šåœ¨ä¸Šè¿°çš„ <code>txn-id</code> å­—æ®µè®¾ç½®æˆè‡ªå·±ï¼Œç›¸å½“äº grab å†™é”ã€‚</p><p>å¦‚æœ tuple Q æœ€é«˜ç‰ˆæœ¬ <code>k</code> æ»¡è¶³ <code>TS(T) == W-TS(Q_k)</code>, é‚£ä¹ˆè¯´æ˜æ˜¯æœ¬äº‹åŠ¡å†™å…¥ï¼Œå¯ä»¥æ”¾å¿ƒå†™ã€‚</p><p>å¦‚æœä¸Šè¿°æ¡ä»¶éƒ½ä¸æ»¡è¶³ï¼Œå®ƒä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ç‰ˆæœ¬ï¼ŒæŠŠä¹‹å‰çš„ end-ts è®¾ç½®æˆ <code>TS(T)</code>ï¼Œç„¶ååˆ›å»ºä¸€æ¡æ–°çš„çºªå½•ï¼ŒæŠŠ end-ts è®¾ç½®æˆæ— é™ï¼Œbegin-ts è®¾ç½®æˆ <code>TS(T)</code>.</p><h4 id="è¯»å–"><a href="#è¯»å–" class="headerlink" title="è¯»å–"></a>è¯»å–</h4><ol><li>$T_i$ è¯»å–æ—¶ï¼Œæ•°æ®åº“æ‰¾åˆ° <code>[begin-ts, end-ts]</code> åŒ…å« $TS(T_i)$ çš„è®°å½•ï¼Œå³äº‹åŠ¡è¯»åˆ°å®ƒä¹‹å‰æœ€è¿‘çš„è¯·æ±‚</li><li>å¦‚æœä¸Šé¢æœ‰ <code>T_id</code> çš„å†™é”ï¼Œé‚£ä¹ˆabortæˆ–è€… wait</li></ol><h4 id="Relaxed"><a href="#Relaxed" class="headerlink" title="Relaxed"></a>Relaxed</h4><p>æ•°æ®åº“ç³»ç»Ÿå®ç°é‡Œé¢æ¨¡å‹æ¯”ä¸Šé¢çš„ relax ä¸€äº›ï¼Œè¯»å–çš„æ—¶å€™ï¼Œå¦‚æœå¤§äºæœ€å¤§çš„ ts, é‚£ç›´æ¥è¯»æœ€å¤§çš„è®°å½•ã€‚è¿™æ ·è¯»æ°¸è¿œä¸ä¼š abort, æ„Ÿè§‰è¿™æ ·å®ç°æ¯”è¾ƒæœ‰é—®é¢˜= =</p><h4 id="ç¼ºç‚¹"><a href="#ç¼ºç‚¹" class="headerlink" title="ç¼ºç‚¹"></a>ç¼ºç‚¹</h4><ol><li>ä»ç„¶éœ€è¦ä¸€å®šçš„æ›´æ”¹ï¼Œæ‰èƒ½è®© MVTS æ˜¯ Recoverable çš„</li><li>å¾ˆå¤šæ—¶å€™è¯»å–è¦æ›´æ–° ts, å¯èƒ½ä¼šæ”¾å¤§ç£ç›˜å†™</li></ol><h3 id="MV2PL"><a href="#MV2PL" class="headerlink" title="MV2PL"></a>MV2PL</h3><p><img src="https://image.mwish.me/blog-image/6993165C-819A-4BA7-8B63-DE5F8AFFC552.png" alt="6993165C-819A-4BA7-8B63-DE5F8AFFC552"></p><p>TS çš„æ—¶é—´æˆ³æ¥è‡ªäº‹åŠ¡å¼€å§‹æ—¶åˆ†é…çš„ commit-ts, MVTS æ²¿ç”¨äº†è¿™ä¸ª tsã€‚2PL çš„ Commit æ—¶é—´è¢«å½“æˆæ˜¯å…¨å±€å”¯ä¸€çš„æ—¶é—´ï¼Œå‡†ç¡®è¯´æ˜¯é‡Šæ”¾ç¬¬ä¸€ä¸ªé”é”çš„æ—¶é—´ã€‚åœ¨ Rigirous 2PL åè®®ä¸‹ï¼Œå¯ä»¥å½“æˆå®ƒä»¬ç­‰æ•ˆã€‚</p><p>MV2PL ç»´æŠ¤äº†ä¸€ä¸ªå…¨å±€å•è°ƒé€’å¢çš„ ts-counterã€‚äº‹åŠ¡ Commit çš„æ—¶å€™ï¼Œä¼šæŠŠè¿™ä¸ª counter é€’å¢ï¼ŒåŒæ—¶èµ‹äºˆè‡ªå·±è¿™ä¸ª counterã€‚å®é™…ä¸Šï¼ŒMV2PL ä½¿ç”¨çš„ä¸æ˜¯ timestampï¼Œè€Œæ˜¯â€œäº‹åŠ¡æäº¤çš„ counterâ€ã€‚</p><h4 id="è¯»å–-åªè¯»äº‹åŠ¡"><a href="#è¯»å–-åªè¯»äº‹åŠ¡" class="headerlink" title="è¯»å–: åªè¯»äº‹åŠ¡"></a>è¯»å–: åªè¯»äº‹åŠ¡</h4><p>åªè¯»äº‹åŠ¡åœ¨è¯»å–æ—¶ï¼Œå¯¹äºåªè¯»äº‹åŠ¡ï¼Œäº‹åŠ¡ <code>TS = ts-counter</code>, ç„¶åç”¨è¿™ä¸ª ts-counter å»è¯»ã€‚</p><p>å·²çŸ¥ï¼šäº‹åŠ¡è·å– ts-counter æ—¶ï¼Œä¹‹å‰æ‰€æœ‰çš„äº‹åŠ¡éƒ½å·²ç»æäº¤ã€‚</p><p>å³ï¼šè¯»å–çš„æ—¶å€™ï¼Œæ²¡æœ‰ blocking, æ²¡æœ‰ abortã€‚äº‹åŠ¡è®°å½•æ˜¯å®Œæ•´çš„ã€‚</p><h4 id="è¯»å†™äº‹åŠ¡"><a href="#è¯»å†™äº‹åŠ¡" class="headerlink" title="è¯»å†™äº‹åŠ¡"></a>è¯»å†™äº‹åŠ¡</h4><p>è¯»å†™äº‹åŠ¡è¯»å–æ—¶ï¼Œè·å¾— S-Lock, è¯»å–æœ€æ–°ç‰ˆæœ¬ï¼Œå†™å…¥æ—¶ï¼Œå…ˆå¯¹ç°åœ¨çš„æœ€æ–°ï¼Œå†™å…¥åçš„æ¬¡æ–°ä¸Šä¸€ä¸ª X-Lockï¼Œç„¶åå†å†™ä¸€ä¸ªæ–°ç‰ˆæœ¬ã€‚ç„¶åè®¾ç½®æ–°ç‰ˆæœ¬çš„ <code>end-ts</code> ä¸ºæ— ç©·ï¼Œå½“ Commit é˜¶æ®µæ—¶ï¼Œäº‹åŠ¡è·å¾—ä¸€ä¸ª CommitTS, ç„¶åæŠŠè‡ªå·±çš„ ts å¯¹åº”æˆè¿™ä¸ª commit-ts, ç„¶åè®¾ç½®è‡ªå·±ä¿®æ”¹æ‰€æœ‰å†…å®¹çš„<code>begin-ts</code> ä¸ºè‡ªèº«ï¼Œè®¾ç½®æ¬¡æ–°ç‰ˆæœ¬ <code>end-ts</code> ä¸ºè‡ªèº«ï¼Œ</p><p>å®é™…ä¸Šï¼Œåœ¨è¿™é‡Œäº‹åŠ¡çš„å¤–éƒ¨æ—¶é—´é¡ºåºè¢«å‰Šå¼±äº†ï¼Œread å¯èƒ½å¯ä»¥æ…¢äºå†™ã€‚ä½†æ˜¯æ—¶é—´å’Œäº‹åŠ¡çš„ order è¢«ä¸åŒçš„ <code>ts-counter</code> çµ¦ fence å¼€äº†ã€‚</p><p><img src="https://image.mwish.me/blog-image/16D1F158-2844-4A7E-9DAD-060F95C86CE6.png" alt="16D1F158-2844-4A7E-9DAD-060F95C86CE6"></p><p>åœ¨è®ºæ–‡  <strong>Fast Serializable Multi-Version Concurrency Control for Main-Memory Database Systems</strong> ä¸­ï¼Œå¯¹äºè¿™ç‚¹æå‡ºäº†è¯æ˜ã€‚</p><p>æ­¤å¤–ï¼ŒMV2PL å†²çªå¤„ç†ï¼Œæœ‰å¦‚ä¸‹ comments:</p><blockquote><p>The key difference among 2PL protocols is in how they handle deadlocks. Previous research has shown that the <em>no-wait</em> policy [9] is the most scalable deadlock prevention technique [48]. With this, the DBMS immediately aborts a transaction if it is unable to acquire a lock on a tuple (as opposed to waiting to see whether the lock is released). Since transactions never wait, the DBMS does not have to employ a background thread to detect and break deadlocks.</p></blockquote><h2 id="Snapshot-Isolation"><a href="#Snapshot-Isolation" class="headerlink" title="Snapshot Isolation"></a>Snapshot Isolation</h2><p>Snapshot Isolation æ˜¯ä¸€ç§ç‰¹æ®Šçš„å¹¶å‘æ§åˆ¶æ–¹æ¡ˆï¼Œå·²åœ¨åŒ…æ‹¬ Oracleï¼ŒPostgreSQL å’ŒSQL Serveråœ¨å†…çš„å•†ä¸šå’Œå¼€æºç³»ç»Ÿä¸­å¾—åˆ°å¹¿æ³›è®¤å¯ã€‚</p><p>å®ç°ä¸Šï¼ŒSI é€šå¸¸ä¾èµ– MVCCï¼Œä½†æ˜¯ MVCC å´ä¸æ­¢èƒ½å®ç° SIã€‚</p><ol><li>äº‹åŠ¡åœ¨å¼€å§‹çš„æ—¶å€™ï¼Œæ‹¿åˆ°ä¸€ä¸ª Snapshotï¼Œå°±æ˜¯å¼€å§‹æ—¶åˆ»äº‹åŠ¡å¯¹åº”çš„<strong>ä¸€è‡´æ€§</strong>çš„è§†å›¾ã€‚</li><li>äº‹åŠ¡åœ¨è‡ªå·±çš„ space ä¸­è¿›è¡Œä¿®æ”¹ã€‚</li><li>äº‹åŠ¡ Commit çš„æ—¶å€™ï¼Œéœ€è¦éªŒè¯å’Œåˆ«çš„äº‹åŠ¡æ˜¯å¦æœ‰å†²çª</li><li>äº‹åŠ¡<strong>åŸå­æ€§</strong>çš„ Commit, ä¸€æ—¦ Commit ï¼Œè¦ä¹ˆå¯¹åˆ«çš„æ‰€æœ‰ Snapshot ä¸å¯è§ï¼Œè¦ä¹ˆä¸€ä¸‹å­å…¨éƒ¨å¯è§ã€‚</li></ol><p>é‚£ä¹ˆï¼Œé‡‡ç”¨å¤šç‰ˆæœ¬å®ç°çš„æ—¶å€™ï¼Œæˆ‘ä»¬é€šå¸¸éœ€è¦ï¼š</p><ol><li>$StartTS(T_i)$, is the time at which transaction $T_i$ started. </li><li>The second timestamp, $CommitTS(T_i)$ is the time when the transaction $T_i$ requested validation.</li></ol><p>äº‹åŠ¡è¯»å–æ—¶ï¼Œä¸ä¼šçœ‹åˆ°å…¶åçš„ä»»ä½•å†™ã€‚</p><blockquote><p>æ³¨: MySQL çš„ RR ä¸‹ï¼Œæœ‰ä¸¤ç§è¯»ï¼Œä¸€ç§è¯»ä¸€è‡´æ€§ Snapshot, ä¸€ç§å…¨å±€ã€‚å®é™…ä¸Š SELECT + SELECT for Update æ··ç”¨ï¼Œå®é™…è¡¨ç°ä¼šç•¥æ˜¾æ··ä¹±.</p></blockquote><p>å¯¹äºæ›´æ–°äº‹åŠ¡è€Œè¨€ï¼Œéœ€è¦ Commit ä¹‹å‰ï¼Œè¦ validate è‡ªèº«æ˜¯å¦æ˜¯åˆç†åˆæ³•çš„ã€‚é¦–å…ˆï¼Œéœ€è¦äº†è§£çš„æ˜¯ï¼ŒSI å·²ç»æœ‰äº† PL-2 çš„çº§åˆ«ï¼Œèƒ½å¤Ÿé˜²æ­¢ G0 G1. åœ¨ SI çš„æƒ…å†µä¸‹ï¼ŒåŠ å…¥å®ç°çš„æ—¶å€™ï¼Œæœ‰ä¸¤ä¸ªäº‹åŠ¡ï¼Œæ›´æ–°äº†åŒä¸€æ¡è®°å½•ï¼Œç„¶åæäº¤ï¼Œå¯èƒ½ä¼šé€ æˆâ€œæŸä¸ªäº‹åŠ¡çš„æ›´æ–°è¢«ä¸¢å¤±â€ï¼Œå³ lost updateã€‚åœ¨ä¸€äº›æ»¡è¶³ <code>LWW</code>, å³â€œæœ€è¿‘å†™å…¥ä¸ºå‡†â€çš„ç³»ç»Ÿä¸­ï¼Œè¿™æ˜¯å¯ä»¥çš„ï¼Œä½†æ˜¯è¿™æ ·å¯èƒ½ä¼šè¿åäº‹åŠ¡çš„ä¸€è‡´æ€§çº¦æŸã€‚æ‰€ä»¥ä¹Ÿè¦é¿å…å®ƒã€‚</p><p>å¯èƒ½çš„æƒ…å†µæœ‰ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">StartTS(Tj) â‰¤ StartTS(Ti) â‰¤ CommitTS(Tj), or</span><br><span class="line">StartTS(Ti) â‰¤ StartTS(Tj) â‰¤ CommitTS(Ti).</span><br></pre></td></tr></table></figure><p>æœ‰ä¸¤ç§ç­–ç•¥ï¼š</p><ol><li><strong>first committer wins</strong></li><li><strong>first updater wins</strong></li></ol><p>è¿™äº›ç­–ç•¥æŒ‰ç…§å®ç°è€Œå®šå…·ä½“åº”è¯¥é€‰ç”¨ä»€ä¹ˆã€‚</p><h3 id="SSI"><a href="#SSI" class="headerlink" title="SSI"></a>SSI</h3><p>Postgres å®ç°äº† SSIï¼Œè¿™ä¸ªå’Œ Generalized SQL é‚£ç¯‡è®ºæ–‡å¼ºç›¸å…³ã€‚PG é é˜²æ­¢ anti dependency æˆç¯ï¼Œabort æ‰å¯èƒ½æˆç¯çš„äº‹åŠ¡ï¼Œæ¥å®ç°äº† SSI çš„è°ƒåº¦ã€‚åŒæ—¶åšäº†å¯¹åªè¯»äº‹åŠ¡çš„ä¼˜åŒ–ã€‚</p><h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul><li><strong>An Empirical Evaluation of In-Memory Multi-Version Concurrency Control</strong></li><li><strong>Fast Serializable Multi-Version Concurrency Control for Main-Memory Database Systems</strong> </li><li><a href="https://zhuanlan.zhihu.com/p/54979396">https://zhuanlan.zhihu.com/p/54979396</a></li><li>æ•°æ®åº“ç³»ç»Ÿæ¦‚å¿µï¼Œç¬¬ä¸ƒç‰ˆã€‚</li></ul>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>äº‹åŠ¡: å¹¶å‘æ§åˆ¶åè®®: 2PL &amp;&amp; TS</title>
      <link href="/2020/11/15/transaction-concurrency-control/"/>
      <url>/2020/11/15/transaction-concurrency-control/</url>
      
        <content type="html"><![CDATA[<p>å¹¶å‘æ§åˆ¶æ˜¯äº‹åŠ¡çš„é‡è¦æˆåˆ†ï¼Œä»–ä»¬ä¼šå†³å®šäº‹åŠ¡çš„è°ƒåº¦ã€å¤„ç†ã€abort é¡ºåºã€‚</p><p>äº‹åŠ¡çš„å¹¶å‘æ§åˆ¶å¯ä»¥å¤§è‡´åˆ†ä¸ºï¼š</p><ul><li>ä¹è§‚çš„å¹¶å‘æ§åˆ¶<ul><li>OCC </li><li>TS</li></ul></li><li>æ‚²è§‚çš„å¹¶å‘æ§åˆ¶<ul><li>2PL</li></ul></li></ul><p>ä¹è§‚çš„å¹¶å‘æ§åˆ¶å‡è®¾å†²çªæ¯”è¾ƒå°‘çš„æƒ…å†µå‘ç”Ÿï¼Œå‡ºç°å†²çªå°±ä¼šé€‰æ‹©äº‹åŠ¡ abortï¼›æ‚²è§‚çš„å¹¶å‘æ§åˆ¶åˆ™æ˜¯å‡è®¾äº‹åŠ¡å†²çªç»å¸¸å‘ç”Ÿï¼Œä¼šé¿å…å†²çªã€‚</p><h2 id="2PL"><a href="#2PL" class="headerlink" title="2PL"></a>2PL</h2><p>é¦–å…ˆ 2PL çš„ Lock å’Œâ€œè¯»å†™é”â€ â€œè‡ªæ—‹é”â€è¿™äº›åŒæ­¥æ“ä½œä¸æ˜¯ä¸€å›äº‹ï¼Œåè€…åœ¨ DB å±‚è¢«ç§°ä¸º Latchã€‚</p><p>åŸºç¡€çš„é”å¯ä»¥ç®€å•åˆ†ä¸ºï¼š</p><ul><li>S-LOCKï¼šShared Lockï¼Œè¯»è·å– S-Lock</li><li>X-Lock: Exclusive Lockï¼Œå†™è·å– X-Lock</li></ul><p>2PL åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼š</p><ol><li>Growingï¼šä»…è·å–é”æˆ–è€…æ‹’ç»è·å–é”çš„è¯·æ±‚</li><li>Shrinkingï¼šåªå…è®¸é‡Šæ”¾é”</li></ol><h3 id="æ­£ç¡®æ€§è¯æ˜"><a href="#æ­£ç¡®æ€§è¯æ˜" class="headerlink" title="æ­£ç¡®æ€§è¯æ˜"></a>æ­£ç¡®æ€§è¯æ˜</h3><p>æ•°æ®åº“ç³»ç»Ÿæ¦‚å¿µå¯¹è¿™ä¸ªæœ‰ä¸€ä¸ªå¾ˆæ£’çš„è¯æ˜ï¼Œç”¨çš„æ˜¯å½’çº³æ³•ï¼š<a href="http://www.mathcs.emory.edu/~cheung/Courses/554/Syllabus/7-serializability/2PL.html">http://www.mathcs.emory.edu/~cheung/Courses/554/Syllabus/7-serializability/2PL.html</a></p><p>ï¼ˆå¤§æ„æ˜¯ 1ä¸ªäº‹åŠ¡ä¸­ï¼Œå·²ç»æ˜¯ä¸²è¡Œçš„ã€‚ç„¶å n ä¸ªäº‹åŠ¡ä¸­ï¼Œå‡è®¾ n-1 ä¸ªäº‹åŠ¡æ˜¯ä¸²è¡Œçš„ï¼Œæ»¡è¶³ 2PL æ¡ä»¶ä¸‹ï¼Œæ— æ³•æ‰¾åˆ°ä¸€ç§è°ƒåº¦ï¼Œè®©ä»–æ»¡è¶³éä¸²è¡ŒåŒ–è°ƒåº¦ï¼‰</p><p><a href="https://zhuanlan.zhihu.com/p/59535337">https://zhuanlan.zhihu.com/p/59535337</a> è¿™ç¯‡æ–‡ç« ä¹Ÿç»™äº†ä¸€ä¸ªåè¯æ³•æ¥è¯æ˜ã€‚å¤§æ„ä¹Ÿå¦‚ä¸Šï¼Œä¸è¿‡ç”¨äº†æˆç¯çš„è§’åº¦æ¥æè¿°ã€‚</p><p>æ­¤å¤–ï¼Œå…³äº 2PL çš„ order, è¿˜æœ‰ä¸€ä¸ªå¾ˆæœ‰è¶£çš„æ¦‚å¿µï¼š2PL å¯ä»¥å½“æˆæå‡ºç¬¬ä¸€ä¸ªè§£é”è¯·æ±‚çš„æ—¶å€™ï¼Œç¬æ—¶æ‰§è¡Œçš„ã€‚è¿™ä¸ªåœ¨ä¸‹é¢æœ‰ä¸€ä¸ªåè¯æ³•è¯æ˜ï¼ˆåœ¨ claim é‚£ï¼‰ï¼š<a href="http://www.mathcs.emory.edu/~cheung/Courses/554/Syllabus/7-serializability/2PL.html">http://www.mathcs.emory.edu/~cheung/Courses/554/Syllabus/7-serializability/2PL.html</a></p><h3 id="2PL-çš„éº»çƒ¦"><a href="#2PL-çš„éº»çƒ¦" class="headerlink" title="2PL çš„éº»çƒ¦"></a>2PL çš„éº»çƒ¦</h3><h4 id="CASCADING-ABORTS"><a href="#CASCADING-ABORTS" class="headerlink" title="CASCADING ABORTS"></a>CASCADING ABORTS</h4><p><img src="https://image.mwish.me/blog-image/1895A50B-B8EC-4C4A-8D81-F8034A2F9BF9.png" alt="1895A50B-B8EC-4C4A-8D81-F8034A2F9BF9"></p><p>ä¸Šè¿°è°ƒåº¦å‘ç”Ÿçš„æ—¶å€™ï¼ŒT1 unlock äº†ï¼ŒT2 è·å–é”è¯» T1ï¼Œç„¶å T1 abort äº†ï¼Œä¸ºäº†é˜²æ­¢ G1aï¼ŒT2 ä¹Ÿåº”è¯¥ abortã€‚</p><p>é‚£ä¹ˆè¿™ä¸ªæ—¶å€™ï¼Œä¾èµ– T2 å†™å…¥çš„ä¹Ÿéƒ½ä¼š abort ï¼Œå“ˆï¼Œé›ªå´©ï¼</p><p>ä¸ºäº†é˜²æ­¢è¿™ç§ç°è±¡ï¼Œä¼šæœ‰ strict 2PL:</p><blockquote><p>A schedule is <strong>strict</strong> if a value written by a txn is not read or overwritten by other txns until that txn finishes.</p></blockquote><p>åœ¨ S2PL ä¸‹ï¼Œä¸ä»…èƒ½é˜²æ­¢ä¸Šè¿° cascading abort, è¿˜èƒ½é å­˜å‚¨åŸæ¥çš„å€¼æ¥æ¢å¤ abortã€‚</p><p>æ­¤å¤–ï¼Œè¿˜æœ‰å¦ä¸€ç§æ¨¡å¼ï¼š</p><blockquote><p>Another variant of two-phase locking is the <strong>rigorous two-phase locking protocol</strong>, which requires that all locks be held until the transaction commits. We can easily verify that, with rigorous two-phase locking, transactions can be serialized in the order in which they commit.</p></blockquote><h4 id="Upgrade-Lock"><a href="#Upgrade-Lock" class="headerlink" title="Upgrade Lock"></a>Upgrade Lock</h4><p>å¦‚æœ txn å…ˆè¯» object a, å†å†™ object aã€‚é‚£ä¹ˆå®ƒéœ€è¦è¿›è¡Œ upgrade, æŠŠ S-LOCK å˜æˆ X-LOCKã€‚</p><p>å‡çº§åªèƒ½åœ¨ growing phase ä¸­è¿›è¡Œã€‚</p><h4 id="Deadlock"><a href="#Deadlock" class="headerlink" title="Deadlock"></a>Deadlock</h4><p>åœ¨å®ç°ä¸Šï¼Œé€šå¸¸2PLä¼šå¼•å…¥ LockTable æ¥è®°å½•é”çš„ä¿¡æ¯ã€‚åŒæ—¶å‘ LockTable ç”³è¯·é”å®šã€‚æ‰€ä»¥ä¸ OS ä¸ä¸€æ ·ï¼Œæ•°æ®åº“å¯ä»¥é«˜åº¦ä»‹å…¥è¿™äº›è¡Œä¸ºã€‚</p><p>æœ‰ä¸¤ç§å¤„ç†æ­»é”çš„æ–¹æ¡ˆï¼šdeadlock detection å’Œ deadlock preventionã€‚</p><h5 id="Deadlock-Prevention"><a href="#Deadlock-Prevention" class="headerlink" title="Deadlock Prevention"></a>Deadlock Prevention</h5><p>deadlock prevention å¯ä»¥ç”¨æŸç§æ–¹å¼ï¼Œæ¯”å¦‚å¼€å§‹çš„æ—¶é—´ï¼Œæ¥æ§åˆ¶ä¼˜å…ˆçº§ã€‚æœ‰äº†ä¼˜å…ˆçº§ï¼Œå½“äº‹åŠ¡ç”³è¯· Lockï¼ŒåŒæ—¶è¿™ä¸ª object ä¸Šå·²ç»æœ‰ lock çš„æ—¶å€™ï¼Œæœ‰ä¸¤ç§ç­–ç•¥ï¼šwait-die å’Œ wound-waitï¼Œè¿™äº›ç­–ç•¥æœ¬èº«æš—ç¤ºäº†ä¸€ä¸ªäº‹åŠ¡åºå·æˆ–è€…æ—¶é—´æˆ³çš„å­˜åœ¨ï¼š</p><ul><li>wait-die: å¦‚æœè¯·æ±‚çš„äº‹åŠ¡æœ‰æ›´é«˜çš„ä¼˜å…ˆçº§ï¼Œé‚£ä¹ˆç­‰å¾…ï¼Œå¦åˆ™ä¼š abort</li><li>wound-wait: å¦‚æœè¯·æ±‚çš„äº‹åŠ¡æœ‰æ›´é«˜çš„ä¼˜å…ˆçº§ï¼Œé‚£ä¹ˆ abort æ‰æŒé”çš„äº‹åŠ¡ï¼Œå¦åˆ™ä¼šç­‰å¾…äº‹åŠ¡å®Œæˆã€‚</li></ul><p>è¿™ä¸¤ç§æ–¹å¼è®©äº‹åŠ¡æŠ¢å é”çš„æ—¶å€™ï¼Œæœ‰äº†ä¸€ä¸ªå•è°ƒçš„ total orderã€‚æ‰€ä»¥æœ¬èº«æ˜¯ work çš„ã€‚åŒæ—¶ï¼Œä¸ºäº†é¿å…å†²çªï¼Œè¢« abort çš„äº‹åŠ¡ä¼šè¦æ±‚ä¸€å®šç¨‹åº¦ä¸Šç”¨åŸæœ‰çš„ä¼˜å…ˆçº§ã€‚</p><p>è¿˜æœ‰ä¸€ç§æ··åˆçš„ç­–ç•¥æ˜¯é”è¶…æ—¶ï¼Œä¸€å®šæ—¶é—´äº‹åŠ¡æ²¡æœ‰æ¨è¿›ä¸‹å»ä¹‹åï¼Œä¼šè¢«åˆ¤å®šä¸ºè¶…æ—¶ã€‚</p><h5 id="Deadlock-Detection"><a href="#Deadlock-Detection" class="headerlink" title="Deadlock Detection"></a>Deadlock Detection</h5><p>deadlock detection é€šå¸¸é‡‡å– wait-for graph çš„å½¢å¼æ¥å®ç°ï¼Œå®ƒæ„å»ºä¸€ä¸ª DAGï¼Œç„¶ååœ¨ç”³è¯·é”çš„æ—¶å€™ï¼Œæ„å»º Transaction çš„ direct ä¾èµ–ã€‚unlock çš„æ—¶å€™ï¼Œé‡Šæ”¾ç›¸å…³çš„ä¾èµ–ã€‚å½“ wait-for graph å‡ºç°ç¯çš„æ—¶å€™ï¼Œè¯´æ˜æœ‰å†²çª. éœ€è¦æŒ‘é€‰ä¸€ä¸ª victim äº‹åŠ¡ abort æ‰ã€‚</p><p>å½“ç„¶ï¼Œè¿™ä¸ª wait-for graph ä¹Ÿå¯ä»¥åœ¨å®šæ—¶æˆ–è€…å…¶ä»–çš„æ—¶æœºæ„å»ºï¼Œæ¯”å¦‚åœ¨å®šæœŸæ£€æŸ¥çš„æ—¶å€™æ„å»ºã€‚</p><p>Abort äº‹åŠ¡æœ¬èº«ä¹Ÿæ˜¯æœ‰è®²ç©¶çš„ï¼Œè¿™é‡Œå¯èƒ½ä¼šåœ¨ wait-for graph é‡Œé¢æˆç¯ï¼Œæˆ‘ä»¬éœ€è¦ abort æ‰ç¯ä¸­çš„ä¸€ä¸ªäº‹åŠ¡ã€‚</p><ol><li>äº‹åŠ¡æ‰§è¡Œäº†å¤šä¹…ï¼Œè¿˜éœ€è¦æ‰§è¡Œå¤šä¹…</li><li>å›æ»šæ—¶ç‰µæ¶‰çš„äº‹åŠ¡</li><li>è¿™ä¸ªäº‹åŠ¡æ˜¯å¦é‡å¤äº†å¾ˆå¤šéï¼Œå† abort å°±é¥¿æ­»äº†ã€‚</li></ol><h4 id="LockTable"><a href="#LockTable" class="headerlink" title="LockTable"></a>LockTable</h4><p>ç»¼ä¸Šï¼Œä¸Šè¿°çš„å†…å®¹éœ€è¦ä¸€ä¸ª LockTable æ¥å®ç°ã€‚è¿™é‡Œé‡‡å–äº†ä¸€ä¸ª HashTable + Chain çš„ç»“æ„ï¼š</p><p><img src="https://image.mwish.me/blog-image/70612C78-F305-444C-8918-B7FEC410BF55.png" alt="70612C78-F305-444C-8918-B7FEC410BF55"></p><ul><li>å½“æœ‰ LOCK è¯·æ±‚æ—¶ï¼Œè¯·æ±‚æ’é˜Ÿå¤„ç†ï¼›å…±äº«çš„è¯·æ±‚å¯èƒ½è¢«åŒæ—¶ grant</li><li>æœ‰ unlock è¯·æ±‚æ—¶ï¼Œé‡Šæ”¾å…ƒç´ ï¼Œå¹¶ä¸”å¤„ç†ä¸‹ä¸€ä¸ª</li><li>æœ‰ abort è¯·æ±‚æ—¶ï¼Œclearï¼Œå¹¶è¿›è¡Œæ¢å¤å·¥ä½œã€‚</li></ul><h3 id="Multiple-Granularity-amp-amp-intention-locks"><a href="#Multiple-Granularity-amp-amp-intention-locks" class="headerlink" title="Multiple Granularity &amp;&amp; intention locks"></a>Multiple Granularity &amp;&amp; intention locks</h3><p>å…³ç³»å‹æ•°æ®åº“æœ‰ä¸åŒçš„å±‚æ¬¡ï¼š</p><ul><li>Database</li><li>table</li><li>Page</li><li>Tuple/Row</li><li>Column</li></ul><p>å½“ Txn ç”³è¯· Lock çš„æ—¶å€™ï¼ŒDBMS ä¼šé¢ä¸´åˆ†é…çš„å±‚æ¬¡é—®é¢˜ï¼š</p><ul><li>å±‚æ¬¡ä½çš„è¯ï¼Œåˆ†é…æ›´å¤šä½å±‚æ¬¡é”ï¼Œå…è®¸æ›´é«˜çš„å¹¶è¡Œåº¦ï¼Œä½†æ˜¯ LockTable ä¼šé¢ä¸´æ›´å¤§çš„æ—¶ç©ºå¼€é”€ï¼ˆä¸»è¦æ˜¯å†…å­˜/CPUï¼‰ã€‚</li><li>åˆ†é…é«˜å±‚æ¬¡é”ï¼Œå¯èƒ½çš„å¹¶è¡Œåº¦ä¼šé™ä½ï¼Œä½†æ˜¯ LockTable é¢ä¸´çš„æ—¶ç©ºå¼€é”€å‡å°ã€‚</li></ul><p>åŒæ—¶ï¼Œå®ç°è€…åœ¨ LockTable ç»´æŠ¤ Lock çš„æ—¶å€™ï¼Œä¼šå‘ç°ï¼Œåè°ƒä¸åŒå±‚æ¬¡çš„é”æ˜¯å›°éš¾çš„ï¼Œè€Œä¸”ä» Root å¼€å§‹é”å®šå¼€é”€è¿‡å¤§ï¼Œå› æ­¤æœ‰äº† intention locks.</p><ul><li>IS: Intention-Sharedï¼Œå¸Œæœ›æ›´ç»†ç²’åº¦çš„è·å¾— shared lock</li><li>IX: Intention-Exclusive: å¸Œæœ›è·å¾—æ›´ç»†ç²’åº¦çš„ exclusive lock</li><li>SIX: S + IX</li></ul><p><img src="https://image.mwish.me/blog-image/C7506976-D338-406A-BCDF-94246279E1DD.png" alt="C7506976-D338-406A-BCDF-94246279E1DD"></p><p>è¿™ä¸ªåº”è¯¥æ¨ªåæ ‡æ˜¯ holding lock, çºµç€çš„æ˜¯è¿‡æ¥çš„è¯·æ±‚ã€‚äº‹åŠ¡ç»™ä¸‹å±‚ä¸Š S/X é”ï¼Œçˆ¶èŠ‚ç‚¹å¿…é¡»æœ‰å¯¹åº”çš„é”æˆ–è€…æ„å‘é”ã€‚</p><p>å‘ç°è¡Œé”è¿‡å¤šå¯èƒ½ä¼šè¿›è¡Œé”çš„å‡çº§(escalation) ï¼Œæ¥æ›´æ–°çˆ¶çº§åˆ«çš„é”. ä¸è¿‡ InnoDB æ²¡æœ‰ï¼Œå› ä¸ºå®ƒè‡ªç§°è‡ªå·±ä¸Šé”å¾ˆä¾¿å®œï¼ˆè™½ç„¶è¢«ä½•ç™»æˆè€å¸ˆåæ§½è¿‡ orzï¼‰ï¼š<a href="https://dev.mysql.com/doc/refman/5.6/en/innodb-transaction-model.html">https://dev.mysql.com/doc/refman/5.6/en/innodb-transaction-model.html</a></p><h4 id="Predicate"><a href="#Predicate" class="headerlink" title="Predicate"></a>Predicate</h4><p>S2PL å¾ˆå¤§ç¨‹åº¦ä¸Šèƒ½é˜²æ­¢ G0 G1 G2-Item äº†ï¼Œä½†æ˜¯æ— æ³•ä¿è¯ G2 ä¸å‘ç”Ÿï¼Œæ‰€ä»¥éœ€è¦å¤„ç† predicateã€‚è¿™é‡Œå¯ä»¥ï¼š</p><ol><li>æ•´ä¸ª Lock ä½ä¿¡æ¯ï¼šæ·»åŠ ä¸€ä¸ª information object, è¯»ä¼šå¯¹ä»–ä¸Š S-LOCKï¼Œå†™ä¼š X-LOCKï¼Œå¯¼è‡´äº§ç”Ÿå†²çªã€‚è¿™ç§æ–¹å¼çš„ç¼ºç‚¹æ˜¯å¹¶è¡Œèƒ½åŠ›å¤ªå·®ï¼Œéœ€è¦æŠŠæ•´ä¸ªå¯¹åº”çš„ index é”ä½ã€‚</li><li>é‡‡ç”¨ index-lockingï¼šè¯»/å†™ä¹‹å‰å¯¹å¯¹åº” B+tree index çš„ leaf node é”å®šï¼Œæ›´æ–°çš„æ—¶å€™é”å®š index çš„ <code>(old)</code> <code>(new)</code></li><li>predicate-locking: å¯¹ Predicate ä¸Šé”ï¼Œæ¯”è¾ƒå¤æ‚ã€æ€§èƒ½ä½ä¸‹è€Œä¸€èˆ¬ä¸é‡‡ç”¨ã€‚</li></ol><p>MySQL é‡‡ç”¨äº† next-key locking çš„å®ç°ï¼Œæ¥è§£å†³ predicate å’Œ phantom çš„é—®é¢˜ã€‚ä¸ºä»€ä¹ˆæ˜¯ Next-Key Locking? è¿™ä¸ªç­–ç•¥è²Œä¼¼æ˜¯ä¸Šä¸–çºª ARIES/KVL æå‡ºæ¥çš„ï¼Œå°†è°“è¯é”è½¬åŒ–ä¸ºè®°å½•çš„é”ï¼Œè¿™ç§æ–¹å¼ç›¸å¯¹æ¥è¯´ç›´è§‚åˆèŠ‚çœç©ºé—´ã€‚</p><h4 id="æ’å…¥å’Œåˆ é™¤"><a href="#æ’å…¥å’Œåˆ é™¤" class="headerlink" title="æ’å…¥å’Œåˆ é™¤"></a>æ’å…¥å’Œåˆ é™¤</h4><p>æ’å…¥æœ¬èº«éœ€è¦æ³¨æ„é”ç›¸å…³çš„ä¿¡æ¯ã€‚æ¯”æ–¹è¯´æ’å…¥çš„æ—¶å€™æœ¬èº«è¦å¯¹è®°å½•ä¸Šé”ï¼Œåˆ é™¤çš„æ—¶å€™ä¹Ÿè¦æ³¨æ„ä¸Šé”ã€‚MySQL ä¼šæœ‰æ’å…¥æ„å‘é”ï¼Œå…·ä½“å¯è§éšå¼é”ç›¸å…³çš„æè¿°ï¼š<a href="http://mysql.taobao.org/monthly/2020/09/06/">http://mysql.taobao.org/monthly/2020/09/06/</a> ã€‚</p><h4 id="æ‚é¡¹"><a href="#æ‚é¡¹" class="headerlink" title="æ‚é¡¹"></a>æ‚é¡¹</h4><p>æ›´ä½çº§çš„ä¸€è‡´æ€§ï¼Œæ¯”å¦‚äºŒçº§ä¸€è‡´æ€§(degree-two consistency)å¯ä»¥é æå‰é‡Šæ”¾è¯»é”ä¹‹ç±»çš„æ–¹å¼æ¥å®ç°. æœ‰ä¸€ç§æ–¹å¼è¢«ç§°ä¸ºæ¸¸æ ‡ä¸€è‡´æ€§ï¼Œè¿™é‡Œä¼šåœ¨ cursor è¯»æœŸé—´ä¸Šè¯»é”ï¼Œè¯»å®Œä¹‹åé‡Šæ”¾ã€‚</p><p>increment lock æ˜¯ä¸€ç§ç‰¹æ®Šçš„é”ã€‚ä¸ºäº†ä¿è¯åœ¨æŸäº› inc/dec æ“ä½œä¸Šçš„é«˜æ•ˆè€Œä½¿ç”¨:</p><p><img src="https://image.mwish.me/blog-image/D2AC199C-DD0C-47B8-9BBD-2B67BD4357FD.png" alt="D2AC199C-DD0C-47B8-9BBD-2B67BD4357FD"></p><h2 id="TS"><a href="#TS" class="headerlink" title="TS"></a>TS</h2><p>å¯¹äº 2PL è€Œè¨€ï¼Œå¦‚æœè¦å®šåºï¼Œäº‹åŠ¡æœ¬èº«ä¼šåœ¨ç¬¬ä¸€ä¸ª lock é‡Šæ”¾çš„æ—¶å€™ä½œä¸º commit æ—¶é—´ã€‚2PL æœ¬èº«æœ‰è¿™ä¸ªä¾èµ–ï¼Œå…¶å®å°±ç®€å•å®ç°ä¸€ä¸‹æ˜¯ä¸éœ€è¦ commit_ts start_ts çš„ã€‚</p><p>Basic-TS åè®®åˆ™ä¸ç„¶ï¼Œå®ƒä¼šåœ¨äº‹åŠ¡å¼€å§‹çš„æ—¶å€™ï¼Œç»™äº‹åŠ¡ä¸€ä¸ª TSï¼Œå¯¹äºäº‹åŠ¡ Tï¼Œè®°ä½œ <code>TS(T)</code>ï¼Œè€Œ ts æ˜¯å°½é‡å•è°ƒé€’å¢çš„ï¼ˆå¯ä»¥æ˜¯ç³»ç»Ÿæ—¶é—´æˆ–è€…æ˜¯ä¸€ä¸ª counterï¼‰ï¼ŒæŸç§æ„ä¹‰ä¸Šï¼Œè¿™ç»™äº†æ‰€æœ‰äº‹åŠ¡ä¸€ä¸ª total orderã€‚</p><p>é‚£ä¹ˆï¼Œæˆ‘ä»¬åœ¨äº‹åŠ¡å¼€å§‹çš„æ—¶å€™å°±è·å¾—äº†â€œå¦‚æœ commit åº”è¯¥æœ‰çš„ tsâ€, æ‰€ä»¥ï¼Œå®ç°ä¸Šä¼šéœ€è¦æ¯ä¸ª object çš„è¯»/å†™ æ—¶é—´ï¼Œæ¥å®Œæˆç›¸å…³çš„éªŒè¯ï¼Œä¸€æ—¦å‘ç°è¿èƒŒäº†éš”ç¦»çº§åˆ«çš„éœ€æ±‚ï¼Œå°±è¦è¿›è¡Œä¸€å®šçš„æ¢å¤å¤„ç†ï¼š</p><p>To implement this scheme, we associate with each data item <em>Q</em> two timestamp values:</p><ol><li><strong>W-timestamp</strong>(<em>Q</em>) denotes the largest timestamp of any transaction that executed write(<em>Q</em>) successfully.</li><li><strong>R-timestamp</strong>(<em>Q</em>) denotes the largest timestamp of any transaction that executed read(<em>Q</em>) successfully.</li></ol><p>ç„¶åï¼Œæœ‰ä¸€äº›å¯¹åº”çš„è¯»å†™è§„åˆ™ï¼š</p><p><img src="https://image.mwish.me/blog-image/A863B4B2-7871-4E03-8D5C-1B2EC2F46CAB.png" alt="A863B4B2-7871-4E03-8D5C-1B2EC2F46CAB"></p><p>ä¸Šé¢æ¯”è¾ƒå¤æ‚ï¼Œä¸è¿‡ç®€å•è¯´å¤§æ¦‚æ€è·¯å°±æ˜¯ï¼š</p><ol><li>æ¬²å†™ <code>X</code>ï¼Œä¸å¯ä»¥å†™ <code>TS(T) &lt; W-TS(X)</code> çš„æ•°æ®ï¼Œä¸èƒ½è¢«å®šåºçš„åæ¥å†™å…¥çš„äº‹åŠ¡å†™äº†ã€‚</li><li>æ¬²å†™ <code>X</code>ï¼Œä¸å¯ä»¥å†™ <code>TS(T) &lt; R-TS(X)</code> çš„æ•°æ®ï¼Œä¸èƒ½è¢«å®šåºçš„åæ¥å†™å…¥çš„äº‹åŠ¡è¯»äº†ã€‚</li><li>æ¬²è¯» , ä¸èƒ½è¯»åˆ°å®šåºçš„äº‹åŠ¡ä¹‹åçš„å†™å…¥ã€‚</li></ol><p>æˆ‘ä»¬ä¸‹é¢æ¥è€ƒè™‘ Recoverable å’Œ Cascadeless:</p><p>TS åè®®æœ¬èº«ä¸æ˜¯ recoverable çš„ï¼Œéœ€è¦ä¸€å®šçš„æ›´æ”¹ï¼Œæœ‰ä¸‹é¢è¿™äº›å‚è€ƒæ–¹æ¡ˆï¼š</p><ol><li>Recoverability and cascadelessness can be ensured by performing all writes together at the end of the transaction. The writes must be atomic in the following sense: While the writes are in progress, no transaction is permitted to access any of the data items that have been written.</li><li>Recoverability and cascadelessness can also be guaranteed by using a limited form of locking, whereby reads of uncommitted items are postponed until the transaction that updated the item commits.</li><li>Recoverability alone can be ensured by tracking uncommitted writes and allowing a transaction <em>T**i</em> to commit only after the commit of any transaction that wrote a value that <em>T**i</em> read. Commit dependencies, outlined in Section 18.1.5, can be used for this purpose.</li></ol><p>TS ä¸ä¼šäº§ç”Ÿæ­»é”ï¼Œå› ä¸ºæœ‰å†²çªéƒ½ abort äº†ã€‚ä½†æ˜¯ Basic-TS æœ‰ä¸€äº› performance ä¸Šçš„é—®é¢˜ï¼š</p><ol><li>æœ¬èº«ä¸æ˜¯ recoverable çš„ï¼Œéœ€è¦ä¸€å®šçš„æ›´æ”¹ã€‚</li><li>æ›´æ–° timestamp å¼€é”€æ¯”è¾ƒå¤§ã€‚</li><li>é•¿æ—¶é—´è¿è¡Œçš„äº‹åŠ¡ç¢°è§å†²çªæ¦‚ç‡æ¯”è¾ƒå¤§ï¼Œå¯èƒ½ä¼šé¥¿æ­»ã€‚</li></ol><p>å…³äº ts åè®®æœ‰ä¸€äº›æ‰¹è¯„ï¼Œå°±æ˜¯å³ä½¿è¯»ä¹Ÿè¦æ›´æ–°ç›¸å…³çš„æ•°æ®ï¼Œé€ æˆé¢å¤–çš„å†™å¼€é”€ã€‚</p><h3 id="Thomas-Write-Rule"><a href="#Thomas-Write-Rule" class="headerlink" title="Thomas-Write Rule"></a>Thomas-Write Rule</h3><p>å›é¡¾ä¸€ä¸‹è§„åˆ™ï¼šæ¬²å†™ <code>X</code>ï¼Œä¸å¯ä»¥å†™ <code>TS(T) &lt; R-TS(X)</code> çš„æ•°æ®ï¼Œä¸èƒ½è¢«å®šåºçš„åæ¥å†™å…¥çš„äº‹åŠ¡è¯»äº†ã€‚</p><p>Thomas-Write Rule å…è®¸ä½ è·³è¿‡è¿™ä¸ªè§„åˆ™ï¼Œå› ä¸ºä½ å¯ä»¥è§†ä½œâ€œå†™å…¥è¢«åæ¥çš„è¦†ç›–äº†â€ã€‚</p><h2 id="OCC-åŸºäºæ£€æŸ¥çš„æ–¹æ³•"><a href="#OCC-åŸºäºæ£€æŸ¥çš„æ–¹æ³•" class="headerlink" title="OCC: åŸºäºæ£€æŸ¥çš„æ–¹æ³•"></a>OCC: åŸºäºæ£€æŸ¥çš„æ–¹æ³•</h2><p>å¯¹äºä¸€ä¸ªäº‹åŠ¡è€Œè¨€ï¼Œå¦‚æœå¤§éƒ¨åˆ†äº‹åŠ¡æ˜¯åªè¯»äº‹åŠ¡ï¼Œå†²çªè¾ƒå°‘ï¼Œé‚£ä¹ˆåº”è¯¥å‡è½»å„ç§å¤„ç†çš„å¼€é”€ã€‚OCC å¤§è‡´åˆ†ä¸ºä¸‰ä¸ªé˜¶æ®µï¼š</p><ol><li>Read Phase: è¯»å¯¹è±¡ï¼ŒæŠŠå¯¹è±¡ copy åˆ°äº‹åŠ¡å†…å†™</li><li>Validation Phase: txn commit çš„æ—¶å€™, æ£€æŸ¥äº‹åŠ¡æ˜¯å¦å’Œåˆ«çš„äº‹åŠ¡äº§ç”Ÿå†²çª</li><li>Write Phase: æŠŠè®°å½•å†™å…¥</li></ol><p>æˆ‘ä»¬å¼•å…¥å‡ ä¸ªæ—¶é—´ç‚¹ï¼ˆä¸ä¸€å®šè¦åˆ†é…æ—¶é—´æˆ³ï¼‰æ¥å¸®åŠ©ç†è§£è¿™ä¸ªæµç¨‹ï¼š</p><ol><li><code>StartTs(T)</code>: äº‹åŠ¡å¼€å§‹æ‰§è¡Œçš„æ—¶é—´</li><li><code>ValidationTS(T)</code>:  å®Œæˆ Read Phase, å¼€å§‹è¿›å…¥ <code>StartTs</code> çš„æ—¶é—´æˆ³</li><li><code>FinishTs(T)</code>: å®Œæˆå†™é˜¶æ®µçš„æ—¶é—´æˆ³</li></ol><p>è¿™é‡Œå¯ä»¥å°è¯•åœ¨ Validation Phase ä¸­åˆ†é…æ—¶é—´æˆ³ï¼Œç„¶å trace è¯»å†™çš„å¯¹åº”æ—¶é—´æˆ³ï¼š</p><ol><li>ä¸¤ä¸ªäº‹åŠ¡æ²¡æœ‰å†²çªï¼Œä¸” <code>TS(Tk) &lt; TS(Ti)</code>, å½“ä¸”ä»…å½“ï¼š<ol><li><code>FinishTS(Tk) &lt; StarTs(Ti)</code>. è¿™ç‚¹æ˜¯æ˜¾è€Œæ˜“è§çš„</li><li><code>ValidationTS(Ti) &gt; FinishTS(Tk)</code> ä¸” <code>WriteSet(Tk)</code> å’Œ <code>ReadSet(Ti)</code> æ²¡æœ‰ç›¸äº¤</li></ol></li></ol><p>è¿™ä¸ªæ–¹æ³•æ˜¯ Cascadeless çš„ï¼Œå› ä¸º Write é˜¶æ®µä¹‹åæ‰èƒ½è¯»åˆ°æ­£ç¡®æ•°æ®ã€‚</p><p>CMU 15-445 æè¿°äº†ä¸€ä¸ª validation çš„åŸºæœ¬ç­–ç•¥ï¼Œä»–çš„å¤§è‡´é€»è¾‘å¦‚ä¸‹ï¼š</p><ol><li>æ£€æŸ¥ä¸ StartTS è‡³ ValidationTS é—´çš„æäº¤äº‹åŠ¡æœ‰æ— å†²çªï¼Œå³éªŒè¯æ˜¯å¦è¯»å–äº† FinishTS äº‹åŠ¡çš„å†™é›†åˆ</li><li>å‘ç°è¿›å…¥ ValidationTS çš„äº‹åŠ¡ä¸­ï¼Œæ›´æ—§çš„äº‹åŠ¡çš„æ—¶å€™ï¼Œè¿›è¡Œä¸‹åˆ—éªŒè¯ï¼š<ol><li>éªŒè¯é˜¶æ®µçš„æ—¶å€™ï¼ˆå‡†ç¡®è¯´æ˜¯å¼€å§‹å†™çš„æ—¶å€™ï¼‰ï¼Œå¯¹æ–¹å·²å®Œæˆå†™ã€‚é‚£æ–°äº‹åŠ¡çš„è¯»é›†å’Œæ—§äº‹åŠ¡å†™é›†ä¸å†²çªå³å¯ã€‚</li><li>éªŒè¯é˜¶æ®µçš„æ—¶å€™ï¼Œå¯¹æ–¹æ²¡å®Œæˆå†™ï¼Œé‚£è¦æ±‚æ—§äº‹åŠ¡çš„å†™é›†ä¸å’Œæ–°äº‹åŠ¡çš„è¯»å†™é›†å†²çªã€‚</li></ol></li></ol><p>è¿›å…¥ ValidationTS çš„æ—¶å€™ï¼ŒTS æ˜¯é€’å¢çš„ã€‚å¦‚æœç”¨ StartTS ä½œäº‹åŠ¡çš„æ—¶é—´æˆ³ï¼Œæœ¬èº«åè®®ä¸Šæ˜¯æ»¡è¶³åºåˆ—åŒ–çš„ï¼Œä½†æ˜¯é—®é¢˜åœ¨äºéªŒè¯çš„æ—¶é—´æˆ³å¯èƒ½ä¸æ˜¯é€’å¢çš„ï¼Œè¿™ä¸ªæƒ…å†µä¸‹å¯èƒ½å‡ºç°ï¼š</p><ol><li>ä¸¤ä¸ªäº‹åŠ¡å·®ä¸å¤šæ—¶å€™å¼€å§‹ï¼Œ<code>TS(i) &lt; TS(j)</code></li><li><code>j</code> æ¯” <code>i</code> æ›´æ—©è¿›å…¥éªŒè¯é˜¶æ®µ</li></ol><p>è¿™ä¸ªæ—¶å€™è‚¯å®šå°±æœ‰é—®é¢˜äº†ï¼Œæ‰€ä»¥å€¾å‘äºåœ¨ Validation é˜¶æ®µåˆ†é…ã€‚</p><h2 id="æ€§èƒ½è¯„ä¼°"><a href="#æ€§èƒ½è¯„ä¼°" class="headerlink" title="æ€§èƒ½è¯„ä¼°"></a>æ€§èƒ½è¯„ä¼°</h2><p>è¿™é‡Œä¸è€ƒè™‘ MVCC çš„éƒ¨åˆ†ï¼Œå¯¹ä»–ä»¬çš„æ€§èƒ½è¿›è¡Œè¯„ä¼°. <code>&lt;Staring into the Abyss: An Evaluation of Concurrency Control with One Thousand Cores&gt;</code> ç»™äº†ä¸€ä¸ªè¯„ä¼°ï¼Œä½†æˆ‘ä¸æ˜¯å¾ˆä¿¡ä»»å®ƒçš„ç»“æœï¼Œæ„Ÿè§‰ä½œè€…å¯¹ scalable counter æ²¡å•¥ç»éªŒã€‚</p><h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p>2PL éƒ¨åˆ†ï¼š</p><ul><li>InnoDB çš„ Locking <a href="https://dev.mysql.com/doc/refman/8.0/en/innodb-locking.html">https://dev.mysql.com/doc/refman/8.0/en/innodb-locking.html</a></li><li>InnoDBå­˜å‚¨å¼•æ“(ç¬¬2ç‰ˆ) <a href="https://book.douban.com/subject/24708143/">https://book.douban.com/subject/24708143/</a></li><li>CMU 15-445</li><li>æ•°æ®åº“ç³»ç»Ÿæ¦‚å¿µ(ç¬¬ä¸ƒç‰ˆ)</li></ul><p>TS éƒ¨åˆ†ï¼š</p><ul><li>CMU 15-445</li><li>æ•°æ®åº“ç³»ç»Ÿæ¦‚å¿µ(ç¬¬ä¸ƒç‰ˆ)</li></ul><p>OCC éƒ¨åˆ†ï¼š</p><ul><li>CMU 15-445</li><li>Microsoft Hekaton</li><li>æ•°æ®åº“ç³»ç»Ÿæ¦‚å¿µ(ç¬¬ä¸ƒç‰ˆ)</li></ul>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>äº‹åŠ¡:åè®®å’Œéš”ç¦»</title>
      <link href="/2020/11/14/%E4%BA%8B%E5%8A%A1-%E5%8D%8F%E8%AE%AE%E5%92%8C%E9%9A%94%E7%A6%BB/"/>
      <url>/2020/11/14/%E4%BA%8B%E5%8A%A1-%E5%8D%8F%E8%AE%AE%E5%92%8C%E9%9A%94%E7%A6%BB/</url>
      
        <content type="html"><![CDATA[<h1 id="äº‹åŠ¡ï¼šéš”ç¦»çº§åˆ«å’Œåè®®"><a href="#äº‹åŠ¡ï¼šéš”ç¦»çº§åˆ«å’Œåè®®" class="headerlink" title="äº‹åŠ¡ï¼šéš”ç¦»çº§åˆ«å’Œåè®®"></a>äº‹åŠ¡ï¼šéš”ç¦»çº§åˆ«å’Œåè®®</h1><p>åº”ç”¨ç¨‹åºå‘˜ä¼šä¾èµ–äº‹åŠ¡è¿™ä¹ˆä¸€ç§æŠ½è±¡ï¼šäº‹åŠ¡ã€‚å®ƒæä¾›äº† ACID çš„æŠ½è±¡ï¼ŒA å¯ä»¥ç†è§£ä¸ºå¤šè¡Œæ•°æ®è¯»/å†™çš„åŸå­æ€§ï¼›C æ®è¯´æ˜¯ç”¨æ¥å‡‘æ•°çš„ï¼›I è¡¨ç¤ºäº‹åŠ¡ä¸­é—´æœ‰æŸç§äº’ç›¸éš”ç¦»ï¼›D è¡¨ç¤ºäº‹åŠ¡æ˜¯æŒä¹…çš„ã€‚å¯¹äºåº”ç”¨ç¨‹åºå‘˜è€Œè¨€ï¼ŒæŠ½è±¡æ˜¯éš”ç¦»çº§åˆ«ã€‚å…³äºè¿™ç‚¹ï¼Œå¯ä»¥ç®€å•è¿™ä¹ˆç†è§£ï¼š<strong>éš”ç¦»çº§åˆ«è¶Šé«˜ï¼Œå†²çªè¶Šå‰§çƒˆï¼Œå¯èƒ½çš„æ€§èƒ½ä¼šæ›´å·®</strong>ã€‚è€Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ç‰ºç‰²ä¸€äº›ä¿è¯ï¼Œæ¥æä¾›æ€§èƒ½</p><p>å¯¹åº”ç”¨ç¨‹åºå‘˜è€Œè¨€ï¼Œéœ€è¦ç†è§£çš„æ˜¯éš”ç¦»çº§åˆ«ï¼Œç”šè‡³æ•°æ®åº“æ›´ä¸Šå±‚çš„å»ºæ¨¡ã€ç¼“å­˜ã€‚ANSI-92 ä¸­ç»™å‡ºäº†ä¸€å®šçš„éš”ç¦»çº§åˆ«çš„å®šä¹‰ï¼Œä½†æ˜¯å¯¹ä¹è§‚çš„äº‹åŠ¡è€Œè¨€ï¼Œæˆ‘ä»¬ä»ç„¶éœ€è¦ç†è§£ä¸€äº›ä¸åŒçš„æ ‡å‡†ã€‚æˆ‘ä»¬ä¸‹é¢ä¼šä»‹ç»ä¸€äº›éš”ç¦»çº§åˆ«ï¼Œè¿™é‡Œæ´å¼•äº† DDIA çš„å®šä¹‰ï¼š</p><ol><li>Read Committed: <ol><li>ï¼ˆæœ€åŸºç¡€çš„éš”ç¦»çº§åˆ«ï¼Œå¾ˆå¤šæ—¶å€™</li><li>ä» DB è¯»çš„æ—¶å€™ï¼Œåªèƒ½çœ‹åˆ°å·²ç»æäº¤çš„æ•°æ®ï¼Œæ²¡æœ‰è„è¯»</li><li>å†™å…¥çš„æ—¶å€™ï¼Œä¸ä¼šè¦†ç›–æ‰æœªå†™å…¥çš„æ•°æ®ï¼Œæ²¡æœ‰è„å†™</li><li>å¯èƒ½çš„å®ç°ï¼šè¡Œçº§åˆ«çš„ Lockï¼Œæˆ–è€…æ˜¯ MVCC/COW ç­‰æœºåˆ¶</li></ol></li><li>Repeatable Read: æ²¡æœ‰ read skew</li><li>Snapshot Isolation: ä»ä¸€ä¸ªä¸€è‡´æ€§çš„è§†å›¾ä¸­è¯»å–<ol><li>æ²¡æœ‰read skew</li><li>å¯èƒ½ä¼šæœ‰ write skew</li></ol></li><li>Serializable: æ‰€æœ‰äº‹åŠ¡çš„è°ƒåº¦æ˜¯å¯ä¸²è¡ŒåŒ–çš„</li></ol><p>æˆ‘ä»¬è¿˜æœ‰ä¸€äº›ç°è±¡ï¼Œä»£è¡¨æŸç§ç¨‹åº¦ä¸Šå¯¹äº‹åŠ¡çš„ breakï¼š</p><ol><li>Dirty reads: çœ‹åˆ°äº†æœªæäº¤çš„æ•°æ®</li><li>Dirty write: ä¸èƒ½è¦†ç›–å¦ä¸€ä¸ªäº‹åŠ¡çš„å°šæœªæäº¤çš„ä¸€éƒ¨åˆ†</li><li>Read skew/unrepeatable read: ä¸¤æ¬¡è¯»åŒä¸€ä¸ª record å¯èƒ½è¯»åˆ°ä¸åŒçš„å€¼</li><li>write skew: å¯ä»¥å°†å†™å…¥åå·®è§†ä¸ºä¸¢å¤±æ›´æ–°é—®é¢˜çš„ä¸€èˆ¬åŒ–ã€‚å¦‚æœä¸¤ä¸ªäº‹åŠ¡è¯»å–ç›¸åŒçš„å¯¹è±¡ï¼Œç„¶åæ›´æ–°å…¶ä¸­ ä¸€äº›å¯¹è±¡ï¼ˆä¸åŒçš„äº‹åŠ¡å¯èƒ½æ›´æ–°ä¸åŒçš„å¯¹è±¡ï¼‰ï¼Œåˆ™å¯èƒ½å‘ç”Ÿå†™å…¥åå·®ã€‚åœ¨å¤šä¸ªäº‹åŠ¡æ›´æ–°åŒä¸€<br>ä¸ªå¯¹è±¡çš„ç‰¹æ®Šæƒ…å†µä¸‹ï¼Œå°±ä¼šå‘ç”Ÿè„å†™æˆ–ä¸¢å¤±æ›´æ–°ï¼ˆå–å†³äºæ—¶æœºï¼‰ã€‚åœ¨ PG MySQL/InnoDB ç­‰çš„ RR çº§åˆ«ä¸‹ï¼Œéƒ½æ— æ³•é¿å… Write Skew</li><li>phantom readï¼šDDIA è®¤ä¸ºè¿™æ˜¯å¯¼è‡´å†™å…¥åå·®çš„æ ¹æºï¼ŒSELECT æŸ¥è¯¢åˆ°ç¬¦åˆæ¡ä»¶çš„ columnsï¼Œç„¶åæŒ‰ç…§æ¡ä»¶æ“ä½œä¸€ä¸ª subsetã€‚è¿™ä¸ªæ—¶å€™ï¼Œä¸€ä¸ªäº‹åŠ¡ä¸­çš„å†™å…¥å¯¼è‡´äº†å¦ä¸€ä¸ªäº‹åŠ¡æŸ¥è¯¢ç»“æœè¢«æ”¹å˜ã€‚ </li></ol><p>å…¶å®ä¸Šé¢è¿™äº›æˆ‘æ•´ç†çš„è¿˜æ˜¯æŒºä¹±çš„ï¼Œæœ‰ç©ºçš„å¯ä»¥å›é¡¾ä¸€ä¸‹ DDIAâ€¦ä½†æ˜¯ä¸Šé¢è¿™äº›è™½ç„¶ä¹±ï¼Œä½†æ˜¯å¯¹åº”çš„å†…å®¹å…¶å®æ˜¯ä¸éš¾æ‡‚çš„ã€‚éš¾å°±éš¾åœ¨æ˜¾ç¤ºå¯èƒ½æœ‰ç‚¹åŒºåˆ«ï¼š</p><ul><li>DDIA çš„å®šä¹‰å€¾å‘äº 2PL + MVCC ç›¸å…³ï¼Œä½†æ˜¯å®é™…ä¸Šä¼šæœ‰ä¸åŒçš„å®ç°ã€‚åˆ«çœ‹å®ç°éƒ½ä¼šå°½é‡å®ç°æ ‡å‡†ï¼Œä½†æ˜¯åœ¨æ•°æ®åº“é¢†åŸŸï¼ŒæŸä¸ªåœ°æ–¹çš„å®ç°èƒ½å†³å®šå¤ªå¤šçš„è¡Œä¸ºäº†ã€‚</li><li>æœ‰å¾ˆå¤šæ•°æ®åº“é‡‡å–ä¹è§‚çš„å¹¶å‘æ§åˆ¶ï¼Œä»–ä»¬çš„è¡¨ç°ä¼šä¸ä¼šä¸å¤ªä¸€æ ·ï¼Ÿ</li><li>æœ‰éƒ¨åˆ†æ•°æ®åº“å®ç°ä¸Šé‡‡å– SI ä»£æ›¿ RRï¼Œè¿™ä¼šä¸ä¼šå¯¼è‡´å®šä¹‰ä¸Šæœ‰ä»€ä¹ˆé—®é¢˜ï¼Ÿ</li><li>å¦‚ä½•ç†è§£ MySQLï¼ŒPG è¿™ç±»çš„éš”ç¦»çº§åˆ«ï¼Ÿ</li><li>â€œå†™åè¯»â€ è¿™äº›å®šä¹‰å’Œä¸Šè¿°æœ‰ä»€ä¹ˆå…³ç³»ï¼Ÿ</li></ul><p>æˆ‘ä»¬å°½é‡ä»¥ä¸ä»‹ç»å®ç°çš„æƒ…å†µä¸‹æ¥è®²è®²ï¼Œä½†æ˜¯ä¸‹é¢å†…å®¹å¯èƒ½ä¸å¯é¿å…çš„è¦æ±‚ä½ å¯¹ 2PL MVCC SI æœ‰ç€æœ€åŸºç¡€çš„ç†è§£ã€‚åœ¨æ•°æ®åº“é¢†åŸŸï¼ŒæŸä¸ªåœ°æ–¹çš„å®ç°èƒ½å†³å®šæ•´ä¸ªé“¾è·¯çš„è¡Œä¸ºã€‚</p><h2 id="ANSI-92-Phenomena"><a href="#ANSI-92-Phenomena" class="headerlink" title="ANSI-92 Phenomena"></a>ANSI-92 Phenomena</h2><p><img src="https://image.mwish.me/blog-image/8A4D7051-23D4-43B1-9E29-90FC938CD97A.png" alt="8A4D7051-23D4-43B1-9E29-90FC938CD97A"></p><p><img src="https://image.mwish.me/blog-image/6B34260B-EF80-4FA3-AC86-94F2B91FD159.png" alt="6B34260B-EF80-4FA3-AC86-94F2B91FD159"></p><p>1/2 è¡¨ç¤ºäº‹åŠ¡ IDï¼Œc a è¡¨ç¤º COMMIT ABORTï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥å¾ˆå¥½çš„æŠŠä¸Šé¢çš„å››ä¸ª P å¯¹åº”åˆ° DDIA çš„å®šä¹‰ä¸­ã€‚è¿™ä¸ªéœ€è¦æ”¾åˆ°å•å¯¹è±¡ + Lock çš„ç¯å¢ƒä¸‹ç†è§£ï¼š</p><ol><li>P0: å¯¹å•å¯¹è±¡çš„è¦†ç›–å†™å…¥ï¼Œå³è„å†™ï¼Œå¯¼è‡´ä»… COMMIT çš„æ—¶å€™æ•°æ®åº“çš„çŠ¶æ€ä¸º Txn2 çš„å†™å…¥ã€‚</li><li>P1 å¯¹å•å¯¹è±¡çš„è„è¯»ã€‚å¦‚æœ TXN1 abort äº†ï¼Œé‚£ä¹ˆæ˜¾ç„¶å¾ˆå±é™©ã€‚</li><li>P2: å†™ä¿®æ”¹äº†è¯», ç±»ä¼¼ä¸å¯é‡å¤è¯»çš„ä¿®æ”¹ã€‚</li><li>P3: Phantom Readï¼Œå¯¹äºæŸä¸ª Predicate çš„è¯» â€” æ”¹</li></ol><p>æ‡‚äº†è¿™äº›ï¼Œä½ åº”è¯¥å¾ˆå¥½çœ‹æ‡‚ä¸Šé¢çš„å®šä¹‰ã€‚</p><p>ä½†æ˜¯ä½ å¯ä»¥å‘ç°ï¼Œå…¶å®æŸäº›æ—¶å€™ï¼Œåœ¨ä¹è§‚å¹¶å‘æˆ–è€… MVCC ä¸‹ï¼Œæœ‰äº›è°ƒåº¦ç”šè‡³æ˜¯æ²¡é—®é¢˜çš„ã€‚SI ç”šè‡³è®©äº‹æƒ…æ›´æ¨¡ç³Šã€‚è¿™é‡Œæˆ‘ä»¬å¯ä»¥å‚è€ƒå¦ä¸€ç¯‡è®ºæ–‡ï¼Œã€ŠGeneralize Isolation Level Definitionsã€‹çš„å®šä¹‰äº†ã€‚</p><p>æ‡‚äº†è¿™äº›ï¼Œä½ åº”è¯¥å¾ˆå¥½çœ‹æ‡‚ä¸Šé¢æˆ‘ä»¬åœ¨ç¬¬ä¸€èŠ‚çš„å®šä¹‰ã€‚ä½†æ˜¯è¿™ä¸ªå®šä¹‰æ˜¯åˆéº»çƒ¦çš„ï¼šå¯¹äºä¹è§‚ç”šè‡³ MVCC çš„å®ç°ï¼Œæˆ‘æ²¡å¯èƒ½ä¸ä¼šæ˜¾ç¤ºé”å®š/å…è®¸è¯»å†™æ˜¯å¹¶å­˜çš„ï¼Œé‚£ä¹ˆè¿™ä¸ªå®šä¹‰å®é™…ä¸Šå°±æ˜¯ä¸èƒ½æ»¡è¶³çš„ã€‚å®é™…ä¸Šæˆ‘ä»¬å¯ä»¥ break P0/P1ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">H1: r1(x, 5) w1(x, 1) r1(y, 5) w1(y, 9) r2(x, 1) r2(y, 9) c1 c2</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆï¼Œè¿™é‡Œ break äº†ä¸Šé¢çš„è¦æ±‚ï¼Œä½†æ˜¯ä»ç„¶æ˜¯å¯ä¸²è¡ŒåŒ–çš„è°ƒåº¦ã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¸€ä¸ªæ›´ specific çš„æ¨¡å‹æ¥æè¿°ã€‚</p><h3 id="å»ºæ¨¡-History-Event-Order"><a href="#å»ºæ¨¡-History-Event-Order" class="headerlink" title="å»ºæ¨¡: History Event Order"></a>å»ºæ¨¡: History Event Order</h3><p>æˆ‘ä»¬éœ€è¦ç¡®åˆ‡æè¿°äº‹åŠ¡ï¼Œæˆ‘ä»¬å°±éœ€è¦ä¸€ä¸ªå…·ä½“çš„æ¨¡å‹ã€‚æˆ‘ä»¬å…ˆè¿œç¦»å…³ç³»çš„æ¦‚å¿µï¼Œä» row/tuple å¼€å§‹ï¼š</p><ul><li><p>row/tuple æ˜¯ä¸€ä¸ª objectï¼Œå¯¹äºå•ä¸ª Object è€Œè¨€ï¼Œäº‹åŠ¡ä»¥ä¸€ä¸ª total order æ“ä½œè¿™ä¸ª object</p></li><li><p>ä¸€ä¸ª object æœ‰ 1 ä¸ªä»¥ä¸Šçš„ç‰ˆæœ¬ï¼Œå¯ä»¥è¯»åˆ° committed, uncommitted ç”šè‡³ abort çš„æ•°æ®</p></li><li><p>å¦‚æœ $T_i$ commit äº†ï¼Œé‚£ä¹ˆè®¤ä¸ºå¯¹ $T_i$ è€Œè¨€ï¼Œå®ƒå†™å…¥çš„ä»»ä½•ä¸€ä¸ª Object çš„ç‰ˆæœ¬ $x_i$ , $T_i$ install $x_i$, å¦‚æœ $T_i$ abort äº†ï¼Œé‚£ä¹ˆ $x_i$ ä¸ä¼šè¢«è§†ä½œ committed çš„ä¸€éƒ¨åˆ†ã€‚</p></li><li><p>$T<em>{init}$ æ˜¯ä¸€ä¸ªæŠ½è±¡çš„äº‹åŠ¡ï¼Œå®ƒè¢«è§†ä½œæœ€åˆçš„äº‹åŠ¡ï¼Œç»™æ¯ä¸ªå‡ºç°çš„ object ä¸€ä¸ªè™šæ‹Ÿçš„åˆå§‹ç‰ˆæœ¬ $X</em>{init}$ ï¼Œå½“äº‹åŠ¡ç¬¬ä¸€æ¬¡å†™å…¥çš„æ—¶å€™ï¼Œä» init å˜æˆæœ€åˆçŠ¶æ€ã€‚å½“è¿™ä¸ª object è¢«åˆ é™¤çš„æ—¶å€™ï¼Œè¢«æ ‡è®°æˆæœ€ç»ˆç‰ˆæœ¬ $X_{dead}$ ã€‚</p></li><li><p>å¦‚æœä¸€ä¸ªå¯¹è±¡è¢«åˆ é™¤ååˆè¢«æ’å…¥äº†ï¼Œé‚£ä¹ˆè§†ä¸ºä¸¤ä¸ªä¸åŒçš„å¯¹è±¡ã€‚</p></li></ul><p>æˆ‘ä»¬æŠŠæ•´ä¸ªæ“ä½œçš„åºåˆ—ç§°ä¸º <strong>Transaction History</strong>ï¼ŒHistory æœ‰ä¸¤éƒ¨åˆ†ç»„æˆï¼š</p><ul><li>ååºçš„ <strong>Events</strong> (<strong>E</strong>)</li><li>å…¨åºçš„ version order</li></ul><h4 id="Event"><a href="#Event" class="headerlink" title="Event"></a>Event</h4><p>å¯¹äº Eventï¼Œæˆ‘ä»¬å¯ä»¥æœ‰ï¼š</p><ol><li>Read(r)</li><li>Write(w)</li><li>commit(c)</li><li>abort(a)</li></ol><p>æˆ‘ä»¬æœ‰å¦‚ä¸‹çš„è®°å·</p><ol><li>TXN j è¯» X è¯»åˆ°ç‰ˆæœ¬ i, è·å¾—å€¼ vï¼Œå¯ä»¥è®°ä½œ $r<em>j(x_i, v)$ æˆ–è€… $r_j(x</em>{i.v})$</li><li>TXN i å†™ X å†™å…¥åˆ°ç‰ˆæœ¬ i, å€¼ vï¼Œå¯ä»¥è®°ä½œ $w<em>i(x_i, v)$ æˆ–è€… $w_i(x</em>{i.v})$</li></ol><p>å¯¹äºè¿™ä¸ª orderï¼Œæˆ‘ä»¬è¦æ˜ç™½ Event å’Œ version order çš„è§„åˆ™ï¼š</p><p>å¯¹äº Event è€Œè¨€ï¼Œå®ƒä¿è¯äº†äº‹åŠ¡çš„ååºå…³ç³»ï¼š</p><ol><li>å¦‚æœ  $r<em>j(x_i, v)$ å­˜åœ¨ï¼Œé‚£ä¹ˆå®ƒ preceded by $w_i(x</em>{i.v})$, å¹¶ä¸”å¯¹åº”ç€â€œæœ€è¿‘çš„å†™å…¥â€</li><li>åœ¨ Event ä¸­ï¼Œå¦‚æœ $w<em>i(x</em>{i.v})$ å’Œ  $r<em>j(x.m)$ ä¸­æ²¡æœ‰ä»»ä½•ä¸€ä¸ª $w_i(x</em>{i.{v2}})$, é‚£ä¹ˆ  $r<em>j(x.m)$ ç‹¬åˆ°çš„å¿…å®šç­‰äº $x</em>{i.v}$</li><li>History å¿…é¡»æ˜¯å®Œæ•´çš„ï¼Œæœ‰äº‹åŠ¡å°±å¿…é¡»æœ‰å¯¹åº”çš„ commit/abort</li></ol><h4 id="Version"><a href="#Version" class="headerlink" title="Version"></a>Version</h4><p>å¯¹äº version è€Œè¨€ï¼š</p><ol><li>å¯¹è±¡ x æœ‰ä¸€ä¸ª init ç‰ˆæœ¬å’Œè‡³å¤šä¸€ä¸ª dead ç‰ˆæœ¬</li><li>å®ƒçš„å¯è§ç‰ˆæœ¬åœ¨ init ç‰ˆæœ¬å’Œ dead ç‰ˆæœ¬ä¹‹é—´</li><li>å¦‚æœ History æœ‰ $r_j(x_i)$ é‚£ä¹ˆ $x_i$ ä¸ºå¯è§ç‰ˆæœ¬ï¼Œæ— è®ºæ˜¯å¦ commit</li></ol><p>åŒæ—¶ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œversion order ä¸ä¸€å®šå’Œå†™å…¥é¡ºåºæ˜¯å®Œå…¨ä¸€æ ·çš„ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">w1(x1) w2(x2) w2(y2) c1 c2</span><br><span class="line">r3(x1) w3(x3) w4(y4) a4</span><br></pre></td></tr></table></figure><p>è¿™é‡Œ x2 åœ¨ x1 åå†™å…¥ï¼Œä½†æ˜¯å› ä¸º commit çš„ orderï¼Œå®é™…ä¸Šå¯¹åº”çš„ x1 åœ¨ x2 å‰ã€‚</p><h3 id="Predicate"><a href="#Predicate" class="headerlink" title="Predicate"></a>Predicate</h3><p>å¯¹äºè°“è¯è€Œè¨€ï¼Œæˆ‘ä»¬éœ€è¦å¼•å…¥é¢å¤–çš„è®°å·ã€‚P æ˜¯ä¸€ä¸ª Boolean expressionï¼Œåœ¨æ•°æ®é›†é‡Œé¢ï¼Œæ»¡è¶³è¿™ä¸ªè¦æ±‚çš„ç‰ˆæœ¬é›†åˆè¢«ç§°ä¸º <code>Vset(P)</code> ã€‚æ³¨æ„ï¼Œè¿™ä¸ªé›†åˆ ä¹‹åŒ…å«å­˜åœ¨çš„è®°å½•ï¼Œæœªæ¶‰åŠçš„ init è®°å½•è¿™äº›æ˜¯ä¸å­˜åœ¨çš„, å®ƒåªåŒ…å«å¯¹åº”çš„ visible å¯¹è±¡ã€‚</p><p>å¯¹äºè¯»å–è€Œè¨€ï¼Œå‡è®¾æœ‰ä¸‹åˆ—çš„ SQLï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> EMPLOYEE <span class="keyword">WHERE</span> DEPT <span class="operator">=</span> SALES;</span><br></pre></td></tr></table></figure><p>åŒæ—¶æœ‰ x,  y ä¸¤ä¸ª object ï¼Œå®ƒä»¬çš„ç‰ˆæœ¬åˆ†åˆ«ä¸º 1 2ï¼Œx æ»¡è¶³ <code>DEPT=SALES</code>æ»¡è¶³éœ€æ±‚çš„ z0 åœ¨æœªæ¥ä¼šè¢«æ’å…¥ã€‚</p><p>é‚£ä¹ˆæˆ‘ä»¬éœ€è¦å†™å‡ºå¯¹åº”çš„ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rj(P: Vset(P)) rj(xj) rj(yj) ...</span><br></pre></td></tr></table></figure><p>å¯¹ï¼Œè¿™ä¸‹å¤æ‚äº†å¾ˆå¤šï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ri(dept=sales: x1; y2) rj(xj)</span><br></pre></td></tr></table></figure><h2 id="Dependencies"><a href="#Dependencies" class="headerlink" title="Dependencies"></a>Dependencies</h2><p>è¿™ç¯‡è®ºæ–‡å®šä¹‰äº†ä¸‰ç§ conflictï¼ŒåŒæ—¶åˆ†ä¸ºäº† regular conflict å’Œ predicate-based conflictã€‚å®ƒä»¬æè¿°çš„æ˜¯äº‹åŠ¡ä¹‹é—´çš„ä¾èµ–å…³ç³»ã€‚</p><h3 id="Read-Dependencies"><a href="#Read-Dependencies" class="headerlink" title="Read Dependencies"></a>Read Dependencies</h3><h4 id="predicate-based-conflict"><a href="#predicate-based-conflict" class="headerlink" title="predicate-based conflict"></a>predicate-based conflict</h4><p>å¯¹äºä¸€ä¸ª Predicateï¼Œå¦‚æœæŸä¸ªäº‹åŠ¡åœ¨å®ƒè¯»ä¹‹å‰ï¼Œæ’å…¥äº†æ»¡è¶³ Predicate çš„è®°å½•ï¼Œé‚£ä¹ˆä¼šæœ‰ read dependency</p><h4 id="Directly-Read-Dependency"><a href="#Directly-Read-Dependency" class="headerlink" title="Directly Read Dependency"></a>Directly Read Dependency</h4><p>äº‹åŠ¡ $T_j$  direct read depend $T_i$ æ—¶ï¼Œä¼šæœ‰ä¸‹åˆ—çš„æ¡ä»¶ï¼š</p><ul><li>directly item-read-depents: Tj è¯»åˆ°äº† Ti å†™å…¥çš„è®°å½•</li><li>directly predicate-read-depends: Ti æ›´æ–°äº†æ»¡è¶³åŒ¹é… <code>Vset(P)</code> çš„å¯¹è±¡ï¼Œå¹¶ä¸”è¢« Tj è¯»åˆ°äº†</li></ul><h3 id="Anti-Dependency"><a href="#Anti-Dependency" class="headerlink" title="Anti Dependency"></a>Anti Dependency</h3><p>å½“äº‹åŠ¡è¦†ç›–äº†å¦ä¸€ä¸ªäº‹åŠ¡ç‹¬åˆ°çš„å€¼çš„æ—¶å€™ï¼Œäº§ç”Ÿäº† anti-dependencyã€‚</p><h4 id="predicate-based-conflict-1"><a href="#predicate-based-conflict-1" class="headerlink" title="predicate-based conflict"></a>predicate-based conflict</h4><p>å¯¹äºä¸€ä¸ª Predicateï¼Œå¦‚æœæŸä¸ªäº‹åŠ¡åœ¨å®ƒè¯»ä¹‹åï¼Œæ’å…¥äº†æ»¡è¶³ Predicate çš„è®°å½•ï¼Œé‚£ä¹ˆä¼šæœ‰ anti dependency</p><h4 id="Directly-Anti-Dependency"><a href="#Directly-Anti-Dependency" class="headerlink" title="Directly Anti Dependency"></a>Directly Anti Dependency</h4><p>äº‹åŠ¡ $T_j$  direct anti depend $T_i$ æ—¶ï¼Œä¼šæœ‰ä¸‹åˆ—çš„æ¡ä»¶ï¼š</p><ul><li>directly item-anti-depents: Ti è¦†ç›–äº† Tj è¯»åˆ°çš„è®°å½•</li><li>directly predicate-anti-depends: Ti æ›´æ–°äº†æ»¡è¶³åŒ¹é… <code>Vset(P)</code> çš„å¯¹è±¡ï¼Œä»–ä¹‹å‰å¹¶ä¸”è¢« Tj è¯»åˆ°äº†</li></ul><h3 id="Write-Dependency"><a href="#Write-Dependency" class="headerlink" title="Write Dependency"></a>Write Dependency</h3><p>å¦‚æœäº‹åŠ¡ $T_i$ è¦†ç›–äº† $T_j$ å†™å…¥çš„ç‰ˆæœ¬ï¼Œé‚£ä¹ˆå®ƒä»¬æœ‰ direct-write-dependã€‚</p><h2 id="Serialization-Graph"><a href="#Serialization-Graph" class="headerlink" title="Serialization Graph"></a>Serialization Graph</h2><p><img src="https://image.mwish.me/blog-image/9702A3CB-D18C-4751-AF2E-4B346C879B2F.png" alt="9702A3CB-D18C-4751-AF2E-4B346C879B2F"></p><p>æœ‰ä¸€ç‚¹å…³é”®æ˜¯ï¼Œäº‹åŠ¡æˆ–è®¸ä¸æ˜¯å…¨åºçš„ï¼Œä½†æ˜¯è‡³å°‘åº”è¯¥æ˜¯<strong>ååº</strong>çš„ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬å¯¹äº‹åŠ¡æ„å»º DAGï¼Œä¸åº”è¯¥å­˜åœ¨ç¯ã€‚</p><p>é‚£ä¹ˆï¼Œé€šè¿‡ä¸Šè¿°å‡ ç§ dependencyï¼Œæˆ‘ä»¬å¯ä»¥æ„å»ºä¾èµ–çš„æœ‰å‘å›¾ï¼Œæ¥åˆ¤æ–­å…·ä½“çš„å…³ç³»ã€‚</p><p><img src="https://image.mwish.me/blog-image/53878744-E179-4603-B768-D80DBCFD58EF.png" alt="53878744-E179-4603-B768-D80DBCFD58EF"></p><p>åŒæ—¶å¯ä»¥å®šä¹‰ depends å…³ç³»ï¼š</p><p><img src="https://image.mwish.me/blog-image/33241D20-8EB6-46C6-9AAD-EDAC95237199.png" alt="33241D20-8EB6-46C6-9AAD-EDAC95237199"></p><h2 id="New-Generalized-Isolation-Specifications"><a href="#New-Generalized-Isolation-Specifications" class="headerlink" title="New Generalized Isolation Specifications"></a>New Generalized Isolation Specifications</h2><blockquote><p>Like the previous approaches, we will define each iso- lation level in terms of phenomena that must be avoided at each level. Our phenomena are prefixed by â€œGâ€ to denote the fact that they are general enough to allow locking and op- timistic implementations; these phenomena are named G0, G1, and so on (by analogy with P0, P1, etc of [6]). We will refer to the new levels as PL levels (where PL stands for â€œportable levelâ€) to avoid the possible confusion with the degrees of isolation given in [8, 13].</p></blockquote><p>è¿™é‡Œç”¨ G è¡¨ç¤º phenomenaï¼ŒPL è¡¨ç¤º portable levelsã€‚</p><h3 id="PL-1"><a href="#PL-1" class="headerlink" title="PL-1"></a>PL-1</h3><p>è¿™ä¸ªå¯¹åº”çš„å…¶å®ç›¸å½“äº P0ï¼Œæˆ‘ä»¬æŠ„è‹±æ–‡çœ‹çœ‹åŸå®šä¹‰ï¼š</p><blockquote><p>we define <strong>PL-1</strong> as the level in which G0 is disallowed:</p><p><strong>G0: Write Cycles.</strong> A history H exhibits phenomenon G0 if DSG(H) contains a directed cycle consisting entirely of write-dependency edges.</p></blockquote><p><img src="https://image.mwish.me/blog-image/89DEB4D5-C31F-4430-9C08-B1E314CAF4A6.png" alt="89DEB4D5-C31F-4430-9C08-B1E314CAF4A6"></p><p>å®é™…ä¸Šè¦†ç›–å†™æœªæäº¤çš„æœ¬èº«åœ¨ 2PL æ„å¤–çš„å®ç°ä¸­ä¸ä¸€å®šå‡ºäº†å¤§é—®é¢˜ï¼Œä½†æ˜¯å¦‚æœæœ‰ä¸Šè¿°çš„é‡å¤è¦†ç›–ï¼Œé‚£ä¹ˆå°±ä¼šçœŸæ­£å‡ºç°é—®é¢˜ã€‚å³å¦‚ä¸Šå›¾ã€‚åŒæ—¶è®ºæ–‡ä¹Ÿç»™å‡ºäº† predicate ç›¸å…³çš„ $H_{wcycle}$</p><p><img src="https://image.mwish.me/blog-image/813DDC98-A805-41A7-B406-9D4986272255.png" alt="813DDC98-A805-41A7-B406-9D4986272255"></p><h3 id="PL-2"><a href="#PL-2" class="headerlink" title="PL-2"></a>PL-2</h3><p>PL-1 å¯¹è¯»æ˜¯æ²¡æœ‰é™åˆ¶çš„ï¼Œå½“ç„¶ï¼Œå‡ºç°æˆ‘ä»¬ä¹‹å‰è¯´çš„â€œè„è¯»â€å°±å¤ªæ­£å¸¸äº†ã€‚</p><p>G1 ç”± G1a G1b G1c æ„æˆï¼š</p><p><img src="https://image.mwish.me/blog-image/DF4CBE7C-03E6-4F03-83A2-5DD32CB18F17.png" alt="DF4CBE7C-03E6-4F03-83A2-5DD32CB18F17"></p><p>G1a: è¯»åˆ°äº† abort äº‹åŠ¡çš„æ•°æ®ã€‚</p><p><img src="https://image.mwish.me/blog-image/8F504CF7-0381-4DBB-810E-65126DE2D4A8.png" alt="8F504CF7-0381-4DBB-810E-65126DE2D4A8"></p><p>G1b: è¯»åˆ°äº†äº‹åŠ¡<strong>ä¸­é—´</strong> çš„æ•°æ®</p><p><img src="https://image.mwish.me/blog-image/FC512948-7B2A-4A46-BFA8-BABC63264652.png" alt="FC512948-7B2A-4A46-BFA8-BABC63264652"></p><p>G1c: äº§ç”Ÿäº† direct çš„ç¯ã€‚å³ direct rr, rw, wr çš„ç¯ã€‚</p><blockquote><p>Phenomenon G1 captures the essence of no-dirty-reads and is comprised of G1a, G1b and G1c. We define isolation level <strong>PL-2</strong> as one in which phenomenon G1 is disallowed. Proscribing G1 is clearly weaker than proscribing P1 since G1 allows reads from uncommitted transactions. </p></blockquote><p>å®é™…ä¸Šï¼Œè¿™ä¸ªç›¸å½“äº read committed, ä½†æ˜¯ä¼šå¼±ä¸€äº›ï¼š</p><blockquote><p>Proscribing G1 is clearly weaker than proscribing P1 since G1 allows reads from uncommitted transactions.</p></blockquote><p>P1 ä¸å…è®¸<strong>è„è¯»</strong>ï¼Œé‚£ä¹ˆ PL-2 é ï¼š</p><ol><li>ä¸å…è®¸è¯»åˆ° abort/ä¸­é—´çš„æ•°æ®ï¼Œä½†æ˜¯å…è®¸çŸ­æš‚è¯»åˆ° uncommitted çš„æ•°æ®</li></ol><p>å®é™…ä¸Šï¼Œè¿™ç›¸å½“äºï¼Œ<strong>è¢« committed çš„äº‹åŠ¡</strong> å¯ä»¥è¯»åˆ° <strong>æœªæäº¤ä½†æœªæ¥è¢«æäº¤</strong> çš„æ•°æ®ã€‚</p><p>direct ä¾èµ–çš„ç¯æ¯”è¾ƒéš¾ç†è§£ï¼Œå°±æ˜¯ Figure2 é‚£äº›ã€‚è¿™ä¸ªæˆ‘ç®€å•æ¨å¯¼ä¸€ä¸‹ä¸ºä»€ä¹ˆè¿™ä¸ªèƒ½æ»¡è¶³ å¯¹åº”çš„ read committedï¼š</p><ul><li>$T_i$ äº‹åŠ¡è¯»ä¸€ç»„ x, y, zâ€¦ è¯»åˆ° $x_k$ $y_k$ â€¦</li><li>$T_i$ åœ¨ä¸€ç»„å­é›†ä¸Šå†æ¬¡è¯»ï¼Œè¯»åˆ°äº† $T_j$ å†™å…¥çš„æ•°æ®ï¼Œè¿™ä¸ªæ—¶å€™ï¼Œ$T_i$ depend $T_j$</li><li>$T_j$ å¦‚æœæœ‰ä»»ä½•æƒ…å†µä¸‹ç›´æ¥ä¾èµ–äº† $T_i$ çš„æ•°æ®ï¼Œé‚£ä¹ˆè¿™ä¸ªé¡ºåºå°±è¢« break</li></ul><p>ä½†æ˜¯è¿™ä¸ªæ²¡æœ‰ç¦æ­¢ anti-dependency, å³ P2 P3 å¯¹åº”çš„</p><ul><li>$T_j$ $T_k$ äº‹åŠ¡è¯»ä¸€ç»„ x, y, zâ€¦ è¯»åˆ° $x_k$ $y_k$ â€¦</li><li>$T_j$ ä¿®æ”¹äº† $x_k$ ï¼Œæ”¹ä¸º $x_j$ , commit, è¿™ä¸ªæ—¶å€™ $T_k$ anti depend $T_j$</li><li>$T_k$ è¯»åˆ°äº† $x_k$ , è¿™ä¸ªæ—¶å€™ $T_j$ depent $T_k$</li></ul><p>å¥½äº†ï¼Œbreak äº†ï¼</p><h3 id="PL-3"><a href="#PL-3" class="headerlink" title="PL-3"></a>PL-3</h3><p><img src="https://image.mwish.me/blog-image/60CD6506-2D23-46AC-AAC2-655921CADD0C.png" alt="60CD6506-2D23-46AC-AAC2-655921CADD0C"></p><p>ç¦æ­¢æ‰€æœ‰ anti-dependency ä¹‹åï¼Œæ•´ä¸ªäº‹åŠ¡å°±å˜çš„<strong>æœ‰åºäº†</strong>ã€‚è¿™å¯¹åº” serializableã€‚å…¶å®è¿™ä¸ªç›¸å¯¹æ¥è¯´æ˜¯æœ€å¥½ç†è§£çš„ã€‚</p><h3 id="PL-2-99"><a href="#PL-2-99" class="headerlink" title="PL-2.99"></a>PL-2.99</h3><p>è¿™ä¸ªå¯¹åº”çš„æ˜¯ repeatable read. </p><p><img src="https://image.mwish.me/blog-image/5E61590D-1A6F-4C8D-9E8A-1E542DEE85E7.png" alt="5E61590D-1A6F-4C8D-9E8A-1E542DEE85E7"></p><p>å®ƒå…è®¸ Item Anti-dependency, ç”¨æ¥å¤„ç†å¯é‡å¤è¯»ã€‚</p><h3 id="Snapshot-Isolation-PL-SI"><a href="#Snapshot-Isolation-PL-SI" class="headerlink" title="Snapshot Isolation: PL-SI"></a>Snapshot Isolation: PL-SI</h3><p>æˆ‘ä¸€ä¸‹æ²¡æ‰¾åˆ°è¿™ä¸ªå®šä¹‰ï¼Œæœ‰ç‚¹è’™åœˆï¼Œåæ¥å‘ç°åœ¨åšå£«è®ºæ–‡ 4.3 é‡Œâ€¦</p><p>å¥½å§ï¼Œå‘å•Šï¼è¿™é‡Œå®šä¹‰äº† PL-2+ æ¥å¼•å…¥ PL-SIï¼š</p><h3 id="PL-2-1"><a href="#PL-2-1" class="headerlink" title="PL-2+"></a>PL-2+</h3><p>PL-2+ è¡¨ç¤ºçœ‹åˆ°ä¸€è‡´æ€§è§†å›¾çš„æœ€ä½çº§åˆ«</p><blockquote><p><strong>G-single: Single Anti-dependency Cycles.</strong> A history H exhibits phenomenon G- single if DSG(H) contains a directed cycle with exactly one anti-dependency edge.</p><p>Level <strong>PL-2+</strong> proscribes G1 and G-single. Intuitively, PL-2+ provides consistency because cycles with one anti-dependency edge occur exactly when some transaction both observes and misses modifications of another transaction.</p></blockquote><h3 id="PL-2L"><a href="#PL-2L" class="headerlink" title="PL-2L"></a>PL-2L</h3><p>è¿™ä¸ªçº§åˆ«è¡¨ç¤ºäº†å•è°ƒè¯»ã€‚</p><h3 id="PL-SI"><a href="#PL-SI" class="headerlink" title="PL-SI"></a>PL-SI</h3><p><img src="https://image.mwish.me/blog-image/02E27F7E-B745-41F5-81F0-52A2D284F9D1.png" alt="02E27F7E-B745-41F5-81F0-52A2D284F9D1"></p><p>å…·ä½“å®šä¹‰è¿˜æ˜¯è›®å¤æ‚çš„ï¼Œç®€å•æ¥è¯´æ˜¯ï¼š</p><ol><li>æ¶‰åŠä¸€ä¸ª start çš„æ—¶é—´æˆ³çš„åºï¼Œåœ¨ start å¼€å§‹ä¹‹åçš„ read-write dependency ä¸èƒ½å­˜åœ¨ï¼ˆä½†æ˜¯å¯ä»¥å­˜åœ¨ anti-dependency, å¦‚ä¸‹æ–‡æ‰€è¿°ï¼‰</li><li>å†™å…¥ä¸å‘ç”Ÿå†²çª</li><li>å…è®¸ PL-2+ å®šä¹‰çš„ consistent view, å¯ä»¥æœ‰ä¸”ä»…æœ‰å•ä¸ª anti-dependency è¾¹çš„ cycle å­˜åœ¨ã€‚ï¼ˆ</li></ol><h2 id="ç°å®ä¸­çš„æ•°æ®åº“"><a href="#ç°å®ä¸­çš„æ•°æ®åº“" class="headerlink" title="ç°å®ä¸­çš„æ•°æ®åº“"></a>ç°å®ä¸­çš„æ•°æ®åº“</h2><p><a href="https://github.com/ept/hermitage">https://github.com/ept/hermitage</a></p><p>ä¸Šé¢è¿™ä¸ªé“¾æ¥æ˜¯ç°å®æ•°æ®åº“ä¸­å¯¹åº”çš„éš”ç¦»çº§åˆ«ã€‚</p>]]></content>
      
      
      
        <tags>
            
            <tag> database </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>è½¯/ç¡¬çš„åˆ†ç•Œ: è™šæ‹Ÿ</title>
      <link href="/2020/11/08/%E8%BD%AF-%E7%A1%AC%E7%9A%84%E5%88%86%E7%95%8C-%E8%99%9A%E6%8B%9F/"/>
      <url>/2020/11/08/%E8%BD%AF-%E7%A1%AC%E7%9A%84%E5%88%86%E7%95%8C-%E8%99%9A%E6%8B%9F/</url>
      
        <content type="html"><![CDATA[<p>å¦‚æœä½ å•ƒè¿‡ OSTEP æˆ–è€…ä»€ä¹ˆå›½å†…çš„æ•™æï¼Œé‚£ä¹ˆä½ ä¸€å®šçŸ¥é“ Paging è¿™äº›è™šæ‹Ÿå†…å­˜ç›¸å…³çš„ç­–ç•¥ï¼Œé‚£ä¸‹é¢æˆ‘ä»¬æ•´ç†ä¸€ä¸‹çŸ¥è¯†ç‚¹ï¼š</p><ol><li><strong>æ“ä½œç³»ç»Ÿ</strong> é‡‡ç”¨äº† <strong>è™šæ‹Ÿå†…å­˜</strong> çš„ç­–ç•¥ï¼Œè¿™ä¸ªç­–ç•¥å®é™…ä¸Šå¾ˆç±»ä¼¼ CPU çš„ cache</li><li><strong>CPU</strong> ä½¿ç”¨çš„æ˜¯<strong>è™šæ‹Ÿåœ°å€</strong>ï¼Œç» <strong>é¡µè¡¨</strong> è½¬åŒ–ä¸ºç‰©ç†åœ°å€ã€‚è¿™ç§è™šæ‹Ÿå†…å­˜çš„æ–¹æ¡ˆä¼˜åŠ¿æ˜¯ï¼š<ol><li>æ”¯æŒæ›´å¤§çš„è™šæ‹Ÿåœ°å€ç©ºé—´ï¼Œæˆ‘ä»¬å¯èƒ½åªæœ‰16Gçš„ <strong>ç‰©ç†å†…å­˜</strong>ï¼Œä½†æˆ‘ä»¬æœ‰ä¸€ä¸ª 32ä½/64ä½çš„åœ°å€ç©ºé—´ï¼ŒåŒæ—¶ï¼Œæˆ‘ä»¬ä¹Ÿèƒ½å¤Ÿé€‚å½“çš„å®Œæˆ swap </li><li>æ”¯æŒéš”ç¦»ï¼Œä¿æŠ¤ä¸€ä¸ª <strong>è¿›ç¨‹</strong> å…å—å…¶ä»– <strong>è¿›ç¨‹</strong> çš„å½±å“</li></ol></li><li>è™šæ‹Ÿåœ°å€è¢«åˆ†ä¸ºè™šæ‹Ÿé¡µå·(å¯èƒ½æœ‰æ•°çº§)å’Œé¡µå†…åç§»ï¼Œç» <strong>è½¬åŒ–</strong> ä¹‹åç§°ä¸ºä¸€ä»½</li><li><strong>é¡µè¡¨</strong> å­˜å‚¨åœ¨ <strong>å†…å­˜</strong> ä¸­ï¼Œå¯¹ä¸€ä¸ªåœ°å€ç©ºé—´è€Œè¨€ï¼Œæ¯ä¸€ä¸ªä½ç½®ç»´æŠ¤ä¸€ä¸ª page table entry çš„å†…å­˜å¼€é”€è¿‡é«˜ï¼Œæ‰€ä»¥ä¼šé‡‡å–å¤šçº§é¡µè¡¨çš„å½¢å¼ï¼Œå‡å°‘ <strong>å†…å­˜è®¿é—®</strong> çš„å¼€é”€ã€‚å®é™…ä¸Šï¼Œå¾ˆå¤šæ—¶å€™é¡µè¡¨çš„ç»“æ„ç±»ä¼¼ radix treeã€‚</li><li>å› ä¸º <strong>å†…å­˜</strong> çš„è®¿é—®æœ‰å·¨å¤§çš„ gap, æ‰€ä»¥éœ€è¦ TLB ä½œä¸ºä¸€ç§ cache<ol><li>å¯¹äºå¤šä¸ªè¿›ç¨‹è€Œè¨€ï¼Œæ¯ä¸ª<strong>è¿›ç¨‹</strong>ä¼šæœ‰ä¸€å¥—è‡ªå·±ç‹¬ç«‹çš„åœ°å€ç©ºé—´ï¼Œä¸Šä¸‹æ–‡åˆ‡æ¢çš„æ—¶å€™ï¼ŒTLB éœ€è¦ Flush å¯¹åº”çš„è¡¨é¡¹ï¼Œæˆ–è€…ç»™ entry ä¸€ä¸ª <strong>æ ‡ç¤ºè¿›ç¨‹</strong> çš„å­—æ®µ</li></ol></li><li>å…·ä½“è®¿é—®çš„æ—¶å€™ï¼ŒæŸä¸ª <strong>Page</strong> å¯èƒ½åœ¨<strong>è®¿é—®ä½</strong>è¢«æ ‡è®°ä¸Šè¯»/å†™ flagï¼Œç”šè‡³ä¼šæœ‰ <strong>ä¿æŠ¤é¡µ</strong> çš„å­˜åœ¨</li></ol><p>ç„¶åï¼Œæˆ‘ä»¬è¿˜çŸ¥é“ï¼š</p><ul><li>TLB æ²¡æœ‰å¯¹åº”çš„ Page entryï¼Œä¼šå‘ç”Ÿ TLB å¤±æ•ˆã€‚è¿™ä¸ªæ—¶å€™ï¼ŒPage å¯èƒ½åœ¨<strong>å†…å­˜</strong>ä¸­ï¼Œéœ€è¦è®¿é—®åŠ è½½ï¼Œå¯èƒ½ä¸åœ¨å†…å­˜ä¸­ï¼Œéœ€è¦<strong>æ“ä½œç³»ç»Ÿ</strong> æ¥å¤„ç†ç¼ºé¡µå¼‚å¸¸(page fault).<ul><li>è¿™éœ€è¦é¢å¤–çš„æœºåˆ¶æ¥<strong>ä¸­æ–­</strong>æ­£åœ¨è¿è¡Œä¸­çš„æ´»è·ƒè¿›ç¨‹ï¼Œå°†æ§åˆ¶æƒè½¬ç§»åˆ° <strong>æ“ä½œç³»ç»Ÿ</strong>ï¼Œç„¶åå†æ¢å¤è¿‡æ¥ã€‚</li></ul></li></ul><p>å¥½å§ï¼Œæˆ‘æœ€æ—©è€ƒ OS çš„æ—¶å€™è§‰å¾—ä¸Šé¢çš„è§‚ç‚¹éƒ½æ˜¯å¾ˆè‡ªç„¶çš„ï¼Œä½†æ˜¯ä½ ä¼šå‘ç°æœ‰é—®é¢˜å°±æ˜¯ï¼š</p><ul><li>å“ªäº›éƒ¨åˆ†æ˜¯è½¯ä»¶(OS)åšçš„ï¼Œå“ªäº›éƒ¨åˆ†æ˜¯ç¡¬ä»¶åšçš„ï¼Ÿ</li><li>è™šæ‹Ÿåœ°å€æ˜¯å¯¹è°è€Œè¨€çš„ï¼Ÿ</li><li>è¿›ç¨‹åˆ‡æ¢ Flush TLB è¿™äº›æ˜¯è°åšçš„ï¼Ÿ</li></ul><p>è¿™ä¸ªæ—¶å€™ä½ ä¼šæ„Ÿè§‰çªç„¶ä¸æ­£å¸¸äº†èµ·æ¥ï¼Œæˆ‘ä»¬éœ€è¦çŸ¥é“çš„æ˜¯ï¼š</p><ol><li>OS æ”¯æŒäº†ä»€ä¹ˆ</li><li>ISA æ”¯æŒäº†ä»€ä¹ˆï¼Œç¡¬ä»¶è¦åšä»€ä¹ˆ</li></ol><p>ç„¶åï¼ŒOS ä»¥ xv6 çš„ RISC-V ç‰ˆæœ¬ä¸ºä¾‹ï¼ŒISA ä»¥ RISC-V ä¸ºä¾‹ï¼Œå»çœ‹çœ‹é—®é¢˜åˆ°åº•æ˜¯ä»€ä¹ˆæ ·å­çš„ã€‚</p><p>æœ€åï¼Œåœ¨å…·ä½“è®¨è®ºä¹‹å‰ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼š<strong>æ“ä½œç³»ç»Ÿ å’Œ ISA çš„åˆ†ç•Œå¹¶ä¸æ˜¯å¹³å¦çš„ï¼Œå¾ˆå¤šä¸œè¥¿å³å¯ä»¥è½¯ä»¶åšï¼Œåˆå¯ä»¥ç¡¬ä»¶åšï¼ˆä½†æ˜¯å¾ˆå¤šæ—¶å€™åœ¨ ISA ä¸Šæä¾›åˆ‡å£å¤§æ¦‚ä¼šæ–¹ä¾¿å¾ˆå¤šï¼‰</strong>ã€‚</p><h2 id="Review"><a href="#Review" class="headerlink" title="Review"></a>Review</h2><p>æˆ‘ä»¬åœ¨è¿™ä¸ª Part å…¶å®å¾ˆæ—©å°±èŠè¿‡ OS åº”è¯¥åšä»€ä¹ˆï¼š <a href="https://zhuanlan.zhihu.com/p/150571417">https://zhuanlan.zhihu.com/p/150571417</a></p><ul><li><p>memory translation</p></li><li><ul><li>æ¯ä¸ªè¿è¡Œçš„è¿›ç¨‹éœ€è¦ä» virtual çš„è¿›ç¨‹è½¬æˆç‰©ç†å†…å­˜</li><li>program å®é™…å¤„ç†çš„æ˜¯è™šæ‹Ÿå†…å­˜ï¼Œéœ€è¦ç¡¬ä»¶æ”¯æŒ</li></ul></li><li><p>protection and privilege</p></li><li><ul><li>éœ€è¦æä¾› user å’Œ supervisor çš„æ¨¡å¼ï¼Œåœ¨ RISC-V ä¸­æœ‰ machine å’Œ supervisor æ¨¡å¼</li></ul></li><li><p>æ›´ä½çš„å±‚æ¬¡ä¸èƒ½ä¿®æ”¹ memory mapping</p></li><li><ul><li>supervisor å¯ä»¥</li><li>supervisor æœ‰ç‹¬ç«‹äºç”¨æˆ·ç¨‹åºçš„ virtual åˆ° physical æ˜ å°„</li></ul></li><li><p>æä¾› traps å’Œ interruptï¼Œåœ¨å‘½ä»¤å±‚é¢æä¾›äº†åˆ° supervisor çš„æ–¹æ³•</p></li></ul><p>ä¹Ÿå°±æ˜¯è¯´ï¼š</p><h4 id="1-åœ°å€"><a href="#1-åœ°å€" class="headerlink" title="1: åœ°å€"></a>1: åœ°å€</h4><p>æŒ‡ä»¤ä¸­ç»™çš„æœ‰å¯èƒ½æ˜¯ <strong>è™šæ‹Ÿåœ°å€</strong>ï¼Œä¹Ÿæœ‰å¯èƒ½æ˜¯<strong>ç‰©ç†åœ°å€</strong>ï¼Œéœ€è¦ ISA/ç¡¬ä»¶ è¿›è¡Œé¢å¤–çš„æ”¯æŒã€‚å®é™…ä¸Šï¼Œæ­£å¸¸çš„ç”¨æˆ·æ€ç¨‹åºè¿è¡Œçš„æ—¶å€™ï¼Œæˆ‘ä»¬ä½¿ç”¨çš„åœ°å€ã€æ±‡ç¼–ä¸­çš„åœ°å€éƒ½æ˜¯ <strong>è™šæ‹Ÿåœ°å€</strong></p><p><img src="https://image.mwish.me/blog-image/966DE38A-A499-4BDC-8BDF-46F344EFC8CC.png" alt="966DE38A-A499-4BDC-8BDF-46F344EFC8CC"></p><p>Supervisor æ¨¡å¼æä¾›äº†ä¸€ç§ç®€å•åŸºäºé¡µé¢çš„è™šæ‹Ÿå†…å­˜ï¼Œè¿™ç§æ–¹å¼å¦‚ä¸‹æ‰€ç¤ºï¼š</p><p><img src="https://image.mwish.me/blog-image/43A18D7F-8D2B-4D62-8AA4-7BD8571D10CB.png" alt="43A18D7F-8D2B-4D62-8AA4-7BD8571D10CB"></p><ol><li>ç¡¬ä»¶/ISA å¯ä»¥åˆ†æ¸…æ¥šé¡µè¡¨é¡¹ï¼Œå¹¶ä¸”äº¤ç»™ç¡¬ä»¶è¿›è¡Œè®¿é—®</li><li>è½¯ä»¶(OS)ä¹Ÿå¯ä»¥è¿›è¡Œå¯¹åº”çš„è®¾ç½®ï¼Œåœ¨å†…å­˜ä¸­æ“ä½œï¼Œå¤„ç†ç¼ºé¡µçš„å¼‚å¸¸ã€‚</li></ol><p>è€Œæ˜¯å¦ enable è™šæ‹Ÿå†…å­˜è¿™ç§æœºåˆ¶ï¼Œå–å†³äº <code>satp</code> å¯„å­˜å™¨ï¼š</p><blockquote><p>ä¸€ä¸ªå« satp(Supervisor Address Translation and Protectionï¼Œç›‘ç®¡è€…åœ°å€è½¬æ¢å’Œä¿æŠ¤) çš„ S æ¨¡å¼æ§åˆ¶çŠ¶æ€å¯„å­˜å™¨æ§åˆ¶äº†åˆ†é¡µç³»ç»Ÿã€‚å¦‚å›¾ 10.12 æ‰€ç¤ºï¼Œsatp æœ‰ä¸‰ä¸ªåŸŸã€‚MODE åŸŸå¯ ä»¥å¼€å¯åˆ†é¡µå¹¶é€‰æ‹©é¡µè¡¨çº§æ•°ï¼Œå›¾ 10.13 å±•ç¤ºäº†å®ƒçš„ç¼–ç ã€‚ASID(Address Space Identifierï¼Œ åœ°å€ç©ºé—´æ ‡è¯†ç¬¦)åŸŸæ˜¯å¯é€‰çš„ï¼Œå®ƒå¯ä»¥ç”¨æ¥é™ä½ä¸Šä¸‹æ–‡åˆ‡æ¢çš„å¼€é”€ã€‚æœ€åï¼ŒPPN å­—æ®µä¿å­˜ äº†æ ¹é¡µè¡¨çš„ç‰©ç†åœ°å€ï¼Œå®ƒä»¥ 4 KiB çš„é¡µé¢å¤§å°ä¸ºå•ä½ã€‚é€šå¸¸ M æ¨¡å¼çš„ç¨‹åºåœ¨ç¬¬ä¸€æ¬¡è¿›å…¥ S æ¨¡å¼ä¹‹å‰ä¼šæŠŠé›¶å†™å…¥ satp ä»¥ç¦ç”¨åˆ†é¡µï¼Œç„¶å S æ¨¡å¼çš„ç¨‹åºåœ¨åˆå§‹åŒ–é¡µè¡¨ä»¥åä¼šå†æ¬¡è¿›è¡Œ satp å¯„å­˜å™¨çš„å†™æ“ä½œã€‚</p></blockquote><p><img src="https://image.mwish.me/blog-image/D31816F2-EF17-4CFF-85B5-AD88A1CA02BB.png" alt="D31816F2-EF17-4CFF-85B5-AD88A1CA02BB"></p><p>è€Œ <code>satp</code> å¯„å­˜å™¨ï¼š</p><blockquote><p>å½“åœ¨ satp å¯„å­˜å™¨ä¸­å¯ç”¨äº†åˆ†é¡µæ—¶ï¼ŒS æ¨¡å¼å’Œ U æ¨¡å¼ä¸­çš„è™šæ‹Ÿåœ°å€ä¼šä»¥ä»æ ¹éƒ¨éå†é¡µè¡¨ çš„æ–¹å¼è½¬æ¢ä¸ºç‰©ç†åœ°å€ã€‚å›¾ 10.14 æè¿°äº†è¿™ä¸ªè¿‡ç¨‹:</p><ol><li>satp.PPN ç»™å‡ºäº†ä¸€çº§é¡µè¡¨çš„åŸºå€ï¼ŒVA[31:22]ç»™å‡ºäº†ä¸€çº§é¡µå·ï¼Œå› æ­¤<strong>å¤„ç†å™¨</strong>ä¼šè¯»å– ä½äºåœ°å€(satp. PPN Ã— 4096 + VA[31: 22] Ã— 4)çš„é¡µè¡¨é¡¹ã€‚</li><li>è¯¥ PTE åŒ…å«äºŒçº§é¡µè¡¨çš„åŸºå€ï¼ŒVA[21:12]ç»™å‡ºäº†äºŒçº§é¡µå·ï¼Œå› æ­¤<strong>å¤„ç†å™¨</strong>è¯»å–ä½äºåœ° å€(PTE. PPN Ã— 4096 + VA[21: 12] Ã— 4)çš„å¶èŠ‚ç‚¹é¡µè¡¨é¡¹ã€‚</li><li>å¶èŠ‚ç‚¹é¡µè¡¨é¡¹çš„ PPN å­—æ®µå’Œé¡µå†…åç§»(åŸå§‹è™šå€çš„æœ€ä½ 12 ä¸ªæœ‰æ•ˆä½)ç»„æˆäº†æœ€ç»ˆç»“æœ: ç‰©ç†åœ°å€å°±æ˜¯(LeafPTE. PPN Ã— 4096 + VA[11: 0])</li></ol></blockquote><p>æ­¤å¤–ï¼Œå…³äºä¹‹å‰çš„ TLB çš„é—®é¢˜ï¼ŒæŒ‡ä»¤æä¾›äº†å¯¹åº”çš„æ”¯æŒï¼š</p><blockquote><p>è¿™æ„å‘³ç€å¦‚æœæ“ ä½œç³»ç»Ÿä¿®æ”¹äº†é¡µè¡¨ï¼Œé‚£ä¹ˆè¿™ä¸ªç¼“å­˜ä¼šå˜å¾—é™ˆæ—§è€Œä¸å¯ç”¨ã€‚S æ¨¡å¼æ·»åŠ äº†å¦ä¸€æ¡æŒ‡ä»¤æ¥è§£å†³ è¿™ä¸ªé—®é¢˜ã€‚è¿™æ¡ sfence.vma ä¼šé€šçŸ¥å¤„ç†å™¨ï¼Œè½¯ä»¶å¯èƒ½å·²ç»ä¿®æ”¹äº†é¡µè¡¨ï¼Œäºæ˜¯å¤„ç†å™¨å¯ä»¥ ç›¸åº”åœ°åˆ·æ–°è½¬æ¢ç¼“å­˜ã€‚å®ƒéœ€è¦ä¸¤ä¸ªå¯é€‰çš„å‚æ•°ï¼Œè¿™æ ·å¯ä»¥ç¼©å°ç¼“å­˜åˆ·æ–°çš„èŒƒå›´ã€‚ä¸€ä¸ªä½äº rs1ï¼Œå®ƒæŒ‡ç¤ºäº†é¡µè¡¨å“ªä¸ªè™šå€å¯¹åº”çš„è½¬æ¢è¢«ä¿®æ”¹äº†;å¦ä¸€ä¸ªä½äº rs2ï¼Œå®ƒç»™å‡ºäº†è¢«ä¿®æ”¹é¡µè¡¨ çš„è¿›ç¨‹çš„åœ°å€ç©ºé—´æ ‡è¯†ç¬¦(ASID)ã€‚å¦‚æœä¸¤è€…éƒ½æ˜¯ x0ï¼Œä¾¿ä¼šåˆ·æ–°æ•´ä¸ªè½¬æ¢ç¼“å­˜ã€‚</p></blockquote><p>å’Œä¸‹é¢è¿™æ®µ</p><blockquote><p>sfence.vma ä»…å½±å“æ‰§è¡Œå½“å‰æŒ‡ä»¤çš„ hart çš„åœ°å€è½¬æ¢ç¡¬ä»¶ã€‚å½“ hart æ›´æ”¹äº†å¦ä¸€ä¸ª hart æ­£åœ¨ä½¿ ç”¨çš„é¡µè¡¨æ—¶ï¼Œå‰ä¸€ä¸ª hart å¿…é¡»ç”¨å¤„ç†å™¨é—´ä¸­æ–­æ¥é€šçŸ¥åä¸€ä¸ª hartï¼Œä»–åº”è¯¥æ‰§è¡Œ sfence.vma æŒ‡ä»¤ã€‚è¿™ä¸ªè¿‡ç¨‹é€šå¸¸è¢«ç§°ä¸º <em>TLB</em> å‡»è½ã€‚</p></blockquote><p>æˆ‘ä»¬å¯ä»¥åœ¨ xv6 çœ‹åˆ°ç›¸å…³çš„ä»£ç :</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line">.globl trampoline</span><br><span class="line">trampoline:</span><br><span class="line">.align 4</span><br><span class="line">.globl uservec</span><br><span class="line">uservec:    </span><br><span class="line">#</span><br><span class="line">        # trap.c sets stvec to point here, so</span><br><span class="line">        # traps from user space start here,</span><br><span class="line">        # in supervisor mode, but with a</span><br><span class="line">        # user page table.</span><br><span class="line">        #</span><br><span class="line">        # sscratch points to where the process&#x27;s p-&gt;tf is</span><br><span class="line">        # mapped into user space, at TRAPFRAME.</span><br><span class="line">        #</span><br><span class="line">        </span><br><span class="line"># swap a0 and sscratch</span><br><span class="line">        # so that a0 is TRAPFRAME</span><br><span class="line">        csrrw a0, sscratch, a0</span><br><span class="line"></span><br><span class="line">        # save the user registers in TRAPFRAME</span><br><span class="line">        sd ra, 40(a0)</span><br><span class="line">        sd sp, 48(a0)</span><br><span class="line">        sd gp, 56(a0)</span><br><span class="line">        sd tp, 64(a0)</span><br><span class="line">        sd t0, 72(a0)</span><br><span class="line">        sd t1, 80(a0)</span><br><span class="line">        sd t2, 88(a0)</span><br><span class="line">        sd s0, 96(a0)</span><br><span class="line">        sd s1, 104(a0)</span><br><span class="line">        sd a1, 120(a0)</span><br><span class="line">        sd a2, 128(a0)</span><br><span class="line">        sd a3, 136(a0)</span><br><span class="line">        sd a4, 144(a0)</span><br><span class="line">        sd a5, 152(a0)</span><br><span class="line">        sd a6, 160(a0)</span><br><span class="line">        sd a7, 168(a0)</span><br><span class="line">        sd s2, 176(a0)</span><br><span class="line">        sd s3, 184(a0)</span><br><span class="line">        sd s4, 192(a0)</span><br><span class="line">        sd s5, 200(a0)</span><br><span class="line">        sd s6, 208(a0)</span><br><span class="line">        sd s7, 216(a0)</span><br><span class="line">        sd s8, 224(a0)</span><br><span class="line">        sd s9, 232(a0)</span><br><span class="line">        sd s10, 240(a0)</span><br><span class="line">        sd s11, 248(a0)</span><br><span class="line">        sd t3, 256(a0)</span><br><span class="line">        sd t4, 264(a0)</span><br><span class="line">        sd t5, 272(a0)</span><br><span class="line">        sd t6, 280(a0)</span><br><span class="line"></span><br><span class="line"># save the user a0 in p-&gt;tf-&gt;a0</span><br><span class="line">        csrr t0, sscratch</span><br><span class="line">        sd t0, 112(a0)</span><br><span class="line"></span><br><span class="line">        # restore kernel stack pointer from p-&gt;tf-&gt;kernel_sp</span><br><span class="line">        ld sp, 8(a0)</span><br><span class="line"></span><br><span class="line">        # make tp hold the current hartid, from p-&gt;tf-&gt;kernel_hartid</span><br><span class="line">        ld tp, 32(a0)</span><br><span class="line"></span><br><span class="line">        # load the address of usertrap(), p-&gt;tf-&gt;kernel_trap</span><br><span class="line">        ld t0, 16(a0)</span><br><span class="line"></span><br><span class="line">        # restore kernel page table from p-&gt;tf-&gt;kernel_satp</span><br><span class="line">        ld t1, 0(a0)</span><br><span class="line">        csrw satp, t1</span><br><span class="line">        sfence.vma zero, zero</span><br><span class="line"></span><br><span class="line">        # a0 is no longer valid, since the kernel page</span><br><span class="line">        # table does not specially map p-&gt;tf.</span><br><span class="line"></span><br><span class="line">        # jump to usertrap(), which does not return</span><br><span class="line">        jr t0</span><br><span class="line"># ä¸­é—´è¢«æˆ‘çœç•¥äº†</span><br><span class="line">.globl userret</span><br><span class="line">userret:</span><br><span class="line">        # userret(TRAPFRAME, pagetable)</span><br><span class="line">        # switch from kernel to user.</span><br><span class="line">        # usertrapret() calls here.</span><br><span class="line">        # a0: TRAPFRAME, in user page table.</span><br><span class="line">        # a1: user page table, for satp.</span><br><span class="line"></span><br><span class="line">        # switch to the user page table.</span><br><span class="line">        csrw satp, a1</span><br><span class="line">        sfence.vma zero, zero</span><br><span class="line"></span><br><span class="line">.globl userret</span><br><span class="line">userret:</span><br><span class="line">        # userret(TRAPFRAME, pagetable)</span><br><span class="line">        # switch from kernel to user.</span><br><span class="line">        # usertrapret() calls here.</span><br><span class="line">        # a0: TRAPFRAME, in user page table.</span><br><span class="line">        # a1: user page table, for satp.</span><br><span class="line"></span><br><span class="line">        # switch to the user page table.</span><br><span class="line">        csrw satp, a1</span><br><span class="line">        sfence.vma zero, zero</span><br><span class="line"></span><br><span class="line">        # put the saved user a0 in sscratch, so we</span><br><span class="line">        # can swap it with our a0 (TRAPFRAME) in the last step.</span><br><span class="line">        ld t0, 112(a0)</span><br><span class="line">        csrw sscratch, t0</span><br></pre></td></tr></table></figure><p>å¥½å§ï¼Œæˆ‘æ‰¿è®¤ reader æ‰‹å†Œè¯´çš„ä¸æ˜¯å¾ˆæ˜ç™½ï¼Œæˆ‘åœ¨ trap å’Œ ret ä¸­é—´éƒ½çœç•¥äº†ä¸€äº›ä»£ç ï¼Œå…³äºè¿™ä¸ª sfence.vma ä½¿ç”¨ï¼Œå¯ä»¥å‚è€ƒï¼š<a href="https://utk.instructure.com/courses/66647/files/3182543/download?verifier=JLzdkcM2uy4hNshzq9Tus0Kll1vJys8bsoFbgcl0&amp;wrap=1">https://utk.instructure.com/courses/66647/files/3182543/download?verifier=JLzdkcM2uy4hNshzq9Tus0Kll1vJys8bsoFbgcl0&amp;wrap=1</a></p><p><img src="https://image.mwish.me/blog-image/38E18604-E8F2-428B-8D5F-FDFEB55163B2.png" alt="38E18604-E8F2-428B-8D5F-FDFEB55163B2"></p><p>æ‰€ä»¥è¿™é‡Œç›¸å½“äºåˆ‡æ¢äº† <code>satp</code> ä»å†…æ ¸åˆ°ç”¨æˆ·æ€/ä»å†…å†…æ ¸æ€åˆ°ç”¨æˆ·æ€ä¹‹åï¼Œfence æ•´ä¸ªåœ°å€ç©ºé—´ã€‚</p><h4 id="2-ç‰¹æƒ"><a href="#2-ç‰¹æƒ" class="headerlink" title="2: ç‰¹æƒ"></a>2: ç‰¹æƒ</h4><p>RISC-V æä¾›äº†ä¸¤ç§é¢å¤–çš„æ¨¡å¼ï¼š</p><blockquote><p> è¿è¡Œæœ€ å¯ä¿¡çš„ä»£ç çš„æœºå™¨æ¨¡å¼(machine mode)ï¼Œä»¥åŠä¸º Linuxï¼ŒFreeBSD å’Œ Windows ç­‰æ“ä½œç³»ç»Ÿ æä¾›æ”¯æŒçš„ç›‘ç®¡è€…æ¨¡å¼(supervisor mode)</p></blockquote><p><img src="https://image.mwish.me/blog-image/41D68117-8467-417E-AD42-78503FA7754C.png" alt="41D68117-8467-417E-AD42-78503FA7754C"></p><p>ç¡¬ä»¶å¯¹æŒ‡ä»¤æœ‰çº¦æŸï¼Œä¸èƒ½åœ¨ User æ¨¡å¼ä¸‹æ‰§è¡Œç‰¹æƒæŒ‡ä»¤ã€‚è¿™æä¾›äº†æŸç§æƒ…å†µçš„ä¿æŠ¤ï¼Œè€Œæ“ä½œç³»ç»Ÿåˆæœ‰è¿™ç§ä¿æŠ¤çš„æƒé™ï¼Œè€Œå…³äº <code>m</code> å’Œ <code>s</code> æ¨¡å¼ï¼Œå°±ç®€è¦è´´ä¸€ä¸‹ï¼š</p><blockquote><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œå‘ç”Ÿæ‰€æœ‰å¼‚å¸¸(ä¸è®ºåœ¨ä»€ä¹ˆæƒé™æ¨¡å¼ä¸‹)çš„æ—¶å€™ï¼Œæ§åˆ¶æƒéƒ½ä¼šè¢«ç§»äº¤åˆ° M æ¨¡å¼çš„å¼‚å¸¸å¤„ç†ç¨‹åºã€‚ä½†æ˜¯ Unix ç³»ç»Ÿä¸­çš„å¤§å¤šæ•°ä¾‹å¤–éƒ½åº”è¯¥è¿›è¡Œ S æ¨¡å¼ä¸‹çš„ç³»ç»Ÿè°ƒ ç”¨ã€‚M æ¨¡å¼çš„å¼‚å¸¸å¤„ç†ç¨‹åºå¯ä»¥å°†å¼‚å¸¸é‡æ–°å¯¼å‘ S æ¨¡å¼ï¼Œä½†è¿™äº›é¢å¤–çš„æ“ä½œä¼šå‡æ…¢å¤§å¤šæ•° å¼‚å¸¸çš„å¤„ç†é€Ÿåº¦ã€‚å› æ­¤ï¼ŒRISC-V æä¾›äº†ä¸€ç§å¼‚å¸¸å§”æ‰˜æœºåˆ¶ã€‚é€šè¿‡è¯¥æœºåˆ¶å¯ä»¥é€‰æ‹©æ€§åœ°å°†ä¸­ æ–­å’ŒåŒæ­¥å¼‚å¸¸äº¤ç»™ S æ¨¡å¼å¤„ç†ï¼Œè€Œå®Œå…¨ç»•è¿‡ M æ¨¡å¼ã€‚</p><p>mideleg(Machine Interrupt Delegationï¼Œæœºå™¨ä¸­æ–­å§”æ‰˜)CSR æ§åˆ¶å°†å“ªäº›ä¸­æ–­å§”æ‰˜ç»™ S æ¨¡å¼ã€‚</p></blockquote><p>æ‰€ä»¥å®é™…ä¸Šï¼Œè¿™ç§æ¨¡å¼æ˜¯ç”±ç¡¬ä»¶æ¥ä¿è¯çš„ã€‚</p><p>RISC-V æä¾›äº†ä¸€ç»„ CSR å¯„å­˜å™¨ï¼Œå¦‚  <a href="https://zhuanlan.zhihu.com/p/150571417">https://zhuanlan.zhihu.com/p/150571417</a> æ‰€ç¤ºï¼Œå¸®åŠ©æ ‡ç¤ºå’Œå®Œæˆå¼‚å¸¸ã€æ¢å¤ä¸Šä¸‹æ–‡ã€‚</p><p>å®é™…ä¸Šï¼Œè§¦å‘ trap çš„æ—¶å€™ï¼Œç¡¬ä»¶éœ€è¦æŠŠç°åœ¨è¿è¡Œçš„æŒ‡ä»¤è®°å½•åˆ° <code>mepc</code>, ç„¶å stop æ•´ä¸ªæµæ°´çº¿ï¼Œå®Œæˆä¹‹å‰æ‰€è¯´çš„å¼‚å¸¸å¤„ç†ã€‚</p><p>å®é™…ä¸Šï¼Œå›åˆ°ä¹‹å‰é¡µè¡¨ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œxv6 ä¸­ï¼š</p><ol><li>ç¿»è¯‘æ˜¯ç”±ç¡¬ä»¶å¤„ç†çš„</li><li>å‡ºç°ç¼ºé¡µå¼‚å¸¸ï¼Œç”±æ“ä½œç³»ç»Ÿè¿™æ ·çš„è½¯ä»¶æ¥å¤„ç†ã€‚</li></ol><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>æœ‰ä¸€å¼ ç»ä¸–å¥½å›¾ï¼š</p><p><img src="https://image.mwish.me/blog-image/7D933BA9-C8E0-4893-ABDD-37527C82C8B9.png" alt="7D933BA9-C8E0-4893-ABDD-37527C82C8B9"></p>]]></content>
      
      
      
        <tags>
            
            <tag> system </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Cache and Related Part3: Coherent</title>
      <link href="/2020/11/01/Cache-and-Related-Part3-Coherent/"/>
      <url>/2020/11/01/Cache-and-Related-Part3-Coherent/</url>
      
        <content type="html"><![CDATA[<p>ï¼ˆå›¾æ¥è‡ª CMU 15-418 Spring 2020 å’Œ UCB CS152ï¼‰</p><p>å½“æˆ‘ä»¬æ¶‰åŠå¤šæ ¸çš„æ—¶å€™ï¼Œæˆ‘ä»¬çš„å¤šä¸ªæ ¸å¯èƒ½ä¼šå…±äº«ä¸€ä»½å†…å­˜ï¼š</p><p><img src="https://image.mwish.me/blog-image/8A003FAC-7726-4EFA-8F98-721EAE514AC4.png" alt="8A003FAC-7726-4EFA-8F98-721EAE514AC4"></p><p>å•ä¸ªå˜é‡çš„è®¿é—®å¯èƒ½ä¼šæœ‰é—®é¢˜ï¼š</p><p><img src="https://image.mwish.me/blog-image/BB44A00B-A60B-4CB8-B063-728410EB5DE4.png" alt="BB44A00B-A60B-4CB8-B063-728410EB5DE4"></p><p>æˆ‘ä»¬è®¿é—® memory, å¯èƒ½<strong>åœ¨ç›´è§‰ä¸Š</strong>ä¼šæ˜¯ï¼š</p><blockquote><p> è¯»åˆ°æœ€è¿‘ä¸€çº§åˆ«å­˜å‚¨ x çš„ä¸Šä¸€ä¸ªå†™å…¥çš„å€¼</p></blockquote><p>ä½†æ˜¯ï¼Œmemory ä¼šé‡åˆ°çš„é—®é¢˜æ˜¯</p><ol><li>æœ‰ global çš„ storage å’Œ local cacheï¼Œè€Œä¸”è¿™ä¸¤ä¸ªå¯èƒ½æ˜¯ä¸ä¸€è‡´çš„<ol><li>æ‰€ä»¥æˆ‘ä»¬æœ‰ write back å’Œ write through çš„ç­–ç•¥ï¼Œæ¥ trade æ€§èƒ½å’Œ consitent</li></ol></li><li>æœ‰å¤šä¸ª local cache çš„è¯ï¼Œå¯èƒ½ä¹Ÿä¼šå¯¼è‡´è¿™ç§è§†å›¾ä¸Šçš„ä¸ä¸€è‡´</li></ol><p>ä½†æ˜¯è¯´åˆ°åº•ï¼Œâ€œè¯»åˆ°ä¸Šä¸€ä¸ªå†™å…¥çš„å€¼â€ï¼Œæˆ–è€…ï¼Œâ€œå†™å…¥æ—¶é—´æœ€è¿‘çš„å€¼â€ï¼Œç©¶ç«Ÿæ˜¯ä»€ä¹ˆè¯­ä¹‰å‘¢ï¼š</p><p><img src="https://image.mwish.me/blog-image/018B5523-101F-4E00-AF0D-B3C0EE915E7F.png" alt="018B5523-101F-4E00-AF0D-B3C0EE915E7F"></p><p>äº‹å®ä¸Šï¼Œæˆ‘ä»¬ä¹‹å‰ä»‹ç»è¿‡ CPU Cache, ç°åœ¨ç»™å‡ºä¸€ä¸ª L1 L2 L3 çš„è§†å›¾</p><p><img src="https://image.mwish.me/blog-image/15293AC1-A830-4AB5-96BE-0ACEE96B962D.png" alt="15293AC1-A830-4AB5-96BE-0ACEE96B962D"></p><p>æ˜¾ç„¶ï¼Œç°åœ¨æˆ‘ä»¬å¯¹åŒä¸€ä¸ªå˜é‡çš„è®¿é—®ï¼Œå¦‚ä¸Šä¸Šå¼ å›¾æ‰€ç¤ºï¼Œæˆ‘å„ä¸ªå¤„ç†å™¨æœ¬èº«æ˜¯é¡ºåºå¤„ç†çš„ï¼Œè€Œå®ƒä»¬åœ¨ä¸€èµ·ï¼Œä¼šå¾—åˆ°ä¸€ä¸ªè¯¡å¼‚çš„ååºï¼Œè€Œ P1 P2 P3 çš„ x å€¼å’Œå†…å­˜ä¸­çš„ x å€¼æ˜¯ inconsistent çš„ã€‚è¿™æ˜¯é—®é¢˜æ‰€åœ¨ï¼šæˆ‘ä»¬æ— æ³•å®šä¹‰â€œä¸Šä¸€ä¸ªâ€é€»è¾‘æ„ä¹‰ä¸Šæ˜¯ä»€ä¹ˆã€‚</p><p>è¦åœ¨ä¿è¯æ€§èƒ½çš„åŒæ—¶ï¼Œä¹Ÿä½œå‡ºå„ä¸ªå¤„ç†å™¨å¯¹ x çš„å€¼è¯»å†™çš„ååºä¿è¯ï¼Œæˆ‘ä»¬éœ€è¦ coherence</p><h3 id="Single-CPU-System-I-O"><a href="#Single-CPU-System-I-O" class="headerlink" title="Single CPU System: I/O"></a>Single CPU System: I/O</h3><p><img src="https://image.mwish.me/blog-image/BF8647F2-AC2B-4ADD-BC99-353EEF618C16.png" alt="BF8647F2-AC2B-4ADD-BC99-353EEF618C16"></p><p>å•æ ¸ CPU IO çš„æ—¶å€™ï¼Œå‡è®¾è¦è¯»/å†™æ•°æ®ï¼Œå¯èƒ½ä¼šï¼š</p><ol><li>processor å†™åˆ°äº† write-buffer é‡Œï¼Œè€Œç½‘å¡å¯èƒ½æ²¡æœ‰è¯»åˆ° buffer ä¸­çš„æ•°æ®ï¼Œè€Œæ˜¯è¯»åˆ°äº† memory ä¸­çš„ stale dataï¼Œé€ æˆå†™ stale data</li><li>ç½‘ç»œä¸­æ•°æ®å†™åˆ°äº† memory ä¸­ï¼Œé€šçŸ¥ processor, processor <code>lw</code> è¯»åˆ°äº† cacheï¼Œé€ æˆè¯» stale data</li></ol><p>æŸç§æ„ä¹‰ä¸Šè¯´ï¼Œè¿™ä¹Ÿæ˜¯ä¸€ç§ä¸ä¸€è‡´å¯¼è‡´çš„ï¼Œä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œéœ€è¦ä¸‹åˆ—çš„æ”¯æŒ</p><ol><li>CPU å†™çš„æ—¶å€™å¯ä»¥å†™åˆ°å’Œè®¾å¤‡çš„ shared buffer ä¸­ï¼Œè€Œä¸æ˜¯æœ¬èº«çš„ write bufferã€‚è®©è®¾å¤‡èƒ½å¤Ÿè¯»åˆ°æ­£ç¡®ä¿¡æ¯</li><li>OS å¯ä»¥æŠŠè¯»å†™çš„ page è®¾ç½®æˆä¸å¯ cache çš„ï¼ŒåŒæ—¶ï¼ŒIO å®Œæˆçš„æ—¶å€™ flush cache page</li><li>åœ¨ç”Ÿäº§ä¸­ï¼ŒDMA transfer çš„é¢‘ç‡è¿œæ¯” <code>lw</code> <code>sw</code> å°‘ï¼Œæ‰€ä»¥å¯ä»¥æ¥å—ä»£ä»·è¾ƒé«˜ã€‚</li></ol><h3 id="Coherence"><a href="#Coherence" class="headerlink" title="Coherence"></a>Coherence</h3><p>ç»ˆäºåˆ°äº† conherence äº†ï¼Œé‚£ä¹ˆæˆ‘ä»¬æ¥è®²è®²ï¼Œmemory coherenceï¼Œæˆ‘å¿…é¡»è¦è¯´ï¼Œä¸‹é¢è¿™å¼ å›¾ç†çš„ç»å¯¹å¾ˆæ¸…æ™°äº†ï¼š</p><p><img src="https://image.mwish.me/blog-image/A850F71C-E08B-4D09-A735-5E01922E811D.png" alt="A850F71C-E08B-4D09-A735-5E01922E811D"></p><p>. </p><ol><li>å•ä¸ª Processor å¯¹å•ä¸ªå˜é‡ x çš„è¯»å†™æ˜¯é¡ºåºçš„</li><li><strong>write propagation</strong>: P å¯¹ä¸€ä¸ªå˜é‡çš„å†™å…¥å¿…é¡»æœ€ç»ˆå¯¹å…¶ä»– Process å¯è§</li><li><strong>write serialization</strong> : å†™æœ‰å…¨å±€çš„é¡ºåº</li></ol><p><img src="https://image.mwish.me/blog-image/42AA0894-4FD5-4BF0-9A22-98F1A12F5B3C.png" alt="42AA0894-4FD5-4BF0-9A22-98F1A12F5B3C"></p><p>ä»¥ä¸Šä¾¿æ˜¯è¿èƒŒ write serialization çš„ä¾‹å­ï¼Œå¯¹äº x å†™å…¥ <code>â€œa&quot;</code>  <code>&quot;b&quot;</code>, P3 P4 è§‚å¯Ÿåˆ°çš„é¡ºåºä¸ä¸€è‡´ã€‚</p><p>é‚£ä¹ˆï¼Œåœ¨è¿™ç§å‡è®¾ä¸‹ï¼Œå‡è®¾æœ‰ä¸‰ä¸ªçº¿ç¨‹ t0, t1, t2:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// t0</span></span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; N; i += <span class="number">2</span>) &#123;</span><br><span class="line">X = i;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// t1</span></span><br><span class="line"><span class="keyword">for</span> (j = <span class="number">1</span>; j &lt; N; j += <span class="number">2</span>) &#123;</span><br><span class="line">X = j;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// t3</span></span><br><span class="line"><span class="keyword">for</span> (k = <span class="number">0</span>; k &lt; ..; k++) &#123;</span><br><span class="line">s[k] = X;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆï¼Œæ•°ç»„ s ä¸­ï¼Œå¯ä»¥çœ‹åˆ°æˆ‘å†™çš„è„‘ç˜«ç¨‹åºå¯ä»¥è¾“å‡ºï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">26980 626437 1226236 1806376 2449353 3083919 3382384 3734980 4165338 5994059 </span><br><span class="line">4872578 7435291 5586348 8893777 6262932 6539670 6875646 7205346 7535204 7873218 </span><br><span class="line">8256550 8658202 14268993 14634249 9901488 10347038 15693957 16119785 16529365 17135341 </span><br><span class="line">17836189 12867162 19251979 19962671 13929908 14261510 14598770 22698103 15331624 24051107 </span><br></pre></td></tr></table></figure><p>è¿™é‡Œå¥‡æ•°/å¶æ•°éƒ½æ˜¯å¼º order çš„ï¼Œä½†æ˜¯ä»–ä»¬ä¹‹é—´å¹¶æ²¡æœ‰ä»€ä¹ˆä¿è¯ï¼Œåªèƒ½ä¿è¯å…¨å±€æœ‰ä¸€è‡´çš„ order</p><p>(é¢˜å¤–è¯ï¼šä½†æ˜¯æˆ‘çœ‹åˆ°è¿™æœ‰ä¸ªé—®é¢˜ï¼Œå°±æ˜¯ <code>atomic + relaxed</code> å’Œ non-atomic æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Œç…äº†çœ¼ï¼š <a href="https://stackoverflow.com/questions/63810298/what-is-the-difference-between-load-store-relaxed-atomic-and-normal-variable">https://stackoverflow.com/questions/63810298/what-is-the-difference-between-load-store-relaxed-atomic-and-normal-variable</a> è¿™ä¼¼ä¹ä¿è¯å•ä¸ªæ“ä½œçš„åŸå­æ€§ï¼Œæ¯”å¦‚æˆ‘ä»¬ RV32I çš„ auipc å’Œ addâ€¦)</p><p>å…³äºå®ç° Cache Coherentï¼Œæ˜¯ä¸‹ä¸€èŠ‚çš„å†…å®¹ï¼Œæˆ‘ä»¬å†æ¬¡å…ˆçœ‹ Memory Model å§ã€‚</p><h2 id="Memory-Consistency"><a href="#Memory-Consistency" class="headerlink" title="Memory Consistency"></a>Memory Consistency</h2><p>æœ€å®ç”¨ã€æœ€æœ‰æŒ‘æˆ˜æ€§ã€æœ€ä»¤äººå›°æƒ‘çš„éƒ¨åˆ†æ¥äº†ã€‚æˆ‘ä»¬ç°åœ¨æœ‰äº†å˜é‡ <code>x</code> çš„ coherenceï¼Œæˆ‘ä»¬è¿˜éœ€è¦ä»€ä¹ˆå‘¢ï¼Ÿ</p><p>Cache Coherence ä¿è¯äº†å•ä¸ª cache block çš„ loads and stores æ˜¯æŒ‰ç…§å®šä¹‰è¿è¡Œçš„ï¼Œä½†æ˜¯æˆ‘ä»¬å‡è®¾æœ‰ä¸€ä¸ª produce-consume:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">// produce</span><br><span class="line">value &lt;- 5</span><br><span class="line">flag &lt;- ok</span><br><span class="line"></span><br><span class="line">// consume</span><br><span class="line">wait until flag is ok</span><br><span class="line">-- æ“ä½œ value</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆï¼Œå¾ˆå°´å°¬çš„æ˜¯ï¼Œä½ ä¼šå‘ç° cache coherent æ²¡æœ‰æä¾›å¯é çš„ä¿éšœã€‚</p><blockquote><p>â€œMemory Consistency Modelâ€ (sometimes called â€œMemory Orderingâ€): do all loads and stores, even to separate cache blocks, behave correctly?</p></blockquote><p>å®é™…ä¸Šï¼Œä½ ä¼šå‘ç°é—®é¢˜çš„æ¥æºå¾ˆå¤šï¼Œè€Œä¸”æ¥æºä¸æ˜¯ä¸Šå±‚åº”ç”¨ï¼Œè€Œæ˜¯æˆ‘ä»¬è®²äº†2èŠ‚çš„ cache write-buffer multi-level cache è¿™äº›ç»™æˆ‘ä»¬å¸¦æ¥åˆ©å¥½çš„ä¸œè¥¿ï¼Œå’Œ OoO æ‰§è¡Œã€ç¼–è¯‘å™¨ä¹±åºç­‰æ­£å¸¸å¯¹ç¨‹åºå‘˜é€æ˜ï¼Œç°åœ¨å…¨å†’å‡ºæ¥äº†çš„ä¸œè¥¿ã€‚</p><h4 id="Uniprocess-Memory-Model"><a href="#Uniprocess-Memory-Model" class="headerlink" title="Uniprocess Memory Model"></a>Uniprocess Memory Model</h4><p>å•ä¸ªç¨‹åºæŒ‰ program order çš„è¯­ä¹‰æ‰§è¡Œã€è¯»å†™</p><p><img src="https://image.mwish.me/blog-image/5E768853-5AB5-4B1A-B940-F2E960E9C93A.png" alt="5E768853-5AB5-4B1A-B940-F2E960E9C93A"></p><p>è¿™å›¾ç›¸å½“äºæˆ‘ä»¬ Part2 è¯´çš„ã€‚</p><p>é‚£ä¹ˆï¼Œåœ¨å¹¶è¡Œçš„æ—¶å€™ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬è¯´çš„ producer-consumer ä¸­ï¼Œå¯èƒ½ä¼šæœ‰ä¸‹å›¾çš„é—®é¢˜ï¼š</p><p><img src="https://image.mwish.me/blog-image/97CF1A96-F3F9-4976-B35F-D30F6CD258BA.png" alt="97CF1A96-F3F9-4976-B35F-D30F6CD258BA"></p><p>write buffer å’Œ OoO ç­‰ä¹±åºä¸èƒ½ä¿è¯å†™å…¥ä¼šè¢«é¡ºåºçš„ä¼ æ’­ï¼Œæ²¡æœ‰ <code>happens-before</code> çš„è¯­ä¹‰ã€‚</p><p>æ›´è¦å‘½çš„æ˜¯ï¼Œcache ä¹Ÿä¼šåœ¨å…¶ä¸­æ·»ä¹±ï¼šï¼ˆå½“ç„¶ä¸æ­¢æ˜¯ cacheï¼Œæ‰€ä»¥å›å¤´æ¥ï¼Œä½ è¦ç†è§£åˆ°ï¼Œ<code>volatile</code> è¿™ä¸ªè¯åœ¨ C/C++ ä¸­æ˜¯å±é™©çš„ï¼Œä¸èƒ½è®¤ä¸ºå®ƒä»¬è¯»å†™å†…å­˜å°±ä¸‡äº‹å¤§å‰äº†ï¼Œä¸è¿‡æˆ‘ä¹Ÿä¸å¤ªæ¸…æ¥šæ NVM çš„å¤§ä½¬ä»¬ä¼šä¸ä¼šç”¨åˆ°è¿™ä¸ªï¼‰</p><p><img src="https://image.mwish.me/blog-image/065D74C5-5B97-40DD-8087-1A31D2CD4A5C.png" alt="065D74C5-5B97-40DD-8087-1A31D2CD4A5C"></p><p>ç”±äº P3 ä¸Šæœ‰ A çš„ cache, å®ƒå¹¶ä¸ä¼šä»å†…å­˜ä¸­è¯»å–åº”è¯»çš„å€¼ï¼Œcache coherent ä¹Ÿæ²¡è¢«è¿èƒŒï¼Œä½†æ˜¯è¿™ä¼šå„¿ç¨‹åºçš„è¯­ä¹‰å°±æ²¡æ³•ä¿è¯äº†ï¼</p><p>æ›´è¦å‘½çš„æ˜¯ï¼Œè¿˜æœ‰ç¼–è¯‘å™¨çš„ä¹±åºï¼Œå…³äºç¼–è¯‘å™¨ä¹±åºå¯ä»¥å‚è€ƒæ²¡æœ‰ä½¿ç”¨ <code>atomic</code> çš„ LevelDB çš„ SkipList, å®ƒåªæ˜¯å†™äº†ä¸€ä¸ªç¼–è¯‘å™¨ barrierï¼Œè€Œæ²¡æœ‰ç”¨ CPU çš„ barrier å’ŒæŒ‡ä»¤ã€‚</p><h3 id="Sequential-Consistency-SC"><a href="#Sequential-Consistency-SC" class="headerlink" title="Sequential Consistency: SC"></a>Sequential Consistency: SC</h3><p>è¿™ä¸ªæ˜¯è€ç†Ÿäººäº†ï¼š</p><p>Formalized by Lamport (1979)</p><ul><li>accesses of each processor in program order</li><li>all accesses appear in sequential order</li></ul><p>æˆ‘ç†è§£å°±æ˜¯ç®€å•è¯´æ‰€æœ‰æ“ä½œæœ‰ä¸€ä¸ªå…¨åºï¼Œå°±æ‰€æœ‰æ“ä½œååºå˜å…¨åºã€‚ä½ å¯ä»¥ç”¨ <code>seq_cst</code> æ¥ä½“éªŒä¸€ä¸‹ï¼ˆ</p><p>ä¸‹é¢æ˜¯å®ƒçš„ç¡¬ä»¶æ¨¡å‹ï¼Œæè¿°çš„éå¸¸è¯¦ç»†ï¼š</p><p><img src="https://image.mwish.me/blog-image/8D07B6F6-9B06-45FB-A3DB-5BB1DDBE47AF.png" alt="8D07B6F6-9B06-45FB-A3DB-5BB1DDBE47AF"></p><p>è¿™ä¸ªæ—¶å€™ï¼Œå†™å…¥è¦æ±‚ï¼š</p><blockquote><p>For each processor, delay start of memory access until previous one completes: each processor has only one outstanding memory access at a time</p></blockquote><p>è¯»å–è¦æ±‚</p><blockquote><p>a read completes when its return value is bound</p></blockquote><p><img src="https://image.mwish.me/blog-image/7A92B093-6B60-49FE-BA37-B121D2B1B686.png" alt="7A92B093-6B60-49FE-BA37-B121D2B1B686"></p><p>ä¸Šè¿°ä¼šå¸¦æ¥ä¸¥æ ¼çš„é™åˆ¶å’Œå¯é æ€§ï¼Œä½†æ˜¯æ€§èƒ½â€¦</p><p><img src="https://image.mwish.me/blog-image/5BC3991D-5012-489B-B26E-64169EAE16E7.png" alt="5BC3991D-5012-489B-B26E-64169EAE16E7"></p><p>é¡ºä¾¿å¯ä»¥æä¸€ä¸‹ï¼Œå¯¹ x86 è€Œè¨€ï¼Œä¸€äº› <code>LOCK</code> æŒ‡ä»¤ä¼šè·å– Lock ç›¸å…³çš„ä¿¡æ¯ï¼Œè€Œ <code>MFENCE</code> ä¼šæ¸…ç©º Store Bufferã€‚è¿™é‡ŒæŒ‡ä»¤ä¼š<strong>æŒ‰ç…§å‘é€çš„é¡ºåº</strong>æ¥æäº¤ã€‚</p><h3 id="Relaxed-Memory-Model"><a href="#Relaxed-Memory-Model" class="headerlink" title="Relaxed Memory Model"></a>Relaxed Memory Model</h3><p>äºæ˜¯æˆ‘ä»¬æœ‰ relaxed ä¸€äº›çš„æ¨¡å‹ï¼Œä¾‹å¦‚ TSO/PSO ç­‰ï¼š</p><p><img src="https://image.mwish.me/blog-image/71298E26-F19C-4084-B6D9-3D0F971475C5.png" alt="71298E26-F19C-4084-B6D9-3D0F971475C5"></p><p>æ³¨ï¼šx86çš„ memory model ç±»ä¼¼ TSOï¼Œåªå…è®¸ store-load ä¹±åºã€‚</p><p>è¿™åœ¨ä¼˜åŒ–ä¸­è·å¾—äº†æƒè¡¡ï¼š</p><p><img src="https://image.mwish.me/blog-image/166633FA-6A66-4370-A075-3FB0735136E8.png" alt="166633FA-6A66-4370-A075-3FB0735136E8"></p><h4 id="ARM-amp-IBM-Power-çš„å†…å­˜æ¨¡å‹"><a href="#ARM-amp-IBM-Power-çš„å†…å­˜æ¨¡å‹" class="headerlink" title="ARM &amp; IBM Power çš„å†…å­˜æ¨¡å‹"></a>ARM &amp; IBM Power çš„å†…å­˜æ¨¡å‹</h4><p>åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬çš„ç¡¬ä»¶å’ŒæŒ‡ä»¤å¯èƒ½æœ‰ä¸‹é¢çš„è¯­ä¹‰ï¼š</p><p><img src="https://image.mwish.me/blog-image/70B65496-6C17-4448-9BD0-F14C42DD2CC4.png" alt="70B65496-6C17-4448-9BD0-F14C42DD2CC4"></p><p>ï¼ˆä¸Šå›¾å®é™…ä¸Šæ˜¯ä¸€ä¸ª non-multi-copy çš„æ¨¡å‹ï¼‰</p><p>ä¸‹é¢æ˜¯æŒ‡ä»¤ï¼Œå®ƒçš„ commit å¯èƒ½æ˜¯ä¹±åºçš„ï¼Œè€Œä¸”æŒ‡ä»¤å¯èƒ½ä¼šåœ¨åˆ†æ”¯é¢„æµ‹é˜¶æ®µï¼š</p><ol><li>è¯»å–çš„æ—¶å€™ï¼Œå¯èƒ½ä¼šç›´æ¥è¯»å–</li><li>å†™çš„æ—¶å€™ï¼Œè¦ç­‰å¾…ä¹‹å‰çš„å†…å®¹ Commit</li></ol><p><img src="https://image.mwish.me/blog-image/C33C7C13-990F-440F-BC8F-95465B2E2B5C.png" alt="C33C7C13-990F-440F-BC8F-95465B2E2B5C"></p><p>æ‘˜å½•ä¸€ä¸‹åŸæ–‡ï¼š</p><blockquote><p>For a read instruction, as soon as an address for the read is known, the read might be satisï¬ed, binding its value to one received from the local memory (or in some cases forwarded from earlier in the thread). <strong>That value could immediately be used by later instructions in the thread that depend on it, but it and they are subject to being restarted or (if this is a speculative path) aborted until the read is committed.</strong></p><p>For a write instruction, the key points are when the address and value become determined. After that (subject to other conditions) the write can be committed, sent to the local memory; this is not subject to restart or abort. After that, the write might propagate to other threads, becoming readable by them.</p></blockquote><p>åŒæ—¶ï¼ŒæŒ‡ä»¤å‘é€çš„é¡ºåºå’Œæ”¶åˆ°çš„é¡ºåºå¯èƒ½æ˜¯ä¸ä¸€æ ·çš„ï¼Œè¿™é‡Œæœ‰ä¸€äº›åˆ†ç±»ï¼š</p><ol><li>Weak, multi-copy-atomic memory models<ol><li>all processors see writes by another processor in same order</li><li>RISC-V RVWMO, baseline weak memory model for RISC-V</li></ol></li><li>Weak, non-multi-copy-atomic memory models<ol><li>processors can see anotherâ€™s writes in different orders</li><li>ARM v7, original ARM v8, IBM POWER</li></ol></li></ol><p>IBM Power å’Œ ARM ä¸­ï¼Œå¯èƒ½ä¼šæœ‰ Load Bufferï¼Œè¯»èµ·æ¥çš„é¡ºåºå’Œå†™çš„é¡ºåºæ˜¯ä¸ä¸€æ ·çš„ã€‚</p><h4 id="å¯èƒ½å‡ºç°çš„é—®é¢˜å’ŒåŒæ­¥"><a href="#å¯èƒ½å‡ºç°çš„é—®é¢˜å’ŒåŒæ­¥" class="headerlink" title="å¯èƒ½å‡ºç°çš„é—®é¢˜å’ŒåŒæ­¥"></a>å¯èƒ½å‡ºç°çš„é—®é¢˜å’ŒåŒæ­¥</h4><p>ä½†æ˜¯ï¼Œè¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬ä»ç„¶è¦é¢å¯¹æœ€åˆçš„é‚£ä¸ªé—®é¢˜ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">// produce</span><br><span class="line">value &lt;- 5</span><br><span class="line">flag &lt;- ok</span><br><span class="line"></span><br><span class="line">// consume</span><br><span class="line">wait until flag is ok</span><br><span class="line">-- æ“ä½œ value</span><br></pre></td></tr></table></figure><p>Data Race:</p><ul><li>two conflicting accesses on different processors</li><li>not ordered by intervening accesses</li></ul><p>æ˜¾ç„¶ï¼Œæˆ‘ä»¬å¯¹ flag çš„æ“ä½œæœ¬èº«æ²¡æœ‰ç»è¿‡åŒæ­¥ï¼Œè¿™ä¸ªåœ¨ä»…å…è®¸ store-load ä¹±åºçš„ç³»ç»Ÿä¸­ï¼Œç”šè‡³æ²¡å•¥é—®é¢˜ï¼ˆä¸è€ƒè™‘ç¼–è¯‘å™¨ä¹±åºï¼‰ã€‚ä½†æ˜¯ï¼Œåœ¨ RISC-V è¿™ç§ç³»ç»Ÿï¼Œæˆ–è€… ARM é‡Œï¼Œä½ å°±ç­‰æ­»å§ã€‚æˆ‘ä»¬éœ€è¦ä¸€äº›æœºåˆ¶æ¥åŒæ­¥ï¼š</p><p>Properly Synchronized Programs:</p><ul><li>all synchronizations are explicitly identified</li><li>all data accesses are ordered through synchronization</li></ul><p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ï¼š</p><ol><li>memory barrier</li><li>æ˜¾å¼çš„é”ï¼Œæ¥éšå¼æä¾› fence</li></ol><p>é€»è¾‘å¦‚ä¸‹ï¼š</p><p><img src="https://image.mwish.me/blog-image/CBE31CAA-B88D-410F-9F82-21D0F68FE031.png" alt="CBE31CAA-B88D-410F-9F82-21D0F68FE031"></p><ol><li>x86 çš„ <code>xchg</code> æ˜¾å¼çš„å¸®ä½ å®Œæˆè¿™ä¸€åˆ‡ï¼Œä½ å¯ä»¥ <code>acquire</code> æ¥è·å¾—é”ï¼Œåœ¨äº’æ–¥åŒºç»´æŠ¤ invariantï¼Œ<code>release</code> æ¥é‡Šæ”¾é”ã€‚é”å‰ï¼Œé”ä¸­ï¼Œé”åéƒ½æ˜¯å¯ä»¥ re-order çš„ï¼Œä½†æ˜¯å®ƒä»¬ä¸èƒ½è¶Šè¿‡é”ã€‚</li><li><strong>MFENCE</strong> <code>LFENCE</code> <code>MFENCE</code> , fenceä¼š stall ç¨‹åºï¼ŒæŠŠä¹‹å‰çš„æ“ä½œæ‰§è¡Œå®Œï¼Œæ¥åˆ›å»ºååºã€‚</li></ol><h4 id="RISC-V-ä¸­çš„åŒæ­¥"><a href="#RISC-V-ä¸­çš„åŒæ­¥" class="headerlink" title="RISC-V ä¸­çš„åŒæ­¥"></a>RISC-V ä¸­çš„åŒæ­¥</h4><p>RISC-V æä¾›äº† multi-copy modelï¼Œç„¶åæä¾›äº† <code>amo</code> æ¥æ”¯æŒåŸå­æ“ä½œï¼Œé¦–å…ˆå®ƒä»¬å¯¹æ“ä½œçš„æ•°æ®æ˜¯åŸå­å®Œæˆçš„ã€‚é¦–å…ˆæœ‰ <code>aq</code> å’Œ <code>rl</code> ä¸¤ä½ï¼š</p><ol><li>å¦‚æœæä¾›äº† <code>aq</code>ï¼Œè¿™æ¡æŒ‡ä»¤ â€œHappens Beforeâ€ ä¹‹åçš„ <code>load</code> å’Œ <code>store</code> </li><li>å¦‚æœæä¾›äº† <code>rl</code>ï¼Œè¿™æ¡æŒ‡ä»¤ â€œHappens Afterâ€ ä¹‹å‰çš„ <code>store</code> å’Œ <code>load</code></li></ol><p>è¿™é‡Œå¯ä»¥å‚è€ƒ <code>spinlock</code>:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Acquire the lock.</span></span><br><span class="line"><span class="comment">// Loops (spins) until the lock is acquired.</span></span><br><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">acquire</span><span class="params">(<span class="keyword">struct</span> spinlock *lk)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">// å¦‚æœ:</span></span><br><span class="line">  <span class="comment">// * acquire</span></span><br><span class="line">  <span class="comment">// * timer interrupt</span></span><br><span class="line">  <span class="comment">// * timer interrupt åœ¨è°ƒåº¦ä¹‹å‰æ‹¿åŒä¸€æŠŠé”, å“¦å¼.</span></span><br><span class="line">  push_off(); <span class="comment">// disable interrupts to avoid deadlock.</span></span><br><span class="line">  <span class="keyword">if</span>(holding(lk))</span><br><span class="line">    panic(<span class="string">&quot;acquire&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// On RISC-V, sync_lock_test_and_set turns into an atomic swap:</span></span><br><span class="line">  <span class="comment">//   a5 = 1</span></span><br><span class="line">  <span class="comment">//   s1 = &amp;lk-&gt;locked</span></span><br><span class="line">  <span class="comment">//   amoswap.w.aq a5, a5, (s1)</span></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  <span class="comment">// è¿™ä¸ªåœ°æ–¹ä½¿ç”¨ acquire, å› ä¸ºä¸‹é¢çš„å†…å®¹ä¸ä¼šè¢«æ”¾åˆ°è¿™å‰é¢.</span></span><br><span class="line">  <span class="keyword">while</span>(__sync_lock_test_and_set(&amp;lk-&gt;locked, <span class="number">1</span>) != <span class="number">0</span>)</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Tell the C compiler and the processor to not move loads or stores</span></span><br><span class="line">  <span class="comment">// past this point, to ensure that the critical section&#x27;s memory</span></span><br><span class="line">  <span class="comment">// references happen strictly after the lock is acquired.</span></span><br><span class="line">  <span class="comment">// On RISC-V, this emits a fence instruction.</span></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  <span class="comment">// ç›¸å½“äºæ‰‹åŠ¨ç»™ lk-&gt;cpu æ’å…¥äº†ä¸€ä¸ª fencing, è®©ä¸Šé¢çš„ä¸œè¥¿ä¸ä¼šè¢«é‡æ‹ä¸‹æ¥</span></span><br><span class="line">  __sync_synchronize();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Record info about lock acquisition for holding() and debugging.</span></span><br><span class="line">  lk-&gt;cpu = mycpu();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Release the lock.</span></span><br><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">release</span><span class="params">(<span class="keyword">struct</span> spinlock *lk)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span>(!holding(lk))</span><br><span class="line">    panic(<span class="string">&quot;release&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è¿™ä¸ªä¸ä¼šè¢«é‡æ’åˆ°ä¸‹é¢å».</span></span><br><span class="line">  lk-&gt;cpu = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Tell the C compiler and the CPU to not move loads or stores</span></span><br><span class="line">  <span class="comment">// past this point, to ensure that all the stores in the critical</span></span><br><span class="line">  <span class="comment">// section are visible to other CPUs before the lock is released,</span></span><br><span class="line">  <span class="comment">// and that loads in the critical section occur strictly before</span></span><br><span class="line">  <span class="comment">// the lock is released.</span></span><br><span class="line">  <span class="comment">// On RISC-V, this emits a fence instruction.</span></span><br><span class="line">  __sync_synchronize();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Release the lock, equivalent to lk-&gt;locked = 0.</span></span><br><span class="line">  <span class="comment">// This code doesn&#x27;t use a C assignment, since the C standard</span></span><br><span class="line">  <span class="comment">// implies that an assignment might be implemented with</span></span><br><span class="line">  <span class="comment">// multiple store instructions.</span></span><br><span class="line">  <span class="comment">// On RISC-V, sync_lock_release turns into an atomic swap:</span></span><br><span class="line">  <span class="comment">//   s1 = &amp;lk-&gt;locked</span></span><br><span class="line">  <span class="comment">//   amoswap.w zero, zero, (s1)</span></span><br><span class="line">  __sync_lock_release(&amp;lk-&gt;locked);</span><br><span class="line"></span><br><span class="line">  pop_off();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>(ä¸Šé¢ç”¨çš„ä»ç„¶æ˜¯ gnu C çš„ <code>__sync_</code> æ‰©å±•ï¼Œå› ä¸ºæ²¡æœ‰ <code>amoswap.rl</code>, æˆ–è€… <code>ac</code>ï¼Œæ‰€ä»¥æ‰‹åŠ¨æ’å…¥äº†ä¸€äº› barrier)</p><p>å…³äº fenceï¼Œå¯ä»¥å‚è€ƒï¼š</p><p><img src="https://image.mwish.me/blog-image/D2ADEADD-86EA-4011-8033-2A4F28C1A960.png" alt="D2ADEADD-86EA-4011-8033-2A4F28C1A960"></p><p>ä¸¾ä¾‹è€Œè¨€ï¼Œå¯¹äºä¸‹é¢çš„å›¾ï¼Œ<code>fence w, w</code> å’Œ <code>fence r,r</code> ä¹‹é—´æ„å»ºäº† barrierï¼Œæ¥ä¿è¯é¡ºåºï¼š</p><p><img src="https://image.mwish.me/blog-image/D67A4594-E3A7-478D-A476-52922A7C3818.png" alt="D67A4594-E3A7-478D-A476-52922A7C3818"></p><p>ä¸Šè¿°ä¾‹å­ä¸­ï¼Œ<code>fence w, w</code> å’Œ <code>fence r, r</code> æ„å»ºäº†ä¸€ä¸ªååºå…³ç³»ã€‚<code>sw data, (xdatap)</code> ä¿è¯è¢« <code>lw xdata, (xdatap)</code> æ„ŸçŸ¥äº†ã€‚</p><h3 id="RISC-V-çš„æ”¯æŒï¼šRV32A"><a href="#RISC-V-çš„æ”¯æŒï¼šRV32A" class="headerlink" title="RISC-V çš„æ”¯æŒï¼šRV32A"></a>RISC-V çš„æ”¯æŒï¼šRV32A</h3><blockquote><p>RISC-V å…·æœ‰å®½æ¾çš„å†…å­˜ä¸€è‡´æ€§æ¨¡å‹(relaxed memory consistency model)ï¼Œå› æ­¤å…¶ä»–çº¿ç¨‹çœ‹ åˆ°çš„å†…å­˜è®¿é—®å¯ä»¥æ˜¯ä¹±åºçš„ã€‚å›¾ 6.2 ä¸­ï¼Œæ‰€æœ‰çš„ RV32A æŒ‡ä»¤éƒ½æœ‰ä¸€ä¸ªè¯·æ±‚ä½(aq)å’Œä¸€ä¸ª é‡Šæ”¾ä½(rl)ã€‚aq è¢«ç½®ä½çš„åŸå­æŒ‡ä»¤ä¿è¯å…¶å®ƒçº¿ç¨‹åœ¨éšåçš„å†…å­˜è®¿é—®ä¸­çœ‹åˆ°é¡ºåºçš„ AMO æ“ ä½œ;rl è¢«ç½®ä½çš„åŸå­æŒ‡ä»¤ä¿è¯å…¶å®ƒçº¿ç¨‹åœ¨æ­¤ä¹‹å‰çœ‹åˆ°é¡ºåºçš„åŸå­æ“ä½œã€‚æƒ³è¦äº†è§£æ›´è¯¦ç»†çš„ æœ‰å…³çŸ¥è¯†ï¼Œå¯ä»¥æŸ¥çœ‹[Adve and Gharachorloo 1996]ã€‚</p></blockquote><p><img src="https://image.mwish.me/blog-image/4390486F-3FF8-4C71-A8FB-DC0598E077CF.png" alt="4390486F-3FF8-4C71-A8FB-DC0598E077CF"></p><p>RV32A æ²¡æœ‰ç›´æ¥æä¾›äº† CAS FAA çš„æŒ‡ä»¤ï¼Œè€Œæ˜¯æä¾›äº†ä¸¤å¥—æŒ‡ä»¤ã€‚RV32A è®¤ä¸ºè¿™æ ·æœ‰æ›´å¥½çš„å¯æ‰©å±•æ€§ï¼š</p><p><img src="https://image.mwish.me/blog-image/23F56E11-4461-4BB4-9D02-C2E38A64A60D.png" alt="23F56E11-4461-4BB4-9D02-C2E38A64A60D"></p><h3 id="ç¼–è¯‘å™¨ä¹±åºå’Œè¯­è¨€çš„-memory-order"><a href="#ç¼–è¯‘å™¨ä¹±åºå’Œè¯­è¨€çš„-memory-order" class="headerlink" title="ç¼–è¯‘å™¨ä¹±åºå’Œè¯­è¨€çš„ memory_order"></a>ç¼–è¯‘å™¨ä¹±åºå’Œè¯­è¨€çš„ <code>memory_order</code></h3><p><a href="https://chromium.googlesource.com/external/leveldb/+/v1.15/port/atomic_pointer.h#61">https://chromium.googlesource.com/external/leveldb/+/v1.15/port/atomic_pointer.h#61</a></p><p>é™¤äº†å†…å­˜ï¼Œç¼–è¯‘å™¨ä¹Ÿä¼šå®Œæˆä¹±åºã€‚æœ€ä½³çš„ä¾‹å­æ˜¯ LevelDB ä¹‹å‰çš„ç¼–è¯‘å™¨ barrierã€‚</p><p>è¯­è¨€ä¼šæä¾›å¯¹åº”çš„è¯­ä¹‰ï¼Œå¦‚ C++ çš„å…­ç§ order ï¼ˆå®è¯è¯´æˆ‘ consume é‚£å‡ ä¸ªå®Œå…¨ä¸æ‡‚ï¼‰: <a href="https://en.cppreference.com/w/cpp/atomic/memory_order">https://en.cppreference.com/w/cpp/atomic/memory_order</a></p><p>æˆ–è€…ç®€å•ç‚¹å¯ä»¥çœ‹çœ‹ Golang çš„ï¼ˆ</p><h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><ol><li>CMU 15-418 Spring 2020</li><li>UCB CS152 Spring 2020</li><li>CPU Cache and Memory Ordering ä½•ç™»æˆ</li><li>RISC-V Reader</li><li>Computer Organization and Design RISC-V edition</li></ol>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Cache and Related Part2: Cache çš„ä¼˜åŒ–</title>
      <link href="/2020/10/31/Cache-and-Related-Part2/"/>
      <url>/2020/10/31/Cache-and-Related-Part2/</url>
      
        <content type="html"><![CDATA[<p>æˆ‘ä»¬ä¸Šä¸€ä¸ª part èŠè¿‡äº† direct-mapped cacheï¼Œè¿™ä¸€èŠ‚æˆ‘ä»¬é‡å¤ä¸€äº› cache çš„ basicsï¼Œç„¶åèŠ cache ç›¸å…³çš„ä¼˜åŒ–ã€‚</p><h2 id="Recall"><a href="#Recall" class="headerlink" title="Recall"></a>Recall</h2><p>æˆ‘ä»¬ä¹‹å‰ä»‹ç»è¿‡äº† direct-mapped cacheï¼Œä¹‹æ‰€ä»¥å«è¿™ä¸ªåå­—ï¼Œæ˜¯å› ä¸ºï¼š</p><blockquote><p>This cache structure is called <strong>direct mapped</strong>, since each memory location is mapped directly to exactly one location in the cache. </p></blockquote><p>æˆ‘ä»¬ä¸Šä¸€èŠ‚ä¸­ï¼Œä¸€ä¸ªåœ°å€å¯ä»¥è¢«åˆ†æˆï¼š</p><ol><li>tag</li><li>index</li><li>offset</li></ol><p>è€Œ cache æœ¬èº«çš„å­˜å‚¨ä¸åªæ˜¯å­˜æ”¾åœ°å€ï¼Œå®ƒéœ€è¦å­˜æ”¾çš„æ˜¯ï¼š</p><ol><li>Invalid bit</li><li>tag</li><li>block data</li></ol><p>æˆ‘æŸ¥äº†ä¸€ä¸‹ï¼Œè¿™é‡Œ block çš„æ¦‚å¿µæ¯”è¾ƒæ¥è¿‘ cacheline çš„æ¦‚å¿µ. æˆ‘çš„ç”µè„‘ lscpu ä¸‹è¯•è¯•ï¼š</p><p>æˆ‘çš„å°å¼ï¼Œä½¿ç”¨ <code>lscpu</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">æ¶æ„ï¼š                           x86_64</span><br><span class="line">CPU è¿è¡Œæ¨¡å¼ï¼š                   32-bit, 64-bit</span><br><span class="line">å­—èŠ‚åºï¼š                         Little Endian</span><br><span class="line">Address sizes:                   43 bits physical, 48 bits virtual</span><br><span class="line">CPU:                             16</span><br><span class="line">åœ¨çº¿ CPU åˆ—è¡¨ï¼š                  0-15</span><br><span class="line">æ¯ä¸ªæ ¸çš„çº¿ç¨‹æ•°ï¼š                 2</span><br><span class="line">æ¯ä¸ªåº§çš„æ ¸æ•°ï¼š                   8</span><br><span class="line">åº§ï¼š                             1</span><br><span class="line">NUMA èŠ‚ç‚¹ï¼š                      1</span><br><span class="line">å‚å•† IDï¼š                        AuthenticAMD</span><br><span class="line">CPU ç³»åˆ—ï¼š                       23</span><br><span class="line">å‹å·ï¼š                           113</span><br><span class="line">å‹å·åç§°ï¼š                       AMD Ryzen 7 3800X 8-Core Processor</span><br><span class="line">æ­¥è¿›ï¼š                           0</span><br><span class="line">Frequency boost:                 enabled</span><br><span class="line">CPU MHzï¼š                        1961.707</span><br><span class="line">CPU æœ€å¤§ MHzï¼š                   3900.0000</span><br><span class="line">CPU æœ€å° MHzï¼š                   2200.0000</span><br><span class="line">BogoMIPSï¼š                       7802.74</span><br><span class="line">è™šæ‹ŸåŒ–ï¼š                         AMD-V</span><br><span class="line">L1d ç¼“å­˜ï¼š                       256 KiB</span><br><span class="line">L1i ç¼“å­˜ï¼š                       256 KiB</span><br><span class="line">L2 ç¼“å­˜ï¼š                        4 MiB</span><br><span class="line">L3 ç¼“å­˜ï¼š                        32 MiB</span><br><span class="line">NUMA èŠ‚ç‚¹0 CPUï¼š                 0-15</span><br></pre></td></tr></table></figure><p><img src="https://image.mwish.me/blog-image/A031FE24-E31B-45F3-82B5-2228AED1EA54.png" alt="A031FE24-E31B-45F3-82B5-2228AED1EA54"></p><p>å½“æˆ‘ä»¬è¯»å–çš„æ—¶å€™ï¼Œæˆ‘ä»¬åœ¨ RISC-V Datapath çš„å›¾åƒä¸Šæ˜¯ç»è¿‡ icache å’Œ dcache è¯»å– memoryï¼Œä½†æ˜¯å®é™…ä¸Šæˆ‘ä»¬æ›´å¤šæ˜¯è¯´è¯»/å†™ cacheã€‚</p><p>å½“æˆ‘ä»¬äº§ç”Ÿè¯» cache miss çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šä¿å­˜å¯„å­˜å™¨ï¼Œç„¶ånoopæˆ–è€…åœæ­¢ï¼Œæ¥æš‚åœæ‰§è¡Œã€‚è€Œæˆ‘ä»¬å¦‚æœæœ‰ out-of-order çš„æ‰§è¡Œï¼Œé‚£ä¹ˆåˆ«çš„éƒ¨åˆ†ä»ç„¶èƒ½åœ¨è¯­ä¹‰æ­£ç¡®çš„æƒ…å†µä¸‹æ‰§è¡Œã€‚ç„¶åç­‰ç¼“å­˜åŠ è½½ã€‚</p><p>å¤„ç†å†™çš„æ—¶å€™ï¼Œæˆ‘ä»¬æœ‰ write-through å’Œ write-back ä¸¤ç§å½¢å¼ï¼Œæˆ‘ä»¬åœ¨ä¸Šä¸€èŠ‚æåˆ°è¿‡ã€‚ä½†æ˜¯ï¼Œæˆ‘ä»¬éœ€è¦è€ƒè™‘åˆ°ï¼Œå¦‚æœæ¯æ¬¡writeéƒ½å†™åˆ°åº•å±‚çš„è¯ï¼Œæ— ç–‘ï¼Œæ¯æ¬¡å†™éƒ½ä¼šå¸¦æ¥å¾ˆå¤§çš„å¼€é”€:</p><blockquote><p> With a write-through scheme, every write causes the data to be written to main memory. These writes will take a long time, likely at least 100 processor clock cycles, and could slow down the processor considerably. </p></blockquote><p>å®ç°çš„æ—¶å€™ï¼Œä¸€ä¸ªæ¯”è¾ƒå¥½çš„è§£å†³æ–¹æ¡ˆæ˜¯ write-bufferã€‚å½“å¤„ç†å†™è¯·æ±‚çš„æ—¶å€™ï¼Œå†™åˆ° cache å±‚çš„ write-bufferå°±ç®—å†™æˆåŠŸäº†ï¼Œå¤„ç†å™¨å¯ä»¥æ¥ä¸‹æ¥è¿›è¡Œï¼Œcache æŠŠå†™ç»™ memory ä¹‹åï¼Œwrite buffer ä¼šè¢«æ¸…ç©ºã€‚ä¸è¿‡ write-buffer ä¼šé¢ä¸´ä¸¤ä¸ªé—®é¢˜</p><ol><li>ä¹±åºï¼ˆæ‰€ä»¥æŸç§æ„ä¹‰ä¸Šéœ€è¦ memory modelï¼‰</li><li>write-stall</li></ol><blockquote><p>If the write buffer is full when the processor reaches a write, the processor must stall until there is an empty position in the write buffer. </p></blockquote><p>è¿˜æœ‰ä¸€ç§æ–¹å¼æ˜¯ write-throughï¼Œå†™åˆ° cache ä¸Šï¼Œç„¶åè¢« evict çš„æ—¶å€™å†™å›ã€‚ä¸è¿‡è¿™ä¸ªä¼šé¢ä¸´çš„é—®é¢˜æ˜¯éœ€è¦è‡ªåŒ— evict çš„æ—¶å€™å¯èƒ½ä¼š stall. write-through ä¹Ÿæœ‰ write allocate ç­‰ç­–ç•¥ã€‚write allocate æ˜¯æŒ‡ï¼šå¦‚æœç›®æ ‡å†…å­˜ä¸åœ¨ cache ä¸­ï¼Œæ˜¯å¦è¦æŠŠå®ƒæä¸Šæ¥ã€‚</p><h2 id="å…¶ä»–æ¨¡å¼ä¸æ€§èƒ½ä¼˜åŒ–"><a href="#å…¶ä»–æ¨¡å¼ä¸æ€§èƒ½ä¼˜åŒ–" class="headerlink" title="å…¶ä»–æ¨¡å¼ä¸æ€§èƒ½ä¼˜åŒ–"></a>å…¶ä»–æ¨¡å¼ä¸æ€§èƒ½ä¼˜åŒ–</h2><p>æˆ‘ä»¬ä¹‹å‰æåˆ° cpu cycles éƒ½æ˜¯ CPU å’Œ time çš„ cycleï¼Œä½†æ˜¯ï¼Œè€ƒè™‘ memory å’Œ cache ä¹‹åã€‚è¿™å‡ ä¸ªå˜æˆäº†ï¼š</p><ol><li>CPU execution clock cycles</li><li>Memory-stall clock cycles</li></ol><p>ä¸Šè¿°ä¸¤ä¸ªä¹˜ clock cycle time</p><p>å¯¹äº memory-stall, æˆ‘ä»¬å¯ä»¥åˆ†ä¸ºè¯»å†™ï¼š</p><p><img src="https://image.mwish.me/blog-image/3A943142-5CDA-4014-8CA3-3B1009AF43EF.png" alt="3A943142-5CDA-4014-8CA3-3B1009AF43EF"></p><p><img src="https://image.mwish.me/blog-image/28081A23-89A5-42CC-8E74-A57B2CE49DF9.png" alt="28081A23-89A5-42CC-8E74-A57B2CE49DF9"></p><h3 id="Fully-associative-cache"><a href="#Fully-associative-cache" class="headerlink" title="Fully associative cache"></a>Fully associative cache</h3><blockquote><p>A cache structure in which a block can be placed in any location in the cache.</p></blockquote><p>è¿™ä¸ªå…¶å®ç±»ä¼¼æ²¡æœ‰ index äº†ï¼Œæ¯æ¬¡æŸ¥è¯¢çš„æ—¶å€™å¯¹æ‰€æœ‰çš„ cache tag å¹¶è¡Œåšä¸€ä¸ªæ¯”è¾ƒï¼ˆæˆ‘å…¶å®ä¸å¤ªæ‡‚ç¡¬ä»¶çš„å®ç°ï¼Œä¸è¿‡è¿™ä¸ªå¬ä¸Šå»å¤ªæç«¯äº†ï¼‰</p><p>åœ¨ fully-associative å’Œ direct-mapped ä¹‹å‰ï¼Œä¹Ÿæœ‰ set-associative:</p><blockquote><p>In a set-associative cache, there are a fixed number of locations where each block can be placed. A set-associative cache with <em>n</em> locations for a block is called an <em>n</em>-way set-associative cache. An <em>n</em>-way set-associative cache consists of a number of sets, each of which consists of <em>n</em> blocks. </p></blockquote><p>å†…å­˜ä¸­çš„æ¯ä¸ªåœ°å€ï¼Œä¹‹å‰æ˜¯ map åˆ° cache ä¸­çš„ä¸€ä¸ª index, ç°åœ¨å…è®¸ map åˆ°ä¸€ä¸ª set, è¿™ä¸ª set æ˜¯ nä½çš„ï¼Œåœ¨è¿™ä¸ªset ä¸­è¿›è¡Œæ¯”è¾ƒ</p><p><img src="https://image.mwish.me/blog-image/DED1D2F9-D9FF-4411-9214-CC1F47EFB142.png" alt="DED1D2F9-D9FF-4411-9214-CC1F47EFB142"></p><p>æ‰€ä»¥å…¶å®æ¥è¯´ï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ª associate å¤§å°çš„å…³ç³»ï¼Œdirect-mapped çš„æƒ…å†µä¸‹ï¼Œè¿™ä¸ªå€¼ä¸º1ï¼Œfully-associate çš„æƒ…å†µä¸‹ï¼Œè¿™ä¸ªå€¼ä¸ºç¼“å­˜çš„å¤§å°ï¼Œä¸‹é¢æˆ‘ä»¬æ¥çœ‹çœ‹å…·ä½“çš„å¯¹æ€§èƒ½çš„å½±å“</p><p><img src="https://image.mwish.me/blog-image/77D0C44E-F04F-413C-BEC0-A57DF3EBEC25.png" alt="77D0C44E-F04F-413C-BEC0-A57DF3EBEC25"></p><p>ç»¼ä¸Šï¼Œä¸€å®šçš„æœºåˆ¶å¯ä»¥ä¿è¯æ›´å°çš„ data miss rate, ä½†åŒæ—¶ï¼Œæ¯”è¾ƒé«˜çš„ accociativity å´ä¸ä¼šæå‡çš„å¤ªé«˜ã€‚è€Œåœ¨cache çš„è®¾è®¡ä¸­ï¼Œä¹Ÿéœ€è¦åšå‡ºä¸€å®šçš„ trade-off, è¯» cache æˆä¸ºäº†ä¸‹é¢çš„å½¢å¼ï¼š</p><p><img src="https://image.mwish.me/blog-image/853482DD-D9E0-483D-A5F9-4D5EC50F7064.png" alt="853482DD-D9E0-483D-A5F9-4D5EC50F7064"></p><p>è¿™ç§ n-way ä¹Ÿæ·»åŠ äº†å¼€é”€ï¼š</p><ol><li>N Comparators çš„æ—¶ç©ºå¼€é”€</li><li>MUX çš„æ—¶é—´å¼€é”€</li></ol><p>è€Œéœ€è¦æ›¿æ¢çš„æ—¶å€™ï¼Œå¯ä»¥ç”¨ LRU æˆ–è€…æ›´ç®€å•çš„ clock ç®—æ³•æ¥æ ‡ç¤ºæ›¿æ¢ cache.</p><h3 id="Multi-Level-Caches-Reducing-the-Miss-Penalty"><a href="#Multi-Level-Caches-Reducing-the-Miss-Penalty" class="headerlink" title="Multi-Level Caches: Reducing the Miss Penalty"></a>Multi-Level Caches: Reducing the Miss Penalty</h3><blockquote><p>This second-level cache is normally on the same chip and is accessed whenever a miss occurs in the primary cache. If the second-level cache contains the desired data, the miss penalty for the first-level cache will be essentially the access time of the second-level cache, which will be much less than the access time of main memory. </p></blockquote><p>å¥½å§ï¼Œä¸å¾—ä¸æ‰¿è®¤ï¼Œæˆ‘çœ‹è¿™ä¸€èŠ‚ä¹‹å‰éƒ½ä»¥ä¸ºè¿™äº› cache è™½ç„¶éƒ½æ˜¯ DRAMï¼Œä½†æ˜¯é€ ä»·å’Œæˆæœ¬æ˜¯æœ‰æ˜æ˜¾å·®å¼‚çš„ã€‚å®ƒä»¬ç¡®å®æœ‰å·®å¼‚ï¼Œä½†æ˜¯æ˜¯ä½“ç°åœ¨åˆ«çš„åœ°æ–¹ï¼Œæˆ‘ä»¬ä¼šåœ¨ä¸‹é¢ä»‹ç»å®ƒä»¬çš„ã€‚</p><p>éœ€è¦æ˜ç™½çš„æ˜¯ï¼Œå‡è®¾æˆ‘ä»¬æœ‰2çº§çš„ cache, ä¸”éƒ½æ²¡æœ‰ data, é‚£ä¹ˆä¸€ä¸ªçš† miss çš„è®¿é—®å°†ä¼šä¸¢å¤±æ›´å¤šçš„æ•°æ®ã€‚</p><blockquote><p>With a larger total size, the secondary cache may use a larger block size than appropriate with a single-level cache. It often uses higher associativity than the primary cache given the focus of reducing miss rates.</p><p>The design considerations for a primary and secondary cache are significantly different, because the presence of the other cache changes the best choice versus a single-level cache. In particular, a two-level cache structure allows the primary cache to focus on minimizing hit time to yield a shorter clock cycle or fewer pipeline stages, while allowing the secondary cache to focus on miss rate to reduce the penalty of long memory access times.</p></blockquote><p>åœ¨i7ä¸­ï¼Œæˆ‘ä»¬æœ‰å¦‚ä¸‹çš„ä¾‹å­ï¼š</p><p><img src="https://image.mwish.me/blog-image/59B41747-12EF-4527-A438-9F771E78F8C8.png" alt="59B41747-12EF-4527-A438-9F771E78F8C8"></p><p>å¯¹ multilevel cache , ä¸‹å±‚éœ€è¦æ›´å¤§çš„å¤§å°ï¼Œå…è®¸æ›´æ…¢çš„ååº”é€Ÿåº¦ã€‚ä½ å¯èƒ½ä¼šå¾ˆå¥‡æ€ªï¼Œä¸ºä»€ä¹ˆéƒ½æ˜¯ cache, é˜¿ååº”é€Ÿåº¦å¯ä»¥æ›´æ…¢ï¼Œå®é™…ä¸Šï¼Œä½ å¯ä»¥è€ƒè™‘æˆ‘ä»¬ä¹‹å‰è®¨è®ºçš„ä¸€äº› trade-off</p><p><img src="https://image.mwish.me/blog-image/DC99A34F-B392-434A-956C-C0ECCBB3999D.png" alt="DC99A34F-B392-434A-956C-C0ECCBB3999D"></p><p>é‚£ä¹ˆä¸‹å±‚çš„ cache å…è®¸æ›´å¤šçš„ waysï¼Œæ›´å¤§çš„å¤§å°ï¼Œå’Œæ›´æ…¢çš„è®¿é—®é€Ÿåº¦ã€‚</p><h4 id="L1-L2-L3"><a href="#L1-L2-L3" class="headerlink" title="L1 L2 L3"></a>L1 L2 L3</h4><p><img src="https://image.mwish.me/blog-image/30DFE9D9-F52F-4A3E-BAEF-FB01A82F74DB.png" alt="30DFE9D9-F52F-4A3E-BAEF-FB01A82F74DB"></p><p>ä»¥ä¸Šçš„å†³ç­–å…è®¸æˆ‘ä»¬ä½œå‡ºè®¾è®¡</p><p><a href="https://superuser.com/questions/269080/why-are-multiple-levels-of-caches-used-in-modern-cpus">https://superuser.com/questions/269080/why-are-multiple-levels-of-caches-used-in-modern-cpus</a></p><p><a href="https://zhuanlan.zhihu.com/p/31875174">https://zhuanlan.zhihu.com/p/31875174</a></p><p><img src="https://image.mwish.me/blog-image/ECC76F17-69E7-480A-A910-F2AA4B7286B8.png" alt="ECC76F17-69E7-480A-A910-F2AA4B7286B8"></p><h3 id="ç¼“å­˜ï¼Œè®¿é—®æ¨¡å¼ï¼Œå¤šä¸ªç¼“å­˜"><a href="#ç¼“å­˜ï¼Œè®¿é—®æ¨¡å¼ï¼Œå¤šä¸ªç¼“å­˜" class="headerlink" title="ç¼“å­˜ï¼Œè®¿é—®æ¨¡å¼ï¼Œå¤šä¸ªç¼“å­˜"></a>ç¼“å­˜ï¼Œè®¿é—®æ¨¡å¼ï¼Œå¤šä¸ªç¼“å­˜</h3><blockquote><p>Caching is perhaps the most important example of the big idea of <strong>prediction</strong>. It relies on the principle of locality to try to find the desired data in the higher levels of the memory hierarchy, and provides mechanisms to ensure that when the prediction is wrong it finds and uses the proper data from the lower levels of the memory hierarchy. The hit rates of the cache prediction on modern computers are often above 95% (see Figure 5.46).</p></blockquote><p>ç¼“å­˜æ˜¯å¯ä»¥ prefetch å¹¶èƒ½å¤Ÿé¢„æµ‹çš„ï¼Œå®é™…ä¸Šï¼Œä¸ä»…æ˜¯è¿™ä¸€å±‚çš„ cache, åº”ç”¨å±‚ cache ä¹Ÿæœ‰å¾ˆå¤šä¸åŒçš„ç®—æ³•ï¼Œæ¥å‡å°ä¸å‘½ä¸­çš„å¼€é”€ã€‚æœ‰ä¸€äº›ç®—æ³•ä¼šæ•…æ„è®©è®¿é—®æ¨¡å¼ cache ä¸å‹å¥½ï¼Œæ¥å¢åŠ è®¿é—® cache çš„å¼€é”€ã€‚</p><p>LRU Clock ç®—æ³•è¿™äº›ç”šè‡³å¯ä»¥åšåˆ°ç¡¬ä»¶ï¼Œè€Œæœ‰ä¸€äº› arc ä¹‹ç±»çš„ç®—æ³•ç›¸å¯¹æ¥è¯´å¯ä»¥ä½œä¸º db çš„ cache replacement policyã€‚</p><p>prefetch å¯ä»¥å¸¦æ¥ä¸å°‘æ€§èƒ½çš„ä¼˜åŠ¿ï¼Œå¦‚ä¸‹å›¾ï¼š</p><p><img src="https://image.mwish.me/blog-image/D3290C5A-C942-4434-9852-22350D87B17C.png" alt="D3290C5A-C942-4434-9852-22350D87B17C"></p><h2 id="ç¼“å­˜ä¸ä»£ç "><a href="#ç¼“å­˜ä¸ä»£ç " class="headerlink" title="ç¼“å­˜ä¸ä»£ç "></a>ç¼“å­˜ä¸ä»£ç </h2><p><code>stride * sizeof(int) == block size</code> çš„æ—¶å€™ï¼Œä½ çš„ä»£ç å¿…å®šä¸æ˜¯ç¼“å­˜å‹å¥½åœ°</p><p>å…³äºç¼“å­˜å‹å¥½è¿™ä¸ªå‘, å¯ä»¥å‚è€ƒä¸‹ï¼š</p><ul><li><a href="https://fosschef.wordpress.com/2011/07/08/prefetch-performance-and-toxic/">https://fosschef.wordpress.com/2011/07/08/prefetch-performance-and-toxic/</a></li><li><a href="http://igoro.com/archive/gallery-of-processor-cache-effects/">http://igoro.com/archive/gallery-of-processor-cache-effects/</a></li><li><a href="https://www.aristeia.com/TalkNotes/ACCU2011_CPUCaches.pdf">https://www.aristeia.com/TalkNotes/ACCU2011_CPUCaches.pdf</a></li><li>CSAPP, 3edtion.</li></ul><p>æˆ‘åœ¨æˆ‘çš„ Mac å’Œ 3800X éƒ½è·‘è¿‡è¿™äº›ä»£ç ï¼Œæœ‰å‡ ä¸ªå‘å…¶å®è¯•ä¸å¤ªå‡ºæ¥ï¼Œæˆ‘ä¹Ÿä¸çŸ¥é“å’‹å›äº‹ï¼Œæœ‰æ²¡æœ‰äººå¯ä»¥æ•™æ•™æˆ‘çš„</p>]]></content>
      
      
      
        <tags>
            
            <tag> system </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Cache and Related Part1</title>
      <link href="/2020/10/29/Cache-and-Related-Part1/"/>
      <url>/2020/10/29/Cache-and-Related-Part1/</url>
      
        <content type="html"><![CDATA[<p>åœ¨ Pipeline æ‰§è¡Œçš„æ—¶å€™ï¼Œæˆ‘ä»¬æ‹†æˆç®€å•çš„ 4/5 stage çš„ pipeline çš„è¯ï¼Œæˆ‘ä»¬ä¼šæœ‰ä¸€äº› hazard:</p><ul><li>Structural hazard</li><li>Data hazard</li><li>Control hazard</li></ul><p>structural hazard éƒ½ç»™å¯ä»¥é  nop å’Œé’±è§£å†³. Data hazard ä¹Ÿå¯ä»¥ nop, ä½†åŒæ—¶ï¼Œå¯ä»¥ forwarding çš„æ–¹å¼ï¼Œé é¢å¤–çš„æ§åˆ¶é€»è¾‘ï¼Œæ¥å‡å°è¿™ç±»äº‹æƒ…çš„å‘ç”Ÿã€‚è€Œæˆ‘ä»¬ä¹Ÿæœ‰ control hazard, å¯¹åˆ†æ”¯æŒ‡ä»¤å¸¦æ¥å½±å“ã€‚ä¸€æ–¹é¢æµæ°´çº¿æœ‰åˆ†æ”¯é¢„æµ‹ï¼Œä¸€æ–¹é¢ gcc æä¾›äº† <code>__likely__</code> ä¹‹ç±»çš„æ“ä½œï¼Œåœ¨ç”Ÿæˆä»£ç çš„æ—¶å€™é™æ€çš„åšäº†ä¸€äº›å¤„ç†ã€‚</p><p>åœ¨è¿™ä¸ªé˜¶æ®µçš„åˆ†æä¸­ï¼Œæˆ‘ä»¬æœ‰ç‚¹å¯¹æ‰€æœ‰æŒ‡ä»¤ä¸€è§†åŒä»çš„å‘³é“ï¼š<code>sw</code> <code>lw</code> è¢«æˆ‘ä»¬å½“æˆä¼Šå¸ƒ/åŒæ­¥çš„ï¼Œå®ƒä»¬ä»¿ä½›è¿è½¬çš„å’Œè¿ç®—æŒ‡ä»¤ä¸€æ ·å¿«ï¼Œè€Œä¸”ä¸ä¼šå¸¦æ¥ä»€ä¹ˆé¢å¤–å¼€é”€. ä½†æ˜¯å®é™…ä¸Šæˆ‘ä»¬éƒ½çŸ¥é“ load memory å’Œè®¡ç®—ä¹‹é—´æ˜¯æœ‰ gap çš„ï¼Œè€Œä¸”è¿™ä¸ª gap è¿˜ä¸å¤ªå°ã€‚</p><p><img src="https://image.mwish.me/blog-image/æˆªå±2020-10-29-ä¸‹åˆ3.05.03.png" alt="æˆªå±2020-10-29 ä¸‹åˆ3.05.03"></p><p>ç„¶åæˆ‘ä»¬å°±åˆ°äº†å–œé—»ä¹è§çš„å­˜å‚¨å±‚æ¬¡å±±äº†ï¼š</p><p><img src="https://image.mwish.me/blog-image/æˆªå±2020-10-29-ä¸‹åˆ3.08.22.png" alt="æˆªå±2020-10-29 ä¸‹åˆ3.08.22"></p><p>è¶Šæ¥è¿‘ CPU, è®¿é—®è¶Šå¿«ï¼Œä½†æ˜¯è¶Šå°ã€å•ä½å­˜å‚¨é‡çš„æˆæœ¬è¶Šæ˜‚è´µã€‚å­˜å‚¨å±‚æ¬¡çš„æ€æƒ³æ˜¯ï¼š</p><ul><li>ä¸Šå±‚çš„æ•°æ®æ˜¯ä¸‹å±‚çš„ä¸€ä¸ªå­é›†</li><li>ä¸‹å±‚åœ¨é€»è¾‘ä¸Šæœ‰æ‰€æœ‰çš„æ•°æ®</li></ul><p>åŒæ—¶ï¼Œç›¸å…³çš„æ¦‚å¿µæœ‰ä¸¤ç§ locality:</p><ul><li>Temporal locality: æ—¶é—´ä¸Šçš„å±€éƒ¨æ€§<ul><li>å¦‚æœæŸä¸ª memory è¢«è®¿é—®äº†ï¼Œå¾ˆå¯èƒ½è¿‘æœŸæœ‰ä¸€å®šæœºä¼šä¼šå†æ¬¡è¢«è®¿é—®</li></ul></li><li>Spatial locality<ul><li>å¦‚æœæŸä¸ª memory è¢«è®¿é—®ï¼Œé‚£å®ƒé™„è¿‘çš„å†…å­˜å¾ˆå¯èƒ½ä¹Ÿä¼šè¢«è®¿é—®</li></ul></li></ul><p><img src="https://image.mwish.me/blog-image/æˆªå±2020-10-29-ä¸‹åˆ5.54.35.png" alt="æˆªå±2020-10-29 ä¸‹åˆ5.54.35"></p><p>é‚£ä¹ˆï¼Œæˆ‘ä»¬åœ¨è®¡ç®—æœºç³»ç»Ÿé‡Œé¢æœ‰ä¸€äº›éšå«çš„å­˜å‚¨å±‚æ¬¡ï¼Œè¿™æ˜¯é™¤å¼€æ˜¾å¼çš„ mmap æˆ–è€…å†™ç›˜ã€å…±äº«å†…å­˜å¤–çš„å½¢å¼ï¼š</p><ol><li>Register å’Œ memory çš„è¯»/å†™ï¼šç”±ç¼–è¯‘å™¨æˆ–è€…æ±‡ç¼–ç¼–å†™è€…ç”Ÿæˆ</li><li>cache å’Œ main memory: ç”± cache controller ç®¡ç†</li><li>Main memory å’Œ disk: ç”± OS ç®¡ç†ï¼›ä¹Ÿæœ‰ TLB è¿™æ ·çš„ç¼“å­˜å­˜åœ¨ï¼ˆæ€»æ‰€å‘¨çŸ¥ï¼ŒTLB è™½ç„¶å«åš bufferï¼Œå®é™…ä¸Šæ˜¯ä¸ª cacheï¼‰ã€‚</li></ol><p>ä¸Šé¢æ˜¯ locality ç›¸å…³çš„è®¿é—®æ¨¡å¼ï¼Œæˆ‘ä»¬ä¼šæ³¨æ„åˆ°ä¸€äº›ç‰¹å¾ã€‚å…¶ä¸­éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæœ‰çš„è®¿é—®æ¨¡å¼æ˜¯ç›¸å¯¹æ¥è¯´ï¼š</p><ul><li>é“¾å¼çš„ç»“æ„å¯èƒ½ä¼šæœ‰ locality ä¸è¶³çš„é—®é¢˜ï¼Œå› ä¸ºå®é™…ä¸Šå®ƒçš„å†…å­˜æ˜¯ç¦»æ•£çš„ï¼Œ</li><li>Go è¯­è¨€è¿™æ ·çš„è¯­è¨€æä¾› map slice è¿™äº›ç›¸å¯¹æ¥è¯´ locality å¥½ä¸€äº›çš„ç»“æ„</li><li>LevelDB é‡Œé¢ä¼šç”¨ Arena å°è¯•åˆ†é…åœ¨è¿ç»­çš„å†…å­˜ä¸Š</li></ul><p>Cache æœ‰ä¸€ç‚¹æ¯”è¾ƒé‡è¦çš„å°±æ˜¯ï¼Œ<strong>cache å¯¹ç”¨æˆ·æ˜¯é€æ˜çš„</strong>ï¼Œè¿™æ„å‘³ç€ï¼š</p><ol><li>å³ä½¿ä¸çŸ¥é“ cache, ç¨‹åºã€æŒ‡ä»¤ä¹Ÿèƒ½æ­£å¸¸çš„è¿ä½œ</li><li>ä¸è€ƒè™‘æ•ˆç‡çš„æƒ…å†µä¸‹ï¼Œä¸Šå±‚çš„ä½¿ç”¨è€…ä¸éœ€è¦çŸ¥é“ cache çš„æ¦‚å¿µ</li></ol><p>è€ƒè™‘ <code>lw t0, 0(t1)</code>, è¿™ä¸ªæ—¶å€™ <code>t1</code> å¯¹åº”çš„åœ°å€ä¸Šçš„å†…å­˜ä¼šè¢«åŠ è½½åˆ°ç¼“å­˜é‡Œã€‚</p><p>å…·ä½“è€Œè¨€ï¼š<code>t1 contains 0x12F0, Memory[0x12F0] = 99</code></p><ul><li>å¦‚æœä» cache ä¸­æ‰¾åˆ°äº†å¯¹åº”çš„åœ°å€ï¼Œé‚£ä¹ˆç›´æ¥ä» cache ä¸­è¯»</li><li>å¦‚æœ cache miss äº†ï¼Œé‚£ä¹ˆä»å†…å­˜å‘é€åˆ° cacheï¼Œå†ä» cache å‘é€åˆ°ç”¨æˆ·</li></ul><h3 id="ç¼“å­˜æœ¯è¯­"><a href="#ç¼“å­˜æœ¯è¯­" class="headerlink" title="ç¼“å­˜æœ¯è¯­"></a>ç¼“å­˜æœ¯è¯­</h3><p>è¯»ç¼“å­˜çš„æ—¶å€™ï¼Œå¯èƒ½ä¼šæœ‰ä¸‰ç§æƒ…å†µ</p><ul><li>Cache hit: ç¼“å­˜å‘½ä¸­</li><li>cache miss: ç¼“å­˜æœªå‘½ä¸­ï¼Œéœ€è¦ä»ä¸‹å±‚è·å–</li><li>cache miss, block replacement: cache æœªå‘½ä¸­ + éœ€è¦æŠŠåŸæ¥å­˜åœ¨çš„ cache çµ¦æ›¿æ¢æ‰</li></ul><p>ç¼“å­˜æ¸©åº¦</p><ul><li>cold: cache empty, æ²¡æœ‰æ€ä¹ˆåŠ è½½</li><li>warming: Cache filling with values youâ€™ll hopefully be accessing again soon</li><li>Warm: Cache is doing its job, fair % of hits</li><li>Hot: Cache is doing very well, high % of hits</li></ul><p>æ„Ÿè§‰è¿™ä¸ªæ¸©åº¦æœ‰ä¸¤å±‚å«ä¹‰ï¼Œä¸€ä¸ªæ˜¯ç¼“å­˜æœ¬èº«å ç”¨é«˜ï¼Œä¸€ä¸ªæ˜¯ç¼“å­˜å‘½ä¸­ç‡é«˜ã€‚</p><ul><li>hit rate: å‘½ä¸­ç¼“å­˜çš„æ¯”ä¾‹</li><li>miss rate: æœªå‘½ä¸­ç¼“å­˜çš„æ¯”ä¾‹</li><li>miss penalty: ä»ä¸‹ä¸€å±‚åŠ è½½åˆ°ä¸Šä¸€å±‚éœ€è¦çš„æ—¶é—´</li><li>hit time: è®¿é—®ç¼“å­˜çš„æ—¶é—´</li></ul><h3 id="Cache-Miss-çš„å½¢å¼"><a href="#Cache-Miss-çš„å½¢å¼" class="headerlink" title="Cache Miss çš„å½¢å¼"></a>Cache Miss çš„å½¢å¼</h3><p>ä»ä¸Šé¢çš„ Miss æ¥çœ‹ï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°ä¸€äº› cache miss çš„å½¢å¼ï¼š</p><ol><li>compulsory misses: ç¨‹åºå¼€å§‹çš„æ—¶å€™ï¼Œå› ä¸º cold çš„åŸå› ï¼Œå¯¼è‡´çš„ Miss<ol><li>CPU/Cache æ€ä¹ˆè§£å†³çš„æˆ‘ä¸çŸ¥é“ï¼Œä¸è¿‡æˆ‘è®°å¾— Memcache æœ‰ä¸€å®šè§£å†³æ–¹æ¡ˆï¼š<a href="https://zhuanlan.zhihu.com/p/194347153">https://zhuanlan.zhihu.com/p/194347153</a></li></ol></li><li><strong>Conflict Misses</strong>ï¼šå†…å­˜å¯¹åº” cache å¤„äºç›¸åŒçš„ä½ç½®ï¼Œéœ€è¦æŠŠç›®å‰çš„ä¸‹æ‰ï¼Œå¯¼è‡´çš„ Miss</li></ol><h2 id="Cache-çš„é€»è¾‘ç»“æ„"><a href="#Cache-çš„é€»è¾‘ç»“æ„" class="headerlink" title="Cache çš„é€»è¾‘ç»“æ„"></a>Cache çš„é€»è¾‘ç»“æ„</h2><p>æˆ‘ä»¬éœ€è¦è€ƒè™‘ä¸‹é¢å‡ ä¸ªç†æ‰€å½“ç„¶çš„é—®é¢˜ï¼š</p><ul><li>Cache çš„é€Ÿåº¦è¿œè¿œå¤§äºå†…å­˜ï¼Œä½† Cache è¿œè¿œå°äºå†…å­˜</li></ul><p>å› æ­¤ï¼Œä¸‹é¢å°†ç”± direct-mapped cache å¼€å§‹ä»‹ç» cache ç›¸å…³çš„ä¿¡æ¯ã€‚</p><h3 id="Direct-Mapped-Cache"><a href="#Direct-Mapped-Cache" class="headerlink" title="Direct-Mapped Cache"></a>Direct-Mapped Cache</h3><p>åœ¨ direct-mapped cache é‡Œé¢ï¼Œæ¯ä¸ªå†…å­˜åœ°å€ä¼šå…³è”åˆ°ä¸€ä¸ª cache ä¸­çš„ blockï¼Œåªè¦ï¼š</p><ol><li>æŸ¥æ‰¾è¿™ä¸ª block æœ‰æ²¡æœ‰æˆå‘˜</li><li>é‡Œé¢æˆå‘˜æ˜¯ä¸æ˜¯è‡ªå·±çš„å†…å­˜åœ°å€</li></ol><p>ä¸ºäº†å®ç°ä¸Šé¢ä¸¤ä¸ªç›®çš„ï¼Œä¸‹é¢è¿™ç¬¬ä¸€ç« é€»è¾‘çš„å›¾æ˜¯ä¸å¤Ÿçš„ï¼Œå› ä¸º</p><ol><li>æ— æ³•ç¡®è®¤æ¯ä¸ª block å¯¹åº”çš„å†…å­˜æ˜¯å¤šå°‘</li></ol><p><img src="https://image.mwish.me/blog-image/CF5E4D39-E103-4CBC-ABDA-14FEE162EEB6.png" alt="CF5E4D39-E103-4CBC-ABDA-14FEE162EEB6"></p><p>æ‰€ä»¥æˆ‘ä»¬çš„ cache éœ€è¦ä¸€ä¸ª tag:</p><p><img src="https://image.mwish.me/blog-image/BE57BF08-4B6D-41B3-AB83-C9809B02D557.png" alt="BE57BF08-4B6D-41B3-AB83-C9809B02D557"></p><p>è¿™é‡ŒæŠŠä¸€ä¸ªåœ°å€åˆ†æˆäº†ä¸‰éƒ¨åˆ†ï¼š</p><ol><li><strong>tag</strong> to check if have correct block</li><li><strong>index</strong> to select block </li><li>Byte <strong>offset</strong> in block</li></ol><p><img src="https://image.mwish.me/blog-image/D41799EC-8745-4B69-BAA7-2B29CF189709.png" alt="D41799EC-8745-4B69-BAA7-2B29CF189709"></p><p>RV32 çš„è®¨è®ºï¼š</p><ul><li>RV32 åœ°å€ç©ºé—´æ˜¯ 32bits</li><li>å‡è®¾æ¯ä¸ª block æ˜¯ 2-byteï¼Œæˆ‘ä»¬æœ‰ 8Byte çš„ cache<ul><li>offset éœ€è¦ 1bit æ¥è¡¨ç¤º</li><li>index è¡¨ç¤ºå¯¹åº”ä½ç½®ï¼Œéœ€è¦æœ‰ <code>(8 / 2)</code> ä¸ªçŠ¶æ€ï¼Œå³å ç”¨ 2bit</li><li>å‰©ä¸‹çš„ 29bits ä½œä¸º tag</li></ul></li></ul><p>åŒæ—¶ï¼Œå®é™…ä¸Šæˆ‘ä»¬å¯èƒ½æœ‰ä¸€ä¸ª valid bit, å½“ç¨‹åºå¼€å§‹è¿è¡Œçš„æ—¶å€™ï¼Œé™¤äº† 32bitsï¼Œå¯èƒ½éœ€è¦ä¸€ä¸ª valid bitï¼Œè¡¨ç¤ºè¿™æ®µç¼“å­˜ä¸­çš„å†…å­˜å¯¹ç¨‹åºè€Œè¨€æ˜¯å¦æ˜¯ valid çš„ã€‚</p><h3 id="çœŸå®æƒ…å†µä¸å‡è®¾"><a href="#çœŸå®æƒ…å†µä¸å‡è®¾" class="headerlink" title="çœŸå®æƒ…å†µä¸å‡è®¾"></a>çœŸå®æƒ…å†µä¸å‡è®¾</h3><p>æˆ‘ä»¬ç°åœ¨å‡è®¾æˆ‘ä»¬çš„ cache æœ‰ï¼š</p><ol><li>16KB çš„ data</li><li>direct-mapped çš„æ¨¡å¼</li><li>4-word çš„ block</li></ol><p>ç°åœ¨æˆ‘ä»¬æ¥å¯¹ç…§ slice çœ‹çœ‹ direct-mapped çš„è®¿é—®ï¼š</p><p><img src="https://image.mwish.me/blog-image/æˆªå±2020-10-31-ä¸‹åˆ2.42.01.png" alt="æˆªå±2020-10-31 ä¸‹åˆ2.42.01"></p><p>é‚£ä¹ˆï¼Œå…·ä½“çš„è®¿é—®å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://image.mwish.me/blog-image/9FC2703E-B742-4671-B76B-33D8FB1E2ECF.png" alt="9FC2703E-B742-4671-B76B-33D8FB1E2ECF"></p><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œåœ¨æœ€æ—©æˆ‘ä»¬çš„è®¨è®ºä¸­ï¼Œä¸€ä¸ª tag å¯¹åº”ç€å¯èƒ½2-byte çš„å†…å­˜ï¼Œä½†æ˜¯ç°åœ¨ï¼Œæˆ‘ä»¬å¯èƒ½ä¸€ä»½ tag å¯¹åº” ä¸€ä¸ª block, è¿™ä¸ª block å¯èƒ½è£…æœ‰æ¯”è¾ƒå¤šç»„çš„å†…å­˜ã€‚å®é™…ä¸Šï¼Œè¿™æœ‰ç›Šäº localityã€‚</p><h3 id="Write-through-amp-Write-back"><a href="#Write-through-amp-Write-back" class="headerlink" title="Write-through &amp; Write-back"></a>Write-through &amp; Write-back</h3><p>è¿™ä¸¤ç§æ–¹æ¡ˆç›¸ä¿¡é™¤äº†è¿™é‡Œï¼Œæˆ‘ä»¬ä»‹ç»å¾ˆå¤šåˆ«çš„å½¢å¼çš„ cache çš„æ—¶å€™ä½ ä¹Ÿä¼šç¢°è§å®ƒä»¬ï¼šå¥½å§ï¼Œè¿‡å»ã€ç°åœ¨ã€è¿˜æ˜¯å°†æ¥ï¼Œä½ éƒ½ä¼šé‡åˆ°è¿™ä¸¤ä¸ªã€‚</p><ol><li>Write-throughï¼šå†™å…¥çš„æ—¶å€™éœ€è¦æ›´æ–°cache å’Œ memory</li><li>Write-back:<ol><li>å†™å…¥çš„æ—¶å€™æ›´æ–° cache block</li><li>æ·»åŠ ä¸€ä¸ª dirty flag</li><li>OS åœ¨ IO ä¹‹å‰ flush cache</li></ol></li></ol><h3 id="block-size-çš„å¤§å°"><a href="#block-size-çš„å¤§å°" class="headerlink" title="block size çš„å¤§å°"></a>block size çš„å¤§å°</h3><ol><li>Pros:<ol><li>spatial locality: ç©ºé—´ locality å—ç›Š</li><li>å¯¹ array è®¿é—®æœ‰å¥½å¤„</li><li>å¯¹äºç›®å‰ stored-program çš„å½¢å¼æœ‰å¥½å¤„</li></ol></li><li>Cons:<ol><li>å¢åŠ äº† Miss penalty</li><li>If block size is too big relative to cache size, then there are too few blocks</li></ol></li></ol><p><img src="https://image.mwish.me/blog-image/7CF53EBF-159A-42A3-ADF4-68522446BC41.png" alt="7CF53EBF-159A-42A3-ADF4-68522446BC41"></p><h3 id="å…¶ä»–ç±»å‹"><a href="#å…¶ä»–ç±»å‹" class="headerlink" title="å…¶ä»–ç±»å‹"></a>å…¶ä»–ç±»å‹</h3><p>å®é™…ä¸Šï¼Œcache æœ‰å‡ ç§ç»„ç»‡æ–¹å¼ï¼š</p><ul><li>fully associative</li><li>Direct mapped</li><li>N-way Set Associate</li></ul><p>æˆ‘ä»¬ä¼šåœ¨ä¸‹ä¸€ä¸ª part ä»‹ç»ã€‚</p>]]></content>
      
      
      
        <tags>
            
            <tag> system </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SDS Intro &amp; RISC-V Datapath(4): Pipeline</title>
      <link href="/2020/10/21/SDS-Intro-RISC-V-Datapath-4-Pipeline/"/>
      <url>/2020/10/21/SDS-Intro-RISC-V-Datapath-4-Pipeline/</url>
      
        <content type="html"><![CDATA[<p>CPU çš„æ°´å¤ªæ·±äº†â€¦æˆ‘åªèƒ½ä¿è¯ä»‹ç»æ¯”è¾ƒåŸºç¡€çš„ case, éš¾å…è®²å‡ºé—®é¢˜ï¼Œå¸Œæœ›å‡ä»¥æ—¶æ—¥æˆ‘èƒ½å›å¤´è½»æ¾å•ƒä¸‹è¿™å‡ å—å§=ï¼Œ=</p><p>ä¸Šä¸€èŠ‚æˆ‘ä»¬ä»‹ç»äº†æµæ°´çº¿çš„åŸºæœ¬æ¦‚å¿µã€‚ç›¸å¯¹äº Single-Cycle çš„å¤„ç†ï¼Œå¹¶å‡è®¾æˆ‘ä»¬æœ‰æœ€ç®€å•çš„5ä¸ª stage:</p><ol><li>IF: å–æŒ‡</li><li>ID: è¯‘ç </li><li>EX: æ‰§è¡Œ</li><li>MA: è®¿å­˜</li><li>WB: å†™å›</li></ol><p>åœ¨ 15-418 é‡Œé¢ï¼Œåˆ†ä¸ºä¸‹é¢çš„ï¼š</p><ol><li>Fetch â€“ get the next instruction from memory</li><li>Decode â€“ figure out what to do &amp; read inputs</li><li>Execute â€“ perform the necessary operations</li><li>Commit â€“ write the results back to registers / memory</li></ol><p>å½“ç„¶éœ€è¦è¯´æ˜çš„æ˜¯ï¼Œè¿™æ˜¯æ•™å­¦çš„ä¸€ä¸ªéå¸¸ç®€åŒ–çš„ç‰ˆæœ¬ï¼ŒçœŸå® pipeline stage ä¼šæ¯”è¿™ä¸ªå¤šä¸å°‘ã€‚</p><p><img src="https://image.mwish.me/blog-image/DA2AADD6-0808-4DAA-BD9C-8ECF81EB0922.png" alt="DA2AADD6-0808-4DAA-BD9C-8ECF81EB0922"></p><p><img src="https://image.mwish.me/blog-image/image-20201021225437486.png" alt="image-20201021225437486"></p><p>Pipeline çš„åŸºæœ¬æ€è·¯æ˜¯ï¼Œâ€œå› ä¸ºæ¯ä¸ªæŒ‡ä»¤çš„æ¯ä¸ªé˜¶æ®µï¼Œç”¨åˆ°çš„ç»“æ„å¯èƒ½éƒ½æ˜¯ä¸ä¸€æ ·çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å’Œæµæ°´çº¿åŠ å·¥ä¸€æ ·ï¼Œæ¯ä¸ªé˜¶æ®µéƒ½åœ¨å¤„ç†ä¸åŒçš„æŒ‡ä»¤â€ã€‚ä½†æ˜¯è¿™ä¸ªå®ç°èµ·æ¥ç›¸å¯¹ Single-Cycle å°±æœ‰å„ç§å„æ ·çš„æ–°é—®é¢˜äº†ã€‚</p><p><img src="https://image.mwish.me/blog-image/C50EED72-96F2-4434-9A88-62ADA24692C7.png" alt="C50EED72-96F2-4434-9A88-62ADA24692C7"></p><p><strong>Idea1: å‡†å¤‡å¿…è¦çš„ Pipeline registersï¼ŒæŠŠæ¯ä¸ª stage éœ€è¦çš„ control logic å’Œä¸Šä¸€é˜¶æ®µçš„æ•°æ®æ‹†åˆ†å‡ºæ¥ï¼Œè®©ä¸‹ä¸ªé˜¶æ®µèƒ½å¤Ÿæ­£ç¡®çš„è¿è¡Œ</strong></p><p><img src="https://image.mwish.me/blog-image/C60C0E6F-9F9B-4966-A051-DA907C80BB09.png" alt="C60C0E6F-9F9B-4966-A051-DA907C80BB09"></p><p>è¿™é‡Œæœ‰ï¼š</p><ol><li>å­˜å‚¨ä¸‹ä¸€é˜¶æ®µéœ€è¦çš„ inst çš„ å¯„å­˜å™¨</li><li>å­˜å‚¨ä¸‹ä¸€é˜¶æ®µéœ€è¦çš„æ•°æ®æ¥æºï¼Œå¦‚ rs ç­‰å¯„å­˜å™¨</li><li>PC Register</li><li>â€¦</li></ol><p>è€Œcontrol logic ä¹Ÿæ˜¯ç±»ä¼¼â€œå¤šé˜¶æ®µçš„â€ï¼Œæ¥å®Œæˆè¿™ä¸ªæ§åˆ¶ã€‚</p><h2 id="Pipeline-Hazards"><a href="#Pipeline-Hazards" class="headerlink" title="Pipeline Hazards"></a>Pipeline Hazards</h2><blockquote><p>A <em>hazard</em> is a situation that prevents starting the next instruction in the next clock cycle</p></blockquote><p>å’‹ä¸€çœ‹æµæ°´çº¿è¿™ä¹ˆè¿è¡Œå°±å®Œäº†ï¼Œä½†æ˜¯ç»†æƒ³è¿˜æ˜¯ä¼šæœ‰å¾ˆå¤šé—®é¢˜ï¼Œè¿™é‡Œåˆ’åˆ†äº†3ç§ï¼š</p><ol><li>Structural hazard ï¼šDatapath ç»„ä»¶çš„å†²çªï¼Œå¯èƒ½ä¼šæœ‰åŒæ—¶å¯¹memory çš„è¯»/å†™</li><li>Data hazardï¼šå¯„å­˜å™¨ç­‰å†²çªï¼Œæ¯”å¦‚åœ¨ä¸åŒ stage çš„æ•°æ®åŒæ—¶è¯»å†™ä¸€ä¸ª reg</li><li>Control hazard</li></ol><p>è¿™è®©æˆ‘ä»¬ä¸èƒ½ç®€å•çš„å•ä¸ªæŒ‡ä»¤æ‰§è¡Œã€‚</p><h3 id="Structutal-hazard"><a href="#Structutal-hazard" class="headerlink" title="Structutal hazard"></a>Structutal hazard</h3><ul><li><strong>Solution 1:</strong> éœ€è¦å†²çªçš„æŒ‡ä»¤éœ€è¦ stall</li><li><strong>Solution 2:</strong> å¢åŠ ç¡¬ä»¶ï¼ˆä¸‹é¢æˆ‘ä»¬ä¼šçœ‹åˆ°è¿™æ˜¯æ€ä¹ˆå®ç°çš„ï¼‰</li><li>æ°¸è¿œèƒ½é å¢åŠ ç¡¬ä»¶æ¥è§£å†³è¿™ä¸ªé—®é¢˜</li></ul><p>å…·ä½“è€Œè¨€ï¼Œåœ¨ decode stage, å¯ä»¥è¯»åˆ°ä¸¤ä¸ª operand reg; åœ¨writeback é˜¶æ®µï¼Œå¯ä»¥å†™å›ä¸€ä¸ª reg, è¿™ä¸ªæ—¶å€™ä¼šäº§ç”Ÿå†²çªã€‚è¿™ä¸ªæ—¶å€™å¯ä»¥åˆ†ç¦»å¯¹å¯„å­˜å™¨çš„è¯»å†™ portï¼Œæ¥ç»´æŒçŠ¶æ€ã€‚</p><p>è¿™é‡Œè¿˜ç»™å‡ºäº†ä¸€ä¸ªè®¿é—® memory çš„ä¾‹å­ï¼šIF é˜¶æ®µå–æŒ‡ä»¤ï¼ŒMA é˜¶æ®µè®¿é—®å­˜å‚¨ï¼Œé‚£ä¹ˆè¿™ä¸ªå°±æœ‰ä¸€ä¸ªç»“æ„å†²çªäº†ï¼Œè¿™ä¸ªæ—¶å€™è§£å†³æ–¹å¼æ˜¯ï¼š</p><p><img src="https://image.mwish.me/blog-image/BF0AA0B5-DEEF-4564-91FE-56425D9FCC4D.png" alt="BF0AA0B5-DEEF-4564-91FE-56425D9FCC4D"></p><p>æ‰€ä»¥æ€»ç»“ä¸€ä¸‹ï¼ŒRISC-V pipeline å‡ºç° structral hazard ä¸»è¦è¿˜æ˜¯åœ¨äº memory</p><p>æœ€ä½³çš„æ–¹å¼æ˜¯æ‹†åˆ†æŒ‡ä»¤å’Œæ•°æ®çš„è®¿é—®ï¼Œæ‹†åˆ†æˆ IMEM å’Œ DMEMã€‚ï¼ˆæˆ‘åªçŸ¥é“æœ‰ icache å’Œ dcache å°±æ˜¯ï¼‰</p><h3 id="Data-Hazard"><a href="#Data-Hazard" class="headerlink" title="Data Hazard"></a>Data Hazard</h3><p>è¿™é‡Œæ˜¯æŒ‡å¯„å­˜å™¨ä¸Šå‰åæŒ‡ä»¤çš„å†²çªï¼Œå…·ä½“å¦‚ä¸‹å›¾ï¼š</p><p><img src="https://image.mwish.me/blog-image/DC3BC619-FDE7-4B97-9725-B87CDFB82D41.png" alt="DC3BC619-FDE7-4B97-9725-B87CDFB82D41"></p><p>ä½ è¿™ä¼šå„¿ä¼šé—®ï¼Œå’±ä¸æ˜¯å·²ç»åˆ†ç¦» Reg çš„è¯»å†™ port äº†å—ï¼Ÿä¸ºå•¥è¿˜ä¼šè¿™æ ·å‘¢ï¼Ÿåˆ†ç¦»ç«¯å£ä¸ä»£è¡¨åŒä¸€ stage æ—¶é—´æ•°æ®å†™/è¯»èƒ½å¤Ÿæœ‰ç¬¦åˆé¢„æœŸçš„ç»“æœï¼š</p><blockquote><p>Might not always be possible to write then read in same cycle, especially in high-frequency designs. </p></blockquote><p>æˆ‘ä»¬å¸Œæœ›ç»“æœæ˜¯ç¬¦åˆé¢„æœŸçš„ï¼Œå³å’Œé pipeline æ‰§è¡Œæœ‰ç›¸åŒçš„ç»“æœï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±éœ€è¦ç»´æŠ¤è¿™ä¸ªè¯­ä¹‰äº†ã€‚æˆ‘ä»¬éœ€è¦ä¿è¯ï¼š</p><ol><li>å‰é¢å†™å…¥ reg çš„å€¼èƒ½è¢«ä¹‹åçš„æŒ‡ä»¤è¯» reg è¯»åˆ°</li><li>å¯¹åŒä¸€ä¸ª reg ä¸ä¾èµ–åŒä¸€æ—¶é—´çš„è¯»/å†™</li></ol><h4 id="è§£å†³æ–¹å¼1-Stalling"><a href="#è§£å†³æ–¹å¼1-Stalling" class="headerlink" title="è§£å†³æ–¹å¼1: Stalling"></a>è§£å†³æ–¹å¼1: Stalling</h4><p>ï¼ˆå¥½åƒæˆ‘ä»¬å‰é¢å°±è®²äº† stalling ä½†æ˜¯æ²¡é…å›¾ï¼Ÿï¼‰</p><p><img src="https://image.mwish.me/blog-image/E705CCA3-C56F-4F9D-8BFC-5FB231695B80.png" alt="E705CCA3-C56F-4F9D-8BFC-5FB231695B80"></p><p>ä½†æ˜¯ stall ä¼šå¤§å¤§å½±å“æ•ˆç‡ï¼ˆè¿™ä¸ªå¯ä»¥æ‰¾ perfbook, é‡Œé¢æœ‰æ•°æ®ï¼‰ï¼Œä¸è¿‡ç¼–è¯‘å™¨ä¹Ÿå¯ä»¥åˆ†æå¹¶ä¸”æ’å…¥ <code>add x0, x0, 0</code> ä¹‹ç±»çš„ nop</p><h4 id="è§£å†³æ–¹å¼2-Forwarding-bypassing"><a href="#è§£å†³æ–¹å¼2-Forwarding-bypassing" class="headerlink" title="è§£å†³æ–¹å¼2: Forwarding(bypassing)"></a>è§£å†³æ–¹å¼2: Forwarding(bypassing)</h4><p><img src="https://image.mwish.me/blog-image/BF657B4A-8595-4056-B685-3249506D6AFA.png" alt="BF657B4A-8595-4056-B685-3249506D6AFA"></p><p>è¿™ä¸ªæ˜¯çœŸçš„ç‰›é€¼â€¦ä½†æ˜¯è¿™ä¹ˆä¸€æ¥ path å’Œ control æ„Ÿè§‰ä¼šå·¨å¤æ‚..</p><blockquote><p>Compare destination of older instructions in pipeline with sources of new instruction in decode stage.</p></blockquote><p>æ‰€ä»¥éœ€è¦ä¸€ä¸ªå·¨å¤æ‚çš„ forwarding control logic</p><p><img src="https://image.mwish.me/blog-image/848C745D-BCA9-4434-866C-9C2BDDBFFE65.png" alt="848C745D-BCA9-4434-866C-9C2BDDBFFE65"></p><p>åŒæ—¶ï¼Œå³ä½¿è¿™æ ·ï¼Œæˆ‘ä»¬è¿˜æ˜¯éœ€è¦å¿…è¦çš„ stall:</p><p><img src="https://image.mwish.me/blog-image/1E2D7DAB-1F6B-4737-842B-D0E8308B9511.png" alt="1E2D7DAB-1F6B-4737-842B-D0E8308B9511"></p><p>è¿™é‡Œç¬¬äºŒæ¡æŒ‡ä»¤ä¾èµ–ç¬¬ä¸€æ¡æŒ‡ä»¤å†™å…¥å¯„å­˜å™¨çš„å€¼ï¼Œæ‰€ä»¥è¿™ä¸ªéœ€è¦ stall. å½“ç„¶ï¼Œç¼–è¯‘å™¨/CPUèƒ½å¤Ÿå®ŒæˆæŒ‡ä»¤é‡æ’ï¼Œæ¥ä¼˜åŒ–è¿™ä¸ªè¿‡ç¨‹ï¼š</p><p><img src="https://image.mwish.me/blog-image/8398FD99-FE01-40F6-ACD4-08B8901B8C83.png" alt="8398FD99-FE01-40F6-ACD4-08B8901B8C83"></p><h2 id="Control-Hazard"><a href="#Control-Hazard" class="headerlink" title="Control Hazard"></a>Control Hazard</h2><p>è¿™ä¸ªåè€Œæ˜¯æˆ‘æœ€ç†Ÿæ‚‰çš„â€¦</p><p><img src="https://image.mwish.me/blog-image/AFADB924-9D9B-430F-9964-E73CF425A799.png" alt="AFADB924-9D9B-430F-9964-E73CF425A799"></p><p>å…¶å®å¯ä»¥çœ‹çœ‹ likelyï¼Œå½±å“ç¨‹åºçš„ä¼˜åŒ–å„¿ï¼š<a href="https://en.cppreference.com/w/cpp/language/attributes/likely">https://en.cppreference.com/w/cpp/language/attributes/likely</a></p><p>likely ä¼šé™æ€çš„å½±å“ç¨‹åºã€‚</p><blockquote><ul><li>Every taken branch in simple pipeline costs 2 dead cycles</li><li>To improve performance, use â€œbranch predictionâ€ to guess which way branch will go earlier in pipeline</li><li>Only flush pipeline if branch prediction was incorrect</li></ul></blockquote><h3 id="Multiple-issue-â€œSuperscalarâ€"><a href="#Multiple-issue-â€œSuperscalarâ€" class="headerlink" title="Multiple issue â€œSuperscalarâ€"></a>Multiple issue â€œSuperscalarâ€</h3><p><img src="https://image.mwish.me/blog-image/86EE0F79-A6D6-49F2-B66C-87C1115A51BD.png" alt="86EE0F79-A6D6-49F2-B66C-87C1115A51BD"></p><p><img src="https://image.mwish.me/blog-image/5A2207CE-B1FA-4470-92E9-C74B1D922CCF.png" alt="5A2207CE-B1FA-4470-92E9-C74B1D922CCF"></p><p>è¿™é‡Œéœ€è¦ Execute ä¹‹å‰å®ŒæˆåŠ¨æ€è®¡ç®—ï¼Œå¹¶ä¸”å» superscalar çš„æ‰§è¡Œ</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>How to exit task</title>
      <link href="/2020/10/18/How-to-exit-task/"/>
      <url>/2020/10/18/How-to-exit-task/</url>
      
        <content type="html"><![CDATA[<p>å¼€å¯ä¸€ä¸ªçº¿ç¨‹ä¸ç®€å•ï¼Œå…³é—­ä¸€ä¸ªçº¿ç¨‹éº»çƒ¦äº‹æ›´å¤š. C++ 11 æä¾›äº† <code>std::thread</code> çš„æŠ½è±¡ï¼ŒC++20 ç”šè‡³æä¾›äº† coroutine. æˆ‘ä»¬çš„èƒŒåå¯èƒ½æ˜¯ POSIX thread åœ¨å†…çš„å„ç§å¹³å°çš„çº¿ç¨‹ã€‚åŒæ—¶æˆ‘ä»¬ä¹Ÿæœ‰ä»»åŠ¡å¼çš„çº¿ç¨‹ api, ä¾‹å¦‚ <code>future</code> <code>promise</code> å¯¹åº”çš„æ¥å£ã€‚åœ¨ Go è¯­è¨€ä¸­ï¼Œæˆ‘ä»¬ç”šè‡³èƒ½ä»¥ä¸€ç§æ›´ä¾¿æ·çš„æ–¹å¼ï¼Œä»¥è¯­æ³•æ”¯æŒçš„å½¢å¼åˆ›å»º goroutine, å¹¶ä»¥ CSP çš„æ¨¡å¼æ¥é€šä¿¡ã€‚è€ŒèƒŒåçš„åŸç”Ÿçº¿ç¨‹æ˜¯éšåŒ¿çš„ã€‚</p><p>å¯¹äº C++11 <code>&lt;thread&gt;</code> è€Œè¨€ï¼Œçº¿ç¨‹æŠ½è±¡ä¸ <code>std::thread</code> æ˜¯ç»‘å®šçš„. æœ€å¥½çš„é˜…è¯»åœ°ç‚¹åœ¨ï¼š</p><p><a href="https://en.cppreference.com/w/cpp/thread/thread">https://en.cppreference.com/w/cpp/thread/thread</a> </p><blockquote><p>delays), starting at the top-level function provided as a <a href="https://en.cppreference.com/w/cpp/thread/thread/thread">constructor argument</a>. The return value of the top-level function is ignored and if it terminates by throwing an exception, <a href="https://en.cppreference.com/w/cpp/error/terminate">std::terminate</a> is called. The top-level function may communicate its return value or an exception to the caller via <a href="https://en.cppreference.com/w/cpp/thread/promise">std::promise</a> or by modifying shared variables (which may require synchronization, see <a href="https://en.cppreference.com/w/cpp/thread/mutex">std::mutex</a> and <a href="https://en.cppreference.com/w/cpp/atomic/atomic">std::atomic</a>)</p><p><code>std::thread</code> objects may also be in the state that does not represent any thread (after default construction, move from, <a href="https://en.cppreference.com/w/cpp/thread/thread/detach">detach</a>, or <a href="https://en.cppreference.com/w/cpp/thread/thread/join">join</a>), and a thread of execution may be not associated with any <code>thread</code> objects (after <a href="https://en.cppreference.com/w/cpp/thread/thread/detach">detach</a>).</p><p>No two <code>std::thread</code> objects may represent the same thread of execution; <code>std::thread</code> is not <a href="https://en.cppreference.com/w/cpp/named_req/CopyConstructible"><em>CopyConstructible</em></a> or <a href="https://en.cppreference.com/w/cpp/named_req/CopyAssignable"><em>CopyAssignable</em></a>, although it is <a href="https://en.cppreference.com/w/cpp/named_req/MoveConstructible"><em>MoveConstructible</em></a> and <a href="https://en.cppreference.com/w/cpp/named_req/MoveAssignable"><em>MoveAssignable</em></a>.</p></blockquote><p>å…¶ä¸­ï¼Œæˆ‘ä»¬ä¹Ÿè¦å…³æ³¨çº¿ç¨‹çš„ææ„ï¼š<a href="https://en.cppreference.com/w/cpp/thread/thread/~thread">https://en.cppreference.com/w/cpp/thread/thread/~thread</a></p><p>åœ¨ææ„çš„æ—¶å€™ï¼Œå¦‚æœçº¿ç¨‹æ˜¯ <code>joinable</code> çš„ï¼Œè¿™é‡Œä¼šè°ƒç”¨ <code>std::terminate</code>: <a href="https://zh.cppreference.com/w/cpp/error/terminate">https://zh.cppreference.com/w/cpp/error/terminate</a></p><p>å½“ç„¶ï¼Œä½ å¯ä»¥ç”¨ä»»åŠ¡å¼çš„ api, ä¾‹å¦‚ <a href="https://en.cppreference.com/w/cpp/thread/async">https://en.cppreference.com/w/cpp/thread/async</a> , è®©ç¨‹åºè‡ªå·±å†³å®šä»€ä¹ˆæ—¶å€™å¯åŠ¨çº¿ç¨‹ï¼ŒæŒ‡å®šå¯¹åº”çš„æ‰§è¡Œç­–ç•¥ã€‚</p><p>é˜…è¯»ä¸Šé¢ä¸€æ®µè¯ï¼Œä½ ä¼šå‘ç°ä¸€ç‚¹ï¼š<code>joinable</code> çš„ <code>thread</code> ä¼š <code>terminate</code>. åŒæ—¶ä½ å¯èƒ½ä¼šæ³¨æ„åˆ°ï¼ŒC++20 ä¸­ï¼Œæä¾›äº†   jthread <a href="https://en.cppreference.com/w/cpp/thread/jthread">https://en.cppreference.com/w/cpp/thread/jthread</a> . å…³äºä½¿ç”¨ï¼Œå…¶å®å¯ä»¥å‚è€ƒ CppCoreGuildlines: <a href="https://www.modernescpp.com/index.php/c-core-guidelines-taking-care-of-your-child-thread">https://www.modernescpp.com/index.php/c-core-guidelines-taking-care-of-your-child-thread</a></p><p>å¯¹ï¼Œä½ ä¼šå¼€å§‹æ„è¯†åˆ°ï¼Œå¼€å¯ä¸€ä¸ªçº¿ç¨‹æˆ–è®¸æœ‰ä¸€äº›å°å‘ï¼Œä½†æ˜¯ä»çº¿ç¨‹é€€å‡ºå…¶å®æ›´éº»çƒ¦ï¼Œä½ åœ¨ä¸€ä¸ª noexcept çš„åœ°æ–¹æŠ›å‡º <code>std::terminate</code>, é‚£ä½ å°±ç­‰æ­»å§ã€‚</p><h2 id="é€€å‡ºçš„ç›®çš„"><a href="#é€€å‡ºçš„ç›®çš„" class="headerlink" title="é€€å‡ºçš„ç›®çš„"></a>é€€å‡ºçš„ç›®çš„</h2><p>ä½ å¯èƒ½éœ€è¦ï¼š</p><ol><li><code>anyOf</code>ï¼Œè®¡ç®—å‡ºæœ€å¿«çš„ä¸€ä¸ªä»»åŠ¡</li><li>æˆ‘ä¸å†éœ€è¦è¿™ä¸ªä»»åŠ¡äº†</li></ol><p>é‚£ä¹ˆæˆ‘ä»¬å¯èƒ½æƒ³åˆ°ä¸¤ä¸ªæ–¹æ¡ˆï¼š</p><ol><li>å‡è£…è‡ªå·±æ˜¯é¸µé¸Ÿï¼Œä¸ç®¡ä¹‹å‰åˆ«çš„ thread</li><li>å…¨éƒ¨ kill/terminate æ‰</li></ol><p>ç¬¬ä¸€ä¸ªåœ¨ C++ å¯èƒ½ä¼šæœ‰ lifetime é—®é¢˜å“Ÿï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">Resource ...</span><br><span class="line"><span class="keyword">for</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ &#123;</span><br><span class="line">Compute</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (ok) &#123;</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆä½ ä¼šå¼€å§‹å¤´ç–¼äº†ï¼ŒåŒæ ·ï¼Œå‡è®¾ç”šè‡³å­˜åœ¨å¼•ç”¨è®¡æ•°çš„æ—¶å€™ï¼Œå¯¹ï¼Œå‡è®¾åœ¨ Go è¯­è¨€ï¼Œä½ è¿˜ä¼šé¢å¯¹ <code>Goroutine æ³„æ¼</code> çš„é—®é¢˜ï¼Œä½ ä¹Ÿè¦å¼€ä¸€ä¸ª Goroutine, æ¥å—ä»»åŠ¡å®Œæˆ flag, å›æ”¶å¯èƒ½çš„èµ„æºã€‚</p><p>ç¬¬äºŒä¸ªæ˜¯ <code>terminate</code>, æˆ–è€…ç”šè‡³æ‹¿åˆ° native çš„ posix api, æ¥ terminate å®ƒï¼Œä½†æ˜¯ä¸‹é¢é—®é¢˜æ¥äº†ï¼š</p><ol><li>è¿˜æ˜¯èµ„æºï¼Œèµ„æºæ³„æ¼</li><li><code>__force_unwind</code> å‘¢ï¼Ÿ<code>noexcept</code> å‘¢ï¼Ÿå…¨ç‚¸äº†ï¼Ÿ</li></ol><p>è¿™é‡Œéšå«è¿™è¿™ä¹ˆä¸€ç‚¹ï¼šä½ æ— æ³•æ— ç—›çš„ç»ˆæ­¢çº¿ç¨‹</p><h2 id="cancel-ä½ è¯¥ç»“æŸäº†"><a href="#cancel-ä½ è¯¥ç»“æŸäº†" class="headerlink" title="cancel: ä½ è¯¥ç»“æŸäº†"></a>cancel: ä½ è¯¥ç»“æŸäº†</h2><p>ç°åœ¨æˆ‘ä»¬ç»•å¼€çº¿ç¨‹ï¼Œå›åˆ°çº¿ç¨‹æ± ï¼Œå®ƒæ˜¯æ€ä¹ˆç»ˆæ­¢çº¿ç¨‹çš„å‘¢ï¼Ÿ</p><p>å‡è®¾æˆ‘ä»¬åœ¨ä¸€ä¸ªå¾ˆå¤§çš„çº¿ç¨‹æ± å­é‡Œï¼Œé‚£ä¹ˆ Pool è¦ destruct äº†ï¼Œè¿™æ˜¯ä¸€ä¸ªå¾ˆå¸¸è§çš„åœºæ™¯ã€‚æˆ‘ä»¬çœ‹çœ‹æŸäº›å®ç°ï¼Œå¯èƒ½ä¼šå‘ç° </p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">atomic&lt;<span class="type">bool</span>&gt; stop_flag;</span><br><span class="line"></span><br><span class="line"><span class="built_in">cancel</span>() &#123;</span><br><span class="line">stop_flag = <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">loop</span>() &#123;</span><br><span class="line"><span class="keyword">while</span> (stop_flag.<span class="built_in">load</span>()) &#123;</span><br><span class="line">..</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// handle exit</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>stop_flag</code> æ˜¯ä¸€ç§å¾ˆå¸¸è§çš„æ¨¡å¼ï¼Œç”šè‡³ä¹Ÿå¯ä»¥åŠ ä¸Šä¸€ä¸ªå…±äº«çš„æ± å­ä¸Šçš„ <code>notify</code> å’Œ <code>wait</code> çš„ cv. ç„¶åcv è‡ªå·±æœ‰ barrier è¯­ä¹‰ï¼Œä¸è¿‡å¤§æ„éƒ½æ˜¯ä¸€æ ·çš„ï¼šä½ åœ¨çº¿ç¨‹è°ƒç”¨çš„åœ°æ–¹æä¾› cancel flagã€‚å½“ç„¶æˆ‘ä»¬ä¹Ÿèƒ½å¤Ÿæä¾› Poison è¿™æ ·çš„æ¶ˆæ¯ï¼Œæ¥ä¿æŒè¿™ä¸ªå±‚é¢çš„ stop è¯­ä¹‰ã€‚</p><h2 id="Blockingï¼Ÿ"><a href="#Blockingï¼Ÿ" class="headerlink" title="Blockingï¼Ÿ"></a>Blockingï¼Ÿ</h2><p>ä¸Šé¢è¯­ä¹‰æ˜¯å¾ˆæ¸…æ™°çš„ï¼Œä½†æ˜¯å¦‚æœç¢°åˆ° IO å‘¢ï¼Ÿåˆæ¥äº†ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">do_something</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">catch</span>(thread_interrupted&amp;)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">handle_interruption</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘ä»¬åˆå›æ¥äº†ï¼Œæ‰‹åŠ¨ interruptï¼ŒRAIIâ€¦å› ä¸ºæœ¬è´¨ä¸Šï¼Œblocking è¿™è¿˜æ˜¯ä¸ªé—®é¢˜ã€‚</p><h2 id="æ²¡æœ‰æ— ç—›çš„æ–¹å¼ï¼šå¯-cancel-çš„ä»»åŠ¡"><a href="#æ²¡æœ‰æ— ç—›çš„æ–¹å¼ï¼šå¯-cancel-çš„ä»»åŠ¡" class="headerlink" title="æ²¡æœ‰æ— ç—›çš„æ–¹å¼ï¼šå¯ cancel çš„ä»»åŠ¡"></a>æ²¡æœ‰æ— ç—›çš„æ–¹å¼ï¼šå¯ cancel çš„ä»»åŠ¡</h2><p>æˆ‘ä»¬çœ‹åˆ°äº†çº¿ç¨‹æ§åˆ¶çš„å›°éš¾æ€§ï¼ŒåŒæ—¶ï¼Œæˆ‘ä»¬ä¹Ÿèƒ½æ„è¯†åˆ°ï¼Œè¯­æ³•ä¸Š Go ä¸æš´éœ² <code>thread</code> æœ¬èº«çš„æ¥å£ï¼Œæ‰€ä»¥å®ƒä¼šç”¨ context æ¨¡å¼æ¥ä¼ é€’ä¿¡æ¯ï¼š</p><p><a href="https://zhuanlan.zhihu.com/p/107930946">https://zhuanlan.zhihu.com/p/107930946</a></p><p>è€ŒC#ä¹Ÿæä¾›äº†ç±»ä¼¼çš„æ¥å£ï¼Œè¦æŠŠ cancel çš„ä¿¡æ¯ä¼ ä¸‹å»</p><p>è¿™æ„å‘³ç€ï¼Œæˆ‘ä»¬æŸç§æ„ä¹‰ä¸Šï¼Œæ˜¯è¦å¯¹ä»»åŠ¡è¿›è¡Œä¾µå…¥çš„ï¼Œæˆ‘ä»¬å¯ä»¥å‚è€ƒ <a href="https://github.com/mapleFU/CPP-Concurrency-In-Action-2ed-2019/blob/master/content/chapter9/9.2-chinese.md">C++ Concurrency In Action ç¬¬äºŒç‰ˆ</a> ï¼Œè¿™é‡Œå¯¹ç›¸å…³çš„ç¼–ç¨‹å†…å®¹è¿›è¡Œäº†å…¥ä¾µã€‚</p><h2 id="éš”ç¦»ï¼šæˆ–è®¸æˆ‘éœ€è¦è¿›ç¨‹"><a href="#éš”ç¦»ï¼šæˆ–è®¸æˆ‘éœ€è¦è¿›ç¨‹" class="headerlink" title="éš”ç¦»ï¼šæˆ–è®¸æˆ‘éœ€è¦è¿›ç¨‹"></a>éš”ç¦»ï¼šæˆ–è®¸æˆ‘éœ€è¦è¿›ç¨‹</h2><p>å›åˆ°ä¹‹å‰çš„é—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦åœæ­¢ï¼Œå¯èƒ½æŸç§æ„ä¹‰ä¸Šä¸æ­¢éœ€è¦â€œå¹¶å‘æ‰§è¡Œä»»åŠ¡â€ï¼Œè¿˜éœ€è¦â€œå…¥ä¾µæ‰§è¡Œä»»åŠ¡çš„é€»è¾‘â€ã€‚è¿™é‡Œï¼Œæˆ‘ä»¬å¯ä»¥çªç„¶æƒ³åˆ°ï¼Œä¸€ç›´ä»¥æ¥è¿™ç¯‡æ–‡ç« éƒ½åœ¨çº ç»“çº¿ç¨‹ï¼Œä½†æ˜¯è¿›ç¨‹ç”± OS æä¾›äº†æ›´å¥½çš„éš”ç¦»å’Œé€šä¿¡æœºåˆ¶ã€‚åŠ å…¥æˆ‘ä»¬å¼•å…¥äº†æŸä¸ªåº“ï¼Œæœ‰ä¸€ä¸ª <code>ComputeHeavy</code> å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°ä¼šè°ƒç”¨å¾ˆé‡çš„è®¡ç®—ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯èƒ½ä¸å¤ªå¥½ä¾µå…¥ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>condition_variable_any</code> åŠ ä¸Š <code>future</code> , ä½†åŒæ—¶ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥è€ƒè™‘ç”¨è¿›ç¨‹ï¼Œå®ƒæä¾›çš„æ˜¯æ›´å¥½çš„éš”ç¦»ã€èµ„æºå›æ”¶ç­‰æœºåˆ¶ã€‚</p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ol><li><a href="https://github.com/mapleFU/CPP-Concurrency-In-Action-2ed-2019/blob/master/content/chapter9/9.2-chinese.md">C++ Concurrency In Action ç¬¬äºŒç‰ˆ</a></li><li><a href="https://stackoverflow.com/questions/10834469/terminating-blocking-io-in-linux-c">https://stackoverflow.com/questions/10834469/terminating-blocking-io-in-linux-c</a></li><li><a href="https://zhuanlan.zhihu.com/p/143564479">https://zhuanlan.zhihu.com/p/143564479</a></li></ol>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>SDS Intro &amp; RISC-V Datapath(3): Control logic and metric</title>
      <link href="/2020/10/18/SDS-Intro-RISC-V-Datapath-3-Control-logic-and-metric/"/>
      <url>/2020/10/18/SDS-Intro-RISC-V-Datapath-3-Control-logic-and-metric/</url>
      
        <content type="html"><![CDATA[<p>ä¹‹å‰çš„ part2 æˆ‘ä»¬å¿½ç•¥äº†æ§åˆ¶é€»è¾‘æ˜¯æ€ä¹ˆå®ç°çš„ï¼ŒæŠŠå®ƒå½“æˆä¸€ä»¶ç†æ‰€å½“ç„¶çš„äº‹æƒ…ã€‚æˆ‘ä»¬å¯ä»¥çœ‹çœ‹ control logic åœ¨å¤„ç†å™¨ä¸­å¯¹åº”çš„ä½ç½®ï¼š</p><p><img src="https://image.mwish.me/blog-image/ADDF3668-C609-432C-96F9-63C9B78E8CCF.png" alt="ADDF3668-C609-432C-96F9-63C9B78E8CCF"></p><p>ä¸Šé¢çš„ control å¯¹åº”çš„å°±æ˜¯ä¸‹å›¾ä¸­äº§ç”Ÿå¿…è¦ç”µä¿¡å·çš„é€»è¾‘ï¼š</p><p><img src="https://image.mwish.me/blog-image/DF8C886C-04EF-42C2-A69A-D20F534363A7.png" alt="ADDF3668-C609-432C-96F9-63C9B78E8CCF"></p><p>å…¶ä¸­ï¼Œ Control Logic æœ‰å¯¹åº”çš„é€»è¾‘è¡¨ï¼š</p><p><img src="https://image.mwish.me/blog-image/44925410-7F57-443E-A74B-C71AC1884ECD.png" alt="44925410-7F57-443E-A74B-C71AC1884ECD"></p><p>å®ƒä¼šæ ¹æ®æŒ‡ä»¤çš„ç±»å‹æ¥åˆ¤æ–­ï¼Œè€ŒæŒ‡ä»¤çš„ç±»å‹æœ‰æŒ‡ä»¤ä¸­å›ºå®šçš„å­—æ®µæ¥å†³å®šã€‚</p><p><img src="https://image.mwish.me/blog-image/0D2C5051-0955-48A2-AC6F-861B8E04E442.png" alt="0D2C5051-0955-48A2-AC6F-861B8E04E442"></p><p>é‚£ä¹ˆï¼Œå®é™…ä¸Šå¯¹åº”çš„å¦‚ä¸Šæ‰€ç¤ºï¼Œäº¤ç»™ <code>Inst</code> <code>BrEq</code> <code>BrLT</code> ä¹‹åï¼Œä¸åŒçš„ç”µè·¯ä¼šå¤„ç†ä»¥ä¸Šå†…å®¹ï¼Œäº§ç”Ÿä¸åŒçš„ä¿¡å·ï¼Œä¾›ç»™ ALU ç­‰ä½¿ç”¨ã€‚</p><h2 id="æ—¶é—´åº¦é‡"><a href="#æ—¶é—´åº¦é‡" class="headerlink" title="æ—¶é—´åº¦é‡"></a>æ—¶é—´åº¦é‡</h2><p><img src="https://image.mwish.me/blog-image/92C92D5E-3049-4CFC-9326-7A69F78D4A4A.png" alt="92C92D5E-3049-4CFC-9326-7A69F78D4A4A"></p><p>åœ¨ä¸€ä¸ª clock ä¸­ï¼Œå¯¹åº”çš„æŒ‡ä»¤æ‰§è¡Œé€»è¾‘å¤§æ¦‚å¦‚ä¸Šæ‰€ç¤ºï¼Œé‚£ä¹ˆï¼Œå®é™…ä¸Š</p><p><img src="https://image.mwish.me/blog-image/B0489346-356B-4449-AEFE-E30566ECF371.png" alt="B0489346-356B-4449-AEFE-E30566ECF371"></p><p>æœ€å¤§çš„æ—¶é’Ÿå‘¨æœŸï¼Œå³èµ° <code>lw</code> çš„ï¼Œä¸ºï¼š</p><p><code>f_max = 1/800ps = 1.25GHz</code></p><p>å®é™…ä¸Šï¼ŒæŒ‡ä»¤æ‰§è¡Œçš„é€Ÿåº¦æ¯”è¿™è¿˜å¿«ï¼Œä¼šåˆ°æ¯ç§’å®Œæˆ 5billion çš„ add ã€‚è¿™å½’åŠŸäºæµæ°´çº¿ã€‚</p><p>é‚£ä¹ˆå¯¹äº CPU æ¥è¯´ï¼Œä»€ä¹ˆç®—è¡¡é‡æ ‡å‡†å‘¢ï¼Ÿæˆ‘çš„ 3800X ä¸ºå•¥å•æ ¸é‚£ä¹ˆç‰›é€¼å‘¢ï¼ˆè¯¯ï¼‰ï¼Ÿæ ‡å‡†ä¸»è¦æœ‰ï¼š</p><ul><li>Latency: ç¨‹åºéœ€è¦æ‰§è¡Œçš„æ—¶é—´</li><li>Throughput: ç¨‹åºä¸€å°æ—¶èƒ½å¤Ÿå¤„ç†çš„è¯·æ±‚æ•°é‡</li></ul><p>å³ï¼š</p><p><img src="https://image.mwish.me/blog-image/8A5BDE2B-FF96-4972-A607-E6E9EFBBF0D0.png" alt="8A5BDE2B-FF96-4972-A607-E6E9EFBBF0D0"></p><p>é‚£ä¹ˆï¼Œå…·ä½“åˆ° CPU å±‚æ¬¡è€Œè¨€ï¼Œæ€§èƒ½ã€Clock cycles per Instructionï¼ˆå³ CPIï¼‰ è¿™äº›ä¼šæœ‰ï¼š</p><ul><li>ISA</li><li>å¤„ç†å™¨çš„å®ç°ï¼ˆè¿™é‡Œä»‹ç»çš„ RISC-V çš„ CPI ä¸º1ï¼‰</li><li>Superscalar processors, CPI &lt; 1</li></ul><p>è¿™äº›å†³å®šæœ¬èº«å½±å“äº† CPiã€‚è€Œ Time per Cycle æœ¬èº«ä¼šè¢«ä¸‹åˆ—å†…å®¹å½±å“ï¼š</p><ol><li>å¤„ç†å™¨çš„ microarchitecture</li><li>æŠ€æœ¯ï¼Œ14nm æˆ–è€… 28nm</li><li>è€—ç”µ</li></ol><h3 id="Pipeline"><a href="#Pipeline" class="headerlink" title="Pipeline"></a>Pipeline</h3><p><img src="https://image.mwish.me/blog-image/9004ADA4-1562-4A46-A343-F5E5DCEBE907.png" alt="9004ADA4-1562-4A46-A343-F5E5DCEBE907"></p><p>æŠŠæ‰€æœ‰æŒ‡ä»¤çš„è€—æ—¶å½“æˆä¸€è‡´çš„ï¼Œç„¶åç”¨æµæ°´çº¿çš„æ–¹å¼æ‰§è¡Œã€‚å› ä¸ºæ¯ä¸ªåŸä»¶åªè¾“å‡ºä¸Šä¸€ä¸ªstateçš„çŠ¶æ€ï¼Œè¿™äº› state æ˜¯å¯ä»¥éš”ç¦»çš„ã€‚</p><p>æµæ°´çº¿<strong>å¹¶ä¸é™ä½ Latency, è€Œæ˜¯å¢å¤§ååé‡</strong>ã€‚</p><p>ä½†æ˜¯ï¼Œæµæ°´çº¿å¹¶ä¸æ˜¯æœ‰å‡ é˜¶æ®µå°±ä¼šå˜å¿«å‡ å€ï¼Œå®é™…ä¸Šï¼Œå¡«å……æµæ°´çº¿çš„æ—¶é—´å’Œ branchï¼Œé™ä½äº†æµæ°´çº¿çš„å¯èƒ½æå‡ã€‚</p><h3 id="Pipeline-is-not-free"><a href="#Pipeline-is-not-free" class="headerlink" title="Pipeline is not free"></a>Pipeline is not free</h3><ul><li>pipeline stage å¦‚æœæ˜¯ä¸å¹³è¡¡çš„ï¼Œå¯èƒ½ä¼šæ¯”è¾ƒæ…¢</li><li>å¯„å­˜å™¨çš„ setup time å’Œ clk-&gt;q çš„æ—¶é—´å¯èƒ½ä¼šæ‹–æ…¢</li></ul><p>pipeline çš„ task å¦‚æœæœ‰ dependency, æ¯”å¦‚ä¹‹å‰æŸä¸ªæŒ‡ä»¤ä¾èµ–æŸä¸ªå¯„å­˜å™¨ï¼Œå¯„å­˜å™¨ä¸Šçš„å€¼åˆè¢«åç»­æŒ‡ä»¤ä¿®æ”¹ï¼Œé‚£ä¹ˆä¼šæœ‰ dependency, è¿™ä¸ªä¼šé€ æˆæµæ°´çº¿çš„ stallã€‚</p><p>é’ˆå¯¹æ—¶é—´ä¸å¹³è¡¡ï¼Œä¾‹å¦‚ ALU 100ps, memory load 200psï¼Œè¿™ä¸ªéœ€è¦æŠ¹å¹³è¿™ç§æ—¶é—´ï¼Œä¾‹å¦‚ä¹‹å‰çš„ <code>t_cycle</code>, éƒ½æ•´æˆ 200ps å°±è¡Œäº†ï¼š</p><p><img src="https://image.mwish.me/blog-image/272C5EF5-4B23-49A9-8088-71751B5A9BD0.png" alt="272C5EF5-4B23-49A9-8088-71751B5A9BD0"></p><p>æˆ‘ä»¬ä¼šåœ¨ä¸‹ä¸€èŠ‚è®¨è®º Pipeline çš„å…·ä½“å®ç°ç»†èŠ‚ï¼Œç°åœ¨å…ˆè·³è¿‡ä¸è¡¨ã€‚</p><h2 id="Superscalar-Processor"><a href="#Superscalar-Processor" class="headerlink" title="Superscalar Processor"></a>Superscalar Processor</h2><p>CPU çš„ clock rate ç”±æŠ€æœ¯å’Œç”µæºé™åˆ¶ï¼Œæµæ°´çº¿å¯ä»¥å¢åŠ é˜¶æ®µï¼Œä½†æ˜¯æœ‰å¦‚ä¸‹ trade-off:</p><ul><li>æ¯ä¸ªé˜¶æ®µåšçš„äº‹æƒ…å°‘ï¼Œclock cycle ä¼šå‡å°</li><li>ä½†æ˜¯æ½œåœ¨çš„ hazard ä¼šå¢åŠ </li></ul><p>æ‰€ä»¥å¯ä»¥è€ƒè™‘ç”¨ superscalar å¤„ç†å™¨ï¼š</p><ul><li>æŠŠ pipeline stage å˜æˆå¤šä¸ªæµæ°´çº¿</li><li>æ¯ä¸ªæ—¶é’Ÿå‘¨æœŸæ‰§è¡Œå¤šä¸ªæŒ‡ä»¤</li><li>CPI &lt; 1, so use Instructions Per Cycle (IPC)</li><li>å› ä¸ºå¤šä¸ªæµæ°´çº¿ï¼Œæ‰€ä»¥å¯èƒ½çš„ dependency å‡å°äº†</li></ul><p>æ­¤å¤–ï¼Œè¿˜å¯ä»¥ä¹±åº(<strong>Out-of-Order</strong>) çš„æ‰§è¡Œï¼š</p><blockquote><p>Reorder instructions dynamically in hardware to reduce impact of hazards:â€¨ EG, memory/cache misses</p></blockquote><p>x86 åªæœ‰ StoreLoad ä¹±åºï¼Œä¸è¿‡å¯ä»¥æ‰§è¡Œçš„ä¹±åºæƒ³å¿…æ›´å¤š</p><p><img src="https://image.mwish.me/blog-image/EE918A8C-2D4B-4A42-A969-CAADBF62C2ED.png" alt="EE918A8C-2D4B-4A42-A969-CAADBF62C2ED"></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>SDS Intro &amp; RISC-V Datapath(2): Datapath</title>
      <link href="/2020/10/15/SDS-Intro-RISC-V-Datapath-2-Datapath/"/>
      <url>/2020/10/15/SDS-Intro-RISC-V-Datapath-2-Datapath/</url>
      
        <content type="html"><![CDATA[<p>RV32I éœ€è¦çš„çŠ¶æ€æœ‰ï¼š</p><ul><li><code>x0</code> - <code>x31</code> çš„å¯„å­˜å™¨<ul><li>æ¯ä¸€ä¸ªæ˜¯ 32bits, 32 ä¸ªå¯„å­˜å™¨</li><li>ç”± <code>rs1</code> <code>rs2</code> å’Œ <code>rd</code> ç¡®å®š</li><li>å¯¹ <code>x0</code> çš„å†™ä¼šè¢«å¿½ç•¥</li></ul></li><li><code>PC</code></li><li>å†…å­˜<ul><li>åœ¨ä¸€ä¸ª32bitsçš„åœ°å€ç©ºé—´é‡Œï¼Œå­˜æœ‰æŒ‡ä»¤å’Œæ•°æ®</li></ul></li></ul><h3 id="One-Instruction-Per-Cycle-RISC-V-Machine"><a href="#One-Instruction-Per-Cycle-RISC-V-Machine" class="headerlink" title="One-Instruction-Per-Cycle RISC-V Machine"></a>One-Instruction-Per-Cycle RISC-V Machine</h3><ul><li>ç°æœ‰çš„çŠ¶æ€è¾“å‡ºå’Œè¾“å…¥èµ°åˆ° combinational logic, åœ¨ä¸‹ä¸ª clock edge ä¹‹å‰è®¾ç½®å¥½ä¸‹ä¸€ä¸ªçŠ¶æ€çš„å€¼</li><li>clock edge åˆ°æ¥æ—¶ï¼Œæ‰€æœ‰çš„çŠ¶æ€éƒ½ä¼šè¢«è¾“å‡ºæ›´æ–°ï¼Œç„¶åæ‰§è¡ŒçŠ¶æ€è½¬ç§»åˆ°</li><li>æŒ‡ä»¤å’Œæ•°æ®çš„å†…å­˜æ˜¯åˆ†å¼€çš„ï¼Œä¸ºäº†ç®€åŒ–ï¼Œå†…å­˜æ˜¯å¼‚æ­¥è¯»å–çš„ï¼Œå†™å…¥æ˜¯åŒæ­¥çš„</li></ul><p>æŠ½è±¡çš„é€»è¾‘å›¾å¦‚ä¸‹ï¼š</p><p><img src="https://image.mwish.me/blog-image/F301427F-471C-402E-A586-55FA9CC3B3D1.png" alt="F301427F-471C-402E-A586-55FA9CC3B3D1"></p><h2 id="Instruction-phase"><a href="#Instruction-phase" class="headerlink" title="Instruction phase"></a>Instruction phase</h2><p><img src="https://image.mwish.me/blog-image/9230AA3F-BFD9-4352-831A-F67E7BFDEFEA.png" alt="9230AA3F-BFD9-4352-831A-F67E7BFDEFEA"></p><p>æˆ‘ä»¬å¤„ç†ä¸€æ¡æŒ‡ä»¤ï¼Œå¯ä»¥åˆ’åˆ†ä¸ºä¸‹é¢è¿™äº›é˜¶æ®µï¼š</p><ol><li>å–æŒ‡</li><li>Decode/Register Read</li><li>Execute</li><li>Memory</li><li>Register Write</li></ol><p>ç°åœ¨ï¼Œæˆ‘ä»¬æ¥å®ç° <code>add</code>, ä¸Šä¸€èŠ‚æˆ‘ä»¬ä»‹ç»äº† <code>add</code> ALU å¯¹åº”çš„é€»è¾‘ï¼Œç°åœ¨éœ€è¦çœ‹çœ‹ <code>add</code> å…¨æµç¨‹äº†ï¼š</p><p><img src="https://image.mwish.me/blog-image/157C17E9-E5BA-486B-BF10-AD307C97F30F.png" alt="157C17E9-E5BA-486B-BF10-AD307C97F30F"></p><p>è¿™ä¸ªåœ°æ–¹ä¸æ¶‰åŠ memory, éœ€è¦åšçš„äº‹æƒ…æ˜¯ï¼š</p><ol><li><code>rd = rs1 + rs2</code></li><li><code>PC = PC + 4</code></li></ol><p><img src="https://image.mwish.me/blog-image/1BCA41B9-F017-45C7-8B61-6D865F74CE31.png" alt="1BCA41B9-F017-45C7-8B61-6D865F74CE31"></p><p><code>RegWEn</code> æ§åˆ¶æ˜¯å¦å†™å¯„å­˜å™¨ï¼Œè¿™æ˜¯æ ¹æ®æŒ‡ä»¤å†³å®šçš„ã€‚</p><ol><li>Clock edge è§¦å‘ PC å˜åŒ–</li><li>IMEM å˜åŒ–ï¼Œå–åœ°å€</li><li><code>Reg[]</code> å˜åŒ–ï¼ŒClock è§¦å‘åè¾“å‡ºåˆ° ALU</li><li>å†™ä¼š <code>rd</code></li></ol><p>é‚£ä¹ˆï¼Œè¦å®ç° sub, éœ€è¦ç»™ ALU çš„æ§åˆ¶é€»è¾‘åŠ æ–™ï¼š</p><p><img src="https://image.mwish.me/blog-image/EC372F7D-B123-450D-AD55-81937FC1DC8D.png" alt="EC372F7D-B123-450D-AD55-81937FC1DC8D"></p><p>å…¶ä»– R-Format Instructions ä¹Ÿå¯ä»¥ç”¨è¿™å¥—é€»è¾‘æ¥å®ç°</p><h3 id="å¼•å…¥ç«‹å³æ•°"><a href="#å¼•å…¥ç«‹å³æ•°" class="headerlink" title="å¼•å…¥ç«‹å³æ•°"></a>å¼•å…¥ç«‹å³æ•°</h3><p><img src="https://image.mwish.me/blog-image/A1F63331-0635-4D27-AEEE-AFF0D6AC0970.png" alt="A1F63331-0635-4D27-AEEE-AFF0D6AC0970"></p><p>æ‰€ä»¥å¼•å…¥äº† imm gen</p><p><img src="https://image.mwish.me/blog-image/57188376-0D28-496F-B702-B819F534D6B3.png" alt="57188376-0D28-496F-B702-B819F534D6B3"></p><h3 id="load-words"><a href="#load-words" class="headerlink" title="load words"></a>load words</h3><p><img src="https://image.mwish.me/blog-image/7BFBC998-6986-42B2-9FB9-D64A4787EAB6.png" alt="7BFBC998-6986-42B2-9FB9-D64A4787EAB6"></p><p>ç°åœ¨ï¼Œæˆ‘ä»¬éœ€è¦è®¿é—® dmem, æ ¹æ®åœ°å€æ¥è¾“å‡ºå€¼ï¼š</p><p><img src="https://image.mwish.me/blog-image/43D2B1BD-5DC7-4906-955B-173BAE47E43D.png" alt="43D2B1BD-5DC7-4906-955B-173BAE47E43D"></p><p>è¿™ä¸ªæ—¶å€™åŠ ä¸Šäº† <code>WbSel</code> å’Œ <code>MemRw</code>, éœ€è¦è¯»å– memoryã€‚æˆ‘ä»¬ç°åœ¨èƒ½è¯»å–å†…å­˜ã€‚</p><p><img src="https://image.mwish.me/blog-image/3CC5F8D9-7F07-448E-96D7-F2E18FB07882.png" alt="3CC5F8D9-7F07-448E-96D7-F2E18FB07882"></p><p>è¿™ä¸ªæ—¶å€™æˆ‘ä»¬éœ€è¦å¢åŠ å†™å†…å­˜çš„ Path:</p><p><img src="https://image.mwish.me/blog-image/206394E8-FDEE-4769-A5B6-6D2A83A1AEF9.png" alt="206394E8-FDEE-4769-A5B6-6D2A83A1AEF9"></p><p>è¿™ä¸ªæ—¶å€™éœ€è¦ä¸€ä¸ª <code>DataW</code> åšè¾“å‡ºåˆ° <code>AddR</code> çš„å€¼ã€‚</p><h3 id="ä¸€å€¼å¤šç”¨"><a href="#ä¸€å€¼å¤šç”¨" class="headerlink" title="ä¸€å€¼å¤šç”¨"></a>ä¸€å€¼å¤šç”¨</h3><p><img src="https://image.mwish.me/blog-image/7BE58BEB-8C40-493A-BCBA-639A4FE58360.png" alt="7BE58BEB-8C40-493A-BCBA-639A4FE58360"></p><p>æˆ‘ä»¬çŸ¥é“ï¼ŒRISC-V çš„ <code>rs1</code> <code>rs2</code>  <code>rd</code> éƒ½æ˜¯å‡ºç°åœ¨åŒä¸€ä¸ªåœ°æ–¹çš„ï¼Œæ‰€ä»¥æ‰€æœ‰çš„è·¯å¾„éƒ½ä¼šè¢«ç”¨åˆ°ï¼Œåªæ˜¯æ ¹æ®æ§åˆ¶é€»è¾‘æ¥åˆ¤æ–­è¿™ä¸ªå€¼å…·ä½“æ˜¯ä»€ä¹ˆè¯­ä¹‰ï¼Œæ˜¯ç«‹å³æ•°è¿˜æ˜¯å¯„å­˜å™¨ã€‚</p><h3 id="branches"><a href="#branches" class="headerlink" title="branches"></a>branches</h3><h4 id="Conditional-branch"><a href="#Conditional-branch" class="headerlink" title="Conditional branch"></a>Conditional branch</h4><p><img src="https://image.mwish.me/blog-image/04E4E1C3-7FD5-4D0D-8A67-CEF2D9242BD2.png" alt="04E4E1C3-7FD5-4D0D-8A67-CEF2D9242BD2"></p><p><img src="https://image.mwish.me/blog-image/7F212FD8-9048-4883-A655-400FF2A8B88C.png" alt="7F212FD8-9048-4883-A655-400FF2A8B88C"></p><p>è¿™é‡ŒåŠ å…¥äº†ä¸€ä¸ª <code>Branch Comp</code> çš„é‡è¦ç»„ä»¶ï¼Œç„¶åæŠŠ PC conditional çš„é€åˆ° ALUï¼Œç»“æœå† conditional çš„é€å› PC</p><h4 id="unconditional-branch"><a href="#unconditional-branch" class="headerlink" title="unconditional branch"></a>unconditional branch</h4><p><img src="https://image.mwish.me/blog-image/B62E5E53-8758-4D55-897F-C9ACC98A72D3.png" alt="B62E5E53-8758-4D55-897F-C9ACC98A72D3"></p><p>è¿™é‡Œå°±æ˜¯ç›´æ¥è·³è½¬äº†ï¼Œæ¯”ä¹‹å‰è¿˜ç®€å•å‘¢ï¼</p><h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><ul><li><p>Universal datapath</p><ul><li><p>Capable of executing all RISC-V instructions in one cycle each</p></li><li><p>Not all units (hardware) used by all instructions </p></li></ul></li><li><p>5 Phases of execution</p></li><li>IF, ID, EX, MEM, WB<ul><li>Not all instructions are active in all phases</li></ul></li><li>Controller specifies how to execute instructions<ul><li>what new instructions can be added with just most control?</li></ul></li></ul>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>SDS Intro &amp; RISC-V Datapath(0): é¢„å¤‡çŸ¥è¯†</title>
      <link href="/2020/10/14/SDS-Intro-RISC-V-Datapath/"/>
      <url>/2020/10/14/SDS-Intro-RISC-V-Datapath/</url>
      
        <content type="html"><![CDATA[<p>æˆ‘ä»¬çš„è®¡ç®—æœºæ„å»ºåœ¨ç”µè·¯å’ŒèŠ¯ç‰‡ä¸Šï¼Œè™½ç„¶ç¨‹åºå‘˜ä¸€èˆ¬ä¸ä¼šäº†è§£è¿™äº›ã€‚ç°åœ¨æˆ‘ä»¬å¯èƒ½æœ‰ä¸¤ç§ç”µå‹ï¼š</p><ul><li><code>Vdd</code> , é«˜ç”µå‹, åœ¨æ ‘è“æ´¾é‡Œé¢å¤§æ¦‚æ˜¯ 1.2ä¼ç‰¹</li><li>ä½ç”µå‹ï¼Œ0ä¼ç‰¹æˆ–è€…æ¥åœ°</li></ul><p>é€šå¸¸ï¼Œæˆ‘ä»¬é€‰æ‹©æŸç§ä¸­é—´å€¼ï¼Œå¤§äºä¸­é—´å€¼çš„è§†ä¸º <code>1</code>/<code>true</code>, å°äºè¿™ä¸ªå€¼çš„è®¾ç½®ä¸º<code>0</code>/<code>false</code>. é«˜ä¸­ç‰©ç†å®éªŒé‡Œé¢æˆ‘ä»¬ä¼šæœ‰ä¸ªç”µæ± ï¼Œç„¶åèµ·ä¸€ä¸ªç”µçº¿+ç‰©ç†çš„â€œswitchâ€å¼€å…³ï¼Œç°ä»£æˆ‘ä»¬ä½¿ç”¨ CMOS ä½œä¸ºè¿™ä¸ªå¼€å…³ï¼š</p><p><img src="https://image.mwish.me/blog-image/DFFF2237-A3C0-4A47-A529-B3F8DBBFC35A.png" alt="DFFF2237-A3C0-4A47-A529-B3F8DBBFC35A"></p><p>åœ¨ CMOS ä¸­ï¼Œæˆ‘ä»¬å®ç°äº†è¿™ç§é€»è¾‘ã€‚å›¾ä¸Šçš„ <code>n</code> æ˜¯ negetive, <code>p</code> æ˜¯ positive, å…·ä½“å¦‚ä¸‹ï¼š</p><p><img src="https://image.mwish.me/blog-image/FBC51C46-58ED-4A23-BCE8-ABBAADBF736E.png" alt="FBC51C46-58ED-4A23-BCE8-ABBAADBF736E"></p><p>åé¢ä¸¤æ¡å°±æ˜¯é«˜ä¸­ç‰©ç†çŸ¥è¯†äº†ï¼ŒçŸ­è·¯ä»€ä¹ˆçš„â€¦ä¸Šé¢ä¸¤æ¡æ¯”è¾ƒé‡è¦ï¼š</p><ul><li>n-type ä¸å¸¦åœˆï¼Œä½ç”µå‹æ—¶ï¼Œå®ƒæ˜¯é€šçš„ï¼Œå¦åˆ™é€š</li><li>p-type å¸¦åœˆï¼Œé«˜ç”µå‹æ—¶ï¼Œæ˜¯é€šçš„ï¼Œå¦åˆ™ä¸é€š</li></ul><p>é‚£ä¹ˆå¯ä»¥ç†è§£ä¸‹é¢è¿™å›¾äº†ï¼š</p><p><img src="https://image.mwish.me/blog-image/FEB6CDCD-A282-4DB6-9BFA-F6662859DFAE.png" alt="FEB6CDCD-A282-4DB6-9BFA-F6662859DFAE"></p><p>X ä¸º Vdd æ—¶ï¼Œp-type é€šï¼Œn-type ä¸é€šï¼Œé‚£ä¹ˆ Y ç”µå‹æ˜¯ 1ï¼›Xä¸º GND æ—¶ï¼Œp-type ä¸é€šï¼Œn-type é€šï¼ŒY ä¸º 0Vã€‚å¾ˆæ˜¾ç„¶ï¼Œä¸Šé¢çš„å¯ä»¥ç®—ä¸€ä¸ªéé—¨ï¼Ÿ</p><p>é‚£ä¹ˆæˆ‘ä»¬å†æ¥åˆ†æä¸€ä¸ª slide é‡Œçš„ç”µè·¯ï¼š</p><p><img src="https://image.mwish.me/blog-image/61EB95F0-389F-480B-BBF0-6334C4FD38BF.png" alt="61EB95F0-389F-480B-BBF0-6334C4FD38BF"></p><p>ä¸Šå›¾ä¸­ï¼ŒX Y ä»»æ„ä¸€ä¸ªç”µå‹ä¸ºä¸€ï¼Œé‚£ä¹ˆ Z â€” 1V ä¸­é—´æ˜¯é€šçš„ï¼ˆè¿™ä¸¤ä¸ªçš„ p-type ä¸­å¹¶è”äº†ï¼‰ï¼›è€Œä¸‹é¢ n-type ä¸²è”ï¼Œéœ€è¦ X, Y éƒ½ä¸º 0ï¼Œå®ƒä»¬æ‰æ˜¯é€šçš„ï¼ŒZ æ‰ä¸º 0 Vã€‚</p><p>é‚£æˆ‘ä»¬å¯ä»¥ç”¨ç”µè·¯æ¥å®ç°ä¸€äº›è¯­ä¹‰ï¼Œä¸‹é¢æ˜¯ä½ ä»¬åº”è¯¥éƒ½å­¦è¿‡çš„ä¸€äº›è®°å·ï¼Œä¸ºäº†çŒæ°´æˆ‘å°±è´´å¼ å›¾äº†ï¼š</p><p><img src="https://image.mwish.me/blog-image/61EB95F0-389F-480B-BBF0-6334C4FD38BF.png" alt="61EB95F0-389F-480B-BBF0-6334C4FD38BF"></p><p>ä»¥ä¸Šæ˜¯ç›¸å…³çš„ç”µè·¯çŸ¥è¯†ã€‚å®é™…ä¸Šæˆ‘ä»¬å¯ä»¥ç”¨å‡ ä¸ªæ•°å­¦å·¥å…·æ¥è¡¨ç¤ºéœ€è¦çš„é€»è¾‘ï¼š</p><p><img src="https://image.mwish.me/blog-image/233C6157-C855-4424-9957-2F78D8A78BEE.png" alt="233C6157-C855-4424-9957-2F78D8A78BEE"></p><p>æˆ‘ä»¬å¯ä»¥ç”¨ï¼š</p><ul><li>Boolean expression: ä¸æˆ–éè¿™äº›ç®—å­çš„å¸ƒå°”é€»è¾‘</li><li>Truth table: é¢„æœŸçš„è¾“å…¥å¯¹åº”çš„è¾“å‡ºçš„æ‰€æœ‰è¡¨æ ¼</li><li>Gate Diagram: ä¸Šè¿°é—¨å’Œè¾“å…¥ã€è¾“å‡ºçš„æè¿°å›¾</li></ul><p>å®é™…ä¸Šï¼Œ<strong>ç”µè·¯ä¸­æ˜¯ä¼šæœ‰ä¸€äº› delay</strong> çš„ï¼š</p><p><img src="https://image.mwish.me/blog-image/16550D9D-C7A7-45DD-BDC0-A002645C48CA.png" alt="16550D9D-C7A7-45DD-BDC0-A002645C48CA"></p><h2 id="åé¦ˆä¸è§¦å‘å™¨"><a href="#åé¦ˆä¸è§¦å‘å™¨" class="headerlink" title="åé¦ˆä¸è§¦å‘å™¨"></a>åé¦ˆä¸è§¦å‘å™¨</h2><p>æˆ‘ä»¬ä¸»è¦ä»‹ç» <em>Synchronous Digital Systems</em>ï¼Œä¸ä»‹ç»å¼‚æ­¥çš„ç³»ç»Ÿ</p><p><strong>ç»„åˆé€»è¾‘(Combinational Logic)</strong>,å…¶è¾“å‡ºåªæ˜¯å½“å‰è¾“å…¥çš„å‡½æ•°ï¼Œä¸ä¹‹å‰çŠ¶æ€æ— å…³ï¼Œæ— å­˜å‚¨åŠŸèƒ½ï¼›å¦ä¸€ç§æ˜¯<strong>æ—¶åºé€»è¾‘(Sequential Logic)</strong>ï¼Œèƒ½å¤Ÿå­˜å‚¨æ•°æ®ä¾›ä»¥åä½¿ç”¨ï¼Œå¦‚è§¦å‘å™¨ï¼Œmemoryï¼Œå¯„å­˜å™¨(register,ç”±å¤šä¸ªè§¦å‘å™¨ç»„æˆ)ã€‚</p><p>ä¸Šè¿°å†…å®¹æç¤ºæˆ‘ä»¬ï¼Œé™¤äº†ä¸æˆ–é—¨å’ŒåŠ æ³•ä¹‹ç±»çš„ ALU è®¡ç®—ï¼Œæˆ‘ä»¬è¿˜éœ€è¦å¯„å­˜å™¨ã€å†…å­˜ç­‰èƒ½å¤Ÿéé¡ºæ—¶çš„ä¿å­˜çŠ¶æ€çš„è®¾å¤‡ï¼ŒåŒæ—¶ï¼Œæˆ‘ä»¬ä¹Ÿéœ€è¦çŠ¶æ€ï¼Œæ¥ç»“åˆä¸Šè¿°å„ä¸ªéƒ¨åˆ†ï¼Œå®Œæˆæ§åˆ¶ï¼šæ¯”å¦‚æˆ‘ä»¬æœ‰ä¸€ä¸ªåŠ æ³•çš„ç»„ä»¶ï¼Œä½†æ˜¯æˆ‘ä»¬ä¼šå¸Œæœ›è®©åŠ æ³•çš„ç»“æœåœ¨ä¸€å®šæ—¶é—´å†…æ˜¯å¯è¯»çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ flip-flop, å³è§¦å‘å™¨ã€‚</p><p>å‡è®¾æˆ‘ä»¬è®¡ç®—ä¸€ä¸ªæ•°ç»„çš„å’Œï¼Œå³</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> sum = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; size; ++i) &#123;</span><br><span class="line">sum += <span class="built_in">array</span>[i];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬æ²¡æœ‰åœ°æ–¹å­˜å‚¨ sumï¼Œé‚£ä¹ˆå°±æ— æ³•å®Œæˆè®¡ç®—ã€‚å¾ˆæ˜¾ç„¶ï¼Œæˆ‘ä»¬éœ€è¦å¯„å­˜å™¨è¿™æ ·çš„ä¸œè¥¿ï¼Œé‚£ä¹ˆï¼Œå¯„å­˜å™¨å®é™…ä¸Šæ˜¯ç”±ä¸€ç»„ flip-flop æ„æˆçš„.</p><h3 id="flip-flop"><a href="#flip-flop" class="headerlink" title="flip-flop"></a>flip-flop</h3><blockquote><p>Flip-flop name because the output flips and flops between 0 and 1</p></blockquote><p><img src="https://image.mwish.me/blog-image/7992A522-FFA5-4D90-A89A-7D7FDE404463.png" alt="7992A522-FFA5-4D90-A89A-7D7FDE404463"></p><p>ä¸‹é¢æ˜¯ D-type flip flop, <code>d</code> ä½œä¸ºè¾“å…¥ï¼Œ<code>q</code> ä½œä¸ºè¾“å‡ºã€‚å®ƒæ˜¯ â€œpositive edge-triggeredâ€ çš„ï¼Œå³å˜ä¸ºé«˜ç”µå‹çš„æ—¶å€™ï¼Œè¾¹ç¼˜è§¦å‘ï¼Œå¹¶ä¿æŒè®°å½•ã€‚å³</p><blockquote><p>â€œOn the rising edge of the clock, the input d is sampled and transferred to the output. At all other times, the input d is ignored.â€</p></blockquote><p>åŒæ—¶ï¼Œé«˜ä½çš„æ—¶é—´ä¸­ï¼Œ<code>d</code> éœ€è¦ä¿æŒç¨³å®šï¼Œå³å¦‚ä¸‹å›¾ï¼š</p><p><img src="https://image.mwish.me/blog-image/A2377FD7-3492-45D6-A748-F19B13CC387D.png" alt="A2377FD7-3492-45D6-A748-F19B13CC387D"></p><p>æˆ‘ä»¬æœ‰å‡ ä¸ªå…³é”®æ—¶é—´ï¼Œå¦‚ä¸Šå›¾ï¼š</p><ul><li>Setup Time: when the input must be stable <em>before</em> the edge of the CLK</li><li>Hold Time: when the input must be stable <em>after</em> the edge of the CLK</li><li>â€œCLK-to-Qâ€ Delay: how long it takes the output to change, measured from the edge of the CLK</li></ul><h3 id="ç³»ç»Ÿæ¨¡å‹å’Œæ—¶é’Ÿå‘¨æœŸ"><a href="#ç³»ç»Ÿæ¨¡å‹å’Œæ—¶é’Ÿå‘¨æœŸ" class="headerlink" title="ç³»ç»Ÿæ¨¡å‹å’Œæ—¶é’Ÿå‘¨æœŸ"></a>ç³»ç»Ÿæ¨¡å‹å’Œæ—¶é’Ÿå‘¨æœŸ</h3><p><img src="https://image.mwish.me/blog-image/35022F87-4627-432A-B48A-A17D4D8DB558.png" alt="35022F87-4627-432A-B48A-A17D4D8DB558"></p><p>ä¸Šè¿°æ˜¯ç”µè·¯çš„åŸºæœ¬æ¨¡å‹ï¼ŒåŒæ—¶ï¼Œå¯¹æ—¶é’Ÿå‘¨æœŸå’Œé¢‘ç‡ï¼Œæˆ‘ä»¬æœ‰ï¼š</p><blockquote><p>Period = Max Delay = CLK-to-Q Delay + CL Delay + Setup Time</p><p>Frequency = 1/Period</p></blockquote><p>æ—¶é—´çš„è®¡ç®—ä¼šæ˜¯åç»­çš„å†…å®¹ã€‚</p><h3 id="æµæ°´çº¿"><a href="#æµæ°´çº¿" class="headerlink" title="æµæ°´çº¿"></a>æµæ°´çº¿</h3><p><img src="https://image.mwish.me/blog-image/68EBFEC9-FFFC-4498-87B5-122B932EA452.png" alt="68EBFEC9-FFFC-4498-87B5-122B932EA452"></p><p>è®¡ç®—çš„æ¯ä¸€æ­¥ä¾èµ–ä¸Šä¸€æ­¥çš„çŠ¶æ€ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯èƒ½è¦å¤šä¸ª register, ä½†æ˜¯ä¸ç”¨ä¿æŒè¿‡ä¹…ï¼Œå› ä¸ºå®é™…ä¸Šæˆ‘ä»¬å‡è®¾æ¨¡å‹æ˜¯å¦‚ä¸Šï¼Œé‚£ä¹ˆæ¯ä¸€æ­¥åªä¾èµ–ä¸Šä¸€æ­¥çš„çŠ¶æ€ã€‚æˆ‘ä»¬å¯ä»¥ pipeline çš„å»å¤„ç†æŒ‡ä»¤ã€‚</p><h3 id="å›åˆ°-sum"><a href="#å›åˆ°-sum" class="headerlink" title="å›åˆ° sum"></a>å›åˆ° sum</h3><p>å›åˆ° sum çš„è®¡ç®—ï¼Œæˆ‘ä»¬æœ‰ï¼š</p><p><img src="https://image.mwish.me/blog-image/C6D1D07C-931A-44F6-9827-B123338E2EEF.png" alt="C6D1D07C-931A-44F6-9827-B123338E2EEF"></p><ol><li><code>S_i-1</code> ä¿å­˜ä¸Šä¸€è½®çš„ value, ç”± <code>Reg</code> æŒç»­è¾“å‡º</li><li><code>S_i-1</code> å’Œ <code>x_i</code> ç»è¿‡åŠ æ³•å™¨è®¡ç®—å‡º <code>S_i</code></li><li><code>reset</code> ä¿¡å·å°† reg é‡ç½®ä¸º 0ï¼Œå¯„å­˜å™¨è¾“å‡º <code>0</code></li><li><code>xi</code> å¼€å§‹è¾“å…¥ <code>x_0</code> , ç»è¿‡åŠ æ³•å™¨å’Œ <code>clk to q</code> çš„æ—¶é—´, æä¾›ç»™ Reg</li><li>CLK èµ·æ—¶ï¼ŒReg å†æ¬¡è®¾ç½®ï¼Œæˆä¸º <code>x0</code> </li></ol><p><img src="https://image.mwish.me/blog-image/image-20201015130546809.png" alt="image-20201015130546809"></p><p>è¿™ä¸ªæ—¶æœŸè§ï¼Œperiod ç­‰åŒäºæœ€å¤§å»¶è¿Ÿï¼Œå³ <code>CLK-to-Q Delay + CL Delay + Setup Time</code></p><p>ä¹Ÿå¯ä»¥è§‚å¯Ÿåˆ°<code>S_i</code>  å’Œ <code>S_(i - 1)</code> å˜åŠ¨çš„å…³ç³»ã€‚</p><h3 id="Critical-path-ä¸èƒ½æŠ„è¿‘é“"><a href="#Critical-path-ä¸èƒ½æŠ„è¿‘é“" class="headerlink" title="Critical path: ä¸èƒ½æŠ„è¿‘é“"></a>Critical path: ä¸èƒ½æŠ„è¿‘é“</h3><p>Critical Path æŒ‡çš„æ˜¯æ‹¿åˆ°å¯„å­˜å™¨è¾“å‡ºçš„å¿…è¦æ—¶é—´ï¼ŒæŒ‡çš„æ˜¯ next register çš„ setup time, ä¹Ÿæ˜¯æ•´ä¸ªé€»è¾‘ç”µè·¯å¯èƒ½çš„æœ€æ…¢çš„æ—¶é—´ï¼Œå³ clock åˆ° q å“åº”çš„æ—¶é—´ã€‚</p><p>æç«¯æƒ…å†µæ˜¯ï¼š</p><p><code>Clk-&gt;Q + **best case** combinational delay &lt; Hold time</code></p><p>è¿™ä¸ªæ—¶å€™æˆ‘ä»¬éœ€è¦ç”šè‡³äººä¸ºåˆ¶é€ ä¸€äº› delay, æ¥è®©å®ƒæœ‰è¶³å¤Ÿçš„ç»´æŒæ—¶é—´ï¼Œå³ hold timeï¼Œæ¥æˆåŠŸè¾“å…¥ç»™å¯„å­˜å™¨çš„ flip-flop.</p><h3 id="é€»è¾‘è®¾è®¡"><a href="#é€»è¾‘è®¾è®¡" class="headerlink" title="é€»è¾‘è®¾è®¡"></a>é€»è¾‘è®¾è®¡</h3><p>å¯„å­˜å™¨æœ¬èº«æ˜¯ä¸€ä¸ªçŠ¶æ€ï¼Œç”µè·¯ä¹Ÿå……æ»¡äº†çŠ¶æ€ï¼Œæˆ‘ä»¬ä¼šæœ‰ä¸Šä¸€æ­¥çš„çŠ¶æ€ï¼Œä¸‹ä¸€æ­¥çš„çŠ¶æ€</p><p><img src="https://image.mwish.me/blog-image/image-20201017153211876.png" alt="image-20201017153211876"></p><p>æˆ‘ä»¬å¯ä»¥ç”¨æœ‰é™çŠ¶æ€è‡ªåŠ¨æœºï¼Œæ¥ä»£è¡¨éœ€è¦çš„é€»è¾‘ã€‚åŒæ—¶ä¹Ÿå¯èƒ½æ‹¿åˆ°å¯¹åº”çš„è¾“å…¥è¾“å‡ºçš„è¡¨ï¼š</p><blockquote><p>Combinational logic circuit is used to implement a function that maps from <em>present state and input</em> to <em>next state and output.</em></p></blockquote><p>æ ¹æ®çŠ¶æ€æœºï¼Œæˆ‘ä»¬å¯ä»¥è®¾è®¡ ALU:</p><p><img src="https://image.mwish.me/blog-image/image-20201017153438192.png" alt="image-20201017153438192"></p><h4 id="åŠ æ³•å™¨"><a href="#åŠ æ³•å™¨" class="headerlink" title="åŠ æ³•å™¨"></a>åŠ æ³•å™¨</h4><p>åŠ æ³•è¦æœ‰ carry-bit å®ç°è¿›ä½ï¼Œç„¶åæ¯ä¸¤ä½æŒ‰ä½ç›¸åŠ ã€‚é€»è¾‘å¦‚ä¸‹ï¼š</p><p><img src="https://image.mwish.me/blog-image/6206E039-8E6E-42AD-A0F5-C5F1956820F2.png" alt="6206E039-8E6E-42AD-A0F5-C5F1956820F2"></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>RISC-V ç¼–è¯‘ã€é“¾æ¥ã€åŠ è½½</title>
      <link href="/2020/10/05/RISC-V-%E7%BC%96%E8%AF%91%E3%80%81%E9%93%BE%E6%8E%A5%E3%80%81%E5%8A%A0%E8%BD%BD/"/>
      <url>/2020/10/05/RISC-V-%E7%BC%96%E8%AF%91%E3%80%81%E9%93%BE%E6%8E%A5%E3%80%81%E5%8A%A0%E8%BD%BD/</url>
      
        <content type="html"><![CDATA[<p>æˆ‘ä»¬ä»‹ç»äº† RISC-V çš„æŒ‡ä»¤ï¼Œä½ å¯ä»¥å½“ä½œä»‹ç»äº†æ±‡ç¼–è¯­è¨€ã€‚ä½†æ˜¯ï¼Œæˆ‘ä»¬ç°åœ¨çŸ¥é“çš„æ˜¯ï¼š</p><ul><li>RV32I çš„æ ¼å¼éƒ½æ˜¯ 32bit çš„</li><li>ä»¥ä¸Šå†…å®¹å¯ä»¥ä»¥ <code>beq</code> ç­‰æ ¼å¼è®©è¯»è€…å¯è¯»ï¼Œä½†æ˜¯æœºå™¨æ‰§è¡Œçš„è¿˜æ˜¯é‚£6ç§æ ¼å¼çš„ä»£ç </li></ul><p>æˆ‘ä»¬ä¹Ÿäº†è§£äº† RISC-V çš„ calling convention å’Œ ABI, è¿™ä¸€èŠ‚ä»‹ç»ç¨‹åºçš„ç¼–è¯‘ã€é“¾æ¥ã€åŠ è½½ã€‚åŸºç¡€çŸ¥è¯†å¯ä»¥é˜…è¯» CSAPP ç¬¬ä¸ƒç« å’Œ  <a href="https://zhuanlan.zhihu.com/p/125163040">https://zhuanlan.zhihu.com/p/125163040</a> æˆ‘ä¹‹å‰å†™çš„åƒåœ¾ã€‚ä¸è¿‡ä»Šå¤©æˆ‘å†™çš„ä¼šç»†ä¸€äº›ã€‚</p><p><img src="https://image.mwish.me/blog-image/7E604484-7BD6-4192-81E0-F5C0E8F31750.png" alt="7E604484-7BD6-4192-81E0-F5C0E8F31750"></p><h2 id="ç¼–è¯‘"><a href="#ç¼–è¯‘" class="headerlink" title="ç¼–è¯‘"></a>ç¼–è¯‘</h2><p>ç¼–è¯‘ç”± <code>.c</code>  è½¬ä¸ºæ±‡ç¼–è¯­è¨€ï¼Œå½¢å¼æ˜¯ <code>.s</code>, è¿™ä¸ªæˆ‘ä»¬ä¹‹å‰éƒ½ç”¨è¿‡äº†</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">âœ— riscv64-unknown-elf-gcc -march=rv32imac -mabi=ilp32 -S </span><br></pre></td></tr></table></figure><p>è¿™æ ·ä½“éªŒä¸€æŠŠå°±è¡Œã€‚Compiler éœ€è¦èµ°ï¼š</p><ul><li>Lexer: è¯­æ³•åˆ†æï¼ŒæŠŠç›®æ ‡è½¬æˆ token. å®é™…ä¸Šå¯ä»¥å€Ÿç”¨ Lex å·¥å…·ï¼Œè€Œ Flex æ˜¯ Lex çš„ä¸€ä¸ªå®ç°ã€‚</li><li>Parser: å°†å†…å®¹å˜ä¸º AST</li><li>Semantic Analysis and Optimization: æ£€æŸ¥ AST, ç„¶ååšä¸€äº›ä¼˜åŒ–</li><li>Code generation: åšå¯„å­˜å™¨ allocation, ä»£ç ç”Ÿæˆ</li></ul><p>å®é™…ä¸Šï¼Œæˆ‘ä»¬ç”Ÿæˆ <code>-S</code> ä¹Ÿéœ€è¦æŒ‡å®šç¼–è¯‘é€‰é¡¹ï¼Œèƒ½æŒ‡å®š <code>-O</code>ã€‚è¿™é‡Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°å¯é çš„ RISC-V çš„ä»£ç ã€‚å®ƒå’Œæˆ‘ä»¬çš„ç¨‹åºæ˜¯é€»è¾‘ä¸Šç­‰ä»·çš„ï¼Œå½“ç„¶å¯èƒ½è¦è¿›è¡Œä¸€å®šçš„ä¼˜åŒ–ã€‚</p><p>æ³¨æ„ï¼Œåœ¨ RISC-V ä¸­ï¼Œç¼–è¯‘æ˜¯ä¼šäº§ç”Ÿä¾¿äºç†è§£çš„ä¼ªæŒ‡ä»¤çš„ã€‚</p><h2 id="æ±‡ç¼–"><a href="#æ±‡ç¼–" class="headerlink" title="æ±‡ç¼–"></a>æ±‡ç¼–</h2><p>å°†æ±‡ç¼–è¯­è¨€ç”Ÿæˆ ELF çš„ object file, object file å±äº machine language äº†ã€‚</p><p><img src="https://image.mwish.me/blog-image/1AD78D8D-1536-428E-99BE-5E072623028C.png" alt="1AD78D8D-1536-428E-99BE-5E072623028C"></p><p>ELF æ–‡ä»¶åŒ…æ‹¬ï¼š</p><ul><li>ELF Header, ä»¥ä¸€ä¸ª 16byte çš„åºåˆ—å¼€å§‹ï¼Œæè¿°ç³»ç»Ÿ word å¤§å°ã€å­—èŠ‚é¡ºåºç­‰</li><li><code>.text</code> text segment, ç¼–è¯‘ç¨‹åºçš„æœºå™¨ä»£ç </li><li><code>.data</code> å·²åˆå§‹åŒ–çš„ global/static C variable, å³æºä»£ç çš„ <code>static</code> éƒ¨åˆ†ã€‚<ul><li>Local æ˜¯åœ¨ stack ä¸­çš„</li><li>æœªåˆå§‹åŒ–çš„ã€è¢«åˆå§‹åŒ–ä¸º 0 çš„ï¼Œåœ¨ <code>.bss</code> ä¸­ã€‚å®ƒä¸å æ®å®é™…ç©ºé—´ï¼Œæœ‰ç‚¹ç±»ä¼¼ gcc çš„ <code>__weak__</code> .</li></ul></li><li><code>.symtab</code> ï¼Œç¬¦å·è¡¨ï¼Œå­˜æ”¾å®šä¹‰ã€å¼•ç”¨çš„å‡½æ•°ã€å…¨å±€å˜é‡å’Œä¸å¯è¢« reference çš„ static å˜é‡</li><li><code>.debug</code> è°ƒè¯•ç¬¦å·è¡¨ï¼ŒåŒ…å«åŸå§‹æ–‡ä»¶; <code>.line</code> åŒæ ·ï¼ŒåŒ…å«è¡Œå·å’Œ <code>.text</code> çš„æ˜ å°„ã€‚åªæœ‰ <code>-g</code> ç¼–è¯‘æ‰ä¼šäº§ç”Ÿ</li><li><code>.strtab</code> å­—ç¬¦ä¸²è¡¨ï¼ŒåŒ…å«å®šä¹‰çš„ string å’Œ section çš„åå­—ã€‚</li></ul><p>ELF å…·ä½“ä¿¡æ¯å¯ä»¥çœ‹ï¼š</p><p>é‚£ä¹ˆæˆ‘ä»¬è¿˜è¦æ³¨æ„ï¼Œæœ‰çš„ directions, å³æ±‡ç¼–æŒ‡ç¤ºç¬¦ï¼Œä¼šè¢«ä¸¢ç»™é“¾æ¥å™¨ï¼Œä½†ä¸äº§ç”Ÿä»€ä¹ˆä»£ç </p><ol><li><code>.text</code>  user text segment ä¸­çš„ç‰‡æ®µ</li><li><code>.data</code>  éœ€è¦å†™åˆ° user data segment ä¸­çš„ç‰‡æ®µ</li><li><code>.globl sym</code> å¯ä»¥ä»å…¶ä»–æ–‡ä»¶å¼•ç”¨çš„å…¨å±€ç¬¦å·</li><li><code>.string str</code> æŠŠå¯¹åº”çš„ C-Style å­—ç¬¦ä¸²å­˜åœ¨å†…å­˜ä¸­</li><li><code>.word w1...wn</code>  æŠŠè¿™ n ä¸ªè¿ç»­çš„ç¬¦å·è¿ç»­å­˜å–</li></ol><p>åŒæ—¶ï¼Œåœ¨é“¾æ¥çš„æ—¶å€™ï¼Œä¼šå®Œæˆä¼ªæŒ‡ä»¤çš„æ›¿æ¢ï¼ŒæŠŠå®ƒä»¬å…¨éƒ¨æ›¿æ¢æˆå…·ä½“çš„æŒ‡ä»¤ï¼ˆè¿™é‡Œå¯ä»¥è¡¨ç¤º RV32I è¿™æ ·çš„ï¼‰ã€‚</p><p>æˆ‘ä»¬æ¥çœ‹çœ‹ hello world:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Hello, %s&quot;</span>, <span class="string">&quot;world&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ RISC-V Book ä¸Šï¼Œå®ƒç”Ÿæˆäº†å¦‚ä¸‹çš„æ±‡ç¼–ï¼š</p><p><img src="https://image.mwish.me/blog-image/FD540A48-C82E-41A5-9218-F3899DE2A9DA.png" alt="FD540A48-C82E-41A5-9218-F3899DE2A9DA"></p><blockquote><p>å…¶ä¸­å›¾ 3.6 ä¸­ç”¨åˆ°çš„æŒ‡ç¤ºç¬¦æœ‰:</p><ul><li>.text:è¿›å…¥ä»£ç æ®µã€‚</li><li>.align2:åç»­ä»£ç æŒ‰22å­—èŠ‚å¯¹é½ã€‚</li><li>.globl main:å£°æ˜å…¨å±€ç¬¦å·â€œmainâ€ã€‚</li><li>.section .rodata:è¿›å…¥åªè¯»æ•°æ®æ®µ</li><li>.balign4:æ•°æ®æ®µæŒ‰4å­—èŠ‚å¯¹é½ã€‚</li><li>.string â€œHello, %s!\nâ€:åˆ›å»ºç©ºå­—ç¬¦ç»“å°¾çš„å­—ç¬¦ä¸²ã€‚</li><li>.string â€œworldâ€:åˆ›å»ºç©ºå­—ç¬¦ç»“å°¾çš„å­—ç¬¦ä¸²ã€‚</li></ul></blockquote><h4 id="tail-call-optimization"><a href="#tail-call-optimization" class="headerlink" title="tail call optimization"></a>tail call optimization</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">fn:</span><br><span class="line"> return foo(x)</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ—¶å€™ï¼Œæ­£å¸¸è¡Œä¸ºåº”è¯¥æ˜¯ï¼šæŠŠ <code>a0</code> è®¾ç½® x, ç„¶åè¿”å›è°ƒç”¨åçš„ <code>a0</code>, å³ï¼š</p><ul><li>ç„¶åç”¨ <code>j</code> æˆ–è€… <code>tail</code> ç›´æ¥è°ƒç”¨ <code>foo(y)</code> ï¼Œè¿™ç©æ„ä¼šåšä¸ªä¿å­˜ï¼ŒæŠŠæœ¬å‡½æ•°çš„ <code>ra</code>, <code>sp</code> ä¿å­˜ï¼Œè¿™æ ·è·³è½¬çš„è¯å°±å¯ä»¥ç›´æ¥è·³è½¬åˆ° <code>fn</code> çš„è°ƒç”¨è€…ã€‚</li></ul><p>åœ¨ RISC-V ä¼ªæŒ‡ä»¤ä¸­ï¼Œæœ‰ä¸€æ¡ <code>tail</code>, ä¼šè¢«è§£é‡Šæˆ</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">auipc x6, offset[32:12]</span><br><span class="line">jalr x0, x6, offset[11:0]</span><br></pre></td></tr></table></figure><p>ç”¨ <code>tail</code> å’Œ <code>j</code> æ¥å®Œæˆä¸Šè¿°çš„ jumpï¼Œè€Œä¸å†è°ƒç”¨å‰å†å»è®¾ sp/ra</p><p>è¿™ä¸ªè¡Œä¸ºè®©æˆ‘æœ‰äº›å¤´æ™•ï¼Œæˆ‘åœ¨ç½‘ä¸Šæ‰¾åˆ°äº†è¿™ç¯‡ blog: <a href="https://www.sifive.com/blog/all-aboard-part-3-linker-relaxation-in-riscv-toolchain">https://www.sifive.com/blog/all-aboard-part-3-linker-relaxation-in-riscv-toolchain</a></p><p>ä¸Šé¢çš„é“¾æ¥å€’æ˜¯ä»‹ç»çš„æ¯”è¾ƒæ¸…æ¥šã€‚</p><h4 id="ç”Ÿæˆæœºå™¨ä»£ç "><a href="#ç”Ÿæˆæœºå™¨ä»£ç " class="headerlink" title="ç”Ÿæˆæœºå™¨ä»£ç "></a>ç”Ÿæˆæœºå™¨ä»£ç </h4><p>æˆ‘ä»¬æè¿°è¿‡ ELF æ ¼å¼äº†ï¼Œæˆ‘ä»¬æœ‰ä¸‹åˆ—å‡ ä¸ªé—®é¢˜</p><h4 id="å‹ç¼©æŒ‡ä»¤"><a href="#å‹ç¼©æŒ‡ä»¤" class="headerlink" title="å‹ç¼©æŒ‡ä»¤"></a>å‹ç¼©æŒ‡ä»¤</h4><p>RV32C æ”¯æŒå‹ç¼©æŒ‡ä»¤ï¼š</p><ul><li>æ¯æ¡çŸ­æŒ‡ä»¤é•¿åº¦ä¸º 16bits</li><li>å¿…é¡»å’Œ 32bits æŒ‡ä»¤ä¸€ä¸€å¯¹åº”</li><li>åªå¯¹æ±‡ç¼–å™¨å’Œè¿æ¥å™¨å¯è§ï¼Œå¹¶ä¸”æ˜¯å¦ä»¥çŸ­æŒ‡ä»¤å–ä»£å¯¹åº”çš„å®½æŒ‡ä»¤ç”± å®ƒä»¬å†³å®šã€‚ç¼–è¯‘å™¨ç¼–å†™è€…å’Œæ±‡ç¼–è¯­è¨€ç¨‹åºå‘˜å¯ä»¥å¹¸ç¦åœ°å¿½ç•¥ RV32C æŒ‡ä»¤åŠå…¶æ ¼å¼ï¼Œä»–ä»¬èƒ½ æ„ŸçŸ¥åˆ°çš„åˆ™æ˜¯æœ€åçš„ç¨‹åºå¤§å°å°äºå¤§å¤šæ•°å…¶å®ƒ ISA çš„ç¨‹åºã€‚</li></ul><p><img src="https://image.mwish.me/blog-image/DB8DEC4A-F78C-4641-9652-266DB487A1F0.png" alt="DB8DEC4A-F78C-4641-9652-266DB487A1F0"></p><p>RV32C å¦‚ä¸Š</p><p><img src="https://image.mwish.me/blog-image/0119C713-D3D9-4C9F-B9F2-91F26E82EBCE.png" alt="0119C713-D3D9-4C9F-B9F2-91F26E82EBCE"></p><p>é‚£ä¹ˆï¼Œè€ƒè™‘å‹ç¼©æŒ‡ä»¤ï¼Œä¼šæœ‰ä¸‹åˆ—é—®é¢˜ï¼š</p><blockquote><p>So the presence of the 16b instructions <strong>doesnâ€™t need to be known to anybody but the assembler and the RISC-V processor itself</strong>!</p></blockquote><h4 id="Forward-Reference"><a href="#Forward-Reference" class="headerlink" title="Forward Reference"></a>Forward Reference</h4><p>å³å‡è®¾ <code>L1 --&gt; L2</code>, ä½† L1 åœ¨ L2 ä¹‹å‰ï¼Œé‚£ä¹ˆè¿™æš—ç¤ºç¼–è¯‘å™¨éœ€è¦ä¸€å¼ å±€éƒ¨çš„ç¬¦å·è¡¨ï¼Œå¹¶æ‰«æä¸æ­¢ä¸€ä¸ª passï¼Œæ¥å®Œæˆè¿™ä¸ªæ“ä½œã€‚</p><h4 id="jal-la-static-åŠ è½½"><a href="#jal-la-static-åŠ è½½" class="headerlink" title="jal/la static åŠ è½½"></a>jal/la static åŠ è½½</h4><p><code>jal</code> ä¼šè·³è½¬ä¸€ä¸ª imm, è€Œ static å˜é‡åŠ è½½ä¸­ï¼Œå¯èƒ½å¯¹åº”çš„ç¬¦å·æ¥è‡ªå¦ä¸€ä¸ªæ–‡ä»¶å®šä¹‰çš„å†…å­˜ä¸­ã€‚</p><h3 id="Tables"><a href="#Tables" class="headerlink" title="Tables"></a>Tables</h3><p>ä¸ºäº†è§£å†³ä¸Šè¿°é—®é¢˜ï¼Œæœ‰äº† symbol table å’Œ relocation tableï¼š</p><p>symbol table å±•ç¤ºå¯èƒ½è¢«å…¶ä»–æ–‡ä»¶ç”¨åˆ°çš„æœ¬æ–‡ä»¶ç¬¦å·ï¼Œä¾‹å¦‚ function call çš„ label, å’Œ <code>.data</code> ä¸­å¯ä»¥è¢«å¤–éƒ¨è®¿é—®çš„ç¬¦å·ã€‚</p><p>Relocation Table å±•ç¤º <code>jal</code> å’Œ <code>la</code> ä¸­éœ€è¦é‡å®šä½çš„åœ°å€ã€‚</p><h2 id="é“¾æ¥"><a href="#é“¾æ¥" class="headerlink" title="é“¾æ¥"></a>é“¾æ¥</h2><p>è®² ELF çš„ objective code è½¬åŒ–ä¸ºå¯æ‰§è¡Œæ–‡ä»¶ï¼Œè¿™ä¸€è¿‡ç¨‹è¢«ç§°ä¸º linking, è¿™ä¸€è¿‡ç¨‹æœ‰é€»è¾‘ä¸Šå¦‚ä¸‹çš„æµç¨‹ï¼š</p><ul><li>ä» <code>.o</code> æ–‡ä»¶æŠŠ text segment åˆåœ¨ä¸€èµ·</li><li>æ‹¿åˆ° data segment, æ‹¼æ¥åˆ°ä¸€èµ·</li><li>resolve reference, è§£å†³æ‰è·¨æ–‡ä»¶çš„ç¬¦å·ã€ä¾èµ–é—®é¢˜ï¼Œç”¨ç»å¯¹çš„åœ°å€å¡«å……</li></ul><p>å®é™…ä¸Šï¼Œ<code>beq</code> <code>bne</code> <code>jal</code> è¿™ç±» PC-relevant çš„æŒ‡ä»¤ä¸ä¼šè¢« relocate, è€Œç”¨ name/label ç›¸å…³çš„å’Œ static çš„ä¼š relocate.</p><h2 id="åŠ è½½"><a href="#åŠ è½½" class="headerlink" title="åŠ è½½"></a>åŠ è½½</h2><p>é€šå¸¸ OS ä¼šåŠ è½½ã€è¿è¡Œç¨‹åºï¼š</p><p><img src="https://image.mwish.me/blog-image/B3419A1F-3922-41B9-8134-4EC45ED97B81.png" alt="B3419A1F-3922-41B9-8134-4EC45ED97B81"></p><p>å®ƒéœ€è¦ï¼š</p><ol><li>è¯» executable æ–‡ä»¶ï¼ŒåŠ è½½ ELFï¼Œæ¥çŸ¥é“ text å’Œ data çš„å¤§å°</li><li>åˆ›å»ºå¸¦ stackã€text çš„åœ°å€ç©ºé—´</li><li>æŠŠ instruction å’Œ data æ‹·è´åˆ°æ–°çš„åœ°å€ç©ºé—´</li><li>æ‹·è´ç”¨æˆ·çš„å‚æ•°ï¼Œä¼ åˆ°æ ˆä¸Šï¼Œä¾›ç¨‹åºè¿è¡Œ</li><li>åˆå§‹åŒ–å¯„å­˜å™¨</li><li>è·³è½¬åˆ°ç”¨æˆ·ç¨‹åºï¼Œå¹¶è®¾ç½® PC</li></ol><h2 id="å…¨æµç¨‹"><a href="#å…¨æµç¨‹" class="headerlink" title="å…¨æµç¨‹"></a>å…¨æµç¨‹</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span> &#123;</span><br><span class="line"><span class="type">int</span> i;</span><br><span class="line"><span class="type">int</span> sum = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt;= <span class="number">100</span>; i++) </span><br><span class="line">sum += i * i;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;The sum of sq from 0 .. 100 is %d\n&quot;</span>, sum);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç¼–è¯‘åç”Ÿæˆï¼š</p><p><img src="https://image.mwish.me/blog-image/7D55935F-1A5F-426F-8332-0DC6BD807E4F.png" alt="7D55935F-1A5F-426F-8332-0DC6BD807E4F"></p><p>assembly çš„æ—¶å€™å¤„ç†ä¼ªæŒ‡ä»¤ï¼š</p><p><img src="https://image.mwish.me/blog-image/A7DC6FD7-197A-447C-9EC5-83058CEAE12C.png" alt="A7DC6FD7-197A-447C-9EC5-83058CEAE12C"></p><p>assembly çš„æ—¶å€™ç”Ÿæˆ symbol table å’Œ relocation tableï¼š</p><p><img src="https://image.mwish.me/blog-image/9B1A0E60-E85D-4982-93E0-E573ECFA3C87.png" alt="9B1A0E60-E85D-4982-93E0-E573ECFA3C87"></p><p>ä»¥ä¸Šçš„ä¿¡æ¯åœ¨é“¾æ¥çš„æ—¶å€™ä¸€èµ·ä½¿ç”¨ã€‚</p><h2 id="åŠ¨æ€é“¾æ¥åº“å’Œé™æ€é“¾æ¥åº“"><a href="#åŠ¨æ€é“¾æ¥åº“å’Œé™æ€é“¾æ¥åº“" class="headerlink" title="åŠ¨æ€é“¾æ¥åº“å’Œé™æ€é“¾æ¥åº“"></a>åŠ¨æ€é“¾æ¥åº“å’Œé™æ€é“¾æ¥åº“</h2><p>å¯¹äºé™æ€åº“è€Œè¨€ï¼Œå®ƒæ˜¯å¯æ‰§è¡Œæ–‡ä»¶çš„ä¸€éƒ¨åˆ†ï¼Œåº“æ›´æ–°äº†ï¼Œè¿è¡Œä¸­çš„ç¨‹åºéœ€è¦é‡æ–°ç¼–è¯‘ã€‚è¿™æ˜¯ç¼–è¯‘æ—¶é“¾æ¥çš„ã€‚</p><p>åœ¨ Linux ä¸‹ï¼Œæä¾›äº† <code>.a</code> æ–‡ä»¶ï¼Œç”¨äºå¤„ç†ï¼Œå•ä¸ªæ–‡ä»¶å³ä½¿æ²¡æœ‰ç”¨åˆ°æ‰€æœ‰éƒ¨åˆ†ï¼Œä¹Ÿéœ€è¦å…¨éƒ¨åŠ è½½ã€‚</p><p><img src="https://image.mwish.me/blog-image/1C5CB001-2512-4A02-8763-9C2EFC1A8EF5.png" alt="1C5CB001-2512-4A02-8763-9C2EFC1A8EF5"></p><p>åœ¨åŠ¨æ€é“¾æ¥åº“ä¸­ï¼Œå…è®¸ç¼–è¯‘æ—¶ã€è¿è¡Œæ—¶é“¾æ¥ã€‚</p><p><img src="https://image.mwish.me/blog-image/26164010-1C75-4033-9411-7ACB84CE5056.png" alt="26164010-1C75-4033-9411-7ACB84CE5056"></p><p>å…±äº«åº“æœ‰ <code>.so</code> æ–‡ä»¶ï¼Œå¼•ç”¨åº“çš„ç”¨æˆ·å¯ä»¥å…±äº«è¿™äº›æ•°æ®ï¼Œè€Œåœ¨å†…å­˜ä¸­ï¼Œå…±äº«åº“çš„<code>.text</code> å¯ä»¥å…±äº«å†…å­˜ï¼Œè¢«å¤šä¸ªè¿›ç¨‹ä½¿ç”¨ï¼š</p><p><img src="https://image.mwish.me/blog-image/CB2186D3-34AB-4CD5-800E-51575F0E357C.png" alt="CB2186D3-34AB-4CD5-800E-51575F0E357C"></p><p>CSAPP ä¸­ï¼ŒæŒ‡å¯¼å¯ä»¥åœ¨ <code>dlfcn.h</code> ä¸­ä½¿ç”¨è¯¥åŠŸèƒ½ã€‚</p><p>æ­¤å¤–ï¼Œä¸ºäº†å…±äº«ï¼Œéœ€è¦å¤„ç†ä½ç½®æ— å…³ä»£ç ï¼ˆPosition-Independent Code, PICï¼‰ã€‚è¿™éœ€è¦ <code>-fPIC</code> é€‰é¡¹ã€‚</p><p>å®ƒåœ¨ç¼–è¯‘æ—¶æˆåŠŸè®¾ç½®ä¸€ä¸ªä¾¿å®œé‡ï¼Œå¹¶åœ¨è¿è¡Œæ—¶ä¸æ”¹å˜è¿™ä¸ªä¾¿å®œé‡ï¼Œè®©ä»£ç èƒ½å¤Ÿè¿è¡Œä¾¿å®œé‡ä¸Šçš„ <code>.text</code></p><p><img src="https://image.mwish.me/blog-image/33F0D9AE-C4D1-4BEF-ADB8-0D486BB11089.png" alt="33F0D9AE-C4D1-4BEF-ADB8-0D486BB11089"></p><p>è€Œ PLT æ¡ç›®ç±»ä¼¼æ‡’æƒ°åŠ è½½ï¼Œä½œä¸ºé“¾æ¥çš„è¡¨æ¥å®Œæˆå·¥ä½œï¼š</p><p><img src="https://image.mwish.me/blog-image/910B0674-2C61-403D-B5A2-C5BBEFF0DE82.png" alt="910B0674-2C61-403D-B5A2-C5BBEFF0DE82"></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>RISC-V æŒ‡ä»¤æ ¼å¼</title>
      <link href="/2020/10/04/RISC-V-%E6%8C%87%E4%BB%A4%E6%A0%BC%E5%BC%8F/"/>
      <url>/2020/10/04/RISC-V-%E6%8C%87%E4%BB%A4%E6%A0%BC%E5%BC%8F/</url>
      
        <content type="html"><![CDATA[<p>å…ˆè´´å‡ ä¸ªå›¾</p><ul><li>RV32I æŒ‡ä»¤å›¾</li></ul><p><img src="https://image.mwish.me/blog-image/D35C054C-DCDE-4C29-BDC1-6637C915952B.png" alt="D35C054C-DCDE-4C29-BDC1-6637C915952B"></p><ul><li>ä¸‹é¢æ˜¯å…·ä½“çš„æŒ‡ä»¤æ ¼å¼</li></ul><p><img src="https://image.mwish.me/blog-image/83904B69-0871-4150-98DE-1F0EA0877D17.png" alt="83904B69-0871-4150-98DE-1F0EA0877D17"></p><ul><li>ä¸‹é¢æ˜¯æŒ‡ä»¤æ ¼å¼å±•å¼€çš„æ ¼å¼</li></ul><p><img src="https://image.mwish.me/blog-image/1B9BA357-6712-4A2D-B287-FE774DF41B4F.png" alt="1B9BA357-6712-4A2D-B287-FE774DF41B4F"></p><p>ä¸Šé¢å‡ å¼ å›¾å¯ä»¥åœ¨åŒ…äº‘å²—è€å¸ˆç¿»è¯‘çš„ RISC-V book é‡Œé¢æ‰¾åˆ°ã€‚</p><blockquote><p>å›¾ 2.2 æ˜¾ç¤ºäº†å…­ç§åŸºæœ¬æŒ‡ä»¤æ ¼å¼ï¼Œåˆ†åˆ«æ˜¯:ç”¨äºå¯„å­˜å™¨-å¯„å­˜å™¨æ“ä½œçš„ R ç±»å‹æŒ‡ä»¤ï¼Œç”¨äºçŸ­ç«‹å³æ•°å’Œè®¿å­˜ load æ“ä½œçš„ I å‹æŒ‡ä»¤ï¼Œç”¨äºè®¿å­˜ store æ“ä½œçš„ S å‹æŒ‡ä»¤ï¼Œç”¨äºæ¡ä»¶è·³è½¬æ“ä½œçš„ B ç±»å‹æŒ‡ä»¤ï¼Œç”¨äºé•¿ç«‹å³æ•°çš„ U å‹æŒ‡ä»¤å’Œç”¨äºæ— æ¡ä»¶è·³è½¬çš„ J å‹æŒ‡ä»¤ã€‚å›¾ 2.3 ä½¿ç”¨å›¾ 2.2 çš„æŒ‡ä»¤æ ¼å¼åˆ—å‡ºäº†å›¾ 2.1 ä¸­å‡ºç°çš„æ‰€æœ‰ RV32I æŒ‡ä»¤çš„æ“ä½œç .</p><p>ä¸ºäº†å¸®åŠ©ç¨‹åºå‘˜ï¼Œæ‰€æœ‰ä½å…¨éƒ¨æ˜¯ 0 æ˜¯éæ³•çš„ RV32I æŒ‡ä»¤ã€‚å› æ­¤, è¯•å›¾è·³è½¬åˆ°è¢«æ¸…é›¶çš„ å†…å­˜åŒºåŸŸçš„é”™è¯¯è·³è½¬å°†ä¼šç«‹å³è§¦å‘å¼‚å¸¸ï¼Œè¿™å¯ä»¥å¸®åŠ©è°ƒè¯•ã€‚ç±»ä¼¼åœ°ï¼Œæ‰€æœ‰ä½å…¨éƒ¨æ˜¯ 1 çš„æŒ‡ ä»¤ä¹Ÿæ˜¯éæ³•æŒ‡ä»¤ï¼Œå®ƒå°†æ•è·å…¶ä»–å¸¸è§çš„é”™è¯¯ï¼Œè¯¸å¦‚æœªç¼–ç¨‹çš„éæ˜“å¤±æ€§å†…å­˜è®¾å¤‡ã€æ–­å¼€è¿æ¥ çš„å†…å­˜æ€»çº¿æˆ–è€…åæ‰çš„å†…å­˜èŠ¯ç‰‡ã€‚</p></blockquote><h2 id="R-Format-Instruction"><a href="#R-Format-Instruction" class="headerlink" title="R-Format Instruction"></a>R-Format Instruction</h2><p>R-Format ç”¨äºå¯„å­˜å™¨-å¯„å­˜å™¨æ“ä½œ</p><p><img src="https://image.mwish.me/blog-image/98C5AAD5-6084-4061-9F60-2C4713515ACE.png" alt="98C5AAD5-6084-4061-9F60-2C4713515ACE"></p><h2 id="I-Format-Instruction"><a href="#I-Format-Instruction" class="headerlink" title="I-Format Instruction"></a>I-Format Instruction</h2><blockquote><p> ç”¨äºçŸ­ç«‹å³æ•°å’Œè®¿å­˜ load æ“ä½œçš„ I å‹æŒ‡ä»¤</p></blockquote><p><img src="https://image.mwish.me/blog-image/28CB5742-AD12-4C86-8AA8-7E8DCA8EF12E.png" alt="28CB5742-AD12-4C86-8AA8-7E8DCA8EF12E"></p><p>å¾ˆé‡è¦çš„æ˜¯ï¼ŒRISC-V æ‰€æœ‰çš„ç«‹å³æ•°éƒ½æ˜¯ signed çš„ã€‚ä¾‹å¦‚ï¼š</p><p><img src="https://image.mwish.me/blog-image/6415DC2D-0A51-49C5-B1AE-606145CEB81F.png" alt="6415DC2D-0A51-49C5-B1AE-606145CEB81F"></p><p>é™¤äº†è¿™ç§ <code>add imm</code>. load æ“ä½œä¹Ÿæ˜¯ I å‹çš„ï¼š</p><p><img src="https://image.mwish.me/blog-image/02D8BD3A-6757-4E0F-B976-A0B66ED9A93B.png" alt="02D8BD3A-6757-4E0F-B976-A0B66ED9A93B"></p><blockquote><p>Note: if instruction has immediate, then uses at most 2 registers (one source, one destination)</p></blockquote><p>load çš„æ¨¡å¼é€šå¸¸æ˜¯ <code>load rd, rs</code> æˆ–è€… <code>load rd, imm(rs)</code>.</p><h2 id="S-Format"><a href="#S-Format" class="headerlink" title="S-Format"></a>S-Format</h2><p>éœ€è¦ä¿å­˜2ä¸ª Register å’Œä¸€ä¸ªå°çš„ imm:</p><p><img src="https://image.mwish.me/blog-image/5890A79A-BC93-4D19-AC79-447D0273E059.png" alt="5890A79A-BC93-4D19-AC79-447D0273E059"></p><blockquote><p>RISC-V design decision is move low 5 bits of immediate to where rd field was in other instructions â€“ keep <strong>rs1</strong>/<strong>rs2</strong> fields in same place.</p></blockquote><p>å› ä¸º store åªæ˜¯æŠŠå¯„å­˜å™¨çš„å­˜åˆ°å†…å­˜ä¸­ï¼Œæ‰€ä»¥æ²¡æœ‰â€œç›®æ ‡å¯„å­˜å™¨â€ã€‚</p><hr><p>ä»¥ä¸ŠæŒ‡ä»¤ä¸­ï¼Œä½ ä¼šå‘ç°ï¼ŒRISC-V å¸Œæœ› <code>rs1</code> <code>rs2</code> <code>rd</code> ä¸‰ä¸ªå¯„å­˜å™¨ <strong>å­˜åœ¨çš„è¯å³æœ‰ç›¸åŒçš„ä½ç½®</strong>ã€‚</p><blockquote><ul><li>By always placing the read sources in the same place, the register file can read without hesitation. If the data ends up being unnecessary (e.g. I-Type), it can be ignored</li></ul></blockquote><hr><h2 id="B-Format-å’Œ-Label"><a href="#B-Format-å’Œ-Label" class="headerlink" title="B-Format å’Œ Label"></a>B-Format å’Œ Label</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">BEQx1,x2,Label</span><br></pre></td></tr></table></figure><p>ä¸Šé¢æ˜¯ä¸€ä¸ªå¾ˆæ­£å¸¸çš„è·³è½¬æŒ‡ä»¤ï¼Œä½†æ˜¯æœ¬èº« .label å¦‚ä½•åœ¨æœºå™¨ç ä¸Šå­˜åœ¨å‘¢ï¼Ÿ</p><p>åœ¨ RISC-V ä¸­ï¼Œä¸€åˆ‡éƒ½æ˜¯æœ‰å†…å­˜ä½ç½®çš„ï¼ŒåŒ…æ‹¬æŒ‡ä»¤ï¼Œé‚£ä¹ˆè·³è½¬åˆ°å¯¹åº”æŒ‡ä»¤çš„å†…å­˜å³å¯ã€‚åœ¨è¿™é‡Œï¼Œå› ä¸º <code>.code</code> ç«¯æœ¬èº«å ç”¨å†…å­˜çš„å¤§å°æœ‰é™ï¼Œæ‰€ä»¥è¿™é‡Œä½¿ç”¨ PC-Relative Addressing:</p><ul><li>ä½¿ç”¨ <code>imm</code> å­—æ®µï¼Œè¡¨ç¤º PC çš„äºŒè¿›åˆ¶è¡¥ç åç§»é‡ã€‚ï¼ˆ<code>Could specify Â± 211 addresses offset from the PC</code>)</li><li>To improve the reach of a single branch instruction, <em>in principle</em>, could multiply the offset by four bytes before adding to PC (<em>instructions are 4 bytes and word aligned</em>). å› ä¸ºæˆ‘ä»¬çš„ RV32I éƒ½æ˜¯ 32bits çš„ï¼Œè€Œä¸”æ˜¯ 4bytes align çš„ï¼Œæ‰€ä»¥å¯ä»¥æŠŠåç§»é‡ <code>* 32</code></li><li>This would allow one branch instruction to reach <code>Â± 211 Ã— 32-bit</code> instructions either side of PC</li></ul><p>ä½†æ˜¯ï¼Œè€ƒè™‘å‹ç¼©æŒ‡ä»¤ï¼Œå³æ‰©å±•çš„ 16-bit instructionsï¼ŒRISC-V éœ€è¦æ”¯æŒçš„è¿˜æœ‰ 16bits çš„æ‰©å±•æŒ‡ä»¤ã€‚</p><ul><li>To enable this, RISC-V always scales the branch offset by 2 bytes - even when there are no 16-bit instructions</li></ul><p>æ‰€ä»¥éœ€è¦å¤„ç† size, ä¸èƒ½ <code>*32</code>, </p><p>åœ¨ RISC-V ä¸­ï¼Œconditional branch é€»è¾‘å¦‚ä¸‹ï¼š</p><ul><li>å¦‚æœè·³è½¬æˆåŠŸäº†ï¼Œ<code>PC = PC + imm</code>, imm æ˜¯äºŒè¿›åˆ¶è¡¥ç ï¼Œæ˜¯ signed çš„</li><li>å¦åˆ™ï¼Œ<code>PC = PC + 4</code></li></ul><p>æœ€åï¼ŒæŒ‡ä»¤çš„æ”¯æŒå½¢å¼å¦‚ä¸‹</p><p><img src="https://image.mwish.me/blog-image/8E9E3C64254443AF66A352BF0DD83DB4.png" alt="8E9E3C64254443AF66A352BF0DD83DB4"></p><p><img src="https://image.mwish.me/blog-image/7ACB61F8-C66F-4612-9DBD-1F7095D2CE9E.png" alt="7ACB61F8-C66F-4612-9DBD-1F7095D2CE9E"></p><p>ä¸‹é¢ç»™äº†ä¸€ä¸ªä¾‹å­ï¼š</p><p><img src="https://image.mwish.me/blog-image/36F645F0-136D-449D-BCCF-97C8ED834226.png" alt="36F645F0-136D-449D-BCCF-97C8ED834226"></p><p>ä»¥ä¸Šæ˜¯ 16bytesï¼Œè€Œæˆ‘ä»¬æœ‰ <code>imm[12]</code>, åç§»é‡ç›¸å½“äºä¹˜äº† byteï¼ŒåŒæ—¶é¢„ç•™äº†ä¸€ä¸ªè™šæ‹Ÿ <code>0</code> bit, ç›¸å½“äº <code>*2byte</code>, å®åœ¨ä¸å¤Ÿï¼Œä¼šä½¿ç”¨ <code>branch</code> + <code>jal</code> çš„æ–¹å¼æ”¯æŒã€‚</p><h2 id="U-Format"><a href="#U-Format" class="headerlink" title="U-Format"></a>U-Format</h2><blockquote><p> ç”¨äºé•¿ç«‹å³æ•°çš„ U å‹æŒ‡ä»¤</p></blockquote><p><img src="https://image.mwish.me/blog-image/04E9659D-BA95-4219-ACF8-A031BD9F7472.png" alt="04E9659D-BA95-4219-ACF8-A031BD9F7472"></p><ul><li>AUIPC â€“ Add Upper Immediate to PC</li><li>LUI â€“ Load Upper Immediate</li></ul><p>æ³¨æ„è¿™ä¿©å¯¹åº”çš„éƒ½æ˜¯é«˜ä½ã€‚å¯ä»¥ç”¨ <code>lui</code> + <code>addi</code> æ„é€  32ä½çš„æ•°ï¼ˆæ¯•ç«Ÿç«‹å³æ•°ä¸å¤Ÿå¤§ï¼‰ã€‚</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ<code>addi</code> æŒ‡ä»¤ä¸­ï¼Œå†™å…¥ <code>imm[11:0]</code>, çœ‹ä¸Šå»å’Œ lui æ²¡æœ‰å†²çªï¼Œä½†æ˜¯å¦‚æœæ„é€  <code>0xDEADBEEF</code>è¿™ç§ï¼Œå› ä¸ºè¿™è¾†éƒ½æ˜¯äºŒè¿›åˆ¶è¡¥ç ï¼Œéœ€è¦å¤„ç†ä½12ä½ä¸­ï¼Œ<code>imm[11]</code> æ˜¯ 1çš„é—®é¢˜ï¼Œè¿™ä¼šå¯¼è‡´æ•´ä¸ªç»“æœæˆä¸€ä¸ªè´Ÿæ•°ã€‚</p><p>è¿™é‡Œæˆ‘ä»¬è¦å›åˆ°äºŒè¿›åˆ¶è¡¥ç çš„ç‰¹ç‚¹ï¼šåŠ ä¸€ä¸ªè´Ÿæ•°çš„æ—¶å€™åŠ æ³•ä»ç„¶æ˜¯æŒ‰ä½åŠ çš„ï¼Œä½†æ˜¯è¿›ä½æ˜¯è¦ä»é«˜ä½ <code>-1</code> çš„ ã€‚è¿™é‡Œéœ€è¦é«˜ä½å† <code>+1</code> å†å¤„ç†ã€‚</p><p><img src="https://image.mwish.me/blog-image/80146EE9-9531-455F-86F9-1C7BBB41A9A8.png" alt="80146EE9-9531-455F-86F9-1C7BBB41A9A8"></p><h2 id="J-Format"><a href="#J-Format" class="headerlink" title="J-Format"></a>J-Format</h2><p>ä¸‹é¢æ˜¯ JAL å’Œ JALR</p><p><img src="https://image.mwish.me/blog-image/BECEBBA9-B72D-4E25-A767-DD54718C7AA5.png" alt="BECEBBA9-B72D-4E25-A767-DD54718C7AA5"></p><p><code>jal</code> æ ¹æ® <code>imm</code> æ¥è·³è·ƒï¼Œ<code>rd</code> å­˜å‚¨ã€‚è¿™ä¸ª <code>jal</code> ä¸­éµå¾ªå’Œ branch ä¸­ä¸€æ ·çš„æµ‹è¯•ï¼Œå³ <code>*2byte</code></p><p><img src="https://image.mwish.me/blog-image/96F9098A-5CC8-4041-8448-92AAFAA92718.png" alt="96F9098A-5CC8-4041-8448-92AAFAA92718"></p><p><code>jalr</code> ä¸­ï¼ŒæŠŠç»“æœå­˜åˆ°å¯„å­˜å™¨ä¸­, æ³¨æ„ï¼Œè¿™å›å„¿å®ƒå°±ä¸ <code>*2byte</code> äº†</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Integer &amp; Endian</title>
      <link href="/2020/09/19/Integer-Endian/"/>
      <url>/2020/09/19/Integer-Endian/</url>
      
        <content type="html"><![CDATA[<p>å¤æ—©å†™è¿‡ä¸€ç¯‡ï¼š<a href="https://zhuanlan.zhihu.com/p/94406822">https://zhuanlan.zhihu.com/p/94406822</a></p><h2 id="Twoâ€™s-Complement-äºŒè¿›åˆ¶è¡¥ç "><a href="#Twoâ€™s-Complement-äºŒè¿›åˆ¶è¡¥ç " class="headerlink" title="Twoâ€™s Complement(äºŒè¿›åˆ¶è¡¥ç )"></a>Twoâ€™s Complement(äºŒè¿›åˆ¶è¡¥ç )</h2><p>è™½ç„¶è¿™æ˜¯å¤§éƒ¨åˆ†å…¥é—¨è®¡ç®—æœºçš„äººéƒ½å­¦è¿‡çš„â€”â€”ä¸å¦‚è¯´æ•´ç¯‡æ–‡ç« éƒ½æ˜¯ï¼Œä½†æ˜¯æˆ‘ä»¬è¿˜æ˜¯èµ°æµç¨‹å¤ä¹ ä¸€é</p><p>å¦‚æœè¡¨ç¤º <code>unsigned</code> ç›¸å¯¹æ¥è¯´å¾ˆç®€å•ï¼Œé‚£ä¹ˆè¡¨ç¤º signed å°±ä¸è¡Œäº†ã€‚æˆ‘ä»¬å¯ä»¥å…ˆéªŒçš„çŸ¥é“ä¸€äº›ç»“è®ºï¼Œä¾‹å¦‚ï¼š</p><p><a href="https://en.cppreference.com/w/cpp/language/types">https://en.cppreference.com/w/cpp/language/types</a></p><ul><li>char çš„èŒƒå›´æ˜¯ <code>-128 to 127</code></li></ul><p>é‚£ä¹ˆï¼Œæ•™ç§‘ä¹¦å¯èƒ½ä¼šæåˆ°çš„ä¸€äº›æœ´ç´ çš„å®ç°ï¼šæ¯”æ–¹è¯´ç”¨è¾¹ç¼˜çš„æŸä¸€ä½è¡¨ç¤º signed æˆ–è€… unsigned. å› ä¸ºè¿™æ ·å¯èƒ½ä¼šæœ‰ä¸€ä¸ª +0 å’Œä¸€ä¸ª -0</p><p>ä¸è¿‡æˆ‘ä»¬å›å¿†ä¸€ä¸‹ï¼Œä¹Ÿæœ‰è¿™ç§æ¨¡å‹æ¥çš„ä¸æ˜¯ï¼Œæ¯”å¦‚ IEEE æµ®ç‚¹æ•°ã€‚</p><h3 id="Sign-and-Magnitude-æœ€é«˜ä½è¡¨ç¤º-signed"><a href="#Sign-and-Magnitude-æœ€é«˜ä½è¡¨ç¤º-signed" class="headerlink" title="Sign and Magnitude: æœ€é«˜ä½è¡¨ç¤º signed"></a>Sign and Magnitude: æœ€é«˜ä½è¡¨ç¤º signed</h3><p>ä¼šå¼•å…¥ <code>+0</code> <code>-0</code> ï¼ŒåŒæ—¶ï¼ŒåŠ æ³•/å‡æ³•éœ€è¦ä¸åŒçš„è¡Œä¸ºã€‚</p><p><a href="https://en.wikipedia.org/wiki/Signed_number_representations#Signed_magnitude_representation">https://en.wikipedia.org/wiki/Signed_number_representations#Signed_magnitude_representation</a></p><h3 id="Oneâ€™s-Complement"><a href="#Oneâ€™s-Complement" class="headerlink" title="Oneâ€™s Complement"></a>Oneâ€™s Complement</h3><blockquote><p>positive numbers have leading 0s, negative numbers have leadings 1s.</p></blockquote><p><a href="https://en.wikipedia.org/wiki/Ones&#39;_complement">https://en.wikipedia.org/wiki/Ones%27_complement</a></p><p>å½“ç„¶è¿™ä¸ªä¹Ÿæœ‰ <code>+0</code> <code>-0</code> çš„é—®é¢˜ï¼ŒOneâ€™s Complement ä¹Ÿæ˜¯æœ€é«˜ä½è¡¨ç¤º signed/unsigned çš„</p><p>è¿™ä¸ªåŠ å‡æ³•éƒ½å¯ä»¥ä¸€å®šç¨‹åº¦ä¸Šç»Ÿä¸€ï¼Œä½†æ˜¯ä¼šå¸¦æ¥ negative zero çš„é—®é¢˜ï¼Œè€Œä¸å¸¦æ¥ negative zero åˆç»™è®¡ç®—å¢åŠ äº†é¢å¤–çš„å¤æ‚åº¦ã€‚</p><h3 id="Twoâ€™s-complement"><a href="#Twoâ€™s-complement" class="headerlink" title="Twoâ€™s complement"></a>Twoâ€™s complement</h3><p><a href="https://en.wikipedia.org/wiki/Two&#39;s_complement#Arithmetic_operations">https://en.wikipedia.org/wiki/Two%27s_complement#Arithmetic_operations</a></p><p><a href="https://zh.wikipedia.org/wiki/äºŒè£œæ•¸">https://zh.wikipedia.org/wiki/%E4%BA%8C%E8%A3%9C%E6%95%B8</a></p><p>ç°åœ¨æœ‰äº† two complement, è¿™ä¸ªé—®é¢˜å°±è¢«å¾ˆå¥½åœ°è§£å†³å•¦ï¼</p><p>æœ¬èŠ‚ï¼Œå®Œç»“ï¼</p><h2 id="Store-data-in-memory"><a href="#Store-data-in-memory" class="headerlink" title="Store data in memory"></a>Store data in memory</h2><p>è¿™ä¸€èŠ‚æˆ–è®¸éœ€è¦å›é¡¾ï¼š<a href="https://zhuanlan.zhihu.com/p/118749234">https://zhuanlan.zhihu.com/p/118749234</a></p><p>å½“æ•°æ®å­˜åœ¨å†…å­˜çš„æ—¶å€™ï¼Œæˆ‘ä»¬æˆ–è®¸ä¼šæœ‰å­—èŠ‚æµï¼š<code>0x28872887</code>ï¼Œå‡å¦‚è¿™é‡Œé¢å…¨æ˜¯32ä½æœ‰ç¬¦å·æ•´æ•°ï¼Œæˆ‘ä»¬æ€ä¹ˆè§£é‡Šå®ƒä»¬å‘¢ï¼Ÿ</p><p>åœ¨ 32ä½ RISC-V ä¸­ï¼Œæˆ‘ä»¬æ˜¯ Little-Endian çš„ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬æœ‰å¦‚ä¸‹å¸ƒå±€ï¼š</p><p><img src="https://image.mwish.me/blog-image/DE4A8B7C-67CC-4304-A0BC-2721362FB6B1.png" alt="DE4A8B7C-67CC-4304-A0BC-2721362FB6B1"></p><p>å‘ç°æ²¡æœ‰ï¼Œæ¯ä¸ª byte çš„é¡ºåºæ˜¯ä¸å˜çš„ï¼Œä½†æ˜¯ä¸€ä¸ª 16 ä½æ•´æ•°ä¸­ï¼Œ byte ä¹‹é—´çš„é¡ºåºæ˜¯ä¸ä¸€æ ·çš„ï¼Œå¯¹äº <code>0x28</code> æ¥è¯´ï¼Œå¦‚æœæˆ‘ä»¬æ˜¯ Little Endian, é‚£ä¹ˆï¼Œæˆ‘ä»¬æ˜¯ <code>0x28</code>, è€Œå¯¹äº BigEndian æ¥è¯´ï¼Œæˆ‘ä»¬æ˜¯ <code>0x82</code>.</p><p>é‚£ä¹ˆå†å›åˆ° <code>0x28872887</code>, å‡è®¾æˆ‘ä»¬ä¼šæœ‰ä¸€ä¸ª <code>int32_t s[4]</code> å˜æˆäº†ä»¥ä¸Šçš„ <code>0x28872887</code>ï¼Œæˆ–è€…æœ‰ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">X</span> &#123;</span></span><br><span class="line">  <span class="type">int</span> i1;</span><br><span class="line">  <span class="type">int</span> i2;</span><br><span class="line">  <span class="type">int</span> i3;</span><br><span class="line">  <span class="type">int</span> i4;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆï¼Œä»–ä»¬ä¼šæ€ä¹ˆåŠï¼Ÿå‡å¦‚æ˜¯å¤§ç«¯åºï¼Ÿç­”æ¡ˆæ˜¯ i1 i2 i3 i4 ä»ç„¶åªä»£è¡¨ <code>0x28</code> <code>0x87</code> <code>0x28</code> <code>0x87</code> æ‰€åœ¨çš„é‚£ 16ä½ï¼Œè¿™ä¸ªé¡ºåºæ˜¯ä¸ä¼šæ”¹å˜çš„ã€‚</p><h3 id="Optimization"><a href="#Optimization" class="headerlink" title="Optimization"></a>Optimization</h3><p><a href="https://en.wikipedia.org/wiki/Endianness#Optimization">https://en.wikipedia.org/wiki/Endianness#Optimization</a></p><p>Little-Endian æä¾›äº†ä¸€ä¸ªå¾ˆå¥½çš„æ€§è´¨ï¼Œå¸®åŠ©ç”¨æˆ·å®Œæˆä¸Šè¿°çš„ä¼˜åŒ–ã€‚</p><h3 id="è½¬åŒ–"><a href="#è½¬åŒ–" class="headerlink" title="è½¬åŒ–"></a>è½¬åŒ–</h3><p>ä½ æ¥è§¦è¿‡ Unix ç½‘ç»œç¼–ç¨‹çš„è¯ï¼Œå¯èƒ½ä¼šå¯¹ä¸‹åˆ—çš„ api æœ‰ä¸€å®šå°è±¡ï¼š</p><p><a href="https://linux.die.net/man/3/htons">https://linux.die.net/man/3/htons</a></p><p>ç½‘ç»œä¼ è¾“ä¸€èˆ¬é‡‡ç”¨å¤§ç«¯åºï¼Œä¹Ÿè¢«ç§°ä¹‹ä¸ºç½‘ç»œå­—èŠ‚åºï¼Œæˆ–<em>ç½‘ç»œåº</em>ã€‚ç°åœ¨å‡è®¾ä½ åšäº†ä¸€ä¸ªç¨‹åºï¼Œéœ€è¦ä»ç½‘ç»œè¯»å†™ï¼Œå¯ä»¥èµ°ä¸Šé¢è¿™ä¸€å¥—â€¦</p><p>ç­‰ç­‰ï¼Œæˆ‘ä»¬æ˜¯ä¸æ˜¯å¿½ç•¥äº†ä»€ä¹ˆï¼Ÿé‚£æµ®ç‚¹æ•°å‘¢ï¼Ÿ</p><p>æˆ‘ä»¬éƒ½çŸ¥é“æµ®ç‚¹æ•°æœ‰ IEEE 754 æ ‡å‡†ï¼Œé‚£ä¹ˆï¼š</p><blockquote><h3 id="Floating-point-edit"><a href="#Floating-point-edit" class="headerlink" title="Floating point[edit]"></a>Floating point[<a href="https://en.wikipedia.org/w/index.php?title=Endianness&amp;action=edit&amp;section=8">edit</a>]</h3><p>Although the ubiquitous x86 processors of today use little-endian storage for all types of data (integer, floating point), there are a number of hardware architectures where <a href="https://en.wikipedia.org/wiki/Floating-point">floating-point</a> numbers are represented in big-endian form while integers are represented in little-endian form.<a href="https://en.wikipedia.org/wiki/Endianness#cite_note-16">[13]</a> There are <a href="https://en.wikipedia.org/wiki/ARM_architecture">ARM</a> processors that have half little-endian, half big-endian floating-point representation for double-precision numbers: both 32-bit words are stored in little-endian like integer registers, but the most significant one first. Because there have been many floating-point formats with no â€œ<a href="https://en.wikipedia.org/wiki/Computer_network">network</a>â€œ standard representation for them, the <a href="https://en.wikipedia.org/wiki/External_Data_Representation">XDR</a> standard uses big-endian IEEE 754 as its representation. It may therefore appear strange that the widespread <a href="https://en.wikipedia.org/wiki/IEEE_754">IEEE 754</a> floating-point standard does not specify endianness.<a href="https://en.wikipedia.org/wiki/Endianness#cite_note-17">[14]</a> Theoretically, this means that even standard IEEE floating-point data written by one machine might not be readable by another. However, on modern standard computers (i.e., implementing IEEE 754), one may in practice safely assume that the endianness is the same for floating-point numbers as for integers, making the conversion straightforward regardless of data type. (Small <a href="https://en.wikipedia.org/wiki/Embedded_system">embedded systems</a> using special floating-point formats may be another matter however.)</p></blockquote><p>åœ¨ boost.endianä¸­ï¼Œç”šè‡³å¯¹ floating point åªæœ‰æœ‰é™çš„æ”¯æŒï¼š</p><blockquote><p>Is there floating point support?</p><p>An attempt was made to support four-byte <code>float</code>s and eight-byte <code>double</code>s, limited to <a href="http://en.wikipedia.org/wiki/IEEE_floating_point">IEEE 754</a> (also known as ISO/IEC/IEEE 60559) floating point and further limited to systems where floating point endianness does not differ from integer endianness. Even with those limitations, support for floating point types was not reliable and was removed. For example, simply reversing the endianness of a floating point number can result in a signaling-NAN.</p><p>Support for <code>float</code> and <code>double</code> has since been reinstated for <code>endian_buffer</code>, <code>endian_arithmetic</code> and the conversion functions that reverse endianness in place. The conversion functions that take and return by value still do not support floating point due to the above issues; reversing the bytes of a floating point number does not necessarily produce another valid floating point number.</p></blockquote><h3 id="èµ°å‘-Reader"><a href="#èµ°å‘-Reader" class="headerlink" title="èµ°å‘ Reader"></a>èµ°å‘ Reader</h3><p>æ‰€ä»¥ï¼Œå½“æˆ‘ä»¬è¯»å–çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¯èƒ½æœ‰å¤§ç«¯åºçš„æ•´æ•°è¯»å–ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Read_</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* buf, T* v)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">static_assert</span>(is_fundamental_v&lt;T&gt;);</span><br><span class="line">  *v = buf[<span class="number">0</span>];</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">1</span>; i &lt; <span class="built_in">sizeof</span>(T); ++i) &#123;</span><br><span class="line">    *v &lt;&lt;= <span class="number">8</span>;</span><br><span class="line">    *v |= <span class="built_in">static_cast</span>&lt;<span class="type">uint8_t</span>&gt;(buf[i]);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="æ•´å‹è½¬æ¢"><a href="#æ•´å‹è½¬æ¢" class="headerlink" title="æ•´å‹è½¬æ¢"></a>æ•´å‹è½¬æ¢</h2><blockquote><h4 id="æ•´å‹è½¬æ¢-1"><a href="#æ•´å‹è½¬æ¢-1" class="headerlink" title="æ•´å‹è½¬æ¢"></a>æ•´å‹è½¬æ¢</h4><p>ä»»ä½•æ•´æ•°ç±»å‹æˆ–æ— ä½œç”¨åŸŸæšä¸¾ç±»å‹çš„<a href="https://zh.cppreference.com/w/cpp/language/value_category#.E7.BA.AF.E5.8F.B3.E5.80.BC">çº¯å³å€¼</a>éƒ½å¯éšå¼è½¬æ¢æˆä»»ä½•å…¶ä»–æ•´æ•°ç±»å‹ã€‚è‹¥å…¶è½¬æ¢åˆ—å‡ºäºæ•´æ•°ç±»å‹æå‡ä¹‹ä¸‹ï¼Œåˆ™å®ƒæ˜¯æå‡è€Œéè½¬æ¢ã€‚</p><ul><li><p>è‹¥ç›®æ ‡ç±»å‹ä¸ºæ— ç¬¦å·ï¼Œåˆ™ç»“æœå€¼æ˜¯ç­‰äºæºå€¼<a href="https://en.wikipedia.org/wiki/Modular_arithmetic">æ¨¡</a> <em>2n<br>\</em> çš„æœ€å°æ— ç¬¦å·å€¼ï¼Œå…¶ä¸­ <em>n</em> æ˜¯ç”¨äºè¡¨ç¤ºç›®æ ‡ç±»å‹çš„ä½æ•°ã€‚</p></li><li><p>è‹¥ç›®æ ‡ç±»å‹æœ‰ç¬¦å·ï¼Œåˆ™å½“æºæ•´æ•°èƒ½ä»¥ç›®æ ‡ç±»å‹è¡¨ç¤ºæ—¶ï¼Œä¸æ›´æ”¹å…¶å€¼ã€‚å¦åˆ™ç»“æœæ˜¯å®ç°å®šä¹‰çš„ (C++20 å‰)ä¸æºå€¼å¯¹ <em>2n<br>\</em> åŒä½™çš„å”¯ä¸€ç›®æ ‡ç±»å‹å€¼ï¼Œå…¶ä¸­ <em>n</em> æ˜¯ç”¨äºè¡¨ç¤ºç›®æ ‡ç±»å‹çš„ä½æ•° (C++20 èµ·)ï¼ˆæ³¨æ„è¿™ä¸åŒäºæœªå®šä¹‰çš„<a href="https://zh.cppreference.com/w/cpp/language/operator_arithmetic#.E6.BA.A2.E5.87.BA">æœ‰ç¬¦å·æ•´æ•°ç®—æœ¯æº¢å‡º</a>ï¼‰ã€‚</p></li><li>è‹¥æºç±»å‹ä¸º boolï¼Œåˆ™å€¼ false è½¬æ¢ä¸ºç›®æ ‡ç±»å‹çš„é›¶ï¼Œè€Œå€¼ true è½¬æ¢æˆç›®æ ‡ç±»å‹çš„ä¸€ï¼ˆæ³¨æ„è‹¥ç›®æ ‡ç±»å‹ä¸º intï¼Œåˆ™è¿™æ˜¯æ•´æ•°ç±»å‹æå‡ï¼Œè€Œéæ•´æ•°ç±»å‹è½¬æ¢ï¼‰ã€‚</li><li>è‹¥ç›®æ ‡ç±»å‹ä¸º boolï¼Œåˆ™è¿™æ˜¯å¸ƒå°”è½¬æ¢ï¼ˆè§ä¸‹æ–‡ï¼‰ã€‚</li></ul></blockquote><p>äº‹å®ä¸Šï¼ŒTiKV ä»£ç ä¾èµ–äº†è¿™ç‚¹ï¼Œunsigned/signed åœ¨ä¸‹å±‚ç»Ÿä¸€ç”¨ <code>signed</code> è¡¨ç¤ºï¼Œç„¶åä¾èµ–è½¬æ¢çš„è¯­ä¹‰ã€‚</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>tenet è§‚å½±ç¬”è®°</title>
      <link href="/2020/09/07/tenet-%E8%A7%82%E5%BD%B1%E7%AC%94%E8%AE%B0/"/>
      <url>/2020/09/07/tenet-%E8%A7%82%E5%BD%B1%E7%AC%94%E8%AE%B0/</url>
      
        <content type="html"><![CDATA[<h1 id="é€†è½¬çš„æ—¶é—´"><a href="#é€†è½¬çš„æ—¶é—´" class="headerlink" title="é€†è½¬çš„æ—¶é—´"></a>é€†è½¬çš„æ—¶é—´</h1><p>2010ä¸Šæ˜ çš„ç›—æ¢¦ç©ºé—´ä¸­ï¼Œå¯¼æ¼”è¯ºå…°å°è¯•äº†ä»¥æ¢¦å¢ƒæ¥æ‰­æ›²ç©ºé—´è¿›è¡Œå™äº‹ã€‚å½¼æ—¶ç”µå½±åœ¨å›½å†…å¤§å—å¥½è¯„ï¼Œç¬”è€…åœ¨è¯»åˆä¸­çš„æ—¶å€™ï¼Œåœ¨è´´å§ä¸Šçœ‹åˆ°ç½‘å‹å¤§å‘¼â€œçƒ§è„‘â€ã€‚2020å¹´ï¼Œè¯ºå…°å¯¼æ¼”å°è¯•äº†æ—¶é—´ä¸Šçš„æ‰­æ›²ã€‚éœ€è¦è¯´æ˜çš„æ˜¯ï¼Œè¿™ä¸ä»…æ˜¯è®¾å®šä¸Šå¯¹äºæ—¶é—´çš„æ‰­æ›²ï¼Œè€Œä¸”åŒ…æ‹¬åœ¨è§†è§‰æ•ˆæœä¸Šçš„é€†æ—¶é—´è¡Œèµ°ï¼Œè¿™ä¸€æ¬¡ä½œå“è¯„ä»·ä»»ç„¶â€œçƒ§è„‘â€ï¼Œä½†å´è¤’è´¬ä¸ä¸€ã€‚</p><p>éœ€è¦è¯´æ˜çš„æ˜¯ï¼Œç©å¼„æ—¶é—´å¹¶ä¸æ˜¯ä»€ä¹ˆæ–°é²œäº‹ï¼Œæ—¶é—´æ—…è¡Œçš„åŸå‹å¤§æ¦‚æ¥è‡ª 1843 å¹´çš„ A Christmas Carol. è‘—åçš„ Docker Who ç³»åˆ—ä¹Ÿæœ‰å¯¹æœ¬ä½œçš„è‡´æ•¬ã€‚è€Œç§‘å¹»é»„é‡‘æ—¶ä»£ï¼Œæ›´æ˜¯æœ‰ã€Šæ°¸æ’çš„ç»ˆç»“ã€‹ã€ã€Šä½ ä»¬è¿™äº›å›é­‚å°¸ã€‹è¿™æ ·ç»å…¸çš„ä½œå“ï¼Œä»¥åŠã€Šå›åˆ°æœªæ¥ã€‹ç­‰ç»å…¸çš„ä½œå“ï¼Œç”šè‡³æ—¶é—´æ—©å·²æˆä¸ºç§‘å¹»ä½œå®¶çš„æ‹¿æ‰‹å¥½æˆï¼Œå®ƒæœ¬èº«å¯ä»¥å¸¦æ¥è´è¶æ•ˆåº”å¼çš„æ”¹å˜ã€åœ¨æ—¶é—´è½´ä¸Šæ—…è¡Œçš„ä¼¦ç†é—®é¢˜ã€æ—¶é—´äº§ç”Ÿçš„æ‚–è®ºã€ä¸å¯æŠ—æ‹’çš„å‘½è¿ã€ä¸ªäººçš„è‡ªç”±æ„å¿—ã€ä¸åŒæ—¶é—´è½´ä¸Šå¿è¿˜æ—¶é—´å€ºçš„å­¤ç‹¬ï¼Œç”šè‡³åŒ…æ‹¬17å¹´çš„çº¦å®šè¿™ç§å™äº‹ä¸Šçš„éª—å±€ã€‚è¿™éƒ½æ˜¯æ—¶é—´çš„å¸¸ç”¨è€ƒé‡ã€‚åœ¨è§£æ„ä¸»ä¹‰çš„åŠ¨ç”»\<Rick&Morty\>é‡Œï¼Œä¸»è§’ä»¬ç”šè‡³å¤šæ¬¡ä»¥æ—¶é—´æ—…è¡Œçš„å½¢å¼å˜²è®½â€œè¿™ä¸€å¥—å·²ç»çƒ‚å¤§è¡—äº†â€ã€‚</p><p>è€Œé€†ç€æ—¶å…‰è¡Œèµ°ä¹Ÿå¹¶é2020å¹´æ‰æœ‰çš„è®¾å®šï¼Œåœ¨æµ·ä¼¯åˆ©å®‰ä¸­ï¼Œå…‰é˜´å†¢æ¥è‡ªæœªæ¥ï¼Œåƒé­”é¬¼åˆåƒç¥æ˜çš„ä¼¯åŠ³é€†ç€æ—¶å…‰è€Œè¡Œèµ°ï¼›åœ¨ã€Šä½ ä¸€ç”Ÿçš„æ•…äº‹ã€‹ä¸­ï¼Œä¸»è§’é€šè¿‡æ–‡å­—é¢†æ‚Ÿäº†æ—¶é—´ç»´åº¦ä¸Šçš„è‡ªæˆ‘ï¼›è€Œä¸€æ­¥æ­¥è¿”è€è¿˜ç«¥ï¼Œä¹Ÿæ˜¯ç§‘å¹»æåˆ°çš„é¢˜æã€‚ä¸è¿‡ä¸å¾—ä¸è¯´ï¼Œä»¥ä¸Šå‡ ä¸ªä¾‹å­ä¸­ï¼Œå…‰é˜´å†¢å’Œä¼¯åŠ³æ²¡æœ‰è¢«ä»ç¬¬ä¸€è§†è§’æå†™è¿‡ï¼Œä½ ä¸€ç”Ÿçš„æ•…äº‹åˆ™é¢†æ‚Ÿå¤šäºæå†™ï¼Œå¤§éƒ¨åˆ†è¿”è€è¿˜ç«¥çš„ä¾‹å­ä¸­ï¼Œäººä»¬å’Œåˆ«äººè¡Œèµ°åœ¨åŒæ ·çš„æ—¶é—´å‰ªå¤´ä¸Šï¼Œåªæ˜¯è‡ªå·±ä¸€æ­¥ä¸€æ­¥å˜å¹´è½»ã€‚TeneT å¡‘é€ çš„æ˜¯å®Œå…¨å¯¹ç€æ—¶é—´åå‘è¡Œèµ°çš„ä¸»è§’ï¼Œå¹¶ä¸”åœ¨è§†è§‰ä¸Šç”¨é€†å‘è¡¨ç°äº†è¿™ä¸€ç‚¹ã€‚è¿™ç‚¹å°è¯•æ˜¯å¾ˆå‹‡æ•¢ã€å¾ˆäº†ä¸èµ·çš„ã€‚ä½†æ˜¯ï¼Œä¸ã€Šç›—æ¢¦ç©ºé—´ã€‹æ‰­æ›²ç©ºé—´ä¸åŒï¼Œæ—¶é—´ä¸Šçš„æ‰­è½¬å¹¶ä¸æ˜¯è¿™ä¹ˆå®¹æ˜“è¡¨ç°çš„ã€‚åœ¨ã€Šç›—æ¢¦ç©ºé—´ã€‹æˆ–è€…ä»Šæ•çš„ã€Šçº¢è¾£æ¤’ã€‹ä¸­ï¼Œæ²¡æœ‰æ¥è§¦è¿‡ä»»ä½•ç§‘å¹»æ¦‚å¿µçš„äººï¼Œä¹Ÿèƒ½ç†è§£ä½œå“åœ¨åˆ†é•œä¸é•œå¤´ä¸Šçš„è¡¨ç°åŠ›ä¸ä¼Ÿå¤§ï¼šç©ºé—´ä¸Šçš„åˆ©ç”¨æ˜¯æ‰€è§å³æ‰€å¾—çš„ï¼Œçº¢è¾£æ¤’ä»ç”µå½±é™¢å¼€å§‹æ¸¸è¡Œç»™äººä¸€ç§å¯ä»¥æ¥å—ä½†åˆè§‰å¾—æ¢¦å¹»çš„éœ‡æ’¼ï¼Œä½†æ˜¯æ—¶é—´ä¸Šçš„è¡¨ç°æ²¡æœ‰é‚£ä¹ˆæ˜æ˜¾ï¼šè¯ºå…°é‡‡ç”¨äº†ç‰©ç†ä¸Šçš„åå‘ï¼ˆè¿™ä¸€ç‚¹è¡¨ç°ä¸Šå¾ˆæ˜¾è‘—ï¼‰å’Œæ—¶é—´ä¸Šçš„å›ç¯å™äº‹æ¥è¡¨ç°ï¼Œå‰è€…ç›¸å¯¹æ¥è¯´å¥½ç†è§£ä¸€äº›ï¼Œä½†æ˜¯è§‚ä¼—ä»ç„¶çœ¼èŠ±ç¼­ä¹±ï¼Œåè€…åˆ™éœ€è¦ååˆ†çš„æ³¨æ„å’Œæ„å»ºè¿™ç§æ–¹å‘çš„èƒ½åŠ›â€”â€”é˜…è¯»å°è¯´çš„æ—¶å€™ï¼Œæˆ‘ä»¬æˆ–è®¸èƒ½ç†è§£åå‘æ—¶é—´çš„å¥‡å¦™ç°è±¡ï¼Œä½†æ˜¯åœ¨è§†è§‰ä¸Šè¡¨ç°å¹¶è®©è§‚ä¼—æ¥å—ï¼Œææ€•éš¾å¾—å¤šã€‚æ‰€ä»¥ï¼Œè™½ç„¶å¾ˆæ•¬ä½©è¯ºå…°åœ¨æ—¶é—´ä¸Šçš„å°è¯•ï¼Œä½†æ˜¯ä»è¤’è´¬ä¸ä¸€çš„è¯„è®ºæ¥çœ‹â€”â€”ä¸èƒ½è¯´ç”µå½±ä¸å¥½ï¼Œä½†å®ƒæ˜¾ç„¶ä¸å¤Ÿç›´è§‚ã€‚</p><p>æŠ›å»è®¾å®šæ¥è®²ï¼ŒTenet ç›¸å¯¹æ¥è¯´å†…æ ¸æ¯”è¾ƒå¹³å‡¡ï¼Œå®ƒè®²äº†ä¸€ä¸ªæœ‰å…³å®¿å‘½çš„ç¾å›½å¤§ç‰‡å¼æ•…äº‹ï¼Œä¹Ÿå¸¦ç»™æˆ‘ä»¬ä¸€äº›å®¿å‘½èˆ¬çš„å“€æ„ï¼Œä½†æ˜¯è¿™äº›å“€æ„ç›¸å¯¹æ··ä¹±çš„æ‰“æ–—å’Œç‚«æŠ€ï¼Œå¹¶æ²¡æœ‰è¢«å¾ˆå¥½çš„ä¼ è¾¾ç»™è§‚ä¼—â€”â€”ä¸ç›—æ¢¦ç©ºé—´åœ¨å†³æˆ˜ä¸­å’Œå‰å¦»ä¸€è·¯å™äº‹ç›¸æ¯”ï¼Œè§‚ä¼—ä»¬å¯¹ TeneT ä¼šæ„Ÿåˆ°èŒ«ç„¶ä¸å°‘ã€‚åœ¨å™äº‹çš„æ·±åº¦å’Œæƒ…æ„Ÿçš„ä¼ è¾¾ä¸Šï¼ŒTeneT æ— è®ºç›¸å¯¹äºå¯¼æ¼”è‡ªå·±çš„ä½œå“ï¼Œè¿˜æ˜¯æ—¶é—´ç›¸å…³çš„å‰ä½œéƒ½é€Šè‰²ä¸å°‘ã€‚ä¸ã€Šå‡‰å®«æ˜¥æ—¥çš„æ¶ˆå¤±ã€‹ç›¸æ¯”ï¼Œåè€…åœ¨æ—¶é—´æ—…è¡Œä¸Šä¹Ÿå¹¶ä¸æ–°é²œï¼Œä½†å®ƒçš„é‡ç‚¹åœ¨æ„Ÿæƒ…ä¸Šçš„è¡¨è¾¾ã€‚è€Œ TeneT æ„Ÿæƒ…ä¸Šçš„è¡¨è¾¾å¹¶ä¸å‡ºè‰²ï¼šè¿™ä¸æ˜¯ç½ªè¿‡ï¼Œç”µå½±æ²¡æœ‰å¿…è¦å¼ºçƒˆçš„è¡¨è¾¾æ„Ÿæƒ…ä¹Ÿèƒ½è·å¾—å…¶ä»–æ–¹é¢çš„èµèª‰ï¼Œä½†æ˜¯åœ¨è§†è§‰æ•ˆæœå·²ç»ä¸é‚£ä¹ˆæœ‰è¶£çš„æƒ…å†µä¸‹ï¼Œå°±æˆäº†å‹å®éª†é©¼çš„ç¨»è‰äº†ã€‚</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Network Layer &amp; End To End System Design</title>
      <link href="/2020/09/05/Network-Layer-End-To-End-System-Design/"/>
      <url>/2020/09/05/Network-Layer-End-To-End-System-Design/</url>
      
        <content type="html"><![CDATA[<p>è¿™ä¸€èŠ‚æˆ‘ä»¬ä¼šä»‹ç»ç½‘ç»œçš„åˆ†å±‚ï¼ˆè€ç†Ÿäººäº†ï¼‰å’Œ End To End System Design. è®¡ç®—æœºç½‘ç»œä»¥åˆ†ç»„çš„æ–¹å¼æ¥æä¾›å¯¹ç‰©ç†ç­‰å±‚é¢çš„æŠ½è±¡ã€‚å„å±‚çš„æ‰€æœ‰åè®®è¢«ç§°ä¸ºåè®®æ ˆ(protocol stack)ï¼Œè€Œ internet æä¾›äº† ç‰©ç†å±‚ã€é“¾è·¯å±‚ã€ç½‘ç»œå±‚ã€è¿è¾“å±‚å’Œåº”ç”¨å±‚ï¼š</p><ol><li>å¯¹äºåº”ç”¨å±‚è€Œè¨€ï¼Œæ•°æ®æ˜¯ message</li><li>å¯¹äºè¿è¾“å±‚è€Œè¨€ï¼Œå®ƒä»¬åœ¨åº”ç”¨ endpoint ä¸­ä¼ è¾“ä¸Šå±‚çš„ messageã€‚æˆ‘ä»¬æŠŠè¿™ä¸€å±‚çš„åˆ†ç»„å«åš segmentã€‚è¿™ä¸€å±‚çš„åè®®åŒ…æ‹¬ TCP å’Œ UDP</li><li>ç½‘ç»œå±‚è´Ÿè´£å°† datagram ç§»åŠ¨åˆ°å¦ä¸€è¾¹ã€‚è¿™ä¸€å±‚åŒ…æ‹¬è‘—åçš„ IP åè®®ï¼ŒåŒæ—¶å®ƒåŒ…å«ä¸€äº›è·¯ç”±é€‰æ‹©åè®®, ç»™è¿è¾“å±‚è¿è¾“ packet</li><li>é“¾è·¯å±‚ä¾é é“¾è·¯å±‚çš„æœåŠ¡ï¼ˆè¿˜è®°å¾—æˆ‘ä»¬å‰ä¸¤è®²ä»‹ç»çš„å—ï¼‰è®²æ¶ˆæ¯ä¼ ç»™ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼Œé“¾è·¯å±‚çš„åˆ†ç»„ç§°ä¸º frame / packet.</li><li>ç‰©ç†å±‚ä¸­ï¼Œæˆ‘ä»¬å®Œæˆäº†å¯¹ç‰©ç†ä¿¡å·ç­‰å¯¹ç¨‹åºå‘˜æ¥è¯´æ²¡å•¥å½±å“ï¼Œä½†æ˜¯å¿…è¦çš„ç”µè·¯ç­‰ä¿¡æ¯ã€‚è¿™ä¸€å±‚å‘ä¸Šä¸€å±‚æä¾›äº†å…‰çº¤ã€é“œçº¿ç­‰æä¾›çš„ç‰©ç†ä¿¡å·ï¼Œç»™ä¸Šå±‚æä¾› 0/1ã€‚</li></ol><p>åº”å½“è¯´æ˜çš„æ˜¯ï¼Œä¸Šé¢æ˜¯ Internet çš„ç½‘ç»œåˆ†å±‚ï¼Œå®é™…ä¸Šä½ å¯èƒ½è¿˜å¬è¯´è¿‡ OSI 7å±‚æ¨¡å‹ç­‰åˆ†å±‚ã€‚</p><p>åœ¨åˆ†å±‚çš„ç½‘ç»œä¸­ï¼Œå¯¹äºä¸Šå±‚è€Œè¨€ï¼Œä¸‹å±‚ç±»ä¼¼ apiï¼Œä¸‹å±‚æä¾›ä¸€äº›å°è£…è¿‡åçš„ä¿è¯ï¼Œä¸Šå±‚ç”¨ä¸€å®šçš„æ–¹å¼å’Œä¸€å®šçš„ä¿è¯æ¥è·å¾—ä¸‹ä¸€å±‚çš„æ•°æ®ã€‚</p><h3 id="é“¾è·¯å±‚å’Œç½‘ç»œå±‚"><a href="#é“¾è·¯å±‚å’Œç½‘ç»œå±‚" class="headerlink" title="é“¾è·¯å±‚å’Œç½‘ç»œå±‚"></a>é“¾è·¯å±‚å’Œç½‘ç»œå±‚</h3><p>1/2/5 å®é™…ä¸Šç›¸å¯¹æ¥è¯´å¥½ç†è§£ï¼Œå¤§éƒ¨åˆ†äººéƒ½æˆ–å¤šæˆ–å°‘æœ‰å°è±¡ã€‚ä½†æ˜¯ 4-5 ä¹‹é—´æœ‰ä»€ä¹ˆåŒºåˆ«å‘¢ï¼Ÿæˆ‘ä»¬çŸ¥é“ç½‘ç»œå±‚åŒ…æ‹¬ IP åè®®ï¼Œå®é™…ä¸Šï¼Œæƒ…å†µç±»ä¼¼ä¸‹é¢ï¼š</p><p><img src="https://image.mwish.me/blog-image/CB61FDA0-C769-4B9E-A2EF-ABDE2535C9D3.png" alt="CB61FDA0-C769-4B9E-A2EF-ABDE2535C9D3"></p><p>Weâ€™ll divide the world into switches and routers</p><ol><li>Switches will route on your, Link Layer (L2) Addresses </li><li>Routers will operate on IP (L3) Addresses</li></ol><p><img src="https://image.mwish.me/blog-image/639D4B96-BEB7-407C-B054-22FF26A861D8.png" alt="639D4B96-BEB7-407C-B054-22FF26A861D8"></p><p>è¿™ä¸¤å±‚ä½¿ç”¨çš„ Route æ–¹å¼ä¸åŒï¼Œè¿™ä¸€ç‚¹æˆ‘ä»¬å³å°†ä»‹ç» IPï¼Œå°±ä¼šäº†è§£äº†ã€‚</p><p>å®é™…ä¸Šï¼ŒIP è¿™ä¸ªæŠ½è±¡ç›¸å¯¹æ¥è¯´ç›¸å½“é‡è¦ï¼Œå®ƒæä¾›äº†ä¸€ä¸ªæ¯”è¾ƒç‹¬ç«‹çš„ç½‘ç»œçš„æŠ½è±¡ï¼ŒåŒæ—¶ï¼Œå¯¹äºå¼‚è´¨æ€§çš„ç½‘ç»œï¼Œç½‘ç»œå±‚ä¹Ÿéœ€è¦ä½œå‡ºä¸€å®šçš„åè°ƒå’Œå¦¥åï¼š</p><ul><li>ç½‘ç»œçš„å¸¦å®½æ›´å¤§ï¼Œå‘é€çš„æ•°æ®æ›´å¿«ï¼Œè€Œæ»¡çš„ç½‘ç»œæ¥ä¸åŠæ¥å—ï¼ŒIP éœ€è¦ä¸¢å¼ƒæ¥è‡ªç”Ÿäº§å¿«çš„ç½‘ç»œçš„åŒ…</li><li>IP å±‚ä¸èƒ½ä¿è¯ loss-free å’Œæ¶ˆæ¯ä¼ é€’çš„ order ï¼ˆThis is called best effort service.ï¼‰</li><li>æœ‰äº›ç½‘ç»œæœ‰ç€æ›´å¤§çš„ packetï¼Œè¿™ä¸ªæ—¶å€™éœ€è¦æ”¯æŒ fragementation æ¥æ‹†åˆ† packet</li></ul><p><img src="https://image.mwish.me/blog-image/55771480-6AB4-4711-82FD-617C7F5F46E4.png" alt="55771480-6AB4-4711-82FD-617C7F5F46E4"></p><p>ä¸‹é¢ç»§ç»­ä¸¢å›¾ï¼š</p><p><img src="https://image.mwish.me/blog-image/0FD97745-8A4A-43BE-9344-FCCF18DB4F71.png" alt="0FD97745-8A4A-43BE-9344-FCCF18DB4F71"></p><p>åŒæ—¶ï¼Œå¯¹äºä¸Šå±‚çš„åº”ç”¨è€Œè¨€ï¼Œæˆ‘ä»¬ä¹Ÿæœ‰ä¸åŒå±‚æ¬¡çš„ä¿¡æ¯ï¼ˆæ­£å¦‚æˆ‘ä»¬ä¸€å¼€å§‹ä»‹ç»çš„ï¼‰ï¼š</p><p><img src="https://image.mwish.me/blog-image/6CA008EC-D656-423C-8619-79782173A59E.png" alt="6CA008EC-D656-423C-8619-79782173A59E"></p><p>æ¯å±‚çš„ä¿¡æ¯æœ‰ä¸åŒçš„ header, æ¥è¡¨ç¤ºè¿™ä¸€å±‚æ‰¿è½½çš„ä¿¡æ¯ã€‚</p><h2 id="End-To-End-arguments-in-system-design"><a href="#End-To-End-arguments-in-system-design" class="headerlink" title="End To End arguments in system design"></a>End To End arguments in system design</h2><p>è¿™æ˜¯ 84 å¹´çš„ä¸€ç¯‡æ–‡ç« ï¼Œä»‹ç»äº†é‚£ä¸ªæ—¶å€™äº’è”ç½‘åº”ç”¨è®¾è®¡çš„ä¸€äº›æ€è€ƒã€‚ä½œè€…è®¤ä¸ºåº”è¯¥åˆç†çš„æŠ½è±¡ï¼Œåœ¨åº•å±‚å®ç°ä¸€äº›è¯­æ„ä»¥ä¼˜åŒ–æ€§èƒ½ï¼Œåœ¨é«˜å±‚å®ç°é«˜å±‚çœŸæ­£æƒ³è¦çš„è¯­ä¹‰ï¼Œå› ä¸ºåœ¨åº•å±‚åšæŠ½è±¡æ˜¯å¾ˆæ˜‚è´µçš„ï¼Œå¹¶ä¸”å®ƒä»¬æä¾›çš„è¯­æ„ä¹Ÿä¸ä¸€å®šçœŸæ­£å¯é ï¼ˆå½“ç„¶ä½ æ˜¯é‡‘èå…¬å¸æˆ–è€…å¾ˆæœ‰é’±å•¥çš„ï¼Œéƒ½èƒ½è‡ªå·±æ­æµ·åº•å…‰ç¼†æé«˜é¢‘äº¤æ˜“äº†ï¼Œä½ å¤§æ¦‚ä¹Ÿæœ‰é’±åœ¨ä¸‹å±‚åšä¼˜åŒ–äº†ï¼‰ã€‚</p><p>æ–‡ç« æœ€å¼€å§‹ä¸¾äº†ä¸ªç®€å•çš„ä¾‹å­ï¼šæ–‡ä»¶ä¼ è¾“ç¨‹åºã€‚</p><blockquote><p>ç”¨æˆ·ä» fs ä¸­è¯»å–ä¸€ä¸ªæ–‡ä»¶ï¼Œç„¶åç»è¿‡ç¨‹åºä¸€å®šå¤„ç†ï¼Œå‘é€ç»™ç½‘ç»œå¦ä¸€ç«¯ï¼Œå¦ä¸€ä¸ªç”¨æˆ·æ¥æ”¶å¹¶å†™å…¥ fsã€‚</p></blockquote><p>è¿™ä¸ªäº‹ä»¶æœ¬èº«å„ä¸ªå±‚æ¬¡éƒ½å¯èƒ½å‡ºç°é”™è¯¯ã€‚æˆ‘ä»¬ä¸ä»…éœ€è¦åº•å±‚å„ç§ä¿è¯å’Œé”™è¯¯å¤„ç†ï¼Œå®é™…ä¸Šæˆ‘ä»¬éœ€è¦ç«¯åˆ°ç«¯çš„ç¡®è®¤ï¼Œå³åº”ç”¨ç¡®è®¤æ–‡ä»¶å†™å…¥å®Œæˆï¼Œå¹¶ä¸” checksum ç­‰ä¸€è‡´ã€‚</p><p><img src="https://image.mwish.me/blog-image/1E186DDA-D9B7-4241-90C8-8ED18C84818C.png" alt="1E186DDA-D9B7-4241-90C8-8ED18C84818C"></p><p>åŒæ—¶ï¼Œæˆ‘ä»¬è™½ç„¶æœ‰ tcp ä¹‹ç±»çš„åè®®èƒ½ä¿è¯ order å’Œå†…å®¹å¯é ï¼Œä½†æ˜¯å¯é çš„å†…å®¹ä¸ä¸€å®šè¢«å¤„ç†äº†ï¼Œä»è¿™ä¸ªè§’åº¦æ¥çœ‹ï¼Œä»…ä»… tcp æ˜¯ä¸å¯é çš„ã€‚ä½†æ˜¯ç›¸å¯¹æ›´åº•å±‚çš„åè®®ï¼Œæˆ–è€… UDP è€Œè¨€ï¼Œåº•å±‚å®ç°å¯¹åº”çš„è¯­ä¹‰èƒ½ä¿è¯æ€§èƒ½ä¸Šçš„ bonus. æˆ‘ä»¬å¯èƒ½éœ€è¦ä¸‹åˆ—çš„æ–¹æ¡ˆæ¥ä¿è¯åº”ç”¨å±‚æ¬¡çš„å¯é ï¼š</p><ol><li>Encryption</li><li>First-in-first-out ordering</li><li>Duplicate message surpression </li><li>Multi-message transactions</li></ol><p>slide ç»™å‡ºäº†æ€»ç»“ï¼Œæˆ‘å°±ä¸çŒ®ä¸‘ç¿»è¯‘äº†ï¼š</p><p>Basic argument: If you can implement functionality correctly and completely at endpoints, do it there and not at a lower layer.</p><ul><li>It saves on redundant work in the system, and avoids confusion later. Exceptions okay for performance optimizations.</li></ul><p>Strong argument: Avoid putting unneeded functionality at lower layers of your system altogether because itâ€™s harmful!</p><ul><li>Extra functionality at low layers constrains how applications are designed at higher layers.</li></ul>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Notes: Scaling Memcache at Facebook</title>
      <link href="/2020/08/22/Notes-Scaling-Memcache-at-Facebook/"/>
      <url>/2020/08/22/Notes-Scaling-Memcache-at-Facebook/</url>
      
        <content type="html"><![CDATA[<h1 id="Notes-Scaling-Memcached-at-Facebook"><a href="#Notes-Scaling-Memcached-at-Facebook" class="headerlink" title="Notes: Scaling Memcached at Facebook"></a>Notes: Scaling Memcached at Facebook</h1><p>è¿™ç¯‡æ–‡ç« ä»‹ç»çš„æ˜¯ FB çš„ç¼“å­˜ç³»ç»Ÿ Memcache, è¿™å¥—ç³»ç»Ÿæ„å»ºåœ¨ memcached ä¸Šï¼Œæä¾›äº†å¯é çš„ã€å¤§è§„æ¨¡çš„ç¼“å­˜ã€‚è¿™ç¯‡è®ºæ–‡ä¸»è¦å†…å®¹æœ‰ï¼š</p><ol><li>memcache çš„ç®€å•çš„æ¶æ„</li><li>memcache æ€§èƒ½çš„ä¼˜åŒ–<ol><li>c/s communication ä¸Šçš„ä¼˜åŒ–ï¼Œå³ä½¿ç”¨ä¸€å®šæ›´æ”¹çš„ UDP æ¥å®ç° Get è¯­ä¹‰å’Œ batch ä¸å¹¶è¡Œè¯·æ±‚</li><li>å‡è½»å¯¹ db çš„å‹åŠ›<ol><li>å‹åŠ›æ¥æºåŒ…æ‹¬ stale sets å’Œ thundering herds ï¼Œè¿™é‡Œ memcache å®ç°äº† Lease æœºåˆ¶</li><li>ç”¨ memcache pool å’Œ pool å†…éƒ¨çš„ replication æ¥æä¾›ä¸€å®šå±‚æ¬¡çš„å…±äº«</li></ol></li><li>å¤„ç†å› ä¸º memcache failure å¯¼è‡´çš„ cascading failure (å›½å†…å¥½åƒæŠŠè¿™ä¸ªå«é›ªå´©?) ï¼Œå¼•å…¥äº†ä¸€ä¸ªå°çš„ Gutter </li></ol></li><li>åœ¨å• Region ä¸­ï¼Œå¼•å…¥ replication</li><li>è·¨åœ°åŒºçš„ä¸»-ä»å¤‡ä»½ä¸­ï¼Œä¿æŒä¸€è‡´æ€§ï¼ˆè¯è¯´ä¸»ä»å¤‡ä»½è¿™ä¸ªè¯è¿˜èƒ½ç”¨å—ï¼Ÿï¼‰</li><li>å•æœºä¼˜åŒ–ï¼Œslab ä¼˜åŒ–å†…å­˜å’Œ MGet æ¥å¤„ç†Batch Key loadï¼Œæˆ‘æ²¡çœ‹çš„å¾ˆç»†ã€‚</li></ol><p>é˜…è¯»è¿™ç¯‡æ–‡ç« éœ€è¦æ³¨æ„ä¸€ç‚¹ï¼Œ<code>memcache != memcached</code>ã€‚å¸Œæœ›çœ‹çš„åŒå­¦ä¸è¦ææ··äº†ã€‚åŒæ—¶è¿™ç¯‡æ–‡ç« åªä»‹ç»äº† 1-3. 4å’Œ5æˆ‘çœ‹çš„éƒ½æ¯”è¾ƒè‰ç‡ã€‚</p><h2 id="architecture"><a href="#architecture" class="headerlink" title="architecture"></a>architecture</h2><p><img src="https://image.mwish.me/blog-image/65A9A79E-E6E9-4FEC-B143-10EDD305309E.png" alt="65A9A79E-E6E9-4FEC-B143-10EDD305309E"></p><p>memcache ç³»ç»Ÿä½œä¸ºä¸€ä¸ª look-aside cacheï¼Œæˆ‘ä»¬å¯ä»¥å›é¡¾ä¸€ä¸‹ look-aside cacheï¼š</p><p><img src="https://image.mwish.me/blog-image/A4E36A75-DDBD-4708-AD25-2DFD87A26E47.png" alt="A4E36A75-DDBD-4708-AD25-2DFD87A26E47"></p><ol><li>Get ä¼šå°è¯• read from cache, å¦‚æœæ²¡æœ‰çš„è¯ï¼Œä¼š read from db å†æ›´æ–° cache</li><li>Set ä¼š update db, ç„¶å invalid cache</li></ol><p>åŒæ—¶ï¼Œmemcached æœ¬èº«ä¸ä¼šå®ç°å’Œå…¶ä»– peer çš„é€šä¿¡ã€‚å¼•å…¥ memcache çš„å®¢æˆ·ç«¯ä¼šæœ‰ï¼š</p><ol><li>memcached å®¢æˆ·ç«¯</li><li>ä¸€ä¸ª proxy æœåŠ¡å™¨ï¼Œç”¨äº batch å’Œ proxy.</li></ol><p>æ¶‰åŠè¿™ä¸ªç³»ç»Ÿçš„æ—¶å€™ï¼Œæœ‰å‡ ä¸ªéœ€è¦æ³¨æ„çš„åœ°æ–¹ï¼š</p><ol><li>å¯èƒ½ä¼šæœ‰çƒ­æ•°æ®å’Œé™ˆæ—§çš„/å¾ˆå°‘æ›´æ–°çš„æ•°æ®</li><li>å¤åˆ¶æ˜¯å¿…è¦çš„ï¼Œä½†æ˜¯å¯èƒ½ä¼šå¯¼è‡´ fan-out å¾ˆå¤§ï¼Œå³æ›´æ–°ä¸€å¤„éœ€è¦æ›´æ–°æ¢å¤šçš„å‰¯æœ¬æˆ–è€… cascade çš„å…³ç³»</li><li>è¯» &gt;&gt;&gt; å†™ï¼Œä½œä¸º cacheï¼Œè¯»æ˜¯ä¸»è¦çš„è´Ÿè½½</li></ol><h2 id="In-a-Cluster-Latency-amp-Load"><a href="#In-a-Cluster-Latency-amp-Load" class="headerlink" title="In a Cluster: Latency &amp; Load"></a>In a Cluster: Latency &amp; Load</h2><h3 id="Latency"><a href="#Latency" class="headerlink" title="Latency"></a>Latency</h3><p>ä½œä¸º web åº”ç”¨çš„é€šç”¨ç¼“å­˜ï¼Œä¸æ•°æ®åº“ä¾èµ–çš„ k-v å­˜å‚¨ä¸åŒï¼ŒGet æ¨¡å¼é€šå¸¸æ˜¯è¿›å…¥ä¸€ä¸ªç½‘é¡µï¼Œç„¶åæèµ·å¾ˆå¤šå­ç»„ä»¶çš„æ•°æ®ï¼Œç”šè‡³ç›¸äº’ä¹‹é—´æœ‰åŠ è½½çš„ä¾èµ–å…³ç³»ã€‚è®ºæ–‡é‡Œé¢è¡¨ç¤ºä¸€æ¬¡ç”¨æˆ·è¯·æ±‚å¯èƒ½å¼•èµ·ä¸Šç™¾ä¸ª cache get keyçš„è®¿é—®ã€‚è¿™æ ·å°±ä¼šé€ æˆæœåŠ¡å™¨è´Ÿæ‹…æ¯”è¾ƒé‡ã€‚åŒæ—¶å› ä¸º memcached æœ¬èº«ä¸æä¾›æœåŠ¡å™¨æ²Ÿé€šï¼Œæ‰€ä»¥ memcache åœ¨å®¢æˆ·ç«¯ä¸Šè§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p><p>å¼•å…¥å®¢æˆ·ç«¯ï¼Œéœ€è¦å¼•å…¥ memcache çš„å®¢æˆ·ç«¯ä¼šæœ‰ï¼š</p><ol><li>memcached å®¢æˆ·ç«¯</li><li>ä¸€ä¸ª proxy æœåŠ¡å™¨ <code>mcrouter</code>ï¼Œç”¨äº batch å’Œ proxy.</li></ol><p>åŒæ—¶æœ‰è¾…åŠ©çš„åˆ—è¡¨ï¼Œæ¥æä¾›è®¿é—®ã€‚</p><p>é‚£ä¹ˆï¼Œå®¢æˆ·ç«¯æä¾›äº† batch å’Œå¹¶è¡Œè®¿é—®ï¼Œå®¢æˆ·ç«¯ä¼š Batch ç”¨æˆ·çš„è¯·æ±‚ï¼ŒæŠŠä¸€äº›çº§è”çš„è®¿é—®ç»„ç»‡æˆ DAG, æ¥å¹¶è¡Œçš„è®¿é—®ï¼Œæ„Ÿè§‰ç±»ä¼¼æ•°æ®åº“è¿™ç§è®¿é—®æ–¹å¼ï¼š</p><p><img src="https://image.mwish.me/blog-image/5D991D77-209D-4817-B6CB-DBACDF1807DC.png" alt="5D991D77-209D-4817-B6CB-DBACDF1807DC"></p><p>å®¢æˆ·ç«¯åœ¨è¯»è¯·æ±‚ä¸Šä»¥ UDP + æ‹¥å¡æ§åˆ¶ æ¥å®ç°ï¼Œæ¥é™ä½ TCP Connection å¸¦æ¥çš„ CPU å’Œ memory å¼€é”€ã€‚ä¸ºäº†é¿å… incast congestion, å³ Get è¿‡å¤šå¯¼è‡´ floyd, å®ƒå®ç°äº†æ…¢å¯åŠ¨ + æ»‘åŠ¨çª—å£ã€‚</p><p>ä¸‹é¢æ˜¯è®ºæ–‡ç›¸å…³çš„ä¸€äº›æ€§èƒ½åˆ†æï¼š</p><blockquote><p>Under peak load, memcache clients observe that 0.25% of get requests are discarded. About 80% of these drops are due to late or dropped packets, while the remainder are due to out of order delivery. Clients treat get er- rors as cache misses, but web servers will skip inserting entries into memcached after querying for data to avoid putting additional load on a possibly overloaded network or server.</p></blockquote><p><img src="https://image.mwish.me/blog-image/98971E72-B68F-4CC4-988A-1D7844A74612.png" alt="98971E72-B68F-4CC4-988A-1D7844A74612"></p><blockquote><p>Web servers rely on a high degree of parallelism and over-subscription to achieve high throughput. The high memory demands of open TCP connections makes it prohibitively expensive to have an open connection be- tween every web thread and memcached server without some form of connection coalescing via mcrouter. Coalescing these connections improves the efficiency of the server by reducing the network, CPU and memory resources needed by high throughput TCP connections. Figure 3 shows the average, median, and 95<em>th</em> percentile latencies of web servers in production getting keys over UDP and through mcrouter via TCP. In all cases, the standard deviation from these averages was less than 1%. As the data show, relying on UDP can lead to a 20% reduction in latency to serve requests.</p></blockquote><p><img src="https://image.mwish.me/blog-image/C607914C-75A5-498C-9416-513855303E33.png" alt="C607914C-75A5-498C-9416-513855303E33"></p><h3 id="Reducing-Loads"><a href="#Reducing-Loads" class="headerlink" title="Reducing Loads"></a>Reducing Loads</h3><p>æœ‰ä¸¤ä¸ªé—®é¢˜ä¼šç»™æ•°æ®åº“å¸¦æ¥é—®é¢˜</p><ol><li>stale sets</li><li>thundering herds</li></ol><p>ï¼ˆç¬¬ä¸€ä¸ªæ„Ÿè§‰æ˜¯ä¸€è‡´æ€§é—®é¢˜å•Šï¼‰</p><p>ç¬¬ä¸€ä¸ªæ˜¯è¯»å†™éƒ½æœ‰çš„æ—¶å€™ï¼Œå›å†™å¸¦æ¥å€¼å’Œæ•°æ®åº“ä¸­å€¼çš„ä¸ä¸€è‡´ï¼Œæˆ‘ä»¬è€ƒè™‘ä¸‹é¢çš„è¿‡ç¨‹ï¼šæœ‰ T1 T2 T3, å’Œå¯¹è±¡ x, x åˆå§‹å€¼æ˜¯ x1, æœªå‘½ä¸­ç”¨ miss è¡¨ç¤ºï¼ŒRC è¡¨ç¤ºè¯» cache, WC è¡¨ç¤ºå†™ Cache, D ä»£è¡¨DB, Inv ä»£è¡¨ Invalid Cache é‚£ä¹ˆå‡è®¾å¦‚ä¸‹çš„æ“ä½œåºåˆ—</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">T1: RCx(m) RDx1                    WCx1</span><br><span class="line">T2: RCx(m)           RDx2     WCx2</span><br><span class="line">T3:             WDx2      Inv     </span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆï¼Œcache æœ€åçš„å‰©ä¸‹çš„å°±æ˜¯ x1 äº†ï¼Œå’Œæ•°æ®åº“ä¸ä¸€è‡´ã€‚</p><p>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œmemcache ä½¿ç”¨äº† lease, åœ¨ cache æœªå‘½ä¸­çš„æ—¶å€™ï¼Œæ‹¿åˆ°ä¸€ä¸ª lease, è¿™æ˜¯ä¸€ä¸ª 64bit çš„ random token, æœ€åç”¨è¿™ä¸ª lease æ¥ä¿è¯å†™ä¼šçš„ç‰ˆæœ¬æ˜¯æ­£ç¡®çš„ã€‚å¦‚æœ cache è¢« invalid äº†ï¼Œä¹‹å‰çš„ cache éƒ½ä¼šè¢« inv, å›å†™ä¼šå› ä¸º lease è¢« invalid è€Œå¤±æ•ˆã€‚è¿™æ ·ä¿è¯ä¸Šè¿°çš„æƒ…æ™¯ä¸ä¼šå‘ç”Ÿã€‚</p><p>Thundering herds è¡¨ç¤ºçš„æ˜¯å¦ä¸€ç§åœºæ™¯ï¼šå½“ä¸€ä¸ª cache è¯»å¾ˆé‡çš„æ—¶å€™ï¼Œå‡ºç°äº†ä¸€ä¸ª invalidï¼Œé‚£å®Œè›‹äº†ï¼Œè¿™äº›è¯»å…¨éƒ¨ä¼šæ‰“åˆ° db ä¸Šï¼Œé€ æˆ db å†™æ€¥å‰§æ”¾å¤§ã€‚</p><p>è¿™ä¸ªé—®é¢˜è§£å†³è¿˜æ˜¯å’Œ lease æœ‰å…³ï¼Œlease å‘æ”¾åœºæ™¯çš„æ—¶æœºæ˜¯ï¼šâ€œåœ¨ cache æœªå‘½ä¸­çš„æ—¶å€™ï¼Œæ‹¿åˆ°ä¸€ä¸ª leaseâ€ã€‚</p><blockquote><p>By default, we configure these servers to return a token only once every 10 seconds per key. Requests for a keyâ€™s value within 10 seconds of a token being issued results in a special notification telling the client to wait a short amount of time. Typically, the client with the lease will have successfully set the data within a few milliseconds. Thus, when waiting clients retry the request, the data is often present in cache.</p></blockquote><p>é€šè¿‡é™å®š lease çš„é¢‘ç‡ï¼Œmemcache è¾¾åˆ°äº†ç±»ä¼¼â€œæ¯æ¬¡åªè®©ä¸€ä¸ª key query è®¿é—® dbâ€ è¿™æ ·çš„æ•ˆæœï¼Œä»è€Œç¼“è§£äº† db å› ä¸ºæ­¤å¯¼è‡´çš„å‹åŠ›ã€‚</p><p>åŒæ—¶ï¼Œè™½ç„¶ä¸ºäº†ä¿è¯ä¸dbä¸€è‡´ï¼Œmemcacheä¼šç”¨ lease, ä½†æ˜¯å®ƒå…è®¸ä¸€äº›ä¸éœ€è¦ä¸€è‡´çš„åº”ç”¨è¯» stale value (æ¯•ç«Ÿä¸€è‡´ä¹Ÿæ„å‘³ç€ä»£ä»·):</p><blockquote><p>We can further reduce this time by identifying situations in which re- turning slightly out-of-date data is acceptable. When a key is deleted, its value is transferred to a data structure that holds recently deleted items, where it lives for a short time before being flushed. A get request can re- turn a lease token or data that is marked as stale. Appli- cations that can continue to make forward progress with stale data do not need to wait for the latest value to be fetched from the databases. Our experience has shown that since the cached value tends to be a monotonically increasing snapshot of the database, most applications can use a stale value without any changes.</p></blockquote><h4 id="Memcache-Pool"><a href="#Memcache-Pool" class="headerlink" title="Memcache Pool"></a>Memcache Pool</h4><p>memcache pool çš„æƒ³æ³•æ˜¯æŒ‰ key åˆ†å‰² memcache. å› ä¸ºå®é™…ä¸Šå„ä¸ªåº”ç”¨è®¿é—®æ¨¡å¼ä¸åŒï¼Œæœ‰ä¸åŒè¯»å†™é¢‘ç‡ã€‚æ··åˆè´Ÿè½½ä¼šå¯¼è‡´è´Ÿé¢å¹²æ‰°ï¼Œæ‰€ä»¥æœ‰ memcache pool. ç„¶åç”¨ä¸åŒçš„ç­–ç•¥æ¥å¤„ç†ï¼Œä¾‹å¦‚ï¼š</p><blockquote><p>ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥ä¸ºç»å¸¸è®¿é—®ä½†å¯¹äº cache miss çš„å¼€é”€ä¸å¤§çš„ key æä¾›ä¸€ä¸ªå°çš„ pool ã€‚æˆ‘ä»¬è¿˜å¯ä»¥ä¸ºä¸ç»å¸¸è®¿é—®çš„ key æä¾›ä¸€ä¸ªå¤§å‹ pool ï¼Œå¯¹äºè¿™äº› key è€Œè¨€ï¼Œcache miss çš„ä»£ä»·éå¸¸é«˜ã€‚</p></blockquote><p><img src="https://image.mwish.me/blog-image/669F5DED-F469-402F-8A49-CE13CD37A21B.png" alt="669F5DED-F469-402F-8A49-CE13CD37A21B"></p><p>(è¿™å¼ å›¾åé¢è¿˜ä¼šè®²)</p><p>æŠŠå†·çƒ­-é«˜ä½ä»£ä»·çš„æ•°æ®æ”¾åœ¨ä¸åŒçš„æ± å­é‡Œï¼Œç„¶å tunning, æ¥ä¿è¯ç³»ç»Ÿæ•ˆç‡ã€‚</p><p>Memcache Pool éœ€è¦æ¯ä¸ª Pool å†…éƒ¨ replication é™ä½è´Ÿè½½ï¼Œè¿™ä¸ªçš„é€»è¾‘åœ¨äºï¼š</p><ol><li>å¦‚æœæ˜¯ sharding çš„è¯ï¼Œå¯¹äºä¸€ä¸ª 100keys çš„è¯·æ±‚ï¼Œä¸¤è¾¹ä»»ç„¶è¦å¤„ç†è¿™ä¹ˆå¤š Queryï¼Œåªæ˜¯æ¯ä¸ª Query æ‹¿çš„ key å°‘äº†ï¼Œè¿™æ˜¯å­˜å‚¨é—®é¢˜ï¼Œä½†æ˜¯ä¸èƒ½è§£å†³ QPS è¿‡é«˜</li><li>replica ä¼šé™ä½æ¯ä¸ªæœºå™¨çš„è¯»å¼€é”€, ä¸è¿‡éœ€è¦é¢å¤–ç»´æŠ¤ä¸€è‡´æ€§ã€‚</li></ol><blockquote><p>Each client chooses replicas based on its own IP address. This approach requires delivering invalidations to all replicas to maintain consistency.</p></blockquote><h3 id="Handling-Failures"><a href="#Handling-Failures" class="headerlink" title="Handling Failures"></a>Handling Failures</h3><p>Failure æ˜¯æŒ‡æ± å­ä¹‹ç±»çš„å¯èƒ½ä¼šåæ‰/ä¸‹çº¿ã€‚å› ä¸ºæ˜¯ç¼“å­˜ï¼Œæ‰€ä»¥ä¸å½±å“æ•°æ®åº“æœ¬èº«çš„æ­£ç¡®æ€§ï¼Œä½†æ˜¯è¯·æ±‚ä»ç„¶ä¼šå…¨éƒ¨æ‰“åˆ°æ•°æ®åº“ä¸Šã€‚è¿™è¢«ç§°ä¸º cascading failure.</p><p>æˆ‘ä»¬å¿…é¡»ä»ä¸¤ä¸ªæ–¹é¢è§£å†³æ•…éšœï¼š</p><ol><li>ç”±äºç½‘ç»œæˆ–æœåŠ¡å™¨æ•…éšœè€Œå¯¼è‡´æ— æ³•è®¿é—®å°‘é‡ä¸»æœº</li><li>å½±å“ cluster ä¸­å¾ˆå¤§æ¯”ä¾‹çš„æœåŠ¡å™¨çš„å¹¿æ³›åœæœºã€‚</li></ol><p>å¯¹äºå°æ•…éšœï¼Œæˆ‘ä»¬ä¾é è‡ªåŠ¨ä¿®å¤ç³»ç»Ÿã€‚è¿™äº›æ“ä½œä¸æ˜¯å³æ—¶çš„ï¼Œå¯èƒ½éœ€è¦å‡ åˆ†é’Ÿã€‚è¯¥æŒç»­æ—¶é—´è¶³å¤Ÿé•¿ï¼Œä»¥è‡´å¯¼è‡´ä¸Šè¿° cascading failureï¼Œå› æ­¤æˆ‘ä»¬å¼•å…¥äº†ä¸€ç§æœºåˆ¶ï¼Œä»¥ä½¿åç«¯æœåŠ¡ä¸æ•…éšœè¿›ä¸€æ­¥éš”ç¦»ã€‚æˆ‘ä»¬ä¸“ç”¨äºä¸€å°ç»„åä¸º Gutter çš„æœºå™¨æ¥æ¥ç®¡å‡ å°æ•…éšœæœåŠ¡å™¨çš„èŒè´£ï¼ˆç±»ä¼¼ MapReduce ä¸­é‚£ç§å‰©ä½™å‡ å°çš„ worker ï¼‰ã€‚ Gutterçº¦å é›†ç¾¤ä¸­MemcachedæœåŠ¡å™¨çš„1ï¼…ã€‚</p><p>è¯·æ±‚ timeoutï¼Œå†æ¬¡è¯·æ±‚ Gutter æ± å­ï¼Œç„¶åæŒ‰ç…§åŸæ¥çš„ç­–ç•¥å¤„ç†ã€‚Gutter ä¼šå¾ˆå¿« expireï¼ŒåŒæ—¶ä¼šæä¾› stale æ•°æ®ï¼š</p><blockquote><p>Entries in Gutter expire quickly to obviate Gutter invalidations. Gutter limits the load on backend services at the cost of slightly stale data.</p></blockquote><p>ä¸Šé¢é‚£æ®µå«ä¹‰ç±»ä¼¼å†™å…¥ä¸ä¼š invalid Gutter, æ‰€ä»¥å®ƒå¯èƒ½è¯»æ—§æ•°æ®â€¦ æ„Ÿè§‰è¿™ä¹Ÿç®—æ˜¯å†™å…¥å’Œä¸€è‡´çš„æƒè¡¡å§ï¼Œåœ¨ cache åçš„æ—¶å€™è¯» stale data æ—¶åˆç†çš„å°±ä¼šè¿™æ ·ï¼Ÿ</p><p>å¯¹äº hot keys, è®ºæ–‡è¯´è¿™ä¸ªå’Œ hot keys æ˜¯ä¸åŒçš„å±‚é¢ï¼š</p><blockquote><p>Note that this design differs from an approach in which a client rehashes keys among the remaining memcached servers. Such an approach risks cascading failures due to non-uniform key access frequency. For example, a single key can account for 20% of a serverâ€™s requests. The server that becomes responsible for this hot key might also become overloaded. By shunting load to idle servers we limit that risk.</p></blockquote><h2 id="In-a-Region-Replication"><a href="#In-a-Region-Replication" class="headerlink" title="In a Region: Replication"></a><strong>In a Region: Replication</strong></h2><p>åœ¨ Region å±‚é¢ï¼Œmemcache ç³»ç»Ÿå†æ¬¡æä¾›äº†æŸç§æ„ä¹‰ä¸Šçš„ replica å’Œå†·çƒ­åˆ†å‰².</p><p>å®ƒæå‡ºäº† frontend cluster, å³ä¸€ç»„ æœåŠ¡å™¨å’Œmemcachedã€‚å¤šç»„ frontend cluster å­˜å‚¨åˆ°åº•å±‚çš„ storage ä¸Šã€‚</p><p><img src="https://image.mwish.me/blog-image/BD349449-EBD4-4152-8AF6-10F56DA54425.png" alt="BD349449-EBD4-4152-8AF6-10F56DA54425"></p><p>é‚£ä¹ˆä¸åŒçš„ cache é—´åˆè¦å¤„ç†ä¸€è‡´æ€§äº†ï¼ˆæˆ‘çš„å¤©å•Šâ€¦ï¼‰ã€‚ Region æä¾›äº†ä¸Šå±‚çš„å’Œä¸‹å±‚çš„ expireï¼š</p><blockquote><p>Reducing packet rates: While mcsqueal could contact memcached servers directly, the resulting rate of packets sent from a backend cluster to frontend clusters would be unacceptably high. This packet rate problem is a consequence of having many databases and many memcached servers communicating across a cluster boundary. Invalidation daemons batch deletes into fewer packets and send them to a set of dedicated servers running mcrouter instances in each frontend cluster. These mcrouters then unpack individual deletes from each batch and route those invalidations to the right memcached server co-located within the frontend cluster. The batching results in an 18Ã— improvement in the median number of deletes per packet.</p><p>Invalidation via web servers: It is simpler for web servers to broadcast invalidations to all frontend clusters. This approach unfortunately suffers from two problems. First, it incurs more packet overhead as web servers are less effective at batching invalidations than mcsqueal pipeline. Second, it provides little recourse when a systemic invalidation problem arises such as misrouting of deletes due to a configuration error. In the past, this would often require a rolling restart of the entire memcache infrastructure, a slow and disruptive process we want to avoid. In contrast, embedding invalidations in SQL statements, which databases commit and store in reliable logs, allows mcsqueal to simply replay invalidations that may have been lost or misrouted.</p></blockquote><p>åœ¨ Region å±‚é¢ï¼Œä¹Ÿæœ‰ Region Pool, è¿™æ˜¯ä¸€ç§èµ„æºå…±äº«ã€‚Region ä¸­ frontend è¯·æ±‚ä¸ä¸€ï¼Œä½†å¯¹åº”å­˜å‚¨å±‚æ˜¯ä¸€æ ·çš„ã€‚å¯¹äºå›¾5ä¸­çš„ B ç±»æ•°æ®ï¼šå³æ•°é‡å°‘è®¿é—®è´µçš„ï¼Œå¯ä»¥è¢«ç§»åˆ°ä¸€ä¸ªå…±äº«çš„æ± å­ä¸­ã€‚</p><blockquote><p> The decision to migrate data into regional pools is currently based on a set of manual heuristics based on access rates, data set size, and num- ber of unique users accessing particular items.</p></blockquote><h3 id="code-and-warm-é‡å¯"><a href="#code-and-warm-é‡å¯" class="headerlink" title="code and warm: é‡å¯"></a>code and warm: é‡å¯</h3><p>ç¼“å­˜çš„ code æ˜¯æŒ‡ï¼š</p><ol><li>å¯èƒ½æŒ‚æ‰é‡å¯ï¼Œå†…å­˜å…¨ä¸¢äº†</li><li>å¯èƒ½åˆšæ‹‰èµ·æ¥ï¼Œå†…å­˜è¿˜æ˜¯æ²¡ä¸œè¥¿</li></ol><p>è¿™ä¸ªæ—¶å€™è¯·æ±‚ä¼šè½åˆ° db ä¸Šï¼Œå¸¦æ¥å†™å…¥çš„æ”¾å¤§ã€‚è¿™ä¸ªæ—¶å€™ï¼Œç®€å•çš„ç­–ç•¥æ˜¯ç›´æ¥ä»åˆ«çš„ warm é›†ç¾¤ cache è¯»ï¼Œæ¥ä¼˜åŒ–æ•ˆç‡ã€‚</p><p>ä½†æ˜¯è¿™æ ·åˆå¯èƒ½æœ‰ä¸ä¸€è‡´çš„é—®é¢˜äº†ã€‚æ‰€ä»¥ memcache æœ‰ä¸‹åˆ—è§£å†³æœºåˆ¶ï¼š</p><ol><li>æœºåˆ¶å¼€å¯æ—¶ï¼Œdelete æœ‰ hold-off æ—¶é—´</li><li>hold-off ä¸­ï¼Œå¯¹è¿™ä¸ª key æ·»åŠ ä¼šå¤±è´¥</li><li>è¿™ä»£è¡¨ä¸ä¸€è‡´ï¼Œç„¶åéœ€è¦é‡æ–°å»ææ•°æ®</li></ol><blockquote><p>Care must be taken to avoid inconsistencies due to race conditions. For example, if a client in the cold cluster does a database update, and a subsequent request from another client retrieves the stale value from the warm cluster before the warm cluster has received the invalidation, that item will be indefinitely inconsistent in the cold cluster. Memcached deletes support nonzero hold-off times that reject add operations for the specified hold-off time. By default, all deletes to the cold cluster are issued with a two second hold-off. When a miss is detected in the cold cluster, the client re-requests the key from the warm cluster and adds it into the cold cluster. The failure of the add indicates that newer data is available on the database and thus the client will refetch the value from the databases. While there is still a theoretical possibility that deletes get delayed more than two seconds, this is not true for the vast majority of the cases. The operational benefits of cold cluster warmup far outweigh the cost of rare cache consistency issues. We turn it off once the cold clusterâ€™s hit rate stabilizes and the benefits diminish.</p></blockquote>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>notes: Spanner</title>
      <link href="/2020/08/19/notes-Spanner/"/>
      <url>/2020/08/19/notes-Spanner/</url>
      
        <content type="html"><![CDATA[<p>Spanner ä¹Ÿæ˜¯åœ°ç†éš”ç¦»çš„æ•°æ®åº“ï¼ŒæŠŠæ•°æ® sharding åœ°å­˜åœ¨å¤šç»„ Paxos çŠ¶æ€æœºä¸Šã€‚è¿™äº›æœºå™¨ä½äºå¯èƒ½åœ°ç†éš”ç¦»çš„ä¸åŒåŒºåŸŸå†…ã€‚</p><p>ç½‘ä¸Šçš„ Spanner äº§å“æœ‰ï¼š<a href="https://cloud.google.com/spanner/docs/true-time-external-consistency?hl=zh-cn">https://cloud.google.com/spanner/docs/true-time-external-consistency?hl=zh-cn</a> . å…³äºå®ƒçš„å†…å®¹æœ‰ç€ä¸­æ–‡çš„ç¿»è¯‘ã€‚å¯ä»¥åœ¨ä¸Šé¢é˜…è¯»å¤–éƒ¨ä¸€è‡´æ€§ç›¸å…³çš„å†…å®¹ï¼Œæˆ‘ç†è§£çš„å¤–éƒ¨ä¸€è‡´æ€§å°±æ˜¯ï¼š</p><ul><li>æä¾›äº†æ—¶é—´ç­‰å¤–éƒ¨çš„çº¦æŸä¸Šçš„ä¸€è‡´æ€§</li><li>åœ¨ä¸€ä¸ªæ—¶é—´æˆ³ä¸‹é¢çš„è·¨è¶Šæ•°æ®åº“çš„å…¨çƒä¸€è‡´æ€§çš„è¯»æ“ä½œ</li></ul><p>å¯¹äº MVCC å’Œå¯¹åº”è¯­ä¹‰çš„ç³»ç»Ÿæ¥è¯´ï¼Œäº‹åŠ¡çš„ ts æ˜¯ç»å¯¹é‡è¦çš„ã€‚Spanner æä¾›äº† TrueTime API, æš´éœ²äº†æ—¶é—´å’Œä¸ç¡®å®šæ€§ï¼Œæ¥å®ç°å¯¹åº”çš„å†…å®¹ã€‚</p><blockquote><p>å®ç°è¿™ç§ç‰¹æ€§çš„å…³é”®æŠ€æœ¯å°±æ˜¯ä¸€ä¸ªæ–°çš„ TrueTime API åŠå…¶å®ç°ã€‚è¿™ä¸ª API å¯ä»¥ç›´æ¥æš´éœ² æ—¶é’Ÿä¸ç¡®å®šæ€§ï¼ŒSpanner æ—¶é—´æˆ³çš„ä¿è¯å°±æ˜¯å–å†³äºè¿™ä¸ª API å®ç°çš„ç•Œé™ã€‚å¦‚æœè¿™ä¸ªä¸ç¡®å®šæ€§ å¾ˆå¤§ï¼ŒSpanner å°±é™ä½é€Ÿåº¦æ¥ç­‰å¾…è¿™ä¸ªå¤§çš„ä¸ç¡®å®šæ€§ç»“æŸã€‚è°·æ­Œçš„é›†ç¾¤ç®¡ç†æä¾›äº†ä¸€ä¸ª TrueTime API çš„å®ç°ã€‚è¿™ç§å®ç°å¯ä»¥ä¿æŒè¾ƒå°çš„ä¸ç¡®å®šæ€§(é€šå¸¸å°äº 10ms)ï¼Œä¸»è¦æ˜¯å€ŸåŠ©äº ç°ä»£æ—¶é’Ÿå‚è€ƒå€¼(æ¯”å¦‚ GPS å’ŒåŸå­é’Ÿ)ã€‚</p></blockquote><h2 id="æ¶æ„"><a href="#æ¶æ„" class="headerlink" title="æ¶æ„"></a>æ¶æ„</h2><p>ä¸€ä¸ª Spanner é›†ç¾¤è¢«ç§°ä¸ºä¸€ä¸ª universe:</p><p>Spanner è¢«éƒ¨ç½²æˆå¤šä¸ª zone çš„é›†åˆï¼Œæ¯ä¸ª zone ç±»ä¼¼ä¸€ä¸ª BigTable. æˆ‘ä¸ªäººæ„Ÿè§‰åƒæ˜¯ä¸€ä¸ªå¯ç”¨åŒºå†…çš„é›†ç¾¤ï¼š</p><ul><li>ä¸€ä¸ª zone åŒ…å«ä¸€ä¸ª zonemaster</li><li>åŒ…å«æˆç™¾ä¸Šåƒä¸ª spanserverï¼Œç±»ä¼¼ Chunk Server, å…·ä½“å­˜å‚¨æ•°æ®ï¼ŒæŠŠæ•°æ®ç»™å®¢æˆ·ç«¯</li><li>å®¢æˆ·ç«¯ç”¨ location proxy æ¥æ‰¾åˆ°è¯»å†™çš„æ•°æ®</li><li>Universe master ä¸»è¦æ˜¯ ä¸€ä¸ªæ§åˆ¶å°ï¼Œå®ƒæ˜¾ç¤ºäº†å…³äº zone çš„å„ç§çŠ¶æ€ä¿¡æ¯ï¼Œå¯ä»¥ç”¨äºç›¸äº’ä¹‹é—´çš„è°ƒè¯•ã€‚</li><li>Placement driver ä¼šå‘¨æœŸæ€§åœ°ä¸ spanserver è¿›è¡Œäº¤äº’ï¼Œæ¥å‘ç°é‚£äº›éœ€è¦è¢«è½¬ç§»çš„æ•°æ®ï¼Œæˆ–è€…æ˜¯ä¸ºäº†æ»¡è¶³ æ–°çš„å‰¯æœ¬çº¦æŸæ¡ä»¶ï¼Œæˆ–è€…æ˜¯ä¸ºäº†è¿›è¡Œè´Ÿè½½å‡è¡¡ã€‚</li></ul><p><img src="https://image.mwish.me/blog-image/74610E36-2947-44EA-908C-A5F32E889030.png" alt="74610E36-2947-44EA-908C-A5F32E889030"></p><h3 id="Spanserver"><a href="#Spanserver" class="headerlink" title="Spanserver"></a>Spanserver</h3><p><img src="https://image.mwish.me/blog-image/95264B0F-64B2-4C4F-B8E9-4F86D5992AC8.png" alt="95264B0F-64B2-4C4F-B8E9-4F86D5992AC8"></p><p>æ„Ÿè§‰å¼€å§‹å¥—å¨ƒäº†ã€‚ä¸è¿‡æ¯”è¾ƒé‡è¦çš„æ˜¯ï¼ŒSpanServer ä¹Ÿæ˜¯è·¨æ•°æ®ä¸­å¿ƒçš„ã€‚</p><p>SpanServer åŒ…å«å¾ˆå¤šçš„ tabletsã€‚</p><p>Spanner ä¼šæŠŠ TS åˆ†é…ç»™æ•°æ®ï¼Œè®©å…¶æˆä¸ºä¸€ä¸ª MVCC çš„ KVï¼ˆè¿˜è®°å¾— TiKV å—ï¼‰ã€‚å•ä¸ª tablet çš„çŠ¶æ€æ˜¯ä»¥æ–‡ä»¶çš„å½¢å¼å­˜å‚¨çš„ï¼Œè¢«ç»„ç»‡ä¸ºï¼š</p><ul><li>B-Tree çš„æ–‡ä»¶å½¢å¼</li><li>WAL</li></ul><p>å¹¶è¢«å­˜å‚¨åœ¨ GFS çš„è¿›åŒ–ç‰ˆï¼Œ Colossus ä¸Šã€‚ä¸è¿‡æ„Ÿè§‰ä¸Šé¢å°±æ˜¯å•çº¯ B-Tree æˆ–è€… LSMTree å±‚äº†ã€‚</p><p>Spanner å®ç°äº† Leader-based çš„ Paxos, æ¥å®ç°ä¸€ç³»åˆ—è¢«å¤åˆ¶çš„ k-v æ“ä½œã€‚</p><p>ï¼ˆæˆ‘å¾ˆå¥‡æ€ªçš„æ˜¯å·²ç»æœ‰ Colossus äº†ä¸ºä»€ä¹ˆè¿˜è¦å°è£…ä¸€å¥— Paxos æ¥å¤åˆ¶ï¼Ÿçœ‹äº†ä¸‹æ„Ÿè§‰æ˜¯ Colossus æ˜¯ä¸è·¨æ•°æ®ä¸­å¿ƒçš„ï¼‰</p><p>ä¸€ä¸ªå†™æ“ä½œæ¥ä¸´æ—¶ï¼Œä¼šå†™ä¸¤æ¬¡ï¼š</p><ul><li>å†™ Paxos æ—¥å¿—</li><li>å¯¹ tablet å†™æ—¥å¿—ï¼Œå¹¶è¿›è¡Œå†™æ“ä½œã€‚</li></ul><p>Paxos å®ç°çš„æ—¶å€™æ˜¯ Pipeline åŒ–çš„ï¼Œä½†æ˜¯ä¼šé¡ºåº apply æ—¥å¿—ã€‚</p><p>ï¼ˆè®ºæ–‡å¯¹ Paxos æçš„æ„Ÿè§‰æ¯”è¾ƒç±»ä¼¼äº ZooKeeper é‚£ç§ï¼Œä¼¼ä¹è¯»å¯ä»¥æœ¬åœ°è¯»ã€‚ï¼‰</p><p>Paxos Group æ˜¯ Leader based çš„ï¼Œå¦‚æœä½ æ˜¯ leader, spanserver ä¼š  Lock Tableï¼Œæ¥æ”¯æŒåˆ†å¸ƒå¼çš„äº‹åŠ¡å®ç°, åŒæ—¶é’ˆå¯¹é•¿äº‹åŠ¡åšäº†ç‰¹åŒ–ã€‚ï¼ˆè¿™é‡Œä¸çŸ¥é“æ˜¯ä¸æ˜¯å¯ä»¥å‚è€ƒ Percolatorï¼‰ã€‚åŒæ—¶ï¼Œspanserver ä¹Ÿä¼šå®ç°äº‹åŠ¡ç®¡ç†å™¨ï¼Œæ¥å®ç°è·¨ paxos group çš„äº‹åŠ¡ã€‚</p><blockquote><p>å…¶ä¸­ä¸€ä¸ª Participant Groupï¼Œ ä¼šè¢«é€‰ä¸ºåè°ƒè€…ï¼Œè¯¥ç»„çš„ participant leader è¢«ç§°ä¸º coordinator leaderï¼Œè¯¥ç»„çš„ participant slaves è¢«ç§°ä¸º coordinator slavesã€‚æ¯ä¸ªäº‹åŠ¡ç®¡ç†å™¨çš„çŠ¶æ€ï¼Œä¼šè¢«ä¿å­˜åˆ°åº•å±‚çš„ Paxos Groupã€‚</p></blockquote><p>ï¼ˆä¸Šé¢è¿™æ®µè¯å¾ˆé‡è¦ï¼Œä½ è¯»åˆ°åé¢è¿˜ä¼šå›æ¥çš„ï¼Œå› ä¸ºæˆ‘å°±æ˜¯è¿™ä¹ˆå›æ¥çš„ï¼‰</p><h3 id="Directory"><a href="#Directory" class="headerlink" title="Directory"></a>Directory</h3><p>Spanner æ”¯æŒ Directory çš„æŠ½è±¡ï¼Œæˆ‘æ„Ÿè§‰ç±»ä¼¼ Column Family. ä¸€ä¸ª directory æ˜¯æ•°æ®å­˜æ”¾å’Œè°ƒåº¦çš„åŸºæœ¬å•å…ƒã€‚å±äºä¸€ä¸ªç›®å½•çš„æ‰€æœ‰æ•°æ®ï¼Œéƒ½å…·æœ‰ç›¸åŒçš„å‰¯æœ¬é…ç½®ã€‚ å½“æ•°æ®åœ¨ä¸åŒçš„ Paxos ç»„ä¹‹é—´è¿›è¡Œç§»åŠ¨æ—¶ï¼Œä¼šä¸€ä¸ªç›®å½•ä¸€ä¸ªç›®å½•åœ°è°ƒåº¦ã€‚</p><p>dir ä»å±äº Paxos Group.</p><p>ä»¥ä¸Šçš„è°ƒåº¦å¯ä»¥é˜²æ­¢çƒ­ç‚¹ï¼Œåˆ†æ•£è´Ÿè½½ã€‚å¦‚æœä¸€ä¸ª dir è¿‡å¤§ï¼ŒSpanner ä¼šæŠŠå®ƒ shardingï¼Œç„¶ååˆ†é…åˆ°ä¸åŒçš„ Paxos Group ä¸Šã€‚</p><p><img src="https://image.mwish.me/blog-image/319E211E-A5F3-4945-B082-60204EA0EE3C.png" alt="319E211E-A5F3-4945-B082-60204EA0EE3C"></p><blockquote><p>æœ€åï¼Œåœ¨ BigTable ä¸­è·¨è¡Œäº‹åŠ¡çš„ç¼ºä¹æ¥å¯¼è‡´äº†ç”¨æˆ·é¢‘ç¹çš„æŠ±æ€¨; Percolator[32]çš„å¼€å‘å°±æ˜¯ç”¨æ¥éƒ¨åˆ†è§£å†³è¿™ä¸ªé—®é¢˜çš„ã€‚</p></blockquote><p><img src="https://image.mwish.me/blog-image/64392CAF-4FEF-45BA-AD40-E7037E0E1CD1.png" alt="64392CAF-4FEF-45BA-AD40-E7037E0E1CD1"></p><p>Spanner æ•°æ®æ¨¡å‹å¦‚ä¸Šæ‰€ç¤ºï¼Œæ„Ÿè§‰è¿˜æ˜¯æ¯”è¾ƒæ¥è¿‘ directory + key çš„è¡Œå­˜çš„ã€‚</p><h2 id="TrueTime"><a href="#TrueTime" class="headerlink" title="TrueTime"></a>TrueTime</h2><p>æœ¬äººå¯¹â€œæ—¶é—´â€è¿™ä¸ªè®¡ç®—æœºæ¦‚å¿µä¸æ˜¯å¾ˆç†Ÿæ‚‰ï¼Œæ‰€ä»¥æ—¶é—´è¿™å—ä¼šè¿‡çš„å¾ˆè‰ç‡ï¼Œç­‰ä»¥åè¡¥å¥½äº†å›å¤´å†çœ‹çœ‹ã€‚</p><p><img src="https://image.mwish.me/blog-image/795C6B9C-F39B-4AE2-B0B1-D014FB8C07FA.png" alt="795C6B9C-F39B-4AE2-B0B1-D014FB8C07FA"></p><p>TrueTime API ä¼šæä¾›ä¸€ä¸ªæ—¶é—´çš„å¯ä¿¡åº¦åŒºé—´ã€‚åœ¨ Googleï¼Œè¿™ä¸ª API æ˜¯ç”±åŸå­é’Ÿ + GPS å®ç°çš„ï¼Œç”¨åŒä¸€ä¸ªæ•°æ®ä¸­å¿ƒå¤šä¸ª master å’Œæœºå™¨ä¸Šçš„ slave + GPS å…±åŒå®ç°æ—¶é’ŸåŒæ­¥çš„æœºåˆ¶ã€‚</p><p>åç»­å†…å®¹ä¸­ï¼Œæœ‰éœ€è¦åˆ¤æ–­ after çš„ï¼Œä¹Ÿæœ‰éœ€è¦ç­‰å¾… after çš„ã€‚</p><h2 id="å¹¶å‘"><a href="#å¹¶å‘" class="headerlink" title="å¹¶å‘"></a>å¹¶å‘</h2><p>Spanner çš„å¹¶å‘ä¸»è¦æŒ‡å®ƒå®ç°äº‹åŠ¡ã€‚</p><h4 id="Requirements"><a href="#Requirements" class="headerlink" title="Requirements"></a>Requirements</h4><ol><li>å¯¹äºåªè¯»äº‹åŠ¡å’Œå¿«ç…§è¯»è€Œè¨€ï¼Œä¸€æ—¦å·²ç»é€‰å®šä¸€ä¸ªæ—¶é—´æˆ³ï¼Œé‚£ä¹ˆï¼Œæäº¤å°±æ˜¯ä¸å¯é¿å…çš„ï¼Œ é™¤éåœ¨é‚£ä¸ªæ—¶é—´ç‚¹çš„æ•°æ®å·²ç»è¢«åƒåœ¾å›æ”¶äº†</li><li>æŠŠ Spanner å®¢æˆ·ç«¯çš„å†™æ“ä½œå’Œ Paxos çœ‹åˆ°çš„å†™æ“ä½œè¿™äºŒè€…è¿›è¡ŒåŒºåˆ†ï¼Œæ˜¯éå¸¸ é‡è¦çš„ï¼Œæˆ‘ä»¬æŠŠ Paxos çœ‹åˆ°çš„å†™æ“ä½œç§°ä¸º Paxos å†™æ“ä½œã€‚ä¾‹å¦‚ï¼Œä¸¤é˜¶æ®µæäº¤ä¼šä¸ºå‡†å¤‡æäº¤é˜¶ æ®µç”Ÿæˆä¸€ä¸ª Paxos å†™æ“ä½œï¼Œè¿™æ—¶ä¸ä¼šæœ‰ç›¸åº”çš„å®¢æˆ·ç«¯å†™æ“ä½œã€‚</li><li>åœ¨æ—¶é—´æˆ³ä¸º t çš„æ—¶åˆ»çš„æ•°æ®åº“è¯»æ“ä½œï¼Œä¸€å®šåªèƒ½çœ‹åˆ°åœ¨ t æ—¶åˆ»ä¹‹ å‰å·²ç»æäº¤çš„äº‹åŠ¡ã€‚</li><li>äº‹åŠ¡è¯»å’Œå†™é‡‡ç”¨ S2PL åè®®ã€‚As a result, they can be assigned timestamps at any time when all locks have been acquired, but before any locks have been released.</li><li>For a given transaction, Spanner as- signs it the timestamp that Paxos assigns to the Paxos write that represents the transaction commit.</li></ol><p>Spanner ä¾èµ–ä¸‹é¢è¿™äº›å•è°ƒæ€§:</p><ol><li>åœ¨æ¯ä¸ª Paxos Group å†…ï¼ŒSpanner ä¼šä»¥å•è°ƒå¢åŠ çš„é¡ºåºç»™æ¯ä¸ª Paxos å†™æ“ä½œåˆ†é…æ—¶é—´æˆ³ï¼Œå³ä½¿åœ¨è·¨è¶Šå¤šä¸ªé¢†å¯¼è€…æ—¶ä¹Ÿæ˜¯å¦‚æ­¤ã€‚</li><li>åœ¨å¤šä¸ªé¢†å¯¼è€…ä¹‹é—´å°±ä¼šå¼ºåˆ¶å®ç°å½¼æ­¤éš”ç¦»çš„ä¸è¿è´¯:ä¸€ä¸ªé¢†å¯¼è€…å¿…é¡»åªèƒ½åˆ†é…å±äºå®ƒè‡ªå·± Lease åŒºé—´å†…çš„æ—¶é—´æˆ³ã€‚å½“åˆ†é…ä¸€ä¸ª s æ—¶ï¼ŒPaxos Group çš„ Leader çš„ <code>smax</code> lease éœ€è¦å¤§äº <code>s</code>.</li></ol><p>Spanner ä¹Ÿä¿è¯äº† Paxos Group é’ˆå¯¹å¤–éƒ¨çš„ä¸€è‡´æ€§ï¼š</p><blockquote><p>if the start of a transaction T occurs after the commit of a transaction T1, then the commit timestamp of T2 must be greater than the commit timestamp of T1.</p></blockquote><p>è¿™æè¿°äº† Spanner è‡ªèº« Commit çš„çº¦æŸï¼Œå› ä¸ºå®ƒä¼¼ä¹åªåˆ†é…äº†ä¸€ä¸ª ts, æ²¡æœ‰ è·Ÿ Percolator é‚£æ ·åˆ†é… start_ts å’Œ commit_tsã€‚</p><p>å®¢æˆ·ç«¯çš„è¯»ä¾èµ– timestamp å’Œå¯¹åº”çš„æœºå™¨ï¼Œåœ¨ä¸Šé¢æ‹¿åˆ° SnapShot æ¥è¯»ï¼Œè€Œå†™éœ€è¦è¿‡ Leaderã€‚æ‰€æœ‰çš„ Retry ä¼šè¯•å›¾åœ¨ç³»ç»Ÿå†…éƒ¨è¿›è¡Œï¼Œä¸éœ€è¦ Spanner åšé¢å¤–çš„æ“ä½œã€‚</p><p>Spanner çš„è¯»å†™è‚¯å®šéƒ½ä¼šå’Œ Paxos é€»è¾‘æœ‰å…³ï¼Œæ„Ÿè§‰æœ‰ç‚¹ç±»ä¼¼ Lease + Raftã€‚Leader ä¼šæœ‰ä¸€ä¸ª Leaseï¼Œåœ¨ replica å†™å®Œæˆçš„æ—¶å€™ï¼Œä¼šå»¶ç»­è‡ªå·±çš„ lease, è€Œ Leader éœ€è¦ explicit çš„ç»­å‘½ã€‚Spanner å…è®¸åˆ‡æ¢ Leader, ä½†æ˜¯è¦å®šä¹‰ä¸€ä¸ª <code>Smax</code>, åªæœ‰æ—¶é—´è¶…è¿‡ <code>Smax</code>, å³ <code>TT.after(s_max)</code>, æ‰ä¼šå…è®¸åˆ‡æ¢ã€‚</p><p>äº‹åŠ¡ä¸­ï¼ŒSpanner ä½¿ç”¨ 2PCï¼Œäº‹åŠ¡ä¼šåˆ†é…æ—¶é—´æˆ³ï¼Œä»£è¡¨<strong>äº‹åŠ¡æäº¤çš„æ—¶é—´</strong>ï¼ˆPercolator ä¼šåœ¨ æäº¤ å’Œ å¼€å§‹ éƒ½åˆ†é…æ—¶é—´æˆ³ï¼Œåˆ¤æ–­é‡å¤çš„åŒºé—´ï¼‰ã€‚</p><blockquote><p>Spanner ä¾èµ–ä¸‹é¢è¿™äº›å•è°ƒæ€§:åœ¨æ¯ä¸ª Paxos ç»„å†…ï¼ŒSpanner ä¼šä»¥å•è°ƒå¢åŠ çš„é¡ºåºç»™æ¯ä¸ª Paxos å†™æ“ä½œåˆ†é…æ—¶é—´æˆ³ï¼Œå³ä½¿åœ¨è·¨è¶Šå¤šä¸ªé¢†å¯¼è€…æ—¶ä¹Ÿæ˜¯å¦‚æ­¤ã€‚ä¸€ä¸ªå•ä¸ªçš„é¢†å¯¼è€…å‰¯æœ¬ï¼Œå¯ ä»¥å¾ˆå®¹æ˜“åœ°ä»¥å•è°ƒå¢åŠ çš„æ–¹å¼åˆ†é…æ—¶é—´æˆ³ã€‚åœ¨å¤šä¸ªé¢†å¯¼è€…ä¹‹é—´å°±ä¼šå¼ºåˆ¶å®ç°å½¼æ­¤éš”ç¦»çš„ä¸è¿ è´¯:ä¸€ä¸ªé¢†å¯¼è€…å¿…é¡»åªèƒ½åˆ†é…å±äºå®ƒè‡ªå·±ç§Ÿçº¦æ—¶é—´åŒºé—´å†…çš„æ—¶é—´æˆ³ã€‚è¦æ³¨æ„åˆ°ï¼Œä¸€æ—¦ä¸€ä¸ªæ—¶ é—´æˆ³ s è¢«åˆ†é…ï¼Œsmax å°±ä¼šè¢«å¢åŠ åˆ° sï¼Œä»è€Œä¿è¯å½¼æ­¤éš”ç¦»æ€§(ä¸è¿è´¯æ€§)ã€‚</p></blockquote><p>æ‰€ä»¥å†™çš„æ—¶å€™ï¼Œä¼šæœ‰å…¨å±€çš„æ—¶é—´æˆ³ã€‚ä½†æ˜¯åŒæ—¶ï¼Œå¾ˆåŠè¯¡çš„æ˜¯ï¼Œè¿™ä¸ªæ—¶é—´æˆ³æ˜¯åœ¨å¼€å§‹çš„æ—¶å€™è¢«åˆ†é…çš„</p><p><img src="https://image.mwish.me/blog-image/71547DDC-3204-4DD8-B279-F6218F60D296.png" alt="71547DDC-3204-4DD8-B279-F6218F60D296"></p><p>è¯»å–çš„äº‹åŠ¡ä¼šæœ‰ä¸€ä¸ª <code>t_safe</code> , è¿™ä¸ªå€¼ä»£è¡¨å®‰å…¨è¯»å–çš„æ—¶é—´æˆ³ï¼Œæ²¡æœ‰åˆ°çš„è¯å¯èƒ½æ˜¯è¦é˜»å¡/é‡è¯•çš„ï¼Œé‚£ä¹ˆå¯èƒ½æ›´æ”¹çš„æœ‰ï¼š</p><ul><li>å†™å…¥çŠ¶æ€æœºçš„æœ€å¤§æ—¶é—´ Paxos çš„ safe, å³è¢«åº”ç”¨åˆ° Paxos çŠ¶æ€æœºçš„æœ€å¤§æ—¶é—´æˆ³ã€‚</li><li>Transaction Manager çš„äº‹åŠ¡ç›¸å…³çš„ ts, å¦‚æœå°äºå†™å…¥çš„ ts çš„è¯ï¼Œå¯èƒ½ä¼šæœ‰å†²çªï¼Œéœ€è¦ block</li></ul><h3 id="å®ç°ç»†èŠ‚"><a href="#å®ç°ç»†èŠ‚" class="headerlink" title="å®ç°ç»†èŠ‚"></a>å®ç°ç»†èŠ‚</h3><blockquote><p>Like Bigtable, writes that occur in a transaction are buffered at the client until commit. As a result, reads in a transaction do not see the effects of the transactionâ€™s writes. This design works well in Spanner because a read returns the timestamps of any data read, and uncommit- ted writes have not yet been assigned timestamps.</p></blockquote><p>è¿™ä¸ªæ˜¯é  <code>ts_safe</code> é‚£ä¸ªçº¦æŸå¤„ç†çš„ã€‚</p><p>RW äº‹åŠ¡ä¸­ï¼Œå…ˆè¯·æ±‚ä¸€ä¸ª Paxos Groupï¼Œæ‹¿åˆ°è¯»é”ï¼Œè¯»éœ€è¦è¯»çš„æ•°æ®ï¼Œç„¶å boffer æ‰€æœ‰çš„ writeã€‚ç„¶åå¼€å§‹ 2PCï¼š</p><ol><li>Participant æ‹¿åˆ°å†™é”ï¼Œåˆ†é…ä¸€ä¸ªå•è°ƒé€’å¢çš„ prepare tsï¼Œæäº¤ä¸€ä¸ª Prepare Paxos Logï¼Œç„¶åæŠŠå¯¹åº”çš„ prepare ts ç»™ Coodinator</li><li>Coodinator æ‹¿åˆ°ä¸€ä¸ªé€’å¢çš„ï¼Œå¤§äº <em>TT.now</em>().<em>latest</em> ã€å¤§äºæ‰€æœ‰ prepare ts çš„ commit ts<ol><li>The coordinator leader then logs a commit record through Paxos (or an abort if it timed out while waiting on the other participants).</li></ol></li><li>Before allowing any coordinator replica to apply the commit record, the coordinator leader waits until <em>TT.after</em>(<em>s</em>), so as to obey the commit-wait rule described in Section 4.1.2. </li></ol><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œå•æœºä¸Šçš„ä»»ä½•å†²çªé  wound-wait, å¤šæœºå™¨é ä¸Šé¢çš„åè®®å®ç°ã€‚</p><p>è¯»ç›¸å¯¹ç®€å•çš„å¤šï¼Œæ‹¿åˆ° Group çš„ scope ç„¶åæ‹¿åˆ° <code>safe_ts</code> æ¥è¯»ã€‚ä¸è¿‡ <code>safe_ts</code> é€‰ä¸¾ä¹Ÿæ˜¯æœ‰æŠ€å·§çš„ï¼š</p><blockquote><p>If the scopeâ€™s values are served by a single Paxos group, then the client issues the read-only transaction to that groupâ€™s leader. (The current Spanner implementa- tion only chooses a timestamp for a read-only transac- tion at a Paxos leader.) That leader assigns s<em>read</em> and ex- ecutes the read. For a single-site read, Spanner gener- ally does better than <em>TT.now</em>().<em>latest</em>. Define <em>LastTS</em>() to be the timestamp of the last committed write at a Paxos group. If there are no prepared transactions, the assign- ment s<em>read</em> = <em>LastTS</em>() trivially satisfies external consis- tency: the transaction will see the result of the last write, and therefore be ordered after it.</p><p>If the scopeâ€™s values are served by multiple Paxos groups, there are several options. The most complicated option is to do a round of communication with all of the groupsâ€™s leaders to negotiate s<em>read</em> based on <em>LastTS</em>(). Spanner currently implements a simpler choice. The client avoids a negotiation round, and just has its reads execute at s<em>read</em> = <em>TT.now</em>().<em>latest</em> (which may wait for safe time to advance). All reads in the transaction can be sent to replicas that are sufficiently up-to-date.</p></blockquote><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ol><li><a href="https://zhuanlan.zhihu.com/p/47870235">https://zhuanlan.zhihu.com/p/47870235</a></li></ol>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>notes: Aurora</title>
      <link href="/2020/08/16/notes-Aurora/"/>
      <url>/2020/08/16/notes-Aurora/</url>
      
        <content type="html"><![CDATA[<h1 id="Aurora"><a href="#Aurora" class="headerlink" title="Aurora"></a>Aurora</h1><p>è®©æˆ‘ä»¬ç»§ç»­ 6.824 é˜…è¯»ã€‚Lecture 10 çš„æ ‡é¢˜æ˜¯:</p><blockquote><p>Lecture 10: Database logging, quorums, Amazon Aurora</p></blockquote><p>ä¸å‰é¢çš„ Raft/CRAQ ä¸åŒï¼ŒAurora å±•ç¤ºäº†ä¸€ç§æŠ€æœ¯å¾ˆç‰›é€¼ä¹Ÿå–å¾—å¾ˆå¥½çš„å…±äº«å­˜å‚¨æ¶æ„ã€‚æˆ‘ä»¬å¯ä»¥è¯´è¿™æ˜¯ç»è¿‡äº†è€ƒéªŒçš„è®¾è®¡è‰¯å¥½çš„æ¶æ„ã€‚</p><p>6.824 ä¸»è¦ä»‹ç»çš„æ˜¯ AZ å’Œ Quorumï¼Œè™½ç„¶è¿™äº›ä¸œè¥¿éƒ½å¾ˆå‰å®³ï¼Œä¸è¿‡æˆ‘æ€»è§‰å¾—æ²¡ä»‹ç» Aurora æœ€ç‰›çš„ä¸œè¥¿ï¼Ÿ</p><p><img src="https://image.mwish.me/blog-image/2F83C406-2307-437E-9E86-772AF7D89F39.png" alt="2F83C406-2307-437E-9E86-772AF7D89F39"></p><p>EC2 æ˜¯ Amazon çš„äº‘æœåŠ¡å™¨ï¼Œç”±æœ¬åœ°çš„ SSDï¼Œå¹¶æœ‰å¤šç§Ÿæˆ·ç­‰ç‰¹æ€§ï¼ŒS3 æ˜¯äºšé©¬é€Šçš„å¯¹è±¡å­˜å‚¨. åœ¨ S3 ä¸Šå­˜ä¸Šå»äº†èƒ½ä¿è¯å®‰å…¨æ€§ã€‚</p><p>è¿™é‡Œçš„ RW è¡¨ç¤ºæœ‰è¯»/å†™æƒé™çš„ Primary, RO è¡¨ç¤ºåªè¯»çš„æœºå™¨ã€‚è¿ç®—èŠ‚ç‚¹æœºå™¨éƒ¨ç½²åœ¨ Amazon çš„ VPC ä¸Šï¼Œè€Œå­˜å‚¨ä¾èµ–äºéƒ¨ç½²åœ¨å„åœ°ã€æœ‰æœ¬åœ° SSD çš„å­˜å‚¨èŠ‚ç‚¹ã€‚å®ƒä¹Ÿä¼šäº§ç”Ÿç±»ä¼¼ binlog çš„æ–‡ä»¶ï¼ŒåŒæ­¥åˆ° Amazon S3 å¯¹è±¡å­˜å‚¨ä¸Šã€‚</p><p>6.824 ç»™äº†ä¸€äº› AWS æœåŠ¡çš„ä»‹ç»ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">EC2 is great for www servers</span><br><span class="line">  more load -&gt; rent more EC2 instances</span><br><span class="line">  crash -&gt; who cares, stateless, data in DB</span><br><span class="line">EC2 is not ideal for DB e.g. MySQL</span><br><span class="line">  limited scaling options -- just read/only DB replicas</span><br><span class="line">  limited fault-tolerance; if phys machine dies, disk dies with it</span><br><span class="line">    periodic DB backups to Amazon&#x27;s &quot;S3&quot; bulk storage service</span><br></pre></td></tr></table></figure><p>æ­¤å¤–è¿˜éœ€è¦ä»‹ç» Amazon EBS, å³ Block Storeï¼ŒAWS çš„å—å­˜å‚¨ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Amazon EBS (Elastic Block Store)</span><br><span class="line">  [diagram of EC2 instance, two EBS servers -- left half of Figure 2]</span><br><span class="line">  block storage that&#x27;s still available even if an EC2 instance crashes</span><br><span class="line">  looks like a disk to EC2 instances, mount e.g. Linux ext4 on EBS volume</span><br><span class="line">  implemented as pairs of servers with disk drives, chain replication,</span><br><span class="line">    paxos-based configuration manager</span><br><span class="line">  both replicas are in the same &quot;availability zone&quot; (AZ)</span><br><span class="line">    AZ = machine room or datacenter</span><br><span class="line">    for speed, since all client writes have to wait for both EBS servers</span><br><span class="line">  for a DB on EC2, much better fault-tolerance than locally-attached storage!</span><br><span class="line">    if DB EC2 instance crashes, just re-start it on another EC2 instance</span><br><span class="line">    and attach to the same EBS volume</span><br><span class="line">  note: only one EC2 instance can use a given EBS volume at a time</span><br><span class="line">    EBS is not shared storage</span><br></pre></td></tr></table></figure><p>ä¼ ç»Ÿçš„ Mirror æ–¹æ¡ˆ Pipeline å¦‚ä¸‹ï¼š</p><p><img src="https://image.mwish.me/blog-image/F2166CAF-99B5-4B32-BFE9-A5008D68FF2B.png" alt="F2166CAF-99B5-4B32-BFE9-A5008D68FF2B"></p><p>ï¼ˆå¼‚æ­¥çš„æ–¹æ¡ˆæˆ–è®¸åªè¦è¯»å– binlog, ä½†æ˜¯åŒæ­¥å¤åˆ¶åˆ™éœ€è¦åšä¸Šé¢çš„æ“ä½œ <a href="https://dev.mysql.com/doc/refman/8.0/en/replication-semisync.htmlï¼‰">https://dev.mysql.com/doc/refman/8.0/en/replication-semisync.htmlï¼‰</a></p><p>ä¸Šè¿°çš„æ“ä½œæˆ–è€…æ–¹æ¡ˆä¼šå¸¦æ¥å¾ˆå¤§çš„å†™æ”¾å¤§ã€‚æ­¤å¤–ï¼ŒAurora è®¤ä¸ºï¼Œåœ¨ä¸€ä¸ªé›†ç¾¤ä¸­ï¼Œæ…¢çš„æœºå™¨å’Œæ…¢çš„/åŒæ­¥çš„æ“ä½œå¾ˆå®¹æ˜“æˆä¸ºç“¶é¢ˆï¼Œä¾‹å¦‚ï¼š</p><ul><li>äº‹åŠ¡çš„ Commit é˜»å¡å†²çªçš„äº‹åŠ¡</li><li>åˆ†å¸ƒå¼äº‹åŠ¡çš„ 2PC</li><li>å•æœºçš„ Cache Miss</li></ul><p>Aurora æŠŠä¸Šå±‚ä¿ç•™ï¼ˆä¸è¿‡å¯èƒ½ä¹Ÿè¦åšä¸€äº›é€‚é…ï¼‰ï¼Œç„¶ååœ¨å­˜å‚¨å±‚æ›¿æ¢ä¸ºäº†åˆ†å¸ƒå¼çš„ï¼š</p><p><img src="https://image.mwish.me/blog-image/76F2664C-65A4-4D5C-AF5D-10334065E8BA.png" alt="76F2664C-65A4-4D5C-AF5D-10334065E8BA"></p><blockquote><p>First, by building storage as an independent fault- tolerant and self-healing service across multiple data-centers, we protect the database from performance variance and transient or permanent failures at either the networking or storage tiers. We observe that a failure in durability can be modeled as a long- lasting availability event, and an availability event can be modeled as a long-lasting performance variation â€“ a well-designed system can treat each of these uniformly [42]. Second, by only writing redo log records to storage, we are able to reduce network IOPS by an order of magnitude. Once we removed this bottleneck, we were able to aggressively optimize numerous other points of contention, obtaining significant throughput improvements over the base MySQL code base from which we started. Third, we move some of the most complex and critical functions (backup and redo recovery) from one-time expensive operations in the database engine to continuous asynchronous operations amortized across a large distributed fleet.</p></blockquote><p>Aurora ä¸»è¦æ€è·¯æ˜¯ï¼š</p><ol><li>æä¾›å…±äº«çš„å­˜å‚¨å’Œ RWN, åœ¨å¤šä¸ªå¯ç”¨åŒºä¿è¯å¯é æ€§</li><li>The log is the database, å…±äº«å­˜å‚¨ä¸ Log</li><li>åŸºäº(2) çš„äº‹åŠ¡</li></ol><p>æˆ‘è§‰å¾— 1 å…¶å®å¾ˆå¥½ç†è§£ï¼Œ2å¯¹æˆ‘è¿™ç§æ²¡çœ‹è¿‡çš„æ¯”è¾ƒæ–°å¥‡ï¼Œä½†æ˜¯ä¹Ÿå¯ä»¥ç†è§£ï¼Œ3è¿™æ®µå¾ˆéš¾</p><h2 id="å­˜å‚¨"><a href="#å­˜å‚¨" class="headerlink" title="å­˜å‚¨"></a>å­˜å‚¨</h2> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Goal: better fault tolerance by cross-AZ replication</span><br></pre></td></tr></table></figure><p>Available Zone å¯ç”¨åŒºï¼Œç®€å•ç†è§£ç±»ä¼¼äºé˜¿é‡Œäº‘ xx æœºæˆ¿ï¼Œç‰¹æ€§æ˜¯ï¼š</p><ul><li>å†…éƒ¨æœºå™¨ç‰©ç†ä¸Šå¤§æ¦‚å¾ˆæ¥è¿‘ï¼Œé›¶ç‚¹å‡ æ¯«ç§’ ping ä¸€ä¸‹</li><li>ç¡¬ä»¶ä¸€èˆ¬æ•…éšœå…¶å®æ¦‚ç‡éƒ½å·®ä¸å¤šï¼Œä½†æ˜¯é«˜æ¸©ã€å‘æ´ªæ°´ã€ç½‘ç»œå»¶è¿Ÿä¹‹ç±»çš„å¯èƒ½å¯¼è‡´æ•´ä¸ªæœºæˆ¿éƒ½ä¸å¯ç”¨</li></ul><p>Aurora é‡‡å–3AZ + æ¯ä¸ª AZ ä¸¤å°çš„å½¢å¼ï¼Œåœ¨ RWN åè®®ä¸‹ä¿è¯äº†ï¼š</p><ul><li>ä¸€ä¸ª AZ å†…å…¨éƒ¨åæ‰ + é¢å¤–åä¸€å°ï¼Œæ˜¯å¯è¯»çš„</li><li>ä¸€ä¸ª AZ å…¨éƒ¨åæ‰ï¼Œæ˜¯å¯å†™çš„</li></ul><p>ï¼ˆæˆ‘çš„é—®é¢˜æ˜¯è¿™æ ·å†™å…¥ä¸ä¼šå»¶è¿Ÿå·¨é«˜ä¹ˆ=ã€‚=ï¼‰</p><p>Aurora å°†ï¼š</p><ul><li>é•¿æœŸçš„æœºå™¨åæ‰</li><li>çŸ­æš‚çš„ç½‘ç»œå»¶è¿Ÿ</li><li>æ›´æ–°</li></ul><p>ä¸Šè¿°çš„é—®é¢˜éƒ½è§†ä½œç³»ç»Ÿçš„ä¸å¯ç”¨ã€‚ç°åœ¨å®ƒæƒ³è¦ä¿è¯çš„æ˜¯ï¼š</p><ul><li>æ— æ³•å‡å°‘æ•…éšœä¿®å¤æ—¶é—´</li><li>â€”&gt; å¸Œæœ›å‡å°‘ MTTF ï¼ˆå¹³å‡æ•…éšœé—´éš”ï¼‰ï¼Œæ¥è®©ä¸Šè¿°ä¸å¯ç”¨å¾ˆå°‘å‘ç”Ÿï¼Œä¿è¯ç³»ç»Ÿæœ‰ Quorum</li></ul><p>Aurora é‡‡ç”¨ Segment Storage, æ¥åˆ†10Gæ®µå­˜å‚¨ï¼Œåˆ†æ®µä¿®å¤ã€‚</p><blockquote><p>ä¹‹æ‰€ä»¥é€‰æ‹©10Gï¼Œæ˜¯å› ä¸ºåœ¨ä¸‡å…†ç½‘ç»œæ¡ä»¶ä¸‹ï¼Œæ¢å¤ä¸€ä¸ªæ•°æ®æ®µåªéœ€è¦10ç§’é’Ÿã€‚åœ¨è¿™ç§æƒ…å†µï¼Œå¦‚æœè¦æ‰“ç ´å¤šæ•°æ´¾ï¼Œé‚£ä¹ˆå¿…é¡»åŒæ—¶å‡ºç°ä¸¤ä¸ªæ•°æ®æ®µåŒæ—¶æ•…éšœåŠ ä¸Šä¸€ä¸ªAZæ•…éšœï¼ŒåŒæ—¶AZæ•…éšœä¸åŒ…å«ä¹‹å‰ä¸¤ä¸ªæ•°æ®æ®µæ•…éšœçš„ç‹¬ç«‹äº‹ä»¶ã€‚é€šè¿‡æˆ‘ä»¬å¯¹æ•…éšœç‡çš„è§‚å¯Ÿï¼Œè¿™ç§æƒ…å†µå‡ºç°çš„æ¦‚ç‡è¶³å¤Ÿä½ï¼Œå³ä½¿æ˜¯åœ¨æˆ‘ä»¬ç°åœ¨ä¸ºå®¢æˆ·æœåŠ¡çš„æ•°æ®åº“é‡çº§ä¸Šã€‚</p></blockquote><p>ä»¥ä¸Šçš„æ˜¯æ¨¡å‹ä¸Šçš„æ€è·¯ï¼ŒAurora æä¾›äº† EBS çº§åˆ«çš„å®¹é”™ï¼š</p><ul><li>EBS éƒ¨ç½²åœ¨ä¸Šè¿°æ‰€å™è¿°çš„æƒ…å†µä¸‹ï¼Œæ¥ä¿è¯å†™å…¥çš„ Quorum</li></ul><p>è¯è¯´ 6.824 åœ¨è¿™é‡Œç®€å•ä»‹ç»äº†ä¸€ä¸‹ Quorum read/writeï¼ŒAmazon åœ¨å®ç° Dynamo çš„æ—¶å€™ä¹Ÿç”¨äº†è¿™å¥—ï¼š</p><ul><li>å¯èƒ½å†™å…¥éœ€è¦ç»´æŠ¤ç‰ˆæœ¬</li><li>N æ˜¯æ€»å‰¯æœ¬çš„æ•°é‡ï¼ŒRæ˜¯è¯»çš„æ•°é‡ï¼ŒWæ˜¯æˆåŠŸå†™çš„æ•°é‡ï¼Œé‚£ä¹ˆï¼š<ul><li>R + W &gt; N, å³åˆ»è¯´æ˜è¯»å†™å¿…å®šæœ‰äº¤é›†ï¼Œå¿…å®šèƒ½è¯»åˆ°å†™å…¥çš„æ•°æ®</li></ul></li></ul><p>6.824 ä»‹ç»å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"> the goal: fault-tolerant storage,</span><br><span class="line">   read latest data even if some failures</span><br><span class="line">how to decide which is the most recent copy?</span><br><span class="line">   cannot vote on content!</span><br><span class="line">     only one server in read quorum might be up to date</span><br><span class="line">   writer assigns increasing version numbers to its writes</span><br><span class="line">   storage servers must remember version of each item</span><br><span class="line">   reader takes max version # of the R copies it receives</span><br><span class="line"> what if a read or write can&#x27;t assemble a quorum?</span><br><span class="line">   keep trying.</span><br></pre></td></tr></table></figure><p>ä¸‹é¢æ˜¯å®ƒçš„ pros and cons</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">What is the benefit of quorum read/write storage systems?</span><br><span class="line">  In contrast to e.g. chain replication.</span><br><span class="line">  Smooth handling of dead or slow or partitioned storage servers</span><br><span class="line">    No need to wait, no need to detect failure, no timeout</span><br><span class="line">    Important for Amazon for remote AZs and temporarily slow servers</span><br><span class="line">    No risk of split brain among the storage servers</span><br><span class="line">  Can adjust R and W to make reads or writes faster (but not both).</span><br><span class="line">  But:</span><br><span class="line">    Servers not in write quorum must catch up (e.g. Aurora&#x27;s gossip).</span><br><span class="line">    Can only tolerate min(N-W, N-R) failures.</span><br><span class="line">    Requirement for version numbers makes it most suitable for single writer.</span><br></pre></td></tr></table></figure><p>åŒæ—¶ï¼Œæ•°æ®æŒ‰ç…§ segment è¿›è¡Œ sharding:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">What if the database is too big for a replica to fit into one storage server?</span><br><span class="line">  Data pages are sharded into 10-GB Protection Groups (PGs).</span><br><span class="line">  Each PG is separately replicated as six &quot;segments&quot; (on six replicas).</span><br><span class="line">    Different PGs likely to be on different sets of six storage servers.</span><br><span class="line">  [DB server, two PGs on 12 storage servers]</span><br></pre></td></tr></table></figure><h2 id="The-log-is-the-database"><a href="#The-log-is-the-database" class="headerlink" title="The log is the database"></a>The log is the database</h2><p><img src="https://image.mwish.me/blog-image/image.png" alt="image"></p><p>Aurora åªä¼šåŒæ­¥ Redo Logï¼Œè€Œä¸è¦åƒä¹‹å‰çš„ MySQL é‚£æ ·åŒæ­¥å¾ˆå¤šåˆ«çš„ write æ“ä½œã€‚Redo log æè¿°è¦è¿›è¡Œçš„æ“ä½œã€‚æ—¥å¿—å’Œå­˜å‚¨å±‚ä¸‹æ²‰åˆ°äº†å­˜å‚¨èŠ‚ç‚¹ã€‚ä½ å¯èƒ½ä¼šè®°å¾—ä¸‹é¢çš„ï¼š</p><p><img src="https://image.mwish.me/blog-image/9DE4AA15-CD61-4C5E-852B-22B34EC48A82.png" alt="9DE4AA15-CD61-4C5E-852B-22B34EC48A82"></p><p>è¿™è¦æ±‚ç³»ç»Ÿå¤§æ¦‚è¦æ»¡è¶³ no-steal/no-force çš„ç‰¹æ€§ï¼šæœªå®Œæˆäº‹åŠ¡çš„é¡µä¸èƒ½åˆ·åˆ°ç›˜ä¸Š. æˆ‘ä»¬ä¼šåœ¨ Log éƒ¨åˆ†å†æ¬¡è®¨è®ºè¿™ä¸€æ®µã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Storage servers understand how to apply DB&#x27;s log to data pages</span><br><span class="line">  So only need to send (small) log entries, not (big) dirty pages</span><br><span class="line">  Sending to many replicas, but not much data</span><br></pre></td></tr></table></figure><p><img src="https://image.mwish.me/blog-image/509272B2-DDAB-49AB-9DE3-4B2131B96997.png" alt="509272B2-DDAB-49AB-9DE3-4B2131B96997"></p><p>é€šè¿‡ä¸Šè¿°çš„ç­–ç•¥å’Œå¼‚æ­¥çš„ apply, Aurora å‡å°‘äº†å†™å…¥çš„å»¶æ—¶ï¼šlog å†™å…¥æ”¾å…¥ Update Queue å³å¯ï¼Œå¤§å¤§é™ä½äº† Latency.</p><h2 id="æ—¥å¿—å’Œ-SQL"><a href="#æ—¥å¿—å’Œ-SQL" class="headerlink" title="æ—¥å¿—å’Œ SQL"></a>æ—¥å¿—å’Œ SQL</h2><p>Log éœ€è¦å¯¹åº”çš„ LSNã€‚å¯¹æ—¥å¿—å¤„ç†çš„å±‚åœ¨ Storage Layer ä¸Šï¼Œæ‰€ä»¥å®ƒä»¬çŸ¥é“æ—¥å¿—çš„è¯­ä¹‰ï¼Œèƒ½å¤Ÿ apply è¿™äº›æ—¥å¿—ã€‚</p><p>ä»¥ä¸Šçš„å†™å…¥æµç¨‹æ˜¯è¿‡äºç®€å•çš„ï¼Œç„¶è€Œè¯»æ€»è¦è¯»åˆ°åƒæ ·çš„ä¸œè¥¿å§ï¼æ—¢ç„¶å’Œ MySQL æ¥ PKï¼Œæ€»è¦æœ‰äº‹åŠ¡çš„è¯­ä¹‰å§ï¼</p><p>æ•°æ®åº“è¦ç¡®è®¤ä¸‹åˆ—ä¿¡æ¯ï¼š</p><ul><li>VCLï¼ˆVolume Complete LSNï¼‰ï¼šä¿è¯ä¹‹å‰éƒ½è¢«æŒä¹…åŒ–çš„ LSN</li><li>CPLï¼ˆConsistency Point LSNï¼‰ï¼šå¯¹äºäº‹åŠ¡çš„è¯­ä¹‰çš„ CP</li><li>VDLï¼ˆVolume Durable LSNï¼‰: å‰¯æœ¬æœ€å¤§çš„ CPL</li></ul><blockquote><p>CPLå¿…é¡»å°äºæˆ–è€…ç­‰VCLï¼Œæ‰€æœ‰å¤§äºVDLçš„æ—¥å¿—è®°å½•éƒ½å¯ä»¥è¢«æˆªæ–­ä¸¢æ‰</p></blockquote><p>é‚£ä¹ˆï¼Œç”šè‡³ VDL ä¹‹å‰çš„ä¸€äº›éƒ½è¦åœ¨è¯­ä¹‰ä¸Šè§†ä½œæ²¡ Commit. å†™å…¥åŒ—æ¨è¿›çš„æ—¶å€™ï¼ŒVCL CPL VDL è¢«æ¨è¿›ï¼Œæ¥å®ç°äº‹åŠ¡çš„è¯­ä¹‰ã€‚</p><p>6.824 å¯¹ Log Write æœ‰ä¸ªæ¯”è¾ƒç²¾ç‚¼çš„æè¿°ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">What does an Aurora quorum write look like?</span><br><span class="line">  Not a classic quorum write:</span><br><span class="line">    DB server&#x27;s writes to storage servers do *not* modify existing data items!</span><br><span class="line">  A write consists of a new log entry.</span><br><span class="line">    For an in-progress transaction.</span><br><span class="line">    Or a commit log record.</span><br><span class="line">  Aurora sends each log record to all six storage servers.</span><br><span class="line">  Transaction commit waits for all of xaction&#x27;s log records to be on a quorum.</span><br><span class="line">    Stated as VDL &gt;= transaction&#x27;s last record.</span><br><span class="line">    So every xaction through this one can be recovered after a crash.</span><br><span class="line">  Commit ==&gt; release locks, reply to client.</span><br></pre></td></tr></table></figure><p>åœ¨å†™å…¥çš„æ—¶å€™ï¼Œä½ è¦å†™ Quorum, ç„¶å <code>VDL &gt; æ—¥å¿—çš„ CPL</code> æ—¶, æäº¤å°±æ˜¯å®‰å…¨çš„ï¼Œä½ å¯ä»¥ Commit äº†ã€‚</p><p>è¯»å–çš„æ—¶å€™æµç¨‹å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">What does an ordinary Aurora read look like?</span><br><span class="line">  Not a quorum read!</span><br><span class="line">  The Aurora DB server needs a data page, due to a cache miss.</span><br><span class="line">    Writes are log entries; reads yield data pages.</span><br><span class="line">  Needs to find a storage server that has all the relevant log entries.</span><br><span class="line">  Database server tracks each storage server&#x27;s SCL (Segment Complete LSN).</span><br><span class="line">    Each storage server has all log entries &lt;= its SCL.</span><br><span class="line">    Reports back to the database server.</span><br><span class="line">  DB server reads from any storage server whose SCL &gt;= highest committed LSN.</span><br><span class="line">    That storage server may need to apply some log records to the data page.</span><br></pre></td></tr></table></figure><p>æ•°æ®åº“å»ºç«‹ä¸€ä¸ªè¯»æ—¶é—´ç‚¹ï¼Œè¡¨ç¤ºè¿™ä¸ªæ—¶å€™è¯»åˆ°ä»€ä¹ˆæ•°æ®æ˜¯å®‰å…¨çš„ï¼Œç„¶ååœ¨å¯¹åº” Segment ä¸‹è¯».</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>notes: Skiplist-based lsm-tree</title>
      <link href="/2020/08/12/notes-Skiplist-based-lsm-tree/"/>
      <url>/2020/08/12/notes-Skiplist-based-lsm-tree/</url>
      
        <content type="html"><![CDATA[<h1 id="The-Skiplist-Based-LSM-Tree"><a href="#The-Skiplist-Based-LSM-Tree" class="headerlink" title="The Skiplist-Based LSM Tree"></a>The Skiplist-Based LSM Tree</h1><p>è¯»è¿™ç¯‡è®ºæ–‡æ˜¯å› ä¸ºåŸå§‹ SkipList é‚£ä¸ª Btree è¯»çš„è„‘é˜”ç–¼ï¼Œæˆ‘åˆä¸æ˜¯å¾ˆäº†è§£ Btreeã€‚è¿™ç¯‡æ–‡ç« åˆå’Œä½¿ç”¨æœ€å¹¿çš„ RocksDB/LevelDB æ¯”è¾ƒæ¥è¿‘ã€‚</p><p>LSM Tree æä¾›äº†å±‚çº§çš„æ•°æ®æ¥æä¾›å†™ä¼˜åŒ–çš„æ•°æ®ç³»ç»Ÿã€‚åŸå§‹çš„è®ºæ–‡ä¸­ï¼Œä½œè€…åœ¨æ¯ä¸ªå±‚æ¬¡ä¸­ä½¿ç”¨çš„éƒ½æ˜¯ç±»ä¼¼ B-Tree çš„ç»“æ„ï¼Œåœ¨ sLSM ä¸­ï¼ŒBuffer ç»“æ„éƒ½æ˜¯ä¸€ç³»åˆ—çš„ Skiplist.</p><p>LSMTree Paper æœ‰ä¸€å¥—å†·çƒ­æ•°æ®è®¡ç®—çš„å¼å­ã€‚æŠŠæ–°æ’å…¥çš„ hot æ•°æ®æ”¾åœ¨å†…å­˜ä¸­ï¼Œå†·çš„ä¸‹å±‚æ•°æ®æ”¾åœ¨ secondary storage ä¸­ï¼Œæ¥è®©å†™è¢«å‡æ‘Šã€‚åŒæ—¶ï¼ŒåŸè®ºæ–‡ä»‹ç»äº† two-component ï¼ˆå³å¯è§†ä½œåªæœ‰å†…å­˜å’Œ diskï¼‰çš„ LSM ä¹‹åï¼Œä¹Ÿä»‹ç»äº† multi-component çš„ LSM Tree, é€šè¿‡å¤šå±‚æ¬¡æ¥å‡æ‘Š Compaction çš„å¼€é”€ã€‚è¿™ä¸ªåœ¨è¿™æœ‰ä¸€äº›ç®€æ´çš„ç­”æ¡ˆï¼š</p><p><a href="https://www.zhihu.com/question/396452321">https://www.zhihu.com/question/396452321</a></p><p>åŒæ—¶ï¼ŒLSM Tree å¯ä»¥ç”¨ Bloom Filterï¼ˆè¿™ä¸ªç”¨çš„åº”è¯¥å¾ˆå¤šï¼‰ã€fence pointerï¼ˆæˆ‘è®°å¾—æ˜¯ FD-Tree é‡Œçš„ï¼Ÿï¼‰</p><blockquote><p>The remainder of this paper will proceed as follows: Section 2 will detail the design of the Skiplist-Based LSM (sLSM), including the in-memory component, the on-disk component, indexing structures, key algorithms, theoretical guarantees, and the range of design knobs; Section 3 will provide extensive experimental results, including parameter tuning and performance analysis; and Section 4 will discuss and conclude.</p></blockquote><p>é˜…è¯»è¿™ç¯‡æ–‡ç« ä¹Ÿæ˜¯å› ä¸ºï¼Œè¿™ä¸ª LSMTree ç›¸å¯¹æ¥è¯´å’Œ LevelDB/RocksDB æœ‰ä¸€å®šç›¸ä¼¼ä¹‹å¤„ã€‚</p><h2 id="SLSM-è®¾è®¡"><a href="#SLSM-è®¾è®¡" class="headerlink" title="SLSM è®¾è®¡"></a>SLSM è®¾è®¡</h2><ul><li>å†…å­˜ä¸­æœ‰ R ä¸ª SkipList, åªæœ‰ä¸€ä¸ªæ˜¯ active çš„ã€‚</li><li>å¦‚æœ Insert å‡ºç°ï¼Œç°æœ‰çš„ SkipList è¾¾åˆ°äº†å¤§å°çš„ä¸Šé™ï¼ˆå¥½å¥‡è¿™ä¸ªä¸Šé™æ˜¯æ€ä¹ˆè®¾ç½®çš„ï¼‰åï¼Œä¼šå°è¯•æŠŠç°åœ¨çš„ SkipList å˜æˆåªè¯»çš„ï¼Œç„¶åå°è¯•åœ¨æ–°çš„ SkipList å†™ã€‚å¦‚æœå†…å­˜æ»¡äº†ï¼š<ul><li>æŒ‰æ¯”ä¾‹æŠŠ m ä¸ªç°æœ‰çš„ SkipList ä¸ Secondary Storage è¿›è¡Œ merge</li></ul></li></ul><p>è¯»å–çš„è¯ä¼šæŒ‰ç…§ SkipList çš„æ–°æ—§è¯»ï¼Œå†è®¿é—®ç£ç›˜ã€‚</p><h4 id="SkipList"><a href="#SkipList" class="headerlink" title="SkipList"></a>SkipList</h4><p>è¿™ç¯‡æ–‡ç« ä»‹ç»äº† SkipList çš„ä¸¤ä¸ªä¼˜åŒ–ï¼š</p><ol><li>Fast Random Levelsï¼šåˆ©ç”¨ random bits ç”Ÿæˆ random Level</li><li>Vertical Arrays, Horizontal Pointers</li></ol><blockquote><p>While the differential densities of the levels precludes an array-based structure in the horizontal direction, it is wasteful to include links from nodes of value k to another node of value k on the next level. Instead, in our implementation a skiplist node includes one key, one value, and an array of pointers to other skiplist nodes. This array can be thought of as a vertical column of level pointers, where pointers above the nodeâ€™s level are null and each pointer below points to the next node on that particular level. In this way, skipping down a level is a matter of reading a value that was already loaded into the cache, rather than chasing a pointer somewhere random in memory. Because we implemented the skiplist in this way from the beginning we do not report differential performance between this cache-conscious and the alternative, naive way.</p></blockquote><p>å…¶å®æ„Ÿè§‰è¯´çš„æ¯”è¾ƒåƒ LevelDB çš„äº†ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">SkipList</span>&lt;Key, Comparator&gt;::Node &#123;</span><br><span class="line">  <span class="function"><span class="keyword">explicit</span> <span class="title">Node</span><span class="params">(<span class="type">const</span> Key&amp; k)</span> : key(k) &#123;</span>&#125;</span><br><span class="line"></span><br><span class="line">  Key <span class="type">const</span> key;</span><br><span class="line"> <span class="keyword">private</span>:</span><br><span class="line">  <span class="comment">// Array of length equal to the node height.  next_[0] is lowest level link.</span></span><br><span class="line">  std::atomic&lt;Node*&gt; next_[<span class="number">1</span>];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="Disk-Based-Storage"><a href="#Disk-Based-Storage" class="headerlink" title="Disk-Based Storage"></a>Disk-Based Storage</h3><blockquote><p>â€œis only touched by merges from the memory bufferâ€</p><p>There are L disk levels, each with D runs on each level. A run is an immutable sequence of sorted key-value pairs, and is captured within one memory-mapped file on disk. </p><p>Each disk run is indexed similarly to the in-memory run, with max/min keys and Bloom filters. </p></blockquote><p>é™¤æ­¤ä¹‹å¤–ä¹‹å¤–è¿™é‡Œè¿˜å¼•å…¥äº† fence pointer, FD-Tree ä¹Ÿæœ‰ fence pointer, è¿™æ˜¯å¸¦å±‚æ¬¡çš„æŸ¥æ‰¾ä¼˜åŒ–ï¼š</p><blockquote><p>These are fixed-width indices that store the key of elements in increments of some logical page size in memory. </p></blockquote><p><img src="https://image.mwish.me/blog-image/An-illustration-of-the-implementation-of-the-Fence-Pointers.jpg" alt="An-illustration-of-the-implementation-of-the-Fence-Pointers"></p><h3 id="Merging"><a href="#Merging" class="headerlink" title="Merging"></a>Merging</h3><p>LSMTree çš„ Merge è¿˜æ˜¯å¾ˆå¤æ‚çš„ï¼š</p><ul><li>merge æ˜¯æŠŠæŸä¸€å±‚æŒ‰æ¯”ä¾‹ m å’Œä¸‹å±‚åˆå¹¶ï¼Œç”¨å†™æ¥å‡å°è¯»æ”¾å¤§</li><li><code>the number of elements at level k is O((mD)^k).</code></li><li>å¯èƒ½ä¼šæœ‰ cascading çš„ merge</li></ul><blockquote><p>We propose a heap-based merging algorithm that runs in O(n log(mD)) time and O(mD) space, where n is the number of elements being merged.</p></blockquote><p><img src="https://image.mwish.me/blog-image/4104B498-0C10-4479-A53E-A1A55A0B0181.png" alt="4104B498-0C10-4479-A53E-A1A55A0B0181"></p><p>å…·ä½“æ¥è¯´ï¼Œæ¯ä¸ª list éƒ½æ˜¯ sorted çš„ï¼ŒLSMTree ä¼šå¯¹å®ƒä»¬ heap sort .</p><p>å®ç°çš„æ—¶å€™ï¼Œè¿™é‡Œé‡‡å–äº†å¤šçº¿ç¨‹çš„æ–¹å¼ï¼š</p><blockquote><p>In our implementation, we also use multithreaded merging to decrease our latency. When an insertion triggers a merge, a dedicated merge thread takes ownership of the runs to merge and executes the merge in parallel, allowing the main thread to rebuild the buffer and continue to answer queries. If a lookup request comes while the merge thread is executing the merge, the main thread searches the memory buffer for the requested key, and if unsuccessful, waits for the merge to complete before querying the disk levels.</p></blockquote><p>ä¸‹é¢æ˜¯ param table å’Œè¯»çš„æ€§èƒ½åˆ†æï¼š</p><p><img src="https://image.mwish.me/blog-image/07BA999F-C722-4C4B-B91F-174E677E4D0C.png" alt="07BA999F-C722-4C4B-B91F-174E677E4D0C"></p><p><img src="https://image.mwish.me/blog-image/3D826C1F-830A-4255-B7D2-F32294459FD4.png" alt="3D826C1F-830A-4255-B7D2-F32294459FD4"></p><h3 id="Range"><a href="#Range" class="headerlink" title="Range"></a>Range</h3><p>Range æ˜¯ä¸€ä¸ªæ¯”è¾ƒå¤æ‚ä½†æ˜¯å¾ˆéœ€è¦çš„æ“ä½œï¼Œæˆ‘ä»¬å¯èƒ½ä¼šï¼š</p><ul><li>æ‹¿åˆ° Snapshot æˆ–è€…è¿­ä»£å™¨ï¼Œç„¶ååœ¨è¿™ä¸Šé¢ iter</li></ul><p>è¿™ç§æ“ä½œå’Œ PointGet ä¸ä¸€æ ·ï¼Œæ˜¯éœ€è¦çŸ¥é“æ‰€æœ‰çš„ table æƒ…æ™¯ç„¶åæŸ¥è¯¢çš„ã€‚</p><p>è¿™é‡Œæ“ä½œæ˜¯ï¼šé¦–å…ˆæŒ‰rangeå’Œå€¼è¿‡æ»¤ï¼Œç„¶åä»æ–°åˆ°æ—§éå†ï¼Œå¹¶æ„å»ºä¸€ä¸ª hashtable æ¥ O(1) çš„å»é‡ã€‚</p><blockquote><p>Because collecting elements in the range in both skiplists and disk runs is a linear-time operation, and because hashing is an amortized constant-time operation, a range query over n keys is expected to take O(n) time.</p></blockquote><p>è¿™ä¸ª <code>O(n)</code> æ˜¯ n keys, æˆ‘ä¸å¤ªæ¸…æ¥šè¿™ä¸ªæ”¾å¤§æ˜¯ä»€ä¹ˆæƒ…å†µï¼Œæ€»è§‰å¾—ä¸å¤ªæ¸…æ¥š</p><h2 id="Perf"><a href="#Perf" class="headerlink" title="Perf"></a>Perf</h2><blockquote><p>We tested the sLSM on a DigitalOcean Droplet Server running 64-bit Ubuntu 4.4.0 with 32 Intel Xeon E5-2650L v3 @ 1.80GHz CPUs, a 500 GB SSD, 224GB main memory, and 30MB L3 cache.</p></blockquote><p>(æˆ‘ä¹Ÿæƒ³æœ‰è¿™ä¹ˆå¥½çš„æœºå™¨)</p><p>å†æ¬¡è´´ä¸€ä¸‹å‚æ•°è¡¨ï¼š</p><p><img src="https://image.mwish.me/blog-image/07BA999F-C722-4C4B-B91F-174E677E4D0C.png" alt="07BA999F-C722-4C4B-B91F-174E677E4D0C"></p><h4 id="R"><a href="#R" class="headerlink" title="R"></a>R</h4><blockquote><p>In determining the optimal R, we found that the smaller R is, the smaller the memory buffer is, and the more frequent merges will be. Thus, lower R leads to lower insertion throughput. However, with few runs to search, lookups are very quick with small R. Analogously, higher R is linked to faster insertion but slower lookup, since more runs need to be searched. With Bloom filters, it is possible to set R high enough to achieve extremely fast insertion while enjoying significant speedup on lookups due to the filters. More formally, R does not enter the amortized insertion time function, and there are significant constant factors hidden in that equation that correspond to the speed and frequency of merges. However, lookups depend linearly upon R, as proven above. The graph in Fig. 2 details the tradeoff between insertion time and lookup time for a number of values of R. As such, setting the number of runs intelligently also allows us to tune the performance of the sLSM to the workload at hand- more runs for more writes, and fewer for more lookups.</p></blockquote><p>å‘åŸæ–‡æ€»è§‰å¾—æ²¡ä»€ä¹ˆè¯šæ„ï¼Œä½†æ˜¯è¿™ä¸€æ®µè¯´çš„æ¯”æˆ‘èƒ½ä»‹ç»çš„ç²¾ç»†å¤šäº†ã€‚</p><p><img src="https://image.mwish.me/blog-image/69D6C0BB-39D4-4E80-B21F-6C9E6A6E1BCA.png" alt="69D6C0BB-39D4-4E80-B21F-6C9E6A6E1BCA"></p><ul><li>R å˜å¤§ï¼Œå†™å…¥å— Compaction çš„å½±å“å’Œ Stall å˜å°</li><li>è¯»å–æ•ˆç‡å˜ä½ï¼Œå› ä¸ºè¦åœ¨å†…å­˜ä¸­å¯»æ‰¾å¤šä¸ª skiplist</li></ul><p>è¯»å–æ•ˆç‡å˜ä½æˆ‘çœŸçš„æ²¡å¤ªç†è§£ï¼Œæ„Ÿè§‰èµ°åˆ° disk ä¸Šè‚¯å®šä¼šæ›´æ…¢ï¼Œä½†æ˜¯ R*Rn å€¼å›ºå®šçš„æ—¶å€™ï¼Œæ„Ÿè§‰ä¸Šé¢çš„å°±å¯ä»¥ç†è§£äº†ï¼Œè€Œä¸”è¿™ä¸¤ä¸ªå‚æ•°ä¹Ÿä¼šå½±å“ flush çš„æ•ˆç‡ã€‚</p><h4 id="Rn"><a href="#Rn" class="headerlink" title="Rn"></a>Rn</h4><blockquote><p>For each value of R, increasing Rn increases insertion rate while decreasing lookup throughput. This is because a larger Rn allows for fewer merges over the lifetime of the workload due to the larger memory buffer. However, this increase in the size of each run increases the runtime of each lookup, since skiplist queries are logarithmic in their size. </p></blockquote><p>è¿™ä¸ªåº”è¯¥ç›¸å¯¹æ›´å¥½ç†è§£ä¸€äº›ã€‚</p><p><img src="https://image.mwish.me/blog-image/B441272A-7A46-4382-9AEB-CAD3BC6CAA53.png" alt="B441272A-7A46-4382-9AEB-CAD3BC6CAA53"></p><p>ä¹Ÿå¯ä»¥å‚è€ƒ RocksDB çš„ Flushing Options</p><p><a href="https://github.com/facebook/rocksdb/wiki/RocksDB-Tuning-Guide#flushing-options">https://github.com/facebook/rocksdb/wiki/RocksDB-Tuning-Guide#flushing-options</a></p><h4 id="Disk-and-Merge-Parameters"><a href="#Disk-and-Merge-Parameters" class="headerlink" title="Disk and Merge Parameters"></a>Disk and Merge Parameters</h4><p>ä¹Ÿå¯ä»¥å‚è€ƒ <a href="https://github.com/facebook/rocksdb/wiki/RocksDB-Tuning-Guide#level-style-compaction">https://github.com/facebook/rocksdb/wiki/RocksDB-Tuning-Guide#level-style-compaction</a></p><ol><li>m is set under 0.5, merges would happen too frequently for sizeable datasets, causing the OS to run out of file descriptors</li></ol><p><img src="https://image.mwish.me/blog-image/2FF5FFBA-4142-44FF-B842-570DC70ABA69.png" alt="2FF5FFBA-4142-44FF-B842-570DC70ABA69"></p><p>D å˜å¤§æ—¶ï¼Œå†™å…¥æ€§èƒ½æ˜¯æå‡çš„ï¼Œä½†æ˜¯è¯»ä¼šè¢«æ”¾å¤§ã€‚m å˜å¤§æ—¶ï¼Œcompaction å˜å¾—ä¸é‚£ä¹ˆé¢‘ç¹ã€‚</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>notes on craq</title>
      <link href="/2020/08/06/notes-on-craq/"/>
      <url>/2020/08/06/notes-on-craq/</url>
      
        <content type="html"><![CDATA[<h1 id="Notes-on-CRAQ"><a href="#Notes-on-CRAQ" class="headerlink" title="Notes on CRAQ"></a>Notes on CRAQ</h1><p><img src="https://image.mwish.me/blog-image/51CB14FC-1504-474F-BA8D-74D2CBFCC14D.png" alt="51CB14FC-1504-474F-BA8D-74D2CBFCC14D"></p><p>è¿™ç¯‡æ–‡ç« ä»‹ç»äº† CRAQï¼Œé“¾å¼å¤åˆ¶çš„æ”¹è¿›ã€‚</p><p>æœ¬äººä¸»è¦é˜…è¯»äº† 1-3 ç« ï¼Œç¬¬ä¸‰ç« çš„ scaling å’Œ 5.3 çš„ membership changes æ²¡æœ‰å®Œå…¨ç†è§£å®ƒçš„æ€è·¯ï¼Œ4.1 çš„ mini-transaction æ²¡æœ‰è¯»çš„å¾ˆç»†ï¼Œä»¥åå¯èƒ½ä¼šå›å¤´æ¥æ”¹ã€‚</p><p>ä¹Ÿæ¬¢è¿æ‡‚çš„æœ‹å‹ç•™è¨€æˆ–è€…ç»™ anmmscs_maple@qq.com é‚®ä»¶ã€‚</p><h3 id="Recall"><a href="#Recall" class="headerlink" title="Recall"></a>Recall</h3><h4 id="GFS"><a href="#GFS" class="headerlink" title="GFS"></a>GFS</h4><p>GFS åˆ†ä¸º Master å’Œ Chunk Server, Master æœ‰ Chunk çš„ metadataï¼Œè´Ÿè´£æ–‡ä»¶æ˜ å°„çš„ä¿¡æ¯ã€Chunkä¿¡æ¯ï¼Œä¹Ÿè´Ÿè´£ç®¡ç† leaseã€å›æ”¶ Chunkã€Chunk è¿ç§»ã€‚Master èŠ‚ç‚¹ä½¿ç”¨å¿ƒè·³ä¿¡æ¯å‘¨æœŸåœ°å’Œæ¯ä¸ª Chunk æœåŠ¡å™¨é€šè®¯ï¼Œå‘é€æŒ‡ä»¤åˆ°å„ä¸ª Chunk æœåŠ¡å™¨å¹¶æ¥æ”¶ Chunk æœåŠ¡å™¨çš„çŠ¶æ€ä¿¡æ¯ã€‚</p><p>ChunkServer ç»´æŠ¤è‡ªå·±çš„é€»è¾‘ï¼Œè¿è¡Œåœ¨ Linux File System ä¸Šã€‚Chunk ç±»ä¼¼ç³»ç»Ÿçš„ block è¿™ç§æ¦‚å¿µï¼Œé»˜è®¤ 64MBã€‚å®ƒçš„å¤§å°ä¼šå½±å“å†…éƒ¨ç¢ç‰‡å’Œé€šä¿¡æ•ˆç‡/ç©ºé—´æ•ˆç‡ï¼šChunk è¶Šå¤§ï¼Œå†…éƒ¨ç¢ç‰‡è‚¯å®šè¶Šå°ï¼Œä½†æ˜¯ metadata ç©ºé—´æ•ˆç‡ä¹Ÿä¼šå˜å¤§ï¼Œè¯·æ±‚æ¬¡æ•°ä¹Ÿä¼šå˜æ›´ã€‚ä¸è¿‡è¿™æ ·ä¹Ÿä¸åˆ©äºå­˜å‚¨å°æ–‡ä»¶ã€‚</p><p>ChunkServer ä¼šæœ‰å¤‡ä»½çš„æ¨¡å‹ã€‚å½“å†™å…¥çš„æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦ä¿è¯å¤šä¸ª replica å†™å…¥é¡ºåºä¸Šæ˜¯ä¸€è‡´çš„ã€‚Master ä¼šç»™ Chunk åˆ†é… leaseï¼Œè¿™ä¸ª chunk ä¼šç»™å‡ºå†™å…¥çš„æ“ä½œåºåˆ—ï¼Œè¢«ç§°ä¸º primary chunkã€‚</p><p><img src="https://image.mwish.me/blog-image/23269A8F-9449-4BA0-869A-66AD962A75E8.png" alt="23269A8F-9449-4BA0-869A-66AD962A75E8"></p><p>GFS çš„æ•°æ®æµå’Œæ§åˆ¶æµæ˜¯åˆ†å¼€çš„ï¼Œå†™å…¥çš„æ—¶å€™ï¼Œclient ä¼šæ‹¿åˆ°æŸä¸ª chunk çš„å…ƒæ•°æ®å¹¶åšç¼“å­˜ï¼Œç„¶åæƒ³ä¸Šå›¾3ä¸€æ ·ï¼š</p><blockquote><p>æ•°æ®æ²¿ç€ä¸€ä¸ª Chunk æœåŠ¡å™¨é“¾é¡ºåºçš„æ¨é€ï¼Œè€Œä¸æ˜¯ä»¥å…¶å®ƒæ‹“æ‰‘å½¢å¼åˆ†æ•£ æ¨é€(ä¾‹å¦‚ï¼Œæ ‘å‹æ‹“æ‰‘ç»“æ„)ã€‚çº¿æ€§æ¨é€æ¨¡å¼ä¸‹ï¼Œæ¯å°æœºå™¨æ‰€æœ‰çš„å‡ºå£å¸¦å®½éƒ½ç”¨äºä»¥æœ€å¿«çš„é€Ÿåº¦ä¼ è¾“æ•°æ®ï¼Œè€Œ ä¸æ˜¯åœ¨å¤šä¸ªæ¥å—è€…ä¹‹é—´åˆ†é…å¸¦å®½ã€‚</p><p>ä¸ºäº†å°½å¯èƒ½çš„é¿å…å‡ºç°ç½‘ç»œç“¶é¢ˆå’Œé«˜å»¶è¿Ÿçš„é“¾æ¥(egï¼Œinter-switch æœ€æœ‰å¯èƒ½å‡ºç°ç±»ä¼¼é—®é¢˜)ï¼Œæ¯å°æœºå™¨ éƒ½å°½é‡çš„åœ¨ç½‘ç»œæ‹“æ‰‘ä¸­é€‰æ‹©ä¸€å°è¿˜æ²¡æœ‰æ¥æ”¶åˆ°æ•°æ®çš„ã€ç¦»è‡ªå·±æœ€è¿‘çš„æœºå™¨ä½œä¸ºç›®æ ‡æ¨é€æ•°æ®ã€‚å‡è®¾å®¢æˆ·æœºæŠŠ æ•°æ®ä» Chunk æœåŠ¡å™¨ S1 æ¨é€åˆ° S4ã€‚å®ƒæŠŠæ•°æ®æ¨é€åˆ°æœ€è¿‘çš„ Chunk æœåŠ¡å™¨ S1ã€‚S1 æŠŠæ•°æ®æ¨é€åˆ° S2ï¼Œå› ä¸º S2 å’Œ S4 ä¸­æœ€æ¥è¿‘çš„æœºå™¨æ˜¯ S2ã€‚åŒæ ·çš„ï¼ŒS2 æŠŠæ•°æ®ä¼ é€’ç»™ S3 å’Œ S4 ä¹‹é—´æ›´è¿‘çš„æœºå™¨ï¼Œä¾æ¬¡ç±»æ¨æ¨é€ä¸‹å»ã€‚æˆ‘ä»¬ çš„ç½‘ç»œæ‹“æ‰‘éå¸¸ç®€å•ï¼Œé€šè¿‡ IP åœ°å€å°±å¯ä»¥è®¡ç®—å‡ºèŠ‚ç‚¹çš„â€œè·ç¦»â€ã€‚</p></blockquote><p>æŸç§æ„ä¹‰ä¸Šï¼Œè¿™ä¹Ÿæ˜¯ä¸€ç§é“¾å¼å¤åˆ¶ã€‚</p><h2 id="CRAQ"><a href="#CRAQ" class="headerlink" title="CRAQ"></a>CRAQ</h2><h3 id="ä¸ºä»€ä¹ˆè¦-CRAQ"><a href="#ä¸ºä»€ä¹ˆè¦-CRAQ" class="headerlink" title="ä¸ºä»€ä¹ˆè¦ CRAQ"></a>ä¸ºä»€ä¹ˆè¦ CRAQ</h3><p>è¿™ç¯‡è®ºæ–‡ä»‹ç»çš„å°±æ˜¯ä¸€ç§é“¾å¼å¤åˆ¶å’Œä¼˜åŒ–ï¼Œè®ºæ–‡ä»‹ç»äº† CRAQ å’Œæ™®é€šé“¾å¼å¤åˆ¶çš„åŒºåˆ«ï¼Œä»¥åŠå®ƒæ˜¯å¦‚ä½•åœ¨ä¿è¯æ€§èƒ½çš„æƒ…å†µä¸‹æä¾›å¼ºä¸€è‡´æ€§å’Œåˆ«çš„looseä¸€ç‚¹çš„ä¸€è‡´æ€§çš„çš„ã€‚</p><p>æ–‡ç« è¿˜ä»‹ç»äº† geo-replication ç›¸å…³çš„å®ç°ã€‚</p><blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Influential: CRAQ and many others build on CR.</span><br><span class="line">    Ceph, Parameter Server, COPS, FAWN.</span><br></pre></td></tr></table></figure></blockquote><p>ä¸Šé¢è¿™äº›éƒ½ç”¨äº† chain replication(å“‡æˆ‘ä»¥å‰éƒ½ä¸çŸ¥é“)ï¼Œå®ƒçš„å¤§è‡´æ€è·¯å¦‚ä¸‹ï¼š</p><ul><li>A-&gt;B-&gt;C-&gt;D æ„æˆä¸€æ¡é“¾ï¼Œ</li><li>client åœ¨å¤´å†™ï¼Œåœ¨å°¾è¯»ï¼ŒAè½ç›˜åå†™ Bï¼ŒB è½ç›˜åå†™ Cï¼ŒDä¸­è½ç›˜å³å¯è¯»</li><li>è¿™ç§æ–¹å¼æ¯”è¾ƒå¥½ pipeline åŒ–</li><li>èŠ‚ç‚¹å˜å¤šçš„æ—¶å€™ï¼Œå¯èƒ½éœ€è¦ Consistet Hashing æ¥ shardingã€‚</li></ul><p>ä¸Šé¢çš„ç¼ºç‚¹æ˜¯ï¼š</p><ul><li>è¯»åœ¨å°¾éƒ¨ï¼Œå¾ˆå®¹æ˜“æˆä¸ºæ½œåœ¨çš„ç“¶é¢ˆ</li><li>å•ä¸ªèŠ‚ç‚¹ failure å¯èƒ½ä¼šå½±å“ç³»ç»Ÿ</li><li>Consistet Hashing ä»ç„¶æœ‰æ½œåœ¨çš„çƒ­ç‚¹é—®é¢˜ï¼ˆè¿™ä¸ªæˆ‘æ²¡ç ”ç©¶è¿‡ï¼‰ï¼Œè¯»è¯·æ±‚ä¼šå…¨éƒ¨è½åœ¨çƒ­ç‚¹çš„å°¾éƒ¨ã€‚</li></ul><p>MIT 6.824 çš„ course notes æŒ‡å‡ºäº† CR çš„ä¼˜ç‚¹</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Why is CR attractive (vs Raft)?</span><br><span class="line">  Client RPCs split between head and tail, vs Raft&#x27;s leader handles both.</span><br><span class="line">  Head sends each write just once, vs Raft&#x27;s leader sends to all.</span><br><span class="line">  Reads involve just one server, not all as in Raft.</span><br><span class="line">  Situation after failure simpler than in Raft (remember Figure 7).</span><br></pre></td></tr></table></figure><p>è€Œå¯¹è±¡å­˜å‚¨ç‰¹ç‚¹æ˜¯ï¼Œä¸éœ€è¦æ‰€æœ‰æ“ä½œçš„ total orderï¼Œéœ€è¦çš„æ˜¯å•ä¸ªå¯¹è±¡çš„orderã€‚</p><p>CRAQ æä¾›ï¼š</p><ul><li>CR ä¸€æ ·çš„å¼ºä¸€è‡´æ€§</li><li>CRAQçš„è®¾è®¡è‡ªç„¶æ”¯æŒè¯»æ“ä½œä¹‹é—´çš„æœ€ç»ˆä¸€è‡´æ€§ï¼Œä»¥é™ä½å†™äº‰ç”¨æœŸé—´çš„å»¶è¿Ÿè¯»å–ï¼Œä»¥åŠåœ¨ä¸´æ—¶åˆ†åŒºæœŸé—´é™çº§ä¸ºåªè¯»è¡Œä¸ºã€‚CRAQå…è®¸åº”ç”¨ç¨‹åºæŒ‡å®šè¯»å–æ“ä½œå¯æ¥å—çš„æœ€å¤§ stale å¯èƒ½æ€§ã€‚ï¼ˆè®ºæ–‡é‡Œæ˜¯ <em>Apportioned Queries</em>ï¼‰</li><li>åœ¨è¯»åˆ†æ‘Šçš„ load-balance ä¹‹å¤–ï¼Œæä¾›äº† geo-replication çš„æ–¹æ¡ˆï¼Œè¯»å¯ä»¥ä»æœ¬åœ°çš„é›†ç¾¤è¯»ï¼ŒåŒæ—¶å€ŸåŠ© ZooKeeper ç»´æŠ¤ membersã€‚</li></ul><h3 id="CR-çš„ä¸€è‡´æ€§è®¨è®º"><a href="#CR-çš„ä¸€è‡´æ€§è®¨è®º" class="headerlink" title="CR çš„ä¸€è‡´æ€§è®¨è®º"></a>CR çš„ä¸€è‡´æ€§è®¨è®º</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Intuition for linearizability of CR?</span><br><span class="line">  When no failures, almost as if the tail were the only server.</span><br><span class="line">    Head picks an order for writes, replicas apply in that order,</span><br><span class="line">      so they will stay in sync except for recent (uncommitted) writes.</span><br><span class="line">    Tail exposes only committed writes to readers.</span><br><span class="line">  Failure recovery, briefly.</span><br><span class="line">    Good news: every replica knows of every committed write.</span><br><span class="line">    But need to push partial writes down the chain.</span><br><span class="line">    If head fails, successor takes over as head, no commited writes lost.</span><br><span class="line">    If tail fails, predecessor takes over as tail, no writes lost.</span><br><span class="line">    If intermediate fails, drop from chain, predecessor may need to</span><br><span class="line">      re-send recent writes.</span><br></pre></td></tr></table></figure><ul><li>æ²¡æœ‰ failure çš„æ—¶å€™ï¼Œæ˜¾ç„¶æ˜¯ Linearizable çš„ï¼Œæ¯•ç«Ÿæ˜¯å•ç‚¹ apply</li><li>failure çš„æ—¶å€™ï¼Œå› ä¸º apply çš„é¡ºåºæ˜¯ä¸€è‡´çš„ï¼Œæ‰€ä»¥æ²¡å…³ç³»ã€‚</li></ul><p>ï¼ˆä¸è¿‡æˆ‘æ„Ÿè§‰è¿™è®ºæ–‡ä¸»è¦é‡ç‚¹è¿˜æ˜¯å•å¯¹è±¡çš„ä¸€è‡´ï¼‰</p><h3 id="CRAQ-1"><a href="#CRAQ-1" class="headerlink" title="CRAQ"></a>CRAQ</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">The CRAQ paper admits there is at least one other way to skin this cat:</span><br><span class="line">  Split objects over many chains, each server participates in multiple chains.</span><br><span class="line">  C1: S1 S2 S3</span><br><span class="line">  C2: S2 S3 S1</span><br><span class="line">  C3: S3 S1 S2</span><br><span class="line">This works if load is more or less evenly divided among chains.</span><br></pre></td></tr></table></figure><p>åœ¨ CRAQ ä¸­ï¼š</p><ul><li>æ¯ä¸ª node å¯ä»¥å­˜å‚¨å¤šä¸ªç‰ˆæœ¬çš„å¯¹è±¡ï¼Œç‰ˆæœ¬å¯ä»¥æ˜¯ <em>clean</em> æˆ–è€… <em>dirty</em> çš„ã€‚</li><li>å½“ node æ¥æ”¶åˆ°å†™å…¥çš„æ—¶å€™ï¼š<ul><li>å¦‚æœæ˜¯ tail, é‚£ä¹ˆæ¥å—å†™å…¥ï¼Œå¹¶ ACK é€šçŸ¥ä¹‹å‰çš„èŠ‚ç‚¹ï¼Œå†™å…¥æˆåŠŸ</li><li>å¦åˆ™æŠŠ <code>(key, value)</code> æ·»åŠ åˆ°ç‰ˆæœ¬é“¾ä¸­ï¼Œæ ‡è®°ä¸º dirty.</li></ul></li><li>å½“é tail çš„èŠ‚ç‚¹æ”¶åˆ° ACK çš„æ—¶å€™ï¼ŒæŠŠå¯¹åº”ç‰ˆæœ¬ dirty æ ‡è®°ä¸º cleanï¼Œç„¶ååˆ é™¤ä¹‹å‰çš„ç‰ˆæœ¬</li></ul><p>é‚£ä¹ˆï¼Œå½“ä¸€ä¸ªèŠ‚ç‚¹æ”¶åˆ°è¯»è¯·æ±‚çš„æ—¶å€™ï¼Œå¦‚æœä¸è¦æ±‚ä¸€è‡´æ€§ï¼Œå¯ä»¥è¿”å›æœ€æ–°çš„ç‰ˆæœ¬ï¼Œå¦åˆ™ï¼š</p><ul><li>å¦‚æœæŸ¥è¯¢çš„å¯¹è±¡æ˜¯ clean çš„ï¼Œè¿”å›ï¼ˆæ„å‘³ç€å†™å…¥ tail å®Œæˆï¼Œå‰é¢å³ä½¿æœ‰äº›è¿™ä¸ª key, ä¹Ÿæ˜¯ dirty çš„ï¼‰</li><li>å¦åˆ™ï¼Œå‘ tail è¿›è¡Œä¸€ä¸ª version query</li></ul><p><img src="https://image.mwish.me/blog-image/F50E8A60-D378-4A03-84C6-A5954F0E1EB1.png" alt="F50E8A60-D378-4A03-84C6-A5954F0E1EB1"></p><p>è®ºæ–‡è®¤ä¸ºï¼Œåœ¨ä¸¤ç§æƒ…å†µä¸‹ï¼Œæ€§èƒ½æ˜¯æœ‰æå‡çš„</p><ul><li>Read-mostly workloads: è¯»å¤šçš„æƒ…å†µä¸‹ï¼Œè¯»ä¼šè¢«å‡æ‘Š</li><li>Write-heavily workloads: å¯¹ tail æŸ¥è¯¢ç‰ˆæœ¬æ¯”å…¨éƒ¨è½åœ¨ tail è½»é‡ï¼Œè¿™æ„å‘³ç€è¯»è¯·æ±‚ä¾ç„¶æ˜¯å‡æ‘Šçš„ã€‚</li></ul><p>è¿™æ ·çš„æƒ…å†µä¸‹ï¼Œè®¤ä¸ºä»»ç„¶æ˜¯ Linearizable çš„ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Intuition for why same as CR (i.e. linearizable) (assuming no failure):</span><br><span class="line">  If replica has only clean, it MUST match tail, since no write has passed it.</span><br><span class="line">  If replica has dirty, it asks tail, in which case it matches tail as well.</span><br></pre></td></tr></table></figure><p>ä¸è¿‡ï¼Œåœ¨ä»¥ä¸Šçš„æƒ…å†µä¹‹å¤–ï¼Œ CRAQ ä»ç„¶æä¾›åˆ«çš„ä¸€è‡´æ€§ï¼š</p><ul><li>Eventual Consistencyï¼šå…è®¸è¯»æœ€æ–°çš„ seesion ç‰ˆæœ¬ï¼ŒåŒæ—¶ï¼Œå¦‚æœè¯»ä¸å®èŠ‚ç‚¹ï¼Œé‚£ä¹ˆç³»ç»Ÿæœ‰å•è°ƒè¯»ä¸€è‡´æ€§</li><li>Eventual Consistency with Maximum-Bounded Inconsistency: å…è®¸è¿”å›</li></ul><h3 id="recovery-amp-membership-changes"><a href="#recovery-amp-membership-changes" class="headerlink" title="recovery &amp; membership changes"></a>recovery &amp; membership changes</h3><p>ä¸»è¦åœ¨è®ºæ–‡ç¬¬äº”èŠ‚</p><blockquote><p>When a head fails, its immediate successor takes over as the new chain head; likewise, the tailâ€™s predecessor takes over when the tail fails. Nodes joining or failing from within the middle of the chain must insert themselves between two nodes, much like a doubly-linked list. The proofs of correct- ness for dealing with system failures are similar to CR; we avoid them here due to space limitations. Section Â§5 describes the details of failure recovery in CRAQ, as well as the integration of our coordination service. In particular, CRAQâ€™s choice of allowing a node to join anywhere in a chain (as opposed only to at its tail [47]), as well as properly handling failures during recovery, requires some careful consideration.</p></blockquote><p>ç„¶åç³»ç»Ÿæœ‰ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Equivalently, why can&#x27;t 2nd node take over as head if it can&#x27;t reach the head?</span><br><span class="line">  Partition -- split brain -- the 2nd node must wait patiently.</span><br></pre></td></tr></table></figure><h3 id="Scale"><a href="#Scale" class="headerlink" title="Scale"></a>Scale</h3><blockquote><ul><li>Most or all writes to an object might originate in a single datacenter.</li><li>Some objects may be only relevant to a subset of datacenters.</li><li>Popular objects might need to be heavily replicated while unpopular ones can be scarce.</li></ul></blockquote><p>å¯¹è±¡æ ‡è¯†ç¬¦ç”±é“¾æ ‡è¯†ç¬¦å’Œå¯†é’¥æ ‡è¯†ç¬¦ç»„æˆã€‚é“¾æ ‡è¯†ç¬¦ç¡®å®š CRAQ ä¸­çš„å“ªäº›èŠ‚ç‚¹å°†å­˜å‚¨è¯¥é“¾ä¸­çš„æ‰€æœ‰ keysï¼Œè€Œå¯†é’¥æ ‡è¯†ç¬¦ä¸ºæ¯ä¸ªé“¾æä¾›å”¯ä¸€çš„å‘½åã€‚è®ºæ–‡æè¿°äº†å¤šç§æŒ‡å®šåº”ç”¨ç¨‹åºéœ€æ±‚çš„æ–¹æ³•ï¼š</p><ol><li><code>&#123;num_datacenters, chain_size&#125;</code>  åˆ†å¸ƒåœ¨æ•´ä¸ªæ•°æ®ä¸­å¿ƒï¼Œç”¨ consistency hashing æ˜ å°„. å›ºå®šçš„æ•°æ®ä¸­å¿ƒå­˜å‚¨å›ºå®šçš„ chainã€‚</li><li><code>&#123;chain_size, dc1, dc2, ..., dcN&#125;</code> æ¯ä¸ªæ•°æ®ä¸­å¿ƒä½¿ç”¨åŒæ ·çš„ chain-sizeï¼Œdc1, dc2 é‡Œé¢ chain çš„å¤§å°éƒ½æ˜¯ <code>chain_size</code>, ç”± consistency hashing å†³å®š dc å†…éƒ¨çš„èŠ‚ç‚¹ã€‚</li><li><code>&#123;*dc*1, *chain*_*size*1, ..., *dc**N*, *chain*_*size**N*&#125;</code> åœ¨æ¯ä¸ªä¸­å¿ƒå†…ï¼Œchain-size æ˜¯æä¾›å¥½çš„ã€‚</li></ol><p>2 3 ä¸­ï¼Œdc1 éƒ½å¯ä»¥æˆä¸º master é›†åˆï¼Œè¿™æ„å‘³ç€å³ä½¿æœ‰é›†ç¾¤å¤´èŠ‚ç‚¹å˜æ¢ï¼Œå†™å…¥ä¹Ÿè¦è½åˆ°è¿™ä¸ªæ•°æ®ä¸­å¿ƒã€‚</p><blockquote><p>Otherwise, if <em>dc</em>1 is disconnected from the rest of the chain, <em>dc</em>2 could become the new head and take over write operations un- til <em>dc</em>1 comes back online. When a master is not defined, writes will only continue in a partition if the partition con- tains a majority of the nodes in the global chain. Otherwise, the partition will become read-only for maximum- bounded inconsistent read operations, as defined in Section 2.4.</p></blockquote><p>åœ¨å•ä¸ªæ•°æ®ä¸­å¿ƒä¸­ï¼Œsharding å¯ä»¥é ä»»æ„çš„ consistency hashing, ä¹Ÿå¯ä»¥å¼•å…¥ naming service. å¤šä¸ªæ•°æ®ä¸­å¿ƒä¸­ï¼Œè¯»å†™ä»£ä»·ä¼šæ”¾å¤§ï¼š</p><blockquote><p>Even with an optimized chain, the latency of write operations over wide-area links will increase as more datacenters are added to the chain. Although this in- creased latency could be significant in comparison to a primary/backup approach which disseminates writes in parallel, it allows writes to be pipelined down the chain. This vastly improves write throughput over the primary/backup approach.</p></blockquote><p>åŒæ—¶ï¼Œå¦‚æœåœ¨å¤šé›†ç¾¤ä¸­å¼•å…¥ ZooKeeper è¿™æ ·çš„åè°ƒç³»ç»Ÿï¼Œå¯ä»¥ï¼š</p><ul><li>å¼•å…¥æŸç§å±‚æ¬¡çš„ zk çš„åè°ƒ</li></ul><blockquote><p>Placing multiple ZooKeeper nodes within a single datacenter improves Zookeeper read scalability within that datacenter, but at the cost of wide-area performance. Since the vanilla implementa- tion has no knowledge of datacenter topology or notion of hierarchy, coordination messages between Zookeeper nodes are transmitted over the wide-area network mul- tiple times. Still, our current implementation ensures that CRAQ nodes always receive notifications from <em>local</em> Zookeeper nodes, and they are further notified only about chains and node lists that are relevant to them. We expand on our coordination through Zookeper in Â§5.1.</p><p>To remove the redundancy of cross-datacenter ZooKeeper traffic, one could build a hierarchy of Zookeeper instances: Each datacenter could contain its own local ZooKeeper instance (of multiple nodes), as well as having a representative that participates in the global ZooKeeper instance (perhaps selected through leader election among the local instance). Separate functionality could then coordinate the sharing of data between the two. An alternative design would be to modify ZooKeeper itself to make nodes aware of network topology, as CRAQ currently is. We have yet to fully investigate either approach and leave this to future work.</p></blockquote><p>æ„Ÿè§‰è¿˜æ˜¯å¾ˆéº»çƒ¦çš„ã€‚</p><h3 id="4-Extensions"><a href="#4-Extensions" class="headerlink" title="4. Extensions"></a>4. Extensions</h3><h4 id="4-1-Mini-Transactions"><a href="#4-1-Mini-Transactions" class="headerlink" title="4.1 Mini Transactions"></a>4.1 Mini Transactions</h4><p>CRAQ æ”¯æŒä¸‹é¢çš„ mini-txn</p><blockquote><ol><li>Prepend/Append: Adds data to the beginning or end of an objectâ€™s current value.</li><li>Increment/Decrement: Adds or subtracts to a keyâ€™s object, interpreted as an integer value.</li><li>Test-and-Set: Only update a keyâ€™s object if its current version number equals the version number spec- ified in the operation.</li></ol></blockquote><p>å¦‚æœæ˜¯ç¬¬ä¸€ç±»å’Œç¬¬äºŒç±»ï¼Œå¯ä»¥ç›´æ¥æ·»åŠ åˆ°å¤´/å°¾ç„¶åä¼ æ’­æ–°ç‰ˆæœ¬ã€‚å†™å…¥æ¯”è¾ƒå¤šçš„è¯å¯ä»¥ batchã€‚</p><p>å¦‚æœæ˜¯ test-and-set, å¦‚æœæœ¬èº«æœ‰ dirty ç‰ˆæœ¬æˆ–è€…æœªå®Œæˆçš„ cache å†™å°±æ‹’ç»ï¼Œå¦åˆ™ä¼ æ’­ã€‚</p><p>ä¸‹é¢æ¥è€ƒè™‘å…·ä½“çš„å®ç°(4.1.2)ï¼š</p><blockquote><p>A mini-transaction is defined by a compare, read, and write set; Sinfonia exposes a linear address space across many memory nodes. </p></blockquote><p>æœ¬è´¨ä¸Šç›¸å½“äºåœ¨å‰é¢ä¸‰ç±»çš„åŸºç¡€ä¸Šæ§åˆ¶è¯»å†™é›†å’Œå†²çªã€‚</p><p>æ¶‰åŠå¤šä¸ª chain çš„äº‹åŠ¡æ—¶å€™ï¼Œéœ€è¦å¯¹ chain ä¹‹é¦–å¤„ç† 2PCã€‚</p><h4 id="4-2-Lowering-Write-Latency-with-Multicast"><a href="#4-2-Lowering-Write-Latency-with-Multicast" class="headerlink" title="4.2 Lowering Write Latency with Multicast"></a>4.2 Lowering Write Latency with Multicast</h4><p>Raft çš„åè®®ä¼šå®Œæˆä¸€ä¸ª majority çš„å†™ã€‚CRAQ ä¹Ÿå¯ä»¥åˆ©ç”¨ multicast æ¥ bonus å†™æ€§èƒ½ï¼š</p><blockquote><p>Then, instead of propagating a full write serially down a chain, which adds latency proportional to the chain length, the actual value can be multicast to the entire chain. Then, only a small metadata message needs to be propagated down the chain to ensure that all replicas have received a write before the tail. If a node does not receive the multi- cast for any reason, the node can fetch the object from its predecessor after receiving the write commit message and before further propagating the commit message.</p></blockquote><p>é€šè¿‡å¹¿æ’­å†™å…¥æ•°æ®ï¼Œç„¶åä»å¤´åˆ°å°¾ä¼ æ’­ metadata è€Œä¸æ˜¯å…¨éƒ¨ä¿¡æ¯ï¼Œæ¥ä¿è¯å†™å…¥æ˜¯æœ‰æ•ˆçš„ã€‚</p><p>åŒæ—¶ï¼Œå•ä¸ª dc å°¾éƒ¨æ”¶åˆ° ACK æˆ–è€…å®Œæˆå†™å…¥çš„æ—¶å€™ï¼Œä¹Ÿå¯ä»¥ç”¨ multicast æå‡æ€§èƒ½ï¼š</p><blockquote><p>This reduces both the amount of time it takes for a nodeâ€™s object to re-enter the clean state after a write, as well as the clientâ€™s perceived write delay.</p></blockquote><h3 id="5-Management-and-Implementation"><a href="#5-Management-and-Implementation" class="headerlink" title="5 Management and Implementation"></a>5 Management and Implementation</h3><h4 id="5-3-Handling-Memberships-Changes"><a href="#5-3-Handling-Memberships-Changes" class="headerlink" title="5.3 Handling Memberships Changes"></a>5.3 Handling Memberships Changes</h4><p>è®ºæ–‡ 2.3 æåˆ°äº†ä¸€å®šçš„è¦æ±‚ï¼Œå³ï¼š</p><ul><li>header å‡ºé—®é¢˜äº†æŠŠ header-&gt;next å½“æ–°çš„ header</li><li>tail å‡ºé—®é¢˜äº†æŠŠ tail-prev å½“ tail</li><li>åœ¨ä¸­é—´åŠ å…¥/åˆ é™¤è¦é€šçŸ¥å‰å</li></ul><p>ä»¥ä¸Šéƒ½æ˜¯ recover æˆ–è€…ä¸‹çº¿çš„è¿‡ç¨‹ï¼ŒåŸå§‹çš„è®ºæ–‡ä¼¼ä¹ä¸ä¼šè€ƒè™‘åœ¨ä»»ä½•ä¸€ä¸ªä½ç½® Joinï¼Œåªä¼šåœ¨å°¾éƒ¨æ’å…¥ã€‚è¿™æ ·çš„è¯ä¼¼ä¹åŒæ­¥å®Œæ•°æ®ç„¶åå°±å¯ä»¥åŠ å…¥äº†ã€‚Join ä¼šå¤æ‚å¾ˆå¤šï¼Œè¿™ç¯‡è®ºæ–‡ä»‹ç»äº†ä¸€ç§æ–°çš„æ–¹å¼ï¼šback-propagationï¼ˆæ³¨æ„ï¼Œä¸æ˜¯ä¼ æ’­å†™å…¥å®Œæˆ ACKï¼‰ï¼Œè¿™ç§æ–¹å¼è®©ä»»æ„æ’å…¥çš„ç³»ç»Ÿ recoverã€‚</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Notes on Consistency: Raft &amp; ZooKeeper and Potpourri</title>
      <link href="/2020/07/22/Notes-on-Consistency-Raft-ZooKeeper-and-Potpourri/"/>
      <url>/2020/07/22/Notes-on-Consistency-Raft-ZooKeeper-and-Potpourri/</url>
      
        <content type="html"><![CDATA[<h1 id="Notes-on-Consistency-Raft-amp-ZooKeeper"><a href="#Notes-on-Consistency-Raft-amp-ZooKeeper" class="headerlink" title="Notes on Consistency: Raft &amp; ZooKeeper"></a>Notes on Consistency: Raft &amp; ZooKeeper</h1><p><img src="https://image.mwish.me/blog-image/B95597B6-1F4D-4579-B286-76A6D16A1A25.png" alt="B95597B6-1F4D-4579-B286-76A6D16A1A25"></p><p>Raft åè®®æŒ‰ç…§è®ºæ–‡å®ç°çš„è¯ï¼Œæ˜¯èƒ½ä¿è¯ Linearizable çš„ï¼Œè¿™æ˜¯æœ€å¼ºçš„ä¸€è‡´æ€§æ¨¡å‹ï¼Œåœ¨æ•´ä¸ªç³»ç»Ÿä¸­ï¼Œoperation æœ‰åºå¹¶åŸå­çš„å®Œæˆï¼Œæ¯ä¸ªæ“ä½œéƒ½åƒç¬é—´å‘ç”Ÿä¸€æ ·ï¼Œåœ¨è¿™ä¸ªæ—¶é—´ç‚¹ä¹‹åçœ‹åˆ°è¿™ä¸ªå¯¹è±¡éƒ½æ˜¯å†™å…¥çš„å€¼ï¼Œåœ¨è¿™ä¸ªç‚¹ä¹‹å‰çœ‹åˆ°çš„éƒ½æ˜¯å‰ä¸€ä¸ªå€¼ã€‚</p><p>ä»¥ä¸Šåªæ˜¯ä¸€ä¸ªæˆ‘è‡ªå·±ç†è§£çš„å¾ˆæ¨¡ç³Šçš„è¯´æ³•ï¼Œå®é™…å†…å®¹å¯ä»¥å‚è€ƒï¼š</p><ul><li><a href="https://en.wikipedia.org/wiki/Linearizability">https://en.wikipedia.org/wiki/Linearizability</a></li></ul><p>å®é™…ä¸Šï¼Œåœ¨äº†è§£ Wing&amp;Gong ç®—æ³•ä¹‹ç±»çš„åˆ¤åˆ«æ³•ä¹‹å‰ï¼Œæˆ‘ä»¬å¯ä»¥å°è¯•çœ‹çœ‹ä¸Šé¢çš„ history4:</p><ul><li>Wx0 åœ¨ Rx1 Rx2 ä¹‹å‰å‘ç”Ÿï¼Œè¿™æ„å‘³ç€å¦‚æœç³»ç»Ÿæ˜¯ Linearizable çš„ï¼Œè¯»å–ä¹‹å‰å°±å‘ç”Ÿäº† Wx1 å’Œ Wx2</li><li>C2 Rx1 ä¹‹å Rx2, æ²¡æœ‰é‡å çš„æƒ…å†µä¸‹ï¼Œ2 åº”è¯¥åœ¨ 1ä¹‹åè¢«å†™å…¥</li></ul><p>ä½ å¯èƒ½ä¼šåœ¨ä¸¤ç§åœ°æ–¹çœ‹åˆ° Linearizable ï¼š</p><ul><li>ä½ åœ¨å•æœºçš„å¤šæ ¸å¤„ç†å™¨ä¸­å®ç°äº†ä¸€ä¸ª Queue, éœ€è¦åˆ¤æ–­åœ¨å¤šæ ¸å¤„ç†å™¨ä¸‹è®¿é—®å®ƒçš„è¯­ä¹‰æ˜¯å¦æ˜¯ Linearizable çš„</li><li>ä½ å®ç°äº†ä¸€ä¸ª Raft, è¦æ¥åˆ¤æ–­ä»–æ˜¯å¦æ»¡è¶³ Linearizable</li></ul><p>Linearizable å®ç°çš„ä»£ä»·å¾ˆé«˜ï¼Œå½“ä½ å®ç°ä¸€ä¸ªåŸºç¡€çš„ kv raft çš„æ—¶å€™ï¼Œä½ å¾—ä¿è¯ï¼š</p><ul><li>Raft æŠŠä½ å†™æ¶ˆæ¯å¹¿æ’­åˆ°äº†å¤§éƒ¨åˆ†æœºå™¨ä¸Š</li><li>åœ¨ä½ è¯»å–çš„æ—¶å€™ï¼ŒRaft Leader ä»ç„¶æ˜¯å¤§éƒ¨åˆ†é›†ç¾¤çš„ Leader</li><li>â€¦</li></ul><p>åœ¨ç³»ç»Ÿä¸­ï¼Œæˆ‘ä»¬å¯èƒ½éœ€è¦ Linearizable çš„åè°ƒå•ç‚¹ï¼Œæ¥å®Œæˆè¿™æ ·çš„è¯­ä¹‰ã€‚</p><h2 id="Sequential-Consistency"><a href="#Sequential-Consistency" class="headerlink" title="Sequential Consistency"></a>Sequential Consistency</h2><blockquote><p>â€¦ the result of any execution is the same as if the operations of all the processors were executed in some sequential order, and the operations of each individual processor appear in this sequence in the order specified by its program.</p></blockquote><p>ä»¥ä¸Šæ˜¯ Sequential Consistency çš„å®šä¹‰ï¼Œå®ƒä¿è¯äº†æ“ä½œæ˜¯ total order çš„ï¼Œå¹¶ä¸”åœ¨ä½ è¯»åˆ°ä¸€ä¸ªå€¼ä¹‹åï¼Œä½ å°±å†ä¹Ÿä¸ä¼šè¯»åˆ°å®ƒä¹‹å‰çš„å€¼äº†ã€‚</p><p>ä½†æ˜¯ï¼Œæœ‰ä¸€ç‚¹éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæœ‰çš„æ—¶å€™ä½ å¹¶æ²¡æœ‰â€œåŒæ—¶â€è¿™ä¸ªä¿è¯ï¼šLinearizable ç³»ç»Ÿä¸­ï¼ŒAå†™å…¥äº†ï¼ŒBåŒæ—¶ä¸€å®šå°±èƒ½è¯»åˆ°ï¼ˆå‡è®¾æ²¡æœ‰å…¶ä»–çš„ Writerï¼‰ã€‚ä½†æ˜¯ Sequential Consistency çš„ç³»ç»Ÿä¸­ï¼Œä½ å¯ä»¥ä¿è¯ Total Orderï¼Œä½†ä¸èƒ½ä¿è¯è¿™ä¸€ç‚¹ã€‚</p><p>ä½ å¦‚æœäº†è§£è¿‡ memory order çš„è¯ï¼Œå¯èƒ½ä¼šæ¯”è¾ƒç†Ÿæ‚‰ <code>acquire</code> <code>release</code> <code>acq_rel</code> <code>seq_cst</code>, åœ¨ stackoverflow æœ‰åä¸¤ä¸ªçš„è®¨è®ºï¼Œæˆ–è®¸èƒ½å¸®ä½ æ›´åŠ äº†è§£ï¼š</p><ul><li><a href="https://stackoverflow.com/questions/12340773/how-do-memory-order-seq-cst-and-memory-order-acq-rel-differ">https://stackoverflow.com/questions/12340773/how-do-memory-order-seq-cst-and-memory-order-acq-rel-differ</a></li></ul><p>ZooKeeper æä¾›ä¸€ç§ç±»ä¼¼ Sequential Consistency çš„å®šä¹‰ï¼Œå®ƒç§°ä¸º Linearizable-Write</p><ul><li>å†™ä¼šè¢«æœ‰åºå…¨å±€å¹¿æ’­</li><li>è¯»ä¼šè¯» local-cache</li><li>é€šè¿‡ watch æ¥çœ‹ç­‰å¾…é€šçŸ¥</li></ul><p>å¯ä»¥å‚è§æˆ‘ä¹‹å‰ç¿»è¯‘çš„ Paper</p><h2 id="éªŒè¯"><a href="#éªŒè¯" class="headerlink" title="éªŒè¯"></a>éªŒè¯</h2><p>Jepsen æ ¹æ®è°ƒç”¨çš„å›¾æä¾›äº†éªŒè¯æ–¹å¼ï¼Œetcd ç­‰éƒ½ç”¨ Jepsen æ¥åšä¸€äº›ä¸€è‡´æ€§éªŒè¯å’Œæ··æ²Œæƒ…å†µä¸‹çš„ä¸€è‡´æ€§éªŒè¯ï¼Œå¯ä»¥çœ‹çœ‹ Jepsen å¯¹åº”çš„æ–‡æ¡£ï¼š</p><ul><li><a href="https://jepsen.io/consistency/models/linearizable">https://jepsen.io/consistency/models/linearizable</a></li><li><a href="https://jepsen.io/consistency/models/sequential">https://jepsen.io/consistency/models/sequential</a></li></ul><h2 id="å¤šä¸ªå˜é‡"><a href="#å¤šä¸ªå˜é‡" class="headerlink" title="å¤šä¸ªå˜é‡"></a>å¤šä¸ªå˜é‡</h2><p>å½“ä½ è¦å¤„ç†å¤šä¸ªå˜é‡çš„â€œä¸€è‡´æ€§â€ çš„æ—¶å€™ï¼Œä½ å¯èƒ½éœ€è¦çš„æ˜¯æ•°æ®åº“çš„ä¸€è‡´æ€§ã€‚</p><p>Generalized Isolation Level Definitions è¿™ç¯‡è®ºæ–‡ä»‹ç»äº†åŒ…æ‹¬ SI ä¸‹å®ƒçš„è¯¦ç»†å®šä¹‰ï¼ŒPostgreSQL çš„ SSI ä¹Ÿæ˜¯åœ¨è¿™åŸºç¡€ä¸Šå®ç°çš„ã€‚</p><p>ä¹‹å‰åšè¿‡ä¸€ä¸ªç›¸å…³çš„ slide: <a href="https://docs.google.com/presentation/d/1FrW41bGt6iSjxQwbYu0YulYR-SoV2iiqyKpDV4SPxxc/edit?usp=sharing">https://docs.google.com/presentation/d/1FrW41bGt6iSjxQwbYu0YulYR-SoV2iiqyKpDV4SPxxc/edit?usp=sharing</a></p><p>å®é™…ä¸Šï¼ŒJepsen çš„ elle ä¹Ÿå¯¹è¿™ç§æƒ…å†µè¿›è¡Œäº†å®éªŒï¼š</p><p><a href="https://github.com/jepsen-io/elle">https://github.com/jepsen-io/elle</a></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>SQL &amp; ORM notes</title>
      <link href="/2020/07/17/SQL-ORM-notes/"/>
      <url>/2020/07/17/SQL-ORM-notes/</url>
      
        <content type="html"><![CDATA[<h1 id="ORM-å’Œ-SQL-å¤‡å¿˜"><a href="#ORM-å’Œ-SQL-å¤‡å¿˜" class="headerlink" title="ORM å’Œ SQL å¤‡å¿˜"></a>ORM å’Œ SQL å¤‡å¿˜</h1><p>ä»Šå¤©è¢«ä¸Šå¤´æ´¾å»å†™ SQL, å‘ç°è‡ªå·±æŠŠ SQL å¿˜å…‰äº†ï¼ŒæŠŠä»¥å‰åšçš„ç¬”è®°ç¿»å‡ºæ¥çœ‹äº†ä¸€éã€‚</p><p>è¿™ç¯‡æ–‡ç« å†™çš„å¾ˆä¸¢äººï¼Œçº¯å½“ä½œå¤‡å¿˜äº†â€¦</p><h1 id="MySQL-amp-SQLAlchemy-æŸ¥è¯¢1"><a href="#MySQL-amp-SQLAlchemy-æŸ¥è¯¢1" class="headerlink" title="MySQL &amp; SQLAlchemy: æŸ¥è¯¢1"></a>MySQL &amp; SQLAlchemy: æŸ¥è¯¢1</h1><h1 id="æ¦‚å¿µ"><a href="#æ¦‚å¿µ" class="headerlink" title="æ¦‚å¿µ"></a>æ¦‚å¿µ</h1><h2 id="åŸºç¡€æŸ¥è¯¢"><a href="#åŸºç¡€æŸ¥è¯¢" class="headerlink" title="åŸºç¡€æŸ¥è¯¢"></a>åŸºç¡€æŸ¥è¯¢</h2><p>æŸ¥è¯¢å¯ä»¥ä»mysqlæŸ¥è¯¢å‡ºä¸€ä¸ªæˆ–<strong>å¤šä¸ª</strong>åˆ—</p><p>å¯ä»¥å¤šåˆ—ï¼Œç”šè‡³ç”¨ * æŒ‡å®šå¤šåˆ—æŸ¥è¯¢</p><p>ç”¨<code>SELECT DISTINCT col FROM table</code> æŒ‡å®š<strong>ä¸åŒçš„è¡Œ</strong></p><p>ç”¨limitæŒ‡å®šæœç´¢çš„ç»“æœ, å¯ä»¥<code>LIMIT BEGIN, END</code>ä¹Ÿå¯ä»¥ <code>LIMIT NUMS</code>ã€‚æ³¨æ„ä»0è¡Œå¼€å§‹ã€‚</p><p>SQL å½¢å¼ç±»ä¼¼äº<code>LIMIT &lt;COUNT&gt; offset</code></p><p><code>SELECT tablename.column</code>SELECTåå¯ä»¥è·Ÿç€è¡¨å</p><h2 id="æ’åºæŸ¥è¯¢"><a href="#æ’åºæŸ¥è¯¢" class="headerlink" title="æ’åºæŸ¥è¯¢"></a>æ’åºæŸ¥è¯¢</h2><p>ç›´æ¥æŸ¥è¯¢è¿”å›çš„æ˜¯æ²¡æœ‰æ’åºçš„ç»“æœï¼Œå»ºè®®<code>order_by</code><br>(æ’åºè¢«ç§°ä¸ºæ˜¯<strong>å­å¥</strong> clause)</p><p>order_by å¯ä»¥æŒ‡å®šå¤šä¸ªåˆ—ï¼ŒæŒ‰é¡ºåºæ’åº(like å­—ç¬¦ä¸²)ã€‚</p><p>å¦‚ <code>ORDER BY c1 DESC, c2</code></p><p>æŒ‡å®šDESCå¯ä»¥ååºæŸ¥è¯¢ï¼Œå®Œæˆç¾å¦™çš„æ“ä½œ</p><h2 id="è¿‡æ»¤æŸ¥è¯¢"><a href="#è¿‡æ»¤æŸ¥è¯¢" class="headerlink" title="è¿‡æ»¤æŸ¥è¯¢"></a>è¿‡æ»¤æŸ¥è¯¢</h2><p>MYSQLä¸­å¯ä»¥å¯¹æŸ¥è¯¢æŒ‡å®šæ¡ä»¶</p><p>å…·ä½“å¯ä»¥çœ‹çœ‹<a href="http://blog.csdn.net/haibo0668/article/details/52539880">è¿™é‡Œ</a></p><ol><li>WHEREå­å¥<br><code>SELECT ... FROM ... WHERE x = a</code><br>åšç›¸ç­‰æ€§æµ‹è¯•ï¼Œè¿™é‡Œæ”¯æŒçš„æ“ä½œå¾ˆå¤š<br>ORDER_BY åœ¨whereä¹‹å</li><li><code>BETWEEN a AND b</code>å¯ä»¥åšèŒƒå›´æ£€æŸ¥ã€‚å¿…é¡»æŒ‡å®šä½å€¼åˆ°é«˜ç«¯å€¼ã€‚</li><li>AND OR æ”¯æŒå¤šä¸ªæ¡ä»¶çš„é€»è¾‘è¿ç®—ï¼Œå¯ä»¥æ‹¬å·è”ç³»èµ·æ¥ï¼Œåœ¨whereåæŒ‡å®š NOTå¦å®šã€‚å…³äºè®¡ç®—æŒç»­å¯ä»¥ç”¨æ‹¬å·åšè‡ªå·±çš„ä¸€äº›åˆ¶å®š</li><li><strong>Like clause</strong> Like å¯ä»¥æŒ‡å®šWILECARD(é€šé…ç¬¦)ã€‚<code>%</code>è¡¨ç¤ºä»»æ„åŒ¹é…(ä»»æ„é•¿åº¦ï¼Œä»»æ„è¯)ï¼Œ<code>jet%</code>è¡¨ç¤ºjetå¼€å¤´æ‰€æœ‰ï¼Œå¤§å°å†™æ•æ„Ÿ<code>_</code>åŒ¹é…ä»»æ„å•ä¸ªå­—ç¬¦ã€‚</li><li>SQL å®šä¹‰äº† substring, upper, concat ä¹‹ç±»çš„ç®—å­ï¼Œå¯ä»¥å¸®ç”¨æˆ·å®Œæˆæ“ä½œã€‚ä¸è¿‡åœ¨å„ç§ sql å®ç°é‡Œå¯èƒ½ä¸ä¸€æ ·/</li><li><strong>REGEXæœç´¢</strong> <code>WHERE COLUMN REGEXP â€˜a|bâ€™</code></li><li><code>IS NULL</code>åšç©ºå€¼æŸ¥è¯¢ã€‚</li><li>IN æ“ä½œæ˜¯åšæ¡ä»¶åŒ¹é…ï¼Œ<code>IN (v1, v2, ...)</code> ç›¸å½“äºåœ¨é‡Œé¢çš„éƒ½æ˜¯validçš„æ“ä½œã€‚</li></ol><h1 id="å®æ“"><a href="#å®æ“" class="headerlink" title="å®æ“"></a>å®æ“</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">for</span> instance <span class="keyword">in</span> session.query(User).order_by(User.<span class="built_in">id</span>):</span><br><span class="line"><span class="meta">... </span>    <span class="built_in">print</span>(instance.name, instance.fullname)</span><br></pre></td></tr></table></figure><p>query()ä¼šåˆ›å»ºå¯¹è±¡ï¼Œå¸®åŠ©åšæŸ¥è¯¢ï¼Œç”¨order_byè¡¨é¡ºåºç»´æŒï¼Œè¿”å›ä¸€ä¸ªtuple</p><p>ä¹Ÿå¯ä»¥å¯¹ä¸“é—¨çš„å­—æ®µè¿›è¡ŒæŸ¥è¯¢</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">for</span> row <span class="keyword">in</span> session.query(User, User.name).<span class="built_in">all</span>():</span><br><span class="line"><span class="meta">... </span>   <span class="built_in">print</span>(row.User, row.name)</span><br></pre></td></tr></table></figure><p>ç»“æœæ˜¯æ˜¾ç„¶çš„</p><p>queryå¯¹è±¡é€šå¸¸è¿”å›ä¸€ä¸ªæ–°çš„queryå¯¹è±¡ï¼Œå¯ä»¥ç”¨.filter().filter()â€¦ ç­‰å®ç°andæ“ä½œçš„é€»è¾‘</p><p>filterçš„è¿‡æ»¤æ“ä½œå¯è§æ­¤ä¸­çš„<a href="https://github.com/linux-wang/sqlalchemy-docs-CN/blob/master/SQLAlchemyORM/Object-Relational-Tutorial.md">å¸¸ç”¨è¿‡æ»¤æ“ä½œ</a>(æœ‰equal unequal like ilike in isnull ç­‰)</p><ul><li><p>ç”¨textå¯¹è±¡åŒ…è£…SQL</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>stmt = text(<span class="string">&quot;SELECT name, id, fullname, password &quot;</span></span><br><span class="line"><span class="meta">... </span>            <span class="string">&quot;FROM users where name=:name&quot;</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>stmt = stmt.columns(User.name, User.<span class="built_in">id</span>, User.fullname, User.password)</span><br><span class="line">SQL&gt;&gt;&gt; session.query(User).from_statement(stmt).params(name=<span class="string">&#x27;ed&#x27;</span>).<span class="built_in">all</span>()</span><br><span class="line">[&lt;User(name=<span class="string">&#x27;ed&#x27;</span>, fullname=<span class="string">&#x27;Ed Jones&#x27;</span>, password=<span class="string">&#x27;f8s7ccs&#x27;</span>)&gt;]</span><br></pre></td></tr></table></figure></li></ul><p>textå¯å†™å…¥åŸç”Ÿçš„SQLè¯­å¥æŸ¥è¯¢</p><h3 id="è¿”å›å“ªäº›"><a href="#è¿”å›å“ªäº›" class="headerlink" title="è¿”å›å“ªäº›"></a>è¿”å›å“ªäº›</h3><p>æœ‰<code>.first()</code> <code>.all()</code>ä¸¤ä¸ªå¸¸ç”¨, æœ‰çš„ ORM ä¹Ÿå®šä¹‰äº† <code>single</code></p><p><code>.one()</code>è¿”å›ä¸€ä¸ªï¼Œæ²¡æœ‰ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œ<code>.one_or_none()</code>æ²¡æœ‰æ—¶ä¼šè¿”å›æ— </p><h2 id="SQLAlchemy-amp-MySQLå¤‡å¿˜ï¼šåŸºæœ¬æ“ä½œ-CUD-ä¸å®Œæ•´æ€§çº¦æŸ"><a href="#SQLAlchemy-amp-MySQLå¤‡å¿˜ï¼šåŸºæœ¬æ“ä½œ-CUD-ä¸å®Œæ•´æ€§çº¦æŸ" class="headerlink" title="SQLAlchemy&amp;MySQLå¤‡å¿˜ï¼šåŸºæœ¬æ“ä½œ(CUD)ä¸å®Œæ•´æ€§çº¦æŸ"></a>SQLAlchemy&amp;MySQLå¤‡å¿˜ï¼šåŸºæœ¬æ“ä½œ(CUD)ä¸å®Œæ•´æ€§çº¦æŸ</h2><h1 id="åˆ›å»º-Create-ã€æ›´æ–°-Update-ä¸åˆ é™¤-Delete"><a href="#åˆ›å»º-Create-ã€æ›´æ–°-Update-ä¸åˆ é™¤-Delete" class="headerlink" title="åˆ›å»º(Create)ã€æ›´æ–°(Update)ä¸åˆ é™¤(Delete)"></a>åˆ›å»º(Create)ã€æ›´æ–°(Update)ä¸åˆ é™¤(Delete)</h1><p>Create, read, update and delete ç®€ç§°CRUDï¼Œè¡¨ç¤ºæˆ‘ä»¬å¸¸åšçš„æ“ä½œã€‚</p><p>ä¸‹é¢æ¥è®²æ’å…¥ï¼Œè¿™é‡Œå°±ä¸ä»‹ç»ç›®çš„äº†â€¦å¤§å®¶éƒ½èƒ½ç†è§£çš„ï¼Œå¯¹å§â€¦</p><h2 id="ç»å¸¸è¦åšçš„æ’å…¥æ“ä½œ"><a href="#ç»å¸¸è¦åšçš„æ’å…¥æ“ä½œ" class="headerlink" title="ç»å¸¸è¦åšçš„æ’å…¥æ“ä½œ"></a>ç»å¸¸è¦åšçš„æ’å…¥æ“ä½œ</h2><ol><li>æ’å…¥å®Œæ•´çš„è¡Œ</li><li>æ’å…¥è¡Œçš„ä¸€éƒ¨åˆ†(???)</li><li>æ’å…¥å¤šè¡Œ</li><li>æ’å…¥æŸ¥è¯¢çš„ç»“æœ</li></ol><h2 id="æ“ä½œ"><a href="#æ“ä½œ" class="headerlink" title="æ“ä½œ"></a>æ“ä½œ</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO tables VALUES(...)</span><br></pre></td></tr></table></figure><p>INSERT è¯­å¥ä¸€èˆ¬ä¸ä¼šäº§ç”Ÿè¾“å‡ºï¼Œå¯¹æ¯ä¸ªåˆ—æä¾›ä¸€ä¸ªå€¼ã€‚</p><p><code>INSERT INTO table(c1, c2, ..., cn) VALUES(c1r, c2r, ..., cnr)</code> æ›´åŠ çš„å®‰å…¨</p><p>ç»™å‡ºåˆ—åçš„å¯æ”¹å˜æ–‡æœ¬ä¸­åˆ—çš„é¡ºåº</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">INTO table(...) VALURS (), ()</span><br></pre></td></tr></table></figure><p>VALUES åå¯è·Ÿå¤šä¸ªtuple</p><h2 id="æ’å…¥æŸ¥æ‰¾çš„ç»“æœ"><a href="#æ’å…¥æŸ¥æ‰¾çš„ç»“æœ" class="headerlink" title="æ’å…¥æŸ¥æ‰¾çš„ç»“æœ"></a>æ’å…¥æŸ¥æ‰¾çš„ç»“æœ</h2><p><code>INSERT INTO table ... SELECT cols FROM ...</code></p><p>å¯ä»¥è®©ä½ æ’å…¥æŸ¥æ‰¾çš„ç»“æœã€‚</p><h1 id="æ›´æ–°"><a href="#æ›´æ–°" class="headerlink" title="æ›´æ–°"></a>æ›´æ–°</h1><h2 id="ç»“æ„"><a href="#ç»“æ„" class="headerlink" title="ç»“æ„"></a>ç»“æ„</h2><ol><li>è¡¨å</li><li>æ›´æ–°æ“ä½œ</li><li>è¿‡æ»¤æ¡ä»¶</li></ol><h2 id="æ“ä½œ-1"><a href="#æ“ä½œ-1" class="headerlink" title="æ“ä½œ"></a>æ“ä½œ</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">UPDATE table </span><br><span class="line">SET c1 = , c2 = ,...</span><br><span class="line">WHERE conds</span><br></pre></td></tr></table></figure><p>æ³¨æ„æ›´æ–°å¦‚æœå¤±è´¥ï¼Œå‰é¢æ‰€æœ‰æ“ä½œCANCEL, è‹¥å¸Œæœ›ç»§ç»­æ‰§è¡Œï¼Œåˆ™ç”¨<code>UPDATE IGNORE</code></p><h1 id="åˆ é™¤"><a href="#åˆ é™¤" class="headerlink" title="åˆ é™¤"></a>åˆ é™¤</h1><h2 id="æ“ä½œ-2"><a href="#æ“ä½œ-2" class="headerlink" title="æ“ä½œ"></a>æ“ä½œ</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DELETE table WHERE conds</span><br></pre></td></tr></table></figure><p>æƒ³åˆ é™¤æ‰€æœ‰æ•°æ®ç”¨<code>TRUNCATE TABLE</code></p><h1 id="åˆ›å»ºè¡¨"><a href="#åˆ›å»ºè¡¨" class="headerlink" title="åˆ›å»ºè¡¨"></a>åˆ›å»ºè¡¨</h1><h2 id="ç»“æ„-1"><a href="#ç»“æ„-1" class="headerlink" title="ç»“æ„"></a>ç»“æ„</h2><p>æ³¨æ„ç‹—å±ç¼–ç é—®é¢˜ï¼ŒUTF-8å¤©ä¸‹ç¬¬ä¸€</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE tablename (</span><br><span class="line">    (colname type constraint,)*</span><br><span class="line">)</span><br></pre></td></tr></table></figure><h2 id="çº¦æŸ"><a href="#çº¦æŸ" class="headerlink" title="çº¦æŸ"></a><a href="https://segmentfault.com/a/1190000006671061">çº¦æŸ</a></h2><p>çº¦æŸå¯èƒ½è¦æ»¡è¶³å‚ç…§å®Œæ•´æ€§(referential integrity) æˆ–è€… å•ä¸ªå…³ç³»çš„å®Œæ•´æ€§çº¦æŸã€‚</p><p>çº¦æŸçš„<a href="https://www.ibm.com/support/knowledgecenter/zh/SSEPGG_9.5.0/com.ibm.db2.luw.admin.dbobj.doc/doc/c0020114.html">ç±»å‹</a></p><p><strong>æ³¨æ„ï¼šçº¦æŸå¯ä»¥æ˜¯è”åˆçš„</strong>ï¼Œåœ¨ SQLAlchemy ä¸­è®¾ç½®è”åˆå¯ä»¥å‚ç…§<a href="http://www.pythondoc.com/flask-sqlalchemy/models.html">è¿™é‡Œ</a>: æ¯”å¦‚è®¾ç½®å¤šä¸ªprimary_key = Trueå³å¯ã€‚</p><h3 id="NOT-NULL"><a href="#NOT-NULL" class="headerlink" title="NOT NULL"></a><code>NOT NULL</code></h3><p>éœ€è¦æŒ‡å®š</p><h3 id="AUTOINCREMENT"><a href="#AUTOINCREMENT" class="headerlink" title="AUTOINCREMENT"></a><code>AUTOINCREMENT</code></h3><p>è‡ªå¢</p><h3 id="DEFAULT"><a href="#DEFAULT" class="headerlink" title="DEFAULT"></a><code>DEFAULT</code></h3><p>åˆ¶å®šé»˜è®¤å€¼</p><h3 id="PRIMARY-KEY"><a href="#PRIMARY-KEY" class="headerlink" title="PRIMARY KEY"></a><code>PRIMARY KEY</code></h3><p>ä¸»é”®</p><p>æœ‰å¯èƒ½å‡ºç°è”åˆä¸»é”®è¿™æ ·çš„æƒ…å†µ,æ ¼å¼å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE student(       </span><br><span class="line">          name VARCHAR(20),</span><br><span class="line">          class VARCHAR(20),</span><br><span class="line">         CONSTRAINT PK_STUD_ID PRIMARY KEY(name,class)       </span><br><span class="line">          )</span><br></pre></td></tr></table></figure><h3 id="UNIQUE"><a href="#UNIQUE" class="headerlink" title="UNIQUE"></a><code>UNIQUE</code></h3><p>UNIQUE KEY</p><h3 id="CHECK"><a href="#CHECK" class="headerlink" title="CHECK"></a><code>CHECK</code></h3><p>æ£€æŸ¥</p><p>MySQLæ²¡æœ‰è¿™ç©æ„ã€‚åº”ç”¨äºå…³ç³»å£°æ˜æ—¶<code>check(P)</code>æŒ‡å®šè°“è¯Pï¼Œæ¯ä¸ªè¢«æ’å…¥çš„æ•°æ®éƒ½è¦æ»¡è¶³P</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE table (</span><br><span class="line">attr1 type ...,</span><br><span class="line">...,</span><br><span class="line">check (attr1 in (&#x27;è€å¸æœº&#x27;, &#x27;é©¬è€çˆ·&#x27;, &#x27;ä»˜åƒåœ¾&#x27;, &#x27;å¤©é˜³å“¥&#x27;))</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>checkå…è®¸å¯¹å­é›†åŠ ä»¥é™åˆ¶ã€‚</p><h3 id="FOREIGN-KEY-å¤–é”®çº¦æŸ"><a href="#FOREIGN-KEY-å¤–é”®çº¦æŸ" class="headerlink" title="FOREIGN KEY å¤–é”®çº¦æŸ"></a><code>FOREIGN KEY</code> å¤–é”®çº¦æŸ</h3><p>æˆ‘ä»¬åœ¨ä»è¡¨ä¸­å¯ä»¥è®¾ç½®å¯¹çˆ¶è¡¨çš„å¤–é”®</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CONSTRAINT fk_class_id FOREIGN KEY(classe_id) REFERENCES classes(id)</span><br></pre></td></tr></table></figure><p>æ²¡æœ‰Referencesï¼Œé»˜è®¤æ˜¯PRIMARY KEY</p><h4 id="CASCADE-çº§è”"><a href="#CASCADE-çº§è”" class="headerlink" title="CASCADE(çº§è”)"></a>CASCADE(çº§è”)</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">FOREIGN KEY(student) REFERENCE dorm403</span><br><span class="line">on delete cascade</span><br><span class="line">on update cascade,</span><br></pre></td></tr></table></figure><p>ä¹Ÿå¯ä»¥é€‰æ‹©<code>set null</code>, <code>set default</code>ã€‚cascade åœ¨ä»è¡¨ä¸­è®¾ç½®ï¼Œè¡¨ç¤ºå½“ä½ æ›´æ–°æˆ–åˆ é™¤ä¸»é”®è¡¨æ—¶ï¼Œé‚£ä¹ˆå¤–é”®è¡¨ä¹Ÿä¼šè·Ÿéšä¸€èµ·æ›´æ–°æˆ–åˆ é™¤ã€‚studentå¯¹åº”å±æ€§çš„åˆ é™¤ã€æ›´æ–°ä¼šä¼ æ’­åˆ°æ•´ä¸ªé“¾ä¸­ã€‚</p><h2 id="æ›´æ–°è¡¨"><a href="#æ›´æ–°è¡¨" class="headerlink" title="æ›´æ–°è¡¨"></a>æ›´æ–°è¡¨</h2><p>å¸Œæœ›åœ¨è¡¨çš„å±‚é¢å¢åŠ æ“ä½œ(é’ˆå¯¹åˆ—)</p><p><code>ALTER TABLE table OPERATIONS</code>æ˜¯éœ€è¦ç”¨åˆ°çš„è¯­æ³•</p><p>ä¸€èˆ¬ä½¿ç”¨<code>ADD</code>, <code>DROP</code>æ“ä½œå¹¶å†™ä¸Šåˆ—ã€‚</p><p><code>DROP TABLE</code>åˆ é™¤æ•´ä¸ªè¡¨ï¼Œä¸ä»…ä»…æ˜¯åˆ é™¤å…¶å†…å®¹ã€‚</p><h3 id="è¡¨çº¦æŸçš„ä¿®æ”¹"><a href="#è¡¨çº¦æŸçš„ä¿®æ”¹" class="headerlink" title="è¡¨çº¦æŸçš„ä¿®æ”¹"></a>è¡¨çº¦æŸçš„ä¿®æ”¹</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">//åˆ é™¤ä¸»é”®çº¦æŸ  </span><br><span class="line">ALTER TABLE è¡¨å DROP PRIMARY KEY;    </span><br><span class="line">//æ·»åŠ ä¸»é”®  </span><br><span class="line">ALTER TABLE è¡¨å ADD PRIMARY KEY(åˆ—å);    </span><br><span class="line">//ä¿®æ”¹åˆ—ä¸ºä¸»é”®</span><br><span class="line">ALTER TABLE è¡¨å MODIFY åˆ—å æ•°æ®ç±»å‹ PRIMARY KEY;</span><br></pre></td></tr></table></figure><h2 id="åˆ é™¤-1"><a href="#åˆ é™¤-1" class="headerlink" title="åˆ é™¤"></a>åˆ é™¤</h2><p><a href="https://www.quora.com/What-is-the-main-difference-between-Truncate-Delete-and-Drop-in-a-database">https://www.quora.com/What-is-the-main-difference-between-Truncate-Delete-and-Drop-in-a-database</a></p><p><a href="http://blog.csdn.net/hanxuemin12345/article/details/7818662">http://blog.csdn.net/hanxuemin12345/article/details/7818662</a></p><p>DELETE TRUNCATE DROPç­‰æ“ä½œ</p><h2 id="SQLAlchemy-MySQL-å¤‡å¿˜-è®¡ç®—å­—æ®µå’Œåˆ†ç»„æŸ¥è¯¢"><a href="#SQLAlchemy-MySQL-å¤‡å¿˜-è®¡ç®—å­—æ®µå’Œåˆ†ç»„æŸ¥è¯¢" class="headerlink" title="SQLAlchemy-MySQL-å¤‡å¿˜-è®¡ç®—å­—æ®µå’Œåˆ†ç»„æŸ¥è¯¢"></a>SQLAlchemy-MySQL-å¤‡å¿˜-è®¡ç®—å­—æ®µå’Œåˆ†ç»„æŸ¥è¯¢</h2><h1 id="MYSQLå’Œç†è®ºéƒ¨åˆ†"><a href="#MYSQLå’Œç†è®ºéƒ¨åˆ†" class="headerlink" title="MYSQLå’Œç†è®ºéƒ¨åˆ†"></a>MYSQLå’Œç†è®ºéƒ¨åˆ†</h1><h2 id="è®¡ç®—å­—æ®µ"><a href="#è®¡ç®—å­—æ®µ" class="headerlink" title="è®¡ç®—å­—æ®µ"></a>è®¡ç®—å­—æ®µ</h2><p>(è¿™é‡Œæ ¹æ®æˆ‘çš„ç†è§£æ›´åƒå¯¹æœç´¢å‡ºçš„æ•°æ®å‡½æ•°è°ƒç”¨)<br>ä¸åŒäºç›´æ¥å­˜å‚¨çš„æ•°æ®</p><p>è®¡ç®—å­—æ®µæœç´¢çš„ç»“æœæ˜¯æŒ‰ä½ åœ¨è®¡ç®—å­—æ®µç¼–å†™çš„é€»è¾‘æ˜¾ç¤ºçš„ï¼Œæ¯”å¦‚è¯´ä½ ç¼–å†™çš„æŒ‡å®šæ˜¯<code>MAN(money)</code>, æ˜¾ç¤ºå‡ºæ¥å°±æ˜¯<code>FXW(-100)</code>.</p><p>Concatå¯ä»¥åœ¨å½¢å¼ä¸Šåˆå¹¶å¤šä¸ªå­—æ®µï¼Œè¿›è¡Œæ“ä½œ<br><code>SELECT Concat(col1, &#39;(&#39;, cow2, &#39;)&#39;) FROM table ORDER BY ...</code><br>è¾“å‡ºçš„å½¢å¼æ˜¯col1(col2)ï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥å¯¹é€‰å®šçš„ç®—æœ¯è¿ç®—ã€‚</p><p>å®é™…ä¸Šè¯´æ˜¯å‡½æ•°ï¼Œä½†æ˜¯ + - * éƒ½æ˜¯å¯ä»¥ç›´æ¥å†™çš„ï¼Œå‡½æ•°æ›´å¤šæŒ‡çš„æ˜¯æ–‡æœ¬å¤„ç†ç­‰æ–¹é¢ã€‚</p><p>å¯ä»¥ä½¿ç”¨æ–‡æœ¬å¤„ç†å‡½æ•°ï¼Œæ¯”å¦‚DATEç­‰(å®é™…ä¸Šéœ€è¦æ—¥æœŸä½¿ç”¨Dateï¼ŒTimeæŒ‡çš„å®é™…ä¸Šæ¯”Dateæ›´ç»†ä¸€å±‚)</p><p>ä¹Ÿæœ‰timeå¯¹è±¡ï¼Œä½†æ˜¯æ¨èä½¿ç”¨æ—¥æœŸæ˜¯å¿…å®šç”¨Date</p><h2 id="æ±‡æ€»æ•°æ®ä¸aggregate-function"><a href="#æ±‡æ€»æ•°æ®ä¸aggregate-function" class="headerlink" title="æ±‡æ€»æ•°æ®ä¸aggregate function"></a>æ±‡æ€»æ•°æ®ä¸aggregate function</h2><p>æœ‰çš„æ—¶å€™ä¸éœ€è¦å®Œæ•´æ•°æ® åªéœ€è¦å•è¡Œå•åˆ—çš„ä¿¡æ¯ï¼Œè¿™ä¸ªæ—¶å€™å¯ä»¥ç”¨æ±‡æ€»æ•°æ®è·å¾—</p><h3 id="èšé›†å‡½æ•°"><a href="#èšé›†å‡½æ•°" class="headerlink" title="èšé›†å‡½æ•°"></a>èšé›†å‡½æ•°</h3><p>è¿è¡Œåœ¨è¡Œç»„ä¸Šï¼Œè¿”å›å•ä¸ªå€¼ï¼Œæˆ‘ä»¬å¸Œæœ›èƒ½å¤Ÿ</p><ol><li>è·å¾—è¡¨ä¸­çš„è¡Œæ•°</li><li>è·å¾—è¡¨ä¸­è¡Œç»„(æŒ‰ä½ å®šä¹‰çš„è§„åˆ™åˆ†ç»„)</li><li>è·å¾—è¡¨ä¸­ä¸€åˆ—çš„ç»Ÿè®¡é‡</li></ol><p>æœ‰AVGï¼ŒSUMï¼ŒCOUNTç­‰å‡½æ•°ã€‚å¯¹<strong>ä¸€åˆ—</strong>æ“ä½œï¼Œä¹Ÿå¯ä»¥å¯¹å¤šåˆ—çš„è®¡ç®—å­—æ®µæ“ä½œã€‚</p><p>æ³¨æ„è¿™äº›ä¸œè¥¿ä¸€èˆ¬éƒ½ä¼šå¿½ç•¥å€¼ä¸ºnullçš„è¡Œ</p><p>éœ€æ³¨æ„COUNTï¼š</p><ol><li>COUNT(<em>) è¿”å›è¡Œæ•°<br>`SELECT COUNT(</em>) AS cow1 FROM table`<br>è¾“å‡ºtableè¡¨è¡Œæ•°</li><li>ä¸Šé¢æ”¹æˆ<code>COUNT(cow)</code>æ”¹æˆä¸€åˆ—çš„å’Œï¼Œ<strong>å¿½ç•¥null</strong></li></ol><p>DISTINCTæŒ‡å®šï¼šä¸Šè¿°æ“ä½œæ˜¯å¯¹ALLçš„æŒ‡å®šï¼Œä¹Ÿå°±æ˜¯å¯¹æ‰€æœ‰énullå­—æ®µè®¡ç®—</p><p><strong>åœ¨aggregeteä¸­æŒ‡å®šDISTINCTå¯¹ä¸ç­‰å€¼æ±‡æ€»</strong>ï¼Œç›¸å½“äºä¸€ä¸ªæ•°æ®å­èµ°ä¸€è¶Ÿ=&gt;<code>SELECT COUNT(DISTINCT id) from ...</code>è¿™ä¸ªdistinctå¯èƒ½ä¸åŒã€‚</p><p>SUM å¯ä»¥å¯¹å¤šä¸ªå€¼è®¡ç®—ï¼ŒæŒ‡å®šé€‚å½“çš„æŒ‡å®šçš„ç»“æœã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT COUNT(*) AS all, MIN(prod) as min FROM ...</span><br></pre></td></tr></table></figure><p>å…è®¸å¯¹å¤šä¸ªè¡Œåˆ—è¿›è¡Œæ“ä½œã€‚</p><h1 id="åˆ†ç»„"><a href="#åˆ†ç»„" class="headerlink" title="åˆ†ç»„"></a>åˆ†ç»„</h1><p>å¸Œæœ›æŠŠå¤§é‡çš„ï¼Œæ‰€æœ‰çš„æ•°æ®åˆ†æˆå‡ ä¸ªé€»è¾‘ç»„ï¼Œå¯¹æ¯ä¸ªç»„è®¡ç®—ã€‚</p><h2 id="åˆ†ç»„æ“ä½œ"><a href="#åˆ†ç»„æ“ä½œ" class="headerlink" title="åˆ†ç»„æ“ä½œ"></a>åˆ†ç»„æ“ä½œ</h2><p>è®¡ç®—å­—æ®µå¾ˆæœ‰ç”¨ï¼Œæ›´å¤šåœ¨äºå’Œåˆ†ç»„ç»“åˆä»¥åã€‚å¯¹æ¯ä¸ªå°ç»„è¿›è¡Œè®¡ç®—</p><p>å¤šä¸ªå­—æ®µçš„å­˜å‚¨å¾ˆå¤šæœ‰ç›¸åŒçš„vent_id, ç»Ÿè®¡æ¯ä¸ªvent_idçš„æ•°ç›®</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT vent_id, COUNT(*) from table GROUP BY vent_id</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ“ä½œé’ˆå¯¹ vent_id æ¥åˆ†ç»„ï¼Œå¾—åˆ°vent_idå¯¹åº”çš„æ•°ç›®ã€‚</p><p>å…³äºGROUP BYçš„å‘</p><ol><li>å¯ä»¥åŒ…å«ä»»æ„æ•°ç›®çš„ Rowï¼Œèƒ½è®©åˆ†ç»„æ›´åŠ çš„ç»†è‡´</li><li>æ‰€æœ‰åˆ—ä¸€èµ·è®¡ç®—ã€‚</li><li>ä½¿ç”¨çš„éƒ½æ˜¯åˆ—æˆ–è€…æœ‰æ•ˆçš„è¡¨è¾¾å¼ï¼Œåœ¨<code>SELECT</code>é€‰å®šè¡¨è¾¾å¼<code>(c1 * c2)</code> åœ¨ <code>GROUP BY</code>ä¸€æ ·ä½¿ç”¨åŒæ ·çš„expr.</li><li>NULL å€¼è¢«å½“æˆä¸€ä¸ªå•ç‹¬çš„åˆ†ç»„è¿”å›</li><li>å¿…é¡»åœ¨where , order by ä¹‹é—´</li></ol><h3 id="è¿‡æ»¤"><a href="#è¿‡æ»¤" class="headerlink" title="è¿‡æ»¤"></a>è¿‡æ»¤</h3><p>å¯¹äºè¿™æ ·çš„åˆ†ç»„ï¼Œæˆ‘ä»¬æœ‰çš„æ—¶å€™éœ€è¦è¿‡æ»¤ï¼Œæ­¤æ—¶ç”¨<code>HAVING</code> å­å¥ï¼Œå®ƒçš„ç”¨æ³•åŒ<code>WHERE</code>ã€‚</p><p>ä½†æ˜¯<code>WHERE</code>æŒ‡å®šçš„æ˜¯è¡Œï¼Œåªæœ‰<code>HAVING</code>å­å¥ç›¸å¯¹çš„æŒ‡å®šçš„æ˜¯åˆ†ç»„ï¼Œèƒ½å¤Ÿè®©æˆ‘ä»¬å¯¹åˆ†ç»„è¿›è¡Œä¸€å®šç¨‹åº¦çš„è¿‡æ»¤ã€‚å¯ä»¥æŠŠwhereå½“æˆåˆ†ç»„å‰è¿‡æ»¤ï¼Œäº‹å®ä¸Šwhereä¸­æ’é™¤çš„å€¼ä¸å†ä¼šå‡ºç°åœ¨åˆ†ç»„ä¸­ã€‚</p><p>(Havingå¯¹åˆ†ç»„è¿‡æ»¤ï¼Œä¾‹å¦‚ä¸Šä¸€ä¸ªä¾‹å­åŠ ä¸Š<code>HAVING COUNT(*) &gt;= 2</code>)</p><p>GROUP BY åªè´Ÿè´£åˆ†ç»„ä¸è´Ÿè´£æ’åºï¼Œæ‰€ä»¥å°½é‡ä½¿ç”¨ä¹‹åsortæŠŠ</p><p><strong>HAVINGå­å¥ç»å¸¸å’ŒSUMç­‰èšé›†å‡½æ•°ç»“åˆ</strong>ï¼Œåˆå¦‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT val1, SUM(val2*val3) AS val23 FROM table ORDER BY val23 HAVING SUM(val2*val3) &gt;= 50</span><br></pre></td></tr></table></figure><h2 id="è¿‡æ»¤ç›¸å…³ç†è®º-ç›¸å½“é‡è¦ï¼ï¼ï¼"><a href="#è¿‡æ»¤ç›¸å…³ç†è®º-ç›¸å½“é‡è¦ï¼ï¼ï¼" class="headerlink" title="è¿‡æ»¤ç›¸å…³ç†è®º(ç›¸å½“é‡è¦ï¼ï¼ï¼)"></a>è¿‡æ»¤ç›¸å…³ç†è®º(ç›¸å½“é‡è¦ï¼ï¼ï¼)</h2><ol><li>å…ˆç”¨<code>from</code>è®¡ç®—å…³ç³»</li><li>å‡ºç°<code>where</code>å­å¥ï¼Œfilter 1çš„ç»“æœ</li><li><code>group by</code> è¿›è¡Œåˆ†ç»„ï¼Œåˆ†å‡ºæ–°çš„ç»„ä»¬</li><li><code>having</code> è¿›è¡Œè¿‡æ»¤</li><li><code>SELECT</code> è¿½è¸ªæŸ¥è¯¢</li></ol><h1 id="å®æ“-1"><a href="#å®æ“-1" class="headerlink" title="å®æ“"></a>å®æ“</h1><p>.group_byå®ç°åˆ†ç»„æŸ¥è¯¢</p><p><code>from sqlalchemy import func</code>åœ¨funcä¸­æœ‰å¾ˆå¤šæœ‰ç”¨çš„åŒ…ã€‚æ¯”å¦‚func.count(<em>), ç›¸å½“äºCOUNT(</em>)ã€‚åŒç†åˆæ¨å¤šåˆ«çš„è¿™æ ·çš„åº“å‡½æ•°ã€‚ä»¥ä¸‹å‚è€ƒSQLAlchemyçš„æ–‡æ¡£</p><blockquote><p>Using the Query, we build a statement like this from the inside out. The statement accessor returns a SQL expression representing the statement generated by a particular Query - this is an instance of a select() construct, which are described in SQL Expression Language Tutorial:</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; from sqlalchemy.sql import func</span><br><span class="line">&gt;&gt;&gt; stmt = session.query(Address.user_id, func.count(&#x27;*&#x27;).\</span><br><span class="line">...         label(&#x27;address_count&#x27;)).\</span><br><span class="line">...         group_by(Address.user_id).subquery()</span><br></pre></td></tr></table></figure><h1 id="SQLAlchemy-amp-MySQL-å¤‡å¿˜-ç»„åˆæŸ¥è¯¢"><a href="#SQLAlchemy-amp-MySQL-å¤‡å¿˜-ç»„åˆæŸ¥è¯¢" class="headerlink" title="SQLAlchemy &amp; MySQL å¤‡å¿˜: ç»„åˆæŸ¥è¯¢"></a>SQLAlchemy &amp; MySQL å¤‡å¿˜: ç»„åˆæŸ¥è¯¢</h1><h1 id="ç»„åˆ-Union-æŸ¥è¯¢"><a href="#ç»„åˆ-Union-æŸ¥è¯¢" class="headerlink" title="ç»„åˆ(Union)æŸ¥è¯¢"></a>ç»„åˆ(Union)æŸ¥è¯¢</h1><h2 id="ç›®çš„"><a href="#ç›®çš„" class="headerlink" title="ç›®çš„"></a>ç›®çš„</h2><p>æ‰§è¡Œå¤šä¸ªæŸ¥è¯¢ï¼Œå¹¶å½“æˆå•ä¸ªæŸ¥è¯¢è¿”å›</p><p>å®é™…ä¸Šä»»ä½•æ‹¥æœ‰å¤šä¸ª<code>WHERE</code>æ¡ä»¶çš„æŸ¥è¯¢éƒ½å¯ä»¥å½“æˆç»„åˆæŸ¥è¯¢</p><h2 id="åŸºç¡€"><a href="#åŸºç¡€" class="headerlink" title="åŸºç¡€"></a>åŸºç¡€</h2><p>ç»„åˆæŸ¥è¯¢å¯ä»¥ç”¨å…³é”®å­—UNIONï¼Œæ¥ç»„åˆå¤šä¸ªæŸ¥è¯¢</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> c1, c2, c3 <span class="keyword">FROM</span> <span class="keyword">table</span> <span class="keyword">WHERE</span> cond1</span><br><span class="line"><span class="keyword">UNION</span></span><br><span class="line"><span class="keyword">SELECT</span> c1, c2, c3 <span class="keyword">FROM</span> <span class="keyword">table</span> <span class="keyword">WHERE</span> cond2</span><br></pre></td></tr></table></figure><p>ç›¸å½“äº<code>WHERE cond1 OR cond2</code></p><ol><li>UNION åœ¨æ¯ä¸¤ä¸ªç›¸é‚»çš„ SELECT ä¸­</li><li>æ¯ä¸ª SELECT æŸ¥è¯¢çš„æ•°æ®ç›¸åŒ</li><li>åˆ—çš„æ•°æ®ç±»å‹å¿…é¡»æ˜¯å…¼å®¹çš„</li></ol><h2 id="é‡å¤çš„è¡Œ"><a href="#é‡å¤çš„è¡Œ" class="headerlink" title="é‡å¤çš„è¡Œ"></a>é‡å¤çš„è¡Œ</h2><p>ä¸¤ä¸ªæŸ¥è¯¢çš„æ¡ä»¶éƒ½æ»¡è¶³å´ UNION ï¼Œé‡å¤çš„è¡Œä¼šè¢« UNIQUEï¼Œä½†æ˜¯ å¦‚æœä½¿ç”¨<code>UNION ALL</code>, åˆ™ä¸å–æ¶ˆé‡å¤çš„è¡Œã€‚</p><h2 id="æ’åº"><a href="#æ’åº" class="headerlink" title="æ’åº"></a>æ’åº</h2><p>å†æœ€åä¸€ä¸ªSELECTåï¼Œé“¾å¼ç”¨ <code>ORDER BY</code>æ’åº</p><h2 id="ç»„åˆä¸åŒè¡¨"><a href="#ç»„åˆä¸åŒè¡¨" class="headerlink" title="ç»„åˆä¸åŒè¡¨"></a>ç»„åˆä¸åŒè¡¨</h2><p>å®é™…ä¸Šæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼ŒUNIONæ˜¯æŠŠæœç´¢çš„ç»“æœåšä¸€ä¸ªäº¤é›†ï¼ŒåŒæ ·æˆ‘ä»¬ä¹Ÿå¯ä½¿ç”¨ä¸åŒçš„è¡¨ï¼Œä½†æ˜¯éœ€è¦åŒæ ·çš„ schemaï¼Œä¾‹å¦‚ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Select</span> Col1, Col2, Col3, Col4, Col5 <span class="keyword">from</span> Table1</span><br><span class="line"><span class="keyword">Union</span></span><br><span class="line"><span class="keyword">Select</span> Col1, Col2, Col3, <span class="keyword">Null</span> <span class="keyword">as</span> Col4, <span class="keyword">Null</span> <span class="keyword">as</span> Col5 <span class="keyword">from</span> Table2</span><br></pre></td></tr></table></figure><p>Python:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sqlalchemy.orm <span class="keyword">import</span> aliased</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Part</span>(<span class="title class_ inherited__">Base</span>):</span><br><span class="line">    __tablename__ = <span class="string">&#x27;part&#x27;</span></span><br><span class="line">    part = Column(String, primary_key=<span class="literal">True</span>)</span><br><span class="line">    sub_part = Column(String, primary_key=<span class="literal">True</span>)</span><br><span class="line">    quantity = Column(Integer)</span><br><span class="line"></span><br><span class="line">included_parts = session.query(</span><br><span class="line">                Part.sub_part,</span><br><span class="line">                Part.part,</span><br><span class="line">                Part.quantity).\</span><br><span class="line">                    <span class="built_in">filter</span>(Part.part==<span class="string">&quot;our part&quot;</span>).\</span><br><span class="line">                    cte(name=<span class="string">&quot;included_parts&quot;</span>, recursive=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">incl_alias = aliased(included_parts, name=<span class="string">&quot;pr&quot;</span>)</span><br><span class="line">parts_alias = aliased(Part, name=<span class="string">&quot;p&quot;</span>)</span><br><span class="line">included_parts = included_parts.union_all(</span><br><span class="line">    session.query(</span><br><span class="line">        parts_alias.sub_part,</span><br><span class="line">        parts_alias.part,</span><br><span class="line">        parts_alias.quantity).\</span><br><span class="line">            <span class="built_in">filter</span>(parts_alias.part==incl_alias.c.sub_part)</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">q = session.query(</span><br><span class="line">        included_parts.c.sub_part,</span><br><span class="line">        func.<span class="built_in">sum</span>(included_parts.c.quantity).</span><br><span class="line">            label(<span class="string">&#x27;total_quantity&#x27;</span>)</span><br><span class="line">    ).\</span><br><span class="line">    group_by(included_parts.c.sub_part)</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">included_parts = session.query(</span><br><span class="line">                Part.sub_part,</span><br><span class="line">                Part.part,</span><br><span class="line">                Part.quantity).\</span><br><span class="line">                    <span class="built_in">filter</span>(Part.part==<span class="string">&quot;our part&quot;</span>).\</span><br><span class="line">                    cte(name=<span class="string">&quot;included_parts&quot;</span>, recursive=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure><p>å’Œ</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">included_parts = included_parts.union_all(</span><br><span class="line">    session.query(</span><br><span class="line">        parts_alias.sub_part,</span><br><span class="line">        parts_alias.part,</span><br><span class="line">        parts_alias.quantity).\</span><br><span class="line">            <span class="built_in">filter</span>(parts_alias.part==incl_alias.c.sub_part)</span><br><span class="line">    )</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨äº†<code>UNION ALL</code></p><blockquote><p>å½“ç„¶ï¼Œè¿™ä¸ªæˆ‘è§‰å¾—å¾ˆå¤§ç¨‹åº¦ä¸Šå’Œä½¿ç”¨<code>WHERE</code> + <code>AND</code>/<code>OR</code> ç­‰æ˜¯ç­‰ä»·çš„ã€‚</p></blockquote><h1 id="SQLAlchemy-amp-MySQL-å¤‡å¿˜-å…³ç³»-relationship-ä¸è¿æ¥-join"><a href="#SQLAlchemy-amp-MySQL-å¤‡å¿˜-å…³ç³»-relationship-ä¸è¿æ¥-join" class="headerlink" title="SQLAlchemy &amp; MySQL å¤‡å¿˜: å…³ç³»(relationship)ä¸è¿æ¥(join)"></a>SQLAlchemy &amp; MySQL å¤‡å¿˜: å…³ç³»(relationship)ä¸è¿æ¥(join)</h1><p>è®¾è®¡è‰¯å¥½ï¼Œèƒ½å¤Ÿä¸çŠ¯å¤ªå¤šäº‹çš„æƒ…å†µä¸‹å¥½å¥½æ·»åŠ çš„æ•°æ®åº“ç§°ä¹‹ä¸º å¯ä¼¸ç¼©æ€§å¥½(scale well).</p><h1 id="é‡ç‚¹"><a href="#é‡ç‚¹" class="headerlink" title="é‡ç‚¹"></a>é‡ç‚¹</h1><ol><li>å­è¡¨ç±»ç”¨foreign keyå¼•ç”¨çˆ¶è¡¨ç±», å¤–é”®å®šä¹‰äº†ä¸¤å¼ è¡¨çš„å…³ç³»ã€‚</li><li><code>students = db.relationship(&#39;Student&#39;, backref=&#39;_class&#39;, lazy=&quot;select&quot;)</code> STUDENTSæ˜¯å­å¯¹è±¡çš„åˆ—è¡¨ã€‚</li></ol><h2 id="æ¦‚å¿µ-1"><a href="#æ¦‚å¿µ-1" class="headerlink" title="æ¦‚å¿µ"></a>æ¦‚å¿µ</h2><p><strong>ç›®æ ‡ï¼šæˆ‘ä»¬å¸Œæœ›å‚¨å­˜åœ¨å¤šä¸ªè¡¨ï¼Œç›¸å…³è”çš„æ•°æ®èƒ½è¢«ä¸€ä¸ªæŸ¥è¯¢æ‰¾å‡ºæ¥ã€‚</strong></p><p>æ˜¾ç„¶æˆ‘ä»¬å·²ç»çŸ¥é“æ¯ä¸ªè¡¨æœ‰å”¯ä¸€æ ‡è¯†ï¼Œè¢«ç§°ä¸ºä¸»é”®ã€‚</p><p>å¤–é”®æ˜¯ä¸€ä¸ªè¡¨ä¸­çš„ä¸€åˆ—ï¼ŒåŒ…å«äº†å¦ä¸€ä¸ªè¡¨å•çš„ä¸»é”®ï¼Œå®šä¹‰äº†æ•°æ®åº“çš„è¡¨é—´çš„å…³ç³»</p><p>è”ç»“æ˜¯ä¸€ç§æœºåˆ¶ï¼Œåœ¨ä¸€æ¡<code>select</code>è¯­å¥ä¸­å¤„ç†å…³è”è¡¨ã€‚å®ƒå¹¶ä¸åœ¨æ•°æ®åº“ä¸­å®é™…å­˜åœ¨ï¼Œè€Œæ˜¯ä¸€ç§æ“ä½œã€‚</p><h2 id="ç­‰å€¼è”ç»“-equijoin"><a href="#ç­‰å€¼è”ç»“-equijoin" class="headerlink" title="ç­‰å€¼è”ç»“(equijoin)"></a>ç­‰å€¼è”ç»“(equijoin)</h2><p>è¿™é‡Œåªç”¨åˆ°äº†SELECT FROM WHEREï¼Œä¸è¿‡æœ‰ä¸¤å¼ è¡¨ï¼Œå¹¶ä¸”åœ¨whereä¸­è¯¦ç»†æ ‡æ³¨äº†(å®Œå…¨é™å®šåˆ—å)ã€‚</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> col <span class="keyword">from</span> tables <span class="keyword">where</span> table1 x table2 <span class="operator">=</span> ... <span class="keyword">order</span> <span class="keyword">by</span> ...</span><br></pre></td></tr></table></figure><p>å¯ä»¥ æˆåŠŸåœ¨ä¸¤å¼ è¡¨ä¸­æœç´¢</p><p>æ²¡æœ‰whereçš„è¯ä½ ä¼šå¾ˆå…´å¥‹çš„çœ‹åˆ°ç¬›å¡å°”ç§¯ã€‚ä½œä¸ºä¿è¯æˆ‘ä»¬å¸Œæœ›æ‰€æœ‰å­å¥éƒ½å«æœ‰where.</p><h2 id="å†…éƒ¨è”ç»“-Inner-Join"><a href="#å†…éƒ¨è”ç»“-Inner-Join" class="headerlink" title="å†…éƒ¨è”ç»“(Inner Join)"></a>å†…éƒ¨è”ç»“(Inner Join)</h2><p>å…³é”®å­—æ˜¯ <code>INNER JOIN</code> å’Œ <code>ON</code>ã€‚</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> cols <span class="keyword">FROM</span> table1 <span class="keyword">INNER</span> <span class="keyword">JOIN</span> table2 <span class="keyword">ON</span> cond</span><br></pre></td></tr></table></figure><p>äº‹å®ä¸Šé¦–é€‰æ˜¯ <code>Inner Join</code></p><h2 id="å¤šè¡¨è”ç»“"><a href="#å¤šè¡¨è”ç»“" class="headerlink" title="å¤šè¡¨è”ç»“"></a>å¤šè¡¨è”ç»“</h2><p>é€‰æ‹©çš„è¡¨æ•°ç›®æ²¡æœ‰é™åˆ¶ï¼Œä½†æ˜¯è¡¨çš„æ•°é‡è¶Šå¤šï¼Œæ•°æ®åº“æŸ¥æ‰¾é€Ÿåº¦ä¸‹é™è¶Šå¿«ã€‚</p><p>ä¹Ÿå¯ä»¥é€‰æ‹©select fromå¤šä¸ªè¡¨ï¼Œç„¶åwhereå¤„æŒ‡å®šæ¡ä»¶</p><p>åœ¨Aå­—æ®µå®šä¹‰Bçš„relationshipå®Œæˆäº†Aæœ‰å¤šä¸ªBçš„å…³ç³»</p><h2 id="è¡¨çš„åˆ«å"><a href="#è¡¨çš„åˆ«å" class="headerlink" title="è¡¨çš„åˆ«å"></a>è¡¨çš„åˆ«å</h2><p><code>FROM table1 as t1, table2 as t2</code> å…è®¸ä½ åœ¨æŸ¥è¯¢ä¸­ä½¿ç”¨åˆ«åå¹¶ä¸åé¦ˆåˆ°åˆ—ä¸­ã€‚</p><h2 id="è‡ªè”ç»“"><a href="#è‡ªè”ç»“" class="headerlink" title="è‡ªè”ç»“"></a>è‡ªè”ç»“</h2><p>ä¸€ä¸ªè¡¨é‡Œæœ‰æ‰€æœ‰ç§‘ç›®çš„æ‰€æœ‰æˆç»©(ä¸è¦é—®æˆ‘ä¸ºä»€ä¹ˆè¿™ä¹ˆè®¾è®¡)ï¼Œæˆ‘ä»¬æƒ³æ‰¾åˆ°é«˜ç­‰æ•°å­¦æŒ‚ç§‘çš„äººï¼Œçœ‹çœ‹ä»–çš„æ¦‚ç‡ç»Ÿè®¡æ˜¯ä¸æ˜¯ä¹ŸæŒ‚äº†.</p><p>å¯ä»¥åˆ©ç”¨è¡¨åˆ«å, ç»™åŒä¸€ä¸ªè¡¨å¤šä¸ªåˆ«åï¼Œå®ŒæˆæŸ¥è¯¢æ“ä½œã€‚</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> p1.mathgrade, p2.xxx <span class="keyword">FROM</span> students <span class="keyword">as</span> p1, students <span class="keyword">AS</span> p2 <span class="keyword">WHERE</span> p1.(cond) <span class="keyword">AND</span> p2.(cond)</span><br></pre></td></tr></table></figure><h2 id="è‡ªç„¶è”ç»“"><a href="#è‡ªç„¶è”ç»“" class="headerlink" title="è‡ªç„¶è”ç»“"></a>è‡ªç„¶è”ç»“</h2><p>ç›®çš„ï¼šè‡³å°‘æœ‰ä¸€ä¸ªåˆ—(å­—æ®µ)å‡ºç°åœ¨ä¸æ­¢ä¸€ä¸ªè¡¨ä¸­ï¼Œè‡ªç„¶è”ç»“è®©æ¯ä¸ªåˆ—è¿”å›ä¸€æ¬¡ã€‚äº‹å®ä¸Šæˆ‘ä»¬åšçš„éƒ½æ˜¯è‡ªç„¶è”ç»“ã€‚</p><p>R Sä¸­ï¼Œå¦‚æœRä¸­çš„ä¸€è¡Œrå’ŒSä¸­çš„ä¸€è¡Œsåœ¨$R\cap S$ ä¸­çš„å€¼ç›¸ç­‰ï¼Œåˆ™å°†å…¶è¿æ¥</p><h2 id="å¤–éƒ¨è”ç»“"><a href="#å¤–éƒ¨è”ç»“" class="headerlink" title="å¤–éƒ¨è”ç»“"></a>å¤–éƒ¨è”ç»“</h2><p>è”ç»“æŠŠæœ‰å¤–é”®å…³è”çš„è¡Œè”ç»“ã€‚ä½†æ˜¯æœ‰çš„æ—¶å€™æˆ‘ä»¬å¸Œæœ›ç»Ÿè®¡æ²¡å…³è”çš„è¡Œã€‚</p><p>æœ‰çš„æ—¶å€™ä¹Ÿå¸Œæœ›å…³è”æ²¡æœ‰å…³è”çš„è¡Œï¼Œè¿™é‡Œå£è¿°ä¸æ˜¯å¾ˆèƒ½è¯´æ¸…ï¼Œå¤§æ¦‚ç›¸å½“äºå·¦ï¼å³è”ç»“çš„æ—¶å€™ï¼Œå¦‚æœå¦ä¸€ä¾§æ²¡æœ‰è”ç»“çš„<code>ON ...</code>æ•°æ®ï¼Œåˆ™ä¸º<code>æœ¬ä¾§ | null</code> çš„å½¢å¼ã€‚</p><p>å¯ä»¥ç…ä¸€çœ¼<a href="http://www.cnblogs.com/youzhangjin/archive/2009/05/22/1486982.html">è¿™é‡Œçš„DEMO</a></p><p>ä½¿ç”¨ <code>LEFT OUTER JOIN</code> <code>RIGHT OUTER JOIN</code> è¡¨ç¤ºè¿™ç§å¤–éƒ¨è”ç»“ã€‚</p><h2 id="å¸¦èšé›†å‡½æ•°çš„è”ç»“"><a href="#å¸¦èšé›†å‡½æ•°çš„è”ç»“" class="headerlink" title="å¸¦èšé›†å‡½æ•°çš„è”ç»“"></a>å¸¦èšé›†å‡½æ•°çš„è”ç»“</h2><p>ç›®çš„ï¼šå¸Œæœ›å¯¹è”ç»“åå¾—åˆ°çš„é‚£å¼ è¡¨è¿›è¡Œåˆ†ç»„</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT ..., COUNT(,,,) AS ... FROM table1 INNER JOIN table2 GROUP BY ...;</span><br></pre></td></tr></table></figure><p>WORKFLOWï¼š<br>å†…è”ç»“ â€“ &gt; åˆ†ç»„ â€“ &gt; ç­›é€‰å‡ºæ¥</p><h1 id="SQLAlchemy"><a href="#SQLAlchemy" class="headerlink" title="SQLAlchemy"></a>SQLAlchemy</h1><p>relationshipç¬¬ä¸€ä¸ªå­—æ®µåŸºäºç±»åï¼Œå¯ä»¥ä¸backrefç­‰åˆèµ·æ¥æ„æˆåå‘ç´¢å¼•</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; from sqlalchemy import ForeignKey</span><br><span class="line">&gt;&gt;&gt; from sqlalchemy.orm import relationship</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; class Address(Base):</span><br><span class="line">...     __tablename__ = &#x27;addresses&#x27;</span><br><span class="line">...     id = Column(Integer, primary_key=True)</span><br><span class="line">...     email_address = Column(String, nullable=False)</span><br><span class="line">...     user_id = Column(Integer, ForeignKey(&#x27;users.id&#x27;))</span><br><span class="line">...</span><br><span class="line">...     user = relationship(&quot;User&quot;, back_populates=&quot;addresses&quot;)</span><br><span class="line">...</span><br><span class="line">...     def __repr__(self):</span><br><span class="line">...         return &quot;&lt;Address(email_address=&#x27;%s&#x27;)&gt;&quot; % self.email_address</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; User.addresses = relationship(</span><br><span class="line">...     &quot;Address&quot;, order_by=Address.id, back_populates=&quot;user&quot;)</span><br></pre></td></tr></table></figure><p>ForeignKeyçº¦æŸæŒ‡colè¢«çº¦æŸä¸ºå…¶ä»–åœ°æ–¹åº”å½“å­˜åœ¨çš„å€¼ã€‚foreignkeyå‚æ•°æŒ‡å®šçš„äº‹table name</p><p>Address.useræ˜¯å¤šå¯¹ä¸€å…³ç³»ã€‚ä»¥ä¸Šå¸‚åˆ¶å®šäº†back_populatesçš„æƒ…å†µï¼Œå¹¶ä¸”äº’ç›¸æ ‡æ¸…å‡ºäº†å­—æ®µçš„åç§°ï¼Œbackrefåªèƒ½åœ¨å­è¡¨å®šä¹‰foreign_ky</p><p>åœ¨ä¸€å¯¹å¤šå…³ç³»ä¸­ï¼Œå­è¡¨ForeignKeyåº”ç”¨çˆ¶è¡¨å‚è€ƒå­—æ®µã€‚</p><h2 id="ä¸€å¯¹ä¸€å…³ç³»"><a href="#ä¸€å¯¹ä¸€å…³ç³»" class="headerlink" title="ä¸€å¯¹ä¸€å…³ç³»"></a>ä¸€å¯¹ä¸€å…³ç³»</h2><p><code>child = relationship(&quot;Child&quot;, uselist=False, back_populates=&quot;parent&quot;)</code><br>uselist = falseï¼Œè®¾ç½®ä¸€å¯¹ä¸€å…³ç³»</p><p>ä¹Ÿå¯ä»¥<br><code>child = relationship(&quot;Child&quot;, backref=backref(&quot;parent&quot;, uselist=False))</code></p><blockquote><p>æ³¨æ„åœ¨åº”ç”¨å…³ç³»çš„è¿‡ç¨‹ä¸­ï¼ŒORMæ¨¡å‹å¯ä»¥é€šè¿‡<code>Father.child</code>è¡¨ç¤ºå¯¹åº”çš„å¯¹è±¡ï¼Œä½†æ˜¯è¿™ä¸ªå¯¹è±¡æ˜¯é foreigning keyå­˜å‚¨åœ¨referencing tableä¸­çš„ã€‚</p><p>å› ä¸ºä»¥ä¸Šçš„æ„¿æ„ï¼Œæ‰€ä»¥æœ‰lazy = â€œxxxâ€ çš„å±æ€§ï¼Œæ¥è¡¨ç¤ºè¿™ä¸ªå±æ€§æ˜¯å¦æ˜¯</p></blockquote><h2 id="å¤šå¯¹å¤šå…³ç³»"><a href="#å¤šå¯¹å¤šå…³ç³»" class="headerlink" title="å¤šå¯¹å¤šå…³ç³»"></a>å¤šå¯¹å¤šå…³ç³»</h2><p>æ¯”å¦‚äºº-å…³æ³¨-äºº<br>é‡‡ç”¨ä¸€å¼ ä¸­é—´è¡¨</p><h1 id="SQLAlchemy-å…³ç³»æ“ä½œ"><a href="#SQLAlchemy-å…³ç³»æ“ä½œ" class="headerlink" title="SQLAlchemy : å…³ç³»æ“ä½œ"></a>SQLAlchemy : å…³ç³»æ“ä½œ</h1><ul><li>joinæ“ä½œä½œç”¨åœ¨queryå¯¹è±¡ä¸Š</li><li>å¯¹å…³ç³»æ“ä½œï¼Œè¿”å›æ˜¯å¯¹è±¡</li></ul><h2 id="es"><a href="#es" class="headerlink" title="es"></a>es</h2><p>ä¸€å¯¹å¤šçš„å¤šï¼Œè°ƒç”¨å­—æ®µ(å¯¹è±¡çš„å­—æ®µ/å±æ€§)æŸ¥è¯¢ä¼šè¿”å›åˆ—è¡¨ã€‚</p><h2 id="joinæ“ä½œ"><a href="#joinæ“ä½œ" class="headerlink" title="joinæ“ä½œ"></a>joinæ“ä½œ</h2><p>æŒ‡å®šäº†<br>joinæŒ‡å®šæ¡ä»¶ï¼Œä¸¤è¡¨è¿æ¥æŸ¥è¯¢ã€‚</p><blockquote><p>å¯¹åº”äº†SQLä¸­çš„è”ç»“çš„å…³ç³»</p></blockquote><p>ä»¥ä¸‹éšå¼çš„æŒ‡å®šidä¸ºç›¸åŒ key æ¥è¿›è¡ŒæŸ¥è¯¢</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>session.query(User).join(Address).\</span><br><span class="line"><span class="meta">... </span>        <span class="built_in">filter</span>(Address.email_address==<span class="string">&#x27;jack@google.com&#x27;</span>).\</span><br><span class="line"><span class="meta">... </span>        <span class="built_in">all</span>()</span><br><span class="line">[&lt;User(name=<span class="string">&#x27;jack&#x27;</span>, fullname=<span class="string">&#x27;Jack Bean&#x27;</span>, password=<span class="string">&#x27;gjffdd&#x27;</span>)&gt;]</span><br></pre></td></tr></table></figure><p>Query.join() knows how to join between User and Address because thereâ€™s only one foreign key between them. If there were no foreign keys, or several, Query.join() works better when one of the following forms are used:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">query.join(User.addresses)                       </span><br><span class="line"># specify relationship from left to right</span><br><span class="line">query.join(Address, User.addresses)              # same, with explicit target</span><br><span class="line">query.join(&#x27;addresses&#x27;)                          # same, using a string</span><br></pre></td></tr></table></figure><p>joinæ“ä½œæŒ‡çš„æ˜¯å¯¹äºä¸¤å¼ æˆ–è€…å¤šå¼ è¡¨ï¼Œç»™å®šå…±åŒçš„æ¡ä»¶å¹¶ä¸”å¯¹äºå…±åŒçš„æ¡ä»¶æ¥è¿›è¡ŒæŸ¥è¯¢</p><p>å› ä¸ºæŸ¥è¯¢çš„æ˜¯join, æ‰€ä»¥æŸ¥è¯¢çš„é¡ºåºæ˜¯(Aå¯¹è±¡, Bå¯¹è±¡)</p><p>åœ¨è¿™é‡Œé€šè¿‡å¯¹queryå¯¹è±¡æ“ä½œæ¥äº§ç”Ÿæ–°çš„ queryå¯¹è±¡ï¼Œå¯ä»¥æŒ‡å®š</p><ol><li><p>æ˜ç¡®çš„æ¡ä»¶</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">query.join(Address, User.id==Address.user_id)   </span><br><span class="line"># explicit condition</span><br></pre></td></tr></table></figure></li><li><p>ä¸€ä¸ªé”®çš„å…³è”</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">query.join(User.addresses)</span><br><span class="line"># pecify relationship from left to right</span><br></pre></td></tr></table></figure></li><li><p>è¢«å…³è”çš„å­—æ®µ-å…³è”å­—æ®µå¤–é”®</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">query.join(Address, User.addresses)</span><br></pre></td></tr></table></figure></li><li><p>å­—æ®µå­—ç¬¦ä¸²å</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">query.join(&#x27;addresses&#x27;)                          </span><br><span class="line"># same, using a string</span><br></pre></td></tr></table></figure></li><li><p>outerjoin<code>query.outerjoin(User.addresses)</code></p></li></ol><h3 id="å¤šä¸ªentityçš„è¿”å›å€¼ç¡®å®š"><a href="#å¤šä¸ªentityçš„è¿”å›å€¼ç¡®å®š" class="headerlink" title="å¤šä¸ªentityçš„è¿”å›å€¼ç¡®å®š"></a>å¤šä¸ªentityçš„è¿”å›å€¼ç¡®å®š</h3><p><code>query = session.query(User, Address).select_from(Address).join(User)</code><br>select_fromæŒ‡å®šäº†æŸ¥è¯¢è¿”å›å€¼çš„ç±»å‹ï¼Œå¦åˆ™joinæœ€å·¦ä¾§çš„é¡¹</p><h2 id="SQLAlchemy-MySQLå¤‡å¿˜ï¼šå­æŸ¥è¯¢"><a href="#SQLAlchemy-MySQLå¤‡å¿˜ï¼šå­æŸ¥è¯¢" class="headerlink" title="SQLAlchemy-MySQLå¤‡å¿˜ï¼šå­æŸ¥è¯¢"></a>SQLAlchemy-MySQLå¤‡å¿˜ï¼šå­æŸ¥è¯¢</h2><p>#SQLAlchemy-MySQLå¤‡å¿˜ï¼šå­æŸ¥è¯¢å’Œé›†åˆ</p><h2 id="æ¦‚å¿µ-2"><a href="#æ¦‚å¿µ-2" class="headerlink" title="æ¦‚å¿µ"></a>æ¦‚å¿µ</h2><p>ä»»ä½•SQLè¯­å¥éƒ½æ˜¯æŸ¥è¯¢ï¼Œè™½ç„¶ä¸€èˆ¬æŸ¥è¯¢æŒ‡çš„æ˜¯select</p><p>SQLå…è®¸åˆ›å»ºå­æŸ¥è¯¢(subquery)</p><p>å­æŸ¥è¯¢æŒ‡çš„æ˜¯ç›¸å½“äºæŸ¥è¯¢å¥—æŸ¥è¯¢ã€‚ä¸€èˆ¬æˆ‘ä»¬æ˜¯å¸Œæœ›å¤„ç†å¤šä¸ªè¡¨ä¸­çš„æ•°æ®ï¼ˆæ¯”æ–¹è¯´æŸgå¼€å¤´çš„è€å¸æœºæƒ³é»‘æˆ‘çš„å·ï¼Œå°±è°ƒç”¨è±†ç“£ github çš„æ•°æ®åº“æ‰€æœ‰é‚®ç®±ä¸º 1506118561@qq.comçš„å·ã€‚ï¼‰</p><p>ç¼–å†™æ—¶å»ºè®®å‘ä¸‹æ–¹è¿™æ ·åˆ†æˆå¤šè¡Œã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SELECT col FROM table1 WHERE col2 IN (</span><br><span class="line">    SELECT ...</span><br><span class="line">)</span><br></pre></td></tr></table></figure><h2 id="ä½¿ç”¨æ³¨æ„"><a href="#ä½¿ç”¨æ³¨æ„" class="headerlink" title="ä½¿ç”¨æ³¨æ„"></a>ä½¿ç”¨æ³¨æ„</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">WHERE v1, v2 IN (SELECT r1, r2 FROM TABLE)</span><br></pre></td></tr></table></figure><p>æœ€å¸¸è§çš„å­æŸ¥è¯¢æ˜¯åœ¨ WHERE å’Œ IN ä¸­ï¼Œåœ¨é™å®šçš„tupleï¼ˆè¡Œï¼‰ä¸­åšæŸ¥è¯¢ã€‚</p><p>SELECTè¿”å›çš„æ˜¯é€‰å‡ºè¡Œæ•°æ®çš„tupleï¼Œéœ€è¦æ‹¥æœ‰ç›¸åŒçš„åˆ—</p><p>å­æŸ¥è¯¢æ•ˆæœä¸ä¸€å®šæ¯”çš„ä¸Šè”ç»“</p><p>å­æŸ¥è¯¢éœ€è¦<strong>å®Œå…¨æ¯”è¾ƒåˆ—å</strong>ï¼Œå› ä¸ºå¯èƒ½æœ‰å¤šä¹‰æ€§ï¼Œæ¯”æ–¹è¯´ä¸€å®šè¦æ‰§è¡Œ<code>a.x = b.x</code></p><p>éœ€è¦å¯¹æ‰€æœ‰æˆå‘˜è®¡ç®—(æ¯”æ–¹è¯´å¯¹æ¡ä»¶ä¸­çš„æˆå‘˜ç”¨COUNT(*)è®¡ç®—æ€»æ•°ç›®)ï¼Œå¯ä»¥é‡‡ç”¨å­æŸ¥è¯¢ã€‚</p><h2 id="ç›¸å…³å­æŸ¥è¯¢"><a href="#ç›¸å…³å­æŸ¥è¯¢" class="headerlink" title="ç›¸å…³å­æŸ¥è¯¢"></a>ç›¸å…³å­æŸ¥è¯¢</h2><p>æ¶‰åŠå¤–éƒ¨åˆ—çš„å­æŸ¥è¯¢ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(SELECT r1 form TABLE_IN WHERE TABLE_IN.name = TABLE_OUT.name)</span><br></pre></td></tr></table></figure><p>éœ€è¦æˆ‘ä»¬é™åˆ¶æœ‰æ­§ä¹‰çš„åˆ—åã€‚</p><p>å¯ä»¥åœ¨ä»¥ä¸‹çš„é“¾æ¥æŸ¥çœ‹å­æŸ¥è¯¢ç›¸å…³ç†è®ºã€‚</p><p><a href="http://blog.csdn.net/raptor/article/details/48735159">http://blog.csdn.net/raptor/article/details/48735159</a></p><p>ä¹Ÿå¯ä»¥ä½¿ç”¨ä¸€ç»„tupleè¡¨ç¤ºç›¸å…³çš„å†…å®¹</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">SELECT COUNT(DISTINCT id)</span><br><span class="line">FROM takes</span><br><span class="line">WHERE (attr1, attr2, attr3) in</span><br><span class="line">(</span><br><span class="line">    SELECT attr1, attr2, attr3</span><br><span class="line">    FROM ...</span><br><span class="line">    WHERE</span><br><span class="line">)</span><br></pre></td></tr></table></figure><h2 id="é›†åˆçš„æ¯”è¾ƒ-some-any-allâ€¦"><a href="#é›†åˆçš„æ¯”è¾ƒ-some-any-allâ€¦" class="headerlink" title="é›†åˆçš„æ¯”è¾ƒ: some, any, allâ€¦"></a>é›†åˆçš„æ¯”è¾ƒ: some, any, allâ€¦</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">SELECT name </span><br><span class="line">FROM table</span><br><span class="line">WHERE table.attr1 &gt; SOME (</span><br><span class="line">    SELECT attr2...</span><br><span class="line">    FROM ..</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>ä»tableä¸­æ‰¾å‡ºnameï¼Œç„¶åä½¿å…¶å¤§äºä¹‹æŸ¥è¯¢çš„æŸä¸€ä¸ª(åªè¦æ‰¾åˆ°ä¸€ä¸ªå³å¯).</p><p>åŒæ—¶ï¼Œ<code>&lt;some</code>, <code>&gt;=some</code> ç­‰æ¯”è¾ƒæ“ä½œåœ¨è¿™é‡Œä¹Ÿæ˜¯å—æ”¯æŒçš„ã€‚</p><p>æœ‰<code>all</code>ç­‰æ“ä½œï¼Œè¡¨ç¤ºæ¯ä¸€ä¸ª</p><h2 id="ç©ºå…³ç³»æŸ¥æ‰¾ä¸åˆ¤æ–­ï¼š-exists"><a href="#ç©ºå…³ç³»æŸ¥æ‰¾ä¸åˆ¤æ–­ï¼š-exists" class="headerlink" title="ç©ºå…³ç³»æŸ¥æ‰¾ä¸åˆ¤æ–­ï¼š exists"></a>ç©ºå…³ç³»æŸ¥æ‰¾ä¸åˆ¤æ–­ï¼š exists</h2><ul><li>é¦–å…ˆæˆ‘ä»¬å¾—æ˜ç¡®ä¸€ç‚¹ï¼Œä¹‹æŸ¥è¯¢çš„å¤–ç•Œçš„å€¼å¯ä»¥ä»£å…¥å­æŸ¥è¯¢å†…ã€‚ä½¿ç”¨äº†å¤–å±‚æŸ¥è¯¢ç›¸å…³çš„å«ç›¸å…³å­æŸ¥è¯¢</li></ul><p>æ‰¾å‡ºç¬¦åˆä¸¤ä¸ªæ¡ä»¶çš„</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">SELECT value1</span><br><span class="line">FROM table as T</span><br><span class="line">WHERE value1 = &quot;&quot; and value2=&quot;&quot;</span><br><span class="line">and EXISTS (</span><br><span class="line">    SELECT * FROM table as S</span><br><span class="line">    where T.name = S.name</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>ä»¥ä¸Šæ‰¾åˆ°v1 = v2, è€Œä¸”æ»¡è¶³å†…éƒ¨æ¡ä»¶çš„è¡Œ</p><p>å†ç»™å‡ºä¸€ä¸ªèŒƒä¾‹ï¼šå¯¹äºå­¦ç”Ÿé€‰ä¿®çš„è¯¾ç¨‹ï¼Œçœ‹çœ‹å“ªäº›å­¦ç”Ÿé€‰ä¿®çš„è¯¾ç¨‹åŒ…å«ç”Ÿç‰©ç³»çš„è¯¾ç¨‹ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">SELECT S.ID, S.name</span><br><span class="line">FROM students AS S  // å­¦ç”Ÿçš„è¡¨</span><br><span class="line">WHERE NOT EXISTS (</span><br><span class="line">    (SELECT ... )</span><br><span class="line">    EXCEPT</span><br><span class="line">    (SELECT ... )</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p><code>NOT EXISTS (B EXCEPT A)</code> â€“&gt; å…³ç³»AåŒ…å«å…³ç³»Bï¼Œå³B - A = ç©ºé›†, å®é™…ä¸Šè¡¨ç¤ºBåŒ…å«äºAã€‚</p><p>è¿™ä¸ªå¯ä»¥ç”¨äºä¸€å®šçš„å¤æ‚çš„é€»è¾‘ï¼Œä»¥ä¸Šæ˜¯åŒ…å«ç”Ÿç‰©ç³»è¯¾ç¨‹ï¼Œä»¥ä¸‹çš„é€»è¾‘è¡¨ç¤ºï¼šæ­¤äººé€‰è¯¾åŒ…æ‹¬äº†ç”Ÿç‰©ç³»çš„æ‰€æœ‰è¯¾ç¨‹</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">SELECT S.ID, S.name</span><br><span class="line">FROM students AS S  // å­¦ç”Ÿçš„è¡¨</span><br><span class="line">WHERE NOT EXISTS (</span><br><span class="line">    (</span><br><span class="line">        SELECT course_id</span><br><span class="line">        FROM classes JOIN take USING(class_id)</span><br><span class="line">        WHERE </span><br><span class="line">    )</span><br><span class="line">    EXCEPT</span><br><span class="line">    (SELECT ... )</span><br><span class="line">)</span><br></pre></td></tr></table></figure><h2 id="é‡å¤è¡Œçš„å­˜åœ¨æ€§æµ‹è¯•"><a href="#é‡å¤è¡Œçš„å­˜åœ¨æ€§æµ‹è¯•" class="headerlink" title="é‡å¤è¡Œçš„å­˜åœ¨æ€§æµ‹è¯•"></a>é‡å¤è¡Œçš„å­˜åœ¨æ€§æµ‹è¯•</h2><p>å¯¹â€œæ˜¯å¦å­˜åœ¨â€è¿™ä¸ªç‰¹å¾è¿›è¡Œåˆ¤æ–­ã€‚<br>ä¾‹å­ï¼š2009å¹´è‡³å°‘å¼€è®¾ä¸¤æ¬¡çš„è¯¾ç¨‹</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">SELECT course_name, course_id </span><br><span class="line">FROM courses</span><br><span class="line">WHERE not unique (</span><br><span class="line">    SELECT C1.course_id</span><br><span class="line">    FROM courses as C1,</span><br><span class="line">        courses as C2</span><br><span class="line">    WHERE C1.course_id = C2.course_id</span><br><span class="line">    AND C1.year = 2009</span><br><span class="line">)</span><br></pre></td></tr></table></figure><h2 id="from-å­å¥ä¸­çš„å­æŸ¥è¯¢"><a href="#from-å­å¥ä¸­çš„å­æŸ¥è¯¢" class="headerlink" title="from å­å¥ä¸­çš„å­æŸ¥è¯¢"></a>from å­å¥ä¸­çš„å­æŸ¥è¯¢</h2><p>æŠŠfromçš„å†…å®¹å½“æˆä¸€ä¸ªå­æŸ¥è¯¢è¿”å›çš„è¡¨ã€‚</p><p>ä¾‹å­ï¼šé€‰å‡ºå·¥èµ„å¤§äº42000çš„ç³»çš„æˆå‘˜çš„å¹³å‡å·¥èµ„</p><p>â€“&gt; æ€»æ„Ÿè§‰è·Ÿåˆ†ç»„æŸ¥è¯¢æ²¡ä»€ä¹ˆå¾ˆå¤§çš„åŒºåˆ«â€¦</p><h2 id="with-å­å¥çš„ä½¿ç”¨"><a href="#with-å­å¥çš„ä½¿ç”¨" class="headerlink" title="with å­å¥çš„ä½¿ç”¨"></a>with å­å¥çš„ä½¿ç”¨</h2><p>åŠŸèƒ½ï¼šå®šä¹‰ä¸´æ—¶å…³ç³»ï¼Œåªå¯¹è¿™å¥è¯æœ‰æ•ˆã€‚å’Œfrom selectå­æŸ¥è¯¢æ˜¯ç­‰ä»·çš„ï¼Œä½†æ˜¯ç›¸å½“äºè¯­æ³•ç³–ï¼Œèƒ½å¤Ÿè¡¨ç°çš„æ›´åŠ æ¸…æ™°ã€‚</p><p>ï¼ˆæ€»è§‰å¾—æœ‰ç‚¹åƒè§†å›¾ï¼Œè§†å›¾è¿‡ä¼šå„¿è®²ï¼‰</p><h2 id="SQLAlchemy-amp-MySQLå¤‡å¿˜ï¼šäº‹åŠ¡å’Œè§†å›¾çš„ä½¿ç”¨"><a href="#SQLAlchemy-amp-MySQLå¤‡å¿˜ï¼šäº‹åŠ¡å’Œè§†å›¾çš„ä½¿ç”¨" class="headerlink" title="SQLAlchemy&amp;MySQLå¤‡å¿˜ï¼šäº‹åŠ¡å’Œè§†å›¾çš„ä½¿ç”¨"></a>SQLAlchemy&amp;MySQLå¤‡å¿˜ï¼šäº‹åŠ¡å’Œè§†å›¾çš„ä½¿ç”¨</h2><h1 id="è§†å›¾"><a href="#è§†å›¾" class="headerlink" title="è§†å›¾"></a>è§†å›¾</h1><h2 id="æ¦‚å¿µç›®çš„"><a href="#æ¦‚å¿µç›®çš„" class="headerlink" title="æ¦‚å¿µç›®çš„"></a>æ¦‚å¿µç›®çš„</h2><p>è§†å›¾ç›¸å½“äºæŠŠä¸€ä¸ªSQLçš„æŸ¥æ‰¾ç­‰è¿‡ç¨‹å­˜å‚¨ä¸ºä¸€å¼ ä¼ªè¡¨ï¼Œå®ƒå¹¶ä¸å®é™…ä¸Šåˆ›å»ºä¸€å¼ è¡¨ã€ä¸å­˜å‚¨æ•°æ®ï¼Œè€Œæ˜¯ä½œä¸º<strong>â€œè™šå…³ç³»â€</strong>ã€‚åŒæ—¶ï¼Œåº•å±‚æ•°æ®å‘ç”Ÿå˜åŒ–çš„æ—¶å€™ï¼Œè§†å›¾çš„ç»“æœä»ç„¶æ˜¯ç¬¦åˆè¦æ±‚çš„ã€‚</p><p>å¸Œæœ›èƒ½å¤Ÿé‡ç”¨SQLè¯­å¥å¹¶ä¸”ä¸€å®šç¨‹åº¦ä¸Šèƒ½å¤Ÿä¿æŠ¤æ•°æ®ã€‚</p><p>è®¸å¤šæ—¶å€™ç”¨äºæ£€ç´¢è€Œéæ›´æ–°ã€‚</p><h2 id="å®šä¹‰ä¸ä½¿ç”¨"><a href="#å®šä¹‰ä¸ä½¿ç”¨" class="headerlink" title="å®šä¹‰ä¸ä½¿ç”¨"></a>å®šä¹‰ä¸ä½¿ç”¨</h2><p><code>CREATE VIEW</code> <code>DROP VIEW</code>å®Œæˆè§†å›¾çš„åˆ›å»ºåˆ é™¤ã€‚</p><p><code>SHOW CREATE VIEW</code>æŸ¥çœ‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">CREATE VIEW faculty AS</span><br><span class="line">SELECT ID, name, dept_name</span><br><span class="line">FROM instructor;</span><br></pre></td></tr></table></figure><p>ASæŸ¥è¯¢è¯­å¥ï¼Œå¾—åˆ°è¿™é‡Œçš„viewã€‚</p><p>æŸ¥è¯¢åˆ°çš„æ˜¯è§†å›¾ï¼Œå¯ä»¥ç±»ä¼¼tableä½¿ç”¨</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SELECT ID FROM faculty </span><br><span class="line">WHERE cond</span><br></pre></td></tr></table></figure><p>è§†å›¾è¿™é‡Œç›¸å½“äºå­æŸ¥è¯¢ã€‚</p><p><strong>æ³¨æ„ï¼Œè§†å›¾ä¸å…è®¸ä½¿ç”¨recursive.</strong></p><h2 id="materialized-view"><a href="#materialized-view" class="headerlink" title="materialized view"></a>materialized view</h2><p><a href="https://blog.csdn.net/joshua_peng1985/article/details/6213593">ç‰©åŒ–è§†å›¾</a></p><p>ç‰¹å®šçš„æ•°æ®åº“å…è®¸å­˜å‚¨è§†å›¾å…³ç³»ï¼Œå¹¶ä¸”å®šä¹‰çš„å…³ç³»æ”¹å˜ï¼Œè¿™ä¸ªè§†å›¾ä¹Ÿè·Ÿç€æ”¹å˜ï¼Œè¿™æ ·çš„è§†å›¾è¢«ç§°ä¸ºï¼šmaterialized viewã€‚</p><p>åŒæ—¶ï¼Œä¸€èˆ¬å¯¹è§†å›¾åªèƒ½è¿›è¡ŒæŸ¥è¯¢ï¼Œä½†æ˜¯æœ‰é™çš„æƒ…å†µä¸‹ï¼Œå…è®¸å¯¹è§†å›¾å…³ç³»è¿›è¡Œä¿®æ”¹ï¼Œä¸åŒæ•°æ®åº“å¯¹è¿™ä¸ªæä¾›äº†ä¸åŒçš„æ”¯æŒã€‚</p><p>å¯¹è§†å›¾æ›´æ–°ä¸€èˆ¬æ˜¯ä¸å…è®¸çš„â€¦ä½†æ˜¯â€¦æœ‰çš„æ•°æ®åº“ç³»ç»Ÿåˆ¶å®šäº†å…è®¸æ›´æ–°çš„å…³æ—­ï¼Œä¸€èˆ¬æ¥è¯´ï¼š</p><ul><li>from è‡ªç”±ä¸€ä¸ªæ•°æ®åº“å…³ç³»</li><li>select åªå«å…³ç³»ï¼Œæ²¡æœ‰è¡¨è¾¾å¼ã€èšé›†ã€DISTINCTç­‰</li><li>æ²¡æœ‰å‡ºç°åœ¨selectçš„å±æ€§å¯ä»¥ç©º</li><li>æ— havingæˆ–group by</li></ul><h2 id="SQLAlchemy-use"><a href="#SQLAlchemy-use" class="headerlink" title="SQLAlchemy use"></a>SQLAlchemy use</h2><blockquote><p><em>out of the box</em>: å¼€ç®±å³ç”¨çš„ï¼Œå³å·²ç»å°è£…å¥½çš„ï¼Œç¼©å†™ä¸ºOOTB</p></blockquote><p>å…³äºread-only un-materialized view, ä¼¼ä¹æ²¡æœ‰ç›´æ¥çš„æ”¯æŒï¼Œå¯ä»¥çœ‹çœ‹<a href="https://stackoverflow.com/questions/9766940/how-to-create-an-sql-view-with-sqlalchemy">è¿™é‡Œ</a></p><p>å¯¹äºmaterialized views, å¯ä»¥å‚è€ƒ<a href="https://stackoverflow.com/questions/21469184/sqlalchemy-materialized-relationships">è¿™é‡Œ</a>ï¼Œå’Œè¿™ä¸ªç”¨<a href="http://www.jeffwidman.com/blog/847/using-sqlalchemy-to-create-and-manage-postgresql-materialized-views/">PostgreSQLçš„ä¾‹å­</a>ä¼¼ä¹è¦ç”¨åˆ°æ¯”è¾ƒå¤šçš„é«˜çº§å±æ€§ï¼Ÿ</p><h1 id="æ•°æ®åº“äº‹åŠ¡-transaction"><a href="#æ•°æ®åº“äº‹åŠ¡-transaction" class="headerlink" title="æ•°æ®åº“äº‹åŠ¡(transaction)"></a>æ•°æ®åº“äº‹åŠ¡(transaction)</h1><p>å¯ä»¥è®¾ç½®commit, rollback. å¯ä»¥è®¾ç½®å¤šä¸ªç‚¹ä¾¿äºæäº¤/å›æ»šã€‚</p><p>äº‹åŠ¡æœ‰ç€ACIDçš„ç‰¹æ€§ï¼Œè¯·çœ‹<a href="https://www.cnblogs.com/fjdingsd/p/5273008.html">è€å“¥åšå®¢</a></p><p>è¿™é‡Œæš‚æ—¶ç®€å•æä¸€ä¸‹<code>transaction</code>ï¼Œä»¥åä¼šè¯¦ç»†ä»‹ç»ã€‚</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Inside C++ Object Model è¯»ä¹¦ç¬”è®°: Part2</title>
      <link href="/2020/07/15/Inside-C-Object-Model-%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0-Part2/"/>
      <url>/2020/07/15/Inside-C-Object-Model-%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0-Part2/</url>
      
        <content type="html"><![CDATA[<h2 id="P-review-C-ç»§æ‰¿å’Œè®¾è®¡"><a href="#P-review-C-ç»§æ‰¿å’Œè®¾è®¡" class="headerlink" title="(P)review: C++ ç»§æ‰¿å’Œè®¾è®¡"></a>(P)review: C++ ç»§æ‰¿å’Œè®¾è®¡</h2><h3 id="virtual"><a href="#virtual" class="headerlink" title="virtual"></a>virtual</h3><p>è™šå‡½æ•°æœºåˆ¶å’Œç»§æ‰¿å‡ ä¹æ€»æ˜¯ä¸€èµ·æçš„ã€‚ç¼–è¯‘å™¨å’Œé“¾æ¥å™¨ä¼šä¿è¯ï¼š</p><ul><li>å¯¹è±¡å’Œ(åŒ…æ‹¬è™šå‡½æ•°çš„)å‡½æ•°çš„æ­£ç¡®å…³è”ã€‚</li></ul><p>è¿™ä¸€ç‚¹æä¾›äº†è¿è¡ŒæœŸçš„å¤šæ€ã€‚é¡ºä¾¿æä¸€å˜´ï¼Œå®é™…ä¸Šåœ¨ C++ ä¸Šè¿è¡ŒæœŸå¤šæ€å’Œç¼–è¯‘å™¨å¤šæ€è¿˜æ˜¯å¾ˆæ¸…æ™°çš„ï¼Œå¦‚æœä½ æ²¡å†™è¿‡ C++ ç›´æ¥å»å†™ Rust çš„è¯ï¼Œå¯èƒ½ä¼šå¯¹ä¸‹é¢çš„åŒºåˆ«æ„Ÿåˆ°å¤´æ™•ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">trait</span> <span class="title class_">Sample</span> &#123;</span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">call</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">call_sample1</span>(s: <span class="type">Box</span>&lt;<span class="keyword">dyn</span> Sample&gt;) &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">call_sample2</span>&lt;T: Sample&gt;(s: T) &#123;&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯ä»¥å›é¡¾ä¸€ä¸‹ä¸Šä¸€ä¸ªç¬”è®°å†™çš„ï¼š</p><p><img src="https://image.mwish.me/blog-image/0FBB20FB-1264-4C0B-AE42-5211962234B8.png" alt="0FBB20FB-1264-4C0B-AE42-5211962234B8"></p><p>ä½ éœ€è¦/å¯èƒ½ <code>override</code> æ‰ <code>virtual</code>, å»ºè®®æ˜¾å¼è¿™ä¹ˆåšã€‚ï¼ˆ<code>overload</code> =  <code>override</code> )ã€‚åŒæ—¶ä¹Ÿè®°ä½ <code>final</code> è¿™ä¸ªå…³é”®å­—ã€‚</p><h3 id="è¿”å›ç±»å‹æ”¾æ¾"><a href="#è¿”å›ç±»å‹æ”¾æ¾" class="headerlink" title="è¿”å›ç±»å‹æ”¾æ¾"></a>è¿”å›ç±»å‹æ”¾æ¾</h3><p>C++ è¿”å›æ˜¯åå˜çš„ï¼Œè¿™æ„å‘³ç€ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Expr</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"><span class="built_in">Expr</span>();</span><br><span class="line"><span class="built_in">Expr</span>(<span class="type">const</span> Expr&amp;);</span><br><span class="line"><span class="function"><span class="keyword">virtual</span> Expr* <span class="title">clone</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥ç›´æ¥å†™ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Cond</span>: <span class="keyword">public</span> Expr &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"><span class="built_in">Cond</span>();</span><br><span class="line"><span class="built_in">Cond</span>(<span class="type">const</span> Cond&amp;);</span><br><span class="line"><span class="function">Cond* <span class="title">clone</span><span class="params">()</span> <span class="keyword">override</span> </span>&#123; <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Cond</span>(*<span class="keyword">this</span>);&#125;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®é™…ä¸Šè¿™ä¸ªè¿˜æ˜¯å¾ˆå¸¸è§çš„ã€‚</p><p>è€Œä¸€å®šçš„é€†å˜æ€§æ¥è‡ªäºï¼šåŸºç±»çš„æŒ‡é’ˆå¯ä»¥æ‰¿è½½å­ç±»å¯¹è±¡ã€‚</p><h3 id="virtual-base-class"><a href="#virtual-base-class" class="headerlink" title="virtual base class"></a>virtual base class</h3><p><img src="https://image.mwish.me/blog-image/AB0CEA77-F056-413A-A504-4D6D4BDFB768.png" alt="AB0CEA77-F056-413A-A504-4D6D4BDFB768"></p><p>è¿™æ˜¯ C++ Reference ä¸­çš„å»ºè®®ã€‚å»ºè®®è®¤ä¸ºï¼Œè™šåŸºç±»åº”è¯¥ä¸ºäº†â€œå…±äº«å¯¹è±¡â€è€Œæ‰¿è½½æˆå‘˜ã€‚</p><p>è™šåŸºç±»çš„æ„é€ è¯­ä¹‰æœ‰ä¸‹åˆ—çš„è¡¥å……ï¼š</p><ul><li>è™šåŸºç±»æ„é€ å‡½æ•°ä¿è¯åªè°ƒç”¨ä¸€æ¬¡ï¼Œç”±æœ€ç»ˆå¯¹è±¡è°ƒç”¨</li><li>è™šåŸºç±»çš„æ„é€ å‡½æ•°ä¼šåœ¨æ´¾ç”Ÿç±»çš„æ„é€ å‡½æ•°ä¹‹å‰å‘—è°ƒç”¨ã€‚</li></ul><p>åœ¨ C++ ä¸­ï¼ŒåŸºç±»å¯ä»¥ä¸ºäº†ä¸‹åˆ—çš„ç›®çš„æˆ–è€…æ··åˆçš„ç›®çš„ï¼š</p><ul><li>æ¥å£ç»§æ‰¿</li><li>å®ç°ç»§æ‰¿</li></ul><p>ä¹¦ä¸Šæ¯”è¾ƒæœ‰æ„æ€çš„æ˜¯å†™äº†ä¸ª lval_box çš„ä¾‹å­ï¼Œè¿™é‡Œç”¨ protect æ¥ç»§æ‰¿ implementï¼Œç”¨ public ç»§æ‰¿æ¥å£ã€‚</p><p>ä¹¦ä¸Šç»™äº†ä¸ªå¾ˆæœ‰è¶£çš„ä¾‹å­ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">X</span>: <span class="keyword">public</span> <span class="keyword">virtual</span> Interface, <span class="keyword">protected</span> Implement &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ç»§æ‰¿é“¾ä¸­æŠŠ interface å½“æˆ virtual class ä½¿ç”¨ã€‚</p><p>åŒæ—¶ï¼Œå…³äºè™šç»§æ‰¿æœ‰ä¸‹åˆ—ä¸€äº›ç‰¹ç‚¹ï¼š</p><blockquote><p>æ‰€æœ‰è™šåŸºç±»å­å¯¹è±¡éƒ½åœ¨ä»»ä½•éè™šåŸºç±»å­å¯¹è±¡ä¹‹å‰åˆå§‹åŒ–ï¼Œæ•…åªæœ‰æœ€ç»ˆæ´¾ç”Ÿç±»ä¼šåœ¨å…¶<a href="https://zh.cppreference.com/w/cpp/language/initializer_list">æˆå‘˜åˆå§‹åŒ–å™¨åˆ—è¡¨</a>ä¸­è°ƒç”¨è™šåŸºç±»çš„æ„é€ å‡½æ•°</p></blockquote><h2 id="Data-è¯­ä¹‰å­¦"><a href="#Data-è¯­ä¹‰å­¦" class="headerlink" title="Data è¯­ä¹‰å­¦"></a>Data è¯­ä¹‰å­¦</h2><h3 id="NonStatic-Data-Members"><a href="#NonStatic-Data-Members" class="headerlink" title="NonStatic Data Members"></a>NonStatic Data Members</h3><p>å½“å¯¹ä¸€ä¸ª nonstatic data member åš load/store çš„æ—¶å€™ï¼Œç¼–è¯‘å™¨çš„åŸºæœ¬æ“ä½œä¼šæ˜¯ï¼š</p><ul><li>ç¼–è¯‘æ—¶å·²ç»çŸ¥é“å¯¹åº”çš„åœ°å€çš„åç§»é‡</li><li>æ•ˆç‡ç­‰åŒäºå­˜å– C struct member</li></ul><p>åœ¨å¼•å…¥è™šæ‹Ÿç»§æ‰¿ä¹‹å‰ï¼Œä»£ä»·éƒ½æ˜¯ä¸€è‡´çš„ï¼Œåœ¨å¼•å…¥è™šæ‹Ÿç»§æ‰¿åï¼Œå¦‚æœé€šè¿‡ virtual base class çš„å¼•ç”¨è®¿é—®å®ƒçš„å¯è®¿é—®æˆå‘˜ï¼Œé‚£ä¹ˆè¿™ä¼šåœ¨è¿è¡Œæ—¶å†³å®šå…·ä½“è®¿é—®çš„å¯¹è±¡ã€‚ï¼ˆé—®é¢˜ï¼šåœ¨ç»§æ‰¿/å¤šç»§æ‰¿çš„å±‚æ¬¡ä¸­ï¼ŒåŸºç±»æŒ‡é’ˆæ˜¯æ€ä¹ˆè¡¨ç¤ºçš„ï¼Ÿæ€ä¹ˆæ ·å¯¼è‡´è¿™ç§ bias çš„ï¼Ÿï¼‰</p><p>å½“ç„¶ï¼Œç¼–è¯‘å™¨å¯èƒ½æœ‰ä¸€å®šçš„ä¸Šä¸‹æ–‡ï¼Œæ¥ä¼˜åŒ–æ‰è¿™ç§å¼€é”€ã€‚</p><h4 id="ç»§æ‰¿ä¸-data-member"><a href="#ç»§æ‰¿ä¸-data-member" class="headerlink" title="ç»§æ‰¿ä¸ data member"></a>ç»§æ‰¿ä¸ data member</h4><p>å®ç°çš„æ—¶å€™ï¼Œå¦‚æœæ²¡æœ‰ virtual base classï¼Œä¸€ä¸ªå­ç±»çš„å¯¹è±¡å¸ƒå±€ç±»ä¼¼äºï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">base class members</span><br><span class="line">---</span><br><span class="line">my members</span><br></pre></td></tr></table></figure><p>ä¸€èˆ¬æ¥è¯´ï¼Œé virtual base member çš„åŸºç±»æˆå‘˜ï¼Œéƒ½ä¼šåœ¨å¯¹è±¡çš„å¤´éƒ¨å‡ºç°ã€‚</p><p>å½“ user ä¸éœ€è¦è¿è¡Œæ—¶å¤šæ€ï¼Œå³ä¸ä½¿ç”¨ virtual class çš„æ—¶å€™ï¼Œå¯¹è±¡ä¼šè¢«â€æ‹¼æ¥â€œåœ¨ä¸€èµ·ã€‚ä¸è¿‡ä¸‹é¢æœ‰å‡ ä¸ªç–‘é—®ï¼š</p><ul><li>å¦‚ä½•å¤„ç† padding ï¼Ÿ</li><li>å¦‚ä½•æ”¯æŒ RTTIï¼Ÿ</li></ul><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// The parts below means 3.1 in the projects.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Concrete</span> &#123;</span><br><span class="line">    <span class="type">int32_t</span> value;</span><br><span class="line">    <span class="type">char</span> f1;</span><br><span class="line">    <span class="type">char</span> f2;</span><br><span class="line">    <span class="type">char</span> f3;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">PartConcrete1</span> &#123;</span><br><span class="line">    <span class="type">int32_t</span> value;</span><br><span class="line">    <span class="type">char</span> f1;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">PartConcrete2</span> &#123;</span><br><span class="line">    PartConcrete1 p1;</span><br><span class="line">    <span class="type">char</span> f2;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">PartConcrete3</span> &#123;</span><br><span class="line">    PartConcrete2 p2;</span><br><span class="line">    <span class="type">char</span> f2;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">DerivedConcrete2</span>: <span class="keyword">public</span> PartConcrete1 &#123;</span><br><span class="line">    <span class="type">char</span> f2;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">DerivedConcrete3</span>: <span class="keyword">public</span> DerivedConcrete2 &#123;</span><br><span class="line">    <span class="type">char</span> f3;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// the code below is testing code:    println(&quot;below is 3.1 data part&quot;);</span></span><br><span class="line">    <span class="built_in">print_t_size</span>&lt;Concrete&gt;();  <span class="comment">// 8</span></span><br><span class="line">    <span class="built_in">print_t_size</span>&lt;PartConcrete1&gt;(); <span class="comment">// 8</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">print_t_size</span>&lt;PartConcrete2&gt;(); <span class="comment">// 12</span></span><br><span class="line">    <span class="built_in">print_t_size</span>&lt;PartConcrete3&gt;(); <span class="comment">// 16</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">print_t_size</span>&lt;DerivedConcrete2&gt;(); <span class="comment">// 12</span></span><br><span class="line">    <span class="built_in">print_t_size</span>&lt;DerivedConcrete3&gt;(); <span class="comment">// 12</span></span><br></pre></td></tr></table></figure><p>è¿™å›å¯ä¸æ˜¯ ebo äº†ï¼</p><ul><li>ç»„åˆçš„æ—¶å€™ï¼Œclang å®ç°ä¸Šè¿˜æ˜¯ä¼šä¿è¯ padding çš„</li><li>ç»§æ‰¿çš„æ—¶å€™ï¼Œå¯èƒ½ä¼šä¼˜åŒ–æ‰å¯èƒ½çš„ padding</li></ul><p><img src="https://image.mwish.me/blog-image/ACD1A13D-FEC3-43E5-885C-DDF0E7BAEF06.png" alt="ACD1A13D-FEC3-43E5-885C-DDF0E7BAEF06"></p><p>ä¹¦ä¸Šçš„ä»£ç æˆä¹¦çš„æ—¶å€™å®ç°è¿˜æ˜¯æ¯”è¾ƒç±»ä¼¼ç»„åˆè¿™æ ·çš„ã€‚æ¥ä¸‹æ¥å†å¯¹æˆ‘ä»¬ä¸Šè¿°è´´çš„ç±»å‹è¿›è¡Œä¸€ç‚¹å°å®éªŒï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">DerivedConcrete2 d2 &#123;<span class="number">1</span>, <span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>&#125;;</span><br><span class="line">DerivedConcrete3 d3 &#123; <span class="number">2</span>, <span class="string">&#x27;c&#x27;</span>, <span class="string">&#x27;d&#x27;</span>, <span class="string">&#x27;e&#x27;</span>&#125;;</span><br><span class="line"></span><br><span class="line">PartConcrete1* p1, *p2;</span><br><span class="line">&#123;</span><br><span class="line">    DerivedConcrete3 d_temp = d3;</span><br><span class="line">    p1 = &amp;d_temp, p2 = &amp;d2;</span><br><span class="line">    *p1 = *p2;</span><br><span class="line">    std::cout &lt;&lt; d_temp.f2 &lt;&lt; <span class="string">&#x27; &#x27;</span> &lt;&lt; d_temp.f3 &lt;&lt; <span class="string">&#x27;\n&#x27;</span>; <span class="comment">// d e</span></span><br><span class="line">&#125;</span><br><span class="line">&#123;</span><br><span class="line">    DerivedConcrete3 d_temp = d3;</span><br><span class="line">    DerivedConcrete2* p21, * <span class="type">const</span> p22 = &amp;d2;</span><br><span class="line">    p21 = &amp;d_temp;</span><br><span class="line">    *p21 = *p22;</span><br><span class="line">    std::cout &lt;&lt; d_temp.f2 &lt;&lt; <span class="string">&#x27; &#x27;</span> &lt;&lt; d_temp.f3 &lt;&lt; <span class="string">&#x27;\n&#x27;</span>; <span class="comment">// b e</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœä½ æ²¡çœ‹å‰é¢çš„å†…å®¹ï¼Œåªæ˜¯è‡ªå·±å†™è¿™äº›ä»£ç çš„è¯ï¼Œä¸Šé¢çš„å†…å®¹åº”è¯¥æ˜¯éå¸¸ç¬¦åˆç›´è§‰çš„ï¼Œ<code>*p21 = *p22</code> å¦‚æœæ”¹äº† <code>d_temp.f3</code> çš„è¯æ€ä¹ˆæƒ³éƒ½æ˜¯ä¸åˆé€‚çš„ã€‚ä½†æ˜¯ä½ çŸ¥é“ <code>DerivedConcrete2</code> å’Œ <code>DerivedConcrete3</code> ä¸€æ ·å¤§ä¹‹åï¼Œæ„Ÿè§‰å°±ä¼šå¥‡æ€ªèµ·æ¥ã€‚</p><p>å®é™…ä¸Šï¼Œå¯ä»¥åœ¨ cppreference ä¸Šæ‰¾åˆ°å­ç±»å‹ç›¸å…³çš„å®šä¹‰ï¼š</p><ul><li><a href="https://en.cppreference.com/w/cpp/language/object#Subobjects">https://en.cppreference.com/w/cpp/language/object#Subobjects</a></li><li><a href="https://en.cppreference.com/w/cpp/types/is_trivially_copyable">https://en.cppreference.com/w/cpp/types/is_trivially_copyable</a></li></ul><blockquote><p>In general, for any trivially copyable type <code>T</code> and an object <code>obj1</code> of <code>T</code>, the underlying bytes of <code>obj1</code> can be copied (e.g. by means of std::memcpy or std::memmove) into an array of <code>char</code>, <code>unsigned char</code> or <a href="https://en.cppreference.com/w/cpp/types/byte"><code>std::byte</code></a> or into <code>obj2</code>, a distinct object of <code>T</code>. Neither <code>obj1</code> nor <code>obj2</code> may be a potentially-overlapping subobject.</p></blockquote><p>å†åŠ ä¸Š non-virtual çš„å¤šæ€åï¼Œå¯¹è±¡éœ€è¦æ·»åŠ ä¸€ä¸ª word å¤§å°çš„ vptrï¼Œå¹¶ä¸”ä¸ºè¿™ä¸ªç±»ç”Ÿæˆä¸€ä¸ª vtable. ç°åœ¨å¾ˆå¤šç¼–è¯‘å™¨å°†å…¶ç½®æ”¾åœ¨å¯¹è±¡çš„èµ·å§‹éƒ¨ä½ã€‚åœ¨å¤šç»§æ‰¿ä¸­ï¼Œä¸Šè¿°ä¸¤ç§æœºåˆ¶è¢«æ··åˆèµ·æ¥ï¼Œå¯¹è±¡ä¸€ä¸ªä¸ªæ’åˆ—ï¼Œå¹¶ä¸”éµç…§ä¹‹å‰è¯´çš„æ–¹å¼è¿›è¡Œã€‚</p><p>ä½†æ˜¯è¿™ç§è½¬åŒ–æœ‰ä¸€ä¸ªç–‘é—®å°±æ˜¯ï¼Œè½¬åŒ–ä¹‹åæŒ‡é’ˆèµ‹å€¼åº”è¯¥æ€ä¹ˆå¤„ç†å‘¢ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Base1</span> &#123;</span><br><span class="line">    <span class="comment">// members</span></span><br><span class="line">    <span class="type">int32_t</span> v1;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Base2</span> &#123;</span><br><span class="line">    <span class="comment">// members</span></span><br><span class="line">    <span class="type">int32_t</span> v2;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Derived</span>: <span class="keyword">public</span> Base1, <span class="keyword">public</span> Base2 &#123;</span><br><span class="line">    <span class="type">int32_t</span> v3; </span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    Derived d_object&#123;&#125;;</span><br><span class="line">    Base1* pb1 = &amp;d_object;</span><br><span class="line">    Base2* pb2 = &amp;d_object;</span><br><span class="line">    <span class="built_in">println</span>(pb1); <span class="comment">// 0x7ffee0f0a940</span></span><br><span class="line">    <span class="built_in">println</span>(pb2); <span class="comment">// 0x7ffee0f0a944</span></span><br><span class="line">    <span class="built_in">println</span>(<span class="built_in">reinterpret_cast</span>&lt;<span class="type">void</span>*&gt;(pb1) == <span class="built_in">reinterpret_cast</span>&lt;<span class="type">void</span>*&gt;(pb2)); <span class="comment">// false</span></span><br><span class="line">    <span class="keyword">auto</span> pd1 = <span class="built_in">static_cast</span>&lt;Derived*&gt;(pb1);</span><br><span class="line">    <span class="keyword">auto</span> pd2 = <span class="built_in">static_cast</span>&lt;Derived*&gt;(pb2);</span><br><span class="line">    <span class="built_in">println</span>(pd1); <span class="comment">// 0x7ffee0f0a940</span></span><br><span class="line">    <span class="built_in">println</span>(pd2); <span class="comment">// 0x7ffee9496940</span></span><br><span class="line">    <span class="built_in">println</span>(pd1 == pd2); <span class="comment">// true</span></span><br><span class="line">    <span class="built_in">println</span>(&amp;d_object == pd1); <span class="comment">// true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®é™…ä¸Šï¼Œè¿™é‡Œåšäº†ä¸€ä¸ªåœ°å€çš„ castã€‚</p><h3 id="å¼•å…¥è™šæ‹Ÿç»§æ‰¿"><a href="#å¼•å…¥è™šæ‹Ÿç»§æ‰¿" class="headerlink" title="å¼•å…¥è™šæ‹Ÿç»§æ‰¿"></a>å¼•å…¥è™šæ‹Ÿç»§æ‰¿</h3><p><img src="https://image.mwish.me/blog-image/2119B240-BD4F-4303-A8B9-D41000E16E28.png" alt="2119B240-BD4F-4303-A8B9-D41000E16E28"></p><p>åœ¨å¼•å…¥è™šæ‹Ÿç»§æ‰¿ä¹‹åï¼Œclass ä¼šç”Ÿæˆä¸€ä¸ª <code>vbase</code>ï¼ŒåŒæ—¶åŠ¨æ€çš„å†³å®š vbase å¯¹è±¡çš„ä½ç½®ã€‚åŒæ—¶ï¼Œç»§æ‰¿è‡ª vbase çš„ç±»ï¼Œä¼šå¸¦æœ‰ä¸€ä¸ª vbase å¯¹è±¡çš„ ptrdiffã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œå¤šä¸ªå¯¹è±¡åˆ†éƒ¨çš„ bias ä¼šè¢«æŒ‡å‘åŒä¸€ä¸ªå…·ä½“çš„å¸ƒå±€ä½ç½®ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œå¯¹è±¡å¸¦æ¥äº†ä¸€æ¬¡ bias å¯»å€çš„å¼€é”€ã€‚</p><h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul><li><a href="https://stackoverflow.com/questions/27007797/the-size-of-base-class-object-and-derived-class-object-in-c">https://stackoverflow.com/questions/27007797/the-size-of-base-class-object-and-derived-class-object-in-c</a></li><li><a href="https://www.cprogramming.com/tutorial/size_of_class_object.html#:~:text=sizeof(Derived">https://www.cprogramming.com/tutorial/size_of_class_object.html#:~:text=sizeof(Derived)%20will%20be%2012,wonâ€™t%20add%20anything%20more.</a> will be 12,wonâ€™t add anything more.)</li></ul>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Inside C++ Object Model è¯»ä¹¦ç¬”è®°</title>
      <link href="/2020/07/13/Inside-C-Object-Model-%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/"/>
      <url>/2020/07/13/Inside-C-Object-Model-%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/</url>
      
        <content type="html"><![CDATA[<h1 id="Inside-the-C-Object-Model-è¯»ä¹¦ç¬”è®°"><a href="#Inside-the-C-Object-Model-è¯»ä¹¦ç¬”è®°" class="headerlink" title="Inside the C++ Object Model è¯»ä¹¦ç¬”è®°"></a>Inside the C++ Object Model è¯»ä¹¦ç¬”è®°</h1><h2 id="Object-Lessons"><a href="#Object-Lessons" class="headerlink" title="Object Lessons"></a>Object Lessons</h2><p>C++ è¢«ç§°ä¸º <code>zero cost abstraction</code>, æŸç§ç¨‹åº¦ä¸Šï¼Œè¿™ä»£è¡¨ç€ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">Point3D</span> &#123;</span><br><span class="line"><span class="type">float</span> x;</span><br><span class="line"><span class="type">float</span> y;</span><br><span class="line"><span class="type">float</span> z;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å’Œä½ å‚»å‚»çš„åœ¨ç¨‹åºé‡Œå•ç‹¬ç»´æŠ¤ <code>x y z</code>ï¼Œç©ºé—´ç­‰å¼€é”€æ˜¯æ²¡æœ‰é¢å¤–å¢åŠ çš„ã€‚å½“ç„¶ <code>Point3D</code> æ˜¯ä¸€ä¸ªå¾ˆ Plain çš„ç±»ã€‚å®ç°çš„æ—¶å€™ï¼Œå¯èƒ½ä¼šæœ‰ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">Point3D</span> &#123;</span><br><span class="line"><span class="built_in">Point3D</span>(<span class="type">float</span> x, <span class="type">float</span> y, <span class="type">float</span> z): <span class="built_in">x_</span>(x) </span><br><span class="line">...</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line"><span class="type">float</span> x_;</span><br><span class="line"><span class="type">float</span> y_;</span><br><span class="line"><span class="type">float</span> z_;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ–è€…ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Point3D</span>: Point2D &#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line"><span class="type">float</span> z_;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”šè‡³å¸¦ä¸Šæ³›å‹</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> <span class="type">edge_t</span>&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Point3D</span> &#123;</span><br><span class="line"><span class="type">edge_t</span> x, y, z;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> <span class="type">edge_t</span>, <span class="type">int</span> dim&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Point3D</span> &#123;</span><br><span class="line"><span class="type">edge_t</span>[dim] edges_;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸‹æ„è¯†æˆ‘ä»¬ä¼šè§‰å¾—ï¼Œè¿è¡Œæ—¶è¿™äº›ç±»çš„å¸ƒå±€æˆæœ¬éƒ½æ˜¯ä¸€æ ·çš„ã€‚å®é™…ä¸Šï¼ŒC++ åœ¨ layoutï¼ˆç©ºé—´ï¼‰å’Œ load/store ï¼ˆæ—¶é—´ç­‰ï¼‰ä¼¤çš„æˆæœ¬æ˜¯ <code>virtual</code> å¼•èµ·çš„ï¼š</p><ul><li>Virtual function: æ”¯æŒé«˜æ•ˆçš„è¿è¡ŒæœŸå¤šæ€</li><li>virtual base class (è¿™ä¸ªç¬”è€…ä¹‹å‰ç”¨çš„å¾ˆå°‘ï¼Œå¯èƒ½ä¸å¤ªäº†è§£)ï¼šè¢«æ£±å‹ç­‰æ–¹å¼ç»§æ‰¿çš„ base class.</li></ul><h3 id="C-Object-Model"><a href="#C-Object-Model" class="headerlink" title="C++ Object Model"></a>C++ Object Model</h3><p>è¿™æœ¬ä¹¦çš„å†…å®¹æ¯”è¾ƒè€ï¼Œæ— æ³•ä¿è¯å’Œæœ€æ–°çš„ clang/gcc/msvc å®ç°ä¸€æ ·ï¼Œä¸è¿‡å®ƒä»‹ç»çš„ä¸€äº›æ¨¡å‹è¿˜æ˜¯å€¼å¾—çœ‹çš„ï¼Œå§‘ä¸”æŠŠå®ƒè¿™ä¸ªæ¨å¯¼è¿‡ç¨‹ copy ä¸€ä¸‹ã€‚</p><p>ç¬¬ä¸€ä¸ªä»‹ç»çš„æ¨¡å‹æ˜¯ï¼š</p><p><img src="https://image.mwish.me/blog-image/418F4DC7-51DC-4C7F-8F26-A3FA24ABFDE5.png" alt="418F4DC7-51DC-4C7F-8F26-A3FA24ABFDE5"></p><p>è¿™ä¸ªé’ˆå¯¹æ¯ä¸ªå‡½æ•°å’Œæˆå‘˜éƒ½ç”Ÿæˆäº†å¯¹åº”çš„ Pointer/ å¯¹åº”å†…å­˜ä½ç½®ã€‚æ‰€æœ‰çš„æŒ‡å‘éƒ½æ˜¯é—´æ¥çš„ï¼Œå‡½æ•°ä¹Ÿæœ‰å¯¹åº”çš„æŒ‡é’ˆã€‚</p><p>ä¹¦ä¸Šå†™çš„ç¬¬äºŒä¸ªå¯¹è±¡æ¨¡å‹åˆ†ä¸ºäº†å‡½æ•°çš„ table å’Œæˆå‘˜çš„ tableï¼Œå¸ƒå±€å¦‚ä¸‹ï¼š</p><p><img src="https://image.mwish.me/blog-image/4DD61565-8EBE-4F05-A11F-165A71DE0AFF.png" alt="4DD61565-8EBE-4F05-A11F-165A71DE0AFF"></p><p>è¿™æœ¬ä¹¦ä¸Šæœ€åä»‹ç»äº†å½“æ—¶ C++ çš„ object modelï¼š</p><ol><li>å¦‚å›¾ <code>1.2</code>. äº§ç”ŸæŒ‡å‘è™šå‡½æ•°çš„æŒ‡é’ˆï¼Œæˆä¸º virtual table (vtbl). <code>vtbl</code> æ˜¯ä»¥ç±»ä¸ºå•ä½ç”Ÿæˆçš„ã€‚åŒæ—¶ï¼Œä¸€ä¸ªåŠ¨æ€çš„ <code>type_info</code> ä¹Ÿè¢«ç”Ÿæˆï¼Œå¯ä»¥ç”¨äºåŠ¨æ€çš„ RTTIã€‚</li><li>æ¯ä¸ªæœ‰ <code>virtual</code> çš„ç±»çš„<em>å¯¹è±¡</em> ç”ŸæˆæŒ‡å‘ç±»çš„ <code>vtbl</code> çš„æŒ‡é’ˆ <code>vptr</code>.</li></ol><p>å¯¹äº virtual ç»§æ‰¿ï¼Œæœ¬ä¹¦æä¾›äº†ä¸¤ç§æ–¹æ¡ˆï¼š</p><ul><li>å­ç±»çš„å¯¹è±¡ç•™å‡ºä¸€å®šçš„å†…å­˜ä½ç½®ï¼ŒæŒ‡å‘ base class çš„åœ°å€</li><li>ç”Ÿæˆä¸€ä¸ª base class table</li></ul><p>ä¸‹å›¾æ˜¯é€»è¾‘ä¸Šçš„æ¨¡å‹ã€‚</p><p><img src="https://image.mwish.me/blog-image/C4C279FD-5CD9-420C-896E-9B8E64E975A4.png" alt="C4C279FD-5CD9-420C-896E-9B8E64E975A4"></p><p>è¿™æ ·å¼•å…¥äº†ä¸€å®šçš„é—´æ¥æ€§è´¨ï¼ˆæœ‰ç‚¹åƒ Python MRO é‚£å¥—ï¼Ÿï¼‰</p><h3 id="å¯¹è±¡æ¨¡å‹å¯¹ç¨‹åºçš„å½±å“"><a href="#å¯¹è±¡æ¨¡å‹å¯¹ç¨‹åºçš„å½±å“" class="headerlink" title="å¯¹è±¡æ¨¡å‹å¯¹ç¨‹åºçš„å½±å“"></a>å¯¹è±¡æ¨¡å‹å¯¹ç¨‹åºçš„å½±å“</h3><p>é¦–å…ˆï¼Œå¯¹è±¡æ¨¡å‹ä¼šå½±å“ä½ éœ€è¦é‡æ–°ç¼–è¯‘ã€é“¾æ¥çš„ä¸œè¥¿ï¼Œå†³å®šç¼–è¯‘å™¨ä¼šæ€ä¹ˆç”Ÿæˆå¯¹ vtbl ç­‰æ“ä½œã€‚</p><p>æ­¤å¤–ï¼Œè¿™æœ¬ä¹¦é‡Œæåˆ°äº†<code>The Politically Correct Struct</code>:</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">BPlusTree</span> &#123;</span><br><span class="line"><span class="comment">// ... æˆå‘˜ä¿¡æ¯</span></span><br><span class="line">BTreeIndex index[];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">mumble</span> &#123;</span><br><span class="line">  <span class="type">char</span> index[<span class="number">1</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>C è¿™æ ·è®© <code>Index</code> å’Œ <code>BPlusTree</code> ä¸€èµ·å¸ƒå±€ã€‚åœ¨ C++ ä¸­ï¼Œä½ è¦æ³¨æ„ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">BPlusTree</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">...</span><br><span class="line">BTreeIndex index[];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">stumble</span> &#123;</span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">    <span class="type">char</span> index[<span class="number">1</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ç§æƒ…å†µä¸‹æ˜¯å¦ ä¸åŒ<code>section</code> ä¸­ï¼Œ<code>index</code> è¿˜ä¼šå‡ºç°åœ¨ç»“æ„çš„å°¾éƒ¨ã€‚</p><p>åŒæ—¶ï¼Œä½ æ³¨æ„åˆ°äº†å¯èƒ½å­˜åœ¨çš„ä¸åŒå¸ƒå±€å’Œ ABIï¼Œä¸ºäº† C/C++ å…¼å®¹ï¼ˆè¿™æ˜¯ä¸ªå¾ˆå¸¸è§çš„éœ€æ±‚ï¼‰ï¼Œä½ å¯èƒ½è¦ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">extern &quot;C&quot; &#123;</span><br><span class="line">// ... å†™ä½ å°è£…çš„ä¸œè¥¿</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è€ƒæ­¤æ¥æä¾›ä¸€å®šçš„ä¿è¯ï¼ˆç»„åˆ/ç»§æ‰¿ï¼Ÿï¼‰</p><h3 id="æŒ‡é’ˆçš„ç±»å‹"><a href="#æŒ‡é’ˆçš„ç±»å‹" class="headerlink" title="æŒ‡é’ˆçš„ç±»å‹"></a>æŒ‡é’ˆçš„ç±»å‹</h3><p>ä¸€äº›è¯­è¨€ä¸­ä¼šæœ‰ fat pointer çš„å­˜åœ¨ï¼Œæ¯”å¦‚ Rust çš„ <code>Box&lt;dyn Trait&gt;</code>, è¿™è®©è¿™äº›æŒ‡é’ˆæœ‰æ›´å¤šçš„ä¿¡æ¯ã€‚</p><p>C++ åªé æŒ‡é’ˆç±»å‹ç¼–è¯‘æ—¶çš„ä¿¡æ¯æ¥å†³å®šï¼ŒæŒ‡é’ˆéƒ½æ˜¯ä¸€ä¸ª <code>word</code> çš„å¤§å°ï¼Œå…·ä½“å¯ä»¥å‚è€ƒè¿™ä¸ªå›ç­”ï¼š</p><blockquote><p> Golangå’ŒRustçš„èƒ–æŒ‡é’ˆä¸C++çš„æŒ‡é’ˆæŒ‡å‘è™šè¡¨å“ªç§è®¾è®¡æ›´å¥½? - F001çš„å›ç­” - çŸ¥ä¹ <a href="https://www.zhihu.com/question/340855881/answer/791076420">https://www.zhihu.com/question/340855881/answer/791076420</a></p></blockquote><p><img src="https://image.mwish.me/blog-image/38D54D51-BC06-4ABA-82A7-AE7A677EC9F3.png" alt="38D54D51-BC06-4ABA-82A7-AE7A677EC9F3"></p><h2 id="The-Semantics-of-Constructors"><a href="#The-Semantics-of-Constructors" class="headerlink" title="The Semantics of Constructors"></a>The Semantics of Constructors</h2><p>æˆ‘ä¸æ€ä¹ˆä¼šå†™ C++ï¼Œä½†æ˜¯æˆ‘å¿ƒç›®ä¸­ï¼ŒC++ æœ€é‡è¦çš„æ¦‚å¿µç»å¯¹åŒ…å« RAIIã€‚</p><p><img src="https://image.mwish.me/blog-image/the-rule-of-five.png" alt="the rule of five"></p><p>åŒæ—¶ï¼Œè¿™é‡Œä¼šæ¶‰åŠä¸€äº› RVO/NRVO ä¹‹ç±»çš„ä¼˜åŒ–ï¼š</p><p><a href="[https://github.com/mapleFU/CppCoreGuidelines-zh-CN/blob/master/CppCoreGuidelines-zh-CN.md#p9-%E4%B8%8D%E8%A6%81%E6%B5%AA%E8%B4%B9%E6%97%B6%E9%97%B4%E6%88%96%E7%A9%BA%E9%97%B4](https://github.com/mapleFU/CppCoreGuidelines-zh-CN/blob/master/CppCoreGuidelines-zh-CN.md#p9-ä¸è¦æµªè´¹æ—¶é—´æˆ–ç©ºé—´">ä¸€ä¸ªä¸ä¿è¯ NRVO çš„ä¾‹å­</a>)</p><h3 id="Default-Constructor"><a href="#Default-Constructor" class="headerlink" title="Default Constructor"></a>Default Constructor</h3><p><a href="https://zh.cppreference.com/w/cpp/language/default_constructor">cppreference</a> ä»‹ç»äº†å®ƒç”Ÿæˆçš„æ¡ä»¶ã€‚</p><p>default constructor åœ¨é»˜è®¤çš„æ—¶å€™ç”Ÿæˆ. ä½†å®ƒä¸ä¼šåšå¤šä½™çš„äº‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ListNode</span> &#123;</span><br><span class="line">ListNode* prev;</span><br><span class="line"><span class="type">int</span> value;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">ListNode v;</span><br></pre></td></tr></table></figure><p>åˆ›å»º <code>v</code> çš„æ—¶å€™ï¼Œ<code>prev</code> <code>value</code> ä¸ä¼šåœ¨ default constructor è¢«åˆå§‹åŒ–ã€‚è¿™ç‚¹æ˜¯ä¸ºäº†æ•ˆç‡ã€‚</p><p>è¿™é‡Œå¯ä»¥è”ç³»ä¸Šè¿° cppreference ä¸­çš„æ¦‚å¿µï¼š</p><blockquote><p>å¹³å‡¡é»˜è®¤æ„é€ å‡½æ•°æ˜¯ä¸è¿›è¡Œä»»ä½•åŠ¨ä½œçš„æ„é€ å‡½æ•°ã€‚æ‰€æœ‰ä¸ C è¯­è¨€å…¼å®¹çš„æ•°æ®ç±»å‹ï¼ˆPOD ç±»å‹ï¼‰éƒ½æ˜¯å¯å¹³å‡¡é»˜è®¤æ„é€ çš„ã€‚</p></blockquote><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ListNode</span> &#123;</span><br><span class="line">ListNode* prev;</span><br><span class="line"><span class="type">int</span> value;</span><br><span class="line"><span class="type">another1_t</span> another1;</span><br><span class="line">  <span class="type">another2_t</span> another2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‡è®¾ <code>another1_t</code> <code>another2_t</code> æœ‰è‡ªå·±çš„ default constructor, é‚£ä¹ˆ <code>ListNode</code> æ„é€ çš„æ—¶å€™ä¼š<strong>æŒ‰é¡ºåº</strong>è°ƒç”¨è¿™äº›å¿…è¦çš„ä¿¡æ¯ï¼Œå¯èƒ½ä¼šç”Ÿæˆï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ListNode::<span class="built_in">ListNode</span>() &#123;</span><br><span class="line"><span class="type">another1_t</span>::<span class="built_in">another1_t</span>();</span><br><span class="line"><span class="type">another2_t</span>::<span class="built_in">another2_t</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// ... your default code...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç±»ä¼¼ä¸Šé¢çš„<em>é¡ºåº</em>ã€‚</p><h4 id="å¸¦-virtual-function-çš„-class"><a href="#å¸¦-virtual-function-çš„-class" class="headerlink" title="å¸¦ virtual function çš„ class"></a>å¸¦ virtual function çš„ class</h4><p>ç¼–è¯‘å™¨éœ€è¦ç”Ÿæˆä¸€ä¸ª <code>vptr</code> ï¼ŒåŒæ—¶æŒ‡å‘è¿™ä¸ª class çš„ <code>vtbl</code>.</p><h3 id="Copy-Constructor"><a href="#Copy-Constructor" class="headerlink" title="Copy Constructor"></a>Copy Constructor</h3><p>ä¼ é€é—¨ï¼š<a href="https://zh.cppreference.com/w/cpp/language/copy_constructor">https://zh.cppreference.com/w/cpp/language/copy_constructor</a></p><p>å°ä¼ é€é—¨ï¼š<a href="https://zh.cppreference.com/w/cpp/language/copy_elision">https://zh.cppreference.com/w/cpp/language/copy_elision</a></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">X</span> &#123;</span><br><span class="line"><span class="built_in">X</span>(std::string name, ...): <span class="built_in">name_</span>(std::<span class="built_in">move</span>(name)) &#123;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">std::string name_;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ï¼ˆä¸è€ƒè™‘è¿™ä¸ªæ„šè ¢çš„ç±»æ€ä¹ˆæ”¹ï¼‰æ˜¾ç„¶è¿™é‡Œå¦‚æœä¼ å‚çš„è¯ï¼Œä¸€å®šä¼šèµ° <code>std::string</code> çš„æ‹·è´æ„é€ å‡½æ•°ã€‚</p><p>åœ¨æœ€åŸå§‹çš„æƒ…å†µä¸‹ï¼Œç¼–è¯‘å™¨ä¼šè€ƒè™‘ <code>bitwise copy semantics</code>ï¼Œç±»ä¼¼ï¼š</p><blockquote><h3 id="å¹³å‡¡å¤åˆ¶æ„é€ å‡½æ•°"><a href="#å¹³å‡¡å¤åˆ¶æ„é€ å‡½æ•°" class="headerlink" title="å¹³å‡¡å¤åˆ¶æ„é€ å‡½æ•°"></a>å¹³å‡¡å¤åˆ¶æ„é€ å‡½æ•°</h3><p>å½“ä¸‹åˆ—å„é¡¹å…¨éƒ¨ä¸ºçœŸæ—¶ï¼Œç±» <code>T</code> çš„å¤åˆ¶æ„é€ å‡½æ•°ä¸ºå¹³å‡¡çš„ï¼š</p><ul><li>å®ƒä¸æ˜¯ç”¨æˆ·æä¾›çš„ï¼ˆå³å®ƒæ˜¯éšå¼å®šä¹‰æˆ–é¢„ç½®çš„ï¼‰ï¼Œä¸”è‹¥å®ƒè¢«é¢„ç½®ï¼Œåˆ™å…¶ç­¾åä¸éšå¼å®šä¹‰çš„ç›¸åŒ (C++14 å‰)ï¼›</li><li><code>T</code> æ²¡æœ‰è™šæˆå‘˜å‡½æ•°ï¼›</li><li><code>T</code> æ²¡æœ‰è™šåŸºç±»ï¼›</li><li>ä¸º <code>T</code> çš„æ¯ä¸ªç›´æ¥åŸºç±»é€‰æ‹©çš„å¤åˆ¶æ„é€ å‡½æ•°éƒ½æ˜¯å¹³å‡¡çš„ï¼›</li><li>ä¸º <code>T</code> çš„æ¯ä¸ªç±»ç±»å‹ï¼ˆæˆ–ç±»ç±»å‹æ•°ç»„ï¼‰çš„éé™æ€æˆå‘˜é€‰æ‹©çš„å¤åˆ¶æ„é€ å‡½æ•°éƒ½æ˜¯å¹³å‡¡çš„ï¼›</li></ul><p>éè”åˆç±»çš„å¹³å‡¡å¤åˆ¶æ„é€ å‡½æ•°ï¼Œæ•ˆæœä¸ºå¤åˆ¶å®å‚çš„æ¯ä¸ªæ ‡é‡å­å¯¹è±¡ï¼ˆé€’å½’åœ°åŒ…å«å­å¯¹è±¡çš„å­å¯¹è±¡ï¼Œä»¥æ­¤ç±»æ¨ï¼‰ï¼Œä¸”ä¸è¿›è¡Œå…¶ä»–åŠ¨ä½œã€‚ä¸è¿‡ä¸éœ€è¦å¤åˆ¶å¡«å……å­—èŠ‚ï¼Œç”šè‡³åªè¦å…¶å€¼ç›¸åŒï¼Œæ¯ä¸ªå¤åˆ¶çš„å­å¯¹è±¡çš„å¯¹è±¡è¡¨ç¤ºä¹Ÿä¸å¿…ç›¸åŒã€‚</p><p><a href="https://zh.cppreference.com/w/cpp/named_req/TriviallyCopyable"><em>å¯å¹³å‡¡å¤åˆ¶</em> <em>(TriviallyCopyable)</em> </a>å¯¹è±¡ï¼Œå¯ä»¥é€šè¿‡æ‰‹åŠ¨å¤åˆ¶å…¶å¯¹è±¡è¡¨ç¤ºæ¥è¿›è¡Œå¤åˆ¶ï¼Œä¾‹å¦‚ç”¨ <a href="https://zh.cppreference.com/w/cpp/string/byte/memmove">std::memmove</a>ã€‚æ‰€æœ‰ä¸ C è¯­è¨€å…¼å®¹çš„æ•°æ®ç±»å‹ï¼ˆPOD ç±»å‹ï¼‰å‡ä¸ºå¯å¹³å‡¡å¤åˆ¶çš„ã€‚</p></blockquote><p>å½“ç„¶ï¼Œè¿™ä¸ä¸€å®šæ˜¯ç”¨æˆ·éœ€è¦çš„ã€‚è®²ä¸€ä¸ªæœ€ç®€å•çš„ä¾‹å­ï¼šæµ…æ‹·è´ã€‚ä¸‹é¢è¿™ä¸ªä¾‹å­ä½ å½“ç„¶ä¼šè€ƒè™‘ç”¨ <code>unique_ptr</code> ä¹‹ç±»çš„ä¸œè¥¿åŒ…ä½ï¼Œä½†æ˜¯å°±è¿™ä¹ˆåšç¤ºèŒƒçš„è¯ï¼Œç»“æœå¯èƒ½ä¼šå¾ˆå¥‡è‘©ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">x</span> &#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line"><span class="type">resource_t</span>* ptr_;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸å¹³å‡¡çš„æ—¶å€™ï¼Œè°ƒç”¨ä¹Ÿæ˜¯é€ä¸ªæŒ‰é¡ºåºè¿›è¡Œçš„ã€‚</p><h4 id="vptr-ä¸è¡Œä¸º"><a href="#vptr-ä¸è¡Œä¸º" class="headerlink" title="vptr ä¸è¡Œä¸º"></a>vptr ä¸è¡Œä¸º</h4><p>å‡è®¾ç±»å‹æœ‰ä¸€ä¸ªè™šæˆå‘˜å‡½æ•°ï¼Œé‚£ä¹ˆå®ƒç†åº”æ‹¥æœ‰ä¸€ä¸ª <code>vptr</code>, æ ¹æ® cppreference, å®ƒä¸ä¼šæ‹¥æœ‰å¹³å‡¡å¤åˆ¶æ„é€ å‡½æ•°ï¼Œå› ä¸ºå®ƒè¦å¯¹ <code>vptr</code> çš„å¤åˆ¶äº§ç”Ÿåˆæ³•çš„ç»“æœï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ZooAnimal</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"><span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">fn</span><span class="params">()</span> </span>&#123; <span class="comment">// ... &#125;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Bear</span>: ZooAnimal &#123;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">fn</span><span class="params">()</span> <span class="keyword">override</span> </span>&#123; <span class="comment">// ...&#125;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Bear b;</span><br><span class="line">ZooAnimal s = b;</span><br></pre></td></tr></table></figure><h3 id="ç¨‹åºè¯­ä¹‰è½¬æ¢"><a href="#ç¨‹åºè¯­ä¹‰è½¬æ¢" class="headerlink" title="ç¨‹åºè¯­ä¹‰è½¬æ¢"></a>ç¨‹åºè¯­ä¹‰è½¬æ¢</h3><p>(æ„Ÿè§‰è¿™ä¸€èŠ‚æ¯”è¾ƒåƒåœ¨ä»‹ç» RVO/NRVO/Copy Elision)</p><ul><li><a href="https://zh.cppreference.com/w/cpp/language/copy_elision">https://zh.cppreference.com/w/cpp/language/copy_elision</a></li></ul><p>ä¸Šè¿°åœ°å€ä»‹ç»äº†æ‰€æœ‰ç›¸å…³çš„æŠ€æœ¯ã€‚æ³¨æ„ NRVO ä¸æ˜¯å¼ºåˆ¶çš„ï¼Œæ‰€ä»¥ CppCoreGuidelines æœ‰ä¸‹åˆ—é“¾æ¥ï¼š</p><p><a href="[https://github.com/mapleFU/CppCoreGuidelines-zh-CN/blob/master/CppCoreGuidelines-zh-CN.md#p9-%E4%B8%8D%E8%A6%81%E6%B5%AA%E8%B4%B9%E6%97%B6%E9%97%B4%E6%88%96%E7%A9%BA%E9%97%B4](https://github.com/mapleFU/CppCoreGuidelines-zh-CN/blob/master/CppCoreGuidelines-zh-CN.md#p9-ä¸è¦æµªè´¹æ—¶é—´æˆ–ç©ºé—´">ä¸€ä¸ªä¸ä¿è¯ NRVO çš„ä¾‹å­</a>)</p><p>ä½ å¯èƒ½é˜²æ­¢é»˜è®¤çš„ move constructor å®ç°çš„è¯ï¼Œå¦‚æœ NRVO ä¸è¿›è¡Œï¼Œä¼˜åŒ–çš„èƒ½åŠ›ä¼šå‡å°‘ã€‚</p><h3 id="member-initialization-list"><a href="#member-initialization-list" class="headerlink" title="member initialization list"></a>member initialization list</h3><p>list ä¸­çš„åˆå§‹åŒ–æ¬¡åºæ˜¯ class ä¸­çš„ member å£°æ˜é¡ºåºå†³å®šçš„ã€‚é¡ºåº constructor, é€†åº destructor</p><p>èªæ˜çš„ç¼–è¯‘å™¨åº”è¯¥èƒ½å‘Šè¯‰ä½ å‡ºäº†é—®é¢˜ï¼Œæ‰€ä»¥åˆ«æ‹…å¿ƒhhhã€‚</p><p>å½“ç„¶ï¼Œå¦‚æœä½ å†™å‡ºä¸‹é¢çš„ä»£ç ï¼Œä»»ä½•ä¸€æœ¬ä¹¦éƒ½ä¼šé˜»æ­¢ä½ ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">X</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"><span class="built_in">X</span>(<span class="type">const</span> Y&amp; y) &#123;</span><br><span class="line">y_ = y;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">Y y_;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç¼–è¯‘å™¨ä¼šæŠŠåˆå§‹åŒ–æ’å…¥åœ¨ explicit çš„ä»£ç ä¹‹å‰ã€‚</p><h2 id="Data-çš„è¯­ä¹‰"><a href="#Data-çš„è¯­ä¹‰" class="headerlink" title="Data çš„è¯­ä¹‰"></a>Data çš„è¯­ä¹‰</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">X</span> &#123;&#125;;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Y</span>: <span class="keyword">public</span> <span class="keyword">virtual</span> X &#123;&#125;;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Z</span>: <span class="keyword">public</span> <span class="keyword">virtual</span> X &#123;&#125;;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">A</span>: <span class="keyword">public</span> Y, <span class="keyword">public</span> Z &#123;&#125;;</span><br></pre></td></tr></table></figure><p>å“¦ï¼Œè¿˜æœ‰ä¸€ä¸ªå¾ˆå¥½ç©çš„ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">H</span> &#123;</span><br><span class="line"><span class="type">int</span> s[];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸‹é¢è®©æˆ‘ä»¬æ¥çœ‹çœ‹å¯¹å®ƒä»¬è¿›è¡Œ <code>sizeof</code> çš„ç»“æœã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Created by mwish on 2020/7/14.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">X</span> &#123;&#125;;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DerivedX</span>: <span class="keyword">public</span> X &#123;&#125;;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Y</span>: <span class="keyword">public</span> <span class="keyword">virtual</span> X &#123;&#125;;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Z</span>: <span class="keyword">public</span> <span class="keyword">virtual</span> X &#123;&#125;;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">A</span>: <span class="keyword">public</span> Y, <span class="keyword">public</span> Z &#123;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">H</span> &#123;</span><br><span class="line">    <span class="type">int</span> s[];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">print_t_size</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    std::cout &lt;&lt; __PRETTY_FUNCTION__ &lt;&lt; <span class="string">&quot;:&quot;</span> &lt;&lt; <span class="built_in">sizeof</span>(T) &lt;&lt; <span class="string">&#x27;\n&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">print_t_size</span>&lt;X&gt;();</span><br><span class="line">    <span class="built_in">print_t_size</span>&lt;DerivedX&gt;();</span><br><span class="line">    <span class="built_in">print_t_size</span>&lt;Y&gt;();</span><br><span class="line">    <span class="built_in">print_t_size</span>&lt;Z&gt;();</span><br><span class="line">    <span class="built_in">print_t_size</span>&lt;A&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print_t_size</span>&lt;H&gt;();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¾“å‡ºï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">void print_t_size() [T = X]:1</span><br><span class="line">void print_t_size() [T = DerivedX]:1</span><br><span class="line">void print_t_size() [T = Y]:8</span><br><span class="line">void print_t_size() [T = Z]:8</span><br><span class="line">void print_t_size() [T = A]:16</span><br><span class="line">void print_t_size() [T = H]:0</span><br></pre></td></tr></table></figure><p>å®é™…ä¸Šï¼Œå¯ä»¥è€ƒè™‘çœ‹çœ‹ ebo: <a href="https://zh.cppreference.com/w/cpp/language/ebo">https://zh.cppreference.com/w/cpp/language/ebo</a></p><blockquote><p>ä¸ºä¿è¯åŒä¸€ç±»å‹çš„ä¸åŒå¯¹è±¡åœ°å€å§‹ç»ˆæœ‰åˆ«ï¼Œè¦æ±‚ä»»ä½•<a href="https://zh.cppreference.com/w/cpp/language/object">å¯¹è±¡</a>æˆ–æˆå‘˜å­å¯¹è±¡ï¼ˆé™¤éä¸º [[no_unique_address]] â€”â€”è§ä¸‹æ–‡ï¼‰ (C++20 èµ·)çš„å¤§å°è‡³å°‘ä¸º 1ï¼Œå³ä½¿è¯¥ç±»å‹æ˜¯ç©ºçš„<a href="https://zh.cppreference.com/w/cpp/language/class">ç±»ç±»å‹</a>ï¼ˆå³æ²¡æœ‰éé™æ€æ•°æ®æˆå‘˜çš„ class æˆ– structï¼‰ä¹Ÿæ˜¯å¦‚æ­¤ã€‚</p></blockquote><p>ï¼ˆä¹Ÿå¯ä»¥çœ‹çœ‹è¿™ä¸ª FAQ: <a href="https://isocpp.org/wiki/faq/classes-and-objects#sizeof-emptyï¼‰">https://isocpp.org/wiki/faq/classes-and-objects#sizeof-emptyï¼‰</a></p><p>æ‰€ä»¥ <code>static_assert(sizeof(X) &gt;= 1)</code> å¿…å®šæ˜¯æˆç«‹çš„ã€‚</p><p>ä¸€ä¸ªå¯¹è±¡çš„å¤§å°é¢å¤–å¼€é”€ï¼ˆç›¸å¯¹äºCè¯­è¨€é‚£æ ·æœ´ç´ çš„å¸ƒå±€ï¼‰åœ¨äºï¼š</p><ul><li>è¯­è¨€ <code>virtual base class</code> å’Œ <code>virtual</code> çš„é¢å¤–è´Ÿæ‹…ã€‚å…³äºè¿™ä¸ªè¿˜å¯ä»¥é˜…è¯»ï¼š<a href="https://zh.cppreference.com/w/cpp/named_req/StandardLayoutType">https://zh.cppreference.com/w/cpp/named_req/StandardLayoutType</a></li><li>ç¼–è¯‘å™¨çš„ä¸€äº›ç‰¹æ®Šå¤„ç†ï¼Œä¾‹å¦‚ä¸‹åˆ—æåˆ°çš„<em>ç©ºåŸºç±»ä¼˜åŒ–</em></li><li>Alignment: è¿™é‡Œä»‹ç»çš„æ¯”è¾ƒå¥½çš„æ˜¯ wiki çš„ã€‚</li></ul><p>è¿™é‡Œç»§ç»­è¯´ä¸€ä¸‹ ebo, å®šä¹‰ä¸€ä¸‹ï¼š</p><blockquote><p>è‹¥ç©ºåŸºç±»ä¹‹ä¸€äº¦ä¸ºé¦–ä¸ªéé™æ€æ•°æ®æˆå‘˜çš„ç±»å‹æˆ–å…¶ç±»å‹çš„åŸºç±»ï¼Œåˆ™ç¦ç”¨ç©ºåŸºä¼˜åŒ–ï¼Œå› ä¸ºè¦æ±‚ä¸¤ä¸ªåŒç±»å‹åŸºç±»å­å¯¹è±¡åœ¨æœ€ç»ˆæ´¾ç”Ÿç±»å‹çš„å¯¹è±¡è¡¨ç¤ºä¸­å¿…é¡»æ‹¥æœ‰ä¸åŒåœ°å€ã€‚</p></blockquote><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Compond2X</span> &#123;</span><br><span class="line">    X x_;</span><br><span class="line">    <span class="type">uint32_t</span> value;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span>  <span class="title class_">Derived3X</span>: <span class="keyword">public</span> X &#123;</span><br><span class="line">    X x_;</span><br><span class="line">    <span class="type">uint32_t</span> value;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>è¾“å‡ºï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// void print_t_size() [T = Derived2X]:4</span></span><br><span class="line"><span class="comment">// åº”ç”¨äº†ç©ºåŸºç±»ä¼˜åŒ–</span></span><br><span class="line"><span class="built_in">print_t_size</span>&lt;Derived2X&gt;();</span><br><span class="line"><span class="comment">// 8</span></span><br><span class="line"><span class="built_in">print_t_size</span>&lt;Compond2X&gt;();</span><br><span class="line"><span class="comment">// 8</span></span><br><span class="line"><span class="built_in">print_t_size</span>&lt;Derived3X&gt;();</span><br></pre></td></tr></table></figure><p>ä¹¦ä¸Š 3.1 èŠ‚ä»‹ç»äº†ç±»å’Œåç§°æŸ¥æ‰¾ç›¸å…³çš„ä¿¡æ¯ï¼Œæ„Ÿè§‰ä¹¦ä¸Šå†™çš„ä¸€èˆ¬ï¼Œæˆ‘ä¹Ÿæ²¡çœ‹å¤ªæ‡‚ï¼Œå°±ä¸è´´äº†ã€‚</p><h3 id="Data-Member-Layout"><a href="#Data-Member-Layout" class="headerlink" title="Data Member Layout"></a>Data Member Layout</h3><p>å½“ä½  <code>repr(C)</code> çš„æ—¶å€™ï¼Œå¯¹è±¡éƒ½æ˜¯æŒ‰é¡ºåºå¸ƒå±€çš„ï¼ŒC++ ä¸€å®šç¨‹åº¦ä¸Šæœ‰è¿™ä¸ªä¿è¯â€”â€”åªå¯¹åŒæ ·è®¿é—®æƒé™çš„å¯¹è±¡è€Œè¨€ã€‚</p><p>å…·ä½“æˆ‘æ‰¾åˆ°äº†è¿™ä¸ªé“¾æ¥ï¼š<a href="https://stackoverflow.com/questions/36149462/does-public-and-private-have-any-influence-on-the-memory-layout-of-an-object">https://stackoverflow.com/questions/36149462/does-public-and-private-have-any-influence-on-the-memory-layout-of-an-object</a></p><p>åªèƒ½è¯´å¦‚æœä½ æœ‰ä¾èµ–è¿™æ ·è¯­ä¹‰çš„æ“ä½œï¼Œè®°å¾— <code>static_assert</code>.</p><p>è€Œ <code>static member</code> å¹¶ä¸æ˜¯å¯¹è±¡çš„ä¸€éƒ¨åˆ†ï¼Œä¸å‚ä¸å¯¹è±¡çš„å¸ƒå±€ã€‚</p><h3 id="static-member-and-name-mangling"><a href="#static-member-and-name-mangling" class="headerlink" title="static member and name-mangling"></a>static member and name-mangling</h3><ul><li><a href="https://en.cppreference.com/w/cpp/language/identifiers">https://en.cppreference.com/w/cpp/language/identifiers</a></li><li><a href="https://en.cppreference.com/w/cpp/language/language_linkage">https://en.cppreference.com/w/cpp/language/language_linkage</a></li></ul><p>ä½ è¦æ˜¯ g++/clang++ ç¼–è¯‘è¿‡ C++ ä»£ç å¤§æ¦‚å°±ä¼šçŸ¥é“çš„â€¦</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>OS å’Œ Virtual Memory: RISC-V è§†è§’</title>
      <link href="/2020/06/17/OS-%E5%92%8C-Virtual-Memory-RISC-V-%E8%A7%86%E8%A7%92/"/>
      <url>/2020/06/17/OS-%E5%92%8C-Virtual-Memory-RISC-V-%E8%A7%86%E8%A7%92/</url>
      
        <content type="html"><![CDATA[<p>è¿™æ˜¯ä¸ª Ringï¼Œä»£è¡¨æˆ‘ä»¬ç”¨çš„ OS è½¯ä»¶çš„å±‚æ¬¡ç»“æ„ï¼š</p><p><img src="https://image.mwish.me/blog-image/A379A81B-5886-404B-9DE7-B290E7A5D1BE.png" alt="A379A81B-5886-404B-9DE7-B290E7A5D1BE"></p><p>åœ¨æ“ä½œç³»ç»Ÿä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°æ“ä½œç³»ç»Ÿçš„ä»»åŠ¡ã€èŒè´£ï¼š</p><ul><li>ç³»ç»Ÿå¼€å¯çš„ç¬¬ä¸€ä¸ªåº”ç”¨</li><li>æ§åˆ¶æ“ä½œç³»ç»Ÿçš„ IO</li><li>å¼€å¯æ–‡ä»¶ç³»ç»Ÿï¼Œç½‘ç»œæ ˆç­‰æœåŠ¡</li><li>ç¨‹åºçš„åŠ è½½å™¨å’Œè¿è¡Œç¨‹åºçš„ç®¡ç†è€…</li></ul><p>OS å·¥ä½œçš„æ ¸å¿ƒï¼š</p><ul><li>è¿è¡Œè¿›ç¨‹çš„ isolation</li><li>è®©ç³»ç»Ÿå’Œå¤–éƒ¨çš„ disk ç­‰é€šä¿¡ï¼Œå®Œæˆ IO ç­‰</li></ul><p>OS éœ€è¦ç¡¬ä»¶æ”¯æŒçš„éƒ¨åˆ†ï¼š</p><ul><li>memory translation<ul><li>æ¯ä¸ªè¿è¡Œçš„è¿›ç¨‹éœ€è¦ä» virtual çš„è¿›ç¨‹è½¬æˆç‰©ç†å†…å­˜</li><li>program å®é™…å¤„ç†çš„æ˜¯è™šæ‹Ÿå†…å­˜ï¼Œéœ€è¦ç¡¬ä»¶æ”¯æŒ</li></ul></li><li>protection and privilege<ul><li>éœ€è¦æä¾› user å’Œ supervisor çš„æ¨¡å¼ï¼Œåœ¨ RISC-V ä¸­æœ‰ machine å’Œ supervisor æ¨¡å¼</li></ul></li><li>æ›´ä½çš„å±‚æ¬¡ä¸èƒ½ä¿®æ”¹ memory mapping<ul><li>supervisor å¯ä»¥</li><li>supervisor æœ‰ç‹¬ç«‹äºç”¨æˆ·ç¨‹åºçš„ virtual åˆ° physical æ˜ å°„</li></ul></li><li>æä¾› traps å’Œ interruptï¼Œåœ¨å‘½ä»¤å±‚é¢æä¾›äº†åˆ° supervisor çš„æ–¹æ³•</li></ul><p>åœ¨ RISC-V ä¸­ï¼Œç¡¬ä»¶å¯ä»¥æä¾› Control and Status Registersï¼Œå³ CSR å¯„å­˜å™¨ï¼Œè¿™æ˜¯ä¸€ç»„å¯ä»¥åŸå­è¯»å†™çš„å¯„å­˜å™¨ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CSRRW rd rs csr</span><br></pre></td></tr></table></figure><p>ä¸Šè¿°è¯»å– <code>csr</code> å†™åˆ° <code>rd</code>, <code>rs</code> ä¸ä¸º0å†™åˆ° <code>csr</code>ã€‚è¿™ä¸æ˜¯æ™®é€šçš„å¯„å­˜å™¨ï¼Œç”¨æ¥ä¸ç¡¬ä»¶æ²Ÿé€š</p><p>æˆ‘ä»¬éœ€è¦ interrupt å’Œ exceptionsï¼Œå®ƒä»¬çš„ç›¸åŒç‚¹å’ŒåŒºåˆ«æ˜¯ï¼š</p><ul><li>interrupt æ˜¯ç¨‹åºå¤–éƒ¨å¯¹ç¨‹åºçš„ä¸­æ–­</li><li>exceptionï¼šè¿è¡Œç¨‹åºå†…éƒ¨ä¸¢çš„æ¯›ç—…ï¼šéœ€è¦è¯» csr, å¯èƒ½æ˜¯æ‰§è¡Œäº†è¿æ³•æŒ‡ä»¤ï¼Œæˆ–è€…è¯»äº†ä¸åˆæ³•å†…å­˜<ul><li><code>ECALL</code> ç”¨æ¥å®ç° syscall</li><li><code>EBREAK</code> åœ¨ç°åœ¨çš„ä¼˜å…ˆçº§å¼•å‘ exception</li></ul></li></ul><p>trap æœ‰ä¸€å®šçš„ flow: ç”±å…¶ä»–è¿›ç¨‹å¤„ç† â€”&gt; OS å¤„ç†</p><p>åœ¨ CS61C çš„å®šä¹‰ä¸­ï¼š</p><ul><li>interrupt: ç”±å¤–éƒ¨å¼•èµ·ï¼Œå¯¹äºç¨‹åºæ˜¯å¼‚æ­¥çš„</li><li>exception: ç”±å†…éƒ¨å¼•èµ·ï¼ŒåŒæ­¥</li><li>trap: éœ€è¦è·³åˆ° hardware å¤„ç†å¼‚å¸¸ï¼Œå¹¶è·³åˆ° interrupt or trap handler çš„ä»£ç </li></ul><p>Trap:</p><ul><li>Trap ä¹‹å‰çš„æŒ‡ä»¤éƒ½è¢«æ‰§è¡Œï¼Œä¹‹åçš„æŒ‡ä»¤åœ¨ trap è¿”å›ä¹‹å‰ä¸èƒ½è¢«æ‰§è¡Œ</li><li>å¾ˆå¤šæ—¶å€™ï¼Œå¦‚æœæŒ‡å®šäº† handlerï¼Œç”¨æˆ·ä¼šå­˜å‚¨è‡ªå·±çš„å¯„å­˜å™¨ï¼Œstack ç­‰ï¼Œç„¶åè¿”å›ã€‚<ul><li>interrupt å¤„ç†å™¨ä¸ä¸€å®šè¦ç†ç¡¬ä»¶ï¼Œå…¶ä»– trap å¯èƒ½ä¼šæœ‰ä¸ª trap code</li></ul></li></ul><p>ç¡¬ä»¶å¤„ç† interrupt:</p><ul><li>ç¡¬ä»¶éœ€è¦è°ƒæ•´ï¼Œå¤§éƒ¨åˆ†æƒ…å†µä¼šè°ƒæ•´åˆ° supervisor</li><li>ç¦æ­¢ interrupt</li><li>æŠŠæ—§çš„ç¨‹åºçš„ PC ç”¨ <code>csr</code> æŒ‡ä»¤å†™åˆ° <code>sepc</code></li><li>æŠŠ trap çš„åŸå› å†™å…¥csr å¯„å­˜å™¨ <code>scause</code></li><li>æŠŠ PC è®¾ç½®æˆ <code>stvec</code> å¯„å­˜å™¨<ul><li><code>stvec</code> è®¾ç½®äº† trap handler</li><li>å¤„ç† exception</li></ul></li></ul><p>å¯¹äºè½¯ä»¶è€Œè¨€ï¼Œéœ€è¦å¤„ç†çš„æ˜¯ï¼š</p><ul><li>ä¿å­˜æ‰€æœ‰å¯„å­˜å™¨</li><li>è¯»å¯¹åº”çš„ <code>csr</code> ï¼Œå‘ç°é™¤äº†ä»€ä¹ˆé—®é¢˜</li><li>æ¢å¤æ‰€æœ‰å¯„å­˜å™¨</li><li>è¿”å›ç¨‹åºåŸå…ˆçš„ä½ç½®</li></ul><p>ä¿å­˜å¯„å­˜å™¨ï¼š</p><ul><li>supervisor æ¨¡å¼ä¸‹ï¼Œåœ¨ <code>sscratch</code> å­˜å‚¨ trap handler</li><li><code>csrrw x1 x1 sscratch</code> å°† x1 ä¸ sccratch äº¤æ¢</li><li><code>sepc</code> è¿™ä¸ª CSR å¯„å­˜å™¨å¤„å†™ PC</li><li>æœ€åä¿å­˜ <code>x1</code>, æ¢å¤ <code>sscratch</code></li></ul><p><img src="https://image.mwish.me/blog-image/1A003613-A174-469A-87CE-3B6746CA8A47.png" alt="1A003613-A174-469A-87CE-3B6746CA8A47"></p><p>æ‰€ä»¥è¿™é‡Œå…ˆæŠŠæ‰€æœ‰ x1 ç›¸å…³çš„å‚æ•°å†™åˆ° <code>sscratch</code> çš„ä½ç½®ï¼Œç„¶åæŠŠ <code>sepc</code> å†™åˆ° x2ï¼Œå¹¶ç»§ç»­ä¿å­˜å®ƒã€‚ç„¶åæ¢å¤æˆ‘ä»¬ä¹‹å‰çš„ï¼ŒæŠŠ x1 ï¼ˆå³åŸæ¥çš„ <code>sscratch</code> ï¼‰å†™åˆ° <code>sscratch</code> ï¼ŒæŠŠåŸæ¥çš„ <code>sscratch</code> å†™åˆ° x2ã€‚è¿™ä¸ªæ—¶å€™å†æŠŠ <code>sscratch</code> å†™å›ã€‚</p><p>ä»¥ä¸Šæµç¨‹ç›¸å½“äºåœ¨ <code>sscratch</code> ä¿å­˜ <code>x1</code> <code>x2</code> â€¦ å†ä¿å­˜ <code>sepc</code>ã€‚</p><p>ç„¶åæˆ‘ä»¬éœ€è¦å†åé¢å†³å®šä¹‹åçš„è°ƒç”¨æ˜¯ä»€ä¹ˆï¼š</p><ul><li>å¦‚æœæ˜¯ä¸€ä¸ª <code>ECALL</code> æŒ‡ä»¤ï¼Œå°±æ‰§è¡Œå…·ä½“çš„ ecall</li><li>å¦‚æœæ˜¯ä¸åˆæ³•æŒ‡ä»¤ï¼Œç›´æ¥ kill</li><li>memory ç›¸å…³çš„å°±åŠ è½½å†…å­˜</li><li>timer interrupt å°±è¿›è¡Œ context switch</li></ul><p>å¤„ç†å®Œä¹‹åï¼Œæˆ‘ä»¬è¦æ¢å¤æ‰€æœ‰çš„å¯„å­˜å™¨ï¼Œ<code>ecall</code> éœ€è¦åœ¨ <code>a0</code> å†™è¿”å›å€¼ã€‚ç„¶åè°ƒç”¨<code>SRET</code> æŒ‡ä»¤ã€‚</p><p><code>sret</code> æŒ‡ä»¤è¿”å›ç¡¬ä»¶ï¼Œæˆ‘ä»¬åœ¨è°ƒç”¨ <code>sret</code> ä¹‹å‰è¦å…ˆå¤„ç† <code>ecall</code> ä¹‹ååšçš„è½¯ä»¶è¡Œä¸ºï¼š</p><ul><li>æ¢å¤æ‰€æœ‰çš„å¯„å­˜å™¨</li><li>æ¢å¤ <code>sepc</code>ï¼Œå¦‚æœæ˜¯ <code>ecall</code>, è¿”å› PC + 4 å¯¹åº”çš„ä½ç½®</li><li>æ¢å¤æ‰€æœ‰çš„å…¶ä»–å¯„å­˜å™¨ï¼Œ<ul><li>å¯èƒ½éœ€è¦è·³è½¬åˆ° <code>sscratch</code></li><li>å¦‚æœæ˜¯ <code>ecall</code>ï¼Œè®¾ç½® <code>a0</code> ä½œä¸ºè¿”å›å€¼</li></ul></li><li>æ‰§è¡Œ <code>sret</code></li></ul><p><code>sret</code> å’Œ <code>ecall</code> å¯¹åº”ï¼Œæœ‰ç€ä¸‹åˆ—çš„ç¡¬ä»¶è¡Œä¸ºï¼š</p><ul><li>æ¢å¤ interrupt</li><li>ä» supervisor å›åˆ° user level</li><li><code>spec</code> ä¸­æ¢å¤ <code>pc</code></li><li>ç»§ç»­è¿è¡Œ</li></ul><h3 id="åŠŸèƒ½å’Œä»£ä»·"><a href="#åŠŸèƒ½å’Œä»£ä»·" class="headerlink" title="åŠŸèƒ½å’Œä»£ä»·"></a>åŠŸèƒ½å’Œä»£ä»·</h3><p>interrupt çš„åŠŸèƒ½ï¼š</p><p>åœ¨ user mode, ç¨‹åºä¸èƒ½æ§åˆ¶ virtual memoryï¼Œä½†æ˜¯å¯ä»¥æ”¹å˜è™šæ‹Ÿå†…å­˜çš„å†…å®¹ã€‚</p><p>è¿™ä»½è™šæ‹Ÿå†…å­˜ä¸ <code>satp</code> è¿™ä¸ª csr å¯„å­˜å™¨æœ‰å…³ï¼Œ<code>satp</code> æ˜¯ page table pointerï¼Œè¡¨ç¤ºç‰©ç†å†…å­˜ä¸Šçš„é¡µè¡¨ã€‚</p><p>è¿™è®©è°ƒç”¨ trap handler ä¹‹å¤–ä¸ä¼š trap ç³»ç»Ÿè°ƒç”¨ã€‚</p><p>interrupt çš„ä»£ä»·ï¼š</p><ul><li>éœ€è¦ flush pipeline</li><li>éœ€è¦ä¿å­˜å’Œæ¢å¤æ‰€æœ‰çš„å¯„å­˜å™¨</li><li>å› ä¸º trap handler æ˜¯ä¸ç›¸å…³çš„ä»£ç ï¼Œæ‰€ä»¥ cache å¯èƒ½å—å½±å“</li></ul><h3 id="Context-Switch"><a href="#Context-Switch" class="headerlink" title="Context Switch"></a>Context Switch</h3><p>ç¡¬ä»¶æ”¯æŒäº† timer interrupt, è§¦å‘çš„æ—¶å€™ï¼Œç¡¬ä»¶æ‰§è¡Œ context switchï¼ŒæŠŠå¯„å­˜å™¨ <code>sscratch</code> å‘¨å›´å­˜å‚¨çš„å¯„å­˜å™¨å­˜åˆ°ç°æœ‰è¿›ç¨‹çš„æ•°æ®ç»“æ„ä¸­ï¼Œç„¶åæŠŠ <code>satp</code> å’Œç›¸å…³æ‹·è´åˆ° memory mapping ç›¸å…³çš„æ•°æ®ç»“æ„ä¸­ã€‚ç„¶åæ ¹æ® scheduler æ¥é€‰æ‹©ç›®æ ‡è¿›ç¨‹ï¼Œæ¢å¤ç›®æ ‡è¿›ç¨‹çš„ <code>satp</code> <code>sepc</code> ç­‰ï¼Œå¹¶è°ƒç”¨ <code>sret</code> è¿”å›ã€‚</p><h2 id="IO"><a href="#IO" class="headerlink" title="IO"></a>IO</h2><p>CPU éœ€è¦ä¸ä¸åŒçš„ IO è®¾å¤‡äº¤äº’ã€‚</p><p><img src="https://image.mwish.me/blog-image/äº¤äº’.png" alt="äº¤äº’"></p><p>è½¯ä»¶å¸Œæœ›ï¼šè¾“å…¥/è¾“å‡ºä¸€å † bytesï¼ŒåŒæ—¶å¸Œæœ›èƒ½å¤Ÿæä¾›ä¸€äº› memory ç›¸å…³çš„æ¥å£æˆ–è€…ç‹¬ç«‹çš„æŒ‡ä»¤ã€‚</p><p>å¯¹äº memory mapped I/O, å¯¹äºä¸€æ®µ address, æˆ‘ä»¬å¯ä»¥ç”¨ lw/sw ç­‰æŒ‡ä»¤å¤„ç† IOã€‚</p><p>ä¸‹é¢æ˜¯è¯¾ä»¶ä¸Šçš„ä¸€äº› memory mapping çš„æ•ˆç‡ï¼Œç»“è®ºæ˜¯ IO è®¾å¤‡å¤„ç†æ•°æ®çš„é€Ÿåº¦æ˜¯è¿œæ…¢äº CPU çš„</p><p><img src="https://image.mwish.me/blog-image/391D529F-58C6-49C2-9448-EF5A47ACCA76.png" alt="391D529F-58C6-49C2-9448-EF5A47ACCA76"></p><p>åŒé€šç”¨åœºæ™¯ä¸‹ï¼Œ device registers æœ‰ä¸¤ä¸ªå¯„å­˜å™¨ï¼š</p><ul><li>control register: è¡¨ç¤º I/O æ˜¯å¦ ready</li><li>data register: åŒ…å«æ•°æ®</li></ul><p>å¸¸ç”¨çš„æ‰‹æ®µåŒ…å« </p><ol><li>polling: PIO è½®è¯¢ control register ï¼Œçœ‹çœ‹æ˜¯å¦å‡†å¤‡å¥½äº†ã€‚è¿™æ ·æ¯”è¾ƒæ¶ˆè€— cpu</li><li>interrupt: ç¡¬ä»¶åœ¨æœ‰æ•°æ®çš„æ—¶å€™è§¦å‘ interruptï¼Œåœ¨ IO é¢‘ç‡é«˜çš„æƒ…å†µä¸‹ï¼Œä¾‹å¦‚é¼ æ ‡ã€é”®ç›˜ã€ç½‘ç»œç­‰ï¼Œå®é™…ä¸Šä¼šè§¦å‘å¾ˆå¤šçš„ IO</li><li>DMA</li></ol>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>RISC-V å…¥é—¨ Part2: ABI &amp;&amp; Calling Convention</title>
      <link href="/2020/06/07/RISC-V-%E5%85%A5%E9%97%A8-Part2/"/>
      <url>/2020/06/07/RISC-V-%E5%85%A5%E9%97%A8-Part2/</url>
      
        <content type="html"><![CDATA[<h1 id="RISC-V-å…¥é—¨-Part2-ABI-amp-amp-Calling-Convention"><a href="#RISC-V-å…¥é—¨-Part2-ABI-amp-amp-Calling-Convention" class="headerlink" title="RISC-V å…¥é—¨ Part2: ABI &amp;&amp; Calling Convention"></a>RISC-V å…¥é—¨ Part2: ABI &amp;&amp; Calling Convention</h1><p>é•¿åº¦å•ä½ï¼š</p><ul><li><code>b</code> byte</li><li><code>h</code> halfword</li><li><code>w</code> word</li></ul><p><code>i</code> çš„å°¾å ä»£è¡¨ <code>imm</code>, ç«‹å³æ•°, æ¯”å¦‚ <code>addi</code>, <code>andi</code></p><p><code>jump</code> åŸºäº<code>jalr</code> ï¼Œè¿™ä¸ª <code>r</code> æ˜¯ registerã€‚</p><hr><p>uç±»æŒ‡ä»¤æ ¼å¼:</p><ul><li><code>lui</code>: load upper immediate, ç”¨äºæ„é€ ä¸€ä¸ª 32-bit constants</li><li><code>auipc</code>: add upper immediate to PC. PC +  åç§»é‡å†™å…¥ <code>register</code></li></ul><hr><p>æˆ‘ä»¬ä¸Šä¸€ä¸ª Part ä»‹ç»äº† bne ç­‰ conditional branchï¼Œæ­¤å¤–è¿˜æœ‰éš¾ç†è§£ä¸€äº›çš„ unconditional branch. ä¾‹å¦‚ä¼ªæŒ‡ä»¤ <code>j</code>, å®ƒåŸºäº <code>jal</code>, å³ jump and link å®ç°ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">jal rd offset</span><br><span class="line">jalr rd rs (offset)</span><br></pre></td></tr></table></figure><p>jal ç”¨æ¥å®ç°å‡½æ•°è°ƒç”¨çš„è¯­ä¹‰ï¼šå®ƒ PC è·³è½¬ <code>offset</code> ï¼ˆé•¿åº¦ä¸º 20bitsï¼‰ï¼Œæˆ–è€…å¯¹åº”çš„å¯„å­˜å™¨ï¼Œç„¶åæŠŠ PC + 4 ï¼ˆRV32I æŒ‡ä»¤é•¿åº¦æ˜¯ 32bit, å³ 4Byteï¼Œè¡¨ç¤ºä¸‹ä¸€æ¡æŒ‡ä»¤ï¼‰å†™åˆ° <code>rd</code> å¯„å­˜å™¨ã€‚</p><p><code>jal</code> ç”¨æ¥å®ç°å‡½æ•°è°ƒç”¨å’Œå¾ªç¯ä¸­çš„ unconditional jump.</p><h2 id="C-to-RISC-V"><a href="#C-to-RISC-V" class="headerlink" title="C to RISC-V"></a>C to RISC-V</h2><p><img src="https://image.mwish.me/blog-image/DC87168C-5240-43EA-9A36-40D0E23563F3.png" alt="DC87168C-5240-43EA-9A36-40D0E23563F3"></p><p>ä¸Šé¢è¿™å¼ å›¾ cmu 15-445 æœ‰æ›´å¥½ç©çš„ç‰ˆæœ¬ã€‚</p><p><img src="https://image.mwish.me/blog-image/8D576B0E-28AC-450C-9752-9088942AB8C4.png" alt="8D576B0E-28AC-450C-9752-9088942AB8C4"></p><p>è¿™é‡Œé¢å†™äº†è°ƒç”¨ä¸€ä¸ªå‡½æ•°çš„6æ­¥ï¼Œå³å‡½æ•°è°ƒç”¨è§„èŒƒ(<strong>Calling convention</strong>) . </p><ul><li>æŠŠå‡½æ•°å‚æ•°æ”¾åˆ°å‡½æ•°èƒ½è®¿é—®çš„åœ°æ–¹</li><li>æŠŠæ§åˆ¶æƒç»™å‡½æ•°ï¼ˆä½¿ç”¨ <code>jal</code> æŒ‡ä»¤ï¼‰</li><li>æ‹¿åˆ° memory ä¸­çš„èµ„æº ï¼ˆè·å–å‡½æ•°éœ€è¦çš„å±€éƒ¨å­˜å‚¨èµ„æºï¼ŒæŒ‰éœ€ä¿å­˜å¯„å­˜å™¨ï¼‰</li><li>è¿è¡Œå‡½æ•°ä¸­çš„æŒ‡ä»¤</li><li>æŠŠå€¼å†™åˆ° memory/register ä¸­ ï¼ˆå°†è¿”å›å€¼å­˜å‚¨åˆ°è°ƒç”¨è€…èƒ½å¤Ÿè®¿é—®åˆ°çš„ä½ç½®ï¼Œæ¢å¤å¯„å­˜å™¨ï¼Œé‡Šæ”¾å±€éƒ¨å­˜å‚¨èµ„æºï¼‰</li><li>è¿”å› ( <code>ret</code> æŒ‡ä»¤)</li></ul><p>å¯„å­˜å™¨æœ‰ <em>caller-saved</em> å’Œ <em>callee-saved</em> ä¸¤ç§ï¼š</p><ul><li><em>caller-saved</em>: callee å¯ä»¥éšä¾¿æï¼Œä»è¿™é‡Œè¯»æ•°æ®ï¼Œç„¶åæ“ä½œå®ƒä»¬</li><li><em>callee-saved</em>: callee åœ¨è¿”å›å‰åº”è¯¥ä¿å­˜çš„</li></ul><p>ABIï¼šè°ƒç”¨å…¶å®ƒå‡½æ•°æ—¶ï¼Œå…³äºæ±‡ç¼–ã€å‚æ•°ã€å¯„å­˜å™¨ç­‰çš„åŒæ–¹çº¦å®šã€‚ï¼ˆæˆ‘è§‰å¾—æœ‰å‡ ä¸ªç­”æ¡ˆè¡¥å……çš„å¾ˆå¥½ï¼‰. å®é™…ä¸Š ABI å…¼å®¹æ€§æ˜¯ä¸€ä¸ªå’Œç¼–è¯‘å™¨ç­‰éƒ½æœ‰å…³çš„è¯é¢˜ã€‚ABI å®šä¹‰äº† calling conventionï¼ŒåŒæ—¶ ABI å®šä¹‰äº†çº¦æŸï¼šæœ‰äº›å¯„å­˜å™¨æ˜¯ä¸å¯å†™çš„ã€‚</p><p>åŒæ—¶ï¼Œä½ å¯ä»¥åœ¨ä¸Šé¢çš„å›¾é‡Œé¢çœ‹åˆ°å¾ˆå¥‡å¦™çš„äº‹æƒ…ï¼Œè¿™é‡Œæ²¡æœ‰å†ä½¿ç”¨ <code>x0</code> - <code>x15</code> è¿™æ ·çš„è®°å·ï¼Œè€Œæ˜¯ç”¨äº† <code>s0</code> <code>fp</code> è¿™æ ·ç›¸å¯¹æ¥è¯´åå­—å¥½ç†è§£ä¸€äº›çš„ã€‚</p><hr><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">Leaf</span><span class="params">(<span class="type">int</span> g, <span class="type">int</span> h, <span class="type">int</span> i, <span class="type">int</span> j)</span> </span>&#123;</span><br><span class="line">    <span class="type">int</span> f;</span><br><span class="line">    f = (g + h) - (i + j);</span><br><span class="line">    <span class="keyword">return</span> f;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”¨ <code>riscv64-unknown-elf-gcc</code> ç¼–è¯‘</p><p>å¯ä»¥çœ‹åˆ°ï¼Œä¸ºäº†å­˜æ”¾æ—§çš„å€¼ï¼Œéœ€è¦ stack.<code>sp</code> å¯„å­˜å™¨å’Œ stack æœ‰å…³ï¼ŒåŒæ—¶æœ‰ push/pop. é‰´äº stack æ˜¯è‡ªé¡¶å‘ä¸‹ç”Ÿé•¿çš„ï¼Œpush ä¼šå‡å° <code>sp</code>, pop ä¼šå¢å¤§ <code>sp</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">âœ— riscv64-unknown-elf-gcc -march=rv32imac -mabi=ilp32 -S leaf.c </span><br></pre></td></tr></table></figure><p>ç¼–è¯‘ä¸€ä¸‹ leaf:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">.file&quot;leaf.c&quot;</span><br><span class="line">.option nopic</span><br><span class="line">.attribute arch, &quot;rv32i2p0_m2p0_a2p0_c2p0&quot;</span><br><span class="line">.attribute unaligned_access, 0</span><br><span class="line">.attribute stack_align, 16</span><br><span class="line">.text</span><br><span class="line">.align1</span><br><span class="line">.globlLeaf</span><br><span class="line">.typeLeaf, @function</span><br><span class="line">Leaf:</span><br><span class="line">addisp,sp,-48 # ä¿®æ”¹ stack, é™ä½ä»¥ push å€¼</span><br><span class="line">sws0,44(sp)   # æŠŠ s0 å†™è¿› 44(sp), s0 è¿™é‡Œä»£è¡¨ frame pointer</span><br><span class="line">addis0,sp,48  # s0 = sp + 48, s0 ä¸º frame pointer</span><br><span class="line">swa0,-36(s0)  # æŠŠ a0 - a3 å­˜äº†ã€‚a0-a1 ç”¨æ¥å­˜è¿”å›å€¼ï¼Œa0-a7 ç”¨æ¥ä¼ å‚</span><br><span class="line">swa1,-40(s0)</span><br><span class="line">swa2,-44(s0)</span><br><span class="line">swa3,-48(s0)</span><br><span class="line"></span><br><span class="line">lwa4,-36(s0) # æŠŠåŸæœ¬ a0 a1 åŠ è½½åˆ° a4 a5</span><br><span class="line">lwa5,-40(s0)</span><br><span class="line">adda4,a4,a5   # a4 = a4 + a5</span><br><span class="line">lwa3,-44(s0) # a3, a5 åŠ è½½</span><br><span class="line">lwa5,-48(s0)</span><br><span class="line">adda5,a3,a5 # a5 = a3 + a5</span><br><span class="line">suba5,a4,a5   # a5 = a4 - a5  è¿™ä¸¤æ®µå®Œæˆå‡½æ•°ä¸»è¦çš„è®¡ç®—</span><br><span class="line">swa5,-20(s0) </span><br><span class="line">lwa5,-20(s0)</span><br><span class="line">mva0,a5 # a0 = a5, a0 æ˜¯è¿”å›å€¼</span><br><span class="line">lws0,44(sp) # s0 = sp + 44</span><br><span class="line">addisp,sp,48 # ä¿®æ”¹ sp</span><br><span class="line">jrra # ra æ˜¯ return address, è¿”å› ra</span><br><span class="line">.sizeLeaf, .-Leaf</span><br><span class="line">.ident&quot;GCC: (GNU) 9.2.0&quot;</span><br></pre></td></tr></table></figure><ul><li>æ”¹å˜ <code>s0</code> è¿™ä¸ª frame pointer å’Œ <code>sp</code> è¿™ä¸ª stack pointer</li><li>æŠŠåŸæ¥çš„ <code>a0 - a4</code> æ”¾åˆ°æ ˆä¸Š</li><li>ç”¨ <code>a4 a5</code> æ¥è¿ç®—</li><li>æ”¹å› <code>sp, s0</code></li><li><code>jr</code> è¿”å›</li></ul><p>è·³è½¬å›æ¥çš„ä¼ªæŒ‡ä»¤å¦‚ä¸‹ï¼š</p><p><img src="https://image.mwish.me/blog-image/C5B138C9-1928-4101-A199-E972CF81657F.png" alt="C5B138C9-1928-4101-A199-E972CF81657F"></p><p><img src="https://image.mwish.me/blog-image/B488D822-AF29-4ACB-82B0-D02416ADCA81.png" alt="B488D822-AF29-4ACB-82B0-D02416ADCA81"></p><p>é¡ºä¾¿ï¼Œ<code>-O2</code> ç¼–è¯‘çš„æ—¶å€™ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">.file&quot;leaf.c&quot;</span><br><span class="line">.option nopic</span><br><span class="line">.attribute arch, &quot;rv32i2p0_m2p0_a2p0_c2p0&quot;</span><br><span class="line">.attribute unaligned_access, 0</span><br><span class="line">.attribute stack_align, 16</span><br><span class="line">.text</span><br><span class="line">.align1</span><br><span class="line">.globlLeaf</span><br><span class="line">.typeLeaf, @function</span><br><span class="line">Leaf:</span><br><span class="line">adda0,a0,a1</span><br><span class="line">adda2,a2,a3</span><br><span class="line">suba0,a0,a2</span><br><span class="line">ret</span><br><span class="line">.sizeLeaf, .-Leaf</span><br><span class="line">.ident&quot;GCC: (GNU) 9.2.0&quot;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œ <code>a0, a1, a2, a3</code> å››ä¸ªæ˜¯å‚æ•°ã€‚</p><p>ä¸‹é¢ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">mult</span><span class="params">(<span class="type">int</span>, <span class="type">int</span>)</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">sumSquare</span><span class="params">(<span class="type">int</span> x, <span class="type">int</span> y)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> mult(x, x) + y;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”Ÿæˆæ±‡ç¼–ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">.file&quot;ss.c&quot;</span><br><span class="line">.option nopic</span><br><span class="line">.attribute arch, &quot;rv32i2p0_m2p0_a2p0_c2p0&quot;</span><br><span class="line">.attribute unaligned_access, 0</span><br><span class="line">.attribute stack_align, 16</span><br><span class="line">.text</span><br><span class="line">.align1</span><br><span class="line">.globlsumSquare</span><br><span class="line">.typesumSquare, @function</span><br><span class="line">sumSquare:</span><br><span class="line">addisp,sp,-16 # reserve space on stack</span><br><span class="line">swra,12(sp)   # save ret addr</span><br><span class="line">sws0,8(sp)# å­˜å‚¨åŸæ¥çš„ s0</span><br><span class="line">mvs0,a1# s0 å­˜å‚¨ y</span><br><span class="line">mva1,a0# a1 = a0 (= x)</span><br><span class="line">callmult</span><br><span class="line">adda0,a0,s0</span><br><span class="line">lwra,12(sp)</span><br><span class="line">lws0,8(sp)</span><br><span class="line">addisp,sp,16</span><br><span class="line">jrra</span><br><span class="line">.sizesumSquare, .-sumSquare</span><br><span class="line">.ident&quot;GCC: (GNU) 9.2.0&quot;</span><br></pre></td></tr></table></figure><hr><h2 id="Stack-Pointer-amp-Frame-Pointer-amp-Memory"><a href="#Stack-Pointer-amp-Frame-Pointer-amp-Memory" class="headerlink" title="Stack Pointer &amp; Frame Pointer &amp; Memory"></a>Stack Pointer &amp; Frame Pointer &amp; Memory</h2><p>å½“ç„¶ï¼Œä»¥ä¸Šæ¼”ç¤ºçš„å¾ˆå¤šéƒ½åœ¨ stack ä¸Šï¼Œå®é™…ä¸Šæˆ‘ä»¬å¯èƒ½éœ€è¦æ‰“ç†çš„ä¸œè¥¿è¿˜æ›´å¤šï¼š</p><p><img src="https://image.mwish.me/blog-image/QQ20201003-0.png" alt="QQ20201003-0"></p><p>å †/æ ˆçš„åˆ†é…æ˜¯ ISA çš„ä¸€éƒ¨åˆ†ï¼ˆæŒ‡ä»¤é›†åŒæ ·æ˜¯ ISA çš„ä¸€éƒ¨åˆ†ï¼‰</p><p><img src="https://image.mwish.me/blog-image/6F1CCA2D-7402-4958-92E0-14B74AED1E8E.png" alt="6F1CCA2D-7402-4958-92E0-14B74AED1E8E"></p><p>ä»¥ä¸Šæ˜¯å¯¹ stack çš„æ“ä½œï¼Œåœ¨ x86 é‡Œé¢æˆ‘ä»¬æœ‰åŸå­çš„ push-pop, ä½†æ˜¯è¿™é‡Œæˆ‘ä»¬å¾—è°¨æ…çš„å¤šã€‚</p><p>çœ‹å‰é¢é‚£ä¸ª s0 çš„ä¾‹å­ï¼Œç”¨ frame pointer(<code>s0</code>) è€Œä¸æ˜¯ sp å–åœ°å€ç›¸å¯¹å€¼. åŒæ—¶æˆ‘ä»¬è¿˜æœ‰ <code>fp</code>, å³ frame pointer, å®ƒä¸­æ–‡å«â€œå¸§æŒ‡é’ˆâ€ã€‚</p><blockquote><p>The calling convention says it doesnâ€™t matter if you use a frame pointer or not!</p><p>It is just a callee saved register, so if you use it as a frame pointerâ€¦â€¨ It will be preserved just like any other saved register.</p><p>But if you just use it as <strong>s0</strong>, that makes no difference!</p></blockquote><p>æ ˆå¸§å†…è¿”å›åœ°å€æ˜¯åœ¨local variableså‰è¿˜æ˜¯åœ¨å®ƒä»¬åé¢ï¼Ÿ - RednaxelaFXçš„å›ç­” - çŸ¥ä¹ <a href="https://www.zhihu.com/question/33920941/answer/57597076">https://www.zhihu.com/question/33920941/answer/57597076</a></p><p>å®é™…ä¸Š fp sp å…³ç³»ç±»ä¼¼<code>fp</code> â€”  <code>sp</code> , åŒæ—¶ <code>fp</code> ä¸æ˜¯å¿…é¡»çš„ï¼Œä½†æ˜¯å¯¹ debug è€Œè¨€å¤§æœ‰è£¨ç›Šã€‚</p><p>æ¥ç€ä¸¾ä¾‹å­ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">list</span> &#123;</span></span><br><span class="line">    <span class="type">void</span> *car;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list</span> *<span class="title">cdr</span>;</span></span><br><span class="line">&#125; List;</span><br><span class="line"></span><br><span class="line">List *<span class="title function_">map</span><span class="params">(List *src, <span class="type">void</span> *(*f)(<span class="type">void</span> *))</span> &#123;</span><br><span class="line">    List *ret;</span><br><span class="line">    <span class="keyword">if</span> (!src)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    ret = (List *)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(List));</span><br><span class="line">    ret-&gt;car = (*f)(src-&gt;car);</span><br><span class="line">    ret-&gt;car = <span class="built_in">map</span>(src-&gt;cdr, f);</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç¼–è¯‘ä¸€ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">.file&quot;rich-list.c&quot;</span><br><span class="line">.option nopic</span><br><span class="line">.attribute arch, &quot;rv32i2p0_m2p0_a2p0_c2p0&quot;</span><br><span class="line">.attribute unaligned_access, 0</span><br><span class="line">.attribute stack_align, 16</span><br><span class="line">.text</span><br><span class="line">.align1</span><br><span class="line">.globlmap</span><br><span class="line">.typemap, @function</span><br><span class="line">map:</span><br><span class="line">addisp,sp,-16</span><br><span class="line">swra,12(sp)</span><br><span class="line">sws0,8(sp) # å­˜å‚¨ s0-s2</span><br><span class="line">sws1,4(sp) </span><br><span class="line">sws2,0(sp)</span><br><span class="line">beqa0,zero,.L3 # is-null, a0 æ˜¯ src</span><br><span class="line">mvs0,a0    # save src</span><br><span class="line">lia0,8     # a0 = 8, call malloc with size 8</span><br><span class="line">mvs2,a1 # s2 = a1</span><br><span class="line">callmalloc</span><br><span class="line">mvs1,a0</span><br><span class="line">lwa0,0(s0)</span><br><span class="line">jalrs2  # jalr è°ƒç”¨å‡½æ•°ï¼Œa1 æ˜¯ä¸€ä¸ª function</span><br><span class="line">mva5,a0</span><br><span class="line">lwa0,4(s0)</span><br><span class="line">swa5,0(s1)</span><br><span class="line">mva1,s2</span><br><span class="line">callmap</span><br><span class="line">lwra,12(sp)</span><br><span class="line">lws0,8(sp)</span><br><span class="line">swa0,0(s1)</span><br><span class="line">lws2,0(sp)</span><br><span class="line">mva0,s1</span><br><span class="line">lws1,4(sp)</span><br><span class="line">addisp,sp,16</span><br><span class="line">jrra</span><br><span class="line">.L3:# is-null, ç›´æ¥è¿”å›äº†</span><br><span class="line">lwra,12(sp)</span><br><span class="line">lws0,8(sp)</span><br><span class="line">lis1,0      # li rd, imm è¯»å–ç«‹å³æ•°ï¼Œè¿™é‡ŒæŠŠ s1, å³è¿”å›å€¼ï¼Œç½®ä¸º0</span><br><span class="line">lws2,0(sp)</span><br><span class="line">mva0,s1     # a0 = 0</span><br><span class="line">lws1,4(sp)</span><br><span class="line">addisp,sp,16</span><br><span class="line">jrra</span><br><span class="line">.sizemap, .-map</span><br><span class="line">.ident&quot;GCC: (GNU) 9.2.0&quot;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„ requirements æ˜¯ï¼šæˆ‘ä»¬ä¼šè°ƒç”¨ <code>malloc</code>, å¹¶åœ¨ä¹‹åä½¿ç”¨ <code>src</code> å’Œ <code>f</code> å‚æ•°</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>LevelDB memtable</title>
      <link href="/2020/06/02/LevelDB-memtable/"/>
      <url>/2020/06/02/LevelDB-memtable/</url>
      
        <content type="html"><![CDATA[<h2 id="SkipList"><a href="#SkipList" class="headerlink" title="SkipList"></a>SkipList</h2><p><a href="https://en.wikipedia.org/wiki/Skip_list">SkipList</a> ä»‹ç»çš„åœ°æ–¹åº”è¯¥æ¯”è¾ƒå¤šï¼Œé‚“ä¿Šæ™–è€å¸ˆæ•°æ®ç»“æ„ 9.2 èŠ‚å¯¹å®ƒçš„æ—¶ç©ºå¤æ‚åº¦éƒ½æœ‰ä¸€ä¸ªåˆ†æã€‚ç›¸å¯¹äºæˆ‘ä»¬å¸¸ç”¨çš„ binary search tree, SkipList æ—¶ç©ºæ•ˆç‡éƒ½æœ‰ä¸€ç‚¹ä¸å¦‚ã€‚ä½†æ˜¯å¦‚æœè¦å®ç°<strong>Thread-safe ordered maps</strong>ï¼ŒSkipList ç›¸å¯¹ç®€å•ï¼Œè€Œä¸”å¯ä»¥åˆ©ç”¨ lock-free çš„æ–¹å¼åšä¸€äº›å¾ˆæ£’çš„ä¼˜åŒ–ã€‚</p><p>ä»‹ç» LevelDB SkipList, æœ¬æ–‡é‡ç‚¹å…³æ³¨å®ƒæ˜¯å¦‚ä½•å®ç°ä¸€å†™å¤šè¯»çš„è¯­ä¹‰çš„ã€‚</p><p><a href="https://github.com/google/leveldb/blob/master/db/skiplist.h#L8">https://github.com/google/leveldb/blob/master/db/skiplist.h#L8</a> </p><p>è¿™æ®µæ³¨é‡Šæåˆ°äº†å‡ ç‚¹ï¼š</p><ul><li>å†™å…¥æ“ä½œéœ€è¦å¤–éƒ¨åŒæ­¥ï¼Œåªèƒ½å•çº¿ç¨‹çš„å†™å…¥ã€‚è¿™ä¸ªæˆ‘ä»¬ä¹‹å‰ä»‹ç» <code>Put</code> çš„æ—¶å€™å¤§æ¦‚è®²è¿‡å®ƒæ˜¯æ€ä¹ˆå®ç°çš„ã€‚</li><li>SkipList è¿™é‡Œåªä¼š<code>Insert</code> å’Œ <code>Get</code>, åˆ©ç”¨ <code>Arena</code> ç”³è¯·å†…å­˜ï¼Œåœ¨SkipList ä½¿ç”¨å®Œæ¯•çš„æ—¶å€™ï¼Œä¸€èµ·é‡Šæ”¾å†…å­˜ã€‚</li><li>å·²ç»æ’å…¥çš„æ•°æ®ä¸ä¼šè¢«æ›´æ–°</li></ul><p>åŒæ—¶ï¼Œé˜…è¯»ä»£ç ä¹‹å‰éœ€è¦æ³¨æ„ï¼šSkipList æŠŠæ‰€æœ‰ä¿¡æ¯éƒ½ä¸¢åˆ° Key é‡Œå»äº†</p><p>æ¯”è¾ƒæœ‰è¶£çš„æ˜¯ <code>Node</code> çš„ barrier:</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Implementation details follow</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> Key, <span class="keyword">class</span> <span class="title class_">Comparator</span>&gt;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">SkipList</span>&lt;Key, Comparator&gt;::Node &#123;</span><br><span class="line">  <span class="function"><span class="keyword">explicit</span> <span class="title">Node</span><span class="params">(<span class="type">const</span> Key&amp; k)</span> : key(k) &#123;</span>&#125;</span><br><span class="line"></span><br><span class="line">  Key <span class="type">const</span> key;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Accessors/mutators for links.  Wrapped in methods so we can</span></span><br><span class="line">  <span class="comment">// add the appropriate barriers as necessary.</span></span><br><span class="line">  <span class="function">Node* <span class="title">Next</span><span class="params">(<span class="type">int</span> n)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">assert</span>(n &gt;= <span class="number">0</span>);</span><br><span class="line">    <span class="comment">// Use an &#x27;acquire load&#x27; so that we observe a fully initialized</span></span><br><span class="line">    <span class="comment">// version of the returned Node.</span></span><br><span class="line">    <span class="keyword">return</span> next_[n].<span class="built_in">load</span>(std::memory_order_acquire);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">SetNext</span><span class="params">(<span class="type">int</span> n, Node* x)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">assert</span>(n &gt;= <span class="number">0</span>);</span><br><span class="line">    <span class="comment">// Use a &#x27;release store&#x27; so that anybody who reads through this</span></span><br><span class="line">    <span class="comment">// pointer observes a fully initialized version of the inserted node.</span></span><br><span class="line">    next_[n].<span class="built_in">store</span>(x, std::memory_order_release);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// No-barrier variants that can be safely used in a few locations.</span></span><br><span class="line">  <span class="function">Node* <span class="title">NoBarrier_Next</span><span class="params">(<span class="type">int</span> n)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">assert</span>(n &gt;= <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> next_[n].<span class="built_in">load</span>(std::memory_order_relaxed);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">NoBarrier_SetNext</span><span class="params">(<span class="type">int</span> n, Node* x)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">assert</span>(n &gt;= <span class="number">0</span>);</span><br><span class="line">    next_[n].<span class="built_in">store</span>(x, std::memory_order_relaxed);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span>:</span><br><span class="line">  <span class="comment">// Array of length equal to the node height.  next_[0] is lowest level link.</span></span><br><span class="line">  std::atomic&lt;Node*&gt; next_[<span class="number">1</span>];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><ul><li><code>NoBarrier</code> åœ¨ <code>relaxed</code> ä¸‹æ“ä½œ</li><li>æœ‰ Barrier çš„åœ¨ <code>acquire</code>/<code>release</code> ä¸‹æ“ä½œ</li></ul><p>é¦–å…ˆçœ‹çœ‹è‡³å…³é‡è¦çš„ <code>FindGreaterOrEqual</code>:</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Return the earliest node that comes at or after key.</span></span><br><span class="line"><span class="comment">// Return nullptr if there is no such node.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// If prev is non-null, fills prev[level] with pointer to previous</span></span><br><span class="line"><span class="comment">// node at &quot;level&quot; for every level in [0..max_height_-1].</span></span><br><span class="line"><span class="function">Node* <span class="title">FindGreaterOrEqual</span><span class="params">(<span class="type">const</span> Key&amp; key, Node** prev)</span> <span class="type">const</span></span>;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ª <code>FindGreaterOrEqual</code> çš„ prev ä¼šæŠŠä¸€ä¸ªé€å±‚çš„æŒ‡é’ˆèµ‹äºˆ <code>prev</code>, å³ <code>prev[4]</code> ä¸º <code>level = 4</code> çš„ Node ä¸­å¯¹åº” prev çš„ä¸€ä¸ªï¼Œç›´åˆ° <code>level = 0</code>.</p><p>å…·ä½“å®ç°çš„æ—¶å€™ï¼Œæˆ‘ä»¬æ³¨æ„å®ƒè°ƒç”¨çš„æ˜¯ <code>x-&gt;Next(level)</code>ã€‚å®ƒæ˜¯ä¸€ä¸ª memory order ä¸º <code>acquire</code> çš„æ“ä½œã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> Key, <span class="keyword">class</span> <span class="title class_">Comparator</span>&gt;</span><br><span class="line"><span class="keyword">typename</span> SkipList&lt;Key, Comparator&gt;::Node*</span><br><span class="line">SkipList&lt;Key, Comparator&gt;::<span class="built_in">FindGreaterOrEqual</span>(<span class="type">const</span> Key&amp; key,</span><br><span class="line">                                              Node** prev) <span class="type">const</span> &#123;</span><br><span class="line">  Node* x = head_;</span><br><span class="line">  <span class="type">int</span> level = <span class="built_in">GetMaxHeight</span>() - <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">    Node* next = x-&gt;<span class="built_in">Next</span>(level);</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">KeyIsAfterNode</span>(key, next)) &#123;</span><br><span class="line">      <span class="comment">// Keep searching in this list</span></span><br><span class="line">      x = next;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (prev != <span class="literal">nullptr</span>) prev[level] = x;</span><br><span class="line">      <span class="keyword">if</span> (level == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> next;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Switch to next list</span></span><br><span class="line">        level--;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥ <code>Insert</code> çš„æ—¶å€™ï¼Œåœ¨æœ‰å¤–éƒ¨åŒæ­¥çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> Key, <span class="keyword">class</span> <span class="title class_">Comparator</span>&gt;</span><br><span class="line"><span class="type">void</span> SkipList&lt;Key, Comparator&gt;::<span class="built_in">Insert</span>(<span class="type">const</span> Key&amp; key) &#123;</span><br><span class="line">  <span class="comment">// TODO(opt): We can use a barrier-free variant of FindGreaterOrEqual()</span></span><br><span class="line">  <span class="comment">// here since Insert() is externally synchronized.</span></span><br><span class="line">  Node* prev[kMaxHeight];</span><br><span class="line">  Node* x = <span class="built_in">FindGreaterOrEqual</span>(key, prev);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Our data structure does not allow duplicate insertion</span></span><br><span class="line">  <span class="built_in">assert</span>(x == <span class="literal">nullptr</span> || !<span class="built_in">Equal</span>(key, x-&gt;key));</span><br><span class="line"></span><br><span class="line">  <span class="type">int</span> height = <span class="built_in">RandomHeight</span>();</span><br><span class="line">  <span class="keyword">if</span> (height &gt; <span class="built_in">GetMaxHeight</span>()) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="built_in">GetMaxHeight</span>(); i &lt; height; i++) &#123;</span><br><span class="line">      prev[i] = head_;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// It is ok to mutate max_height_ without any synchronization</span></span><br><span class="line">    <span class="comment">// with concurrent readers.  A concurrent reader that observes</span></span><br><span class="line">    <span class="comment">// the new value of max_height_ will see either the old value of</span></span><br><span class="line">    <span class="comment">// new level pointers from head_ (nullptr), or a new value set in</span></span><br><span class="line">    <span class="comment">// the loop below.  In the former case the reader will</span></span><br><span class="line">    <span class="comment">// immediately drop to the next level since nullptr sorts after all</span></span><br><span class="line">    <span class="comment">// keys.  In the latter case the reader will use the new node.</span></span><br><span class="line">    max_height_.<span class="built_in">store</span>(height, std::memory_order_relaxed);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  x = <span class="built_in">NewNode</span>(key, height);</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; height; i++) &#123;</span><br><span class="line">    <span class="comment">// NoBarrier_SetNext() suffices since we will add a barrier when</span></span><br><span class="line">    <span class="comment">// we publish a pointer to &quot;x&quot; in prev[i].</span></span><br><span class="line">    x-&gt;<span class="built_in">NoBarrier_SetNext</span>(i, prev[i]-&gt;<span class="built_in">NoBarrier_Next</span>(i));</span><br><span class="line">    prev[i]-&gt;<span class="built_in">SetNext</span>(i, x);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><code>max_height_</code> çš„ store å’Œ load éƒ½æ˜¯ relaxed çš„ï¼Œå¦ä¸€ä¸ªçº¿ç¨‹åªä¼šè¯»åˆ°æ—§çš„å€¼ï¼Œä½†ä¸ä¼šè¯»åˆ°è¿‡å¤§çš„å€¼ã€‚</li><li>æ’å…¥çš„æ—¶å€™æ˜¯ä» 0 å±‚åˆ°æœ€é«˜å±‚æ’å…¥çš„ã€‚<code>FindGreaterOrEqual</code> æ˜¯åè¿‡æ¥çš„ã€‚</li><li>æ’å…¥çš„æ—¶å€™æ˜¯ <code>x-&gt;NoBarrier_SetNext</code>  å† <code>prev[i]-&gt;SetNext</code> ã€‚å‰è€…æ˜¯ä¸€ä¸ª<code>relaxed</code>, åè€…æ˜¯ä¸€ä¸ª<code>release</code>.</li></ul><p>æˆ‘ä»¬ <code>Insert</code> æ˜¯å•çº¿ç¨‹çš„ï¼Œä½†æ˜¯ SkipList çš„ Iterator å¯èƒ½ä¼šè°ƒç”¨ <code>FindGreaterOrEqual</code>ã€‚å®ƒçš„ <code>Next</code> æ˜¯ä¸€ä¸ª <code>acquire</code> çš„æ“ä½œã€‚</p><h2 id="Memtable"><a href="#Memtable" class="headerlink" title="Memtable"></a>Memtable</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> leveldb &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">InternalKeyComparator</span>;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MemTableIterator</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MemTable</span> &#123;</span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="comment">// MemTables are reference counted.  The initial reference count</span></span><br><span class="line">  <span class="comment">// is zero and the caller must call Ref() at least once.</span></span><br><span class="line">  <span class="function"><span class="keyword">explicit</span> <span class="title">MemTable</span><span class="params">(<span class="type">const</span> InternalKeyComparator&amp; comparator)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">MemTable</span>(<span class="type">const</span> MemTable&amp;) = <span class="keyword">delete</span>;</span><br><span class="line">  MemTable&amp; <span class="keyword">operator</span>=(<span class="type">const</span> MemTable&amp;) = <span class="keyword">delete</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Increase reference count.</span></span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">Ref</span><span class="params">()</span> </span>&#123; ++refs_; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Drop reference count.  Delete if no more references exist.</span></span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">Unref</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    --refs_;</span><br><span class="line">    <span class="built_in">assert</span>(refs_ &gt;= <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (refs_ &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">delete</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Returns an estimate of the number of bytes of data in use by this</span></span><br><span class="line">  <span class="comment">// data structure. It is safe to call when MemTable is being modified.</span></span><br><span class="line">  <span class="function"><span class="type">size_t</span> <span class="title">ApproximateMemoryUsage</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Return an iterator that yields the contents of the memtable.</span></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  <span class="comment">// The caller must ensure that the underlying MemTable remains live</span></span><br><span class="line">  <span class="comment">// while the returned iterator is live.  The keys returned by this</span></span><br><span class="line">  <span class="comment">// iterator are internal keys encoded by AppendInternalKey in the</span></span><br><span class="line">  <span class="comment">// db/format.&#123;h,cc&#125; module.</span></span><br><span class="line">  <span class="function">Iterator* <span class="title">NewIterator</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Add an entry into memtable that maps key to value at the</span></span><br><span class="line">  <span class="comment">// specified sequence number and with the specified type.</span></span><br><span class="line">  <span class="comment">// Typically value will be empty if type==kTypeDeletion.</span></span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">Add</span><span class="params">(SequenceNumber seq, ValueType type, <span class="type">const</span> Slice&amp; key,</span></span></span><br><span class="line"><span class="params"><span class="function">           <span class="type">const</span> Slice&amp; value)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// If memtable contains a value for key, store it in *value and return true.</span></span><br><span class="line">  <span class="comment">// If memtable contains a deletion for key, store a NotFound() error</span></span><br><span class="line">  <span class="comment">// in *status and return true.</span></span><br><span class="line">  <span class="comment">// Else, return false.</span></span><br><span class="line">  <span class="function"><span class="type">bool</span> <span class="title">Get</span><span class="params">(<span class="type">const</span> LookupKey&amp; key, std::string* value, Status* s)</span></span>;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span>:</span><br><span class="line">  <span class="keyword">friend</span> <span class="keyword">class</span> <span class="title class_">MemTableIterator</span>;</span><br><span class="line">  <span class="keyword">friend</span> <span class="keyword">class</span> <span class="title class_">MemTableBackwardIterator</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">KeyComparator</span> &#123;</span><br><span class="line">    <span class="type">const</span> InternalKeyComparator comparator;</span><br><span class="line">    <span class="function"><span class="keyword">explicit</span> <span class="title">KeyComparator</span><span class="params">(<span class="type">const</span> InternalKeyComparator&amp; c)</span> : comparator(c) &#123;</span>&#125;</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">operator</span><span class="params">()</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* a, <span class="type">const</span> <span class="type">char</span>* b)</span> <span class="type">const</span></span>;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">typedef</span> SkipList&lt;<span class="type">const</span> <span class="type">char</span>*, KeyComparator&gt; Table;</span><br><span class="line"></span><br><span class="line">  ~<span class="built_in">MemTable</span>();  <span class="comment">// Private since only Unref() should be used to delete it</span></span><br><span class="line"></span><br><span class="line">  KeyComparator comparator_;</span><br><span class="line">  <span class="type">int</span> refs_;</span><br><span class="line">  Arena arena_;</span><br><span class="line">  Table table_;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">&#125;  <span class="comment">// namespace leveldb</span></span><br></pre></td></tr></table></figure><p>è¿™ä¸ªè¿˜æ˜¯å¾ˆæ¸…æ™°çš„â€¦</p><h3 id="Put-Get-Codec"><a href="#Put-Get-Codec" class="headerlink" title="Put Get Codec"></a>Put Get Codec</h3><p>codec éœ€è¦ç†è§£ varint: <a href="https://developers.google.com/protocol-buffers/docs/encoding">https://developers.google.com/protocol-buffers/docs/encoding</a> . æ•°å­—çš„è¡¨ç¤ºå½¢å¼æˆä¸ºäº† <code>msb + 7byte</code> çš„å½¢å¼ã€‚å› ä¸ºè¿™å®é™…ä¸Šæ˜¯ä¸ª <code>unsigned</code>, æ‰€ä»¥ä¸éœ€è¦åˆ«çš„å¤„ç†ã€‚å¦‚æœæ˜¯ <code>signed</code> çš„è¯æˆ–è®¸è¿˜è¦è€ƒè™‘ zigzag æ¥ç¼–ç ã€‚</p><p>åœ¨ LevelDB ä¸­ï¼Œæˆ‘ä»¬ä¼š <code>Add(SequenceNumber s, ValueType type, const Slice&amp; key, const Slice&amp; value)</code>ã€‚ä½†æ˜¯æˆ‘ä»¬åœ¨ SkipList ä¸­ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œ<code>Node</code> é‡Œé¢æ˜¯åªæœ‰ Key çš„ã€‚ LevelDB ä¼šæŠŠè¿™å››ä¸ªè¿›è¡Œ codec, åŒæ—¶è®©æˆ‘ä»¬èƒ½å¤Ÿé«˜æ•ˆè¯»å†™ï¼Œæ”¯æŒ <code>Get</code> å‡½æ•°ã€‚</p><p>Key ç¼–ç å¦‚ä¸‹ï¼š</p><ul><li><code>varint32</code> çš„ key length</li><li><code>key</code> çš„å†…å®¹ï¼ˆé•¿åº¦ä¸º <code>key.size()</code>ï¼‰</li><li><code>(s &lt;&lt; 8) | type</code> ã€‚type æ˜¯ä¸€ä¸ª 1byte çš„ enum, è¡¨ç¤ºæ˜¯ Put è¿˜æ˜¯ deleteï¼Œå‰©ä¸‹çš„ <code>s</code> è¡¨ç¤ºæ“ä½œçš„é€’å¢çš„åºåˆ—å·ã€‚</li><li><code>varint32</code> çš„ value length</li><li><code>value</code> çš„å†…å®¹</li></ul><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">MemTable::Add</span><span class="params">(SequenceNumber s, ValueType type, <span class="type">const</span> Slice&amp; key,</span></span></span><br><span class="line"><span class="params"><span class="function">                   <span class="type">const</span> Slice&amp; value)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// Format of an entry is concatenation of:</span></span><br><span class="line">  <span class="comment">//  key_size     : varint32 of internal_key.size()</span></span><br><span class="line">  <span class="comment">//  key bytes    : char[internal_key.size()]</span></span><br><span class="line">  <span class="comment">//  value_size   : varint32 of value.size()</span></span><br><span class="line">  <span class="comment">//  value bytes  : char[value.size()]</span></span><br><span class="line">  <span class="type">size_t</span> key_size = key.<span class="built_in">size</span>();</span><br><span class="line">  <span class="type">size_t</span> val_size = value.<span class="built_in">size</span>();</span><br><span class="line">  <span class="type">size_t</span> internal_key_size = key_size + <span class="number">8</span>;</span><br><span class="line">  <span class="type">const</span> <span class="type">size_t</span> encoded_len = <span class="built_in">VarintLength</span>(internal_key_size) +</span><br><span class="line">                             internal_key_size + <span class="built_in">VarintLength</span>(val_size) +</span><br><span class="line">                             val_size;</span><br><span class="line">  <span class="type">char</span>* buf = arena_.<span class="built_in">Allocate</span>(encoded_len);</span><br><span class="line">  <span class="type">char</span>* p = <span class="built_in">EncodeVarint32</span>(buf, internal_key_size);</span><br><span class="line">  std::<span class="built_in">memcpy</span>(p, key.<span class="built_in">data</span>(), key_size);</span><br><span class="line">  p += key_size;</span><br><span class="line">  <span class="built_in">EncodeFixed64</span>(p, (s &lt;&lt; <span class="number">8</span>) | type);</span><br><span class="line">  p += <span class="number">8</span>;</span><br><span class="line">  p = <span class="built_in">EncodeVarint32</span>(p, val_size);</span><br><span class="line">  std::<span class="built_in">memcpy</span>(p, value.<span class="built_in">data</span>(), val_size);</span><br><span class="line">  <span class="built_in">assert</span>(p + val_size == buf + encoded_len);</span><br><span class="line">  table_.<span class="built_in">Insert</span>(buf);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åŒæ—¶å¯ä»¥å…³æ³¨ä¸€ä¸‹ <code>Encode</code> çš„é€»è¾‘ï¼Œx86 CPU æ˜¯å°ç«¯åºçš„ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">EncodeFixed64</span><span class="params">(<span class="type">char</span>* dst, <span class="type">uint64_t</span> value)</span> </span>&#123;</span><br><span class="line">  <span class="type">uint8_t</span>* <span class="type">const</span> buffer = <span class="built_in">reinterpret_cast</span>&lt;<span class="type">uint8_t</span>*&gt;(dst);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Recent clang and gcc optimize this to a single mov / str instruction.</span></span><br><span class="line">  buffer[<span class="number">0</span>] = <span class="built_in">static_cast</span>&lt;<span class="type">uint8_t</span>&gt;(value);</span><br><span class="line">  buffer[<span class="number">1</span>] = <span class="built_in">static_cast</span>&lt;<span class="type">uint8_t</span>&gt;(value &gt;&gt; <span class="number">8</span>);</span><br><span class="line">  buffer[<span class="number">2</span>] = <span class="built_in">static_cast</span>&lt;<span class="type">uint8_t</span>&gt;(value &gt;&gt; <span class="number">16</span>);</span><br><span class="line">  buffer[<span class="number">3</span>] = <span class="built_in">static_cast</span>&lt;<span class="type">uint8_t</span>&gt;(value &gt;&gt; <span class="number">24</span>);</span><br><span class="line">  buffer[<span class="number">4</span>] = <span class="built_in">static_cast</span>&lt;<span class="type">uint8_t</span>&gt;(value &gt;&gt; <span class="number">32</span>);</span><br><span class="line">  buffer[<span class="number">5</span>] = <span class="built_in">static_cast</span>&lt;<span class="type">uint8_t</span>&gt;(value &gt;&gt; <span class="number">40</span>);</span><br><span class="line">  buffer[<span class="number">6</span>] = <span class="built_in">static_cast</span>&lt;<span class="type">uint8_t</span>&gt;(value &gt;&gt; <span class="number">48</span>);</span><br><span class="line">  buffer[<span class="number">7</span>] = <span class="built_in">static_cast</span>&lt;<span class="type">uint8_t</span>&gt;(value &gt;&gt; <span class="number">56</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åŒæ—¶éœ€è¦æ³¨æ„å…·ä½“çš„ Comparator:</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">InternalKeyComparator::Compare</span><span class="params">(<span class="type">const</span> Slice&amp; akey, <span class="type">const</span> Slice&amp; bkey)</span> <span class="type">const</span> </span>&#123;</span><br><span class="line">  <span class="comment">// Order by:</span></span><br><span class="line">  <span class="comment">//    increasing user key (according to user-supplied comparator)</span></span><br><span class="line">  <span class="comment">//    decreasing sequence number</span></span><br><span class="line">  <span class="comment">//    decreasing type (though sequence# should be enough to disambiguate)</span></span><br><span class="line">  <span class="type">int</span> r = user_comparator_-&gt;<span class="built_in">Compare</span>(<span class="built_in">ExtractUserKey</span>(akey), <span class="built_in">ExtractUserKey</span>(bkey));</span><br><span class="line">  <span class="keyword">if</span> (r == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="type">const</span> <span class="type">uint64_t</span> anum = <span class="built_in">DecodeFixed64</span>(akey.<span class="built_in">data</span>() + akey.<span class="built_in">size</span>() - <span class="number">8</span>);</span><br><span class="line">    <span class="type">const</span> <span class="type">uint64_t</span> bnum = <span class="built_in">DecodeFixed64</span>(bkey.<span class="built_in">data</span>() + bkey.<span class="built_in">size</span>() - <span class="number">8</span>);</span><br><span class="line">    <span class="keyword">if</span> (anum &gt; bnum) &#123;</span><br><span class="line">      r = <span class="number">-1</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (anum &lt; bnum) &#123;</span><br><span class="line">      r = +<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> r;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…·ä½“ Get çš„æ—¶å€™ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><ul><li>æŸä¸€ä¸ª key é•¿åº¦æ˜¯ä¸€å®šçš„ï¼Œå¾ˆå®¹æ˜“æ„é€ åŒæ ·çš„ key_length å’Œ key, å°è¯•åœ¨ SkipList ä¸­ è°ƒç”¨ Seek, æ‰¾åˆ° Key</li><li>æˆ‘ä»¬ä½¿ç”¨çš„ç¼–ç æ˜¯ 7byte çš„ seq, 1byte çš„ put/del flagï¼Œæ‰€ä»¥ Seek ä¼šå°è¯•æ‰¾åˆ°<ul><li>å¦‚æœ user_key ä¸ä¸€æ ·ï¼Œå³æœ¬ key ä¸å­˜åœ¨</li><li>å­˜åœ¨çš„è¯ï¼Œèƒ½å¤Ÿä¿è¯ Seek åˆ°çš„æ˜¯æœ€æ–°ç‰ˆæœ¬ï¼Œæˆ–æ˜¯ç»™å®š seq å†…çš„æœ€æ–°ç‰ˆæœ¬ã€‚åˆ¤æ–­ type å¹¶è¯»å‡º value å³å¯ã€‚</li></ul></li></ul><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">MemTable::Get</span><span class="params">(<span class="type">const</span> LookupKey&amp; key, std::string* value, Status* s)</span> </span>&#123;</span><br><span class="line">  Slice memkey = key.<span class="built_in">memtable_key</span>();</span><br><span class="line">  <span class="function">Table::Iterator <span class="title">iter</span><span class="params">(&amp;table_)</span></span>;</span><br><span class="line">  iter.<span class="built_in">Seek</span>(memkey.<span class="built_in">data</span>());</span><br><span class="line">  <span class="keyword">if</span> (iter.<span class="built_in">Valid</span>()) &#123;</span><br><span class="line">    <span class="comment">// entry format is:</span></span><br><span class="line">    <span class="comment">//    klength  varint32</span></span><br><span class="line">    <span class="comment">//    userkey  char[klength]</span></span><br><span class="line">    <span class="comment">//    tag      uint64</span></span><br><span class="line">    <span class="comment">//    vlength  varint32</span></span><br><span class="line">    <span class="comment">//    value    char[vlength]</span></span><br><span class="line">    <span class="comment">// Check that it belongs to same user key.  We do not check the</span></span><br><span class="line">    <span class="comment">// sequence number since the Seek() call above should have skipped</span></span><br><span class="line">    <span class="comment">// all entries with overly large sequence numbers.</span></span><br><span class="line">    <span class="type">const</span> <span class="type">char</span>* entry = iter.<span class="built_in">key</span>();</span><br><span class="line">    <span class="type">uint32_t</span> key_length;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span>* key_ptr = <span class="built_in">GetVarint32Ptr</span>(entry, entry + <span class="number">5</span>, &amp;key_length);</span><br><span class="line">    <span class="keyword">if</span> (comparator_.comparator.<span class="built_in">user_comparator</span>()-&gt;<span class="built_in">Compare</span>(</span><br><span class="line">            <span class="built_in">Slice</span>(key_ptr, key_length - <span class="number">8</span>), key.<span class="built_in">user_key</span>()) == <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="comment">// Correct user key</span></span><br><span class="line">      <span class="type">const</span> <span class="type">uint64_t</span> tag = <span class="built_in">DecodeFixed64</span>(key_ptr + key_length - <span class="number">8</span>);</span><br><span class="line">      <span class="keyword">switch</span> (<span class="built_in">static_cast</span>&lt;ValueType&gt;(tag &amp; <span class="number">0xff</span>)) &#123;</span><br><span class="line">        <span class="keyword">case</span> kTypeValue: &#123;</span><br><span class="line">          Slice v = <span class="built_in">GetLengthPrefixedSlice</span>(key_ptr + key_length);</span><br><span class="line">          value-&gt;<span class="built_in">assign</span>(v.<span class="built_in">data</span>(), v.<span class="built_in">size</span>());</span><br><span class="line">          <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> kTypeDeletion:</span><br><span class="line">          *s = Status::<span class="built_in">NotFound</span>(<span class="built_in">Slice</span>());</span><br><span class="line">          <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>LevelDB Log: WAL of LSMTree C0</title>
      <link href="/2020/05/29/LevelDB-Log-WAL-of-LSMTree-C0/"/>
      <url>/2020/05/29/LevelDB-Log-WAL-of-LSMTree-C0/</url>
      
        <content type="html"><![CDATA[<p>å¦‚æœå¯¹ WAL è¿™ä¸ªåè¯é™Œç”Ÿçš„è¯â€¦æˆ‘æƒ³è¿™ç¯‡æ–‡ç« çš„è¯»è€…åº”è¯¥ä¸ä¼šçœŸçš„æ²¡å¬è¿‡ WAL å§â€¦</p><p>å®é™…ä¸Šæ•°æ®åº“çš„ WAL è¿˜æ˜¯æ¯”è¾ƒéš¾é˜…è¯»çš„ï¼Œä»¥ B+Tree + Undo/Redo Log ä¸ºä¾‹ï¼ŒLog çš„ Undo/Redo å’Œ checkout point, GC æœ¬èº«æœ‰æ¯”è¾ƒå¤§çš„å¤æ‚æ€§ï¼Œè¿™ç»™é˜…è¯»å¸¦æ¥äº†å¾ˆå¤§çš„å›°éš¾ã€‚</p><p>LevelDB çš„ç»“æ„æ˜¯ LSMTree, LSMTree åŸè®ºæ–‡ä¸­ï¼Œå®ƒçš„ç»“æ„å¦‚ä¸‹ï¼š</p><p><img src="https://image.mwish.me/blog-image/9F1865E8-603E-4385-B237-C776166512E8.png" alt="9F1865E8-603E-4385-B237-C776166512E8"></p><p>è¿™æ˜¯è®ºæ–‡ä¸­çš„ figure 2.1, æˆ‘ä»¬å¯ä»¥çœ‹åˆ°C0 æ˜¯åœ¨å†…å­˜ä¸­çš„ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼ŒLevelDB æœ‰ç›¸å¯¹ç®€å•çš„ WALï¼Œä½œä¸ºå†™ memtable ä¹‹å‰å†™å…¥çš„æ—¥å¿—ã€‚</p><p>æˆ‘ä»¬éœ€è¦å…³æ³¨çš„æ˜¯ï¼š</p><ol><li>æ—¥å¿—çš„ç»“æ„æ˜¯ä»€ä¹ˆæ ·çš„</li><li>æ—¥å¿—æ˜¯ä»€ä¹ˆæ—¶å€™å¼€å§‹å†™ï¼Œæœ‰ä»€ä¹ˆæ—¶å€™åˆ é™¤çš„</li><li>å¯¹äºç›˜çš„æ•…éšœï¼Œæ—¥å¿—æ€ä¹ˆå¤„ç†</li><li>æ—¥å¿—å‘½åç­–ç•¥æ˜¯ä»€ä¹ˆ</li></ol><hr><h3 id="æ—¥å¿—çš„ç»“æ„"><a href="#æ—¥å¿—çš„ç»“æ„" class="headerlink" title="æ—¥å¿—çš„ç»“æ„"></a>æ—¥å¿—çš„ç»“æ„</h3><p>å…³äºé—®é¢˜1ï¼Œæœ€å¥½çš„é˜…è¯»åœ°ç‚¹æ˜¯ï¼š<a href="https://github.com/google/leveldb/blob/master/doc/log_format.md">https://github.com/google/leveldb/blob/master/doc/log_format.md</a></p><p>å¤§æ¦‚æœ‰è¿™æ ·çš„é€»è¾‘å…³ç³»ï¼š</p><ol><li>The <strong>log file</strong> contents are a sequence of <em>32KB</em> blocks. The only exception is that the tail of the file may contain a partial block.</li><li>Each block consists of a sequence of records:</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">block := record* trailer?</span><br><span class="line">record :=</span><br><span class="line">  checksum: uint32     // crc32c of type and data[] ; little-endian</span><br><span class="line">  length: uint16       // little-endian</span><br><span class="line">  type: uint8          // One of FULL, FIRST, MIDDLE, LAST</span><br><span class="line">  data: uint8[length]</span><br></pre></td></tr></table></figure><p>æ€»ç»“ä¸€ä¸‹ï¼š</p><ul><li>æ—¥å¿—æ–‡ä»¶æ˜¯å¯èƒ½çš„ä¸€ä¸ª header åŠ ä¸Šè‹¥å¹²ä¸ª block</li><li>æ¯ä¸ª block ç»“æ„è¿™ä¸ªæœ‰ç‚¹åƒæ­£åˆ™è¡¨è¾¾å¼ï¼ŒåŒ…å« <code>*</code> ä¸ª record å’Œå¯èƒ½å­˜åœ¨çš„ trailer</li><li>æ¯ä¸ª record åŒ…å« crc32, little-endian çš„ length, ä¸€ä¸ªç±»å‹å’Œå…·ä½“çš„ byte æ•°æ®</li></ul><blockquote><p>A record never starts within the last six bytes of a block (since it wonâ€™t fit). Any leftover bytes here form the trailer, which must consist entirely of zero bytes and must be skipped by readers.</p></blockquote><ul><li><code>trailer</code> å¦‚ä¸Šè¿°å†…å®¹ï¼Œç›¸å½“äºæ˜¯å°¾éƒ¨çš„ paddingï¼Œä¸Šä¸€å—çš„å†…å®¹å°äº6å³å¯è·³è¿‡è¿™äº› paddingã€‚</li></ul><blockquote><p> ä¸ºä»€ä¹ˆæ˜¯ 7byte</p></blockquote><p>å¯ä»¥è´´ä¸€ä¸‹<code>db/log_format.h</code> çš„ä»£ç ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Copyright (c) 2011 The LevelDB Authors. All rights reserved.</span></span><br><span class="line"><span class="comment">// Use of this source code is governed by a BSD-style license that can be</span></span><br><span class="line"><span class="comment">// found in the LICENSE file. See the AUTHORS file for names of contributors.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Log format information shared by reader and writer.</span></span><br><span class="line"><span class="comment">// See ../doc/log_format.md for more detail.</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> STORAGE_LEVELDB_DB_LOG_FORMAT_H_</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> STORAGE_LEVELDB_DB_LOG_FORMAT_H_</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> leveldb &#123;</span><br><span class="line"><span class="keyword">namespace</span> log &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">enum</span> <span class="title class_">RecordType</span> &#123;</span><br><span class="line">  <span class="comment">// Zero is reserved for preallocated files</span></span><br><span class="line">  kZeroType = <span class="number">0</span>,</span><br><span class="line"></span><br><span class="line">  kFullType = <span class="number">1</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// For fragments</span></span><br><span class="line">  kFirstType = <span class="number">2</span>,</span><br><span class="line">  kMiddleType = <span class="number">3</span>,</span><br><span class="line">  kLastType = <span class="number">4</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">int</span> kMaxRecordType = kLastType;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">int</span> kBlockSize = <span class="number">32768</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Header is checksum (4 bytes), length (2 bytes), type (1 byte).</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">int</span> kHeaderSize = <span class="number">4</span> + <span class="number">2</span> + <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">&#125;  <span class="comment">// namespace log</span></span><br><span class="line">&#125;  <span class="comment">// namespace leveldb</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span>  <span class="comment">// STORAGE_LEVELDB_DB_LOG_FORMAT_H_</span></span></span><br></pre></td></tr></table></figure><ul><li><code>kBlockSize</code> æ˜¯ 32k, å³<code>32 * 1024 = 32768</code></li><li><code>RecordType</code> æ˜¯ä¸ª <code>enum</code>, æœ‰ä¸‹åˆ—å‡ ç§ç±»å‹ã€‚<code>enum</code> åœ¨ C++ é»˜è®¤æ˜¯ int, ä¸è¿‡ä¼¼ä¹å®ƒå°±ç”¨äº†ä¸€ä½<ul><li><code>kFullType</code> å…¨è®°å½•</li><li><code>kFirstType</code> <code>kMiddleType</code> <code>kLastType</code>: æˆªæ–­çš„è®°å½•çš„ <code>first, middle..., last</code></li><li><code>kZeroType</code> ä¸äº†è§£</li></ul></li><li><code>kHeaderSize</code> åŒ…å« checksum, length, typeã€‚é•¿åº¦å¦‚å‰æ–‡æ‰€è¿°ã€‚</li></ul><p>å…³äº first middle last è¿˜å¯ä»¥å‚è€ƒæ–‡æ¡£ï¼š</p><blockquote><p>Example: consider a sequence of user records:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">A: length 1000</span><br><span class="line">B: length 97270</span><br><span class="line">C: length 8000</span><br></pre></td></tr></table></figure><p><strong>A</strong> will be stored as a FULL record in the first block.</p><p><strong>B</strong> will be split into three fragments: first fragment occupies the rest of the first block, second fragment occupies the entirety of the second block, and the third fragment occupies a prefix of the third block. This will leave six bytes free in the third block, which will be left empty as the trailer.</p><p><strong>C</strong> will be stored as a FULL record in the fourth block.</p></blockquote><p>ï¼ˆåæ§½ä¸€ä¸‹ï¼Œè¿™ä¹ˆå¤§çš„ kvï¼Œå†…å­˜è‚¯å®šä¸€æ¬¡åˆ†é…äº†hhhï¼‰</p><h3 id="filename"><a href="#filename" class="headerlink" title="filename"></a>filename</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">std::string <span class="title">LogFileName</span><span class="params">(<span class="type">const</span> std::string&amp; dbname, <span class="type">uint64_t</span> number)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">assert</span>(number &gt; <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">MakeFileName</span>(dbname, number, <span class="string">&quot;log&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¥ç€çœ‹</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> std::string <span class="title">MakeFileName</span><span class="params">(<span class="type">const</span> std::string&amp; dbname, <span class="type">uint64_t</span> number,</span></span></span><br><span class="line"><span class="params"><span class="function">                                <span class="type">const</span> <span class="type">char</span>* suffix)</span> </span>&#123;</span><br><span class="line">  <span class="type">char</span> buf[<span class="number">100</span>];</span><br><span class="line">  std::<span class="built_in">snprintf</span>(buf, <span class="built_in">sizeof</span>(buf), <span class="string">&quot;/%06llu.%s&quot;</span>,</span><br><span class="line">                <span class="built_in">static_cast</span>&lt;<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>&gt;(number), suffix);</span><br><span class="line">  <span class="keyword">return</span> dbname + buf;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»¥ <code>dbname_number.log</code> å½¢å¼ä¿å­˜æ–‡ä»¶</p><h3 id="Log-ä¸-Writer"><a href="#Log-ä¸-Writer" class="headerlink" title="Log ä¸ Writer"></a>Log ä¸ Writer</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> leveldb &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">WritableFile</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> log &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Writer</span> &#123;</span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="comment">// Create a writer that will append data to &quot;*dest&quot;.</span></span><br><span class="line">  <span class="comment">// &quot;*dest&quot; must be initially empty.</span></span><br><span class="line">  <span class="comment">// &quot;*dest&quot; must remain live while this Writer is in use.</span></span><br><span class="line">  <span class="function"><span class="keyword">explicit</span> <span class="title">Writer</span><span class="params">(WritableFile* dest)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Create a writer that will append data to &quot;*dest&quot;.</span></span><br><span class="line">  <span class="comment">// &quot;*dest&quot; must have initial length &quot;dest_length&quot;.</span></span><br><span class="line">  <span class="comment">// &quot;*dest&quot; must remain live while this Writer is in use.</span></span><br><span class="line">  <span class="built_in">Writer</span>(WritableFile* dest, <span class="type">uint64_t</span> dest_length);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">Writer</span>(<span class="type">const</span> Writer&amp;) = <span class="keyword">delete</span>;</span><br><span class="line">  Writer&amp; <span class="keyword">operator</span>=(<span class="type">const</span> Writer&amp;) = <span class="keyword">delete</span>;</span><br><span class="line"></span><br><span class="line">  ~<span class="built_in">Writer</span>();</span><br><span class="line"></span><br><span class="line">  <span class="function">Status <span class="title">AddRecord</span><span class="params">(<span class="type">const</span> Slice&amp; slice)</span></span>;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span>:</span><br><span class="line">  <span class="function">Status <span class="title">EmitPhysicalRecord</span><span class="params">(RecordType type, <span class="type">const</span> <span class="type">char</span>* ptr, <span class="type">size_t</span> length)</span></span>;</span><br><span class="line"></span><br><span class="line">  WritableFile* dest_;</span><br><span class="line">  <span class="type">int</span> block_offset_;  <span class="comment">// Current offset in block</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// crc32c values for all supported record types.  These are</span></span><br><span class="line">  <span class="comment">// pre-computed to reduce the overhead of computing the crc of the</span></span><br><span class="line">  <span class="comment">// record type stored in the header.</span></span><br><span class="line">  <span class="type">uint32_t</span> type_crc_[kMaxRecordType + <span class="number">1</span>];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">&#125;  <span class="comment">// namespace log</span></span><br><span class="line">&#125;  <span class="comment">// namespace leveldb</span></span><br></pre></td></tr></table></figure><ul><li>å¸¦ <code>dest_length</code> çš„ç›¸å½“äºå¯¹ file è‡ªå¸¦ä¸€å®šçš„ <code>offset</code></li><li><code>AddRecord</code> æ˜¯ public çš„ï¼Œå¤–éƒ¨äº¤ç»™å®ƒæ·»åŠ æ—¥å¿—</li><li><code>EmitPhysicalRecord</code> æ˜¯å®é™…å†™å…¥çš„å‡½æ•°</li></ul><p>æ·»åŠ æ—¥å¿—ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Status <span class="title">Writer::AddRecord</span><span class="params">(<span class="type">const</span> Slice&amp; slice)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// left is for slice.</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span>* ptr = slice.<span class="built_in">data</span>();</span><br><span class="line">  <span class="type">size_t</span> left = slice.<span class="built_in">size</span>();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Fragment the record if necessary and emit it.  Note that if slice</span></span><br><span class="line">  <span class="comment">// is empty, we still want to iterate once to emit a single</span></span><br><span class="line">  <span class="comment">// zero-length record</span></span><br><span class="line">  Status s;</span><br><span class="line">  <span class="type">bool</span> begin = <span class="literal">true</span>;</span><br><span class="line">  <span class="keyword">do</span> &#123;</span><br><span class="line">    <span class="type">const</span> <span class="type">int</span> leftover = kBlockSize - block_offset_;</span><br><span class="line">    <span class="built_in">assert</span>(leftover &gt;= <span class="number">0</span>);</span><br><span class="line">    <span class="comment">// &lt; 7 byte, just padding it.</span></span><br><span class="line">    <span class="keyword">if</span> (leftover &lt; kHeaderSize) &#123;</span><br><span class="line">      <span class="comment">// Switch to a new block</span></span><br><span class="line">      <span class="keyword">if</span> (leftover &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// Fill the trailer (literal below relies on kHeaderSize being 7)</span></span><br><span class="line">        <span class="built_in">static_assert</span>(kHeaderSize == <span class="number">7</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">        dest_-&gt;<span class="built_in">Append</span>(<span class="built_in">Slice</span>(<span class="string">&quot;\x00\x00\x00\x00\x00\x00&quot;</span>, leftover));</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// to a new block.</span></span><br><span class="line">      block_offset_ = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Invariant: we never leave &lt; kHeaderSize bytes in a block.</span></span><br><span class="line">    <span class="built_in">assert</span>(kBlockSize - block_offset_ - kHeaderSize &gt;= <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç›®å‰ block ä¸­å¯å†™å…¥çš„é‡</span></span><br><span class="line">    <span class="type">const</span> <span class="type">size_t</span> avail = kBlockSize - block_offset_ - kHeaderSize;</span><br><span class="line">    <span class="comment">// ç›®å‰è¿™ä¸ª block ä¸­éœ€è¦å†™å…¥çš„æ•°æ®é‡</span></span><br><span class="line">    <span class="type">const</span> <span class="type">size_t</span> fragment_length = (left &lt; avail) ? left : avail;</span><br><span class="line"></span><br><span class="line">    RecordType type;</span><br><span class="line">    <span class="comment">// end è¡¨ç¤ºåœ¨è¿™ä¸ª block å†…èƒ½å¦å†™å®Œ</span></span><br><span class="line">    <span class="type">const</span> <span class="type">bool</span> end = (left == fragment_length);</span><br><span class="line">    <span class="keyword">if</span> (begin &amp;&amp; end) &#123;</span><br><span class="line">      type = kFullType;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (begin) &#123;</span><br><span class="line">      type = kFirstType;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (end) &#123;</span><br><span class="line">      type = kLastType;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      type = kMiddleType;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    s = <span class="built_in">EmitPhysicalRecord</span>(type, ptr, fragment_length);</span><br><span class="line">    ptr += fragment_length;</span><br><span class="line">    left -= fragment_length;</span><br><span class="line">    begin = <span class="literal">false</span>;</span><br><span class="line">  &#125; <span class="keyword">while</span> (s.<span class="built_in">ok</span>() &amp;&amp; left &gt; <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">return</span> s;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">Status <span class="title">Writer::EmitPhysicalRecord</span><span class="params">(RecordType t, <span class="type">const</span> <span class="type">char</span>* ptr,</span></span></span><br><span class="line"><span class="params"><span class="function">                                  <span class="type">size_t</span> length)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">assert</span>(length &lt;= <span class="number">0xffff</span>);  <span class="comment">// Must fit in two bytes</span></span><br><span class="line">  <span class="built_in">assert</span>(block_offset_ + kHeaderSize + length &lt;= kBlockSize);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Format the header</span></span><br><span class="line">  <span class="type">char</span> buf[kHeaderSize];</span><br><span class="line">  buf[<span class="number">4</span>] = <span class="built_in">static_cast</span>&lt;<span class="type">char</span>&gt;(length &amp; <span class="number">0xff</span>);</span><br><span class="line">  buf[<span class="number">5</span>] = <span class="built_in">static_cast</span>&lt;<span class="type">char</span>&gt;(length &gt;&gt; <span class="number">8</span>);</span><br><span class="line">  buf[<span class="number">6</span>] = <span class="built_in">static_cast</span>&lt;<span class="type">char</span>&gt;(t);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Compute the crc of the record type and the payload.</span></span><br><span class="line">  <span class="type">uint32_t</span> crc = crc32c::<span class="built_in">Extend</span>(type_crc_[t], ptr, length);</span><br><span class="line">  crc = crc32c::<span class="built_in">Mask</span>(crc);  <span class="comment">// Adjust for storage</span></span><br><span class="line">  <span class="built_in">EncodeFixed32</span>(buf, crc);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Write the header and the payload</span></span><br><span class="line">  Status s = dest_-&gt;<span class="built_in">Append</span>(<span class="built_in">Slice</span>(buf, kHeaderSize));</span><br><span class="line">  <span class="keyword">if</span> (s.<span class="built_in">ok</span>()) &#123;</span><br><span class="line">    s = dest_-&gt;<span class="built_in">Append</span>(<span class="built_in">Slice</span>(ptr, length));</span><br><span class="line">    <span class="keyword">if</span> (s.<span class="built_in">ok</span>()) &#123;</span><br><span class="line">      s = dest_-&gt;<span class="built_in">Flush</span>();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  block_offset_ += kHeaderSize + length;</span><br><span class="line">  <span class="keyword">return</span> s;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘æ„Ÿè§‰æ²¡å•¥å¥½è¯´çš„ï¼Œè¿™ä»£ç çœŸçš„å¾ˆå¥½ç†è§£ï¼Œæˆ‘åŠ çš„æ³¨é‡Šéƒ½æ„Ÿè§‰å¾ˆå¤šä½™â€¦</p><p><code>EmitPhysicalRecord</code>å¦‚æœå†™åäº†ï¼ˆå³ <code>s.ok</code> ä¸æ»¡è¶³ï¼‰ï¼Œä¼šç›´æ¥è·³è¿‡è¿™æ¡è®°å½•</p><h3 id="Reader"><a href="#Reader" class="headerlink" title="Reader"></a>Reader</h3><p><code>Reader</code> ä»£ç ç›¸å¯¹ä¼šå¤æ‚å¾ˆå¤šï¼Œè¿™é‡Œç®€å•ä»‹ç»ä¸€ä¸‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Reader</span> &#123;</span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="comment">// Interface for reporting errors.</span></span><br><span class="line">  <span class="keyword">class</span> <span class="title class_">Reporter</span> &#123;</span><br><span class="line">   <span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">virtual</span> ~<span class="built_in">Reporter</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Some corruption was detected.  &quot;size&quot; is the approximate number</span></span><br><span class="line">    <span class="comment">// of bytes dropped due to the corruption.</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">Corruption</span><span class="params">(<span class="type">size_t</span> bytes, <span class="type">const</span> Status&amp; status)</span> </span>= <span class="number">0</span>;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Create a reader that will return log records from &quot;*file&quot;.</span></span><br><span class="line">  <span class="comment">// &quot;*file&quot; must remain live while this Reader is in use.</span></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  <span class="comment">// If &quot;reporter&quot; is non-null, it is notified whenever some data is</span></span><br><span class="line">  <span class="comment">// dropped due to a detected corruption.  &quot;*reporter&quot; must remain</span></span><br><span class="line">  <span class="comment">// live while this Reader is in use.</span></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  <span class="comment">// If &quot;checksum&quot; is true, verify checksums if available.</span></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  <span class="comment">// The Reader will start reading at the first record located at physical</span></span><br><span class="line">  <span class="comment">// position &gt;= initial_offset within the file.</span></span><br><span class="line">  <span class="built_in">Reader</span>(SequentialFile* file, Reporter* reporter, <span class="type">bool</span> checksum,</span><br><span class="line">         <span class="type">uint64_t</span> initial_offset);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">Reader</span>(<span class="type">const</span> Reader&amp;) = <span class="keyword">delete</span>;</span><br><span class="line">  Reader&amp; <span class="keyword">operator</span>=(<span class="type">const</span> Reader&amp;) = <span class="keyword">delete</span>;</span><br><span class="line"></span><br><span class="line">  ~<span class="built_in">Reader</span>();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Read the next record into *record.  Returns true if read</span></span><br><span class="line">  <span class="comment">// successfully, false if we hit end of the input.  May use</span></span><br><span class="line">  <span class="comment">// &quot;*scratch&quot; as temporary storage.  The contents filled in *record</span></span><br><span class="line">  <span class="comment">// will only be valid until the next mutating operation on this</span></span><br><span class="line">  <span class="comment">// reader or the next mutation to *scratch.</span></span><br><span class="line">  <span class="function"><span class="type">bool</span> <span class="title">ReadRecord</span><span class="params">(Slice* record, std::string* scratch)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Returns the physical offset of the last record returned by ReadRecord.</span></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  <span class="comment">// Undefined before the first call to ReadRecord.</span></span><br><span class="line">  <span class="function"><span class="type">uint64_t</span> <span class="title">LastRecordOffset</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span>:</span><br><span class="line">  <span class="comment">// Extend record types with the following special values</span></span><br><span class="line">  <span class="keyword">enum</span> &#123;</span><br><span class="line">    kEof = kMaxRecordType + <span class="number">1</span>,</span><br><span class="line">    <span class="comment">// Returned whenever we find an invalid physical record.</span></span><br><span class="line">    <span class="comment">// Currently there are three situations in which this happens:</span></span><br><span class="line">    <span class="comment">// * The record has an invalid CRC (ReadPhysicalRecord reports a drop)</span></span><br><span class="line">    <span class="comment">// * The record is a 0-length record (No drop is reported)</span></span><br><span class="line">    <span class="comment">// * The record is below constructor&#x27;s initial_offset (No drop is reported)</span></span><br><span class="line">    kBadRecord = kMaxRecordType + <span class="number">2</span></span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Skips all blocks that are completely before &quot;initial_offset_&quot;.</span></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  <span class="comment">// Returns true on success. Handles reporting.</span></span><br><span class="line">  <span class="function"><span class="type">bool</span> <span class="title">SkipToInitialBlock</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è¿”å› kMaxRecordType å®šä¹‰çš„ type æˆ–è€… eof</span></span><br><span class="line">  <span class="comment">// Return type, or one of the preceding special values</span></span><br><span class="line">  <span class="function"><span class="type">unsigned</span> <span class="type">int</span> <span class="title">ReadPhysicalRecord</span><span class="params">(Slice* result)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Reports dropped bytes to the reporter.</span></span><br><span class="line">  <span class="comment">// buffer_ must be updated to remove the dropped bytes prior to invocation.</span></span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">ReportCorruption</span><span class="params">(<span class="type">uint64_t</span> bytes, <span class="type">const</span> <span class="type">char</span>* reason)</span></span>;</span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">ReportDrop</span><span class="params">(<span class="type">uint64_t</span> bytes, <span class="type">const</span> Status&amp; reason)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// SequentialFile,  * const å³ä¸ä¼šæŒ‡å‘åˆ«çš„å¯¹è±¡</span></span><br><span class="line">  SequentialFile* <span class="type">const</span> file_;</span><br><span class="line">  <span class="comment">// Reporter ä¸ŠæŠ¥äº‹ä»¶</span></span><br><span class="line">  Reporter* <span class="type">const</span> reporter_;</span><br><span class="line">  <span class="comment">// æ˜¯å¦ä½¿ç”¨ checksum</span></span><br><span class="line">  <span class="type">bool</span> <span class="type">const</span> checksum_;</span><br><span class="line">  <span class="comment">// æ„Ÿè§‰ä¸Š backing_store_ æ˜¯ä¸€ä¸ª kBlockSize å¤§å°çš„æ•°ç»„</span></span><br><span class="line">  <span class="comment">// ç”¨æ¥å­˜æ”¾è¯»åˆ°çš„ä¿¡æ¯ã€‚</span></span><br><span class="line">  <span class="type">char</span>* <span class="type">const</span> backing_store_;</span><br><span class="line">  <span class="comment">// è¯» buffer, æŒ‡å‘ backing_store</span></span><br><span class="line">  Slice buffer_;</span><br><span class="line">  <span class="comment">// EOF å¤„ç†</span></span><br><span class="line">  <span class="type">bool</span> eof_;  <span class="comment">// Last Read() indicated EOF by returning &lt; kBlockSize</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ–‡ä»¶ä¸­ last_record è¯»çš„ offset</span></span><br><span class="line">  <span class="comment">// Offset of the last record returned by ReadRecord.</span></span><br><span class="line">  <span class="type">uint64_t</span> last_record_offset_;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ç»´æŠ¤çš„ buffer çš„ offset</span></span><br><span class="line">  <span class="comment">// Offset of the first location past the end of buffer_.</span></span><br><span class="line">  <span class="type">uint64_t</span> end_of_buffer_offset_;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// The Reader will start reading at the first record located at physical</span></span><br><span class="line">  <span class="comment">//   position &gt;= initial_offset within the file.</span></span><br><span class="line">  <span class="comment">// Offset at which to start looking for the first record to return</span></span><br><span class="line">  <span class="type">uint64_t</span> <span class="type">const</span> initial_offset_;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// True if we are resynchronizing after a seek (initial_offset_ &gt; 0). In</span></span><br><span class="line">  <span class="comment">// particular, a run of kMiddleType and kLastType records can be silently</span></span><br><span class="line">  <span class="comment">// skipped in this mode</span></span><br><span class="line">  <span class="comment">// æ˜¯å¦éœ€è¦é‡æ–°åŒæ­¥ï¼Œé€šå¸¸å› ä¸º initial_offset_ seek ä¹‹åå¯¼è‡´</span></span><br><span class="line">  <span class="type">bool</span> resyncing_;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><ul><li>å¤–éƒ¨è°ƒç”¨ read-offset æ¥è¯»å–ä¿¡æ¯</li><li><code>backing_store_</code> å’Œ <code>buffer_</code> ç”¨æ¥ç®¡ç†è¯»åˆ°çš„ä¿¡æ¯ï¼Œ<code>end_of_buffer_offset_</code> æ˜¯æ ‡æ³¨<code>buffer_</code> è¯»åˆ°çš„ä¿¡æ¯çš„ length çš„</li><li><code>eof_</code> è¡¨ç¤ºè¯»å–æ˜¯å¦æ˜¯ <code>eof</code> çŠ¶æ€</li><li><code>initial_offset_</code> è¡¨ç¤ºæœ€åˆè·³è¿‡çš„ offset, å®ç°çš„æ—¶å€™ä¸ºäº†å¯¹é½ä¹‹ç±»çš„ç†ç”±ä¸ä¼šç›´æ¥ seek åˆ°å¯¹åº”ä½ç½®ï¼Œè€Œæ˜¯ seek åˆ° block çš„å¼€å¤´ï¼Œç„¶å <code>resyncing_</code> ã€‚</li></ul><p>reader æ„é€ å‡½æ•°å¦‚ä¸‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Reader::<span class="built_in">Reader</span>(SequentialFile* file, Reporter* reporter, <span class="type">bool</span> checksum,</span><br><span class="line">               <span class="type">uint64_t</span> initial_offset)</span><br><span class="line">    : <span class="built_in">file_</span>(file),</span><br><span class="line">      <span class="built_in">reporter_</span>(reporter),</span><br><span class="line">      <span class="built_in">checksum_</span>(checksum),</span><br><span class="line">      <span class="built_in">backing_store_</span>(<span class="keyword">new</span> <span class="type">char</span>[kBlockSize]),</span><br><span class="line">      <span class="built_in">buffer_</span>(),</span><br><span class="line">      <span class="built_in">eof_</span>(<span class="literal">false</span>),</span><br><span class="line">      <span class="built_in">last_record_offset_</span>(<span class="number">0</span>),</span><br><span class="line">      <span class="built_in">end_of_buffer_offset_</span>(<span class="number">0</span>),</span><br><span class="line">      <span class="built_in">initial_offset_</span>(initial_offset),</span><br><span class="line">      <span class="built_in">resyncing_</span>(initial_offset &gt; <span class="number">0</span>) &#123;&#125;</span><br></pre></td></tr></table></figure><p>å…¶å®æ¯”è¾ƒæœ‰æ„æ€çš„æ˜¯ <code>backing_store_</code> çš„åˆå§‹åŒ–ï¼Œä¸ºä»€ä¹ˆè¦åœ¨å †ä¸Šæ=ï¼Œ=æˆ‘ä¹Ÿä¸å¤ªäº†è§£</p><p>è¯»æµç¨‹å¤§è‡´å¦‚ä¸‹ï¼Œå¯ä»¥å‚è€ƒ <code>ReadRecord</code> å’Œ <code>ReadPhysicalRecord</code>ï¼š</p><ul><li>å°è¯•seekåˆ° block çš„å¼€å¤´ï¼Œç„¶åæ¯æ¬¡è¯»å–çš„æ—¶å€™ï¼Œè¯»å–ä¸€ä¸ª blockã€‚æ•°æ®ä¼šè¢«è¯»å–åˆ° <code>backing_store_</code> é‡Œï¼Œå¹¶ä»¥ <code>buffer_</code> çš„å½¢å¼è®¿é—®</li><li>åœ¨<code>buffer_</code> ä¸­è¿˜æœ‰è¶³å¤Ÿå†…å®¹çš„æ—¶å€™ï¼Œä»é‡Œé¢è¯»å– <code>record</code></li><li>è¯»å–ä¸å®Œæ•´çš„è¯ä¼šå†™å…¥åˆ° <code>scratch</code> é‡Œï¼Œ<code>ReadRecord</code> å®ç°äº†ä¸€ä¸ªç±»ä¼¼çŠ¶æ€æœºçš„æ¨¡å‹ï¼Œæœ€åä¼šæŠŠ <code>record</code> å®Œæ•´åå‡ºæ¥ã€‚</li></ul><h3 id="æ—¥å¿—ä¸é”™è¯¯å¤„ç†"><a href="#æ—¥å¿—ä¸é”™è¯¯å¤„ç†" class="headerlink" title="æ—¥å¿—ä¸é”™è¯¯å¤„ç†"></a>æ—¥å¿—ä¸é”™è¯¯å¤„ç†</h3><p>å¤§éƒ¨åˆ†é”™è¯¯å¤„ç†æˆ‘è§‰å¾—çœ‹ reader ä»£ç èƒ½å­¦åˆ°ä¸å°‘ã€‚</p><p>æ–‡æ¡£é‡Œè¿˜æåˆ°äº†å’Œ <code>RecordIO Data Format</code> çš„å¯¹æ¯”ï¼š<a href="http://mesos.apache.org/documentation/latest/recordio/">http://mesos.apache.org/documentation/latest/recordio/</a></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>LevelDB Arena: memory of skiplist</title>
      <link href="/2020/05/25/LevelDB-Arena-memory-of-skiplist/"/>
      <url>/2020/05/25/LevelDB-Arena-memory-of-skiplist/</url>
      
        <content type="html"><![CDATA[<p><code>Arena</code> çš„è‹±æ–‡æ„æ€å¤§æ¦‚æ˜¯</p><blockquote><p>An <strong>arena</strong> is an enclosed area that showcases theatre, musical performances or sporting events.</p></blockquote><p>åœ¨ LevelDB ä¸­ï¼Œ<code>Arena</code> æ˜¯ç»™ SkipList æä¾›å†…å­˜æ¥æºçš„ï¼ŒSkipList ä¼šæä¾› <code>key-value</code> çš„æ•°æ®ã€‚åŒæ—¶ï¼ŒSkipList æ˜¯ mvcc çš„ï¼Œå®ƒåœ¨ Minor Compaction çš„æ—¶å€™ï¼Œæ‰ä¼šå»æ‰ä¸€äº› deleted data, è¿™æ„å‘³ç€ SkipList åœ¨å†…å­˜ä¸­åªä¼š â€œå°è¯•å¢åŠ å†…å­˜â€ã€‚</p><p>åŒæ—¶ï¼Œ<code>key-value</code> ï¼ˆå†åŠ ä¸Šç‰ˆæœ¬ï¼‰ä¸€èˆ¬ä¹Ÿä¸ä¼šç‰¹åˆ«å¤§ï¼Œå¦‚æœå¤§çš„è¯å¯ä»¥å‚è€ƒ WiscKey çš„æ–‡ç« ï¼Œè¿™é‡Œè½¬å‘ä¸€ç¯‡åˆ«äººå†™çš„åšå®¢ï¼š</p><ul><li><a href="https://zhuanlan.zhihu.com/p/30953751">https://zhuanlan.zhihu.com/p/30953751</a></li></ul><p>ä»¥ä¸Šä¸¤ç‚¹éœ€æ±‚å¯ä»¥å¸®åŠ©æˆ‘ä»¬äº†è§£ <code>Arena</code> çš„éœ€æ±‚ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Arena</span> &#123;</span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="built_in">Arena</span>();</span><br><span class="line"></span><br><span class="line">  <span class="built_in">Arena</span>(<span class="type">const</span> Arena&amp;) = <span class="keyword">delete</span>;</span><br><span class="line">  Arena&amp; <span class="keyword">operator</span>=(<span class="type">const</span> Arena&amp;) = <span class="keyword">delete</span>;</span><br><span class="line"></span><br><span class="line">  ~<span class="built_in">Arena</span>();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Return a pointer to a newly allocated memory block of &quot;bytes&quot; bytes.</span></span><br><span class="line">  <span class="function"><span class="type">char</span>* <span class="title">Allocate</span><span class="params">(<span class="type">size_t</span> bytes)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Allocate memory with the normal alignment guarantees provided by malloc.</span></span><br><span class="line">  <span class="function"><span class="type">char</span>* <span class="title">AllocateAligned</span><span class="params">(<span class="type">size_t</span> bytes)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Returns an estimate of the total memory usage of data allocated</span></span><br><span class="line">  <span class="comment">// by the arena.</span></span><br><span class="line">  <span class="function"><span class="type">size_t</span> <span class="title">MemoryUsage</span><span class="params">()</span> <span class="type">const</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> memory_usage_.<span class="built_in">load</span>(std::memory_order_relaxed);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span>:</span><br><span class="line">  <span class="function"><span class="type">char</span>* <span class="title">AllocateFallback</span><span class="params">(<span class="type">size_t</span> bytes)</span></span>;</span><br><span class="line">  <span class="function"><span class="type">char</span>* <span class="title">AllocateNewBlock</span><span class="params">(<span class="type">size_t</span> block_bytes)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Allocation state</span></span><br><span class="line">  <span class="type">char</span>* alloc_ptr_;</span><br><span class="line">  <span class="type">size_t</span> alloc_bytes_remaining_;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Array of new[] allocated memory blocks</span></span><br><span class="line">  std::vector&lt;<span class="type">char</span>*&gt; blocks_;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Total memory usage of the arena.</span></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  <span class="comment">// TODO(costan): This member is accessed via atomics, but the others are</span></span><br><span class="line">  <span class="comment">//               accessed without any locking. Is this OK?</span></span><br><span class="line">  std::atomic&lt;<span class="type">size_t</span>&gt; memory_usage_;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><ul><li>skiplist å¯ä»¥æ‹¿åˆ°å¯¹åº”çš„ arena, arena è´Ÿè´£ç”³è¯·å†…å­˜</li><li><code>MemoryUsage</code> è¿”å› <code>Arena</code> æ€»å…±ç”³è¯·çš„å†…å­˜</li><li><code>Allocate</code> å’Œ <code>AllocateAlign</code> ç»™ skiplist ç”³è¯·å†…å­˜ï¼Œä¹Ÿé˜²æ­¢å†…å­˜çš„ç¢ç‰‡åŒ–</li></ul><p>æœ‰ä¸€ç‚¹é—®é¢˜æ˜¯ï¼Œçœ‹ä¸Šå» <code>Arena</code> ä½¿ç”¨ä¼¼ä¹æ˜¯å•çº¿ç¨‹çš„ã€‚</p><h2 id="ç”³è¯·æµç¨‹"><a href="#ç”³è¯·æµç¨‹" class="headerlink" title="ç”³è¯·æµç¨‹"></a>ç”³è¯·æµç¨‹</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">int</span> kBlockSize = <span class="number">4096</span>;</span><br><span class="line"></span><br><span class="line">Arena::<span class="built_in">Arena</span>()</span><br><span class="line">    : <span class="built_in">alloc_ptr_</span>(<span class="literal">nullptr</span>), <span class="built_in">alloc_bytes_remaining_</span>(<span class="number">0</span>), <span class="built_in">memory_usage_</span>(<span class="number">0</span>) &#123;&#125;</span><br><span class="line"></span><br><span class="line">Arena::~<span class="built_in">Arena</span>() &#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; blocks_.<span class="built_in">size</span>(); i++) &#123;</span><br><span class="line">    <span class="keyword">delete</span>[] blocks_[i];</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>Arena</code> åœ¨ <code>blocks_</code> ä¸­ç®¡ç†è‡ªå·±çš„å†…å­˜ï¼Œ<code>alloc_ptr_</code> æŒ‡å‘ç°åœ¨ç®¡ç†çš„ <code>block</code>, <code>alloc_bytes_remaining_</code> ç®¡ç†ç°æœ‰ <code>block</code> å‰©ä½™çš„å†…å­˜</p><p>ä¸‹é¢æ˜¯ allocate çš„æµç¨‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">char</span>* <span class="title">Arena::Allocate</span><span class="params">(<span class="type">size_t</span> bytes)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// The semantics of what to return are a bit messy if we allow</span></span><br><span class="line">  <span class="comment">// 0-byte allocations, so we disallow them here (we don&#x27;t need</span></span><br><span class="line">  <span class="comment">// them for our internal use).</span></span><br><span class="line">  <span class="built_in">assert</span>(bytes &gt; <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> (bytes &lt;= alloc_bytes_remaining_) &#123;</span><br><span class="line">    <span class="type">char</span>* result = alloc_ptr_;</span><br><span class="line">    alloc_ptr_ += bytes;</span><br><span class="line">    alloc_bytes_remaining_ -= bytes;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">AllocateFallback</span>(bytes);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>ç°æœ‰çš„ <code>alloc_bytes_remaining_</code> æœ‰ç©ºé—´ï¼Œä¼šç›´æ¥å°è¯•è¿”å›</li><li>å¦åˆ™è¿›å…¥ <code>AllocateFallback</code></li></ul><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">char</span>* <span class="title">Arena::AllocateFallback</span><span class="params">(<span class="type">size_t</span> bytes)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (bytes &gt; kBlockSize / <span class="number">4</span>) &#123;</span><br><span class="line">    <span class="comment">// Object is more than a quarter of our block size.  Allocate it separately</span></span><br><span class="line">    <span class="comment">// to avoid wasting too much space in leftover bytes.</span></span><br><span class="line">    <span class="type">char</span>* result = <span class="built_in">AllocateNewBlock</span>(bytes);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// We waste the remaining space in the current block.</span></span><br><span class="line">  alloc_ptr_ = <span class="built_in">AllocateNewBlock</span>(kBlockSize);</span><br><span class="line">  alloc_bytes_remaining_ = kBlockSize;</span><br><span class="line"></span><br><span class="line">  <span class="type">char</span>* result = alloc_ptr_;</span><br><span class="line">  alloc_ptr_ += bytes;</span><br><span class="line">  alloc_bytes_remaining_ -= bytes;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ <code>AllocateFallback</code> ä¸­é€»è¾‘æ˜¯ï¼š</p><ul><li>å¦‚æœç”³è¯·å†…å­˜è¿‡å¤§ï¼ˆå¤§äº <code>kBlockSize / 4</code>ï¼‰å³ç›´æ¥ç”³è¯·æ–°çš„å—è¿”å›</li><li>å¦åˆ™ <code>AllocateNewBlock</code>, åŒæ—¶æŠŠç°æœ‰çš„æŒ‡é’ˆæŒ‡å‘æ–°çš„ block</li></ul><p>æ³¨æ„çš„ä¸€ç‚¹æ˜¯ï¼Œå†…å­˜è¿‡å¤§çš„æ—¶å€™ï¼Œä¸ä¼šæ”¹å˜ <code>alloc_ptr_</code>ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæ’å…¥äº†æ–°çš„ <code>block_</code>, ä½†æ˜¯ä¸æ”¹å˜ç°æœ‰çš„ <code>alloc_ptr_</code>ã€‚</p><p>å¯¹äºç”³è¯· new block, ä»£ç å¾ˆç®€å•ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">char</span>* <span class="title">Arena::AllocateNewBlock</span><span class="params">(<span class="type">size_t</span> block_bytes)</span> </span>&#123;</span><br><span class="line">  <span class="type">char</span>* result = <span class="keyword">new</span> <span class="type">char</span>[block_bytes];</span><br><span class="line">  blocks_.<span class="built_in">push_back</span>(result);</span><br><span class="line">  memory_usage_.<span class="built_in">fetch_add</span>(block_bytes + <span class="built_in">sizeof</span>(<span class="type">char</span>*),</span><br><span class="line">                          std::memory_order_relaxed);</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="ä¸€äº›é—®é¢˜"><a href="#ä¸€äº›é—®é¢˜" class="headerlink" title="ä¸€äº›é—®é¢˜"></a>ä¸€äº›é—®é¢˜</h2><ul><li>å¯¹äº <code>Allocate</code>, å‡è®¾ä¸€å¼€å§‹ç¢ç‰‡åŒ–çš„ç¥å¥‡ï¼Œå‰©ä¸‹900ä½™ bytes, å†ç”³è¯·ä¸€ä¸ª 900+ bytes çš„å†…å­˜ï¼Œæ˜¯å¦ä¼šé€ æˆæ¯”è¾ƒå¤§çš„å†…å­˜ç¢ç‰‡ï¼Ÿ</li><li>jemalloc ä¹‹ç±»çš„åˆ†é…å™¨å¯¹äºå¤„ç†å°å†…å­˜åº”è¯¥æœ‰æ¯”è¾ƒå¥½çš„æ–¹æ¡ˆï¼Œè¿™ä¸ªæ—¶å€™ <code>Arena</code> æœ‰ä»€ä¹ˆå¸®åŠ©ã€‚</li></ul><p>ä¸çŸ¥é“æœ‰æ²¡æœ‰äººèƒ½æ¨èä¾¿äºé˜…è¯»çš„ allocatorâ€¦</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>LevelDB Put: How it batch</title>
      <link href="/2020/05/25/LevelDB-Put-How-it-batch/"/>
      <url>/2020/05/25/LevelDB-Put-How-it-batch/</url>
      
        <content type="html"><![CDATA[<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Convenience methods</span></span><br><span class="line"><span class="function">Status <span class="title">DBImpl::Put</span><span class="params">(<span class="type">const</span> WriteOptions&amp; o, <span class="type">const</span> Slice&amp; key, <span class="type">const</span> Slice&amp; val)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> DB::<span class="built_in">Put</span>(o, key, val);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è°ƒç”¨çš„æ˜¯</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Default implementations of convenience methods that subclasses of DB</span></span><br><span class="line"><span class="comment">// can call if they wish</span></span><br><span class="line"><span class="function">Status <span class="title">DB::Put</span><span class="params">(<span class="type">const</span> WriteOptions&amp; opt, <span class="type">const</span> Slice&amp; key, <span class="type">const</span> Slice&amp; value)</span> </span>&#123;</span><br><span class="line">  WriteBatch batch;</span><br><span class="line">  batch.<span class="built_in">Put</span>(key, value);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">Write</span>(opt, &amp;batch);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å…ˆä»‹ç»ä¸€ä¸‹<code>Writer</code>, è¿™ç©æ„å®é™…ä¸Šæ˜¯ <code>DBImpl::Writer</code></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Information kept for every waiting writer</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">DBImpl</span>::Writer &#123;</span><br><span class="line">  <span class="function"><span class="keyword">explicit</span> <span class="title">Writer</span><span class="params">(port::Mutex* mu)</span></span></span><br><span class="line"><span class="function">      : batch(nullptr), sync(false), done(false), cv(mu) &#123;</span>&#125;</span><br><span class="line"></span><br><span class="line">  Status status;</span><br><span class="line">  WriteBatch* batch;</span><br><span class="line">  <span class="type">bool</span> sync;</span><br><span class="line">  <span class="type">bool</span> done;</span><br><span class="line">  port::CondVar cv;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><ul><li><code>batch</code> æŒ‡å®šäº†ä¸€æ‰¹å†™å…¥çš„ <code>WriteBatch</code></li><li><code>cv</code> æ˜¯è·¨å¹³å°çš„ condvarï¼ˆçœ‹æ¥è¿™ä¸ªä»£ç ä¸æ˜¯ C++11 å†™çš„ï¼‰ï¼Œç”¨ä¸Šå±‚çš„ <code>mutex_</code> æ„å»º cv, æ¥è¡¨ç¤ºæœ¬æ¬¡å†™å…¥çš„çŠ¶æ€</li><li><code>done</code> è¡¨ç¤ºå†™å…¥çš„çŠ¶æ€ï¼Œç”¨æ¥äº¤ç»™ caller</li><li><code>sync</code> è¡¨ç¤ºå†™å…¥æ˜¯å¦å¼ºåˆ¶åšsync ç”¨äºå–‚ç»™ callee</li></ul><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Status <span class="title">DBImpl::Write</span><span class="params">(<span class="type">const</span> WriteOptions&amp; options, WriteBatch* updates)</span> </span>&#123;</span><br><span class="line">  <span class="function">Writer <span class="title">w</span><span class="params">(&amp;mutex_)</span></span>;</span><br><span class="line">  w.batch = updates;</span><br><span class="line">  w.sync = options.sync;</span><br><span class="line">  w.done = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function">MutexLock <span class="title">l</span><span class="params">(&amp;mutex_)</span></span>;</span><br><span class="line">  writers_.<span class="built_in">push_back</span>(&amp;w);</span><br><span class="line">  <span class="keyword">while</span> (!w.done &amp;&amp; &amp;w != writers_.<span class="built_in">front</span>()) &#123;</span><br><span class="line">    w.cv.<span class="built_in">Wait</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (w.done) &#123;</span><br><span class="line">    <span class="keyword">return</span> w.status;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// May temporarily unlock and wait.</span></span><br><span class="line">  Status status = <span class="built_in">MakeRoomForWrite</span>(updates == <span class="literal">nullptr</span>);</span><br><span class="line">  <span class="type">uint64_t</span> last_sequence = versions_-&gt;<span class="built_in">LastSequence</span>();</span><br><span class="line">  Writer* last_writer = &amp;w;</span><br><span class="line">  <span class="keyword">if</span> (status.<span class="built_in">ok</span>() &amp;&amp; updates != <span class="literal">nullptr</span>) &#123;  <span class="comment">// nullptr batch is for compactions</span></span><br><span class="line">    WriteBatch* write_batch = <span class="built_in">BuildBatchGroup</span>(&amp;last_writer);</span><br><span class="line">    WriteBatchInternal::<span class="built_in">SetSequence</span>(write_batch, last_sequence + <span class="number">1</span>);</span><br><span class="line">    last_sequence += WriteBatchInternal::<span class="built_in">Count</span>(write_batch);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Add to log and apply to memtable.  We can release the lock</span></span><br><span class="line">    <span class="comment">// during this phase since &amp;w is currently responsible for logging</span></span><br><span class="line">    <span class="comment">// and protects against concurrent loggers and concurrent writes</span></span><br><span class="line">    <span class="comment">// into mem_.</span></span><br><span class="line">    &#123;</span><br><span class="line">      mutex_.<span class="built_in">Unlock</span>();</span><br><span class="line">      status = log_-&gt;<span class="built_in">AddRecord</span>(WriteBatchInternal::<span class="built_in">Contents</span>(write_batch));</span><br><span class="line">      <span class="type">bool</span> sync_error = <span class="literal">false</span>;</span><br><span class="line">      <span class="keyword">if</span> (status.<span class="built_in">ok</span>() &amp;&amp; options.sync) &#123;</span><br><span class="line">        status = logfile_-&gt;<span class="built_in">Sync</span>();</span><br><span class="line">        <span class="keyword">if</span> (!status.<span class="built_in">ok</span>()) &#123;</span><br><span class="line">          sync_error = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (status.<span class="built_in">ok</span>()) &#123;</span><br><span class="line">        status = WriteBatchInternal::<span class="built_in">InsertInto</span>(write_batch, mem_);</span><br><span class="line">      &#125;</span><br><span class="line">      mutex_.<span class="built_in">Lock</span>();</span><br><span class="line">      <span class="keyword">if</span> (sync_error) &#123;</span><br><span class="line">        <span class="comment">// The state of the log file is indeterminate: the log record we</span></span><br><span class="line">        <span class="comment">// just added may or may not show up when the DB is re-opened.</span></span><br><span class="line">        <span class="comment">// So we force the DB into a mode where all future writes fail.</span></span><br><span class="line">        <span class="built_in">RecordBackgroundError</span>(status);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (write_batch == tmp_batch_) tmp_batch_-&gt;<span class="built_in">Clear</span>();</span><br><span class="line"></span><br><span class="line">    versions_-&gt;<span class="built_in">SetLastSequence</span>(last_sequence);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">    Writer* ready = writers_.<span class="built_in">front</span>();</span><br><span class="line">    writers_.<span class="built_in">pop_front</span>();</span><br><span class="line">    <span class="keyword">if</span> (ready != &amp;w) &#123;</span><br><span class="line">      ready-&gt;status = status;</span><br><span class="line">      ready-&gt;done = <span class="literal">true</span>;</span><br><span class="line">      ready-&gt;cv.<span class="built_in">Signal</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (ready == last_writer) <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Notify new head of write queue</span></span><br><span class="line">  <span class="keyword">if</span> (!writers_.<span class="built_in">empty</span>()) &#123;</span><br><span class="line">    writers_.<span class="built_in">front</span>()-&gt;cv.<span class="built_in">Signal</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‰æœŸæ˜¯åšä¸€äº› checking, å¾ˆé‡è¦çš„æ˜¯ <code>BuildBatchGroup</code> è¿™ä¸ªå‡½æ•°ï¼Œæˆ‘è§‰å¾—è¿™ä¸ªå‡½æ•°å†™çš„å¥½å¥‡å¦™</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Status <span class="title">DBImpl::Write</span><span class="params">(<span class="type">const</span> WriteOptions&amp; options, WriteBatch* updates)</span> </span>&#123;</span><br><span class="line">  <span class="function">Writer <span class="title">w</span><span class="params">(&amp;mutex_)</span></span>;</span><br><span class="line">  w.batch = updates;</span><br><span class="line">  w.sync = options.sync;</span><br><span class="line">  w.done = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function">MutexLock <span class="title">l</span><span class="params">(&amp;mutex_)</span></span>;</span><br><span class="line">  writers_.<span class="built_in">push_back</span>(&amp;w);</span><br><span class="line">  <span class="keyword">while</span> (!w.done &amp;&amp; &amp;w != writers_.<span class="built_in">front</span>()) &#123;</span><br><span class="line">    w.cv.<span class="built_in">Wait</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (w.done) &#123;</span><br><span class="line">    <span class="keyword">return</span> w.status;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// May temporarily unlock and wait.</span></span><br><span class="line">  Status status = <span class="built_in">MakeRoomForWrite</span>(updates == <span class="literal">nullptr</span>);</span><br><span class="line">  <span class="type">uint64_t</span> last_sequence = versions_-&gt;<span class="built_in">LastSequence</span>();</span><br><span class="line">  Writer* last_writer = &amp;w;</span><br><span class="line">  <span class="keyword">if</span> (status.<span class="built_in">ok</span>() &amp;&amp; updates != <span class="literal">nullptr</span>) &#123;  <span class="comment">// nullptr batch is for compactions</span></span><br><span class="line">    <span class="comment">// write_batch æ˜¯ write çš„æ—¶å€™æ‰¹é‡å†™å†…å®¹ï¼ŒæŠŠ last_writer è°ƒæ•´åˆ°äº†çœŸæ­£çš„ batch å†™çš„æœ«å°¾ã€‚</span></span><br><span class="line">    WriteBatch* write_batch = <span class="built_in">BuildBatchGroup</span>(&amp;last_writer);</span><br><span class="line">    WriteBatchInternal::<span class="built_in">SetSequence</span>(write_batch, last_sequence + <span class="number">1</span>);</span><br><span class="line">    last_sequence += WriteBatchInternal::<span class="built_in">Count</span>(write_batch);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Add to log and apply to memtable.  We can release the lock</span></span><br><span class="line">    <span class="comment">// during this phase since &amp;w is currently responsible for logging</span></span><br><span class="line">    <span class="comment">// and protects against concurrent loggers and concurrent writes</span></span><br><span class="line">    <span class="comment">// into mem_.</span></span><br><span class="line">    &#123;</span><br><span class="line">      mutex_.<span class="built_in">Unlock</span>();</span><br><span class="line">      <span class="comment">// å…ˆå†™ Log å†å†™ mem_</span></span><br><span class="line">      status = log_-&gt;<span class="built_in">AddRecord</span>(WriteBatchInternal::<span class="built_in">Contents</span>(write_batch));</span><br><span class="line">      <span class="type">bool</span> sync_error = <span class="literal">false</span>;</span><br><span class="line">      <span class="keyword">if</span> (status.<span class="built_in">ok</span>() &amp;&amp; options.sync) &#123;</span><br><span class="line">        status = logfile_-&gt;<span class="built_in">Sync</span>();</span><br><span class="line">        <span class="keyword">if</span> (!status.<span class="built_in">ok</span>()) &#123;</span><br><span class="line">          sync_error = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (status.<span class="built_in">ok</span>()) &#123;</span><br><span class="line">        status = WriteBatchInternal::<span class="built_in">InsertInto</span>(write_batch, mem_);</span><br><span class="line">      &#125;</span><br><span class="line">      mutex_.<span class="built_in">Lock</span>();</span><br><span class="line">      <span class="keyword">if</span> (sync_error) &#123;</span><br><span class="line">        <span class="comment">// The state of the log file is indeterminate: the log record we</span></span><br><span class="line">        <span class="comment">// just added may or may not show up when the DB is re-opened.</span></span><br><span class="line">        <span class="comment">// So we force the DB into a mode where all future writes fail.</span></span><br><span class="line">        <span class="built_in">RecordBackgroundError</span>(status);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (write_batch == tmp_batch_) tmp_batch_-&gt;<span class="built_in">Clear</span>();</span><br><span class="line"></span><br><span class="line">    versions_-&gt;<span class="built_in">SetLastSequence</span>(last_sequence);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">    Writer* ready = writers_.<span class="built_in">front</span>();</span><br><span class="line">    writers_.<span class="built_in">pop_front</span>();</span><br><span class="line">    <span class="comment">// w æ˜¯ç°åœ¨ç®¡çš„ï¼Œæœ¬èº«æ²¡æœ‰å¿…è¦ signal</span></span><br><span class="line">    <span class="keyword">if</span> (ready != &amp;w) &#123;</span><br><span class="line">      ready-&gt;status = status;</span><br><span class="line">      ready-&gt;done = <span class="literal">true</span>;</span><br><span class="line">      ready-&gt;cv.<span class="built_in">Signal</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (ready == last_writer) <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Notify new head of write queue</span></span><br><span class="line">  <span class="keyword">if</span> (!writers_.<span class="built_in">empty</span>()) &#123;</span><br><span class="line">    writers_.<span class="built_in">front</span>()-&gt;cv.<span class="built_in">Signal</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆæˆ‘ä»¬ä¸»è¦çš„é€»è¾‘å°±çœ‹å®Œäº†ï¼Œå›å¤´å†çœ‹çœ‹ <code>MakeRoomForWrite</code>:</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// REQUIRES: mutex_ is held</span></span><br><span class="line"><span class="comment">// REQUIRES: this thread is currently at the front of the writer queue</span></span><br><span class="line"><span class="function">Status <span class="title">DBImpl::MakeRoomForWrite</span><span class="params">(<span class="type">bool</span> force)</span> </span>&#123;</span><br><span class="line">  mutex_.<span class="built_in">AssertHeld</span>();</span><br><span class="line">  <span class="built_in">assert</span>(!writers_.<span class="built_in">empty</span>());</span><br><span class="line">  <span class="type">bool</span> allow_delay = !force;</span><br><span class="line">  Status s;</span><br><span class="line">  <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!bg_error_.<span class="built_in">ok</span>()) &#123;</span><br><span class="line">      <span class="comment">// Yield previous error</span></span><br><span class="line">      s = bg_error_;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (allow_delay &amp;&amp; versions_-&gt;<span class="built_in">NumLevelFiles</span>(<span class="number">0</span>) &gt;=</span><br><span class="line">                                  config::kL0_SlowdownWritesTrigger) &#123;</span><br><span class="line">      <span class="comment">// We are getting close to hitting a hard limit on the number of</span></span><br><span class="line">      <span class="comment">// L0 files.  Rather than delaying a single write by several</span></span><br><span class="line">      <span class="comment">// seconds when we hit the hard limit, start delaying each</span></span><br><span class="line">      <span class="comment">// individual write by 1ms to reduce latency variance.  Also,</span></span><br><span class="line">      <span class="comment">// this delay hands over some CPU to the compaction thread in</span></span><br><span class="line">      <span class="comment">// case it is sharing the same core as the writer.</span></span><br><span class="line">      </span><br><span class="line">      <span class="comment">// L0 file åˆ°æé™çš„æ—¶å€™, å¯ä»¥å‚è€ƒ LevelDB çš„ WriteStall æ–‡æ¡£</span></span><br><span class="line">      mutex_.<span class="built_in">Unlock</span>();</span><br><span class="line">      env_-&gt;<span class="built_in">SleepForMicroseconds</span>(<span class="number">1000</span>);</span><br><span class="line">      allow_delay = <span class="literal">false</span>;  <span class="comment">// Do not delay a single write more than once</span></span><br><span class="line">      mutex_.<span class="built_in">Lock</span>();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!force &amp;&amp;</span><br><span class="line">               (mem_-&gt;<span class="built_in">ApproximateMemoryUsage</span>() &lt;= options_.write_buffer_size)) &#123;</span><br><span class="line">      <span class="comment">// There is room in current memtable</span></span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (imm_ != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">      <span class="comment">// We have filled up the current memtable, but the previous</span></span><br><span class="line">      <span class="comment">// one is still being compacted, so we wait.</span></span><br><span class="line">      <span class="built_in">Log</span>(options_.info_log, <span class="string">&quot;Current memtable full; waiting...\n&quot;</span>);</span><br><span class="line">      background_work_finished_signal_.<span class="built_in">Wait</span>();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (versions_-&gt;<span class="built_in">NumLevelFiles</span>(<span class="number">0</span>) &gt;= config::kL0_StopWritesTrigger) &#123;</span><br><span class="line">      <span class="comment">// There are too many level-0 files.</span></span><br><span class="line">      <span class="built_in">Log</span>(options_.info_log, <span class="string">&quot;Too many L0 files; waiting...\n&quot;</span>);</span><br><span class="line">      background_work_finished_signal_.<span class="built_in">Wait</span>();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// Attempt to switch to a new memtable and trigger compaction of old</span></span><br><span class="line">      <span class="built_in">assert</span>(versions_-&gt;<span class="built_in">PrevLogNumber</span>() == <span class="number">0</span>);</span><br><span class="line">      <span class="type">uint64_t</span> new_log_number = versions_-&gt;<span class="built_in">NewFileNumber</span>();</span><br><span class="line">      WritableFile* lfile = <span class="literal">nullptr</span>;</span><br><span class="line">      s = env_-&gt;<span class="built_in">NewWritableFile</span>(<span class="built_in">LogFileName</span>(dbname_, new_log_number), &amp;lfile);</span><br><span class="line">      <span class="keyword">if</span> (!s.<span class="built_in">ok</span>()) &#123;</span><br><span class="line">        <span class="comment">// Avoid chewing through file number space in a tight loop.</span></span><br><span class="line">        versions_-&gt;<span class="built_in">ReuseFileNumber</span>(new_log_number);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">delete</span> log_;</span><br><span class="line">      <span class="keyword">delete</span> logfile_;</span><br><span class="line">      logfile_ = lfile;</span><br><span class="line">      logfile_number_ = new_log_number;</span><br><span class="line">      log_ = <span class="keyword">new</span> log::<span class="built_in">Writer</span>(lfile);</span><br><span class="line">      imm_ = mem_;</span><br><span class="line">      has_imm_.<span class="built_in">store</span>(<span class="literal">true</span>, std::memory_order_release);</span><br><span class="line">      mem_ = <span class="keyword">new</span> <span class="built_in">MemTable</span>(internal_comparator_);</span><br><span class="line">      mem_-&gt;<span class="built_in">Ref</span>();</span><br><span class="line">      force = <span class="literal">false</span>;  <span class="comment">// Do not force another compaction if have room</span></span><br><span class="line">      <span class="built_in">MaybeScheduleCompaction</span>();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> s;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ˜¯ç»™ <code>memTable</code> å†™è¶³å¤Ÿçš„ç©ºé—´ï¼Œç„¶åé€»è¾‘ä¸Šä½œå‡ºåç»­å¤„ç†ã€‚</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Types In Golang: Part2</title>
      <link href="/2020/05/01/Types-In-Golang-Part2/"/>
      <url>/2020/05/01/Types-In-Golang-Part2/</url>
      
        <content type="html"><![CDATA[<h4 id="string"><a href="#string" class="headerlink" title="string"></a>string</h4><p>Golang é‡Œé¢çš„ string æ˜¯ immutable çš„ï¼Œå®ƒçš„ cap/len æ˜¯åŒä¸€ä¸ªå€¼ã€‚æˆ‘ä»¬å¯èƒ½éœ€è¦æ¶‰åŠä¸¤ä¸ªåˆ«çš„ç±»å‹ï¼š</p><ul><li><p>string æ˜¯ä¸€ä¸ª <code>byte</code> (<code>uint8</code> ) ç»„æˆçš„å¯¹è±¡ï¼Œå½¢å¼ä¸Šå¯ä»¥è„‘è¡¥ Rust çš„ <code>&amp;[u8]</code> (æ„Ÿè§‰æˆ‘è¯´çš„ä¸å¤ªå¯¹ï¼Œæœ‰ä¸æ˜¯ bytes ç»„æˆçš„ string ä¹ˆ)</p></li><li><p>æˆ‘ä»¬éœ€è¦æ¶‰åŠå¦ä¸€ä¸ªç±»å‹ <code>rune</code> ï¼Œå³ unicodeã€‚å…·ä½“ string å¯èƒ½ç”±ä¸å®šé•¿çš„ä¸åŒ unicode æ„æˆï¼Œæ‰€ä»¥</p><blockquote><p>åœ¨Goä¸­ï¼Œæ‰€æœ‰çš„å­—ç¬¦ä¸²å¸¸é‡éƒ½è¢«è§†ä¸ºæ˜¯UTF-8ç¼–ç çš„ã€‚ åœ¨ç¼–è¯‘æ—¶åˆ»ï¼Œéæ³•UTF-8ç¼–ç çš„å­—ç¬¦ ä¸²å¸¸é‡å°†å¯¼è‡´ç¼–è¯‘å¤±è´¥ã€‚ åœ¨è¿è¡Œæ—¶åˆ»ï¼ŒGoè¿è¡Œæ—¶æ— æ³•é˜»æ­¢ä¸€ä¸ªå­—ç¬¦ä¸²æ˜¯éæ³•UTF-8ç¼–ç çš„ã€‚</p></blockquote></li></ul><blockquote><p>å­—ç¬¦ä¸²ç±»å‹æ²¡æœ‰å†…ç½®çš„æ–¹æ³•ã€‚æˆ‘ä»¬å¯ä»¥</p><ul><li>ä½¿ç”¨stringsæ ‡å‡†åº“ ô°€ æä¾›çš„å‡½æ•°æ¥è¿›è¡Œå„ç§å­—ç¬¦ä¸²æ“ä½œã€‚</li><li>è°ƒç”¨å†…ç½®å‡½æ•° len æ¥è·å–ä¸€ä¸ªå­—ç¬¦ä¸²å€¼çš„é•¿åº¦(æ­¤å­—ç¬¦ä¸²ä¸­å­˜å‚¨çš„å­—èŠ‚æ•°)ã€‚</li><li>ä½¿ç”¨å®¹å™¨å…ƒç´ ç´¢å¼•(ç¬¬18ç« )è¯­æ³•aString[i]æ¥è·å–aStringä¸­çš„ç¬¬iä¸ª byteã€‚ è¡¨è¾¾ å¼ aString[i] æ˜¯ä¸å¯å¯»å€çš„ã€‚æ¢å¥è¯è¯´ï¼Œ aString[i] ä¸å¯è¢«ä¿®æ”¹ã€‚ ä½¿ç”¨å­åˆ‡ç‰‡è¯­æ³•(ç¬¬18ç« )aString[start:end]æ¥è·å–aStringçš„ä¸€ä¸ªå­å­—ç¬¦ä¸²ã€‚ è¿™ é‡Œï¼Œ start (åŒ…æ‹¬)å’Œ end (ä¸åŒ…æ‹¬)å‡ä¸º aString ä¸­å­˜å‚¨çš„å­—èŠ‚çš„ä¸‹æ ‡ã€‚</li></ul><p>å¯¹äºæ ‡å‡†ç¼–è¯‘å™¨æ¥è¯´ï¼Œä¸€ä¸ªå­—ç¬¦ä¸²çš„èµ‹å€¼å®Œæˆä¹‹åï¼Œæ­¤èµ‹å€¼ä¸­çš„ç›®æ ‡å€¼å’Œæºå€¼å°†å…±äº«åº•å±‚å­—èŠ‚ã€‚ ä¸€ä¸ªå­åˆ‡ç‰‡è¡¨è¾¾å¼ aString[start:end] çš„ä¼°å€¼ç»“æœä¹Ÿå°†å’ŒåŸºç¡€å­—ç¬¦ä¸² aString å…±äº«ä¸€éƒ¨åˆ†åº•å±‚ å­—èŠ‚ã€‚</p></blockquote><p>æ¯”è¾ƒé‡è¦çš„æ˜¯ï¼šç´¢å¼•çš„å¯¹è±¡æ˜¯ byteï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fmt.Printf(&quot;%T \n&quot;, hello[0]) // uint8</span><br></pre></td></tr></table></figure><p>å¯¹äºå­—ç¬¦ä¸²è€Œè¨€ï¼Œæˆ‘ä»¬ç»å¸¸ç±»å‹è½¬æ¢ï¼Œæ¯”å¦‚æŠŠæŸä¸ª string ä¸¢ç»™ etcd å‘é€è¯·æ±‚ã€‚</p><blockquote><ol><li><p>ä¸€ä¸ªå­—ç¬¦ä¸²å€¼å¯ä»¥è¢«æ˜¾å¼è½¬æ¢ä¸ºä¸€ä¸ªå­—èŠ‚åˆ‡ç‰‡(byte slice)ï¼Œåä¹‹äº¦ç„¶ã€‚ ä¸€ä¸ªå­—èŠ‚åˆ‡ç‰‡ç±»å‹æ˜¯ ä¸€ä¸ªå…ƒç´ ç±»å‹ä¸ºå†…ç½®ç±»å‹byteçš„åˆ‡ç‰‡ç±»å‹ã€‚ æˆ–è€…è¯´ï¼Œä¸€ä¸ªå­—èŠ‚åˆ‡ç‰‡ç±»å‹çš„åº•å±‚ç±»å‹ä¸º[]byte (äº¦å³ []uint8 )ã€‚</p></li><li><p>ä¸€ä¸ªå­—ç¬¦ä¸²å€¼å¯ä»¥è¢«æ˜¾å¼è½¬æ¢ä¸ºä¸€ä¸ªç ç‚¹åˆ‡ç‰‡(rune slice)ï¼Œåä¹‹äº¦ç„¶ã€‚ ä¸€ä¸ªç ç‚¹åˆ‡ç‰‡ç±»å‹æ˜¯ä¸€ä¸ªå…ƒç´ ç±»å‹ä¸ºå†…ç½®ç±»å‹runeçš„åˆ‡ç‰‡ç±»å‹ã€‚ æˆ–è€…è¯´ï¼Œä¸€ä¸ªç ç‚¹åˆ‡ç‰‡ç±»å‹çš„åº•å±‚ç±»å‹ä¸º []rune (äº¦å³ []int32 )ã€‚</p></li></ol><p>åœ¨ä¸€ä¸ªä»ç ç‚¹åˆ‡ç‰‡åˆ°å­—ç¬¦ä¸²çš„è½¬æ¢ä¸­ï¼Œç ç‚¹åˆ‡ç‰‡ä¸­çš„æ¯ä¸ªç ç‚¹å€¼å°†è¢«UTF-8ç¼–ç ä¸ºä¸€åˆ°å››ä¸ªå­—èŠ‚è‡³ç»“æœ å­—ç¬¦ä¸²ä¸­ã€‚ å¦‚æœä¸€ä¸ªç ç‚¹å€¼æ˜¯ä¸€ä¸ªä¸åˆæ³•çš„Unicodeç ç‚¹å€¼ï¼Œåˆ™å®ƒå°†è¢«è§†ä¸ºUnicodeæ›¿æ¢å­—ç¬¦(ç ç‚¹) å€¼0xFFFD(Unicode replacement character)ã€‚ æ›¿æ¢å­—ç¬¦å€¼0xFFFDå°†è¢«UTF-8ç¼–ç ä¸ºä¸‰ä¸ªå­—èŠ‚0xef 0xbf 0xbdã€‚</p><p>å½“ä¸€ä¸ªå­—ç¬¦ä¸²è¢«è½¬æ¢ä¸ºä¸€ä¸ªç ç‚¹åˆ‡ç‰‡æ—¶ï¼Œæ­¤å­—ç¬¦ä¸²ä¸­å­˜å‚¨çš„å­—èŠ‚åºåˆ—å°†è¢«è§£è¯»ä¸ºä¸€ä¸ªä¸€ä¸ªç ç‚¹çš„UTF-8ç¼–ç åºåˆ—ã€‚ éæ³•çš„UTF-8ç¼–ç å­—èŠ‚åºåˆ—å°†è¢«è½¬åŒ–ä¸ºUnicodeæ›¿æ¢å­—ç¬¦å€¼0xFFFDã€‚</p><p>å½“ä¸€ä¸ªå­—ç¬¦ä¸²è¢«è½¬æ¢ä¸ºä¸€ä¸ªå­—èŠ‚åˆ‡ç‰‡æ—¶ï¼Œç»“æœåˆ‡ç‰‡ä¸­çš„åº•å±‚å­—èŠ‚åºåˆ—æ˜¯æ­¤å­—ç¬¦ä¸²ä¸­å­˜å‚¨çš„å­—èŠ‚åºåˆ—çš„ä¸€ ä»½æ·±å¤åˆ¶ã€‚</p></blockquote><p>æ‰€ä»¥è¿™ä¸ªè½¬åŒ–è¿‡ç¨‹è¿˜æ˜¯æœ‰å¤åˆ¶çš„ï¼ŒTiDB ç”¨è¿™ä¸ªç‰¹ç‚¹å†™äº†ä¸ª <code>hack.String</code>, æŒºæœ‰æ„æ€çš„ï¼š<a href="https://github.com/pingcap/tidb/blob/master/util/hack/hack.go">https://github.com/pingcap/tidb/blob/master/util/hack/hack.go</a></p><p>ä½†æ˜¯å®é™…ä¸Šï¼Œä¸Šè¿°æƒ…æ™¯å­˜åœ¨ä¸€äº›ç¼–è¯‘å™¨çš„ä¼˜åŒ–ï¼ˆæˆ‘åäº†ï¼‰ï¼Œè¿™æ˜¯æ ‡å‡†åº“ä¸­çš„ä¼˜åŒ–</p><blockquote><ul><li>ä¸€ä¸ª for-range å¾ªç¯ä¸­è·Ÿéš range å…³é”®å­—çš„ä»å­—ç¬¦ä¸²åˆ°å­—èŠ‚åˆ‡ç‰‡çš„è½¬æ¢; <code>for i, v := range []byte(s) &#123;&#125;</code></li><li>ä¸€ä¸ªåœ¨æ˜ å°„å…ƒç´ ç´¢å¼•è¯­æ³•ä¸­è¢«ç”¨åšé”®å€¼çš„ä»å­—èŠ‚åˆ‡ç‰‡åˆ°å­—ç¬¦ä¸²çš„è½¬æ¢; <code>v[string(bytes)]</code></li><li>ä¸€ä¸ªå­—ç¬¦ä¸²æ¯”è¾ƒè¡¨è¾¾å¼ä¸­è¢«ç”¨åšæ¯”è¾ƒå€¼çš„ä»å­—èŠ‚åˆ‡ç‰‡åˆ°å­—ç¬¦ä¸²çš„è½¬æ¢; <code>if s &lt; string(bytes)</code></li><li>ä¸€ä¸ª(è‡³å°‘æœ‰ä¸€ä¸ªè¢«è¡”æ¥çš„å­—ç¬¦ä¸²å€¼ä¸ºéç©ºå­—ç¬¦ä¸²å¸¸é‡çš„)å­—ç¬¦ä¸²è¡”æ¥è¡¨è¾¾å¼ä¸­çš„ä»å­—èŠ‚åˆ‡ç‰‡åˆ° å­—ç¬¦ä¸²çš„è½¬æ¢ã€‚<code>s  += string(bytes)</code></li></ul></blockquote><p>for-range éå†å­—ç¬¦ä¸²çš„æ—¶å€™ key æ˜¯ byte start index, value æ˜¯ rune. æ‰€ä»¥å…¶å®å¾ˆå¥½ç©ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>  &#123;</span><br><span class="line">s := <span class="string">&quot;ä½ å¦ˆæ­»äº†ï¼Œæˆ‘æ˜¯ä½ å“¥å“¥ï¼Œæˆ‘ä»¬ä¿©éƒ½æ˜¯ä½ å¦ˆçš„å„¿å­&quot;</span></span><br><span class="line"><span class="keyword">for</span> i, rn := <span class="keyword">range</span> s &#123;</span><br><span class="line">fmt.Println(i, rn, <span class="type">string</span>(rn))</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥è¯•ç€è¿è¡Œä¸€ä¸‹è¿™ä¸ªï¼Œè‡³äºéå† bytes, ä½ å¯ä»¥ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i, v := <span class="keyword">range</span> []<span class="type">byte</span>(s) &#123;&#125;</span><br></pre></td></tr></table></figure><h3 id="å‡½æ•°"><a href="#å‡½æ•°" class="headerlink" title="å‡½æ•°"></a>å‡½æ•°</h3><p>å‡½æ•°æˆ‘å…¶å®ä¸æ˜¯å¾ˆæƒ³ä»‹ç»ï¼Œä½†æ˜¯æˆ‘ä»¬éœ€è¦æ³¨æ„ä¸€ä¸‹ builtin çš„è¿™ç§å†…ç½®å‡½æ•°ï¼Œè¿™ç§å¾€å¾€é å¼€æ´ä¹‹ç±»çš„æ–¹æ³•ï¼Œåœ¨ è¿™äº›å‡½æ•°å£°æ˜åœ¨ <code>builtin</code> ô°€ å’Œ <code>unsafe</code> ô°€ æ ‡å‡†åº“ä¸­, å¯ä»¥æ”¯æŒæ³›å‹ç”šè‡³ç±»å‹ä½œä¸ºå‚æ•°ï¼Œå…¶ä¸­ <code>len</code> <code>cap</code> è¿™äº›ä¹Ÿæœ‰å¯èƒ½ç¼–è¯‘æœŸè·å¾—å€¼ã€‚</p><p>å¦å¤–ï¼Œå¾ˆå¤šæ—¶å€™ Go ç¼–è¯‘å™¨ä¼šå¸Œæœ›ä½ å®šä¹‰å®Œæ•´ä¸ªå‡½æ•°ï¼Œä½†æ˜¯å†™ä¸ª <code>panic(â€œunimplementedâ€)</code> å…¶å®ä¹Ÿå¯ä»¥ï¼Œå®é™…ä¸ŠGo æœ‰ä¸ª <a href="https://golang.org/ref/spec#Terminating_statements">https://golang.org/ref/spec#Terminating_statements</a> ï¼Œæ»¡è¶³è¿™ä¸ªæ ‡å‡†çš„å¯ä»¥å½“å‡½æ•°çš„ç»“å°¾ã€‚</p><h4 id="channel"><a href="#channel" class="headerlink" title="channel"></a>channel</h4><p>channel æ˜¯ä¸ª mpmc çš„æ¨¡å‹ï¼Œä¸€äº› goroutineå¯ä»¥å‘ æ­¤é€šé“å‘é€æ•°æ®ï¼Œå¦å¤–ä¸€äº›goroutineå¯ä»¥ä»æ­¤é€šé“æ¥æ”¶æ•°æ®ã€‚</p><blockquote><p>éšç€ä¸€ä¸ªæ•°æ®å€¼çš„ä¼ é€’(å‘é€å’Œæ¥æ”¶)ï¼Œä¸€äº›æ•°æ®å€¼çš„æ‰€æœ‰æƒä»ä¸€ä¸ªåç¨‹è½¬ç§»åˆ°äº†å¦ä¸€ä¸ªåç¨‹ã€‚ å½“ä¸€ ä¸ªåç¨‹å‘é€ä¸€ä¸ªå€¼åˆ°ä¸€ä¸ªé€šé“ï¼Œæˆ‘ä»¬å¯ä»¥è®¤ä¸ºæ­¤åç¨‹é‡Šæ”¾äº†ä¸€äº›å€¼çš„æ‰€æœ‰æƒã€‚ å½“ä¸€ä¸ªåç¨‹ä»ä¸€ä¸ªé€šé“ æ¥æ”¶åˆ°ä¸€ä¸ªå€¼ï¼Œæˆ‘ä»¬å¯ä»¥è®¤ä¸ºæ­¤åç¨‹è·å–äº†ä¸€äº›å€¼çš„æ‰€æœ‰æƒã€‚</p></blockquote><p>(çªç„¶æƒ³åˆ° Send å’Œ Sync è¿™ä¿© trait)</p><h4 id="channel-çš„ç±»å‹"><a href="#channel-çš„ç±»å‹" class="headerlink" title="channel çš„ç±»å‹"></a>channel çš„ç±»å‹</h4><blockquote><p>å­—é¢å½¢å¼chan Tè¡¨ç¤ºä¸€ä¸ªå…ƒç´ ç±»å‹ä¸ºTçš„åŒå‘é€šé“ç±»å‹ã€‚ ç¼–è¯‘å™¨å…è®¸ä»æ­¤ç±»å‹çš„å€¼ä¸­æ¥æ”¶å’Œå‘æ­¤ ç±»å‹çš„å€¼ä¸­å‘é€æ•°æ®ã€‚<br> å­—é¢å½¢å¼chan&lt;- Tè¡¨ç¤ºä¸€ä¸ªå…ƒç´ ç±»å‹ä¸ºTçš„å•å‘å‘é€é€šé“ç±»å‹ã€‚ ç¼–è¯‘å™¨ä¸å…è®¸ä»æ­¤ç±»å‹çš„å€¼ä¸­ æ¥æ”¶æ•°æ®ã€‚</p><p>å­—é¢å½¢å¼&lt;-chan Tè¡¨ç¤ºä¸€ä¸ªå…ƒç´ ç±»å‹ä¸ºTçš„å•å‘æ¥æ”¶é€šé“ç±»å‹ã€‚ ç¼–è¯‘å™¨ä¸å…è®¸å‘æ­¤ç±»å‹çš„å€¼ä¸­ å‘é€æ•°æ®ã€‚</p></blockquote><p>åŒå‘é€šé“chan Tçš„å€¼å¯ä»¥è¢«éšå¼è½¬æ¢ä¸ºå•å‘é€šé“ç±»å‹chan&lt;- Tå’Œ&lt;-chan Tï¼Œä½†åä¹‹ä¸è¡Œ(å³ä½¿æ˜¾å¼ ä¹Ÿä¸è¡Œ)ã€‚ ç±»å‹chan&lt;- Tå’Œ&lt;-chan Tçš„å€¼ä¹Ÿä¸èƒ½ç›¸äº’è½¬æ¢ã€‚</p><blockquote><p>ä¸€ä¸ªå®¹é‡ä¸º0çš„é€šé“å€¼ç§°ä¸ºä¸€ä¸ªé ç¼“å†²é€šé“(unbuffered channel)ï¼Œä¸€ä¸ªå®¹é‡ä¸ä¸º0çš„é€šé“å€¼ç§°ä¸ºä¸€ä¸ªç¼“å†²é€šé“(buffered channel)ã€‚</p><p>é€šé“ç±»å‹çš„é›¶å€¼ä¹Ÿä½¿ç”¨é¢„å£°æ˜çš„nilæ¥è¡¨ç¤ºã€‚ ä¸€ä¸ªéé›¶é€šé“å€¼å¿…é¡»é€šè¿‡å†…ç½®çš„makeå‡½æ•°æ¥åˆ›å»ºã€‚ </p></blockquote><p>æ‰€ä»¥ channel æ¯”è¾ƒæ˜¯é â€œå†…éƒ¨æˆå‘˜æ˜¯ä¸æ˜¯åŒä¸€ä¸ªâ€æ¥åˆ¤æ–­çš„ã€‚</p><h5 id="channel-æ“ä½œå’Œè¯­ä¹‰"><a href="#channel-æ“ä½œå’Œè¯­ä¹‰" class="headerlink" title="channel æ“ä½œå’Œè¯­ä¹‰"></a>channel æ“ä½œå’Œè¯­ä¹‰</h5><ol><li><code>close(ch)</code> å…³é—­é <code>&lt;-chan</code></li><li><code>ch &lt;- v</code> ç»™ ch å‘é€ v</li><li><code>&lt;-ch</code> æ¥æ”¶ä¸€ä¸ªå€¼</li><li><code>cap(ch)</code> æŸ¥è¯¢å®¹é‡</li><li><code>len(ch)</code> æŸ¥è¯¢å†…éƒ¨å·²æœ‰å…ƒç´ çš„é•¿åº¦</li></ol><blockquote><p>Goä¸­å¤§å¤šæ•°çš„åŸºæœ¬æ“ä½œéƒ½æ˜¯æœªåŒæ­¥çš„ã€‚æ¢å¥è¯è¯´ï¼Œå®ƒä»¬éƒ½ä¸æ˜¯å¹¶å‘å®‰å…¨çš„ã€‚ è¿™äº›æ“ä½œåŒ…æ‹¬èµ‹å€¼ã€ä¼  å‚ã€å’Œå„ç§å®¹å™¨å€¼æ“ä½œç­‰ã€‚ ä½†æ˜¯ï¼Œé™¤äº†å¹¶å‘åœ°å…³é—­ä¸€ä¸ªé€šé“å’Œå‘æ­¤é€šé“å‘é€æ•°æ®è¿™ç§æƒ…å½¢ï¼Œä¸Šé¢è¿™äº› æ‰€æœ‰åˆ—å‡ºçš„æ“ä½œéƒ½å·²ç»åŒæ­¥è¿‡äº†ï¼Œå› æ­¤å®ƒä»¬å¯ä»¥åœ¨å¹¶å‘åç¨‹ä¸­å®‰å…¨è¿è¡Œè€Œæ— éœ€å…¶å®ƒåŒæ­¥æ“ä½œã€‚ æˆ‘ä»¬åœ¨ ç¼–ç¨‹ä¸­åº”è¯¥é¿å…å¹¶å‘åœ°å…³é—­ä¸€ä¸ªé€šé“å’Œå‘æ­¤é€šé“å‘é€æ•°æ®è¿™ç§æƒ…å½¢ï¼Œ å› ä¸ºè¿™ç§æƒ…å½¢å±äºä¸è‰¯è®¾è®¡(åŸ å› å°†åœ¨ä¸‹é¢è§£é‡Š)ã€‚</p></blockquote><p>æ‰€ä»¥ close å’Œ send é€»è¾‘åº”è¯¥åˆç†çš„æ‹†åˆ†ã€‚</p><blockquote><p>æ³¨æ„:é€šé“çš„èµ‹å€¼å’Œå…¶å®ƒç±»å‹å€¼çš„èµ‹å€¼ä¸€æ ·ï¼Œæ˜¯æœªåŒæ­¥çš„ã€‚ åŒæ ·ï¼Œå°†åˆšä»ä¸€ä¸ªé€šé“æ¥æ”¶å‡ºæ¥çš„å€¼èµ‹ç»™ å¦ä¸€ä¸ªå€¼ä¹Ÿæ˜¯æœªåŒæ­¥çš„ã€‚</p><p>å¦‚æœè¢«æŸ¥è¯¢çš„é€šé“ä¸ºä¸€ä¸ªnilé›¶å€¼é€šé“ï¼Œåˆ™capå’Œlenå‡½æ•°è°ƒç”¨éƒ½è¿”å›0ã€‚ è¿™ä¸¤ä¸ªæ“ä½œæ˜¯å¦‚æ­¤ç®€å•ï¼Œæ‰€ ä»¥åé¢å°†ä¸å†å¯¹å®ƒä»¬è¿›è¡Œè¯¦è§£ã€‚ äº‹å®ä¸Šï¼Œè¿™ä¸¤ä¸ªæ“ä½œåœ¨å®è·µä¸­å¾ˆå°‘ä½¿ç”¨ã€‚</p></blockquote><div class="table-container"><table><thead><tr><th style="text-align:center">æ“ä½œ</th><th style="text-align:center">nil channel</th><th style="text-align:center">closed channel</th><th style="text-align:center">channel</th></tr></thead><tbody><tr><td style="text-align:center">close</td><td style="text-align:center">panic</td><td style="text-align:center">panic</td><td style="text-align:center">close it</td></tr><tr><td style="text-align:center">ch &lt;-</td><td style="text-align:center">blocking forever</td><td style="text-align:center">panic</td><td style="text-align:center">blocking or send success</td></tr><tr><td style="text-align:center">&lt;-ch</td><td style="text-align:center">blocking forever</td><td style="text-align:center">never panic</td><td style="text-align:center">blocking or recv success</td></tr></tbody></table></div><p>å…¶å®æ ¹æ®æˆ‘ç†è§£ï¼Œæˆ‘æ€»ç»“äº†ä¸€ä¸‹ï¼š</p><ul><li>Golang çš„ close æ˜¯â€œä¸å¯é‡å¤è°ƒç”¨â€ çš„ï¼Œclose nil, è¢« close çš„ channel éƒ½ä¼šäº§ç”Ÿ panic</li><li>sender åº”è¯¥çŸ¥é“ channel çš„æƒ…å†µï¼Œç»™ nil å‘é€ä¼š blocking forever, ç»™ closed å‘é€ä¼š panic</li><li>receiver æŸç§æƒ…å†µä¸‹ä¸çŸ¥é“ï¼Œæ‰€ä»¥å®ƒä» nil æ¥æ”¶ä¼š block forever, ä» closed æ¥æ”¶æ¶ˆæ¯å¿…å®šä¸ä¼š blocking</li></ul><p>channel æ­¤å¤–è¿˜éœ€è¦ç»´æŠ¤ FIFO çš„è¯­ä¹‰ï¼Œè¿™å…¶å®æš—ç¤ºå¾ˆéº»çƒ¦çš„å®ç°ï¼Œå®é™…ä¸Šå¾ˆå¤šå†…å­˜ channel éƒ½ä¸æƒ³åšè¿™ä¸€ç‚¹ã€‚</p><p>å¯ä»¥è®¤ä¸ºä¸€ä¸ª channel ç»´æŠ¤äº†3ä¸ª queue:</p><blockquote><ol><li>æ¥æ”¶æ•°æ®åç¨‹é˜Ÿåˆ—ã€‚æ­¤é˜Ÿåˆ—æ˜¯ä¸€ä¸ªæ²¡æœ‰é•¿åº¦é™åˆ¶çš„é“¾è¡¨ã€‚ æ­¤é˜Ÿåˆ—ä¸­çš„åç¨‹å‡å¤„äºé˜»å¡çŠ¶æ€ï¼Œå®ƒä»¬ æ­£ç­‰å¾…ç€ä»æ­¤é€šé“æ¥æ”¶æ•°æ®ã€‚</li><li>å‘é€æ•°æ®åç¨‹é˜Ÿåˆ—ã€‚æ­¤é˜Ÿåˆ—ä¹Ÿæ˜¯ä¸€ä¸ªæ²¡æœ‰é•¿åº¦é™åˆ¶çš„é“¾è¡¨ã€‚ æ­¤é˜Ÿåˆ—ä¸­çš„åç¨‹äº¦å‡å¤„äºé˜»å¡çŠ¶æ€ï¼Œ å®ƒä»¬æ­£ç­‰å¾…ç€å‘æ­¤é€šé“å‘é€æ•°æ®ã€‚ æ­¤é˜Ÿåˆ—ä¸­çš„æ¯ä¸ªåç¨‹å°†è¦å‘é€çš„å€¼(æˆ–è€…æ­¤å€¼çš„æŒ‡é’ˆï¼Œå–å†³äº å…·ä½“ç¼–è¯‘å™¨å®ç°)å’Œæ­¤åç¨‹ä¸€èµ·å­˜å‚¨åœ¨æ­¤é˜Ÿåˆ—ä¸­ã€‚</li><li>æ•°æ®ç¼“å†²é˜Ÿåˆ—ã€‚è¿™æ˜¯ä¸€ä¸ªå¾ªç¯é˜Ÿåˆ—ï¼Œå®ƒçš„é•¿åº¦ä¸ºæ­¤é€šé“çš„å®¹é‡ã€‚æ­¤é˜Ÿåˆ—ä¸­å­˜æ”¾çš„å€¼çš„ç±»å‹éƒ½ä¸ºæ­¤ é€šé“çš„å…ƒç´ ç±»å‹ã€‚ å¦‚æœæ­¤é˜Ÿåˆ—ä¸­å½“å‰å­˜æ”¾çš„å€¼çš„ä¸ªæ•°å·²ç»è¾¾åˆ°æ­¤é€šé“çš„å®¹é‡ï¼Œåˆ™æˆ‘ä»¬è¯´æ­¤é€šé“å·² ç»å¤„äºæ»¡æ§½çŠ¶æ€ã€‚ å¦‚æœæ­¤é˜Ÿåˆ—ä¸­å½“å‰å­˜æ”¾çš„å€¼çš„ä¸ªæ•°ä¸ºé›¶ï¼Œåˆ™æˆ‘ä»¬è¯´æ­¤é€šé“å¤„äºç©ºæ§½çŠ¶æ€ã€‚ å¯¹ äºä¸€ä¸ªéç¼“å†²é€šé“(å®¹é‡ä¸ºé›¶)ï¼Œå®ƒæ€»æ˜¯åŒæ—¶å¤„äºæ»¡æ§½çŠ¶æ€å’Œç©ºæ§½çŠ¶æ€ã€‚</li></ol></blockquote><p>æ³¨æ„å…¶ä¸­çš„ blocking è¡Œä¸ºï¼Œåœ¨ select çš„æ—¶å€™ä½ ä¼šéœ€è¦å®ƒä»¬çš„ã€‚æ­¤å¤–ï¼š</p><blockquote><p>ä¸€ä¸ªéé›¶é€šé“è¢«å…³é—­ä¹‹åï¼Œæ­¤é€šé“ä¸Šçš„åç»­æ•°æ®æ¥æ”¶æ“ä½œå°†æ°¸ä¸ä¼šé˜»å¡ã€‚ æ­¤é€šé“çš„ ç¼“å†²é˜Ÿåˆ—ä¸­å­˜å‚¨æ•°æ®ä»ç„¶å¯ä»¥è¢«æ¥æ”¶å‡ºæ¥ã€‚ ä¼´éšç€è¿™äº›æ¥æ”¶å‡ºæ¥çš„ç¼“å†²æ•°æ®çš„ç¬¬äºŒä¸ªå¯é€‰è¿”å›(ç±»å‹ ä¸ç¡®å®šå¸ƒå°”)å€¼ä»ç„¶æ˜¯trueã€‚ ä¸€æ—¦æ­¤ç¼“å†²é˜Ÿåˆ—å˜ä¸ºç©ºï¼Œåç»­çš„æ•°æ®æ¥æ”¶æ“ä½œå°†æ°¸ä¸é˜»å¡å¹¶ä¸”æ€»ä¼šè¿”å› æ­¤é€šé“çš„å…ƒç´ ç±»å‹çš„é›¶å€¼å’Œå€¼ä¸ºfalseçš„ç¬¬äºŒä¸ªå¯é€‰è¿”å›ç»“æœã€‚ </p><p>é€šé“æ“ä½œæƒ…å½¢C: å½“ä¸€ä¸ªåç¨‹æˆåŠŸè·å–åˆ°ä¸€ä¸ªéé›¶ä¸”å°šæœªå…³é—­çš„é€šé“çš„é”å¹¶ä¸”å‡†å¤‡å…³é—­æ­¤é€šé“æ—¶ï¼Œä¸‹é¢ ä¸¤æ­¥å°†ä¾æ¬¡æ‰§è¡Œ:</p><ol><li>å¦‚æœæ­¤é€šé“çš„æ¥æ”¶æ•°æ®åç¨‹é˜Ÿåˆ—ä¸ä¸ºç©º(è¿™ç§æƒ…å†µä¸‹ï¼Œç¼“å†²é˜Ÿåˆ—å¿…ä¸ºç©º)ï¼Œæ­¤é˜Ÿåˆ—ä¸­çš„æ‰€æœ‰åç¨‹ å°†è¢«ä¾ä¸ªå¼¹å‡ºï¼Œå¹¶ä¸”æ¯ä¸ªåç¨‹å°†æ¥æ”¶åˆ°æ­¤é€šé“çš„å…ƒç´ ç±»å‹çš„ä¸€ä¸ªé›¶å€¼ï¼Œç„¶åæ¢å¤è‡³è¿è¡ŒçŠ¶æ€ã€‚</li><li>å¦‚æœæ­¤é€šé“çš„å‘é€æ•°æ®åç¨‹é˜Ÿåˆ—ä¸ä¸ºç©ºï¼Œæ­¤é˜Ÿåˆ—ä¸­çš„æ‰€æœ‰åç¨‹å°†è¢«ä¾ä¸ªå¼¹å‡ºï¼Œå¹¶ä¸”æ¯ä¸ªåç¨‹ä¸­éƒ½å°†äº§ç”Ÿä¸€ä¸ªpanic(å› ä¸ºå‘å·²å…³é—­çš„é€šé“å‘é€æ•°æ®)ã€‚ è¿™å°±æ˜¯æˆ‘ä»¬åœ¨ä¸Šé¢è¯´å¹¶å‘åœ°å…³é—­ä¸€ä¸ªé€šé“å’Œ å‘æ­¤é€šé“å‘é€æ•°æ®è¿™ç§æƒ…å½¢å±äºä¸è‰¯è®¾è®¡çš„åŸå› ã€‚ äº‹å®ä¸Šï¼Œå¹¶å‘åœ°å…³é—­ä¸€ä¸ªé€šé“å’Œå‘æ­¤é€šé“å‘é€ æ•°æ®å°†äº§ç”Ÿæ•°æ®ç«äº‰ã€‚</li></ol></blockquote><p>å…¶ä»–å‡ ä¸ª case ä¹Ÿå¯ä»¥çœ‹çœ‹ã€‚</p><p>æ­¤å¤–éœ€è¦æ³¨æ„ï¼š</p><ul><li><code>&lt;-</code> æ¥æ”¶åˆ°çš„å…ƒç´ å…¨æ˜¯å€¼å¤åˆ¶ï¼ˆæˆ‘ä¸ªäººæ„Ÿè§‰ä¼ æŒ‡é’ˆæ€ªæ€ªçš„ï¼Ÿä¸çŸ¥æœ‰æ²¡æœ‰ä»€ä¹ˆ ä¾‹å­ï¼‰</li><li>goroutine å’Œ channel ä¸­ï¼Œ channel åªæœ‰æ²¡æœ‰ goroutine å¼•ç”¨æ‰ä¼šè¢« gc, goroutine åŒç†ã€‚æ‰€ä»¥è¦å°å¿ƒ leak.</li><li>goroutine å…è®¸ä½ ä» nil å’Œ closed ä¸­ recv, è¿”å›ä¸€ä¸ª ok çš„ boolã€‚è¿™ä¹Ÿå…è®¸ä½  for-range ä½¿ç”¨</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line">  <span class="keyword">for</span> v, ok &lt;- ch </span><br><span class="line">  <span class="keyword">if</span> !ok &#123;</span><br><span class="line">    <span class="keyword">break</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> v := <span class="keyword">range</span> ch &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="select-channel"><a href="#select-channel" class="headerlink" title="select channel"></a>select channel</h5><blockquote><p>æ‰€æœ‰çš„éé˜»å¡ case æ“ä½œä¸­å°†æœ‰ä¸€ä¸ªè¢«éšæœºé€‰æ‹©æ‰§è¡Œ(è€Œä¸æ˜¯æŒ‰ç…§ä»ä¸Šåˆ°ä¸‹çš„é¡ºåº)ï¼Œç„¶åæ‰§è¡Œæ­¤ æ“ä½œå¯¹åº”çš„ case åˆ†æ”¯ä»£ç å—ã€‚</p><p>åœ¨æ‰€æœ‰çš„ case æ“ä½œå‡ä¸ºé˜»å¡çš„æƒ…å†µä¸‹ï¼Œå¦‚æœ default åˆ†æ”¯å­˜åœ¨ï¼Œåˆ™ default åˆ†æ”¯ä»£ç å—å°†å¾—åˆ°æ‰§ è¡Œ; å¦åˆ™ï¼Œå½“å‰åç¨‹å°†è¢«æ¨å…¥æ‰€æœ‰é˜»å¡æ“ä½œä¸­ç›¸å…³çš„é€šé“çš„å‘é€æ•°æ®åç¨‹é˜Ÿåˆ—æˆ–è€…æ¥æ”¶æ•°æ®åç¨‹ é˜Ÿåˆ—ä¸­ï¼Œå¹¶è¿›å…¥é˜»å¡çŠ¶æ€ã€‚</p></blockquote><p>ä¸€ç§å¾ˆå¸¸ç”¨çš„æ¨¡å¼æ˜¯ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">select &#123;</span><br><span class="line">case &lt;-ch:</span><br><span class="line">// do something</span><br><span class="line">default:</span><br><span class="line">// è·³è¿‡</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>select ä¼šè¯„ä¼°æ‰€æœ‰çš„ arm, ç»™ channel lock å¹¶ä¸”å°è¯•æ˜¯å¦æ˜¯ non-blocking çš„</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>  &#123;</span><br><span class="line">ch := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">int</span>)</span><br><span class="line"><span class="keyword">select</span> &#123;</span><br><span class="line"><span class="keyword">case</span> ch&lt;- <span class="number">114514</span>:</span><br><span class="line">fmt.Println(<span class="string">&quot;Send done&quot;</span>)</span><br><span class="line"><span class="keyword">case</span> v := &lt;- ch:</span><br><span class="line">fmt.Printf(<span class="string">&quot;Receive %d\n&quot;</span>, v)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fmt.Println(<span class="string">&quot;done&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»¥ä¸Šæ“ä½œä¼šå¾—åˆ°ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">fatal error: all goroutines are asleep - deadlock!</span><br><span class="line"></span><br><span class="line">goroutine 1 [select]:</span><br><span class="line">main.main()</span><br><span class="line">        .../cmd/chan_example.go:7 +0xe3</span><br></pre></td></tr></table></figure><h3 id="method"><a href="#method" class="headerlink" title="method"></a>method</h3><p>æœ‰ method éœ€è¦æœ‰å‡ ä¸ªé™åˆ¶ï¼š</p><blockquote><ol><li>T å¿…é¡»æ˜¯ä¸€ä¸ªå®šä¹‰ç±»å‹(ç¬¬14ç« );</li><li>T å¿…é¡»å’Œæ­¤æ–¹æ³•å£°æ˜å®šä¹‰åœ¨åŒä¸€ä¸ªä»£ç åŒ…ä¸­;</li><li>T ä¸èƒ½æ˜¯ä¸€ä¸ªæŒ‡é’ˆç±»å‹;</li><li>T ä¸èƒ½æ˜¯ä¸€ä¸ªæ¥å£ç±»å‹ã€‚</li></ol></blockquote><p>method ä¼š implict ç”Ÿæˆå‡½æ•°ï¼Œè®© go ç¼–è¯‘å™¨å» manglingã€‚</p><blockquote><p>å¯¹æ¯ä¸€ä¸ªä¸ºå€¼ç±»å‹å±ä¸» T å£°æ˜çš„æ–¹æ³•ï¼Œç¼–è¯‘å™¨å°†è‡ªåŠ¨éšå¼åœ°ä¸ºå…¶å¯¹åº”çš„æŒ‡é’ˆç±»å‹å±ä¸» <em>T å£°æ˜ä¸€ä¸ªç›¸åº”çš„ åŒåæ–¹æ³•ã€‚ ä»¥ä¸Šé¢çš„ä¸ºç±»å‹Bookå£°æ˜çš„Pagesæ–¹æ³•ä¸ºä¾‹ï¼Œç¼–è¯‘å™¨å°†è‡ªåŠ¨ä¸ºç±»å‹</em>Bookå£°æ˜ä¸€ä¸ªåŒåæ–¹ æ³•:</p></blockquote><p>ä¹Ÿå°±æ˜¯è¯´ <code>(T) call()</code> è¢«å£°æ˜åï¼Œ<code>(*T) call</code> ä¼šè¢« implicit çš„å®šä¹‰ï¼Œä¼  <code>(*v)</code> ä½œä¸ºå‚æ•°ï¼Œè€Œç”Ÿæˆçš„å‡½æ•° function callï¼Œä¼šæ˜¯ä¸€ä¸ªå€¼å¤åˆ¶ã€‚ç±»å‹Tçš„æ–¹æ³•é›†æ€»æ˜¯ç±»å‹<em>Tçš„æ–¹æ³•é›†çš„å­é›†ã€‚ä¸Šè¿°ç¬¬ä¸€ä¸ªæ‹¬å·é‡Œçš„è¢«ç§°ä¸º </em>receiver type*ã€‚</p><p>è¿™ç‚¹å¯ä»¥åœ¨ Go-FAQ æ‰¾åˆ°ï¼š<a href="https://golang.org/doc/faq#different_method_sets">https://golang.org/doc/faq#different_method_sets</a></p><p>æ‰€ä»¥æˆ‘ä»¬éœ€è¦è€ƒè™‘æ˜¯<code>(*T)</code> è¿˜æ˜¯ <code>(T)</code> å®ç°ï¼š</p><blockquote><p>å¯¹äºå€¼ç±»å‹å±ä¸»è¿˜æ˜¯æŒ‡é’ˆç±»å‹å±ä¸»éƒ½å¯ä»¥æ¥å—çš„æ–¹æ³•å£°æ˜ï¼Œä¸‹é¢åˆ—å‡ºäº†ä¸€äº›è€ƒè™‘å› ç´ :</p><ul><li>å¤ªå¤šçš„æŒ‡é’ˆå¯èƒ½ä¼šå¢åŠ åƒåœ¾å›æ”¶å™¨çš„è´Ÿæ‹…ã€‚ å¦‚æœä¸€ä¸ªå€¼ç±»å‹çš„å°ºå¯¸å¤ªå¤§ï¼Œé‚£ä¹ˆå±ä¸»å‚æ•°åœ¨ä¼ å‚çš„æ—¶å€™çš„å¤åˆ¶æˆæœ¬å°†ä¸å¯å¿½ç•¥ã€‚ æŒ‡é’ˆç±»å‹éƒ½æ˜¯ å°å°ºå¯¸ç±»å‹ã€‚ å…³äºå„ç§ä¸åŒç±»å‹çš„å°ºå¯¸ï¼Œè¯·é˜…è¯»å€¼å¤åˆ¶ä»£ä»·(ç¬¬34ç« )ä¸€æ–‡ã€‚</li><li>åœ¨å¹¶å‘åœºåˆä¸‹ï¼ŒåŒæ—¶è°ƒç”¨ä¸ºå€¼ç±»å‹å±ä¸»å’ŒæŒ‡é’ˆç±»å‹å±ä¸»æ–¹æ³•æ¯”è¾ƒæ˜“äºäº§ç”Ÿæ•°æ®ç«äº‰ã€‚</li><li>sync æ ‡å‡†åº“åŒ…ä¸­çš„ç±»å‹çš„å€¼ä¸åº”è¯¥è¢«å¤åˆ¶ï¼Œæ‰€ä»¥å¦‚æœä¸€ä¸ªç»“æ„ä½“ç±»å‹å†…åµŒ(ç¬¬24ç« )äº†è¿™äº›ç±» å‹ï¼Œåˆ™ä¸åº”è¯¥ä¸ºè¿™ä¸ªç»“æ„ä½“ç±»å‹å£°æ˜å€¼ç±»å‹å±ä¸»çš„æ–¹æ³•ã€‚</li></ul><p>å¦‚æœå®åœ¨æ‹¿ä¸å®šä¸»æ„åœ¨ä¸€ä¸ªæ–¹æ³•å£°æ˜ä¸­åº”è¯¥ä½¿ç”¨å€¼ç±»å‹å±ä¸»è¿˜æ˜¯æŒ‡é’ˆç±»å‹å±ä¸»ï¼Œé‚£ä¹ˆè¯·ä½¿ç”¨æŒ‡é’ˆç±»å‹å± ä¸»ã€‚</p></blockquote><h3 id="interface"><a href="#interface" class="headerlink" title="interface"></a>interface</h3><p>interface æ˜¯ä¸€ä¸ªå¾ˆå¸¸ç”¨ï¼Œä½†æ˜¯ç”¨èµ·æ¥å¤§å®¶å…¶å®å¾ˆæ¨¡ç³Šçš„ä¸œè¥¿ã€‚æˆ‘ä»¬éœ€è¦å®é™…ä¸Šè„‘è¢‹æƒ³æ¸…æ¥šï¼š</p><ul><li><code>i = v</code> ä¼šä¸ä¼šäº§ç”Ÿå¤åˆ¶ï¼Œè¿˜æ˜¯å¼•ç”¨çš„ copy</li><li><code>i1 = i2</code> ä¼šæœ‰å¦‚ä½•å½±å“</li><li>interface å†…éƒ¨å¦‚ä½•ç»´æŠ¤å…·ä½“ç±»å‹ï¼Œå®Œæ•´ä¿¡æ¯ã€‚</li></ul><blockquote><p>åœ¨Goä¸­ï¼Œå¦‚æœç±»å‹Tå®ç°äº†ä¸€ä¸ªæ¥å£ç±»å‹Iï¼Œåˆ™ç±»å‹Tçš„å€¼éƒ½å¯ä»¥éšå¼è½¬æ¢åˆ°ç±»å‹Iã€‚ æ¢å¥è¯è¯´ï¼Œç±»å‹ Tçš„å€¼å¯ä»¥èµ‹ç»™ç±»å‹Içš„å¯ä¿®æ”¹å€¼ã€‚ å½“ä¸€ä¸ªTå€¼è¢«è½¬æ¢åˆ°ç±»å‹I(æˆ–è€…èµ‹ç»™ä¸€ä¸ªIå€¼)çš„æ—¶å€™ï¼Œ</p><ul><li>å¦‚æœç±»å‹Tæ˜¯ä¸€ä¸ªéæ¥å£ç±»å‹ï¼Œåˆ™æ­¤Tå€¼çš„<strong>ä¸€ä¸ªå¤åˆ¶</strong>å°†è¢«åŒ…è£¹åœ¨ç»“æœ(æˆ–è€…ç›®æ ‡)Iå€¼ä¸­ã€‚ æ­¤æ“ä½œ çš„æ—¶é—´å¤æ‚åº¦ä¸º <em>O</em>(n) ï¼Œå…¶ä¸­ n ä¸º T å€¼çš„å°ºå¯¸ã€‚</li><li>å¦‚æœç±»å‹ T ä¹Ÿä¸ºä¸€ä¸ªæ¥å£ç±»å‹ï¼Œåˆ™æ­¤ T å€¼ä¸­å½“å‰åŒ…è£¹çš„(éæ¥å£)å€¼å°†è¢«å¤åˆ¶ä¸€ä»½åˆ°ç»“æœ(æˆ–è€…ç›® æ ‡)Iå€¼ä¸­ã€‚ å®˜æ–¹æ ‡å‡†ç¼–è¯‘å™¨ä¸ºæ­¤æ“ä½œåšäº†ä¼˜åŒ–ï¼Œä½¿å¾—æ­¤æ“ä½œçš„æ—¶é—´å¤æ‚åº¦ä¸º<em>O</em>(1)ï¼Œè€Œä¸ æ˜¯<em>O</em>(n)ã€‚</li></ul></blockquote><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œæœ¬èº«ä¼šå‘ç”Ÿä¸€ä¸ª copy è¿‡ç¨‹ã€‚</p><p>å¯ä»¥çœ‹ä¸€æ®µæ¯”è¾ƒæœ‰è¶£çš„ä»£ç ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Book <span class="keyword">struct</span> &#123;</span><br><span class="line">name <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b Book)</span></span> About() <span class="type">string</span> &#123;</span><br><span class="line"><span class="keyword">return</span> fmt.Sprintf(<span class="string">&quot;Book(name:%s)&quot;</span>, b.name)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Aboutable <span class="keyword">interface</span> &#123;</span><br><span class="line">About() <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>  &#123;</span><br><span class="line"><span class="keyword">var</span> aboutable Aboutable</span><br><span class="line"><span class="keyword">if</span> aboutable == <span class="literal">nil</span> &#123;</span><br><span class="line">fmt.Println(<span class="string">&quot;aboutable is nil&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line">fmt.Println(aboutable) <span class="comment">// &lt;nil&gt;</span></span><br><span class="line"><span class="keyword">var</span> bookPtr *Book</span><br><span class="line">aboutable = bookPtr</span><br><span class="line"><span class="keyword">if</span> aboutable == <span class="literal">nil</span> &#123;</span><br><span class="line">fmt.Println(<span class="string">&quot;aboutable is nil&quot;</span>)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">fmt.Println(<span class="string">&quot;aboutable is not nil&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fmt.Println(aboutable) <span class="comment">// &lt;nil&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// panic: value method main.Book.About called using nil *Book pointer</span></span><br><span class="line"><span class="comment">//aboutable.About()</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">b := Book&#123;name: <span class="string">&quot;å¡æ‹‰é©¬ä½å¤«å…„å¼Ÿ&quot;</span>&#125;</span><br><span class="line">aboutable = b</span><br><span class="line"></span><br><span class="line">fmt.Println(aboutable.About()) <span class="comment">// Book(name:å¡æ‹‰é©¬ä½å¤«å…„å¼Ÿ)</span></span><br><span class="line"><span class="comment">//aboutableBook := aboutable.(Book)</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>å¯¹äºä¸€ä¸ªéæ¥å£ç±»å‹å’Œæ¥å£ç±»å‹å¯¹ï¼Œå®ƒä»¬çš„å®ç°å…³ç³»ä¿¡æ¯åŒ…æ‹¬ä¸¤éƒ¨åˆ†çš„å†…å®¹:</p><ol><li>åŠ¨æ€ç±»å‹(å³æ­¤éæ¥å£ç±»å‹)çš„ä¿¡æ¯ã€‚</li><li>ä¸€ä¸ªæ–¹æ³•è¡¨(åˆ‡ç‰‡ç±»å‹)ï¼Œå…¶ä¸­å­˜å‚¨äº†æ‰€æœ‰æ­¤æ¥å£ç±»å‹æŒ‡å®šçš„å¹¶ä¸”ä¸ºæ­¤éæ¥å£ç±»å‹(åŠ¨æ€ç±»å‹)å£°æ˜çš„æ–¹æ³•ã€‚</li></ol></blockquote><p>å¯ä»¥å®ç° Golang çš„å¤šæ€ï¼š</p><blockquote><p>æ¯”å¦‚ï¼Œå½“æ–¹æ³•i.mè¢«è°ƒç”¨æ—¶ï¼Œå…¶å®è¢«è°ƒç”¨çš„æ˜¯æ–¹æ³•t.mã€‚ ä¸€ä¸ªæ¥å£å€¼å¯ä»¥é€šè¿‡åŒ…è£¹ä¸åŒåŠ¨æ€ç±»å‹çš„åŠ¨æ€å€¼æ¥è¡¨ç°å‡ºå„ç§ä¸åŒçš„è¡Œä¸ºï¼Œè¿™ç§°ä¸ºå¤šæ€ã€‚</p></blockquote><p>ä½†æˆ‘è§‰å¾—è¿˜æ˜¯å¾ˆé¸¡è‚‹çš„ï¼Œå¯¹ä¸åŒç±»å‹éœ€è¦ä¸€å † builtin æˆ–è€…å†™å¾ˆå¤šé, æ„Ÿè§‰å¾ˆè›‹ç–¼ã€‚</p><h3 id="åå°„ä¸ç±»å‹"><a href="#åå°„ä¸ç±»å‹" class="headerlink" title="åå°„ä¸ç±»å‹"></a>åå°„ä¸ç±»å‹</h3><p>æˆ‘ä»¬å¯ä»¥æ³¨æ„åˆ°ä¹‹å‰çš„ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">b := Book&#123;name: <span class="string">&quot;å¡æ‹‰é©¬ä½å¤«å…„å¼Ÿ&quot;</span>&#125;</span><br><span class="line">aboutable = b</span><br><span class="line"></span><br><span class="line">fmt.Println(aboutable.About()) <span class="comment">// Book(name:å¡æ‹‰é©¬ä½å¤«å…„å¼Ÿ)</span></span><br><span class="line">aboutableBook := aboutable.(Book)</span><br></pre></td></tr></table></figure><p>ç±»æ¯”èµ·æ¥ï¼Œæˆ‘ä»¬å·²ç»æ‹¥æœ‰äº†å¯¹ä¸€å®šçš„åº•å±‚ç±»å‹çš„è½¬æ¢ï¼Œå¯ä»¥ç†è§£æˆ<code>static_cast</code>,å¯èƒ½éœ€è¦ç±»ä¼¼ C++ çš„ <code>dynamic_cast&lt;&gt;</code> çš„è½¬æ¢ï¼Œä¹Ÿå°±æ˜¯ï¼š</p><blockquote><ol><li><p>å°†ä¸€ä¸ªæ¥å£å€¼è½¬æ¢ä¸ºä¸€ä¸ªéæ¥å£ç±»å‹(æ­¤éæ¥å£ç±»å‹å¿…é¡»å®ç°äº†æ­¤æ¥å£å€¼çš„æ¥å£ç±»å‹)ã€‚</p></li><li><p>å°†ä¸€ä¸ªæ¥å£å€¼è½¬æ¢ä¸ºå¦ä¸€ä¸ªæ¥å£ç±»å‹(å‰è€…æ¥å£å€¼çš„ç±»å‹å¯ä»¥å®ç°äº†ä¹Ÿå¯ä»¥æœªå®ç°åè€…ç›®æ ‡æ¥å£</p><p>ç±»å‹)ã€‚</p></li></ol></blockquote><p>ä»¥ä¸Šä¾é ï¼š</p><blockquote><p>åœ¨ä¸€ä¸ªç±»å‹æ–­è¨€è¡¨è¾¾å¼i.(T)ä¸­ï¼Œiç§°ä¸ºæ–­è¨€å€¼ï¼ŒTç§°ä¸ºæ–­è¨€ç±»å‹ã€‚ ä¸€ä¸ªæ–­è¨€å¯èƒ½æˆåŠŸæˆ–è€…å¤±è´¥ã€‚</p></blockquote><p>è¿˜æ˜¯æœ‰ä¸€äº›ä¸åŒçš„ï¼Œå®é™…ä¸Š <code>dynamic_cast</code> å¯¹è±¡æ˜¯æŒ‡é’ˆï¼Œè€Œè¿™é‡Œå¾ˆéš¾æ‹¿åˆ°<code>interface</code> ä¸­åŸå¯¹è±¡çš„å¼•ç”¨ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">b := Book&#123;name: <span class="string">&quot;å¡æ‹‰é©¬ä½å¤«å…„å¼Ÿ&quot;</span>&#125;</span><br><span class="line">aboutable = b</span><br><span class="line"></span><br><span class="line">fmt.Println(aboutable.About()) <span class="comment">// Book(name:å¡æ‹‰é©¬ä½å¤«å…„å¼Ÿ)</span></span><br><span class="line">aboutableBook := aboutable.(Book)</span><br><span class="line">fmt.Println(aboutableBook.About()) <span class="comment">// Book(name:å¡æ‹‰é©¬ä½å¤«å…„å¼Ÿ)</span></span><br><span class="line"></span><br><span class="line">aboutableBook.name = <span class="string">&quot;ç½ªä¸ç½š&quot;</span></span><br><span class="line">fmt.Println(aboutable.About()) <span class="comment">// Book(name:å¡æ‹‰é©¬ä½å¤«å…„å¼Ÿ)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//bptr, ok := (aboutable).(*Book)</span></span><br><span class="line"><span class="comment">//if !ok &#123;</span></span><br><span class="line"><span class="comment">//fmt.Println(&quot;cast error&quot;)</span></span><br><span class="line"><span class="comment">//&#125; else &#123;</span></span><br><span class="line"><span class="comment">//fmt.Println(bptr.About())</span></span><br><span class="line"><span class="comment">//&#125;</span></span><br></pre></td></tr></table></figure><p>ä¸‹é¢æ˜¯ç¼–è¯‘ä¸é€šè¿‡çš„, é™¤éä½ ä¸€å¼€å§‹æ”¾çš„å°±æ˜¯ <code>*Book</code>, å¯ä»¥è½¬å›æ¥ã€‚å¦åˆ™è¿™ä»ç„¶æ˜¯ä¸€ä¸ª copy è¡Œä¸ºã€‚</p><p>æ­¤å¤–è¿˜æœ‰ä¸ªå¾ˆç¥ç§˜çš„è¯­æ³•ï¼šswitch type:</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">switch</span> x.(<span class="keyword">type</span>) &#123;</span><br><span class="line"><span class="keyword">case</span> []<span class="type">int</span>:</span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘çœŸçš„è§‰å¾—è¿™ä¸ªè¯­æ³•å¤ªç¥ç§˜äº†ï¼Œè¿™ä¼¼ä¹æ˜¯ä¸ª builtinã€‚</p><p>æ­¤å¤–ï¼Œç±»ä¼¼ Java é€†å˜ï¼Œåå˜çš„æ¦‚å¿µï¼š</p><blockquote><p>ä¸€ä¸ª <strong>[]T</strong> ç±»å‹çš„å€¼ä¸èƒ½ç›´æ¥è¢«è½¬æ¢ä¸ºç±»å‹ <strong>[]I</strong> ï¼Œå³ä½¿ç±»å‹ <strong>T</strong> å®ç°äº†æ¥å£ç±»å‹<strong>I</strong></p></blockquote><h3 id="ç±»å‹å†…åµŒ"><a href="#ç±»å‹å†…åµŒ" class="headerlink" title="ç±»å‹å†…åµŒ"></a>ç±»å‹å†…åµŒ</h3><p>ä¼¼ä¹æ˜¯ç”±äº Go ç»„åˆä¼˜äºç»§æ‰¿çš„å“²å­¦ï¼ŒGo å…è®¸ç±»å‹å†…åµŒï¼Œå®ƒçš„è§„åˆ™æœ‰ç‚¹å¥‡æ€ªï¼š</p><blockquote><ol><li>ä¸€ä¸ªç±»å‹å T åªæœ‰åœ¨å®ƒæ—¢ä¸è¡¨ç¤ºä¸€ä¸ªå®šä¹‰çš„æŒ‡é’ˆç±»å‹ä¹Ÿä¸è¡¨ç¤ºä¸€ä¸ªåŸºç±»å‹ä¸ºæŒ‡é’ˆç±»å‹æˆ–è€…æ¥å£ç±»å‹ çš„æŒ‡é’ˆç±»å‹çš„æƒ…å†µä¸‹åœ¨å¯ä»¥è¢«ç”¨ä½œå†…åµŒå­—æ®µã€‚</li><li>ä¸€ä¸ªæŒ‡é’ˆç±»å‹ *T åªæœ‰åœ¨ T ä¸ºä¸€ä¸ªç±»å‹åå¹¶ä¸” T æ—¢ä¸è¡¨ç¤ºä¸€ä¸ªæŒ‡é’ˆç±»å‹ä¹Ÿä¸è¡¨ç¤ºä¸€ä¸ªæ¥å£ç±»å‹çš„æ—¶ å€™æ‰èƒ½è¢«ç”¨ä½œå†…åµŒå­—æ®µã€‚</li></ol></blockquote><ul><li>T æœ¬èº«è¦æ±‚ä¸æ˜¯ pointer/åŸºç±»å‹ä¸æ˜¯ pointer/interface</li><li>*T è¦æ±‚ T æ˜¯ç±»å‹å åŸºç±»å‹ä¸æ˜¯ pointer/interface</li><li>ï¼ˆæˆ‘ä»¥å‰ä¸çŸ¥é“çš„æ˜¯ï¼Œç±»å‹ç«Ÿç„¶èƒ½å†…åµŒ interface, ç¥äº†ï¼‰</li></ul><p>è¢«å†…åµŒç±»å‹çš„æ–¹æ³•ä¼šè¢«æå‡ï¼Œè¿™æ˜¯ä¸€ä¸ªè¯­æ³•ç³–ï¼Œå¦‚æœé‡å¤å®šä¹‰ï¼Œå¯ä»¥å‚è€ƒä»¥ä¸‹é€»è¾‘ï¼š</p><blockquote><p>åªæœ‰æ·±åº¦æœ€æµ…çš„ä¸€ä¸ªå®Œæ•´å½¢å¼çš„é€‰æ‹©å™¨(å¹¶ä¸”æœ€æµ…è€…åªæœ‰ä¸€ä¸ª)å¯ä»¥è¢«ç¼©å†™ä¸ºx.yã€‚ æ¢å¥è¯è¯´ï¼Œ x.y è¡¨ç¤ºæ·±åº¦æœ€æµ…çš„ä¸€ä¸ªé€‰æ‹©å™¨ã€‚å…¶å®ƒå®Œæ•´å½¢å¼çš„é€‰æ‹©å™¨è¢«æ­¤æœ€æµ…è€…æ‰€é®æŒ¡(å‹åˆ¶)ã€‚ å¦‚æœæœ‰å¤šä¸ªå®Œæ•´å½¢å¼çš„é€‰æ‹©å™¨åŒæ—¶æ‹¥æœ‰æœ€æµ…æ·±åº¦ï¼Œåˆ™ä»»ä½•å®Œæ•´å½¢å¼çš„é€‰æ‹©å™¨éƒ½ä¸èƒ½è¢«ç¼©å†™ä¸º x.y ã€‚ æˆ‘ä»¬ç§°è¿™äº›åŒæ—¶æ‹¥æœ‰æœ€æµ…æ·±åº¦çš„å®Œæ•´å½¢å¼çš„é€‰æ‹©å™¨å‘ç”Ÿäº†ç¢°æ’ã€‚</p></blockquote><p>è€Œå¤–å±‚ç±»å‹ä¹Ÿä¼š implicit å®ç°è¿™äº›æ–¹æ³•ã€‚</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Types In Golang: part1</title>
      <link href="/2020/05/01/Types-In-Golang/"/>
      <url>/2020/05/01/Types-In-Golang/</url>
      
        <content type="html"><![CDATA[<p>Golang çš„ç±»å‹åˆ†ä¸ºï¼š</p><ul><li>basic type:<ul><li>string</li><li>bool</li><li>int/uint/float</li><li>byte and rune is uint8 and int32</li><li>complex</li></ul></li><li>composite type<ul><li>pointer</li><li>struct</li><li>function</li><li>container<ul><li>slice</li><li>array</li><li>map</li></ul></li><li>channel</li><li>interface</li></ul></li></ul><p>æ¯ç§ type éƒ½æœ‰ä¸€ä¸ª kind</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">type A B  // A is an another type</span><br><span class="line">type A = B // A is an alias of B</span><br></pre></td></tr></table></figure><h4 id="underlying-type"><a href="#underlying-type" class="headerlink" title="underlying type"></a>underlying type</h4><ul><li>æ¯ä¸ª type éƒ½æœ‰ underlying type</li><li>å†…ç½®ç±»å‹ underlying type ä¸ºè‡ªèº«</li><li>unsafe.Pointer undefined</li><li>ä¸€ä¸ª undefined type å³ <code>=</code> æ„æˆçš„ composite type</li><li>ä¸€ä¸ªç±»å‹å£°æ˜ä¸­ï¼Œä¸¤ä¸ªç±»å‹å…±äº« underlying type</li></ul><p>ä¸Šé¢çš„å†…å®¹4/5å†™çš„å¾ˆä¹±ï¼Œå…¶å®å°±æ˜¯ä¸‹é¢ï¼š</p><ul><li><code>AgeSlice</code> åº•å±‚ç±»å‹æ˜¯ <code>[]Age</code></li><li><code>Age</code> çš„åº•å±‚ç±»å‹æ˜¯ <code>MyInt</code>, <code>MyInt</code> åº•å±‚ç±»å‹æ˜¯ <code>int</code>, <code>int</code> åº•å±‚ç±»å‹æ˜¯è‡ªå·±</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> typesys</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> (</span><br><span class="line">MyInt <span class="type">int</span></span><br><span class="line">Age MyInt</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> (</span><br><span class="line">IntSlice []<span class="type">int</span></span><br><span class="line">MyIntSlice []MyInt</span><br><span class="line">AgeSlice []Age</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Ages []Age</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">f1</span><span class="params">(v <span class="type">int</span>)</span></span>  &#123;</span><br><span class="line"><span class="built_in">panic</span>(<span class="string">&quot;implement me&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">f2</span><span class="params">([]Age)</span></span>  &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">f3</span><span class="params">([]<span class="type">int</span>)</span></span>  &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Call1</span><span class="params">()</span></span>  &#123;</span><br><span class="line"><span class="keyword">var</span> v MyInt = <span class="number">114514</span></span><br><span class="line"><span class="comment">//cannot call</span></span><br><span class="line"><span class="comment">//f1(v)</span></span><br><span class="line">f1(<span class="type">int</span>(v))</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> s []Age</span><br><span class="line">f2(s)</span><br><span class="line"><span class="keyword">var</span> s2 AgeSlice</span><br><span class="line">f2(s2)</span><br><span class="line"></span><br><span class="line"><span class="comment">// cannot call</span></span><br><span class="line"><span class="comment">//f3(s)</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ³¨æ„ï¼Œç±»å‹åˆ«åä¸­</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> A = B</span><br><span class="line"><span class="keyword">type</span> C = B</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> AA = <span class="keyword">struct</span> &#123;&#125;</span><br><span class="line"><span class="keyword">type</span> BB = <span class="keyword">struct</span> &#123;&#125;</span><br></pre></td></tr></table></figure><p>AA, BB éƒ½æ˜¯åŒä¸€ç§ç±»å‹</p><h4 id="value"><a href="#value" class="headerlink" title="value"></a>value</h4><p>ä¸€ä¸ªç±»å‹æœ‰ï¼š</p><ul><li>ä¸åŒçš„ value</li><li>ä¸€ä¸ªé›¶å€¼</li></ul><p>æˆ‘ä»¬å¯ä»¥ç”¨ unsafe æ ‡å‡†åº“åŒ…ä¸­çš„ Sizeof å‡½æ•°æ¥å–å¾—ä»»ä½•ä¸€ä¸ªå€¼çš„ memory sizeã€‚</p><blockquote><p>è£¹åœ¨ä¸€ä¸ªæ¥å£å€¼ä¸­çš„éæ¥å£ å€¼ç§°ä¸ºæ­¤æ¥å£å€¼çš„åŠ¨æ€å€¼ã€‚æ­¤åŠ¨æ€å€¼çš„ç±»å‹ç§°ä¸ºæ­¤æ¥å£å€¼çš„åŠ¨æ€ç±»å‹ã€‚ ä¸€ä¸ªä»€ä¹ˆä¹Ÿæ²¡åŒ…è£¹çš„æ¥å£å€¼ä¸º ä¸€ä¸ªé›¶å€¼æ¥å£å€¼ã€‚é›¶å€¼æ¥å£å€¼çš„åŠ¨æ€å€¼å’ŒåŠ¨æ€ç±»å‹å‡ä¸ºä¸å­˜åœ¨ã€‚</p><p>ä¸€ä¸ªæ¥å£ç±»å‹å¯ä»¥æŒ‡å®šè‹¥å¹²ä¸ª(å¯ä»¥æ˜¯é›¶ä¸ª)æ–¹æ³•ï¼Œè¿™äº›æ–¹æ³•å½¢æˆäº†æ­¤æ¥å£ç±»å‹çš„æ–¹æ³•é›†ã€‚</p></blockquote><h3 id="æŒ‡é’ˆ"><a href="#æŒ‡é’ˆ" class="headerlink" title="æŒ‡é’ˆ"></a>æŒ‡é’ˆ</h3><p>è¿™ä¸ªæ¦‚å¿µç±»ä¼¼ C çš„ pointer, ä½†æ˜¯æœ‰ gc å…œåº•ï¼Œæ‰€ä»¥æˆ‘æ€»è§‰å¾— Go é‡Œé¢æŒ‡é’ˆæ€ªæ€ªçš„</p><h5 id="å¯å¯»å€"><a href="#å¯å¯»å€" class="headerlink" title="å¯å¯»å€"></a>å¯å¯»å€</h5><p><code>return &amp;func()</code> å¯èƒ½ä¼šç»™ä½ æŠ¥é”™ â€œä¸å¯å¯»å€â€ï¼Œè¿™ä¸€ç‚¹æˆ‘æ€»è§‰å¾—å¾ˆç¦»è°±â€¦ ä½†æ˜¯æˆ‘ä»¬æ€»å¾—ææ˜ç™½ä¸ºä»€ä¹ˆã€‚</p><blockquote><p>ä¸€ä¸ªå¯å¯»å€çš„å€¼æ˜¯æŒ‡è¢«æ”¾ç½®åœ¨å†…å­˜ä¸­æŸå›ºå®šä½ç½®å¤„çš„ä¸€ä¸ªå€¼(ä½†æ”¾ç½®åœ¨æŸå›ºå®šä½ç½®å¤„çš„ä¸€ä¸ª å€¼å¹¶éä¸€å®šæ˜¯å¯å¯»å€çš„)ã€‚ ç›®å‰ï¼Œæˆ‘ä»¬åªéœ€çŸ¥é“æ‰€æœ‰å˜é‡éƒ½æ˜¯å¯ä»¥å¯»å€çš„;ä½†æ˜¯æ‰€æœ‰å¸¸é‡ã€å‡½æ•°è¿”å› å€¼å’Œå¼ºåˆ¶è½¬æ¢ç»“æœéƒ½æ˜¯ä¸å¯å¯»å€çš„ã€‚ å½“ä¸€ä¸ªå˜é‡è¢«å£°æ˜çš„æ—¶å€™ï¼ŒGoè¿è¡Œæ—¶å°†ä¸ºæ­¤å˜é‡å¼€è¾Ÿä¸€æ®µå†…å­˜ã€‚ æ­¤å†…å­˜çš„èµ·å§‹åœ°å€å³ä¸ºæ­¤å˜é‡çš„åœ°å€ã€‚</p></blockquote><p><code>*p</code> ç±»ä¼¼ Cï¼Œå¯¹ <code>nil</code> deref ä¼š panic.</p><p><img src="/Users/fuasahi/Downloads/47D191C9293076F9A6775E0FA2546192.png" alt="47D191C9293076F9A6775E0FA2546192"></p><p>è¿™ä¸ªå†™çš„æ¯”è¾ƒè¿·ï¼Œæˆ‘ä¸ªäººç†è§£æ˜¯ï¼š</p><ul><li>å¦‚æœæ˜¯ underline type ç›¸åŒï¼Œå¯ä»¥ implicit è½¬</li><li>å¦‚æœå…³ç³»å¤šå±‚ï¼Œéœ€è¦ explict çš„è½¬</li></ul><p>æŒ‡é’ˆåªèƒ½ä¸ nil æ¯”è¾ƒ</p><p>ï¼ˆunsafe.Pointer ç±»ä¼¼ C Pointer, å¯ä»¥è®©æˆ‘ä»¬å¤§å±•å®å›¾ï¼‰</p><h4 id="ç»“æ„ä½“"><a href="#ç»“æ„ä½“" class="headerlink" title="ç»“æ„ä½“"></a>ç»“æ„ä½“</h4><ul><li>å½“ä¸€ä¸ª(æº)ç»“æ„ä½“å€¼è¢«èµ‹å€¼ç»™å¦å¤–ä¸€ä¸ª(ç›®æ ‡)ç»“æ„ä½“å€¼æ—¶ï¼Œå…¶æ•ˆæœå’Œé€ä¸ªå°†æºç»“æ„ä½“å€¼çš„å„ä¸ªå­—æ®µ èµ‹å€¼ç»™ç›®æ ‡ç»“æ„ä½“å€¼çš„å„ä¸ªå¯¹åº”å­—æ®µçš„æ•ˆæœæ˜¯ä¸€æ ·çš„ã€‚</li><li><code>&amp;Struct&#123;&#125;</code> æ˜¯ä¸€ä¸ªè¯­æ³•ç³–ï¼Œ<code>(&amp;Struct&#123;&#125;.field)</code> ä¸å¯ä»¥ï¼Œä½†æ˜¯ <code>&amp;Struct&#123;&#125;</code> æœ¬èº«çš„ field æ˜¯å¯ä»¥ç»­å‘½çš„ï¼ˆæƒ³èµ· C++ ç”¨ <code>&amp;&amp;</code> ç»­å‘½äº†ï¼‰</li></ul><h4 id="å€¼ä¸å¼•ç”¨"><a href="#å€¼ä¸å¼•ç”¨" class="headerlink" title="å€¼ä¸å¼•ç”¨"></a>å€¼ä¸å¼•ç”¨</h4><p>Go é‡Œé¢æœ‰ä¸¤ç§æŒ‡é’ˆï¼š</p><ul><li>ç±»å‹å®‰å…¨çš„ pointer</li><li>ä¸å®‰å…¨çš„ unsafe.Pointer</li></ul><blockquote><p>ä¸€ä¸ªæŒ‡é’ˆå€¼å­˜å‚¨ç€å¦ä¸€ä¸ªå€¼çš„åœ°å€ï¼Œé™¤éæ­¤æŒ‡é’ˆå€¼æ˜¯ä¸€ä¸ªnilç©ºæŒ‡é’ˆã€‚ æˆ‘ä»¬å¯ä»¥è¯´æ­¤æŒ‡é’ˆå¼•ç”¨ç€(ç¬¬15 ç« )å¦å¤–ä¸€ä¸ªå€¼ï¼Œæˆ–è€…è¯´å¦å¤–ä¸€ä¸ªå€¼æ­£è¢«æ­¤æŒ‡é’ˆæ‰€å¼•ç”¨ã€‚ </p></blockquote><p>å®é™…ä¸Šï¼Œå¦‚æœä¼ å‚ï¼Œå‚æ•°æ˜¯ slice/map/string, ç„¶åä½ æŠŠæ•´ä¸ª å¯¹è±¡ copy äº†ä¸€éï¼Œæ˜¾ç„¶æ˜¯ä¸åˆç†çš„ã€‚å¾ˆæ˜¾ç„¶è¿™éœ€è¦ pass ä¸€ä¸ª pointer/å¼•ç”¨ä¸€æ ·çš„å¯¹è±¡è¿›å»ã€‚</p><p>å®é™…ä¸Šæˆ‘ä»¬å¯ä»¥æ‰¾åˆ°ä¸€äº›å¯¹è±¡å®šä¹‰ï¼š</p><ol><li>slice: <a href="https://github.com/golang/go/blob/master/src/runtime/slice.go">https://github.com/golang/go/blob/master/src/runtime/slice.go</a></li></ol><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> slice <span class="keyword">struct</span> &#123;</span><br><span class="line">array unsafe.Pointer</span><br><span class="line"><span class="built_in">len</span>   <span class="type">int</span></span><br><span class="line"><span class="built_in">cap</span>   <span class="type">int</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>map: <a href="https://github.com/golang/go/blob/master/src/runtime/map.go">https://github.com/golang/go/blob/master/src/runtime/map.go</a></li><li>â€¦</li></ol><p>è¿™äº›å…·ä½“ parse çš„æ—¶å€™éƒ½æ˜¯ç±»ä¼¼ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">type _map *hashtableImpl</span><br></pre></td></tr></table></figure><p>è¿™æ ·çš„å¼•ç”¨å¯¹è±¡ã€‚</p><p>æ¯”è¾ƒéœ€è¦æ³¨æ„çš„æ˜¯ interface</p><blockquote><p>ä¸€ä¸ªéç©ºæ¥å£ç±»å‹çš„å€¼çš„dynamicTypeInfoå­—æ®µçš„methodså­—æ®µå¼•ç”¨ç€ä¸€ä¸ªæ–¹æ³•åˆ—è¡¨ã€‚ æ­¤åˆ—è¡¨ä¸­çš„æ¯ ä¸€é¡¹ä¸ºæ­¤æ¥å£å€¼çš„åŠ¨æ€ç±»å‹ä¸Šå®šä¹‰çš„ä¸€ä¸ªæ–¹æ³•ï¼Œæ­¤æ–¹æ³•å¯¹åº”ç€æ­¤æ¥å£ç±»å‹æ‰€æŒ‡å®šçš„ä¸€ä¸ªçš„åŒåŸå‹çš„æ–¹ æ³•ã€‚</p></blockquote><p>æ‰€ä»¥ï¼š</p><blockquote><ul><li>åœ¨èµ‹å€¼ä¸­ï¼Œåº•å±‚é—´æ¥å€¼éƒ¨å°†ä¸ä¼šè¢«å¤åˆ¶</li><li>åœ¨ä½¿ç”¨ unsafe.Sizeof å‡½æ•°è®¡ç®—ä¸€ä¸ªå€¼çš„å°ºå¯¸çš„ æ—¶å€™ï¼Œæ­¤å€¼çš„é—´æ¥éƒ¨åˆ†æ‰€å å†…å­˜ç©ºé—´æœªè¢«è®¡ç®—åœ¨å†…ã€‚</li></ul></blockquote><p>éœ€è¦ç†è§£å¼•ç”¨è¿™ä¸ªè¯ï¼Œåœ¨ Go é‡Œé¢å®é™…ä¸Šæ²¡æœ‰å¾ˆå¥½çš„ context</p><blockquote><p>åœ¨Goä¸­ï¼Œåªæœ‰åˆ‡ç‰‡ã€æ˜ å°„ã€é€šé“å’Œå‡½æ•°ç±»å‹å±äºå¼•ç”¨ç±»å‹ã€‚ (å¦‚æœæˆ‘ä»¬ç¡®å®éœ€è¦å¼•ç”¨ç±»å‹è¿™ä¸ªæœ¯ è¯­ï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¸åº”æŠŠå…¶å®ƒæŒ‡é’ˆæŒæœ‰è€…ç±»å‹æ’é™¤åœ¨å¼•ç”¨ç±»å‹ä¹‹å¤–ã€‚) ä¸€äº›å‡½æ•°è°ƒç”¨çš„å‚æ•°æ˜¯é€šè¿‡å¼•ç”¨æ¥ä¼ é€’çš„ã€‚ (å¯¹ä¸èµ·ï¼Œåœ¨Goä¸­ï¼Œæ‰€æœ‰çš„å‡½æ•°è°ƒç”¨çš„å‚æ•°éƒ½æ˜¯é€šè¿‡ å€¼å¤åˆ¶çš„æ–¹å¼æ¥ä¼ é€’çš„ã€‚)</p></blockquote><h3 id="array-slice-map"><a href="#array-slice-map" class="headerlink" title="array slice map"></a>array slice map</h3><ul><li>ä¸€ä¸ªæ˜ å°„ç±»å‹çš„é”®å€¼ç±»å‹å¿…é¡»ä¸ºä¸€ä¸ªå¯æ¯”è¾ƒç±»å‹</li><li>æ•°ç»„å’Œåˆ‡ç‰‡ç±»å‹çš„é”®ç±»å‹å‡ä¸ºå†… ç½®ç±»å‹intã€‚ ä¸€ä¸ªæ•°ç»„æˆ–åˆ‡ç‰‡çš„ä¸€ä¸ªå…ƒç´ å¯¹åº”çš„é”®å€¼æ€»æ˜¯ä¸€ä¸ªéè´Ÿæ•´æ•°ä¸‹æ ‡ï¼Œæ­¤éè´Ÿæ•´æ•°è¡¨ç¤ºè¯¥å…ƒç´ åœ¨ è¯¥æ•°ç»„æˆ–åˆ‡ç‰‡æ‰€æœ‰å…ƒç´ ä¸­çš„é¡ºåºä½ç½®ã€‚æ­¤éè´Ÿæ•´æ•°ä¸‹æ ‡äº¦å¸¸ç§°ä¸ºä¸€ä¸ªå…ƒç´ ç´¢å¼•(index)ã€‚</li><li>æ¯ä¸ªå®¹å™¨å€¼æœ‰ä¸€ä¸ªé•¿åº¦å±æ€§</li><li>æ¯ä¸ªæ•°ç»„å€¼ä»…ç”±ä¸€ä¸ªç›´æ¥éƒ¨åˆ†ç»„æˆï¼Œè€Œä¸€ä¸ªåˆ‡ç‰‡æˆ–è€…æ˜ å°„å€¼æ˜¯ç”±ä¸€ä¸ªç›´æ¥ éƒ¨åˆ†å’Œä¸€ä¸ªå¯èƒ½çš„è¢«æ­¤ç›´æ¥éƒ¨åˆ†å¼•ç”¨ç€çš„é—´æ¥éƒ¨åˆ†ç»„æˆã€‚</li></ul><blockquote><p>ä¸€ä¸ªæ•°ç»„æˆ–è€…åˆ‡ç‰‡çš„æ‰€æœ‰å…ƒç´ ç´§æŒ¨ç€å­˜æ”¾åœ¨ä¸€å—è¿ç»­çš„å†…å­˜ä¸­ã€‚ä¸€ä¸ªæ•°ç»„ä¸­çš„æ‰€æœ‰å…ƒç´ å‡å­˜æ”¾åœ¨æ­¤æ•°ç»„ å€¼çš„ç›´æ¥éƒ¨åˆ†ï¼Œä¸€ä¸ªåˆ‡ç‰‡ä¸­çš„æ‰€å…ƒç´ å‡å­˜æ”¾åœ¨æ­¤åˆ‡ç‰‡å€¼çš„é—´æ¥éƒ¨åˆ†ã€‚ åœ¨å®˜æ–¹æ ‡å‡†ç¼–è¯‘å™¨å’Œè¿è¡Œæ—¶ä¸­ï¼Œ æ˜ å°„æ˜¯ä½¿ç”¨å“ˆå¸Œè¡¨ç®—æ³•æ¥å®ç°çš„ã€‚æ‰€ä»¥ä¸€ä¸ªæ˜ å°„ä¸­çš„æ‰€æœ‰å…ƒç´ ä¹Ÿå‡å­˜æ”¾åœ¨ä¸€å—è¿ç»­çš„å†…å­˜ä¸­ï¼Œä½†æ˜¯æ˜ å°„ ä¸­çš„å…ƒç´ å¹¶ä¸ä¸€å®šç´§æŒ¨ç€å­˜æ”¾ã€‚</p><p>å¯¹äºè¿™ä¸‰ç§å®¹å™¨ï¼Œå…ƒç´ è®¿é—®çš„æ—¶é—´å¤æ‚åº¦å‡ä¸º<em>O</em>(1)ã€‚</p></blockquote><h4 id="é›¶å€¼"><a href="#é›¶å€¼" class="headerlink" title="é›¶å€¼"></a>é›¶å€¼</h4><ol><li><p><code>A&#123;&#125;</code> â€”&gt; <code>[]int&#123;&#125;</code></p></li><li><p>å’ŒæŒ‡é’ˆä¸€æ ·ï¼Œæ‰€æœ‰åˆ‡ç‰‡å’Œæ˜ å°„ç±»å‹çš„é›¶å€¼å‡ç”¨é¢„å£°æ˜çš„æ ‡è¯†ç¬¦ nil æ¥è¡¨ç¤ºã€‚</p></li><li><p>å³ä½¿ä¸€ä¸ªæ•°ç»„å˜é‡åœ¨å£°æ˜çš„æ—¶å€™æœªæŒ‡å®šåˆå§‹å€¼ï¼Œå®ƒçš„å…ƒç´ æ‰€å çš„å†…å­˜ç©ºé—´ä¹Ÿå·²ç»è¢«å¼€è¾Ÿå‡º</p><p>æ¥ã€‚ ä½†æ˜¯ä¸€ä¸ªnilåˆ‡ç‰‡æˆ–è€…æ˜ å°„å€¼çš„å…ƒç´ çš„å†…å­˜ç©ºé—´å°šæœªè¢«å¼€è¾Ÿå‡ºæ¥ã€‚</p></li><li><p><code>[]T&#123;&#125;</code>è¡¨ç¤ºç±»å‹<code>[]T</code>çš„ä¸€ä¸ªç©ºåˆ‡ç‰‡å€¼ï¼Œå®ƒå’Œ<code>[]T(nil)</code>æ˜¯ä¸ç­‰ä»·çš„ã€‚ åŒæ ·ï¼Œ<code>map[K]T&#123;&#125;</code>å’Œ</p><p><code>map[K]T(nil)</code> ä¹Ÿæ˜¯ä¸ç­‰ä»·çš„ã€‚</p></li></ol><p>ä»¥ä¸Šå†…å®¹æ˜¯å¾ˆæ˜¾ç„¶çš„ï¼Œä½†æ˜¯å®é™…ä½¿ç”¨çš„æ—¶å€™ï¼Œå› ä¸º slice æˆ‘ä»¬é€šå¸¸å’Œ append è”ç”¨ï¼Œæ‰€ä»¥<code>var v []int</code> ç„¶åå†å¯¹å®ƒä¸æ–­ append</p><h5 id="æ¯”è¾ƒ"><a href="#æ¯”è¾ƒ" class="headerlink" title="æ¯”è¾ƒ"></a>æ¯”è¾ƒ</h5><ul><li>åŒç±»å‹æ•°ç»„æ˜¯å¯æ¯”è¾ƒçš„ï¼Œç±»ä¼¼ C é‡Œé¢ strcmp</li><li>slice map å¯ä»¥åŒ nil æ¯”è¾ƒ</li></ul><h5 id="len-cap"><a href="#len-cap" class="headerlink" title="len cap"></a>len cap</h5><ul><li>slice: len cap</li><li>map: len, å®ƒçš„ cap æ˜¯æ— é™å¤§</li><li>array: len cap éƒ½æ˜¯è‡ªèº«çš„ size</li></ul><h5 id="å…ƒç´ çš„-r-w"><a href="#å…ƒç´ çš„-r-w" class="headerlink" title="å…ƒç´ çš„ r/w"></a>å…ƒç´ çš„ r/w</h5><p>åœ¨ C++ ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥æƒ³è±¡ï¼š</p><ul><li><code>const T&amp; operator[](int v)</code> å’Œ  <code>T&amp; operator[](int v)</code> , ä¿è¯ä½ æ‹¿å‡ºæ¥æ˜¯ä¸ª ref</li></ul><p>åœ¨ Go çš„ <code>v[k]</code> ä¸­ï¼š</p><p>å¦‚æœæ˜¯ä¸ª slice/array</p><ul><li>v æ˜¯ä¸€ä¸ª nil slice: panic</li><li>slice/array ä¸­å¿…é¡»æœ‰é•¿åº¦çš„é™åˆ¶</li></ul><p>å¦‚æœæ˜¯ä¸ª map</p><ul><li>å¦‚æœ k æ˜¯ä¸€ä¸ªåŠ¨æ€ç±»å‹ä¸ºä¸å¯æ¯”è¾ƒç±»å‹çš„æ¥å£å€¼ï¼Œåˆ™ v[k] åœ¨è¿è¡Œæ—¶åˆ»å°†é€ æˆä¸€ä¸ª Panic ï¼ˆæ¯”å¦‚ä½ å®šä¹‰äº†ä¸€ä¸ª map[interface{}]xxx, ç„¶åä¼ äº†ä¸€ä¸ªä¸å¯ä»¥ cmp çš„ key, å®ƒä¼š panic è¯´è¿™ç©æ„ä¸æ˜¯ hashable çš„ï¼‰</li><li>å¦‚æœ <code>v[k] = xxx</code> ï¼Œä¸” <code>v</code> is nil, ä¼š panic</li><li><code>v[k]</code> è¯»å–æ—¶ï¼Œ<strong>æ— è®ºå¦‚ä½•ä¸ä¼š panic</strong>, å¦‚æœä¸å­˜åœ¨ä¼šè¿”å› Value ç±»å‹çš„ é›¶å€¼</li></ul><h4 id="Slice-çš„ç»“æ„ä¸æ“ä½œè¯­ä¹‰"><a href="#Slice-çš„ç»“æ„ä¸æ“ä½œè¯­ä¹‰" class="headerlink" title="Slice çš„ç»“æ„ä¸æ“ä½œè¯­ä¹‰"></a>Slice çš„ç»“æ„ä¸æ“ä½œè¯­ä¹‰</h4><p>äº†è§£äº† slice çš„è¯­ä¹‰ï¼Œæˆ‘ä»¬æ‰èƒ½ä¸çå‡ æŠŠç”¨ã€‚é¦–å…ˆè¦çŸ¥é“ Slice å¹¶ä¸æ˜¯ immutable + Persistent çš„ç»“æ„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå®é™…ä¸Šè¿™äº›æ“ä½œæ˜¯å¾ˆå¯èƒ½æœ‰å‰¯ä½œç”¨çš„</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> slice <span class="keyword">struct</span> &#123;</span><br><span class="line">array unsafe.Pointer</span><br><span class="line"><span class="built_in">len</span>   <span class="type">int</span></span><br><span class="line"><span class="built_in">cap</span>   <span class="type">int</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>å½“ä¸€ä¸ªåˆ‡ç‰‡è¢«ç”¨åšä¸€ä¸ª append å‡½æ•°è°ƒç”¨ä¸­çš„åŸºç¡€åˆ‡ç‰‡ï¼Œ</p><p>å¦‚æœæ·»åŠ çš„å…ƒç´ æ•°é‡å¤§äºæ­¤(åŸºç¡€)åˆ‡ç‰‡çš„å†—ä½™å…ƒç´ æ§½ä½çš„æ•°é‡ï¼Œåˆ™ä¸€ä¸ªæ–°çš„åº•å±‚å†…å­˜ç‰‡æ®µå°†è¢« å¼€è¾Ÿå‡ºæ¥å¹¶ç”¨æ¥å­˜æ”¾ç»“æœåˆ‡ç‰‡çš„å…ƒç´ ã€‚ è¿™æ—¶ï¼ŒåŸºç¡€åˆ‡ç‰‡å’Œç»“æœåˆ‡ç‰‡ä¸å…±äº«ä»»ä½•åº•å±‚å…ƒç´ ã€‚ å¦åˆ™ï¼Œä¸ä¼šæœ‰åº•å±‚å†…å­˜ç‰‡æ®µè¢«å¼€è¾Ÿå‡ºæ¥ã€‚è¿™æ—¶ï¼ŒåŸºç¡€åˆ‡ç‰‡ä¸­çš„æ‰€æœ‰å…ƒç´ ä¹ŸåŒæ—¶å±äºç»“æœåˆ‡ç‰‡ã€‚ä¸¤ ä¸ªåˆ‡ç‰‡çš„å…ƒç´ éƒ½å­˜æ”¾äºåŒä¸€ä¸ªå†…å­˜ç‰‡æ®µä¸Šã€‚</p></blockquote><p>å®é™…ä¸Šï¼Œå¦‚æœä¸æ³¨æ„çš„è¯ï¼Œå¾ˆå®¹æ˜“å‘ç”Ÿå¤šä¸ª slice å…±äº«åº•å±‚å†…å­˜çš„æƒ…å†µï¼Œè¯·æ³¨æ„ã€‚</p><ul><li>slice èµ‹å€¼æ”¹å˜ slice çš„å¼•ç”¨å¯¹è±¡</li><li>array èµ‹å€¼ copy å…¨éƒ¨å…ƒç´ </li></ul><p>å¯¹äº map æ¥è¯´ï¼Œå¢æ”¹/åˆ åˆ†åˆ«æ˜¯ï¼š</p><ul><li><code>v[k] = s</code></li><li><code>delete(v, k)</code></li></ul><p>map ä¸Šæ“ä½œä¼¼ä¹éƒ½æ˜¯æ³›å‹çš„ï¼Œï¼ˆGo æ²¡æœ‰æ³›å‹å°±æ˜¯sbï¼Œå“ï¼‰ã€‚</p><blockquote><p>æ³¨æ„ï¼Œåœ¨Go 1.12ä¹‹å‰ï¼Œæ˜ å°„æ‰“å°ç»“æœä¸­çš„æ¡ç›®é¡ºåºå¹¶ä¸å›ºå®šï¼Œä¸¤æ¬¡æ‰“å°ç»“æœå¯èƒ½å¹¶ä¸ç›¸åŒã€‚</p></blockquote><p>è‡³äº slice, é€šå¸¸é  append, ä½†æ˜¯ slice åˆä¸æ˜¯ immutable çš„ï¼Œæ‰€ä»¥å®é™…ä¸Š <code>append()</code> å¯èƒ½ä¼šè¿”å›ä¸€ä¸ªæ”¹å˜ len è€Œä¸æ”¹å˜ cap çš„ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>  &#123;</span><br><span class="line">s1 := []<span class="type">int</span> &#123; <span class="number">1</span>, <span class="number">1</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">1</span>, <span class="number">4</span>&#125;</span><br><span class="line">fmt.Printf(<span class="string">&quot;len: %d cap: %d\n&quot;</span>, <span class="built_in">len</span>(s1), <span class="built_in">cap</span>(s1))</span><br><span class="line">s1 = <span class="built_in">append</span>(s1, <span class="number">4</span>)</span><br><span class="line">fmt.Printf(<span class="string">&quot;len: %d cap: %d\n&quot;</span>, <span class="built_in">len</span>(s1), <span class="built_in">cap</span>(s1))</span><br><span class="line">s2 := <span class="built_in">append</span>(s1, <span class="number">5</span>)</span><br><span class="line">fmt.Printf(<span class="string">&quot;len: %d cap: %d\n&quot;</span>, <span class="built_in">len</span>(s1), <span class="built_in">cap</span>(s1))</span><br><span class="line">fmt.Printf(<span class="string">&quot;len: %d cap: %d\n&quot;</span>, <span class="built_in">len</span>(s2), <span class="built_in">cap</span>(s2))</span><br><span class="line"></span><br><span class="line">s1[<span class="number">2</span>] = <span class="number">5</span></span><br><span class="line"><span class="comment">// s1: 5 s2: 5</span></span><br><span class="line">fmt.Printf(<span class="string">&quot;s1: %d s2: %d\n&quot;</span>, s1[<span class="number">2</span>], s2[<span class="number">2</span>])</span><br><span class="line"></span><br><span class="line">s3 := <span class="built_in">append</span>(s1, <span class="number">6</span>)</span><br><span class="line"><span class="comment">// s2: 6 s3: 6</span></span><br><span class="line">fmt.Printf(<span class="string">&quot;s2: %d s3: %d\n&quot;</span>, s2[<span class="built_in">len</span>(s2) - <span class="number">1</span>], s3[<span class="built_in">len</span>(s3) - <span class="number">1</span>])</span><br><span class="line"></span><br><span class="line">sptr := &amp;s1[<span class="number">5</span>]</span><br><span class="line">*sptr = <span class="number">114514</span></span><br><span class="line"><span class="comment">// s2: 114514 s3: 114514</span></span><br><span class="line">fmt.Printf(<span class="string">&quot;s2: %d s3: %d\n&quot;</span>, s2[<span class="number">5</span>], s3[<span class="number">5</span>])</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥æˆ‘ä¸ªäººè§‰å¾—ï¼Œè¿˜æ˜¯æŠŠ slice å½“æˆâ€œæœ‰å†…éƒ¨æ‰€æœ‰æƒçš„æŒ‡é’ˆâ€å§</p><p>ï¼ˆæˆ‘å±€çš„æŒºå‚»é€¼çš„ï¼ŒçœŸçš„ï¼‰</p><p>åˆ›å»ºå®¹å™¨å¯ä»¥ï¼š</p><ul><li><code>new</code></li><li><code>make</code></li><li>å­—é¢é‡</li></ul><h4 id="å®¹å™¨å…ƒç´ ï¼šå¯»å€"><a href="#å®¹å™¨å…ƒç´ ï¼šå¯»å€" class="headerlink" title="å®¹å™¨å…ƒç´ ï¼šå¯»å€"></a>å®¹å™¨å…ƒç´ ï¼šå¯»å€</h4><blockquote><p>å¯å¯»å€çš„æ•°ç»„çš„å…ƒç´ ä¹Ÿæ˜¯å¯å¯»å€çš„ã€‚</p><p>ä¸å¯å¯»å€çš„æ•°ç»„çš„å…ƒç´ ä¹Ÿæ˜¯ä¸å¯å¯»å€çš„ã€‚ åŸå› å¾ˆç®€å•ï¼Œå› ä¸º ä¸€ä¸ªæ•°ç»„ä¸­çš„æ‰€æœ‰å…ƒç´ å‡å¤„äºæ­¤æ•°ç»„çš„ç›´æ¥éƒ¨åˆ†ã€‚ </p><p>ä¸€ä¸ªåˆ‡ç‰‡å€¼çš„ä»»ä½•å…ƒç´ éƒ½æ˜¯å¯å¯»å€çš„ï¼Œå³ä½¿æ­¤åˆ‡ç‰‡æœ¬èº«æ˜¯ä¸å¯å¯»å€çš„ã€‚ è¿™æ˜¯å› ä¸ºä¸€ä¸ªåˆ‡ç‰‡çš„åº•å±‚ å…ƒç´ æ€»æ˜¯å­˜å‚¨åœ¨ä¸€ä¸ªè¢«å¼€è¾Ÿå‡ºæ¥çš„å†…å­˜ç‰‡æ®µä¸Šã€‚ ä»»ä½•æ˜ å°„å…ƒç´ éƒ½æ˜¯ä¸å¯å¯»å€çš„ã€‚åŸå› è¯¦è§æ­¤æ¡é—®ç­”(ç¬¬51ç« )ã€‚</p><p>å¦‚æœä¸€ä¸ªæ˜ å°„ç±»å‹çš„å…ƒç´ ç±»å‹ä¸ºä¸€ä¸ªç»“æ„ä½“ç±»å‹ï¼Œåˆ™æˆ‘ä»¬æ— æ³•ä¿®æ”¹æ­¤æ˜ å°„ç±»å‹çš„å€¼ä¸­çš„æ¯ä¸ªç»“æ„ ä½“å…ƒç´ çš„å•ä¸ªå­—æ®µã€‚ æˆ‘ä»¬å¿…é¡»æ•´ä½“åœ°åŒæ—¶ä¿®æ”¹æ‰€æœ‰ç»“æ„ä½“å­—æ®µã€‚ </p><p>å¦‚æœä¸€ä¸ªæ˜ å°„ç±»å‹çš„å…ƒç´ ç±»å‹ä¸ºä¸€ä¸ªæ•°ç»„ç±»å‹ï¼Œåˆ™æˆ‘ä»¬æ— æ³•ä¿®æ”¹æ­¤æ˜ å°„ç±»å‹çš„å€¼ä¸­çš„æ¯ä¸ªæ•°ç»„å…ƒ ç´ çš„å•ä¸ªå…ƒç´ ã€‚ æˆ‘ä»¬å¿…é¡»æ•´ä½“åœ°åŒæ—¶ä¿®æ”¹æ‰€æœ‰æ•°ç»„å…ƒç´ ã€‚</p></blockquote><h4 id="slice-copy"><a href="#slice-copy" class="headerlink" title="slice copy"></a>slice copy</h4><p><code>copy</code> å‡½æ•°å½¢å¼æ˜¯ <code>copy(dest, src)</code>. åœ¨ dest æ‹·è´åˆ° len ä¸ºæ­¢ï¼Œè¿”å›æ‹·è´çš„é•¿åº¦ã€‚</p><h4 id="for-loop"><a href="#for-loop" class="headerlink" title="for-loop"></a>for-loop</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> key, element = <span class="keyword">range</span> aContainer &#123; </span><br><span class="line"><span class="comment">// ä½¿ç”¨keyå’Œelement ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ cpp ä¸­ï¼Œæˆ‘ä»¬ä¼šæœ‰ï¼ˆå®é™…ä¸ŠåŠ å…¥ range ä¹‹åä¼šæ›´å¥½ä½¿ï¼‰ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">auto</span>&amp; p: container) &#123;&#125;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">const</span> <span class="keyword">auto</span>&amp; p: container) &#123;&#125;</span><br></pre></td></tr></table></figure><p>æ„Ÿè§‰ Go çš„ loop åŠŸèƒ½å­±å¼±å¾ˆå¤šï¼š</p><ul><li>å¦‚æœä½ éœ€è¦ä¿®æ”¹å€¼ï¼Œå…¶å®è¿˜æ˜¯è¦å€ŸåŠ© key</li></ul><blockquote><ol><li>å¦‚æœ aContainer æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œé‚£ä¹ˆåœ¨éå†è¿‡ç¨‹ä¸­å¯¹æ­¤æ•°ç»„å…ƒç´ çš„ä¿®æ”¹ä¸ä¼šä½“ç°åˆ°å¾ªç¯å˜é‡ ä¸­ã€‚ åŸå› æ˜¯æ­¤æ•°ç»„çš„å‰¯æœ¬(è¢«çœŸæ­£éå†çš„å®¹å™¨)å’Œæ­¤æ•°ç»„ä¸å…±äº«ä»»ä½•å…ƒç´ ã€‚</li><li>å¦‚æœ aContainer æ˜¯ä¸€ä¸ªåˆ‡ç‰‡(æˆ–è€…æ˜ å°„)ï¼Œé‚£ä¹ˆåœ¨éå†è¿‡ç¨‹ä¸­å¯¹æ­¤åˆ‡ç‰‡(æˆ–è€…æ˜ å°„)å…ƒç´  çš„ä¿®æ”¹å°†ä½“ç°åˆ°å¾ªç¯å˜é‡ä¸­ã€‚ åŸå› æ˜¯æ­¤åˆ‡ç‰‡(æˆ–è€…æ˜ å°„)çš„å‰¯æœ¬å’Œæ­¤åˆ‡ç‰‡(æˆ–è€…æ˜ å°„)å…± äº«å…ƒç´ (æˆ–æ¡ç›®)ã€‚</li><li>åœ¨éå†ä¸­çš„æ¯ä¸ªå¾ªç¯æ­¥ï¼Œ aContainer å‰¯æœ¬ä¸­çš„ä¸€ä¸ªé”®å€¼å…ƒç´ å¯¹å°†è¢«èµ‹å€¼(å¤åˆ¶)ç»™å¾ªç¯å˜é‡ã€‚ æ‰€ä»¥å¯¹å¾ªç¯å˜é‡çš„ç›´æ¥éƒ¨åˆ†çš„ä¿®æ”¹å°†ä¸ä¼šä½“ç°åœ¨aContainerä¸­çš„å¯¹åº”å…ƒç´ ä¸­ã€‚ (å› ä¸ºè¿™ä¸ªåŸ å› ï¼Œå¹¶ä¸” for-range å¾ªç¯æ˜¯éå†æ˜ å°„æ¡ç›®çš„å”¯ä¸€é€”å¾„ï¼Œæ‰€ä»¥æœ€å¥½ä¸è¦ä½¿ç”¨å¤§å°ºå¯¸çš„æ˜ å°„é”®å€¼å’Œå…ƒ ç´ ç±»å‹ï¼Œä»¥é¿å…è¾ƒå¤§çš„å¤åˆ¶è´Ÿæ‹…ã€‚)</li></ol></blockquote><p>è¿™é‡Œæœ‰ä¸€äº›ç»†èŠ‚ï¼š</p><blockquote><p>æ˜ å°„ä¸­çš„æ¡ç›®çš„éå†é¡ºåºæ˜¯ä¸ç¡®å®šçš„(å¯ä»¥è®¤ä¸ºæ˜¯éšæœºçš„)ã€‚æˆ–è€…è¯´ï¼ŒåŒä¸€ä¸ªæ˜ å°„ä¸­çš„æ¡ç›®çš„ä¸¤ æ¬¡éå†ä¸­ï¼Œæ¡ç›®çš„é¡ºåºå¾ˆå¯èƒ½æ˜¯ä¸ä¸€è‡´çš„ï¼Œå³ä½¿åœ¨è¿™ä¸¤æ¬¡éå†ä¹‹é—´ï¼Œæ­¤æ˜ å°„å¹¶æœªå‘ç”Ÿä»»ä½•æ”¹å˜ã€‚</p><p> å¦‚æœåœ¨ä¸€ä¸ªæ˜ å°„ä¸­çš„æ¡ç›®çš„éå†è¿‡ç¨‹ä¸­ï¼Œä¸€ä¸ªè¿˜æ²¡æœ‰è¢«éå†åˆ°çš„æ¡ç›®è¢«åˆ é™¤äº†ï¼Œåˆ™æ­¤æ¡ç›®ä¿è¯ä¸ ä¼šè¢«éå†å‡ºæ¥ã€‚</p><p>å¦‚æœåœ¨ä¸€ä¸ªæ˜ å°„ä¸­çš„æ¡ç›®çš„éå†è¿‡ç¨‹ä¸­ï¼Œä¸€ä¸ªæ–°çš„æ¡ç›®è¢«æ·»åŠ å…¥æ­¤æ˜ å°„ï¼Œåˆ™æ­¤æ¡ç›®å¹¶ä¸ä¿è¯å°†åœ¨ æ­¤éå†è¿‡ç¨‹ä¸­è¢«éå†å‡ºæ¥ã€‚</p></blockquote><p>å¾ªç¯å˜é‡æ˜¯å•ä¸ªçš„ï¼Œå®é™…ä¸Šä½ å¯ä»¥è¯•è¯•ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="comment">// å¯ä»¥ä½¿ç”¨ persons[:] æˆ–è€… &amp;persons é¿å…å¼€é”€</span></span><br><span class="line"><span class="keyword">for</span> i, p := <span class="keyword">range</span> persons &#123;</span><br><span class="line">fmt.Println(i, p)</span><br><span class="line"><span class="comment">// Note: ä¸æ”¹å˜éå†è¿‡ç¨‹ä¸­çš„å€¼</span></span><br><span class="line">persons[<span class="number">1</span>].name = <span class="string">&quot;Jack&quot;</span></span><br><span class="line">p.age = <span class="number">31</span></span><br><span class="line">&#125;</span><br><span class="line">fmt.Println(<span class="string">&quot;persons:&quot;</span>, &amp;persons)</span><br><span class="line"></span><br><span class="line">persons[<span class="number">1</span>].name = <span class="string">&quot;nmsl.xt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> personSlice []Person</span><br><span class="line">personSlice = persons[:]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i, p := <span class="keyword">range</span> personSlice &#123;</span><br><span class="line">fmt.Println(i, p)</span><br><span class="line"><span class="comment">// Note: ä¸æ”¹å˜éå†è¿‡ç¨‹ä¸­çš„å€¼</span></span><br><span class="line">personSlice[<span class="number">1</span>].name = <span class="string">&quot;Jack&quot;</span></span><br><span class="line">p.age = <span class="number">31</span></span><br><span class="line">&#125;</span><br><span class="line">fmt.Println(<span class="string">&quot;persons:&quot;</span>, &amp;personSlice)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Person <span class="keyword">struct</span> &#123;</span><br><span class="line">name <span class="type">string</span></span><br><span class="line">age <span class="type">int</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>è¯·æ³¨æ„ï¼Œä¸Šè¿°æ‰€æœ‰å„ç§å®¹å™¨æ“ä½œçš„å†…éƒ¨å®ç°éƒ½æœªè¿›è¡ŒåŒæ­¥ã€‚å¦‚æœä¸ä½¿ç”¨ä»Šåå°†è¦ä»‹ç»çš„å„ç§å¹¶å‘åŒæ­¥æŠ€ æœ¯ï¼Œåœ¨æ²¡æœ‰åç¨‹ä¿®æ”¹ä¸€ä¸ªå®¹å™¨å€¼å’Œå®ƒçš„å…ƒç´ çš„æ—¶å€™ï¼Œå¤šä¸ªåç¨‹å¹¶å‘è¯»å–æ­¤å®¹å™¨å€¼å’Œå®ƒçš„å…ƒç´ æ˜¯å®‰å…¨çš„ã€‚ ä½†æ˜¯å¹¶å‘ä¿®æ”¹åŒä¸€ä¸ªå®¹å™¨å€¼åˆ™æ˜¯ä¸å®‰å…¨çš„ã€‚</p></blockquote><p>éœ€è¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> k, v := <span class="keyword">range</span> container &#123;</span><br><span class="line">slice = <span class="built_in">append</span>(slice, &amp;v)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½ ä¼šå‘ç°ï¼Œå¦‚åŒé‚£ä¸ªç»å…¸çš„å¹¶å‘é”™è¯¯ä¸€æ ·ï¼Œä½  append äº†åŒä¸€ä¸ªå€¼ã€‚</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Distribute Transaction: basic of 2PC</title>
      <link href="/2020/04/06/Distribute-Transaction-basic-of-2PC/"/>
      <url>/2020/04/06/Distribute-Transaction-basic-of-2PC/</url>
      
        <content type="html"><![CDATA[<h1 id="Distributed-Transaction"><a href="#Distributed-Transaction" class="headerlink" title="Distributed Transaction"></a>Distributed Transaction</h1><p>éœ€æ±‚ï¼šè¦ä¹ˆå…¨éƒ¨æäº¤ï¼Œè¦ä¹ˆå…¨éƒ½ä¸æäº¤ã€‚äº‹åŠ¡çš„å„ä¸ªæˆåˆ†éƒ½æ˜¯åŸå­çš„ã€‚</p><p>å‡è®¾ï¼š</p><ol><li>æ¯ä¸ª Node è®°å½• Logï¼Œä½†æ˜¯å¾—ä¸åˆ°å…¨å±€çš„ Log</li><li>å…è®¸ <em>coordinator process</em> çš„å­˜åœ¨ï¼Œå®ƒå¯èƒ½æ˜¯äº‹åŠ¡çš„å‘èµ·è€…ï¼Œå…¶ä»–çš„ Node è¢«è§†ä¸º participants.</li><li>å‘é€æ¶ˆæ¯çš„æ—¶å€™ï¼Œå¯èƒ½éœ€è¦è®°å½•åˆ°æ—¥å¿—ä¸­</li></ol><p>2PC æœ‰ä¸¤ä¸ªé˜¶æ®µï¼š</p><ul><li>The <em>commit-request phase</em> (or <em>voting phase</em>)<ul><li>è¿™ä¸ªé˜¶æ®µ<em>coordinator</em> è¯•å›¾ prepare. ç»“æœæœ‰ä»¥ä¸‹ä¸¤ç§</li><li>â€œYesâ€: commit (if the transaction participantâ€™s local portion execution has ended properly)</li><li>â€œNoâ€: abort (if a problem has been detected with the local portion)</li></ul></li><li>The <em>commit phase</em> æ ¹æ®ä¹‹å‰æ”¶é›†åˆ°çš„ç»“æœæ¥å†³å®šæ˜¯å¦è¿›è¡Œæœ€ç»ˆçš„ Commit æˆ–è€… abort, å¹¶ä¸”æŠŠè¿™ä¸ªæ¶ˆæ¯ broadcast.</li></ul><p>ä¸Šé¢æ˜¯ 2PC çš„åˆçº§å°è±¡ï¼Œä½†æ˜¯ç»†æƒ³èµ·æ¥å…¶å®é—®é¢˜è›®å¤šçš„ï¼š</p><ul><li>participants â€œå¯ä»¥æäº¤â€ æ˜¯ä¸€ä¸ªä»€ä¹ˆæ ·çš„çŠ¶æ€ï¼Ÿ</li><li>å¯¹äº abort 2PC åº”è¯¥å¦‚ä½•å¤„ç†è¿™ä¸ªæ—¥å¿—ï¼Ÿ</li><li>å¹¶è¡Œçš„ 2PC æ˜¯ä»€ä¹ˆæ ·å­çš„ï¼Ÿå¯¹ Lock Manager æœ‰ä»€ä¹ˆå½±å“ï¼Ÿ</li></ul><p>ä¸‹é¢è¯¦ç»†è§£é‡Šä¸€ä¸‹ã€‚</p><h2 id="2PC-çš„ç»“æ„"><a href="#2PC-çš„ç»“æ„" class="headerlink" title="2PC çš„ç»“æ„"></a>2PC çš„ç»“æ„</h2><p><img src="https://image.mwish.me/blog-image/3149FDE05902E361F776579665A3F442.png" alt="3149FDE05902E361F776579665A3F442"></p><ol><li><code>coordinator</code> <ol><li>å†™<code>&lt;prepare TXN&gt;</code>  WAL</li><li>broadcast <code>prepare</code></li></ol></li><li><code>participants</code> æ”¶åˆ° <code>prepare</code><ol><li>æ‰§è¡Œäº‹åŠ¡ï¼Œå†™ undo log å’Œ redo log</li><li>å¦‚æœæ“ä½œæ˜¯æˆåŠŸçš„ï¼Œé‚£ä¹ˆäº‹åŠ¡è¿›å…¥ä¸€ä¸ª <code>pre-commit</code> çš„çŠ¶æ€ï¼š<ol><li>å³ä½¿ abort äº†ä¹Ÿèƒ½å¤Ÿæ¢å¤è¿™ä¸ªçŠ¶æ€</li><li>äº‹åŠ¡ä¼šå†™å…¥ä¸€ä¸ª <code>&lt;prepare TXN&gt;</code> çš„ log</li></ol></li><li>å¦‚æœæ“ä½œæ˜¯å¤±è´¥çš„ï¼Œé‚£ä¹ˆå†™å…¥ <code>&lt;don&#39;t commit TXN&gt;</code> å¹¶ä¸” abort</li><li>å¦‚æœä»¥ä¸Šæ“ä½œéƒ½æˆåŠŸï¼Œè¿”å›ä¸€ä¸ª <code>agreement</code>, å¦åˆ™è¿”å› <code>abort</code></li></ol></li></ol><p>å¯¹äº commit é˜¶æ®µï¼Œå®é™…ä¸Šé€»è¾‘å¦‚ä¸‹</p><ol><li><code>coordinator</code><ol><li>å¦‚æœéƒ½æ˜¯ <code>agreement</code>, é‚£ä¹ˆå†™ <code>&lt;Commit Txn&gt;</code> çš„ Log, å¦åˆ™å†™ <code>&lt;Abort Txn&gt;</code></li><li>å¹¿æ’­</li></ol></li><li><code>participants</code> æ”¶åˆ°åï¼Œæ‰§è¡Œå¯¹åº”é€»è¾‘ï¼Œå®Œæˆåè¿”å› <code>ACK</code></li></ol><p><img src="https://image.mwish.me/blog-image/14B5C5E1-CB99-4552-A969-A5A88D95D6F3.png" alt="14B5C5E1-CB99-4552-A969-A5A88D95D6F3"></p><h3 id="2PC-çš„æ¢å¤"><a href="#2PC-çš„æ¢å¤" class="headerlink" title="2PC çš„æ¢å¤"></a>2PC çš„æ¢å¤</h3><ol><li>å¦‚æœ Txn æœ‰ <code>&lt;don&#39;t commit TXN&gt;</code> <code>&lt;commit TXN&gt;</code> <code>&lt;abort TXN&gt;</code> çš„ Log, æƒ…å†µåº”è¯¥éå¸¸æ˜æ˜¾äº†ã€‚</li><li>å¦‚æœæ˜¯ <code>&lt;ready&gt;</code> çš„ log, éœ€è¦å’Œå…¶ä»–èŠ‚ç‚¹ä¸€èµ·å†³å®šçŠ¶å†µï¼ˆè¿™æ„å‘³ç€åè°ƒè€…çš„çŠ¶æ€æ˜¯ <code>wait</code>, è€Œå„ä¸ªèŠ‚ç‚¹éƒ½æ˜¯ <code>ready</code>ï¼‰</li><li>å¦‚æœæ²¡æœ‰ç›¸å…³çš„çŠ¶æ€ï¼Œé‚£ä¹ˆè‡³å°‘ <code>abort</code> å®ƒæ˜¯å®‰å…¨çš„ã€‚</li></ol><p>åœ¨ wiki ä¸Šä¹Ÿå¯ä»¥æ‰¾åˆ°ï¼š</p><blockquote><p><em>Presumed abort</em> or <em>Presumed commit</em> are common such optimizations.<a href="https://en.wikipedia.org/wiki/Two-phase_commit_protocol#cite_note-weikum2001-2">[2]</a><a href="https://en.wikipedia.org/wiki/Two-phase_commit_protocol#cite_note-Bern2009-3">[3]</a><a href="https://en.wikipedia.org/wiki/Two-phase_commit_protocol#cite_note-mohan1983-5">[5]</a> An assumption about the outcome of transactions, either commit, or abort, can save both messages and logging operations by the participants during the 2PC protocolâ€™s execution. For example, when presumed abort, if during system recovery from failure no logged evidence for commit of some transaction is found by the recovery procedure, then it assumes that the transaction has been aborted, and acts accordingly. This means that it does not matter if aborts are logged at all, and such logging can be saved under this assumption. Typically a penalty of additional operations is paid during recovery from failure, depending on optimization type. Thus the best variant of optimization, if any, is chosen according to failure and transaction outcome statistics.</p></blockquote><h3 id="Timeout"><a href="#Timeout" class="headerlink" title="Timeout"></a>Timeout</h3><blockquote><p>The greatest disadvantage of the two-phase commit protocol is that it is a blocking protocol. If the coordinator fails permanently, some participants will never resolve their transactions: After a participant has sent an <strong>agreement</strong> message to the coordinator, it will block until a <strong>commit</strong> or <strong>rollback</strong> is received.</p></blockquote><p>å¦‚æœåè°ƒè€…æ”¶åˆ°äº†ä¸€ä¸ª <code>abort</code>, å…¶å®è¿˜è›®æ¬¢å–œçš„ï¼šé‚£è‚¯å®šå¤§å®¶ä¸€èµ· abort ã€‚ä½†æ˜¯å¦‚æœå“ªä¸ªæœºå™¨æ†‹ç€æ²¡æ¶ˆæ¯äº†ï¼Œå“¦è±ï¼Œä½ å¾—ä¸€ç›´ block ç€ã€‚</p><p>æ‰€ä»¥ 2PC ä¸€å®šç¨‹åº¦ä¸Šå¯èƒ½éœ€è¦å¼•å…¥ timeoutï¼š</p><blockquote><p>å¯¹äºåè°ƒè€…æ¥è¯´å¦‚æœåœ¨æŒ‡å®šæ—¶é—´å†…æ²¡æœ‰æ”¶åˆ°æ‰€æœ‰å‚ä¸è€…çš„åº”ç­”ï¼Œåˆ™å¯ä»¥è‡ªåŠ¨é€€å‡º WAIT çŠ¶æ€ï¼Œå¹¶å‘æ‰€æœ‰å‚ä¸è€…å‘é€ rollback é€šçŸ¥ã€‚å¯¹äºå‚ä¸è€…æ¥è¯´å¦‚æœä½äº READY çŠ¶æ€ï¼Œä½†æ˜¯åœ¨æŒ‡å®šæ—¶é—´å†…æ²¡æœ‰æ”¶åˆ°åè°ƒè€…çš„ç¬¬äºŒé˜¶æ®µé€šçŸ¥ï¼Œåˆ™ä¸èƒ½æ­¦æ–­åœ°æ‰§è¡Œ rollback æ“ä½œï¼Œå› ä¸ºåè°ƒè€…å¯èƒ½å‘é€çš„æ˜¯ commit é€šçŸ¥ï¼Œè¿™ä¸ªæ—¶å€™æ‰§è¡Œ rollback å°±ä¼šå¯¼è‡´æ•°æ®ä¸ä¸€è‡´ã€‚</p><p>æ­¤æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥ä»‹å…¥äº’è¯¢æœºåˆ¶ï¼Œè®©å‚ä¸è€… A å»è¯¢é—®å…¶ä»–å‚ä¸è€… B çš„æ‰§è¡Œæƒ…å†µã€‚å¦‚æœ B æ‰§è¡Œäº† rollback æˆ– commit æ“ä½œï¼Œåˆ™ A å¯ä»¥å¤§èƒ†çš„ä¸ B æ‰§è¡Œç›¸åŒçš„æ“ä½œï¼›å¦‚æœ B æ­¤æ—¶è¿˜æ²¡æœ‰åˆ°è¾¾ READY çŠ¶æ€ï¼Œåˆ™å¯ä»¥æ¨æ–­å‡ºåè°ƒè€…å‘å‡ºçš„è‚¯å®šæ˜¯ rollback é€šçŸ¥ï¼›å¦‚æœ B åŒæ ·ä½äº READY çŠ¶æ€ï¼Œåˆ™ A å¯ä»¥ç»§ç»­è¯¢é—®å¦å¤–çš„å‚ä¸è€…ã€‚åªæœ‰å½“æ‰€æœ‰çš„å‚ä¸è€…éƒ½ä½äº READY çŠ¶æ€æ—¶ï¼Œæ­¤æ—¶ä¸¤é˜¶æ®µæäº¤åè®®æ— æ³•å¤„ç†ï¼Œå°†é™·å…¥é•¿æ—¶é—´çš„é˜»å¡çŠ¶æ€ã€‚</p></blockquote><h3 id="3PC-å’Œ-Pre-Commit"><a href="#3PC-å’Œ-Pre-Commit" class="headerlink" title="3PC å’Œ Pre Commit"></a>3PC å’Œ Pre Commit</h3><p>æˆ‘ä»¬ä¹‹å‰è¯´åˆ°ï¼Œå…¨æ˜¯<code>ready log</code> æ˜¯ä¸€ä¸ªå¥‡æ€ªçš„çŠ¶æ€ã€‚è¿™ä¸ªæ—¶å€™ä¸€å®šç¨‹åº¦ä¸Šå¯ä»¥å¼•å…¥ 3PCï¼š</p><p><a href="https://en.wikipedia.org/wiki/Three-phase_commit_protocol">https://en.wikipedia.org/wiki/Three-phase_commit_protocol</a></p><blockquote><p>A <a href="https://en.wikipedia.org/wiki/Two-phase_commit_protocol">two-phase commit protocol</a> cannot dependably recover from a failure of both the coordinator and a cohort member during the <strong>Commit phase</strong>. If only the coordinator had failed, and no cohort members had received a commit message, it could safely be inferred that no commit had happened. If, however, both the coordinator and a cohort member failed, it is possible that the failed cohort member was the first to be notified, and had actually done the commit. Even if a new coordinator is selected, it cannot confidently proceed with the operation until it has received an agreement from all cohort members, and hence must block until all cohort members respond.</p><p>The three-phase commit protocol eliminates this problem by introducing the Prepared to commit state. If the coordinator fails before sending preCommit messages, the cohort will unanimously agree that the operation was aborted. The coordinator will not send out a doCommit message until all cohort members have <strong>ACK</strong>ed that they are <strong>Prepared to commit</strong>. This eliminates the possibility that any cohort member actually completed the transaction before all cohort members were aware of the decision to do so (an ambiguity that necessitated indefinite blocking in the <a href="https://en.wikipedia.org/wiki/Two-phase_commit_protocol">two-phase commit protocol</a>).</p></blockquote><p><strong>Prepared to commit</strong> è¿™ä¸ªçŠ¶æ€è¡¨ç¤º, precommit æˆåŠŸäº†å°±åªèƒ½ commit äº†ï¼Œå¦åˆ™æ˜¯åº”è¯¥ abort çš„ã€‚</p><h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul><li><a href="https://segmentfault.com/a/1190000012534071">https://segmentfault.com/a/1190000012534071</a></li><li><a href="https://en.wikipedia.org/wiki/Two-phase_commit_protocol">https://en.wikipedia.org/wiki/Two-phase_commit_protocol</a></li><li><a href="https://en.wikipedia.org/wiki/Three-phase_commit_protocol">https://en.wikipedia.org/wiki/Three-phase_commit_protocol</a></li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> distributed </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CALL: libc å’Œ C++ æ ‡å‡†åº“</title>
      <link href="/2020/04/04/CALL-libc-%E5%92%8C-C-%E6%A0%87%E5%87%86%E5%BA%93/"/>
      <url>/2020/04/04/CALL-libc-%E5%92%8C-C-%E6%A0%87%E5%87%86%E5%BA%93/</url>
      
        <content type="html"><![CDATA[<p>CALL æ˜¯ <strong>(Compiler/Assembler/Linker/Loader)</strong>çš„ç®€ç§°ã€‚å¦‚æœä½ å’Œ C/C++ æ‰“è¿‡äº¤é“çš„è¯ï¼Œæ²¡æœ‰ç†ç”±ä¼šå¯¹è¿™å‡ ä¸ªè¯å¤ªé™Œç”Ÿã€‚æ‰€ä»¥ä»Šå¤©è¿™æ˜¯ä¸€ç¯‡æ°´æ–‡ã€‚</p><h2 id="Levels-of-Representation-Interpretation"><a href="#Levels-of-Representation-Interpretation" class="headerlink" title="Levels of Representation/Interpretation"></a>Levels of Representation/Interpretation</h2><p><img src="https://image.mwish.me/blog-image/level.png" alt="level"></p><ul><li>â€œXX æ˜¯ä¸€é—¨ è§£é‡Šå‹è¯­è¨€â€</li><li>â€œXX æ˜¯ç¼–è¯‘å‹è¯­è¨€â€</li></ul><p>æŠ›å¼€æ­£ç¡®æ€§ï¼Œä¸€å®šç¨‹åº¦ä¸Šæˆ‘ä»¬å¯ä»¥å°è¯•å¡«ç©ºï¼ˆPython / C++ã€Goï¼‰å¹¶ä¸”çŸ¥é“ï¼š</p><ul><li>Python å¯èƒ½ä¼šè¿è¡Œä¸€ä¸ªè§£é‡Šå™¨ï¼ˆå®˜æ–¹æ˜¯ CPython, å¯èƒ½æœ‰ Pypy è¿™æ ·çš„ï¼‰ï¼Œç„¶åè§£é‡Š Python çš„å­—èŠ‚ç </li><li>C++ã€Go ä¼šç¼–è¯‘æˆ binary, å°±æˆ‘ç†è§£ï¼Œè¿™æ˜¯â€œæœºå™¨ä¸Šçš„å­—èŠ‚ç â€(è¿™æ˜¯è·Ÿ Python å­—èŠ‚ç å¯¹åº”çš„ï¼Œå®é™…æƒ…å†µå¯èƒ½æ‰‹æ˜¯åè¿‡æ¥çš„), ç„¶åæ‰§è¡Œã€‚è¿™å…¶ä¸­ Go å¯èƒ½ä¼šæœ‰ Runtimeã€GC è¿™æ ·çš„å¼€é”€ã€‚</li></ul><p>ä½†æ˜¯åŒæ—¶ï¼ŒPython ä¹Ÿèƒ½é€šè¿‡ä¸€äº›æ–¹å¼æ‰“åŒ…æˆ exe ï¼ˆè™½ç„¶å¾ˆå·¨å¤§ï¼‰ï¼ŒåŒæ—¶ LLVM è¿™äº›å±‚æ¬¡çš„å¼•å…¥è®©æˆ‘ä»¬çš„ç†è§£æ¨¡ç³Šäº†èµ·æ¥ã€‚æ‰€ä»¥æˆ‘ä»¬è¦æ˜ç¡®ä¸€ä¸‹è¿™ä¸ª Levelã€‚</p><p><img src="https://image.mwish.me/blog-image/A6642C36-5B8D-4168-877C-9D3FCCD84A44.png" alt="A6642C36-5B8D-4168-877C-9D3FCCD84A44"></p><blockquote><ul><li>Language translation gives us another option</li><li>In general, we interpret a high-level language when efficiency is not critical and translate to a lower-level language to increase performance</li><li>Although this is becoming a â€œdistinction without a differenceâ€â€¨ Many intepreters do a â€œjust in timeâ€ runtime compilation to bytecode that either is emulated or directly compiled to machine code (e.g. LLVM)</li></ul></blockquote><p>æ‰€ä»¥è¿™ä¸ªé—®é¢˜å®é™…ä¸Šæ˜¯å¾ˆå«ç³Šä¸æ¸…çš„ï¼Œç¬¬ä¸‰ç‚¹é‡Œé¢ JIT ç­‰çš„å¼•å…¥æ›´è®©äº‹æƒ…æ‰‘æœ”è¿·ç¦»äº†èµ·æ¥ã€‚å…·ä½“å…¶å®å¯ä»¥å‚è€ƒè¿™ä¸ªé“¾æ¥é‡Œçš„è¯´æ³•ï¼š<a href="https://www.zhihu.com/question/19608553ã€‚">https://www.zhihu.com/question/19608553ã€‚</a></p><blockquote><p>ä¸€èˆ¬è¢«ç§°ä¸ºâ€œè§£é‡Šå‹è¯­è¨€â€çš„æ˜¯ä¸»æµå®ç°ä¸ºè§£é‡Šå™¨çš„è¯­è¨€ï¼Œä½†å¹¶ä¸æ˜¯è¯´å®ƒå°±æ— æ³•ç¼–è¯‘ã€‚ä¾‹å¦‚è¯´ç»å¸¸è¢«è®¤ä¸ºæ˜¯â€œè§£é‡Šå‹è¯­è¨€â€çš„<a href="http://schemers.org/">Scheme</a>å°±æœ‰å¥½å‡ ç§ç¼–è¯‘å™¨å®ç°ï¼Œå…¶ä¸­ç‡å…ˆæ”¯æŒ<a href="http://www.r6rs.org/">R6RS</a>è§„èŒƒçš„å¤§éƒ¨åˆ†å†…å®¹çš„æ˜¯<a href="http://ikarus-scheme.org/">Ikarus</a>ï¼Œæ”¯æŒåœ¨x86ä¸Šç¼–è¯‘Schemeï¼›å®ƒæœ€ç»ˆä¸æ˜¯ç”ŸæˆæŸç§è™šæ‹Ÿæœºçš„å­—èŠ‚ç ï¼Œè€Œæ˜¯ç›´æ¥ç”Ÿæˆx86æœºå™¨ç ã€‚</p></blockquote><p>å®é™…ä¸Šè§£é‡Šå™¨çš„æ€§èƒ½åŠ£åŠ¿ä¹Ÿä¸ä¸€å®šæ˜¯ä¸€ç§åäº‹ï¼Œåƒæˆ‘å»å¹´å» PyCon å¬çš„â€œæ…¢è§£é‡Šæ˜¯ä¸€ç§ä¼˜åŠ¿â€ï¼Œè™½ç„¶æœ‰ç‚¹ç ´ç½å­ç ´æ‘”çš„å‘³é“ï¼Œä½†æ˜¯å¦‚æœä½ åœ¨ C/C++ ä¸‹å¼€ asan/valgrind æˆ–è€…å¸¦ <code>gcc -g</code>, å’Œ Go è¿™ç§å¸¦ Runtime çš„ã€V8è¿™äº›å¯ä»¥æä¾›çš„debugæ¯”è¾ƒï¼Œéš¾å…ä¼šæœ‰ç¾¡æ…•çš„æƒ³æ³•ã€‚</p><blockquote><p>Interpreter provides instruction set independence: run on any machine</p></blockquote><p>å°±æ˜¯è¿™æ ·ã€‚</p><h2 id="CALL-chain"><a href="#CALL-chain" class="headerlink" title="CALL chain"></a>CALL chain</h2><p><img src="https://image.mwish.me/blog-image/8009A6B1-A4E5-46A4-A40F-BD41F4E01D34.png" alt="8009A6B1-A4E5-46A4-A40F-BD41F4E01D34"></p><p>è¿™æ˜¯ä¸€å¼ æ°´å›¾ã€‚å¯èƒ½è¿˜è¦å¤„ç†ä¸€ä¸‹é¢„å¤„ç†ä¹‹ç±»çš„è¿‡ç¨‹ï¼Œä½†æ˜¯å¤§æ¦‚æµç¨‹æ˜¯è¿™æ ·æ²¡é”™ã€‚</p><h3 id="Compile"><a href="#Compile" class="headerlink" title="Compile"></a>Compile</h3><p>Compile çš„è¿‡ç¨‹å¤§æ¦‚æ˜¯</p><ul><li>Lexer</li><li>Parser</li><li>Semantic Analysis and Optimization</li><li>Code generation</li></ul><p>ä¸è¿‡çœ‹ä¸Šé¢è½¬çš„é‚£ç¯‡æ–‡ç« ï¼Œä¼¼ä¹å½¢å¼æœ‰å˜ï¼Œè¿™æ–¹é¢æˆ‘ä¸æ˜¯å¾ˆäº†è§£ã€‚Lexer/Parser çš„éƒ¨åˆ†å¯ä»¥å‚è€ƒæˆ‘ä¹‹å‰çš„ Lex/Yacc å…¥é—¨ã€‚æ€»ä¹‹ï¼Œæˆ‘ä»¬ç°åœ¨æŠŠæºä»£ç ç¼–è¯‘åå¯ä»¥è½¬åŒ–ä¸ºä¸€ç§å¯¹åº”çš„ IR, å³ <code>nmsl.c</code> -&gt; <code>nmsl.S</code>.</p><h3 id="Assembler"><a href="#Assembler" class="headerlink" title="Assembler"></a>Assembler</h3><p>Assembler æ¥ä¸‹æ¥ä¼š<code>nmsl.s</code> -&gt; <code>nmsl.o</code>.</p><ul><li>Reads and Uses Directives</li><li>Replace Pseudo-instructions</li><li>Produce <strong>Machine Language</strong> rather than just <strong>Assembly Language</strong></li><li>Creates Object File</li></ul><p>é¡ºä¾¿ç»™å‡ºè¿™ä¸ª part ä¸€ä¸ªå¾ˆæœ‰æ„æ€çš„ slide:</p><p><img src="https://image.mwish.me/blog-image/é¡ºä¾¿.png" alt="é¡ºä¾¿"></p><h4 id="ELF"><a href="#ELF" class="headerlink" title="ELF"></a>ELF</h4><blockquote><ul><li>object file header: size and position of the other pieces of the object file</li><li>text segment: the machine code</li><li>data segment: binary representation of the static data in the source file</li><li><p>relocation information: identifies lines of code that need to be fixed up later</p></li><li><p>symbol table: list of this fileâ€™s labels and static data that can be referenced</p></li><li>debugging information</li><li>A standard format is ELF (except Microsoft)â€¨ <a href="http://www.skyfree.org/linux/references/ELF_Format.pdf">http://www.skyfree.org/linux/references/ELF_Format.pdf</a></li></ul></blockquote><p>è¿™ä¸ªæˆ‘è§‰å¾—è¿˜æ˜¯ csapp å†™å¾—å¥½â€¦æ€»ä¹‹ç”Ÿæˆçš„ç›®æ ‡æ–‡ä»¶ä¼šæ»¡è¶³è¿™æ ·çš„å½¢å¼ã€‚</p><h3 id="Linker"><a href="#Linker" class="headerlink" title="Linker"></a>Linker</h3><blockquote><p> Combines several object (.o) files into a single executable (â€œlinkingâ€)</p></blockquote><p><img src="https://image.mwish.me/blog-image/5B0267D5-78CF-4CB7-97B7-69D4D5D1DF88.png" alt="5B0267D5-78CF-4CB7-97B7-69D4D5D1DF88"></p><blockquote><ul><li>Step 1: Take text segment from each .o file and put them together</li><li>Step 2: Take data segment from each .o file, put them together, and concatenate this onto end of text segments</li><li>Step 3: Resolve references<ul><li>Go through Relocation Table; handle each entry</li><li>That is, fill in all absolute addresses</li></ul></li></ul></blockquote><p>è¿™æ®µæˆ‘æ„Ÿè§‰ CSAPP è®²çš„ç¨å¾®è¯¦ç»†ä¸€äº›ã€‚</p><p>åœ¨åº”ç”¨å±‚é¢ä¸Šï¼Œè¿™é‡Œå…¶å®è¿˜æ¶‰åŠï¼ˆä¸ä¸€å®šæ˜¯è¿™é‡Œå¼•å…¥çš„ï¼‰name manglingï¼Œcalling conventionè¿™ç§ C/C++ ç›¸å…³çš„é—®é¢˜ï¼Œæ‰€ä»¥å¯èƒ½ <code>extern &quot;C&quot;</code> åœ¨è¿™ç§æƒ…å†µä¸‹å°±ç›¸å¯¹å¾ˆå¥½ç†è§£äº†ã€‚</p><h3 id="Loader"><a href="#Loader" class="headerlink" title="Loader"></a>Loader</h3><blockquote><p>When one is run, loaderâ€™s job is to load it into memory and start it running</p><p>In reality, loader is the operating system (OS)</p><ul><li>loading is one of the OS tasks</li><li>And these days, the loader actually does a lot of the linking:â€¨ Linkerâ€™s â€˜executableâ€™ is actually only partially linked, instead still having external references</li></ul></blockquote><p>è¿™é‡Œå¯ä»¥å‚è€ƒ CSAPP é‡Œé¢é“¾æ¥çš„æ—¶æœºç›¸å…³çš„æ¦‚å¿µã€‚</p><h3 id="libc-libc"><a href="#libc-libc" class="headerlink" title="libc/libc++"></a>libc/libc++</h3><p><code>qsort</code> æ˜¯ä¸€ä¸ª <code>&lt;cstdlib&gt;</code> ä¸‹çš„å‡½æ•°ï¼Œå¦‚æœä½ å» libc++ æ‰¾çš„è¯ï¼Œä¼šå‘ç°äº‹æƒ…å¥½åƒä¸å¤ªå¯¹ï¼š</p><p><a href="https://github.com/llvm-mirror/libcxx/blob/7c3769df62c0b3820130aa868397a80a042e0232/include/cstdlib">https://github.com/llvm-mirror/libcxx/blob/7c3769df62c0b3820130aa868397a80a042e0232/include/cstdlib</a></p><p>è¿™é‡Œåªæœ‰ <code>using</code> å’Œå‡½æ•°å£°æ˜ï¼Œæ²¡æœ‰å¯¹åº”çš„å®ç°ã€‚</p><p>å®é™…ä¸Š C++ çš„æ ‡å‡†åº“ï¼ˆä»¥ libc++ï¼‰ ä¸ºä¾‹ï¼Œå¯èƒ½ä¼šæ ¹æ®æ¨¡ç‰ˆç”Ÿæˆéœ€è¦çš„å‡½æ•°/ç±»ã€‚æ‰€ä»¥æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å¯¹åº”çš„ä¸€äº›æºä»£ç ã€‚</p><p>Cè¯­è¨€çš„åº“å‡½æ•°å®é™…ä¸Šé€šå¸¸ä»¥é“¾æ¥åº“çš„å½¢å¼åœ¨ libc ä¸­æä¾›ï¼Œé“¾æ¥çš„æ—¶å€™æˆ‘ä»¬æ‰¾åˆ°ï¼š<a href="https://stackoverflow.com/questions/26277283/gcc-linking-libc-static-and-some-other-library-dynamically-revisited">https://stackoverflow.com/questions/26277283/gcc-linking-libc-static-and-some-other-library-dynamically-revisited</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> system </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>RISC-V GetStart</title>
      <link href="/2020/03/28/RISC-V-GetStart/"/>
      <url>/2020/03/28/RISC-V-GetStart/</url>
      
        <content type="html"><![CDATA[<h1 id="RISC-V-and-C-Toolchains"><a href="#RISC-V-and-C-Toolchains" class="headerlink" title="RISC-V and C Toolchains"></a>RISC-V and C Toolchains</h1><h2 id="ISA-amp-amp-RISC-V"><a href="#ISA-amp-amp-RISC-V" class="headerlink" title="ISA &amp;&amp; RISC-V"></a>ISA &amp;&amp; RISC-V</h2><p>æŒ‡ä»¤(Instruction) æ˜¯ CPU çš„ primitives operations, æˆ‘ä»¬å¯ä»¥çŸ¥é“æœ‰è¿™æ ·çš„ä¿éšœï¼š</p><ul><li>æŒ‡ä»¤é¡ºåºæ‰§è¡Œ</li><li>æ¯æ¡æŒ‡ä»¤å®Œæˆå¾ˆè½»é‡çš„ã€åŸºæœ¬çš„æ“ä½œ</li><li>æ¯æ¡æŒ‡ä»¤ä¼šä½œç”¨åœ¨ operand ä¸Šï¼Œç”šè‡³å¯èƒ½å˜æ›´æŒ‡ä»¤çš„é¡ºåºã€‚</li></ul><p>CPU ä¼šæœ‰æŸä¸ª â€œfamilyâ€, å®ç°äº†å®ƒè‡ªå·±çš„ instruction setã€‚è¿™ä¸ªç‹¬ç‰¹çš„ instruction set åˆå®ç°äº†æŸä¸ªå…·ä½“çš„ ISAï¼Œä¾‹å¦‚ï¼š</p><ol><li>ARM, Intel x86, MIPS, RISC-V, IBM/Motorola PowerPC (old Mac), Intel IA64</li></ol><p>RISC-V å¸Œæœ›ä¿è¯ç®€æ´çš„ç‰¹æ€§(ä»¥ä¸‹æ‘˜è‡ª RISC-V v2p1)ï¼š</p><blockquote><p>RISC-Vçš„ä¸åŒå¯»å¸¸ä¹‹å¤„ï¼Œé™¤äº†åœ¨äºå®ƒæ˜¯æœ€è¿‘è¯ç”Ÿçš„å’Œå¼€æºçš„ä»¥å¤–ï¼Œè¿˜åœ¨äº:å’Œå‡ ä¹æ‰€ æœ‰ä»¥å¾€çš„ISAä¸åŒï¼Œå®ƒæ˜¯æ¨¡å—åŒ–çš„ã€‚å®ƒçš„æ ¸å¿ƒæ˜¯ä¸€ä¸ªåä¸º<em>RV32I</em>çš„åŸºç¡€ISAï¼Œè¿è¡Œä¸€ä¸ªå®Œæ•´ çš„è½¯ä»¶æ ˆã€‚RV32Iæ˜¯å›ºå®šçš„ï¼Œæ°¸è¿œä¸ä¼šæ”¹å˜ã€‚è¿™ä¸ºç¼–è¯‘å™¨ç¼–å†™è€…ï¼Œæ“ä½œç³»ç»Ÿå¼€å‘äººå‘˜å’Œæ±‡ ç¼–è¯­è¨€ç¨‹åºå‘˜æä¾›äº†ç¨³å®šçš„ç›®æ ‡ã€‚æ¨¡å—åŒ–æ¥æºäºå¯é€‰çš„æ ‡å‡†æ‰©å±•ï¼Œæ ¹æ®åº”ç”¨ç¨‹åºçš„éœ€è¦ï¼Œ ç¡¬ä»¶å¯ä»¥åŒ…å«æˆ–ä¸åŒ…å«è¿™äº›æ‰©å±•ã€‚è¿™ç§æ¨¡å—åŒ–ç‰¹æ€§ä½¿å¾—RISC-Vå…·æœ‰äº†è¢–çåŒ–ã€ä½èƒ½è€—çš„ç‰¹ ç‚¹ï¼Œè€Œè¿™å¯¹äºåµŒå…¥å¼åº”ç”¨å¯èƒ½è‡³å…³é‡è¦ã€‚RISC-Vç¼–è¯‘å™¨å¾—çŸ¥å½“å‰ç¡¬ä»¶åŒ…å«å“ªäº›æ‰©å±•åï¼Œä¾¿ å¯ä»¥ç”Ÿæˆå½“å‰ç¡¬ä»¶æ¡ä»¶ä¸‹çš„æœ€ä½³ä»£ç ã€‚æƒ¯ä¾‹æ˜¯æŠŠä»£è¡¨æ‰©å±•çš„å­—æ¯é™„åŠ åˆ°æŒ‡ä»¤é›†åç§°ä¹‹åä½œ ä¸ºæŒ‡ç¤ºã€‚ä¾‹å¦‚ï¼ŒRV32IMFDå°†ä¹˜æ³•(RV32M)ï¼Œå•ç²¾åº¦æµ®ç‚¹(RV32F)å’ŒåŒç²¾åº¦æµ®ç‚¹ (RV32D)çš„æ‰©å±•æ·»åŠ åˆ°äº†åŸºç¡€æŒ‡ä»¤é›†(RV32I)ä¸­ã€‚</p></blockquote><h2 id="RISC-V-basic-RV32I"><a href="#RISC-V-basic-RV32I" class="headerlink" title="RISC-V basic: RV32I"></a>RISC-V basic: RV32I</h2><p><img src="https://image.mwish.me/blog-image/å¯„å­˜å™¨æ¨¡å‹.png" alt="å¯„å­˜å™¨æ¨¡å‹"></p><ul><li>Registers: 32 wordsï¼Œæ¯ä¸ªé•¿åº¦æ˜¯ 32bitsã€‚ï¼ˆéåŸºç¡€çš„æœ‰16bitçš„å‹ç¼©æŒ‡ä»¤å’Œ 64bit ç”šè‡³æ›´å¤§çš„æŒ‡ä»¤ï¼‰</li><li>Memory: Huge</li></ul><p>è®¿é—® registers å’Œ memory çš„é€Ÿåº¦å¤§æ¦‚å·®è· 100-500å€</p><p>RISC-V æœ‰ 32ä¸ª <strong>RV32I</strong> å¯„å­˜å™¨, åç§°æ˜¯ <code>x0</code>-<code>x31</code></p><blockquote><p>x0 is special, always holds the value zero<br> â€¢ So really only 31 registers able to hold variable values</p></blockquote><p>æ³¨æ„ 6.828 å¯èƒ½ä¼šæœ‰å¯¹åº”çš„ name, ä¸‹é¢å¯¹åŸå› æœ‰ä¸€å®šçš„è§£é‡Š</p><blockquote><p>Registers are also given symbolic names:â€¨<br> These will be described later and are a â€œconventionâ€/â€œABIâ€ (Application Binary Interface): â€¨ Not actually enforced in hardware but needed to follow to keep things consistent</p></blockquote><p>Register æœ¬èº«æ˜¯æ²¡æœ‰ç±»å‹çš„ï¼ˆåºŸè¯ï¼‰ã€‚</p><ul><li>RISC-V does not <strong>require</strong> that integers be word aligned</li><li>ä½†æ˜¯ï¼Œå¦‚æœä¸ alignï¼Œå¯¹ atomicity æ”¯æŒç¼ºä¹ï¼ŒåŒæ—¶ load æ“ä½œä¼šæ…¢ä¸Šå¾ˆå¤šã€‚</li></ul><p>So in <strong>practice</strong>, RISC-V requires integers to be aligned on 4-byte boundaries</p><h3 id="RISC-V-Instructions"><a href="#RISC-V-Instructions" class="headerlink" title="RISC-V Instructions"></a>RISC-V Instructions</h3><p>Instructions are fixed, 32b long ï¼ˆè¯è¯´ä¼¼ä¹ b æ˜¯ bit, B æ˜¯ Byteï¼‰</p><p><img src="https://image.mwish.me/blog-image/8C6F3A35-2220-475D-A75B-C1E09A1E6B69.png" alt="8C6F3A35-2220-475D-A75B-C1E09A1E6B69"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">add x1, x2, x3</span><br></pre></td></tr></table></figure><p><code>x1 = x2 + x3</code> ä¸ä¸Šé¢ç­‰ä»·. add æ˜¯ operation code (opcode), x1 æ˜¯ destination register, <code>x2</code> <code>x3</code> æ˜¯ç¬¬ä¸€ã€ç¬¬äºŒä¸ª operand registerã€‚ä»¥ä¸Šçš„æ ¼å¼è¢«ç§°ä¸º assembly comment syntax</p><p><code>x0</code> åœ¨ RISC-V ä¸­ä»£è¡¨ no-op, å°±æ˜¯â€œè¯»æ˜¯0ï¼Œä»€ä¹ˆéƒ½ä¸å†™â€ã€‚å®é™…ä¸Šï¼ŒRISC-V æ ¸å¿ƒçš„æŒ‡ä»¤å¾ˆç²¾ç®€ï¼Œå®ƒä¾é  <code>x0</code> æ¥å®ç°å¾ˆå¤šä¼ªæŒ‡ä»¤ã€‚</p><h4 id="ç«‹å³æ•°-immediates-å’Œå¸¸é‡æ„å»º"><a href="#ç«‹å³æ•°-immediates-å’Œå¸¸é‡æ„å»º" class="headerlink" title="ç«‹å³æ•°(immediates) å’Œå¸¸é‡æ„å»º"></a>ç«‹å³æ•°(immediates) å’Œå¸¸é‡æ„å»º</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">addi x3, x4, -10</span><br></pre></td></tr></table></figure><p>ç›¸å½“äº <code>f = g - 10</code>ï¼Œå½“ç„¶è¿™é‡Œæœ‰ä¸ªé—®é¢˜å°±æ˜¯è¿™ä¸ªç«‹å³æ•°èƒ½æœ‰å¤šå¤§å‘¢ï¼Ÿ RISC-V 32 ä¸­æŒ‡ä»¤æ˜¯å®šé•¿çš„ï¼Œè™½ç„¶æˆ‘ä»¬æœ‰å‹ç¼©æŒ‡ä»¤ä¹‹ç±»çš„æ”¯æŒï¼Œä½†æ˜¯ <code>imm</code> å ç”¨çš„ bytes ä»ç„¶æ˜¯å—é™çš„ï¼Œæ˜¾ç„¶ï¼Œå®ƒæ²¡æœ‰èƒ½åŠ›è¡¨ç¤º 32 ä½é•¿åº¦çš„æ•°æ®ï¼šä¸€ä¸ª I-type çš„æŒ‡ä»¤åªæœ‰ 12bits æ¥ä¿å­˜ç«‹å³æ•°ã€‚</p><p>é‚£è‚¯å®šæˆ‘ä»¬è¿˜éœ€è¦æ„å»ºä¸€ä¸ª 32bit çš„æ•°å§ï¼å¯ä»¥çœ‹çœ‹å¦‚ä¸‹ï¼š</p><blockquote><p>å›¾ 2.1 å‰©ä¸‹çš„ä¸¤æ¡æ•´æ•°è®¡ç®—æŒ‡ä»¤ä¸»è¦ç”¨äºæ„é€ å¤§çš„å¸¸é‡æ•°å€¼å’Œé“¾æ¥ã€‚åŠ è½½ç«‹å³æ•°åˆ°é«˜ ä½(lui)å°† 20 ä½å¸¸é‡åŠ è½½åˆ°å¯„å­˜å™¨çš„é«˜ 20 ä½ã€‚æ¥ç€ä¾¿å¯ä»¥ä½¿ç”¨æ ‡å‡†çš„ç«‹å³æŒ‡ä»¤æ¥åˆ›å»º 32 ä½å¸¸é‡ã€‚è¿™æ ·å­ï¼Œä»…ä½¿ç”¨ 2 æ¡ 32 ä½ RV32I æŒ‡ä»¤ï¼Œä¾¿å¯æ„é€ ä¸€ä¸ª 32 ä½å¸¸é‡ã€‚å‘ PC é«˜ä½åŠ  ä¸Šç«‹å³æ•°(auipc)è®©æˆ‘ä»¬ä»…ç”¨ä¸¤æ¡æŒ‡ä»¤ï¼Œä¾¿å¯ä»¥åŸºäºå½“å‰ PC ä»¥ä»»æ„åç§»é‡è½¬ç§»æ§åˆ¶æµæˆ– è€…è®¿é—®æ•°æ®ã€‚å°† auipc ä¸­çš„ 20 ä½ç«‹å³æ•°ä¸ jalr(å‚è§ä¸‹é¢)ä¸­ 12 ä½ç«‹å³æ•°çš„ç»„åˆï¼Œæˆ‘ä»¬ å¯ä»¥å°†æ‰§è¡Œæµè½¬ç§»åˆ°ä»»ä½• 32 ä½ PC ç›¸å¯¹åœ°å€ã€‚è€Œ auipc åŠ ä¸Šæ™®é€šåŠ è½½æˆ–å­˜å‚¨æŒ‡ä»¤ä¸­çš„ 12 ä½ç«‹å³æ•°åç§»é‡ï¼Œä½¿æˆ‘ä»¬å¯ä»¥è®¿é—®ä»»ä½• 32 ä½ PC ç›¸å¯¹åœ°å€çš„æ•°æ®ã€‚</p></blockquote><h3 id="data-transfer"><a href="#data-transfer" class="headerlink" title="data transfer"></a>data transfer</h3><p><img src="https://image.mwish.me/blog-image/853BC117-2DE0-49B5-AD9C-B3D24C18BE16.png" alt="853BC117-2DE0-49B5-AD9C-B3D24C18BE16"></p><p>å¾ˆæ­£å¸¸çš„æ€è·¯æ˜¯ï¼Œè¦ä»å†…å­˜ â€” å¯„å­˜å™¨è¯»å†™æ•°æ®ï¼Œè€Œä¸”åœ°å€æ˜¯ 32ä½çš„ ï¼ˆè‚¯å®šä¸èƒ½ç»™ç«‹å³æ•°äº†ï¼‰</p><ul><li>1 word = 4bytes</li><li>Data typically smaller than 32 bits, but rarely smaller than 8 bits</li><li>Memory addresses are reallyâ€¨ in bytes, not words</li></ul><p>ä¸‹é¢çš„<code>lw</code> <code>sw</code> è¡¨ç¤º <code>load</code> <code>store</code> å•ä½ä¸º <code>word</code> çš„æ•°æ®</p><p>æ³¨æ„ï¼Œè¿™é‡Œæåˆ° RISC-V æ˜¯ Little-Endian çš„ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬ä»ä¸‹å¤´è¯» <code>0x000408012</code></p><p><img src="https://image.mwish.me/blog-image/9BB275BA-B363-4E42-B421-7A75C4D0F1CC.png" alt="9BB275BA-B363-4E42-B421-7A75C4D0F1CC"></p><p>éšä¾¿ä»çŸ¥ä¹æ‰¾çš„å›¾</p><p><img src="https://image.mwish.me/blog-image/éšä¾¿ä»çŸ¥ä¹æ‰¾çš„å›¾.jpg" alt="éšä¾¿ä»çŸ¥ä¹æ‰¾çš„å›¾"></p><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸€ä¸ª int 0x03f5</p><p>æ˜¯ï¼š</p><ul><li>f5 : 0</li><li>03 : 1</li><li>00 : 2</li><li>00 : 3</li></ul><p>å®é™…ä¸Š BigEndian LittleEndian å¯ä»¥çœ‹ä¹‹å‰ Post çš„é‚£ç¯‡æ–‡ç« : <a href="https://zhuanlan.zhihu.com/p/254144597">https://zhuanlan.zhihu.com/p/254144597</a></p><p><img src="https://image.mwish.me/blog-image/1D6C494E-FAEE-4D74-ACD9-F9FD987A591B.png" alt="1D6C494E-FAEE-4D74-ACD9-F9FD987A591B"></p><p><code>int</code> å¦‚æœæ˜¯ 32 bit çš„ï¼Œé‚£ä¹ˆ 1word = 4byte, æ˜¾ç„¶åˆç†å¯¹å§ï¼Œä¸Šé¢è¿™æ®µä¹Ÿå¾ˆå¥½æ‡‚ã€‚</p><ul><li>lw æ˜¯ reg &lt;- memory on address</li><li>sw æ˜¯ reg value -&gt; memory on address</li></ul><p>è¿˜æœ‰ <code>lb</code> <code>sb</code> , å¾ˆå¥½æ‡‚å¯¹å§ï¼Œå°±ä¸å¤šè§£é‡Šäº†ã€‚</p><blockquote><p>RISC-V also has â€œunsigned byteâ€ loads (<strong>lbu</strong>) which zero extend to fill register. Why no unsigned store byte <strong>sbu</strong>?</p></blockquote><h3 id="Logical-Instruction"><a href="#Logical-Instruction" class="headerlink" title="Logical Instruction"></a>Logical Instruction</h3><p><img src="https://image.mwish.me/blog-image/7FFBD3D3-88CB-43F5-BB70-F069403DC8CC.png" alt="7FFBD3D3-88CB-43F5-BB70-F069403DC8CC"></p><p>æ³¨æ„ç®—æ•°ç§»ä½å’Œé€»è¾‘ç§»ä½ï¼šå¯¹äºsigned, ç®—æ•°ç§»ä½ä¼šæŠŠç¬¦å·ä½ç§»åŠ¨ä¸‹æ¥ã€‚</p><p>ç„¶ååœ¨ RISC-V é‡Œé¢ï¼Œå¯ä»¥æŠŠå®ƒä»¬æœ€åä¸€ä¸ªå­—æ¯å½“æˆåŒºåˆ† <code>logical</code> å’Œ <code>arithmetic</code> çš„æ ‡å¿—</p><h3 id="åˆ†æ”¯æŒ‡ä»¤"><a href="#åˆ†æ”¯æŒ‡ä»¤" class="headerlink" title="åˆ†æ”¯æŒ‡ä»¤"></a>åˆ†æ”¯æŒ‡ä»¤</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">beq register1,register2,L1</span><br></pre></td></tr></table></figure><p><code>if (x1 == x2) goto L1</code>, å…¶ä¸­ L1 æ˜¯ä¸€ä¸ª Label.</p><h3 id="åˆ†æ”¯æŒ‡ä»¤-1"><a href="#åˆ†æ”¯æŒ‡ä»¤-1" class="headerlink" title="åˆ†æ”¯æŒ‡ä»¤"></a>åˆ†æ”¯æŒ‡ä»¤</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">beq register1,register2,L1</span><br></pre></td></tr></table></figure><p>if (x1 == x2) goto L1, å…¶ä¸­ L1 æ˜¯ä¸€ä¸ª Label. S</p><p>beq è¿™ç§ b å¼€å¤´çš„æŒ‡ä»¤ä¸­ï¼Œb æ˜¯ branch çš„ç¼©å†™ï¼Œbeq å°±æ˜¯ Branch on EQualï¼ŒåŒç†å¯ä»¥æ¨æµ‹ï¼š</p><ul><li>blt: branch on less than </li><li>bne: branch on not equal</li><li>bltu Branch on Greater Than Unsigned </li></ul><p>å€¼å¾—ç©å‘³çš„æ˜¯ï¼ŒRISC-V é‡Œé¢ä¸å­˜åœ¨greater ï¼Œå®ƒä¼šè¢«è½¬æˆ less  ã€‚</p><p>ä¸Šé¢çš„ä»£ç å¯ä»¥è¢«è§†ä¸º conditional branch, æ­¤å¤–æˆ‘ä»¬è¿˜å¯ä»¥å…³æ³¨ unconditional branch. ä¹Ÿå°±æ˜¯ always jump çš„ caseï¼Œè¿™é‡Œæœ‰è¯­å¥ jï¼Œå³ jumpã€‚jal å’Œ jalr è¿™ä¸¤ä¸ªæŒ‡ä»¤ï¼Œjal æ˜¯ jump and linkã€‚å®ƒçš„å½¢å¼å¤§æ¦‚æ˜¯ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">jal rd offset</span><br><span class="line">jalr rd rs (offset)</span><br></pre></td></tr></table></figure><ul><li>jal ä¼šæŠŠ PC+4 å†™å…¥åˆ° rd å¯„å­˜å™¨ä¸­ï¼Œä½œä¸ºä¿å­˜â€œè°ƒç”¨è€…â€ ï¼Œç„¶åæŠŠå†…å®¹è·³è½¬åˆ° offset </li></ul><p>æ‰€ä»¥å®ƒå¯èƒ½çš„ä½¿ç”¨åœºæ™¯æ˜¯ï¼š</p><ol><li>æ— æ¡ä»¶çš„è·³è½¬ï¼ˆä»£ç é‡Œå†™ gotoï¼‰</li><li>è°ƒç”¨åˆ«çš„å‡½æ•°ï¼ˆä¸Šä¸‹æ–‡å†™åˆ°rdé‡Œé¢ï¼‰</li></ol><p>å¦‚æœæ˜¯ jalr å°±æ˜¯ <code>PC + imm</code> å˜æˆ <code>rs + imm</code></p><h3 id="å†è®ºè®¡ç®—"><a href="#å†è®ºè®¡ç®—" class="headerlink" title="å†è®ºè®¡ç®—"></a>å†è®ºè®¡ç®—</h3><blockquote><p>æœ‰ä»€ä¹ˆä¸åŒä¹‹å¤„?é¦–å…ˆï¼ŒRISC-V ä¸­æ²¡æœ‰å­—èŠ‚æˆ–åŠå­—å®½åº¦çš„æ•´æ•°è®¡ç®—æ“ä½œã€‚æ“ä½œå§‹ç»ˆ æ˜¯ä»¥å®Œæ•´çš„å¯„å­˜å™¨å®½åº¦ã€‚å†…å­˜è®¿é—®éœ€è¦çš„èƒ½é‡æ¯”ç®—æœ¯è¿ç®—é«˜å‡ ä¸ªæ•°é‡çº§ã€‚å› æ­¤ä½å®½åº¦çš„æ•° æ®è®¿é—®å¯ä»¥èŠ‚çœå¤§é‡çš„èƒ½é‡ï¼Œä½†ä½å®½åº¦çš„è¿ç®—ä¸ä¼šã€‚ARM-32 å…·æœ‰ä¸€ä¸ªä¸å¯»å¸¸çš„åŠŸèƒ½ï¼Œå¯¹ äºå¤§å¤šæ•°ç®—æœ¯é€»è¾‘è¿ç®—ä¸­çš„ä¸€ä¸ªæ“ä½œæ•°ï¼Œä½ å¯ä»¥é€‰æ‹©å¯¹å®ƒè¿›è¡Œç§»ä½ã€‚å°½ç®¡è¿™äº›æŒ‡ä»¤çš„ä½¿ç”¨ é¢‘ç‡å¾ˆä½ï¼Œä½†å®ƒä½¿æ•°æ®è·¯å¾„å’Œæ•°æ®é€šè·¯æ›´åŠ å¤æ‚ã€‚ä¸æ­¤ç›¸å¯¹çš„æ˜¯ï¼ŒRV32I æä¾›äº†å•ç‹¬çš„ç§»ä½æŒ‡ä»¤ã€‚</p><p>RV32I ä¹Ÿä¸åŒ…å«ä¹˜æ³•å’Œé™¤æ³•ï¼Œå®ƒä»¬åŒ…å«åœ¨å¯é€‰çš„ RV32M æ‰©å±•ä¸­(å‚è§ç¬¬ 4 ç« )ã€‚ä¸ ARM-32 å’Œ x86-32 ä¸åŒï¼Œå³ä½¿å¤„ç†å™¨æ²¡æœ‰æ·»åŠ ä¹˜é™¤æ³•æ‰©å±•ï¼Œå®Œæ•´çš„ RISC-V è½¯ä»¶æ ˆä¹Ÿå¯ä»¥ è¿è¡Œï¼Œè¿™å¯ä»¥ç¼©å°åµŒå…¥å¼èŠ¯ç‰‡çš„é¢ç§¯ã€‚MIPS-32 æ±‡ç¼–ç¨‹åºå¯èƒ½ç”¨ä¸€ç³»åˆ—ç§»ä½ä»¥åŠåŠ æ³•æŒ‡ä»¤ æ¥æ›¿æ¢ä¹˜æ³•ï¼Œä»¥æé«˜æ€§èƒ½ï¼Œè¿™å¯èƒ½ä¼šä½¿ç¨‹åºå‘˜çœ‹åˆ°å¤„ç†å™¨æ‰§è¡Œäº†æ±‡ç¼–ç¨‹åºä¸­æ²¡æœ‰çš„æŒ‡ä»¤ï¼Œ è¿›è€Œé€ æˆæ··æ·†ã€‚RV32I å¯ä»¥å¿½ç•¥äº†è¿™äº›ç‰¹æ€§:å¾ªç¯ç§»ä½æŒ‡ä»¤å’Œæ•´æ•°ç®—æœ¯æº¢å‡ºæ£€æµ‹ï¼Œè¿™ä¸¤ä¸ª ç‰¹æ€§éƒ½å¯ä»¥ç”¨è‹¥å¹²æ¡ RV32I æŒ‡ä»¤æ¥å®ç°(å‚è§ç¬¬ 2.6 èŠ‚)ã€‚</p></blockquote>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>The Go Memory Model</title>
      <link href="/2020/02/29/The-Go-Memory-Model/"/>
      <url>/2020/02/29/The-Go-Memory-Model/</url>
      
        <content type="html"><![CDATA[<p>memory model å…¶å®å„å¤§è¯­è¨€ä¼¼ä¹éƒ½æœ‰ï¼Œæ‰€ä»¥çœ‹åˆ°ä¸‹é¢çš„ä»£ç ä½ å¤§æ¦‚ä¸ä¼šé™Œç”Ÿ</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a <span class="type">string</span></span><br><span class="line"><span class="keyword">var</span> done <span class="type">bool</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">setup</span><span class="params">()</span></span> &#123;</span><br><span class="line">a = <span class="string">&quot;hello, world&quot;</span></span><br><span class="line">done = <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">go</span> setup()</span><br><span class="line"><span class="keyword">for</span> !done &#123;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">print</span>(a)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç›¸ä¿¡ä½ å¯ä»¥ç”¨ç»éªŒåˆ¤æ–­ä¸Šé¢çš„ä¾‹å­å“ªé‡Œæœ‰é—®é¢˜ï¼Œå®é™…ä¸Šï¼Œä¸€ä¸ªç¨‹åºé¢ä¸´ç€ï¼š</p><ul><li>ç¼–è¯‘å™¨å¯èƒ½æŠŠæ— å…³çš„ä»£ç ä¹±åºä»¥æé«˜æ•ˆç‡</li><li>CPU å¯èƒ½ä¼šäº§ç”Ÿæ‰§è¡Œä¸Šçš„ä¹±åºï¼ˆæ¯”å¦‚ Intel çš„ Store-Load ä¹±åºï¼‰</li><li>å¤šæ ¸å†…å­˜ä¸Šæœ‰å„ç§å„æ ·çš„éº»çƒ¦<ul><li>è™½è¯´å†…å­˜å’Œå¹¶å‘å…³ç³»æš§æ˜§ä¸æ¸…ï¼Œä½†æ˜¯æ¯«æ— ç–‘é—®ï¼Œå‰è€…å¯¹å†™ä»£ç æ˜¯å­˜åœ¨å½±å“çš„ã€‚æœ‰çš„æ—¶å€™ç”šè‡³ä¼šç»™äººå¸¦æ¥å¥‡æ€ªçš„å°è±¡å’ŒåŠè¯¡çš„è®¾è®¡ï¼Œæ¯”å¦‚ C å’Œ Java ä¸åŒå«ä¹‰çš„ volatile.</li></ul></li></ul><p>é‚£ä¹ˆ Go åŒæ ·è¦é¢ä¸´è¿™æ ·çš„é—®é¢˜ï¼Œä¸‹é¢çš„ä»£ç èƒ½å¤Ÿå¾ˆå¥½çš„è¿ä½œã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> wg sync.WaitGroup</span><br><span class="line">xxx := <span class="literal">nil</span></span><br><span class="line">wg.Add(<span class="number">1</span>)</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">defer</span> wg.Done()</span><br><span class="line"><span class="comment">// logic..</span></span><br><span class="line">xxx = val</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">wg.Done()</span><br><span class="line"><span class="comment">// read xxx</span></span><br></pre></td></tr></table></figure><p>è¿˜æœ‰ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">xChan = <span class="built_in">make</span>(<span class="keyword">chan</span> X)</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">xChan &lt;- val</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">xxx := &lt;- xChan</span><br><span class="line"><span class="comment">// read xxx</span></span><br></pre></td></tr></table></figure><p>ä¸ºä»€ä¹ˆå‘¢ï¼Ÿæˆ‘ä»¬æ¥çœ‹çœ‹è¿™ä¸ª blog å§ï¼š<a href="https://golang.org/ref/mem">https://golang.org/ref/mem</a></p><h2 id="Happens-Before"><a href="#Happens-Before" class="headerlink" title="Happens Before"></a>Happens Before</h2><blockquote><p>Within a single goroutine, the happens-before order is the order expressed by the program.</p><p>A read <em>r</em> of a variable <code>v</code> is <em>allowed</em> to observe a write <em>w</em> to <code>v</code> if both of the following hold:</p><ol><li><em>r</em> does not happen before <em>w</em>.</li><li>There is no other write <em>wâ€™</em> to <code>v</code> that happens after <em>w</em> but before <em>r</em>.</li></ol><p>To guarantee that a read <em>r</em> of a variable <code>v</code> observes a particular write <em>w</em> to <code>v</code>, ensure that <em>w</em> is the only write <em>r</em> is allowed to observe. That is, <em>r</em> is <em>guaranteed</em> to observe <em>w</em> if both of the following hold:</p><ol><li><em>w</em> happens before <em>r</em>.</li><li>Any other write to the shared variable <code>v</code> either happens before <em>w</em> or after <em>r</em>.</li></ol><p>This pair of conditions is stronger than the first pair; it requires that there are no other writes happening concurrently with <em>w</em> or <em>r</em>.</p></blockquote><p>åŸæ–‡è¿˜æ˜¯æ¯”è¾ƒç²¾ç‚¼çš„ï¼Œæˆ‘å°±ç›´æ¥ç¿»è¯‘äº†ã€‚ç›®å‰çš„ happens before é’ˆå¯¹çš„å¯¹è±¡æ˜¯å•ä¸ªå˜é‡ã€‚æ³¨æ„</p><blockquote><p>Reads and writes of values larger than a single machine word behave as multiple machine-word-sized operations in an unspecified order.</p></blockquote><p>å…³äº happens before, Go è¯­è¨€çš„ä»‹ç»è¿˜æ˜¯å¾ˆç®€å•çš„ï¼Œæˆ‘å€¾å‘äºé˜…è¯»ä¸€ä¸‹ C++ Concurrency In Action, æ‘˜å½•ä¸‹é¢å…³äº happens-before çš„ä¸€æ®µ</p><blockquote><p>At the basic level, inter-thread happens-before is relatively simple and relies on the synchronizes-with relationship introduced in section 5.3.1: if operation A in one thread synchronizes-with operation B in another thread, then A inter-thread happens- before B. Itâ€™s also a transitive relation: if A inter-thread happens-before B and B inter- thread happens-before C, then A inter-thread happens-before C. You saw this in listing 5.2 as well.</p><p>Inter-thread happens-before also combines with the sequenced-before relation: if operation A is sequenced before operation B, and operation B inter-thread happens- before operation C, then A inter-thread happens-before C. Similarly, if A synchronizes- with B and B is sequenced before C, then A inter-thread happens-before C. These two together mean that if you make a series of changes to data in a single thread, you need only one synchronizes-with relationship for the data to be visible to subsequent opera- tions on the thread that executed C.</p></blockquote><p>ä»¥ä¸Šä½ å°±æœ‰äº†å…³äº happens before çš„åŸºæœ¬è®¤çŸ¥ã€‚</p><h3 id="é»‘æš—é¢"><a href="#é»‘æš—é¢" class="headerlink" title="é»‘æš—é¢"></a>é»‘æš—é¢</h3><p>ä¸‹é¢å†…å®¹æ˜¯æˆ‘èƒ¡æ‰¯çš„</p><blockquote><p>This hardware must obey the following ordering constraints [McK05a, McK05b]:</p><ol><li>Each CPU will always perceive its own memory accesses as occurring in program order.</li><li>CPUs will reorder a given operation with a store only if the two operations are referencing different locations.</li><li>All of a given CPUâ€™s loads preceding a read memory barrier (smp_rmb()) will be perceived by all CPUs to precede any loads following that read memory barrier.</li><li>All of a given CPUâ€™s stores preceding a write mem- ory barrier (smp_wmb()) will be perceived by all CPUs to precede any stores following that write memory barrier.</li><li>All of a given CPUâ€™s accesses (loads and stores) preceding a full memory barrier (smp_mb()) will be perceived by all CPUs to precede any accesses following that memory barrier.</li></ol></blockquote><h2 id="Synchronization"><a href="#Synchronization" class="headerlink" title="Synchronization"></a>Synchronization</h2><h3 id="Initialization"><a href="#Initialization" class="headerlink" title="Initialization"></a>Initialization</h3><blockquote><p>Program initialization runs in a single goroutine, but that goroutine may create other goroutines, which run concurrently.</p><p>If a package <code>p</code> imports package <code>q</code>, the completion of <code>q</code>â€˜s <code>init</code> functions happens before the start of any of <code>p</code>â€˜s.</p><p>The start of the function <code>main.main</code> happens after all <code>init</code> functions have finished.</p></blockquote><p>å°±æ˜¯ <code>init</code> é˜¶æ®µå½¢æˆä¸€æ£µæ ‘æˆ–è€…DAGï¼Œåè¢« import çš„å…ˆè¢«åˆå§‹åŒ–ã€‚</p><h3 id="Goroutine-creation"><a href="#Goroutine-creation" class="headerlink" title="Goroutine creation"></a>Goroutine creation</h3><blockquote><p> The <code>go</code> statement that starts a new goroutine happens before the goroutineâ€™s execution begins.</p></blockquote><p>å®˜æ–¹æ–‡æ¡£çš„ä¾‹å­å¾ˆå¥½ï¼Œä¸€å­—ä¸æ˜“</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a <span class="type">string</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">f</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="built_in">print</span>(a)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">hello</span><span class="params">()</span></span> &#123;</span><br><span class="line">a = <span class="string">&quot;hello, world&quot;</span></span><br><span class="line"><span class="keyword">go</span> f()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li><code>go</code> before goroutineâ€™s begin</li><li><code>a</code> ä¼šå…ˆè¢«åˆå§‹åŒ–</li></ol><h3 id="Goroutine-destruction"><a href="#Goroutine-destruction" class="headerlink" title="Goroutine destruction"></a>Goroutine destruction</h3><blockquote><p>The exit of a goroutine is not guaranteed to happen before any event in the program. For example, in this program:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">var a string</span><br><span class="line"></span><br><span class="line">func hello() &#123;</span><br><span class="line">go func() &#123; a = &quot;hello&quot; &#125;()</span><br><span class="line">print(a)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>the assignment to <code>a</code> is not followed by any synchronization event, so it is not guaranteed to be observed by any other goroutine. In fact, an aggressive compiler might delete the entire <code>go</code> statement.</p><p>If the effects of a goroutine must be observed by another goroutine, use a synchronization mechanism such as a lock or channel communication to establish a relative ordering.</p></blockquote><p>ï¼ˆå…¶å®æˆ‘å¾ˆå¥½å¥‡ï¼Œè¿™ä¸€æ®µèƒ½ä¸èƒ½è¿‡ç¼–è¯‘ï¼‰</p><h3 id="Channel-communication"><a href="#Channel-communication" class="headerlink" title="Channel communication"></a>Channel communication</h3><blockquote><p><em>A send on a channel happens before the corresponding receive from that channel completes.</em></p><p><em>A receive from an unbuffered channel happens before the send on that channel completes.</em></p></blockquote><p>å›æƒ³èµ·å¼€å¤´çš„ä»£ç ï¼Œä¸éš¾ç†è§£ä¸ºä»€ä¹ˆä¸‹åˆ—ä»£ç æ˜¯åˆç†çš„</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">xChan = <span class="built_in">make</span>(<span class="keyword">chan</span> X)</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">xChan &lt;- val</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">xxx := &lt;- xChan</span><br><span class="line"><span class="comment">// read xxx</span></span><br></pre></td></tr></table></figure><p>ä»£ç è¿˜æœ‰ä¸ªæ¯”è¾ƒæœ‰æ„æ€çš„åœ°æ–¹æ˜¯é™æµ</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> limit = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">int</span>, <span class="number">3</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">for</span> _, w := <span class="keyword">range</span> work &#123;</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(w <span class="keyword">func</span>()</span></span>) &#123;</span><br><span class="line">limit &lt;- <span class="number">1</span></span><br><span class="line">w()</span><br><span class="line">&lt;-limit</span><br><span class="line">&#125;(w)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">select</span>&#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="sync-åº“"><a href="#sync-åº“" class="headerlink" title="sync åº“"></a>sync åº“</h3><blockquote><p><em>A single call of</em> <code>f()</code> <em>from</em> <code>once.Do(f)</code> <em>happens (returns) before any call of</em> <code>once.Do(f)</code> <em>returns.</em></p><p><em>For any call to</em> <code>l.RLock</code> <em>on a</em> <code>sync.RWMutex</code> <em>variable</em> <code>l</code><em>, there is an</em> <em>n</em> <em>such that the</em> <code>l.RLock</code> <em>happens (returns) after call</em> <em>n</em> <em>to</em> <code>l.Unlock</code> <em>and the matching</em> <code>l.RUnlock</code> <em>happens before call</em> <em>n**+1 to</em> <code>l.Lock</code><em>.</em></p></blockquote><p>å¦‚æœ <code>Lock</code> <code>Once</code> æœ‰é—®é¢˜ï¼Œé‚£æˆ‘ä»¬çš„ç¨‹åºçœŸåº”è¯¥å‡ºæ¯›ç—…äº†ï¼å®é™…ä¸Šï¼Œç¨‹åºæœ€æ—©çš„ <code>wg.Done</code> ä¹Ÿæœ‰ happens-before è¯­ä¹‰ï¼</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>GFS ç®€è¯»</title>
      <link href="/2020/02/25/GFS-%E7%AE%80%E8%AF%BB/"/>
      <url>/2020/02/25/GFS-%E7%AE%80%E8%AF%BB/</url>
      
        <content type="html"><![CDATA[<h2 id="ä¸€è‡´æ€§"><a href="#ä¸€è‡´æ€§" class="headerlink" title="ä¸€è‡´æ€§"></a>ä¸€è‡´æ€§</h2><p>ç”±äºæœ‰å¤šä»½å‰¯æœ¬ï¼ŒGFS é¢ä¸´ç€ä¸€è‡´æ€§çš„é—®é¢˜ã€‚</p><p>å½“æ•°æ®è¢«è¿›è¡Œ replicated çš„æ—¶å€™ï¼Œä¸€è‡´æ€§æ˜¯å¾ˆé‡è¦çš„ã€‚ä½ è¯»ä¸€ä¸ªå‰¯æœ¬çš„æ—¶å€™ï¼Œå…ˆå†™äº†ä½†æ˜¯æ•°æ®è¿˜æ²¡è¿‡æ¥å‘¢</p><p>å…³äºä¸€è‡´æ€§ï¼Œæœ‰å¼ºä¸€è‡´æ€§å’Œå¼±ä¸€è‡´æ€§ï¼Œåˆæ´¾ç”Ÿå‡ºæœ€ç»ˆä¸€è‡´æ€§è¿™äº›æ„ä¹‰ä¸æ˜çš„ç‹—ä¸œè¥¿</p><p>è¿™ç¯‡æ–‡ç«  å†™å¾—ä¸é”™ï¼Œå¦å¤– ddia å…³äºè¿™ä¸ªä¹Ÿæœ‰ç®€å•è®¨è®ºã€‚</p><p><a href="https://zhuanlan.zhihu.com/p/48782892">https://zhuanlan.zhihu.com/p/48782892</a></p><blockquote><p> General tension between these:<br>     strong consistency is easy for application writers<br>     strong consistency is bad for performance<br>     weak consistency has good performance and is easy to scale to many servers<br>     weak consistency is complex to reason about</p></blockquote><h2 id="GFS-çš„ç‰¹æ€§-æˆ‘ç›¸ä¿¡è¯»è€…ä»¬è¯»è¿‡ä¸€ä¸‡éäº†"><a href="#GFS-çš„ç‰¹æ€§-æˆ‘ç›¸ä¿¡è¯»è€…ä»¬è¯»è¿‡ä¸€ä¸‡éäº†" class="headerlink" title="GFS çš„ç‰¹æ€§(æˆ‘ç›¸ä¿¡è¯»è€…ä»¬è¯»è¿‡ä¸€ä¸‡éäº†)"></a>GFS çš„ç‰¹æ€§(æˆ‘ç›¸ä¿¡è¯»è€…ä»¬è¯»è¿‡ä¸€ä¸‡éäº†)</h2><ol><li><p>å¤±æ•ˆæ˜¯å¸¸æ€ï¼Œè€Œéæ„å¤–äº‹ä»¶ï¼šè¿™ç‚¹åŒ mapreduce, æˆ‘ä»¬éœ€è¦å¤„ç†å¤±æ•ˆç­‰é—®é¢˜ï¼Œæ¥ä¿è¯ç¨‹åºèƒ½å¤Ÿç¨³æ­¥çš„è¿è¡Œ</p></li><li><p>æ–‡ä»¶â€œéå¸¸å·¨å¤§â€</p><blockquote><p>æˆ‘ä»¬ç»å¸¸éœ€è¦å¤„ç†å¿«é€Ÿå¢é•¿çš„ã€å¹¶ä¸”ç”±æ•°äº¿ä¸ªå¯¹è±¡æ„æˆçš„ã€æ•°ä»¥ TB çš„æ•°æ®<br>é›†æ—¶ï¼Œé‡‡ç”¨ç®¡ç†æ•°äº¿ä¸ª KB å¤§å°çš„å°æ–‡ä»¶çš„æ–¹å¼æ˜¯éå¸¸ä¸æ˜æ™ºçš„</p><p>(éƒ½ç”¨tb, æ•°ä¸ªgbç®—, å¥½å¼ºå•Šï¼Œæˆ‘ä»€ä¹ˆæ—¶å€™èƒ½ä¹°çš„èµ·è¿™ä¹ˆå¤šå­˜å‚¨)</p></blockquote></li><li><p>æ–‡ä»¶çš„ä¿®æ”¹é‡‡å– append å½¢å¼ï¼Œå¾ˆå°‘ä¼šå®é™…çš„æŠŠæ•°æ®å¼„æ‰ã€‚å†™å®Œä¹‹åå°½é‡åªè¿›è¡Œâ€œé¡ºåºè¯»â€ï¼Œè€Œé RandomAccess. åŒæ—¶æä¾› atomic çš„ append è°ƒç”¨ã€‚</p></li><li><p>GFS æä¾›äº†å¿«ç…§æ“ä½œï¼Œèƒ½å¤Ÿå¯¹æ–‡ä»¶/ç›®å½•ä¸‹çš„æ–‡ä»¶å– Snapshot</p></li><li><p>æ²¡ç”¨ POSIX APIï¼Œä½†æ˜¯ä»ç„¶æœ‰å¼±åŒ–çš„ç›¸ä¼¼ API</p></li></ol><h2 id="GFS"><a href="#GFS" class="headerlink" title="GFS"></a>GFS</h2><p><img src="/Users/fuasahi/Downloads/C7442FCD-3FDB-4930-8EEB-8CA54E3E396D.png" alt="C7442FCD-3FDB-4930-8EEB-8CA54E3E396D"></p><blockquote><p>GFS å­˜å‚¨çš„æ–‡ä»¶éƒ½è¢«åˆ†å‰²æˆå›ºå®šå¤§å°çš„ Chunkã€‚åœ¨ Chunk åˆ›å»ºçš„æ—¶å€™ï¼ŒMaster æœåŠ¡å™¨ä¼šç»™æ¯ä¸ª Chunk åˆ† é…ä¸€ä¸ªä¸å˜çš„ã€å…¨çƒå”¯ä¸€çš„ 64 ä½çš„ Chunk æ ‡è¯†ã€‚Chunk æœåŠ¡å™¨æŠŠ Chunk ä»¥ Linux æ–‡ä»¶çš„å½¢å¼ä¿å­˜åœ¨æœ¬åœ°ç¡¬ç›˜ ä¸Šï¼Œå¹¶ä¸”æ ¹æ®æŒ‡å®šçš„ Chunk æ ‡è¯†å’Œå­—èŠ‚èŒƒå›´æ¥è¯»å†™å—æ•°æ®ã€‚å‡ºäºå¯é æ€§çš„è€ƒè™‘ï¼Œæ¯ä¸ªå—éƒ½ä¼šå¤åˆ¶åˆ°å¤šä¸ªå—æœ åŠ¡å™¨ä¸Šã€‚ç¼ºçœæƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä½¿ç”¨ 3 ä¸ªå­˜å‚¨å¤åˆ¶èŠ‚ç‚¹ï¼Œä¸è¿‡ç”¨æˆ·å¯ä»¥ä¸ºä¸åŒçš„æ–‡ä»¶å‘½åç©ºé—´è®¾å®šä¸åŒçš„å¤åˆ¶çº§åˆ«ã€‚</p><p>Master èŠ‚ç‚¹ç®¡ç†æ‰€æœ‰çš„æ–‡ä»¶ç³»ç»Ÿå…ƒæ•°æ®ã€‚è¿™äº›å…ƒæ•°æ®åŒ…æ‹¬åå­—ç©ºé—´ã€è®¿é—®æ§åˆ¶ä¿¡æ¯ã€æ–‡ä»¶å’Œ Chunk çš„æ˜  å°„ä¿¡æ¯ã€ä»¥åŠå½“å‰ Chunk çš„ä½ç½®ä¿¡æ¯ã€‚Master èŠ‚ç‚¹è¿˜ç®¡ç†ç€ç³»ç»ŸèŒƒå›´å†…çš„æ´»åŠ¨ï¼Œæ¯”å¦‚ï¼ŒChunk Leaseã€å­¤å„¿ Chunkçš„å›æ”¶ã€ä»¥åŠ Chunk åœ¨ Chunk æœåŠ¡å™¨ä¹‹é—´çš„è¿ç§»ã€‚</p></blockquote><p>GFS çš„ä»£ç è·‘åœ¨ user-space ä¸Šï¼ŒåŒæ—¶è¢«é“¾æ¥åˆ°åº“é‡Œã€‚</p><p>è®ºæ–‡æåˆ° GFS å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯éƒ½ä¸ç”¨å†™ç¼“å­˜ï¼š</p><blockquote><p>å®¢æˆ·ç«¯ç¼“å­˜æ•°æ®å‡ ä¹æ²¡æœ‰ä»€ä¹ˆç”¨å¤„ï¼Œå› ä¸ºå¤§éƒ¨ åˆ†ç¨‹åºè¦ä¹ˆä»¥æµçš„æ–¹å¼è¯»å–ä¸€ä¸ªå·¨å¤§æ–‡ä»¶ï¼Œè¦ä¹ˆå·¥ä½œé›†å¤ªå¤§æ ¹æœ¬æ— æ³•è¢«ç¼“å­˜ã€‚</p><p>Chunk æœåŠ¡å™¨ä¸éœ€è¦ç¼“å­˜æ–‡ä»¶æ•°æ®çš„åŸå› æ˜¯ï¼ŒChunk ä»¥æœ¬åœ°æ–‡ä»¶çš„æ–¹å¼ä¿å­˜ï¼ŒLinux æ“ä½œç³»ç»Ÿçš„æ–‡ä»¶ç³»ç»Ÿç¼“å­˜ä¼šæŠŠç»å¸¸è®¿é—®çš„æ•°æ®ç¼“å­˜åœ¨å†…å­˜ä¸­ã€‚</p></blockquote><h3 id="Masterâ€™s-metadata"><a href="#Masterâ€™s-metadata" class="headerlink" title="Masterâ€™s metadata"></a>Masterâ€™s metadata</h3><p><img src="/Users/fuasahi/Downloads/14BB9EEE-7E8F-4EB4-9752-BF22671DFEB4.png" alt="14BB9EEE-7E8F-4EB4-9752-BF22671DFEB4"></p><ul><li><code>map(filename --&gt; [chunk-servers])</code>, ns tree</li><li>chunk handler, lease <code>map(handle --&gt; ([cs, version, primary, lease expiration]))</code></li><li>Chunk çš„ ä¿¡æ¯</li><li>LOG, CKPT</li></ul><blockquote><p>Master æœåŠ¡å™¨ä¸ä¼šæŒä¹…ä¿å­˜ Chunk ä½ç½®ä¿¡æ¯ã€‚Master æœåŠ¡å™¨åœ¨å¯åŠ¨æ—¶ï¼Œæˆ–è€…æœ‰æ–°çš„ Chunk æœåŠ¡å™¨åŠ å…¥æ—¶ï¼Œå‘å„ä¸ª Chunk æœåŠ¡å™¨è½®è¯¢å®ƒä»¬æ‰€å­˜å‚¨çš„ Chunk çš„ä¿¡æ¯ã€‚</p><p>åŒæ ·çš„ï¼Œæ¯ä¸ªæ–‡ä»¶çš„åœ¨å‘½åç©ºé—´ä¸­çš„æ•°æ®å¤§å°é€šå¸¸åœ¨ 64 å­—èŠ‚ä»¥ä¸‹ï¼Œå› ä¸ºä¿å­˜çš„æ–‡ä»¶åæ˜¯ç”¨å‰ç¼€å‹ç¼©ç®—æ³•å‹ç¼©è¿‡çš„ã€‚</p></blockquote><h4 id="æ“ä½œæ—¥å¿—"><a href="#æ“ä½œæ—¥å¿—" class="headerlink" title="æ“ä½œæ—¥å¿—"></a>æ“ä½œæ—¥å¿—</h4><ul><li>log å¤åˆ¶åˆ° remote å¤šå°æœºå™¨ï¼Œå…¨éƒ¨å®Œæˆä¹‹åï¼Œæ‰ä¼šå“åº”å®¢æˆ·ç«¯</li><li>chunkä¿è¯logæŒä¹…åŒ–ä¹‹åï¼Œå¯¹å®¢æˆ·ç«¯æ˜¯å¯è§çš„</li><li>master èƒ½å¤Ÿ replay log å’Œæ„å»º ckpt</li></ul><h3 id="Read"><a href="#Read" class="headerlink" title="Read"></a>Read</h3><p><img src="/Users/fuasahi/Downloads/EC865399-2D30-4FF9-B84A-02D81A237714.png" alt="EC865399-2D30-4FF9-B84A-02D81A237714"></p><blockquote><p>å®¢æˆ·ç«¯å¹¶ä¸é€šè¿‡ Master èŠ‚ç‚¹è¯»å†™æ–‡ä»¶æ•°æ®ã€‚åä¹‹ï¼Œå®¢æˆ·ç«¯å‘ Master èŠ‚ç‚¹è¯¢é—®å®ƒåº”è¯¥è”ç³»çš„ Chunk æœåŠ¡å™¨ã€‚ å®¢æˆ·ç«¯å°†è¿™äº› metadata ç¼“å­˜ä¸€æ®µæ—¶é—´ï¼Œåç»­çš„æ“ä½œå°†ç›´æ¥å’Œ Chunk æœåŠ¡å™¨è¿›è¡Œæ•°æ®è¯»å†™æ“ä½œã€‚</p></blockquote><ul><li>Client æŠŠ <code>(filename, offset)</code> å‘é€ç»™ Master</li><li>Master å‘é€ <code>(u64_chunk_id, [chunk_servers])</code> å›å»ï¼Œå®¢æˆ·ç«¯æœ‰ä¸€å®šçš„å¯¹è¿™ä¸ªç»“æœçš„ç¼“å­˜</li><li>Client ä» Chunk Server è¯»æ•°æ®ï¼Œä¸€èˆ¬ä¼šé€‰å– <code>[chunk_server]</code> é‡Œé¢æœ€è¿‘çš„æœºå™¨å»è¯»å–ã€‚</li></ul><p>è¿™ä¸ªå…¶å®å’Œæ–‡ä»¶ç³»ç»Ÿ inode å’Œ block çš„è®¾è®¡æœ‰ä¸€å®šç›¸ä¼¼æ€§ï¼Œé€»è¾‘ä¸Šä¸€å®šç¨‹åº¦ä¸Šå¯ä»¥æŒ‰ç…§é‚£ä¸ªç†è§£ã€‚ç›®å‰ GFS çš„é»˜è®¤ Chunk Size æ˜¯ 64Mï¼Œè¿™ä¸ªå€¼ä¼¼ä¹åœ¨ HDFS é‡Œé¢æ˜¯å¯ä»¥è°ƒçš„ã€‚64M å‡è½»äº† Master çš„å†…å­˜å¼€é”€å’Œ Client çš„ metadata ç¼“å­˜å¼€é”€ã€‚ä½†æ˜¯å…¶å®è¿™æ ·ä¹Ÿä¼šé€ æˆå¾ˆå¤§çš„ internal fragments, ä¸é€‚åˆå°æ–‡ä»¶çš„å¤„ç†ï¼Œæ‰€ä»¥è¿˜æ˜¯ç”¨æˆ·è‡ªå·±çœ‹æƒ…å†µ trade-off æŠŠã€‚</p><p>è®ºæ–‡æåˆ°äº†ï¼š</p><blockquote><p>åœ¨å®é™…åº”ç”¨ä¸­ï¼Œç”±äºæˆ‘ä»¬çš„ç¨‹åºé€šå¸¸æ˜¯è¿ç»­çš„è¯»å–åŒ…å«å¤šä¸ª Chunk çš„å¤§æ–‡ä»¶ï¼Œçƒ­ç‚¹è¿˜ä¸æ˜¯ä¸»è¦çš„é—®é¢˜ã€‚</p><p>ç„¶è€Œï¼Œå½“æˆ‘ä»¬ç¬¬ä¸€æ¬¡æŠŠ GFS ç”¨äºæ‰¹å¤„ç†é˜Ÿåˆ—ç³»ç»Ÿçš„æ—¶å€™ï¼Œçƒ­ç‚¹çš„é—®é¢˜è¿˜æ˜¯äº§ç”Ÿäº†:ä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶åœ¨GFS ä¸Šä¿å­˜ä¸º single-chunk æ–‡ä»¶ï¼Œä¹‹åè¿™ä¸ªå¯æ‰§è¡Œæ–‡ä»¶åœ¨æ•°ç™¾å°æœºå™¨ä¸ŠåŒæ—¶å¯åŠ¨ã€‚å­˜æ”¾è¿™ä¸ªå¯æ‰§è¡Œæ–‡ä»¶çš„å‡  ä¸ª Chunk æœåŠ¡å™¨è¢«æ•°ç™¾ä¸ªå®¢æˆ·ç«¯çš„å¹¶å‘è¯·æ±‚è®¿é—®å¯¼è‡´ç³»ç»Ÿå±€éƒ¨è¿‡è½½ã€‚æˆ‘ä»¬é€šè¿‡ä½¿ç”¨æ›´å¤§çš„å¤åˆ¶å‚æ•°æ¥ä¿å­˜å¯ æ‰§è¡Œæ–‡ä»¶ï¼Œä»¥åŠé”™å¼€æ‰¹å¤„ç†é˜Ÿåˆ—ç³»ç»Ÿç¨‹åºçš„å¯åŠ¨æ—¶é—´çš„æ–¹æ³•è§£å†³äº†è¿™ä¸ªé—®é¢˜ã€‚ä¸€ä¸ªå¯èƒ½çš„é•¿æ•ˆè§£å†³æ–¹æ¡ˆæ˜¯ï¼Œ åœ¨è¿™ç§çš„æƒ…å†µä¸‹ï¼Œå…è®¸å®¢æˆ·ç«¯ä»å…¶å®ƒå®¢æˆ·ç«¯è¯»å–æ•°æ®ã€‚</p></blockquote><h2 id="Consistency"><a href="#Consistency" class="headerlink" title="Consistency"></a>Consistency</h2><p>GFS å¯¹ file namespace çš„ä¿®æ”¹ï¼ŒåŒ…æ‹¬åˆ›å»ºæ–‡ä»¶ï¼Œæ˜¯ atomic çš„ã€‚ file namespace åªåœ¨ master èŠ‚ç‚¹ä¸Šæ“ä½œã€‚</p><blockquote><p>the masterâ€™s operation log defines a <strong>global total order</strong> of these operations</p></blockquote><p>ä½†æ˜¯å¹¶è¡Œçš„clientå†™å…¥æ˜¯å±é™©çš„ï¼Œå¯ä»¥å‚è€ƒæˆªå›¾å’Œå¯¹ä¸‹é¢ phenomena çš„å®šä¹‰</p><blockquote><p>When a mutation succeeds without interference from concurrent writers, the affected region is defined (and by implication consistent): all clients will always see what the mutation has written. Concurrent successful mutations leave the region undefined but consistent: all clients see the same data, but it may not reflect what any one mutation has written. Typically, it consists of mingled fragments from multiple mutations. A failed mutation makes the region in- consistent (hence also undefined): different clients may see different data at different times. We describe below how our applications can distinguish defined regions from undefined</p></blockquote><p>é€šä¿—çš„è®²ï¼Œéœ€è¦è¾¨åˆ«â€œä¸€è‡´â€å’Œâ€å·²å®šä¹‰â€, å‰è€…æ˜¯å¤šä¸ªå‰¯æœ¬å†…å®¹çš„ä¸€è‡´ï¼Œåè€…æ˜¯é’ˆå¯¹å†™/append è¯­ä¹‰çš„ã€‚</p><p>GFS ä¿è¯å†™å…¥çš„æ–‡ä»¶æ˜¯â€œä¸€è‡´çš„â€ï¼Œè¿™åŒ…æ‹¬ï¼š</p><blockquote><p>(a) å¯¹ Chunk çš„æ‰€æœ‰å‰¯æœ¬çš„ä¿®æ”¹æ“ä½œé¡ºåºä¸€è‡´(3.1 ç« )ï¼Œ</p><p>(b)ä½¿ç”¨ Chunk çš„ç‰ˆæœ¬å·<strong>ï¼ˆè¿™ä¸ªå€¼æ˜¯è·Ÿ Lease æŒ‚é’©çš„ï¼Œä¸ç†è§£çš„è¯å¯ä»¥çœ‹åé¢ï¼‰</strong>æ¥æ£€æµ‹å‰¯æœ¬æ˜¯å¦å› ä¸ºå®ƒæ‰€åœ¨çš„ Chunk æœåŠ¡å™¨å®•æœº(4.5 ç« )è€Œé”™è¿‡äº†ä¿®æ”¹æ“ä½œ è€Œå¯¼è‡´å…¶å¤±æ•ˆã€‚å¤±æ•ˆçš„å‰¯æœ¬ä¸ä¼šå†è¿›è¡Œä»»ä½•ä¿®æ”¹æ“ä½œï¼ŒMaster æœåŠ¡å™¨ä¹Ÿä¸å†è¿”å›è¿™ä¸ª Chunk å‰¯æœ¬çš„ä½ç½®ä¿¡æ¯ ç»™å®¢æˆ·ç«¯ã€‚å®ƒä»¬ä¼šè¢«åƒåœ¾æ”¶é›†ç³»ç»Ÿå°½å¿«å›æ”¶ã€‚</p></blockquote><p>a å¾ˆå¥½ç†è§£ï¼Œb ç›¸å¯¹éš¾ç†è§£å¾ˆå¤š, æ‰€ä»¥æˆ‘è´´åŸæ–‡ï¼š</p><blockquote><p>using chunk version numbers to detect any replica that has become stale because it has missed mu- tations while its chunkserver was down </p></blockquote><p>ç„¶åæ³¨æ„ refresh</p><blockquote><p>Since clients cache chunk locations, they may read from a stale replica before that information is refreshed. This win- dow is limited by the cache entryâ€™s timeout and the next open of the file, which purges from the cache all chunk in- formation for that file. Moreover, as most of our files are append-only, a stale replica usually returns a premature end of chunk rather than outdated data. When a reader retries and contacts the master, it will immediately get current chunk locations.</p></blockquote><p>æ‰€ä»¥æˆ‘è®¤ä¸ºä¸Šé¢è¿™æ®µå«ä¹‰æ˜¯ï¼ŒGFS å¯èƒ½ç»™å®¢æˆ·ç«¯è¿”å›éæœ€æ–°ä½†ä¸€è‡´çš„æ•°æ®ï¼Œç„¶åç­‰å¾…ä»å®¢æˆ·ç«¯è¯»å–/åˆ·æ–°</p><blockquote><p>åœ¨å®é™…åº”ç”¨ä¸­ï¼Œæˆ‘ä»¬æ‰€æœ‰çš„åº”ç”¨ç¨‹åºå¯¹æ–‡ä»¶çš„å†™å…¥æ“ä½œéƒ½æ˜¯å°½é‡é‡‡ç”¨æ•°æ®è¿½åŠ æ–¹å¼ï¼Œè€Œä¸æ˜¯è¦†ç›–æ–¹å¼ã€‚ ä¸€ç§å…¸å‹çš„åº”ç”¨ï¼Œåº”ç”¨ç¨‹åºä»å¤´åˆ°å°¾å†™å…¥æ•°æ®ï¼Œç”Ÿæˆäº†ä¸€ä¸ªæ–‡ä»¶ã€‚å†™å…¥æ‰€æœ‰æ•°æ®ä¹‹åï¼Œåº”ç”¨ç¨‹åºè‡ªåŠ¨å°†æ–‡ä»¶ æ”¹åä¸ºä¸€ä¸ªæ°¸ä¹…ä¿å­˜çš„æ–‡ä»¶åï¼Œæˆ–è€…å‘¨æœŸæ€§çš„ä½œ Checkpointï¼Œè®°å½•æˆåŠŸå†™å…¥äº†å¤šå°‘æ•°æ®ã€‚Checkpoint æ–‡ä»¶å¯ä»¥ åŒ…å«ç¨‹åºçº§åˆ«çš„æ ¡éªŒå’Œã€‚Readers ä»…æ ¡éªŒå¹¶å¤„ç†ä¸Šä¸ª Checkpoint ä¹‹åäº§ç”Ÿçš„æ–‡ä»¶ regionï¼Œè¿™äº›æ–‡ä»¶ region çš„çŠ¶ æ€ä¸€å®šæ˜¯å·²å®šä¹‰çš„ã€‚è¿™ä¸ªæ–¹æ³•æ»¡è¶³äº†æˆ‘ä»¬ä¸€è‡´æ€§å’Œå¹¶å‘å¤„ç†çš„è¦æ±‚ã€‚è¿½åŠ å†™å…¥æ¯”éšæœºä½ç½®å†™å…¥æ›´åŠ æœ‰æ•ˆç‡ï¼Œ å¯¹åº”ç”¨ç¨‹åºçš„å¤±è´¥å¤„ç†æ›´å…·æœ‰å¼¹æ€§ã€‚Checkpoint å¯ä»¥è®© Writer ä»¥æ¸è¿›çš„æ–¹å¼é‡æ–°å¼€å§‹ï¼Œå¹¶ä¸”å¯ä»¥é˜²æ­¢ Reader å¤„ç†å·²ç»è¢«æˆåŠŸå†™å…¥ï¼Œä½†æ˜¯ä»åº”ç”¨ç¨‹åºçš„è§’åº¦æ¥çœ‹è¿˜å¹¶æœªå®Œæˆçš„æ•°æ®ã€‚</p></blockquote><h2 id="Atomic-Append"><a href="#Atomic-Append" class="headerlink" title="Atomic Append"></a>Atomic Append</h2><ol><li>client æƒ³ append, æ‰€ä»¥ ask for last chunk, æœ‰å¯èƒ½æ˜¯ master ä¸Š no primary çš„ã€‚</li><li>master å¯»æ‰¾ç‰ˆæœ¬å·ç­‰äº master çš„æ•°æ®ï¼Œç„¶åå¦‚æœæ²¡æœ‰ primary åˆ†é… primary å’Œ leaseã€‚æ³¨æ„ï¼Œåªæœ‰è®¤ä¸ºæ²¡æœ‰ primary çš„æ—¶å€™ï¼Œmaster æ‰ä¼š increase version<ol><li>å¦‚æœè”ç³»ä¸ä¸Šï¼Œmaster éœ€è¦ wait for the lease, generate new primary</li><li>å†™é¡ºåºç”± Primary å†³å®šï¼Œæ˜¯ chunk å†…ç¡®å®šçš„, å…·ä½“å‚è€ƒè®ºæ–‡3.2</li></ol></li><li>ç»™å®¢æˆ·ç«¯è¿”å› (P, S, #V + Lease)</li><li>Master æŒä¹…åŒ–è¿™ä¸ª version number</li></ol><blockquote><p>GFS ô°‚ä¾›äº†ä¸€ç§åŸå­çš„æ•°æ®è¿½åŠ æ“ä½œâ€“è®°å½•è¿½åŠ ã€‚ä¼ ç»Ÿæ–¹å¼çš„å†™å…¥æ“ä½œï¼Œå®¢æˆ·ç¨‹åºä¼šæŒ‡å®šæ•°æ®å†™å…¥çš„å ç§»é‡ã€‚å¯¹åŒä¸€ä¸ªregionçš„å¹¶è¡Œå†™å…¥æ“ä½œä¸æ˜¯ä¸²è¡Œçš„:regionå°¾éƒ¨å¯èƒ½ä¼šåŒ…å«å¤šä¸ªä¸åŒå®¢æˆ·æœºå†™å…¥çš„æ•°æ®ç‰‡æ®µã€‚ ä½¿ç”¨è®°å½•è¿½åŠ ï¼Œå®¢æˆ·æœºåªéœ€è¦æŒ‡å®šè¦å†™å…¥çš„æ•°æ®ã€‚GFS ä¿è¯è‡³å°‘æœ‰ä¸€æ¬¡åŸå­çš„å†™å…¥æ“ä½œæˆåŠŸæ‰§è¡Œ(å³å†™å…¥ä¸€ ä¸ªé¡ºåºçš„ byte æµ)ï¼Œå†™å…¥çš„æ•°æ®è¿½åŠ åˆ° GFS æŒ‡å®šçš„åç§»ä½ç½®ä¸Šï¼Œä¹‹å GFS è¿”å›è¿™ä¸ªåç§»é‡ç»™å®¢æˆ·æœºã€‚è¿™ç±»ä¼¼ äºåœ¨ Unix æ“ä½œç³»ç»Ÿç¼–ç¨‹ç¯å¢ƒä¸­ï¼Œå¯¹ä»¥ O_APPEND æ¨¡å¼æ‰“å¼€çš„æ–‡ä»¶ï¼Œå¤šä¸ªå¹¶å‘å†™æ“ä½œåœ¨æ²¡æœ‰ç«æ€æ¡ä»¶æ—¶çš„è¡Œ ä¸ºã€‚</p></blockquote><p>æ‰€ä»¥ï¼Œä½ ä»ç„¶å¯èƒ½æœ‰å„ç§å„æ ·çš„é—®é¢˜ï¼Œè™½ç„¶å®ƒæ˜¯æŒ‡å®šé¡ºåºè¿è¡Œçš„ã€‚æ‰€ä»¥è®ºæ–‡åœ¨2æœ€åå†™äº†ï¼Œåº”è¯¥åœ¨åº”ç”¨å±‚åšä¸€å®šçš„å†³å®šï¼ˆä¸çŸ¥é“è¿™ä¸ªéƒ¨åˆ†æœ‰æ²¡æœ‰è¢«å°è£…æˆåº“ï¼‰</p><blockquote><p>åœ¨å®é™…åº”ç”¨ä¸­ï¼Œæˆ‘ä»¬æ‰€æœ‰çš„åº”ç”¨ç¨‹åºå¯¹æ–‡ä»¶çš„å†™å…¥æ“ä½œéƒ½æ˜¯å°½é‡é‡‡ç”¨æ•°æ®è¿½åŠ æ–¹å¼ï¼Œè€Œä¸æ˜¯è¦†ç›–æ–¹å¼ã€‚ ä¸€ç§å…¸å‹çš„åº”ç”¨ï¼Œåº”ç”¨ç¨‹åºä»å¤´åˆ°å°¾å†™å…¥æ•°æ®ï¼Œç”Ÿæˆäº†ä¸€ä¸ªæ–‡ä»¶ã€‚å†™å…¥æ‰€æœ‰æ•°æ®ä¹‹åï¼Œåº”ç”¨ç¨‹åºè‡ªåŠ¨å°†æ–‡ä»¶ æ”¹åä¸ºä¸€ä¸ªæ°¸ä¹…ä¿å­˜çš„æ–‡ä»¶åï¼Œæˆ–è€…å‘¨æœŸæ€§çš„ä½œ Checkpointï¼Œè®°å½•æˆåŠŸå†™å…¥äº†å¤šå°‘æ•°æ®ã€‚Checkpoint æ–‡ä»¶å¯ä»¥ åŒ…å«ç¨‹åºçº§åˆ«çš„æ ¡éªŒå’Œã€‚Readers ä»…æ ¡éªŒå¹¶å¤„ç†ä¸Šä¸ª Checkpoint ä¹‹åäº§ç”Ÿçš„æ–‡ä»¶ regionï¼Œè¿™äº›æ–‡ä»¶ region çš„çŠ¶ æ€ä¸€å®šæ˜¯å·²å®šä¹‰çš„ã€‚è¿™ä¸ªæ–¹æ³•æ»¡è¶³äº†æˆ‘ä»¬ä¸€è‡´æ€§å’Œå¹¶å‘å¤„ç†çš„è¦æ±‚ã€‚è¿½åŠ å†™å…¥æ¯”éšæœºä½ç½®å†™å…¥æ›´åŠ æœ‰æ•ˆç‡ï¼Œ å¯¹åº”ç”¨ç¨‹åºçš„å¤±è´¥å¤„ç†æ›´å…·æœ‰å¼¹æ€§ã€‚Checkpoint å¯ä»¥è®© Writer ä»¥æ¸è¿›çš„æ–¹å¼é‡æ–°å¼€å§‹ï¼Œå¹¶ä¸”å¯ä»¥é˜²æ­¢ Reader å¤„ç†å·²ç»è¢«æˆåŠŸå†™å…¥ï¼Œä½†æ˜¯ä»åº”ç”¨ç¨‹åºçš„è§’åº¦æ¥çœ‹è¿˜å¹¶æœªå®Œæˆçš„æ•°æ®ã€‚</p><p>æˆ‘ä»¬å†æ¥åˆ†æå¦ä¸€ç§å…¸å‹çš„åº”ç”¨ã€‚è®¸å¤šåº”ç”¨ç¨‹åºå¹¶è¡Œçš„è¿½åŠ æ•°æ®åˆ°åŒä¸€ä¸ªæ–‡ä»¶ï¼Œæ¯”å¦‚è¿›è¡Œç»“æœçš„åˆå¹¶æˆ– è€…æ˜¯ä¸€ä¸ªç”Ÿäº§è€…-æ¶ˆè´¹è€…é˜Ÿåˆ—ã€‚è®°å½•è¿½åŠ æ–¹å¼çš„â€œè‡³å°‘ä¸€æ¬¡è¿½åŠ â€çš„ç‰¹æ€§ä¿è¯äº† Writer çš„è¾“å‡ºã€‚Readers ä½¿ç”¨ ä¸‹é¢çš„æ–¹æ³•æ¥å¤„ç†å¶ç„¶æ€§çš„å¡«å……æ•°æ®å’Œé‡å¤å†…å®¹ã€‚Writers åœ¨æ¯æ¡å†™å…¥çš„è®°å½•ä¸­éƒ½åŒ…å«äº†é¢å¤–çš„ä¿¡æ¯ï¼Œä¾‹å¦‚ Checksumï¼Œç”¨æ¥éªŒè¯å®ƒçš„æœ‰æ•ˆæ€§ã€‚Reader å¯ä»¥åˆ©ç”¨ Checksum è¯†åˆ«å’ŒæŠ›å¼ƒé¢å¤–çš„å¡«å……æ•°æ®å’Œè®°å½•ç‰‡æ®µã€‚å¦‚æœ åº”ç”¨ä¸èƒ½å®¹å¿å¶å°”çš„é‡å¤å†…å®¹(æ¯”å¦‚ï¼Œå¦‚æœè¿™äº›é‡å¤æ•°æ®è§¦å‘äº†éå¹‚ç­‰æ“ä½œ)ï¼Œå¯ä»¥ç”¨è®°å½•çš„å”¯ä¸€æ ‡è¯†ç¬¦æ¥è¿‡æ»¤ å®ƒä»¬ï¼Œè¿™äº›å”¯ä¸€æ ‡è¯†ç¬¦é€šå¸¸ç”¨äºå‘½åç¨‹åºä¸­å¤„ç†çš„å®ä½“å¯¹è±¡ï¼Œä¾‹å¦‚ web æ–‡æ¡£ã€‚è¿™äº›è®°å½• I/O åŠŸèƒ½18éƒ½åŒ…å«åœ¨æˆ‘ ä»¬çš„ç¨‹åºå…±äº«çš„åº“ä¸­ï¼Œå¹¶ä¸”é€‚ç”¨äº Google å†…éƒ¨çš„å…¶å®ƒçš„æ–‡ä»¶æ¥å£å®ç°ã€‚æ‰€ä»¥ï¼Œç›¸åŒåºåˆ—çš„è®°å½•ï¼ŒåŠ ä¸Šä¸€äº›å¶ å°”å‡ºç°çš„é‡å¤æ•°æ®ï¼Œéƒ½è¢«åˆ†å‘åˆ° Reader äº†ã€‚</p></blockquote><p>è€Œç³»ç»Ÿåªèƒ½ä¿è¯ï¼š</p><blockquote><p>å¦‚æœæ“ä½œæˆåŠŸæ‰§è¡Œï¼Œæ•°æ®ä¸€å®šå·²ç»å†™å…¥åˆ° Chunk çš„æ‰€æœ‰å‰¯æœ¬çš„ç›¸åŒåç§»ä½ç½®ä¸Š</p></blockquote><h2 id="Snapshot"><a href="#Snapshot" class="headerlink" title="Snapshot"></a>Snapshot</h2><p>ä½ å¯ä»¥æŠŠè¿™ä¸ª GFS ç³»ç»Ÿå½“æˆæ˜¯å…è®¸ cow çš„ï¼Œå½“ä½ è¯·æ±‚ snapshot çš„æ—¶å€™ï¼š</p><ol><li>å–æ¶ˆæ‰€æœ‰ç°æœ‰çš„ Lease, å¹¶å†™ wal</li><li>copy metadata, å¹¶ä¸”è®°å½• rc, æ‹·è´æœ‰åŒæ ·çš„ metadata</li><li>å¤„ç†å†™ chunk çš„æ—¶å€™ï¼Œå¦‚æœæ˜¯å¿«ç…§å†™ Cï¼ŒMaster ä¼š copy ä¸€ä»½æ–° chunk Câ€™</li></ol>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Go Concurrency Patterns</title>
      <link href="/2020/02/19/Go-Concurrency-Patterns-Pipeline/"/>
      <url>/2020/02/19/Go-Concurrency-Patterns-Pipeline/</url>
      
        <content type="html"><![CDATA[<h2 id="Pipeline"><a href="#Pipeline" class="headerlink" title="Pipeline"></a>Pipeline</h2><blockquote><p> Informally, a pipeline is a series of <em>stages</em> connected by channels, where each stage is a group of goroutines running the same function. In each stage, the goroutines</p><ul><li>receive values from <em>upstream</em> via <em>inbound</em> channels</li><li>perform some function on that data, usually producing new values</li><li>send values <em>downstream</em> via <em>outbound</em> channels</li></ul></blockquote><p>ä½ å¯èƒ½å¯¹ OS é‡Œé¢çš„ pipeline ç›¸å½“ç†Ÿæ‚‰ï¼Œæ¯å¤©éƒ½ç”¨ã€‚å®é™…ä¸Šç”šè‡³åœ¨ 6.828 2019 ä½œä¸šé‡Œé¢è¿˜å®ç°äº†ä¸€ä¸ªç±»ä¼¼çš„æ¨¡å¼å®ç° prime: <a href="https://pdos.csail.mit.edu/6.828/2019/labs/util.html">https://pdos.csail.mit.edu/6.828/2019/labs/util.html</a></p><p>è¿™ä¸ª pipeline æ„æ€æ˜¯é€šè¿‡ <code>fn(in chan) out chan</code> è¿™æ ·çš„æ¨¡å¼ä¸åœå¥— channel é“¾ï¼Œæœ€åæä¾›ç»™ä¸€ä¸ªæ¶ˆè´¹è€…ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">chan1 := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">int</span>)</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">2</span>; i &lt; <span class="number">100</span>; i++ &#123;</span><br><span class="line">chan1 &lt;- i</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">close</span>(chan1)</span><br><span class="line">&#125;()</span><br><span class="line">primeChan := Filter(chan1, IsPrime)</span><br><span class="line"><span class="keyword">for</span> prime := <span class="keyword">range</span> primeChan &#123;</span><br><span class="line">fmt.Println(<span class="string">&quot;Recv prime: &quot;</span>, prime)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ ·ç”šè‡³èƒ½å¾ˆå‡½æ•°å¼(bushi)çš„å¥—åœˆï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">// Set up the pipeline and consume the output.</span></span><br><span class="line">    <span class="keyword">for</span> n := <span class="keyword">range</span> sq(sq(gen(<span class="number">2</span>, <span class="number">3</span>))) &#123;</span><br><span class="line">        fmt.Println(n) <span class="comment">// 16 then 81</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Fan-in-fan-out"><a href="#Fan-in-fan-out" class="headerlink" title="Fan-in/fan-out"></a>Fan-in/fan-out</h3><blockquote><p>Multiple functions can read from the same channel until that channel is closed; this is called <em>fan-out</em>. This provides a way to distribute work amongst a group of workers to parallelize CPU use and I/O.</p><p>A function can read from multiple inputs and proceed until all are closed by multiplexing the input channels onto a single channel thatâ€™s closed when all the inputs are closed. This is called <em>fan-in</em>.</p></blockquote><p>chan å…¶å®ç±»ä¼¼ä¸€ä¸ªå¾ˆè¯¡å¼‚(niubi)çš„ mpms çš„ queueã€‚ä¸Šè¿°çš„ <code>sq</code> , <code>gen</code> éƒ½æ˜¯ï¼š</p><ul><li>æ¥å—ä¸€ä¸ª/é›¶ä¸ª in channel</li><li>apply ä¸€ç³»åˆ—æ“ä½œ</li><li>åå‡ºä¸€ä¸ª out channel</li></ul><p>åšå®¢ä¸­æä¾›äº†ä¸€ä¸ª <code>merge</code> å‡½æ•°çš„ä¾‹å­ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    in := gen(<span class="number">2</span>, <span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Distribute the sq work across two goroutines that both read from in.</span></span><br><span class="line">    c1 := sq(in)</span><br><span class="line">    c2 := sq(in)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Consume the merged output from c1 and c2.</span></span><br><span class="line">    <span class="keyword">for</span> n := <span class="keyword">range</span> merge(c1, c2) &#123;</span><br><span class="line">        fmt.Println(n) <span class="comment">// 4 then 9, or 9 then 4</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå‡½æ•°åŒæ—¶åšäº† fan-in å’Œ fan-out:</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">merge</span><span class="params">(cs ...&lt;-<span class="keyword">chan</span> <span class="type">int</span>)</span></span> &lt;-<span class="keyword">chan</span> <span class="type">int</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> wg sync.WaitGroup</span><br><span class="line">    out := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">int</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Start an output goroutine for each input channel in cs.  output</span></span><br><span class="line">    <span class="comment">// copies values from c to out until c is closed, then calls wg.Done.</span></span><br><span class="line">    output := <span class="function"><span class="keyword">func</span><span class="params">(c &lt;-<span class="keyword">chan</span> <span class="type">int</span>)</span></span> &#123;</span><br><span class="line">        <span class="keyword">for</span> n := <span class="keyword">range</span> c &#123;</span><br><span class="line">            out &lt;- n</span><br><span class="line">        &#125;</span><br><span class="line">        wg.Done()</span><br><span class="line">    &#125;</span><br><span class="line">    wg.Add(<span class="built_in">len</span>(cs))</span><br><span class="line">    <span class="keyword">for</span> _, c := <span class="keyword">range</span> cs &#123;</span><br><span class="line">        <span class="keyword">go</span> output(c)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Start a goroutine to close out once all the output goroutines are</span></span><br><span class="line">    <span class="comment">// done.  This must start after the wg.Add call.</span></span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        wg.Wait()</span><br><span class="line">        <span class="built_in">close</span>(out)</span><br><span class="line">    &#125;()</span><br><span class="line">    <span class="keyword">return</span> out</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ³¨æ„åˆ°æˆ‘ä»¬å‰ä¸€ç¯‡åšå®¢æåˆ°çš„ä¸€äº›é—®é¢˜ï¼Œæ¯”å¦‚ errors çš„å¤„ç†å’Œ goroutine æ³„æ¼ï¼š</p><blockquote><p>There is a pattern to our pipeline functions:</p><ul><li>stages close their outbound channels when all the send operations are done.</li><li>stages keep receiving values from inbound channels until those channels are closed.</li></ul><p>This pattern allows each receiving stage to be written as a <code>range</code> loop and ensures that all goroutines exit once all values have been successfully sent downstream.</p><p>But in real pipelines, stages donâ€™t always receive all the inbound values. Sometimes this is by design: the receiver may only need a subset of values to make progress. More often, a stage exits early because an inbound value represents an error in an earlier stage. In either case the receiver should not have to wait for the remaining values to arrive, and we want earlier stages to stop producing values that later stages donâ€™t need.</p></blockquote><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">    <span class="comment">// Consume the first value from the output.</span></span><br><span class="line">    out := merge(c1, c2)</span><br><span class="line">    fmt.Println(&lt;-out) <span class="comment">// 4 or 9</span></span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">    <span class="comment">// Since we didn&#x27;t receive the second value from out,</span></span><br><span class="line">    <span class="comment">// one of the output goroutines is hung attempting to send it.</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯¹äºè¿™æ ·çš„æ¶ˆè´¹è€…ï¼Œç”Ÿäº§çš„ goroutine ä¼šå¡ä½ â€”&gt; æ³„æ¼ã€‚ä¸€å®šç¨‹åº¦ä¸Šï¼Œå¯ä»¥ç”¨ buffer + close è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">gen</span><span class="params">(nums ...<span class="type">int</span>)</span></span> &lt;-<span class="keyword">chan</span> <span class="type">int</span> &#123;</span><br><span class="line">    out := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">int</span>, <span class="built_in">len</span>(nums))</span><br><span class="line">    <span class="keyword">for</span> _, n := <span class="keyword">range</span> nums &#123;</span><br><span class="line">        out &lt;- n</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">close</span>(out)</span><br><span class="line">    <span class="keyword">return</span> out</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ’å…¥ä¸€æ®µ-goroutine-çŸ¥è¯†"><a href="#æ’å…¥ä¸€æ®µ-goroutine-çŸ¥è¯†" class="headerlink" title="æ’å…¥ä¸€æ®µ goroutine çŸ¥è¯†"></a>æ’å…¥ä¸€æ®µ goroutine çŸ¥è¯†</h3><p>æˆ‘ä»¬çš„ channel å’Œ close æœ‰ä»€ä¹ˆè§„åˆ™å‘¢ï¼š</p><ul><li>channel æ˜¯ FIFO çš„</li><li>å¦‚æœå» close, Channel æ˜¯ä¸€ä¸ªç©ºæŒ‡é’ˆæˆ–è€…å·²ç»è¢«å…³é—­æ—¶ï¼ŒGo è¯­è¨€è¿è¡Œæ—¶éƒ½ä¼šç›´æ¥ <code>panic</code> å¹¶æŠ›å‡ºå¼‚å¸¸</li><li>close çš„æ—¶å€™ä¸èƒ½æ˜¯<code>&lt;-chan</code>, å³å•å‘æ¥å—çš„ channel</li><li>Channel å’Œ goroutine çš„ GCï¼šä¸€è¾¹æœ‰æ•°æ®å°±ä¸èƒ½ gc.</li></ul><p>å…·ä½“å‚è€ƒ Detailed Explanations for Channel Operations ä¸€èŠ‚ï¼Œå¯ä»¥çœ‹åˆ°ï¼š</p><blockquote><p>To make the explanations for channel operations simple and clear, in the remaining of this article, channels will be classified into three categories:</p><ol><li>nil channels.</li><li>non-nil but closed channels.</li><li>not-closed non-nil channels.</li></ol><p>The following table simply summarizes the behaviors for all kinds of operations applying on nil, closed and not-closed non-nil channels.</p><div class="table-container"><table><thead><tr><th style="text-align:center">Operation</th><th style="text-align:center">A Nil Channel</th><th style="text-align:center">A Closed Channel</th><th style="text-align:center">A Not-Closed Non-Nil Channel</th></tr></thead><tbody><tr><td style="text-align:center">Close</td><td style="text-align:center">panic</td><td style="text-align:center">panic</td><td style="text-align:center">succeed to close (C)</td></tr><tr><td style="text-align:center">Send Value To</td><td style="text-align:center">block for ever</td><td style="text-align:center">panic</td><td style="text-align:center">block or succeed to send (B)</td></tr><tr><td style="text-align:center">Receive Value From</td><td style="text-align:center">block for ever</td><td style="text-align:center">never block (D)</td><td style="text-align:center">block or succeed to receive (A)</td></tr></tbody></table></div></blockquote><p>å…¶å®æˆ‘æŒºå¥½å¥‡çš„ï¼Œ Rust åŒºåˆ†äº† sender receiver, è¿™é‡Œä¸ºå•¥ä¸â€¦</p><h3 id="Explicit-cancellation"><a href="#Explicit-cancellation" class="headerlink" title="Explicit cancellation"></a>Explicit cancellation</h3><blockquote><p>When <code>main</code> decides to exit without receiving all the values from <code>out</code>, it must tell the goroutines in the upstream stages to abandon the values theyâ€™re trying to send. It does so by sending values on a channel called <code>done</code>. It sends two values since there are potentially two blocked senders:</p></blockquote><p>å…·ä½“æ¥è¯´ï¼Œä¸‹æ¸¸å·²ç»æ‹¿åˆ°äº†æ•°æ®æˆ–è€…å‡ºç°äº† err, éœ€è¦å‘Šè¯‰ä¸Šæ¸¸è¿™æ ·çš„æ¶ˆæ¯ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    in := gen(<span class="number">2</span>, <span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Distribute the sq work across two goroutines that both read from in.</span></span><br><span class="line">    c1 := sq(in)</span><br><span class="line">    c2 := sq(in)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Consume the first value from output.</span></span><br><span class="line">    done := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span><br><span class="line">    <span class="keyword">defer</span> <span class="built_in">close</span>(done)</span><br><span class="line">    out := merge(done, c1, c2)</span><br><span class="line">    fmt.Println(&lt;-out) <span class="comment">// 4 or 9</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åŠ å…¥äº† done è¿™ä¸ª flag åï¼Œè¿™é‡Œåªéœ€è¦ä¸€ä¸ªå€¼ï¼ŒåŒæ—¶æœ‰ä¸¤ä¸ª input channel. é‚£ä¹ˆï¼Œmerge æˆ‘ä»¬å¯ä»¥å®ç°ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">merge</span><span class="params">(done &lt;-<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;, cs ...&lt;-<span class="keyword">chan</span> <span class="type">int</span>)</span></span> &lt;-<span class="keyword">chan</span> <span class="type">int</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> wg sync.WaitGroup</span><br><span class="line">    out := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">int</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Start an output goroutine for each input channel in cs.  output</span></span><br><span class="line">    <span class="comment">// copies values from c to out until c is closed or it receives a value</span></span><br><span class="line">    <span class="comment">// from done, then output calls wg.Done.</span></span><br><span class="line">    output := <span class="function"><span class="keyword">func</span><span class="params">(c &lt;-<span class="keyword">chan</span> <span class="type">int</span>)</span></span> &#123;</span><br><span class="line">        <span class="keyword">defer</span> wg.Done()</span><br><span class="line">        <span class="keyword">for</span> n := <span class="keyword">range</span> c &#123;</span><br><span class="line">            <span class="keyword">select</span> &#123;</span><br><span class="line">            <span class="keyword">case</span> out &lt;- n:</span><br><span class="line">            <span class="keyword">case</span> &lt;-done:</span><br><span class="line">               <span class="keyword">return</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    wg.Add(<span class="built_in">len</span>(cs))</span><br><span class="line">    <span class="keyword">for</span> _, c := <span class="keyword">range</span> cs &#123;</span><br><span class="line">        <span class="keyword">go</span> output(c)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Start a goroutine to close out once all the output goroutines are</span></span><br><span class="line">    <span class="comment">// done.  This must start after the wg.Add call.</span></span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        wg.Wait()</span><br><span class="line">        <span class="built_in">close</span>(out)</span><br><span class="line">    &#125;()</span><br><span class="line">    <span class="keyword">return</span> out</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>bitcoin</title>
      <link href="/2020/01/31/bitcoin/"/>
      <url>/2020/01/31/bitcoin/</url>
      
        <content type="html"><![CDATA[<h2 id="Bitcoin"><a href="#Bitcoin" class="headerlink" title="Bitcoin"></a>Bitcoin</h2><p>bitcoin ä¸»è¦è§£å†³çš„é—®é¢˜ï¼ˆæˆ‘ç›¸ä¿¡ä½ ä»¬åœ¨å„ç§åœ°æ–¹çœ‹è¿‡ä¸€ä¸‡éäº†ï¼‰ï¼š</p><ul><li>forgery: ä¼ªé€ </li><li>double spending </li><li>theft</li></ul><p>æˆ‘ä»¬éœ€è¦è€ƒé‡çš„é—®é¢˜æ˜¯ï¼š</p><ul><li>åŒºå—é“¾æ˜¯æ€ä¹ˆå­˜å‚¨çš„ï¼ŒTransaction Block è¿™äº›ç»“æ„çš„å…³ç³»æ˜¯ä»€ä¹ˆ</li><li>å¦‚ä½•é˜²æ­¢é”™è¯¯</li><li>å¦‚ä½•é˜²æ­¢distributed system ç»å¸¸å‡ºç°çš„é—®é¢˜</li></ul><h3 id="Transaction"><a href="#Transaction" class="headerlink" title="Transaction"></a>Transaction</h3><p>Bitcoin çš„ idea æ˜¯æŠŠæ•°æ®å½“æˆæ˜¯ signed sequence of transactions</p><blockquote><p>every coin has a sequence of transaction records one for each time this coin was transferred as payment a coinâ€™s latest transaction indicates who owns it now</p></blockquote><p>åœ¨è®ºæ–‡ä¸­ï¼Œ txn æ ¼å¼æ˜¯ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pub(user1): public key of new owner</span><br><span class="line">hash(prev): hash of this coin&#x27;s previous transaction record</span><br><span class="line">sig(user2): signature over transaction by previous owner&#x27;s private key</span><br><span class="line">(BitCoin is much more complex: amount (fractional), multiple in/out, ...)</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹çœ‹ä»–çš„ Transaction Example</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Y owns a coin, previously given to it by X: </span><br><span class="line">// X-&gt;Y coin, T7: pub(Y), hash(T6) å‰ä¸€æ¬¡äº¤æ˜“, sig(X) X ç”¨ private key ç­¾åå‡ºçš„å”¯ä¸€å€¼</span><br><span class="line">    T7: pub(Y), hash(T6), sig(X)</span><br></pre></td></tr></table></figure><p>è·Ÿç€ä¸Šé¢çš„</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Y buys a hamburger from Z and pays with this coin</span><br><span class="line">// Y æ‹¿åˆ° Z çš„ pub key</span><br><span class="line">  Z sends public key to Y</span><br><span class="line">  // pub key å¯ä»¥ç”¨äºåŠ å¯†ï¼ŒY åˆ›å»ºè®°å½•</span><br><span class="line">  Y creates a new transaction and signs it</span><br><span class="line">  T8: pub(Z), hash(T7), sig(Y)</span><br></pre></td></tr></table></figure><p>éªŒè¯ï¼šT8 çš„ sig å’Œ T7 çš„ pub æ˜¯ä¸€æ ·çš„</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Y sends transaction record to Z</span><br><span class="line">Z verifies:</span><br><span class="line">  T8&#x27;s sig() corresponds to T7&#x27;s pub()</span><br><span class="line">Z gives hamburger to Y</span><br></pre></td></tr></table></figure><p>Z çš„ä½™é¢æ˜¯ Z çŸ¥é“çš„æ²¡æœ‰èŠ±è´¹çš„ transaction è®°å½•ï¼ˆæ„Ÿè§‰è¿™ä¸ªè¿‡ç¨‹ç±»ä¼¼äºä» log ä¸­è¯»ï¼‰</p><blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Z &quot;owns&quot; a coin = Z knows private key for &quot;new owner&quot; public key in latest xaction</span><br></pre></td></tr></table></figure></blockquote><p>ä¹Ÿå°±æ˜¯è¯´ï¼ŒZ æœ‰ä¸€ä¸ªå¸ï¼Œè¡¨ç¤º Z çŸ¥é“ T8 çš„ pub(Z) å¯ä»¥è§£æå‡ºæ¥å¤šå°‘ ï¼ˆxaction == Transactionï¼‰</p><p>å¦‚ä½•é˜²æ­¢ä¸€ä¸ªç­¾åçš„ double-spending</p><blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">what do we need?</span><br><span class="line">  publish log of all transactions to everyone, in same order</span><br><span class="line">    so Q knows about Y-&gt;Z, and will reject Y-&gt;Q</span><br><span class="line">    a &quot;public ledger&quot;</span><br><span class="line">  ensure Y can&#x27;t un-publish a transaction</span><br></pre></td></tr></table></figure></blockquote><p>åœ¨äº‹å®ä¸Šè¦æ±‚å¯¹æ–¹å¹¿æ’­ ä¸‹é¢è¿™æ®µä»‹ç»äº†å’Œ raft ä¹‹ç±» consensus çš„åŒºåˆ«</p><blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">why not publish transactions like this:</span><br><span class="line">  1000s of peers, run by anybody, no trust required in any one peer</span><br><span class="line">  peers flood new transactions over &quot;overlay&quot;</span><br><span class="line">  transaction Y-&gt;Z only acceptable if majority of peers think it is valid</span><br><span class="line">    i.e. they don&#x27;t know of any Y-&gt;Q</span><br><span class="line">    hopefully majority overlap ensures double-spend is detected</span><br><span class="line">  how to count votes?</span><br><span class="line">    how to even count peers so you know what a majority is?</span><br><span class="line">    perhaps distinct IP addresses?</span><br><span class="line">  problem: &quot;sybil attack&quot; // å¥³å·«æ”»å‡»ï¼Œåˆ¶é€ å¤§é‡èŠ‚ç‚¹åŠ å…¥ç³»ç»Ÿ</span><br><span class="line">    IP addresses are not secure -- easy to forge</span><br><span class="line">    attacker pretends to have 10,000 computers -- majority</span><br><span class="line">    when Z asks, attacker&#x27;s majority says &quot;we only know of Y-&gt;Z&quot;</span><br><span class="line">    when Q asks, attacker&#x27;s majority says &quot;we only know of Y-&gt;Q&quot;</span><br><span class="line">  voting is hard in &quot;open&quot; p2p schemes</span><br></pre></td></tr></table></figure></blockquote><h3 id="Block-Chain"><a href="#Block-Chain" class="headerlink" title="Block Chain"></a>Block Chain</h3><p>æ˜¯ä¸€ä¸ª agreement on transaction log to prevent double-spending</p><p>åŒ…å«äº† transaction çš„æ•´ä¸ªè®°å½•ï¼Œç„¶åæœ‰å¾ˆå¤š replica (è®ºæ–‡ä¸­å« peers, è¿™é‡ŒæŒ‡çš„æ˜¯åˆ«çš„åŒºå—é“¾ç³»ç»Ÿï¼Œå« replica ä¹Ÿä¸å¤ªåˆé€‚)</p><ul><li>æ¯ä¸ªåŒ…å«å®Œæ•´çš„å¤‡ä»½ï¼ˆå¤ª tm æµªè´¹äº†å§ï¼‰</li><li>new block / transaction éœ€è¦å¹¿æ’­ç»™å…¶ä»–çš„ peers</li></ul><p>æ¯ä¸ª block åŒ…å«ï¼š</p><ul><li>hash(prev_block) // æ³¨æ„æ˜¯ block</li><li>ä¸€ä¸ª transaction çš„é¡ºåºé›†åˆ </li><li>â€œnonceâ€ (not quite a nonce in the usual cryptographic sense)</li><li>current time: ç°åœ¨çš„æ—¶é—´æˆ³</li></ul><p>å°½é‡æ¯10åˆ†é’Ÿäº§ç”Ÿä¸€ä¸ª block chain, åŒæ—¶è®°å½•åªæœ‰è¢«æ”¾åœ¨ block chain ä¸Šæ‰ä¼šè¢«ä¿¡ä»»</p><blockquote><p>åœ¨è¿›è¡Œéšæœºæ•£åˆ—è¿ç®—æ—¶ï¼Œå·¥ä½œé‡è¯æ˜æœºåˆ¶å¼•å…¥äº†å¯¹æŸä¸€ä¸ªç‰¹å®šå€¼çš„æ‰«æå·¥ä½œï¼Œæ¯”æ–¹è¯´ SHAâ€256 ä¸‹ï¼Œéšæœºæ•£åˆ—å€¼ä»¥ä¸€ä¸ªæˆ–å¤šä¸ª 0 å¼€å§‹ã€‚é‚£ä¹ˆéšç€ 0 çš„æ•°ç›®çš„ä¸Šå‡, æ‰¾åˆ°è¿™ä¸ªè§£æ‰€éœ€è¦çš„å·¥ä½œé‡ å°†å‘ˆæŒ‡æ•°å¢é•¿ï¼Œè€Œå¯¹ç»“æœè¿›è¡Œæ£€éªŒåˆ™ä»…éœ€è¦ä¸€æ¬¡éšæœºæ•£åˆ—è¿ç®—ã€‚</p></blockquote><p>block çš„åˆ›å»ºæ˜¯ç”± mining æ¥åšçš„ï¼Œå¤šä¸ª cpu å°è¯•å¾ˆå¤šæ¬¡ï¼Œæ¥æŒ–å‡ºæ–°çš„ block. åœ¨è¿™ä¸ªç³»ç»Ÿä¸­å¯èƒ½ä¼šæœ‰å‡ ä¸ªé—®é¢˜ï¼Œæˆ‘è®°å¾—æˆ‘ä»¬åœ¨ Raft ä¸­ä¹Ÿæœ‰ç±»ä¼¼çš„é—®é¢˜</p><ul><li>é¡ºåºæäº¤ï¼šæ¶ˆæ¯çš„æäº¤è¦æ±‚æ˜¯é¡ºåºçš„ï¼Œè¿™ä¸ªåœ¨ Raft ä¸­ç”±å•ä¸ª master æ¥å¤„ç†</li><li>blockchain fork: ç”±äºç½‘ç»œåˆ†åŒºæˆ–è€…ä¸¤ä¸ªpeer åŒæ—¶ç®—å‡ºäº†æ–°çš„blockç­‰åŸå› ï¼Œ blockchain è¢«åˆ†æˆæ²¡æœ‰å…±è¯†çš„å¤šä¸ªã€‚</li></ul><p>å…ˆä»‹ç»ç¬¬äºŒä¸ªé—®é¢˜ï¼Œbitcoin è§£å†³çš„æ–¹æ¡ˆæ˜¯ï¼š</p><ul><li>åŒæ ·é•¿åº¦ã€æ–° block ä¸åŒçš„ chain éƒ½ä¼šè¢«ä¿æŒ, ç›´åˆ°æ–°çš„æœ€é•¿çºªå½•è¦†ç›–</li><li>å‡è®¾æ–°äº§ç”Ÿäº† BZ/BQ ä¸¤æ¡é“¾ï¼Œæœ‰æ›´å¤šè¢«è§‚æµ‹åˆ°çš„ä¸€æ–¹ï¼Œæœ‰æ›´å¤šæœºå™¨ï¼Œ<em>æ›´å¤§æ¦‚ç‡</em>æ‰¾åˆ°æ–°çš„èŠ‚ç‚¹ï¼Œç„¶åæ›´é•¿çš„ block-chain ä¼šè¢« apply</li><li>åœ¨ä¸€ä¸ªç³»ç»Ÿï¼ˆåˆ†åŒºå†…éƒ¨ï¼‰ä¼šä¸‹è½½è¢« apply çš„åŒºå—é“¾</li></ul><p>ç¬¬äºŒä¸ªé—®é¢˜è¿˜ä¼šæœ‰å˜ä½“ï¼šY ç”¨åŒä¸€ä¸ª hash ç»™ä¸åŒ block chain å‘é€ï¼Œä¼šé€ æˆåˆ†è£‚ï¼›ç»™åŒä¸€ä¸ªå‘é€çš„æ—¶å€™ï¼Œä¸ä¼šå®¹è®¸è¿™ç§é¡ºåºå‡ºç°ã€‚</p><h3 id="æ¿€åŠ±"><a href="#æ¿€åŠ±" class="headerlink" title="æ¿€åŠ±"></a>æ¿€åŠ±</h3><p>å‰æ–‡ä»‹ç»äº† mining, æŒ–çŸ¿çš„è¿‡ç¨‹ä¸­, æ–°åŒºå—ä¼šé™„å¸¦ä¸€ä¸ªç”±åˆ›é€ è€…æ‹¥æœ‰çš„ç”µå­è´§å¸ã€‚</p><p>åŒæ—¶ï¼Œä¹Ÿæœ‰äº¤æ˜“è´¹ã€‚è¾“å‡ºå°äºè¾“å…¥æ—¶ï¼Œå·®é¢æ˜¯äº¤æ˜“è´¹</p><h3 id="Reclaiming-Disk-Space"><a href="#Reclaiming-Disk-Space" class="headerlink" title="Reclaiming Disk Space"></a><strong>Reclaiming Disk Space</strong></h3><p>Once the latest transaction in a coin is buried under enough blocks, the spent transactions before it can be discarded to save disk space.</p><h2 id="FAQ"><a href="#FAQ" class="headerlink" title="FAQ"></a>FAQ</h2><h4 id="æ˜¯ä¸æ˜¯-signature-å°±è¶³å¤Ÿäº†"><a href="#æ˜¯ä¸æ˜¯-signature-å°±è¶³å¤Ÿäº†" class="headerlink" title="æ˜¯ä¸æ˜¯ signature å°±è¶³å¤Ÿäº†"></a>æ˜¯ä¸æ˜¯ signature å°±è¶³å¤Ÿäº†</h4><p>ç­”ï¼šä¸æ˜¯ï¼Œå¯èƒ½ä¼šæœ‰äººæŠŠè¿™ä¸ª signature copy ä¸€ä»½ï¼Œç„¶åé‡å¤è½¬è´¦äº¤æ˜“è¡Œä¸º</p><h4 id="Proof-of-work-çš„-purpose"><a href="#Proof-of-work-çš„-purpose" class="headerlink" title="Proof-of-work çš„ purpose"></a>Proof-of-work çš„ purpose</h4><p>æ”»å‡»è€…éœ€è¦ 51% æ”»å‡»</p><h4 id="æœ‰æ¯”-pow-æ›´èŠ‚çœèµ„æºçš„ç®—æ³•ä¹ˆ"><a href="#æœ‰æ¯”-pow-æ›´èŠ‚çœèµ„æºçš„ç®—æ³•ä¹ˆ" class="headerlink" title="æœ‰æ¯” pow æ›´èŠ‚çœèµ„æºçš„ç®—æ³•ä¹ˆ"></a>æœ‰æ¯” pow æ›´èŠ‚çœèµ„æºçš„ç®—æ³•ä¹ˆ</h4><blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">A: Proof-of-work is hard to fake or simulate, a nice property in a</span><br><span class="line">totally open system like Bitcoin where you cannot trust anyone to</span><br><span class="line">follow rules. There are some alternate schemes; search the web for</span><br><span class="line">proof-of-stake or look at Algorand and Byzcoin, for example. In a</span><br><span class="line">smallish closed system, in which the participants are known though</span><br><span class="line">not entirely trusted, Byzantine agreement protocols could be used, as</span><br><span class="line">in Hyperledger.</span><br></pre></td></tr></table></figure></blockquote><h4 id="ä¼ æ’­å¾ˆå¤šæ¶ˆæ¯çš„å¤„ç†"><a href="#ä¼ æ’­å¾ˆå¤šæ¶ˆæ¯çš„å¤„ç†" class="headerlink" title="ä¼ æ’­å¾ˆå¤šæ¶ˆæ¯çš„å¤„ç†"></a>ä¼ æ’­å¾ˆå¤šæ¶ˆæ¯çš„å¤„ç†</h4><blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">There&#x27;s a small chance that two miners find blocks at the same time,</span><br><span class="line">perhaps B50&#x27; containing &quot;pay Bob&quot; and B50&#x27;&#x27; containing &quot;pay Charlie&quot;. At</span><br><span class="line">this point there&#x27;s a fork in the block chain. These two blocks will be</span><br><span class="line">flooded to all the nodes. Each node will start mining a successor to one</span><br><span class="line">of them (the first it hears). Again the most likely outcome is that a</span><br><span class="line">single miner will finish significantly before any other miner, and flood</span><br><span class="line">the successor, and most peers will switch that winning fork. The chance</span><br><span class="line">of repeatedly having two miners simultaneously find blocks gets very</span><br><span class="line">small as the forks get longer. So eventually all the peers will switch</span><br><span class="line">to the same fork, and in fork there will be only one spend of the coin.</span><br><span class="line"></span><br><span class="line">The possibility of accidentally having a short-lived fork is the reason</span><br><span class="line">that careful clients will wait until there are a few successor blocks</span><br><span class="line">before believing a transaction.</span><br></pre></td></tr></table></figure></blockquote><h4 id="éšç€åŒºå—é“¾çš„å¢é•¿ï¼Œæ–°åŠ å…¥ä¸€ä¸ªèŠ‚ç‚¹ä¼šä¸ä¼šè€—æ—¶å¾ˆä¹…"><a href="#éšç€åŒºå—é“¾çš„å¢é•¿ï¼Œæ–°åŠ å…¥ä¸€ä¸ªèŠ‚ç‚¹ä¼šä¸ä¼šè€—æ—¶å¾ˆä¹…" class="headerlink" title="éšç€åŒºå—é“¾çš„å¢é•¿ï¼Œæ–°åŠ å…¥ä¸€ä¸ªèŠ‚ç‚¹ä¼šä¸ä¼šè€—æ—¶å¾ˆä¹…"></a>éšç€åŒºå—é“¾çš„å¢é•¿ï¼Œæ–°åŠ å…¥ä¸€ä¸ªèŠ‚ç‚¹ä¼šä¸ä¼šè€—æ—¶å¾ˆä¹…</h4><ul><li>ä¸€æ—¦ä¸‹è½½å®Œäº†å°±ä¸å†éœ€è¦äº†</li><li>ä¸€äº› user å¯ä»¥ä¿¡ä»»èº«è¾¹æœ‰å®Œæ•´çš„ chain çš„ç”¨æˆ·ï¼ˆæˆ–è€…çŸ¿å·¥ï¼Ÿï¼‰</li></ul><h4 id="51-æ”»å‡»"><a href="#51-æ”»å‡»" class="headerlink" title="51 æ”»å‡»"></a>51 æ”»å‡»</h4><p>å¯¹äº 51% æ”»å‡»ï¼š<a href="https://www.coindesk.com/51-attacks-real-threat-bitcoin">https://www.coindesk.com/51-attacks-real-threat-bitcoin</a> å®é™…ä¸Šå‡ºç° 51% è¿™ä¸ªç³»ç»Ÿå°± GG äº†</p><h4 id="SHA-256-ä¹‹å¤–çš„æ–¹æ¡ˆ"><a href="#SHA-256-ä¹‹å¤–çš„æ–¹æ¡ˆ" class="headerlink" title="SHA-256 ä¹‹å¤–çš„æ–¹æ¡ˆ"></a>SHA-256 ä¹‹å¤–çš„æ–¹æ¡ˆ</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Q: Are there any ways for Bitcoin mining to do useful work, beyond simply</span><br><span class="line">brute-force calculating SHA-256 hashes?</span><br><span class="line"></span><br><span class="line">A: Maybe -- here are two attempts to do what you suggest:</span><br><span class="line">https://www.cs.umd.edu/~elaine/docs/permacoin.pdf</span><br><span class="line">http://primecoin.io/</span><br></pre></td></tr></table></figure><p>é˜…è¯»æ¯”ç‰¹å¸è®ºæ–‡æœ‰æ„Ÿï¼š</p><ul><li>å—¯ï¼Œæ¯ä¸ªåŒºå—ä¼šå­˜æ‰€æœ‰çš„ä¿¡æ¯â€¦æ‰€æœ‰ä¿¡æ¯ï¼Ÿä»€ä¹ˆå‡ æŠŠï¼Ÿå“¦æœ‰ä¸ª merkle tree, ç­‰ç­‰ä½ åˆæ²¡æœ‰ snapshot æˆ–è€… compaction, åœ¨è¿™æœ‰é¬¼ç”¨å•Šï¼Œéš¾é“ä½ è·Ÿ buddy ç®—æ³•ä¸€æ · coin æœ‰æ–°çºªå½•å°± mark as delete ç„¶åæŠŠ sibling ä¸€èµ·åˆ æ‰ä¹ˆ</li><li>å—¯ï¼Œå¤„ç†è„‘è£‚â€¦å“¦è¿™ä¸ªå« forkâ€¦ ç­‰ä¼šå„¿ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™ä¸ªç³»ç»Ÿåªæœ‰æœ€ç»ˆä¸€è‡´æ€§ï¼Œä¸èƒ½ä¿è¯è¯»åˆ°æ­£ç¡®çš„æ•°æ®ï¼Ÿç½‘ç»œåˆ†åŒºæ€ä¹ˆåŠï¼Ÿå“¦å¤šç­‰å‡ ä¸ª block éªŒè¯â€¦ä»€ä¹ˆå‡ æŠŠ</li><li>å—¯ï¼Œä¸€ä¸ªé“¾è¦ä¿è¯æ‰€æœ‰çš„è®°å½•æ˜¯æœ‰åºçš„â€¦fuckâ€¦è¿™ä»£ä»·å¤ªé«˜äº†å§</li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> distributed </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MapReduce ç®€è¯»</title>
      <link href="/2020/01/28/MapReduce-%E7%AE%80%E8%AF%BB/"/>
      <url>/2020/01/28/MapReduce-%E7%AE%80%E8%AF%BB/</url>
      
        <content type="html"><![CDATA[<h1 id="MapReduce-è®ºæ–‡é˜…è¯»"><a href="#MapReduce-è®ºæ–‡é˜…è¯»" class="headerlink" title="MapReduce è®ºæ–‡é˜…è¯»"></a>MapReduce è®ºæ–‡é˜…è¯»</h1><blockquote><p>æœ¬æ–‡ä¸»è¦ä»‹ç»äº† MapReduce è®ºæ–‡çš„ç¬¬ä¸‰ç« ã€‚ç¬¬å››ç« ç­‰å†…å®¹æœ€å¥½è‡ªè¡Œå†å»é˜…è¯»ã€‚</p></blockquote><h2 id="ç¼–ç¨‹æ¨¡å‹"><a href="#ç¼–ç¨‹æ¨¡å‹" class="headerlink" title="ç¼–ç¨‹æ¨¡å‹"></a>ç¼–ç¨‹æ¨¡å‹</h2><p>MapReduce ä½¿ç”¨ç±»ä¼¼ fp çš„åŸè¯­æ¥æè¿°ä¸€ä¸ªè®¡ç®—ï¼š</p><blockquote><p>Map(k, v) =&gt; list(k2, v2)</p><p>Reduce(k2, list(v2)) =&gt; list(v2)</p><p>è¾“å…¥çš„k, v != ä¸­é—´çš„ k2, v2 == è¾“å‡ºçš„k2, v2.</p></blockquote><p>å¯ä»¥åšå€’æ’ç´¢å¼•ã€wordcountã€åˆ†å¸ƒå¼æ’åºç­‰äº‹æƒ…ï¼Œå‰ææ˜¯ä½ èƒ½æŠŠä½ çš„ä»»åŠ¡æè¿°æˆmap â€“ reduce å½¢å¼ã€‚</p><h2 id="å®ç°"><a href="#å®ç°" class="headerlink" title="å®ç°"></a>å®ç°</h2><h3 id="æœºå™¨"><a href="#æœºå™¨" class="headerlink" title="æœºå™¨"></a>æœºå™¨</h3><blockquote><ol><li><p>x86 æ¶æ„ã€è¿è¡Œ Linux æ“ä½œç³»ç»Ÿã€åŒå¤„ç†å™¨ã€2-4GB å†…å­˜çš„æœºå™¨ã€‚</p></li><li><p>æ™®é€šçš„ç½‘ç»œç¡¬ä»¶è®¾å¤‡ï¼Œæ¯ä¸ªæœºå™¨çš„å¸¦å®½ä¸ºç™¾å…†æˆ–è€…åƒå…†ï¼Œä½†æ˜¯è¿œå°äºç½‘ç»œçš„å¹³å‡å¸¦å®½çš„ä¸€åŠã€‚</p></li><li><p>é›†ç¾¤ä¸­åŒ…å«æˆç™¾ä¸Šåƒçš„æœºå™¨ï¼Œå› æ­¤ï¼Œæœºå™¨æ•…éšœæ˜¯å¸¸æ€ã€‚</p></li><li><p>å­˜å‚¨ä¸ºå»‰ä»·çš„å†…ç½® IDE ç¡¬ç›˜ã€‚ä¸€ä¸ªå†…éƒ¨åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿç”¨æ¥ç®¡ç†å­˜å‚¨åœ¨è¿™äº›ç£ç›˜ä¸Šçš„æ•°æ®ã€‚æ–‡ä»¶ç³»</p><p>ç»Ÿé€šè¿‡æ•°æ®å¤åˆ¶æ¥åœ¨ä¸å¯é çš„ç¡¬ä»¶ä¸Šä¿è¯æ•°æ®çš„å¯é æ€§å’Œæœ‰æ•ˆæ€§ã€‚</p></li><li><p>ç”¨æˆ·ô°‚äº¤å·¥ä½œ(job)ç»™è°ƒåº¦ç³»ç»Ÿã€‚æ¯ä¸ªå·¥ä½œ(job)éƒ½åŒ…å«ä¸€ç³»åˆ—çš„ä»»åŠ¡(task)ï¼Œè°ƒåº¦ç³»ç»Ÿå°†è¿™äº›ä»»</p><p>åŠ¡è°ƒåº¦åˆ°é›†ç¾¤ä¸­å¤šå°å¯ç”¨çš„æœºå™¨ä¸Šã€‚</p></li></ol></blockquote><p>åœ¨åŸå§‹è®ºæ–‡ä¸­ï¼Œæåˆ°äº†ä¸Šè¿°çš„ç¯å¢ƒï¼Œä½†æ˜¯ä¸çŸ¥é“å¦‚æœç”¨å†…å­˜è®¡ç®—å¹¶å†™å­˜å–éƒ½åœ¨å†…å­˜çš„è¯ï¼Œä¼šä¸ä¼šå¯¹æœºå™¨æ€§èƒ½è¦æ±‚é«˜å¾ˆå¤šã€‚</p><h3 id="ä¸»è¦æµç¨‹"><a href="#ä¸»è¦æµç¨‹" class="headerlink" title="ä¸»è¦æµç¨‹"></a>ä¸»è¦æµç¨‹</h3><p><img src="https://nmsl.maplewish.cn/blog:/Users/fuasahi/Desktop/writing/MapReduce.md:mapreduce%E6%B5%81%E7%A8%8B.png" alt="mapreduceæµç¨‹"></p><p>å¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œæœ‰ map-worker å’Œ reduce-worker. Map Reduce åˆ†åŒºæ•°é‡ç”±ç”¨æˆ·å®šä¹‰ã€‚</p><p>æ“ä½œæŒ‰è®ºæ–‡è¯´æœ‰ä¸€äº›æµç¨‹ï¼Œç…§æ¬ä¸å¤ªå¥½ï¼Œæˆ‘å°±è¯´ä¸‹è‡ªå·±çš„ç†è§£ï¼š</p><ol><li>å°†è¾“å…¥æ–‡ä»¶åˆ† M æ®µï¼Œå®šä¹‰ä¸€å®šçš„æ•°æ®æ®µå¤§å°(åŸå§‹è®ºæ–‡ç»™16-64MB)</li><li>ç”¨æˆ·ç¨‹åºåˆ›å»ºå¤§é‡çš„ map reduce å·¥ä½œå‰¯æœ¬, æœ‰ workers å’Œ masterã€‚è®ºæ–‡é‡Œé¢åªæœ‰ä¸€ä¸ª master, ä¼¼ä¹ Hadoop MapReduce å…è®¸ä½ é…ç½®å¤‡ç”¨çš„ Master.</li><li>master åˆ†é…ä»»åŠ¡ç»™ç©ºé—² workerï¼Œæœ‰Må’ŒRä¸ª map å’Œ reduce ä»»åŠ¡</li><li><strong>Map worker</strong> å®Œæˆè®¡ç®—ï¼Œå¹¶ä¸”æŠŠæ•°æ®<strong>ç¼“å­˜</strong>åœ¨<strong>å†…å­˜</strong>ä¸­ï¼Œ <code>k2, v2</code> å¯¹è‡ªåŠ¨åˆ†åŒºæˆ R ä¸ªï¼Œå†™åœ¨ <strong>æœ¬åœ°æ–‡ä»¶</strong> ä¸­ï¼Œæ¶ˆæ¯è¢«ä¼ ç»™master, master æŠŠè¿™ä¸ªä¿¡æ¯ä¼ ç»™ reducer.</li><li>reducer æ¥æ”¶åˆ° master çš„æ¶ˆæ¯åï¼š<ol><li>ç”¨ rpc è¯»å–è¿™äº›æ•°æ®</li><li>æŠŠæ•°æ®æŒ‰ç…§ k2 èšåˆï¼Œä¼¼ä¹è¦æ’åºï¼Ÿ</li><li>å¤„ç†è¿™äº›æ•°æ®ï¼ŒæŒ‰ç…§åˆ†åŒº<strong>è¿½åŠ </strong>å†™åˆ°è¾“å‡ºæ–‡ä»¶</li></ol></li><li>å®Œæˆåï¼ŒRä¸ªåˆ†åŒºæœ‰<strong>è¿½åŠ </strong> çš„ map-reduce æ–‡ä»¶ã€‚</li></ol><h3 id="æ•…éšœå¤„ç†"><a href="#æ•…éšœå¤„ç†" class="headerlink" title="æ•…éšœå¤„ç†"></a>æ•…éšœå¤„ç†</h3><h4 id="worker-æ•…éšœ"><a href="#worker-æ•…éšœ" class="headerlink" title="worker æ•…éšœ"></a>worker æ•…éšœ</h4><p>worker æ•…éšœçš„ä¸»è¦è§£å†³æ–¹æ¡ˆæ˜¯æ ‡è®°æˆé”™è¯¯ï¼Œå¦‚æœæ˜¯ map-worker åˆ™é€šçŸ¥ reduce-worker ï¼ŒæŠŠä»»åŠ¡äº¤ç»™åˆ«äººæ‰§è¡Œã€‚</p><p>æˆ‘å¾ˆå¼Ÿå¼Ÿï¼Œçœ‹çš„æ˜¯è®ºæ–‡ä¸­æ–‡ç¿»è¯‘ï¼Œä½†æ˜¯æ„Ÿè§‰è¿™æ®µå†™çš„æ¯”æˆ‘èƒ½æ€»ç»“çš„å¥½å¾ˆå¤š:</p><blockquote><p>master å‘¨æœŸæ€§çš„ ping æ¯ä¸ª workerã€‚å¦‚æœåœ¨ä¸€ä¸ªçº¦å®šçš„æ—¶é—´èŒƒå›´å†…æ²¡æœ‰æ”¶åˆ° worker è¿”å›çš„ä¿¡æ¯ï¼Œmaster å°†<br>æŠŠè¿™ä¸ª worker æ ‡è®°ä¸ºå¤±æ•ˆã€‚æ‰€æœ‰ç”±è¿™ä¸ªå¤±æ•ˆçš„ worker å®Œæˆçš„ Map ä»»åŠ¡è¢«é‡è®¾ä¸ºåˆå§‹çš„ç©ºé—²çŠ¶æ€ï¼Œä¹‹åè¿™äº›<br>ä»»åŠ¡å°±å¯ä»¥è¢«å®‰æ’ç»™å…¶ä»–çš„ workerã€‚åŒæ ·çš„ï¼Œworker å¤±æ•ˆæ—¶æ­£åœ¨è¿è¡Œçš„ Map æˆ– Reduce ä»»åŠ¡ä¹Ÿå°†è¢«é‡æ–°ç½®ä¸º<br>ç©ºé—²çŠ¶æ€ï¼Œç­‰å¾…é‡æ–°è°ƒåº¦ã€‚</p></blockquote><ol><li>æ€»çš„æ¥è¯´ï¼Œ master ä¼šè·Ÿ worker ä¿æŒ heaet beat</li><li>æ²¡æœ‰è¿”å›çš„è¯ï¼Œä»»åŠ¡ä» ç±»ä¼¼ <em>æ‰§è¡Œä¸­</em> çš„çŠ¶æ€è¢«æ›´æ”¹ä¸º <em>æœªçŸ¥æ€§</em></li><li>ç­‰å¾…ä»»åŠ¡è¢«è°ƒåº¦ç»™åˆ«çš„ worker</li></ol><h4 id="master-æ•…éšœ"><a href="#master-æ•…éšœ" class="headerlink" title="master æ•…éšœ"></a>master æ•…éšœ</h4><p>ç±»ä¼¼å†…å­˜å¤‡ä»½å§ï¼Œå†™walï¼å‘¨æœŸæ€§å†™å…¥ç£ç›˜ä»€ä¹ˆçš„ â€¦ ä¸»è¦æ˜¯å†™å…¥ ckpt, ç„¶åè®©ç³»ç»Ÿèƒ½å¤Ÿ recover</p><h3 id="ä»»åŠ¡ç²’åº¦"><a href="#ä»»åŠ¡ç²’åº¦" class="headerlink" title="ä»»åŠ¡ç²’åº¦"></a>ä»»åŠ¡ç²’åº¦</h3><blockquote><p>ç†æƒ³æƒ…å†µä¸‹ï¼ŒM å’Œ R åº”å½“ æ¯”é›†ç¾¤ä¸­ worker çš„æœºå™¨æ•°é‡è¦å¤šå¾—å¤šã€‚åœ¨æ¯å° worker æœºå™¨éƒ½æ‰§è¡Œå¤§é‡çš„ä¸åŒä»»åŠ¡èƒ½å¤Ÿ é«˜é›†ç¾¤çš„åŠ¨æ€çš„è´Ÿè½½ å‡è¡¡èƒ½åŠ›ï¼Œå¹¶ä¸”èƒ½å¤ŸåŠ å¿«æ•…éšœæ¢å¤çš„é€Ÿåº¦:å¤±æ•ˆæœºå™¨ä¸Šæ‰§è¡Œçš„å¤§é‡ Map ä»»åŠ¡éƒ½å¯ä»¥åˆ†å¸ƒåˆ°æ‰€æœ‰å…¶ä»–çš„ worker æœºå™¨ä¸Šå»æ‰§è¡Œã€‚</p><p>ä½†æ˜¯å®é™…ä¸Šï¼Œåœ¨æˆ‘ä»¬çš„å…·ä½“å®ç°ä¸­å¯¹ M å’Œ R çš„å–å€¼éƒ½æœ‰ä¸€å®šçš„å®¢è§‚é™åˆ¶ï¼Œå› ä¸º master å¿…é¡»æ‰§è¡Œ O(M+R) æ¬¡è°ƒåº¦ï¼Œå¹¶ä¸”åœ¨å†…å­˜ä¸­ä¿å­˜ O(M<em>R)ä¸ªçŠ¶æ€(å¯¹å½±å“å†…å­˜ä½¿ç”¨çš„å› ç´ è¿˜æ˜¯æ¯”è¾ƒå°çš„:O(M</em>R)å—çŠ¶æ€ï¼Œå¤§æ¦‚æ¯ å¯¹ Map ä»»åŠ¡/Reduce ä»»åŠ¡ 1 ä¸ªå­—èŠ‚å°±å¯ä»¥äº†)ã€‚</p></blockquote><h3 id="å¤‡ç”¨ä»»åŠ¡"><a href="#å¤‡ç”¨ä»»åŠ¡" class="headerlink" title="å¤‡ç”¨ä»»åŠ¡"></a>å¤‡ç”¨ä»»åŠ¡</h3><p>æœ‰çš„ä»»åŠ¡æ‰§è¡Œçš„å¾ˆæ…¢ï¼Œæˆ‘ä»¬æœ‰çš„æ—¶å€™ä¼šè°ƒåº¦ backup æœºå™¨ (å¤‡ä»½) æ¥å¤„ç†å‰©ä¸‹çš„ã€å¤„ç†ä¸­çš„ä»»åŠ¡ã€‚</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>éš”ç¦»çº§åˆ«</title>
      <link href="/2020/01/13/%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB/"/>
      <url>/2020/01/13/%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB/</url>
      
        <content type="html"><![CDATA[<h1 id="ACID"><a href="#ACID" class="headerlink" title="ACID"></a>ACID</h1><ul><li>A: Abortability</li><li>C ç”¨æˆ·å±‚é¢å®šä¹‰çš„ invariant</li><li>Isolation: éš”ç¦»æ€§</li><li>Durability: æŒä¹…æ€§</li></ul><h2 id="å•å¯¹è±¡å†™å…¥çš„å®ç°"><a href="#å•å¯¹è±¡å†™å…¥çš„å®ç°" class="headerlink" title="å•å¯¹è±¡å†™å…¥çš„å®ç°"></a>å•å¯¹è±¡å†™å…¥çš„å®ç°</h2><p>å¸Œæœ›å¯¹å•ä¸ªæœºå™¨çš„å•ä¸ªèŠ‚ç‚¹ï¼Œèƒ½æä¾›åŸå­æ€§å’Œéš”ç¦»æ€§</p><p>å¦‚æœæ˜¯å¤§æ–‡ä»¶/è¦†ç›–çš„æ—¶å€™ä¸ atomic(å†™åˆ°ä¸€åŠäº†) / å®¢æˆ·ä¼šä¸ä¼šçœ‹åˆ°éƒ¨åˆ†æ›´æ–°çš„å€¼</p><p>é€šè¿‡æ—¥å¿—æ¥å®ç°å´©æºƒå›å¤ï¼Œç”¨é”å®ç°éš”ç¦»</p><p>å•ä¸ªå¯¹è±¡å®é™…ä¸Šä¹Ÿæœ‰ä¸€äº›å¥‡è‘©æ“ä½œï¼Œæ¯”å¦‚ CAS æ“ä½œï¼Œä¸€èˆ¬ç›´æ¥ç”± CAS ç±»æŒ‡ä»¤æ”¯æŒã€‚</p><h2 id="å¼±éš”ç¦»çº§åˆ«"><a href="#å¼±éš”ç¦»çº§åˆ«" class="headerlink" title="å¼±éš”ç¦»çº§åˆ«"></a>å¼±éš”ç¦»çº§åˆ«</h2><h3 id="Read-Committed"><a href="#Read-Committed" class="headerlink" title="Read Committed"></a>Read Committed</h3><ul><li>è¯»æ•°æ®åº“ï¼šåªèƒ½çœ‹åˆ°å·²ç»æäº¤çš„æ•°æ®ï¼Œæ²¡æœ‰è„è¯»</li><li>å†™æ•°æ®åº“ï¼šåªä¼šè¦†ç›–å·²ç»å†™å…¥çš„æ•°æ®ï¼Œæ²¡æœ‰è„å†™</li></ul><blockquote><p>è¯»æœªæäº¤(Read uncommitted)ã€‚å®ƒå¯ä»¥é˜²æ­¢è„å†™ï¼Œä½†ä¸é˜²æ­¢è„è¯»ã€‚</p></blockquote><p>è¯»ï¼šä¸ä¼šçœ‹åˆ°éƒ¨åˆ†æ›´æ–°çš„å€¼ã€‚</p><p>å†™ï¼šæ²¡æœ‰è„å†™</p><p>å¯èƒ½çš„å®ç°ï¼š</p><p>å®é™…ä¸Šè¿™ä¸ªçº§åˆ«å¯ä»¥é€šè¿‡ row-level-lock å®ç°ï¼š</p><p>ä¿®æ”¹ç‰¹å®š object çš„æ—¶å€™ï¼Œåªæœ‰è¯´ï¼Œç›´åˆ° abort/commit</p><p>è¯»å¯ä»¥æ‹¿åˆ°å¯¹åº”çš„é”ï¼Œå®é™…ä¸Šä¹Ÿå¯ä»¥ä¿ç•™ä¸€ä»½ old value, ä»¥æ“ä½œã€‚</p><h2 id="SI-å’Œ-Repeatable-Read"><a href="#SI-å’Œ-Repeatable-Read" class="headerlink" title="SI å’Œ Repeatable Read"></a>SI å’Œ Repeatable Read</h2><p>è¿™ä¸ªæ—¶å€™éœ€è¦è¯´ Read Committed çš„é—®é¢˜ï¼šå®ƒè¯»åˆ°çš„å¯èƒ½æ˜¯è‡ªå·±çš„ Write å’Œåˆ«äºº Committed çš„ write çš„æ··åˆç‰©</p><p>è¿™ç§å¼‚å¸¸è¢«ç§°ä¸ºä¸å¯é‡å¤è¯»/è¯»åå·®ï¼ˆread skewï¼‰</p><p>å®ç°çš„æ–¹æ³•ç›¸å¯¹æ¥è¯´å¯èƒ½è¦å¤‡ä»½/SI</p><h3 id="SI"><a href="#SI" class="headerlink" title="SI"></a>SI</h3><ul><li>å†™éœ€è¦å†™é”ï¼Œè¯»ä» Snapshot è¯»</li></ul><p>Txn ä»ä¸€è‡´æ€§å¿«ç…§è¯»å–</p><p>åœ¨ PostgreSQL ä¸­</p><ul><li>äº‹åŠ¡ä¼šæœ‰ä¸€ä¸ªä¸¥æ ¼é€’å¢çš„ ID</li><li>å­—æ®µæœ‰ createBy deleteBy çš„è¯­ä¹‰ï¼Œå®ç°ä¸Šæ˜¯ xmin, xmax.</li></ul><p>SI æœ‰å¯è§æ€§çš„è§„åˆ™ï¼š</p><ul><li>æ¯æ¬¡äº‹åŠ¡å¼€å§‹çš„æ—¶å€™ï¼Œåˆ—å‡ºå…¶ä»–æ‰€æœ‰çš„Txn, å¹¶ ignore è¿™äº›</li><li>è¢« abort çš„äº‹åŠ¡æ‰§è¡Œçš„å†™å…¥è¢«å¿½ç•¥</li><li>è¢«è¾ƒæ™šäº‹åŠ¡ id(äº§ç”Ÿç¬¬ä¸€æ¬¡è¯»/è¯»ä¹‹å‰è·å–çš„)äº‹åŠ¡æ‰€åšçš„ä»»ä½•å†™å…¥éƒ½ä¼šè¢«å¿½ç•¥ï¼Œä¸ç®¡æ˜¯å¦å·²ç»æäº¤</li></ul><p>æ‰€ä»¥å¯è§æ€§è§„åˆ™æ˜¯ï¼š</p><ul><li>txn å¼€å§‹çš„æ—¶å€™ï¼Œåˆ›å»ºå¯¹è±¡çš„äº‹åŠ¡å·²ç»æäº¤äº†</li><li>å¯¹è±¡æ²¡æœ‰è¢«è¢«æ ‡è®°ä¸º deleted </li></ul><h3 id="SI-amp-amp-Index"><a href="#SI-amp-amp-Index" class="headerlink" title="SI &amp;&amp; Index"></a>SI &amp;&amp; Index</h3><ul><li>PostgreSQL é¿å…æ›´æ–°</li><li>TiDB Index ç±»å‹ä¼šä¸€èµ·æ›´æ–°</li><li>æœ‰çš„æ•°æ®åº“ä¼šåˆ›å»º Copy-on-write ç»“æ„</li></ul><ul><li>PostgreSQL: SI â€”&gt; repeatable read</li><li>Oracle: Serializable</li></ul><h2 id="Lost-Update"><a href="#Lost-Update" class="headerlink" title="Lost Update"></a>Lost Update</h2><ul><li>TXN1 readX writeX commit</li><li>TXN2 readX writeX                commit</li></ul><p>Txn1 æœ‰å¯èƒ½ä¼šè¢« Overwrite.</p><p>å¯ä»¥å®ç°åŸå­å†™ï¼Œä¹Ÿå¯ä»¥ LOCK FOR XXX æ˜¾ç¤ºé”å®šã€‚</p><h2 id="SI-å¯èƒ½å‘ç”Ÿçš„é—®é¢˜"><a href="#SI-å¯èƒ½å‘ç”Ÿçš„é—®é¢˜" class="headerlink" title="SI å¯èƒ½å‘ç”Ÿçš„é—®é¢˜"></a>SI å¯èƒ½å‘ç”Ÿçš„é—®é¢˜</h2><ul><li>3ä¸ª txn äº’ç›¸ä¾èµ–</li><li>2ä¸ªä¹‹é—´çš„ phantom</li></ul>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Docker review: Linux Namespace</title>
      <link href="/2020/01/11/Docker-review-Linux-Namespace/"/>
      <url>/2020/01/11/Docker-review-Linux-Namespace/</url>
      
        <content type="html"><![CDATA[<h2 id="dockerçš„ç®€å•å®ç°åŸç†"><a href="#dockerçš„ç®€å•å®ç°åŸç†" class="headerlink" title="dockerçš„ç®€å•å®ç°åŸç†"></a>dockerçš„ç®€å•å®ç°åŸç†</h2><p>å‚è€ƒçš„ä¹¦ç¼–å†™äº2017å¹´ï¼Œæœ¬äººä¼šå°†ä¹¦ä¸Šç›¸å…³çš„å†…å®¹å…ˆè¿‡ä¸€éï¼Œç„¶åæŠŠç°åœ¨æ¯”è¾ƒå…·ä½“çš„å®ç°è´´å‡ºæ¥ã€‚</p><h3 id="Namespace"><a href="#Namespace" class="headerlink" title="Namespace"></a>Namespace</h3><p>ä»¥ä¸‹å†…å®¹æ˜¯å¯¹ Linux Man namespace(7) çš„ä¸€ä¸ªæ•´ç†ï¼Œå»ºè®®æœ‰ç©ºé—²å»é˜…è¯»å®˜æ–¹çš„æ–‡æ¡£ï¼Œä¸è¦å¸æ”¶äºŒæ‰‹çŸ¥è¯†ã€‚</p><p>å¦‚æœä½ è·‘ä¸‹é¢çš„è¯ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">âœ  ~ ls -l /proc/$$/ns</span><br><span class="line">æ€»ç”¨é‡ 0</span><br><span class="line">lrwxrwxrwx 1 mwish mwish 0  1æœˆ 11 04:10 cgroup -&gt; &#x27;cgroup:[4026531835]&#x27;</span><br><span class="line">lrwxrwxrwx 1 mwish mwish 0  1æœˆ 11 04:10 ipc -&gt; &#x27;ipc:[4026531839]&#x27;</span><br><span class="line">lrwxrwxrwx 1 mwish mwish 0  1æœˆ 11 04:10 mnt -&gt; &#x27;mnt:[4026531840]&#x27;</span><br><span class="line">lrwxrwxrwx 1 mwish mwish 0  1æœˆ 11 04:10 net -&gt; &#x27;net:[4026531992]&#x27;</span><br><span class="line">lrwxrwxrwx 1 mwish mwish 0  1æœˆ 11 04:10 pid -&gt; &#x27;pid:[4026531836]&#x27;</span><br><span class="line">lrwxrwxrwx 1 mwish mwish 0  1æœˆ 11 04:10 pid_for_children -&gt; &#x27;pid:[4026531836]&#x27;</span><br><span class="line">lrwxrwxrwx 1 mwish mwish 0  1æœˆ 11 04:10 user -&gt; &#x27;user:[4026531837]&#x27;</span><br><span class="line">lrwxrwxrwx 1 mwish mwish 0  1æœˆ 11 04:10 uts -&gt; &#x27;uts:[4026531838]&#x27;</span><br></pre></td></tr></table></figure><p>å®é™…ä¸Šä½ å¯ä»¥åœ¨ man é‡Œå¤´æ‰¾åˆ° namespace</p><blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">A namespace wraps a global system resource in an abstraction that</span><br><span class="line">makes it appear to the processes within the namespace that they have</span><br><span class="line">their own isolated instance of the global resource.  Changes to the</span><br><span class="line">global resource are visible to other processes that are members of</span><br><span class="line">the namespace, but are invisible to other processes.  One use of</span><br><span class="line">namespaces is to implement containers.</span><br><span class="line"></span><br><span class="line">This page provides pointers to information on the various namespace</span><br><span class="line">types, describes the associated /proc files, and summarizes the APIs</span><br><span class="line">for working with namespaces.</span><br></pre></td></tr></table></figure></blockquote><p>ç§ç±»ä¹Ÿå¯ä»¥ï¼š</p><blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">Namespace types</span><br><span class="line">    The following table shows the namespace types available on Linux.</span><br><span class="line">    The second column of the table shows the flag value that is used to</span><br><span class="line">    specify the namespace type in various APIs.  The third column</span><br><span class="line">    identifies the manual page that provides details on the namespace</span><br><span class="line">    type.  The last column is a summary of the resources that are</span><br><span class="line">    isolated by the namespace type.</span><br><span class="line"></span><br><span class="line">    Namespace Flag            Page                  Isolates</span><br><span class="line">    Cgroup    CLONE_NEWCGROUP cgroup_namespaces(7)  Cgroup root directory</span><br><span class="line">    IPC       CLONE_NEWIPC    ipc_namespaces(7)     System V IPC,</span><br><span class="line">                                                    POSIX message queues</span><br><span class="line">    Network   CLONE_NEWNET    network_namespaces(7) Network devices,</span><br><span class="line">                                                    stacks, ports, etc.</span><br><span class="line">    Mount     CLONE_NEWNS     mount_namespaces(7)   Mount points</span><br><span class="line">    PID       CLONE_NEWPID    pid_namespaces(7)     Process IDs</span><br><span class="line">    User      CLONE_NEWUSER   user_namespaces(7)    User and group IDs</span><br><span class="line">    UTS       CLONE_NEWUTS    uts_namespaces(7)     Hostname and NIS</span><br><span class="line">                                                    domain name</span><br></pre></td></tr></table></figure></blockquote><p>é€šä¿—çš„è¯´ï¼Œå°±æ˜¯ï¼š</p><ul><li><code>Mount</code>: éš”ç¦»æ–‡ä»¶ç³»ç»ŸæŒ‚è½½ç‚¹</li><li><code>UTS</code>: éš”ç¦»ä¸»æœºåå’ŒåŸŸåä¿¡æ¯</li><li><code>IPC</code>: éš”ç¦»è¿›ç¨‹é—´é€šä¿¡</li><li><code>PID</code>: éš”ç¦»è¿›ç¨‹çš„ID</li><li><code>Network</code>: éš”ç¦»ç½‘ç»œèµ„æº</li><li><code>User</code>: éš”ç¦»ç”¨æˆ·å’Œç”¨æˆ·ç»„çš„ID</li></ul><p>æ­¤å¤–ï¼Œåœ¨ä¸€äº›åœ°æ–¹ä½ å¯ä»¥æ³¨æ„é™åˆ¶</p><blockquote><p>Note that namespaces <em>do not</em> restrict access to physical resources such as CPU, memory and disk. That access is metered and restricted by a kernel feature called â€˜cgroupsâ€™.</p></blockquote><p>å—¯è¿™ä¸ªåè¯æˆ‘ä»¬ç¨åå†ä»‹ç»å§ã€‚</p><p>å®é™…ä¸Šå¯ä»¥è¯»å®Œ namespace(7) å¯¹åº”çš„ man æ‰‹å†Œï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Each process has a /proc/[pid]/ns/ subdirectory containing one entry</span><br><span class="line">       for each namespace that supports being manipulated by setns(2):</span><br></pre></td></tr></table></figure><p>åˆšåˆš <code>cat /proc/$$/ns</code> å®é™…ä¸Šå°±æ˜¯è¿™æ ·è¯»å–ä¿¡æ¯çš„ã€‚åŒæ—¶æˆ‘ä»¬ç•™æ„ä¸€ä¸‹ä¹‹å‰çš„ namespace , ä»–æ˜¯æœ‰ä¸€ä¸ª id çš„ã€‚å¦‚æœå¤šä¸ª process çš„ namespace æœ‰ç€åŒä¸€ä¸ª id, æˆ‘ä»¬æœ‰ç†ç”±è®¤ä¸ºå®ƒä»¬åœ¨ä¸€ä¸ª namespace ä¸‹å¤´ã€‚é‚£ä¹ˆä»¥ä¸‹æ–¹æ³•å¯ä»¥ä¿ç•™è‡ªå·±ï¼ˆæˆ–è€…æˆ‘ä»¬æ¸´æœ›çš„è¿›ç¨‹ id çš„ï¼‰ uts namespace. è¿™äº›å†…å®¹å¯ä»¥å‚è€ƒ man çš„ <em>namespace lifetime</em> è¿™ä¸ª part.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">âœ  ~ <span class="built_in">touch</span> uts</span><br><span class="line">âœ  ~ mount --<span class="built_in">bind</span> /proc/$$/ns/uts uts</span><br></pre></td></tr></table></figure><p>å‡è®¾æˆ‘ä»¬ä¹‹å‰ mount äº† uts, è¿™ä¸ªæ—¶å€™æˆ‘ä»¬çŸ¥é“ä»–æ˜¯èƒ½ï¼š<strong>éš”ç¦»ä¸»æœºåå’ŒåŸŸåä¿¡æ¯</strong></p><p>æ¥ä¸‹æ¥æˆ‘ä»¬ä»‹ç»å‡ ä¸ª syscall:</p><ul><li>setns(2): allows the calling process to join an existing namespace.  The namespace to join is specified via a file descriptor that refers to one of the /proc/[pid]/ns files described below.</li><li>unshare(2): <a href="http://man7.org/linux/man-pages/man2/unshare.2.html">http://man7.org/linux/man-pages/man2/unshare.2.html</a></li><li>clone(2): <a href="http://man7.org/linux/man-pages/man2/clone.2.html">http://man7.org/linux/man-pages/man2/clone.2.html</a></li><li>ioctl(2): (åæ§½: è¿™ç©æ„ä¸‡èƒ½å•Šâ€¦) <a href="http://man7.org/linux/man-pages/man2/ioctl.2.html">http://man7.org/linux/man-pages/man2/ioctl.2.html</a></li></ul><p>ä½ å¯ä»¥å½“æˆæ˜¯æ·»åŠ  namespace å’Œ åˆ‡æ¢ namespaceã€‚</p><p>ä»¥ä¸‹éƒ¨åˆ†ä»‹ç»çš„æ˜¯å„ç§ namespace, ä»£ç å¾ˆå¤š sample æ¥è‡ªäºè¿™ä¸ªåœ°æ–¹ï¼š<a href="http://crosbymichael.com/creating-containers-part-1.html">http://crosbymichael.com/creating-containers-part-1.html</a> </p><h2 id="Skeleton"><a href="#Skeleton" class="headerlink" title="Skeleton"></a>Skeleton</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> STACKSIZE (1024*1024)</span></span><br><span class="line"><span class="type">static</span> <span class="type">char</span> child_stack[STACKSIZE];</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">clone_args</span> &#123;</span></span><br><span class="line">        <span class="type">char</span> **argv;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// child_exec is the func that will be executed as the result of clone</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">child_exec</span><span class="params">(<span class="type">void</span> *stuff)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">clone_args</span> *<span class="title">args</span> =</span> (<span class="keyword">struct</span> clone_args *)stuff;</span><br><span class="line">        <span class="keyword">if</span> (execvp(args-&gt;argv[<span class="number">0</span>], args-&gt;argv) != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;failed to execvp argments %s\n&quot;</span>,</span><br><span class="line">                        strerror(errno));</span><br><span class="line">                <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// we should never reach here!</span></span><br><span class="line">        <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">clone_args</span> <span class="title">args</span>;</span></span><br><span class="line">        args.argv = &amp;argv[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> clone_flags = SIGCHLD;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// the result of this call is that our child_exec will be run in another</span></span><br><span class="line">        <span class="comment">// process returning it&#x27;s pid</span></span><br><span class="line">        <span class="type">pid_t</span> pid =</span><br><span class="line">            clone(child_exec, child_stack + STACKSIZE, clone_flags, &amp;args;</span><br><span class="line">        <span class="keyword">if</span> (pid &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;clone failed WTF!!!! %s\n&quot;</span>, strerror(errno));</span><br><span class="line">                <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// lets wait on our child process here before we, the parent, exits</span></span><br><span class="line">        <span class="keyword">if</span> (waitpid(pid, <span class="literal">NULL</span>, <span class="number">0</span>) == <span class="number">-1</span>) &#123;</span><br><span class="line">                <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;failed to wait pid %d\n&quot;</span>, pid);</span><br><span class="line">                <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">exit</span>(EXIT_SUCCESS);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p> æˆ‘ä»¬éœ€è¦ä¸€ä¸ª skeleton æ¥å¡«å……é€»è¾‘</p><h4 id="Unix-Time-sharing-Namespace"><a href="#Unix-Time-sharing-Namespace" class="headerlink" title="Unix Time-sharing Namespace"></a>Unix Time-sharing Namespace</h4><p>UTS éš”ç¦»ä¸»æœºåå’ŒåŸŸåä¿¡æ¯, æˆ‘åœ¨è‡ªå·±çš„ manjaro ä¸Šä»¿ç…§ä»£ç å†™äº†ä¸€ä¸ª</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> _GNU_SOURC</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> STACK_SIZE (1024 * 1024)</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">char</span> child_stack[STACK_SIZE];</span><br><span class="line"><span class="type">char</span>* <span class="type">const</span> child_args[] = &#123;</span><br><span class="line"><span class="string">&quot;/bin/bash&quot;</span>,</span><br><span class="line"><span class="literal">NULL</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">child_main</span><span class="params">(<span class="type">void</span>* args)</span> &#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;in sub process\n&quot;</span>);</span><br><span class="line"><span class="keyword">if</span> (sethostname(<span class="string">&quot;mname&quot;</span>, <span class="built_in">strlen</span>(<span class="string">&quot;mname&quot;</span>)) != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;failed to execvp argments %s\n&quot;</span>,</span><br><span class="line">                        strerror(errno));</span><br><span class="line">                <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">execv(child_args[<span class="number">0</span>], child_args);</span><br><span class="line"><span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;start\n&quot;</span>);</span><br><span class="line"><span class="type">int</span> child_pid = clone(child_main, child_stack + STACK_SIZE, SIGCHLD, <span class="literal">NULL</span>);</span><br><span class="line">waitpid(child_pid, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;exit\n&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½ éœ€è¦ sudo ä»¥è¿è¡Œè¿™ä¸ªç¨‹åºã€‚</p><h2 id="IPC-Namespace"><a href="#IPC-Namespace" class="headerlink" title="IPC Namespace"></a>IPC Namespace</h2><p>The IPC namespace is used for isolating interprocess communication, things like SysV message queues. Letâ€™s make a copy of <code>skeleton.c</code> for this namespace.</p><h2 id="PID-Namespace"><a href="#PID-Namespace" class="headerlink" title="PID Namespace"></a>PID Namespace</h2><blockquote><p>This one is fun. The PID namespace is a way to carve up the PIDs that one process can view and interact with. When we create a new PID namespace the first process will get to be the loved PID 1. If this process exits the kernel kills everyone else within the namespace. Letâ€™s start by making a copy of <code>skeleton.c</code> for our changes.</p></blockquote><p>ä»–ä¼šå¯¹è¿›ç¨‹ PID é‡æ–°æ ‡å·ï¼Œæ¯ä¸ª PID namespace æœ‰è‡ªå·±çš„ wx, å†…æ ¸ä¸º PID ns ç»´æŠ¤äº†ä¸€ä¸ªæ ‘çŠ¶ç»“æ„ï¼Œä» root ns åˆ° child nsï¼Œå…¶ä¸­ï¼š</p><ul><li>çˆ¶èŠ‚ç‚¹å¯ä»¥çœ‹åˆ°å­nsè¿›ç¨‹</li><li>å­ä¸èƒ½çœ‹åˆ°çˆ¶ ns</li><li>PID 1 æœ‰ init ç‰¹æƒ</li><li>ä¸èƒ½ kill/ptrace çˆ¶/å…„ ns</li><li>å¦‚æœé‡æ–°æŒ‚è½½ <code>/proc</code> æ–‡ä»¶ç³»ç»Ÿ</li></ul><p>ä¸€ä¸ªè¿›ç¨‹ 1 å¯ä»¥å±è”½ä¸€å®šçš„ä¿¡å·ï¼Œä½†æ˜¯å››ç§æ€æ‰ç¨‹åºçš„ SIG ä¸­ï¼Œå¯¹äºçˆ¶çº§ ns è¿›ç¨‹çš„ SIGKILL, SIGSTOP ä¼šè¢«æ€æ‰ã€‚</p><p>åŒæ—¶ï¼Œç”¨ ps, å› ä¸ºçœ‹åˆ°çš„æ˜¯å†…å­˜çš„ <code>/proc</code> è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿï¼Œæ‰€ä»¥å¯èƒ½éœ€è¦é‡æ–° mount.</p><h2 id="mount-Namespace"><a href="#mount-Namespace" class="headerlink" title="mount Namespace"></a>mount Namespace</h2><p>(å†å²ä¸Šç¬¬ä¸€ä¸ªå®ç°çš„ ns)</p><p><code>CLONE_NEWNS</code></p><p> æŒ‚è½½çš„å½¢å¼æœ‰ï¼š</p><ul><li>share</li><li>slave</li><li>share and slave</li><li>primary</li><li>unbindable</li></ul>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Rust std::sync::Arc</title>
      <link href="/2020/01/09/Rust-std-sync-Arc/"/>
      <url>/2020/01/09/Rust-std-sync-Arc/</url>
      
        <content type="html"><![CDATA[<h2 id="æ°´æ–‡-Rust-std-sync-Arc"><a href="#æ°´æ–‡-Rust-std-sync-Arc" class="headerlink" title="[æ°´æ–‡] Rust std::sync::Arc"></a>[æ°´æ–‡] Rust std::sync::Arc</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[cfg_attr(not(test), lang = <span class="string">&quot;arc&quot;</span>)]</span></span><br><span class="line"><span class="meta">#[stable(feature = <span class="string">&quot;rust1&quot;</span>, since = <span class="string">&quot;1.0.0&quot;</span>)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">Arc</span>&lt;T: ?<span class="built_in">Sized</span>&gt; &#123;</span><br><span class="line">    ptr: NonNull&lt;ArcInner&lt;T&gt;&gt;,</span><br><span class="line">    phantom: PhantomData&lt;T&gt;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å†…éƒ¨æ˜¯ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">ArcInner</span>&lt;T: ?<span class="built_in">Sized</span>&gt; &#123;</span><br><span class="line">    strong: atomic::AtomicUsize,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// the value usize::MAX acts as a sentinel for temporarily &quot;locking&quot; the</span></span><br><span class="line">    <span class="comment">// ability to upgrade weak pointers or downgrade strong ones; this is used</span></span><br><span class="line">    <span class="comment">// to avoid races in `make_mut` and `get_mut`.</span></span><br><span class="line">    weak: atomic::AtomicUsize,</span><br><span class="line"></span><br><span class="line">    data: T,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Comparing-with-std-rc-Rc"><a href="#Comparing-with-std-rc-Rc" class="headerlink" title="Comparing with std::rc::Rc"></a>Comparing with <code>std::rc::Rc</code></h2><h3 id="å†…éƒ¨å¯å˜å½¢"><a href="#å†…éƒ¨å¯å˜å½¢" class="headerlink" title="å†…éƒ¨å¯å˜å½¢"></a>å†…éƒ¨å¯å˜å½¢</h3><p>å…¶å®ä½ åº”è¯¥è®°å¾— Rc å®ç°ç”¨äº†ä¸€å † <code>Cell</code> æ¥è¡¨ç¤º counter, </p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[cfg_attr(not(test), lang = <span class="string">&quot;rc&quot;</span>)]</span></span><br><span class="line"><span class="meta">#[stable(feature = <span class="string">&quot;rust1&quot;</span>, since = <span class="string">&quot;1.0.0&quot;</span>)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">Rc</span>&lt;T: ?<span class="built_in">Sized</span>&gt; &#123;</span><br><span class="line">    ptr: NonNull&lt;RcBox&lt;T&gt;&gt;,</span><br><span class="line">    phantom: PhantomData&lt;T&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">RcBox</span>&lt;T: ?<span class="built_in">Sized</span>&gt; &#123;</span><br><span class="line">    strong: Cell&lt;<span class="type">usize</span>&gt;,</span><br><span class="line">    weak: Cell&lt;<span class="type">usize</span>&gt;,</span><br><span class="line">    value: T,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå†…éƒ¨å¯å˜å½¢ä¸­ï¼Œ ArcInner é çš„æ˜¯ <code>Atomic</code> æ¥å®ç°</p><h2 id="æ–¹æ³•"><a href="#æ–¹æ³•" class="headerlink" title="æ–¹æ³•"></a>æ–¹æ³•</h2><p>å¦‚æœæ˜¯ <code>new</code> çš„è¯ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[inline]</span></span><br><span class="line"><span class="meta">#[stable(feature = <span class="string">&quot;rust1&quot;</span>, since = <span class="string">&quot;1.0.0&quot;</span>)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">new</span>(data: T) <span class="punctuation">-&gt;</span> Arc&lt;T&gt; &#123;</span><br><span class="line">    <span class="comment">// Start the weak pointer count as 1 which is the weak pointer that&#x27;s</span></span><br><span class="line">    <span class="comment">// held by all the strong pointers (kinda), see std/rc.rs for more info</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">x</span>: <span class="type">Box</span>&lt;_&gt; = <span class="keyword">box</span> ArcInner &#123;</span><br><span class="line">        strong: atomic::AtomicUsize::<span class="title function_ invoke__">new</span>(<span class="number">1</span>),</span><br><span class="line">        weak: atomic::AtomicUsize::<span class="title function_ invoke__">new</span>(<span class="number">1</span>),</span><br><span class="line">        data,</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">Self</span>::<span class="title function_ invoke__">from_inner</span>(Box::<span class="title function_ invoke__">into_raw_non_null</span>(x))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯¹äº clone æ¥è¯´ï¼Œæ³¨é‡Šéå¸¸è¯¦ç»†ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[inline]</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">clone</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> Arc&lt;T&gt; &#123;</span><br><span class="line">    <span class="comment">// Using a relaxed ordering is alright here, as knowledge of the</span></span><br><span class="line">    <span class="comment">// original reference prevents other threads from erroneously deleting</span></span><br><span class="line">    <span class="comment">// the object.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// As explained in the [Boost documentation][1], Increasing the</span></span><br><span class="line">    <span class="comment">// reference counter can always be done with memory_order_relaxed: New</span></span><br><span class="line">    <span class="comment">// references to an object can only be formed from an existing</span></span><br><span class="line">    <span class="comment">// reference, and passing an existing reference from one thread to</span></span><br><span class="line">    <span class="comment">// another must already provide any required synchronization.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// [1]: (www.boost.org/doc/libs/1_55_0/doc/html/atomic/usage_examples.html)</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">old_size</span> = <span class="keyword">self</span>.<span class="title function_ invoke__">inner</span>().strong.<span class="title function_ invoke__">fetch_add</span>(<span class="number">1</span>, Relaxed);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// However we need to guard against massive refcounts in case someone</span></span><br><span class="line">    <span class="comment">// is `mem::forget`ing Arcs. If we don&#x27;t do this the count can overflow</span></span><br><span class="line">    <span class="comment">// and users will use-after free. We racily saturate to `isize::MAX` on</span></span><br><span class="line">    <span class="comment">// the assumption that there aren&#x27;t ~2 billion threads incrementing</span></span><br><span class="line">    <span class="comment">// the reference count at once. This branch will never be taken in</span></span><br><span class="line">    <span class="comment">// any realistic program.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// We abort because such a program is incredibly degenerate, and we</span></span><br><span class="line">    <span class="comment">// don&#x27;t care to support it.</span></span><br><span class="line">    <span class="keyword">if</span> old_size &gt; MAX_REFCOUNT &#123;</span><br><span class="line">        <span class="keyword">unsafe</span> &#123;</span><br><span class="line">            <span class="title function_ invoke__">abort</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">Self</span>::<span class="title function_ invoke__">from_inner</span>(<span class="keyword">self</span>.ptr)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li><code>Relaxed</code> çš„ <code>fetch_add</code> æ˜¯åŸå­çš„</li><li>å¦‚æœæœ‰ <code>old_size &gt; MAX_REFCOUNT</code> ï¼Œè¿™é‡Œè®¤ä¸ºä½ ä¸€èˆ¬å‡ºäº† <code>mem::forget</code> çš„ å¥‡æ€ª bug</li></ol><p>å¯¹äº Drop æ¥è¯´ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[inline]</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">drop</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">    <span class="comment">// Because `fetch_sub` is already atomic, we do not need to synchronize</span></span><br><span class="line">    <span class="comment">// with other threads unless we are going to delete the object. This</span></span><br><span class="line">    <span class="comment">// same logic applies to the below `fetch_sub` to the `weak` count.</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">self</span>.<span class="title function_ invoke__">inner</span>().strong.<span class="title function_ invoke__">fetch_sub</span>(<span class="number">1</span>, Release) != <span class="number">1</span> &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// This fence is needed to prevent reordering of use of the data and</span></span><br><span class="line">    <span class="comment">// deletion of the data.  Because it is marked `Release`, the decreasing</span></span><br><span class="line">    <span class="comment">// of the reference count synchronizes with this `Acquire` fence. This</span></span><br><span class="line">    <span class="comment">// means that use of the data happens before decreasing the reference</span></span><br><span class="line">    <span class="comment">// count, which happens before this fence, which happens before the</span></span><br><span class="line">    <span class="comment">// deletion of the data.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// As explained in the [Boost documentation][1],</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// &gt; It is important to enforce any possible access to the object in one</span></span><br><span class="line">    <span class="comment">// &gt; thread (through an existing reference) to *happen before* deleting</span></span><br><span class="line">    <span class="comment">// &gt; the object in a different thread. This is achieved by a &quot;release&quot;</span></span><br><span class="line">    <span class="comment">// &gt; operation after dropping a reference (any access to the object</span></span><br><span class="line">    <span class="comment">// &gt; through this reference must obviously happened before), and an</span></span><br><span class="line">    <span class="comment">// &gt; &quot;acquire&quot; operation before deleting the object.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// In particular, while the contents of an Arc are usually immutable, it&#x27;s</span></span><br><span class="line">    <span class="comment">// possible to have interior writes to something like a Mutex&lt;T&gt;. Since a</span></span><br><span class="line">    <span class="comment">// Mutex is not acquired when it is deleted, we can&#x27;t rely on its</span></span><br><span class="line">    <span class="comment">// synchronization logic to make writes in thread A visible to a destructor</span></span><br><span class="line">    <span class="comment">// running in thread B.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// Also note that the Acquire fence here could probably be replaced with an</span></span><br><span class="line">    <span class="comment">// Acquire load, which could improve performance in highly-contended</span></span><br><span class="line">    <span class="comment">// situations. See [2].</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// [1]: (www.boost.org/doc/libs/1_55_0/doc/html/atomic/usage_examples.html)</span></span><br><span class="line">    <span class="comment">// [2]: (https://github.com/rust-lang/rust/pull/41714)</span></span><br><span class="line">    atomic::<span class="title function_ invoke__">fence</span>(Acquire);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsafe</span> &#123;</span><br><span class="line">        <span class="keyword">self</span>.<span class="title function_ invoke__">drop_slow</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è€ƒè™‘ä¸€ä¸‹è¿™æ®µä»£ç ï¼š</p><blockquote><p>deletion of the data.  Because it is marked <code>Release</code>, the decreasing of the reference count synchronizes with this <code>Acquire</code> fence. This means that use of the data happens before decreasing the reference count, which happens before this fence, which happens before the deletion of the data.</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">atomic::fence(Acquire);</span><br></pre></td></tr></table></figure><ol><li><code>self.inner().strong.fetch_sub(1, Release)</code> æœ¬èº«æ˜¯åŸå­çš„</li><li><code>atomic::fence(Acquire);</code> ä¿è¯ <code>self.drop_slow</code> ä¸ä¼šè¢«é‡æ’åºåˆ° <code>fetch_sub</code> ä¹‹å‰</li></ol><p>ç„¶å <code>drop_slow</code> ä¹ŸåŒ…å«äº†ä¸€æ®µè¿™æ ·çš„é€»è¾‘ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Non-inlined part of `drop`.</span></span><br><span class="line"><span class="meta">#[inline(never)]</span></span><br><span class="line"><span class="keyword">unsafe</span> <span class="keyword">fn</span> <span class="title function_">drop_slow</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">    <span class="comment">// Destroy the data at this time, even though we may not free the box</span></span><br><span class="line">    <span class="comment">// allocation itself (there may still be weak pointers lying around).</span></span><br><span class="line">    ptr::<span class="title function_ invoke__">drop_in_place</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>.ptr.<span class="title function_ invoke__">as_mut</span>().data);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">self</span>.<span class="title function_ invoke__">inner</span>().weak.<span class="title function_ invoke__">fetch_sub</span>(<span class="number">1</span>, Release) == <span class="number">1</span> &#123;</span><br><span class="line">        atomic::<span class="title function_ invoke__">fence</span>(Acquire);</span><br><span class="line">        Global.<span class="title function_ invoke__">dealloc</span>(<span class="keyword">self</span>.ptr.<span class="title function_ invoke__">cast</span>(), Layout::<span class="title function_ invoke__">for_value</span>(<span class="keyword">self</span>.ptr.<span class="title function_ invoke__">as_ref</span>()))</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>fetch_sub</code> ä¹Ÿæœ‰åŒæ ·é€»è¾‘ã€‚è¯¦ç»†å†…å®¹å¯ä»¥å‚è€ƒè¿™ä¸ªè§£ç­”ï¼š</p><ul><li><a href="https://stackoverflow.com/questions/48124031/stdmemory-order-relaxed-atomicity-with-respect-to-the-same-atomic-variable#comment83225530_48124031">https://stackoverflow.com/questions/48124031/stdmemory-order-relaxed-atomicity-with-respect-to-the-same-atomic-variable#comment83225530_48124031</a></li><li>åŒæ—¶å…¶å®åœ¨ CppReference çš„ Relaxed ä¸€èŠ‚ä¹Ÿæœ‰å†…å®¹çš„æç¤ºï¼Œå£°ç§° <code>shared_ptr</code> çš„ <code>inc</code> é€‚åˆ <code>relaxed</code> ï¼Œè€Œ <code>dec</code> éœ€è¦<code>release</code> +  <code>acquire</code> .</li></ul><h3 id="count"><a href="#count" class="headerlink" title="count"></a>count</h3><p><code>Arc</code> å®ç°äº†ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">  <span class="meta">#[inline]</span></span><br><span class="line">  <span class="meta">#[stable(feature = <span class="string">&quot;arc_counts&quot;</span>, since = <span class="string">&quot;1.15.0&quot;</span>)]</span></span><br><span class="line">  <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">weak_count</span>(this: &amp;<span class="keyword">Self</span>) <span class="punctuation">-&gt;</span> <span class="type">usize</span> &#123;</span><br><span class="line">      <span class="keyword">let</span> <span class="variable">cnt</span> = this.<span class="title function_ invoke__">inner</span>().weak.<span class="title function_ invoke__">load</span>(SeqCst);</span><br><span class="line">      <span class="comment">// If the weak count is currently locked, the value of the</span></span><br><span class="line">      <span class="comment">// count was 0 just before taking the lock.</span></span><br><span class="line">      <span class="keyword">if</span> cnt == usize::MAX &#123; <span class="number">0</span> &#125; <span class="keyword">else</span> &#123; cnt - <span class="number">1</span> &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line"><span class="meta">#[inline]</span></span><br><span class="line">  <span class="meta">#[stable(feature = <span class="string">&quot;arc_counts&quot;</span>, since = <span class="string">&quot;1.15.0&quot;</span>)]</span></span><br><span class="line">  <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">strong_count</span>(this: &amp;<span class="keyword">Self</span>) <span class="punctuation">-&gt;</span> <span class="type">usize</span> &#123;</span><br><span class="line">      this.<span class="title function_ invoke__">inner</span>().strong.<span class="title function_ invoke__">load</span>(SeqCst)</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>å…¶å®å¯ä»¥çœ‹çœ‹ <code>Weak</code> å®ç°çš„</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[unstable(feature = <span class="string">&quot;weak_counts&quot;</span>, issue = <span class="string">&quot;57977&quot;</span>)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">weak_count</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="type">Option</span>&lt;<span class="type">usize</span>&gt; &#123;</span><br><span class="line">    <span class="comment">// Due to the implicit weak pointer added when any strong pointers are</span></span><br><span class="line">    <span class="comment">// around, we cannot implement `weak_count` correctly since it</span></span><br><span class="line">    <span class="comment">// necessarily requires accessing the strong count and weak count in an</span></span><br><span class="line">    <span class="comment">// unsynchronized fashion. So this version is a bit racy.</span></span><br><span class="line">    <span class="keyword">self</span>.<span class="title function_ invoke__">inner</span>().<span class="title function_ invoke__">map</span>(|inner| &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">strong</span> = inner.strong.<span class="title function_ invoke__">load</span>(SeqCst);</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">weak</span> = inner.weak.<span class="title function_ invoke__">load</span>(SeqCst);</span><br><span class="line">        <span class="keyword">if</span> strong == <span class="number">0</span> &#123;</span><br><span class="line">            <span class="comment">// If the last `Arc` has *just* been dropped, it might not yet</span></span><br><span class="line">            <span class="comment">// have removed the implicit weak count, so the value we get</span></span><br><span class="line">            <span class="comment">// here might be 1 too high.</span></span><br><span class="line">            weak</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// As long as there&#x27;s still at least 1 `Arc` around, subtract</span></span><br><span class="line">            <span class="comment">// the implicit weak pointer.</span></span><br><span class="line">            <span class="comment">// Note that the last `Arc` might get dropped between the 2</span></span><br><span class="line">            <span class="comment">// loads we do above, removing the implicit weak pointer. This</span></span><br><span class="line">            <span class="comment">// means that the value might be 1 too low here. In order to not</span></span><br><span class="line">            <span class="comment">// return 0 here (which would happen if we&#x27;re the only weak</span></span><br><span class="line">            <span class="comment">// pointer), we guard against that specifically.</span></span><br><span class="line">            cmp::<span class="title function_ invoke__">max</span>(<span class="number">1</span>, weak - <span class="number">1</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„ SeqCst å¯ä»¥çœ‹çœ‹ï¼š<a href="https://stackoverflow.com/questions/12340773/how-do-memory-order-seq-cst-and-memory-order-acq-rel-differ">https://stackoverflow.com/questions/12340773/how-do-memory-order-seq-cst-and-memory-order-acq-rel-differ</a></p><p>è€Œ is_unique åˆä¸åŒäº†ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// Determine whether this is the unique reference (including weak refs) to</span></span><br><span class="line"><span class="comment">/// the underlying data.</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// Note that this requires locking the weak ref count.</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">is_unique</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="type">bool</span> &#123;</span><br><span class="line">    <span class="comment">// lock the weak pointer count if we appear to be the sole weak pointer</span></span><br><span class="line">    <span class="comment">// holder.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// The acquire label here ensures a happens-before relationship with any</span></span><br><span class="line">    <span class="comment">// writes to `strong` (in particular in `Weak::upgrade`) prior to decrements</span></span><br><span class="line">    <span class="comment">// of the `weak` count (via `Weak::drop`, which uses release).  If the upgraded</span></span><br><span class="line">    <span class="comment">// weak ref was never dropped, the CAS here will fail so we do not care to synchronize.</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">self</span>.<span class="title function_ invoke__">inner</span>().weak.<span class="title function_ invoke__">compare_exchange</span>(<span class="number">1</span>, usize::MAX, Acquire, Relaxed).<span class="title function_ invoke__">is_ok</span>() &#123;</span><br><span class="line">        <span class="comment">// This needs to be an `Acquire` to synchronize with the decrement of the `strong`</span></span><br><span class="line">        <span class="comment">// counter in `drop` -- the only access that happens when any but the last reference</span></span><br><span class="line">        <span class="comment">// is being dropped.</span></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">unique</span> = <span class="keyword">self</span>.<span class="title function_ invoke__">inner</span>().strong.<span class="title function_ invoke__">load</span>(Acquire) == <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// The release write here synchronizes with a read in `downgrade`,</span></span><br><span class="line">        <span class="comment">// effectively preventing the above read of `strong` from happening</span></span><br><span class="line">        <span class="comment">// after the write.</span></span><br><span class="line">        <span class="keyword">self</span>.<span class="title function_ invoke__">inner</span>().weak.<span class="title function_ invoke__">store</span>(<span class="number">1</span>, Release); <span class="comment">// release the lock</span></span><br><span class="line">        unique</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>deque in Rust</title>
      <link href="/2020/01/01/deque-in-Rust-and-C/"/>
      <url>/2020/01/01/deque-in-Rust-and-C/</url>
      
        <content type="html"><![CDATA[<h1 id="std-collections-VecDeque"><a href="#std-collections-VecDeque" class="headerlink" title="std::collections::VecDeque"></a>std::collections::VecDeque</h1><p>Rust çš„ <code>VecDeque</code> é‡‡å–çš„æ˜¯ ring buffer çš„æ–¹å¼æ¥å®ç°çš„ã€‚æˆ‘ä»¬é¦–å…ˆçœ‹çœ‹å®ƒçš„ç»“æ„ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// A double-ended queue implemented with a growable ring buffer.</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// The &quot;default&quot; usage of this type as a queue is to use [`push_back`] to add to</span></span><br><span class="line"><span class="comment">/// the queue, and [`pop_front`] to remove from the queue. [`extend`] and [`append`]</span></span><br><span class="line"><span class="comment">/// push onto the back in this manner, and iterating over `VecDeque` goes front</span></span><br><span class="line"><span class="comment">/// to back.</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// [`push_back`]: #method.push_back</span></span><br><span class="line"><span class="comment">/// [`pop_front`]: #method.pop_front</span></span><br><span class="line"><span class="comment">/// [`extend`]: #method.extend</span></span><br><span class="line"><span class="comment">/// [`append`]: #method.append</span></span><br><span class="line">#[<span class="built_in">stable</span>(feature = <span class="string">&quot;rust1&quot;</span>, since = <span class="string">&quot;1.0.0&quot;</span>)]</span><br><span class="line">pub <span class="keyword">struct</span> <span class="title class_">VecDeque</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="comment">// tail and head are pointers into the buffer. Tail always points</span></span><br><span class="line">    <span class="comment">// to the first element that could be read, Head always points</span></span><br><span class="line">    <span class="comment">// to where data should be written.</span></span><br><span class="line">    <span class="comment">// If tail == head the buffer is empty. The length of the ringbuffer</span></span><br><span class="line">    <span class="comment">// is defined as the distance between the two.</span></span><br><span class="line">    tail: usize,</span><br><span class="line">    head: usize,</span><br><span class="line">    buf: RawVec&lt;T&gt;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><em>RawVec</em> æˆ‘ä»¬ç¨åå»çœ‹ï¼Œç›®å‰å¯ä»¥ç†è§£æˆä¸€æ®µåˆ†é…çš„ã€è¿ç»­çš„ Unininitialize Memory</li></ul><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[allow(missing_debug_implementations)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">RawVec</span>&lt;T, A: Alloc = Global&gt; &#123;</span><br><span class="line">    ptr: Unique&lt;T&gt;,</span><br><span class="line">    cap: <span class="type">usize</span>,</span><br><span class="line">    a: A,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»–ä»¬å…·ä½“ç»“æ„å¯ä»¥çœ‹çœ‹æˆ‘éšæ‰‹å¼„çš„å›¾ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">buftailhead buf(end)</span><br><span class="line">|     |     |    |</span><br></pre></td></tr></table></figure><p>å†™å…¥çš„æ—¶å€™å‘ head å†™å…¥ï¼Œtail æ˜¯ å¯è¯»çš„å¤´ï¼ˆè€å®è¯´æˆ‘çœ‹ä»£ç ä¹‹å‰æ€»è§‰å¾—æ˜¯åè¿‡æ¥çš„ï¼‰ã€‚</p><p>å½“ <code>new</code> çš„æ—¶å€™ä¼š call <code>with_capacity</code></p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[stable(feature = <span class="string">&quot;rust1&quot;</span>, since = <span class="string">&quot;1.0.0&quot;</span>)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">with_capacity</span>(capacity: <span class="type">usize</span>) <span class="punctuation">-&gt;</span> VecDeque&lt;T&gt; &#123;</span><br><span class="line">    <span class="comment">// +1 since the ringbuffer always leaves one space empty</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">cap</span> = cmp::<span class="title function_ invoke__">max</span>(capacity + <span class="number">1</span>, MINIMUM_CAPACITY + <span class="number">1</span>).<span class="title function_ invoke__">next_power_of_two</span>();</span><br><span class="line">    <span class="built_in">assert!</span>(cap &gt; capacity, <span class="string">&quot;capacity overflow&quot;</span>);</span><br><span class="line"></span><br><span class="line">    VecDeque &#123;</span><br><span class="line">        tail: <span class="number">0</span>,</span><br><span class="line">        head: <span class="number">0</span>,</span><br><span class="line">        buf: RawVec::<span class="title function_ invoke__">with_capacity</span>(cap),</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>cap ä¼šè®©å¤§å°æˆä¸º 2 çš„å€æ•°ã€‚å› ä¸º head == tail æ˜¯ empty çš„è¡¨ç¤ºï¼Œæ‰€ä»¥éœ€è¦ <code>capacity + 1</code></p><p>å¯¹äº <code>push_back</code>:</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[stable(feature = <span class="string">&quot;rust1&quot;</span>, since = <span class="string">&quot;1.0.0&quot;</span>)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">push_back</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, value: T) &#123;</span><br><span class="line">    <span class="keyword">self</span>.<span class="title function_ invoke__">grow_if_necessary</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">head</span> = <span class="keyword">self</span>.head;</span><br><span class="line">    <span class="keyword">self</span>.head = <span class="keyword">self</span>.<span class="title function_ invoke__">wrap_add</span>(<span class="keyword">self</span>.head, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">unsafe</span> &#123; <span class="keyword">self</span>.<span class="title function_ invoke__">buffer_write</span>(head, value) &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>grow_if_necessary</code> æ¯”è¾ƒé‡è¦ï¼Œæˆ‘ä»¬åé¢ä»‹ç»</p><h3 id="Index-Wrap"><a href="#Index-Wrap" class="headerlink" title="Index Wrap"></a>Index Wrap</h3><p><code>wrap</code> å…¶å®æƒ³ä¸€æƒ³å¾ˆæ¸…æ™°ï¼Œè¿™ä¸ªä¸æ˜¯ç›´æ¥å»å–åœ°å€ï¼Œè€Œæ˜¯åœ¨ ring buffer é‡Œé¢æ‹¿åˆ°ä¸€ä¸ªç›¸å¯¹çš„åœ°å€ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/// Returns the index in the underlying buffer for a given logical element</span></span><br><span class="line"><span class="comment">/// index + addend.</span></span><br><span class="line"><span class="meta">#[inline]</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">wrap_add</span>(&amp;<span class="keyword">self</span>, idx: <span class="type">usize</span>, addend: <span class="type">usize</span>) <span class="punctuation">-&gt;</span> <span class="type">usize</span> &#123;</span><br><span class="line">    <span class="title function_ invoke__">wrap_index</span>(idx.<span class="title function_ invoke__">wrapping_add</span>(addend), <span class="keyword">self</span>.<span class="title function_ invoke__">cap</span>())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>wrap_index</code>:</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// Returns the index in the underlying buffer for a given logical element index.</span></span><br><span class="line"><span class="meta">#[inline]</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">wrap_index</span>(index: <span class="type">usize</span>, size: <span class="type">usize</span>) <span class="punctuation">-&gt;</span> <span class="type">usize</span> &#123;</span><br><span class="line">    <span class="comment">// size is always a power of 2</span></span><br><span class="line">    <span class="built_in">debug_assert!</span>(size.<span class="title function_ invoke__">is_power_of_two</span>());</span><br><span class="line">    index &amp; (size - <span class="number">1</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ª size å…¶å®æ˜¯ <code>RawVec</code> çš„ cap. æˆ‘ä»¬ä¹‹å‰çœ‹åˆ°äº† cap ä¼šä¿è¯è‡ªå·±æ˜¯ 2 çš„å€æ•°, è¿™é‡Œä¹Ÿæœ‰ <code>debug_assert</code>ã€‚æ‰€ä»¥ <code>index &amp; (size - 1)</code> ç›¸å½“äº <code>index % size</code>. æ‹¿åˆ°è¿™é‡Œå¯¹åº”çš„ indexã€‚è¿­ä»£å™¨ã€<code>index</code> éƒ½æ˜¯ç”¨è¿™ä¸€å¥—çš„ã€‚</p><p>æ‰€ä»¥ä¹‹å‰çš„ <code>push_back</code> ï¼š</p><ul><li>æ£€æŸ¥æ˜¯å¦è¦ grow, å¦‚æœè¦çš„è¯è‚¯å®šä¼šå…ˆ grow, grow æ–¹æ³•ä¸€ä¼šå„¿ä»‹ç»ã€‚</li><li>æ‹¿åˆ° old head (å¯å†™å…¥çš„)</li><li>head åœ¨ ringbuffer é‡Œé¢å‰è¿›</li><li>å†™å…¥ old head</li></ul><p>ç„¶åå¯ä»¥çœ‹çœ‹ <code>push_front</code> , å¾ˆç±»ä¼¼</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[stable(feature = <span class="string">&quot;rust1&quot;</span>, since = <span class="string">&quot;1.0.0&quot;</span>)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">push_front</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, value: T) &#123;</span><br><span class="line">    <span class="keyword">self</span>.<span class="title function_ invoke__">grow_if_necessary</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">self</span>.tail = <span class="keyword">self</span>.<span class="title function_ invoke__">wrap_sub</span>(<span class="keyword">self</span>.tail, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">tail</span> = <span class="keyword">self</span>.tail;</span><br><span class="line">    <span class="keyword">unsafe</span> &#123;</span><br><span class="line">        <span class="keyword">self</span>.<span class="title function_ invoke__">buffer_write</span>(tail, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸éœ€è¦æˆ‘è¿‡å¤šè§£é‡Šï¼Œä½ è‚¯å®šçŸ¥é“ï¼š</p><ul><li>æ£€æŸ¥æ˜¯å¦è¦ grow, å¦‚æœè¦çš„è¯è‚¯å®šä¼šå…ˆ grow, grow æ–¹æ³•ä¸€ä¼šå„¿ä»‹ç»ã€‚</li><li>æ‹¿åˆ° old tail </li><li>tail åœ¨ ringbuffer é‡Œé¢åé€€</li><li>å†™å…¥ old tail</li></ul><h2 id="Pop"><a href="#Pop" class="headerlink" title="Pop"></a>Pop</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[stable(feature = <span class="string">&quot;rust1&quot;</span>, since = <span class="string">&quot;1.0.0&quot;</span>)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">pop_front</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="type">Option</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">self</span>.<span class="title function_ invoke__">is_empty</span>() &#123;</span><br><span class="line">        <span class="literal">None</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">tail</span> = <span class="keyword">self</span>.tail;</span><br><span class="line">        <span class="keyword">self</span>.tail = <span class="keyword">self</span>.<span class="title function_ invoke__">wrap_add</span>(<span class="keyword">self</span>.tail, <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">unsafe</span> &#123; <span class="title function_ invoke__">Some</span>(<span class="keyword">self</span>.<span class="title function_ invoke__">buffer_read</span>(tail)) &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="grow-if-neccessary"><a href="#grow-if-neccessary" class="headerlink" title="grow_if_neccessary"></a><code>grow_if_neccessary</code></h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// This may panic or abort</span></span><br><span class="line"><span class="meta">#[inline]</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">grow_if_necessary</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">self</span>.<span class="title function_ invoke__">is_full</span>() &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">old_cap</span> = <span class="keyword">self</span>.<span class="title function_ invoke__">cap</span>();</span><br><span class="line">        <span class="keyword">self</span>.buf.<span class="title function_ invoke__">double</span>();</span><br><span class="line">        <span class="keyword">unsafe</span> &#123;</span><br><span class="line">            <span class="keyword">self</span>.<span class="title function_ invoke__">handle_capacity_increase</span>(old_cap);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">debug_assert!</span>(!<span class="keyword">self</span>.<span class="title function_ invoke__">is_full</span>());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>double</code> æ˜¯ raw_vec çš„ä¸€ä¸ªæ–¹æ³•ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[inline(never)]</span></span><br><span class="line">   <span class="meta">#[cold]</span></span><br><span class="line">   <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">double</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">       <span class="keyword">unsafe</span> &#123;</span><br><span class="line">           <span class="keyword">let</span> <span class="variable">elem_size</span> = mem::size_of::&lt;T&gt;();</span><br><span class="line"></span><br><span class="line">           <span class="comment">// since we set the capacity to usize::MAX when elem_size is</span></span><br><span class="line">           <span class="comment">// 0, getting to here necessarily means the RawVec is overfull.</span></span><br><span class="line">           <span class="built_in">assert!</span>(elem_size != <span class="number">0</span>, <span class="string">&quot;capacity overflow&quot;</span>);</span><br><span class="line"></span><br><span class="line">           <span class="keyword">let</span> (new_cap, uniq) = <span class="keyword">match</span> <span class="keyword">self</span>.<span class="title function_ invoke__">current_layout</span>() &#123;</span><br><span class="line">               <span class="title function_ invoke__">Some</span>(cur) =&gt; &#123;</span><br><span class="line">                   <span class="comment">// Since we guarantee that we never allocate more than</span></span><br><span class="line">                   <span class="comment">// isize::MAX bytes, `elem_size * self.cap &lt;= isize::MAX` as</span></span><br><span class="line">                   <span class="comment">// a precondition, so this can&#x27;t overflow. Additionally the</span></span><br><span class="line">                   <span class="comment">// alignment will never be too large as to &quot;not be</span></span><br><span class="line">                   <span class="comment">// satisfiable&quot;, so `Layout::from_size_align` will always</span></span><br><span class="line">                   <span class="comment">// return `Some`.</span></span><br><span class="line">                   <span class="comment">//</span></span><br><span class="line">                   <span class="comment">// tl;dr; we bypass runtime checks due to dynamic assertions</span></span><br><span class="line">                   <span class="comment">// in this module, allowing us to use</span></span><br><span class="line">                   <span class="comment">// `from_size_align_unchecked`.</span></span><br><span class="line">                   <span class="keyword">let</span> <span class="variable">new_cap</span> = <span class="number">2</span> * <span class="keyword">self</span>.cap;</span><br><span class="line">                   <span class="keyword">let</span> <span class="variable">new_size</span> = new_cap * elem_size;</span><br><span class="line">                   <span class="title function_ invoke__">alloc_guard</span>(new_size).<span class="title function_ invoke__">unwrap_or_else</span>(|_| <span class="title function_ invoke__">capacity_overflow</span>());</span><br><span class="line">                   <span class="keyword">let</span> <span class="variable">ptr_res</span> = <span class="keyword">self</span>.a.<span class="title function_ invoke__">realloc</span>(NonNull::<span class="title function_ invoke__">from</span>(<span class="keyword">self</span>.ptr).<span class="title function_ invoke__">cast</span>(),</span><br><span class="line">                                                cur,</span><br><span class="line">                                                new_size);</span><br><span class="line">                   <span class="keyword">match</span> ptr_res &#123;</span><br><span class="line">                       <span class="title function_ invoke__">Ok</span>(ptr) =&gt; (new_cap, ptr.<span class="title function_ invoke__">cast</span>().<span class="title function_ invoke__">into</span>()),</span><br><span class="line">                       <span class="title function_ invoke__">Err</span>(_) =&gt; <span class="title function_ invoke__">handle_alloc_error</span>(</span><br><span class="line">                           Layout::<span class="title function_ invoke__">from_size_align_unchecked</span>(new_size, cur.<span class="title function_ invoke__">align</span>())</span><br><span class="line">                       ),</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="literal">None</span> =&gt; &#123;</span><br><span class="line">                   <span class="comment">// skip to 4 because tiny Vec&#x27;s are dumb; but not if that</span></span><br><span class="line">                   <span class="comment">// would cause overflow</span></span><br><span class="line">                   <span class="keyword">let</span> <span class="variable">new_cap</span> = <span class="keyword">if</span> elem_size &gt; (!<span class="number">0</span>) / <span class="number">8</span> &#123; <span class="number">1</span> &#125; <span class="keyword">else</span> &#123; <span class="number">4</span> &#125;;</span><br><span class="line">                   <span class="keyword">match</span> <span class="keyword">self</span>.a.alloc_array::&lt;T&gt;(new_cap) &#123;</span><br><span class="line">                       <span class="title function_ invoke__">Ok</span>(ptr) =&gt; (new_cap, ptr.<span class="title function_ invoke__">into</span>()),</span><br><span class="line">                       <span class="title function_ invoke__">Err</span>(_) =&gt; <span class="title function_ invoke__">handle_alloc_error</span>(Layout::array::&lt;T&gt;(new_cap).<span class="title function_ invoke__">unwrap</span>()),</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;;</span><br><span class="line">           <span class="keyword">self</span>.ptr = uniq;</span><br><span class="line">           <span class="keyword">self</span>.cap = new_cap;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p>è°ƒç”¨ <code>realloc</code> ï¼Œ<em>ä¸æ”¹å˜ç°æœ‰å¸ƒå±€</em>çš„æƒ…å†µä¸‹ buffer å€æ‰©ï¼Œæ‰€ä»¥æ¥ä¸‹æ¥éœ€è¦ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">unsafe</span> &#123;</span><br><span class="line"><span class="keyword">self</span>.<span class="title function_ invoke__">handle_capacity_increase</span>(old_cap);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®ç°ä¸Šä»£ç å†™çš„å¾ˆæ¸…æ™°ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// Frobs the head and tail sections around to handle the fact that we</span></span><br><span class="line"><span class="comment">/// just reallocated. Unsafe because it trusts old_capacity.</span></span><br><span class="line"><span class="meta">#[inline]</span></span><br><span class="line"><span class="keyword">unsafe</span> <span class="keyword">fn</span> <span class="title function_">handle_capacity_increase</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, old_capacity: <span class="type">usize</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">new_capacity</span> = <span class="keyword">self</span>.<span class="title function_ invoke__">cap</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Move the shortest contiguous section of the ring buffer</span></span><br><span class="line">    <span class="comment">//    T             H</span></span><br><span class="line">    <span class="comment">//   [o o o o o o o . ]</span></span><br><span class="line">    <span class="comment">//    T             H</span></span><br><span class="line">    <span class="comment">// A [o o o o o o o . . . . . . . . . ]</span></span><br><span class="line">    <span class="comment">//        H T</span></span><br><span class="line">    <span class="comment">//   [o o . o o o o o ]</span></span><br><span class="line">    <span class="comment">//          T             H</span></span><br><span class="line">    <span class="comment">// B [. . . o o o o o o o . . . . . . ]</span></span><br><span class="line">    <span class="comment">//              H T</span></span><br><span class="line">    <span class="comment">//   [o o o o o . o o ]</span></span><br><span class="line">    <span class="comment">//              H                 T</span></span><br><span class="line">    <span class="comment">// C [o o o o o . . . . . . . . . o o ]</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">self</span>.tail &lt;= <span class="keyword">self</span>.head &#123;</span><br><span class="line">        <span class="comment">// A</span></span><br><span class="line">        <span class="comment">// Nop</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> <span class="keyword">self</span>.head &lt; old_capacity - <span class="keyword">self</span>.tail &#123;</span><br><span class="line">        <span class="comment">// B</span></span><br><span class="line">        <span class="keyword">self</span>.<span class="title function_ invoke__">copy_nonoverlapping</span>(old_capacity, <span class="number">0</span>, <span class="keyword">self</span>.head);</span><br><span class="line">        <span class="keyword">self</span>.head += old_capacity;</span><br><span class="line">        <span class="built_in">debug_assert!</span>(<span class="keyword">self</span>.head &gt; <span class="keyword">self</span>.tail);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// C</span></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">new_tail</span> = new_capacity - (old_capacity - <span class="keyword">self</span>.tail);</span><br><span class="line">        <span class="keyword">self</span>.<span class="title function_ invoke__">copy_nonoverlapping</span>(new_tail, <span class="keyword">self</span>.tail, old_capacity - <span class="keyword">self</span>.tail);</span><br><span class="line">        <span class="keyword">self</span>.tail = new_tail;</span><br><span class="line">        <span class="built_in">debug_assert!</span>(<span class="keyword">self</span>.head &lt; <span class="keyword">self</span>.tail);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">debug_assert!</span>(<span class="keyword">self</span>.head &lt; <span class="keyword">self</span>.<span class="title function_ invoke__">cap</span>());</span><br><span class="line">    <span class="built_in">debug_assert!</span>(<span class="keyword">self</span>.tail &lt; <span class="keyword">self</span>.<span class="title function_ invoke__">cap</span>());</span><br><span class="line">    <span class="built_in">debug_assert!</span>(<span class="keyword">self</span>.<span class="title function_ invoke__">cap</span>().<span class="title function_ invoke__">count_ones</span>() == <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªç®—æ³•ä¼šä¿è¯å°½é‡ç§»åŠ¨æœ€å°‘çš„å…ƒç´ ã€‚</p><ul><li>A: ä¸éœ€è¦è°ƒæ•´. åˆšå¥½ tail å®Œå…¨åœ¨å¼€å¤´ï¼Œå¯ä»¥æƒ³è±¡æˆåªæœ‰ push_backã€‚(front push pop åŒæ ·ä¹Ÿæœ‰å¯èƒ½å•¦ï¼Œå‡†ç¡®çš„è¯´)</li><li>B: <code>self.head &lt; old_capacity - self.tail</code> ä¿è¯ç§»åŠ¨å‰æ®µå…ƒç´ </li><li>C: å¦åˆ™ ç§»åŠ¨åæ®µå…ƒç´ ã€‚</li></ul><h2 id="Drop"><a href="#Drop" class="headerlink" title="Drop"></a>Drop</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[stable(feature = <span class="string">&quot;rust1&quot;</span>, since = <span class="string">&quot;1.0.0&quot;</span>)]</span></span><br><span class="line"><span class="keyword">unsafe</span> <span class="keyword">impl</span>&lt;<span class="meta">#[may_dangle]</span> T&gt; <span class="built_in">Drop</span> <span class="keyword">for</span> <span class="title class_">VecDeque</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">drop</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> (front, back) = <span class="keyword">self</span>.<span class="title function_ invoke__">as_mut_slices</span>();</span><br><span class="line">        <span class="keyword">unsafe</span> &#123;</span><br><span class="line">            <span class="comment">// use drop for [T]</span></span><br><span class="line">            ptr::<span class="title function_ invoke__">drop_in_place</span>(front);</span><br><span class="line">            ptr::<span class="title function_ invoke__">drop_in_place</span>(back);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// RawVec handles deallocation</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ª front back æ˜¯ [start, head) åˆ° [tail, end) çš„ slice</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[inline]</span></span><br><span class="line"><span class="meta">#[stable(feature = <span class="string">&quot;deque_extras_15&quot;</span>, since = <span class="string">&quot;1.5.0&quot;</span>)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">as_mut_slices</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) <span class="punctuation">-&gt;</span> (&amp;<span class="keyword">mut</span> [T], &amp;<span class="keyword">mut</span> [T]) &#123;</span><br><span class="line">    <span class="keyword">unsafe</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">head</span> = <span class="keyword">self</span>.head;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">tail</span> = <span class="keyword">self</span>.tail;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">buf</span> = <span class="keyword">self</span>.<span class="title function_ invoke__">buffer_as_mut_slice</span>();</span><br><span class="line">        RingSlices::<span class="title function_ invoke__">ring_slices</span>(buf, head, tail)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ª <code>ring_slice</code> å®ç°æ˜¯ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// Returns the two slices that cover the `VecDeque`&#x27;s valid range</span></span><br><span class="line"><span class="keyword">trait</span> <span class="title class_">RingSlices</span>: <span class="built_in">Sized</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">slice</span>(<span class="keyword">self</span>, from: <span class="type">usize</span>, to: <span class="type">usize</span>) <span class="punctuation">-&gt;</span> <span class="keyword">Self</span>;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">split_at</span>(<span class="keyword">self</span>, i: <span class="type">usize</span>) <span class="punctuation">-&gt;</span> (<span class="keyword">Self</span>, <span class="keyword">Self</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">ring_slices</span>(buf: <span class="keyword">Self</span>, head: <span class="type">usize</span>, tail: <span class="type">usize</span>) <span class="punctuation">-&gt;</span> (<span class="keyword">Self</span>, <span class="keyword">Self</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">contiguous</span> = tail &lt;= head;</span><br><span class="line">        <span class="keyword">if</span> contiguous &#123;</span><br><span class="line">            <span class="keyword">let</span> (empty, buf) = buf.<span class="title function_ invoke__">split_at</span>(<span class="number">0</span>);</span><br><span class="line">            (buf.<span class="title function_ invoke__">slice</span>(tail, head), empty)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> (mid, right) = buf.<span class="title function_ invoke__">split_at</span>(tail);</span><br><span class="line">            <span class="keyword">let</span> (left, _) = mid.<span class="title function_ invoke__">split_at</span>(head);</span><br><span class="line">            (right, left)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ª contiguous ç±»ä¼¼æˆ‘ä»¬ä¹‹å‰æ‰©å®¹ çš„æ—¶å€™ã€‚</p><p>è€Œå†…å­˜çš„å›æ”¶äº¤ç»™ <code>RawVec</code>.</p><h2 id="æ€§èƒ½"><a href="#æ€§èƒ½" class="headerlink" title="æ€§èƒ½"></a>æ€§èƒ½</h2><ul><li><code>push_front</code> <code>push_back</code>: å‡æ‘Šå¤æ‚åº¦å’Œ <code>Vec</code> çš„ <code>push_back</code>ä¸€æ ·ï¼Œä¸è¿‡å¯èƒ½æ‰©å®¹çš„æ—¶å€™éœ€è¦ 1.5 å€ size çš„å¤åˆ¶</li></ul><p>ä¸‹é¢è¿™æ®µä»å®˜æ–¹æ–‡æ¡£å¤åˆ¶è¿‡æ¥çš„</p><div class="table-container"><table><thead><tr><th style="text-align:left"></th><th style="text-align:left">get(i)</th><th style="text-align:left">insert(i)</th><th style="text-align:left">remove(i)</th><th style="text-align:left">append</th><th style="text-align:left">split_off(i)</th></tr></thead><tbody><tr><td style="text-align:left"><a href="https://doc.rust-lang.org/std/vec/struct.Vec.html"><code>Vec</code></a></td><td style="text-align:left">O(1)</td><td style="text-align:left">O(n-i)*</td><td style="text-align:left">O(n-i)</td><td style="text-align:left">O(m)*</td><td style="text-align:left">O(n-i)</td></tr><tr><td style="text-align:left"><a href="https://doc.rust-lang.org/std/collections/struct.VecDeque.html"><code>VecDeque</code></a></td><td style="text-align:left">O(1)</td><td style="text-align:left">O(min(i, n-i))*</td><td style="text-align:left">O(min(i, n-i))</td><td style="text-align:left">O(m)*</td><td style="text-align:left">O(min(i, n-i))</td></tr><tr><td style="text-align:left"><a href="https://doc.rust-lang.org/std/collections/struct.LinkedList.html"><code>LinkedList</code></a></td><td style="text-align:left">O(min(i, n-i))</td><td style="text-align:left">O(min(i, n-i))</td><td style="text-align:left">O(min(i, n-i))</td><td style="text-align:left">O(1)</td><td style="text-align:left">O(min(i, n-i))</td></tr></tbody></table></div><p>Note that where ties occur, <a href="https://doc.rust-lang.org/std/vec/struct.Vec.html"><code>Vec</code></a> is generally going to be faster than <a href="https://doc.rust-lang.org/std/collections/struct.VecDeque.html"><code>VecDeque</code></a>, and <a href="https://doc.rust-lang.org/std/collections/struct.VecDeque.html"><code>VecDeque</code></a> is generally going to be faster than</p>]]></content>
      
      
      
        <tags>
            
            <tag> language </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Naive C++ STL: searching and copying</title>
      <link href="/2019/12/27/Naive-C-STL-searching-and-copying/"/>
      <url>/2019/12/27/Naive-C-STL-searching-and-copying/</url>
      
        <content type="html"><![CDATA[<h1 id="Naive-C-STL-searching-and-copying"><a href="#Naive-C-STL-searching-and-copying" class="headerlink" title="Naive C++ STL: searching and copying"></a>Naive C++ STL: searching and copying</h1><p>å› ä¸ºæœ¬äººä¸ä¼šå†™ C++ï¼Œæ‰€ä»¥å¾ˆå¤šåœ°æ–¹æ˜¯å¾ˆ naive çš„æ‰‹åŠ¨å¤åˆ¶å’ŒæŸ¥æ‰¾çš„ï¼Œååˆ†å‚»é€¼ã€‚ç°åœ¨æˆ‘ä»¬ç”¨ STL æ¥æ”¹é€ å¼±æ™ºä»£ç å§ã€‚</p><h2 id="Tools-about-copying"><a href="#Tools-about-copying" class="headerlink" title="Tools about copying"></a>Tools about copying</h2><h3 id="memcpy"><a href="#memcpy" class="headerlink" title="memcpy"></a><code>memcpy</code></h3><blockquote><div class="table-container"><table><thead><tr><th>dest</th><th>-</th><th>pointer to the memory location to copy to</th></tr></thead><tbody><tr><td>src</td><td>-</td><td>pointer to the memory location to copy from</td></tr><tr><td>count</td><td>-</td><td>number of bytes to copy</td></tr></tbody></table></div><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span>* <span class="title function_">memcpy</span><span class="params">( <span class="type">void</span>* dest, <span class="type">const</span> <span class="type">void</span>* src, <span class="built_in">std</span>::<span class="type">size_t</span> count )</span>;</span><br></pre></td></tr></table></figure></blockquote><p>å…³äºå®ƒçš„æ•ˆç‡ï¼š</p><blockquote><p>memcpyæ¯”å¾ªç¯èµ‹å€¼å¿«å—ï¼Ÿä¸ºä»€ä¹ˆï¼Ÿ - æµ·æ«çš„å›ç­” - çŸ¥ä¹ <a href="https://www.zhihu.com/question/356017800/answer/907232343">https://www.zhihu.com/question/356017800/answer/907232343</a></p></blockquote><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼š</p><blockquote><p>If the objects overlap, the behavior is undefined.</p><p>If either <code>dest</code> or <code>src</code> is a null pointer, the behavior is undefined, even if <code>count</code> is zero.</p></blockquote><p>æˆ‘ä¸ªäººè§‰å¾—è¿™å¯èƒ½åŸºäºä¸€äº›å®ç°ä¸Šçš„ä¼˜åŒ–ï¼Œå¦‚æœä¸æƒ³è¦çš„è¯ï¼Œå¯ä»¥è·³åˆ°ä¸‹ä¸€ä¸ªå·¥å…·</p><h3 id="memmove"><a href="#memmove" class="headerlink" title="memmove"></a><code>memmove</code></h3><blockquote><p>The objects may overlap: copying takes place as if the characters were copied to a temporary character array and then the characters were copied from the array to <code>dest</code>.</p></blockquote><p>ä¼¼ä¹å¤šä¸€æ¡æ£€æŸ¥è¾¹ç•Œçš„æŒ‡ä»¤ï¼Œè¿™ä¸ª sample code è¯´æ˜äº†ä¸€åˆ‡ï¼š</p><blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstring&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line"> <span class="type">char</span> str[] = <span class="string">&quot;1234567890&quot;</span>;</span><br><span class="line"> <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; str &lt;&lt; <span class="string">&#x27;\n&#x27;</span>;</span><br><span class="line"> <span class="built_in">std</span>::memmove(str + <span class="number">4</span>, str + <span class="number">3</span>, <span class="number">3</span>); <span class="comment">// copies from [4, 5, 6] to [5, 6, 7]</span></span><br><span class="line"> <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; str &lt;&lt; <span class="string">&#x27;\n&#x27;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></blockquote><h3 id="std-copy-std-copy-if"><a href="#std-copy-std-copy-if" class="headerlink" title="std::copy std::copy_if"></a><code>std::copy</code> <code>std::copy_if</code></h3><p>åŒä¸Šï¼š</p><blockquote><p>Copies all elements in the range <code>[first, last)</code> starting from first and proceeding to last - 1. The behavior is undefined if <code>d_first</code> is within the range <code>[first, last)</code>. In this case, <a href="https://en.cppreference.com/w/cpp/algorithm/copy_backward">std::copy_backward</a> may be used instead.</p><p>Only copies the elements for which the predicate <code>pred</code> returns true. The relative order of the elements that are copied is preserved. The behavior is undefined if the source and the destination ranges overlap.</p></blockquote><p>å¯ä»¥æŒ‡å®š execute_policy.</p><p>å…¶å®å¯èƒ½ä½ å¬è¿‡ <code>std::uninitialized_copy</code>, å®é™…ä¸Šè¿™éƒ¨åˆ†å†…å®¹åœ¨ä¸‹é¢ StackoverFlow é‡Œæœ‰ï¼š</p><p><a href="https://stackoverflow.com/questions/30158192/difference-between-stduninitialized-copy-stdcopy">https://stackoverflow.com/questions/30158192/difference-between-stduninitialized-copy-stdcopy</a></p><p>å®é™…ä¸Šå¾ˆç®€å•ï¼Œ<code>uninitialized_copy</code> ç”¨ construct, è°ƒç”¨ constructor.</p><p>æ­¤å¤– cppreference ä¸Šè®¤ä¸ºè¿™äº›ä¼šå°½é‡ç”¨ <code>memmove</code> å®ç°</p><h3 id="std-copy-backward"><a href="#std-copy-backward" class="headerlink" title="std::copy_backward"></a><code>std::copy_backward</code></h3><blockquote><p>When copying overlapping ranges, <code>std::copy</code> is appropriate when copying to the left (beginning of the destination range is outside the source range) while <code>std::copy_backward</code> is appropriate when copying to the right (end of the destination range is outside the source range).</p></blockquote><p>æ³¨æ„åˆ«å’Œä¸‹é¢çš„ææ··äº†</p><h3 id="std-reversed-copy"><a href="#std-reversed-copy" class="headerlink" title="std::reversed_copy"></a><code>std::reversed_copy</code></h3><blockquote><p>Copies the elements from the range <code>[first, last)</code> to another range beginning at <code>d_first</code> in such a way that the elements in the new range are in reverse order.</p><p>Behaves as if by executing the assignment <em>(d_first + (last - first) - 1 - i) = </em>(first + i) once for each non-negative <code>i &lt; (last - first)</code></p><p>If the source and destination ranges (that is, <code>[first, last)</code> and <code>[d_first, d_first+(last-first))</code> respectively) overlap, the behavior is undefined.</p></blockquote><p>BidirIt éœ€è¦æ»¡è¶³ï¼š<a href="https://en.cppreference.com/w/cpp/named_req/BidirectionalIterator"><em>LegacyBidirectionalIterator</em></a></p><p>åŒºåˆ«å¾ˆå¤§ï¼š<a href="https://stackoverflow.com/questions/34049447/difference-between-copy-backward-and-reverse-copy">https://stackoverflow.com/questions/34049447/difference-between-copy-backward-and-reverse-copy</a></p><h3 id="std-uninitialized-xxx"><a href="#std-uninitialized-xxx" class="headerlink" title="std::uninitialized_xxx"></a><code>std::uninitialized_xxx</code></h3><p>ç›¸å½“äºåœ¨ MayUninitMem ä¸Š placement new, ç„¶åè°ƒç”¨ copy constructor.</p><h2 id="Tools-about-searching"><a href="#Tools-about-searching" class="headerlink" title="Tools about searching"></a>Tools about searching</h2><h3 id="on-unsorted-ranges"><a href="#on-unsorted-ranges" class="headerlink" title="on unsorted ranges"></a>on unsorted ranges</h3><h4 id="find-find-if-find-first-of"><a href="#find-find-if-find-first-of" class="headerlink" title="find find_if find_first_of"></a><code>find</code> <code>find_if</code> <code>find_first_of</code></h4><ul><li>æ ¹æ®æ¡ä»¶ find</li><li>æ‰¾åˆ°â€œé¦–ä¸ªâ€ç¬¦åˆæ¡ä»¶çš„ï¼Œå¦åˆ™è¿”å›å°¾éƒ¨</li></ul><h4 id="std-adjacent-find"><a href="#std-adjacent-find" class="headerlink" title="std::adjacent_find"></a><code>std::adjacent_find</code></h4><p>æ‰¾åˆ°ä¸¤ä¸ªè¿ç»­ç›¸åŒå…ƒç´ </p><h4 id="std-search"><a href="#std-search" class="headerlink" title="std::search"></a><code>std::search</code></h4><p>ç±»ä¼¼å­—ç¬¦ä¸²æŸ¥æ‰¾ï¼Œåœ¨é¡ºåºå®¹å™¨ä¸­æŸ¥æ‰¾å­é¡ºåºå®¹å™¨</p><h3 id="on-sorted-ranges"><a href="#on-sorted-ranges" class="headerlink" title="on sorted ranges"></a>on sorted ranges</h3><h4 id="std-lower-bound-std-upper-bound"><a href="#std-lower-bound-std-upper-bound" class="headerlink" title="std::lower_bound std::upper_bound"></a><code>std::lower_bound</code> <code>std::upper_bound</code></h4><p>åˆ†åˆ«æ˜¯ï¼š</p><blockquote><p>Returns an iterator pointing to the first element in the range <code>[first, last)</code> that is <em>not less</em> than (i.e. greater or equal to) <code>value</code>, or <code>last</code> if no such element is found.</p><p>Returns an iterator pointing to the first element in the range <code>[first, last)</code> that is <em>greater</em> than <code>value</code>, or <code>last</code> if no such element is found.</p></blockquote><p>æ³¨æ„éƒ½æ˜¯ last</p><p>æ³¨æ„ comp:</p><blockquote><p>binary predicate which returns true if the first argument is <em>less</em> than (i.e. is ordered before) the second.</p></blockquote><h4 id="std-equal-range"><a href="#std-equal-range" class="headerlink" title="std::equal_range"></a><code>std::equal_range</code></h4><p>å¯èƒ½å®ç°æˆè¿™æ ·ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">class</span> ForwardIt, <span class="keyword">class</span> T&gt;</span></span><br><span class="line"><span class="function">std::pair&lt;ForwardIt,ForwardIt&gt; </span></span><br><span class="line"><span class="function">    <span class="title">equal_range</span><span class="params">(ForwardIt first, ForwardIt last,</span></span></span><br><span class="line"><span class="params"><span class="function">                <span class="type">const</span> T&amp; value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> std::<span class="built_in">make_pair</span>(std::<span class="built_in">lower_bound</span>(first, last, value),</span><br><span class="line">                          std::<span class="built_in">upper_bound</span>(first, last, value));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Migration"><a href="#Migration" class="headerlink" title="Migration"></a>Migration</h2><p>ä»¥ä¸Šæ˜¯æˆ‘å†™çš„åºŸç‰©ä»£ç ï¼Œç°åœ¨è€ƒè™‘æŠŠä¹‹å‰ proj çš„ä»£ç è¿ç§»åˆ°è¿™äº›ä¸Šå»ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">INDEX_TEMPLATE_ARGUMENTS</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">B_PLUS_TREE_INTERNAL_PAGE_TYPE::ValueIndex</span><span class="params">(<span class="type">const</span> ValueType &amp;value)</span> <span class="type">const</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>-&gt;<span class="built_in">GetSize</span>(); ++i) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">ValueAt</span>(i) == value) &#123;</span><br><span class="line">            <span class="keyword">return</span> i;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">GetSize</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li>B+ æ ‘çš„ internal page æ˜¯æ— åºçš„ï¼Œæ‰€ä»¥ä»ç„¶éœ€è¦ä¸€ä¸ªçº¿æ€§çš„æŸ¥æ‰¾</li><li>ç›®æ ‡æ˜¯ä¸ä¼šé‡å¤çš„</li></ul><p>æ‰€ä»¥æˆ‘æ”¹æˆäº†ä¸€ä¸ªå¾ˆ naive çš„ code:</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">INDEX_TEMPLATE_ARGUMENTS</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">B_PLUS_TREE_INTERNAL_PAGE_TYPE::ValueIndex</span><span class="params">(<span class="type">const</span> ValueType &amp;value)</span> <span class="type">const</span> </span>&#123;</span><br><span class="line"><span class="keyword">auto</span> iter =</span><br><span class="line">        std::<span class="built_in">lower_bound</span>(<span class="keyword">this</span>-&gt;array, <span class="keyword">this</span>-&gt;array + <span class="built_in">GetSize</span>(), value,</span><br><span class="line">                         [](<span class="type">const</span> MappingType &amp;mp, <span class="type">const</span> ValueType &amp;vl) &#123;</span><br><span class="line">                             <span class="keyword">return</span> mp.second &lt; vl;</span><br><span class="line">                         &#125;);</span><br><span class="line">    <span class="keyword">if</span> (iter == <span class="keyword">this</span>-&gt;array + <span class="built_in">GetSize</span>() || iter-&gt;second != value) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">GetSize</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> iter - <span class="keyword">this</span>-&gt;array;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>copying:</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// <span class="doctag">TODO:</span> select a STL function like `copy_backward` to help us to move</span></span><br><span class="line"><span class="comment">// memory.</span></span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="built_in">GetSize</span>(); i &gt; to_insert_pos; --i) &#123;</span><br><span class="line">    <span class="keyword">this</span>-&gt;array[i] = <span class="keyword">this</span>-&gt;array[i - <span class="number">1</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå®é™…ä¸Šè‚¯å®šå¯ä»¥åˆ‡æ¢æˆ copy_backward, ä½†æ˜¯å†™çš„æ—¶å€™å¤§è„‘å¾—æ¸…æ™°ä¸€äº›ï¼š</p><ul><li>å®é™…ä¸Šæ•°æ®èŒƒå›´ç±»ä¼¼ [src_start, src_end) å’Œ [target_end - (src_end - src_start), target_end)</li><li>æ³¨æ„æ‹·è´</li></ul><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">std::<span class="built_in">copy_backward</span>(<span class="keyword">this</span>-&gt;array + to_insert_pos, <span class="keyword">this</span>-&gt;array + <span class="built_in">GetSize</span>(),</span><br><span class="line">                       <span class="keyword">this</span>-&gt;array + <span class="built_in">GetSize</span>() + <span class="number">1</span>);</span><br></pre></td></tr></table></figure><p>binary_search:</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> i = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">for</span> (; i &lt; <span class="built_in">GetSize</span>(); ++i) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">comparator</span>(<span class="keyword">this</span>-&gt;array[i].first, key) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> i;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå®é™…ä¸Š key æ˜¯æœ‰åºçš„ï¼Œå¯ä»¥åˆ©ç”¨ stl çš„äºŒåˆ†ï¼Œè¿™é‡Œæˆ‘å†™äº†ä¸ª lower_bound:</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">auto</span> iter =</span><br><span class="line">    std::<span class="built_in">lower_bound</span>(<span class="keyword">this</span>-&gt;array, <span class="keyword">this</span>-&gt;array + <span class="built_in">GetSize</span>(), key,</span><br><span class="line">                     [&amp;](<span class="type">const</span> MappingType &amp;mp, <span class="type">const</span> KeyType &amp;key) &#123;</span><br><span class="line">                         <span class="keyword">return</span> <span class="built_in">comparator</span>(mp.first, key) &lt; <span class="number">0</span>;</span><br><span class="line">                     &#125;);</span><br><span class="line"><span class="keyword">return</span> iter - <span class="keyword">this</span>-&gt;array;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Rust std::cell</title>
      <link href="/2019/11/27/Rust-std-cell/"/>
      <url>/2019/11/27/Rust-std-cell/</url>
      
        <content type="html"><![CDATA[<h1 id="std-cell"><a href="#std-cell" class="headerlink" title="std::cell"></a>std::cell</h1><p>ä»Šå¤©ç—…ç»ˆäºå¥½äº†ï¼Œä¸ç”¨ä¸Šè…¹ä¸‹æ³„äº†ï¼Œæ¥å†™ç‚¹æ°´æ–‡åº†ç¥ä¸€ä¸‹ğŸ‰</p><h2 id="UnsafeCell"><a href="#UnsafeCell" class="headerlink" title="UnsafeCell"></a>UnsafeCell</h2><p><code>UnsafeCell</code> çš„åŠ¨æœºåœ¨ F001 å¤§ä½¬çš„ <a href="https://zhuanlan.zhihu.com/p/22243054">è¿™ç¯‡æ–‡ç« </a> é‡Œé¢æåŠäº†ï¼Œæä¸€ä¸‹ä½œè€…å†™çš„ä¹¦è¿˜æ˜¯å¾ˆä¸é”™çš„ï¼Œå¯¹æˆ‘å¸®åŠ©å¾ˆå¤§ã€‚</p><p><code>UnsafeCell</code> ç»“æ„å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[lang = <span class="string">&quot;unsafe_cell&quot;</span>]</span></span><br><span class="line"><span class="meta">#[stable(feature = <span class="string">&quot;rust1&quot;</span>, since = <span class="string">&quot;1.0.0&quot;</span>)]</span></span><br><span class="line"><span class="meta">#[repr(transparent)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">UnsafeCell</span>&lt;T: ?<span class="built_in">Sized</span>&gt; &#123;</span><br><span class="line">    value: T,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ³¨æ„ä¸€ä¸‹ marker:</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[stable(feature = <span class="string">&quot;rust1&quot;</span>, since = <span class="string">&quot;1.0.0&quot;</span>)]</span></span><br><span class="line"><span class="keyword">impl</span>&lt;T: ?<span class="built_in">Sized</span>&gt; !<span class="built_in">Sync</span> <span class="keyword">for</span> <span class="title class_">UnsafeCell</span>&lt;T&gt; &#123;&#125;</span><br></pre></td></tr></table></figure><p>æ¯”è¾ƒé‡è¦çš„æ–¹æ³•æ˜¯ <code>get</code>:</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">impl</span>&lt;T: ?<span class="built_in">Sized</span>&gt; UnsafeCell&lt;T&gt; &#123;</span><br><span class="line">    <span class="comment">/// Gets a mutable pointer to the wrapped value.</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// This can be cast to a pointer of any kind.</span></span><br><span class="line">    <span class="comment">/// Ensure that the access is unique (no active references, mutable or not)</span></span><br><span class="line">    <span class="comment">/// when casting to `&amp;mut T`, and ensure that there are no mutations</span></span><br><span class="line">    <span class="comment">/// or mutable aliases going on when casting to `&amp;T`</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// # Examples</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// ```</span></span><br><span class="line">    <span class="comment">/// use std::cell::UnsafeCell;</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// let uc = UnsafeCell::new(5);</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// let five = uc.get();</span></span><br><span class="line">    <span class="comment">/// ```</span></span><br><span class="line">    <span class="meta">#[inline]</span></span><br><span class="line">    <span class="meta">#[stable(feature = <span class="string">&quot;rust1&quot;</span>, since = <span class="string">&quot;1.0.0&quot;</span>)]</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">const</span> <span class="keyword">fn</span> <span class="title function_">get</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> *<span class="keyword">mut</span> T &#123;</span><br><span class="line">        <span class="comment">// We can just cast the pointer from `UnsafeCell&lt;T&gt;` to `T` because of</span></span><br><span class="line">        <span class="comment">// #[repr(transparent)]</span></span><br><span class="line">        <span class="keyword">self</span> <span class="keyword">as</span> *<span class="keyword">const</span> UnsafeCell&lt;T&gt; <span class="keyword">as</span> *<span class="keyword">const</span> T <span class="keyword">as</span> *<span class="keyword">mut</span> T</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>repr(transparent)</code> èµ„æ–™åœ¨ï¼š</p><ul><li><a href="https://github.com/rust-lang/rust/issues/43036">https://github.com/rust-lang/rust/issues/43036</a></li><li><a href="https://github.com/rust-lang/rfcs/pull/1758">https://github.com/rust-lang/rfcs/pull/1758</a></li><li><a href="https://github.com/rust-lang/rfcs/blob/master/text/1758-repr-transparent.md">https://github.com/rust-lang/rfcs/blob/master/text/1758-repr-transparent.md</a></li></ul><blockquote><p>On some ABIs, structures with one field arenâ€™t handled the same way as values of the same type as the single field. For example on ARM64, functions returning a structure with a single <code>f64</code> field return nothing and take a pointer to be filled with the return value, whereas functions returning a <code>f64</code> return the floating-point number directly.</p><p>This means that if someone wants to wrap a <code>f64</code> value in a struct tuple wrapper and use that wrapper as the return type of a FFI function that actually returns a bare <code>f64</code>, the calls to this function will be compiled incorrectly by Rust and the execution of the program will segfault.</p><p>This also means that <code>UnsafeCell</code> cannot be soundly used in place of a bare <code>T</code> in FFI context, which might be necessary to signal to the Rust side of things that this <code>T</code> value may unexpectedly be mutated.</p></blockquote><h2 id="std-cell-Cell"><a href="#std-cell-Cell" class="headerlink" title="std::cell::Cell"></a>std::cell::Cell</h2><blockquote><p><code>Cell</code> implements interior mutability by moving values in and out of the <code>Cell</code>. To use references instead of values, one must use the <code>RefCell</code> type, acquiring a write lock before mutating. <code>Cell</code> provides methods to retrieve and change the current interior value:</p><ul><li>For types that implement <code>Copy</code>, the <code>get</code> method retrieves the current interior value.</li><li>For types that implement <code>Default</code>, the <code>take</code> method replaces the current interior value with <code>Default::default()</code> and returns the replaced value.</li><li>For all types, the <code>replace</code> method replaces the current interior value and returns the replaced value and the <code>into_inner</code> method consumes the <code>Cell</code> and returns the interior value. Additionally, the <code>set</code> method replaces the interior value, dropping the replaced value.</li></ul></blockquote><p>å¯¹äº <code>Cell</code> è€Œè¨€ï¼Œä¸ä¸€å®šå®Œå…¨éœ€è¦ä½ å®ç° Copy æ‰èƒ½ç”¨ï¼Œ<code>get</code> éœ€è¦ä½ å®ç° <code>Copy</code>, <code>set</code> ä¼šç§»é™¤åŸå…ˆå†…éƒ¨çš„</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[stable(feature = <span class="string">&quot;rust1&quot;</span>, since = <span class="string">&quot;1.0.0&quot;</span>)]</span></span><br><span class="line"><span class="meta">#[repr(transparent)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">Cell</span>&lt;T: ?<span class="built_in">Sized</span>&gt; &#123;</span><br><span class="line">    value: UnsafeCell&lt;T&gt;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯¹åº”çš„å‡ ä¸ª marker</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[stable(feature = <span class="string">&quot;rust1&quot;</span>, since = <span class="string">&quot;1.0.0&quot;</span>)]</span></span><br><span class="line"><span class="keyword">unsafe</span> <span class="keyword">impl</span>&lt;T: ?<span class="built_in">Sized</span>&gt; <span class="built_in">Send</span> <span class="keyword">for</span> <span class="title class_">Cell</span>&lt;T&gt; <span class="keyword">where</span> T: <span class="built_in">Send</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[stable(feature = <span class="string">&quot;rust1&quot;</span>, since = <span class="string">&quot;1.0.0&quot;</span>)]</span></span><br><span class="line"><span class="keyword">impl</span>&lt;T: ?<span class="built_in">Sized</span>&gt; !<span class="built_in">Sync</span> <span class="keyword">for</span> <span class="title class_">Cell</span>&lt;T&gt; &#123;&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œä»ç»“æ„è®¾è®¡æ¥çœ‹, <code>Cell</code> ç›¸å¯¹æ¥è¯´é¢å¤–å¼€é”€å°ä¸€äº›ã€‚</p><p>Get/Set:</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">impl</span>&lt;T:<span class="built_in">Copy</span>&gt; Cell&lt;T&gt; &#123;</span><br><span class="line">    <span class="comment">/// Returns a copy of the contained value.</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// # Examples</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// ```</span></span><br><span class="line">    <span class="comment">/// use std::cell::Cell;</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// let c = Cell::new(5);</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// let five = c.get();</span></span><br><span class="line">    <span class="comment">/// ```</span></span><br><span class="line">    <span class="meta">#[inline]</span></span><br><span class="line">    <span class="meta">#[stable(feature = <span class="string">&quot;rust1&quot;</span>, since = <span class="string">&quot;1.0.0&quot;</span>)]</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">get</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> T &#123;</span><br><span class="line">        <span class="keyword">unsafe</span>&#123; *<span class="keyword">self</span>.value.<span class="title function_ invoke__">get</span>() &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// çœç•¥</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ª <code>get</code> éœ€è¦å®ç° copy trait, æ‹¿åˆ° <code>UnsafeCell</code> å†…éƒ¨çš„æ•°å€¼ã€‚ç„¶åæŠŠè¿™ä¸ªæ—§å€¼ <code>drop</code> æ‰ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">impl</span>&lt;T&gt; Cell&lt;T&gt; &#123;</span><br><span class="line">    <span class="comment">/// Sets the contained value.</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// # Examples</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// ```</span></span><br><span class="line">    <span class="comment">/// use std::cell::Cell;</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// let c = Cell::new(5);</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// c.set(10);</span></span><br><span class="line">    <span class="comment">/// ```</span></span><br><span class="line">    <span class="meta">#[inline]</span></span><br><span class="line">    <span class="meta">#[stable(feature = <span class="string">&quot;rust1&quot;</span>, since = <span class="string">&quot;1.0.0&quot;</span>)]</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">set</span>(&amp;<span class="keyword">self</span>, val: T) &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">old</span> = <span class="keyword">self</span>.<span class="title function_ invoke__">replace</span>(val);</span><br><span class="line">        <span class="title function_ invoke__">drop</span>(old);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>çœ‹æ¥æˆ‘ä»¬éœ€è¦çœ‹çœ‹ <code>replace</code>:</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[stable(feature = <span class="string">&quot;move_cell&quot;</span>, since = <span class="string">&quot;1.17.0&quot;</span>)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">replace</span>(&amp;<span class="keyword">self</span>, val: T) <span class="punctuation">-&gt;</span> T &#123;</span><br><span class="line">    mem::<span class="title function_ invoke__">replace</span>(<span class="keyword">unsafe</span> &#123; &amp;<span class="keyword">mut</span> *<span class="keyword">self</span>.value.<span class="title function_ invoke__">get</span>() &#125;, val)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>mem::replace</code> çš„æ–‡æ¡£å¦‚ä¸‹ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">replace</span>&lt;T&gt;(dest: &amp;<span class="keyword">mut</span> T, src: T) <span class="punctuation">-&gt;</span> T</span><br></pre></td></tr></table></figure><blockquote><p>Moves <code>src</code> into the referenced <code>dest</code>, returning the previous <code>dest</code> value.</p><p>Neither value is dropped.</p></blockquote><p>è¿”å› <code>UnsafeCell</code> ä¿å­˜çš„å€¼ï¼ŒåŒæ—¶å†™å…¥ <code>UnsafeCell</code>.</p><h2 id="std-cell-RefCell"><a href="#std-cell-RefCell" class="headerlink" title="std::cell::RefCell"></a>std::cell::RefCell</h2><blockquote><p><code>RefCell</code> uses Rustâ€™s lifetimes to implement â€˜dynamic borrowingâ€™, a process whereby one can claim temporary, exclusive, mutable access to the inner value. Borrows for <code>RefCell</code>s are tracked â€˜at runtimeâ€™, unlike Rustâ€™s native reference types which are entirely tracked statically, at compile time. Because <code>RefCell</code> borrows are dynamic it is possible to attempt to borrow a value that is already mutably borrowed; when this happens it results in thread panic.</p></blockquote><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// A mutable memory location with dynamically checked borrow rules</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// See the [module-level documentation](index.html) for more.</span></span><br><span class="line"><span class="meta">#[stable(feature = <span class="string">&quot;rust1&quot;</span>, since = <span class="string">&quot;1.0.0&quot;</span>)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">RefCell</span>&lt;T: ?<span class="built_in">Sized</span>&gt; &#123;</span><br><span class="line">    borrow: Cell&lt;BorrowFlag&gt;,</span><br><span class="line">    value: UnsafeCell&lt;T&gt;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®ƒç›¸å¯¹ <code>Cell</code> å¤šç»´æŠ¤äº†ä¸€ä¸ª <code>borrow</code> å­—æ®µï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Positive values represent the number of `Ref` active. Negative values</span></span><br><span class="line"><span class="comment">// represent the number of `RefMut` active. Multiple `RefMut`s can only be</span></span><br><span class="line"><span class="comment">// active at a time if they refer to distinct, nonoverlapping components of a</span></span><br><span class="line"><span class="comment">// `RefCell` (e.g., different ranges of a slice).</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// `Ref` and `RefMut` are both two words in size, and so there will likely never</span></span><br><span class="line"><span class="comment">// be enough `Ref`s or `RefMut`s in existence to overflow half of the `usize`</span></span><br><span class="line"><span class="comment">// range. Thus, a `BorrowFlag` will probably never overflow or underflow.</span></span><br><span class="line"><span class="comment">// However, this is not a guarantee, as a pathological program could repeatedly</span></span><br><span class="line"><span class="comment">// create and then mem::forget `Ref`s or `RefMut`s. Thus, all code must</span></span><br><span class="line"><span class="comment">// explicitly check for overflow and underflow in order to avoid unsafety, or at</span></span><br><span class="line"><span class="comment">// least behave correctly in the event that overflow or underflow happens (e.g.,</span></span><br><span class="line"><span class="comment">// see BorrowRef::new).</span></span><br><span class="line"><span class="keyword">type</span> <span class="title class_">BorrowFlag</span> = <span class="type">isize</span>;</span><br><span class="line"><span class="keyword">const</span> UNUSED: BorrowFlag = <span class="number">0</span>;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼š</p><ul><li><code>UNUSED</code> è¡¨ç¤ºè¿™ä¸ª <code>RefCell</code> å¹¶æ²¡æœ‰ä»»ä½•å€Ÿç”¨</li><li>Positive value: è¡¨ç¤º <code>Ref</code>, è¿™é‡Œå¯ä»¥æ¨æµ‹æ˜¯ <code>&amp;T</code> æ¨¡å¼çš„å€Ÿç”¨å­˜åœ¨</li><li>Nagative value: è¡¨ç¤º <code>RefMut</code>, è¿™é‡Œå¯ä»¥æ¨æµ‹æ˜¯ <code>&amp;mut T</code> æ¨¡å¼çš„å€Ÿç”¨å­˜åœ¨</li></ul><p>è®©æˆ‘ä»¬çœ‹çœ‹ <code>try_borrow_mut</code>:</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// Mutably borrows the wrapped value, returning an error if the value is currently borrowed.</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// The borrow lasts until the returned `RefMut` or all `RefMut`s derived</span></span><br><span class="line"><span class="comment">/// from it exit scope. The value cannot be borrowed while this borrow is</span></span><br><span class="line"><span class="comment">/// active.</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// This is the non-panicking variant of [`borrow_mut`](#method.borrow_mut).</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// # Examples</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// ```</span></span><br><span class="line"><span class="comment">/// use std::cell::RefCell;</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// let c = RefCell::new(5);</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// &#123;</span></span><br><span class="line"><span class="comment">///     let m = c.borrow();</span></span><br><span class="line"><span class="comment">///     assert!(c.try_borrow_mut().is_err());</span></span><br><span class="line"><span class="comment">/// &#125;</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// assert!(c.try_borrow_mut().is_ok());</span></span><br><span class="line"><span class="comment">/// ```</span></span><br><span class="line"><span class="meta">#[stable(feature = <span class="string">&quot;try_borrow&quot;</span>, since = <span class="string">&quot;1.13.0&quot;</span>)]</span></span><br><span class="line"><span class="meta">#[inline]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">try_borrow_mut</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;RefMut&lt;<span class="symbol">&#x27;_</span>, T&gt;, BorrowMutError&gt; &#123;</span><br><span class="line">    <span class="keyword">match</span> BorrowRefMut::<span class="title function_ invoke__">new</span>(&amp;<span class="keyword">self</span>.borrow) &#123;</span><br><span class="line">        <span class="title function_ invoke__">Some</span>(b) =&gt; <span class="title function_ invoke__">Ok</span>(RefMut &#123;</span><br><span class="line">            value: <span class="keyword">unsafe</span> &#123; &amp;<span class="keyword">mut</span> *<span class="keyword">self</span>.value.<span class="title function_ invoke__">get</span>() &#125;,</span><br><span class="line">            borrow: b,</span><br><span class="line">        &#125;),</span><br><span class="line">        <span class="literal">None</span> =&gt; <span class="title function_ invoke__">Err</span>(BorrowMutError &#123; _private: () &#125;),</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæœ‰ç›¸å½“é‡è¦çš„ <code>BorrowRefMut</code>:</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">BorrowRefMut</span>&lt;<span class="symbol">&#x27;b</span>&gt; &#123;</span><br><span class="line">    borrow: &amp;<span class="symbol">&#x27;b</span> Cell&lt;BorrowFlag&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Drop</span> <span class="keyword">for</span> <span class="title class_">BorrowRefMut</span>&lt;<span class="symbol">&#x27;_</span>&gt; &#123;</span><br><span class="line">    <span class="meta">#[inline]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">drop</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">borrow</span> = <span class="keyword">self</span>.borrow.<span class="title function_ invoke__">get</span>();</span><br><span class="line">        <span class="built_in">debug_assert!</span>(<span class="title function_ invoke__">is_writing</span>(borrow));</span><br><span class="line">        <span class="keyword">self</span>.borrow.<span class="title function_ invoke__">set</span>(borrow + <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span>&lt;<span class="symbol">&#x27;b</span>&gt; BorrowRefMut&lt;<span class="symbol">&#x27;b</span>&gt; &#123;</span><br><span class="line">    <span class="meta">#[inline]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">new</span>(borrow: &amp;<span class="symbol">&#x27;b</span> Cell&lt;BorrowFlag&gt;) <span class="punctuation">-&gt;</span> <span class="type">Option</span>&lt;BorrowRefMut&lt;<span class="symbol">&#x27;b</span>&gt;&gt; &#123;</span><br><span class="line">        <span class="comment">// <span class="doctag">NOTE:</span> Unlike BorrowRefMut::clone, new is called to create the initial</span></span><br><span class="line">        <span class="comment">// mutable reference, and so there must currently be no existing</span></span><br><span class="line">        <span class="comment">// references. Thus, while clone increments the mutable refcount, here</span></span><br><span class="line">        <span class="comment">// we explicitly only allow going from UNUSED to UNUSED - 1.</span></span><br><span class="line">        <span class="keyword">match</span> borrow.<span class="title function_ invoke__">get</span>() &#123;</span><br><span class="line">            UNUSED =&gt; &#123;</span><br><span class="line">                borrow.<span class="title function_ invoke__">set</span>(UNUSED - <span class="number">1</span>);</span><br><span class="line">                <span class="title function_ invoke__">Some</span>(BorrowRefMut &#123; borrow &#125;)</span><br><span class="line">            &#125;,</span><br><span class="line">            _ =&gt; <span class="literal">None</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Clones a `BorrowRefMut`.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// This is only valid if each `BorrowRefMut` is used to track a mutable</span></span><br><span class="line">    <span class="comment">// reference to a distinct, nonoverlapping range of the original object.</span></span><br><span class="line">    <span class="comment">// This isn&#x27;t in a Clone impl so that code doesn&#x27;t call this implicitly.</span></span><br><span class="line">    <span class="meta">#[inline]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">clone</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> BorrowRefMut&lt;<span class="symbol">&#x27;b</span>&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">borrow</span> = <span class="keyword">self</span>.borrow.<span class="title function_ invoke__">get</span>();</span><br><span class="line">        <span class="built_in">debug_assert!</span>(<span class="title function_ invoke__">is_writing</span>(borrow));</span><br><span class="line">        <span class="comment">// Prevent the borrow counter from underflowing.</span></span><br><span class="line">        <span class="built_in">assert!</span>(borrow != isize::<span class="title function_ invoke__">min_value</span>());</span><br><span class="line">        <span class="keyword">self</span>.borrow.<span class="title function_ invoke__">set</span>(borrow - <span class="number">1</span>);</span><br><span class="line">        BorrowRefMut &#123; borrow: <span class="keyword">self</span>.borrow &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[inline(always)]</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">is_writing</span>(x: BorrowFlag) <span class="punctuation">-&gt;</span> <span class="type">bool</span> &#123;</span><br><span class="line">    x &lt; UNUSED</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿”å›çš„æ˜¯ä¸€ä¸ª <code>RefMut</code>, å¸¦æœ‰å€¼å’Œ <code>BorrowRefMut&lt;&#39;b&gt;</code></p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// A wrapper type for a mutably borrowed value from a `RefCell&lt;T&gt;`.</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// See the [module-level documentation](index.html) for more.</span></span><br><span class="line"><span class="meta">#[stable(feature = <span class="string">&quot;rust1&quot;</span>, since = <span class="string">&quot;1.0.0&quot;</span>)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">RefMut</span>&lt;<span class="symbol">&#x27;b</span>, T: ?<span class="built_in">Sized</span> + <span class="symbol">&#x27;b</span>&gt; &#123;</span><br><span class="line">    value: &amp;<span class="symbol">&#x27;b</span> <span class="keyword">mut</span> T,</span><br><span class="line">    borrow: BorrowRefMut&lt;<span class="symbol">&#x27;b</span>&gt;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯ä»¥æŒ‰ç…§ä¹‹å‰çš„è§„åˆ™ï¼Œæ¥å¤§è‡´æ˜ç™½è¿™æ®µé€»è¾‘ï¼š</p><ol><li><code>new</code> çš„æ—¶å€™ï¼Œè¿™é‡Œæ˜¯ä¸ª <code>RefMut</code>, å¿…é¡»æ²¡æœ‰ <code>Ref</code>, å³ unused æ‰æ˜¯åˆæ³•çš„ï¼Œå®ƒçš„çŠ¶æ€æ”¹ä¸º <code>UNUSED - 1</code>. å³ä¸€ä¸ª <code>RefMut</code>.</li><li><code>drop</code> çš„æ—¶å€™ï¼Œå¢åŠ  <code>BorrowFlag</code> çš„å€¼.</li><li><code>BorrowRefMut</code> æŒæœ‰ <code>&amp; Cell&lt;BorrowFlag&gt;</code></li></ol><p><code>try_borrow</code> ç±»ä¼¼ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[stable(feature = <span class="string">&quot;try_borrow&quot;</span>, since = <span class="string">&quot;1.13.0&quot;</span>)]</span></span><br><span class="line"><span class="meta">#[inline]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">try_borrow</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;Ref&lt;<span class="symbol">&#x27;_</span>, T&gt;, BorrowError&gt; &#123;</span><br><span class="line">    <span class="keyword">match</span> BorrowRef::<span class="title function_ invoke__">new</span>(&amp;<span class="keyword">self</span>.borrow) &#123;</span><br><span class="line">        <span class="title function_ invoke__">Some</span>(b) =&gt; <span class="title function_ invoke__">Ok</span>(Ref &#123;</span><br><span class="line">            value: <span class="keyword">unsafe</span> &#123; &amp;*<span class="keyword">self</span>.value.<span class="title function_ invoke__">get</span>() &#125;,</span><br><span class="line">            borrow: b,</span><br><span class="line">        &#125;),</span><br><span class="line">        <span class="literal">None</span> =&gt; <span class="title function_ invoke__">Err</span>(BorrowError &#123; _private: () &#125;),</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">BorrowRef</span>&lt;<span class="symbol">&#x27;b</span>&gt; &#123;</span><br><span class="line">    borrow: &amp;<span class="symbol">&#x27;b</span> Cell&lt;BorrowFlag&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span>&lt;<span class="symbol">&#x27;b</span>&gt; BorrowRef&lt;<span class="symbol">&#x27;b</span>&gt; &#123;</span><br><span class="line">    <span class="meta">#[inline]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">new</span>(borrow: &amp;<span class="symbol">&#x27;b</span> Cell&lt;BorrowFlag&gt;) <span class="punctuation">-&gt;</span> <span class="type">Option</span>&lt;BorrowRef&lt;<span class="symbol">&#x27;b</span>&gt;&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">b</span> = borrow.<span class="title function_ invoke__">get</span>().<span class="title function_ invoke__">wrapping_add</span>(<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> !<span class="title function_ invoke__">is_reading</span>(b) &#123;</span><br><span class="line">            <span class="comment">// Incrementing borrow can result in a non-reading value (&lt;= 0) in these cases:</span></span><br><span class="line">            <span class="comment">// 1. It was &lt; 0, i.e. there are writing borrows, so we can&#x27;t allow a read borrow</span></span><br><span class="line">            <span class="comment">//    due to Rust&#x27;s reference aliasing rules</span></span><br><span class="line">            <span class="comment">// 2. It was isize::max_value() (the max amount of reading borrows) and it overflowed</span></span><br><span class="line">            <span class="comment">//    into isize::min_value() (the max amount of writing borrows) so we can&#x27;t allow</span></span><br><span class="line">            <span class="comment">//    an additional read borrow because isize can&#x27;t represent so many read borrows</span></span><br><span class="line">            <span class="comment">//    (this can only happen if you mem::forget more than a small constant amount of</span></span><br><span class="line">            <span class="comment">//    `Ref`s, which is not good practice)</span></span><br><span class="line">            <span class="literal">None</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// Incrementing borrow can result in a reading value (&gt; 0) in these cases:</span></span><br><span class="line">            <span class="comment">// 1. It was = 0, i.e. it wasn&#x27;t borrowed, and we are taking the first read borrow</span></span><br><span class="line">            <span class="comment">// 2. It was &gt; 0 and &lt; isize::max_value(), i.e. there were read borrows, and isize</span></span><br><span class="line">            <span class="comment">//    is large enough to represent having one more read borrow</span></span><br><span class="line">            borrow.<span class="title function_ invoke__">set</span>(b);</span><br><span class="line">            <span class="title function_ invoke__">Some</span>(BorrowRef &#123; borrow &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Drop</span> <span class="keyword">for</span> <span class="title class_">BorrowRef</span>&lt;<span class="symbol">&#x27;_</span>&gt; &#123;</span><br><span class="line">    <span class="meta">#[inline]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">drop</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">borrow</span> = <span class="keyword">self</span>.borrow.<span class="title function_ invoke__">get</span>();</span><br><span class="line">        <span class="built_in">debug_assert!</span>(<span class="title function_ invoke__">is_reading</span>(borrow));</span><br><span class="line">        <span class="keyword">self</span>.borrow.<span class="title function_ invoke__">set</span>(borrow - <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Clone</span> <span class="keyword">for</span> <span class="title class_">BorrowRef</span>&lt;<span class="symbol">&#x27;_</span>&gt; &#123;</span><br><span class="line">    <span class="meta">#[inline]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">clone</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">        <span class="comment">// Since this Ref exists, we know the borrow flag</span></span><br><span class="line">        <span class="comment">// is a reading borrow.</span></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">borrow</span> = <span class="keyword">self</span>.borrow.<span class="title function_ invoke__">get</span>();</span><br><span class="line">        <span class="built_in">debug_assert!</span>(<span class="title function_ invoke__">is_reading</span>(borrow));</span><br><span class="line">        <span class="comment">// Prevent the borrow counter from overflowing into</span></span><br><span class="line">        <span class="comment">// a writing borrow.</span></span><br><span class="line">        <span class="built_in">assert!</span>(borrow != isize::<span class="title function_ invoke__">max_value</span>());</span><br><span class="line">        <span class="keyword">self</span>.borrow.<span class="title function_ invoke__">set</span>(borrow + <span class="number">1</span>);</span><br><span class="line">        BorrowRef &#123; borrow: <span class="keyword">self</span>.borrow &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li><code>new</code> çš„æ—¶å€™ <code>+1</code> å¹¶æ£€æŸ¥ï¼Œå¦‚æœä¹‹å‰æ˜¯ <code>&lt; 0</code> çš„ writing çŠ¶æ€ï¼Œè¿”å› None. å¦åˆ™è¿”å› <code>BorrowRef</code></li><li><code>drop</code> çš„æ—¶å€™ <code>borrow</code> å‡å°‘</li><li><code>clone</code> çš„æ—¶å€™ <code>++borrow</code></li></ol>]]></content>
      
      
      <categories>
          
          <category> Rust </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>Vector çš„ C++ å’Œ Rust å®ç°</title>
      <link href="/2019/10/15/Vector-%E7%9A%84-C-%E5%92%8C-Rust-%E5%AE%9E%E7%8E%B0/"/>
      <url>/2019/10/15/Vector-%E7%9A%84-C-%E5%92%8C-Rust-%E5%AE%9E%E7%8E%B0/</url>
      
        <content type="html"><![CDATA[]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>MapReduce Paper &amp; Lab Report</title>
      <link href="/2019/10/09/MapReduce-Paper-Lab-Report/"/>
      <url>/2019/10/09/MapReduce-Paper-Lab-Report/</url>
      
        <content type="html"><![CDATA[<h1 id="MapReduce-è®ºæ–‡é˜…è¯»"><a href="#MapReduce-è®ºæ–‡é˜…è¯»" class="headerlink" title="MapReduce è®ºæ–‡é˜…è¯»"></a>MapReduce è®ºæ–‡é˜…è¯»</h1><h2 id="ç¼–ç¨‹æ¨¡å‹"><a href="#ç¼–ç¨‹æ¨¡å‹" class="headerlink" title="ç¼–ç¨‹æ¨¡å‹"></a>ç¼–ç¨‹æ¨¡å‹</h2><p>MapReduce ä½¿ç”¨ç±»ä¼¼ fp çš„åŸè¯­æ¥æè¿°ä¸€ä¸ªè®¡ç®—ï¼š</p><blockquote><p>Map(k, v) =&gt; list(k2, v2)</p><p>Reduce(k2, list(v2)) =&gt; list(v2)</p><p>è¾“å…¥çš„k, v != ä¸­é—´çš„ k2, v2 == è¾“å‡ºçš„k2, v2.</p></blockquote><p>å¯ä»¥åšå€’æ’ç´¢å¼•ã€wordcountã€åˆ†å¸ƒå¼æ’åºç­‰äº‹æƒ…ï¼Œå‰ææ˜¯ä½ èƒ½æŠŠä½ çš„ä»»åŠ¡æè¿°æˆmap â€“ reduce å½¢å¼ã€‚</p><h2 id="å®ç°"><a href="#å®ç°" class="headerlink" title="å®ç°"></a>å®ç°</h2><h3 id="ä¸»è¦æµç¨‹"><a href="#ä¸»è¦æµç¨‹" class="headerlink" title="ä¸»è¦æµç¨‹"></a>ä¸»è¦æµç¨‹</h3><p><img src="https://nmsl.maplewish.cn/blog:/Users/fuasahi/Desktop/writing/MapReduce.md:mapreduce%E6%B5%81%E7%A8%8B.png" alt="mapreduceæµç¨‹"></p><p>å¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œæœ‰ map-worker å’Œ reduce-worker. Map Reduce åˆ†åŒºæ•°é‡ç”±ç”¨æˆ·å®šä¹‰ã€‚</p><p>æ“ä½œæŒ‰è®ºæ–‡è¯´æœ‰ä¸€äº›æµç¨‹ï¼Œç…§æ¬ä¸å¤ªå¥½ï¼Œæˆ‘å°±è¯´ä¸‹è‡ªå·±çš„ç†è§£ï¼š</p><ol><li>å°†è¾“å…¥æ–‡ä»¶åˆ†æ®µï¼Œå®šä¹‰ä¸€å®šçš„æ•°æ®æ®µå¤§å°(åŸå§‹è®ºæ–‡ç»™16-64MB)</li><li>ç”¨æˆ·ç¨‹åºåˆ›å»ºå¤§é‡çš„ map reduce å·¥ä½œå‰¯æœ¬</li><li>master åˆ†é…ä»»åŠ¡ç»™ç©ºé—² workerï¼Œæœ‰Må’ŒRä¸ªä»»åŠ¡</li><li><strong>Map worker</strong> å®Œæˆè®¡ç®—ï¼Œå¹¶ä¸”æŠŠæ•°æ®<strong>ç¼“å­˜</strong>åœ¨<strong>å†…å­˜</strong>ä¸­ï¼Œ <code>k2, v2</code> å¯¹è‡ªåŠ¨åˆ†åŒºæˆ R ä¸ªï¼Œå†™åœ¨ <strong>æœ¬åœ°æ–‡ä»¶</strong> ä¸­ï¼Œæ¶ˆæ¯è¢«ä¼ ç»™master, master æŠŠè¿™ä¸ªä¿¡æ¯ä¼ ç»™ reducer.</li><li>reducer æ¥æ”¶åˆ° master çš„æ¶ˆæ¯åï¼š<ol><li>ç”¨ rpc è¯»å–è¿™äº›æ•°æ®</li><li>æŠŠæ•°æ®æŒ‰ç…§ k2 èšåˆï¼Œä¼¼ä¹è¦æ’åºï¼Ÿ</li><li>å¤„ç†è¿™äº›æ•°æ®ï¼ŒæŒ‰ç…§åˆ†åŒº<strong>è¿½åŠ </strong>å†™åˆ°è¾“å‡ºæ–‡ä»¶</li></ol></li><li>å®Œæˆåï¼ŒRä¸ªåˆ†åŒºæœ‰<strong>è¿½åŠ </strong> çš„ map-reduce æ–‡ä»¶ã€‚</li></ol><h3 id="æ•…éšœå¤„ç†"><a href="#æ•…éšœå¤„ç†" class="headerlink" title="æ•…éšœå¤„ç†"></a>æ•…éšœå¤„ç†</h3><h4 id="worker-æ•…éšœ"><a href="#worker-æ•…éšœ" class="headerlink" title="worker æ•…éšœ"></a>worker æ•…éšœ</h4><p>worker æ•…éšœçš„ä¸»è¦è§£å†³æ–¹æ¡ˆæ˜¯æ ‡è®°æˆé”™è¯¯ï¼Œå¦‚æœæ˜¯ map-worker åˆ™é€šçŸ¥ reduce-worker ï¼ŒæŠŠä»»åŠ¡äº¤ç»™åˆ«äººæ‰§è¡Œã€‚</p><p>æˆ‘å¾ˆå¼Ÿå¼Ÿï¼Œçœ‹çš„æ˜¯è®ºæ–‡ä¸­æ–‡ç¿»è¯‘ï¼Œä½†æ˜¯æ„Ÿè§‰è¿™æ®µå†™çš„æ¯”æˆ‘èƒ½æ€»ç»“çš„å¥½å¾ˆå¤šï¼š</p><blockquote><p>master å‘¨æœŸæ€§çš„ ping æ¯ä¸ª workerã€‚å¦‚æœåœ¨ä¸€ä¸ªçº¦å®šçš„æ—¶é—´èŒƒå›´å†…æ²¡æœ‰æ”¶åˆ° worker è¿”å›çš„ä¿¡æ¯ï¼Œmaster å°†<br>æŠŠè¿™ä¸ª worker æ ‡è®°ä¸ºå¤±æ•ˆã€‚æ‰€æœ‰ç”±è¿™ä¸ªå¤±æ•ˆçš„ worker å®Œæˆçš„ Map ä»»åŠ¡è¢«é‡è®¾ä¸ºåˆå§‹çš„ç©ºé—²çŠ¶æ€ï¼Œä¹‹åè¿™äº›<br>ä»»åŠ¡å°±å¯ä»¥è¢«å®‰æ’ç»™å…¶ä»–çš„ workerã€‚åŒæ ·çš„ï¼Œworker å¤±æ•ˆæ—¶æ­£åœ¨è¿è¡Œçš„ Map æˆ– Reduce ä»»åŠ¡ä¹Ÿå°†è¢«é‡æ–°ç½®ä¸º<br>ç©ºé—²çŠ¶æ€ï¼Œç­‰å¾…é‡æ–°è°ƒåº¦ã€‚</p></blockquote><h4 id="master-æ•…éšœ"><a href="#master-æ•…éšœ" class="headerlink" title="master æ•…éšœ"></a>master æ•…éšœ</h4><p>ç±»ä¼¼å†…å­˜å¤‡ä»½å§ï¼Œå†™walï¼å‘¨æœŸæ€§å†™å…¥ç£ç›˜ä»€ä¹ˆçš„ â€¦</p><h3 id="ä»»åŠ¡ç²’åº¦"><a href="#ä»»åŠ¡ç²’åº¦" class="headerlink" title="ä»»åŠ¡ç²’åº¦"></a>ä»»åŠ¡ç²’åº¦</h3><blockquote><p>ç†æƒ³æƒ…å†µä¸‹ï¼ŒM å’Œ R åº”å½“ æ¯”é›†ç¾¤ä¸­ worker çš„æœºå™¨æ•°é‡è¦å¤šå¾—å¤šã€‚åœ¨æ¯å° worker æœºå™¨éƒ½æ‰§è¡Œå¤§é‡çš„ä¸åŒä»»åŠ¡èƒ½å¤Ÿ é«˜é›†ç¾¤çš„åŠ¨æ€çš„è´Ÿè½½ å‡è¡¡èƒ½åŠ›ï¼Œå¹¶ä¸”èƒ½å¤ŸåŠ å¿«æ•…éšœæ¢å¤çš„é€Ÿåº¦:å¤±æ•ˆæœºå™¨ä¸Šæ‰§è¡Œçš„å¤§é‡ Map ä»»åŠ¡éƒ½å¯ä»¥åˆ†å¸ƒåˆ°æ‰€æœ‰å…¶ä»–çš„ worker æœºå™¨ä¸Šå»æ‰§è¡Œã€‚</p><p>ä½†æ˜¯å®é™…ä¸Šï¼Œåœ¨æˆ‘ä»¬çš„å…·ä½“å®ç°ä¸­å¯¹ M å’Œ R çš„å–å€¼éƒ½æœ‰ä¸€å®šçš„å®¢è§‚é™åˆ¶ï¼Œå› ä¸º master å¿…é¡»æ‰§è¡Œ O(M+R) æ¬¡è°ƒåº¦ï¼Œå¹¶ä¸”åœ¨å†…å­˜ä¸­ä¿å­˜ O(M<em>R)ä¸ªçŠ¶æ€(å¯¹å½±å“å†…å­˜ä½¿ç”¨çš„å› ç´ è¿˜æ˜¯æ¯”è¾ƒå°çš„:O(M</em>R)å—çŠ¶æ€ï¼Œå¤§æ¦‚æ¯ å¯¹ Map ä»»åŠ¡/Reduce ä»»åŠ¡ 1 ä¸ªå­—èŠ‚å°±å¯ä»¥äº†)ã€‚</p></blockquote><h3 id="å¤‡ç”¨ä»»åŠ¡"><a href="#å¤‡ç”¨ä»»åŠ¡" class="headerlink" title="å¤‡ç”¨ä»»åŠ¡"></a>å¤‡ç”¨ä»»åŠ¡</h3><p>æœ‰çš„ä»»åŠ¡æ‰§è¡Œçš„å¾ˆæ…¢ï¼Œæˆ‘ä»¬æœ‰çš„æ—¶å€™ä¼šè°ƒåº¦ backup (å¤‡ä»½) æ¥å¤„ç†å‰©ä¸‹çš„ã€å¤„ç†ä¸­çš„ä»»åŠ¡ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> Lab Report </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Paper Reading </tag>
            
            <tag> Lab Report </tag>
            
            <tag> Distributed </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>PyConCn2019</title>
      <link href="/2019/09/29/PyConCn2019/"/>
      <url>/2019/09/29/PyConCn2019/</url>
      
        <content type="html"><![CDATA[<p>ç¿˜äº†ä¸€å¤©å…¬å¸ TB æ¥ PyCon, ä¹Ÿä¸è¯´æƒ³æ³•äº†ï¼Œå°±è¯´ä¸‹è‡ªå·±å¬çš„ä¸€äº›ã€‚ç”±äºè‡ªå·±æ°´å¹³ä¸å¤Ÿï¼Œè¯´çš„ä¸œè¥¿å¯èƒ½æœ‰å¾ˆå¤šé—®é¢˜ï¼Œæ¬¢è¿å„è·¯å¤§ä½¬æŒ‡å‡ºï¼š</p><h3 id="ARMIN-RONACHER-è°ƒè¯•æ˜¯ä¸€ç§æ–°çš„å‘å¸ƒï¼šæ…¢è¯­è¨€çš„æ„å¤–ä¼˜åŠ¿"><a href="#ARMIN-RONACHER-è°ƒè¯•æ˜¯ä¸€ç§æ–°çš„å‘å¸ƒï¼šæ…¢è¯­è¨€çš„æ„å¤–ä¼˜åŠ¿" class="headerlink" title="ARMIN RONACHER: è°ƒè¯•æ˜¯ä¸€ç§æ–°çš„å‘å¸ƒï¼šæ…¢è¯­è¨€çš„æ„å¤–ä¼˜åŠ¿"></a>ARMIN RONACHER: è°ƒè¯•æ˜¯ä¸€ç§æ–°çš„å‘å¸ƒï¼šæ…¢è¯­è¨€çš„æ„å¤–ä¼˜åŠ¿</h3><p>ä½œè€…å¯¹æ¯”äº† Python, V8, è¿˜æœ‰ Cpp è¿™äº›è¯­è¨€çš„ debug/release ä¸‹çš„æ€§èƒ½æ¯”è¾ƒå’Œ debug å¯æä¾›çš„ä¿¡æ¯ï¼Œå¾—å‡º Python ç¼–è¯‘ä¸èƒ½åƒæœ‰ JIT/AOT ç¼–è¯‘å™¨ä¸€æ ·ï¼Œæä¾›å¾ˆé«˜çš„ä¼˜åŒ–ï¼Œä½†æ˜¯è¿™ä¹Ÿè®©åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ç”¨ debug modeï¼ˆæˆ–è€…è¯´æä¾›æ›´å¤šçš„ debug ä¿¡æ¯ï¼‰çš„æ€§èƒ½æŸè€—ã€ä»£ä»·æ›´å°ã€‚</p><h3 id="LAIKE9M-Python-è°ƒè¯•æ–°æ€è·¯"><a href="#LAIKE9M-Python-è°ƒè¯•æ–°æ€è·¯" class="headerlink" title="LAIKE9M: Python è°ƒè¯•æ–°æ€è·¯"></a>LAIKE9M: Python è°ƒè¯•æ–°æ€è·¯</h3><p><a href="https://github.com/laike9m/Cyberbraingithub.com">https://github.com/laike9m/Cyberbraingithub.com</a></p><p>ä»‹ç»äº†ä¸‹ Python debug çš„æ€è·¯ï¼ŒåŒæ—¶å¼•å‡ºè¿™ä¸ª repo, çœ‹ä¸Šå»å¾ˆä¸é”™= =ä¸è¿‡æˆ‘å°šä¸”æ²¡æœ‰ä½“éªŒè¿‡ï¼Œä¸å¥½åšå‡ºè¯„ä»·ã€‚æ„Ÿè§‰åšé¢˜å¯ä»¥ç”¨ç”¨ï¼Œä¸è¿‡ç›®å‰ç”Ÿäº§ç¯å¢ƒç”¨è¿™ä¸ªä¼°è®¡ä¸æ˜¯å¾ˆæ–¹ä¾¿ï¼Ÿ</p><h3 id="å¼ ä½³åœ†-GIL-çš„è¿‡å»å’Œæœªæ¥"><a href="#å¼ ä½³åœ†-GIL-çš„è¿‡å»å’Œæœªæ¥" class="headerlink" title="å¼ ä½³åœ†: GIL çš„è¿‡å»å’Œæœªæ¥"></a>å¼ ä½³åœ†: GIL çš„è¿‡å»å’Œæœªæ¥</h3><p><a href="https://www.python.org/dev/peps/pep-0554/www.python.org">https://www.python.org/dev/peps/pep-0554/www.python.org</a></p><p>ä»‹ç»äº†ä¸€ä¸‹ GIL çš„å†å²å’Œä¸€äº›ç»•è¿‡ GIL çš„æ–¹æ¡ˆï¼Œä¹Ÿä»‹ç»äº†ä¸Šé¢è¿™ä¸ª PEPï¼Œä¸è¿‡æ„Ÿè§‰æé—®ç¯èŠ‚è´¨é‡ä¸æ˜¯å¾ˆé«˜= =</p><h3 id="GIAMPAOLO-RODOLA-ä½¿ç”¨-Python-åŠ é€Ÿæ–‡ä»¶ä¼ è¾“å’Œæ–‡ä»¶å¤åˆ¶"><a href="#GIAMPAOLO-RODOLA-ä½¿ç”¨-Python-åŠ é€Ÿæ–‡ä»¶ä¼ è¾“å’Œæ–‡ä»¶å¤åˆ¶" class="headerlink" title="GIAMPAOLO RODOLA: ä½¿ç”¨ Python åŠ é€Ÿæ–‡ä»¶ä¼ è¾“å’Œæ–‡ä»¶å¤åˆ¶"></a>GIAMPAOLO RODOLA: ä½¿ç”¨ Python åŠ é€Ÿæ–‡ä»¶ä¼ è¾“å’Œæ–‡ä»¶å¤åˆ¶</h3><p>psutil è¿™ä¸ªåº“çš„ä½œè€…ä»‹ç»ä¸€ä¸‹ç”¨ sendfile ä»£æ›¿ read + write å‡å°‘ç”¨æˆ·æ€å†…æ ¸è·³æ¥è·³å»çš„æ–¹æ³•ã€‚åŒæ—¶ä¹Ÿç®€çŸ­ä»‹ç»äº†ä¸‹ psutil è¿™ä¸ªåº“ã€‚ï¼ˆæˆ‘æœ¬äººä¹Ÿç”¨è¿™ä¸ªåº“ï¼Œæ‰€ä»¥å¬å¾—å¾ˆå¼€å¿ƒï¼‰</p><p><a href="https://pic3.zhimg.com/v2-ea5c21e251004d639b624aaae78294ae_ipico.jpg">giampaolo/psutilgithub.com</a></p><h3 id="THAUTWARM-Python-è¯­æ³•æ‰©å±•æ¡†æ¶-Moshmosh-å’Œå…¶ä¸Š-CPython-å…¼å®¹çš„-JIT-å®ç°"><a href="#THAUTWARM-Python-è¯­æ³•æ‰©å±•æ¡†æ¶-Moshmosh-å’Œå…¶ä¸Š-CPython-å…¼å®¹çš„-JIT-å®ç°" class="headerlink" title="THAUTWARM: Python è¯­æ³•æ‰©å±•æ¡†æ¶ Moshmosh å’Œå…¶ä¸Š CPython å…¼å®¹çš„ JIT å®ç°"></a>THAUTWARM: Python è¯­æ³•æ‰©å±•æ¡†æ¶ Moshmosh å’Œå…¶ä¸Š CPython å…¼å®¹çš„ JIT å®ç°</h3><p>Moshmosh ä¼¼ä¹æ²¡ä»‹ç»ï¼Ÿä¸»è¦å†…å®¹æ˜¯åè€…ï¼ŒæœŸå¾…å¤§ä½¬å¼€å‘è€…å¡«å‘ã€‚</p><h3 id="å¼ æ±å®¶-ä»-thriftpy-ä¸­å­¦ä¹ -rpc-åè®®"><a href="#å¼ æ±å®¶-ä»-thriftpy-ä¸­å­¦ä¹ -rpc-åè®®" class="headerlink" title="å¼ æ±å®¶: ä» thriftpy ä¸­å­¦ä¹  rpc åè®®"></a>å¼ æ±å®¶: ä» thriftpy ä¸­å­¦ä¹  rpc åè®®</h3><p>ç®€å•ä»‹ç»äº†ä¸€ä¸‹ thrift å’Œ thriftpyï¼Œä¼¼ä¹æ²¡æœ‰è®²å¾ˆæ·±ã€‚</p><hr><p>å‚ä¼šä½“éªŒè¿˜æ˜¯å¾ˆä¸é”™çš„ï¼Œå¾ˆå¤šæ¯”è¾ƒå®ç”¨çš„å»ºè®®ï¼ŒæœŸå¾…ä¸‹æ¬¡å†ç©</p>]]></content>
      
      
      <categories>
          
          <category> life </category>
          
      </categories>
      
      
        <tags>
            
            <tag> talks </tag>
            
            <tag> Python </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
